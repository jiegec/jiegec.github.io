
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维，编程，调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/category/software/page/2/">
      
      
        <link rel="prev" href="../../../programming/">
      
      
        <link rel="next" href="../../../speech/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.2">
    
    
      
        <title>software - 杰哥的{运维，编程，调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.d7758b05.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-3109FRSVTT",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#software" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维，编程，调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              software
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/cpu/" class="md-tabs__link">
        
  
    
  
  CPU

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../benchmark/" class="md-tabs__link">
        
  
    
  
  SPEC

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../archive/2025/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    杰哥的{运维，编程，调板子}小笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/cpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../benchmark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SPEC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" checked>
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="">
            
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    software
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    software
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#从-tex-到-pdf-的过程" class="md-nav__link">
    <span class="md-ellipsis">
      从 TeX 到 PDF 的过程
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#用-nix-编译-rust-项目" class="md-nav__link">
    <span class="md-ellipsis">
      用 Nix 编译 Rust 项目
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invalid-date-报错与时区的关系" class="md-nav__link">
    <span class="md-ellipsis">
      invalid date 报错与时区的关系
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#archive-中-common-符号的链接问题" class="md-nav__link">
    <span class="md-ellipsis">
      Archive 中 COMMON 符号的链接问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nvidia-驱动和-cuda-安装速查" class="md-nav__link">
    <span class="md-ellipsis">
      NVIDIA 驱动和 CUDA 安装速查
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#切换-connectx-4-为以太网模式" class="md-nav__link">
    <span class="md-ellipsis">
      切换 ConnectX-4 为以太网模式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rsyslog-收集远程日志" class="md-nav__link">
    <span class="md-ellipsis">
      rsyslog 收集远程日志
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nix-cookbook" class="md-nav__link">
    <span class="md-ellipsis">
      Nix Cookbook
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-libvirt-中运行-risc-v-虚拟机" class="md-nav__link">
    <span class="md-ellipsis">
      在 libvirt 中运行 RISC-V 虚拟机
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loongarch64-工具链构建" class="md-nav__link">
    <span class="md-ellipsis">
      LoongArch64 工具链构建
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-vector-10-工具链构建" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V Vector 1.0 工具链构建
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xrdp-和-nvidia-显卡兼容性问题" class="md-nav__link">
    <span class="md-ellipsis">
      XRDP 和 NVIDIA 显卡兼容性问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nvidia-驱动和-cuda-版本信息速查" class="md-nav__link">
    <span class="md-ellipsis">
      NVIDIA 驱动和 CUDA 版本信息速查
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locale-影响排序的特殊副作用" class="md-nav__link">
    <span class="md-ellipsis">
      Locale 影响排序的特殊副作用
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#配置-homebridge-broadlink-rm-pro" class="md-nav__link">
    <span class="md-ellipsis">
      配置 homebridge-broadlink-rm-pro
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-处理-post-请求出现-internal-server-error-排查一则" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx 处理 POST 请求出现 Internal Server Error 排查一则
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gnome-的-fractional-scaling" class="md-nav__link">
    <span class="md-ellipsis">
      Gnome 的 Fractional Scaling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#使用-sssd-的-ldap-认证" class="md-nav__link">
    <span class="md-ellipsis">
      使用 SSSD 的 LDAP 认证
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-big-surm1-上解决-latex-找不到楷体字体的问题" class="md-nav__link">
    <span class="md-ellipsis">
      在 Big Sur(M1) 上解决 LaTeX 找不到楷体字体的问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-符号" class="md-nav__link">
    <span class="md-ellipsis">
      COMMON 符号
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-m1-上用-qemu-运行-debian-虚拟机" class="md-nav__link">
    <span class="md-ellipsis">
      在 M1 上用 QEMU 运行 Debian 虚拟机
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-spack-中用-external-的-slurm-依赖编译-openmpi" class="md-nav__link">
    <span class="md-ellipsis">
      在 Spack 中用 external 的 Slurm 依赖编译 OpenMPI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usbip-模拟-usb-设备" class="md-nav__link">
    <span class="md-ellipsis">
      USB/IP 模拟 USB 设备
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-sbt-中-fork-并且并行运行测试" class="md-nav__link">
    <span class="md-ellipsis">
      在 sbt 中 fork 并且并行运行测试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-macos-上带执行权限-mmap-一个已删除文件遇到的问题和解决方案" class="md-nav__link">
    <span class="md-ellipsis">
      在 macOS 上带执行权限 mmap 一个已删除文件遇到的问题和解决方案
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="software">software<a class="headerlink" href="#software" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-08-05 00:00:00+00:00">2022年8月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="从-tex-到-pdf-的过程"><a class="toclink" href="../../../../software/2022/08/05/from-tex-to-pdf/">从 TeX 到 PDF 的过程</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/08/05/from-tex-to-pdf/#背景">背景</a></h3>
<p>今天跑 <code>xdvipdfmx</code> 的时候出现了报错，忽然想研究一下，DVI 格式是什么，TeX 是如何一步步变成 PDF 的。</p>

    
      <nav class="md-post__action">
        <a href="../../../../software/2022/08/05/from-tex-to-pdf/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-08-02 00:00:00+00:00">2022年8月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-nix-编译-rust-项目"><a class="toclink" href="../../../../software/2022/08/02/rust-nix/">用 Nix 编译 Rust 项目</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/08/02/rust-nix/#背景">背景</a></h3>
<p>Rust 项目一般是用 Cargo 管理，但是它的缺点是每个项目都要重新编译一次所有依赖，硬盘空间占用较大，不能跨项目共享编译缓存。调研了一下，有若干基于 Nix 的 Rust 构建工具：</p>
<ul>
<li>cargo2nix: https://github.com/cargo2nix/cargo2nix</li>
<li>carnix: 不再更新</li>
<li>crane: https://github.com/ipetkov/crane</li>
<li>crate2nix: https://github.com/kolloch/crate2nix</li>
<li>naersk: https://github.com/nix-community/naersk</li>
<li>nocargo: https://github.com/oxalica/nocargo</li>
</ul>
<p>下面我分别来尝试一下这几个工具的使用。</p>

    
      <nav class="md-post__action">
        <a href="../../../../software/2022/08/02/rust-nix/">
          继续阅读
        </a>
      </nav>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-26 00:00:00+00:00">2022年7月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="invalid-date-报错与时区的关系"><a class="toclink" href="../../../../software/2022/07/26/invalid-date-timezone/">invalid date 报错与时区的关系</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/07/26/invalid-date-timezone/#背景">背景</a></h3>
<p>最近在验题的时候，@HarryChen 发现了一个现象：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;1919-04-13&quot;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>date:<span class="w"> </span>invalid<span class="w"> </span>date<span class="w"> </span>‘1919-04-13’
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>$<span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC<span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;1919-04-13&quot;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">00</span>:00:00<span class="w"> </span>UTC<span class="w"> </span><span class="m">1919</span>
</span></code></pre></div>
<p>也就是说，这个现象与时区有关，那么为啥 <code>1919-04-13</code> 是一个不合法的日期呢？</p>
<h3 id="时区"><a class="toclink" href="../../../../software/2022/07/26/invalid-date-timezone/#时区">时区</a></h3>
<p>实际上，对于某一个时区来说，有的时间是不存在的，最常见的就是夏令时。在 <a href="https://timezonedb.com/time-zones/Asia/Shanghai">Timezone DB</a> 里可以看到，恰好在 1919 年 4 月 13 日发生了一次 UTC+8 到 UTC+9 的变化，因此零点变成了一点，就变成了不合法的日期。</p>
<p>这个数据，实际上保存在 tzdata 中，可以用 zdump 工具查看：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>tzdata<span class="w"> </span>-v<span class="w"> </span>Asia/Shanghai
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Dec<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">20</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Dec<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">04</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Dec<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">20</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Dec<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">04</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Jun<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Mar<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1942</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1942</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1942</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Jan<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1942</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1945</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1945</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1945</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1945</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Wed<span class="w"> </span>May<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>Asia/Shanghai<span class="w">  </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>Asia/Shanghai<span class="w">  </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Jan<span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">03</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Jan<span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">11</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Jan<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">03</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Jan<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">11</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div>
<p>可以看到，它列出来了历史上 Asia/Shanghai 时区的变化历史。具体的历史，可以查看 <a href="https://zh.wikipedia.org/zh-cn/%E4%B8%AD%E5%9C%8B%E6%99%82%E5%8D%80">中国时区</a>。</p>
<p>此外，历史上，从儒略历到格里高利历的演变过程，也出现了一段“不存在”的日期，如 <a href="https://stackoverflow.com/questions/35194544/setting-october-14-1582-fails-in-java-sql-date">Setting October 14 ,1582 fails in java.sql.Date</a>。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-11 00:00:00+00:00">2022年7月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="archive-中-common-符号的链接问题"><a class="toclink" href="../../../../software/2022/07/11/archive-common-linking/">Archive 中 COMMON 符号的链接问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/07/11/archive-common-linking/#背景">背景</a></h3>
<p>最近看到一个 <a href="https://github.com/NixOS/nixpkgs/issues/180308">issue: irssi 1.4.1 fails to build on darwin arm64</a>，它的现象是，链接的时候会报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>Undefined symbols for architecture arm64:
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>  &quot;_current_theme&quot;, referenced from:
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>      _format_get_text_theme in libfe_common_core.a(formats.c.o)
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>      _format_get_text in libfe_common_core.a(formats.c.o)
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>      _strip_codes in libfe_common_core.a(formats.c.o)
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>      _format_send_as_gui_flags in libfe_common_core.a(formats.c.o)
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>      _window_print_daychange in libfe_common_core.a(fe-windows.c.o)
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>      _printformat_module_dest_charargs in libfe_common_core.a(printtext.c.o)
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>      _printformat_module_gui_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>      ...
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>  &quot;_default_formats&quot;, referenced from:
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>      _format_find_tag in libfe_common_core.a(formats.c.o)
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>      _format_get_text_theme_args in libfe_common_core.a(formats.c.o)
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>      _printformat_module_dest_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>      _printformat_module_gui_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>ld: symbol(s) not found for architecture arm64
</span></code></pre></div>
<p>代码 <code>themes.c</code> 定义了这两个全局变量：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">THEME_REC</span><span class="w"> </span><span class="o">*</span><span class="n">current_theme</span><span class="p">;</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">GHashTable</span><span class="w"> </span><span class="o">*</span><span class="n">default_formats</span><span class="p">;</span>
</span></code></pre></div>
<p>并且 <code>themes.c</code> 编译出来的 <code>themes.c.o</code> 也在 archive 文件中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>ar<span class="w"> </span>t<span class="w"> </span>src/fe-common/core/libfe_common_core.a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>themes.c.o
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>themes.c.o
</span></code></pre></div>
<p>并且 <code>themes.c.o</code> 也定义了这两个符号：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>src/fe-common/core/libfe_common_core.a.p/themes.c.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>COM
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_current_theme
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_default_formats
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_themes
</span></code></pre></div>
<p>那么，问题在哪呢？看起来，链接的时候提供了 <code>libfe_common_core.a</code> 的参数，并且 <code>.a</code> 里面也有 <code>themes.c.o</code>，我们要找的符号也有定义，那么为什么会出现 <code>Undefined symbols</code> 的问题呢？</p>
<p>答案出在 COMMON 符号上。</p>
<h3 id="common-符号"><a class="toclink" href="../../../../software/2022/07/11/archive-common-linking/#common-符号">COMMON 符号</a></h3>
<p>COMMON 符号的原因和原理，详细可以见 <a href="https://maskray.me/blog/2022-02-06-all-about-common-symbols">MaskRay 的博客 All about COMMON symbols</a>，里面从链接器的角度很详细地讲述了这个问题。</p>
<p>简单来说，COMMON 符号的引入是为了和 Fortran 进行互操作。它在 C 中对应了没有初始化语句的全局变量。实际上到最后，还是会保存到 .bss 段中，默认清零。所以：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">common_symbol</span><span class="p">;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">not_common_symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<p>两个语句最终结果是类似的，只不过第一个是 COMMON Symbol，第二个就是普通的 GLOBAL Symbol。</p>
<p>这看起来和 <code>Undefined symbols</code> 错误还是没有关系。问题在哪？</p>
<h3 id="archive"><a class="toclink" href="../../../../software/2022/07/11/archive-common-linking/#archive">Archive</a></h3>
<p>静态库通常是以 Archive 的方式给出，后缀是 <code>.a</code>。它实际上是一堆 <code>.o</code> 打包的集合，外加一个索引，即单独保存一个表，保存了每个 <code>.o</code> 定义了哪些符号。这样的好处是找符号的时候，不用遍历 <code>.o</code>，而是直接在索引里面找相关的符号。</p>
<p>为了创建一个 Archive，Linux 上可以用 <code>ar</code> 命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>ar<span class="w"> </span>cr<span class="w"> </span>libxxx.a<span class="w"> </span>a.o<span class="w"> </span>b.o<span class="w"> </span>c.o
</span></code></pre></div>
<p>其中 <code>c</code> 表示 create，<code>r</code> 表示插入（和覆盖）。</p>
<p>macOS 上要用 <code>libtool -static</code> 来创建 Archive：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>libtool<span class="w"> </span>-static<span class="w"> </span>libxxx.a<span class="w"> </span>a.o<span class="w"> </span>b.o<span class="w"> </span>c.o
</span></code></pre></div>
<p>否则链接的时候会报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>ld: warning: ignoring file libxxx.a, building for macOS-arm64 but attempting to link with file built for unknown-unsupported file format
</span></code></pre></div>
<p>然后用 <code>ar t</code> 命令就可以看 Archive 有哪些内容：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>$<span class="w"> </span>ar<span class="w"> </span>t<span class="w"> </span>libxxx.a
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>a.o
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>b.o
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>c.o
</span></code></pre></div>
<p>可以用 <code>nm --print-armap</code> 命令查看 Archive 的索引：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>$<span class="w"> </span>nm<span class="w"> </span>--print-armap<span class="w"> </span>libxxx.a
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>Archive<span class="w"> </span>index:
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>symbol1<span class="w"> </span><span class="k">in</span><span class="w"> </span>a.o
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>symbol2<span class="w"> </span><span class="k">in</span><span class="w"> </span>b.o
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>symbol3<span class="w"> </span><span class="k">in</span><span class="w"> </span>c.o
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>a.o:
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>symbol1
</span></code></pre></div>
<p>所以我们已经了解了 Archive 的情况：它是多个 <code>.o</code> 文件的集合，并且实现了索引。链接的时候，会通过索引来找 <code>.o</code>，而不是遍历所有的 <code>.o</code> 文件。</p>
<h3 id="链接问题"><a class="toclink" href="../../../../software/2022/07/11/archive-common-linking/#链接问题">链接问题</a></h3>
<p>那么，回到一开始的链接问题，既然我们已经确认了，<code>.o</code> 文件中定义了符号，并且这个 <code>.o</code> 也确实在 <code>.a</code> 文件中，那就只剩下最后一个可能了：索引里面没有这个符号。</p>
<p>用 <code>nm --print-armap</code> 命令尝试，发现上面的 <code>_default_formats</code> 和 <code>_current_theme</code> 只在对应的 <code>.o</code> 中有定义，在 Archive index 部分是没有的。</p>
<p>网友 @ailin-nemui 指出了这个问题，并且提供了一个链接：<a href="https://stackoverflow.com/questions/19398742/os-x-linker-unable-to-find-symbols-from-a-c-file-which-only-contains-variables/26581710#26581710">OS X linker unable to find symbols from a C file which only contains variables</a>。它讲了很重要的一点，是 macOS 的 ar/ranlib/libtool 版本默认情况下不会为 COMMON 符号创建索引。所以，解决方案也很明确了：</p>
<ol>
<li>第一种 不要创建 COMMON 符号：添加编译选项 <code>-fno-common</code>，这个选项在比较新的编译器里都是默认了</li>
<li>第二种 为 COMMON 符号创建索引：用 <code>libtool -static -c</code> 命令，其中 <code>-c</code> 选项就是打开为 COMMON 符号创建索引</li>
<li>第三种 修改代码：给全局变量设置一个初始化值</li>
</ol>
<p>这样，这个问题就得到了妥善的解决。</p>
<h3 id="附录"><a class="toclink" href="../../../../software/2022/07/11/archive-common-linking/#附录">附录</a></h3>
<p>下面是 <a href="https://www.unix.com/man-page/osx/1/LIBTOOL/">macOS libtool manpage</a> 中写的相关文档：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>-c     Include common symbols as definitions with respect to the table of contents.  This is seldom the intended behavior for linking  from
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>          a library, as it forces the linking of a library member just because it uses an uninitialized global that is undefined at that point
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>          in the linking.  This option is included only because this was the original behavior of ranlib.  This option is not the default.
</span></code></pre></div>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-06 00:00:00+00:00">2022年7月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nvidia-驱动和-cuda-安装速查"><a class="toclink" href="../../../../software/2022/07/06/install-nvidia-cuda/">NVIDIA 驱动和 CUDA 安装速查</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/07/06/install-nvidia-cuda/#背景">背景</a></h3>
<p>最近在 Ubuntu 上配置 NVIDIA 驱动和 CUDA 环境的次数比较多，在此总结一下整个流程，作为教程供大家学习。</p>
<h3 id="配置-nvidia-apt-源"><a class="toclink" href="../../../../software/2022/07/06/install-nvidia-cuda/#配置-nvidia-apt-源">配置 NVIDIA APT 源</a></h3>
<p>Ubuntu 源有自带的 NVIDIA 驱动版本，但这里我们要使用 NVIDIA 的 APT 源。首先，我们要访问 <a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network">https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network</a>，在网页中选择我们的系统，例如：</p>
<ol>
<li>Operating System: Linux</li>
<li>Architecture: x86_64</li>
<li>Distribution: Ubuntu</li>
<li>Version: 20.04</li>
<li>Installer Type: deb (network)</li>
</ol>
<p>此时，下面就会显示一些命令，复制下来执行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>wget<span class="w"> </span>https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>cuda-keyring_1.0-1_all.deb
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span></code></pre></div>
<p>最后一步的 <code>sudo apt-get -y install cuda</code> 可以不着急安装，我们在后面再来讨论 CUDA 版本的问题。</p>
<h3 id="nvidia-驱动"><a class="toclink" href="../../../../software/2022/07/06/install-nvidia-cuda/#nvidia-驱动">NVIDIA 驱动</a></h3>
<p>配置好源以后，接下来，我们就要安装 NVIDIA 驱动了。首先，我们要选取一个 NVIDIA 版本，选择的标准如下：</p>
<ol>
<li>驱动版本需要支持所使用的显卡</li>
<li>驱动版本需要支持所使用的 CUDA 版本</li>
</ol>
<p>这些信息在网络上都可以查到，也可以参考 <a href="../../../../software/2021/12/26/nvidia-cuda/">NVIDIA 驱动和 CUDA 版本信息速查</a>。</p>
<p>假如我们已经选择了要安装 470.129.06 版本，那么，我们接下来要确认一下 NVIDIA 的 APT 源的版本名称：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>sudo apt show -a nvidia-driver-470
</span></code></pre></div>
<p>在输出的结果中搜索 <code>470.129.06</code>，找到 <code>Version: 470.129.06-0ubuntu1</code>，下面写了 <code>APT-Sources: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64 Packages</code>，这就说明这个版本是从 NVIDIA 的 APT 源来的。</p>
<p>所以，我们要用 <code>470.129.06-0ubuntu1</code>，而不是 <code>470.129.06-0ubuntu0.20.04.1</code>，后者是 Ubuntu 源自带的，我们要用前者。</p>
<p>接下来，指定版本安装驱动：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nvidia-driver-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1
</span></code></pre></div>
<p>如果系统里已经安装了其他版本的 nvidia 驱动，可能会出现冲突。这时候，只需要把冲突的包也写在要安装的包里即可，例如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nvidia-utils-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>cuda-drivers<span class="o">=</span><span class="m">470</span>.129.06-1<span class="w"> </span>cuda-drivers-470<span class="o">=</span><span class="m">470</span>.129.06-1<span class="w"> </span>nvidia-driver-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-gl-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-compute-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-decode-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-encode-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-ifr1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-fbc1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-common-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-kernel-source-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-dkms-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-kernel-common-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-extra-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-compute-utils-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>xserver-xorg-video-nvidia-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-cfg1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-settings<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span><span class="nv">libxnvctrl0</span><span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-modprobe<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1
</span></code></pre></div>
<p>最终，我们要保证，系统里面所有 nvidia 驱动相关的包都是同一个版本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>list<span class="w"> </span>--installed<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nvidia
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>libnvidia-cfg1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>libnvidia-common-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>all<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>libnvidia-compute-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>libnvidia-decode-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>libnvidia-encode-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>libnvidia-extra-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>libnvidia-fbc1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>libnvidia-gl-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>libnvidia-ifr1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>nvidia-compute-utils-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>nvidia-dkms-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>nvidia-driver-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>nvidia-fabricmanager-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>nvidia-kernel-common-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>nvidia-kernel-source-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>nvidia-modprobe/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,upgradable<span class="w"> </span>to:<span class="w"> </span><span class="m">515</span>.48.07-0ubuntu1<span class="o">]</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>nvidia-settings/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,upgradable<span class="w"> </span>to:<span class="w"> </span><span class="m">515</span>.48.07-0ubuntu1<span class="o">]</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>nvidia-utils-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>xserver-xorg-video-nvidia-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span></code></pre></div>
<p>接下来，为了防止 apt 升级的时候顺手破坏了一致的版本，我们要把包固定在一个版本里：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>cuda-drivers<span class="w"> </span>nvidia-modprobe<span class="w"> </span>nvidia-settings<span class="w"> </span>libxnvctrl0
</span></code></pre></div>
<p>如果有其他 nvidia 包说要自动升级，也可以类似地固定住。</p>
<h3 id="cuda"><a class="toclink" href="../../../../software/2022/07/06/install-nvidia-cuda/#cuda">CUDA</a></h3>
<p>CUDA 实际上是绿色软件，把整个目录放在任意一个目录，都可以使用。</p>
<p>安装 CUDA 的方式有很多，我们可以用 APT 安装全局的，也可以用 Spack 或者 Anaconda 安装到本地目录。实际上这些安装过程都是把同样的文件复制到不同的地方而已。</p>
<p>如果要安装全局的话，还是推荐用 NVIDIA 的 APT 源，以安装 CUDA 11.1 为例：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>cuda-11-1
</span></code></pre></div>
<p>那么 CUDA 就会安装到 /usr/local/cuda-11.1 目录下。如果想要用 nvcc，我们可以手动把它加到 PATH 环境变量中。</p>
<p>CUDA 是可以多版本共存的，比如你可以把 CUDA 11.1 到 CUDA 11.7 一口气都装了。不过注意，CUDA 对 NVIDIA 驱动有版本要求，所以有一些可能会不满足 APT 的版本要求；同时，CUDA 对编译器版本有要求，所以如果系统还是 Ubuntu 16.04 或者 18.04，赶紧升级吧。</p>
<h3 id="nvidia-container-toolkit"><a class="toclink" href="../../../../software/2022/07/06/install-nvidia-cuda/#nvidia-container-toolkit">NVIDIA Container Toolkit</a></h3>
<p>安装方法：<a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#linux-distributions">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#linux-distributions</a></p>
<p>命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://nvidia.github.io/libnvidia-container/gpgkey<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span>curl<span class="w"> </span>-s<span class="w"> </span>-L<span class="w"> </span>https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span>sed<span class="w"> </span><span class="s1">&#39;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/nvidia-container-toolkit.list<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span></code></pre></div>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-02 00:00:00+00:00">2022年7月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="切换-connectx-4-为以太网模式"><a class="toclink" href="../../../../software/2022/07/02/connectx-4-switch-to-ethernet/">切换 ConnectX-4 为以太网模式</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/07/02/connectx-4-switch-to-ethernet/#背景">背景</a></h3>
<p>最近在给机房配置网络，遇到一个需求，就是想要把 ConnectX-4 当成以太网卡用，它既支持 Infiniband，又支持 Ethernet，只不过默认是 Infiniband 模式，所以需要用 mlxconfig 工具来做这个切换。</p>
<h3 id="切换方法"><a class="toclink" href="../../../../software/2022/07/02/connectx-4-switch-to-ethernet/#切换方法">切换方法</a></h3>
<p>在 <a href="https://docs.nvidia.com/networking/display/mftv422/using+mlxconfig">Using mlxconfig</a> 文档中，写了如何切换网卡为 Infiniband 模式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>mlxconfig<span class="w"> </span>-d<span class="w"> </span>/dev/mst/mt4103_pci_cr0<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">LINK_TYPE_P1</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">LINK_TYPE_P2</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>Device<span class="w"> </span><span class="c1">#1:</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>----------
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>Device<span class="w"> </span>type:<span class="w">   </span>ConnectX3Pro
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>PCI<span class="w"> </span>device:<span class="w">    </span>/dev/mst/mt4103_pci_cr0
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>Configurations:<span class="w">        </span>Next<span class="w"> </span>Boot<span class="w">        </span>New
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">  </span>LINK_TYPE_P1<span class="w">         </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span><span class="w">           </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">  </span>LINK_TYPE_P2<span class="w">         </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span><span class="w">           </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>Apply<span class="w"> </span>new<span class="w"> </span>Configuration?<span class="w"> </span>?<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span><span class="w"> </span><span class="o">[</span>n<span class="o">]</span><span class="w"> </span>:<span class="w"> </span>y
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>Applying...<span class="w"> </span>Done!
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>-I-<span class="w"> </span>Please<span class="w"> </span>reboot<span class="w"> </span>machine<span class="w"> </span>to<span class="w"> </span>load<span class="w"> </span>new<span class="w"> </span>configurations.
</span></code></pre></div>
<p>那么，我们只需要反其道而行之，设置模式为 <code>ETH(2)</code> 即可。</p>
<h3 id="mst-安装"><a class="toclink" href="../../../../software/2022/07/02/connectx-4-switch-to-ethernet/#mst-安装">MST 安装</a></h3>
<p>要使用 mlxconfig，就需要安装 <a href="https://network.nvidia.com/products/adapter-software/firmware-tools/">MFT(Mellanox Firmware Tools)</a>。我们用的是 Debian bookworm，于是要下载 DEB：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>wget<span class="w"> </span>https://www.mellanox.com/downloads/MFT/mft-4.20.1-14-x86_64-deb.tgz
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>unar<span class="w"> </span>mft-4.20.1-14-x86_64-deb.tgz
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="nb">cd</span><span class="w"> </span>mft-4.20.1-14-x86_64-deb
</span></code></pre></div>
<p>UPDATE 2022-10-28: 现在最新版本 mft-4.21.0-99 已经修复了下面出现的编译问题。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>wget<span class="w"> </span>https://www.mellanox.com/downloads/MFT/mft-4.21.0-99-x86_64-deb.tgz
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>unar<span class="w"> </span>mft-4.21.0-99-x86_64-deb.tgz
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nb">cd</span><span class="w"> </span>mft-4.21.0-99-x86_64-deb
</span></code></pre></div>
<p>尝试用 <code>sudo ./install.sh</code> 安装，发现 dkms 报错。查看日志，发现是因为内核过高（5.18），有函数修改了用法，即要把 pci_unmap_single 的调用改为 dma_unmap_single，并且修改第一个参数，如 <a href="https://github.com/torvalds/linux/commit/a2e759612e5ff3858856fe97be5245eecb84e29b">linux commit a2e759612e5ff3858856fe97be5245eecb84e29b</a> 指出的那样：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>-           pci_unmap_single(dev-&gt;pci_dev, dev-&gt;dma_props[i].dma_map, DMA_MBOX_SIZE, DMA_BIDIRECTIONAL);
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>+           dma_unmap_single(&amp;dev-&gt;pci_dev-&gt;dev, dev-&gt;dma_props[i].dma_map, DMA_MBOX_SIZE, DMA_BIDIRECTIONAL);
</span></code></pre></div>
<p>修改完以后，手动 <code>sudo dkms install kernel-mft-dkms/4.20.1</code>，发现就编译成功了。再手动安装一下 mft 并启动服务：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>$ sudo dpkg -i DEBS/mft_4.20.1-14_amd64.deb
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>$ sudo mst start
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>Starting MST (Mellanox Software Tools) driver set
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>Loading MST PCI module - Success
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>[warn] mst_pciconf is already loaded, skipping
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>Create devices
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>Unloading MST PCI module (unused) - Success
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>$ sudo mst status
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>MST modules:
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>------------
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    MST PCI module is not loaded
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    MST PCI configuration module loaded
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>MST devices:
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>------------
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>/dev/mst/mtxxxx_pciconf0         - PCI configuration cycles access.
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>                                   domain:bus:dev.fn=0000:xx:xx.0 addr.reg=yy data.reg=zz cr_bar.gw_offset=-1
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>                                   Chip revision is: 00
</span></code></pre></div>
<p>既然已经安装好了，最后执行 <code>mlxconfig</code> 即可切换为以太网：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mlxconfig<span class="w"> </span>-d<span class="w"> </span>/dev/mst/mtxxxx_pciconf0<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">LINK_TYPE_P1</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">LINK_TYPE_P2</span><span class="o">=</span><span class="m">2</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>Device<span class="w"> </span><span class="c1">#1:</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>----------
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>Device<span class="w"> </span>type:<span class="w">    </span>ConnectX4
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>Name:<span class="w">           </span>REDACTED
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>Description:<span class="w">    </span>ConnectX-4<span class="w"> </span>VPI<span class="w"> </span>adapter<span class="w"> </span>card<span class="p">;</span><span class="w"> </span>FDR<span class="w"> </span>IB<span class="w"> </span><span class="o">(</span>56Gb/s<span class="o">)</span><span class="w"> </span>and<span class="w"> </span>40GbE<span class="p">;</span><span class="w"> </span>dual-port<span class="w"> </span>QSFP28<span class="p">;</span><span class="w"> </span>PCIe3.0<span class="w"> </span>x8<span class="p">;</span><span class="w"> </span>ROHS<span class="w"> </span>R6
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>Device:<span class="w">         </span>/dev/mst/mtxxxx_pciconf0
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>Configurations:<span class="w">                              </span>Next<span class="w"> </span>Boot<span class="w">       </span>New
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">         </span>LINK_TYPE_P1<span class="w">                        </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w">           </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">         </span>LINK_TYPE_P2<span class="w">                        </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w">           </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w"> </span>Apply<span class="w"> </span>new<span class="w"> </span>Configuration?<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span><span class="w"> </span><span class="o">[</span>n<span class="o">]</span><span class="w"> </span>:<span class="w"> </span>y
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>Applying...<span class="w"> </span>Done!
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>-I-<span class="w"> </span>Please<span class="w"> </span>reboot<span class="w"> </span>machine<span class="w"> </span>to<span class="w"> </span>load<span class="w"> </span>new<span class="w"> </span>configurations.
</span></code></pre></div>
<p>显示各个配置可能的选项和内容：<code>sudo mlxconfig -d /dev/mst/mtxxxx_pciconf0 show_confs</code></p>
<p>整个安装流程在仓库 <a href="https://github.com/jiegec/mft-debian-bookworm">https://github.com/jiegec/mft-debian-bookworm</a> 中用脚本实现。</p>
<p>UPDATE: 太新的 MFT 版本不支持比较旧的网卡，例如 4.22.1-LTS 支持 ConnectX-3，但 4.26.1-LTS 就不支持了。</p>
<h3 id="vmware-esxi"><a class="toclink" href="../../../../software/2022/07/02/connectx-4-switch-to-ethernet/#vmware-esxi">VMware ESXi</a></h3>
<p>如果要在 ESXi 上把网卡改成以太网模式，可以参考下面的文档：</p>
<ul>
<li>https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813</li>
<li>https://docs.nvidia.com/networking/plugins/servlet/mobile?contentId=15051769#content/view/15051769</li>
</ul>
<p>命令（ESXi 7.0U3）：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>scp *.vib root@esxi:/some/path
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>esxcli software vib install -v /some/path/MEL_bootbank_mft_4.21.0.703-0.vib
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>esxcli software vib install -v /some/path/MEL_bootbank_nmst_4.21.0.703-1OEM.703.0.0.18434556.vib
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>reboot
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>/opt/mellanox/bin/mst start
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>/opt/mellanox/bin/mst status -vv
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>/opt/mellanox/bin/mlxfwmanager --query
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>/opt/mellanox/bin/mlxconfig -d mt4115_pciconf0 set LINK_TYPE_P1=2 LINK_TYPE_P2=2
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>reboot
</span></code></pre></div>
<p>然后就可以看到网卡了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-01 00:00:00+00:00">2022年7月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rsyslog-收集远程日志"><a class="toclink" href="../../../../software/2022/07/01/rsyslog-remote/">rsyslog 收集远程日志</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/07/01/rsyslog-remote/#背景">背景</a></h3>
<p>最近在运维的时候发现网络设备（如交换机）有一个远程发送日志的功能，即可以通过 syslog udp 协议发送日志到指定的服务器。为此，可以在服务器上运行 rsyslog 并收集日志。</p>
<h3 id="rsyslog-配置"><a class="toclink" href="../../../../software/2022/07/01/rsyslog-remote/#rsyslog-配置">rsyslog 配置</a></h3>
<p>默认的 rsyslog 配置是收集系统本地的配置，因此我们需要编写一个 rsyslog 配置，用于收集远程的日志。</p>
<p>首先复制 <code>/etc/rsyslog.conf</code> 到 <code>/etc/rsyslog-remote.conf</code>，然后修改：</p>
<ol>
<li>注释掉 <code>imuxsock</code> 和 <code>imklog</code> 相关的 module 加载</li>
<li>去掉 <code>imudp</code> 和 <code>imtcp</code> 相关的注释，这样就会监听在相应的端口上</li>
<li>修改 <code>$WorkDirectory</code>，例如 <code>$WorkDirectory /var/spool/rsyslog-remote</code>，防止与已有的 rsyslog 冲突</li>
<li>注释 <code>$IncludeConfig</code>，防止引入了不必要的配置</li>
<li>注释所有已有的 <code>RULES</code> 下面的配置</li>
<li>添加如下配置：</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$template FromIp,&quot;/var/log/rsyslog-remote/%FROMHOST-IP%.log&quot;
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>*.* ?FromIp
</span></code></pre></div>
<p>这样，就会按照来源的 IP 地址进行分类，然后都写入到 <code>/var/log/rsyslog-remote/x.x.x.x.log</code> 文件里。</p>
<h3 id="systemd-service"><a class="toclink" href="../../../../software/2022/07/01/rsyslog-remote/#systemd-service">systemd service</a></h3>
<p>最后，写一个 systemd service 让它自动启动：</p>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">[Unit]</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">ConditionPathExists</span><span class="o">=</span><span class="err">/etc/rsyslog-remote.conf</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">Description</span><span class="o">=</span><span class="err">Remote Syslog Service</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">[Service]</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">Type</span><span class="o">=</span><span class="err">simple</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">PIDFile</span><span class="o">=</span><span class="err">/var/run/rsyslogd-remote.pid</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">ExecStart</span><span class="o">=</span><span class="err">/usr/sbin/rsyslogd -n -f /etc/rsyslog-remote.conf -i /var/run/rsyslogd-remote.pid</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">ExecReload</span><span class="o">=</span><span class="err">/bin/kill -HUP $MAINPID</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="k">[Install]</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="n">WantedBy</span><span class="o">=</span><span class="err">multi-user.target</span>
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>rsyslog-remote
</span></code></pre></div>
<p>这样就实现了远程日志的收集。</p>
<h3 id="logrotate-设置"><a class="toclink" href="../../../../software/2022/07/01/rsyslog-remote/#logrotate-设置">logrotate 设置</a></h3>
<p>为了防止日志太多，还需要配置 logrotate。</p>
<p>复制 <code>/etc/logrotate.d/rsyslog</code> 到 <code>/etc/logrotate.d/rsyslog-remote</code>，然后修改开头为 <code>/var/log/rsyslog-remote/*.log</code> 即可，路径和上面对应。注意脚本 <code>/usr/lib/rsyslog/rsyslog-remote</code> 也需要复制一份，然后修改一下 systemd service 名字。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../software/2022/07/01/rsyslog-remote/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://www.makeuseof.com/set-up-linux-remote-logging-using-rsyslog/">How to Set Up Remote Logging on Linux Using rsyslog</a></li>
<li><a href="https://www.thegeekdiary.com/configuring-remote-logging-using-rsyslog-in-centos-rhel/">Configuring Remote Logging using rsyslog in CentOS/RHEL</a></li>
<li><a href="https://www.tecmint.com/install-rsyslog-centralized-logging-in-centos-ubuntu/">How to Setup Central Logging Server with Rsyslog in Linux</a></li>
<li><a href="https://www.tecmint.com/setup-rsyslog-client-to-send-logs-to-rsyslog-server-in-centos-7/">How to Setup Rsyslog Client to Send Logs to Rsyslog Server in CentOS 7</a></li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-06-07 00:00:00+00:00">2022年6月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nix-cookbook"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/">Nix Cookbook</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#背景">背景</a></h3>
<p>最近在尝试 NixOS 和在 macOS 上跑 Nix，下面记录一些我在使用过程中遇到的一些小问题和解决思路。</p>
<h3 id="nixos"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#nixos">NixOS</a></h3>
<h4 id="全局配置"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#全局配置">全局配置</a></h4>
<p>NixOS 的全局配置路径：<code>/etc/nixos/configuration.nix</code> 和 <code>/etc/nixos/hardware-configuration.nix</code></p>
<p>应用更新后的全局配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>nixos-rebuild<span class="w"> </span>switch
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="c1"># or</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--upgrade
</span></code></pre></div>
<p>应用 Flakes 配置文件并显示变化：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">)</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">home</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/nix/var/nix/profiles/&quot;</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="n">old</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">system&quot;</span><span class="p">)</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo nixos-rebuild switch --flake .&quot;</span><span class="p">)</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="n">new</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">system&quot;</span><span class="p">)</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nix store diff-closures </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="更新大版本"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#更新大版本">更新大版本</a></h4>
<p>如果要更新 NixOS 21.11 到 22.05:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>nix-channel<span class="w"> </span>--list
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>nix-channel<span class="w"> </span>--add<span class="w"> </span>https://nixos.org/channels/nixos-22.05<span class="w"> </span>nixos
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--upgrade
</span></code></pre></div>
<p>可以考虑改或者不改 <code>/etc/nixos/configuration.nix</code> 中的 <code>system.stateVersion</code>。</p>
<h4 id="常用配置"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#常用配置">常用配置</a></h4>
<p>常用的 NixOS 配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c1"># Enable XFCE</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>services<span class="o">.</span>xserver<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>services<span class="o">.</span>xserver<span class="o">.</span>desktopManager<span class="o">.</span>xfce<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="c1"># System wide packages</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>environment<span class="o">.</span><span class="ss">systemPackages</span> <span class="o">=</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>  xxx
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="p">];</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="c1"># Fish shell</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>users<span class="o">.</span>users<span class="o">.</span><span class="ss">xxx</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a>  <span class="ss">shell</span> <span class="o">=</span> pkgs<span class="o">.</span>fish<span class="p">;</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="p">}</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="c1"># Command not found</span>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a>programs<span class="o">.</span>command-not-found<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a>
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="c1"># Steam gaming</span>
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfree</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a>programs<span class="o">.</span>steam<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a>
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="c1"># NOPASSWD for sudo</span>
</span><span id="__span-59-24"><a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>security<span class="o">.</span>sudo<span class="o">.</span><span class="ss">wheelNeedsPassword</span> <span class="o">=</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-59-25"><a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a>
</span><span id="__span-59-26"><a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a><span class="c1"># QEMU guest</span>
</span><span id="__span-59-27"><a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a>services<span class="o">.</span>qemuGuest<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-28"><a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a>services<span class="o">.</span>spice-vdagentd<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-29"><a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a>
</span><span id="__span-59-30"><a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a><span class="c1"># XRDP</span>
</span><span id="__span-59-31"><a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-32"><a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">defaultWindowManager</span> <span class="o">=</span> <span class="s2">&quot;xfce4-session&quot;</span><span class="p">;</span>
</span><span id="__span-59-33"><a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">openFirewall</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-34"><a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a>
</span><span id="__span-59-35"><a id="__codelineno-59-35" name="__codelineno-59-35" href="#__codelineno-59-35"></a><span class="c1"># OpenSSH server</span>
</span><span id="__span-59-36"><a id="__codelineno-59-36" name="__codelineno-59-36" href="#__codelineno-59-36"></a>services<span class="o">.</span>openssh<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-59-37"><a id="__codelineno-59-37" name="__codelineno-59-37" href="#__codelineno-59-37"></a>
</span><span id="__span-59-38"><a id="__codelineno-59-38" name="__codelineno-59-38" href="#__codelineno-59-38"></a><span class="c1"># Udev rules for Altera USB Blaster</span>
</span><span id="__span-59-39"><a id="__codelineno-59-39" name="__codelineno-59-39" href="#__codelineno-59-39"></a>services<span class="o">.</span>udev<span class="o">.</span><span class="ss">packages</span> <span class="o">=</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-59-40"><a id="__codelineno-59-40" name="__codelineno-59-40" href="#__codelineno-59-40"></a>  usb-blaster-udev-rules
</span><span id="__span-59-41"><a id="__codelineno-59-41" name="__codelineno-59-41" href="#__codelineno-59-41"></a><span class="p">];</span>
</span></code></pre></div>
<h4 id="vscode-remote"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#vscode-remote">VSCode Remote</a></h4>
<p>VSCode Remote 会在远程的机器上运行一个预编译的 nodejs，运行的时候会因为路径问题无法执行。</p>
<p>解决方法在 <a href="https://nixos.wiki/wiki/Visual_Studio_Code#Remote_SSH">NixOS Wiki</a> 上有，具体来说，首先，需要安装 <code>nodejs</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>environment<span class="o">.</span><span class="ss">systemPackages</span> <span class="o">=</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>  nodejs-16_x <span class="c1"># vscode remote</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="p">];</span>
</span></code></pre></div>
<p>然后，用软链接来覆盖 nodejs：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="nb">cd</span><span class="w"> </span>~/.vscode-server/bin/HASH
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/run/current-system/sw/bin/node
</span></code></pre></div>
<p>这样就可以正常使用 VSCode Remote 了。</p>
<h3 id="home-manager"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#home-manager">Home Manager</a></h3>
<p><a href="https://github.com/nix-community/home-manager">Home Manager</a> 描述用户默认看到的程序，而 NixOS 的配置是所有用户的。</p>
<h4 id="配置文件"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#配置文件">配置文件</a></h4>
<p>配置文件：<code>~/.config/nixpkgs/home.nix</code></p>
<p>应用配置文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>home-manager<span class="w"> </span>switch
</span></code></pre></div>
<p>应用 Flakes 配置文件并显示变化：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">)</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="n">home</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/nix/var/nix/profiles/per-user/</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">/&quot;</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="n">old</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">profile&quot;</span><span class="p">)</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;home-manager switch --flake .&quot;</span><span class="p">)</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="n">new</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">profile&quot;</span><span class="p">)</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nix store diff-closures </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="常用配置_1"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#常用配置_1">常用配置</a></h4>
<p>常用的 Home Manager 配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c1"># Allow unfree</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfree</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfreePredicate</span> <span class="o">=</span> <span class="p">(</span>pkg<span class="p">:</span> <span class="no">true</span><span class="p">);</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="c1"># User wide packages</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>home<span class="o">.</span><span class="ss">packages</span> <span class="o">=</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>  xxx
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="p">];</span>
</span></code></pre></div>
<p>生成 Nix 配置 <code>~/.config/nix/nix.conf</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># Enable flakes &amp; setup TUNA mirror</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>nix<span class="o">.</span><span class="ss">package</span> <span class="o">=</span> pkgs<span class="o">.</span>nix<span class="p">;</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>nix<span class="o">.</span><span class="ss">settings</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>  <span class="ss">experimental-features</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;nix-command&quot;</span> <span class="s2">&quot;flakes&quot;</span> <span class="p">];</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>  <span class="ss">substituters</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store&quot;</span> <span class="s2">&quot;https://cache.nixos.org/&quot;</span><span class="p">];</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="p">};</span>
</span></code></pre></div>
<p>Shell 环境变量和 PATH：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>home<span class="o">.</span><span class="ss">sessionVariables</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>  <span class="ss">A</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">;</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="p">};</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>home<span class="o">.</span><span class="ss">sessionPath</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>  <span class="s2">&quot;$HOME/.local/bin&quot;</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="p">];</span>
</span></code></pre></div>
<p>离线 Home Manager 文档（用 <code>home-manager-help</code> 命令打开）：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>manual<span class="o">.</span>html<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="覆盖依赖版本"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#覆盖依赖版本">覆盖依赖版本</a></h4>
<p>设置 JVM 程序依赖的 JDK 版本：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># Maven with java 11</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>home<span class="o">.</span><span class="ss">packages</span> <span class="o">=</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>  <span class="p">(</span>maven<span class="o">.</span>override <span class="p">{</span> <span class="ss">jdk</span> <span class="o">=</span> jdk11<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="p">];</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="c1"># Many packages with the same JDK</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>home<span class="o">.</span><span class="ss">packages</span> <span class="o">=</span> 
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>  <span class="k">let</span> <span class="ss">java</span> <span class="o">=</span> pkgs<span class="o">.</span>jdk11<span class="p">;</span> <span class="k">in</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>  <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>    <span class="p">(</span>maven<span class="o">.</span>override <span class="p">{</span> <span class="ss">jdk</span> <span class="o">=</span> java<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>    <span class="p">(</span>sbt<span class="o">.</span>override <span class="p">{</span> <span class="ss">jre</span> <span class="o">=</span> java<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>  <span class="p">];</span>
</span></code></pre></div>
<p>具体的参数命名要看 nixpkgs 上对应的包的开头。</p>
<h4 id="配置-direnv"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#配置-direnv">配置 direnv</a></h4>
<p>direnv 是一个 shell 插件，它的用途是进入目录的时候，会根据 .envrc 来执行命令，比如自动进入 nix-shell 等。配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>programs<span class="o">.</span>direnv<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></code></pre></div>
<p>然后在工程路径下，编写 <code>.envrc</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>use_nix
</span></code></pre></div>
<p>那么，在 shell 进入目录的时候，就会自动获得 nix-shell 的环境变量。</p>
<h4 id="配置-fish"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#配置-fish">配置 fish</a></h4>
<p>可以在 home manager 配置中编写 fish 配置，这样它会自动生成 <code>~/.config/fish/config.fish</code> 文件：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">shellAliases</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>  <span class="ss">a</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span><span class="p">;</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="p">};</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">shellInit</span> <span class="o">=</span> <span class="s s-Multiline">&#39;&#39;</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="s s-Multiline">  # Rust</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="s s-Multiline">  set -x PATH ~/.cargo/bin $PATH</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="s s-Multiline">&#39;&#39;</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="配置-git"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#配置-git">配置 git</a></h4>
<p>同理，也可以在 home manager 中配置 git：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>programs<span class="o">.</span>git<span class="o">.</span>lfs<span class="o">.</span><span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">userName</span> <span class="o">=</span> <span class="s2">&quot;Someone&quot;</span><span class="p">;</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">userEmail</span> <span class="o">=</span> <span class="s2">&quot;mail@example.com&quot;</span><span class="p">;</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">extraConfig</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>  <span class="ss">core</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>    <span class="ss">quotepath</span> <span class="o">=</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>  <span class="p">};</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>  <span class="ss">pull</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>    <span class="ss">rebase</span> <span class="o">=</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>  <span class="p">};</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="p">};</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">ignores</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>  <span class="s2">&quot;.DS_Store&quot;</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a><span class="p">];</span>
</span></code></pre></div>
<p>生成的 <code>git</code> 配置在 <code>~/.config/git/config</code> 和 <code>~/.config/git/ignore</code>。</p>
<h3 id="flakes"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#flakes">Flakes</a></h3>
<p>Flakes 可以用来把多个系统的 nix 配置写在一个项目中。例如：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="p">{</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>  <span class="ss">description</span> <span class="o">=</span> <span class="s2">&quot;Nix configuration&quot;</span><span class="p">;</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>  <span class="ss">inputs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>    home-manager<span class="o">.</span><span class="ss">url</span> <span class="o">=</span> <span class="s2">&quot;github:nix-community/home-manager/release-22.05&quot;</span><span class="p">;</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>    nixpkgs<span class="o">.</span><span class="ss">url</span> <span class="o">=</span> <span class="s2">&quot;github:nixos/nixpkgs/nixos-22.05&quot;</span><span class="p">;</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>  <span class="p">};</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>  <span class="ss">outputs</span> <span class="o">=</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> home-manager <span class="p">}:</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>    <span class="p">{</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>      nixosConfigurations<span class="o">.</span><span class="ss">xxxx</span> <span class="o">=</span> nixpkgs<span class="o">.</span>lib<span class="o">.</span>nixosSystem <span class="p">{</span>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>        <span class="ss">system</span> <span class="o">=</span> <span class="s2">&quot;x86_64-linux&quot;</span><span class="p">;</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>        <span class="ss">modules</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>          <span class="l">./nixos/xxxx/configuration.nix</span>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a>          home-manager<span class="o">.</span>nixosModules<span class="o">.</span>home-manager
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>          <span class="l">./nixos/xxxx/home.nix</span>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a>        <span class="p">];</span>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a>      <span class="p">};</span>
</span><span id="__span-73-19"><a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a>      homeConfigurations<span class="o">.</span><span class="ss">yyyy</span> <span class="o">=</span> home-manager<span class="o">.</span>lib<span class="o">.</span>homeManagerConfiguration <span class="p">{</span>
</span><span id="__span-73-20"><a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a>        <span class="ss">configuration</span> <span class="o">=</span> <span class="nb">import</span> <span class="l">./home-manager/yyyy/home.nix</span><span class="p">;</span>
</span><span id="__span-73-21"><a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a>        <span class="ss">system</span> <span class="o">=</span> <span class="s2">&quot;aarch64-darwin&quot;</span><span class="p">;</span>
</span><span id="__span-73-22"><a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a>        <span class="ss">homeDirectory</span> <span class="o">=</span> <span class="s2">&quot;/Users/yyyy&quot;</span><span class="p">;</span>
</span><span id="__span-73-23"><a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a>        <span class="ss">username</span> <span class="o">=</span> <span class="s2">&quot;yyyy&quot;</span><span class="p">;</span>
</span><span id="__span-73-24"><a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a>        <span class="ss">stateVersion</span> <span class="o">=</span> <span class="s2">&quot;22.05&quot;</span><span class="p">;</span>
</span><span id="__span-73-25"><a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a>      <span class="p">};</span>
</span><span id="__span-73-26"><a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a>    <span class="p">};</span>
</span><span id="__span-73-27"><a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后，要应用上面的配置，运行：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># NixOS</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="c1"># Home manager</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>home-manager<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.
</span></code></pre></div>
<p>这样就可以把若干个系统上的 nix 配置管理在一个仓库中了。</p>
<h3 id="实用工具"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#实用工具">实用工具</a></h3>
<h4 id="nixpkgs-fmt"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#nixpkgs-fmt">nixpkgs-fmt</a></h4>
<p><a href="https://github.com/nix-community/nixpkgs-fmt">nixpkgs-fmt</a> 用来格式化 Nix 代码。</p>
<h4 id="searchnixosorg"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#searchnixosorg">search.nixos.org</a></h4>
<p><a href="https://search.nixos.org/">search.nixos.org</a> 可以搜索 nixpkgs 上的各种包，也可以看到不同平台支持情况。缺点是看不出是否 unfree 和 broken，并且一些 darwin os-specific 的包不会显示。</p>
<h4 id="nix-tree"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#nix-tree">nix-tree</a></h4>
<p>显示各个 nix derivation 的硬盘占用和依赖关系。</p>
<h3 id="打包"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#打包">打包</a></h3>
<p>可以很容易地编写 <code>default.nix</code> 来给自己的项目打包。</p>
<h4 id="cmake"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#cmake">CMake</a></h4>
<p>对于一个简单的 cmake 程序，可以按照如下的格式编写 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="k">with</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{};</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>stdenv<span class="o">.</span>mkDerivation <span class="p">{</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>  <span class="ss">version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>  <span class="ss">src</span> <span class="o">=</span> <span class="l">./.</span><span class="p">;</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>  <span class="ss">nativeBuildInputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>    cmake
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>  <span class="p">];</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>  <span class="ss">buildInputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>    xxx
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>    yyy
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>  <span class="p">];</span>
</span><span id="__span-75-17"><a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以用 <code>nix-build</code> 命令来构建，生成结果会在当前目录下创建一个 <code>result</code> 的软链接，里面就是安装目录。</p>
<p>由于 <code>nix-build</code> 的时候也会创建 <code>build</code> 目录，为了防止冲突，建议开发的时候用其他的名字。</p>
<h4 id="qt"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#qt">Qt</a></h4>
<p>对于 Qt 项目来说，由于有不同的 Qt 大版本，所以实现的时候稍微复杂一些，要拆成两个文件，首先是 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="k">with</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{};</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>libsForQt5<span class="o">.</span>callPackage <span class="l">./xxx.nix</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></div>
<p>这里就表示用 <code>qt5</code> 来编译，那么编写 <code>xxx.nix</code> 的时候，传入的 <code>qtbase</code> 等库就是 <code>qt5</code> 的版本：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="p">{</span> stdenv<span class="p">,</span> qtbase<span class="p">,</span> wrapQtAppsHook<span class="p">,</span> cmake <span class="p">}:</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>stdenv<span class="o">.</span>mkDerivation <span class="p">{</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span><span class="p">;</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>  <span class="ss">version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>  <span class="ss">src</span> <span class="o">=</span> <span class="l">./.</span><span class="p">;</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>  <span class="ss">nativeBuildInputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>    cmake
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>    wrapQtAppsHook <span class="c1"># must-have for qt apps</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>  <span class="p">];</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>  <span class="ss">buildInputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a>    qtbase
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a>  <span class="p">];</span>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际测试中发现，运行的程序可能会报告 <code>Could not initialize GLX</code> 的错误，这个方法可以通过 <code>wrapProgram</code> 添加环境变量解决：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>  # https://github.com/NixOS/nixpkgs/issues/66755#issuecomment-657305962
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>  # Fix &quot;Could not initialize GLX&quot; error
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>  postInstall = &#39;&#39;
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    wrapProgram &quot;$out/bin/xxx&quot; --set QT_XCB_GL_INTEGRATION none
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>  &#39;&#39;;
</span></code></pre></div>
<h3 id="开发环境"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#开发环境">开发环境</a></h3>
<p>除了打包以外，通常还会在 <code>shell.nix</code> 中定义开发环境需要的包：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="p">{</span> pkgs <span class="o">?</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{}</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="p">}:</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>pkgs<span class="o">.</span>mkShell <span class="p">{</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>  <span class="ss">buildInputs</span> <span class="o">=</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>    cmake
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>  <span class="p">];</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后可以用 <code>nix-shell</code> 来进入开发环境。如果不希望外面的环境变量传递进去，可以用 <code>nix-shell --pure</code>。</p>
<h3 id="搜索"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#搜索">搜索</a></h3>
<p>按名字搜索一个包：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>nix<span class="w"> </span>search<span class="w"> </span>nixpkgs<span class="w"> </span>xxx
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>nix-env<span class="w"> </span>-qaP<span class="w"> </span>yyy
</span></code></pre></div>
<h3 id="nixpkgs"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#nixpkgs">Nixpkgs</a></h3>
<p>可以从 TUNA 镜像上先 clone 一份到本地，然后再添加 github 上游作为 remote。</p>
<p>从本地 nixpkgs 安装：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>nix-env<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>-iA<span class="w"> </span>xxx
</span></code></pre></div>
<p>从本地 nixpkgs 编译：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>nix-build<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>-A<span class="w"> </span>xxx
</span></code></pre></div>
<p>从本地 nixpkgs 开一个 shell：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>nix-shell<span class="w"> </span>-I<span class="w"> </span><span class="nv">nixpkgs</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>-p<span class="w"> </span>xxx
</span></code></pre></div>
<h4 id="nixpkgs-的分支"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#nixpkgs-的分支">Nixpkgs 的分支</a></h4>
<p>Nixpkgs 开发分支主要有三个：</p>
<ol>
<li>master</li>
<li>staging-next</li>
<li>staging</li>
</ol>
<p>发 PR 的时候，如果需要重新编译的包比较多，就要往 staging 提交；比较少，就往 staging-next 提交。</p>
<p>CI 会自动把 master 合并到 staging-next，也会把 staging-next 合并到 staging。这样 master 上的改动也会同步到 staging 上。</p>
<p>维护者会定义把 staging 手动合并到 staging-next，然后手动合并 staging-next 到 staging。这个的周期一般是一周多，可以在 pr 里搜索 staging-next。</p>
<p>Hydra 会编译 master 分支和 staging-next 分支上的包，不会编译 staging 分支上的包。同理，binary cache 上前两个分支上有的，而 staging 上没有的。</p>
<p>参考：<a href="https://nixos.org/manual/nixpkgs/stable/#submitting-changes-commit-policy">https://nixos.org/manual/nixpkgs/stable/#submitting-changes-commit-policy</a></p>
<h4 id="提交贡献"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#提交贡献">提交贡献</a></h4>
<p>注意事项：</p>
<ol>
<li>升级一些比较老的写法，例如 mkDerivation -&gt; stdenv.mkDerivation，Qt 的 hook</li>
<li>引入 patch 的时候，建议先向上游提 PR，如果合并了，就直接用上游的 commit；如果没有合并，退而求其次可以用 pr 的 patch；如果没有提 PR 的渠道，或者上游的 commit 无法应用到当前的版本，或者这个 patch 没有普适性，再写本地的 patch；注释里要写打 patch 的原因和相关的 issue 链接，什么时候不再需要这个 patch，并且起个名字</li>
<li>不知道 SHA256 的时候，可以注释掉或者随便写一个，这样 nix build 的时候会重新下载，然后把正确的显示出来</li>
<li>对于有命令的包，可以添加 testVersion 测试</li>
<li>长时间没有 review 的 pr，可以在 discourse 上回复帖子。</li>
<li>更新之前，可以搜索一下，有没有相关的 issue 或者 pr；如果有 issue，新建 pr 的时候要提一下</li>
</ol>
<p>一些常见的问题：</p>
<ol>
<li>编译器打开 <code>-fno-common</code> 后，可能会导致一些链接问题</li>
<li>Darwin 上的 clang 没有打开 LTO，也没有打开 Universal 支持</li>
<li>AArch64 Darwin 上的 gfortran 的 stack protector 不工作，需要把 hardening 关掉</li>
<li>当编译报错是 <code>-Werror</code> 导致的时候，按照 warning 类型在 NIX_CFLAGS_COMPILE 中添加 <code>-Wno-error=warning-type</code></li>
<li>configure 版本较老，需要引入 autoreconfHook</li>
</ol>
<p>阅读文档：<a href="https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/quick-start.chapter.md">https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/quick-start.chapter.md</a> 和 <a href="https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/coding-conventions.chapter.md">https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/coding-conventions.chapter.md</a></p>
<h3 id="vscode"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#vscode">VSCode</a></h3>
<p>可以安装 <a href="https://github.com/nix-community/vscode-nix-ide/">https://github.com/nix-community/vscode-nix-ide/</a> 插件，配合 <code>rnix-lsp</code> 来使用。</p>
<h3 id="杂项"><a class="toclink" href="../../../../software/2022/06/07/nix-cookbook/#杂项">杂项</a></h3>
<p>可以用 <code>nix copy</code> 命令在不同机器的 store 之间复制文件，见 <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-copy.html">nix copy - copy paths between Nix stores</a>。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-31 00:00:00+00:00">2022年5月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-libvirt-中运行-risc-v-虚拟机"><a class="toclink" href="../../../../software/2022/05/31/qemu-rv64-in-libvirt/">在 libvirt 中运行 RISC-V 虚拟机</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2022/05/31/qemu-rv64-in-libvirt/#背景">背景</a></h3>
<p>我在 libvirt 中跑了几个 KVM 加速的虚拟机，然后突发奇想，既然 libvirt 背后是 qemu，然后 qemu 是支持跨指令集的，那是否可以让 libvirt 来运行 RISC-V 架构的虚拟机？经过一番搜索，发现可以跑 ARM：<a href="https://fedoraproject.org/wiki/Architectures/ARM/HowToQemu#Using_QEMU_with_libvirt">How To: Running Fedora-ARM under QEMU</a>，既然如此，我们也可以试试用 libvirt 来运行 RV64 虚拟机。</p>
<h3 id="准备-rootfs"><a class="toclink" href="../../../../software/2022/05/31/qemu-rv64-in-libvirt/#准备-rootfs">准备 rootfs</a></h3>
<p>第一步是根据 Debian 的文档 <a href="https://wiki.debian.org/RISC-V#Creating_a_riscv64_chroot">Creating a riscv64 chroot</a> 来创建 rootfs，然后再用 virt-make-fs 来打包。</p>
<p>首先是用 mmdebstrap 来生成一个 chroot：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/riscv64-chroot
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>mmdebstrap<span class="w"> </span>qemu-user-static<span class="w"> </span>binfmt-support<span class="w"> </span>debian-ports-archive-keyring
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>mmdebstrap<span class="w"> </span>--architectures<span class="o">=</span>riscv64<span class="w"> </span>--include<span class="o">=</span><span class="s2">&quot;debian-ports-archive-keyring&quot;</span><span class="w"> </span>sid<span class="w"> </span>/tmp/riscv64-chroot<span class="w"> </span><span class="s2">&quot;deb http://deb.debian.org/debian-ports sid main&quot;</span><span class="w"> </span><span class="s2">&quot;deb http://deb.debian.org/debian-ports unreleased main&quot;</span>
</span></code></pre></div>
<p>进入 chroot 以后，进行一些配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>chroot<span class="w"> </span>/tmp/riscv64-chroot
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>$<span class="w"> </span>apt<span class="w"> </span>update
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>$<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>linux-image-riscv64<span class="w"> </span>u-boot-menu<span class="w"> </span>vim
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c1"># set root password</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>$<span class="w"> </span>passwd
</span></code></pre></div>
<p>然后修改 <code>/etc/default/u-boot</code> 文件，添加如下的配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># change ro to rw, set root device</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nv">U_BOOT_PARAMETERS</span><span class="o">=</span><span class="s2">&quot;rw noquiet root=/dev/vda1&quot;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c1"># fdt is provided by qemu</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="nv">U_BOOT_FDT_DIR</span><span class="o">=</span><span class="s2">&quot;noexist&quot;</span>
</span></code></pre></div>
<p>然后运行 <code>u-boot-update</code> 生成配置文件 <code>/boot/extlinux/extlinux.conf</code>。</p>
<p>到这里，rootfs 已经准备完毕。</p>
<h3 id="尝试在-qemu-中启动"><a class="toclink" href="../../../../software/2022/05/31/qemu-rv64-in-libvirt/#尝试在-qemu-中启动">尝试在 QEMU 中启动</a></h3>
<p>接下来，可以参考 <a href="https://wiki.debian.org/RISC-V#Setting_up_a_riscv64_virtual_machine">Setting up a riscv64 virtual machine</a> 先启动一个 qemu 来测试一下是否可以正常工作：</p>
<p>首先制作一个 qcow2 格式的镜像：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>virt-make-fs<span class="w"> </span>--partition<span class="o">=</span>gpt<span class="w"> </span>--type<span class="o">=</span>ext4<span class="w"> </span>--size<span class="o">=</span>+10G<span class="w"> </span>--format<span class="o">=</span>qcow2<span class="w"> </span>/tmp/riscv64-chroot<span class="w"> </span>rootfs.qcow2
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>$<span class="w"> </span>qemu-img<span class="w"> </span>info<span class="w"> </span>rootfs.qcow2
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>image:<span class="w"> </span>rootfs.qcow2
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>file<span class="w"> </span>format:<span class="w"> </span>qcow2
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>virtual<span class="w"> </span>size:<span class="w"> </span><span class="m">11</span>.4<span class="w"> </span>GiB<span class="w"> </span><span class="o">(</span><span class="m">12231971328</span><span class="w"> </span>bytes<span class="o">)</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>disk<span class="w"> </span>size:<span class="w"> </span><span class="m">1</span>.33<span class="w"> </span>GiB
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>cluster_size:<span class="w"> </span><span class="m">65536</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>Format<span class="w"> </span>specific<span class="w"> </span>information:
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span>compat:<span class="w"> </span><span class="m">1</span>.1
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span>compression<span class="w"> </span>type:<span class="w"> </span>zlib
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span>lazy<span class="w"> </span>refcounts:<span class="w"> </span><span class="nb">false</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span>refcount<span class="w"> </span>bits:<span class="w"> </span><span class="m">16</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span>corrupt:<span class="w"> </span><span class="nb">false</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">    </span>extended<span class="w"> </span>l2:<span class="w"> </span><span class="nb">false</span>
</span></code></pre></div>
<p>然后启动 qemu，配置好 OpenSBI 和 U-Boot 的路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>qemu-system-misc<span class="w"> </span>opensbi<span class="w"> </span>u-boot-qemu
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>qemu-system-riscv64<span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt<span class="w"> </span>-m<span class="w"> </span>8G<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span>-bios<span class="w"> </span>/usr/lib/riscv64-linux-gnu/opensbi/generic/fw_jump.elf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span>-kernel<span class="w"> </span>/usr/lib/u-boot/qemu-riscv64_smode/uboot.elf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span>-object<span class="w"> </span>rng-random,filename<span class="o">=</span>/dev/urandom,id<span class="o">=</span>rng0<span class="w"> </span>-device<span class="w"> </span>virtio-rng-device,rng<span class="o">=</span>rng0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span>-append<span class="w"> </span><span class="s2">&quot;console=ttyS0 rw root=/dev/vda1&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">    </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd0<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>rootfs.qcow2,format<span class="o">=</span>qcow2,id<span class="o">=</span>hd0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>usernet<span class="w"> </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>usernet,hostfwd<span class="o">=</span>tcp::22222-:22
</span></code></pre></div>
<p>如果系统可以正常工作，看到下面的输出，下一步就可以配置 libvirt 了。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>[    6.285024] Run /init as init process
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>Loading, please wait...
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>Starting version 251.1-1
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>[    7.743714] virtio_ring: module verification failed: signature and/or required key missing - tainting kernel
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>[    8.071762] virtio_blk virtio1: [vda] 23838189 512-byte logical blocks (12.2 GB/11.4 GiB)
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>[    8.181210]  vda: vda1
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>Begin: Loading essential drivers ... done.
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>Begin: Running /scripts/init-premount ... done.
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>Begin: Mounting root file system ... Begin: Running /scripts/local-top ... done.
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>Begin: Running /scripts/local-premount ... done.
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>Warning: fsck not present, so skipping root file system
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>[    9.003143] EXT4-fs (vda1): mounted filesystem with ordered data mode. Quota mode: none.
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>done.
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>Begin: Running /scripts/local-bottom ... done.
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>Begin: Running /scripts/init-bottom ... done.
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>[    9.754151] Not activating Mandatory Access Control as /sbin/tomoyo-init does not exist.
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>[    9.808860] random: fast init done
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>[   10.651361] systemd[1]: Inserted module &#39;autofs4&#39;
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>[   10.735574] systemd[1]: systemd 251.1-1 running in system mode (+PAM +AUDIT +SELINUX +APPARMOR +IMA +SMACK +SECCOMP +GCRYPT -GNUTLS +OPENSSL +ACL +BLKID +CURL +ELFUTILS +FIDO2 +IDN2 -IDN +IPTC +KMOD +LIBCRYPTSETUP +LIBFDISK +PCRE2 -PWQUALITY -P11KIT -QRENCODE +TPM2 +BZIP2 +LZ4 +XZ +ZLIB +ZSTD -BPF_FRAMEWORK -XKBCOMMON +UTMP +SYSVINIT default-hierarchy=unified)
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>[   10.736902] systemd[1]: Detected architecture riscv64.
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>Welcome to Debian GNU/Linux bookworm/sid!
</span></code></pre></div>
<h3 id="配置-libvirt"><a class="toclink" href="../../../../software/2022/05/31/qemu-rv64-in-libvirt/#配置-libvirt">配置 libvirt</a></h3>
<p>首先，打开 virt-manager，在向导中，可以在下拉菜单选择自定义的架构，选择 riscv64 和 virt，然后选择 Import existing disk image，找到刚刚创建的 qcow2 文件。</p>
<p>创建好以后，我们还不能直接启动，因为此时还没有配置 OpenSBI 和 U-Boot。由于 virt-aa-helper 会<a href="https://github.com/wiedi/libvirt/blob/435b4ad22bf812d97f30e4d6b71e6b3a967f4f75/src/security/virt-aa-helper.c#L529">检查 OpenSBI 和 U-Boot 的路径，要求它们不能在 /usr/lib 路径下</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="cm">/*</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="cm"> * Don&#39;t allow access to special files or restricted paths such as /bin, /sbin,</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="cm"> * /usr/bin, /usr/sbin and /etc. This is in an effort to prevent read/write</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="cm"> * access to system files which could be used to elevate privileges. This is a</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="cm"> * safety measure in case libvirtd is under a restrictive profile and is</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="cm"> * subverted and trying to escape confinement.</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="cm"> *</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="cm"> * Note that we cannot exclude block devices because they are valid devices.</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="cm"> * The TEMPLATE file can be adjusted to explicitly disallow these if needed.</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="cm"> *</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="cm"> * RETURN: -1 on error, 0 if ok, 1 if blocked</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="cm"> */</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">restricted</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">        </span><span class="s">&quot;/bin/&quot;</span><span class="p">,</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">        </span><span class="s">&quot;/etc/&quot;</span><span class="p">,</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">        </span><span class="s">&quot;/lib&quot;</span><span class="p">,</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">        </span><span class="s">&quot;/lost+found/&quot;</span><span class="p">,</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">        </span><span class="s">&quot;/proc/&quot;</span><span class="p">,</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">        </span><span class="s">&quot;/sbin/&quot;</span><span class="p">,</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">        </span><span class="s">&quot;/selinux/&quot;</span><span class="p">,</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">        </span><span class="s">&quot;/sys/&quot;</span><span class="p">,</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">        </span><span class="s">&quot;/usr/bin/&quot;</span><span class="p">,</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">        </span><span class="s">&quot;/usr/lib&quot;</span><span class="p">,</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">        </span><span class="s">&quot;/usr/sbin/&quot;</span><span class="p">,</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">        </span><span class="s">&quot;/usr/share/&quot;</span><span class="p">,</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">        </span><span class="s">&quot;/usr/local/bin/&quot;</span><span class="p">,</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">        </span><span class="s">&quot;/usr/local/etc/&quot;</span><span class="p">,</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">        </span><span class="s">&quot;/usr/local/lib&quot;</span><span class="p">,</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">        </span><span class="s">&quot;/usr/local/sbin/&quot;</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<p>所以，我手动把 U-Boot 和 OpenSBI 复制一份到 /var/lib 下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/lib/custom
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/var/lib/custom
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>/usr/lib/u-boot/qemu-riscv64_smode<span class="w"> </span>.
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>$<span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>/usr/lib/riscv64-linux-gnu<span class="w"> </span>.
</span></code></pre></div>
<p>此时，再去配置 libvirt 的 XML 配置文件：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="w">  </span><span class="nt">&lt;os&gt;</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="nt">&lt;type</span><span class="w"> </span><span class="na">arch=</span><span class="s">&#39;riscv64&#39;</span><span class="w"> </span><span class="na">machine=</span><span class="s">&#39;virt&#39;</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="nt">&lt;loader</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;rom&#39;</span><span class="nt">&gt;</span>/var/lib/custom/riscv64-linux-gnu/opensbi/generic/fw_jump.elf<span class="nt">&lt;/loader&gt;</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="nt">&lt;kernel&gt;</span>/var/lib/custom/qemu-riscv64_smode/uboot.elf<span class="nt">&lt;/kernel&gt;</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="nt">&lt;boot</span><span class="w"> </span><span class="na">dev=</span><span class="s">&#39;hd&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">  </span><span class="nt">&lt;/os&gt;</span>
</span></code></pre></div>
<p>其余部分不用修改。在下面可以看到 virt-manager 已经设置好了 qemu-system-riscv64:</p>
<div class="language-XML highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nt">&lt;devices&gt;</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">  </span><span class="nt">&lt;emulator&gt;</span>/usr/bin/qemu-system-riscv64<span class="nt">&lt;/emulator&gt;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">  </span><span class="nt">&lt;disk</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;file&#39;</span><span class="w"> </span><span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="nt">&lt;driver</span><span class="w"> </span><span class="na">name=</span><span class="s">&#39;qemu&#39;</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;qcow2&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="nt">&lt;source</span><span class="w"> </span><span class="na">file=</span><span class="s">&#39;/path/to/rootfs.qcow2&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span><span class="nt">&lt;target</span><span class="w"> </span><span class="na">dev=</span><span class="s">&#39;vda&#39;</span><span class="w"> </span><span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span><span class="nt">&lt;address</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;pci&#39;</span><span class="w"> </span><span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span><span class="w"> </span><span class="na">bus=</span><span class="s">&#39;0x04&#39;</span><span class="w"> </span><span class="na">slot=</span><span class="s">&#39;0x00&#39;</span><span class="w"> </span><span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">  </span><span class="nt">&lt;/disk&gt;</span>
</span></code></pre></div>
<p>保存以后直接启动，就完成了在 libvirt 中运行 Debian RV64 虚拟机的目的。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-02 00:00:00+00:00">2022年5月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="loongarch64-工具链构建"><a class="toclink" href="../../../../software/2022/05/02/loongarch64-toolchain/">LoongArch64 工具链构建</a></h2>
<p>最近因为龙芯杯的原因，想自己搞个 LoongArch64 的交叉编译工具链试试，结果遇到了很多坑，最后终于算是搞出来了。</p>
<p>一开始是想搞一个 newlib 的工具链，比较简单，而且之前做过一个仓库：<a href="https://github.com/jiegec/riscv-toolchain">jiegec/riscv-toolchain</a>，就是构建的 riscv64-unknown-elf 工具链，照着 riscv-gnu-toolchain 就可以了。不过研究发现，newlib 还不支持 loongarch，目前只有 glibc 支持，只好硬着头皮上了。</p>
<p>于是我就在 riscv-toolchain 的基础上搞 loongarch64-unknown-linux-gnu，也就是带 glibc 的工具链，结果发现遇到很多坑。首先编译 libgcc 的时候就找不到头文件，于是先要从 glibc 和 linux 安装头文件到 sysroot 里面，对于 sysroot 里面的头文件路径到底是 include 还是 usr/include 也折腾了半天。然后编译 libgcc 又各种出问题，最后折腾了半天，结果是 gcc stage1 和 glibc 都没问题，gcc stage2 会报链接错误，但是不管它也能用，可以编译出正常的程序，毕竟 libc 是好的。</p>
<p>于是转念一想，要不要试试 crosstool-ng。克隆了一份上游的版本，照着 riscv 的部分抄了一份变成了 loongarch，然后把 config 里面的 linux/glibc/gcc/binutils-gdb 都替换为 custom location，这样我就可以用上游的最新版本了。中途还遇到了 <a href="https://github.com/crosstool-ng/crosstool-ng/issues/1564">crosstool-ng 对 gcc 12/13 不兼容的 bug</a>，还好下面有人提出了解决方法。这些都搞定以后，终于构建出了一个完整的 loongarch64-unknown-linux-gnu 工具链。仓库地址是 <a href="https://github.com/jiegec/ct-ng-loongarch64">jiegec/ct-ng-loongarch64</a>，需要配合添加了 LoongArch 的 <a href="https://github.com/jiegec/crosstool-ng/tree/loongarch">jiegec/crosstool-ng loongarch 分支</a> 使用。</p>
<p>最后得到的工具链各组件版本如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>loongarch64-unknown-linux-gnu-gcc (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.0 20220502 (experimental)
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>This is free software; see the source for copying conditions.  There is NO
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>GNU ld (crosstool-NG 1.25.0_rc2.1_7e21141) 2.38.50.20220502
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>This program is free software; you may redistribute it under the terms of
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>the GNU General Public License version 3 or (at your option) a later version.
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>This program has absolutely no warranty.
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>GNU gdb (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.50.20220502-git
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>This is free software: you are free to change and redistribute it.
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>There is NO WARRANTY, to the extent permitted by law.
</span></code></pre></div>
<p>之后有时间的话，再把 qemu 和系统搞起来跑跑。</p>
<p>UPDATE: GCC 12.1 发布了，试了一下这个正式版本可以正确地编译。目前还需要使用 HEAD 版本的 binutils 和龙芯的 glibc 和 linux。</p>
<p>参考文档：</p>
<ul>
<li><a href="https://github.com/sunhaiyong1978/CLFS-for-LoongArch/blob/main/CLFS_For_LoongArch64-20220108.md">手把手教你构建基于 LoongArch64 架构的 Linux 系统</a></li>
<li><a href="https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/">How to Build a GCC Cross-Compiler</a></li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-25 00:00:00+00:00">2022年1月25日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="risc-v-vector-10-工具链构建"><a class="toclink" href="../../../../software/2022/01/25/rvv-1.0-toolchain/">RISC-V Vector 1.0 工具链构建</a></h2>
<p>不久前 RVV 1.0 标准终于是出来了，但是工具链的支持目前基本还处于刚 upstream 还没有 release 的状态。而目前 RVV 1.0 的支持主要在 LLVM 上比较活跃，因此也是采用 LLVM Clang + GCC Newlib Toolchain 的方式进行配合，前者做 RVV 1.0 的编译，后者提供 libc 等基础库。</p>
<p>UPDATE: LLVM 14 已经发布，这个版本已经支持 RVV 1.0，直接从 https://apt.llvm.org 等地安装 LLVM 14 即可。</p>
<p>LLVM Clang 直接采用 upstream 即可。编译选项：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>$<span class="w"> </span>cmake<span class="w"> </span>-G<span class="w"> </span>Ninja<span class="w"> </span>../llvm<span class="w"> </span>-DCMAKE_C_COMPILER<span class="o">=</span>clang<span class="w"> </span>-DCMAKE_CXX_COMPILER<span class="o">=</span>clang++<span class="w"> </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span>/prefix/llvm<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>-DLLVM_ENABLE_PROJECTS<span class="o">=</span><span class="s2">&quot;clang&quot;</span><span class="w"> </span>-DLLVM_TARGETS_TO_BUILD<span class="o">=</span><span class="s2">&quot;RISCV&quot;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>$<span class="w"> </span>ninja
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>$<span class="w"> </span>ninja<span class="w"> </span>install
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>$<span class="w"> </span>/prefix/llvm/bin/clang<span class="w"> </span>--version
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>clang<span class="w"> </span>version<span class="w"> </span><span class="m">14</span>.0.0<span class="w"> </span><span class="o">(</span>https://github.com/llvm/llvm-project.git<span class="w"> </span>8d298355ca3778a47fd6b3110aeee03ea5e8e02b<span class="o">)</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>Target:<span class="w"> </span>x86_64-unknown-linux-gnu
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>Thread<span class="w"> </span>model:<span class="w"> </span>posix
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>InstalledDir:<span class="w"> </span>/data/llvm/bin
</span></code></pre></div>
<p>还需要配合一个 GCC 工具链才可以完整地工作。可以直接采用 riscv-gnu-toolchain nightly 版本，比如 <a href="https://github.com/riscv-collab/riscv-gnu-toolchain/releases/download/2022.01.17/riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz">riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz</a>。下载以后解压，得到 riscv 目录，GCC 版本是比较新的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-gcc<span class="w"> </span>--version
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>riscv64-unknown-elf-gcc<span class="w"> </span><span class="o">(</span>GCC<span class="o">)</span><span class="w"> </span><span class="m">11</span>.1.0
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2021</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>see<span class="w"> </span>the<span class="w"> </span><span class="nb">source</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>copying<span class="w"> </span>conditions.<span class="w">  </span>There<span class="w"> </span>is<span class="w"> </span>NO
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>warranty<span class="p">;</span><span class="w"> </span>not<span class="w"> </span>even<span class="w"> </span><span class="k">for</span><span class="w"> </span>MERCHANTABILITY<span class="w"> </span>or<span class="w"> </span>FITNESS<span class="w"> </span>FOR<span class="w"> </span>A<span class="w"> </span>PARTICULAR<span class="w"> </span>PURPOSE.
</span></code></pre></div>
<p>但是如果编译 C++ 程序，链接的时候就会报错：<code>prefixed ISA extension must separate with _</code>，这是因为 riscv-gnu-toolchain 仓库的 binutils 版本不够新，在 upstream 的 binutils 里面已经修复了这个问题。所以 clone 下来，然后编译，覆盖掉 riscv-gnu-toolchain 里面的 binutils：</p>
<p>UPDATE: binutils 2.38 已经发布，用这个版本即可。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>../configure<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>--disable-gdb<span class="w"> </span>--disable-sim<span class="w"> </span>--disable-libdecnumber<span class="w"> </span>--disable-readline
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>$<span class="w"> </span>make
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>$<span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-ld<span class="w"> </span>--version
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>GNU<span class="w"> </span>Binutils<span class="o">)</span><span class="w"> </span><span class="m">2</span>.38.50.20220125
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2022</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>This<span class="w"> </span>program<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>you<span class="w"> </span>may<span class="w"> </span>redistribute<span class="w"> </span>it<span class="w"> </span>under<span class="w"> </span>the<span class="w"> </span>terms<span class="w"> </span>of
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>the<span class="w"> </span>GNU<span class="w"> </span>General<span class="w"> </span>Public<span class="w"> </span>License<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span><span class="o">(</span>at<span class="w"> </span>your<span class="w"> </span>option<span class="o">)</span><span class="w"> </span>a<span class="w"> </span>later<span class="w"> </span>version.
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>This<span class="w"> </span>program<span class="w"> </span>has<span class="w"> </span>absolutely<span class="w"> </span>no<span class="w"> </span>warranty.
</span></code></pre></div>
<p>然后编译程序的时候，使用 clang，配置参数 <code>--gcc-toolchain=~/riscv</code> 即可让 clang 找到 GNU 工具链。这样就可以编译出来 RVV 1.0 的程序了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>/llvm/bin/clang<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>-O2<span class="w"> </span>-march<span class="o">=</span>rv64gcv1p0<span class="w"> </span>-menable-experimental-extensions<span class="w"> </span>-mllvm<span class="w"> </span>--riscv-v-vector-bits-min<span class="o">=</span><span class="m">256</span><span class="w"> </span>--gcc-toolchain<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>add.cpp<span class="w"> </span>-o<span class="w"> </span>add
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>$<span class="w"> </span>/data/llvm/bin/llvm-objdump<span class="w"> </span>--mattr<span class="o">=</span>+v<span class="w"> </span>-S<span class="w"> </span>add
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">   </span>1020e:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">70</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>c5<span class="w">   </span>vsetivli<span class="w">        </span>zero,<span class="w"> </span><span class="m">8</span>,<span class="w"> </span>e32,<span class="w"> </span>m1,<span class="w"> </span>ta,<span class="w"> </span>mu
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">   </span><span class="m">10212</span>:<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>t1<span class="o">)</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">   </span><span class="m">10216</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span>e4<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>t2<span class="o">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">   </span>1021a:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">07</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a4,<span class="w"> </span>-32
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">   </span>1021e:<span class="w"> </span><span class="m">07</span><span class="w"> </span>e5<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v10,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">   </span><span class="m">10222</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v11,<span class="w"> </span><span class="o">(</span>a4<span class="o">)</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">   </span><span class="m">10226</span>:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">85</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v8,<span class="w"> </span>v8,<span class="w"> </span>v10
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">   </span>1022a:<span class="w"> </span>d7<span class="w"> </span><span class="m">94</span><span class="w"> </span><span class="m">95</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v9,<span class="w"> </span>v9,<span class="w"> </span>v11
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">   </span>1022e:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">05</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a0,<span class="w"> </span>-32
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">   </span><span class="m">10232</span>:<span class="w"> </span><span class="m">27</span><span class="w"> </span>e4<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">   </span><span class="m">10236</span>:<span class="w"> </span>a7<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">05</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>a0<span class="o">)</span>
</span></code></pre></div>
<p>可以看到 llvm 的自动向量化是工作的。此外，也可以编写 rvv intrinsic。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-29 00:00:00+00:00">2021年12月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="xrdp-和-nvidia-显卡兼容性问题"><a class="toclink" href="../../../../software/2021/12/29/xrdp-nvidia/">XRDP 和 NVIDIA 显卡兼容性问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/12/29/xrdp-nvidia/#背景">背景</a></h3>
<p>最近在尝试配置 XRDP，发现它在有 NVIDIA 的机器上启动远程桌面后会黑屏，查看错误信息可以看到：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>xf86OpenConsole: Cannot open virtual console 1 (Permission denied)
</span></code></pre></div>
<p>2024 年注：一些比较新的发行版上携带的 xrdp 已经没有这个问题，此外不要忘记安装 xorgxrdp。</p>
<h3 id="解决方法"><a class="toclink" href="../../../../software/2021/12/29/xrdp-nvidia/#解决方法">解决方法</a></h3>
<p>XRDP 作者在 <a href="https://github.com/neutrinolabs/xrdp/issues/2010#issuecomment-942561105">issue #2010</a> 中提到了解决方法：</p>
<p>修改 /etc/xrdp/sesman.ini，在 <code>[Xorg]</code> 部分里加上下面的配置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>param=-configdir
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>param=/
</span></code></pre></div>
<p>实际上就是不让 Xorg 加载 nvidia xorg 驱动，这样就绕过了问题。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-26 00:00:00+00:00">2021年12月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nvidia-驱动和-cuda-版本信息速查"><a class="toclink" href="../../../../software/2021/12/26/nvidia-cuda/">NVIDIA 驱动和 CUDA 版本信息速查</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/12/26/nvidia-cuda/#背景">背景</a></h3>
<p>之前和 NVIDIA 驱动和 CUDA 搏斗比较多，因此记录一下一些常用信息，方便查询。</p>
<h3 id="常用地址"><a class="toclink" href="../../../../software/2021/12/26/nvidia-cuda/#常用地址">常用地址</a></h3>
<ul>
<li><a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux">CUDA Toolkit Downloads</a></li>
<li><a href="https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html">NVIDIA Driver Installation Quickstart Guide</a></li>
<li><a href="https://www.nvidia.com/Download/index.aspx">NVIDIA Driver Downloads</a></li>
<li><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html">NVIDIA Docker Installation Guide</a></li>
</ul>
<h3 id="cuda-版本与-nvidia-驱动兼容性"><a class="toclink" href="../../../../software/2021/12/26/nvidia-cuda/#cuda-版本与-nvidia-驱动兼容性">CUDA 版本与 NVIDIA 驱动兼容性</a></h3>
<p>可以通过 apt show cuda-runtime-x-x 找到：</p>
<ul>
<li>cuda 12.6 &gt;= 560 (Release Notes: 525)</li>
<li>cuda 12.5 &gt;= 555 (Release Notes: 525)</li>
<li>cuda 12.4 &gt;= 550 (Release Notes: 525)</li>
<li>cuda 12.3 &gt;= 545 (Release Notes: 525)</li>
<li>cuda 12.2 &gt;= 535 (Release Notes: 525)</li>
<li>cuda 12.1 &gt;= 530 (Release Notes: 525)</li>
<li>cuda 12.0 &gt;= 525 (Release Notes: 525)</li>
<li>cuda 11.8 &gt;= 520 (Release Notes: 450)</li>
<li>cuda 11.7 &gt;= 515 (Release Notes: 450)</li>
<li>cuda 11.6 &gt;= 510 (Release Notes: 450)</li>
<li>cuda 11.5 &gt;= 495 (Release Notes: 450)</li>
<li>cuda 11.4 &gt;= 470 (Release Notes: 450)</li>
<li>cuda 11.3 &gt;= 465 (Release Notes: 450)</li>
<li>cuda 11.2 &gt;= 460 (Release Notes: 450)</li>
<li>cuda 11.1 &gt;= 455 (Release Notes: 450)</li>
<li>cuda 11.0 &gt;= 450 (Release Notes: 450)</li>
<li>cuda 10.2 &gt;= 440</li>
<li>cuda 10.1 &gt;= 418</li>
<li>cuda 10.0 &gt;= 410</li>
<li>cuda 9.2 &gt;= 396</li>
<li>cuda 9.1 &gt;= 390</li>
<li>cuda 9.0 &gt;= 384</li>
</ul>
<p>使用 nvidia-smi 看到的 CUDA 版本，通常就是这个驱动在上表里对应的 CUDA 版本，例如内核驱动版本是 470 的话，看到的 CUDA 版本就是 11.4。</p>
<p>实际上兼容的驱动版本会比 APT 宣称的更多一些：<a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html">官方文档</a> 里面写了 CUDA 11.x 可以兼容 NVIDIA &gt;= 450，CUDA 12.x 可以兼容 NVIDIA &gt;= 525。</p>
<h3 id="cuda-版本和-gccclang-版本兼容性"><a class="toclink" href="../../../../software/2021/12/26/nvidia-cuda/#cuda-版本和-gccclang-版本兼容性">CUDA 版本和 GCC/Clang 版本兼容性</a></h3>
<p>可以在 cuda/include/crt/host_config.h 文件里找到：</p>
<ul>
<li>cuda 12.6: gcc &lt;= 13, 3.2 &lt; clang &lt; 19</li>
<li>cuda 12.1: gcc &lt;= 12, 3.2 &lt; clang &lt; 16</li>
<li>cuda 12.0: gcc &lt;= 12, 3.2 &lt; clang &lt; 15</li>
<li>cuda 11.8: gcc &lt;= 11, 3.2 &lt; clang &lt; 15</li>
<li>cuda 11.5: gcc &lt;= 11</li>
<li>cuda 11.4: gcc &lt;= 10</li>
<li>cuda 11.3: gcc &lt;= 10, 3.2 &lt; clang &lt; 12</li>
<li>cuda 11.1: gcc &lt;= 10, 3.2 &lt; clang &lt; 11</li>
<li>cuda 11.0: gcc &lt;= 9, 3.2 &lt; clang &lt; 10</li>
<li>cuda 10.2: gcc &lt;= 8, 3.2 &lt; clang &lt; 9</li>
<li>cuda 10.1: gcc &lt;= 8, 3.2 &lt; clang &lt; 9</li>
<li>cuda 10.0: gcc &lt;= 7</li>
<li>cuda 9.1: gcc &lt;= 6</li>
</ul>
<h3 id="cuda-版本与显卡兼容性"><a class="toclink" href="../../../../software/2021/12/26/nvidia-cuda/#cuda-版本与显卡兼容性">CUDA 版本与显卡兼容性</a></h3>
<p>编译选项与显卡对应关系 https://arnon.dk/matching-sm-architectures-arch-and-gencode-for-various-nvidia-cards/</p>
<p>可以在 <code>nvcc --help</code> 搜索 gpu-architecture 找到：</p>
<ul>
<li>cuda 12.1 sm_50 to sm_90a</li>
<li>cuda 12.0 sm_50 to sm_90a</li>
<li>cuda 11.8 sm_35 to sm_90</li>
<li>cuda 11.4 sm_35 to sm_87</li>
<li>cuda 11.3 sm_35 to sm_86</li>
<li>cuda 11.1 sm_35 to sm_86</li>
<li>cuda 11.0 sm_35 to sm_80</li>
<li>cuda 10.2 sm_30 to sm_75</li>
<li>cuda 10.0 sm_30 to sm_75</li>
<li>cuda 9.1 sm_30 to sm_72</li>
<li>cuda 9.0 sm_30 to sm_70</li>
</ul>
<p>显卡的 Compute Capability 可以在 https://developer.nvidia.com/cuda-gpus 找到：</p>
<ul>
<li>H100: 90</li>
<li>A100: 80</li>
<li>V100: 70</li>
<li>P100: 60</li>
</ul>
<h3 id="升级-nvidia-驱动"><a class="toclink" href="../../../../software/2021/12/26/nvidia-cuda/#升级-nvidia-驱动">升级 NVIDIA 驱动</a></h3>
<p>升级后，需要 rmmod 已有的，再 modprobe 新的：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>rmmod<span class="w"> </span>nvidia_uvm<span class="w"> </span>nvidia_drm<span class="w"> </span>nvidia_modeset<span class="w"> </span>nvidia<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>modprobe<span class="w"> </span>nvidia
</span></code></pre></div>
<p>如果发现 rmmod 失败，可以 <code>lsof /dev/nvidiactl</code> 查看谁在占用。DGX OS 上需要停止：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>nvsm.service
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>nvidia-dcgm.service<span class="w"> </span>
</span></code></pre></div>
<p>除了 <code>/dev/nvidia*</code> 可能被占用以外，还需要用 lsof 检查 <code>/dev/dri/render*</code>。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-09-02 00:00:00+00:00">2021年9月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="locale-影响排序的特殊副作用"><a class="toclink" href="../../../../software/2021/09/02/locale/">Locale 影响排序的特殊副作用</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/09/02/locale/#背景">背景</a></h3>
<p>最近在答疑的时候，发现同一条命令在不同系统上行为不同，一开始以为是 bash 版本问题，排查后最后发现是 locale 的问题。一个例子如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>$<span class="w"> </span>cat<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="m">1</span><span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>*<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span>a<span class="w"> </span>b<span class="w"> </span>A<span class="w"> </span>B<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试<span class="w"> </span>α
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="m">1</span><span class="w"> </span>A<span class="w"> </span>B<span class="w"> </span><span class="se">\ </span>a<span class="w"> </span>b<span class="w"> </span>α<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;zh_CN.UTF-8&quot;</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span><span class="m">1</span><span class="w"> </span>测<span class="w"> </span>二<span class="w"> </span>试<span class="w"> </span>一<span class="w"> </span>a<span class="w"> </span>A<span class="w"> </span>b<span class="w"> </span>B<span class="w"> </span>α
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;en_US.UTF-8&quot;</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span><span class="m">1</span><span class="w"> </span>a<span class="w"> </span>A<span class="w"> </span>b<span class="w"> </span>B<span class="w"> </span>α<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试
</span></code></pre></div>
<p>注意  1 a A 的顺序，在不同的 locale 下结果不同。</p>
<p>网上也有关于这个问题的讨论：</p>
<ol>
<li>https://unix.stackexchange.com/questions/75341/specify-the-sort-order-with-lc-collate-so-lowercase-is-before-uppercase</li>
<li>https://stackoverflow.com/questions/43448655/weird-behavior-of-bash-glob-regex-ranges</li>
</ol>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-07-24 00:00:00+00:00">2021年7月24日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="配置-homebridge-broadlink-rm-pro"><a class="toclink" href="../../../../software/2021/07/24/homebridge-rm-mini-3/">配置 homebridge-broadlink-rm-pro</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/07/24/homebridge-rm-mini-3/#背景">背景</a></h3>
<p>最近发现空调遥控器电池有点不足，有时候会自动关机，于是拿出以前买的 Broadlink RM mini 3 充当远程的空调遥控器使用。为了方便手机上配置，分别采用了官方的 App 智慧星和 homebridge 进行配置。</p>
<h3 id="步骤"><a class="toclink" href="../../../../software/2021/07/24/homebridge-rm-mini-3/#步骤">步骤</a></h3>
<p>首先用官方的智慧星配置好 Broadlink RM mini 3 的网络，然后配置 homebridge-broadlink-rm-pro。最早的插件作者不怎么更新了，这个版本是目前用的比较多的一个 fork。</p>
<p>安装好以后，在 Home 里面可以看到 Scan Code 的开关。打开以后，用遥控器在 Broadlink RM mini 3 附近按按键，就可以在 Homebridge 日志里看到 hex code 了。然后，就按照插件教程里的方法写配置，例子如下：</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">        </span><span class="nt">&quot;platform&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BroadlinkRM&quot;</span><span class="p">,</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Broadlink RM&quot;</span><span class="p">,</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">        </span><span class="nt">&quot;accessories&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">                </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Air Conditioner&quot;</span><span class="p">,</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">                </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;air-conditioner&quot;</span><span class="p">,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">                </span><span class="nt">&quot;noHumidity&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">                </span><span class="nt">&quot;minTemperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">                </span><span class="nt">&quot;maxTemperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">                </span><span class="nt">&quot;defaultCoolTemperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">                        </span><span class="nt">&quot;off&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span><span class="p">,</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">                        </span><span class="nt">&quot;cool28&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">                                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">                        </span><span class="p">},</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">                        </span><span class="nt">&quot;cool27&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">                                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">                        </span><span class="p">},</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">                        </span><span class="nt">&quot;cool26&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">                                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">        </span><span class="p">}]</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就可以在手机上方便地控制空调温度了。测试了一下，可以用 Siri 说“设置空调为 XX 度”，也是完全可以工作的。</p>
<p>P.S. 小米的空气净化器现在可以用插件 https://github.com/torifat/xiaomi-mi-air-purifier#readme，之前博客里写的那一个已经不更新了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-07-16 00:00:00+00:00">2021年7月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nginx-处理-post-请求出现-internal-server-error-排查一则"><a class="toclink" href="../../../../software/2021/07/16/nginx-post-internal-server-error/">Nginx 处理 POST 请求出现 Internal Server Error 排查一则</a></h2>
<h3 id="前言"><a class="toclink" href="../../../../software/2021/07/16/nginx-post-internal-server-error/#前言">前言</a></h3>
<p>最近一个服务忽然出现问题，用户反馈，HTTP POST 一个小的 body 不会出错，POST 一个大的 body 就会 500 Internal Server Error。</p>
<h3 id="排查"><a class="toclink" href="../../../../software/2021/07/16/nginx-post-internal-server-error/#排查">排查</a></h3>
<p>观察后端日志，发现没有出错的那一个请求。观察 Nginx 日志，发现最后一次日志是几个小时前。最后几条 Nginx 日志写的是 <code>a client request body is buffered to a temporary file</code>。</p>
<h3 id="结论"><a class="toclink" href="../../../../software/2021/07/16/nginx-post-internal-server-error/#结论">结论</a></h3>
<p>继续研究后，发现是硬盘满了。Nginx 在处理 POST body 的时候，如果 body 超过阈值，会写入到临时文件中：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Syntax: client_body_buffer_size size;
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Default: client_body_buffer_size 8k|16k;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>Context: http, server, location
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>Sets buffer size for reading client request body. In case the request body is larger than the buffer, the whole body or only its part is written to a temporary file. By default, buffer size is equal to two memory pages. This is 8K on x86, other 32-bit platforms, and x86-64. It is usually 16K on other 64-bit platforms.
</span></code></pre></div>
<p>详见 https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size</p>
<p>这就可以解释为什么 Nginx 返回 500 而且没有转发到后端，也可以解释为什么 Nginx 没有输出新的错误日志。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-13 00:00:00+00:00">2021年3月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="gnome-的-fractional-scaling"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/">Gnome 的 Fractional Scaling</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#背景">背景</a></h3>
<p>最近发现部分软件（包括 Google Chrome，Firefox 和 Visual Studio Code）在 125% 的 Fractional Scaling 模式下会很卡。找到了一些临时解决方法，但是很不优雅，也很麻烦。所以深入研究了一下 Fractional Scaling 的工作方式。</p>
<h3 id="临时解决方法"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#临时解决方法">临时解决方法</a></h3>
<p>根据关键字，找到了 <a href="https://askubuntu.com/questions/1274719/chrome-menus-too-slow-after-enabling-fractional-scaling-in-ubuntu-20-04">Chrome menus too slow after enabling fractional scaling in Ubuntu 20.04</a>。按它的方法，关闭 Google Chrome 的硬件加速，发现卡顿问题确实解决了。</p>
<p>类似地，也可以<a href="https://gist.github.com/andriyudatama/fe5d00deb36feeea30ef35a5ea0f7eff">关闭 VSCode 的硬件加速</a>，在 Firefox 里也可以找到相应的设置。这样操作确实可以解决问题。但是，对于每一个出问题的应用都这样搞一遍，还是挺麻烦的。</p>
<p>另一个思路是，<a href="https://askubuntu.com/questions/1230208/fractional-scaling-does-not-work-properly-ubuntu-20-04/1272794#1272794">不使用 Fractional Scaling，而只是把字体变大</a>。但毕竟和我们想要的效果不大一样。</p>
<h3 id="一些发现"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#一些发现">一些发现</a></h3>
<p>在物理机进行了一些实验以后，发现一个现象：125% 的时候卡顿，而其他比例（100%，150%，175%，200%）都不卡顿。</p>
<p>网上一顿搜到，找到了 xrandr 工具。下面是观察到的一些现象（GNOME 设置分辨率一直是 1920x1080）：</p>
<table>
<thead>
<tr>
<th>放缩比例</th>
<th>xrandr 显示的分辨率</th>
<th>xrandr 显示的 transform</th>
</tr>
</thead>
<tbody>
<tr>
<td>100%</td>
<td>1920x1080</td>
<td>diag(1.0, 1.0, 1.0)</td>
</tr>
<tr>
<td>125%</td>
<td>3072x1728</td>
<td>diag(1.6, 1.6, 1.0)</td>
</tr>
<tr>
<td>150%</td>
<td>2560x1440</td>
<td>diag(1.33, 1.33, 1.0)</td>
</tr>
<tr>
<td>175%</td>
<td>2208x1242</td>
<td>diag(1.15, 1.15, 1.0)</td>
</tr>
<tr>
<td>200%</td>
<td>1920x1080</td>
<td>diag(1.0, 1.0, 1.0)</td>
</tr>
</tbody>
</table>
<p>在 <a href="https://www.x.org/releases/X11R7.5/doc/man/man1/xrandr.1.html">xrandr 文档</a> 中，写了：transform 是一个 3x3 矩阵，矩阵乘以输出的点的坐标得到图形缓存里面的坐标。</p>
<p>由此可以猜想：fractional scaling 的工作方式是，把绘制的 buffer 调大，然后再用 transform 把最终输出分辨率调成 1920x1080。可以看到，xrandr 显示的分辨率除以 transform 对应的值，就是 1920x1080。但这并不能解释 100% 和 200% 的区别，所以肯定还漏了什么信息。</p>
<p>翻了翻 <a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#989734a4aea877b0c1d80fa73cbe2ee59de79fba_376_422">mutter 实现 fractional scaling 的 pr</a>，找到了实现 scale 的一部分：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clutter_actor_get_resource_scale</span><span class="w"> </span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resource_scale</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="n">resource_scale</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">paint_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resource_scale</span><span class="p">;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">cogl_matrix_scale</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">modelview</span><span class="p">,</span><span class="w"> </span><span class="n">paint_scale</span><span class="p">,</span><span class="w"> </span><span class="n">paint_scale</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>然后找到了一段对 scale 做 ceiling 的<a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#989734a4aea877b0c1d80fa73cbe2ee59de79fba_238_265">代码</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_clutter_actor_get_real_resource_scale</span><span class="w"> </span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resource_scale</span><span class="p">))</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="n">ceiled_resource_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceilf</span><span class="w"> </span><span class="p">(</span><span class="n">resource_scale</span><span class="p">);</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="n">stage_width</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">ceiled_resource_scale</span><span class="p">;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="n">stage_height</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">ceiled_resource_scale</span><span class="p">;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>这样，100% 和其他比例就区分开了。</p>
<p>另外，也在<a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#d66a28cda989fbb17c8a7302b3f6360640c3c152_33_33">代码</a> 中发现：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cp">#define SCALE_FACTORS_PER_INTEGER 4</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="cp">#define SCALE_FACTORS_STEPS (1.0 / (float) SCALE_FACTORS_PER_INTEGER)</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="cp">#define MINIMUM_SCALE_FACTOR 1.0f</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="cp">#define MAXIMUM_SCALE_FACTOR 4.0f</span>
</span></code></pre></div>
<p>这段代码规定了比例只能是 25% 的倍数。</p>
<p>我也试了一下用 xrandr --scale 1.5x1.5：效果就是窗口看起来都更小了，分辨率变成了 2880x1620，transform 是 diag(1.5, 1.5, 1.0)。</p>
<h3 id="虚拟机测试"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#虚拟机测试">虚拟机测试</a></h3>
<p>接着，用虚拟机做了一些测试。为了在 GNOME over Wayland 上使用 fractional scaling，需要运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$<span class="w"> </span>gsettings<span class="w"> </span><span class="nb">set</span><span class="w"> </span>org.gnome.mutter<span class="w"> </span>experimental-features<span class="w"> </span><span class="s2">&quot;[&#39;scale-monitor-framebuffer&#39;]&quot;</span>
</span></code></pre></div>
<p>接着又做了类似上面的测试（GNOME 设置分辨率一直是 2560x1600）：</p>
<table>
<thead>
<tr>
<th>放缩比例</th>
<th>xrandr 显示的分辨率</th>
</tr>
</thead>
<tbody>
<tr>
<td>100%</td>
<td>2560x1600</td>
</tr>
<tr>
<td>125%</td>
<td>2048x1280</td>
</tr>
<tr>
<td>150%</td>
<td>1704x1065</td>
</tr>
<tr>
<td>175%</td>
<td>1464x915</td>
</tr>
<tr>
<td>200%</td>
<td>1280x800</td>
</tr>
</tbody>
</table>
<p>在这个测试中，xrandr 显示的 transform 一直都是单位矩阵；还用了来自 <a href="https://github.com/xyproto/wallutils">xyproto/wallutils</a> 的 <code>wayinfo</code> 命令查看输出的分辨率，一直是 2560x1600，DPI 一直是 96。用 wallutils 的 xinfo 看到的结果和 xrandr 一致（通过 XWayland）。但是和物理机有一点不同：物理机有一个选项问要不要打开 fractional scaling，下面还会提示性能下降的问题；但是虚拟机上并没有这个提示，而是直接给了一些 Scale 比例的选项。</p>
<p>尝试了一下，在 GNOME over X11 上是找不到 fractional scaling 的（没有出现设置 scale 的选项）。找到一个实现这个功能的 fork：https://github.com/puxplaying/mutter-x11-scaling，不过没有尝试过。</p>
<p>我也尝试在虚拟机中用 xrandr --scale，结果就是输出黑屏，需要重启 gdm 来恢复到登录界面。</p>
<p>更新：由于物理机使用的是 Ubuntu，想到是不是 Ubuntu 采用了上面那个 fork 的 patch，然后就在 <a href="https://changelogs.ubuntu.com/changelogs/pool/main/m/mutter/mutter_3.38.1-1ubuntu1/changelog">changelog</a> 中看到：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>mutter (3.38.1-1ubuntu1) groovy; urgency=medium
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>  * Merge with debian, including new upstream version, remaining changes:
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    - debian/gbp.conf: update upstream branch to point to ubuntu/master
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    - debian/patches/x11-Add-support-for-fractional-scaling-using-Randr.patch:
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>      + X11: Add support for fractional scaling using Randr
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>  * d/p/clutter-backend-x11-Don-t-set-the-font-dpi-computed-on-X1.patch:
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    - Dropped, applied upstream
</span></code></pre></div>
<p>也找到了对应的 <a href="https://git.launchpad.net/ubuntu/+source/mutter/tree/debian/patches/x11-Add-support-for-fractional-scaling-using-Randr.patch?h=applied/ubuntu/groovy">patch 文件</a>。这也就解释了，为什么网上会说 GNOME over X11 支持 fractional scaling，并且需要用 gsettings 打开，而我在 Debian 和 Arch Linux 上设置这个选项也没有用了。原来是 Ubuntu 加的私货啊。</p>
<p>在 patch 中，找到了这么一段配置的解释：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>+    &lt;key name=&quot;fractional-scale-mode&quot; enum=&quot;org.gnome.mutter.X11.scale-mode&quot;&gt;
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>+      &lt;default&gt;&quot;scale-ui-down&quot;&lt;/default&gt;
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>+      &lt;description&gt;
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>+        Choose the scaling mode to be used under X11 via Randr extension.
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>+
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>+        Supported methods are:
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>+
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>+        • “scale-up”     — Scale everything up to the requested scale, shrinking
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>+                           the UI. The applications will look blurry when scaling
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>+                           at higher values and the resolution will be lowered.
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>+        • “scale-ui-down — Scale up the UI toolkits to the closest integer
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>+                           scaling value upwards, while scale down the display
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>+                           to match the requested scaling level.
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>+                           It increases the resolution of the logical display.
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>+      &lt;/description&gt;
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>+    &lt;/key&gt;
</span></code></pre></div>
<p>这样就可以解释前面看到的现象了：默认是 <code>scale-ui-down</code>，也就是先放大到两倍（closest integer scaling value upwards），再缩小（scale down the display to match the requested scaling level）。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-15 00:00:00+00:00">2021年2月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="使用-sssd-的-ldap-认证"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/">使用 SSSD 的 LDAP 认证</a></h2>
<h3 id="前言"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#前言">前言</a></h3>
<p>最近在研究替换一个老的用户系统，于是顺便学习了一下 LDAP，还有 SSSD。LDAP 是一个目录协议，顺带的，因为用户信息也可以存在里面，所以也就成了一个常见的用户认证协议。SSSD 就是一个 daemon，把系统的 NSS PAM 的机制和 LDAP 连接起来。</p>
<h3 id="配置"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#配置">配置</a></h3>
<p>其实很简单，安装 sssd 并且配置即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>sssd
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>/etc/sssd/sssd.conf
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># file content:</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="o">[</span>sssd<span class="o">]</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nv">config_file_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="nv">services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nss,pam
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="nv">domains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LDAP
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="o">[</span>domain/LDAP<span class="o">]</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="nv">cache_credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="nv">enumerate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="nv">entry_cache_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="nv">ldap_network_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="nv">id_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="nv">auth_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="nv">chpass_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="nv">ldap_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap://127.0.0.1/
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="nv">ldap_chpass_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap://127.0.0.1/
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="nv">ldap_search_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="nv">ldap_default_bind_dn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cn</span><span class="o">=</span>localhost,ou<span class="o">=</span>machines,dc<span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="nv">ldap_default_authtok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>REDACTED
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>sssd
</span></code></pre></div>
<p>一些字段需要按照实际情况编写，请参考<a href="https://manpages.debian.org/testing/sssd-common/sssd.conf.5.en.html">sssd.conf</a> 和 <a href="https://manpages.debian.org/testing/sssd-ldap/sssd-ldap.5.en.html">sssd-ldap</a>。</p>
<h3 id="协议"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#协议">协议</a></h3>
<p>那么，LDAP 里面的用户是如何和 Linux 里的用户对应起来的呢？可以看到，SSSD 会查询 posixAccount：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>(&amp;(objectclass=posixAccount)(uid=*)(uidNumber=*)(gidNumber=*))
</span></code></pre></div>
<p>然后，可以查到 <a href="https://ldapwiki.com/wiki/PosixAccount">posixAccount 的 schema</a>，里面可以见到对应 <code>/etc/passwd</code> 的各个字段。相应的，也有 <code>shadowAccount</code> 对应 <code>/etc/shadow</code>。</p>
<p>按照要求配好以后（建议用 ldapvi 工具），就可以用 <code>getent passwd</code> 看到新增的用户了。</p>
<p>上面的部分是通过 NSS 接口来查询的，除了用户以外，还有其他的一些 NIS 信息可以通过 LDAP 查询。此外，如果要登录的话，则是用 PAM 认证，SSSD 则会把 PAM 认证转换成 LDAP 的 Bind：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>$<span class="w"> </span>su<span class="w"> </span><span class="nb">test</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>Password:
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># sssd: bind to dn of test user with password</span>
</span></code></pre></div>
<p>如果 Bind 成功，则认为登录成功；否则就是登录失败。</p>
<p>如果用户要修改密码，SSSD 默认用的是 <a href="https://tools.ietf.org/html/rfc3062">RFC3062 LDAP Password Modify Extended Operation</a> 的方式；如果服务器不支持的话，可以按照 <a href="https://sssd.io/docs/design_pages/chpass_without_exop.html">文档</a> 使用 ldap modify 方式来修改密码。</p>
<p>SSD 还可以<a href="https://linux.die.net/man/5/sssd-sudo">配置 sudo 支持</a>，也是用类似的方法，添加 objectClass=sudoRole 的目录项即可。可以参考 <a href="https://linux.die.net/man/5/sudoers.ldap">man sudoers.ldap</a> 编写对应的目录项。</p>
<p>对于 SSH 配置，可以参考 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/openssh-sssd">RedHat 的文档</a>，和参考 <a href="https://www.systutorials.com/docs/linux/man/1-sss_ssh_authorizedkeys/">man sss_ssh_authorizedkeys</a> 配置 authorized keys 命令。然后，给用户添加 <code>sshPublicKey</code> 属性即可，内容与 <code>~/.ssh/id_*.pub</code> 一致。</p>
<h3 id="相关-rfc"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#相关-rfc">相关 RFC</a></h3>
<p><a href="https://ldap.com/ldap-related-rfcs/">LDAP-Related RFCs</a></p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc2307">RFC2307 An Approach for Using LDAP as a Network Information Service</a></li>
<li><a href="https://tools.ietf.org/html/rfc3062">RFC3062 LDAP Password Modify Extended Operation</a></li>
<li><a href="https://tools.ietf.org/html/rfc4511">RFC4511 Lightweight Directory Access Protocol (LDAP): The Protocol</a></li>
<li><a href="https://tools.ietf.org/html/rfc4512">RFC4512 Lightweight Directory Access Protocol (LDAP): Directory Information Models</a></li>
<li><a href="https://tools.ietf.org/html/rfc4513">RFC4513 Lightweight Directory Access Protocol (LDAP): Authentication Methods and Security Mechanisms</a></li>
<li><a href="https://tools.ietf.org/html/rfc4517">RFC4517 Lightweight Directory Access Protocol (LDAP): Syntaxes and Matching Rules</a></li>
<li><a href="https://tools.ietf.org/html/rfc4519">RFC4519 Lightweight Directory Access Protocol (LDAP): Schema for User Applications</a></li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-09 00:00:00+00:00">2021年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-big-surm1-上解决-latex-找不到楷体字体的问题"><a class="toclink" href="../../../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/">在 Big Sur(M1) 上解决 LaTeX 找不到楷体字体的问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#背景">背景</a></h3>
<p>最近在尝试移植 <a href="https://github.com/MiKTeX/miktex/pull/710">MiKTeX 到 Apple Silicon 上</a>，添加了一些 patch 以后就可以工作了，但遇到了新的问题，即找不到 KaiTi</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/tex/latex/ctex/fontset/ctex-fontset-macnew.def:99:
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">   </span>Package<span class="w"> </span>fontspec<span class="w"> </span>Error:
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">      </span>The<span class="w"> </span>font<span class="w"> </span><span class="s2">&quot;Kaiti SC&quot;</span><span class="w"> </span>cannot<span class="w"> </span>be<span class="w"> </span>found.
</span></code></pre></div>
<p>用 <code>miktex-fc-list</code> 命令找了一下，确实没有找到：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>$<span class="w"> </span>/Applications/MiKTeX<span class="se">\ </span>Console.app/Contents/bin/miktex-fc-list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Kaiti
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="c1"># Nothing</span>
</span></code></pre></div>
<p>上网搜了一下，找到了一个<a href="https://www.jianshu.com/p/8f35c57901e3">解决方案</a>：字体在目录 <code>/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ATS.framework/Versions/A/Support/FontSubsets/Kaiti.ttc</code> 里，所以手动安装一下，就可以让 LaTeX 找到了。但我觉得，与其安装多一份在文件系统里，不如让 LaTeX 去找它。</p>
<h3 id="解决方法"><a class="toclink" href="../../../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#解决方法">解决方法</a></h3>
<p>按照上面的线索，找到了 <code>Kaiti.ttc</code> 所在的路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>$<span class="w"> </span>fd<span class="w"> </span>Kaiti.ttc
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc
</span></code></pre></div>
<p>可以看到，和上面的路径又不大一样。研究了一下 fontconfig，发现可以用 <code>miktex-fc-conflist</code> 找到配置文件的目录：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$<span class="w"> </span>/Applications/MiKTeX<span class="se">\ </span>Console.app/Contents/bin/miktex-fc-conflist
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>+<span class="w"> </span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/config/fontconfig/config/localfonts2.conf:<span class="w"> </span>No<span class="w"> </span>description
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>+<span class="w"> </span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/config/fontconfig/config/localfonts.conf:<span class="w"> </span>No<span class="w"> </span>description
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>...
</span></code></pre></div>
<p>看了下第一个文件（localfonts.conf）：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="cm">&lt;!--</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="cm">  DO NOT EDIT THIS FILE! It will be replaced when MiKTeX is updated.</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="cm">  Instead, edit the configuration file localfonts2.conf.</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="cm">--&gt;</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="nt">&lt;fontconfig&gt;</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="nt">&lt;include&gt;</span>localfonts2.conf<span class="nt">&lt;/include&gt;</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="nt">&lt;dir&gt;</span>/Library/Fonts/<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="nt">&lt;dir&gt;</span>/System/Library/Fonts/<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/type1<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/opentype<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/truetype<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="nt">&lt;/fontconfig&gt;</span>
</span></code></pre></div>
<p>可以看到，我们可以添加路径，不过建议修改的是 <code>localfonts2.conf</code>。按照类似的格式，修改成：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nt">&lt;fontconfig&gt;</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nt">&lt;dir&gt;</span>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="cm">&lt;!-- REMOVE THIS LINE</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="cm">     REMOVE THIS LINE --&gt;</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="nt">&lt;/fontconfig&gt;</span>
</span></code></pre></div>
<p>UPDATE: 新版本 macOS 中，路径建议加上 <code>/System/Library/AssetsV2/com_apple_MobileAsset_Font7</code>：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nt">&lt;dir&gt;</span>/System/Library/AssetsV2/com_apple_MobileAsset_Font7<span class="nt">&lt;/dir&gt;</span>
</span></code></pre></div>
<p>这样，就可以找到 Kaiti SC 了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>$<span class="w"> </span>miktex-fc-list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Kaiti
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Regular,標準體,常规体
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Regular,標準體,常规体
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Bold,粗體,粗体
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Bold,粗體,粗体
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Black,黑體,黑体
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Black,黑體,黑体
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>STKaiti:style<span class="o">=</span>Regular,標準體,Ordinær,Normal,Normaali,Regolare,レギュラー,일반체,Regulier,Обычный,常规体
</span></code></pre></div>
<p>这样就搞定了，用 LaTeX 找字体的时候也没有出现问题了。</p>
<p>如果你用的是 TeX Live，那么直接把上面的 Kaiti.ttc 路径复制到 <code>~/Library/Fonts</code> 下即可。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-09 00:00:00+00:00">2021年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="common-符号"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/">COMMON 符号</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#背景">背景</a></h3>
<p>在编译一个程序的时候，遇到了 undefined symbol 的问题。具体情况是这样的：</p>
<ol>
<li>一开始的时候，直接把所有的源代码编译成 <code>.o</code>，再一次性链接，这样不会报错</li>
<li>后来，把一些代码编译成静态库，即把其中一部分源代码编译成 <code>.o</code> 后，用 <code>ar</code> 合并到一个 <code>.a</code> 中，再和其余的 <code>.o</code> 链接在一起，这时候就报错了：</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>Undefined symbols for architecture arm64:
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>  &quot;_abcd&quot;, referenced from:
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    ...
</span></code></pre></div>
<p>如果换台机器，编译（使用的是 gcc 10.2.0）就没有问题。</p>
<p>而如果去找这个符号存在的 <code>.o</code> 里，是可以找到的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/path/to/abcd.o
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="m">0000000000000028</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000008</span><span class="w"> </span>_abcd
</span></code></pre></div>
<p>在合成的静态库 <code>.a</code> 里，也是存在的（一个定义 + 若干个引用）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/path/to/libabc.a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>abcd
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="m">0000000000000028</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000008</span><span class="w"> </span>_abcd
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span></code></pre></div>
<p>于是觉得很奇怪，就上网搜了一下，找到了一篇 <a href="https://stackoverflow.com/questions/63665653/different-behavior-between-clang-and-gcc-10-when-linking-to-static-library-conta">StackOverflow</a> 讲了这个问题。解决方案很简单，就是：</p>
<p><strong>编译的时候打开 <code>-fno-common</code> 设置</strong></p>
<p>而 gcc 10 不会出错的原因是，它默认从 <code>-fcommon</code> 改成了 <code>-fno-common</code> 。</p>
<h3 id="common-是什么"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#common-是什么">COMMON 是什么</a></h3>
<p>这时候，肯定不满足于找到一个解决方案，肯定还是会去找背后的原理。</p>
<p>首先，搜索了一下 COMMON 是什么，找到了 <a href="https://binarydodo.wordpress.com/2016/05/09/investigating-linking-with-common-symbols-in-elf/">Investigating linking with COMMON symbols in ELF</a> 这篇文章。</p>
<p>文章里讲了 COMMON 是做什么的：</p>
<blockquote>
<p>Common symbols are a feature that allow a programmer to 'define' several variables of the same name in different source files.  This is in contrast with the more popular way of doing, where you define a variable once in a source file, and reference it everywhere else in other source files, using extern.  When common symbols are used, the linker will merge all symbols of the same name into a single memory location, the size of which is the largest type of the individual common symbol definitions.  For example, if fileA.c defines an uninitialized 32-bit integer myint, and fileB.c defines an 8-bit char myint, then in the final executable, references to myint from both files will point to the same memory location (common location), and the linker will reserve 32 bits for that location.</p>
</blockquote>
<p>文章里还讲了具体的实现方法：一个没有初始化的全局变量，在 <code>-fcommon</code> 的情况下，会设为 COMMON；如果有初始化，就按照初始化的值预分配到 .bss 或者 .data。链接的时候，如果有多个同名的 symbol，会有一个规则决定最后的 symbol 放到哪里；如果有冲突的话，就是我们熟悉的 <code>multiple definition</code> 错误了。</p>
<p>为啥会有这种需求，多个 variable 同名，不会冲突而且共享内存？又在别的地方看到说法，COMMON 是给 <code>ancient</code> 代码使用的，还有的提到了 FORTRAN。于是去搜了一下，果然，FORTRAN 是问题的关键</p>
<h3 id="fortran-里面的-common"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#fortran-里面的-common">FORTRAN 里面的 COMMON</a></h3>
<p>用关键词很容易可以搜索到讲 <a href="https://www.obliquity.com/computer/fortran/common.html">COMMON BLOCK in FORTRAN 的文章</a>，FORTRAN 里面的 COMMON 是一种通过全局存储隐式传递参数的方法。拿文章里的例子：</p>
<div class="language-fortran highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="w">      </span><span class="k">PROGRAM </span><span class="n">MAIN</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">      </span><span class="kt">INTEGER </span><span class="n">A</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">      </span><span class="kt">REAL    </span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">      </span><span class="k">COMMON  </span><span class="n">R</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">F</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">      </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">14</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">      </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="mf">9.9</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">      </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">      </span><span class="k">CALL </span><span class="n">SUB</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">      </span><span class="k">END</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="k">      SUBROUTINE </span><span class="n">SUB</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">      </span><span class="kt">INTEGER </span><span class="n">I</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">      </span><span class="kt">REAL    </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">      </span><span class="k">COMMON  </span><span class="n">A</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">B</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">      </span><span class="k">END</span>
</span></code></pre></div>
<p>在函数 MAIN 和 SUB 中，都有 COMMON 语句，而 COMMON 后面的变量，就是存储在一个 COMMON 的 symbol 之中，按照顺序映射到 symbol 的内存地址。尝试编译一下上面的代码，然后看一下 symbol：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>$<span class="w"> </span>gfortran<span class="w"> </span>-g<span class="w"> </span>-c<span class="w"> </span>test.f<span class="w"> </span>-o<span class="w"> </span>test.o
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>test.o
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="m">0000000000000078</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_main
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="m">0000000000000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_sub_
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>000000000000000c<span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>___BLNK__
</span></code></pre></div>
<p>可以看到，出现了一个叫做 <code>___BLNK__</code> 的 COMMON symbol，大小是 16 字节。看一下代码中是如何引用的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-S<span class="w"> </span>--reloc<span class="w"> </span>test.o
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>Disassembly<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>__TEXT,__text:
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="m">0000000000000018</span><span class="w"> </span>_MAIN__:
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="p">;</span><span class="w">         </span>PROGRAM<span class="w"> </span>MAIN
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">      </span><span class="m">18</span>:<span class="w"> </span>fd<span class="w"> </span>7b<span class="w"> </span>be<span class="w"> </span>a9<span class="w">                   </span>stp<span class="w"> </span>x29,<span class="w"> </span>x30,<span class="w"> </span><span class="o">[</span>sp,<span class="w"> </span><span class="c1">#-32]!</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">      </span>1c:<span class="w"> </span>fd<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>mov<span class="w"> </span>x29,<span class="w"> </span>sp
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="p">;</span><span class="w">         </span><span class="nv">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-14
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">      </span><span class="m">20</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">        </span><span class="m">0000000000000020</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">      </span><span class="m">24</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">        </span><span class="m">0000000000000024</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">      </span><span class="m">28</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">12</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#-14</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">      </span>2c:<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>b9<span class="w">                   </span>str<span class="w"> </span>w1,<span class="w"> </span><span class="o">[</span>x0,<span class="w"> </span><span class="c1">#4]</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="p">;</span><span class="w">         </span><span class="nv">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">99</span>.9
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">      </span><span class="m">30</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">        </span><span class="m">0000000000000030</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">      </span><span class="m">34</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">        </span><span class="m">0000000000000034</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="w">      </span><span class="m">38</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">52</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#52429</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">      </span>3c:<span class="w"> </span>e1<span class="w"> </span><span class="m">58</span><span class="w"> </span>a8<span class="w"> </span><span class="m">72</span><span class="w">                   </span>movk<span class="w">    </span>w1,<span class="w"> </span><span class="c1">#17095, lsl #16</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="w">      </span><span class="m">40</span>:<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">27</span><span class="w"> </span>1e<span class="w">                   </span>fmov<span class="w">    </span>s0,<span class="w"> </span>w1
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">      </span><span class="m">44</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>bd<span class="w">                   </span>str<span class="w"> </span>s0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="p">;</span><span class="w">         </span><span class="nv">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.2
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="w">      </span><span class="m">48</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="w">        </span><span class="m">0000000000000048</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">      </span>4c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="w">        </span>000000000000004c:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">      </span><span class="m">50</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">52</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#52429</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="w">      </span><span class="m">54</span>:<span class="w"> </span><span class="m">81</span><span class="w"> </span>c9<span class="w"> </span>a7<span class="w"> </span><span class="m">72</span><span class="w">                   </span>movk<span class="w">    </span>w1,<span class="w"> </span><span class="c1">#15948, lsl #16</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="w">      </span><span class="m">58</span>:<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">27</span><span class="w"> </span>1e<span class="w">                   </span>fmov<span class="w">    </span>s0,<span class="w"> </span>w1
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="w">      </span>5c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">08</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>bd<span class="w">                   </span>str<span class="w"> </span>s0,<span class="w"> </span><span class="o">[</span>x0,<span class="w"> </span><span class="c1">#8]</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="p">;</span><span class="w">         </span>CALL<span class="w"> </span>SUB<span class="o">(</span>X,Y<span class="o">)</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="w">      </span><span class="m">60</span>:<span class="w"> </span>e1<span class="w"> </span><span class="m">63</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w"> </span>x1,<span class="w"> </span>sp,<span class="w"> </span><span class="c1">#24</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="w">      </span><span class="m">64</span>:<span class="w"> </span>e0<span class="w"> </span><span class="m">73</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w"> </span>x0,<span class="w"> </span>sp,<span class="w"> </span><span class="c1">#28</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="w">      </span><span class="m">68</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">94</span><span class="w">                   </span>bl<span class="w">  </span><span class="c1">#0 &lt;_MAIN__+0x50&gt;</span>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="w">        </span><span class="m">0000000000000068</span>:<span class="w">  </span>ARM64_RELOC_BRANCH26<span class="w"> </span>_sub_
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="p">;</span><span class="w">         </span>END
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="w">      </span>6c:<span class="w"> </span>1f<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">03</span><span class="w"> </span>d5<span class="w">                   </span>nop
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="w">      </span><span class="m">70</span>:<span class="w"> </span>fd<span class="w"> </span>7b<span class="w"> </span>c2<span class="w"> </span>a8<span class="w">                   </span>ldp<span class="w"> </span>x29,<span class="w"> </span>x30,<span class="w"> </span><span class="o">[</span>sp<span class="o">]</span>,<span class="w"> </span><span class="c1">#32</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a><span class="w">      </span><span class="m">74</span>:<span class="w"> </span>c0<span class="w"> </span><span class="m">03</span><span class="w"> </span>5f<span class="w"> </span>d6<span class="w">                   </span>ret
</span></code></pre></div>
<p>可以看到，在 MAIN 中引用 <code>A</code> 的时候，取的地址是 <code>___BLNK__+4</code>，<code>R</code> 是 <code>___BLNK__+0</code>，<code>F</code> 是 <code>___BLNK__+8</code>。这和代码里的顺序也是一致的。所以在 SUB 中读 A I B 的时候，对应了 MAIN 中的 A R F。通过这种方式，可以在 MAIN 函数里面隐式地给所有函数传递参数。</p>
<p>此外，COMMON 还可以命名，这样就可以区分不同的参数用途：</p>
<div class="language-fortran highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="w">        </span><span class="k">PROGRAM </span><span class="n">MAIN</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">        </span><span class="kt">INTEGER </span><span class="n">A</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">        </span><span class="kt">REAL    </span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">        </span><span class="k">COMMON  </span><span class="n">R</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">F</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">        </span><span class="k">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">14</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="mf">9.9</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">        </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">        </span><span class="k">CALL </span><span class="n">SUB</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">        </span><span class="k">END</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="k">        SUBROUTINE </span><span class="n">SUB</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">        </span><span class="kt">INTEGER </span><span class="n">I</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">        </span><span class="kt">REAL    </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">        </span><span class="k">COMMON  </span><span class="n">A</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">B</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">        </span><span class="k">END</span>
</span></code></pre></div>
<p>代码添加了一行 <code>COMMON /test/</code>，观察一下 symbol：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>test.o
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="m">0000000000000088</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_main
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="m">0000000000000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_sub_
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>000000000000000c<span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>___BLNK__
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="m">0000000000000008</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>_test_
</span></code></pre></div>
<p>和预期的一致：出现了新的 COMMON symbol，对应了 named COMMON Block 里面的变量 X 和 Y。</p>
<p>再看一下汇编里怎么引用的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="p">;</span><span class="w">         </span>CALL<span class="w"> </span>SUB<span class="o">(</span>X,Y<span class="o">)</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">      </span><span class="m">60</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">                </span><span class="m">0000000000000060</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>_test_
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">      </span><span class="m">64</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w">     </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">                </span><span class="m">0000000000000064</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">       </span>_test_
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">      </span><span class="m">68</span>:<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w">     </span>x1,<span class="w"> </span>x0,<span class="w"> </span><span class="c1">#4</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">      </span>6c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">                </span>000000000000006c:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>_test_
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">      </span><span class="m">70</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w">     </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">                </span><span class="m">0000000000000070</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">       </span>_test_
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">      </span><span class="m">74</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">94</span><span class="w">                   </span>bl<span class="w">      </span><span class="c1">#0 &lt;_MAIN__+0x5c&gt;</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">                </span><span class="m">0000000000000074</span>:<span class="w">  </span>ARM64_RELOC_BRANCH26<span class="w"> </span>_sub_
</span></code></pre></div>
<p>可以看到，第一个参数（x0）为 <code>_test_</code>，第二个参数（x1）为 <code>_test_+4</code>，和预期也是一样的。</p>
<p>读到这里，就可以理解为啥有 COMMON symbol 了。可能是为了让 C 代码和 FORTRAN 代码可以互操作 COMMON symbol，就有了这么一出。也可能有的 C 库确实用了类似的方法来实现某些功能。</p>
<h3 id="解决方案"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#解决方案">解决方案</a></h3>
<p>但是，这种用法在现在来看是不推荐的，建议还是该 extern 就 extern，另外，在编译静态库的时候，记得加上 <code>-fno-common</code>。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-01-02 00:00:00+00:00">2021年1月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-m1-上用-qemu-运行-debian-虚拟机"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/">在 M1 上用 QEMU 运行 Debian 虚拟机</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#背景">背景</a></h3>
<p>看到 @jsteward 在 M1 的 QEMU 中运行了 Windows on ARM，所以我先来试试 Debian on AArch64，这样会简单一些。</p>
<p>参考：https://gist.github.com/niw/e4313b9c14e968764a52375da41b4278#file-readme-md</p>
<p>大约需要 3G 的硬盘空间。</p>
<h3 id="安装-qemu-w-m1-patches"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#安装-qemu-w-m1-patches">安装 QEMU w/ M1 patches</a></h3>
<p>目前上游的 QEMU 还不支持 M1 的 Hypervisor framework，需要打 patch：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/git/qemu.git
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nb">cd</span><span class="w"> </span>qemu
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>git<span class="w"> </span>checkout<span class="w"> </span>master<span class="w"> </span>-b<span class="w"> </span>wip/hvf
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>curl<span class="w"> </span><span class="s1">&#39;https://patchwork.kernel.org/series/400619/mbox/&#39;</span><span class="p">|</span>git<span class="w"> </span>am<span class="w"> </span>--3way
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>mkdir<span class="w"> </span>build
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="nb">cd</span><span class="w"> </span>build
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>../configure<span class="w"> </span>--target-list<span class="o">=</span>aarch64-softmmu<span class="w"> </span>--enable-cocoa<span class="w"> </span>--disable-gnutls
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>make<span class="w"> </span>-j4
</span></code></pre></div>
<p>编译后，得到 <code>qemu-system-aarch64</code> 的二进制</p>
<h3 id="准备好文件系统"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#准备好文件系统">准备好文件系统</a></h3>
<p>需要下载 <a href="https://gist.github.com/niw/4f1f9bb572f40d406866f23b3127919b/raw/f546faea68f4149c06cca88fa67ace07a3758268/QEMU_EFI-cb438b9-edk2-stable202011-with-extra-resolutions.tar.gz">EFI 固件</a> 和 <a href="https://mirrors.tuna.tsinghua.edu.cn/debian-cd/current/arm64/iso-cd/debian-10.7.0-arm64-xfce-CD-1.iso">Debian 安装镜像</a>，解压前者以后把文件放同一个目录中，并且创建需要的文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>ls<span class="w"> </span>*.fd
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>QEMU_EFI.fd<span class="w">   </span>QEMU_VARS.fd
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash0.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1m<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">64</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash1.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1m<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">64</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>QEMU_EFI.fd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash0.img<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>notrunc
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>QEMU_VARS.fd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash1.img<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>notrunc
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-img<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>qcow2<span class="w"> </span>disk.qcow2<span class="w"> </span>40G
</span></code></pre></div>
<h3 id="安装-debian-系统"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#安装-debian-系统">安装 Debian 系统</a></h3>
<p>接着，执行以下的命令，然后按照提示安装系统：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span>-M<span class="w"> </span>virt,highmem<span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span>-accel<span class="w"> </span>hvf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">  </span>-cpu<span class="w"> </span>cortex-a72<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">  </span>-m<span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash0.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash,readonly<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash1.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">  </span>-device<span class="w"> </span>virtio-scsi-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">  </span>-device<span class="w"> </span>virtio-gpu-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">  </span>-device<span class="w"> </span>qemu-xhci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">  </span>-device<span class="w"> </span>usb-kbd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">  </span>-device<span class="w"> </span>usb-tablet<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./disk.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>boot,cache<span class="o">=</span>writethrough<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">  </span>-device<span class="w"> </span>nvme,drive<span class="o">=</span>boot,serial<span class="o">=</span>boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">  </span>-drive<span class="w"> </span><span class="k">if</span><span class="o">=</span>none,id<span class="o">=</span>cd,file<span class="o">=</span>debian-10.7.0-arm64-xfce-CD-1.iso,media<span class="o">=</span>cdrom<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">  </span>-device<span class="w"> </span>scsi-cd,drive<span class="o">=</span><span class="nb">cd</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">  </span>-display<span class="w"> </span>default,show-cursor<span class="o">=</span>on
</span></code></pre></div>
<p>需要注意的是，如果用 <code>-cdrom</code> 选项，Debian 会无法识别，所以需要走 SCSI。安装完成后，第一次重启可能会显示失败，不用管。另外，安装界面只在串口处显示，但不会显示在 GUI 中，估计是因为 <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=977466">BUG</a>（感谢 @Harry-Chen 指出）。</p>
<h3 id="启动系统"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#启动系统">启动系统</a></h3>
<p>安装好后，运行下面的命令来启动 Debian 系统：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span>-monitor<span class="w"> </span>stdio<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span>-M<span class="w"> </span>virt,highmem<span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span>-accel<span class="w"> </span>hvf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span>-cpu<span class="w"> </span>cortex-a72<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span>-m<span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash0.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash,readonly<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash1.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">  </span>-device<span class="w"> </span>virtio-gpu-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">  </span>-device<span class="w"> </span>virtio-scsi-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">  </span>-device<span class="w"> </span>qemu-xhci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">  </span>-device<span class="w"> </span>usb-kbd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">  </span>-device<span class="w"> </span>usb-tablet<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./disk.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>boot,cache<span class="o">=</span>writethrough<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">  </span>-device<span class="w"> </span>nvme,drive<span class="o">=</span>boot,serial<span class="o">=</span>boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">  </span>-display<span class="w"> </span>default,show-cursor<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">  </span>-nic<span class="w"> </span>user,model<span class="o">=</span>virtio
</span></code></pre></div>
<p>注意参数和上面有所不同。启动后就可以在 GUI 上看到 Debian 登录的界面了。</p>
<h3 id="网络"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#网络">网络</a></h3>
<p>起来以后，可以看到一个网卡 <code>enp0s1</code> 启动并获取 IP 地址：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>ip<span class="w"> </span>l<span class="w"> </span><span class="nb">set</span><span class="w"> </span>enp0s1<span class="w"> </span>up
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>$<span class="w"> </span>dhclient<span class="w"> </span>enp0s1
</span></code></pre></div>
<p>获取到一个 IP 地址后，就可以上网了。</p>
<h3 id="已知问题"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#已知问题">已知问题</a></h3>
<p>在虚拟机内重启以后，可能会启动失败。退出 QEMU 进程重新启动即可。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-11-08 00:00:00+00:00">2020年11月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-spack-中用-external-的-slurm-依赖编译-openmpi"><a class="toclink" href="../../../../software/2020/11/08/spack-openmpi-slurm-external/">在 Spack 中用 external 的 Slurm 依赖编译 OpenMPI</a></h2>
<p>最近在一个集群上，需要用一个自己编译的 openmpi，但并没有 root 权限，所以需要自己搞一个 spack，在 spack 里面装 openmpi。但默认的安装选项下，它没有打开 slurm 支持，所以 srun 的话会出问题，只能 sbatch 然后指定 host 去做。于是我研究了一下怎么在 spack 里引入 external 的 slurm，然后用它来编译 openmpi</p>
<p>首先，编译 <code>~/.spack/packages.yaml</code>：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">packages</span><span class="p">:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span><span class="nt">slurm</span><span class="p">:</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="nt">buildable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">      </span><span class="s">&quot;slurm@15-08-7-1%gcc@8.3.0</span><span class="nv"> </span><span class="s">arch=linux-ubuntu16.04-haswell&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr</span>
</span></code></pre></div>
<p>这里 slurm 版本是 <code>15.08.7</code>，我就按照 spack 里面 slurm 的版本号来写了。可以用 <code>spack spec openmpi schedulers=slurm +pmi</code> 来确认一下外部的 slurm 确实出现在了依赖之中。</p>
<p>这一步配好的话，安装的时候就会直接跳过 spack 里面 slurm 的安装。但又出现了 configure 错误，找不到 pmi 的库。于是，先用 external 的 mpirun 看一下配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>openmpi-3.0.0
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>$<span class="w"> </span>ompi_info
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>...
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>--with-pmi<span class="o">=</span>/usr
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>--with-pmi-libdir<span class="o">=</span>/usr/lib/x86_64-linux-gnu
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>...
</span></code></pre></div>
<p>可以看到，需要两个 config 参数。然后，在 spack 的 openmpi package.py 中：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;schedulers=slurm&#39;</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>  <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--with-pmi=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>  <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.1.3:&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.0.3&#39;</span><span class="p">):</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">if</span> <span class="s1">&#39;+static&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>      <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--enable-static&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p>所以，需要加一个小 patch：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;schedulers=slurm&#39;</span><span class="p">):</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>  <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--with-pmi=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>  <span class="c1"># patched here</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>  <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--with-pmi-libdir=</span><span class="si">{0}</span><span class="s1">/lib/x86_64-linux-gnu&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>  <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.1.3:&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.0.3&#39;</span><span class="p">):</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="k">if</span> <span class="s1">&#39;+static&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>      <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--enable-static&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p>然后，就可以编译通过了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-15 00:00:00+00:00">2020年5月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="usbip-模拟-usb-设备"><a class="toclink" href="../../../../software/2020/05/15/usb-ip-simulation/">USB/IP 模拟 USB 设备</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2020/05/15/usb-ip-simulation/#背景">背景</a></h3>
<p>2018 年的时候发过一篇博客，讲如何用 USB/IP 协议在两台 Linux 电脑之间共享 USB 设备。最近刚好有一个需求，就是针对一个现成的 USB device 的代码，通过 USB/IP 模拟出一个 USB 设备，然后进行调试。</p>
<h3 id="usbip-协议"><a class="toclink" href="../../../../software/2020/05/15/usb-ip-simulation/#usbip-协议">USB/IP 协议</a></h3>
<p>USB/IP 只有一个简略的<a href="https://github.com/realthunder/usbip/blob/master/usbip_protocol.txt">文档</a>，为数不多的使用 USB/IP 的代码，所以有一些细节没有说的很清楚，只能一点点去尝试。</p>
<p>首先，USB/IP 基于 TCP，端口号 3240。客户端向服务端发送请求，服务端向客户端进行回应。</p>
<p>请求的类型：OP_REQ_DEVLIST OP_REQ_IMPORT USBIP_CMD_SUBMIT 和 USBIP_CMD_UNLINK</p>
<p>回应的类型：OP_REP_DEVLIST OP_REP_IMPORT USBIP_RET_SUBMIT USBIP_RET_UNLINK</p>
<p>工作的过程大概如下：</p>
<ol>
<li>OP_REQ_DEVLIST 请求获取设备列表</li>
<li>OP_REP_DEVLIST 返回设备列表</li>
<li>OP_REQ_IMPORT 请求 USB 设备</li>
<li>OP_REP_IMPORT 返回 USB 设备</li>
<li>USBIP_CMD_SUBMIT 发送 URB</li>
<li>USBIP_RET_SUBMIT 返回 URB</li>
</ol>
<p>（先不考虑 CMD_UNLINK 和 RET_UNLINK）</p>
<p>其中前面四个比较简单清晰，所需要的字段也都是 Descriptor 中对应的字段。后面两个就相对复杂一些：URB data 的长度需要根据 endpoint 类型和 direction 共同决定。URB 实际上是 Linux 内核里的一个数据结构。</p>
<h3 id="usb-协议"><a class="toclink" href="../../../../software/2020/05/15/usb-ip-simulation/#usb-协议">USB 协议</a></h3>
<p>那么，USB 协议的几种 transfer 怎么对应到 URB 的数据呢？首先看最常见的三种（[ref](https://www.beyondlogic.org/usbnutshell/usb4.shtml）：</p>
<ol>
<li>Control Transfer</li>
<li>第一种是 Control IN，一共有三个阶段，第一个阶段是 Setup，Host 发送给 Device 一个八字节的 Setup Packet；第二个阶段是 Data，Device 发送给 Host 一段数据；第三个阶段是 Status，Host 发送给 Device 一个 Zero Length Packet。此时 Setup Packet 对应 urb 中的 setup，Data 就对应 RET_SUBMIT 里面的 URB data 了，自然 CMD_SUBMIT 中是没有 URB data 的</li>
<li>第二种是 Control OUT，一共有三个阶段，第一个阶段是 Setup，Host 发送给 Device 一个吧字节的 Setup Packet；第二个阶段是 Data，Host 给 Device 发送一段数据；第三个阶段是 Status，Device 给 Host 发送一个 Zero Length Packet。此时 Setup Packet 对应 urb 中的 setup，Data 对应 CMD_SUBMIT 末尾的 URB data，长度由 transfer_buffer_length 指定。返回的 RET_SUBMIT 不带 URB data，但依然需要有 RET_SUBMIT。</li>
<li>Interrupt/Bulk Transfer</li>
<li>第一种是 Interrupt/Bulk IN，由 Device 给 Host 发送一段数据，附在 RET_SUBMIT 中。</li>
<li>第二种是 Interrupt/Bulk OUT，由 Host 给 Device 发送一段数据，中 CMD_SUBMIT 的 URB data 中。返回的 RET_SUBMIT 不带 URB data，但不能不发 RET_SUBMIT。</li>
</ol>
<p>可见，Interrupt 和 Bulk 是比较简单的，而 Control 和 Isochronous（没有提到）则比较复杂。</p>
<h3 id="回到-usbip-协议"><a class="toclink" href="../../../../software/2020/05/15/usb-ip-simulation/#回到-usbip-协议">回到 USB/IP 协议</a></h3>
<p>其实补充了这些信息以后，就可以实现一个 USB/IP 协议的服务器了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-13 00:00:00+00:00">2020年4月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-sbt-中-fork-并且并行运行测试"><a class="toclink" href="../../../../software/2020/04/13/sbt-fork-parallel-test/">在 sbt 中 fork 并且并行运行测试</a></h2>
<h3 id="问题"><a class="toclink" href="../../../../software/2020/04/13/sbt-fork-parallel-test/#问题">问题</a></h3>
<p>最近在 sbt 使用遇到一个问题，有两个测试，分别用 testOnly 测试的时候没有问题，如果同时测试就会出问题，应该是全局的状态上出现了冲突。一个自然的解决思路是 fork，但是 sbt 默认 fork 之后 test 是顺序执行的，这会很慢。所以搜索了一下，找到了 fork 并且并行测试的方法。</p>
<h3 id="解决方法"><a class="toclink" href="../../../../software/2020/04/13/sbt-fork-parallel-test/#解决方法">解决方法</a></h3>
<p>解决方法在 sbt 文档中其实就有（<a href="https://www.scala-sbt.org/release/docs/Testing.html#Forking+testsl">原文</a>）。简单来说就是：把每个 test 放到单独的 TestGroup 中，每个 TestGroup 分别用一个 forked JVM 去运行；然后让 sbt 的并行限制设高一些：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// move each test into a group and fork them to avoid race condition</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">import</span><span class="w"> </span><span class="nc">Tests</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">singleTests</span><span class="p">(</span><span class="n">tests</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">TestDefinition</span><span class="p">])</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="n">tests</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">Group</span><span class="p">(</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">      </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">      </span><span class="n">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="n">test</span><span class="p">),</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">      </span><span class="nc">SubProcess</span><span class="p">(</span><span class="nc">ForkOptions</span><span class="p">()))</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">testGrouping</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">singleTests</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">definedTests</span><span class="p">).</span><span class="n">value</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1">// allow multiple concurrent tests</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="n">concurrentRestrictions</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Global</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">Tags</span><span class="p">.</span><span class="n">limitAll</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></code></pre></div>
<p>这样就可以了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-07 00:00:00+00:00">2020年2月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-macos-上带执行权限-mmap-一个已删除文件遇到的问题和解决方案"><a class="toclink" href="../../../../software/2020/02/07/macos-mmap-exec/">在 macOS 上带执行权限 mmap 一个已删除文件遇到的问题和解决方案</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2020/02/07/macos-mmap-exec/#背景">背景</a></h3>
<p>实验环境：macOS Catalina 10.15.2</p>
<p>最近在 <a href="https://github.com/rcore-os/zircon-rs">rcore-rs/zircon-rs</a> 项目中遇到一个比较玄学的问题，首先需求是在 macOS 的用户进程里开辟一段地址空间，然后把这个地址空间多次映射（权限可能不同、同一块内存可能被映射到多个地址），通过 mmap 模拟虚拟地址的映射。采用的是如下的方案：</p>
<ol>
<li>在临时目录创建一个文件，把文件大小设为 16M（暂不考虑扩容）</li>
<li>需要映射一个虚拟地址到物理地址的时候，就对这个文件的物理地址偏移进行 FIXED 映射，虚拟地址就是期望的虚拟地址。</li>
</ol>
<p>这样的方案在 Linux 下运行地很好，但在 macOS 下总是以一定概率在第二部出现 EPERM。网上搜了很多，但也没搜到相关的信息，于是自己断断续续地研究了一下，现在有一个比较初步的结果。</p>
<h3 id="tldr"><a class="toclink" href="../../../../software/2020/02/07/macos-mmap-exec/#tldr">TL；DR</a></h3>
<p>先说结论：调用一个带 PROT_EXEC 并且映射文件的 mmap 时，macOS 会进行安全检测，如果此时发现文件在文件系统上消失了，它会认为这可能是一个恶意软件行为，进行拦截，返回 EPERM。</p>
<p>而代码实际上在第一步和第二步之间，把临时目录删了：由于进程持有 fd，所以文件并不会真的删掉，当软件退出的时候文件自然会删除，这是临时文件的常见做法（见 tmpfile(3)）。</p>
<h3 id="研究过程"><a class="toclink" href="../../../../software/2020/02/07/macos-mmap-exec/#研究过程">研究过程</a></h3>
<h4 id="查看-console"><a class="toclink" href="../../../../software/2020/02/07/macos-mmap-exec/#查看-console">查看 Console</a></h4>
<p>在网上一番搜索未果后，就尝试在 Console 里面寻找信息。照着程序名字搜索，可以找到一些信息：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>temporarySigning type=1 matchFlags=0x0 path=/path/to/executable
</span></code></pre></div>
<p>这是编译这个 executable 的时候出现的，好像也没啥问题。然后解除过滤，在这个信息前后按照 syspolicyd 寻找：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>initiating malware scan (... info_path: /path/to/temp/file proc_path: /path/to/executable)
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>Unable (errno: 2) to read file at &lt;private&gt; for process path: &lt;private&gt; library path: &lt;private&gt;
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>Disallowing load of &lt;private&gt; in 50001, &lt;private&gt;
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>Library load (/path/to/temp/file) rejected: library load denied by system policy
</span></code></pre></div>
<p>这几条记录比较可疑，每次运行程序，如果跑挂了，就会出现这几条，如果没跑挂，就不会出现这一条。所以很大概率是被 macOS 拦截了。错误信息的用词是 library，所以大概率是被当成加载动态库了，但既然内容是空的，所以我想的是文件名触碰到了什么奇怪的规则，然后文件名又是随机的，随机导致 EPERM 是概率性出现的，这好像很有道理。于是我把 tmpfile 换成了固定的路径，忽然就好了。但固定的路径只能保证同时只有一个程序在跑，如果路径拼接上 pid，怎么删，谁来删又是一个问题。虽然可以放到 /tmp 下面然后随便搞，但 /tmp 的回收并不是那么积极，在临时目录下丢太多文件也会出现问题。</p>
<h4 id="一丝曙光"><a class="toclink" href="../../../../software/2020/02/07/macos-mmap-exec/#一丝曙光">一丝曙光</a></h4>
<p>这时候，@wangrunji0408 提供了一个方案：在 System Preferences -&gt; Security &amp; Privacy -&gt; Privacy -&gt; Developer Tools 中添加编译该 executable 的程序（如 iTerm、CLion）可以解决这个问题。那么问题应该比较明确了，就是 malware scan 的问题，如果信任了这个 App 为 Developer Tools，它产生的 executable 也是可信的，应该不是恶意软件。但在 tmux 环境下，它哪个 App 也不属于，没法继承，况且把这个权限开放出去也有潜在的安全问题。并且让每个开发者都要这么操作一遍很不方便。</p>
<h4 id="回到-console"><a class="toclink" href="../../../../software/2020/02/07/macos-mmap-exec/#回到-console">回到 Console</a></h4>
<p>今天刚好看到一个 <a href="https://georgegarside.com/blog/macos/sierra-console-private/">post</a>，内容是如何在 macOS Catalina 中查看 log 中标记为 private 的内容。如果你注意到的话，上面的 log 中出现了几处 private，这并不是我改的，而是 macOS 自带的隐私机制（当然这种机制似乎并没有采用的很完全，一些消息源没有打上 private 的标签）。</p>
<p>然后按照上面的 post 的方法（<a href="https://saagarjha.com/blog/2019/09/29/making-os-log-public-on-macos-catalina/">另一个 post</a>）开启了一下标记为 private 的内容，正好我的系统没有升级到 10.15.3 所以还能用。此时上面的第二条和第三条就出现了具体内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>Unable (errno: 2) to read file at /path/to/temp/file for process path: /path/to/executable library path: /path/to/temp/file
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>Disallowing load of /path/to/temp/file in 61254, /path/to/executable
</span></code></pre></div>
<p>这个时候问题就很明显了：读取不到文件。这时候回想起 tmpfile 的工作原理，它会删除生成的文件，在删除文件之后，macOS 进行扫描，发现找不到文件，于是 disallow 了，mmap 就会返回 EPERM。</p>
<p>解决方案也很显然了：把删除目录延后，或者放在 /tmp 下等待清理等待。</p>
<p>我也写了一段 C 代码来验证这个现象：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mman.h&gt;</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;mmap&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CREAT</span><span class="p">,</span><span class="w"> </span><span class="mo">0777</span><span class="p">);</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x200000000</span><span class="p">;</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="c1">// might not work if unlink is put here (race condition)</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="c1">// you can use sleep to reproduce</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">    </span><span class="n">unlink</span><span class="p">(</span><span class="s">&quot;mmap&quot;</span><span class="p">);</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_FIXED</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">    </span><span class="c1">// always works if unlink is put here</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">    </span><span class="c1">// unlink(&quot;mmap&quot;);</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;mmap&quot;</span><span class="p">);</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;good&quot;</span><span class="p">);</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="p">}</span>
</span></code></pre></div>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <span class="md-pagination__current">2</span> <a class="md-pagination__link" href="../3/">3</a> <a class="md-pagination__link" href="../4/">4</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../programming/" class="md-footer__link md-footer__link--prev" aria-label="上一页: programming">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                programming
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../speech/" class="md-footer__link md-footer__link--next" aria-label="下一页: speech">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                speech
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f13b1293.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>