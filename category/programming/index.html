
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维,编程,调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/category/programming/">
      
      
        <link rel="prev" href="../others/">
      
      
        <link rel="next" href="../software/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.0-b3">
    
    
      
        <title>programming - 杰哥的{运维,编程,调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.83068744.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-3109FRSVTT",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#programming" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              programming
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/README.md" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../archive/2023/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/README.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    programming
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    programming
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#libc-的-uniform_int_distribution-性能问题" class="md-nav__link">
    libc++ 的 uniform_int_distribution 性能问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#写一个-bash-zsh-和-fish-都能跑的脚本" class="md-nav__link">
    写一个 bash zsh 和 fish 都能跑的脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cc-数参数个数的特别方法" class="md-nav__link">
    C/C++ 数参数个数的特别方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#编程作业中的学术诚信" class="md-nav__link">
    编程作业中的学术诚信
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-11-的-abi-问题" class="md-nav__link">
    C++ 11 的 ABI 问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rust-在-m1-上的-code-signing-问题和临时解决方法" class="md-nav__link">
    Rust 在 M1 上的 Code Signing 问题和临时解决方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-arm64-上使用-rust-analyzer" class="md-nav__link">
    在 arm64 上使用 rust-analyzer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#实现一个简单的-decaf-lsp" class="md-nav__link">
    实现一个简单的 Decaf LSP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#用-rust-procedure-macro-实现-gll-parser" class="md-nav__link">
    用 Rust Procedure Macro 实现 GLL Parser
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#前端解析上传的-csv" class="md-nav__link">
    前端解析上传的 CSV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-前缀转换上意外遇到的-undefined-behavior" class="md-nav__link">
    IP 前缀转换上意外遇到的 Undefined Behavior
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#高云-fpga-踩坑" class="md-nav__link">
    高云 FPGA 踩坑
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-rcore-上运行-nginx" class="md-nav__link">
    在 rCore 上运行 nginx
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#实现网络的-syscall" class="md-nav__link">
    实现网络的 syscall
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#使用-rust-实现-e1000-驱动" class="md-nav__link">
    使用 Rust 实现 e1000 驱动
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考9" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（9）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#使用-rust-实现-virtio-驱动" class="md-nav__link">
    使用 Rust 实现 VirtIO 驱动
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rust-获取-linker-script-中的地址" class="md-nav__link">
    Rust 获取 Linker Script 中的地址
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#通过-ssh-隧道连接-adb-和-android-设备" class="md-nav__link">
    通过 SSH 隧道连接 ADB 和 Android 设备
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#升级-mongodb-到-40" class="md-nav__link">
    升级 MongoDB 到 4.0
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verilog-初体验" class="md-nav__link">
    Verilog 初体验
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-archlinux-上编译-lineageos-for-huawei-angler" class="md-nav__link">
    在 ArchLinux 上编译 LineageOS for Huawei Angler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#编写-ebpf-程序和利用-hyperloglog-统计包的信息" class="md-nav__link">
    编写 eBPF 程序和利用 HyperLogLog 统计包的信息
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#调整-nginx-和-php-的上传文件大小限制" class="md-nav__link">
    调整 Nginx 和 PHP 的上传文件大小限制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#最近写-nodejs-遇到的若干坑" class="md-nav__link">
    最近写 Node.js 遇到的若干坑
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在脚本中寻找-x11-的-display-和-xauthority" class="md-nav__link">
    在脚本中寻找 X11 的 DISPLAY 和 XAUTHORITY
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#把-gdb-降级到-801" class="md-nav__link">
    把 GDB 降级到 8.0.1
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考8" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（8）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考7" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（7）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#新手向绕过-c-类的访问限制" class="md-nav__link">
    〖新手向〗绕过 C++ 类的访问限制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考6" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（6）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考5" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（5）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考4" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（4）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考3" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（3）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考2" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考（2）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#近来做-stanford-cs140e-的一些进展和思考" class="md-nav__link">
    近来做 Stanford CS140e 的一些进展和思考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#再次吐槽-vs-关于-scanf-和-scanf_s-的问题" class="md-nav__link">
    再次吐槽 VS 关于 scanf 和 scanf_s 的问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#我正在使用的两个-emacs-的-patch" class="md-nav__link">
    我正在使用的两个 Emacs 的 Patch
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#有趣的-java-日期格式化问题" class="md-nav__link">
    有趣的 Java 日期格式化问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lsp-和-c" class="md-nav__link">
    LSP 和 C++
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-的内存池实现" class="md-nav__link">
    Nginx 的内存池实现
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-jupyter-notebook-中运行-c-代码" class="md-nav__link">
    在 Jupyter Notebook 中运行 C++ 代码
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#分析一个我第一次见的素数测试函数" class="md-nav__link">
    分析一个我第一次见的素数测试函数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#关于-scanf-和-scanf_s-的问题" class="md-nav__link">
    关于 scanf 和 scanf_s 的问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-good-way-to-show-git-diff-for-compressed-files" class="md-nav__link">
    A good way to show git diff for compressed files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exciting-new-software-updates" class="md-nav__link">
    Exciting new software updates
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interesting-links" class="md-nav__link">
    Interesting links
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-on-git-shallow-clone" class="md-nav__link">
    Tips on git shallow clone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-interesting-links" class="md-nav__link">
    Some interesting links
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="programming">programming<a class="headerlink" href="#programming" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-22 00:00:00">2023年7月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="libc-的-uniform_int_distribution-性能问题"><a class="toclink" href="../../programming/2023/07/22/uniform-int-distribution-performance/">libc++ 的 uniform_int_distribution 性能问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2023/07/22/uniform-int-distribution-performance/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>前段时间，@lwpie 发现一段 C++ 代码在 macOS 下，分别用自带的 Clang 编译和用 Homebrew 的 GCC 编译，性能差距接近一个数量级，下面是运行时间：</p>
<ul>
<li>GCC-13 Homebrew: 300</li>
<li>Apple Clang: 2170</li>
</ul>

    <nav class="md-post__action">
      <a href="../../programming/2023/07/22/uniform-int-distribution-performance/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-18 00:00:00">2023年7月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="写一个-bash-zsh-和-fish-都能跑的脚本"><a class="toclink" href="../../programming/2023/07/18/portable-script-across-bash-zsh-fish/">写一个 bash zsh 和 fish 都能跑的脚本</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2023/07/18/portable-script-across-bash-zsh-fish/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>bash 和 zsh 都实现了 POSIX shell 标准，因此写脚本的时候，比较容易兼容这两种常见的 shell。但现在 fish 也很流行，而 fish 不符合 POSIX shell 标准，很多地方语法多不兼容，能否写一个脚本，可以用 bash，zsh 和 fish 跑？</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2023/07/18/portable-script-across-bash-zsh-fish/#__codelineno-0-1"></a><span class="c1">## The following commands should work</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2023/07/18/portable-script-across-bash-zsh-fish/#__codelineno-0-2"></a>bash<span class="w"> </span>test.sh
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2023/07/18/portable-script-across-bash-zsh-fish/#__codelineno-0-3"></a>zsh<span class="w"> </span>test.sh
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2023/07/18/portable-script-across-bash-zsh-fish/#__codelineno-0-4"></a>fish<span class="w"> </span>test.sh
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../programming/2023/07/18/portable-script-across-bash-zsh-fish/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-14 00:00:00">2023年4月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cc-数参数个数的特别方法"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/">C/C++ 数参数个数的特别方法</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>群友上个月提了一个未知来源问题：</p>
<p>实现一个你自己的 <code>printf(int, ...)</code> 函数，该函数包含可变参数。为简便期间，假设所有参数均为 int 类型。</p>
<ol>
<li>第一个参数是一个普通参数，不表示后续可变参数的数目</li>
<li>在 printf 中逐个输出所有传入的整数值（可使用系统自带的 kprintf 实现输出）</li>
<li>思考如何判定参数结束，是否有副作用</li>
</ol>

    <nav class="md-post__action">
      <a href="../../programming/2023/04/14/counting-arguments/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-12 00:00:00">2022年7月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 19 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="编程作业中的学术诚信"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/">编程作业中的学术诚信</a></h2>
<p>本文是我自己对 <a href="https://integrity.mit.edu/handbook/writing-code">Academic Integrity at MIT: Writing Code</a> 的非官方中文翻译。本文已经得到了官方的邮件授权。</p>
<h3 id="编写代码-writing-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A7%C2%BC%C2%96%C3%A5%C2%86%C2%99%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81-writing-code">编写代码 Writing Code</a></h3>
<p>与学术写作类似，当你在做课程项目的时候，如果使用了或者改编了其他人开发的代码，你必须要引用代码的来源。你可以在代码注释中引用代码来源。这些注释不仅保护了他人的劳动成果，也会帮助你理解代码和调试。</p>
<div class="language-text highlight"><pre><span></span><code>Writing code is similar to academic writing in that when you use or
adapt code developed by someone else as part of your project, you must
cite your source. However, instead of quoting or paraphrasing a source,
you include an inline comment in the code. These comments not only
ensure you are giving proper credit, but help with code understanding
and debugging.
</code></pre></div>
<h3 id="什么时候应该在代码中引用来源when-should-i-cite-a-source-in-my-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A4%C2%BB%C2%80%C3%A4%C2%B9%C2%88%C3%A6%C2%97%C2%B6%C3%A5%C2%80%C2%99%C3%A5%C2%BA%C2%94%C3%A8%C2%AF%C2%A5%C3%A5%C2%9C%C2%A8%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81%C3%A4%C2%B8%C2%AD%C3%A5%C2%BC%C2%95%C3%A7%C2%94%C2%A8%C3%A6%C2%9D%C2%A5%C3%A6%C2%BA%C2%90when-should-i-cite-a-source-in-my-code">什么时候应该在代码中引用来源？When should I cite a source in my code?</a></h3>
<ol>
<li>
<p>当你从外部来源复制了代码。无论你是复制了代码片段，还是一整个模块，你都需要引用来源。</p>
<div class="language-text highlight"><pre><span></span><code>When you copy code from an external source. Whether you are copying a
snippet of code or an entire module, you should credit the source.
</code></pre></div>
</li>
<li>
<p>当你复制了代码并做了改动，你依然要引用来源。你并不是代码的原作者。</p>
<div class="language-text highlight"><pre><span></span><code>When you copy the code and adapt it, you should still credit the source.
You were not the original developer of the code.
</code></pre></div>
</li>
</ol>
<h3 id="我应该如何引用代码how-should-i-cite-the-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A6%C2%88%C2%91%C3%A5%C2%BA%C2%94%C3%A8%C2%AF%C2%A5%C3%A5%C2%A6%C2%82%C3%A4%C2%BD%C2%95%C3%A5%C2%BC%C2%95%C3%A7%C2%94%C2%A8%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81how-should-i-cite-the-code">我应该如何引用代码？How should I cite the code?</a></h3>
<ol>
<li>
<p>通常来说，代码的网址和下载时间就足够了。如果可以让读者更加清晰地了解到代码来源，可以增加更多的细节。</p>
<div class="language-text highlight"><pre><span></span><code>Generally, the URL and the date of retrieval are sufficient. Add
more details if it will help the reader get a clearer
understanding of the source.
</code></pre></div>
</li>
<li>
<p>如果你修改了代码，你需要注明：“Adapted from:”（修改自）或者“Based on”（基于）。这样读者就知道你修改了代码。</p>
<div class="language-text highlight"><pre><span></span><code>If you adapted the code, you should indicate “Adapted from:” or
“Based on” so it is understood that you modified the code.
</code></pre></div>
</li>
<li>
<p>你的老师可能会对你如何引用代码有具体的要求。如果你不能确认什么是可行的，请询问你的老师。</p>
<div class="language-text highlight"><pre><span></span><code>Your instructor may have specific instructions on how you should
or should not cite your sources. If you are not clear on what is
acceptable, ask your instructor.
</code></pre></div>
</li>
</ol>
<h3 id="开源软件的使用-use-of-open-source-software"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A5%C2%BC%C2%80%C3%A6%C2%BA%C2%90%C3%A8%C2%BD%C2%AF%C3%A4%C2%BB%C2%B6%C3%A7%C2%9A%C2%84%C3%A4%C2%BD%C2%BF%C3%A7%C2%94%C2%A8-use-of-open-source-software">开源软件的使用 Use of Open Source Software</a></h3>
<p>当你使用开源软件项目的代码的时候，你不仅要注明代码的来源，还需要遵循代码的开源软件许可证。请记住：</p>
<div class="language-text highlight"><pre><span></span><code>When you use code from an open source project, you need both to
attribute the source and follow the terms of any open source license
that applies to the code you are using. Keep in mind:
</code></pre></div>
<ol>
<li>
<p>当你下载源码的时候，它的开源软件许可证通常也在源码中。</p>
<div class="language-text highlight"><pre><span></span><code>When you download the source, the license is typically part of the
download.
</code></pre></div>
</li>
<li>
<p>同时，代码里也通常会包括它的版权和使用条款。</p>
<div class="language-text highlight"><pre><span></span><code>Also, the source code itself will typically contain the
copyright and terms of use.
</code></pre></div>
</li>
<li>
<p>当你引入了开源代码，并且它附带了开源软件许可证，你应该把它的版权声明复制到你的代码中，和/或把许可证复制到代码目录中的文件。</p>
<div class="language-text highlight"><pre><span></span><code>When you incorporate open-source-licensed code into a program,
it is good practice to duplicate the copyright in your code,
and/or store the license in a file with the code.
</code></pre></div>
</li>
<li>
<p>如果在下载的文件里没有找到开源软件许可证，你可以在开源项目的网站上找到全文，如 <a href="https://httpd.apache.org/">Apache HTTP Server 网站</a> 或者 <a href="https://opensource.org/">Open Source Initiative (OSI) 网站</a>。</p>
<div class="language-text highlight"><pre><span></span><code>If you don’t obtain the license with the download, you should be
able to find it on the site of the open source project, such as
Apache HTTP Server site, or on the Open Source Initiative (OSI)
site.
</code></pre></div>
</li>
</ol>
<h3 id="老师决定具体的代码复用程度-instructors-determine-the-specific-expectations-around-re-use-of-code-in-each-class"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A8%C2%80%C2%81%C3%A5%C2%B8%C2%88%C3%A5%C2%86%C2%B3%C3%A5%C2%AE%C2%9A%C3%A5%C2%85%C2%B7%C3%A4%C2%BD%C2%93%C3%A7%C2%9A%C2%84%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81%C3%A5%C2%A4%C2%8D%C3%A7%C2%94%C2%A8%C3%A7%C2%A8%C2%8B%C3%A5%C2%BA%C2%A6-instructors-determine-the-specific-expectations-around-re-use-of-code-in-each-class">老师决定具体的代码复用程度 Instructors determine the specific expectations around re-use of code in each class.</a></h3>
<p>通常，老师会确定课程的协作规则。如果这个规则没有明确地给出来，或者你不确认什么是可行的，请询问你的老师。</p>
<div class="language-text highlight"><pre><span></span><code>Often, the requirements are described in the collaboration policy for
the class. If policy is not clearly described in the course materials
and you are not sure what is acceptable, ask your instructor.
</code></pre></div>
<h4 id="例子"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A4%C2%BE%C2%8B%C3%A5%C2%AD%C2%90">例子</a></h4>
<p>下面给出一个例子，是课程（Spring 2012 6.005 Elements of Software Construction）的协作规则：</p>
<div class="language-text highlight"><pre><span></span><code>Collaboration policy from Spring 2012 6.005 Elements of Software
Construction: (used with the permission of Professor Rob Miller, Dept of
Electrical Engineering &amp; Computer Science)
</code></pre></div>
<p>我们鼓励同学们互相帮助，但是为了保证每个人都有良好的独立学习体验，我们对你们做了如下的限制：</p>
<div class="language-text highlight"><pre><span></span><code>We encourage you to help each other with work in this class, but there
are limits to what you can do, to ensure that everybody has a good
individual learning experience.
</code></pre></div>
<h5 id="单人作业-individual-work"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A5%C2%8D%C2%95%C3%A4%C2%BA%C2%BA%C3%A4%C2%BD%C2%9C%C3%A4%C2%B8%C2%9A-individual-work">单人作业 Individual work</a></h5>
<p>课程里的习题都要单人完成。我们鼓励同学们讨论实现方法，但是你的代码和报告都需要自己完成。</p>
<div class="language-text highlight"><pre><span></span><code>Problem sets in this class are intended to be primarily individual
efforts. You are encouraged to discuss approaches with other students
but your code and your write-up must be your own.
</code></pre></div>
<p>你不能使用其他同学编写的资料，无论是这个学期还是以往学期的同学。你也不可以把你的成果提供给其他同学。</p>
<div class="language-text highlight"><pre><span></span><code>You may not use materials produced as course work by other students,
whether in this term or previous terms, nor may you provide work for
other students to use.
</code></pre></div>
<p>帮助其他同学是应该的。但要保证一个原则，当你在帮助其他同学的时候，你自己的答案或代码不应该可以看到，无论是自己还是其他同学。可以养成一个习惯，帮助他人的时候把笔记本电脑合上。</p>
<div class="language-text highlight"><pre><span></span><code>It’s good to help other students. But as a general rule, during the time
that you are helping another student, your own solution should not be
visible, either to you or to them. Make a habit of closing your laptop
while you’re helping.
</code></pre></div>
<p>在帮助其他同学，阅读同学的代码的时候，你会看到同学的解答。你可以从同学的方法里获得灵感，但是不能复制他们的成果。</p>
<div class="language-text highlight"><pre><span></span><code>During code review, you will see classmates’ solutions to a problem set.
While it is fine to take inspiration from their approach, do not copy
their work.
</code></pre></div>
<p>你可以用外部网站上的资料，比如 StackOverflow，但前提是加上引用，并且作业要求里允许这么做。特别地，如果作业要求里写了“实现 X 功能”，那么你必须自己实现 X 功能，而不能复用外部的代码。</p>
<div class="language-text highlight"><pre><span></span><code>It’s fine to use material from external sources like StackOverflow, but
only with proper attribution, and only if the assignment allows it. In
particular, if the assignment says “implement X,” then you must create
your own X, not reuse one from an external source.
</code></pre></div>
<p>你也可以用课程组提供的代码，不需要引用。老师提供的代码在未经允许的情况下，不能公开分享，我们后面会讨论这个问题。</p>
<div class="language-text highlight"><pre><span></span><code>It’s also fine to use any code provided by this semester’s 6.031 staff
(in class, readings, or problem sets), without need for attribution.
Staff-provided code may not be publicly shared without permission,
however, as discussed later in this document.
</code></pre></div>
<p>例子一 Example 1：</p>
<ul>
<li>
<p>A 和 B 做作业的时候坐在一起。他们简略地讨论实现的不同方法。他们在白板上画流程图。当 A 发现 Java 标准库中一个有用的类，她把这个发现告诉了 B。当 B 发现了 StackOverflow 上的一个回答，他给 A 发送了 URL。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Alyssa and Ben sit next to each other with their laptops while
working on a problem set. They talk in general terms about
different approaches to doing the problem set. They draw
diagrams on the whiteboard. When Alyssa discovers a useful class
in the Java library, she mentions it to Ben. When Ben finds a
StackOverflow answer that helps, he sends the URL to Alyssa. OK.
</code></pre></div>
</li>
<li>
<p>在他们编写代码的时候，他们把代码大声念出来，好让双方都可以编写正确的代码。错误！</p>
<div class="language-text highlight"><pre><span></span><code>As they type lines of code, they speak the code aloud to the
other person, to make sure both people have the right code.
INAPPROPRIATE.
</code></pre></div>
</li>
<li>
<p>在作业最困难的部分，A 和 B 互相看电脑屏幕，并对比代码，确认他们代码实现都是正确的。错误！</p>
<div class="language-text highlight"><pre><span></span><code>In a tricky part of the problem set, Alyssa and Ben look at each
other’s screens and compare them so that they can get their code
right. INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子二 Example 2：</p>
<ul>
<li>
<p>J 已经完成了作业，但是他的朋友 B 正在努力解决一个 bug。J 坐在 B 旁边，看他的代码，帮他调试出了问题。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Jerry already finished the problem set, but his friend Ben is
now struggling with a nasty bug. Jerry sits next to Ben, looks
at his code, and helps him debug. OK.
</code></pre></div>
</li>
<li>
<p>J 打开了自己的笔记本，找到自己的答案，然后指着自己的代码给 B 纠正错误。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Jerry opens his own laptop, finds his solution to the problem
set, and refers to it while he’s helping Ben correct his code.
INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子三 Example 3：</p>
<ul>
<li>
<p>L 这周有很多作业，但是因为时间和身体原因来不及做。他已经错过截止时间两天了，但基本没有什么进度。B 觉得 L 可怜，想要帮助 L。在 L 写作业的时候，B 告诉 L 他是怎么做作业的。B 已经提交了自己的答案，并且在帮助 L 的时候，不打开自己的笔记本电脑。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Louis had three problem sets and two quizzes this week, was away
from campus for several days for a track meet, and then got
sick. He’s already taken two slack days on the deadline and has
made almost no progress on the problem set. Ben feels sorry for
Louis and wants to help, so he sits down with Louis and talks
with him about how to do the problem set while Louis is working
on it. Ben already handed in his own solution, but he doesn’t
open his own laptop to look at it while he’s helping Louis. OK.
</code></pre></div>
</li>
<li>
<p>B 打开了自己的笔记本电脑，并且在帮助 L 的时候阅读自己的代码。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Ben opens his laptop and reads his own code while he’s helping
Louis. INAPPROPRIATE.
</code></pre></div>
</li>
<li>
<p>B 花了几个小时帮助 L，但是 L 还是没有完成。但是 B 需要去做自己的事情了。在 L 承诺只有在必要的时候才会看 B 的代码之后，B 把自己的代码上传到 Dropbox 并且分享给了 L。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Ben has by now spent a couple hours with Louis, and Louis still
needs help, but Ben really needs to get back to his own work. He
puts his code in a Dropbox and shares it with Louis, after Louis
promises only to look at it when he really has to.
INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子四 Example 4：</p>
<ul>
<li>J 和 E 独立完成作业。他们交换了自己的测例来检查作业。错误！测例是题目的一部分，也是学习体验的一部分。如果你使用了其他人的测例，就是在抄袭，即使只是临时的。<div class="language-text highlight"><pre><span></span><code>John and Ellen both worked on their problem sets separately.
They exchange their test cases with each other to check their
work. INAPPROPRIATE. Test cases are part of the material for the
problem set, and part of the learning experience of the course.
You are copying if you use somebody else’s test cases, even if
temporarily.
</code></pre></div>
</li>
</ul>
<p>注意，在上面的例子中，双方都负有学术不端的责任。抄袭作业，或者把自己的作业提供给他人，是一个很严重的事情，可能导致分数扣减，课程不及格甚至处分。抄袭作业，或者帮助他人抄袭，可能会给你的成绩单上添加一个不能消除的 F。</p>
<div class="language-text highlight"><pre><span></span><code>Note that in the examples marked inappropriate above, both people are
held responsible for the violation in academic honesty. Copying work, or
knowingly making work available for copying, in contravention of this
policy is a serious offense that may incur reduced grades, failing the
course, and disciplinary action. Copying, or helping somebody copy, may
result in an F on your transcript that you will not be able to drop.
</code></pre></div>
<p>上述的要求对课程所有的单人作业都使用。</p>
<div class="language-text highlight"><pre><span></span><code>This policy applies to all coursework that is handed in by an
individual: problem sets, reading exercises, nanoquiz makeups, etc.
</code></pre></div>
<h5 id="组队作业-group-work"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A7%C2%BB%C2%84%C3%A9%C2%98%C2%9F%C3%A4%C2%BD%C2%9C%C3%A4%C2%B8%C2%9A-group-work">组队作业 Group work</a></h5>
<p>你应该和你的队友合作完成组队作业，并且每个人都应该有接近的任务量。</p>
<div class="language-text highlight"><pre><span></span><code>You should collaborate with your partners on all aspects of group
project work and in-class collaborative exercises, and each of you is
expected to contribute a roughly equal share to design and
implementation.
</code></pre></div>
<p>你可以复用自己在学期内早些时候编写的代码等（包括之前自己和其他队友完成的）。你也可以用课程提供的任何代码。</p>
<div class="language-text highlight"><pre><span></span><code>You may reuse designs, ideas and code from your own work earlier in the
semester (even if it was done with a different partner). You may also
use any code provided by this semester’s 6.031 staff.
</code></pre></div>
<p>你可以使用外部代码，只要：</p>
<ol>
<li>所有同学都可以访问这个资料</li>
<li>进行了合理的引用</li>
<li>作业允许你这么做</li>
</ol>
<p>特别地，如果作业要求你“实现 X 功能”，你就必须自己实现 X 功能，不能复用他人的。</p>
<p>你们组不能复用其他组的代码和思路，无论是其他组是当前学期还是以往学期的同学。</p>
<div class="language-text highlight"><pre><span></span><code>You may also use material from external sources, so long as: (1) the
material is available to all students in the class; (2) you give proper
attribution; and (3) the assignment itself allows it. In particular, if
the assignment says “implement X,” then you must create your own X, not
reuse someone else’s. Finally, your group may not reuse designs, ideas,
or code created by another group, in this semester or previous
semesters.
</code></pre></div>
<h3 id="即使修改网络上的代码很常见-although-it-is-common-practice-to-adapt-code-examples-found-on-the-web"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A5%C2%8D%C2%B3%C3%A4%C2%BD%C2%BF%C3%A4%C2%BF%C2%AE%C3%A6%C2%94%C2%B9%C3%A7%C2%BD%C2%91%C3%A7%C2%BB%C2%9C%C3%A4%C2%B8%C2%8A%C3%A7%C2%9A%C2%84%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81%C3%A5%C2%BE%C2%88%C3%A5%C2%B8%C2%B8%C3%A8%C2%A7%C2%81-although-it-is-common-practice-to-adapt-code-examples-found-on-the-web">即使修改网络上的代码很常见 Although it is common practice to adapt code examples found on the web,</a></h3>
<ul>
<li>
<p>你不能抄袭其他同学的代码。你的同学不是一个合法的代码来源。</p>
<div class="language-text highlight"><pre><span></span><code>You should never copy code from other students. Your peers are
not considered an authorized source.
</code></pre></div>
</li>
<li>
<p>你不能简单地复用网上的代码。就像学术写作，你可以采用别人的思路，但是你也要把自己的理解加进去。</p>
<div class="language-text highlight"><pre><span></span><code>You should not simply re-use code as the solution to an
assignment. Like academic writing, your code can incorporate the
ideas of others but should reflect your original approach to the
problem.
</code></pre></div>
</li>
</ul>
<h3 id="引用代码的例子-examples-of-citing-code-sources"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A5%C2%BC%C2%95%C3%A7%C2%94%C2%A8%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81%C3%A7%C2%9A%C2%84%C3%A4%C2%BE%C2%8B%C3%A5%C2%AD%C2%90-examples-of-citing-code-sources">引用代码的例子 Examples of citing code sources</a></h3>
<p>例子一 Example 1：</p>
<p>在 Apache 项目的源码的 PluginProxyUtil 类中，开发者引用了论坛的 URL，作者和时间：</p>
<div class="language-text highlight"><pre><span></span><code>In describing the class PluginProxyUtil in the Apache Project source
code, the developer cites the source as a post in a forum and includes
the URL, author and date:
</code></pre></div>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-1"></a><span class="cm">/**</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-2"></a><span class="cm">* A utility class that gives applets the ability to detect proxy host settings.</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-3"></a><span class="cm">* This was adapted from a post from Chris Forster on 20030227 to a Sun Java</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-4"></a><span class="cm">* forum here:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-5"></a><span class="cm">* http://forum.java.sun.com/thread.jspa?threadID=364342&amp;tstart=120</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-6"></a><span class="cm">[…]</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-7"></a><span class="cm">*/</span>
</span></code></pre></div>
<p>（来源：Apache Project 源代码 http://svn.apache.org 于 2019 年 7 月获取）</p>
<div class="language-text highlight"><pre><span></span><code>(Source: Apache Project source code http://svn.apache.org retrieved in
July 2019.)
</code></pre></div>
<p>例子二 Example 2：</p>
<p>在 Google Chrome <code>stack_trace_win</code> 的 <code>OutputTraceToStream</code> 函数中，开发者引用了 Microsoft Developer Network 并且附带了 URL：</p>
<div class="language-text highlight"><pre><span></span><code>In the function OutputTraceToStream in the Google Chrome stack_trace_win
source code, the developer cites the source code as the Microsoft
Developer Network and includes a URL:
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-1-1"></a><span class="c1">// Code adapted from MSDN example:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-1-2"></a><span class="c1">// http://msdn.microsoft.com/en-us/library/ms680578(VS.85).aspx </span>
</span></code></pre></div>
<p>（来源：https://github.com/adobe/chromium/blob/master/base/debug/stack_trace_win.cc 于 2019 年 7 月获取） </p>
<div class="language-text highlight"><pre><span></span><code>(Source:
https://github.com/adobe/chromium/blob/master/base/debug/stack_trace_win.cc
retrieved in July 2019.)
</code></pre></div>
<h3 id="引用附有开源许可证的代码的例子-example-of-open-source-licensed-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#%C3%A5%C2%BC%C2%95%C3%A7%C2%94%C2%A8%C3%A9%C2%99%C2%84%C3%A6%C2%9C%C2%89%C3%A5%C2%BC%C2%80%C3%A6%C2%BA%C2%90%C3%A8%C2%AE%C2%B8%C3%A5%C2%8F%C2%AF%C3%A8%C2%AF%C2%81%C3%A7%C2%9A%C2%84%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81%C3%A7%C2%9A%C2%84%C3%A4%C2%BE%C2%8B%C3%A5%C2%AD%C2%90-example-of-open-source-licensed-code">引用附有开源许可证的代码的例子 Example of open-source-licensed code:</a></h3>
<p>在 Google Chrome <code>stack_trace_win</code> 代码的开头，可以看到版权声明和开源许可证的引用：</p>
<div class="language-text highlight"><pre><span></span><code>At the top of the Google Chrome stack_trace_win source file, note the
copyright and reference to the open source license:
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-1"></a><span class="c1">// Copyright (c) 2011 The Chromium Authors. All rights reserved.</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-2"></a><span class="c1">// Use of this source code is governed by a BSD-style license that can be</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-3"></a><span class="c1">// found in the LICENSE file.</span>
</span></code></pre></div>
<p>如果你把这个代码加入到你的程序中，你需要遵守 Chromium 作者的开源许可证协议中的条款。虽然这个开源许可证只要求你在重分发的时候复制一份版权声明和许可证，一个好习惯是无论是否要求，你都要复制它的版权声明到代码中，和/或把它的许可证放到代码目录的文件中。这样的话，如果你在将来想要重分发你的代码，就很容易检查知识产权相关的问题。</p>
<div class="language-text highlight"><pre><span></span><code>If you incorporate this code into a program, you should follow the terms
outlined in The Chromium Authors&#39; open source license file, which is
shown below. While this license only requires that you duplicate the
copyright and license if you are redistributing the code, it is good
practice to always duplicate the copyright in your code, and/or store
the license in a file with the code. This way, if you want to
redistribute the code later, intellectual property reviewing becomes
much easier.
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-1"></a><span class="c1">// Copyright (c) 2014 The Chromium Authors. All rights reserved.</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-2"></a><span class="c1">//</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-3"></a><span class="c1">// Redistribution and use in source and binary forms, with or without</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-4"></a><span class="c1">// modification, are permitted provided that the following conditions are</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-5"></a><span class="c1">// met:</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-6"></a><span class="c1">//</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-7"></a><span class="c1">//* Redistributions of source code must retain the above copyright</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-8"></a><span class="c1">// notice, this list of conditions and the following disclaimer.</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-9"></a><span class="c1">//* Redistributions in binary form must reproduce the above</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-10"></a><span class="c1">// copyright notice, this list of conditions and the following disclaimer</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-11"></a><span class="c1">// in the documentation and/or other materials provided with the</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-12"></a><span class="c1">// distribution.</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-13"></a><span class="c1">//* Neither the name of Google Inc. nor the names of its</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-14"></a><span class="c1">// contributors may be used to endorse or promote products derived from</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-15"></a><span class="c1">// this software without specific prior written permission.</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-16"></a><span class="c1">//</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-17"></a><span class="c1">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-18"></a><span class="c1">// &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-19"></a><span class="c1">// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-20"></a><span class="c1">// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-21"></a><span class="c1">// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-22"></a><span class="c1">// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-23"></a><span class="c1">// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-24"></a><span class="c1">// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-25"></a><span class="c1">// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-26"></a><span class="c1">// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-27"></a><span class="c1">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-28"></a><span class="c1">//</span>
</span></code></pre></div>
<p>（来源：The Chromium Authors license file https://src.chromium.org/viewvc/chrome/trunk/src/LICENSE 于 2019 年 7 月获取）</p>
<div class="language-text highlight"><pre><span></span><code>(Source: The Chromium Authors license file
https://src.chromium.org/viewvc/chrome/trunk/src/LICENSE retrieved in
July 2019.)
</code></pre></div>

    <nav class="md-post__action">
      <a href="../../programming/2022/07/12/writing-code-cn/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-06-23 00:00:00">2021年6月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="c-11-的-abi-问题"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/">C++ 11 的 ABI 问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>有同学遇到这样的一个问题，代码中链接了一个第三方的动态库，在链接的时候出现了不一致的问题，比如有一个函数签名如下：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-0-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">foobar</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</span></code></pre></div>
<p>使用 GCC 11.1.0 编译上面的代码，可以发现它需要的符号是 <code>_Z6foobarNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE</code>，但是第三方库里面却是 <code>_Z6foobarSs</code>，因此找不到对应的符号，链接失败。</p>
<h3 id="问题"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/#%C3%A9%C2%97%C2%AE%C3%A9%C2%A2%C2%98">问题</a></h3>
<p>经过一番研究，发现 <code>Ss</code> 在 <a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html">Itanium ABI</a> 中表示的是缩写：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-1"></a>In addition, the following catalog of abbreviations of the form &quot;Sx&quot; are used:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-4"></a>   &lt;substitution&gt; ::= St # ::std::
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-5"></a>   &lt;substitution&gt; ::= Sa # ::std::allocator
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-6"></a>   &lt;substitution&gt; ::= Sb # ::std::basic_string
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-7"></a>   &lt;substitution&gt; ::= Ss # ::std::basic_string &lt; char,
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-8"></a>                         ::std::char_traits&lt;char&gt;,
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-9"></a>                         ::std::allocator&lt;char&gt; &gt;
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-10"></a>   &lt;substitution&gt; ::= Si # ::std::basic_istream&lt;char,  std::char_traits&lt;char&gt; &gt;
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-11"></a>   &lt;substitution&gt; ::= So # ::std::basic_ostream&lt;char,  std::char_traits&lt;char&gt; &gt;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-12"></a>   &lt;substitution&gt; ::= Sd # ::std::basic_iostream&lt;char, std::char_traits&lt;char&gt; &gt;
</span></code></pre></div>
<p>这看起来很正常，<code>_Z6foobarSs</code> 表示的是 <code>foobar(std::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;)</code>，但是 GCC 11.1.0 编译出来的上面的代码却没有用这个符号，而是 <code>foobar(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;)</code>。差别就在于 <code>__cxx11</code> 中。</p>
<p>经过一番搜索，找到了 GCC <a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html">关于这个问题的文档</a>和<a href="https://developers.redhat.com/blog/2015/02/05/gcc5-and-the-c11-abi">网上的文章</a>，找到了原因：从 GCC5 开始，为了兼容 C++11 标准的改变，做了这个变动。如果要恢复原来的行为，需要添加一个定义：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-1"></a>$<span class="w"> </span>g++<span class="w"> </span>-D_GLIBCXX_USE_CXX11_ABI<span class="o">=</span><span class="m">0</span><span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-2"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarSs
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-3"></a>$<span class="w"> </span>g++<span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-4"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-5"></a><span class="c1">## install g++-4.9 in ubuntu 16.04</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-6"></a>$<span class="w"> </span>g++-4.9<span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-7"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarSs
</span></code></pre></div>
<p>这样就可以正常链接到第三方的动态库了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2021/06/23/cpp-11-abi-problem/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-12-04 00:00:00">2020年12月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rust-在-m1-上的-code-signing-问题和临时解决方法"><a class="toclink" href="../../programming/2020/12/04/workaround-rust-on-m1/">Rust 在 M1 上的 Code Signing 问题和临时解决方法</a></h2>
<p>不久前，rust 添加了 Tier2 的 aarch64-apple-darwin 的支持，试了一下，确实可以运行，不过当我编译的时候，出现：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-0-1"></a>error: failed to run custom build command for `xxxx v1.0 (/path/to/xxxx)`
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-0-3"></a>Caused by:
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-0-4"></a>  process didn&#39;t exit successfully: `/path/to/xxx/target/debug/build/xxx-xxxx/build-script-build` (signal: 9, SIGKILL: kill)
</span></code></pre></div>
<p>看了一下 Console.app 里面的 crash 日志，发现是 codesigning 问题。解决方法是，用 codesign 命令来签名：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-1-1"></a><span class="c1">## for build.rs</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-1-2"></a>codesign<span class="w"> </span>-s<span class="w"> </span>-<span class="w"> </span>target/debug/build/*/build-script-build
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-1-3"></a><span class="c1">## for dylib of some crates</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-1-4"></a>codesign<span class="w"> </span>-s<span class="w"> </span>-<span class="w"> </span>target/debug/deps/*.dylib
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-1-5"></a><span class="c1">## for final executable</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-1-6"></a>codesign<span class="w"> </span>-s<span class="w"> </span>-<span class="w"> </span>target/debug/xxx
</span></code></pre></div>
<p>多次编译并签名后，就可以正常运行最后的二进制了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2020/12/04/workaround-rust-on-m1/#__codelineno-2-1"></a>target/debug/xxxx:<span class="w"> </span>Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>arm64
</span></code></pre></div>
<p>然后就可以了。等待上游添加 code signing 支持吧。</p>
<p>2020-12-07 更新：找了找 cargo 的 issues，找到了<a href="https://github.com/rust-lang/cargo/issues/8913">同样的问题</a>，看来并不是 code signing 支持的问题，而是在 Intel 的 Alacritty 下面，运行 Apple 的 rustc 工具链的时候，才会出现的 BUG。我也自己试了一下，在 Apple 的 Terminal 下跑编译就没有问题。</p>

    <nav class="md-post__action">
      <a href="../../programming/2020/12/04/workaround-rust-on-m1/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-13 00:00:00">2020年9月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-arm64-上使用-rust-analyzer"><a class="toclink" href="../../programming/2020/09/13/aarch64-rust-analyzer/">在 arm64 上使用 rust-analyzer</a></h2>
<p>远程到 arm64 的机器上进行开发，发现没有 rust-analyzer 的支持。研究了一下，发现在 rustup 里面可以找到，不过要配置一下：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2020/09/13/aarch64-rust-analyzer/#__codelineno-0-1"></a>&gt;<span class="w"> </span>rustup<span class="w"> </span>toolchain<span class="w"> </span>add<span class="w"> </span>nightly
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2020/09/13/aarch64-rust-analyzer/#__codelineno-0-2"></a>&gt;<span class="w"> </span>rustup<span class="w"> </span>component<span class="w"> </span>add<span class="w"> </span>--toolchain<span class="w"> </span>nightly<span class="w"> </span>rust-analyzer-preview
</span></code></pre></div>
<p>这个时候，应该可以找到 <code>~/.rustup/toolchains/nightly-aarch64-unknown-linux-gnu/bin/rust-analyzer</code> 文件，接下来，配置 VSCode 插件即可：</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2020/09/13/aarch64-rust-analyzer/#__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2020/09/13/aarch64-rust-analyzer/#__codelineno-1-2"></a><span class="w">    </span><span class="nt">&quot;rust-analyzer.serverPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~/.rustup/toolchains/nightly-aarch64-unknown-linux-gnu/bin/rust-analyzer&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2020/09/13/aarch64-rust-analyzer/#__codelineno-1-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>路径在 <code>~/.vscode-server/data/Machine/settings.json</code>。</p>
<p>参考：https://github.com/rust-analyzer/rust-analyzer/issues/5256</p>

    <nav class="md-post__action">
      <a href="../../programming/2020/09/13/aarch64-rust-analyzer/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-17 00:00:00">2019年11月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="实现一个简单的-decaf-lsp"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/">实现一个简单的 Decaf LSP</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>编译原理课程在做 Decaf 的 PA，之前做了一些比较简单的尝试，包括在线 Decaf、在线 TAC VM 等等，都是套一个前端，然后整个编译到 wasm 跑前端就可以了。如果要做 LSP 的话，工作量会稍微大一些，不过也更加实用。</p>
<p>然后有一天，助教 @equation314 写了 <a href="https://github.com/equation314/decaf-vscode">decaf-vscode</a> 一个 VSCode 对 Decaf 的语法高亮插件，我就 Fork 了一份到 <a href="https://github.com/jiegec/decaf-vscode">jiegec/decaf-vscode</a>，然后添加了 LSP 的支持，让它有了一些更高级的功能。</p>
<h3 id="实现"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A5%C2%AE%C2%9E%C3%A7%C2%8E%C2%B0">实现</a></h3>
<p>LSP 服务端一般是一个命令行程序，通过 JSONRPC 进行消息通讯，然后就上午找有没有现成的框架。比较重要的是 <a href="https://crates.io/crates/lsp-types">lsp-types</a> 和 <a href="https://crates.io/crates/tower-lsp">tower-lsp</a> ，前者封装了 LSP 协议的各个结构体，后者提供了服务端的大概实现。不过由于后者做的不大全，所以我自己 fork 了一份添加了一些。</p>
<p>实际实现的时候，需要实现几个函数，分别相应客户端的请求，比如在 initialize 的时候告诉客户端我都实现了哪些东西，然后相应地提供各种信息，如 symbol，hover，folding，definition 等等。为了实现简单，我要求客户端每次修改的时候都把完整的文件传过来，虽然不是很高效，但是很简单，目前也没有啥很长的 Decaf 程序嘛。</p>
<p>每次拿到 Decaf 程序之后，就按照 decaf-rs 的方法，Lex 然后 Parse，然后遍历 AST，分别把需要的各个信息都存下来，当客户端在请求的时候，直接返回即可。然后就会在 VSCode 中出现，比如实现了 document symbol，在左边的 Outline 中就会出现相应的结构；实现了 hover，当移动到一些地方的时候，客户端发出请求，服务端就把相应的 hover 信息返回给客户端。整个协议并不复杂，后面实际实现其实才是比较复杂的地方。</p>
<p>实现的功能中，symbols hovers ranges definition 都是在得到 AST 后一次遍历都计算好，然后返回，同时在遇到错误的时候，也通过 diagnostic 的形式把检查出来的错误汇报给用户。由于 VSCode 的良好支持，基本不需要写 TypeScript 代码。</p>
<p>至于代码补全，现在做的比较粗糙，仅仅补全了一些内置函数：Print ReadInteger 和 ReadLine。还在考虑支持函数调用的补全，但是在补全的时候会出现语法错误，意味着需要保证在补全的时候我还能拿到之前正确的类型信息，需要一些工作量，现在还没有去做。</p>
<h3 id="使用"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A4%C2%BD%C2%BF%C3%A7%C2%94%C2%A8">使用</a></h3>
<p>我自己测试的方法就是两个窗口，一个是 <a href="https://github.com/jiegec/decaf-lsp">decaf-lsp</a> ，首先克隆下来，然后 <code>cargo install --path . --force</code> 来安装到全局；另一个就是我 Fork 的 <a href="https://github.com/jiegec/decaf-vscode">decaf-vscode</a> ，克隆下来，然后按 <code>F5</code> 进入 VSCode 的调试模式，它会打开一个新窗口，里面启用了 Decaf for VSCode 插件。这个时候看 Decaf 代码就可以看到上面提到的那些东西了。</p>
<h3 id="总结"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A6%C2%80%C2%BB%C3%A7%C2%BB%C2%93">总结</a></h3>
<p>感觉 LSP 是一个比较好实现的 Protocol，但 Protocol 承载的 Data 才是比较困难的东西。要实现一个完整的 completion 还需要很多东西，现在只能说是个 naive implementation 吧。</p>
<p>刚写完就发现 Neovim 发布了 <a href="https://github.com/neovim/nvim-lsp">官方的 LSP client</a> 。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/11/17/rust-decaf-lsp/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-15 00:00:00">2019年11月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-rust-procedure-macro-实现-gll-parser"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/">用 Rust Procedure Macro 实现 GLL Parser</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>在编译原理课上，PA 框架采用的是 <a href="https://github.com/MashPlant/lalr1">MashPlant/lalr1</a> ，是一个比较好用的 Lexer + Parser 的工具，它的大概语法见 <a href="https://mashplant.gitbook.io/decaf-doc/pa1a/lalr1-shi-yong-zhi-dao/yi-ge-wan-zheng-de-li-zi">一个完整的例子</a> 。然后之前看到了 GLL Parser，想着可不可以照着类似的语法也写一个 GLL 的 Parser Generator，也是用 Rust Procedure Macro 的方法，就开始了研究。</p>
<h3 id="尝试"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A5%C2%B0%C2%9D%C3%A8%C2%AF%C2%95">尝试</a></h3>
<p>首先是阅读 GLL 的论文，它并不长，大概的意思就是，LL(1) 文法需要考虑 PS 冲突的情况，而 GLL 的解决方法就是“都试一下”，然后为了效率，用了 GSS 表示解析过程和 SPPF 表示解析结果。然后就开始照着论文手写了不同版本的实现，见 <a href="https://github.com/jiegec/gll-test">jiegec/gll-test</a> 。</p>
<p>第一种就是按照论文里第一段实现直接抄过来，每个可能性作为一个 Continuation 存下来，它有自己的栈和执行位置（Label）。这样 Work 以后呢，我又想到了 async/await，用类似的方法又写了一遍，相对要简洁一些，也是很平常的递归下降的写法，而不是 Loop + Label 的形式。但这些都不能做到合并栈的目的，所以遇到十分有歧义的文法的时候会很糟糕。</p>
<p>然后开始按照论文中的 GSS 进行编写，基本还是按照论文进行翻译，然后一步一步做，做好以后把 GSS 画出来，和论文的图可以对的上；然后照着 GLL parse-tree generation 的论文把 SPPF 实现了，这时候就可以从 recongizer 变成一个 parser 了。</p>
<h3 id="宏"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A5%C2%AE%C2%8F">宏</a></h3>
<p>得到一份可行的代码以后，就要扩展到通用的情况上。学习了一下 MashPlant/lalr1 的实现，实现了一个 proc macro，它读取了用户的程序，从一个模板文件开始，往里面插入一些生成的代码，丢给编译器去编译。这时候就涉及到编译期和运行时的不同了，我把运行时一些通用的结构放到了 <code>gll-pg-core</code> 中，把编译期的代码放到了 <code>gll-pg-macros</code> 。</p>
<p>代码生成的时候，基本按照之前自己写的样子抄，只不过这个时候要按照用户编写的产生式进行生成了，各种名字都要规范化，变得可以复用，然后尽量减少命名空间的污染等等这些常见的写宏需要注意的操作。</p>
<p>不过，考虑到现在还没有实现 Lexer，所以先用了 Logos 库作为 Lexer。但我其实不大喜欢它，因为它太简单，也没有行号的信息，不过暂且先这样吧，以后可能会自己实现。</p>
<p>然后 0.1.0 版本就诞生了，它的样例长这样：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-1"></a><span class="sd">//! This example is taken from MashPlant/lalr1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-3"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_core</span>::<span class="n">LogosToken</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-4"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_macros</span>::<span class="n">gll</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-5"></a><span class="k">use</span><span class="w"> </span><span class="n">logos</span>::<span class="n">Logos</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-7"></a>#<span class="cp">#[derive(Logos, Debug, Eq, PartialEq, Clone)]</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-8"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Token</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-9"></a><span class="w">    </span><span class="cp">#[end]</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-10"></a><span class="w">    </span><span class="n">End</span><span class="p">,</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-11"></a><span class="w">    </span><span class="cp">#[error]</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-12"></a><span class="w">    </span><span class="n">Error</span><span class="p">,</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-13"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot; &quot;</span><span class="cp">]</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-14"></a><span class="w">    </span><span class="n">_Eps</span><span class="p">,</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-15"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;+&quot;</span><span class="cp">]</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-16"></a><span class="w">    </span><span class="n">Add</span><span class="p">,</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-17"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;-&quot;</span><span class="cp">]</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-18"></a><span class="w">    </span><span class="n">Sub</span><span class="p">,</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-19"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;*&quot;</span><span class="cp">]</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-20"></a><span class="w">    </span><span class="n">Mul</span><span class="p">,</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-21"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;/&quot;</span><span class="cp">]</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-22"></a><span class="w">    </span><span class="n">Div</span><span class="p">,</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-23"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;%&quot;</span><span class="cp">]</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-24"></a><span class="w">    </span><span class="n">Mod</span><span class="p">,</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-25"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;(&quot;</span><span class="cp">]</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-26"></a><span class="w">    </span><span class="n">LPar</span><span class="p">,</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-27"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;)&quot;</span><span class="cp">]</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-28"></a><span class="w">    </span><span class="n">RPar</span><span class="p">,</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-29"></a><span class="w">    </span><span class="cp">#[regex = </span><span class="s">&quot;[0-9]+&quot;</span><span class="cp">]</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-30"></a><span class="w">    </span><span class="n">IntLit</span><span class="p">,</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-31"></a><span class="p">}</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-32"></a>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-33"></a>#<span class="cp">#[gll(Expr, Token)]</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-34"></a><span class="k">impl</span><span class="w"> </span><span class="n">Parser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-35"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Add Expr)]</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-36"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_add</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-37"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-39"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Sub Expr)]</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-40"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_sub</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-41"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-43"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mul Expr)]</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-44"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mul</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-45"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-47"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Div Expr)]</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-48"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_div</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-49"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-51"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mod Expr)]</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-52"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mod</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-53"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-55"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Sub Expr)]</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-56"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_neg</span><span class="p">(</span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-57"></a><span class="w">        </span><span class="o">-</span><span class="n">r</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-58"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-59"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; LPar Expr RPar)]</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-60"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_paren</span><span class="p">(</span><span class="n">_l</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_r</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-61"></a><span class="w">        </span><span class="n">i</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-62"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-63"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; IntLit)]</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-64"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_int</span><span class="p">(</span><span class="n">i</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-65"></a><span class="w">        </span><span class="n">i</span><span class="p">.</span><span class="n">slice</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-67"></a><span class="p">}</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-68"></a>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-69"></a>#<span class="cp">#[test]</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-70"></a><span class="k">fn</span> <span class="nf">gll</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-71"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Token</span>::<span class="n">lexer</span><span class="p">(</span><span class="s">&quot;1 + 2 * 3&quot;</span><span class="p">);</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-72"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Parser</span>::<span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="p">);</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-73"></a><span class="w">    </span><span class="c1">// two ways to parse</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-74"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">]);</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-75"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它解析的结果是一个数组，对应所有可能出现的情况。这样比较简单，但是要求中间各种类型都是 Clone，因为同一个结点可能会被用多次。它的计算方法就是在最终的 SPPF 上递归找到所有可能性，然后调用用户代码，最后放到一个 Vec 中。</p>
<h3 id="记忆化"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A8%C2%AE%C2%B0%C3%A5%C2%BF%C2%86%C3%A5%C2%8C%C2%96">记忆化</a></h3>
<p>但是，上面的做法有一个很大的问题，就是，虽然 SPPF 的空间复杂度是有限的，但所有可能的解析树可以有很多，如果把每一个情况都完整的存在一个 Vec 中，空间要求是很高的，中间也有很多重复计算的情况。所以需要做记忆化，然后每次给出一个。因为依赖自己内部的状态，所以不能是 Iterator 只能是 StreamingIterator。</p>
<p>记忆化也花了我一番功夫，现在用了一个比较土的办法，在每个结点上记录了当前遇到过的所有可能，这个是逐渐构造的，意味着如果只需要第一种解析树，不需要额外的空间。然后逐渐扩张，如果有可以重用的结构就重用，把涉及的所有的结构都放在一个 Vec 中，用完之后一起 drop 掉。</p>
<p>当然了，这个时候，各种东西都变成了引用：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-1"></a><span class="sd">//! This example is taken from MashPlant/lalr1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-3"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_core</span>::<span class="o">*</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-4"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_macros</span>::<span class="n">gll</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-5"></a><span class="k">use</span><span class="w"> </span><span class="n">logos</span>::<span class="n">Logos</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-7"></a>#<span class="cp">#[derive(Logos, Debug, Eq, PartialEq, Clone)]</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-8"></a><span class="k">enum</span> <span class="nc">Token</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-9"></a><span class="w">    </span><span class="cp">#[end]</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-10"></a><span class="w">    </span><span class="n">End</span><span class="p">,</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-11"></a><span class="w">    </span><span class="cp">#[error]</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-12"></a><span class="w">    </span><span class="n">Error</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-13"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot; &quot;</span><span class="cp">]</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-14"></a><span class="w">    </span><span class="n">_Eps</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-15"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;+&quot;</span><span class="cp">]</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-16"></a><span class="w">    </span><span class="n">Add</span><span class="p">,</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-17"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;-&quot;</span><span class="cp">]</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-18"></a><span class="w">    </span><span class="n">Sub</span><span class="p">,</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-19"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;*&quot;</span><span class="cp">]</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-20"></a><span class="w">    </span><span class="n">Mul</span><span class="p">,</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-21"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;/&quot;</span><span class="cp">]</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-22"></a><span class="w">    </span><span class="n">Div</span><span class="p">,</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-23"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;%&quot;</span><span class="cp">]</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-24"></a><span class="w">    </span><span class="n">Mod</span><span class="p">,</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-25"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;(&quot;</span><span class="cp">]</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-26"></a><span class="w">    </span><span class="n">LPar</span><span class="p">,</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-27"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;)&quot;</span><span class="cp">]</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-28"></a><span class="w">    </span><span class="n">RPar</span><span class="p">,</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-29"></a><span class="w">    </span><span class="cp">#[regex = </span><span class="s">&quot;[0-9]+&quot;</span><span class="cp">]</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-30"></a><span class="w">    </span><span class="n">IntLit</span><span class="p">,</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-31"></a><span class="p">}</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-32"></a>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-33"></a>#<span class="cp">#[derive(Default)]</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-34"></a><span class="k">struct</span> <span class="nc">Parser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-35"></a><span class="w">    </span><span class="n">literals</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-36"></a><span class="p">}</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-37"></a>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-38"></a>#<span class="cp">#[gll(Expr, Token)]</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-39"></a><span class="k">impl</span><span class="w"> </span><span class="n">Parser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-40"></a><span class="w">    </span><span class="c1">// you can omit self</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-41"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Add Expr)]</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-42"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_add</span><span class="p">(</span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-43"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-45"></a><span class="w">    </span><span class="c1">// you can use &amp;self</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-46"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Sub Expr)]</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-47"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_sub</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-48"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-50"></a><span class="w">    </span><span class="c1">// you can use &amp;mut self as well</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-51"></a><span class="w">    </span><span class="c1">// but all of these have &amp;mut self in fact</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-52"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mul Expr)]</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-53"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mul</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-54"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-55"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-56"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Div Expr)]</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-57"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_div</span><span class="p">(</span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-58"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-59"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-60"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mod Expr)]</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-61"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mod</span><span class="p">(</span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-62"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-64"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Sub Expr)]</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-65"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_neg</span><span class="p">(</span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-66"></a><span class="w">        </span><span class="o">-*</span><span class="n">r</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-67"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-68"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; LPar Expr RPar)]</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-69"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_paren</span><span class="p">(</span><span class="n">_l</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_r</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-70"></a><span class="w">        </span><span class="o">*</span><span class="n">i</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-72"></a><span class="w">    </span><span class="c1">// so you can make your IDE happy with &amp;mut self here</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-73"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; IntLit)]</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-74"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_int</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-75"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">lit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">slice</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-76"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">literals</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">lit</span><span class="p">);</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-77"></a><span class="w">        </span><span class="n">lit</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-79"></a><span class="p">}</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-80"></a>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-81"></a>#<span class="cp">#[test]</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-82"></a><span class="k">fn</span> <span class="nf">ambiguous</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-83"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Token</span>::<span class="n">lexer</span><span class="p">(</span><span class="s">&quot;1 + 2 + 3&quot;</span><span class="p">);</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-84"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Parser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">literals</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[]</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-85"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-86"></a><span class="w">    </span><span class="c1">// two ways to parse</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-87"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">cloned</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-88"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]);</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-89"></a><span class="p">}</span>
</span></code></pre></div>
<p>这时候就是 0.3.0 版本，基本达到了我一开始想要的程度。</p>
<h3 id="错误处理"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A9%C2%94%C2%99%C3%A8%C2%AF%C2%AF%C3%A5%C2%A4%C2%84%C3%A7%C2%90%C2%86">错误处理</a></h3>
<p>在之前写编译原理 PA1 的时候，遇到的一个问题就是，如果自己的代码有错，因为宏展开以后丢失了位置信息，所以报错都会在错误的位置。一番查找以后，找到了解决方案：原样记录下原来的代码（syn::Block），然后通过 quote 宏直接拼接到最终的 TokenStream 中，这样在结果里，虽然代码还是那些代码，但部分的 Token 就有了正确的位置，这样就很方便用户代码的修改了。不过还是不方便找模板部分的代码错误，毕竟那部分确实在原来的代码中没有出现过。</p>
<p>对于模板中的代码错误，我最终的解决方案是 <code>cargo-expand</code> ，把我的测试代码和展开后的代码拼接起来，然后在茫茫的无关报错下去找我的错误的地方。虽然不是很好用，但毕竟还是 work 的。另外，宏还需要对用户代码的一些类型进行检查，比如上面的 Expr 对应 i32，这个就需要在各处都保持一致，但这个就需要自己进行检查了。使用了一下 proc_macro_diagnostic 的 API，还不是很好用，等它 stable 吧。</p>
<h3 id="总结"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A6%C2%80%C2%BB%C3%A7%C2%BB%C2%93">总结</a></h3>
<p>终于自己手写了一个 Procedure Macro，感觉现有的工具已经比较成熟了，有 syn quote 以后很多操作都很方便。但代码还有很多地方可以优化，慢慢搞吧。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/11/15/rust-proc-macro-gll/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-07-17 00:00:00">2019年7月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="前端解析上传的-csv"><a class="toclink" href="../../programming/2019/07/17/parse-upload-csv-frontend/">前端解析上传的 CSV</a></h2>
<p>之前做过一个在前端解析上传的 CSV 的功能，但是只能支持部分的 encoding，遇到 gbk 就傻眼了。一番研究以后，找到了比较科学的方案：</p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-1"></a><span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Chardet</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;chardet&#39;</span><span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Iconv</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;iconv-lite&#39;</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-4"></a><span class="kd">const</span><span class="w"> </span><span class="nx">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileReader</span><span class="p">();</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-5"></a><span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-6"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-7"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-8"></a><span class="w">  </span><span class="c1">// detect encoding and convert</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-9"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">encoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Chardet</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-10"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Iconv</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span><span class="w"> </span><span class="nx">encoding</span><span class="p">);</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-11"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">csvData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Papa</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">data</span><span class="p">;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-12"></a><span class="w">  </span><span class="c1">// do anything with it</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-13"></a><span class="p">};</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2019/07/17/parse-upload-csv-frontend/#__codelineno-0-15"></a><span class="nx">reader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">blob_here</span><span class="p">);</span>
</span></code></pre></div>
<p>依赖了两个库：<code>chardet</code> 和 <code>iconv-lite</code> ，测试了一下，解析 UTF-8 GBK UTF-16BE 都没问题。</p>
<p>P.S. 在生成 csv 的时候，也会出现 Excel 打开后乱码的问题，一开始我以为需要转 UTF-16 然后再添加 BOM Mark，后来发现只要在最前面加上 0xEF 0xBB 0xFB（UTF-8 编码下的 BOM Mark）即可。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/07/17/parse-upload-csv-frontend/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-06-21 00:00:00">2019年6月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ip-前缀转换上意外遇到的-undefined-behavior"><a class="toclink" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/">IP 前缀转换上意外遇到的 Undefined Behavior</a></h2>
<p>最近发现了两个很神奇的 Undefined Behavior，出现在 Prefix Len 和 Netmask 的转换的问题下。一个简单思路可能是：</p>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-0-1"></a><span class="cp">##define PREFIX_BIN2DEC(bin) (32 - __builtin_ctz((bin)))</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-0-2"></a><span class="cp">##define PREFIX_DEC2BIN(hex) (((~0) &gt;&gt; (32 - (hex))) &lt;&lt; (32 - (hex))</span>
</span></code></pre></div>
<p>乍一看，似乎没有什么问题。但是，在一些平台下，可能会出现这样的结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-1-1"></a>PREFIX_BIN2DEC(0x00000000) = 33
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-1-2"></a>PREFIX_DEC2BIN(0) = 0xFFFFFFFF
</span></code></pre></div>
<p>而且只能在一些平台上不确定地复现，最后发现其实是 Undefined Behavior，在 C 的标准中：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-2-1"></a>In any case, the behavior is undefined if rhs is negative or is greater or equal the number of bits in the promoted lhs.
</span></code></pre></div>
<p>意味着， <code>0xFFFFFFFF &gt;&gt; 32</code> 是一个 UB，所以出现了上面的问题。</p>
<p>另外，<code>__builtin_ctz</code> 有这样的说明：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-3-1"></a>Returns the number of trailing 0-bits in x, starting at the least significant bit position. If x is 0, the result is undefined.
</span></code></pre></div>
<p>意味着，<code>__builtin_ctz(0)</code> 也是一个 UB，所以得到了错误的结果。</p>
<p>解决方案也很简单，下面提供一个参考的解决方法：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-4-1"></a><span class="cp">##define PREFIX_BIN2DEC(bin) ((bin) ? (32 - __builtin_ctz((bin))) : 0)</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-4-2"></a><span class="cp">##define PREFIX_DEC2BIN(hex) (((uint64_t)0xFFFFFFFF &lt;&lt; (32 - (hex))) &amp; 0xFFFFFFFF)</span>
</span></code></pre></div>
<p>Quagga 的实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-1"></a><span class="cm">/* Convert masklen into IP address&#39;s netmask (network byte order). */</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-2"></a><span class="kt">void</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-3"></a><span class="nf">masklen2ip</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">masklen</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">in_addr</span><span class="w"> </span><span class="o">*</span><span class="n">netmask</span><span class="p">)</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-4"></a><span class="p">{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-5"></a><span class="w">  </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">masklen</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">masklen</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">IPV4_MAX_BITLEN</span><span class="p">);</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-7"></a><span class="w">  </span><span class="cm">/* left shift is only defined for less than the size of the type.</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-8"></a><span class="cm">   * we unconditionally use long long in case the target platform</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-9"></a><span class="cm">   * has defined behaviour for &lt;&lt; 32 (or has a 64-bit left shift) */</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-11"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-12"></a><span class="w">    </span><span class="n">netmask</span><span class="o">-&gt;</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htonl</span><span class="p">(</span><span class="mh">0xffffffffULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">masklen</span><span class="p">));</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-13"></a><span class="w">  </span><span class="k">else</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-14"></a><span class="w">    </span><span class="n">netmask</span><span class="o">-&gt;</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htonl</span><span class="p">(</span><span class="n">masklen</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0xffffffffU</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">masklen</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-15"></a><span class="p">}</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-16"></a>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-17"></a><span class="cm">/* Convert IP address&#39;s netmask into integer. We assume netmask is</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-18"></a><span class="cm">   sequential one. Argument netmask should be network byte order. */</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-19"></a><span class="n">u_char</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-20"></a><span class="nf">ip_masklen</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">in_addr</span><span class="w"> </span><span class="n">netmask</span><span class="p">)</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-21"></a><span class="p">{</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-22"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">ntohl</span><span class="p">(</span><span class="n">netmask</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-23"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-24"></a><span class="w">    </span><span class="cm">/* clz: count leading zeroes. sadly, the behaviour of this builtin</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-25"></a><span class="cm">     * is undefined for a 0 argument, even though most CPUs give 32 */</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__builtin_clz</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-27"></a><span class="w">  </span><span class="k">else</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-28"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-5-29"></a><span class="p">}</span>
</span></code></pre></div>
<p>BIRD 的解决方法：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-1"></a><span class="cm">/**</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-2"></a><span class="cm"> * u32_mkmask - create a bit mask</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-3"></a><span class="cm"> * @n: number of bits</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-4"></a><span class="cm"> *</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-5"></a><span class="cm"> * u32_mkmask() returns an unsigned 32-bit integer which binary</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-6"></a><span class="cm"> * representation consists of @n ones followed by zeroes.</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-7"></a><span class="cm"> */</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-8"></a><span class="n">u32</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-9"></a><span class="nf">u32_mkmask</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-10"></a><span class="p">{</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-11"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-12"></a><span class="p">}</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-14"></a><span class="cm">/**</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-15"></a><span class="cm"> * u32_masklen - calculate length of a bit mask</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-16"></a><span class="cm"> * @x: bit mask</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-17"></a><span class="cm"> *</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-18"></a><span class="cm"> * This function checks whether the given integer @x represents</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-19"></a><span class="cm"> * a valid bit mask (binary representation contains first ones, then</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-20"></a><span class="cm"> * zeroes) and returns the number of ones or 255 if the mask is invalid.</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-21"></a><span class="cm"> */</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-22"></a><span class="n">uint</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-23"></a><span class="nf">u32_masklen</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-24"></a><span class="p">{</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-25"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-26"></a><span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-27"></a>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-28"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-29"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ffff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x0000ffff</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-30"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff00ff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x00ff00ff</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-31"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f0f0f0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x0f0f0f0f</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-32"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x33333333</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x33333333</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-33"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x55555555</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-34"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xaaaaaaaa</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-35"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">l</span><span class="p">;</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/#__codelineno-6-36"></a><span class="p">}</span>
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../programming/2019/06/21/ip-prefix-unexpected-undefined-behavior/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-04-01 00:00:00">2019年4月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="高云-fpga-踩坑"><a class="toclink" href="../../programming/2019/04/01/gowin-fpga/">高云 FPGA 踩坑</a></h2>
<p>最近拿到了高云 FPGA GW2A-18 开发版，想在这上面做一些小工程。不过首先要配置好环境什么的。官方提供了 Linux 和 Windows 的两套工具，自然是拥抱 Linux 咯，但是由于官方适配的是 Redhat 系的操作系统，所以用 Debian 系的时候出现了若干问题，后面会谈到怎么解决的。</p>
<p>首先是官网下载了它的软件，大概有 IDE，综合器，布线器和 Programmer 四个工具，然后开始跑，发现缺少了 libcrypt.so.1.0.0。上网搜了一下解决方案，需要重新编译 openssl-1.0.0，于是下载并且编译了 openssl-1.0.0t 并且把 .so 的路径调好了，这时候就可以打开 IDE 了。然后发现需要 License，这个很简单，去官网申请一下，一天邮件就下来了。</p>
<p>接下来配置 License，IDE 很容易，直接选择邮件里发下来的 node-locked License 即可。不过 Synplify Pro 的 Linux 版本不支持直接单文件 node-locked 的 License，只允许跑 SCL … 不过高云也提供了 SCL 的下载，和 IDE 的 License Server 放在一起，安装完以后，在得到的 License 里加上两行：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-0-1"></a>SERVER<span class="w"> </span><span class="si">${</span><span class="nv">hostname</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">hostid</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">port</span><span class="si">}</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-0-2"></a>VENDER<span class="w"> </span>snpslmd<span class="w"> </span>/path/to/scl/2018.06/linux64/bin/snpslmd
</span></code></pre></div>
<p>然后把 $LM_LICENSE_FILE 指向这个文件路径，就可以了。这一部分感谢 @Jackey-Huo。</p>
<p>随手写了一个简化版的点亮数字人生（没有数码管），得到了 bistream，准备往板子里刷，然后问题出现了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-1-1"></a>ImportError: /path/to/Gowin_YunYuan_V1.9.0Beta_linux/Programmer/bin/librt.so.1: symbol __vdso_clock_gettime version GLIBC_PRIVATE not defined in file libc.so.6 with link time reference
</span></code></pre></div>
<p>目测是 glibc 版本问题 … 这就很难处理了。另外又从官网下载了独立的 Programmer，仍然不行，检测不到设备。</p>
<p>最后想了想，找到了终极办法，在 Docker 里运行 CentOS 的 Privileged Container，再跑 programmer：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-2-1"></a>$<span class="w"> </span>docker<span class="w"> </span>pull<span class="w"> </span>centos
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-2-2"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--privileged<span class="w"> </span>-v<span class="w"> </span>/home:/home<span class="w"> </span>centos<span class="w"> </span>/bin/bash
</span></code></pre></div>
<p>CentOS 镜像出乎意料地小。进去以后，找到 Programmer 路径，然后 scan：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-1"></a><span class="c1">## ./programmer_cli --scan</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-2"></a><span class="w"> </span>Scanning!
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-3"></a>Current<span class="w"> </span>download-cable<span class="w"> </span>channel:0
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-4"></a>Device<span class="w"> </span>Info:
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-5"></a><span class="w">        </span>Family:<span class="w"> </span>GW2A
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-6"></a><span class="w">        </span>Name:<span class="w"> </span>GW2A-18
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-7"></a><span class="w">        </span>ID:<span class="w"> </span>0xREDACTED
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-8"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>device<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>found!
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-3-9"></a><span class="w"> </span>Cost<span class="w"> </span><span class="m">0</span>.54<span class="w"> </span>second<span class="o">(</span>s<span class="o">)</span>
</span></code></pre></div>
<p>接着烧到 SRAM 中：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-4-1"></a><span class="c1">## ./programmer_cli -d GW2A-18 --fsFile /path/to/bitstream.fs --run 2</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-4-2"></a><span class="w"> </span><span class="s2">&quot;SRAM Program&quot;</span><span class="w"> </span>starting<span class="w"> </span>on<span class="w"> </span>device-1...
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-4-3"></a>Programming...:<span class="w"> </span><span class="o">[</span><span class="c1">#########################] 100%</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-4-4"></a><span class="w"> </span>User<span class="w"> </span>Code:<span class="w"> </span>0xREDACTED
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-4-5"></a><span class="w"> </span>Status<span class="w"> </span>Code:<span class="w"> </span>0xREDACTED
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../programming/2019/04/01/gowin-fpga/#__codelineno-4-6"></a><span class="w"> </span>Cost<span class="w"> </span><span class="m">4</span>.54<span class="w"> </span>second<span class="o">(</span>s<span class="o">)</span>
</span></code></pre></div>
<p>烧录成功，功能测试也没有问题。可以继续进行下一步工作了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/04/01/gowin-fpga/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-03-08 00:00:00">2019年3月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-rcore-上运行-nginx"><a class="toclink" href="../../programming/2019/03/08/running-nginx-on-rcore/">在 rCore 上运行 nginx</a></h2>
<p>阿 西 吧 nginx 终于能在 rCore 上跑了 orrrrrrrz</p>
<p>通过这半个多月来的大量开发，我和王润基 @wangrunji0408 学长算是终于完成了第一个 milestone：跑起来一个 nginx。遇到了很多困难，大概有这些：</p>
<ol>
<li>syscall 实现不全。各种方面都缺，然后 nginx 在编译的时候又检测到比较新的 OS 版本，所以很多 syscall 都用了新的来替代老的，例如 readv/writev pread/pwrite accept4 等等，所以这方面做了一些工作。另外，还有很多新的 syscall 进来，太多了我就不细说了，基本上一个 commit 做一点一个 commit 做一点这个样子。</li>
<li>nginx 用到了 SSE 的寄存器 xmm，但是之前是没有开的。所以把 sse 打开，然后切换上下文的时候把 sse 通过 fxsave 保存和 fxrstor 恢复（有意思的是，as 居然不认这俩，只好手动写字节码），然后为了 16bit 的对齐又写了几行汇编代码。这块问题不大，今天一会就搞定了。但是如果要性能更高一些的话，可能需要在第一次使用 xmm 的时候再开始保存，大概就是加一个 bit 的事情。</li>
<li>文件系统有点崩。实现还是有很多 BUG，表现就是需要经常重新 mksfs 一下，再重启加载完好的 fs，有时候强制关机一下就又崩了。</li>
<li>内存管理做了一些改变。为了实现更加完整的 mmap mumap 和 mprotect，又发现了一些新的 BUG 在里面，然后慢慢修复了。就是实现的有点粗暴。</li>
<li>死锁问题。这个其实现在还会出现，只是还没调出来，也不会百分百出现。我们计划在锁上面做一些死锁检测，例如记住是谁上锁的，等等。现在就遇到一个很玄学的死锁问题。</li>
</ol>
<p>然后代码也是一边在写一边在重构吧，很多地方现在都写得很粗暴，FIXME 和 TODO 留了很多，很多地方也写得不够优雅。以后再慢慢重构 + 优化吧。</p>
<p>截图留念：</p>
<p><img alt="" src="/images/nginx.jpg" /></p>
<p>再往前的话，还有很多小的问题，例如网卡的中断启用了但没有改 mask，所以啥也没收到，靠 QEMU Tracing 找到问题。还有一个很有意思的现象，就是如果 elf 的 program header 没有 phdr 这个项的时候，我们发现，可以通过第一个 load（如果加载了完整的 elf 头的话），我们可以从这里推断出 phdr 的地址（load 的虚拟地址加偏移），然后丢到 auxv 里去让 musl 配置 tls。总之这些都解决了。也不用去考虑兼容 litc 了，已经全部向 linux 靠拢了，稳。</p>
<p>注：最简 nginx 编译参数：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-0-1"></a>./configure --with-cc=/usr/bin/musl-gcc --with-cc-opt=-static --with-ld-opt=-satic --without-pcre --without-http_rewrite_module --without-http_gzip_module --with-poll_module
</span></code></pre></div>
<p>这样编译出来是一个静态文件，并且在 strip 之后只有不到 1M 的大小。</p>
<p>最简 nginx 配置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-1"></a>daemon off;
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-2"></a>master_process off;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-4"></a>events {
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-5"></a>    use poll;
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-6"></a>}
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-8"></a>http {
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-9"></a>    server {
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-10"></a>        listen 80;
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-11"></a>        server_name _;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-13"></a>        root /;
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-14"></a>    }
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2019/03/08/running-nginx-on-rcore/#__codelineno-1-15"></a>}
</span></code></pre></div>
<p>这样就免去了一些麻烦（多线程、多进程交互还是有很多问题），但确实可以跑起来了。</p>
<p>另外，还需要写一份 /etc/passwd 和 /etc/group 用于 nobody 和 nogroup。不需要其他额外的东西了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/03/08/running-nginx-on-rcore/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-03-04 00:00:00">2019年3月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="实现网络的-syscall"><a class="toclink" href="../../programming/2019/03/04/implement-network-syscalls/">实现网络的 syscall</a></h2>
<p>有了网卡驱动，接下来要做的就做网络的 syscall 了。为了测试，首先在 busybox 里找可以用来测试的 applet，由于没有实现 poll，所以 nc telnet 啥的都用不了。最后选择到了 ping 和 pscan 上。</p>
<p>ping 大家都很了解，pscan 就是一个扫端口的，对一个 ip 连续的若干个端口发起 tcp 请求。这就要求我提供 raw socket 和 tcp socket 状态的支持。由于网络栈本身是异步的，但 read connect 这些函数在不调 setsockopt 的前提下又是同步的，然而现在又没有 signal 可以用，要是 block 了就再也出不来了。于是就采用了 Condvar 的办法，拿一个全局的条件变量，当 poll 不到内容的时候，先把线程拿掉，等到网络栈更新了，再恢复。这样至少不会把 cpu 也 block 住。</p>
<p>然后就是把 socket 部分改了又改吧，数据结构的设计改了几次，为了解决 ownership 问题上锁啊也有点多，但是也更细了，虽然实际上可能没有必要，因为上面还有大的锁。不过性能还不是现在考虑的重点，关键还要先把 send recv accept bind listen 啥的写得差不多了，然后还有把 poll/select 实现了，这个很关键。</p>
<p>中间遇到的最大的坑就是，接收 pci interrupt 的时候总是啥也没有，然后靠万能的 qemu trace 发现，原来是 mask 掉了，所以啥也收不了，然后最后的解决方案就是用 MSI Interrupt #55 搞定了这个问题。至于为啥是 55 呢，因为 23 + 32 = 55 啊（误</p>
<p>总之是修好了。终于可以继续写其它的 syscall 了。还没想好 poll 要怎么写，orz。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/03/04/implement-network-syscalls/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-02-26 00:00:00">2019年2月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="使用-rust-实现-e1000-驱动"><a class="toclink" href="../../programming/2019/02/26/network-driver-again/">使用 Rust 实现 e1000 驱动</a></h2>
<p>是的。我又来了。上次做了<a href="../../programming/2019/01/29/virtio-drivers-implementation/">使用 Rust 实现 VirtIO 驱动</a>之后，继续往 rCore 加更多的驱动支持。由于现在工作重点是 x86_64 下的 syscall 实现，所以选了一个比较有代表性的驱动 e1000 来实现。其实如果只是为了在 qemu 下运行的话，其实只需要支持 virtio-pci 就可以了，原来的 virtio-net 直接拿来用就可以了。</p>
<p>为什么挑 e1000 呢，一方面是支持的设备多，有真实硬件可以测试，虽然不一定要裸机上跑，但是可以通过 PCI passthrough 来测试驱动的正确性。另一方面是网上的资料比较多，有现成的简单的代码可以借鉴。这次主要借鉴了三个来源：一是 Biscuit OS，二是 Judge Duck OS，三是 Linux。</p>
<p>首先是实现了简单的 PCI 总线的枚举，然后找到对应的设备，激活，并且找到映射的内存地址，然后把原来 C 语言的实现搬运到 Rust 中。这个过程中遇到很多坑，例如一开始我以为内核里 pa 和 va 是一个固定的偏移，不过多次尝试后才发现这个假设只对 riscv 平台里的实现成立。</p>
<p>这个时候就可以收到外面给进来的以太网帧了。接着就是把它接入到 smoltcp 的 API 中。但是发包又不工作了，尝试了很多次，各种方法也不行。其中特别要提到的就是 qemu 的 tracing API，它在帮助我调试之前的 virtio 驱动和这次的 e1000(e) 驱动中起到了很大的帮助。不过，遗憾的是，发包相关的代码里的 trace 不足以让我找到问题的所在，我只好采用了最后一招：</p>
<p>下载 QEMU，自己改，然后自己编译。</p>
<p>这个方法果然很有效啊，经过简单的几个修改，很快就定位到问题所在了，原来就是一个简单的错误，把 4 写成了 8。这个过程中我也发现 QEMU 在 incremental build 的时候似乎会 segfault，我没管这么多，反正编译也不慢，次数也不多，每次 clean 再 build 问题也不大。</p>
<p>接下来要摸索 82559 的网卡适用情况如何，因为有一个真实的 82559 网卡可供测试。另一方面就要开始考虑 socket 那一套 syscall 怎么做了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/02/26/network-driver-again/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-02-12 00:00:00">2019年2月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考9"><a class="toclink" href="../../programming/2019/02/12/thoughts-on-stanford-cs140e-9/">近来做 Stanford CS140e 的一些进展和思考（9）</a></h2>
<p>距离<a href="../../programming/2018/04/10/thoughts-on-stanford-cs140e-8/">上一篇 CS140e 系列文章</a>已经过去了很久，距离第一篇文章过了一年零几天。在后来这一段时间内，CS140e 结束了课程，又开始了新一年的 winter 2019 课程，迎来的却是 C 版本的 CS140e，不禁让人感到失望。还好，Sergio Benitez 放出了原来的 CS140e 的<a href="https://cs140e.sergio.bz">镜像</a>，如果大家仍然想回去查看原版优质的 CS140e，可以点进去参考。</p>
<p>后来因为机缘巧合参与到了清华的 Rust OS 课程，又想到回来把原来的 CS140e 进行更新，于是顺带把跑在 QEMU 下的一些需要的工作给做了，另外把 Rust nightly 版本更新了（一年前的 nightly 还能叫 nightly？），才发现标准库变化还是蛮大的，由于 nightly 版本变了，而且原来是内嵌了一个阉割过的 std，所以主要是从新的 std 里抄代码到内嵌的 std 中。另外，原来的 xargo 也不再维护了，转而使用 rust-xbuild 进行交叉编译。</p>
<p>然后又顺手实现了 backtrace 和从 backtrace 中配合 dward symbols 找函数名的功能，不过实践证明，这些东西还是 addr2line 做得更好，所以也就没有做下去，在 relocation 上也是遇到了各种问题。这个经验也是应用到了 rCore 那边。</p>
<p>再之后也就是寒假写驱动了，见之前的一个博文，我就没有在 CS140e 上去实现它了。有时间有兴趣的时候再考虑做一下 Raspberry Pi 的网卡驱动吧。</p>
<p>写于迪拜雨天。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/02/12/thoughts-on-stanford-cs140e-9/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-01-29 00:00:00">2019年1月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="使用-rust-实现-virtio-驱动"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/">使用 Rust 实现 VirtIO 驱动</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>最近在给 rCore 添加驱动层的支持。一开始是想做网卡驱动，后来发现， <code>qemu-system-riscv32</code> 只支持如下的驱动：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-1"></a><span class="c1">## qemu-system-riscv32 -device help</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-3"></a>Storage<span class="w"> </span>devices:
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-4"></a>name<span class="w"> </span><span class="s2">&quot;scsi-cd&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>SCSI,<span class="w"> </span>desc<span class="w"> </span><span class="s2">&quot;virtual SCSI CD-ROM&quot;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-5"></a>name<span class="w"> </span><span class="s2">&quot;scsi-disk&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>SCSI,<span class="w"> </span>desc<span class="w"> </span><span class="s2">&quot;virtual SCSI disk or CD-ROM (legacy)&quot;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-6"></a>name<span class="w"> </span><span class="s2">&quot;scsi-hd&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>SCSI,<span class="w"> </span>desc<span class="w"> </span><span class="s2">&quot;virtual SCSI disk&quot;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-7"></a>name<span class="w"> </span><span class="s2">&quot;virtio-blk-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-8"></a>name<span class="w"> </span><span class="s2">&quot;virtio-scsi-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-10"></a>Network<span class="w"> </span>devices:
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-11"></a>name<span class="w"> </span><span class="s2">&quot;virtio-net-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-13"></a>Input<span class="w"> </span>devices:
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-14"></a>name<span class="w"> </span><span class="s2">&quot;virtconsole&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-serial-bus
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-15"></a>name<span class="w"> </span><span class="s2">&quot;virtio-keyboard-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-16"></a>name<span class="w"> </span><span class="s2">&quot;virtio-mouse-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-17"></a>name<span class="w"> </span><span class="s2">&quot;virtio-serial-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-18"></a>name<span class="w"> </span><span class="s2">&quot;virtio-tablet-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-19"></a>name<span class="w"> </span><span class="s2">&quot;virtserialport&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-serial-bus
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-21"></a>Display<span class="w"> </span>devices:
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-22"></a>name<span class="w"> </span><span class="s2">&quot;virtio-gpu-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-23"></a>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-24"></a>Misc<span class="w"> </span>devices:
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-25"></a>name<span class="w"> </span><span class="s2">&quot;loader&quot;</span>,<span class="w"> </span>desc<span class="w"> </span><span class="s2">&quot;Generic Loader&quot;</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-26"></a>name<span class="w"> </span><span class="s2">&quot;virtio-balloon-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-27"></a>name<span class="w"> </span><span class="s2">&quot;virtio-crypto-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-0-28"></a>name<span class="w"> </span><span class="s2">&quot;virtio-rng-device&quot;</span>,<span class="w"> </span>bus<span class="w"> </span>virtio-bus
</span></code></pre></div>
<p>所以要实现网卡的话，只能实现这里的 <code>virtio-net-device</code> ，而 VirtIO 驱动之间有很多共通的地方，于是顺带把 <code>gpu</code> <code>mouse</code> 和 <code>blk</code> 实现了。</p>
<h3 id="第一个驱动-virtio-net-的实现"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/#%C3%A7%C2%AC%C2%AC%C3%A4%C2%B8%C2%80%C3%A4%C2%B8%C2%AA%C3%A9%C2%A9%C2%B1%C3%A5%C2%8A%C2%A8-virtio-net-%C3%A7%C2%9A%C2%84%C3%A5%C2%AE%C2%9E%C3%A7%C2%8E%C2%B0">第一个驱动 <code>virtio-net</code> 的实现</a></h3>
<p>首先想到并且实现了的是网卡驱动， <code>virtio-net</code> 。最开始的时候，为了简单，只开了一块缓冲区，每次同时只收/发一个包。首先拿了 <a href="https://github.com/jiegec/device_tree-rs">device_tree-rs</a> 读取 bbl 传过来的 dtb 地址，找到各个 <code>virtio_mmio</code> 总线以后按照设备类型找到对应的设备。然后就是对着 virtio 的标准死磕，同时看 Linux 和 QEMU 的源代码辅助理解，最后终于是成功地把收/发的两个 virtqueue 配置好，并且在中断的时候处理收到的包。这个时候，可以成功地输出收到的包的内容，并且发出指定内容的包了。效果就是看到了这样的图片（图中网站是 <a href="https://hpd.gasmi.net/">Hex Packet Decoder</a>）：</p>
<p><img alt="" src="/images/arp_packet.jpg" /></p>
<p>基于此，写了一个简单的以太网帧的解析，ARP 的回复和 ping 的回复（直接修改 <code>ECHO_REQUEST</code> 为 <code>ECHO_REPLY</code> 然后更新 CHECKSUM），实现了最基本的 ping：</p>
<p><img alt="" src="/images/arping.png" /></p>
<p><img alt="" src="/images/ping.jpg" /></p>
<h3 id="显卡驱动"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/#%C3%A6%C2%98%C2%BE%C3%A5%C2%8D%C2%A1%C3%A9%C2%A9%C2%B1%C3%A5%C2%8A%C2%A8">显卡驱动</a></h3>
<p>网卡可以用了，很自然地会想到做一些其他的 virtio 驱动，第一个下手的是显卡。显卡和网卡的主要区别是，网卡是两个 queue 异步作，而在显卡驱动上则是在一个 queue 上每次放一输入一输出的缓冲区来进行交互，具体步骤在 virtio 标准中也写得很清楚。在这个过程中，QEMU 的 Tracing 功能帮了很大的忙，在调试 desc 的结构上提供了很多帮助。</p>
<p>然后就在 framebuffer 上画了一个 mandelbrot：</p>
<p><img alt="" src="/images/mandelbrot.jpg" /></p>
<p>在 @shankerwangmiao 的建议下，调了一下颜色：</p>
<p><img alt="" src="/images/mandelbrot2.jpg" /></p>
<p>这样就好看多了。</p>
<h3 id="http-服务器"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/#http-%C3%A6%C2%9C%C2%8D%C3%A5%C2%8A%C2%A1%C3%A5%C2%99%C2%A8">HTTP 服务器</a></h3>
<p>在 @wangrunji0408 的提醒和建议下，我开始把一个 Rust 实现的网络栈 <a href="https://github.com/m-labs/smoltcp">smoltcp</a> 集成到代码中来。这个库中，对底层 Interface 的要求如下：</p>
<ol>
<li>当可以发包并且可以收包的时候，返回一收一发两个 Token，并在使用的时候调用指定的函数。</li>
<li>当可以发包的时候，返回一个发的 Token，含义同上。</li>
</ol>
<p>这是我第一次看到这种抽象，而且也没有特别明确的文档表示，这个 Token 代表什么，我应该提供什么。我直接按照一些已有的例子，照着实现了一把。过程中遇到了 ownership 的问题，通过 Arc 和 Mutex 解决了，然后又出现了死锁的问题，调了半天才调出来。</p>
<p>接着按照 somltcp 的样例写一个简单的 udp echo server 和（假的）tcp 服务器：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-1"></a><span class="c1">// simple http server</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-2"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sockets</span><span class="p">.</span><span class="n">get</span>::<span class="o">&lt;</span><span class="n">TcpSocket</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tcp_handle</span><span class="p">);</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-3"></a><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">socket</span><span class="p">.</span><span class="n">is_open</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-4"></a><span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-5"></a><span class="p">}</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-7"></a><span class="k">if</span><span class="w"> </span><span class="n">socket</span><span class="p">.</span><span class="n">can_send</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-8"></a><span class="w">    </span><span class="fm">write!</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Server: rCore</span><span class="se">\r\n</span><span class="s">Content-Length: 13</span><span class="se">\r\n</span><span class="s">Content-Type: text/html</span><span class="se">\r\n</span><span class="s">Connection: Closed</span><span class="se">\r\n\r\n</span><span class="s">Hello, world!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-9"></a><span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2019/01/29/virtio-drivers-implementation/#__codelineno-1-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>虽然很粗暴，但是 work 了：</p>
<p><img alt="" src="/images/http.jpg" /></p>
<h3 id="鼠标驱动和块设备驱动"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/#%C3%A9%C2%BC%C2%A0%C3%A6%C2%A0%C2%87%C3%A9%C2%A9%C2%B1%C3%A5%C2%8A%C2%A8%C3%A5%C2%92%C2%8C%C3%A5%C2%9D%C2%97%C3%A8%C2%AE%C2%BE%C3%A5%C2%A4%C2%87%C3%A9%C2%A9%C2%B1%C3%A5%C2%8A%C2%A8">鼠标驱动和块设备驱动</a></h3>
<p>接着自然是往 QEMU 支持的剩下的 virtio 设备里下手。首先下手的是鼠标驱动。这次遇到了新的问题：</p>
<ol>
<li>由于缓冲的存在，每次只有在 EV_SYN 的时候才会一次性把若干个事件放入队列中。</li>
<li>一个事件就要一个 desc chain，意味着直接串足够大小的 buffer 到同一个 desc chain 中并不能工作。</li>
</ol>
<p>于是只好痛定思痛照着 Linux 内核的实现把完整的 Virtqueue 的操作实现了，并且顺带把前面的网卡和显卡的驱动也更新了。果然，每次都是三个左右的事件（X，Y，SYN）插入，然后根据这些事件就可以计算出当前的鼠标位置了。</p>
<p>至于块设备，遇到的则是别的坑。看标准的时候，本以为就一个结构体 virtio_blk_req 就搞完了，但仔细读了读，标准似乎没讲清楚，读的时候是怎么传，写的时候又是怎么传。于是在这里卡了很久，从 Tracing 信息可以看出，QEMU 一直认为我提供的 buffer 大小不正确，多次实验之后发现，给 device 写入的 buffer 大小为 block size 的整数倍加一，这个一存放的是状态，其他则是数据，真的太坑了。</p>
<p>有了块设备以后，就可以替换掉原来的内嵌 SFS 的方案，转为直接从块设备读 SFS 文件。这里我没想明白 lazy_static 和 ownership 的一些问题，最后也则是@wangrunji0408 的帮助我解决了。</p>
<h3 id="总结"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/#%C3%A6%C2%80%C2%BB%C3%A7%C2%BB%C2%93">总结</a></h3>
<p>用 Rust 写出一个可以工作的驱动并不难，只要知道 unsafe 怎么用，但是一旦需要深入思考这里应该用什么安全的方法封装的时候，才发现是个很困难的事情。现在虽然工作了，但是很多地方线程并不安全，代码也不够简洁高效，以后还有很多需要改进的地方。</p>
<h3 id="see-also"><a class="toclink" href="../../programming/2019/01/29/virtio-drivers-implementation/#see-also">See also</a></h3>
<ol>
<li><a href="https://github.com/oasis-tcs/virtio-spec">Virtio Spec</a></li>
</ol>

    <nav class="md-post__action">
      <a href="../../programming/2019/01/29/virtio-drivers-implementation/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-01-07 00:00:00">2019年1月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rust-获取-linker-script-中的地址"><a class="toclink" href="../../programming/2019/01/07/rust-access-linker-script-address/">Rust 获取 Linker Script 中的地址</a></h2>
<p>在 Linker Script 中可以记录下一个地址到一个变量中，大概这样：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-0-1"></a>.text: {
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-0-2"></a>    PROVIDE(__text_start = .);
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-0-3"></a>    *(.text .text.* .gnu.linkonce.t*)
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-0-4"></a>    PROVIDE(__text_end = .);
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-0-5"></a>}
</span></code></pre></div>
<p>这里的 <code>PROVIDE()</code> 是可选的。这样，代码里就可以获取到 .text 段的地址了。在 C 中，直接 extern 一个同名的变量就可以了，但在 Rust 中，需要这样获取：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-1-1"></a><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-1-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">__text_start</span><span class="p">();</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-1-3"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">__text_end</span><span class="p">();</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-1-4"></a><span class="p">}</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-1-6"></a><span class="c1">// __text_start as usize</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2019/01/07/rust-access-linker-script-address/#__codelineno-1-7"></a><span class="c1">// __text_end as usize</span>
</span></code></pre></div>
<p>这样就可以拿到地址了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/01/07/rust-access-linker-script-address/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-09-13 00:00:00">2018年9月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="通过-ssh-隧道连接-adb-和-android-设备"><a class="toclink" href="../../programming/2018/09/13/adb-over-ssh-tunnel/">通过 SSH 隧道连接 ADB 和 Android 设备</a></h2>
<p>由于本机算力不足，想要在远程<a href="../../programming/2018/06/18/building-lineageos-in-archlinux/">编译 LineageOS</a> ，其中有一步需要连接到已有的设备，于是突发奇想：</p>
<ol>
<li>adb 可以通过 网络连接</li>
<li>ssh 可以进行端口转发，这里是把 remote 的端口转发到 Android 设备上的端口。</li>
</ol>
<p>方法如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/09/13/adb-over-ssh-tunnel/#__codelineno-0-1"></a>$<span class="w"> </span>adb<span class="w"> </span>shell<span class="w"> </span>ip<span class="w"> </span>-f<span class="w"> </span>inet<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>wlan0
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/09/13/adb-over-ssh-tunnel/#__codelineno-0-2"></a>$<span class="w"> </span><span class="c1"># remember the ip address here</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2018/09/13/adb-over-ssh-tunnel/#__codelineno-0-3"></a>$<span class="w"> </span>adb<span class="w"> </span>tcpip<span class="w"> </span>PORT1
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2018/09/13/adb-over-ssh-tunnel/#__codelineno-0-4"></a>$<span class="w"> </span>ssh<span class="w"> </span>-R<span class="w"> </span>PORT2:ANDROID_IP:PORT1<span class="w"> </span>REMOTE
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2018/09/13/adb-over-ssh-tunnel/#__codelineno-0-5"></a><span class="o">(</span>remote<span class="o">)</span>$<span class="w"> </span>adb<span class="w"> </span>connect<span class="w"> </span>localhost:PORT2<span class="w"> </span><span class="c1"># trust this device on Android</span>
</span></code></pre></div>
<p>参考文档：</p>
<ol>
<li><a href="https://stackoverflow.com/a/3623727">How can I connect to Android with ADB over TCP?</a></li>
<li><a href="https://www.ssh.com/ssh/tunneling/example">SSH PORT FORWARDING EXAMPLE</a></li>
</ol>

    <nav class="md-post__action">
      <a href="../../programming/2018/09/13/adb-over-ssh-tunnel/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-07-04 00:00:00">2018年7月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="升级-mongodb-到-40"><a class="toclink" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/">升级 MongoDB 到 4.0</a></h2>
<p>MongoDB 4.0 刚刚发布，加入了我很想要的 Transaction 功能。不过，我一更新就发现 MongoDB 起不来了。研究了一下日志，发现由于我创建数据库时，MongoDB 版本是 3.4，虽然后来升级到了 3.6，但还是用着 3.4 的兼容模式。这个可以这样来检测：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/#__codelineno-0-1"></a>$<span class="w"> </span>mongo
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/#__codelineno-0-2"></a>&gt;<span class="w"> </span>db.adminCommand<span class="o">(</span><span class="w"> </span><span class="o">{</span><span class="w"> </span>getParameter:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>featureCompatibilityVersion:<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">)</span>
</span></code></pre></div>
<p>如果不是 3.6，升级到 4.0 之前，需要先执行如下操作：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/#__codelineno-1-1"></a>$<span class="w"> </span><span class="c1"># MongoDB version 3.6</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/#__codelineno-1-2"></a>$<span class="w"> </span>mongo
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/#__codelineno-1-3"></a>&gt;<span class="w"> </span>db.adminCommand<span class="o">(</span><span class="w"> </span><span class="o">{</span><span class="w"> </span>setFeatureCompatibilityVersion:<span class="w"> </span><span class="s2">&quot;3.6&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">)</span>
</span></code></pre></div>
<p>然后再升级到 MongoDB 4.0，才能正常地启动 MongoDB 4.0。之后可以考虑尝试使用 MongoDB 4.0 的 Transaction 了。不知道什么时候进入 Debian 的 stretch-backports 源中。</p>
<p>为了使用 MongoDB 4.0 的新特性，输入以下命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/#__codelineno-2-1"></a>$<span class="w"> </span>mongo
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/#__codelineno-2-2"></a>&gt;<span class="w"> </span>db.adminCommand<span class="o">(</span><span class="w"> </span><span class="o">{</span><span class="w"> </span>setFeatureCompatibilityVersion:<span class="w"> </span><span class="s2">&quot;4.0&quot;</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">)</span>
</span></code></pre></div>
<p>之后会尝试一下 MongoDB 4.0 的 Transaction 功能。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/07/04/upgrade-mongodb-to-4.0/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-06-21 00:00:00">2018年6月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="verilog-初体验"><a class="toclink" href="../../programming/2018/06/21/verilog-first-try/">Verilog 初体验</a></h2>
<p>自己以前一直对硬件方面没有接触，但是大二大三很快就要接触相关知识，所以自己就先预习一下 Verilog HDL，以便以后造计算机。听学长们推荐了一本书叫《自己动手写 CPU》，由于自己手中只有很老的 Spartan-3 板子，手上没有可以用来试验的 FPGA，所以选择用 Verilog + Verilator 进行模拟。既然是模拟，自然是会有一定的问题，不过这个以后再说。</p>
<p>然后就是模仿着这本书的例子，写了指令的获取和指令的解码两部分很少很少的代码，只能解码 ori (or with immidiate) 这一个指令。然后，通过 verilator 跑模拟，输出 vcd 文件，再用 gtkwave 显示波形，终于能够看到我想要的结果了。能够看到，前一个时钟周期获取指令，下一个时钟周期进行解码，出现了流水线的结果。这让我十分开心。</p>
<p>接下来就是实现一些基本的算术指令，然后讲计算的结果写入到相应的寄存器中。这样做完之后，就可以做一个基于 verilator 的简易 A+B 程序了。</p>
<p>我的代码发布在<a href="https://github.com/jiegec/learn_verilog">jiegec/learn_verilog</a>中。最近马上到考试周，可能到暑假会更频繁地更新吧。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/06/21/verilog-first-try/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-06-18 00:00:00">2018年6月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-archlinux-上编译-lineageos-for-huawei-angler"><a class="toclink" href="../../programming/2018/06/18/building-lineageos-in-archlinux/">在 ArchLinux 上编译 LineageOS for Huawei Angler</a></h2>
<p>实践了一下如何在 ArchLinux 上编译自己的 LineageOS。本文主要根据<a href="https://wiki.lineageos.org/devices/angler/build">官方文档</a> 进行编写。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-1"></a>$<span class="w"> </span><span class="c1"># for py2 virtualenv and running x86 prebuilt binaries(e.g. bison)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>pacman<span class="w"> </span>-Sy<span class="w"> </span>python2-virtualenv<span class="w"> </span>lib32-gcc-libs<span class="w"> </span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-3"></a>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>~/bin
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-4"></a>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>~/virtualenv
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-5"></a>$<span class="w"> </span><span class="c1"># build script is written in python 2</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-6"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/virtualenv
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-7"></a>$<span class="w"> </span>virtualenv2<span class="w"> </span>-p<span class="w"> </span>/usr/bin/python2<span class="w"> </span>py2
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-8"></a>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>~/android/lineage
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-9"></a>$<span class="w"> </span>curl<span class="w"> </span>https://storage.googleapis.com/git-repo-downloads/repo<span class="w"> </span>&gt;<span class="w"> </span>~/bin/repo
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-10"></a>$<span class="w"> </span>chmod<span class="w"> </span>a+x<span class="w"> </span>~/bin/repo
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-11"></a>$<span class="w"> </span>vim<span class="w"> </span>~/.config/fish/config.fish
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-12"></a><span class="nb">set</span><span class="w"> </span>-x<span class="w"> </span>PATH<span class="w"> </span>~/bin<span class="w"> </span><span class="nv">$PATH</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-13"></a><span class="nb">set</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">USE_CCACHE</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-14"></a>$<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>fish<span class="w"> </span>-l
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-15"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/android/lineage
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-16"></a>$<span class="w"> </span>repo<span class="w"> </span>init<span class="w"> </span>-u<span class="w"> </span>https://github.com/LineageOS/android.git<span class="w"> </span>-b<span class="w"> </span>lineage-15.1
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-17"></a>$<span class="w"> </span><span class="c1"># alternatively, follow https://mirrors.tuna.tsinghua.edu.cn/help/lineageOS/</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-18"></a>$<span class="w"> </span>repo<span class="w"> </span>sync
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-19"></a>$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>~/virtualenv/py2/bin/activate
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-20"></a>$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>build/envsetup.sh
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-21"></a>$<span class="w"> </span>breakfast<span class="w"> </span>angler
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-22"></a>$<span class="w"> </span>vim<span class="w"> </span>~/.config/fish/config.fish
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-23"></a>$<span class="w"> </span>ccache<span class="w"> </span>-M<span class="w"> </span>50G
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-24"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/android/lineage/device/huawei/angler
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-25"></a>$<span class="w"> </span>./extract-files.sh
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-26"></a><span class="c1">## Plug in Nexus 6P, maybe over ssh, see my another post</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-27"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/android/lineage
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-28"></a>$<span class="w"> </span>croot
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-29"></a>$<span class="w"> </span>brunch<span class="w"> </span>angler
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="../../programming/2018/06/18/building-lineageos-in-archlinux/#__codelineno-0-30"></a>$<span class="w"> </span><span class="c1"># Endless waiting... (for me, more than 2 hrs)</span>
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../programming/2018/06/18/building-lineageos-in-archlinux/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-06-15 00:00:00">2018年6月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="编写-ebpf-程序和利用-hyperloglog-统计包的信息"><a class="toclink" href="../../programming/2018/06/15/ebpf-with-hyperloglog/">编写 eBPF 程序和利用 HyperLogLog 统计包的信息</a></h2>
<p>前段时间在写概率论与数理统计的期末论文，讨论的主题是如何对一个十分巨大的多重集合（或者是流）中相异元素个数进行估计，写的是 HyperLogLog 等算法。联想到前段时间 LWN 上多次提到的 eBPF 和 BCC 的文章，我准备自己用 eBPF 实现一个高效的估计 inbound packet 中来相异源地址的个数和 outbound packet 中相异目的地址的个数。经过了许多的尝试和努力，最终是写成了 <a href="https://github.com/jiegec/hll_ebpf">jiegec/hll_ebpf</a> ，大致原理如下：</p>
<p>由于 eBPF 是一个采用专用的 bytecode 并且跑在内核中的语言，虽然我们可以用 clang 写 C 语言然后交给 LLVM 生成相应地 eBPF bytecode，但仍然收到许多的限制。而且，我很少接触 Linux 内核开发，于是在找内核头文件时费了一番功夫。首先是核心代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_def</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;maps&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">hll_ebpf_out_daddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-2"></a><span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_PERCPU_ARRAY</span><span class="p">,</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-3"></a><span class="w">    </span><span class="p">.</span><span class="n">key_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-4"></a><span class="w">    </span><span class="p">.</span><span class="n">value_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-5"></a><span class="w">    </span><span class="p">.</span><span class="n">max_entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-6"></a><span class="w">    </span><span class="p">.</span><span class="n">pinning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">// PIN_GLOBAL_NS</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-7"></a><span class="p">};</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-9"></a><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;out_daddr&quot;</span><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-10"></a><span class="kt">int</span><span class="w"> </span><span class="n">bpf_out_daddr</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">__sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-11"></a><span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="n">daddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_daddr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-12"></a><span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Murmur3</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-13"></a><span class="w">  </span><span class="n">update_hll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hll_ebpf_out_daddr</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">);</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-14"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-0-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>首先是声名一个类型为 PERCPU_ARRAY 的 eBPF MAP 类型。这里的 MAP 不是字典，Array 才是真是的数据结构，只不过提供的 API 是类似于字典的。SEC 宏则是指定这个东西要放在哪一个段，这个在后面会提到。这个函数的作用就是，获取 IP 包的目的地址（其实应该判断一下是否是 IPv4 的），然后根据 HyperLogLog 的要求，进行哈希（这里采用的是 Murmur3），然后对得到的哈希值分段，前一部分用于索引，后一部分的 nlz（clz, whatever）用于估计。具体算法详情可以参考 HyperLogLog 的论文。</p>
<p>接着，我们可以把这个 eBPF 函数进行编译，并且应用起来：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-1"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">KERN</span><span class="o">=</span><span class="m">4</span>.16.0-2<span class="w"> </span><span class="c1"># or use uname -r with awk, see Makefile</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-2"></a>$<span class="w"> </span>clang<span class="w"> </span>-O2<span class="w"> </span>-I<span class="w"> </span>/usr/src/linux-headers-<span class="si">${</span><span class="nv">KERN</span><span class="si">}</span>-common/include<span class="w"> </span>-I<span class="w"> </span>/usr/src/linux-headers-<span class="si">${</span><span class="nv">KERN</span><span class="si">}</span>-common/arch/x86/include<span class="w"> </span>-emit-llvm<span class="w"> </span>-c<span class="w"> </span>bpf.c<span class="w"> </span>-o<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>llc<span class="w"> </span>-march<span class="o">=</span>bpf<span class="w"> </span>-filetype<span class="o">=</span>obj<span class="w"> </span>-o<span class="w"> </span>bpf.o
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-3"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">IFACE</span><span class="o">=</span>en0<span class="w"> </span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-4"></a>$<span class="w"> </span>sudo<span class="w"> </span>tc<span class="w"> </span>qdisc<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span><span class="si">${</span><span class="nv">IFACE</span><span class="si">}</span><span class="w"> </span>clsact<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-5"></a>$<span class="w"> </span>sudo<span class="w"> </span>tc<span class="w"> </span>filter<span class="w"> </span>del<span class="w"> </span>dev<span class="w"> </span><span class="si">${</span><span class="nv">IFACE</span><span class="si">}</span><span class="w"> </span>egress
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-6"></a>$<span class="w"> </span>sudo<span class="w"> </span>tc<span class="w"> </span>filter<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span><span class="si">${</span><span class="nv">IFACE</span><span class="si">}</span><span class="w"> </span>egress<span class="w"> </span>bpf<span class="w"> </span>obj<span class="w"> </span>bpf.o<span class="w"> </span>sec<span class="w"> </span>out_daddr
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-7"></a>$<span class="w"> </span>sudo<span class="w"> </span>tc<span class="w"> </span>filter<span class="w"> </span>del<span class="w"> </span>dev<span class="w"> </span><span class="si">${</span><span class="nv">IFACE</span><span class="si">}</span><span class="w"> </span>ingress
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-1-8"></a>$<span class="w"> </span>sudo<span class="w"> </span>tc<span class="w"> </span>filter<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span><span class="si">${</span><span class="nv">IFACE</span><span class="si">}</span><span class="w"> </span>ingress<span class="w"> </span>bpf<span class="w"> </span>obj<span class="w"> </span>bpf.o<span class="w"> </span>sec<span class="w"> </span>in_saddr
</span></code></pre></div>
<p>我们需要在用户态读出上面这个 MAP 中的内容。由于它是全局的，我们可以在 <code>/sys/fs/bpf/tc/globals</code> 中找到他们。然后，把统计得到的数据进行综合，得到结果：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">read_file</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-2"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_obj_get</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-3"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-4"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-5"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-7"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-8"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-9"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-10"></a><span class="w">    </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-11"></a><span class="w">    </span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="c1">// assuming 2 CPUs, will change later</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-13"></a><span class="w">      </span><span class="n">V</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-14"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-15"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-16"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.709</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-17"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-19"></a><span class="w">      </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">V</span><span class="p">);</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-21"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-22"></a><span class="w">    </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">));</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-23"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-24"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lround</span><span class="p">(</span><span class="n">E</span><span class="p">));</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../programming/2018/06/15/ebpf-with-hyperloglog/#__codelineno-2-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以手动通过 <code>nmap</code> 测试，例如扫描一个段，可以看到数据会增长许多。如果扫描相同的段，则数字不会变化，但如果扫描新的段，数字会有变化。这是一个 利用了 eBPF 的 HyperLogLog 的实现。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/06/15/ebpf-with-hyperloglog/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-06-10 00:00:00">2018年6月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="调整-nginx-和-php-的上传文件大小限制"><a class="toclink" href="../../programming/2018/06/10/nginx-php-upload-size-limit/">调整 Nginx 和 PHP 的上传文件大小限制</a></h2>
<p>之前迁移的 MediaWiki，有人提出说无法上传一个 1.4M 的文件。我去看了一下网站，上面写的是限制在 2M，但是一上传就说 Entity Too Large，无法上传。后来经过研究，是 Nginx 对 POST 的大小进行了限制，同时 PHP 也有限制。</p>
<p>Nginx 的话，可以在 nginx.conf 的 http 中添加，也可以在 server 或者 location 中加入这么一行：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/06/10/nginx-php-upload-size-limit/#__codelineno-0-1"></a>client_max_body_size 100m;
</span></code></pre></div>
<p>我的建议是，尽量缩小范围到需要的地方，即 location &gt; server &gt; http。</p>
<p>在 PHP 中，则修改 /etc/php/7.0/fpm/php.ini：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2018/06/10/nginx-php-upload-size-limit/#__codelineno-1-1"></a>post_max_size = 100M
</span></code></pre></div>
<p>回到 MediaWiki 的上传页面，可以看到显示的大小限制自动变成了 100M，这个是从 PHP 的配置中直接获得的。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/06/10/nginx-php-upload-size-limit/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-06-08 00:00:00">2018年6月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="最近写-nodejs-遇到的若干坑"><a class="toclink" href="../../programming/2018/06/08/nodejs-experiences/">最近写 Node.js 遇到的若干坑</a></h2>
<p>最近在做前后端分离，前端在用 Vue.js 逐步重写，后端则变为 api 的形式。同时，我尝试了用 autocannon 和 clinic 工具测试自己的 api endpoint 的性能，一开始发现有几个延迟会特别高，即使是一个很简单的 api 也有不正常的高延迟。</p>
<p>于是，我用 clinic 生成了 flamegraph，发现了一些问题：</p>
<ol>
<li>我在 session 里保存了一些缓存的信息，这部分内容比较大，express-session 在保存到数据库前会先 JSON.stringify 再 crc 判断是否有改变，如果有改变则保存下来。但是由于我的这个对象嵌套层数多，所以时间花得很多。我调整了这个对象的结构，缩小了很多以后，果然这部分快了很多</li>
<li>有一个 API 需要大量的数据库查询，原本是 O（结点总数）次查询，我考虑到我们数据的结构，改成了 O（深度），果然快了许多</li>
<li>之前遇到一个小问题，就是即使我没有登录，服务器也会记录 session 并且返回一个 cookie。检查以后发现，是 connect-flash 即使在没有使用的时候，也会往 cookie 中写入一个空的对象，这就导致 express-session 认为需要保存，所以出现了问题。解决方案就是，换成了它的一个 fork：connect-flash-plus，它解决了这个问题</li>
</ol>

    <nav class="md-post__action">
      <a href="../../programming/2018/06/08/nodejs-experiences/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-11 00:00:00">2018年5月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在脚本中寻找-x11-的-display-和-xauthority"><a class="toclink" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/">在脚本中寻找 X11 的 DISPLAY 和 XAUTHORITY</a></h2>
<p>之前在搞一个小工具，在里面需要访问 X11 server，但是访问 X11 server 我们需要两个东西：DISPLAY 和 XAUTHORITY 两个环境变量。但是，由于它们在不同的发型版和 Display Manager 下都有些不同，所以花了不少功夫才写了一些。</p>
<p>为了验证我们是否可以连上 X11 server，我们使用这一句：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-0-1"></a><span class="nv">DIMENSIONS</span><span class="o">=</span><span class="k">$(</span>xdpyinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;dimensions:&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2;exit}&#39;</span><span class="k">)</span>
</span></code></pre></div></p>
<p>它尝试打开当前的 DISPLAY，并且输出它的分辨率。接下来，我对不同的一些发型版，综合网上的方法，尝试去找到正确的环境变量。</p>
<p>对于 Debian:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-1-1"></a><span class="nv">DISPLAY</span><span class="o">=</span><span class="k">$(</span>w<span class="w"> </span>-hs<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">tty</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span>/sys/class/tty/tty0/active<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="s1">&#39;$2 == tty &amp;&amp; $3 != &quot;-&quot; {print $3; exit}&#39;</span><span class="k">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-1-2"></a><span class="nv">USER</span><span class="o">=</span><span class="k">$(</span>w<span class="w"> </span>-hs<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">tty</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span>/sys/class/tty/tty0/active<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="s1">&#39;$2 == tty &amp;&amp; $3 != &quot;-&quot; {print $1; exit}&#39;</span><span class="k">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-1-3"></a><span class="nb">eval</span><span class="w"> </span><span class="nv">XAUTHORITY</span><span class="o">=</span>~<span class="nv">$USER</span>/.Xauthority
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-1-4"></a><span class="nb">export</span><span class="w"> </span>DISPLAY
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-1-5"></a><span class="nb">export</span><span class="w"> </span>XAUTHORITY
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-1-6"></a><span class="nv">DIMENSIONS</span><span class="o">=</span><span class="k">$(</span>xdpyinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;dimensions:&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2;exit}&#39;</span><span class="k">)</span>
</span></code></pre></div></p>
<p>对于 Archlinux：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-2-1"></a><span class="nv">DISPLAY</span><span class="o">=</span><span class="k">$(</span>w<span class="w"> </span>-hs<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;match($2, /:[0-9]+/) {print $2; exit}&#39;</span><span class="k">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-2-2"></a><span class="nv">USER</span><span class="o">=</span><span class="k">$(</span>w<span class="w"> </span>-hs<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;match($2, /:[0-9]+/) {print $1; exit}&#39;</span><span class="k">)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-2-3"></a><span class="nb">eval</span><span class="w"> </span><span class="nv">XAUTHORITY</span><span class="o">=</span>/run/user/<span class="k">$(</span>id<span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span><span class="k">)</span>/gdm/Xauthority
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-2-4"></a><span class="nb">export</span><span class="w"> </span>DISPLAY
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-2-5"></a><span class="nb">export</span><span class="w"> </span>XAUTHORITY
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-2-6"></a><span class="nv">DIMENSIONS</span><span class="o">=</span><span class="k">$(</span>xdpyinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;dimensions:&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2;exit}&#39;</span><span class="k">)</span>
</span></code></pre></div></p>
<p>最后一种情况很粗暴的，直接找进程拿：
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-3-1"></a><span class="nv">XAUTHORITY</span><span class="o">=</span><span class="k">$(</span>ps<span class="w"> </span>a<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;match($0, /Xorg/) {print $0; exit}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>perl<span class="w"> </span>-n<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;/Xorg.*\s-auth\s([^\s]+)\s/ &amp;&amp; print $1&#39;</span><span class="k">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-3-2"></a><span class="nv">PID</span><span class="o">=</span><span class="k">$(</span>ps<span class="w"> </span>a<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;match($0, /Xorg/) {print $1; exit}&#39;</span><span class="k">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-3-3"></a><span class="nv">DISPLAY</span><span class="o">=</span><span class="k">$(</span>lsof<span class="w"> </span>-p<span class="w"> </span><span class="nv">$PID</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;match($9, /^\/tmp\/\.X11-unix\/X[0-9]+$/) {sub(&quot;/tmp/.X11-unix/X&quot;,&quot;:&quot;,$9); print $9; exit}&#39;</span><span class="k">)</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-3-4"></a><span class="nb">export</span><span class="w"> </span>DISPLAY
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-3-5"></a><span class="nb">export</span><span class="w"> </span>XAUTHORITY
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2018/05/11/finding-x11-display-and-xauthority/#__codelineno-3-6"></a><span class="nv">DIMENSIONS</span><span class="o">=</span><span class="k">$(</span>xdpyinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;dimensions:&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2;exit}&#39;</span><span class="k">)</span>
</span></code></pre></div></p>
<p>中间混用了大量的 awk perl 代码，就差 sed 了。牺牲了一点可读性，但是开发起来比较轻松。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/05/11/finding-x11-display-and-xauthority/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-04-17 00:00:00">2018年4月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="把-gdb-降级到-801"><a class="toclink" href="../../programming/2018/04/17/downgrade-gdb/">把 GDB 降级到 8.0.1</a></h2>
<p>在 macOS 上使用 GDB 需要 codesigning。但是在 GDB 升级到 8.1 后这种方法不知道为何失效了。所以我安装回了 GDB 8.0.1 并且重新 codesigning，现在又可以正常升级了。</p>
<p>对 Formula 进行 patch：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-1"></a>diff --git a/Formula/gdb.rb b/Formula/gdb.rb
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-2"></a>index 29a1c590..25360893 100644
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-3"></a>--- a/Formula/gdb.rb
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-4"></a>+++ b/Formula/gdb.rb
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-5"></a>@@ -1,14 +1,15 @@
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-6"></a> class Gdb &lt; Formula
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-7"></a>   desc &quot;GNU debugger&quot;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-8"></a>   homepage &quot;https://www.gnu.org/software/gdb/&quot;
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-9"></a>-  url &quot;https://ftp.gnu.org/gnu/gdb/gdb-8.1.tar.xz&quot;
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-10"></a>-  mirror &quot;https://ftpmirror.gnu.org/gdb/gdb-8.1.tar.xz&quot;
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-11"></a>-  sha256 &quot;af61a0263858e69c5dce51eab26662ff3d2ad9aa68da9583e8143b5426be4b34&quot;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-12"></a>+  url &quot;https://ftp.gnu.org/gnu/gdb/gdb-8.0.1.tar.xz&quot;
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-13"></a>+  mirror &quot;https://ftpmirror.gnu.org/gdb/gdb-8.0.1.tar.xz&quot;
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-14"></a>+  sha256 &quot;3dbd5f93e36ba2815ad0efab030dcd0c7b211d7b353a40a53f4c02d7d56295e3&quot;
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-16"></a>   bottle do
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-17"></a>-    sha256 &quot;43a6d6cca157ef70d13848f35c04e11d832dc0c96f5bcf53a43330f524b3ac40&quot; =&gt; :high_sierra
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-18"></a>-    sha256 &quot;fe7c6261f9164e7a744c9c512ba7e5afff0e74e373ece9b5aa19d5da6443bfc2&quot; =&gt; :sierra
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-19"></a>-    sha256 &quot;cd89001bcf8c93b5d6425ab91a400aeffe0cd5bbb0eccd8ab38c719ab5ca34ba&quot; =&gt; :el_capitan
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-20"></a>+    sha256 &quot;e98ad847402592bd48a9b1468fefb2fac32aff1fa19c2681c3cea7fb457baaa0&quot; =&gt; :high_sierra
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-21"></a>+    sha256 &quot;0fdd20562170c520cfb16e63d902c13a01ec468cb39a85851412e7515b6241e9&quot; =&gt; :sierra
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-22"></a>+    sha256 &quot;f51136c70cff44167dfb8c76b679292d911bd134c2de3fef40777da5f1f308a0&quot; =&gt; :el_capitan
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-23"></a>+    sha256 &quot;2b32a51703f6e254572c55575f08f1e0c7bc2f4e96778cb1fa6582eddfb1d113&quot; =&gt; :yosemite
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-24"></a>   end
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-25"></a>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2018/04/17/downgrade-gdb/#__codelineno-0-26"></a>   deprecated_option &quot;with-brewed-python&quot; =&gt; &quot;with-python@2&quot;
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../programming/2018/04/17/downgrade-gdb/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-04-10 00:00:00">2018年4月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考8"><a class="toclink" href="../../programming/2018/04/10/thoughts-on-stanford-cs140e-8/">近来做 Stanford CS140e 的一些进展和思考（8）</a></h2>
<p>在<a href="../../programming/2018/04/07/thoughts-on-stanford-cs140e-7/">上一篇文章</a>之后，我其实还是很忙，但是一直心理惦记着这件事，毕竟只剩最后的一点点就可以做完了，不做完总是觉得心痒。</p>
<p>今天做的部分是调度。我们目前只在 EL0 运行了一个 shell，每当触发 exception 时回到 kernel 进行处理，再回到原来的地方。但现在，我要实现一个 preemtive round-robin scheduler，就需要管理当前的所有进程，并且维护当前的进程状态，当时钟中断到来的时候，决定下一个 time slice 要执行的进程，再切换过去。这个过程当然会遇到不少的坑。</p>
<p>首先，我们需要判断一个进程是否可以执行了。考虑到阻塞的 IO，作者提供了一个优雅的方法：如果这个进程阻塞在 IO 上，那么，提供一个函数，在 scheduler 中调用，判断所需要的数据是否到达。这样，我们就可以一个循环把下一个 time slice 要执行的线程找到。如果找不到，就等待 interrupt 再尝试。</p>
<p>困难的地方在于，在启动的时候，切换到一个起始线程。并且在上下文切换的时候，在 process 1 -&gt; kernel -&gt; process 2 这两步过程中，有许多寄存器都需要仔细考虑如何实现。并且在这个过程中，我也发现了之前写的代码中的问题，最终修复了（目前来看是 working 了）。</p>
<p>我的代码实现在 <a href="https://github.com/jiegec/cs140e/commit/977f179a9b28e88e85f4ba9577a0682bf2b6c57b">这里</a> 。下一步就要写 syscall 了。希望能在期中前抽时间赶紧把这个做完。</p>
<p>18:54 PM Update: 刚实现完了 sleep 的 syscall。比预想中要简单。果然找到了自己实现的调度器的 BUG。此系列大概是完结了。</p>
<p>2019-02-12 Update: <a href="../../programming/2019/02/12/thoughts-on-stanford-cs140e-9/">下一篇文章</a>。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/04/10/thoughts-on-stanford-cs140e-8/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-04-07 00:00:00">2018年4月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考7"><a class="toclink" href="../../programming/2018/04/07/thoughts-on-stanford-cs140e-7/">近来做 Stanford CS140e 的一些进展和思考（7）</a></h2>
<p>在<a href="../../programming/2018/03/05/thoughts-on-stanford-cs140e-6/">上一篇文章</a>之后，我很长时间都没有在继续我这个项目，清明节刚好闲下来了我就回来继续啃它。Stanford 那边已经结课，最后的 <code>3-spawn</code> 也只有一部分，剩下的部分不知道什么时候作者才会填上去了。</p>
<p>这次主要要写的代码就是，对异常的处理。这里的异常并不是我们编程语言中的 catch/throw，而是硬件的异常。AArch64 和 x86 一样，也有不同的特权级别的区分，前者是 EL0~EL3，后者则是 RING0 和 RING3。特权级别高可以往特权级别低转换，但是反过来，只能通过异常的方式提高特权等级，并且切换特权等级后只有固定的一些代码可能会跳转，这就是 <code>exception handler/vectors</code> 。这些函数可以知道是什么原因调用了他们，根据硬件规定好的文档，我们可以知道发生了什么事情，是对齐出错了呢，还是用户调用了 syscall 呢，等等。根据不同的情况，我们需要进行不同的处理。当处理完之后，我们需要考虑，跳转回用户代码的时候，回到哪里，提供什么值，不提供什么。</p>
<p>实现的话，需要很多步骤。首先是构造好 <code>exception vector</code> ，这里作者已经写好了一个宏（这里 @BenYip 遇到了一个 assembler 的 BUG），直接用宏就可以把它写出来。然后，我们需要把它加载到当前 EL 的 <code>VBAR_ELx</code> 寄存器中，当 CPU 抛出异常的时候，就会找到这里相应的处理器进行处理。进到这里以后，我们首先先不考虑太多上下文保存的事情--我们先保证能处理异常，恢复也是个有很多坑的步骤，作者也是在这里分成了两个 Subphase。首先还是从 <code>ESR_ELx</code> 中解析到错误的来源的具体内容，如果是我们在 <code>shell</code> 中自己调用的 <code>brk 2</code> 指令，我们就自己新开一个 <code>shell</code> ，修改了提示符以示区别。这样，我们就成功地捕捉到了这个异常。由于我们还无法恢复回去，所以我们直接死循环。</p>
<p>接下来我们要做的是，从异常中恢复出来。由于用户代码可能在各种地方抛出异常，异常也分同步和异步两种情况，这里有许多需要考虑的问题。为了简化，我们目前只考虑同步的 <code>brk 2</code> 导致的 Brk 异常。为了能恢复之后能够正常运行，我们需要把所有的寄存器都保存下来，即 <code>TrapFrame</code> 。保存的时候需要讲究 AArch64 平台下 SP 寄存器的对齐问题。我们也要把一些特殊的寄存器保存下来。还有一点，就是，因为 <code>exception handler</code> 中调用了 <code>context_save</code> 函数，所以此时的 lr 本身也需要进行保存，这个地方也卡了我很久。最后，再把这些一个一个地恢复到原来的样子，调整 <code>ELR_EL1</code> 使得退回到原来的状态时，会跳过当前的 <code>brk 2</code> 指令，调用它的下一调指令。这样，我们就成功地在遇到异常时，弹出一个 <code>shell</code> ，而且还可以回退回来。</p>
<p>学到了很多很多。之后大三，我们可能需要做自己的 CPU，在自己的 CPU 上跑自己的操作系统，在自己的操作系统中跑自己的编译器，在自己的编译器中编译一个数据库。希望到时我还活着吧。#flag</p>
<p>更新：<a href="../../programming/2018/04/10/thoughts-on-stanford-cs140e-8/">下一篇在这里</a>。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/04/07/thoughts-on-stanford-cs140e-7/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-03-07 00:00:00">2018年3月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="新手向绕过-c-类的访问限制"><a class="toclink" href="../../programming/2018/03/07/breaking-c-weak-access-control/">〖新手向〗绕过 C++ 类的访问限制</a></h2>
<p>这是一篇很水的文章，面向萌新，已经知道了的可以自觉绕道。</p>
<p>昨天上课，有同学问，如果用户偷偷把 <code>private</code> 改成 <code>public</code> 再和原有的库链接，是不是就可以在用户代码里更改了。这个答案是肯定的。下面我们就做个实验：</p>
<p>首先，创建 good_class.h 和 good_class.cpp:</p>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-0-2"></a><span class="k">private</span><span class="o">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-0-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-0-4"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-0-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">getData</span><span class="p">();</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-0-6"></a><span class="p">};</span>
</span></code></pre></div>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-1-1"></a><span class="cp">##include &quot;good_class.h&quot;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-1-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">SomeClass::getData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-1-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-1-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后，首先编译，</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-2-1"></a>clang++<span class="w"> </span>-c<span class="w"> </span>good_class.cpp<span class="w"> </span>-o<span class="w"> </span>good_class.o
</span></code></pre></div>
<p>然后，修改 good_class.cpp 并写一个 evil_user.cpp</p>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-3-2"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-3-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-3-4"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-3-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">getData</span><span class="p">();</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-3-6"></a><span class="p">};</span>
</span></code></pre></div>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-2"></a><span class="cp">##include &quot;good_class.h&quot;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-5"></a><span class="w">    </span><span class="n">SomeClass</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-6"></a><span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">37</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-7"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">getData</span><span class="p">());</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-4-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>编译：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../programming/2018/03/07/breaking-c-weak-access-control/#__codelineno-5-1"></a>clang++<span class="w"> </span>good_class.o<span class="w"> </span>evil_user.cpp<span class="w"> </span>-o<span class="w"> </span>evil
</span></code></pre></div>
<p>然后 <code>evil</code> 如愿地输出了 <code>37</code> 。</p>
<p>一些提醒：</p>
<ol>
<li><code>C++</code> 的访问控制十分的弱，仅仅是编译期。所以是很容易绕过的。</li>
<li>对于不想泄露源代码的库，不要导出 <code>C++</code> 的类和函数。选择导出 <code>C</code> 函数，结构体用 incomplete type 或者干脆 <code>void *</code> 。</li>
</ol>
<p>扩展阅读： <a href="https://liam0205.me/2018/01/23/crack-private-member-function-by-vtable/">L 叔的通过虚函数表访问私有函数</a> 。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/03/07/breaking-c-weak-access-control/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-03-05 00:00:00">2018年3月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考6"><a class="toclink" href="../../programming/2018/03/05/thoughts-on-stanford-cs140e-6/">近来做 Stanford CS140e 的一些进展和思考（6）</a></h2>
<p>在<a href="../../programming/2018/03/03/thoughts-on-stanford-cs140e-5/">上一篇文章</a>之后，作者终于更新了测试的用例，我的程序终于可以成功跑过所有测试，也成功在树莓派跑起来。不过，我的代码中很多地方的错误处理比较偷懒，往往直接 <code>panic</code> ，显然并不友好。同时，我想到了使用 <a href="https://github.com/rust-fuzz/cargo-fuzz">cargo-fuzz</a> 来进行自动化测试，果然，使用这个很快就修复了不少我没想到的会出错的地方，比如乘法溢出，目录项没有正确结束等等。目前还发现一个 <code>timeout</code> 的问题，研究发现大概是文件的 <code>cluster chain</code> 中出现了环，导致一直读取文件而没有停止。要解决这个问题，我目前想到的是 <code>Floyd</code> 的判圈算法，但还没上实现。等过几天，新的 <code>Assignment 3</code> 出了以后，再继续更新。希望作者少点跳票，多点勤奋，哈哈哈哈哈</p>
<p>更新：<a href="../../programming/2018/04/07/thoughts-on-stanford-cs140e-7/">下一篇在这里</a>。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/03/05/thoughts-on-stanford-cs140e-6/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-03-03 00:00:00">2018年3月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考5"><a class="toclink" href="../../programming/2018/03/03/thoughts-on-stanford-cs140e-5/">近来做 Stanford CS140e 的一些进展和思考（5）</a></h2>
<p>在<a href="../../programming/2018/02/27/thoughts-on-stanford-cs140e-4/">上一篇文章</a>之后，作者多次延期跳票之后（again），终于放出了 <code>Assignment 2 Phase 3: Saddle Up</code> 。这次，我们要做的变成了把已经写好的（错漏百出）的 <code>fat32</code> 的驱动搬到树莓派里面去，然后实现一些基本的 <code>shell</code> 命令： <code>ls</code> <code>cat</code> <code>cd</code> 等等。作者首先更新了老版本的新的测试样例，放了一些映像然后提供了预期的结果，结果发现，这里的 <code>fat32</code> 有一些不同，主要的就是 <code>bytes_per_sector</code> 不是 <code>512</code> 了，意味着物理的扇区和逻辑扇区并不一致。同时， <code>sectors_per_cluster</code> 也不是 <code>1</code> 了，需要考虑多个扇区的情况。同时， <code>read_cluster</code> 传入的 <code>offset</code> 也可能不再是第一个 <code>sector</code> 中的，所以需要做一个处理。对于物理和逻辑扇区的问题，作者推荐的方案是，把 <code>fat32</code> 之外的扇区保持不变，把其内的扇区视为逻辑扇区。这样，其它代码都可以透明地工作，而不用到处更改，这就体现了封装的威力。接着，作者提供了一个写好了的 <code>libsd</code> 和一些导出的函数，使用这些函数即可。不过，在错误处理和 <code>timeout</code> 上也遇到了一些坑。后面，把东西搬到树莓派上运行，问题就出现了：读取了第一个扇区（即 <code>MBR</code> 所在的扇区）之后，直接就死掉了。想了半天都没找到方案，突然想起可以利用 <code>panic!</code> 对错误语句进行二分查找。查找了大概有七八个小时之后，终于发现，问题出现在读取一个 <code>u32</code> 类型的变量上。我起初怀疑是栈出了问题，所以放到堆上分配，然而还是不行。忽然想起以前遇到的对齐问题，在 <code>AArch64</code> 架构上，可能为了简化，读取的 <code>u32</code> 必须对齐到四个字节上。于是找了找 <code>Rust</code> 中的对齐方面的文档，找到了 <code>#[repr(align=4)]</code> 这种表示方法，代替了原来的 <code>#[repr(packed)]</code> ，并且把数据先拷贝到对齐后的栈上的对应数据结构，然后再读取对应的项。果然，这个问题就解决了。然后又发现我的盘中会出现 <code>lfn</code> 项并不是从后往前的情况，于是我又修改了一下相关的代码。现在，终于可以成功地 <code>ls</code> <code>cat</code> <code>cd</code> 。</p>
<p>不过还是要吐槽一下，作者的测试用的映像文件中，会出现 <code>0xE5</code> 表示这个项已经被删除的情况，但是似乎作者的代码并没有处理这个，所以在预期的输出中出现了一些明显不正确的结果，导致我的代码跑测试并不能通过。而且，作者的代码在一些情况下会把文件的后缀漏掉。作者后来更新了几次测试的文件，不过这个问题只解决了一部分，并没有完全解决。坐等作者继续放出新的测试文件吧。</p>
<p>更新：<a href="../../programming/2018/03/05/thoughts-on-stanford-cs140e-6/">下一篇在这里</a>。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/03/03/thoughts-on-stanford-cs140e-5/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-02-27 00:00:00">2018年2月27日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考4"><a class="toclink" href="../../programming/2018/02/27/thoughts-on-stanford-cs140e-4/">近来做 Stanford CS140e 的一些进展和思考（4）</a></h2>
<p>在<a href="../../programming/2018/02/16/thoughts-on-stanford-cs140e-3/">上一篇文章</a>之后，作者多次延期跳票之后，终于放出了 <code>Assignment 2 Phase 2:32-bit Lipids</code> ，这两天就把只读 <code>FAT32</code> 写完了（不过封装得并不好，许多地方利用了 <code>pub(super)</code> 把变量可以访问的范围控制到 <code>vfat</code> 中，然后直接读，只有少数需要特殊处理的进行了函数的封装）。首先当然是研究了半天 <code>MBR</code> 和 <code>FAT32</code> 的结构，拿了不同来源的 <code>FAT</code> 结构说明进行对比和验证，最后终于把格式搞清楚了，先实现了 <code>MasterBootRecord</code> ，这个其实很好实现，以前也有接触过 <code>MBR</code> ，本身也很简单。然后就是根据 <code>MBR</code> 找到第一个 <code>FAT32</code> 的分区，根据偏移找到分区的开头，开头的第一个扇区就是 <code>EBPB</code> 数据结构，里面保存了 <code>FAT32</code> 分区的各种信息。根据里面的信息，可以找到 <code>FAT</code> 表的位置和数量，还有数据部分的 <code>Cluster</code> 的位置和数量。接着，解析一下 <code>FAT</code> 表，实际上是一个与 <code>Cluster</code> 一一对应的链表结构，用特殊的数据代表链表的尾和空、坏扇区。利用这些，和 <code>EBPB</code> 中根目录所在的第一个 <code>Cluster</code> ，先在 <code>VFat</code> 里面实现了读取一个 <code>Cluster</code> 链的内容的函数，利用这个函数读取一个一个的目录项，解析目录项，把长文件名的项合并到一个之中，然后对应地丢到 <code>Entry</code> 对象中，目录则可以枚举子目录项，根据名字比较去找子目录或者子文件夹，文件则实现了 <code>io::Read</code>和 <code>io::Seek</code> 使得可以读取文件的内容。实现好了这些以后，就拿了 <code>raspbian-strech-lite.img</code> 作为硬盘映像，从文件里读取文件信息，成功地把 <code>config.txt</code> 读取出来。</p>
<p>其中还是遇到许多困难，如各种偏移的计算，如何处理跨 <code>Cluster</code> 和跨 <code>Sector</code> 的读写，等等，有不少的坑在其中，花了两天的空余时间才差不多完善了这个功能。还有就是利用 <code>Rust</code> 现有的功能完成 <code>C</code> 里面很轻易就可以实现的指针操作，也花了不少时间。</p>
<p>更新：<a href="../../programming/2018/03/03/thoughts-on-stanford-cs140e-5/">下一篇在这里</a>。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/02/27/thoughts-on-stanford-cs140e-4/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-02-16 00:00:00">2018年2月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考3"><a class="toclink" href="../../programming/2018/02/16/thoughts-on-stanford-cs140e-3/">近来做 Stanford CS140e 的一些进展和思考（3）</a></h2>
<p>由于 <code>Assignment 2: File System</code> 延期发布，所以中间那段时间转向 <code>MIT 6.828</code> 稍微研究了一下。前几天放出了新的任务，在<a href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">上一篇文章</a>之后，我又有了一些进展：实现了从内存中读取 <code>ATAGS(ARM Tags)</code> 信息的代码，从而可以获得内存大小的信息，根据这个信息，实现了 <code>bump</code> 和 <code>bin</code> 两种内存分配器，并且把二者之一注册为全局内存分配器，利用上更新了的 <code>std</code> 就可以使用需要动态分配内存的相关工具了。利用这个，我实现了 <code>shell</code> 输入历史的回溯，把输入历史保存在一个动态增长的数组中，再特殊处理上下键，把当前的行替换为历史。</p>
<p>这个过程也不是没有踩坑。一开始代码放出来了，但是题目说明还没出，我就自己按照代码做了 <code>ATAGS</code> 和 <code>bump</code> 分配器，后来做完了，看到说明出了以后，发现理解还是有偏差，把代码更改了并修复了分配器的 BUG。看到 <code>bin</code> 分配器的时候，我按照网上的 <code>buddy memory allocation</code> 实现了一个内存分配器，原理看起来简单实现起来还是有很多细节问题，后来按照新放出的单元测试，修修补补才写得差不多可用了。同时，原来的 <code>bootloader</code> 因为用了新的 <code>std</code> 而缺失了 <code>alloc</code> 不能编译，我就把 <code>kernel</code> 下的相关文件软连接过去，调了数次后把问题解决。此时， <code>kernel</code> 文件大小已经有 40K，按照 115200 Baudrate 发送需要几秒才能传输过去，我就调到了 230400 Baudrate，果然现在的传输速度就有所提升，可以接受了。等之后写了 <code>EMMC(SD card)</code> 的驱动和 <code>FAT32</code> 的文件系统后，就可以实现更多的 <code>shell</code> 的功能了。中间还遇到一个问题，就是如果给 <code>kernel</code> 开启了 <code>bin</code> 分配器，使用 <code>exit</code> 回到 <code>bootloader</code> 就无法传新的 <code>kernel</code> 上去了，结果发现是因为 <code>bin</code> 中用到的侵入式 <code>LinkedList</code> 实现覆盖了部分 <code>bootloader</code> 的代码，换回不能回收内存的 <code>bump</code> 分配器即可，反正目前远远还用不了那么多内存。</p>
<p>之后还要在 <code>aarch64</code> 上用 <code>MMU</code> 实现虚拟内存，之前在 <code>MIT 6.828</code> 里被页表整得脑子眩晕，希望到时我还活着吧（逃</p>
<p>更新：<a href="../../programming/2018/02/27/thoughts-on-stanford-cs140e-4/">下一篇在这里</a>。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/02/16/thoughts-on-stanford-cs140e-3/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-02-06 00:00:00">2018年2月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考2"><a class="toclink" href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">近来做 Stanford CS140e 的一些进展和思考（2）</a></h2>
<p>在<a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/">上一篇文章</a>之后，我又有了一些进展：<code>UART</code> ，简易的<code>shell</code> ，修复了之前写的 <code>xmodem</code> 中的 BUG，一个可以从 <code>UART</code> 接收一个 <code>kernel</code> 写入到内存中再跳转过去的 <code>bootloader</code> 。</p>
<p>首先是 <code>UART</code> ，就是通过两个 <code>GPIO pin</code> 进行数据传输，首先在 <code>memory mapped IO</code> 上进行相应的初始化，然后包装了 <code>io::Read</code> 和 <code>io::Write</code> （这里实现一开始有 BUG，后来修复了），然后很快地完成了一个仅仅能 <code>echo</code> 的 <code>kernel</code> 。</p>
<p>然后实现了 <code>CONSOLE</code> ，一个对 <code>MiniUart</code> 和单例封装，就可以用 <code>kprint!/kprintln!</code> 宏来输出到 <code>UART</code> ，接着实现了一个 <code>echo</code> 的 <code>shell</code> ，读入一行输出一行。然后实现退格键和方向键，这里的难点在于要控制光标并且用读入的或者空格覆盖掉屏幕上已经显示而不应该显示的内容。接着，利用 <code>skeleton</code> 中的 <code>Command</code> 做了一个简单的 <code>echo</code> 命令。</p>
<p>接着，利用之前编写的 <code>tty</code> ，配合上新编写的 <code>bootloader</code> ，实现通过 <code>UART</code> 把新的 <code>kernel</code> 通过 <code>XMODEM</code> 协议发送到设备，写入 <code>0x80000</code> 启动地址并且调转到新加载的 <code>kernel</code> 中执行。</p>
<p>最后，又实现了 <code>uptime</code> （输出设备启动到现在的时间）和 <code>exit</code> （跳转回 <code>bootloader</code> ，可以上传新的 <code>kernel</code> ）。并添加了 <code>TUNA</code> 作为 <code>shell</code> 启动时输出的 <code>BANNER</code> 。</p>
<p>整个过程挺虐的，踩了很多的坑，由于很多东西都没有，输入输出目前也只有 <code>UART</code> ，写了 <code>UART</code> 后又遇到 <code>XMODEM</code> 难以调试的问题。十分感谢 <code>#tuna</code> 上的 @BenYip 及时地指出了代码的几处问题，节省了我许多时间。</p>
<p>更新：<a href="../../programming/2018/02/16/thoughts-on-stanford-cs140e-3/">下一篇在这里</a>。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-02-04 00:00:00">2018年2月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="近来做-stanford-cs140e-的一些进展和思考"><a class="toclink" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/">近来做 Stanford CS140e 的一些进展和思考</a></h2>
<p>最近，受各路安利，剁手买下了 <a href="https://item.taobao.com/item.htm?id=537501616420">这个淘宝商家的树莓派的套餐 C</a> ，还买了许多 LED 灯泡、杜邦线和电阻，开始按照 <a href="http://web.stanford.edu/class/cs140e/">CS 140e</a> 学习 Rust 并且用 Rust 编译写一个简易的操作系统。Assignment 0 的目标就是编写一个向 GPIO 16 连接的 LED 灯闪烁。首先当然就是愉快地按照教程下载 bootloader，下载交叉编译工具链，顺带装一个 Raspbian 到机器上，随时可以当成一个低性能的 ARM/ARM64（实际上，Raspbian 只用了 armv7l，没有用 64bit）机器来用，以后如果配上 <a href="https://scateu.me">@scateu</a> 团购的 Motorola Laptop Dock 的话就是一个几百块的笔记本了。把课程上的文件丢上去，可以看到绿色的活动指示灯闪烁，后面又把 CP2102 模块连上去，又能看到 Blink on, Blink off 的输出。然后按照要求，自己先码一段 C 语言，实现 blinky:</p>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-1"></a><span class="cp">##define GPIO_BASE (0x3F000000 + 0x200000)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-3"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">GPIO_FSEL1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x04</span><span class="p">);</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-4"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">GPIO_SET0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1C</span><span class="p">);</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-5"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">GPIO_CLR0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-7"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spin_sleep_us</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">us</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-8"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-9"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;nop&quot;</span><span class="p">);</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-11"></a><span class="p">}</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-13"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spin_sleep_ms</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-14"></a><span class="w">  </span><span class="n">spin_sleep_us</span><span class="p">(</span><span class="n">ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-15"></a><span class="p">}</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-16"></a>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-18"></a><span class="w">  </span><span class="c1">// STEP 1: Set GPIO Pin 16 as output.</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-19"></a><span class="w">  </span><span class="o">*</span><span class="n">GPIO_FSEL1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-20"></a><span class="w">  </span><span class="c1">// STEP 2: Continuously set and clear GPIO 16.</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-21"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-22"></a><span class="w">    </span><span class="o">*</span><span class="n">GPIO_SET0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-23"></a><span class="w">    </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-24"></a><span class="w">    </span><span class="o">*</span><span class="n">GPIO_CLR0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-25"></a><span class="w">    </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-26"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>其中大部分代码都已经给出了，自己要实现也只是查询一下 BCM2837 SoC 的 GPIO 文档，按照文档把该做的内存操作和位运算都写一下即可。最后发现，闪烁的频率特别慢，几秒钟才闪烁一次。毕竟是按照 CPU 的 clock speed 进行粗略的计时，而生成的代码也不是很高效，没有 inline。接着则是用 Rust 再实现一下上面这部分的代码：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-1"></a>#<span class="cp">#![feature(compiler_builtins_lib, lang_items, asm, pointer_methods)]</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-2"></a>#<span class="cp">#![no_builtins]</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-3"></a>#<span class="cp">#![no_std]</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-5"></a><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">compiler_builtins</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-7"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">lang_items</span><span class="p">;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-9"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_BASE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mh">0x3F000000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200000</span><span class="p">;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-11"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_FSEL1</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-12"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_SET0</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1C</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-13"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_CLR0</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-15"></a>#<span class="cp">#[inline(never)]</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-16"></a><span class="k">fn</span> <span class="nf">spin_sleep_ms</span><span class="p">(</span><span class="n">ms</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-17"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">600</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-18"></a><span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">asm!</span><span class="p">(</span><span class="s">&quot;nop&quot;</span><span class="w"> </span>:::: <span class="s">&quot;volatile&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-20"></a><span class="p">}</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-21"></a>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-22"></a>#<span class="cp">#[no_mangle]</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-23"></a><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">kmain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-24"></a><span class="w">    </span><span class="c1">// STEP 1: Set GPIO Pin 16 as output.</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-25"></a><span class="w">    </span><span class="n">GPIO_FSEL1</span><span class="p">.</span><span class="n">write_volatile</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">18</span><span class="p">);</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-26"></a><span class="w">    </span><span class="c1">// STEP 2: Continuously set and clear GPIO 16.</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-27"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-28"></a><span class="w">        </span><span class="n">GPIO_SET0</span><span class="p">.</span><span class="n">write_volatile</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-29"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-30"></a><span class="w">        </span><span class="n">GPIO_CLR0</span><span class="p">.</span><span class="n">write_volatile</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-31"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-33"></a><span class="p">}</span>
</span></code></pre></div>
<p>这边和上面一样，很多东西都已经给出了，只是重新改写一下而已。不过，这边的实测结果则是，一秒钟会闪烁很多下，看了下汇编，生成的循环比较紧凑，所以也没有达到想要的效果，不过后面到我实现了 Timer 的读取之后，就很精准了。</p>
<p>接下来就是痛苦的学习 Rust 的过程，Assignment 1 上来就是解答关于 Rust 语言的一些问题，在过程中被 Rust 十分严格的 Lifetime 和 Borrow checker 弄得想死，好歹最后还是让测试都通过了。接下来就是真正地提供一些封装硬件接口的 API，然后利用这些 API 去实现更多功能，首先是利用栈上分配的空间模拟一个变长数组的 API：<code>stack-vec</code> ，然后是把底层的直接操作硬件的内存操作封装成类型安全的 <code>volatile</code> ，然后实现一个简单的支持断点续传的传文件的协议 <code>xmodem</code> ，又做了一个辅助电脑上使用 TTY+XMODEM 的小工具 <code>ttywrite</code> ，然后就开始撸硬件了：时钟 <code>timer</code> ，针对 GPIO pin 的类型安全的状态机 <code>GPIO</code> 。目前只实现到这里，然后做出了一个准确一秒闪烁的 blinky（令人惊讶的是，因为这里的 kernel 直接从文件头开始就是代码，最后的 binary 异常地小，而之前的代码从文件的偏移 0x8000 开始。目前看来，是因为之前的代码是整个文件加载到 0x0000 上，而代码默认了从  0x8000 开始，所以除了最开头的一个跳转指令，中间留了许多空余的空间。而这里的代码是直接被 bootloader 加载到了 0x80000 处并且跳转到这里执行，所以省去了许多空间）：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-1"></a><span class="k">fn</span> <span class="nf">blinky</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pin16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gpio</span>::<span class="n">new</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pin_out16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin16</span><span class="p">.</span><span class="n">into_output</span><span class="p">();</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-5"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-6"></a><span class="w">        </span><span class="n">pin_out16</span><span class="p">.</span><span class="n">set</span><span class="p">();</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-7"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-8"></a><span class="w">        </span><span class="n">pin_out16</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-9"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-11"></a><span class="p">}</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-13"></a>#<span class="cp">#[no_mangle]</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-14"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">kmain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-15"></a><span class="w">    </span><span class="c1">// FIXME: Start the shell.</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-16"></a><span class="w">    </span><span class="n">blinky</span><span class="p">();</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>目前只做到这里。后面还有大把的坑要踩，难写的 Rust 还得继续啃下去。我的代码都以 diff 的形式放在了 <a href="https://github.com/jiegec/cs140e">jiegec/cs140e</a> ，写得并不美观。接下来就是实现 <code>UART</code> 了，终于要实现串口通信了。</p>
<p>2018-01-06 更新： <a href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">下一篇文章已经更新</a> 。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-01-30 00:00:00">2018年1月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="再次吐槽-vs-关于-scanf-和-scanf_s-的问题"><a class="toclink" href="../../programming/2018/01/30/more-on-scanf-and-scanf_s/">再次吐槽 VS 关于 scanf 和 scanf_s 的问题</a></h2>
<p>继<a href="../../programming/2017/10/17/on-scanf-and-scanf_s/">上次的吐槽</a>后，今天再次遇到同学因为 <code>scanf</code> 在 VS 下的 <code>deprecation error</code> 感到十分迷茫，在知乎上求助又因为拍照的原因被说，我就在此再次吐槽一下 VS 这对初学者很不友善很不友善的两点。</p>
<p>一点就是上面提到的这个，另一点就是程序结束后任意键以退出这一功能要做得更加醒目一点。前者由于大多数新手在学习 <code>C/C++</code> 的时候都会跟着书上或者网上的代码敲一遍输入输出的代码，很容易就会撞到这个问题。后者则会让新手习惯性地以为程序闪退了，没有出结果，而不知道其实是程序执行结束后关闭而已。</p>

    <nav class="md-post__action">
      <a href="../../programming/2018/01/30/more-on-scanf-and-scanf_s/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-01-07 00:00:00">2018年1月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="我正在使用的两个-emacs-的-patch"><a class="toclink" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/">我正在使用的两个 Emacs 的 Patch</a></h2>
<p>我在本地对 <code>emacs.rb</code> 进行了修改：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-1"></a>diff --git a/Formula/emacs.rb b/Formula/emacs.rb
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-2"></a>index d0138cd..de3c5ff 100644
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-3"></a>--- a/Formula/emacs.rb
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-4"></a>+++ b/Formula/emacs.rb
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-5"></a>@@ -4,6 +4,14 @@ class Emacs &lt; Formula
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-6"></a>   url &quot;https://ftp.gnu.org/gnu/emacs/emacs-25.3.tar.xz&quot;
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-7"></a>   sha256 &quot;253ac5e7075e594549b83fd9ec116a9dc37294d415e2f21f8ee109829307c00b&quot;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-9"></a>+  patch do
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-10"></a>+    url &quot;https://gist.githubusercontent.com/aatxe/260261daf70865fbf1749095de9172c5/raw/214b50c62450be1cbee9f11cecba846dd66c7d06/patch-multicolor-font.diff&quot;
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-11"></a>+  end
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-12"></a>+
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-13"></a>+  patch do
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-14"></a>+    url &quot;https://debbugs.gnu.org/cgi/bugreport.cgi?filename=0001-Fix-child-frame-placement-issues-bug-29953.patch;bug=29953;att=1;msg=8&quot;
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-15"></a>+  end
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-16"></a>+
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-17"></a>   bottle do
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-18"></a>     sha256 &quot;d5ce62eb55d64830264873a363a99f3de58c35c0bd1602cb7fd0bc37137b0c9d&quot; =&gt; :high_sierra
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-19"></a>     sha256 &quot;4d7ff7f96c9812a9f58cd45796aef789a1b5d26c58e3e68ecf520fab34af524d&quot; =&gt; :sierra
</span></code></pre></div>
<p>主要涉及到两个 Patch：</p>
<ol>
<li>启用对 Multicolor font，比如 Emoji 的支持。由于一些 ethic problems 暂时在 Emacs 中被禁用了，所以自己启用回来。</li>
<li>打上我前几天上报的 <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=29953">BUG #29953</a> 的修复。已经在上游 Merge 到 <code>emacs-26</code> 分支中，这个修复会在下一个版本中。</li>
</ol>
<p>有了第一个，就可以正常显示 Emoji（对不起，RMS）；有了第二个，就解决了 <code>pyim</code> 和 <code>lsp-ui-peek</code> 用 <code>child-frame</code> 显示的一些问题了。</p>
<p>另外还有一个我自己在用的 <code>recoll.rb</code> ：
<div class="language-rb highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-1"></a><span class="c1">## Documentation: https://docs.brew.sh/Formula-Cookbook.html</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-2"></a><span class="c1">##                http://www.rubydoc.info/github/Homebrew/brew/master/Formula</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-3"></a><span class="c1">## PLEASE REMOVE ALL GENERATED COMMENTS BEFORE SUBMITTING YOUR PULL REQUEST!</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Recoll</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Formula</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-6"></a><span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s2">&quot;Recoll is a desktop full-text search tool.&quot;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-7"></a><span class="w">  </span><span class="n">homepage</span><span class="w"> </span><span class="s2">&quot;https://www.lesbonscomptes.com/recoll/&quot;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-8"></a><span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="s2">&quot;https://www.lesbonscomptes.com/recoll/recoll-1.23.5.tar.gz&quot;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-9"></a><span class="w">  </span><span class="n">sha256</span><span class="w"> </span><span class="s2">&quot;9b6b6941efc3e87c8325e95a69a5d0a37c022c3c45773c71dccd0fb3f364475f&quot;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-11"></a><span class="w">  </span><span class="n">depends_on</span><span class="w"> </span><span class="s2">&quot;xapian&quot;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-12"></a><span class="w">  </span><span class="n">depends_on</span><span class="w"> </span><span class="s2">&quot;qt&quot;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-13"></a><span class="w">  </span><span class="n">depends_on</span><span class="w"> </span><span class="s2">&quot;aspell&quot;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-15"></a><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">install</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-16"></a><span class="w">    </span><span class="n">inreplace</span><span class="w"> </span><span class="s2">&quot;Makefile.in&quot;</span><span class="p">,</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-17"></a><span class="w">      </span><span class="s2">&quot;-Wl,--no-undefined -Wl,--warn-unresolved-symbols&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--no-undefined --warn-unresolved-symbols&quot;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-19"></a><span class="w">    </span><span class="nb">system</span><span class="w"> </span><span class="s2">&quot;./configure&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--disable-dependency-tracking&quot;</span><span class="p">,</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-20"></a><span class="w">                          </span><span class="s2">&quot;--disable-silent-rules&quot;</span><span class="p">,</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-21"></a><span class="w">                          </span><span class="s2">&quot;--without-x&quot;</span><span class="p">,</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-22"></a><span class="w">                          </span><span class="s2">&quot;--disable-x11mon&quot;</span><span class="p">,</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-23"></a><span class="w">                          </span><span class="s2">&quot;--with-aspell&quot;</span><span class="p">,</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-24"></a><span class="w">                          </span><span class="s2">&quot;--enable-recollq&quot;</span><span class="p">,</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-25"></a><span class="w">                          </span><span class="s2">&quot;--disable-webkit&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># requires qtwebkit, which is not bundled with qt5</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-26"></a><span class="w">                          </span><span class="s2">&quot;--prefix=</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-27"></a><span class="w">    </span><span class="nb">system</span><span class="w"> </span><span class="s2">&quot;make&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;install&quot;</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-28"></a>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-29"></a><span class="w">    </span><span class="n">mkdir</span><span class="w"> </span><span class="n">libexec</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-30"></a><span class="w">    </span><span class="n">mv</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="s2">&quot;recoll.app&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">libexec</span><span class="o">/</span><span class="s2">&quot;recoll.app&quot;</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-31"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-32"></a>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-33"></a><span class="w">  </span><span class="nb">test</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-34"></a><span class="w">    </span><span class="c1"># `test do` will create, run in and delete a temporary directory.</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-35"></a><span class="w">    </span><span class="c1">#</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-36"></a><span class="w">    </span><span class="c1"># This test will fail and we won&#39;t accept that! For Homebrew/homebrew-core</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-37"></a><span class="w">    </span><span class="c1"># this will need to be a test that verifies the functionality of the</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-38"></a><span class="w">    </span><span class="c1"># software. Run the test with `brew test recoll`. Options passed</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-39"></a><span class="w">    </span><span class="c1"># to `brew install` such as `--HEAD` also need to be provided to `brew test`.</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-40"></a><span class="w">    </span><span class="c1">#</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-41"></a><span class="w">    </span><span class="c1"># The installed folder is not in the path, so use the entire path to any</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-42"></a><span class="w">    </span><span class="c1"># executables being tested: `system &quot;#{bin}/program&quot;, &quot;do&quot;, &quot;something&quot;`.</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-43"></a><span class="w">    </span><span class="nb">system</span><span class="w"> </span><span class="s2">&quot;false&quot;</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-44"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-45"></a><span class="k">end</span>
</span></code></pre></div></p>

    <nav class="md-post__action">
      <a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2017-12-31 00:00:00">2017年12月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="有趣的-java-日期格式化问题"><a class="toclink" href="../../programming/2017/12/31/interesting-java-formatting-problem/">有趣的 Java 日期格式化问题</a></h2>
<p>今天在群里看到有人说，Java 的日期格式化有问题，如果用 <code>YYYY-MM-dd</code> ，今天的日期就会显示 <code>2018-12-31</code> 。我立马在本地用 Java REPL (aka Groovy) 跑了一下，果然如此：</p>
<div class="language-groovy highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-1"></a><span class="n">$</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="o">()</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-2"></a><span class="o">===&gt;</span><span class="w"> </span><span class="n">Sun</span><span class="w"> </span><span class="n">Dec</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="mi">26</span><span class="w"> </span><span class="n">CST</span><span class="w"> </span><span class="mi">2017</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-3"></a><span class="n">$</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nn">java.text.SimpleDateFormat</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-4"></a><span class="o">===&gt;</span><span class="w"> </span><span class="n">java</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">SimpleDateFormat</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-5"></a><span class="n">$</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">&quot;YYYY-MM-dd&quot;</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-6"></a><span class="o">===&gt;</span><span class="w"> </span><span class="mi">2018</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>
</span></code></pre></div>
<p>解决方案是，把格式换为 <code>yyyy-MM-dd</code> ，确实就可以了。于是我就去研究了一下文档： <a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html">Class SimpleDateFormat</a> ，发现了问题：</p>
<p><code>y</code> 代表 <code>year</code> ，而 <code>Y</code> 代表 <code>week year</code> 。根据 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/GregorianCalendar.html#week_year">week year</a> ，因为今年最后的一个星期在明年的部分更多，于是这个星期被归在了明年，所以这一周属于 2018，这就可以解释之前的那个输出问题了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2017/12/31/interesting-java-formatting-problem/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2017-12-12 00:00:00">2017年12月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="lsp-和-c"><a class="toclink" href="../../programming/2017/12/12/lsp-and-cpp/">LSP 和 C++</a></h2>
<p>之前时间，巨硬发布了 LSP（Language Server Protocol），目的是解决目前 IDE 和各语言的 m+n 问题。想法很好，不过直到最近，终于有我觉得可以用的工具出来了，并且已经代替了我在使用的其它的插件。</p>
<p>由于我最近主要就是做做程设作业，做做 OJ 这些，主要就是和 C++ 打交道。所以我当然就开始找一些比较成熟的 C++的 LSP server。有一个 Sourcegraph 维护的 <a href="https://langserver.org/">langserver.org</a> ，上面有着目前的各个语言和编辑器/IDE 的支持情况，我刚才提到的 cquery 也会加入到这个列表里去。从这个列表里可以看到，我用的比较多的 Python 和 Haskell 都已经有不错的的 LSP server，我已经开始在本地体验 pyls 和 hie 了，感觉做得挺不错的。</p>
<p>回到 C++，我的主力编辑器是 Emacs，其次是 CLion，而 Emacs 上的<a href="https://github.com/emacs-lsp/lsp-mode">LSP 支持 lsp-mode</a>也在快速发展，与之配合的<a href="https://github.com/emacs-lsp/lsp-ui">lsp-ui</a> 也出现了很多很棒的功能。</p>
<p>下面开始编译并配置<a href="https://github.com/jacobdufault/cquery">cquery</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/jacobdufault/cquery<span class="w"> </span>--recursive
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-2"></a><span class="nb">cd</span><span class="w"> </span>cquery
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-3"></a>./waf<span class="w"> </span>configure<span class="w"> </span><span class="c1"># to use system clang, append --use-system-clang</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-4"></a>./waf<span class="w"> </span>build
</span></code></pre></div>
<p>然后配置 Emacs：</p>
<div class="language-elisp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-1"></a><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">lsp-mode</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-2"></a><span class="w">  </span><span class="nb">:ensure</span><span class="w"> </span><span class="no">t</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-3"></a><span class="w">  </span><span class="nb">:diminish</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-4"></a><span class="w">  </span><span class="nv">lsp-mode</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-5"></a><span class="w">  </span><span class="nb">:commands</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-6"></a><span class="w">  </span><span class="p">(</span><span class="nv">lsp-mode</span><span class="p">)</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-7"></a><span class="w">  </span><span class="nb">:config</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-8"></a><span class="w">  </span><span class="p">(</span><span class="nv">lsp-define-stdio-client</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-9"></a><span class="w">   </span><span class="nv">lsp-pyls</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-10"></a><span class="w">   </span><span class="s">&quot;python&quot;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-11"></a><span class="w">   </span><span class="nf">#&#39;</span><span class="nv">get-project-root</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-12"></a><span class="w">   </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;/usr/local/bin/pyls&quot;</span><span class="p">)))</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-14"></a><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">lsp-ui</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-15"></a><span class="w">  </span><span class="nb">:commands</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-16"></a><span class="w">  </span><span class="nv">lsp-ui-mode</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-17"></a><span class="w">  </span><span class="nb">:init</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-18"></a><span class="w">  </span><span class="p">(</span><span class="nv">add-hook</span><span class="w"> </span><span class="ss">&#39;lsp-mode-hook</span><span class="w"> </span><span class="ss">&#39;lsp-ui-mode</span><span class="p">))</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-19"></a>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-20"></a><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">cquery</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-21"></a><span class="w">  </span><span class="nb">:load-path</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-22"></a><span class="w">  </span><span class="s">&quot;path_to_cquery/emacs&quot;</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-23"></a><span class="w">  </span><span class="nb">:config</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-24"></a><span class="w">  </span><span class="p">(</span><span class="k">setq</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-25"></a><span class="w">     </span><span class="nv">cquery-executable</span><span class="w"> </span><span class="s">&quot;path_to_cquery/build/app&quot;</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-26"></a><span class="w">     </span><span class="nv">cquery-resource-dir</span><span class="w"> </span><span class="s">&quot;path_to_cquery/clang_resource_dir&quot;</span><span class="p">))</span>
</span></code></pre></div>
<p>接下来，需要配置 基于 Clang 的 工具都需要的 Compilation Database。Sacrasm 对这个有一个非常完整的<a href="https://sarcasm.github.io/notes/dev/compilation-database.html">总结</a> ，可以查看里面的方法。我这里推荐在 CMake 项目中用 CMake 自带的，加上<a href="https://github.com/nickdiego/compiledb-generator">nickdiego/compiledb-generator</a> 应付基于Makefile/Autotools的项目。如果都不适用，就按照cquery的README写一个简单的.cquery文件即可，不需要Bear那种必须关闭SIP的方案。</p>
<p>然后就可以享受很多功能了！还是挺好用的。</p>

    <nav class="md-post__action">
      <a href="../../programming/2017/12/12/lsp-and-cpp/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2017-12-02 00:00:00">2017年12月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nginx-的内存池实现"><a class="toclink" href="../../programming/2017/12/02/on-nginx-memory-pool/">Nginx 的内存池实现</a></h2>
<p>今晚参加了 Tunight，会长给我们讲了 Nginx 的一些内部运作的机制和原理。中间的时候，会长展示的代码中用到了线程池方面的一些函数，但是大多地方只有调用 <code>ngx_pcalloc</code> 而没有看到相应的对象释放的过程，于是在演示的最后，会长应大家要求对 Nginx 魔幻的内存池实现做了现场代码分析。</p>
<p>在分析的中途遇到了很多坑，最后才终于理清了内存池的工作原理。这里直接解释结论吧。以下代码均摘自 Nginx 1.13.7，代码都可以在官方仓库找到。</p>
<p>首先分析一下创建一个内存池的函数：
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-1"></a><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-2"></a><span class="nf">ngx_create_pool</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">ngx_log_t</span><span class="w"> </span><span class="o">*</span><span class="n">log</span><span class="p">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-3"></a><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-4"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">  </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-6"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-11"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-12"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-13"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-14"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-16"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-17"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-19"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-20"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-21"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-22"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-23"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-26"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>现在开始分段分析这个函数：在这里，一个内存池用一个 <code>ngx_pool_t (aka struct ngx_pool_s)</code> 类型的数据进行包装，所有的关于内存池的操作都基于相应的内存池对象。 <code>ngx_log_t</code> 表示输出信息的对象，与内存池无关，后面也不会讨论它。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-1"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-3"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-6"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-7"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-8"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-9"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<p>这里通过调用 <code>ngx_memalign</code> 分配一段（能对齐就对齐，不能对齐就放弃的）以 size 为大小的内存，做为这个内存池第一个块的内存，这个块的头是完整的，其中 <code>p-&gt;d.last</code> 和 <code>p-&gt;d.end</code> 分别表示可用于分配对象的内存段的开始和结束，在用 <code>p-&gt;d.next</code> 连接起来的链表中，每个链表实际上只有 <code>d</code> 是存储了数据，后面的各个域都不再使用。这里的 <code>p-&gt;d.failed</code> 涉及到链表的优化，在以后会接触到。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-1"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-2"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-4"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-5"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-6"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-7"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-8"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span></code></pre></div>
<p>这里的 <code>size</code> 计算出实际用于对象分配的内存大小， <code>p-&gt;max</code> 存储了当前这个块最大能容纳的对象的大小， <code>p-&gt;current</code> 会和上面的 <code>p-&gt;d.failed</code> 合在一起对链表进行优化。 <code>p-&gt;chain</code> 与其他功能关系较密切，不会在本文中展开，而 <code>p-&gt;cleanup</code> 允许外部注册一些清理函数，实现起来并不难。</p>
<p>接下来，由于 <code>ngx_pnalloc</code> 和 <code>ngx_pcalloc</code> 都和 <code>ngx_palloc</code> 相近，这里只对 <code>ngx_palloc</code> 进行分析：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-2"></a><span class="nf">ngx_palloc</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-3"></a><span class="p">{</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-4"></a><span class="cp">##if !(NGX_DEBUG_PALLOC)</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-8"></a><span class="cp">##endif</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ngx_palloc_large</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里分了两种情况，如果要分配的内存大于一个块的最大值，那么这段内存必须要单独分配单独维护，所以调用了 <code>ngx_palloc_large</code> ，下面对其分析：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-2"></a><span class="nf">ngx_palloc_large</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-3"></a><span class="p">{</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-4"></a><span class="w">    </span><span class="kt">void</span><span class="w">              </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-5"></a><span class="w">    </span><span class="n">ngx_uint_t</span><span class="w">         </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-6"></a><span class="w">    </span><span class="n">ngx_pool_large_t</span><span class="w">  </span><span class="o">*</span><span class="n">large</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-8"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-13"></a><span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-17"></a><span class="w">            </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-18"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-20"></a>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-22"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-26"></a><span class="w">    </span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_large_t</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">large</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-28"></a><span class="w">        </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-31"></a>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-32"></a><span class="w">    </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-33"></a><span class="w">    </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-34"></a><span class="w">    </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">large</span><span class="p">;</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-35"></a>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-36"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-37"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 <code>ngx_alloc</code> 就是对 <code>malloc</code> 的简单封装，直接分配一段内存，然后向 <code>pool-&gt;large</code> 中以 <code>ngx_pool_large_t</code> 组成的链表中插入。这里有一个小优化：因为 <code>ngx_pool_large_t</code> 本身也要占用内存，为了复用已经被释放的 <code>ngx_pool_large_t</code> ，尝试链表的前几项，如果几项中都没有空的位置，因为 <code>ngx_pool_large_t</code> 本身是一个很小的对象，自然可以复用自己在内存池中分配对象的方法 <code>ngx_palloc_small</code> ，然后把它加入到 <code>pool-&gt;large</code> 的链表的第一向前。如果很大的内存都在分配后很快释放，这种方法可以复用很多的 <code>ngx_pool_large_t</code> 。</p>
<p>接下来分析 <code>ngx_palloc_small</code> ：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-1"></a><span class="k">static</span><span class="w"> </span><span class="n">ngx_inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-2"></a><span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">ngx_uint_t</span><span class="w"> </span><span class="n">align</span><span class="p">)</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-3"></a><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-4"></a><span class="w">    </span><span class="n">u_char</span><span class="w">      </span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-5"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">  </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-7"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-9"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-10"></a><span class="w">        </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="p">;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-11"></a>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">align</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-13"></a><span class="w">            </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">NGX_ALIGNMENT</span><span class="p">);</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-15"></a>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-17"></a><span class="w">            </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-19"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-21"></a>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-22"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-23"></a>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-24"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ngx_palloc_block</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>首先，从 <code>pool-&gt;current</code> 遍历（这样做的原因下面会提到）已有的各个块，寻找有没有哪个块能容纳下现在需要的大小，如果能就可以调整 <code>p-&gt;d.last</code> 返回，否则就分配一个新的块到内存池中，再从新的块中分配需要的大小的内存。需要一提的是，在设计中，小的对象是随着整个内存池的销毁而被一起释放的，不会在中途被释放，而大的对象尽量要用完即释放。接下来分析 <code>ngx_palloc_block</code> ：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-2"></a><span class="nf">ngx_palloc_block</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-3"></a><span class="p">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-4"></a><span class="w">    </span><span class="n">u_char</span><span class="w">      </span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-5"></a><span class="w">    </span><span class="kt">size_t</span><span class="w">       </span><span class="n">psize</span><span class="p">;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-6"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">  </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">new</span><span class="p">;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-8"></a><span class="w">    </span><span class="n">psize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">pool</span><span class="p">);</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-10"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span><span class="w"> </span><span class="n">psize</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-15"></a><span class="w">    </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-16"></a>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-17"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">psize</span><span class="p">;</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-18"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-19"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-21"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_data_t</span><span class="p">);</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-22"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">NGX_ALIGNMENT</span><span class="p">);</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-23"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-24"></a>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-25"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-27"></a><span class="w">            </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-30"></a>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-31"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="p">;</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-32"></a>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-33"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-34"></a><span class="p">}</span>
</span></code></pre></div>
<p>为了节省内存，结构体中并没有记录实际分配的内存块的大小，于是根据第一个块的大小分配当前的块，虽然这里用的也是一个类型为 <code>ngx_pool_t</code> 结构体，实际上只用到了 <code>new-&gt;d</code> 中的内容维护块组成的链表和块内的分配情况。然后从 <code>pool-&gt;current</code> 开始找块的链表的结尾，找到节尾后把当前的块加到结尾的后面，然后把刚才需要分配的小对象的地址返回。与此同时，由于调用这个函数的时候，一定是当前的对象在已有的从 <code>pool-&gt;current</code> 开始的块中都放不下了，我们给这些块的 <code>p-&gt;d.failed</code> 进行自增，意思是说这个块在分配新的对象的时候又一次放不下了，如果放不下的次数比较多，我们可以认为这个块已经装得比较满了，那么，我们把 <code>pool-&gt;current</code> 设为它的后继，以后在分配新的对象的时候就会自动跳过这些比较满的块，从而提高了效率。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-1"></a><span class="n">ngx_int_t</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-2"></a><span class="nf">ngx_pfree</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-3"></a><span class="p">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-4"></a><span class="w">    </span><span class="n">ngx_pool_large_t</span><span class="w">  </span><span class="o">*</span><span class="n">l</span><span class="p">;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-8"></a><span class="w">            </span><span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-9"></a><span class="w">                           </span><span class="s">&quot;free: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-10"></a><span class="w">            </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-11"></a><span class="w">            </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">NGX_OK</span><span class="p">;</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-16"></a>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NGX_DECLINED</span><span class="p">;</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>从 <code>ngx_pfree</code> 的实现可以看出，只有大的对象才会要求尽快释放，小的对象和没有被手动释放的大的对象都会随着内存池生命周期的结束而一起释放。如 <code>ngx_destroy_pool</code> 中的实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-1"></a><span class="kt">void</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-2"></a><span class="nf">ngx_destroy_pool</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">)</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-3"></a><span class="p">{</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-4"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">          </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-5"></a><span class="w">    </span><span class="n">ngx_pool_large_t</span><span class="w">    </span><span class="o">*</span><span class="n">l</span><span class="p">;</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-6"></a><span class="w">    </span><span class="n">ngx_pool_cleanup_t</span><span class="w">  </span><span class="o">*</span><span class="n">c</span><span class="p">;</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-10"></a><span class="w">            </span><span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-11"></a><span class="w">                           </span><span class="s">&quot;run cleanup: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-12"></a><span class="w">            </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-15"></a>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-16"></a><span class="cp">##if (NGX_DEBUG)</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-17"></a>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-18"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-19"></a><span class="cm">     * we could allocate the pool-&gt;log from this pool</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-20"></a><span class="cm">     * so we cannot use this log while free()ing the pool</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-21"></a><span class="cm">     */</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-23"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-24"></a><span class="w">        </span><span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;free: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-26"></a>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-27"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="cm">/* void */</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-28"></a><span class="w">        </span><span class="n">ngx_log_debug2</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-29"></a><span class="w">                       </span><span class="s">&quot;free: %p, unused: %uz&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-30"></a>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-32"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-35"></a>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-36"></a><span class="cp">##endif</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-37"></a>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-38"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-40"></a><span class="w">            </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-41"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-43"></a>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-44"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="cm">/* void */</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-45"></a><span class="w">        </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-46"></a>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-47"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-48"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51" href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-51"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数首先调用了一系列用户定义的 <code>pool-&gt;cleanup</code> 链表中的函数，允许自定义回收一些特定的资源。然后对每一个 <code>pool-&gt;large</code> 链表中的内容分别释放，最后再把各个块中所有的内存整块释放。注意 <code>ngx_large_block_t</code> 也是存在块中的，所以顺序不能反了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2017/12/02/on-nginx-memory-pool/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2017-11-30 00:00:00">2017年11月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-jupyter-notebook-中运行-c-代码"><a class="toclink" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/">在 Jupyter Notebook 中运行 C++ 代码</a></h2>
<p>刚刚在 HN 上看到了这么一个文章：<a href="https://blog.jupyter.org/interactive-workflows-for-c-with-jupyter-fe9b54227d92">Interactive Workflows for C++ with Jupyter</a> <a href="https://news.ycombinator.com/item?id=15808809">HN</a> ，终于可以在 Jupyter Notebook 里跑 C++代码了，很开心，于是开始自己研究了起来怎么本地跑。</p>
<p>首先当然是更新一波 jupyter，安装一波 cling：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-0-1"></a>pip3<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>jupyter
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-0-2"></a>brew<span class="w"> </span>install<span class="w"> </span>cling
</span></code></pre></div>
<p>然后根据<a href="https://github.com/root-project/cling/tree/master/tools/Jupyter">官方教程</a>里的要求执行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-1-1"></a><span class="nb">cd</span><span class="w"> </span>/usr/local/share/cling/Jupyter/kernel
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-1-2"></a>pip3<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-1-3"></a>jupyter<span class="w"> </span>kernelspec<span class="w"> </span>install<span class="w"> </span>cling-cpp11
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-1-4"></a>jupyter<span class="w"> </span>kernelspec<span class="w"> </span>install<span class="w"> </span>cling-cpp14
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-1-5"></a>jupyter<span class="w"> </span>kernelspec<span class="w"> </span>install<span class="w"> </span>cling-cpp17
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-1-6"></a>jupyter<span class="w"> </span>kernelspec<span class="w"> </span>install<span class="w"> </span>cling-cpp1z
</span></code></pre></div>
<p>结果发现找不到<code>jupyter-kernelspec</code>，遂重装了一下<code>jupyter-client</code>这个包，果然就可以了。打开一个 notebook 测试：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-2-1"></a>jupyter notebook
</span></code></pre></div>
<p>然后创建一个 C++14 的 Notebook，结果发现一直 Kernel rebooting，错误信息是说找不到<code>../Cellar/cling/0.5/lib/libclingJupyter.dylib</code>。这一看就是路径处理的问题，当前目录肯定不是<code>/usr/local</code>，肯定出现了什么问题，然后研究发现<code>cling-kernel.py</code>中对<code>cling</code>判断是否是个连接，如果是连接则按照连接去找<code>cling</code>的安装目录，但是！没有考虑到这个连接是个相对路径的问题（Homebrew 你背锅吗）。于是我愉快地改了代码并提交了<a href="https://github.com/root-project/cling/pull/198">PR</a>。修复了以后就可以用了。</p>
<p>以下是一个小小的例子：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-1"></a>&gt;&gt;<span class="w"> </span>jupyter<span class="w"> </span>console<span class="w"> </span>--kernel<span class="w"> </span>cling-cpp14
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-2"></a>Jupyter<span class="w"> </span>console<span class="w"> </span><span class="m">5</span>.2.0
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-4"></a>cling-X
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-7"></a>In<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span><span class="c1">#include &lt;stdio.h&gt;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-8"></a>Out<span class="o">[</span><span class="m">1</span><span class="o">]</span>:
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-10"></a>In<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span>:<span class="w"> </span>char<span class="w"> </span>*s<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-11"></a>input_line_4:2:12:<span class="w"> </span>warning:<span class="w"> </span>ISO<span class="w"> </span>C++11<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>allow<span class="w"> </span>conversion<span class="w"> </span>from<span class="w"> </span>string<span class="w"> </span>literal<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;char *&#39;</span><span class="w"> </span><span class="o">[</span>-Wwritable-strings<span class="o">]</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-12"></a><span class="w"> </span>char<span class="w"> </span>*s<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-13"></a><span class="w">           </span>^
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-14"></a>Out<span class="o">[</span><span class="m">2</span><span class="o">]</span>:
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-16"></a>In<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span>:<span class="w"> </span>printf<span class="o">(</span><span class="s2">&quot;%s&quot;</span>,s<span class="o">)</span><span class="p">;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-17"></a>Hello,<span class="w"> </span>world!Out<span class="o">[</span><span class="m">3</span><span class="o">]</span>:
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/#__codelineno-3-18"></a><span class="o">(</span>int<span class="o">)</span><span class="w"> </span><span class="m">13</span>
</span></code></pre></div></p>
<p>Okay，大功告成！</p>

    <nav class="md-post__action">
      <a href="../../programming/2017/11/30/run-cpp-in-jupyter-notebook/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2017-10-17 00:00:00">2017年10月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="分析一个我第一次见的素数测试函数"><a class="toclink" href="../../programming/2017/10/17/analysis-on-a-primality-test/">分析一个我第一次见的素数测试函数</a></h2>
<p>今天逛到这个<a href="http://blog.csdn.net/l04205613/article/details/6025118">连接</a>，发现其中的第四种素数判定方法很有意思：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-1"></a>##include&lt;stdio.h&gt;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-2"></a>##include&lt;math.h&gt;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-3"></a>int p[8]={4,2,4,2,4,6,2,6};
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-4"></a>int prime(int n)
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-5"></a>{
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-6"></a>    int i=7,j,q;
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-7"></a>    if(n==1)return 0;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-8"></a>    if(n==2||n==5||n==3)return 1;
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-9"></a>    if(n%2==0||n%3==0||n%5==0)return 0;
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-10"></a>    q=(int)sqrt(n);
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-11"></a>    for(;i&lt;=q;){
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-12"></a>        for(j=0;j&lt;8;j++){
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-13"></a>            if(n%i==0)return 0;
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-14"></a>            i+=p[j];
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-15"></a>        }
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-16"></a>        if(n%i==0)return 0;
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-17"></a>    }
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-18"></a>    return 1;
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-19"></a>}
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-20"></a>void main()
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-21"></a>{
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-22"></a>    int n;
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-23"></a>    scanf(&quot;%d&quot;,&amp;n);
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-24"></a>    if(prime(n))puts(&quot;Yes&quot;);
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-25"></a>    else puts(&quot;No&quot;);
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2017/10/17/analysis-on-a-primality-test/#__codelineno-0-26"></a>}
</span></code></pre></div>
<p>仔细研究发现，这里利用的是这样的原理：</p>
<ol>
<li>判断是不是 1, 2, 3, 5 及其倍数</li>
<li>从 7 开始，不断考虑其是否是素数，那么，这个 p 是什么回事呢？</li>
</ol>
<p>首先把 p 的各个元素加起来，和为 30，然后就可以发现一个规律：
7 为质数，7+2=9 不是质数，7+4=11 为质数，11+2=13 为质数，13+2=15 为合数，15+2=17 为质数，17+2=19 为质数，19+2=21 为合数，21+2=23 为质数，23+2=25 为合数，25+2=27 为合数，27+2=29 为质数，29+1=31 为质数，31+2=33 为合数，33+2=35 为合数，35+2=37 为质数。
观察以上所有的合数，都含有 2 或者 3 或者 5 的因子，而 30 又是 2,3,5 的公倍数，也就是说，后面的素数模 30 的余数不可能是上面这些合数，而剩下的素数才可能是真正的素数，于是跳过了很多素数的判断。</p>
<p>至于这个函数的性能如何，还需要进一步测试来进行判断。</p>

    <nav class="md-post__action">
      <a href="../../programming/2017/10/17/analysis-on-a-primality-test/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2017-10-17 00:00:00">2017年10月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="关于-scanf-和-scanf_s-的问题"><a class="toclink" href="../../programming/2017/10/17/on-scanf-and-scanf_s/">关于 scanf 和 scanf_s 的问题</a></h2>
<p>最近作为程设基础的小教员，收到很多同学的求助，关于<code>scanf</code>和<code>scanf_s</code>的问题已经遇到了两次，特此写一篇博文来叙述一下这个问题。</p>
<p>一开始，有同学问我，
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2017/10/17/on-scanf-and-scanf_s/#__codelineno-0-1"></a>char a;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2017/10/17/on-scanf-and-scanf_s/#__codelineno-0-2"></a>scanf(&quot;%c&quot;,&amp;a);
</span></code></pre></div>
为什么会报错？我说，vs 默认强制要求使用 scanf_s 函数，于是我建议这位同学把这个错误信息关掉了。嗯。经过百度，这位同学的问题解决了。</p>
<p>后来，又有一位同学问我，
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2017/10/17/on-scanf-and-scanf_s/#__codelineno-1-1"></a>char a;
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2017/10/17/on-scanf-and-scanf_s/#__codelineno-1-2"></a>scanf_s(&quot;%c&quot;,&amp;a);
</span></code></pre></div>
程序为什么会崩溃？我想了想，如果 scanf_s 和 scanf 是一样的行为，这段代码是没问题的。但 scanf_s 既然安全，必然是在字符串方面做了处理。这里的 char*勉强也算一个？网上一查，果然，应该写成<code>scanf_s("%c",&amp;a,1);</code>，字符串则要写成<code>scanf_s("%s",str,sizeof(str))</code>，来保证缓冲区不会溢出。</p>
<p>但是，这样解决这个问题又面临着不同的选择：</p>
<ol>
<li>学习<code>scanf_s</code>和<code>scanf</code>的不同，把所有<code>scanf</code>换成<code>scanf_s</code>并做相应的修改。
   这样当然符合了语言进化的潮流，也会让 vs 闭嘴。但是，scanf_s 只有在 C11 标准中有，而且，根据<a href="http://en.cppreference.com/w/c/io/fscanf">cpprefrence.com 上关于 scanf 的描述</a>，只有在<code>__STDC_LIB_EXT1__</code>被定义且在<code>#include&lt;stdio.h&gt;</code>之前<code>#define __STDC_WANT_LIB_EXT1__</code>才能确保使用<code>scanf_s</code>能使用，当然在 vs 较新版本中是默认可以使用的。但是，程设基础的作业是要丢到 oj 上的，而 oj 上的编译器不一定支持这些，所以这个选项不行。</li>
<li>坚持用<code>scanf</code>，自己按照题目要求保证缓冲区不溢出，同时让 vs 闭嘴。
   网上已有<a href="https://www.cnblogs.com/wangduo/p/5554465.html">教程</a>，已经讲的很全面了，大家可以根据这个教程把 vs 教训一顿。为了能在 oj 里跑，建议用里面的方法五到八。（个人最推荐在文件头添加<code>#define _CRT_SECURE_NO_WARNINGS</code>）</li>
</ol>
<p>以后再遇到这个问题，我就丢这个连接上来就好了咯。yeah！</p>

    <nav class="md-post__action">
      <a href="../../programming/2017/10/17/on-scanf-and-scanf_s/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2016-07-23 00:00:00">2016年7月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="a-good-way-to-show-git-diff-for-compressed-files"><a class="toclink" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/">A good way to show git diff for compressed files</a></h2>
<p>I have found a good way to track changes in .gz files:
Add these to ~/.gitconfig:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-1"></a>[core]
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-2"></a>  attributesFile = ~/.gitattributes
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-3"></a>[diff &quot;zip&quot;]
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-4"></a>  textconv = unzip -p
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-5"></a>  binary = true
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-6"></a>[diff &quot;gz&quot;]
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-7"></a>  textconv = gzcat
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-8"></a>  binary = true
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-9"></a>[diff &quot;bz2&quot;]
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-10"></a>  textconv = bzcat
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-11"></a>  binary = true
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-12"></a>[diff &quot;xz&quot;]
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-13"></a>  textconv = xzcat
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-14"></a>  binary = true
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-15"></a>[diff &quot;tar&quot;]
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-16"></a>  textconv = tar -O -xf
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-17"></a>  binary = true
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-18"></a>[diff &quot;tar-bz2&quot;]
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-19"></a>  textconv = tar -O -xjf
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-20"></a>  binary = true
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-21"></a>[diff &quot;tar-gz&quot;]
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-22"></a>  textconv = tar -O -xzf
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-23"></a>  binary = true
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-24"></a>[diff &quot;tar-xz&quot;]
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-25"></a>  textconv = tar -O -xJf
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-26"></a>  binary = true
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-27"></a>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-28"></a>[diff &quot;odf&quot;]
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-29"></a>  textconv = odt2txt
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-30"></a>[diff &quot;pdf&quot;]
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-31"></a>  textconv = pdfinfo
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-32"></a>[diff &quot;bin&quot;]
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-0-33"></a>  textconv = hexdump -v -C
</span></code></pre></div>
<p>And these to ~/.gitattributes:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-1"></a>*.tar diff=tar
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-2"></a>*.tar.bz2 diff=tar-bz2
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-3"></a>*.tar.gz diff=tar-gz
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-4"></a>*.tar.xz diff=tar-xz
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-5"></a>*.bz2 diff=bz2
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-6"></a>*.gz diff=gz
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-7"></a>*.zip diff=zip
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-8"></a>*.xz diff=xz
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-10"></a>*.odf diff=odf
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-11"></a>*.odt diff=odf
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-12"></a>*.odp diff=odf
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-13"></a>*.pdf diff=pdf
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-14"></a>*.exe diff=bin
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-15"></a>*.png diff=bin
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/#__codelineno-1-16"></a>*.jpg diff=bin
</span></code></pre></div>
<p>And then you can <code>git diff</code> for .gz files.</p>
<p>Codes are adapted from https://gist.github.com/RsrchBoy/11197048
and https://git.wiki.kernel.org/index.php/GitTips#Getting_a_plain-text_diff and https://gist.github.com/kbaird/2654115.</p>

    <nav class="md-post__action">
      <a href="../../programming/2016/07/23/a-good-way-to-show-git-diff-for-compressed-files/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2016-05-22 00:00:00">2016年5月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="exciting-new-software-updates"><a class="toclink" href="../../programming/2016/05/22/exciting-new-software-updates/">Exciting new software updates</a></h2>
<p>Just got a piece of great news: GHC 8.0.1 is out! See the announcement [here][http://article.gmane.org/gmane.comp.lang.haskell.ghc.devel/11928].</p>
<p>So excited! And Emacs 25 release will be out soon. Using Emacs 25.0.94 now. Many new features available. See [this][http://puntoblogspot.blogspot.com/2016/05/emacs-251-news.html] for more information.</p>
<p>Recently I have finally started to use mu4e and gnus. What makes it truly great is that they integrate org, bbdb and so on.</p>

    <nav class="md-post__action">
      <a href="../../programming/2016/05/22/exciting-new-software-updates/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2016-04-09 00:00:00">2016年4月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="interesting-links"><a class="toclink" href="../../programming/2016/04/09/interesting-links/">Interesting links</a></h2>
<p>Having a bad cold. Really annoying.</p>
<p>Okay, here comes the interesting links:</p>
<p>https://glyph.twistedmatrix.com/2015/11/editor-malware.html</p>
<p>http://kitchingroup.cheme.cmu.edu/blog/2016/04/07/Writing-hy-code-from-hy-code/</p>
<p>https://github.com/holomorph/transmission</p>
<p>https://github.com/bergey/org-babel-diagrams</p>
<p>http://ess.r-project.org/</p>
<p>http://projects.haskell.org/diagrams/</p>

    <nav class="md-post__action">
      <a href="../../programming/2016/04/09/interesting-links/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2016-04-03 00:00:00">2016年4月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tips-on-git-shallow-clone"><a class="toclink" href="../../programming/2016/04/03/tips-on-git-shallow-clone/">Tips on git shallow clone</a></h2>
<p>Just learned a new tip on git shallow clone. As you know, some repository are really really large, such as emacs and linux. Cloning is slow and unstable. And there is no way to pause and resume a git clone. So I use shallow clone to clone them. But what if I want to clone other branches?</p>
<p>From here: http://stackoverflow.com/a/27393574/2148614</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2016/04/03/tips-on-git-shallow-clone/#__codelineno-0-1"></a>git remote set-branches origin &#39;*&#39;
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../programming/2016/04/03/tips-on-git-shallow-clone/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2016-03-09 00:00:00">2016年3月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="some-interesting-links"><a class="toclink" href="../../programming/2016/03/09/some-interesting-links/">Some interesting links</a></h2>
<p>I'm here to share some interesting links. I do not have much time writing the blog now.</p>
<p>Recently I have been working on CodeFalling/MacGesture on Github. If you are interested in it, go and have a look.</p>
<p>Here are the links to share:
https://twitter.com/PoolpOrg/status/694593152670437376
https://github.com/wellle/targets.vim
http://thecodelesscode.com/case/225
https://twitter.com/zhangyuze320602/status/706457155763712000</p>
<p>I have done reading the biography of Steve Jobs. Great book.</p>

    <nav class="md-post__action">
      <a href="../../programming/2016/03/09/some-interesting-links/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../others/" class="md-footer__link md-footer__link--prev" aria-label="上一页: others" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                others
              </div>
            </div>
          </a>
        
        
          
          <a href="../software/" class="md-footer__link md-footer__link--next" aria-label="下一页: software" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                software
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.4e31edb1.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
        
      
    
  </body>
</html>