
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维,编程,调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/category/networking/">
      
      
        <link rel="prev" href="../misc/">
      
      
        <link rel="next" href="../news/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0">
    
    
      
        <title>networking - 杰哥的{运维,编程,调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0c456da8.min.css">
      
      

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#networking" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              networking
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../archive/2023/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    networking
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    生成树协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    软硬件队列接口
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transport-layer-interface" class="md-nav__link">
    Transport Layer Interface 考古
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linksys-e8450-openwrt-ubi" class="md-nav__link">
    升级 Linksys E8450 的 OpenWRT 系统到 UBI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esxi" class="md-nav__link">
    ESXi 网络配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-udp-checksum" class="md-nav__link">
    IP 和 UDP Checksum 的增量更新问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openwrt-gandi-ddns" class="md-nav__link">
    OpenWRT 上配置 Gandi DDNS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etc" class="md-nav__link">
    ETC 比赛无线网络搭建小记
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veth-ipv6-only-brouter" class="md-nav__link">
    使用 veth 实现 IPv6-only 的 Brouter 功能
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android-lte-ipv6" class="md-nav__link">
    在 Android 上打开 LTE 的 IPv6
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ledeopenwrt-wpad" class="md-nav__link">
    在 LEDE（OpenWrt）上启用 wpad
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ipfilter-extension-rfc8367" class="md-nav__link">
    通过 Ipfilter Extension 实现 RFC8367
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#macos-tap-interface-ipv6" class="md-nav__link">
    在 macOS 上 TAP Interface 上启用 IPv6 自动配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#macos-gretap" class="md-nav__link">
    在 macOS 下实现 GRETAP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wireguard-overlay-network-babel" class="md-nav__link">
    在 WireGuard 构建的 Overlay Network 上跑 babel 路由协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lenovo-y1s-openwrt-17015-ipv6-bridge" class="md-nav__link">
    向 Lenovo y1s 刷入 OpenWRT 17.01.5 固件，并把 IPv6 bridge 到内网中和配置认证脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multicast" class="md-nav__link">
    用 multicast 地址找到同一网段的主机
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iptables-demux" class="md-nav__link">
    通过 iptables 在同一个端口根据源地址解复用（demux）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wireguard" class="md-nav__link">
    Wireguard 隧道搭建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#macos-linux-tinc" class="md-nav__link">
    在 macOS 和 Linux 之间搭建 tinc 网络
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ftp-server-behind-nat" class="md-nav__link">
    搭建 FTP server behind NAT
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-vmware-esxi" class="md-nav__link">
    使用 Nginx 转发 VMware ESXi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iptables-forwarding" class="md-nav__link">
    使用 iptables 和策略路由进行带源地址的 forwarding
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upnp-mosh-nat" class="md-nav__link">
    利用 UPnP 协议进行 mosh NAT 穿透的研究
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cisco-ac-ap" class="md-nav__link">
    使用 Cisco AC + AP 组合搭建网络实践
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nat64" class="md-nav__link">
    NAT64 初尝试
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="networking">networking</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-20 00:00:00">2023年6月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../networking/2023/06/20/spanning-tree-protocol/">生成树协议</a></h2>
<h3 id="spanning-tree-protocol"><a class="toclink" href="../../networking/2023/06/20/spanning-tree-protocol/#spanning-tree-protocol">Spanning Tree Protocol</a></h3>
<p>STP（Spanning Tree Protocol）可以在 <a href="https://ieeexplore.ieee.org/document/1389253">802.1D-1998</a> 第 8 章中找到。STP 协议工作在交换机上，需要根据交换机连接的拓扑，自动计算出一个生成树，并且把不在生成树上的边禁用，这样即使连接的拓扑有环路，禁用以后就没有环了。有了 STP 以后，连接交换机的时候就可以刻意连成环，从而提供冗余。</p>

    <nav class="md-post__action">
      <a href="../../networking/2023/06/20/spanning-tree-protocol/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-22 00:00:00">2023年3月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 27 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/">软硬件队列接口</a></h2>
<h3 id="_2"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_2">背景</a></h3>
<p>在网卡等场景下，经常会需要在软硬件之间传输大量的数据，通常的方法是建立循环队列，例如 H2C（Host to Chip）方向，是 Host 作为 Producer 增加数据到队尾，Chip 作为 Consumer 从队头读取数据。由于每次传输的数据不定长，为了方便，队列的项是一个定长的 Descriptor，Descriptor 指向了数据的地址。但具体的细节，不同的实现还不太一样。下面逐个案例进行分析。</p>
<h3 id="axi-dma"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#axi-dma">AXI DMA</a></h3>
<p>文档：<a href="https://docs.xilinx.com/r/en-US/pg021_axi_dma">https://docs.xilinx.com/r/en-US/pg021_axi_dma</a></p>
<p>如果在 Xilinx FPGA 上使用过以太网，那大概率会接触到 AXI DMA 这个 IP，它负责把以太网 MAC 的 AXI Stream 数据用 DMA 的形式通过内存来与操作系统交互。</p>
<h4 id="_3"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_3">发送队列</a></h4>
<p>它的收和发各是一个队列，首先来看发送队列：</p>
<p>发送队列由一个头指针（MM2S_CURDESC）和一个尾指针定义（MM2S_TAILDESC），指针指向的是一个 Scatter Gather Descriptor，Descriptor 的内容包括：</p>
<ul>
<li>NXTDESC：队列下一项的地址</li>
<li>BUFFER_ADDRESS：要传输的数据的地址</li>
<li>CONTROL：控制信息</li>
<li>STATUS：状态信息</li>
<li>APP0 to APP4：附带的信息</li>
</ul>
<p>可见这个发送队列实际上是一个链表：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">axi_dma_desc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-2"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">axi_dma_desc</span><span class="w"> </span><span class="o">*</span><span class="n">nxtdesc</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-3"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer_address</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-4"></a><span class="w">  </span><span class="c1">// omitted</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-5"></a><span class="p">};</span>
</span></code></pre></div>
<p>当 MM2S_TAILDESC 被更新的时候，硬件会从 CURDESC 开始逐个 Descriptor 处理，直到遇到 TAILDESC 为止：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-1"></a><span class="c1">// when taildesc is changed</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">taildesc_changed</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-3"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-4"></a><span class="w">    </span><span class="n">dma_send</span><span class="p">(</span><span class="n">curdesc</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curdesc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">taildesc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-6"></a><span class="w">      </span><span class="n">curdesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curdesc</span><span class="o">-&gt;</span><span class="n">nxtdesc</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-8"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">curdesc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">taildesc</span><span class="p">);</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>所以，实际上是驱动不断地提供一个链表给 AXI DMA 去发送，至于这个链表是只有一个元素的数组，还是用一个循环队列去实现，都是可能的。</p>
<h5 id="u-boot"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#u-boot">U-Boot</a></h5>
<p>下面来看 U-Boot 的例子，驱动是 <a href="https://github.com/u-boot/u-boot/blob/v2023.01/drivers/net/xilinx_axi_emac.c">xilinx_axi_emac.c</a>。这个驱动的实现很简单：每次需要发送的时候，只准备一个 Descriptor，发完就轮询直到发送成功。显然这个写法没有很好地利用 DMA 的异步特性，但胜在简单。下面是 <code>axiemac_send</code> 的部分源码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_send</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-2"></a><span class="w">  </span><span class="cm">/* Setup Tx BD */</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-3"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_bd</span><span class="p">));</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-4"></a><span class="w">  </span><span class="cm">/* At the end of the ring, link the last BD back to the top */</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-5"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">next_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">);</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-6"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">next_desc_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">);</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-7"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">buf_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-8"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">buf_addr_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-9"></a><span class="w">  </span><span class="cm">/* Save len */</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-10"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_TXSOF_MASK</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-11"></a><span class="w">            </span><span class="n">XAXIDMA_BD_CTRL_TXEOF_MASK</span><span class="p">;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-13"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">);</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-15"></a><span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-16"></a><span class="w">  </span><span class="cm">/* Start the hardware */</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-17"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-18"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-19"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-21"></a><span class="w">  </span><span class="cm">/* Start transfer */</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-22"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-23"></a>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-24"></a><span class="w">  </span><span class="cm">/* Wait for transmission to complete */</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-25"></a><span class="w">  </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;axiemac: Waiting for tx to be done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-26"></a><span class="w">  </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-27"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-28"></a><span class="w">      </span><span class="p">(</span><span class="n">XAXIDMA_IRQ_DELAY_MASK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">XAXIDMA_IRQ_IOC_MASK</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-29"></a><span class="w">    </span><span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-30"></a><span class="w">    </span><span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-31"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-32"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="linux"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#linux">Linux</a></h5>
<p>再来看 Linux 的 驱动：<a href="https://github.com/torvalds/linux/blob/v6.2/drivers/net/ethernet/xilinx/xilinx_axienet_main.c">xilinx_axienet_main.c</a>。它采取的方法是分配一个 Descriptor 数组，然后把数组的每一项都指向下一项（最后一项指向第一项），形成一个链表形式的循环队列，维护一个尾指针。下面是初始化代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_dma_bd_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">ndev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-2"></a><span class="w">  </span><span class="cm">/* Allocate the Tx and Rx buffer descriptors. */</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-3"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-4"></a><span class="w">           </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-5"></a><span class="w">           </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-7"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-8"></a><span class="w">    </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-9"></a><span class="w">          </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-10"></a><span class="w">          </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">);</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-12"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-13"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-14"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-16"></a><span class="w">  </span><span class="cm">/* Write to the RS (Run-stop) bit in the Tx channel control register.</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-17"></a><span class="cm">   * Tx channel is now ready to run. But only after we write to the</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-18"></a><span class="cm">   * tail pointer register that the Tx channel will start transmitting.</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-19"></a><span class="cm">   */</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-20"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_TX_CDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="p">);</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-21"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_cr</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-22"></a><span class="w">  </span><span class="n">axienet_dma_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_TX_CR_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_cr</span><span class="p">);</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>初始化好了以后，每当要发送数据的时候，就写入 tail 指针指向的 Descriptor，然后增加 tail 指针，同时告诉硬件开始 DMA：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="n">netdev_tx_t</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-2"></a><span class="nf">axienet_start_xmit</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">ndev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-3"></a><span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="n">num_frag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">axienet_check_tx_bd_space</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">num_frag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-8"></a><span class="w">  </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-9"></a><span class="w">            </span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span><span class="w"> </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-10"></a><span class="w">  </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-11"></a><span class="w">  </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_TXSOF_MASK</span><span class="p">;</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-13"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_frag</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">)</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-15"></a><span class="w">      </span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-16"></a><span class="w">    </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">new_tail_ptr</span><span class="p">];</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-17"></a><span class="w">    </span><span class="n">frag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-18"></a><span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-19"></a><span class="w">              </span><span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-20"></a><span class="w">              </span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-21"></a><span class="w">              </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-22"></a><span class="w">    </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-23"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-24"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-26"></a><span class="w">  </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_TXEOF_MASK</span><span class="p">;</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-27"></a><span class="w">  </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-29"></a><span class="w">  </span><span class="n">tail_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">new_tail_ptr</span><span class="p">;</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-30"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">)</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-31"></a><span class="w">    </span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-32"></a><span class="w">  </span><span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="p">,</span><span class="w"> </span><span class="n">new_tail_ptr</span><span class="p">);</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-33"></a>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-34"></a><span class="w">  </span><span class="cm">/* Start the transfer */</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-35"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_TX_TDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">tail_p</span><span class="p">);</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-36"></a><span class="p">}</span>
</span></code></pre></div>
<p>实现思路：</p>
<ol>
<li>检查是否有足够的空闲 Descriptor</li>
<li>对于要发送的数据的每一段，都填入一个 Descriptor</li>
<li>写入新的 tail 指针，启动 DMA</li>
</ol>
<p>那么，又有一个问题：如何知道硬件完成了 DMA 传输，释放了 Descriptor 呢？答案是，AXI DMA 传输完成时，会通过中断通知 CPU，Linux 最终会调用 <code>axienet_free_tx_chain</code> 函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_free_tx_chain</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">axienet_local</span><span class="w"> </span><span class="o">*</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">first_bd</span><span class="p">,</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-2"></a><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_bds</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">sizep</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">axidma_bd</span><span class="w"> </span><span class="o">*</span><span class="n">cur_p</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-5"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-6"></a><span class="w">  </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-7"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-9"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_bds</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-10"></a><span class="w">    </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[(</span><span class="n">first_bd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">];</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-11"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-13"></a><span class="w">    </span><span class="cm">/* If force is not specified, clean up only descriptors</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-14"></a><span class="cm">     * that have been completed by the MAC.</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-15"></a><span class="cm">     */</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_COMPLETE_MASK</span><span class="p">))</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-17"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-19"></a><span class="w">    </span><span class="cm">/* Ensure we see complete descriptor update */</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-20"></a><span class="w">    </span><span class="n">dma_rmb</span><span class="p">();</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-21"></a><span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc_get_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-22"></a><span class="w">    </span><span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-23"></a><span class="w">         </span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_LENGTH_MASK</span><span class="p">),</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-24"></a><span class="w">         </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_COMPLETE_MASK</span><span class="p">))</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-27"></a><span class="w">      </span><span class="n">napi_consume_skb</span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">budget</span><span class="p">);</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-28"></a>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-29"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-30"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-31"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-32"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-33"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-34"></a><span class="w">    </span><span class="cm">/* ensure our transmit path and device don&#39;t prematurely see status cleared */</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-35"></a><span class="w">    </span><span class="n">wmb</span><span class="p">();</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-36"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-37"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-38"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-39"></a>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-40"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-41"></a><span class="p">}</span>
</span></code></pre></div>
<p>从代码来看，其实也很简单：AXI DMA 传输完成后，会设置 status 的内容，标记已经传输完成。这时候只要从最后一次完成传输的 Descriptor 开始扫描，把所有完成传输的 Descriptor 回收即可。</p>
<h4 id="_4"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_4">接收队列</a></h4>
<p>接收队列结构与发送队列相似，但不同的是，生产者和消费者的角色对调，驱动为了保证随时可以接收数据，需要预先准备好 Descriptor，当 AXI DMA 从以太网 MAC 收到数据的时候，随时有 Descriptor 可以使用，写入数据后，再通知 CPU。和发送队列一样，接收队列由一个头指针（S2MM_CURDESC）和一个尾指针定义（S2MM_TAILDESC），指针指向的 Descriptor 结构与发送队列一致。硬件的接收逻辑和发送逻辑类似，只不过方向相反。</p>
<h5 id="u-boot_1"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#u-boot_1">U-Boot</a></h5>
<p>首先还是来看 U-Boot 的实现。前面提到，为了简化，U-Boot 的网卡驱动每次同时只会发送一个帧，接收的时候其实也一样：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-1"></a><span class="p">(</span><span class="n">some</span><span class="w"> </span><span class="n">net</span><span class="w"> </span><span class="n">operation</span><span class="w"> </span><span class="p">(</span><span class="n">ping</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tftp</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">whatever</span><span class="p">...))</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-2"></a><span class="n">eth_init</span><span class="p">()</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-3"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">()</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-4"></a><span class="n">eth_send</span><span class="p">()</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-5"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">()</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-6"></a><span class="n">eth_rx</span><span class="p">()</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-7"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">()</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-8"></a><span class="w">  </span><span class="p">(</span><span class="n">process</span><span class="w"> </span><span class="n">packet</span><span class="p">)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-9"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_pkt</span><span class="p">)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-10"></a><span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_pkt</span><span class="p">()</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-11"></a><span class="n">eth_halt</span><span class="p">()</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-12"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">()</span>
</span></code></pre></div>
<p>首先看 AXI EMAC 驱动如何初始化接收队列：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-1"></a><span class="k">static</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">rxframe</span><span class="p">[</span><span class="n">PKTSIZE_ALIGN</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">DMAALIGN</span><span class="p">)));</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_start</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-4"></a><span class="w">  </span><span class="cm">/* Start DMA RX channel. Now it&#39;s ready to receive data.*/</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-5"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-7"></a><span class="w">  </span><span class="cm">/* Setup the BD. */</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-8"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-9"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-10"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-11"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-12"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-13"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-14"></a><span class="w">  </span><span class="cm">/* Flush the last BD so DMA core could see the updates */</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-15"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-16"></a>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-17"></a><span class="w">  </span><span class="cm">/* It is necessary to flush rxframe because if you don&#39;t do it</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-18"></a><span class="cm">   * then cache can contain uninitialized data */</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-19"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">));</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-20"></a>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-21"></a><span class="w">  </span><span class="cm">/* Start the hardware */</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-22"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-23"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-24"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-25"></a>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-26"></a><span class="w">  </span><span class="cm">/* Rx BD is ready - start */</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-27"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-28"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到它只初始化了一个 Descriptor，并且把 CURDESC 和 TAILDESC 都指向它，并且提供了一个缓冲区 <code>rxframe</code>。当 AXI DMA 接收到数据的时候，就会把数据写入 <code>rxframe</code>，更新 <code>rx_bd</code> 并发送中断。U-Boot 处理中断的方法也很简单：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_recv</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">**</span><span class="n">packetp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-2"></a><span class="w">  </span><span class="cm">/* Disable IRQ for a moment till packet is handled */</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-3"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-4"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">XAXIDMA_IRQ_ALL_MASK</span><span class="p">;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-5"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-7"></a><span class="w">  </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_ACTUAL_LEN_MASK</span><span class="p">;</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-8"></a><span class="w">  </span><span class="o">*</span><span class="n">packetp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rxframe</span><span class="p">;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-9"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>它关闭了 AXI DMA 的中断，然后直接读取长度，把 <code>rxframe</code> 作为数据指针传给网络栈处理的函数。网络栈处理完以后，就会调用 <code>free_pkt</code> 进行收尾：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_free_pkt</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-2"></a><span class="cp">##ifdef DEBUG</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-3"></a><span class="w">  </span><span class="cm">/* It is useful to clear buffer to be sure that it is consistent */</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-4"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">rxframe</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">));</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-5"></a><span class="cp">##endif</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-6"></a><span class="w">  </span><span class="cm">/* Setup RxBD */</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-7"></a><span class="w">  </span><span class="cm">/* Clear the whole buffer and setup it again - all flags are cleared */</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-8"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-9"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-10"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-11"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-12"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-13"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-15"></a><span class="w">  </span><span class="cm">/* Write bd to HW */</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-16"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-18"></a><span class="w">  </span><span class="cm">/* It is necessary to flush rxframe because if you don&#39;t do it</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-19"></a><span class="cm">   * then cache will contain previous packet */</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-20"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">));</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-21"></a>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-22"></a><span class="w">  </span><span class="cm">/* Rx BD is ready - start again */</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-23"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>收尾工作也很简单，把接收队列恢复到可以接收数据的状态即可，因为 <code>rxframe</code> 是全局变量，也不需要进行 <code>free</code>。</p>
<h5 id="linux_1"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#linux_1">Linux</a></h5>
<p>Linux 的驱动实现里，接收队列和发送队列类似，也是用一个数组来实现循环链表，只不过接收队列还需要提前准备好缓冲区，供 AXI DMA 写入：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_dma_bd_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">ndev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-2"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-3"></a><span class="w">           </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">,</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-4"></a><span class="w">           </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-5"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-6"></a><span class="w">    </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-8"></a><span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-9"></a><span class="w">      </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">);</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-10"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-11"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-12"></a>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-13"></a><span class="w">    </span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">);</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-14"></a>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-15"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-16"></a><span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-17"></a><span class="w">              </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">,</span><span class="w"> </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-18"></a><span class="w">    </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-19"></a>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-20"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">;</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-21"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-23"></a><span class="w">  </span><span class="cm">/* Populate the tail pointer and bring the Rx Axi DMA engine out of</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-24"></a><span class="cm">   * halted state. This will make the Rx side ready for reception.</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-25"></a><span class="cm">   */</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-26"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_CDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="p">);</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-27"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_cr</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-28"></a><span class="w">  </span><span class="n">axienet_dma_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_CR_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_cr</span><span class="p">);</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-29"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_TDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-30"></a><span class="w">           </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)));</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-31"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，数组的每一项的指针指向下一项，然后把头地址写入 CURDESC，尾地址写入 TAILDESC，这样硬件就可以开始接收数据。AXI DMA 收到数据以后，会把数据写入 Descriptor 指向的缓冲区地址，然后发送中断，Linux 执行下列代码处理中断：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_rx_poll</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">napi_struct</span><span class="w"> </span><span class="o">*</span><span class="n">napi</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-2"></a><span class="w">  </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">];</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-4"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">packets</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">budget</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_COMPLETE_MASK</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-5"></a><span class="w">    </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-7"></a><span class="w">    </span><span class="cm">/* Ensure we see complete descriptor update */</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-8"></a><span class="w">    </span><span class="n">dma_rmb</span><span class="p">();</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-10"></a><span class="w">    </span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-11"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-12"></a>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-13"></a><span class="w">    </span><span class="cm">/* skb could be NULL if a previous pass already received the</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-14"></a><span class="cm">     * packet for this slot in the ring, but failed to refill it</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-15"></a><span class="cm">     * with a newly allocated buffer. In this case, don&#39;t try to</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-16"></a><span class="cm">     * receive it again.</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-17"></a><span class="cm">     */</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-19"></a><span class="w">      </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000FFFF</span><span class="p">;</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-20"></a>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-21"></a><span class="w">      </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc_get_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-22"></a><span class="w">      </span><span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">,</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-23"></a><span class="w">           </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-25"></a><span class="w">      </span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-26"></a><span class="w">      </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-27"></a>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-28"></a><span class="w">      </span><span class="n">napi_gro_receive</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">);</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-29"></a>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-30"></a><span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-31"></a><span class="w">      </span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-33"></a>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-34"></a><span class="w">    </span><span class="n">new_skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">napi_alloc_skb</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">);</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-35"></a>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-36"></a><span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-37"></a><span class="w">              </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">,</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-38"></a><span class="w">              </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-39"></a><span class="w">    </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-40"></a>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-41"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">;</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-42"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-43"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_skb</span><span class="p">;</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-44"></a>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-45"></a><span class="w">    </span><span class="cm">/* Only update tail_p to mark this slot as usable after it has</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-46"></a><span class="cm">     * been successfully refilled.</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-47"></a><span class="cm">     */</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-48"></a><span class="w">    </span><span class="n">tail_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">;</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-49"></a>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-50"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">)</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-51"></a><span class="w">      </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-52"></a><span class="w">    </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">];</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-53"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-54"></a>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-55"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tail_p</span><span class="p">)</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-56"></a><span class="w">    </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_TDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">tail_p</span><span class="p">);</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-57"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，接收逻辑顺序扫描了 Descriptor，找到那些传输完成的，把其中的数据交给网络栈处理，然后分配一个新的 skb，绑定到 Descriptor 上，把它恢复到可以接收数据的状态，最后更新 TAILDESC。</p>
<h4 id="_5"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_5">小结</a></h4>
<p>AXI DMA 提供了一个 Descriptor 链来异步地传输数据，U-Boot 为了简化，把链表退化成只有一个节点，串行地收和发；Linux 使用数组实现了一个循环的链表，通过 TAILDESC 提供新的 Descriptor，然后从 CURDESC 回收 Descriptor。Descriptor 不断在硬件和软件之间交替，CURDESC 到 TAILDESC 的部分归硬件，其余的归软件。这种设计模式在其他很多地方也可以看到。</p>
<h3 id="intel-82599"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#intel-82599">Intel 82599</a></h3>
<p>Intel 82599 是一个有线网卡，Linux 的驱动是 ixgbe。Intel 82599 为收和发都提供了多个队列，每个队列都对应了一个 Descriptor 数组，在内存中连续存放。Linux 驱动使用了 64 个接收队列和发送队列。</p>
<p>文档链接：<a href="https://cdrdv2-public.intel.com/331520/82599-datasheet-v3-4.pdf">https://cdrdv2-public.intel.com/331520/82599-datasheet-v3-4.pdf</a></p>
<h4 id="_6"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_6">接收队列</a></h4>
<p>和 AXI DMA 的链表形式不同。每个接收队列都由如下的寄存器定义：</p>
<ul>
<li>RDBAL/RDBAH[n]: Receive Descriptor Base Address Low/High</li>
<li>RDLEN[n]: Receive Descriptor Length</li>
<li>RDH[n]: Receive Descriptor Head</li>
<li>RDT[n]: Receive Descriptor Tail</li>
</ul>
<p>由基地址 + 长度定义了一个循环队列，然后从 Head 到 Tail 的部分是当前有效的队列，软件从 Tail 插入新的 Descriptor，硬件从 Head 取 Descriptor。当 Head 等于 Tail 的时候，队列是空的，也就是说 Tail 表示的是合法的下一个，这样队列满的时候 Tail + 1 == Head。</p>
<p>ixgbe 的实现代码在 <code>ixgbe_main.c</code> 中，首先看如何初始化接收队列：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ixgbe_configure_rx</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-2"></a><span class="w">  </span><span class="cm">/*</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-3"></a><span class="cm">   * Setup the HW Rx Head and Tail Descriptor Pointers and</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-4"></a><span class="cm">   * the Base and Length of the Rx Descriptor Ring</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-5"></a><span class="cm">   */</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-6"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-7"></a><span class="w">    </span><span class="n">ixgbe_configure_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-8"></a><span class="p">}</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ixgbe_configure_rx_ring</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-11"></a><span class="w">           </span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_ring</span><span class="w"> </span><span class="o">*</span><span class="n">ring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-12"></a><span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">rdba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-13"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDBAL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">rdba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-14"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDBAH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">rdba</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">));</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-15"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDLEN</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-16"></a><span class="w">      </span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span><span class="w"> </span><span class="nc">ixgbe_adv_rx_desc</span><span class="p">));</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-18"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-19"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-20"></a><span class="w">  </span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">IXGBE_RDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">);</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-21"></a>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-22"></a><span class="w">  </span><span class="cm">/* enable receive descriptor ring */</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-23"></a><span class="w">  </span><span class="n">rxdctl</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">IXGBE_RXDCTL_ENABLE</span><span class="p">;</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-24"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="n">rxdctl</span><span class="p">);</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-25"></a>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-26"></a><span class="w">  </span><span class="cm">/* in ixgbe_alloc_rx_buffers */</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-27"></a><span class="w">  </span><span class="n">bufsz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-29"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ixgbe_alloc_mapped_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span><span class="w"> </span><span class="n">bi</span><span class="p">))</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-31"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-32"></a>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-33"></a><span class="w">    </span><span class="cm">/* sync the buffer for use by the device */</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-34"></a><span class="w">    </span><span class="n">dma_sync_single_range_for_device</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-35"></a><span class="w">             </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span><span class="w"> </span><span class="n">bufsz</span><span class="p">,</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-36"></a><span class="w">             </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-37"></a>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-38"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-39"></a><span class="cm">     * Refresh the desc even if buffer_addrs didn&#39;t change</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-40"></a><span class="cm">     * because each write-back erases this info.</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-41"></a><span class="cm">     */</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-42"></a><span class="w">    </span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">pkt_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">);</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-43"></a>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-44"></a><span class="w">    </span><span class="n">rx_desc</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-45"></a><span class="w">    </span><span class="cm">/* clear the length for the next_to_use descriptor */</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-46"></a><span class="w">    </span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">upper</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-47"></a>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-48"></a><span class="w">    </span><span class="n">cleaned_count</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-49"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cleaned_count</span><span class="p">);</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-50"></a>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-51"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-52"></a><span class="p">}</span>
</span></code></pre></div>
<p>具体到实现上，可以看到和 AXI DMA 驱动基本是一样的：分配 Descriptor 数组空间，然后给每个 Descriptor 分配一个 Buffer，然后更新 tail 指针，让硬件可以开始进行接收。</p>
<h4 id="_7"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_7">发送队列</a></h4>
<p>发送队列和接收队列类似，也是先分配好 Descriptor 数组，只不过先不填内容，等到要发送数据的时候，再从 tail 取出一个 Descriptor，写入 buffer 地址，然后更新 tail 指针让硬件发送。代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-1"></a><span class="n">netdev_tx_t</span><span class="w"> </span><span class="nf">ixgbe_xmit_frame_ring</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-2"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-3"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_ring</span><span class="w"> </span><span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-4"></a><span class="w">  </span><span class="cm">/* record the location of the first descriptor for this packet */</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-5"></a><span class="w">  </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">];</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-6"></a><span class="w">  </span><span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-7"></a><span class="w">  </span><span class="n">first</span><span class="o">-&gt;</span><span class="n">bytecount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-9"></a><span class="w">  </span><span class="cm">/* in ixgbe_tx_map */</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-10"></a><span class="w">  </span><span class="n">dma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-12"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">frag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];;</span><span class="w"> </span><span class="n">frag</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">dma</span><span class="p">))</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-14"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">dma_error</span><span class="p">;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-16"></a><span class="w">    </span><span class="cm">/* record length, and DMA address */</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-17"></a><span class="w">    </span><span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-18"></a><span class="w">    </span><span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">dma</span><span class="p">,</span><span class="w"> </span><span class="n">dma</span><span class="p">);</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-19"></a>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-20"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buffer_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-21"></a>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-22"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-23"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">cmd_type_len</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-24"></a><span class="w">        </span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_type</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">);</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-25"></a>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-26"></a><span class="w">      </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-27"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-28"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-29"></a><span class="w">        </span><span class="n">tx_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-30"></a><span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-31"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-32"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">olinfo_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-33"></a>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-34"></a><span class="w">      </span><span class="n">dma</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">;</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-35"></a><span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">;</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-36"></a>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-37"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buffer_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-39"></a>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-40"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">cmd_type_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_type</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-41"></a>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-42"></a><span class="w">    </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-43"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-45"></a><span class="w">      </span><span class="n">tx_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-46"></a><span class="w">      </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-48"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">olinfo_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-49"></a>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-50"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-51"></a><span class="w">    </span><span class="n">data_len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-52"></a>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-53"></a><span class="w">    </span><span class="n">dma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">frag</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-54"></a><span class="w">               </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-55"></a>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-56"></a><span class="w">    </span><span class="n">tx_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-57"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-58"></a>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-59"></a><span class="w">  </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-60"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-61"></a><span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-62"></a>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-63"></a><span class="w">  </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-64"></a>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-65"></a><span class="w">  </span><span class="n">ixgbe_maybe_stop_tx</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span><span class="w"> </span><span class="n">DESC_NEEDED</span><span class="p">);</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-66"></a>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-67"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">netif_xmit_stopped</span><span class="p">(</span><span class="n">txring_txq</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">netdev_xmit_more</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-68"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-69"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-70"></a><span class="p">}</span>
</span></code></pre></div>
<p>这一段代码的思路是，对于 skb 的每个 frag，尝试填入 Descriptor，如果发现填不下，就填多个，直到填完位置，最后更新 tail 指针，让硬件开始发送。</p>
<h4 id="_8"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_8">小结</a></h4>
<p>在了解 AXI DMA 的工作原理的基础上，Intel 82599 的队列其实也不复杂，只不过直接采取了以 Descriptor 数组作为循环队列的方式，并且这里归属于硬件的 Descriptor 空间其实是 [Head, Tail) 左闭右开区间的形式（AXI DMA 是链表的头和尾，都属于硬件），这样就可以用 Head == Tail 来表示空队列，当然了，队列也永远会差一项才能满（除非额外记录队列中合法元素个数）。最后贴一张 Intel 82599 Datasheet 中的图片来帮助理解：</p>
<p><img alt="" src="/images/82599_queue.png" /></p>
<h3 id="connectx-4"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#connectx-4">ConnectX-4</a></h3>
<p>接下来看看 ConnectX-4 是如何设计它的各个队列的。首先，它有 Work Queue，用于发送数据（Send Queue）和准备接收数据的缓冲区（Receive Queue），然后硬件处理 Work Queue 中的 Entry 后，就会把结果写入到 Completion Queue，并且通过 Event Queue 通知 CPU。</p>
<p>文档：<a href="https://network.nvidia.com/files/doc-2020/ethernet-adapters-programming-manual.pdf">https://network.nvidia.com/files/doc-2020/ethernet-adapters-programming-manual.pdf</a></p>
<h4 id="work-queue"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#work-queue">Work Queue</a></h4>
<p>Work Queue 和前面 Intel 82599 的设计很像，也是一个 Descriptor 的数组的形式，只不过 Work Queue Entry 是不定长的，支持不同的 Entry Format，例如 Send WQE、Receive WQE 和 Shared Receive WQE。</p>
<p>驱动初始化的时候，创建好 Work Queue：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">mlx5e_open_queues</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5e_channel</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">,</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-2"></a><span class="w">           </span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5e_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">,</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-3"></a><span class="w">           </span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5e_channel_param</span><span class="w"> </span><span class="o">*</span><span class="n">cparam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-4"></a><span class="w">  </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mlx5e_open_sqs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">cparam</span><span class="p">);</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-6"></a><span class="w">  </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mlx5e_open_rxq_rq</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cparam</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>之后，和 Intel 82599 类似，发送的时候就向 Send Queue 插入 Entry，然后更新 Doorbell 让硬件开始发送；为了接收，先分配好缓冲区，初始化 Receive Queue，更新 Doorbell 让硬件开始接收数据。</p>
<h4 id="completion-queue"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#completion-queue">Completion Queue</a></h4>
<p>和 Intel 82599 不同的是，这里表示项目完成是通过 Completion Queue 完成的，也就是说，硬件会向 Completion Queue 插入一项，来表示对应的 Work Queue Entry 完成情况。这样的设计下，Work Queue 完全由软件写入，Completion Queue 完全由硬件写入，不像前面 AXI DMA 和 Intel 82599 那样硬件会更新 Descriptor 里面的状态位。Completion Queue 也有两个 Counter，相当于队列的头和尾指针：Producer Counter 记录了硬件写入的 Completion Queue Entry（CQE）数量，Consumer Counter 记录了软件已经处理了的 CQE 数量。在这里有一个比较有意思的设计：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-1"></a><span class="n">ownership</span><span class="w"> </span><span class="nf">cqe_ownership</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">((</span><span class="n">consumer_counter</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">log2_cq_size</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SW</span><span class="w"> </span><span class="n">ownership</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-4"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HW</span><span class="w"> </span><span class="n">ownership</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它根据 consumer_counter 的当前值的高位（mask 掉 CQ 大小对应的 bits）与 CQE 的 owner 字段进行比对，如果相等，就认为是属于软件；否则则是属于硬件。软件在轮询的时候，只有遇到 SW ownership 的 CQE 才会处理，否则就忽略。乍一看，这个设计挺奇怪的，因为溢出的问题，<code>((consumer_counter &gt;&gt; log2_cq_size) &amp; 1)</code> 每次溢出就会取反，所以相应的 ownership 的对应关系也会取反。回想一下，之前 AXI DMA 的做法，接收的时候，软件设置一个状态位，硬件完成接收以后，也设置一个状态位，软件完成处理以后，再恢复状态位为可以接收的状态，这样来回操作比较麻烦。在 ConnectX-4 的这种设计下，硬件只需要在填 CQE 的时候，toggle 一下 owner 位即可，软件不需要修改内容，只需要修改 consumer_counter。</p>
<p>这样看可能比较迷糊，来拆解一下整个过程。首先是 AXI DMA 的接收队列的 Descriptor 的处理：</p>
<ol>
<li>软件设置 status = 0 表示这个 Descriptor 可以接收</li>
<li>硬件设置 status |= COMPLETED</li>
<li>软件读取 status 发现 COMPLETED，处理数据，然后重新设置 status = 0</li>
</ol>
<p>可以看到，Descriptor 的内容是软件和硬件来回修改。ConnectX-4 的设计下，软件不需要对 CQE 做任何修改：</p>
<ol>
<li>初始情况下，owner = 1 和 consumer_counter = 0，对应 HW owner，所以软件不会认为是合法的 CQE</li>
<li>硬件开始向 CQ 插入 CQE，此时 owner ^=1 变为 0，对应 SW owner，所以软件可以开始读取并处理 CQE</li>
<li>硬件不断插入，出现了第一次溢出，软件跟着处理，也第一次溢出了，此时 <code>((consumer_counter &gt;&gt; log2_cq_size) &amp; 1) = 1</code>，此时 1 对应 SW owner，0 对应 HW owner。当硬件插入 CQE 以后，owner 才从 0（HW owner）又变回 1（SW owner），软件就知道，可以继续读取并处理 CQE</li>
<li>这个过程继续下去，owner 的含义不断翻转</li>
</ol>
<p>可以看到，整个过程软件不需要写入 CQE 的内容，只需要不断轮询并更新 consumer_counter。硬件实现也很简单，不断地对 owner 进行异或，就实现了通知软件的功能。这就类似于，每当 counter 溢出的时候，就自动“清空”所有 CQE 的“valid”位，然后硬件再设置“valid = 1”。硬件只需要保证 producer_counter 不会追上 consumer_counter 就可以了，硬件也不需要去读取 CQE 的内容来判断软件是否处理完成。这个方式还是比较有意思的。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">get_sw_cqe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5_ib_cq</span><span class="w"> </span><span class="o">*</span><span class="n">cq</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-2"></a><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-3"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cqe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5_cqe64</span><span class="w"> </span><span class="o">*</span><span class="n">cqe64</span><span class="p">;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-6"></a><span class="w">  </span><span class="n">cqe64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cqe_sz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">cqe</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cqe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-7"></a>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">get_cqe_opcode</span><span class="p">(</span><span class="n">cqe64</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MLX5_CQE_INVALID</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-9"></a><span class="w">      </span><span class="o">!</span><span class="p">((</span><span class="n">cqe64</span><span class="o">-&gt;</span><span class="n">op_own</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MLX5_CQE_OWNER_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cqe</span><span class="p">;</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-11"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-13"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际上，写这篇博客就是因为有同学看到了 CQE 的 owner 的奇怪设定，我才来研究的这个问题。我就是为了这点醋，才包的这顿饺子，前面做了一大堆的引入。</p>
<h3 id="chatgpt"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#chatgpt">ChatGPT 时间</a></h3>
<p>问：What does network driver do to send/receive network packets to/from NIC?</p>
<p>答：A network driver is a software component that allows the operating system to communicate with the network interface card (NIC) and send and receive network packets. The NIC is a hardware device that connects a computer to a network and enables it to communicate with other devices on that network.</p>
<p>When the computer wants to send a network packet, the operating system hands the packet off to the network driver, which then converts it into a format that the NIC can understand. The network driver also sets the appropriate control bits and headers in the packet to ensure that it is correctly transmitted over the network.</p>
<p>When a network packet is received by the NIC, the network driver intercepts it and passes it on to the operating system. The network driver then verifies the packet's integrity, checks if it is destined for the local machine, and if so, hands it over to the appropriate application.</p>
<p>In summary, the network driver acts as a bridge between the operating system and the NIC, enabling the computer to send and receive network packets over the network.</p>
<p>问：Can you give me a detailed description? e.g. the ring buffer and notification mechanism</p>
<p>答：Sure, I can provide a more detailed description of how network drivers use ring buffers and notification mechanisms to send and receive network packets.</p>
<p>A ring buffer is a circular buffer that is used by the network driver to store incoming and outgoing network packets. The buffer is divided into multiple sections or "rings," each of which can hold one or more packets. The ring buffer is used to manage the flow of data between the network driver and the NIC.</p>
<p>When a packet is received by the NIC, it is stored in the receive ring buffer. The network driver then reads the packet from the ring buffer, processes it, and hands it over to the appropriate application.</p>
<p>When the computer wants to send a packet, the network driver first checks if there is space available in the transmit ring buffer. If there is, it writes the packet to the next available slot in the buffer and sets the appropriate control bits and headers.</p>
<p>The network driver then uses a notification mechanism to inform the NIC that there is data available in the transmit ring buffer. This notification mechanism can take different forms, depending on the specific hardware and driver implementation. For example, it might involve writing to a specific memory location or sending an interrupt signal to the NIC.</p>
<p>注：没听说过给 NIC 发送中断。</p>
<p>When the NIC receives the notification, it reads the packet from the transmit ring buffer and sends it over the network.</p>
<p>The ring buffer and notification mechanisms are critical components of network drivers because they enable efficient communication between the operating system and the NIC. By using a circular buffer, the driver can handle multiple packets at once and avoid the need for expensive memory allocations or deallocations. The notification mechanism allows the driver to inform the NIC of data availability without constantly polling the buffer, which would waste CPU cycles and reduce system performance.</p>
<p>注：这里说反了，应该是告诉网卡驱动有数据可用。</p>
<p>问：Can you take Xilinx AXI DMA for example?</p>
<p>答：Sure, let me provide an example of how the Xilinx AXI DMA uses a ring buffer and notification mechanism to send and receive network packets.</p>
<p>The Xilinx AXI DMA is a DMA controller that is commonly used in embedded systems to handle data transfers between a host processor and peripherals, including network interfaces. The AXI DMA uses a scatter-gather DMA engine, which means it can transfer data between non-contiguous memory regions.</p>
<p>In the context of network communication, the AXI DMA is typically used to transfer packets between the network interface card and the host memory. The AXI DMA driver sets up a ring buffer in host memory that is used to store incoming and outgoing packets.</p>
<p>When a packet is received by the NIC, it is stored in a receive ring buffer that is allocated in the host memory. The AXI DMA driver sets up the receive ring buffer and configures the AXI DMA to use it as the destination for incoming packets.</p>
<p>To enable the notification mechanism, the AXI DMA driver configures the AXI DMA to generate an interrupt when a packet is received and stored in the receive ring buffer. The interrupt is sent to the host processor, which then reads the packet from the receive ring buffer and processes it.</p>
<p>When the host processor wants to send a packet, it writes the packet data to a transmit ring buffer that is also allocated in host memory. The AXI DMA driver sets up the transmit ring buffer and configures the AXI DMA to use it as the source for outgoing packets.</p>
<p>To enable the notification mechanism for outgoing packets, the AXI DMA driver configures the AXI DMA to generate an interrupt when the transmit ring buffer is empty and ready to accept a new packet. This interrupt is sent to the host processor, which then writes the next packet to the transmit ring buffer.</p>
<p>The AXI DMA driver manages the ring buffers and interrupt handling to ensure that incoming and outgoing packets are processed efficiently and without data loss.</p>
<p>In summary, the Xilinx AXI DMA uses a ring buffer and notification mechanism to enable efficient transfer of network packets between the NIC and the host memory. The ring buffer is used to manage the flow of incoming and outgoing packets, while the notification mechanism enables the DMA engine to inform the host processor when new data is available or when the buffer is ready to accept new data.</p>
<p>问：How about Intel 82599? What's the difference between Intel 82599 and AXI DMA?</p>
<p>答：The Intel 82599 is a high-performance Ethernet controller that is commonly used in data center and cloud computing environments. Like the AXI DMA, the Intel 82599 also uses a ring buffer and notification mechanism to send and receive network packets.</p>
<p>However, there are some key differences between the Intel 82599 and the AXI DMA. The most significant difference is that the Intel 82599 is a hardware-based Ethernet controller, while the AXI DMA is a DMA controller that is typically used in embedded systems.</p>
<p>As a hardware-based Ethernet controller, the Intel 82599 is optimized for high-speed data transfer and advanced networking features. It includes hardware offloading capabilities that can offload tasks such as TCP/IP checksum calculation, packet segmentation, and packet filtering from the host CPU. This offloading reduces the CPU load and improves overall system performance.</p>
<p>The Intel 82599 uses multiple receive and transmit ring buffers to support parallel data processing and enable high-speed data transfer. The receive ring buffers are used to store incoming packets, while the transmit ring buffers are used to store outgoing packets.</p>
<p>The notification mechanism used by the Intel 82599 is called Interrupt Moderation. This mechanism is used to reduce the number of interrupts generated by the Ethernet controller and improve system efficiency. Interrupt Moderation groups multiple network packets together and generates a single interrupt to notify the host CPU that the packets are ready to be processed.</p>
<p>In summary, the Intel 82599 and the AXI DMA both use ring buffers and notification mechanisms to transfer network packets, but they differ in their design and application. The Intel 82599 is a high-performance Ethernet controller that is optimized for data center and cloud computing environments, while the AXI DMA is a DMA controller that is typically used in embedded systems. The Intel 82599 includes advanced networking features such as hardware offloading and Interrupt Moderation, which improve system performance and efficiency.</p>

    <nav class="md-post__action">
      <a href="../../networking/2023/03/22/hardware-queue-interface/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-12 00:00:00">2023年2月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="transport-layer-interface"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/">Transport Layer Interface 考古</a></h2>
<h3 id="transport-layer-interface_1"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#transport-layer-interface_1">Transport Layer Interface</a></h3>
<p>现在网络编程主要采用的是 BSD Sockets API，但实际上当年还有另一套 API，就是 TLI（Transport Layer Interface），后来 BSD Sockets 胜出，进入了 POSIX 标准，TLI 后面也标准化为了 XTI，现在可以在部分 Unix 系统中找到。TLI/XTI 的使用方法和 Sockets API 有些类似，但是比较特别的一点在于，Sockets API 第一步是 <code>socket</code> 调用，传的参数就决定了这是 TCP 还是 UDP 还是其他什么协议，而 TLI 是通过打开不同的设备文件来进行区分：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-0-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_open</span><span class="p">(</span><span class="s">&quot;/dev/udp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></div>
<p>比如 TCP 就是 <code>/dev/tcp</code>，UDP 就是 <code>/dev/udp</code>，同理还有 <code>/dev/icmp</code> 等等。这颇有 Unix 的哲学：everything is a file。而 BSD Sockets API 则是有对应的系统调用，libc 基本不需要做什么事情。</p>
<p>沿着这个思路，既然 TLI 第一步是打开一个文件，难道后面的一系列的 bind、connect、send、recv 等操作也是对文件读写吗？是的！如果我们查看 illumos 的<a href="https://github.com/illumos/illumos-gate/blob/46f52c84cb830d1636c093bd5c2d83074aeaf21c/usr/src/lib/libnsl/nsl/_conn_util.c#L76-L82">源码</a>，会发现 <code>t_connect</code> 函数的核心实现是：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-1"></a><span class="w">    </span><span class="n">creq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">T_conn_req</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ctlbufp</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-2"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">PRIM_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_CONN_REQ</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-3"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">DEST_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-4"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">DEST_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-5"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">OPT_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-6"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">OPT_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">putmsg</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ctlbufp</span><span class="p">,</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-9"></a><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">strbuf</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">len</span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">udata</span><span class="o">:</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-10"></a><span class="w">        </span><span class="n">t_errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TSYSERR</span><span class="p">;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-12"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，这段在 libnsl 中的代码构造了一个结构体 <code>struct T_conn_req</code>，然后通过 <code>putmsg</code> 系统调用发送出去。可以预想，内核那边虚拟了一个 <code>/dev/tcp</code> 设备，这个设备注册了 putmsg 的回调函数。在回调函数中，解析结构体的字段，然后执行相应的操作。用户调用 TLI 函数，然后 libnsl 负责把函数的参数封装成一个结构体，然后向 <code>t_open</code> 打开的设备文件发送结构体的内容。内核和 libnsl 约定好了结构体，然后不同的操作根据结构体的 <code>PRIM_type</code> 字段来区分。实际上，这个约定也是一个标准，叫做 TPI(Transport Provider Interface)。</p>
<h3 id="transport-provider-interface"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#transport-provider-interface">Transport Provider Interface</a></h3>
<p>TPI(Transport Provider Interface) 约定了内核和 libnsl 之间的接口。内核和用户态之间互相发送消息，有点像 HTTP，一个请求过去，一个响应回来。只不过请求是“connect”或者“accept”等等。相比 Sockets API，确实绕了很多，首先要封装到 struct 里面，然后通过统一的读写 syscall 进入到内核，再解析一遍 struct，再做实际的操作。如果直接 syscall 的话，内核实现会比较简单，只不过不“Unix”了。实际上，如过你阅读 Illumos 源码，它在解析 struct 以后，也会转而执行相应的 Sockets 处理函数，然后把返回值再封装成 TLI 的响应，发送给用户程序。</p>
<p>比较有意思的是，TPI 本身也是有状态的：Idle，Unbound，Data Transfer，等待 ACK 等等。所以如果你在 Solaris 上跑 netstat，会发现 UDP 也有状态（Idle/Unbound），那实际上不是 UDP 的状态，而是 TPI 的状态。正因此，我在维护 lsof 的时候，经常看到 TCP/TPI state，不明所以，才会研究 TPI 的历史，然后找到 TLI，才知道除了 Sockets 以外，还有一套 Unix 上的网络 API。有趣的是，TLI 是 System V 提供的，以前经常听到 System V ABI 的说法，却不知道 System V 是一个 Unix 操作系统，现在依然还可以在很多地方看到它的身影。</p>
<h3 id="_1"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#_1">参考资料</a></h3>
<ul>
<li><a href="https://pubs.opengroup.org/onlinepubs/9647699/toc.pdf">Networking Services (XNS)</a></li>
<li><a href="http://www.openss7.org/docs/tpi.pdf">Transport Provider Interface</a></li>
</ul>
<h3 id="chatgpt"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#chatgpt">ChatGPT</a></h3>
<p>问：What is Transport Layer Interface?</p>
<p>答：The Transport Layer Interface (TLI) is an application programming interface (API) that provides a standard interface for communication between an application program and the transport layer protocols of a network. It was originally developed by AT&amp;T for the Unix operating system and is now used in many other operating systems.</p>
<p>The TLI provides a set of functions that allow applications to communicate with the transport layer protocols, such as TCP and UDP, in a network-independent manner. Applications can use TLI to establish connections, send and receive data, and manage network resources.</p>
<p>One of the advantages of TLI is that it provides a layer of abstraction between the application and the transport layer protocols, which allows the application to be independent of the underlying network. This means that an application can be developed using TLI on one operating system and run on another operating system with different transport layer protocols.</p>
<p>However, TLI is an older interface and has largely been replaced by newer interfaces such as the sockets API, which is now the de facto standard for network programming.</p>
<p>问：What's the relationship between Transport Layer Interface and Transport Provider Interface?</p>
<p>答：The Transport Layer Interface (TLI) and Transport Provider Interface (TPI) are both application programming interfaces (APIs) that provide a standard way for applications to communicate with the transport layer protocols of a network. However, they are different interfaces that serve different purposes.</p>
<p>TLI is an API that was developed by AT&amp;T for the Unix operating system to provide a network-independent interface for applications to communicate with transport layer protocols such as TCP and UDP. It provides a set of functions that allow applications to establish connections, send and receive data, and manage network resources.</p>
<p>On the other hand, TPI is an API that was developed by the X/Open consortium to provide a standard interface for communication between the transport layer protocols and network drivers or hardware. It provides a set of functions that allow transport providers to interact with network drivers or hardware and handle network-specific issues such as congestion control, flow control, and error handling.</p>
<p>In other words, TLI is an interface for applications to communicate with the transport layer protocols, while TPI is an interface for transport providers to communicate with network drivers or hardware. The two interfaces are related in that TLI can be implemented using TPI, but they are distinct and serve different purposes in the network architecture.</p>
<p>问：Please write a UDP echo server in Transport Layer Interface</p>
<p>答：Sure, here is an example of a UDP echo server using the Transport Layer Interface (TLI) in C language:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-2"></a><span class="cp">##include &lt;stdlib.h&gt;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-3"></a><span class="cp">##include &lt;unistd.h&gt;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-4"></a><span class="cp">##include &lt;string.h&gt;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-5"></a><span class="cp">##include &lt;sys/types.h&gt;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-6"></a><span class="cp">##include &lt;sys/socket.h&gt;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-7"></a><span class="cp">##include &lt;netinet/in.h&gt;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-8"></a><span class="cp">##include &lt;netdb.h&gt;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-9"></a><span class="cp">##include &lt;tiuser.h&gt;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-11"></a><span class="cp">##define BUFSIZE 1024</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-12"></a><span class="cp">##define SERVICE_NAME &quot;echo&quot;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-14"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-15"></a><span class="p">{</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-17"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">t_call</span><span class="w"> </span><span class="n">call</span><span class="p">;</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-18"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">t_unitdata</span><span class="w"> </span><span class="n">ud</span><span class="p">;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-19"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">t_uderr</span><span class="w"> </span><span class="n">uderr</span><span class="p">;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-20"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">netbuf</span><span class="w"> </span><span class="o">*</span><span class="n">recvbuf</span><span class="p">;</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-21"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-22"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="w"> </span><span class="n">servaddr</span><span class="p">,</span><span class="w"> </span><span class="n">cliaddr</span><span class="p">;</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-23"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hostent</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">;</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-24"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">portno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5001</span><span class="p">;</span><span class="w"> </span><span class="c1">// can be any available port number</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-26"></a><span class="w">    </span><span class="c1">// create socket</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">sockfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_open</span><span class="p">(</span><span class="s">&quot;/dev/udp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-28"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_open&quot;</span><span class="p">);</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-29"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-32"></a><span class="w">    </span><span class="c1">// bind socket to port</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-33"></a><span class="w">    </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-34"></a><span class="w">    </span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">;</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-35"></a><span class="w">    </span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INADDR_ANY</span><span class="p">;</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-36"></a><span class="w">    </span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="n">portno</span><span class="p">);</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-38"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_bind&quot;</span><span class="p">);</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-39"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-41"></a>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-42"></a><span class="w">    </span><span class="c1">// listen for incoming requests</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-43"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-44"></a><span class="w">        </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">call</span><span class="p">));</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-45"></a><span class="w">        </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">));</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-46"></a><span class="w">        </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ud</span><span class="p">));</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-47"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">;</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-48"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">maxlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-49"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-50"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-51"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">udata</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-52"></a>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-53"></a><span class="w">        </span><span class="c1">// receive message</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-54"></a><span class="w">        </span><span class="n">recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">netbuf</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">t_alloc</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="n">T_UNITDATA</span><span class="p">,</span><span class="w"> </span><span class="n">T_ALL</span><span class="p">);</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_rcvudata</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="n">recvbuf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uderr</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-56"></a><span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_rcvudata&quot;</span><span class="p">);</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-57"></a><span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-58"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-59"></a><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-60"></a><span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-61"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-62"></a>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-63"></a><span class="w">        </span><span class="c1">// send message back to client</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-64"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">udata</span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-65"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">udata</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-66"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">;</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-67"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-68"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">maxlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-69"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_sndudata</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ud</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-70"></a><span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_sndudata&quot;</span><span class="p">);</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-71"></a><span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-72"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-73"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-74"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-75"></a><span class="p">}</span>
</span></code></pre></div>
<p>This UDP echo server listens on a specific port and waits for incoming messages from clients. When it receives a message, it sends the same message back to the client as a response. Note that this example assumes that the TLI library is already installed on your system, and the program is compiled with the appropriate TLI library flags.</p>

    <nav class="md-post__action">
      <a href="../../networking/2023/02/12/transport-layer-interface/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-03 00:00:00">2022年1月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linksys-e8450-openwrt-ubi"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/">升级 Linksys E8450 的 OpenWRT 系统到 UBI</a></h2>
<h3 id="_1"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#_1">背景</a></h3>
<p>在 <a href="https://openwrt.org/toh/linksys/e8450">OpenWRT Linksys E8450 页面</a> 中，如果要用新版的固件，需要转换到 UBI 格式的文件系统。之前用的是 non-UBI 格式的文件系统，直接在官方的分区下，覆盖掉其中一个启动分区。但是经常会报告 flash 出错，然后系统也不稳定，决定要按照文档更新到 UBI。</p>
<h3 id="_2"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#_2">步骤</a></h3>
<p>请注意：更换文件系统操作比较危险，请先备份好数据，并做好变砖的心理准备。本文仅记录了作者编写时可行的更新操作，不代表读者在阅读时，依然可以按照这个顺序进行，请按照 <a href="https://github.com/dangowrt/owrt-ubi-installer">https://github.com/dangowrt/owrt-ubi-installer</a> 的文档进行操作。</p>
<p>基本按照文档一步一步走。初始状态是一个 non-UBI 版本的 OpenWRT 固件：</p>
<ol>
<li>下载官方的 1.0 固件：https://downloads.linksys.com/support/assets/firmware/FW_E8450_1.0.01.101415_prod.img</li>
<li>在 luci 中，刷入官方 1.0 固件，这时候进入了官方固件的系统</li>
<li>登录官方固件网页，恢复出厂设置</li>
<li>下载 openwrt ubi recovery <a href="https://github.com/dangowrt/linksys-e8450-openwrt-installer/releases/download/v0.6.1/openwrt-mediatek-mt7622-linksys_e8450-ubi-initramfs-recovery-installer.itb">固件</a> 然后在官方固件里刷入</li>
<li>这时候进入了 recovery 固件，下载 <a href="https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">ubi 固件</a>，继续在网页里刷入</li>
<li>这时候固件就更新完成了。ssh root@192.168.1.1，然后进去安装 luci 等软件，恢复配置即可。</li>
</ol>

    <nav class="md-post__action">
      <a href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-27 00:00:00">2021年3月27日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="esxi"><a class="toclink" href="../../networking/2021/03/27/esxi-network-config/">ESXi 网络配置</a></h2>
<p>用过 ESXi 的大家都知道，它网页版对网络的配置功能有限，特别是 IPv6 的部分，有的事情无法实现。更好的办法是 SSH 到 ESXi 上直接用命令行进行配置。</p>
<p>可能会用到的一些命令：</p>
<ol>
<li>esxcfg-vmknic: 用来给 vmkernel 配置地址</li>
<li>esxcfg-route: 设置系统路由表</li>
<li>esxcli: 大杂烩，很多功能都在里面</li>
<li>tcpdump-uw：魔改版 tcpdump</li>
</ol>
<p>一些例子：</p>
<p>设置 IPv6 默认路由：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2021/03/27/esxi-network-config/#__codelineno-0-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcfg-route<span class="w"> </span>-f<span class="w"> </span>V6<span class="w"> </span>-a<span class="w"> </span>default<span class="w"> </span><span class="nv">$IPV6</span>
</span></code></pre></div>
<p>删除 vmkernel 的 IPv6 地址：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2021/03/27/esxi-network-config/#__codelineno-1-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcli<span class="w"> </span>network<span class="w"> </span>ip<span class="w"> </span>interface<span class="w"> </span>ipv6<span class="w"> </span>address<span class="w"> </span>remove<span class="w"> </span>-i<span class="w"> </span><span class="nv">$VMKERNEL</span><span class="w"> </span>-I<span class="w"> </span><span class="nv">$IPV6</span>/<span class="nv">$PREFIX</span>
</span></code></pre></div>
<p>参考：https://kb.vmware.com/s/article/1002662</p>

    <nav class="md-post__action">
      <a href="../../networking/2021/03/27/esxi-network-config/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-05-30 00:00:00">2019年5月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ip-udp-checksum"><a class="toclink" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/">IP 和 UDP Checksum 的增量更新问题</a></h2>
<p>之前在写 IP Checksum 的增量更新，就是当 TTL -= 1 的时候，Checksum 应该增加 0x0100，但是这样会有问题，在于，如果按照原来的 IP Checksum 计算方法，是不会出现 0xFFFF 的（求和，进位，然后取反写入），这种加法就有可能出现 0xFFFF。于是翻阅了相关的 RFC：</p>
<p>首先是 RFC 1141 相关部分：</p>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-0-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-0-2"></a><span class="n">ipptr</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="o">--</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* decrement ttl */</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-0-3"></a><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipptr</span><span class="o">-&gt;</span><span class="n">Checksum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x100</span><span class="p">;</span><span class="w">  </span><span class="cm">/* increment checksum high byte*/</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-0-4"></a><span class="n">ipptr</span><span class="o">-&gt;</span><span class="n">Checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">sum</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">))</span><span class="w"> </span><span class="cm">/* add carry */</span>
</span></code></pre></div>
<p>这也是比较直接能想到的一种方法，但是会出现刚才提到的问题。于是 RFC 1624 纠正了这个问题：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-1"></a>  Although this equation appears to work, there are boundary conditions
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-2"></a>   under which it produces a result which differs from the one obtained
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-3"></a>   by checksum computation from scratch.  This is due to the way zero is
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-4"></a>   handled in one&#39;s complement arithmetic.
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-6"></a>   In one&#39;s complement, there are two representations of zero: the all
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-7"></a>   zero and the all one bit values, often referred to as +0 and -0.
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-8"></a>   One&#39;s complement addition of non-zero inputs can produce -0 as a
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-9"></a>   result, but never +0.  Since there is guaranteed to be at least one
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-13"></a>Rijsinghani                                                     [Page 2]
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-15"></a>RFC 1624             Incremental Internet Checksum              May 1994
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-17"></a>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-18"></a>   non-zero field in the IP header, and the checksum field in the
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-19"></a>   protocol header is the complement of the sum, the checksum field can
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-20"></a>   never contain ~(+0), which is -0 (0xFFFF).  It can, however, contain
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-21"></a>   ~(-0), which is +0 (0x0000).
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-23"></a>   RFC 1141 yields an updated header checksum of -0 when it should be
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-24"></a>   +0.  This is because it assumed that one&#39;s complement has a
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-25"></a>   distributive property, which does not hold when the result is 0 (see
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-26"></a>   derivation of [Eqn. 2]).
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-27"></a>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-28"></a>   The problem is avoided by not assuming this property.  The correct
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-29"></a>   equation is given below:
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-30"></a>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-31"></a>          HC&#39; = ~(C + (-m) + m&#39;)    --    [Eqn. 3]
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-1-32"></a>              = ~(~HC + ~m + m&#39;)
</span></code></pre></div>
<p>只要把代码简单修改一下就可以了，或者遇到 0xFFFF 时设为 0，这时候就解决了这个问题。</p>
<p>但是，仔细研究了一下发现，UDP Checksum 又是这么定义的（RFC 768）:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-2-1"></a>If the computed  checksum  is zero,  it is transmitted  as all ones (the
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-2-2"></a>equivalent  in one&#39;s complement  arithmetic).   An all zero  transmitted
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-2-3"></a>checksum  value means that the transmitter  generated  no checksum  (for
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/#__codelineno-2-4"></a>debugging or for higher level protocols that don&#39;t care).
</span></code></pre></div>
<p>刚好和 IP Checksum 相反，这就很有意思了。</p>

    <nav class="md-post__action">
      <a href="../../networking/2019/05/30/ip-and-udp-checksum-incremental-update/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-10-22 00:00:00">2018年10月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openwrt-gandi-ddns"><a class="toclink" href="../../networking/2018/10/22/ddns-openwrt-router/">OpenWRT 上配置 Gandi DDNS</a></h2>
<p>一直想给自己的 OpenWRT 路由器添加 DDNS 功能，但 Gandi 不在官方的 ddns-scripts 列表中，自己在网上找了一些脚本，发现是 Python 写的，尝试把 Python 安装到路由器上又发现空间不够，虽然可以安装到 USB 上，但总归是麻烦。</p>
<p>最后找到了官方的一个<a href="https://github.com/Gandi/api-examples/blob/master/bash/livedns/mywanip.sh">脚本</a>，非常适合我的需求。简单修改一下，然后安装一下支持 HTTPS 的 cURL：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/10/22/ddns-openwrt-router/#__codelineno-0-1"></a>$ opkg update
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/10/22/ddns-openwrt-router/#__codelineno-0-2"></a>$ opkg install ca-bundle
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/10/22/ddns-openwrt-router/#__codelineno-0-3"></a>$ opkg install curl
</span></code></pre></div>
<p>然后把脚本添加到 crontab 即可。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/10/22/ddns-openwrt-router/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-10-20 00:00:00">2018年10月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="etc"><a class="toclink" href="../../networking/2018/10/20/etc-wireless-network/">ETC 比赛无线网络搭建小记</a></h2>
<p>正好上着李贺武老师的《无线移动网络技术》课，然后今天又给 ETC 比赛搭建无线网络，于是周二的时候找老师咨询了一下意见。我们大概给老师讲了一下场地的样子和尺寸（当时估计的大了），然后老师给我们提供了一个可以供参考的部署方案，包括几个 AP 分别放在哪，这些 AP 的 2.4GHz 都用哪个 channel，然后都用多少功率。并且很友善地在周五的时候让助教来场地帮我们 survey 一下无线网络的状况。我们用 Fluke Networks 的 AirCheck Wi-Fi Tester 看了一下场地的各个频道的 AP 数量和信号强度，发现虽然 AP 挺多的，但是它们的信号都比我们的小不少，而且我们也都开到了 50mW，所以干扰不大。</p>
<p>然后昨天下午一点半钟来到场地，用板车把设备都运到计算机开放实验室，然后开始部署无线网络。我们提前来踩过几次点，这边的网络是没有 DHCP 服务器的，通过一个指定的网关出去。我们发现可以利用已有的这些交换机从地下连到各个电脑上的网线，来连接我们的 AP 和交换机，这样我们就免去了走线的麻烦。于是我们先定下放 AP 的位置，然后用寻线器找到网线插到了交换机的哪一个端口上，标记好后换成连接到我们自己的交换机的网线上，从而可以通过 PoE 把我们的 AP 给启动起来。然后用我自己的路由器，把 LAN 口插到交换机上，给 AP 分发 DHCP 地址，然后把下发的默认网关配置为真实的网关（DHCP Option 3） ，没做但是也可以顺带做的是把 WLC 的地址分发下去（DHCP Option 43 Type 241）。</p>
<p>当然，这个过程也遇到了一点小坑，就是交换机还保留了之前的配置，所以这次把新的几个端口划到了一个 VLAN 下，命令自然是记不住的要现查。然后起来以后还挺稳定的，也没出现什么问题，网络带宽也足够用，离千兆还有蛮多距离，一天也才跑了接近俩 TB 的流量。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/10/20/etc-wireless-network/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-10-07 00:00:00">2018年10月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="veth-ipv6-only-brouter"><a class="toclink" href="../../networking/2018/10/07/use-veth-for-ipv6-brouter/">使用 veth 实现 IPv6-only 的 Brouter 功能</a></h2>
<p>最近从 @shankerwangmiao 学到了一个方法：通过 veth 把两个 bridge 的 IPv6 桥接起来。方法如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/10/07/use-veth-for-ipv6-brouter/#__codelineno-0-1"></a>$ ip link add veth-v6-in type veth peer name veth-v6-out
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/10/07/use-veth-for-ipv6-brouter/#__codelineno-0-2"></a>$ brctl addif br-in veth-v6-in
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/10/07/use-veth-for-ipv6-brouter/#__codelineno-0-3"></a>$ brctl addif br-out veth-v6-out
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/10/07/use-veth-for-ipv6-brouter/#__codelineno-0-4"></a>$ ebtables -t filter -A FORWARD -p ! IPv6 -o veth-v6-in -j DROP
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2018/10/07/use-veth-for-ipv6-brouter/#__codelineno-0-5"></a>$ ebtables -t filter -A FORWARD -p ! IPv6 -o veth-v6-out -j DROP
</span></code></pre></div>
<p>这样就可以看到 veth 上仅有 IPv6 的流量了。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/10/07/use-veth-for-ipv6-brouter/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-10-04 00:00:00">2018年10月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="android-lte-ipv6"><a class="toclink" href="../../networking/2018/10/04/enable-lte-ipv6-on-android/">在 Android 上打开 LTE 的 IPv6</a></h2>
<p>听闻北京移动给 LTE 配置了 SLAAC，但现在需要手动打开，方法如下：</p>
<p>Settings -&gt; Network &amp; Internet -&gt; Mobile Network -&gt; Advanced -&gt; Access Point Names -&gt; 中国移动 GPRS (China Mobile) -&gt; 把 APN procotol 和 APN roaming protocol 两项都改成 IPv4/IPv6 </p>
<p>然后在 <a href="https://test-ipv6.com">test-ipv6.com</a> 上可以看到确实分配了 IPv6 地址，不过目前评分只有 1/10。也就是说可用性还不佳。</p>
<p>而在 iOS 上，通过 HE 的 Network Tools 能看到，确实拿到了 IPv6 的地址，但是出不去，怀疑是运营商没有下发相关配置，所以还不能使用，只能继续等。</p>
<p>2018-11-06 更新：现在 iOS 用户也有 LTE 的 v6 了。评分是 9/10。目前可用性已经可以了，就是国内互联还不大好。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/10/04/enable-lte-ipv6-on-android/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-09-11 00:00:00">2018年9月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ledeopenwrt-wpad"><a class="toclink" href="../../networking/2018/09/11/enable-wpad-on-lede/">在 LEDE（OpenWrt）上启用 wpad</a></h2>
<p>WPAD（Web Proxy Auto-Discovery Protocol）是一个可以利用 dhcp 分发 pac 配置的协议。方法如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/09/11/enable-wpad-on-lede/#__codelineno-0-1"></a>$<span class="w"> </span><span class="c1"># ssh to router first</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/09/11/enable-wpad-on-lede/#__codelineno-0-2"></a>$<span class="w"> </span>vim<span class="w"> </span>/etc/dnsmasq.conf
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/09/11/enable-wpad-on-lede/#__codelineno-0-3"></a>dhcp-option<span class="o">=</span><span class="m">252</span>,<span class="s2">&quot;http://router_ip/wpad.dat&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/09/11/enable-wpad-on-lede/#__codelineno-0-4"></a>$<span class="w"> </span>vim<span class="w"> </span>/www/wpad.dat<span class="w"> </span><span class="c1"># put pac here</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2018/09/11/enable-wpad-on-lede/#__codelineno-0-5"></a>$<span class="w"> </span>service<span class="w"> </span>dnsmasq<span class="w"> </span>restart
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../networking/2018/09/11/enable-wpad-on-lede/#__codelineno-0-6"></a>$<span class="w"> </span><span class="c1"># ensure proxy is available to lan</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../networking/2018/09/11/enable-wpad-on-lede/#__codelineno-0-7"></a>$<span class="w"> </span><span class="c1"># enable wpad on devices</span>
</span></code></pre></div>
<p>参考文档：</p>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Web_Proxy_Auto-Discovery_Protocol">Web Proxy Auto-Discovery Protocol</a></li>
<li><a href="https://www.davidpashley.com/articles/automatic-proxy-configuration-with-wpad/">Automatic Proxy Configuration with WPAD</a></li>
<li><a href="https://findproxyforurl.com/deploying-wpad/">Deploying WPAD</a></li>
<li><a href="http://findproxyforurl.com/example-pac-file/">Example PAC File</a></li>
</ol>

    <nav class="md-post__action">
      <a href="../../networking/2018/09/11/enable-wpad-on-lede/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-08-31 00:00:00">2018年8月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ipfilter-extension-rfc8367"><a class="toclink" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/">通过 Ipfilter Extension 实现 RFC8367</a></h2>
<p>前几天无聊闲逛看到了一个很有趣的 <a href="https://tools.ietf.org/html/rfc8367">RFC8367 - Wrongful Termination of Internet Protocol (IP) Packets</a> ，看到日期大家应该都懂了，这是个粥客，不过里面还是反映了一些事情，咳。</p>
<p>之前看到闪客实现了 <a href="https://github.com/shankerwangmiao/xt_PROTO">shankerwangmiao/xt_PROTO</a> ，想到自己也可以做一个 iptables 扩展，于是就写了 <a href="https://github.com/jiegec/xt_EQUALIZE">jiegec/xt_EQUALIZE</a> 。它是这样使用的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-1"></a>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:jiegec/xt_EQUALIZE.git
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-2"></a>$<span class="w"> </span>make
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-4"></a>$<span class="w"> </span>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>filter<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-j<span class="w"> </span>EQUALIZE
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-5"></a>$<span class="w"> </span>sudo<span class="w"> </span>dmesg<span class="w"> </span>-w<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-6"></a>$<span class="w"> </span><span class="c1"># Make some random network requests to see the effect!</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-7"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">1</span>.1.1.1
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-8"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">8</span>.8.8.8
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/#__codelineno-0-9"></a>$<span class="w"> </span>ping<span class="w"> </span>::1
</span></code></pre></div>
<p>目前还没有把参数都变成可以配置的。如果真的有人需要这个模块的话，我再改吧（逃</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/08/31/implementing-rfc8367-as-iptables-extension/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-08-25 00:00:00">2018年8月25日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="macos-tap-interface-ipv6"><a class="toclink" href="../../networking/2018/08/25/enable-ipv6-autoconfiguration-on-tap-interfaces-in-macos/">在 macOS 上 TAP Interface 上启用 IPv6 自动配置</a></h2>
<p>由于 macOS 对 TAP Interface 不会自动出现一个设置中对应的服务，所以需要手动进行配置。一番测试后，发现可以通过：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/08/25/enable-ipv6-autoconfiguration-on-tap-interfaces-in-macos/#__codelineno-0-1"></a>$ sudo ipconfig set [tap_if] automatic-v6
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/08/25/enable-ipv6-autoconfiguration-on-tap-interfaces-in-macos/#__codelineno-0-2"></a>$ sudo ipconfig set [tap_if] dhcp
</span></code></pre></div>
<p>启用系统自带的 dhcp 和 ra 功能。也许有方法可以把这些 tap 搬到系统的设置中去。</p>
<p>UPDATE:</p>
<p>可以把 TAP Interface 加到系统的设置中去。方法参考<a href="https://stackoverflow.com/a/6375307">Virtual network interface in Mac OS X</a>。完成以后可以直接通过系统设置界面进行配置。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/08/25/enable-ipv6-autoconfiguration-on-tap-interfaces-in-macos/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-08-21 00:00:00">2018年8月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="macos-gretap"><a class="toclink" href="../../networking/2018/08/21/implementing-gretap-in-macos/">在 macOS 下实现 GRETAP</a></h2>
<p>由于没有找到 macOS 下现成的 GRETAP 实现，我就想到自己实现一个。由于<a href="http://tuntaposx.sourceforge.net/">tuntaposx</a>提供了一个和 Linux 下基本一样的 TAP Interface，于是自己利用 raw socket 和 TAP Interface 实现了一下，主要方法：</p>
<ol>
<li>打开 raw socket，读取收到的 proto 47 的包，判断是否为 GRETAP 包，是，则写入内层包到打开的 TAP Interface 中。</li>
<li>从 TAP Interface 中读入包，自己加上 GRE 头和 IP 头，然后发送。</li>
</ol>
<p>主要的难度是在 raw socket 部分，macOS 继承了 BSD，与 Linux 不大一样。于是参考了<a href="https://sock-raw.org/papers/sock_raw">SOCK_RAW Demystified</a>，成功地实现了这个功能。</p>
<p>代码放在<a href="https://github.com/jiegec/gretapmac">jiegec/gretapmac</a>。写得并不高效，仅仅可用，用了一百多行。</p>
<p>UPDATE: 之后又随手实现了一个类似的协议，L2TPv3 over UDP。代码在<a href="https://github.com/jiegec/l2tpv3udptap">jiegc/l2tpv3udptap</a>。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/08/21/implementing-gretap-in-macos/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-08-10 00:00:00">2018年8月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="wireguard-overlay-network-babel"><a class="toclink" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/">在 WireGuard 构建的 Overlay Network 上跑 babel 路由协议</a></h2>
<p>受 <a href="https://blog.fugoes.xyz/2018/02/03/Run-Babeld-over-Wireguard.html">Run Babeld over Wireguard - Fugoes's Blog</a> 和 <a href="https://vincent.bernat.im/en/blog/2018-route-based-vpn-wireguard">Route-based VPN on Linux with WireGuard</a> 启发，自己也想尝试一下，在一个有多个结点的网络中，如何通过 WireGuard 构建一个 overlay network，并通过 babel 自动进行结点发现和路径选择。</p>
<p>首先建立点对点的 WireGuard Tunnel。由于我们用 babel 进行路由，所以我们不能采用 Wiregurad 本身基于目的地址的端口复用，所以每一个 WireGuard interface 都只有一个 Peer。</p>
<p>配置一个点对点的 WireGuard Tunnel：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-1"></a>$ # for wg-quick
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-2"></a>$ cat wg0.conf
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-3"></a>[Interface]
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-4"></a>Address = IPV4/32, fe80::ID/64
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-5"></a>PrivateKey = REDACTED
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-6"></a>ListenPort = PORT1
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-7"></a>Table = off # ask wg-quick not to insert peer address into routing table
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-9"></a>[Peer]
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-10"></a>PublicKey = REDACTED
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-11"></a>AllowedIPs = 0.0.0.0/0, ::/0
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-0-12"></a>Endpoint = REDACTED:PORT2
</span></code></pre></div>
<p>这里的 IPV4 和 ID 在同一设备上的不同 WireGuard Tunnel 上相同。只是通过 wg interface 编号来区分。</p>
<p>接着配置 babeld：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-1"></a>$ cat babeld.conf
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-3"></a>router-id ID
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-4"></a>local-port 33123 # for babelweb2
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-6"></a>## one line for each wg interface
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-7"></a>interface wg0 type tunnel rtt-max 512
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-9"></a>redistribute ip PREFIX/LEN ge LEN le 32 local allow # tunnel neighbors
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-10"></a>redistribute proto 42 # routes installed by babeld
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-11"></a>redistribute local deny
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/#__codelineno-1-12"></a>## consult babeld man page for more
</span></code></pre></div>
<p>然后通过 BabelWeb2（很难用）进行可视化，然后通过手动触发一些网络波动即可达到效果。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-07-26 00:00:00">2018年7月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="lenovo-y1s-openwrt-17015-ipv6-bridge"><a class="toclink" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/">向 Lenovo y1s 刷入 OpenWRT 17.01.5 固件，并把 IPv6 bridge 到内网中和配置认证脚本</a></h2>
<p>首先参照<a href="https://wiki.openwrt.org/toh/lenovo/lenovo_y1_v1">OpenWRT Wiki - Lenovo Y1 v1</a>找到刷固件教程：</p>
<ol>
<li>下载<a href="https://mirrors.tuna.tsinghua.edu.cn/lede/releases/17.01.5/targets/ramips/mt7620/lede-17.01.5-ramips-mt7620-y1s-squashfs-sysupgrade.bin">Lenovo y1s 的固件</a>备用</li>
<li>断开电源，等待一段时间，插入电源同时快速按下重置按钮，如果面板双闪，则说明进入了恢复模式</li>
<li>电脑连接到四个 LAN 口中任意一个，配置静态地址在 192.168.1.0/24 网段</li>
<li>打开 192.168.1.1 可以看到刷固件的页面</li>
<li>上传固件，等待路由器重启</li>
<li>配置 IP 地址为 DHCP 模式，打开 192.168.1.1 进行配置</li>
</ol>
<p>然后就是常规的密码设置，opkg 源设置为 tuna 的源，配置 ssh 和 公钥。</p>
<p>接下来，我们为了使用学校的 SLAAC，采用 ebtables 直接把学校的 IPv6 bridge 进来，而 IPv4 由于准入系统，需要 NAT。</p>
<p>参考 <a href="https://tmikey.tech/tech_daily/lede/2017/08/25/bridge_ipv6_lede.html">Bridge IPv6 connections to WAN</a>，下载 <a href="https://github.com/cvmiller/v6brouter/blob/master/v6brouter_openwrt.sh">v6brouter_openwrt.sh</a> 到某个地方，然后修改一下里面的一些参数：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-0-1"></a><span class="c1">## For Lenovo y1s</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-0-2"></a><span class="nv">WAN_DEV</span><span class="o">=</span>eth0.2
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-0-3"></a><span class="nv">BRIDGE</span><span class="o">=</span>br-lan
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-0-4"></a><span class="c1">## the rest remain unchanged</span>
</span></code></pre></div>
<p>然后跑起来之后，自己的电脑可以成功拿到原生的 IPv6 地址了，不需要用难用的 NAT66 技术。</p>
<p>下一步是采用<a href="https://github.com/z4yx/GoAuthing">z4yx/GoAuthing</a>。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-1"></a>$<span class="w"> </span>go<span class="w"> </span>get<span class="w"> </span>-u<span class="w"> </span>-v<span class="w"> </span>github.com/z4yx/GoAuthing
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-2"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$GOPATH</span>/src/github.com/z4yx/GoAuthing/cli
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-3"></a>$<span class="w"> </span>env<span class="w"> </span><span class="nv">GOOS</span><span class="o">=</span>linux<span class="w"> </span><span class="nv">GOARCH</span><span class="o">=</span>mipsle<span class="w"> </span><span class="nv">GOMIPS</span><span class="o">=</span>softfloat<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>main.go
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-4"></a>$<span class="w"> </span>mipsel-linux-gnu-strip<span class="w"> </span>main
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-5"></a>$<span class="w"> </span>scp<span class="w"> </span>main<span class="w"> </span>root@192.168.1.1:~/GoAuthing
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-6"></a>$<span class="w"> </span>ssh<span class="w"> </span>root@192.168.1.1
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-7"></a>$<span class="w"> </span>opkg<span class="w"> </span>install<span class="w"> </span>ca-certificates
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-1-8"></a>$<span class="w"> </span>./GoAuthing
</span></code></pre></div>
<p>这里参考了<a href="https://blog.csdn.net/QQ531456898/article/details/80095707">解决 GO 语言编译程序在 openwrt(mipsle 架构) 上运行提示 Illegal instruction 问题</a>，配置了 GOMIPS 环境变量。为了访问 HTTPS 网站，参考了<a href="https://wiki.openwrt.org/doc/howto/wget-ssl-certs">OpenWRT Wiki - SSL and Certificates in wget</a>。有毒的是，这个环境变量，在 macOS 上不能正常工作，而在 Linux 机子上是没有问题的。</p>
<p>然后就可以成功地跑起来 GoAuthing，解决了上校园网认证的问题。</p>
<p>感谢<a href="https://github.com/z4yx">宇翔</a>编写的 GoAuthing 小工具。</p>
<p>更新：简化了一下 v6brouter 脚本：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-1"></a><span class="c1">##!/bin/sh</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-2"></a><span class="nv">BRIDGE</span><span class="o">=</span>br-lan
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-3"></a><span class="nv">WAN_DEV</span><span class="o">=</span><span class="k">$(</span>/sbin/uci<span class="w"> </span>get<span class="w"> </span>network.wan.ifname<span class="k">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-4"></a><span class="nv">WHITELIST1</span><span class="o">=</span><span class="s2">&quot;00:11:22:33:44:55&quot;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-5"></a><span class="nv">WHITELIST2</span><span class="o">=</span><span class="s2">&quot;55:44:33:22:11:00&quot;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-7"></a>brctl<span class="w"> </span>addbr<span class="w"> </span><span class="nv">$BRIDGE</span><span class="w"> </span><span class="m">2</span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-8"></a>brctl<span class="w"> </span>addif<span class="w"> </span><span class="nv">$BRIDGE</span><span class="w"> </span><span class="nv">$WAN_DEV</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-9"></a>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">$BRIDGE</span><span class="w"> </span>down
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-10"></a>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">$BRIDGE</span><span class="w"> </span>up
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-11"></a>brctl<span class="w"> </span>show
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-13"></a>ebtables<span class="w"> </span>-F
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-14"></a>ebtables<span class="w"> </span>-P<span class="w"> </span>FORWARD<span class="w"> </span>ACCEPT
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-15"></a>ebtables<span class="w"> </span>-L
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-17"></a>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>dhcp.lan.ra<span class="o">=</span><span class="s1">&#39;disabled&#39;</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-18"></a>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>dhcp.lan.dhcpv6<span class="o">=</span><span class="s1">&#39;disabled&#39;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-19"></a>uci<span class="w"> </span>commit
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-20"></a>/etc/init.d/odhcpd<span class="w"> </span>restart
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-22"></a><span class="nb">echo</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/net/ipv6/conf/<span class="nv">$BRIDGE</span>/accept_ra
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-23"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-F
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-24"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-A<span class="w"> </span>BROUTING<span class="w"> </span>-i<span class="w"> </span><span class="nv">$WAN_DEV</span><span class="w"> </span>-p<span class="w"> </span>!<span class="w"> </span>ipv6<span class="w"> </span>-j<span class="w"> </span>DROP
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-25"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-A<span class="w"> </span>BROUTING<span class="w"> </span>-s<span class="w"> </span><span class="nv">$WHITELIST1</span><span class="w"> </span>-p<span class="w"> </span>ipv6<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-26"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-A<span class="w"> </span>BROUTING<span class="w"> </span>-d<span class="w"> </span><span class="nv">$WHITELIST1</span><span class="w"> </span>-p<span class="w"> </span>ipv6<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-27"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-A<span class="w"> </span>BROUTING<span class="w"> </span>-s<span class="w"> </span><span class="nv">$WHITELIST2</span><span class="w"> </span>-p<span class="w"> </span>ipv6<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-28"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-A<span class="w"> </span>BROUTING<span class="w"> </span>-d<span class="w"> </span><span class="nv">$WHITELIST2</span><span class="w"> </span>-p<span class="w"> </span>ipv6<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-29"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-A<span class="w"> </span>BROUTING<span class="w"> </span>-p<span class="w"> </span>ipv6<span class="w"> </span>-j<span class="w"> </span>DROP
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/#__codelineno-2-30"></a>ebtables<span class="w"> </span>-t<span class="w"> </span>broute<span class="w"> </span>-L
</span></code></pre></div>
<p>注意，这里添加了两个 WHITELIST 的 MAC 地址，表示只让这两个 MAC 地址的设备访问 v6。一般来说，外面网关的 MAC 地址也要放进来，不然可能接收不到 RA。如果不需要白名单的话，可以去掉 ebtables 的后几行规则。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/07/26/flashing-lenovo-y1s-and-bridge-ipv6/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-07-15 00:00:00">2018年7月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="multicast"><a class="toclink" href="../../networking/2018/07/15/use-multicast-address-to-find-neighbours/">用 multicast 地址找到同一网段的主机</a></h2>
<p>IPv4 :</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/07/15/use-multicast-address-to-find-neighbours/#__codelineno-0-1"></a>$<span class="w"> </span>ping<span class="w"> </span>-t1<span class="w"> </span><span class="m">224</span>.0.0.1
</span></code></pre></div>
<p>IPv6:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/07/15/use-multicast-address-to-find-neighbours/#__codelineno-1-1"></a>$<span class="w"> </span>ping<span class="w"> </span>-t1<span class="w"> </span>ff02::1%iface
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../networking/2018/07/15/use-multicast-address-to-find-neighbours/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-07-06 00:00:00">2018年7月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="iptables-demux"><a class="toclink" href="../../networking/2018/07/06/use-iptables-to-serve-different-services-on-one-port/">通过 iptables 在同一个端口根据源地址解复用（demux）</a></h2>
<p>现在遇到一个场景，原来的一个服务只给一个客户端用，但现在增加了一个客户端，由于客户端配置相同，但是服务端需要区别对待两个客户端的服务端配置，所以利用 iptables 根据源地址做了一个端口转发，实现了 demux。</p>
<p>假设：服务器在 192.168.0.1，客户端分别在 192.168.0.2 和 192.168.0.3。客户端配置的服务端地址是 192.168.0.1:8000。之前，在服务器上只跑了一个服务，监听着 8000 端口。</p>
<p>现在，在服务器上再跑一个服务，监听 8001 端口，同时根据需求进行相应的配置。然后，加上如下 iptables 规则：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/07/06/use-iptables-to-serve-different-services-on-one-port/#__codelineno-0-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.0.3<span class="w"> </span>-d<span class="w"> </span><span class="m">192</span>.168.0.1<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">8000</span><span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">8001</span>
</span></code></pre></div>
<p>这样，在不需要更改客户端的情况下，完成了需要的效果。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/07/06/use-iptables-to-serve-different-services-on-one-port/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-06-29 00:00:00">2018年6月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="wireguard"><a class="toclink" href="../../networking/2018/06/29/wireguard-tunnel/">Wireguard 隧道搭建</a></h2>
<p>随着 Wireguard Go 版本的开发，在 macOS 上起 WireGuard Tunnel 成为现实。于是，搭建了一个 macOS 和 Linux 之间的 WireGuard Tunnel。假设 Linux 端为服务端，macOS 端为客户端。</p>
<p>macOS 端：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-1"></a>$<span class="w"> </span>brew<span class="w"> </span>install<span class="w"> </span>wireguard-tools
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-2"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/usr/local/etc/wireguard
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-3"></a>$<span class="w"> </span>wg<span class="w"> </span>genkey<span class="w"> </span>&gt;<span class="w"> </span>privatekey
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-4"></a>$<span class="w"> </span>wg<span class="w"> </span>pubkey<span class="w"> </span>&lt;<span class="w"> </span>privatekey<span class="w"> </span>&gt;<span class="w"> </span>publickey
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-5"></a>$<span class="w"> </span>vim<span class="w"> </span>tunnel.conf
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-6"></a><span class="o">[</span>Interface<span class="o">]</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-7"></a><span class="nv">PrivateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>MACOS_PRIVATE_KEY
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-9"></a><span class="o">[</span>Peer<span class="o">]</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-10"></a><span class="nv">PublicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LINUX_PUBLIC_KEY<span class="w"> </span><span class="c1"># Generated below</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-11"></a><span class="nv">AllowedIPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">192</span>.168.0.0/24
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-12"></a><span class="nv">Endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LINUX_PUBLIC_IP:12345
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-13"></a>$<span class="w"> </span>vim<span class="w"> </span>up.sh
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-14"></a><span class="c1">##!/bin/bash</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-15"></a><span class="c1">## change interface name when necessary</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-16"></a>sudo<span class="w"> </span>wireguard-go<span class="w"> </span>utun0
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-17"></a>sudo<span class="w"> </span>wg<span class="w"> </span>setconf<span class="w"> </span>utun0<span class="w"> </span>tunnel.conf
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-18"></a>sudo<span class="w"> </span>ifconfig<span class="w"> </span>utun0<span class="w"> </span><span class="m">192</span>.168.0.2<span class="w"> </span><span class="m">192</span>.168.0.1
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-19"></a>$<span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>up.sh
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-0-20"></a>$<span class="w"> </span>./up.sh
</span></code></pre></div>
<p>配置 Linux 端：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-1"></a>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://git.zx2c4.com/WireGuard
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-2"></a>$<span class="w"> </span>make
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-4"></a>$<span class="w"> </span>sudo<span class="w"> </span>fish
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-5"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/etc/wireguard
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-6"></a>$<span class="w"> </span>wg<span class="w"> </span>genkey<span class="w"> </span>&gt;<span class="w"> </span>privatekey
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-7"></a>$<span class="w"> </span>wg<span class="w"> </span>pubkey<span class="w"> </span>&lt;<span class="w"> </span>privatekey<span class="w"> </span>&gt;<span class="w"> </span>publickey
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-8"></a>$<span class="w"> </span>vim<span class="w"> </span>wg0.conf
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-9"></a><span class="o">[</span>Interface<span class="o">]</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-10"></a><span class="nv">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">192</span>.168.0.1/24
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-11"></a><span class="nv">PrivateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LINUX_PRIVATE_KEY
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-12"></a><span class="nv">ListenPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12345</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-14"></a><span class="o">[</span>Peer<span class="o">]</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-15"></a><span class="nv">PublicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>MACOS_PUBLIC_KEY
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-16"></a><span class="nv">AllowedIPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">192</span>.168.0.2/24
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../networking/2018/06/29/wireguard-tunnel/#__codelineno-1-17"></a>$<span class="w"> </span>wg-quick<span class="w"> </span>up<span class="w"> </span>wg0
</span></code></pre></div></p>
<p>经过测试，两边可以互相 ping 通。</p>
<p>后续尝试在 Android 上跑通 WireGuard。</p>
<p>UPDATE 2018-07-11: </p>
<p>成功在 Android 上跑通 WireGuard。在 Google Play 上下载官方的 App 即可。麻烦在于，将 Android 上生成的 Public Key 和服务器的 Public Key 进行交换。</p>
<p>然后又看到<a href="https://wiki.debian.org/Wireguard#Step_2_-_Alternative_C_-_systemd">WireGuard 在 systemd-networkd</a>上的配置方案，自己也实践了一下。首先，如果用的是 stretch，请首先打开 stretch-backports 源并把 systemd 升级到 237 版本。</p>
<p>然后，根据上面这个连接进行配置，由于都是 ini 格式，基本就是复制粘贴就可以配置了。有一点要注意，就是，要保护 PrivateKey 的安全，注意配置 .netdev 文件的权限。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/06/29/wireguard-tunnel/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-09 00:00:00">2018年5月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="macos-linux-tinc"><a class="toclink" href="../../networking/2018/05/09/tinc-between-macos-and-linux/">在 macOS 和 Linux 之间搭建 tinc 网络</a></h2>
<p>一直听说 tinc 比较科学，所以尝试自己用 tinc 搭建一个网络。这里，macOS 这段没有固定 IP 地址，Linux 机器有固定 IP 地址 linux_ip。假设网络名称为 example , macOS 端名为 macos 地址为 192.168.0.2, linux 端名为 linux 地址为 192.168.0.1。</p>
<p>2018-11-11 注：本文用的 tinc 版本为 1.0.x，而不是 1.1-pre，两个分支命令不同，但协议可以兼容。</p>
<p>在 macOS 上配置：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-0-1"></a>brew<span class="w"> </span>install<span class="w"> </span>tinc
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-0-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/usr/local/etc/tinc/example
</span></code></pre></div></p>
<p>新建 /usr/local/etc/tinc/example/tinc.conf:
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-1-1"></a>Name = macos
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-1-2"></a>Device = utun0 # use an unused number
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-1-3"></a>ConnectTo = linux
</span></code></pre></div></p>
<p>编辑 /usr/local/etc/tinc/example/tinc-up:
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-2-1"></a>##!/bin/sh
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-2-2"></a>ifconfig $INTERFACE 192.168.0.2 192.168.0.1 mtu 1500 netmask 255.255.255.255
</span></code></pre></div></p>
<p>和 /usr/local/etc/tinc/example/tinc-down:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-3-1"></a>##!/bin/sh
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-3-2"></a>ifconfig $INTERFACE down
</span></code></pre></div></p>
<p>还有 /usr/local/etc/tinc/example/subnet-up:
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-4-1"></a>##!/bin/sh
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-4-2"></a>[ &quot;$NAME&quot; = &quot;$NODE&quot; ] &amp;&amp; exit 0
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-4-3"></a>/usr/local/opt/iproute2mac/bin/ip route add $SUBNET dev $INTERFACE
</span></code></pre></div></p>
<p>以及 /usr/local/etc/tinc/example/subnet-down:
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-5-1"></a>##!/bin/sh
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-5-2"></a>[ &quot;$NAME&quot; = &quot;$NODE&quot; ] &amp;&amp; exit 0
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-5-3"></a>/usr/local/opt/iproute2mac/bin/ip route del $SUBNET dev $INTERFACE
</span></code></pre></div></p>
<p>然后将它们都设为可执行的：
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-6-1"></a>chmod +x tinc-up
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-6-2"></a>chmod +x tinc-down
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-6-3"></a>chmod +x subnet-down
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-6-4"></a>chmod +x subnet-down
</span></code></pre></div></p>
<p>编辑 /usr/local/etc/tinc/example/macos:
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-7-1"></a>Port = 655
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-7-2"></a>Subnet = 192.168.0.1/24
</span></code></pre></div></p>
<p>执行 <code>tincd -n example -K</code> 生成密钥。</p>
<p>到 Linux 机器上：
编辑以下文件：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-1"></a>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/tinc/example/hosts
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-2"></a>$<span class="w"> </span>cat<span class="w"> </span>/etc/tinc/example/tinc.conf
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-3"></a><span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>linux
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-4"></a>$<span class="w"> </span>cat<span class="w"> </span>/etc/tinc/example/tinc-up
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-5"></a><span class="nv">$!</span>/bin/sh
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-6"></a>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">$INTERFACE</span><span class="w"> </span>up
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-7"></a>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.0.1/24<span class="w"> </span>dev<span class="w"> </span><span class="nv">$INTERFACE</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-8"></a>$<span class="w"> </span>cat<span class="w"> </span>/etc/tinc/example/tinc-down
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-9"></a><span class="nv">$!</span>/bin/sh
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-10"></a>ip<span class="w"> </span>addr<span class="w"> </span>del<span class="w"> </span><span class="m">192</span>.168.0.1/24<span class="w"> </span>dev<span class="w"> </span><span class="nv">$INTERFACE</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-11"></a>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">$INTERFACE</span><span class="w"> </span>down
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-12"></a>$<span class="w"> </span>cat<span class="w"> </span>/etc/tinc/example/hosts/linux
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-13"></a><span class="nv">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>linux_ip
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-14"></a><span class="nv">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">655</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-15"></a><span class="nv">Subnet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">192</span>.168.0.1/24
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-8-16"></a>$<span class="w"> </span>tincd<span class="w"> </span>-n<span class="w"> </span>example<span class="w"> </span>-K
</span></code></pre></div></p>
<p>接着，把 linux 上 /etc/tinc/example/hosts/linux 拷贝到 macos 的 /usr/local/etc/tinc/example/hosts/linux，然后把 macos 上 /usr/local/etc/tinc/example/hosts/macos 拷贝到 /etc/tinc/example/hosts/macos。在两台机器上都 <code>tinc -n example -D -d3</code> 即可看到连接的建立，通过 ping 即可验证网络建立成功。</p>
<p>2018-05-29 Update: Android 上，利用 Tinc GUI 也可以把 Tinc 运行起来，只是配置不大一样：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-1"></a>$<span class="w"> </span>cat<span class="w"> </span>tinc.conf
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-2"></a><span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>example
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-3"></a><span class="nv">Device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/dev/tun
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-4"></a><span class="nv">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>switch
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-5"></a><span class="nv">ConnectTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>remote
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-6"></a><span class="nv">ScriptsInterpreter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/system/bin/sh
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-7"></a>$<span class="w"> </span>cat<span class="w"> </span>tinc-up
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-8"></a><span class="c1">##!/bin/sh</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-9"></a>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">$INTERFACE</span><span class="w"> </span>up
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-10"></a>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span>local_ip/24<span class="w"> </span>dev<span class="w"> </span><span class="nv">$INTERFACE</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-11"></a>$<span class="w"> </span>cat<span class="w"> </span>tinc-down
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-12"></a><span class="c1">##!/bin/sh</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-13"></a>ip<span class="w"> </span>addr<span class="w"> </span>del<span class="w"> </span>local_ip/24<span class="w"> </span>dev<span class="w"> </span><span class="nv">$INTERFACE</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-14"></a>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">$INTERFACE</span><span class="w"> </span>down
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-15"></a>$<span class="w"> </span>cat<span class="w"> </span>subnet-up
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-16"></a><span class="nv">$!</span>/bin/bash
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-17"></a><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-18"></a>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="nv">$SUBNET</span><span class="w"> </span>dev<span class="w"> </span><span class="nv">$INTERFACE</span><span class="w"> </span>metric<span class="w"> </span><span class="nv">$WEIGHT</span><span class="w"> </span>table<span class="w"> </span><span class="nb">local</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-19"></a>$<span class="w"> </span>cat<span class="w"> </span>subnet-down
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-20"></a><span class="c1">##!/bin/bash</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-21"></a><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="../../networking/2018/05/09/tinc-between-macos-and-linux/#__codelineno-9-22"></a>ip<span class="w"> </span>route<span class="w"> </span>del<span class="w"> </span><span class="nv">$SUBNET</span><span class="w"> </span>dev<span class="w"> </span><span class="nv">$INTERFACE</span><span class="w"> </span>table<span class="w"> </span><span class="nb">local</span>
</span></code></pre></div>
<p>注意 table local 的使用。需要 Root。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/05/09/tinc-between-macos-and-linux/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-08 00:00:00">2018年5月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ftp-server-behind-nat"><a class="toclink" href="../../networking/2018/05/08/ftp-behind-nat/">搭建 FTP server behind NAT</a></h2>
<p>我们出现新的需求，要把以前的 FTP 服务器迁移到 NAT 之后的一台机器上。但是，FTP 不仅用到 20 21 端口，PASV 还会用到高端口，这给端口转发带来了一些麻烦。我们一开始测试，直接在 Router 上转发 20 和 21 端口到 Server 上。但是很快发现，Filezilla 通过 PASV 获取到地址为（内网地址，端口高 8 位，端口低 8 位），然后，Filezilla 检测出这个地址是内网地址，于是转而向 router_ip:port 发包，这自然是不会得到结果的。</p>
<p>此时我们去网上找了找资料，找到了一个很粗暴的方法：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-0-1"></a>iptables<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-i<span class="w"> </span>external_interface<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">20</span><span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span>internal_ip:20
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-0-2"></a>iptables<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-i<span class="w"> </span>external_interface<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">21</span><span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span>internal_ip:21
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-0-3"></a>iptables<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-i<span class="w"> </span>external_interface<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">1024</span>:65535<span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span>internal_ip:1024-65535
</span></code></pre></div></p>
<p>有趣地是，macOS 自带的 ftp 命令（High Sierra 似乎已经删去）可以正常使用。研究发现，它用 EPSV（Extended Passive Mode）代替 PASV，这里并没有写内网地址，因而可以正常使用。</p>
<p>这么做，Filezilla 可以成功访问了。但是，用其它客户端的时候，它会直连那个内网地址而不是 Router 的地址，于是还是连不上。而且，使用了 1024-65535 的所有端口，这个太浪费而且会影响我们其它的服务。</p>
<p>我们开始研究我们 FTP 服务器 (pyftpdlib) 的配置。果然，找到了适用于 FTP behind NAT 的相关配置：
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-1"></a>     - (str) masquerade_address:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-2"></a>        the &quot;masqueraded&quot; IP address to provide along PASV reply when
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-3"></a>        pyftpdlib is running behind a NAT or other types of gateways.
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-4"></a>        When configured pyftpdlib will hide its local address and
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-5"></a>        instead use the public address of your NAT (default None).
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-6"></a>     - (dict) masquerade_address_map:
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-7"></a>        in case the server has multiple IP addresses which are all
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-8"></a>        behind a NAT router, you may wish to specify individual
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-9"></a>        masquerade_addresses for each of them. The map expects a
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-10"></a>        dictionary containing private IP addresses as keys, and their
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-11"></a>        corresponding public (masquerade) addresses as values.
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-12"></a>     - (list) passive_ports:
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-13"></a>        what ports the ftpd will use for its passive data transfers.
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-14"></a>        Value expected is a list of integers (e.g. range(60000, 65535)).
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-15"></a>        When configured pyftpdlib will no longer use kernel-assigned
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../networking/2018/05/08/ftp-behind-nat/#__codelineno-1-16"></a>        random ports (default None).
</span></code></pre></div></p>
<p>于是，我们配置了 <code>masquerade_address</code> 使得 FTP 服务器会在 PASV 中返回 Router 的地址，并且在 <code>passive_ports</code> 中缩小了 <code>pyftpdlib</code> 使用的端口范围。</p>
<p>进行配置以后，我们在前述的 iptables 命令中相应修改了端口范围，现在工作一切正常。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/05/08/ftp-behind-nat/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-08 00:00:00">2018年5月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nginx-vmware-esxi"><a class="toclink" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/">使用 Nginx 转发 VMware ESXi</a></h2>
<p>我们的 VMware ESXi 在一台 NAT Router 之后，但是我们希望通过域名可以直接访问 VMware ESXi。我们首先的尝试是，把 8443 转发到它的 443 端口，比如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-0-1"></a>socat<span class="w"> </span>TCP-LISTEN:8443,reuseaddr,fork<span class="w"> </span>TCP:esxi_addr:443
</span></code></pre></div>
<p>它能工作地很好（假的，如果你把 8443 换成 9443 它就不工作了），但是，我们想要的是，直接通过 esxi.example.org 就可以访问它。于是，我们需要 Nginx 在其中做一个转发的功能。在这个过程中遇到了很多的坑，最后终于是做好了（VMware Remote Console 等功能还不行，需要继续研究）。</p>
<p>首先讲讲为啥把 8443 换成 9443 不能工作吧 -- 很简单，ESXi 的网页界面会请求 8443 端口。只是恰好我用 8443 转发到 443，所以可以正常工作。这个很迷，但是测试的结果确实如此。VMware Remote Console 还用到了别的端口，我还在研究之中。</p>
<p>来谈谈怎么配置这个 Nginx 转发吧。首先是 80 跳转 443:
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-1-1"></a>server {
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-1-2"></a>        listen 80;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-1-3"></a>        listen 8080;
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-1-4"></a>        server_name esxi.example.org;
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-1-6"></a>        return 301 https://$host$request_uri;
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-1-7"></a>}
</span></code></pre></div></p>
<p>这个很简单，接下来是转发 443 端口：
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-1"></a>server {
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-2"></a>        listen 443 ssl;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-3"></a>        server_name esxi.example.org;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-4"></a>        ssl_certificate /path/to/ssl/cert.pem;
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-5"></a>        ssl_certificate_key /path/to/ssl/key.pem;
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-7"></a>        location / {
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-8"></a>                proxy_pass https://esxi_addr;
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-9"></a>                proxy_ssl_verify off;
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-10"></a>                proxy_ssl_session_reuse on;
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-11"></a>                proxy_set_header Host $http_host;
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-12"></a>                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-13"></a>                proxy_set_header X-Forwarded-Proto $scheme;
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-14"></a>        }
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-2-15"></a>}
</span></code></pre></div></p>
<p>此时，打开 https://esxi.example.org 就能看到登录界面了。但是仍然无法登录。从 DevTools 看错误，发现它请求了 8443 端口。于是进行转发：
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-1"></a>server {
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-2"></a>        listen 8443 ssl;
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-3"></a>        server_name esxi.example.org;
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-4"></a>        ssl_certificate /path/to/ssl/cert.pem;
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-5"></a>        ssl_certificate_key /path/to/ssl/key.pem;
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-8"></a>        location / {
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-9"></a>                if ($request_method = &#39;OPTIONS&#39;) {
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-10"></a>                        add_header &#39;Access-Control-Allow-Origin&#39; &#39;https://esxi.example.org&#39;;
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-11"></a>                        add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-12"></a>                        add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET, POST, OPTIONS&#39;;
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-13"></a>                        add_header &#39;Access-Control-Max-Age&#39; 1728000;
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-14"></a>                        add_header &#39;Access-Control-Allow-Headers&#39; &#39;VMware-CSRF-Token,DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Cookie,SOAPAction&#39;;
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-15"></a>                        add_header &#39;Content-Type&#39; &#39;text/plain; charset=utf-8&#39;;
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-16"></a>                        add_header &#39;Content-Length&#39; 0;
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-17"></a>                        return 204;
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-18"></a>                }
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-19"></a>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-20"></a>                add_header &#39;Access-Control-Allow-Origin&#39; &#39;https://esxi.example.org&#39;;
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-21"></a>                add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-22"></a>                proxy_pass https://esxi_addr:443;
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-23"></a>                proxy_ssl_verify off;
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-24"></a>                proxy_ssl_session_reuse on;
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-25"></a>                proxy_set_header Host $http_host;
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-26"></a>                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-27"></a>                proxy_set_header X-Forwarded-Proto $scheme;
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-28"></a>        }
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-3-29"></a>}
</span></code></pre></div></p>
<p>主要麻烦的是配置 CORS 的相关策略。我也是看了 DevTools 的错误提示半天才慢慢写出来的。这样配置以后，就可以成功登录 VMware ESXi 了。</p>
<p>20:02 更新：现在做了 WebSocket 转发，目前可以在浏览器中打开 Web Console 了。但是，在访问 https://esxi.example.org/ 的时候还是会出现一些问题，然而 https://esxi.example.org:8443/ 是好的。</p>
<p>转发 WebSocket：
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-1"></a>map $http_upgrade $connection_upgrade {
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-2"></a>        default upgrade;
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-3"></a>        &#39;&#39;      close;
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-4"></a>}
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-6"></a>server {
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-7"></a>        listen 8443 ssl;
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-8"></a>        server_name esxi.example.org;
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-9"></a>        ssl_certificate /path/to/ssl/cert.pem;
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-10"></a>        ssl_certificate_key /path/to/ssl/key.pem;
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-11"></a>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-13"></a>        location / {
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-15"></a>                if ($request_method = &#39;OPTIONS&#39;) {
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-16"></a>                        add_header &#39;Access-Control-Allow-Origin&#39; &#39;https://esxi.example.org&#39;;
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-17"></a>                        add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-18"></a>                        add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET, POST, OPTIONS&#39;;
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-19"></a>                        add_header &#39;Access-Control-Max-Age&#39; 1728000;
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-20"></a>                        add_header &#39;Access-Control-Allow-Headers&#39; &#39;VMware-CSRF-Token,DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Cookie,SOAPAction&#39;;
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-21"></a>                        add_header &#39;Content-Type&#39; &#39;text/plain; charset=utf-8&#39;;
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-22"></a>                        add_header &#39;Content-Length&#39; 0;
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-23"></a>                        return 204;
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-24"></a>                }
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-26"></a>                add_header &#39;Access-Control-Allow-Origin&#39; &#39;https://esxi.example.org&#39; always;
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-27"></a>                add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39; always;
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-29"></a>                proxy_pass https://esxi_addr:443;
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-30"></a>                proxy_ssl_verify off;
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-31"></a>                proxy_ssl_session_reuse on;
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-32"></a>                proxy_set_header Host $http_host;
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-33"></a>                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-34"></a>                proxy_set_header X-Forwarded-Proto $scheme;
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-35"></a>                proxy_set_header Upgrade $http_upgrade;
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-36"></a>                proxy_set_header Connection $connection_upgrade;
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-37"></a>        }
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-4-38"></a>}
</span></code></pre></div></p>
<p>20:29 更新：找到了 VMware Remote Console 的端口：902，用 iptables 进行 DNAT 即可：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-5-1"></a>iptables<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-i<span class="w"> </span>wan_interface<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">902</span><span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span>esxi_addr:902
</span></code></pre></div></p>
<p>2018-05-09 08:07 更新：最后发现，还是直接隧道到内网访问 ESXi 最科学。或者，让 443 重定向到 8443：
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-1"></a>server {
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-2"></a>        listen 443 ssl;
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-3"></a>        server_name esxi.example.org;
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-4"></a>        ssl_certificate /path/to/ssl/cert.pem;
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-5"></a>        ssl_certificate_key /path/to/ssl/key.pem;
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-7"></a>        return 301 https://$host:8443$request_uri;
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/#__codelineno-6-8"></a>}
</span></code></pre></div>
这样，前面也不用写那么多 CORS 的东西了。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/05/08/nginx-proxy-vmware-esxi/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-06 00:00:00">2018年5月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="iptables-forwarding"><a class="toclink" href="../../networking/2018/05/06/nat-forwarding-with-src-address/">使用 iptables 和策略路由进行带源地址的 forwarding</a></h2>
<p>陈老师打开他的服务器，突然发现 CPU 莫名高负载，然后发现是有一个用户被远程登录拿来挖矿了。但是这台机器在 NAT 后，所以登录的源地址全是 NAT 路由，所以不知道对方的地址是什么。我们为了能使用 fail2ban 来禁用多次尝试失败的 IP，但又不想因为别人把 NAT 路由的地址给禁了，这样我们自己也用不了了。所以必须要让这台机器能够知道 ssh 的源地址，我们现在简单的 socat 方案不能满足这个需求。</p>
<p>需求：</p>
<ol>
<li>可以在外网连 NAT 路由的高端口（如 2222）来访问这台机器。</li>
<li>在内网中，既可以直接连它的内网地址，也可以连 NAT 路由的高端口来访问这台服务器。此时，由于连 ssh 的机器就在同一个子网中，如果保留了源地址，服务器发的包会直接回来不经过 NAT。所以我们还是保留了 socat 的方案。</li>
</ol>
<p>实现方法：</p>
<p>在 NAT Router 上配置 DNAT，这样发到 NAT Router 上的包就可以转发到服务器上：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-0-1"></a>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-i<span class="w"> </span>external_interface<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">2222</span><span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span>internal_server_ip:22
</span></code></pre></div>
<p>但是，从服务器回来的包到了 NAT Router 上后，由于路由表的配置问题，默认的路由并不能把包送达对方。</p>
<p>方法 1:
我们首先给包打上 mark：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-1-1"></a>iptables<span class="w"> </span>-t<span class="w"> </span>mangle<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-i<span class="w"> </span>internal_interface<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--sport<span class="w"> </span><span class="m">22</span><span class="w"> </span>-j<span class="w"> </span>MARK<span class="w"> </span>--set-mark<span class="w"> </span>0x2222
</span></code></pre></div>
<p>然后配置策略路由：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-2-1"></a>ip<span class="w"> </span>rule<span class="w"> </span>add<span class="w"> </span>fwmark<span class="w"> </span>0x2222<span class="w"> </span>table<span class="w"> </span><span class="m">2222</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-2-2"></a>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>table<span class="w"> </span><span class="m">2222</span><span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span>gateway_address
</span></code></pre></div>
<p>方法 2: (UPD 2018-07-07)
利用 <code>ip rule</code> 直接达成同样的效果</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-3-1"></a>ip<span class="w"> </span>rule<span class="w"> </span>add<span class="w"> </span>from<span class="w"> </span>internal_ip/prefix<span class="w"> </span>table<span class="w"> </span><span class="m">2222</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-3-2"></a><span class="c1">## or</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-3-3"></a>ip<span class="w"> </span>rule<span class="w"> </span>add<span class="w"> </span>iif<span class="w"> </span>internal_interface<span class="w"> </span>table<span class="w"> </span><span class="m">2222</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-3-4"></a>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>table<span class="w"> </span><span class="m">2222</span><span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span>gateway_address
</span></code></pre></div>
<p>这样就可以保证 ssh 的回包可以原路返回了。</p>
<p>由于前面提到的原因，上面我们配置的 DNAT 规则只对外网过来的包有效。为了内网的访问，我们仍然采用了 socat 的方式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../networking/2018/05/06/nat-forwarding-with-src-address/#__codelineno-4-1"></a>socat<span class="w"> </span>TCP-LISTEN:2222,reuseaddr,fork<span class="w"> </span>TCP:internal_server_ip:22
</span></code></pre></div>
<p>从不同的机器测试，都可以在 <code>who</code> 看到，地址确实是我们想看到的源地址。接下来配置 <code>fail2ban</code>即可。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/05/06/nat-forwarding-with-src-address/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-05 00:00:00">2018年5月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="upnp-mosh-nat"><a class="toclink" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/">利用 UPnP 协议进行 mosh NAT 穿透的研究</a></h2>
<p>由于经常要从宿舍、教室等不同的 Wi-Fi 之间切换，但是 ssh 连接又总是断，所以想用 mosh 代替 ssh。但是 mosh 也有它的问题：</p>
<ol>
<li>不能滚动。这个可以在 mosh 中嵌套一层 tmux 解决。我目前写了一些自动 mosh 后打开 tmux 并且开启鼠标支持的脚本，但还是有缺陷。</li>
<li>在高端口 60000+ 监听 UDP，这使得 NAT 后的服务器难以直接通过端口转发。如果直接转发到 NAT 后的机器，那么 NAT 后面如果有多台机器，这又失效了。</li>
</ol>
<p>于是找了找网上的 NAT 穿透的一些文章，看到了 UPnP 的方法。大致就是，用户可以向路由器注册一个临时的转发规则，路由会自动在 iptables 上配置转发。但是，这样也会遇到一个问题：路由上的 mosh-server 不知道这个转发的存在，所以它可能会尝试监听同样的端口。解决方案下面会提到。</p>
<p>需求：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-0-1"></a>Server &lt;---&gt; NAT Router &lt;---&gt; My Laptop
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-0-2"></a>On NAT Router, port 8022 is forwarded to Server:22
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-0-3"></a>1. mosh router # works
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-0-4"></a>2. mosh --ssh=&quot;ssh -p 8022&quot; router # works
</span></code></pre></div>
<p>首先在 NAT Router 上配置 miniupnpd（以 Debian 为例）</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>miniupnpd
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-2"></a><span class="c1">## you will get a dialog upon installation</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-3"></a><span class="c1">## input your wan interface and listening ip accordingly</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-4"></a>sudo<span class="w"> </span>vim<span class="w"> </span>/etc/default/miniupnpd
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-5"></a><span class="c1">## edit START_DAEMON=0 to START_DAEMON=1</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-6"></a>sudo<span class="w"> </span>vim<span class="w"> </span>/etc/miniupnpd/miniupnpd.conf
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-7"></a><span class="c1">## edit ext_ifname, listening_ip accordingly</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-8"></a><span class="c1">## set secure_mode=yes</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-9"></a><span class="c1">## add &#39;allow 60000-60023 internal_ip/prefix 60000-60023&#39;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-10"></a><span class="c1">## before the last line &#39;deny 0-65535 0.0.0.0/0 0-65535&#39;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-1-11"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>miniupnpd
</span></code></pre></div>
<p>现在，复制 <a href="https://github.com/jiegec/mosh-upnp-hole-puncher/blob/master/mosh-wrapper.js">我修改的 mosh-wrapper.js</a> 到用户的 home 目录下，在 Server 安装 <code>miniupnpc</code> 然后通过：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/#__codelineno-2-1"></a>mosh<span class="w"> </span>--ssh<span class="o">=</span><span class="s2">&quot;ssh -p 8022&quot;</span><span class="w"> </span>--server<span class="o">=</span>~/mosh-wrapper.js<span class="w"> </span>user@router
</span></code></pre></div>
<p>这样，mosh 首先会通过 ssh 和 Server 协商一个 AES 的密钥和 UDP 端口（如 60001），之后的通信都通过 UDP 端口走加密后的流量。我的 <code>mosh-wrapper.js</code> 通过 <code>miniupnpc</code> 向路由器请求把该 UDP 端口转发到 Server 上，这样， <code>mosh-server</code> 就能通过 NAT 路由穿透到后面的 Server 上。</p>
<p>等会！问题来了：</p>
<p><code>mosh</code> 默认的 IP 范围是 <code>60000-61000</code> ，根据我的观察，它会从 60001 开始尝试监听本机地址，如果已经被占用，则 60002, 60003, ... 但是！Router 和 Server 实际上占用了相同的端口空间，并且 <code>mosh</code> 只知道本机哪些端口被占用了，而不知道 Router 和 Server 共同占用了多少端口。</p>
<p>我想到了一些可能的解决方案：</p>
<ol>
<li>在 Router 上让 miniupnpd 监听对应的端口，占住这个坑。这样，Router 上的 <code>mosh-server</code> 就不会用和 Server 相同的端口</li>
<li>如果有多个 Server，则会出现抢夺相同端口的情况。我目前的想法是，让 <code>upnpc</code> 去询问 Router 找空闲的端口，然后再传给 <code>mosh-server</code> 使用。另一种方法则是，给不同的 Server 划分不同的端口范围，比如 Router 用 60001-60005, 然后 Server1 用 60006-60010, Server2 用 60011-60015 如此下去。</li>
</ol>
<p>然后，新的问题又发现了：</p>
<p>当我在和 Server 同一个子网的时候，由于 <code>miniupnpd</code> 配置的 <code>iptables</code> 规则中来源只有 WAN interface，所以我在内网发的包是不会被转发的。当然，既然在内网了，为啥不直接用内网 IP 呢，不知道 <code>mosh</code> 有没有提供设置备用 IP 的功能。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/05/05/mosh-behind-nat-with-upnp/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-04-28 00:00:00">2018年4月28日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cisco-ac-ap"><a class="toclink" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/">使用 Cisco AC + AP 组合搭建网络实践</a></h2>
<p>有一台已配置好直接可用的 AC 在地址 ac-address。我们需要搭建交换机 + AP 的网络，并且用一台 Linux 服务器进行 DHCP 从而给 AP 分发 AC 的地址。这里以 systemd-networkd 为例。</p>
<p>我们约定，vlan 2 上联外网，vlan 3 为 Linux 服务器和 AP 的内部网络。</p>
<p>接下来，配置交换机给 Linux 服务器的端口为 trunk 口，然后将下联 Cisco AP 的端口都设为 access vlan 3 模式。接下来在 Linux 服务器上配置 DHCP 服务器和 NAT。</p>
<p>如果 Linux 服务器的 interface 名称为 eno1 :</p>
<p>配置两个 VLAN interface:
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-0-1"></a>$ cat /etc/systemd/network/eno1.network
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-0-2"></a>[Match]
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-0-3"></a>Name=eno1
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-0-5"></a>[Network]
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-0-6"></a>VLAN=eno1.2
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-0-7"></a>VLAN=eno1.3
</span></code></pre></div></p>
<p>相应添加 VLAN 配置：
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-1"></a>$ cat /etc/systemd/network/eno1.2.network
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-2"></a>[NetDev]
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-3"></a>Name=eno1.2
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-5"></a>[VLAN]
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-6"></a>Id=2
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-7"></a>$ cat /etc/systemd/network/eno1.3.network
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-8"></a>[NetDev]
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-9"></a>Name=eno1.3
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-11"></a>[VLAN]
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-1-12"></a>Id=3
</span></code></pre></div></p>
<p>配置上行的 eno1.2 interface 的静态地址：
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-1"></a>$ cat /etc/systemd/network/eno1.2.network
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-2"></a>[Match]
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-3"></a>Name=eno1.2
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-5"></a>[Network]
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-6"></a>Address=123.123.123.123/24
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-7"></a>Gateway=123.123.123.1
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-2-8"></a>DNS=1.2.4.8
</span></code></pre></div></p>
<p>配置内部网络 eno1.3 interface:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-3-1"></a>$ cat /etc/systemd/network/eno1.3.network
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-3-2"></a>[Match]
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-3-3"></a>Name=eno1.3
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-3-5"></a>[Network]
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-3-6"></a>Address=192.168.1.1/24
</span></code></pre></div></p>
<p>配置 dhcpd (isc-dhcp-server):
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-1"></a>$ cat /etc/default/isc-dhcp-server
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-2"></a>INTERFACESv4=&quot;eno1.3&quot;
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-3"></a>$ cat /etc/dhcpd.conf
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-4"></a>option space Cisco_LWAPP_AP;
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-5"></a>option Cisco_LWAPP_AP.server-address code 241 = array of ip-address;
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-7"></a>subnet 192.168.1.0 netmask 255.255.255.0 {
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-8"></a>  range 192.168.1.100 192.168.1.200;
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-9"></a>  option routers 192.168.1.1;
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-10"></a>  vendor-option-space Cisco_LWAPP_AP;
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-11"></a>  option Cisco_LWAPP_AP.server-address $ac-address;
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-4-12"></a>}
</span></code></pre></div></p>
<p>配置 iptables 做 NAT:
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-5-1"></a>iptables -t nat -A POSTROUTING -o eno1.2 -j MASQUERADE
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-5-2"></a>iptables-save &gt; /etc/iptables/iptables.rules
</span></code></pre></div></p>
<p>打开 ipv4 forwarding:
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-6-1"></a>echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/#__codelineno-6-2"></a>echo &#39;net.ipv4.conf.all.forwarding=1&#39; &gt;&gt; /etc/sysctl.d/99-ipv4-forwarding.conf
</span></code></pre></div></p>

    <nav class="md-post__action">
      <a href="../../networking/2018/04/28/wifi-with-cisco-ac-and-ap/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-01-02 00:00:00">2018年1月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nat64"><a class="toclink" href="../../networking/2018/01/02/first-trail-of-NAT64/">NAT64 初尝试</a></h2>
<p>最近宿舍里有线网络的 IPv4 总是拿不到地址，只能连无线网，不禁对计算机系学生的可怕的设备数量有了深刻的认识。不过，作为一个有道德（误）的良好青年，还是不要给已经枯竭的 IPv4 地址填堵了，还是赶紧玩玩 IPv6 的网络吧。然后在 TUNA 群里受青年千人续本达 (@heroxbd) 的安利，本地搭建一下 NAT64+DNS64 的环境。不过考虑到宿舍还是拿不到有线的 IPv4 地址，我就先利用苹果先前在强制 iOS 的应用支持 NAT64 网络的同时，在 macOS 上为了方便开发者调试，提供的便捷的建立 NAT64 网络的能力。</p>
<p>首先在设置中按住 Option 键打开 Sharing，点击 Internet Sharing，勾上 Create NAT64 Network 然后把网络共享给设备。然后在手机上关掉 Wi-Fi 和 Cellular，发现还能正常上网。此时可以打开 Wireshark 验证我们的成果了：</p>
<p>在手机上打开浏览器，浏览千度，得到如下的 Wireshark 截图：
<img alt="baidu-nat64" src="/images/baidu-nat64.jpg" /></p>
<p>这里，<code>2001:2:0:aab1::1</code> 是本机在这个子网中的地址，<code>2001:2::aab1:cda2:5de:87f6:fd78</code> 是我的 iOS 设备的地址，然后 iOS 向 macOS 发出了 DNS 请求，macOS 发送 DNS 请求后得到 <code>baidu.com</code> 的 IPv4 地址之一为 <code>111.13.101.208</code> ：
<img alt="baidu-dns" src="/images/baidu-dns.jpg" /></p>
<p>上图中，我们可以看到， <code>baidu.com</code> 的 <code>AAAA</code> 记录是 <code>2001:2:0:1baa::6f0d:65d0</code> ，这个就是 DNS64 转译的地址，前面为网关的 <code>prefix</code> ，后面就是对应的 IPv4 地址： <code>0x6f=111, 0x0d=13, 0x65=101, 0xd0=208</code> ，当客户端向这个地址发包的时候，网关发现前缀符合条件，把最后的这部分 IPv4 地址取出来，自己把包发送到真实的地址上去，再把返回来的包再转为 IPv6 的地址返还给客户端。可以验证，剩下的几个地址也符合这个转译规则。</p>
<p>这就实现了：利用一台连接着 IPv6 和 IPv4 两种网络的网关，可以使得 IPv6 这个网络通过网关访问 IPv4。通过配置，也可以使得 IPv4 访问 IPv6 中的地址（即 Stateful 和 Stateless 的区分，需要手动配置映射）。</p>
<p>好处：作为比较成熟的 IPv4 到 IPv6 过渡方案之一，可以让自己组建的 IPv6 网络访问一些仅 IPv4 的网站。
坏处：依赖于 DNS64，必须要经过一层翻译，一些应用或协议可能写死了 IPv4 的地址，该方法可能会失效。</p>

    <nav class="md-post__action">
      <a href="../../networking/2018/01/02/first-trail-of-NAT64/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../misc/" class="md-footer__link md-footer__link--prev" aria-label="上一页: misc" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                misc
              </div>
            </div>
          </a>
        
        
          
          <a href="../news/" class="md-footer__link md-footer__link--next" aria-label="下一页: news" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                news
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
        
      
    
  </body>
</html>