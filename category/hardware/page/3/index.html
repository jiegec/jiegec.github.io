
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维，编程，调板子}小笔记" name="description"/>
<link href="https://jia.je/category/hardware/page/3/" rel="canonical"/>
<link href="../../../devops/" rel="prev"/>
<link href="../../../meta/" rel="next"/>
<link href="../../../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>hardware - 杰哥的{运维，编程，调板子}小笔记</title>
<link href="../../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-3109FRSVTT",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#hardware">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维，编程，调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="杰哥的{运维，编程，调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维，编程，调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              hardware
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/jiegec/blog-source" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../about/">
        
  
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../open-source-contributions/">
        
  
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../tags/">
        
  
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/cpu/">
        
  
  
    
  
  CPU

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../series/">
        
  
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../projects/">
        
  
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../tools/">
        
  
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../benchmark/">
        
  
  
    
  
  SPEC

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../archive/2025/">
          
  
  
  归档

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../../crypto/">
          
  
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维，编程，调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="杰哥的{运维，编程，调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    杰哥的{运维，编程，调板子}小笔记
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/jiegec/blog-source" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    博客
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../about/">
<span class="md-ellipsis">
    关于
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../open-source-contributions/">
<span class="md-ellipsis">
    开源
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../tags/">
<span class="md-ellipsis">
    标签
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/cpu/">
<span class="md-ellipsis">
    CPU
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../series/">
<span class="md-ellipsis">
    系列
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../projects/">
<span class="md-ellipsis">
    项目
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../tools/">
<span class="md-ellipsis">
    工具
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../benchmark/">
<span class="md-ellipsis">
    SPEC
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
<span class="md-ellipsis">
    归档
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_12_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_12">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2025/">
<span class="md-ellipsis">
    2025
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2024/">
<span class="md-ellipsis">
    2024
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2023/">
<span class="md-ellipsis">
    2023
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2022/">
<span class="md-ellipsis">
    2022
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2021/">
<span class="md-ellipsis">
    2021
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2020/">
<span class="md-ellipsis">
    2020
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2019/">
<span class="md-ellipsis">
    2019
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2018/">
<span class="md-ellipsis">
    2018
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2017/">
<span class="md-ellipsis">
    2017
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2016/">
<span class="md-ellipsis">
    2016
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../archive/2014/">
<span class="md-ellipsis">
    2014
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_13" type="checkbox"/>
<label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="">
<span class="md-ellipsis">
    分类
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_13_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_13">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../crypto/">
<span class="md-ellipsis">
    crypto
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../csdn/">
<span class="md-ellipsis">
    csdn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ctf/">
<span class="md-ellipsis">
    ctf
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../devops/">
<span class="md-ellipsis">
    devops
    
  </span>
</a>
</li>
<li class="md-nav__item">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    hardware
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="../../">
<span class="md-ellipsis">
    hardware
    
  </span>
</a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#浅谈乱序执行-cpu二访存">
<span class="md-ellipsis">
      浅谈乱序执行 CPU（二：访存）
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#用-sv2vyosys-把-fpnew-转为-verilog-网表">
<span class="md-ellipsis">
      用 sv2v+yosys 把 fpnew 转为 verilog 网表
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#synopsys-design-compiler-综合实践">
<span class="md-ellipsis">
      Synopsys Design Compiler 综合实践
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#openroad-flow-初尝试">
<span class="md-ellipsis">
      OpenROAD Flow 初尝试
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#通过-jtag-对-vcu128-上的-rocket-chip-进行调试">
<span class="md-ellipsis">
      通过 JTAG 对 VCU128 上的 Rocket Chip 进行调试
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#分析-diplomacy-系统">
<span class="md-ellipsis">
      分析 Diplomacy 系统
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chisel3-cookbook">
<span class="md-ellipsis">
      Chisel3 Cookbook
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#教学缓存一致性协议分析">
<span class="md-ellipsis">
      「教学」缓存一致性协议分析
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dram-在-kintex-7-fpga-上内部-vref-的性能问题">
<span class="md-ellipsis">
      DRAM 在 Kintex 7 FPGA 上内部 Vref 的性能问题
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#教学dram-结构和特性">
<span class="md-ellipsis">
      「教学」DRAM 结构和特性
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#教学risc-v-debug-协议">
<span class="md-ellipsis">
      「教学」RISC-V Debug 协议
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#manycore-处理器架构分析">
<span class="md-ellipsis">
      Manycore 处理器架构分析
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sunway-处理器架构分析">
<span class="md-ellipsis">
      Sunway 处理器架构分析
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#移植系统到-rocket-chip-on-vcu128">
<span class="md-ellipsis">
      移植系统到 Rocket Chip on VCU128
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#教学axi-quad-spi-时序分析">
<span class="md-ellipsis">
      「教学」AXI Quad SPI 时序分析
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#浅谈乱序执行-cpu一乱序">
<span class="md-ellipsis">
      浅谈乱序执行 CPU（一：乱序）
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#硬盘相关的概念">
<span class="md-ellipsis">
      硬盘相关的概念
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#linksys-e8450-openwrt-配置-w-80211ax">
<span class="md-ellipsis">
      Linksys E8450 OpenWRT 配置 w/ 802.11ax
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pcb-笔记">
<span class="md-ellipsis">
      PCB 笔记
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#skid-buffer">
<span class="md-ellipsis">
      Skid Buffer
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#以太网的物理接口">
<span class="md-ellipsis">
      以太网的物理接口
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#arm-m1-macbook-air-开箱">
<span class="md-ellipsis">
      ARM M1 MacBook Air 开箱
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fido-u2ffido2-和-ctap-的关系">
<span class="md-ellipsis">
      FIDO U2F、FIDO2 和 CTAP 的关系
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mifare-classic-上配置-ndef">
<span class="md-ellipsis">
      MIFARE Classic 上配置 NDEF
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#在命令行中进行-vivado-仿真">
<span class="md-ellipsis">
      在命令行中进行 Vivado 仿真
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../meta/">
<span class="md-ellipsis">
    meta
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../misc/">
<span class="md-ellipsis">
    misc
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../networking/">
<span class="md-ellipsis">
    networking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../os/">
<span class="md-ellipsis">
    os
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../others/">
<span class="md-ellipsis">
    others
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../programming/">
<span class="md-ellipsis">
    programming
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../software/">
<span class="md-ellipsis">
    software
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../system/">
<span class="md-ellipsis">
    system
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="hardware">hardware<a class="headerlink" href="#hardware" title="Permanent link">¶</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-31 00:00:00+00:00">2022年3月31日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 18 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="浅谈乱序执行-cpu二访存"><a class="toclink" href="../../../../hardware/2022/03/31/brief-into-ooo-2/">浅谈乱序执行 CPU（二：访存）</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/ooo_cpu.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/03/31/brief-into-ooo-2/#背景">背景</a></h3>
<p>之前写过一个<a href="../../../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU</a>，随着学习的深入，内容越来越多，页面太长，因此把后面的一部分内容独立出来，变成了这篇博客文章。</p>
<p>本文主要讨论访存的部分。</p>
<p>本系列的所有文章：</p>
<ul>
<li><a href="../../../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU（一：乱序）</a></li>
<li><a href="../../../../hardware/2022/03/31/brief-into-ooo-2/">浅谈乱序执行 CPU（二：访存）</a></li>
<li><a href="../../../../hardware/2024/09/12/brief-into-ooo-3/">浅谈乱序执行 CPU（三：前端）</a></li>
</ul>
<nav class="md-post__action">
<a href="../../../../hardware/2022/03/31/brief-into-ooo-2/">
          继续阅读
        </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-30 00:00:00+00:00">2022年3月30日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="用-sv2vyosys-把-fpnew-转为-verilog-网表"><a class="toclink" href="../../../../hardware/2022/03/30/sv2v-fpnew/">用 sv2v+yosys 把 fpnew 转为 verilog 网表</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/03/30/sv2v-fpnew/#背景">背景</a></h3>
<p>FPnew 是一个比较好用的浮点计算单元，但它是 SystemVerilog 编写的，并且用了很多高级特性，虽然闭源软件是支持的，但是开源拖拉机经常会遇到这样那样的问题。所以一直想用 sv2v 把它翻译成 Verilog，但此时的 Verilog 还有很多复杂的结构，再用 yosys 转换为一个通用可综合的网表。</p>
<h3 id="步骤"><a class="toclink" href="../../../../hardware/2022/03/30/sv2v-fpnew/#步骤">步骤</a></h3>
<p>经过一系列踩坑，一个很重要的点是要用最新的 sv2v(v0.0.9-24-gf868f06) 和 yosys(0.15+70)。Debian 打包的 yosys 版本比较老，不能满足需求。</p>
<p>首先，用 verilator 进行预处理，把一堆 sv 文件合成一个：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>$<span class="w"> </span>cat<span class="w"> </span>a.sv<span class="w"> </span>b.sv<span class="w"> </span>c.sv<span class="w"> </span>&gt;<span class="w"> </span>test.sv
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>$<span class="w"> </span>verilator<span class="w"> </span>-E<span class="w"> </span>test.sv<span class="w"> </span>&gt;<span class="w"> </span>merged.sv
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">'/^`line/d'</span><span class="w"> </span>merged.sv
</span></code></pre></div>
<p>注意这里用 sed 去掉了无用的行号信息。然后，用 sv2v 进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>$<span class="w"> </span>sv2v<span class="w"> </span>merged.sv<span class="w"> </span>&gt;<span class="w"> </span>merge.v
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">'/\$$fatal/d'</span><span class="w"> </span>merge.v
</span></code></pre></div>
<p>这里又用 sed 把不支持的 $fatal 去掉。最后，用 yosys 进行处理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>$<span class="w"> </span>yosys<span class="w"> </span>-p<span class="w"> </span><span class="s1">'read_verilog -defer merge.v'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'hierarchy -p fpnew_top'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'proc'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'opt'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'write_verilog -noattr output.v'</span>
</span></code></pre></div>
<p>注意这里要用 <code>read_verilog -defer</code>，否则 yosys 会遇到 TAG_WIDTH=0 默认参数就直接例化，然后就出现 <code>[0:-1]</code> 这样的下标。<code>read_verilog</code> 的文档告诉了我们可以分两步做：</p>
<div class="language-text highlight"><pre><span></span><code>-defer
    only read the abstract syntax tree and defer actual compilation
    to a later 'hierarchy' command. Useful in cases where the default
    parameters of modules yield invalid or not synthesizable code.
</code></pre></div>
<p>这样就得到了简化后的 verilog 代码：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">module</span><span class="w"> </span><span class="n">\$paramod$011e4d7ee08c34f246a38322dc9967d23ecc8081\fpnew_opgroup_block_A94B6_B7406</span><span class="w"> </span><span class="p">(</span><span class="n">clk_i</span><span class="p">,</span><span class="w"> </span><span class="n">rst_ni</span><span class="p">,</span><span class="w"> </span><span class="n">operands_i</span><span class="p">,</span><span class="w"> </span><span class="n">is_boxed_i</span><span class="p">,</span><span class="w"> </span><span class="n">rnd_mode_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_mod_i</span><span class="p">,</span><span class="w"> </span><span class="n">src_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">int_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">vectorial_op_i</span><span class="p">,</span><span class="w"> </span><span class="n">tag_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_valid_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_ready_o</span><span class="p">,</span><span class="w"> </span><span class="n">flush_i</span><span class="p">,</span><span class="w"> </span><span class="n">result_o</span><span class="p">,</span><span class="w"> </span><span class="n">status_o</span><span class="p">,</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">,</span><span class="w"> </span><span class="n">tag_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_valid_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_ready_i</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="p">,</span><span class="w"> </span><span class="n">busy_o</span><span class="p">);</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_0_</span><span class="p">;</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_1_</span><span class="p">;</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">71</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">arbiter_output</span><span class="p">;</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-13-11"><a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-13-12"><a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-13-13"><a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-13-14"><a href="#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">flush_i</span><span class="p">;</span>
</span><span id="__span-13-15"><a href="#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-13-16"><a href="#__codelineno-13-16" id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>这样虽然比较丑陋，但是解决了 SystemVerilog 的问题。诚然，这样也失去了修改参数的能力，因为参数已经在 yosys 综合途中确定下来了。</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-14 00:00:00+00:00">2022年3月14日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="synopsys-design-compiler-综合实践"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/">Synopsys Design Compiler 综合实践</a></h2>
<h3 id="工艺库"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#工艺库">工艺库</a></h3>
<p>综合很重要的一步是把 HDL 的逻辑变成一个个单元，这些单元加上连接方式就成为了网表。那么，基本单元有哪些，怎么决定用哪些基本单元？</p>
<p>这个就需要工艺库了，工艺库定义了一个个单元，单元的引脚、功能，还有各种参数，这样 Design Compiler 就可以按照这些信息去找到一个优化的网表。</p>
<h4 id="liberty-格式"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#liberty-格式">Liberty 格式</a></h4>
<p>网上可以找到一些 Liberty 格式的工艺库，比如 <a href="https://raw.githubusercontent.com/The-OpenROAD-Project/OpenROAD-flow-scripts/master/flow/platforms/nangate45/lib/NangateOpenCellLibrary_typical.lib">Nangate45</a>，它的设定是 25 摄氏度，1.10 伏，属于 TT（Typical/Typical）的 Process Corner。</p>
<p>在里面可以看到一些基本单元的定理，比如 <code>AND2_X1</code>，就是一个 drive strength 是 1 的二输入与门：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>cell (AND2_X1) {
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>    drive_strength : 1;
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>    pin (A1) {
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>        direction : input;
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>    }
</span><span id="__span-20-6"><a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>    pin (A2) {
</span><span id="__span-20-7"><a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a>        direction : input;
</span><span id="__span-20-8"><a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a>    }
</span><span id="__span-20-9"><a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a>    pin (ZN) {
</span><span id="__span-20-10"><a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a>        direction : output;
</span><span id="__span-20-11"><a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a>        function : "(A1 &amp; A2)";
</span><span id="__span-20-12"><a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a>    }
</span><span id="__span-20-13"><a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a>    /* ... */
</span><span id="__span-20-14"><a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a>}
</span></code></pre></div>
<p>这样就定义了两个输入 pin，一个输出 pin，还有它实现的功能。还有很重要的一点是保存了时序信息，比如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>lu_table_template (Timing_7_7) {
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a>    variable_1 : input_net_transition;
</span><span id="__span-21-3"><a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a>    variable_2 : total_output_net_capacitance;
</span><span id="__span-21-4"><a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a>    index_1 ("0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070");
</span><span id="__span-21-5"><a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a>    index_2 ("0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070");
</span><span id="__span-21-6"><a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a>}
</span><span id="__span-21-7"><a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a>cell (AND2_X1) {
</span><span id="__span-21-8"><a href="#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a>    pin (ZN) {
</span><span id="__span-21-9"><a href="#__codelineno-21-9" id="__codelineno-21-9" name="__codelineno-21-9"></a>        timing () {
</span><span id="__span-21-10"><a href="#__codelineno-21-10" id="__codelineno-21-10" name="__codelineno-21-10"></a>            related_pin : "A1";
</span><span id="__span-21-11"><a href="#__codelineno-21-11" id="__codelineno-21-11" name="__codelineno-21-11"></a>            timing_sense : positive_unate;
</span><span id="__span-21-12"><a href="#__codelineno-21-12" id="__codelineno-21-12" name="__codelineno-21-12"></a>            cell_fall(Timing_7_7) {
</span><span id="__span-21-13"><a href="#__codelineno-21-13" id="__codelineno-21-13" name="__codelineno-21-13"></a>                index_1 ("0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535");
</span><span id="__span-21-14"><a href="#__codelineno-21-14" id="__codelineno-21-14" name="__codelineno-21-14"></a>                index_2 ("0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400");
</span><span id="__span-21-15"><a href="#__codelineno-21-15" id="__codelineno-21-15" name="__codelineno-21-15"></a>                values ("0.0217822,0.0253224,0.0288237,0.0346827,0.0448323,0.0636086,0.100366", \
</span><span id="__span-21-16"><a href="#__codelineno-21-16" id="__codelineno-21-16" name="__codelineno-21-16"></a>                        "0.0233179,0.0268545,0.0303556,0.0362159,0.0463659,0.0651426,0.101902", \
</span><span id="__span-21-17"><a href="#__codelineno-21-17" id="__codelineno-21-17" name="__codelineno-21-17"></a>                        "0.0296429,0.0331470,0.0366371,0.0425000,0.0526603,0.0714467,0.108208", \
</span><span id="__span-21-18"><a href="#__codelineno-21-18" id="__codelineno-21-18" name="__codelineno-21-18"></a>                        "0.0402311,0.0440292,0.0477457,0.0538394,0.0641187,0.0829203,0.119654", \
</span><span id="__span-21-19"><a href="#__codelineno-21-19" id="__codelineno-21-19" name="__codelineno-21-19"></a>                        "0.0511250,0.0554077,0.0595859,0.0662932,0.0771901,0.0963434,0.133061", \
</span><span id="__span-21-20"><a href="#__codelineno-21-20" id="__codelineno-21-20" name="__codelineno-21-20"></a>                        "0.0625876,0.0673198,0.0719785,0.0794046,0.0910973,0.110757,0.147656", \
</span><span id="__span-21-21"><a href="#__codelineno-21-21" id="__codelineno-21-21" name="__codelineno-21-21"></a>                        "0.0748282,0.0800098,0.0851434,0.0933663,0.106111,0.126669,0.163872");
</span><span id="__span-21-22"><a href="#__codelineno-21-22" id="__codelineno-21-22" name="__codelineno-21-22"></a>            }
</span><span id="__span-21-23"><a href="#__codelineno-21-23" id="__codelineno-21-23" name="__codelineno-21-23"></a>    }
</span><span id="__span-21-24"><a href="#__codelineno-21-24" id="__codelineno-21-24" name="__codelineno-21-24"></a>}
</span></code></pre></div>
<p>首先要看 cell_fall 后面的 template 是 Timing_7_7，可以看到 variable_1 和 variable_2 对应的是 input_net_transition 和 total_output_net_capacitance。这里 cell_fall 指的是输出 pin ZN 从 1 变成 0 的时候，这个变化从 A1 的变化传播到 ZN 的时间，这个时间和输入的 transition 时间（大概是从 0 到 1、从 1 到 0 的时间，具体从多少百分比到多少百分比见设置）和输出的 capacitance 有关，所以是一个查找表，查找的时候找最近的点进行插值。输出的 capacitance 取决于 wire load 和连接了这个输出的其他单元的输入。</p>
<p>除了 cell_fall/cell_rise 两种类型，还有 fall_transition 和 rise_transition，这就是输出引脚的变化时间，又作为后继单元的输入 transition 时间。</p>
<p>接下来，还能看到功耗的数据：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>power_lut_template (Power_7_7) {
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a>    variable_1 : input_transition_time;
</span><span id="__span-22-3"><a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>    variable_2 : total_output_net_capacitance;
</span><span id="__span-22-4"><a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a>    index_1 ("0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070");
</span><span id="__span-22-5"><a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a>    index_2 ("0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070");
</span><span id="__span-22-6"><a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a>}
</span><span id="__span-22-7"><a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a>internal_power () {
</span><span id="__span-22-8"><a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a>    related_pin          : "A1";
</span><span id="__span-22-9"><a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a>    fall_power(Power_7_7) {
</span><span id="__span-22-10"><a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a>        index_1 ("0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535");
</span><span id="__span-22-11"><a href="#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a>        index_2 ("0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400");
</span><span id="__span-22-12"><a href="#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a>        values ("2.707163,2.939134,3.111270,3.271119,3.366153,3.407657,3.420511", \
</span><span id="__span-22-13"><a href="#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a>                "2.676697,2.905713,3.073189,3.236823,3.334156,3.373344,3.387400", \
</span><span id="__span-22-14"><a href="#__codelineno-22-14" id="__codelineno-22-14" name="__codelineno-22-14"></a>                "2.680855,2.891263,3.047784,3.212948,3.315296,3.360694,3.377614", \
</span><span id="__span-22-15"><a href="#__codelineno-22-15" id="__codelineno-22-15" name="__codelineno-22-15"></a>                "2.821141,3.032707,3.182020,3.338567,3.444608,3.488752,3.508229", \
</span><span id="__span-22-16"><a href="#__codelineno-22-16" id="__codelineno-22-16" name="__codelineno-22-16"></a>                "3.129641,3.235525,3.357993,3.567372,3.743682,3.792092,3.808289", \
</span><span id="__span-22-17"><a href="#__codelineno-22-17" id="__codelineno-22-17" name="__codelineno-22-17"></a>                "3.724304,3.738737,3.808381,3.980825,4.147999,4.278043,4.311323", \
</span><span id="__span-22-18"><a href="#__codelineno-22-18" id="__codelineno-22-18" name="__codelineno-22-18"></a>                "4.526175,4.492292,4.510220,4.634217,4.814899,4.934862,5.047389");
</span><span id="__span-22-19"><a href="#__codelineno-22-19" id="__codelineno-22-19" name="__codelineno-22-19"></a>    }
</span><span id="__span-22-20"><a href="#__codelineno-22-20" id="__codelineno-22-20" name="__codelineno-22-20"></a>    rise_power(Power_7_7) {
</span><span id="__span-22-21"><a href="#__codelineno-22-21" id="__codelineno-22-21" name="__codelineno-22-21"></a>        index_1 ("0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535");
</span><span id="__span-22-22"><a href="#__codelineno-22-22" id="__codelineno-22-22" name="__codelineno-22-22"></a>        index_2 ("0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400");
</span><span id="__span-22-23"><a href="#__codelineno-22-23" id="__codelineno-22-23" name="__codelineno-22-23"></a>        values ("1.823439,1.926997,1.963153,2.028865,1.957837,2.123314,2.075262", \
</span><span id="__span-22-24"><a href="#__codelineno-22-24" id="__codelineno-22-24" name="__codelineno-22-24"></a>                "1.796317,1.896145,1.960625,2.014112,2.050786,2.046472,1.972327", \
</span><span id="__span-22-25"><a href="#__codelineno-22-25" id="__codelineno-22-25" name="__codelineno-22-25"></a>                "1.811604,1.886741,1.955658,1.978263,1.965671,1.963736,2.071227", \
</span><span id="__span-22-26"><a href="#__codelineno-22-26" id="__codelineno-22-26" name="__codelineno-22-26"></a>                "1.997387,2.045930,2.092357,2.063643,2.099127,1.932089,2.131341", \
</span><span id="__span-22-27"><a href="#__codelineno-22-27" id="__codelineno-22-27" name="__codelineno-22-27"></a>                "2.367285,2.439718,2.440043,2.403446,2.305848,2.351146,2.195145", \
</span><span id="__span-22-28"><a href="#__codelineno-22-28" id="__codelineno-22-28" name="__codelineno-22-28"></a>                "2.916140,2.994325,3.044451,2.962881,2.836259,2.781564,2.633645", \
</span><span id="__span-22-29"><a href="#__codelineno-22-29" id="__codelineno-22-29" name="__codelineno-22-29"></a>                "3.687718,3.756085,3.789394,3.792984,3.773583,3.593022,3.405552");
</span><span id="__span-22-30"><a href="#__codelineno-22-30" id="__codelineno-22-30" name="__codelineno-22-30"></a>    }
</span><span id="__span-22-31"><a href="#__codelineno-22-31" id="__codelineno-22-31" name="__codelineno-22-31"></a>}
</span></code></pre></div>
<p>可以看到，这也是一个查找表，也是按照输出的 rise/fall 有不同的功耗。巧合的是，功耗的查找表的 index_1/index_2 和上面的时序查找表是一样的。除了 internal power，还有 leakage power，定义如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>leakage_power_unit : "1nW";
</span><span id="__span-23-2"><a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a>/* ... */
</span><span id="__span-23-3"><a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a>cell_leakage_power  : 50.353160;
</span><span id="__span-23-4"><a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a>
</span><span id="__span-23-5"><a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a>leakage_power () {
</span><span id="__span-23-6"><a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a>    when           : "!A1 &amp; !A2";
</span><span id="__span-23-7"><a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a>    value          : 40.690980;
</span><span id="__span-23-8"><a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a>}
</span><span id="__span-23-9"><a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a>leakage_power () {
</span><span id="__span-23-10"><a href="#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a>    when           : "!A1 &amp; A2";
</span><span id="__span-23-11"><a href="#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a>    value          : 62.007550;
</span><span id="__span-23-12"><a href="#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a>}
</span><span id="__span-23-13"><a href="#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a>leakage_power () {
</span><span id="__span-23-14"><a href="#__codelineno-23-14" id="__codelineno-23-14" name="__codelineno-23-14"></a>    when           : "A1 &amp; !A2";
</span><span id="__span-23-15"><a href="#__codelineno-23-15" id="__codelineno-23-15" name="__codelineno-23-15"></a>    value          : 41.294331;
</span><span id="__span-23-16"><a href="#__codelineno-23-16" id="__codelineno-23-16" name="__codelineno-23-16"></a>}
</span><span id="__span-23-17"><a href="#__codelineno-23-17" id="__codelineno-23-17" name="__codelineno-23-17"></a>leakage_power () {
</span><span id="__span-23-18"><a href="#__codelineno-23-18" id="__codelineno-23-18" name="__codelineno-23-18"></a>    when           : "A1 &amp; A2";
</span><span id="__span-23-19"><a href="#__codelineno-23-19" id="__codelineno-23-19" name="__codelineno-23-19"></a>    value          : 57.419780;
</span><span id="__span-23-20"><a href="#__codelineno-23-20" id="__codelineno-23-20" name="__codelineno-23-20"></a>}
</span></code></pre></div>
<p>可以看到，它的 leakage power 取决于输入的状态，单位是 1nW。</p>
<p>再来看 Flip Flop 的定义：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>cell (DFFRS_X1) {
</span><span id="__span-24-2"><a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>    ff ("IQ" , "IQN") {
</span><span id="__span-24-3"><a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a>        next_state          : "D";
</span><span id="__span-24-4"><a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a>        clocked_on          : "CK";
</span><span id="__span-24-5"><a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a>        preset              : "!SN";
</span><span id="__span-24-6"><a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a>        clear               : "!RN";
</span><span id="__span-24-7"><a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a>        clear_preset_var1   : L;
</span><span id="__span-24-8"><a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a>        clear_preset_var2   : L;
</span><span id="__span-24-9"><a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a>    }
</span><span id="__span-24-10"><a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a>    pin (D) {
</span><span id="__span-24-11"><a href="#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a>        direction       : input;
</span><span id="__span-24-12"><a href="#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a>        capacitance     : 1.148034;
</span><span id="__span-24-13"><a href="#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a>        fall_capacitance    : 1.081549;
</span><span id="__span-24-14"><a href="#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a>        rise_capacitance    : 1.148034;
</span><span id="__span-24-15"><a href="#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a>
</span><span id="__span-24-16"><a href="#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a>        timing () {
</span><span id="__span-24-17"><a href="#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a>
</span><span id="__span-24-18"><a href="#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a>            related_pin    : "CK";
</span><span id="__span-24-19"><a href="#__codelineno-24-19" id="__codelineno-24-19" name="__codelineno-24-19"></a>            timing_type    : hold_rising;
</span><span id="__span-24-20"><a href="#__codelineno-24-20" id="__codelineno-24-20" name="__codelineno-24-20"></a>            when               : "RN &amp; SN";
</span><span id="__span-24-21"><a href="#__codelineno-24-21" id="__codelineno-24-21" name="__codelineno-24-21"></a>            sdf_cond       : "RN_AND_SN === 1'b1";
</span><span id="__span-24-22"><a href="#__codelineno-24-22" id="__codelineno-24-22" name="__codelineno-24-22"></a>            fall_constraint(Hold_3_3) {
</span><span id="__span-24-23"><a href="#__codelineno-24-23" id="__codelineno-24-23" name="__codelineno-24-23"></a>                index_1 ("0.00117378,0.0449324,0.198535");
</span><span id="__span-24-24"><a href="#__codelineno-24-24" id="__codelineno-24-24" name="__codelineno-24-24"></a>                index_2 ("0.00117378,0.0449324,0.198535");
</span><span id="__span-24-25"><a href="#__codelineno-24-25" id="__codelineno-24-25" name="__codelineno-24-25"></a>                values ("0.002921,0.012421,0.011913", \
</span><span id="__span-24-26"><a href="#__codelineno-24-26" id="__codelineno-24-26" name="__codelineno-24-26"></a>                        "0.002707,0.008886,0.005388", \
</span><span id="__span-24-27"><a href="#__codelineno-24-27" id="__codelineno-24-27" name="__codelineno-24-27"></a>                        "0.139993,0.148595,0.137370");
</span><span id="__span-24-28"><a href="#__codelineno-24-28" id="__codelineno-24-28" name="__codelineno-24-28"></a>            }
</span><span id="__span-24-29"><a href="#__codelineno-24-29" id="__codelineno-24-29" name="__codelineno-24-29"></a>            rise_constraint(Hold_3_3) {
</span><span id="__span-24-30"><a href="#__codelineno-24-30" id="__codelineno-24-30" name="__codelineno-24-30"></a>                index_1 ("0.00117378,0.0449324,0.198535");
</span><span id="__span-24-31"><a href="#__codelineno-24-31" id="__codelineno-24-31" name="__codelineno-24-31"></a>                index_2 ("0.00117378,0.0449324,0.198535");
</span><span id="__span-24-32"><a href="#__codelineno-24-32" id="__codelineno-24-32" name="__codelineno-24-32"></a>                values ("0.004193,0.015978,0.019836", \
</span><span id="__span-24-33"><a href="#__codelineno-24-33" id="__codelineno-24-33" name="__codelineno-24-33"></a>                        "0.020266,0.031864,0.035343", \
</span><span id="__span-24-34"><a href="#__codelineno-24-34" id="__codelineno-24-34" name="__codelineno-24-34"></a>                        "0.099118,0.113075,0.120979");
</span><span id="__span-24-35"><a href="#__codelineno-24-35" id="__codelineno-24-35" name="__codelineno-24-35"></a>            }
</span><span id="__span-24-36"><a href="#__codelineno-24-36" id="__codelineno-24-36" name="__codelineno-24-36"></a>        }
</span><span id="__span-24-37"><a href="#__codelineno-24-37" id="__codelineno-24-37" name="__codelineno-24-37"></a>    }
</span><span id="__span-24-38"><a href="#__codelineno-24-38" id="__codelineno-24-38" name="__codelineno-24-38"></a>}
</span></code></pre></div>
<p>可以看到，这里的属性变成了 setup/hold 时间。</p>
<p>SRAM 也有类似的定义，通常是写在单独的 lib 文件中，根据 width 和 depth 生成，比如 <a href="https://github.com/The-OpenROAD-Project/OpenROAD-flow-scripts/blob/master/flow/platforms/nangate45/lib/fakeram45_32x64.lib">fakeram45_32x64.lib</a>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>cell(fakeram45_32x64) {
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>    area : 1754.536;
</span><span id="__span-25-3"><a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a>    interface_timing : true;
</span><span id="__span-25-4"><a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a>    memory() {
</span><span id="__span-25-5"><a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a>        type : ram;
</span><span id="__span-25-6"><a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a>        address_width : 5;
</span><span id="__span-25-7"><a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a>        word_width : 64;
</span><span id="__span-25-8"><a href="#__codelineno-25-8" id="__codelineno-25-8" name="__codelineno-25-8"></a>    }
</span><span id="__span-25-9"><a href="#__codelineno-25-9" id="__codelineno-25-9" name="__codelineno-25-9"></a>    pin(clk)   {
</span><span id="__span-25-10"><a href="#__codelineno-25-10" id="__codelineno-25-10" name="__codelineno-25-10"></a>        direction : input;
</span><span id="__span-25-11"><a href="#__codelineno-25-11" id="__codelineno-25-11" name="__codelineno-25-11"></a>        min_period : 0.174 ;
</span><span id="__span-25-12"><a href="#__codelineno-25-12" id="__codelineno-25-12" name="__codelineno-25-12"></a>        internal_power(){
</span><span id="__span-25-13"><a href="#__codelineno-25-13" id="__codelineno-25-13" name="__codelineno-25-13"></a>            rise_power(scalar) {
</span><span id="__span-25-14"><a href="#__codelineno-25-14" id="__codelineno-25-14" name="__codelineno-25-14"></a>                values ("1498.650")
</span><span id="__span-25-15"><a href="#__codelineno-25-15" id="__codelineno-25-15" name="__codelineno-25-15"></a>            }
</span><span id="__span-25-16"><a href="#__codelineno-25-16" id="__codelineno-25-16" name="__codelineno-25-16"></a>            fall_power(scalar) {
</span><span id="__span-25-17"><a href="#__codelineno-25-17" id="__codelineno-25-17" name="__codelineno-25-17"></a>                values ("1498.650")
</span><span id="__span-25-18"><a href="#__codelineno-25-18" id="__codelineno-25-18" name="__codelineno-25-18"></a>            }
</span><span id="__span-25-19"><a href="#__codelineno-25-19" id="__codelineno-25-19" name="__codelineno-25-19"></a>        }
</span><span id="__span-25-20"><a href="#__codelineno-25-20" id="__codelineno-25-20" name="__codelineno-25-20"></a>    }
</span><span id="__span-25-21"><a href="#__codelineno-25-21" id="__codelineno-25-21" name="__codelineno-25-21"></a>    bus(wd_in)   {
</span><span id="__span-25-22"><a href="#__codelineno-25-22" id="__codelineno-25-22" name="__codelineno-25-22"></a>        bus_type : fakeram45_32x64_DATA;
</span><span id="__span-25-23"><a href="#__codelineno-25-23" id="__codelineno-25-23" name="__codelineno-25-23"></a>        direction : input;
</span><span id="__span-25-24"><a href="#__codelineno-25-24" id="__codelineno-25-24" name="__codelineno-25-24"></a>        timing() {
</span><span id="__span-25-25"><a href="#__codelineno-25-25" id="__codelineno-25-25" name="__codelineno-25-25"></a>            related_pin     : clk;
</span><span id="__span-25-26"><a href="#__codelineno-25-26" id="__codelineno-25-26" name="__codelineno-25-26"></a>            timing_type     : setup_rising ;
</span><span id="__span-25-27"><a href="#__codelineno-25-27" id="__codelineno-25-27" name="__codelineno-25-27"></a>            rise_constraint(scalar) {
</span><span id="__span-25-28"><a href="#__codelineno-25-28" id="__codelineno-25-28" name="__codelineno-25-28"></a>                values ("0.050");
</span><span id="__span-25-29"><a href="#__codelineno-25-29" id="__codelineno-25-29" name="__codelineno-25-29"></a>            }
</span><span id="__span-25-30"><a href="#__codelineno-25-30" id="__codelineno-25-30" name="__codelineno-25-30"></a>            fall_constraint(scalar) {
</span><span id="__span-25-31"><a href="#__codelineno-25-31" id="__codelineno-25-31" name="__codelineno-25-31"></a>                values ("0.050");
</span><span id="__span-25-32"><a href="#__codelineno-25-32" id="__codelineno-25-32" name="__codelineno-25-32"></a>            }
</span><span id="__span-25-33"><a href="#__codelineno-25-33" id="__codelineno-25-33" name="__codelineno-25-33"></a>        } 
</span><span id="__span-25-34"><a href="#__codelineno-25-34" id="__codelineno-25-34" name="__codelineno-25-34"></a>        internal_power(){
</span><span id="__span-25-35"><a href="#__codelineno-25-35" id="__codelineno-25-35" name="__codelineno-25-35"></a>            when : "(we_in)";
</span><span id="__span-25-36"><a href="#__codelineno-25-36" id="__codelineno-25-36" name="__codelineno-25-36"></a>            rise_power(scalar) {
</span><span id="__span-25-37"><a href="#__codelineno-25-37" id="__codelineno-25-37" name="__codelineno-25-37"></a>                values ("14.987");
</span><span id="__span-25-38"><a href="#__codelineno-25-38" id="__codelineno-25-38" name="__codelineno-25-38"></a>            }
</span><span id="__span-25-39"><a href="#__codelineno-25-39" id="__codelineno-25-39" name="__codelineno-25-39"></a>            fall_power(scalar) {
</span><span id="__span-25-40"><a href="#__codelineno-25-40" id="__codelineno-25-40" name="__codelineno-25-40"></a>                values ("14.987");
</span><span id="__span-25-41"><a href="#__codelineno-25-41" id="__codelineno-25-41" name="__codelineno-25-41"></a>            }
</span><span id="__span-25-42"><a href="#__codelineno-25-42" id="__codelineno-25-42" name="__codelineno-25-42"></a>        }
</span><span id="__span-25-43"><a href="#__codelineno-25-43" id="__codelineno-25-43" name="__codelineno-25-43"></a>    }
</span><span id="__span-25-44"><a href="#__codelineno-25-44" id="__codelineno-25-44" name="__codelineno-25-44"></a>}
</span></code></pre></div>
<p>也可以类似地看到，它的输入 setup/hold，功耗，面积等等信息。</p>
<h4 id="db-格式"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#db-格式">DB 格式</a></h4>
<p>在给 Design Compiler 配置工艺库前，需要用 Library Compiler 先把 lib 格式转换为更紧凑的二进制 db 格式：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-26-1"><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="nv">read_lib</span><span class="w"> </span>xxx.lib
</span><span id="__span-26-2"><a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="nv">write_lib</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>db<span class="w"> </span>xxx
</span></code></pre></div>
<p>实测部分 Liberty 文件会报错，不知道有没有修复的办法。另外，不同版本的 Library Compiler 生成的格式也不大一样，但都是兼容的。</p>
<p>在 Design Compiler 中，设置当前工艺库命令：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-27-1"><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="nv">set_app_var</span><span class="w"> </span>target_library<span class="w"> </span>xxx.db
</span><span id="__span-27-2"><a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nv">set_link_var</span><span class="w"> </span>target_library<span class="w"> </span>xxx.db
</span><span id="__span-27-3"><a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="c"># or</span>
</span><span id="__span-27-4"><a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="nv">set_app_var</span><span class="w"> </span>target_library<span class="w"> </span><span class="k">{</span><span class="nv">xxx.db</span><span class="w"> </span>yyy.db<span class="k">}</span>
</span><span id="__span-27-5"><a href="#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="nv">set_link_var</span><span class="w"> </span>target_library<span class="w"> </span><span class="k">{</span><span class="nv">xxx.db</span><span class="w"> </span>yyy.db<span class="k">}</span>
</span></code></pre></div>
<h3 id="综合脚本"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#综合脚本">综合脚本</a></h3>
<p>准备好工艺库以后，就可以开始编写综合脚本了，通常有这么些步骤：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-28-1"><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="c"># step 1: read source code &amp; set top level module name</span>
</span><span id="__span-28-2"><a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="nv">read_file</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>verilog<span class="w"> </span>xxx.v
</span><span id="__span-28-3"><a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="nv">read_file</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>vhdl<span class="w"> </span>yyy.vhdl
</span><span id="__span-28-4"><a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="nv">current_design</span><span class="w"> </span>xxx
</span><span id="__span-28-5"><a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a>
</span><span id="__span-28-6"><a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="c"># step 2: setup timing constraints</span>
</span><span id="__span-28-7"><a href="#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="nv">create_clock</span><span class="w"> </span>clock<span class="w"> </span><span class="o">-</span>period<span class="w"> </span><span class="mf">1.0000</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mi">1</span>GHz<span class="w"> </span>for<span class="w"> </span>example
</span><span id="__span-28-8"><a href="#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="c"># other timing constraints:</span>
</span><span id="__span-28-9"><a href="#__codelineno-28-9" id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="c"># e.g. set_input_delay/set_output_delay</span>
</span><span id="__span-28-10"><a href="#__codelineno-28-10" id="__codelineno-28-10" name="__codelineno-28-10"></a>
</span><span id="__span-28-11"><a href="#__codelineno-28-11" id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="c"># step 3: synthesis</span>
</span><span id="__span-28-12"><a href="#__codelineno-28-12" id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="nv">link</span>
</span><span id="__span-28-13"><a href="#__codelineno-28-13" id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="nv">uniquify</span>
</span><span id="__span-28-14"><a href="#__codelineno-28-14" id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="c"># use this if you want to ungroup all hierarchy</span>
</span><span id="__span-28-15"><a href="#__codelineno-28-15" id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="c"># ungroup -flatten -all</span>
</span><span id="__span-28-16"><a href="#__codelineno-28-16" id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="c"># use this to retime design</span>
</span><span id="__span-28-17"><a href="#__codelineno-28-17" id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="c"># set_optimize_registers</span>
</span><span id="__span-28-18"><a href="#__codelineno-28-18" id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="nv">compile_ultra</span>
</span><span id="__span-28-19"><a href="#__codelineno-28-19" id="__codelineno-28-19" name="__codelineno-28-19"></a>
</span><span id="__span-28-20"><a href="#__codelineno-28-20" id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="c"># step 4: check &amp; report</span>
</span><span id="__span-28-21"><a href="#__codelineno-28-21" id="__codelineno-28-21" name="__codelineno-28-21"></a><span class="nv">check_timing</span>
</span><span id="__span-28-22"><a href="#__codelineno-28-22" id="__codelineno-28-22" name="__codelineno-28-22"></a><span class="nv">check_design</span>
</span><span id="__span-28-23"><a href="#__codelineno-28-23" id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="nv">report_design</span>
</span><span id="__span-28-24"><a href="#__codelineno-28-24" id="__codelineno-28-24" name="__codelineno-28-24"></a><span class="nv">report_area</span><span class="w"> </span><span class="o">-</span>hierarchy
</span><span id="__span-28-25"><a href="#__codelineno-28-25" id="__codelineno-28-25" name="__codelineno-28-25"></a><span class="nv">report_power</span><span class="w"> </span><span class="o">-</span>hierarchy
</span><span id="__span-28-26"><a href="#__codelineno-28-26" id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="nv">report_cell</span>
</span><span id="__span-28-27"><a href="#__codelineno-28-27" id="__codelineno-28-27" name="__codelineno-28-27"></a><span class="nv">report_timing</span><span class="w"> </span><span class="o">-</span>delay_type<span class="w"> </span>max
</span><span id="__span-28-28"><a href="#__codelineno-28-28" id="__codelineno-28-28" name="__codelineno-28-28"></a><span class="nv">report_timing</span><span class="w"> </span><span class="o">-</span>delay_type<span class="w"> </span>min
</span><span id="__span-28-29"><a href="#__codelineno-28-29" id="__codelineno-28-29" name="__codelineno-28-29"></a><span class="nv">report_constraint</span><span class="w"> </span><span class="o">-</span>all_violators
</span><span id="__span-28-30"><a href="#__codelineno-28-30" id="__codelineno-28-30" name="__codelineno-28-30"></a><span class="nv">report_qor</span>
</span><span id="__span-28-31"><a href="#__codelineno-28-31" id="__codelineno-28-31" name="__codelineno-28-31"></a>
</span><span id="__span-28-32"><a href="#__codelineno-28-32" id="__codelineno-28-32" name="__codelineno-28-32"></a><span class="c"># step 5: export</span>
</span><span id="__span-28-33"><a href="#__codelineno-28-33" id="__codelineno-28-33" name="__codelineno-28-33"></a><span class="nv">write</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>ddc<span class="w"> </span><span class="o">-</span>hierarchy<span class="w"> </span><span class="o">-</span>output<span class="w"> </span>xxx.ddc
</span><span id="__span-28-34"><a href="#__codelineno-28-34" id="__codelineno-28-34" name="__codelineno-28-34"></a><span class="nv">write_sdc</span><span class="w"> </span><span class="o">-</span>version<span class="w"> </span><span class="mf">1.0</span><span class="w"> </span>xxx.sdf
</span><span id="__span-28-35"><a href="#__codelineno-28-35" id="__codelineno-28-35" name="__codelineno-28-35"></a><span class="nv">write</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>verilog<span class="w"> </span><span class="o">-</span>hierarchy<span class="w"> </span><span class="o">-</span>output<span class="w"> </span>xxx.syn.v
</span><span id="__span-28-36"><a href="#__codelineno-28-36" id="__codelineno-28-36" name="__codelineno-28-36"></a><span class="nv">write_sdc</span><span class="w"> </span>xxx.sdc
</span></code></pre></div>
<p>根据需求，进行自定义的修改。综合完成后，可以看到生成的 <code>xxx.syn.v</code> 文件里都是一个个的 cell，比如：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-29-1"><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="n">AND2X2</span><span class="w"> </span><span class="n">U3912</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">n4416</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">n2168</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">n3469</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-29-2"><a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="n">OAI21X1</span><span class="w"> </span><span class="n">U3913</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">n2872</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">n4589</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">C</span><span class="p">(</span><span class="n">n2461</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">n3471</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-29-3"><a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="n">DFFPOSX1</span><span class="w"> </span><span class="n">clock_r_REG147_S1</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">n7634</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CLK</span><span class="p">(</span><span class="n">clock</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">n7773</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
<p>还有一些比较特殊的 cell，比如 TIEHI/TIELO 就是恒定输出 1/0，用于门控时钟的 CLKGATE/ICG 等，还有一些综合阶段不会出现的 cell，在后续阶段会使用。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://vlsiuniverse.blogspot.com/2016/12/liberty-format-introduction.html">Liberty format: an introduction</a></li>
<li><a href="https://www.eng.biu.ac.il/temanad/files/2017/02/Lecture-4-Standard-Cell-Libraries.pdf">Digital VLSI Design Lecture 4: Standard Cell Libraries</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-12 00:00:00+00:00">2022年3月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="openroad-flow-初尝试"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/">OpenROAD Flow 初尝试</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#背景">背景</a></h3>
<p>最近在尝试接触一些芯片前后端的知识。正好有现成的开源工具链 OpenROAD 来做这个事情，借此机会来学习一下整个流程。</p>
<h3 id="尝试过程"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#尝试过程">尝试过程</a></h3>
<p>首先 clone 仓库 OpenROAD-flow-scripts，然后运行：<code>./build_openroad.sh</code>，脚本会克隆一些仓库，自动进行编译。</p>
<p>编译中会找不到一些库，比如可能需要安装这些依赖：<code>liblemon-dev libeigen3-dev libreadline-dev swig</code>，此外运行的时候还需要 <code>klayout</code> 依赖。</p>
<p>如果遇到解决 cmake 找不到 LEMON 的问题，这是一个 <a href="https://lemon.cs.elte.hu/trac/lemon/ticket/628">BUG</a>，可以运行下面的命令解决：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nb">cd</span><span class="w"> </span>/usr/lib/x86_64-linux-gnu/cmake/lemon
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>cp<span class="w"> </span>lemonConfig.cmake<span class="w"> </span>LEMONConfig.cmake
</span></code></pre></div>
<p>编译后整个目录大概有 4.8G，输出的二进制目录是 133M。</p>
<p>如果要跑一下样例里的 nangate45 工艺的 gcd 例子，运行：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>cd flow
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>make DESIGN_CONFIG=./designs/nangate45/gcd/config.mk
</span></code></pre></div>
<h3 id="分析-gcd-测例"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#分析-gcd-测例">分析 GCD 测例</a></h3>
<p>这个测例的代码提供了这样一个接口：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">module</span><span class="w"> </span><span class="n">gcd</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="p">(</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">req_msg</span><span class="p">,</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_rdy</span><span class="p">,</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_val</span><span class="p">,</span>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">reset</span><span class="p">,</span>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">resp_msg</span><span class="p">,</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_rdy</span><span class="p">,</span>
</span><span id="__span-8-10"><a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_val</span>
</span><span id="__span-8-11"><a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="p">);</span>
</span><span id="__span-8-12"><a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>从名字可以推断出，外部通过 req 发送请求到 GCD 模块，然后模块计算出 GCD 后再返回结果。</p>
<p>根据日志可以看到，从 verilog 到最终的 gds 文件，经过了这些步骤：</p>
<ol>
<li>第一步用 yosys 综合（1_1_yosys），把 verilog 代码转化为网表，网表中的单元就是形如 <code>NAND2_X1</code> <code>DFF_X1</code> 等这样由工艺库定义的一些单元。</li>
<li>第二步进行 floorplan（2_1_floorplan），规划出芯片的大小，逻辑放在哪个位置，输入输出引脚放在什么位置（2_2_floorplan_io），还要考虑 SRAM 等宏或者 IP（2_4_mplace），电源网络 PDN（2_6_floorplan_pdn）</li>
<li>第三步是 Placement，就是把前面得到的一些 cell 放到芯片上的 (x,y) 坐标上</li>
<li>第四步是 Clock Tree Synthesis（4_1_cts），简称 CTS，生成时钟树</li>
<li>第五步是进行路由连线，OpenROAD 有两个路由：FastRoute（5_1_fastroute）和 TritonRoute（5_2_TritonRoute）</li>
<li>第六步输出结果到 gds 文件（6_1_merge）。</li>
</ol>
<p>这些步骤可以在仓库的 <code>flow/Makefile</code> 里面看得比较清晰，英文版摘抄如下：</p>
<ol>
<li>SYNTHESIS<ol>
<li>Run Synthesis using yosys</li>
</ol>
</li>
<li>FLOORPLAN<ol>
<li>Translate verilog to def</li>
<li>IO Placement (random)</li>
<li>Timing Driven Mixed Size Placement (tdms)</li>
<li>Macro Placement</li>
<li>Tapcell and Welltie insertion</li>
<li>PDN generation</li>
</ol>
</li>
<li>PLACE<ol>
<li>Global placement without placed IOs, timing-driven, and routability-driven</li>
<li>IO placement (non-random)</li>
<li>Global placement with placed IOs, timing-driven, and routability-driven</li>
<li>Resizing &amp; Buffering</li>
<li>Detail placement</li>
</ol>
</li>
<li>CTS(Clock Tree Synthesis)<ol>
<li>Run TritonCTS</li>
<li>Filler cell insertion</li>
</ol>
</li>
<li>ROUTING<ol>
<li>Run global route (FastRoute)</li>
<li>Run detailed route (TritonRoute)</li>
</ol>
</li>
</ol>
<p>最后生成的 gds，用 KLayout 打开，可以看到这个样子：</p>
<p><img alt="" src="../../../../hardware/gcd_gds.png"/></p>
<p>日志里可以看到，预测的总功耗是 1.71 mW，面积占用是 703 um^2。</p>
<p>还跑了一下其他样例设计的 gds，比如 ibex：</p>
<p><img alt="" src="../../../../hardware/ibex_gds.png"/></p>
<p>日志里可以看到，预测的总功耗是 10.1 mW，面积占用是 32176 um^2。</p>
<p>还有 tiny rocket：</p>
<p><img alt="" src="../../../../hardware/tiny_rocket_gds.png"/></p>
<p>日志里可以看到，预测的总功耗是 36.8 mW，面积占用是 52786 um^2。</p>
<h3 id="工艺库常见术语"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#工艺库常见术语">工艺库常见术语</a></h3>
<ul>
<li>slvt/lvt/rvt/hvt: super-low/low/regular/high V threshold 前者速度快：阈值电压低，同时漏电流大</li>
<li>ss/tt/ff: slow-slow/typical-typical/fast-fast 后者速度快：电压高，温度低，比如 SS（0.99V 125C）TT（1.10V 25C）FF（1.21V -40C）；有时候还会看到 ssg，可以理解为 ss 的比较精确的版本，因此没有那么悲观，延迟比 SS 低一些，详见 <a href="https://cloud.tencent.com/developer/article/1598417">STA | ssg 跟 ss corner 的区别——谬误更正版</a></li>
<li>c + 数字：表示的是 channel length，c40 表示 40nm，数字越大速度越慢，能耗越低</li>
<li>数字+track：表示的是 track height，sc12 表示 12-track，数字越大速度越快</li>
</ul>
<p>ARM 的文档 <a href="https://developer.arm.com/documentation/102738/0100/Choosing-the-physical-IP-libraries">Choosing the physical IP libraries</a> 描述了 Channel length, Track height, Voltage threshold 等不同的选择。</p>
<p>综合来说，如果要更低的延迟，选择低 vt，小 c 和大 track，反之如果要更低的能耗，选择高 vt，大 c 和 小 track。</p>
<h3 id="ccs-vs-nldm"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#ccs-vs-nldm">CCS v.s. NLDM</a></h3>
<p>由于物理的特性比较复杂，工艺库里描述的也只是一个大致的模型，刻画了这些 cell 的特性，那么自然可以选取不同的模型。NLDM（上面举的例子就是 NLDM），CCS 就是常见的两个模型，相比之下，CCS 更精确，同时参数更多。更精确的还有直接用 SPICE 描述的电路。详细的对比可以看下面的参考文档。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://theopenroadproject.org/2019/12/11/getting-started-with-openroad-app-part-1/">GETTING STARTED WITH OPENROAD APP – PART 1</a></li>
<li><a href="https://link.springer.com/book/10.1007/b117024">Advanced ASIC Chip Synthesis Using Synopsys® Design Compiler™ Physical Compiler™ and PrimeTime®</a></li>
<li><a href="https://www.paripath.com/blog/characterization-blog/comparing-nldm-and-ccs-delay-models">Comparing NLDM And CCS delay models</a></li>
<li><a href="https://chitlesh.ch/wordpress/liberty-ccs-ecsm-or-ndlm/">Introduction to Liberty : CCS, ECSM and NDLM</a></li>
<li><a href="https://blog.csdn.net/graymount/article/details/106010388">STA 概念：一文了解 NLDM 与 CCS</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-09 00:00:00+00:00">2022年3月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="通过-jtag-对-vcu128-上的-rocket-chip-进行调试"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/">通过 JTAG 对 VCU128 上的 Rocket Chip 进行调试</a></h2>
<h3 id="前言"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#前言">前言</a></h3>
<p>两年前，我尝试过用 BSCAN JTAG 来配置 Rocket Chip 的调试，但是这个方法不是很好用，具体来说，如果有独立的一组 JTAG 信号，配置起来会更方便，而且不用和 Vivado 去抢，OpenOCD 可以和 Vivado hw_server 同时运行和工作。但是，苦于 VCU128 上没有 PMOD 接口，之前一直没考虑过在 VCU128 上配置独立的 JTAG。然后最近研究了一下，终于解决了这个问题。</p>
<h3 id="寻找-jtag-接口"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#寻找-jtag-接口">寻找 JTAG 接口</a></h3>
<p>前几天在研究别的问题的时候，看到 VCU128 文档中的这段话：</p>
<div class="language-text highlight"><pre><span></span><code>The FT4232HL U8 multi-function USB-UART on the VCU128 board provides three level-shifted
UART connections through the single micro-AB USB connector J2.
• Channel A is configured in JTAG mode to support the JTAG chain
• Channel B implements 4-wire UART0 (level-shifted) FPGA U1 bank 67 connections
• Channel C implements 4-wire UART1 (level-shifted) FPGA U1 bank 67 connections
• Channel D implements 2-wire (level-shifted) SYSCTLR U42 bank 501 connections
</code></pre></div>
<p>其中 Channel A 是到 FPGA 本身的 JTAG 接口，是给 Vivado 用的，如果是通过 BSCAN 的方式，也是在这个 Channel 上，但是需要经过 FPGA 自己的 TAP 再隧道到 BSCAN 上，比较麻烦。Channel B 和 C 是串口，Channel D 是连接 VCU128 上的 System Controller 的。之前的时候，都是直接用 Channel B 做串口，然后突发奇想：注意到这里是 4-wire UART，说明连接到 FPGA 是四条线，那是不是也可以拿来当 JTAG 用？</p>
<p>查询了一下 FT4232H 的文档，发现它的 Channel A 和 Channel B 是支持 MPSSE 模式的，在 MPSSE 模式下，可以当成 JTAG 使用：</p>
<table>
<thead>
<tr>
<th>Signal</th>
<th>Channel A</th>
<th>Channel B</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCK</td>
<td>12</td>
<td>22</td>
</tr>
<tr>
<td>TDI</td>
<td>13</td>
<td>23</td>
</tr>
<tr>
<td>TDO</td>
<td>14</td>
<td>24</td>
</tr>
<tr>
<td>TMS</td>
<td>15</td>
<td>25</td>
</tr>
</tbody>
</table>
<p>对照 VCU128 的 Schematic 看，虽然引脚的编号不大一样，可以发现，Channel A 和 B 分别对应了 ADBUS0-4 和 BDBUS 0-4，对应到 schematic 上的名字是：</p>
<ul>
<li>ADBUS0 - FT4232_TCK</li>
<li>ADBUS1 - FT4232_TDI</li>
<li>ADBUS2 - FMCP_HSPC_TDO</li>
<li>ADBUS3 - FT4232_TMS</li>
</ul>
<p>这一组是直接连到 FPGA 上专用的 JTAG 引脚，其中 TDO 是连接了额外的逻辑，可以把 FMC 接口上的 JTAG 连接成 daisy chain。</p>
<ul>
<li>ADBUS0 - FTDI_UART0_TXD_LS - UART0_RXD - BP26 -&gt; TCK</li>
<li>ADBUS1 - FTDI_UART0_RXD_LS - UART0_TXD - BN26 -&gt; TDI</li>
<li>ADBUS2 - FTDI_UART0_RTS_B_LS - UART0_RTS_B - BP22 -&gt; TDO</li>
<li>ADBUS3 - FTDI_UART0_CTS_B_LS - UART0_CTS_B - BP23 -&gt; TMS</li>
</ul>
<p>这里的 RXD/TXD 名字交换也是很容易看错，要小心，只要记住 FT4232H 要求的顺序一定是 TCK-TDI-TDO-TMS 即可。对应到 vivado 内的 xdc 就是这么写：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-18-1"><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-18-2"><a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BN26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-18-3"><a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP22<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-18-4"><a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP23<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span></code></pre></div>
<p>接下来，我们要把 Rocket Chip 的 JTAG 信号接出来。</p>
<h3 id="配置-rocket-chip-的-jtag"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#配置-rocket-chip-的-jtag">配置 Rocket Chip 的 JTAG</a></h3>
<p>配置 Rocket Chip 的 JTAG，大概需要如下几步：</p>
<ol>
<li>给 Config 加上 WithJtagDTM，以 JTAG 作为 DTM 模块</li>
<li>给 Subsystem 加上 HasPeripheryDebug</li>
<li>给 SubsystemModuleImp 加上 HasPeripheryDebugModuleImp</li>
<li>把 JTAG 信号连到自己的顶层模块上</li>
</ol>
<p>最后一步的相关代码，首先，按照 spec 要求，把 DM 输出的 ndreset 信号连到整个 Rocket 的 reset 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-19-1"><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1">// ndreset can reset all harts</span>
</span><span id="__span-19-2"><a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asBool</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">ndreset</span><span class="p">).</span><span class="n">getOrElse</span><span class="p">(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>
</span><span id="__span-19-3"><a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="n">target</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span>
</span></code></pre></div>
<p>接着，把 JTAG 的信号连到顶层：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">systemJtag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">systemjtag</span><span class="p">.</span><span class="n">get</span>
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span>
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span>
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span>
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span>
</span></code></pre></div>
<p>除了 JTAG 信号以外，还需要配置 IDCODE 相关的变量：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">mfr_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeManufId</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">11</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">part_number</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodePartNum</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-21-3"><a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeVersion</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span></code></pre></div>
<p>最后这一部分比较关键：首先，JTAG 部分的 reset 是独立于其余部分的，这里简单期间就连到了外部的 reset，其实可以改成 FPGA program 的时候进行 reset，然后等时钟来了就释放，实现方法可以参考文末的链接。resetctrl 是给 DM 知道哪些核心被 reset 了，最后是调用 rocket chip 自带的函数。这里踩的一个坑是，传给 systemJtag.reset 一定得是异步的，因为这个时钟域的时钟都是 jtag 的 TCK 信号，所以很可能错过一开始的 reset 信号，所以这里要用异步的 reset。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1">// MUST use async reset here</span>
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="c1">// otherwise the internal logic(e.g. TLXbar) might not function</span>
</span><span id="__span-22-3"><a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="c1">// if reset deasserted before TCK rises</span>
</span><span id="__span-22-4"><a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asAsyncReset</span>
</span><span id="__span-22-5"><a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="n">target</span><span class="p">.</span><span class="n">resetctrl</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-22-6"><a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">  </span><span class="n">rc</span><span class="p">.</span><span class="n">hartIsInReset</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-22-7"><a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="p">}</span>
</span><span id="__span-22-8"><a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="nc">Debug</span><span class="p">.</span><span class="n">connectDebugClockAndReset</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="配置-jtag-相关的约束"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#配置-jtag-相关的约束">配置 JTAG 相关的约束</a></h3>
<p>这部分是参考了 pulp 的 VCU118 中 jtag 信号的约束文件。照着抄就行：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="nv">create_clock</span><span class="w"> </span><span class="o">-</span>period<span class="w"> </span><span class="mf">100.000</span><span class="w"> </span><span class="o">-</span>name<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-23-2"><a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="nv">set_input_jitter</span><span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">1.000</span>
</span><span id="__span-23-3"><a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="nv">set_property</span><span class="w"> </span>CLOCK_DEDICATED_ROUTE<span class="w"> </span>FALSE<span class="w"> </span><span class="k">[</span><span class="nv">get_nets</span><span class="w"> </span>jtag_TCK_IBUF_inst<span class="o">/</span>O<span class="k">]</span>
</span><span id="__span-23-4"><a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-23-5"><a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span><span id="__span-23-6"><a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="nv">set_output_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-23-7"><a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>to<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-23-8"><a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-23-9"><a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-23-10"><a href="#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="nv">set_clock_groups</span><span class="w"> </span><span class="o">-</span>asynchronous<span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span>jtag_TCK<span class="k">]</span><span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span><span class="o">-</span>of_objects<span class="w"> </span><span class="k">[</span><span class="nv">get_pins</span><span class="w"> </span>system_i<span class="o">/</span>clk_wiz_0<span class="o">/</span>inst<span class="o">/</span>mmcme4_adv_inst<span class="o">/</span>CLKOUT1<span class="k">]]</span>
</span><span id="__span-23-11"><a href="#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="nv">set_property</span><span class="w"> </span>ASYNC_REG<span class="w"> </span>TRUE<span class="w"> </span><span class="k">[</span><span class="nv">get_cells</span><span class="w"> </span><span class="o">-</span>hier<span class="w"> </span><span class="o">-</span>regexp<span class="w"> </span><span class="s2">"system_i/rocketchip_wrapper_0/.*/cdc_reg_reg.*"</span><span class="k">]</span>
</span></code></pre></div>
<p>和原版本稍微改了一下，一个区别是 <code>set_clock_groups</code> 的时候，第二个时钟参数用的是 Clocking Wizard 的输出，同时也是 Rocket Chip 自己的时钟输入；另一个区别是用的 ASYNC_REG 查询语句不大一样。我没有具体分析过这些约束为什么这么写，不确定这些约束是否都合理，是否都是需要的，没有测试过不带这些约束会不会出问题。</p>
<h3 id="运行-openocd-和-gdb"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#运行-openocd-和-gdb">运行 OpenOCD 和 GDB</a></h3>
<p>最后，采用如下的 OpenOCD 配置来连接：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c"># openocd config</span>
</span><span id="__span-24-2"><a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="c"># use ftdi channel 1</span>
</span><span id="__span-24-3"><a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="c"># vcu128 uart0 as jtag</span>
</span><span id="__span-24-4"><a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">10000</span>
</span><span id="__span-24-5"><a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>ftdi
</span><span id="__span-24-6"><a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="nv">ftdi_vid_pid</span><span class="w"> </span><span class="mh">0x0403</span><span class="w"> </span><span class="mh">0x6011</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>FT4232H
</span><span id="__span-24-7"><a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="nv">ftdi_layout_init</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="mh">0x000b</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>Output:<span class="w"> </span>TCK<span class="w"> </span>TDI<span class="w"> </span>TMS
</span><span id="__span-24-8"><a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="nv">ftdi_tdo_sample_edge</span><span class="w"> </span>falling
</span><span id="__span-24-9"><a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="nv">ftdi_channel</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>channel<span class="w"> </span>B
</span><span id="__span-24-10"><a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="nv">reset_config</span><span class="w"> </span>none
</span><span id="__span-24-11"><a href="#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a>
</span><span id="__span-24-12"><a href="#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-24-13"><a href="#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span>
</span><span id="__span-24-14"><a href="#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a>
</span><span id="__span-24-15"><a href="#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-24-16"><a href="#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a>
</span><span id="__span-24-17"><a href="#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-24-18"><a href="#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w"> </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
<p>然后就可以连接到 Rocket Chip 上：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>&gt;<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>openocd.cfg
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0-rc2
</span><span id="__span-25-3"><a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-25-4"><a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-25-5"><a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-25-6"><a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">"jtag"</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">'transport select &lt;transport&gt;'</span>.
</span><span id="__span-25-7"><a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-25-8"><a href="#__codelineno-25-8" id="__codelineno-25-8" name="__codelineno-25-8"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span><span id="__span-25-9"><a href="#__codelineno-25-9" id="__codelineno-25-9" name="__codelineno-25-9"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">10000</span><span class="w"> </span>kHz
</span><span id="__span-25-10"><a href="#__codelineno-25-10" id="__codelineno-25-10" name="__codelineno-25-10"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x10000913<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x489<span class="w"> </span><span class="o">(</span>SiFive<span class="w"> </span>Inc<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x1<span class="o">)</span>
</span><span id="__span-25-11"><a href="#__codelineno-25-11" id="__codelineno-25-11" name="__codelineno-25-11"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">16</span>
</span><span id="__span-25-12"><a href="#__codelineno-25-12" id="__codelineno-25-12" name="__codelineno-25-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Disabling<span class="w"> </span>abstract<span class="w"> </span><span class="nb">command</span><span class="w"> </span>reads<span class="w"> </span>from<span class="w"> </span>CSRs.
</span><span id="__span-25-13"><a href="#__codelineno-25-13" id="__codelineno-25-13" name="__codelineno-25-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-25-14"><a href="#__codelineno-25-14" id="__codelineno-25-14" name="__codelineno-25-14"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">64</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x800000000094112d
</span><span id="__span-25-15"><a href="#__codelineno-25-15" id="__codelineno-25-15" name="__codelineno-25-15"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-25-16"><a href="#__codelineno-25-16" id="__codelineno-25-16" name="__codelineno-25-16"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span><span id="__span-25-17"><a href="#__codelineno-25-17" id="__codelineno-25-17" name="__codelineno-25-17"></a>&gt;<span class="w"> </span>riscv64-unknown-elf-gdb
</span><span id="__span-25-18"><a href="#__codelineno-25-18" id="__codelineno-25-18" name="__codelineno-25-18"></a><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>target<span class="w"> </span>remote<span class="w"> </span>localhost:3333
</span><span id="__span-25-19"><a href="#__codelineno-25-19" id="__codelineno-25-19" name="__codelineno-25-19"></a>Remote<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>localhost:3333
</span><span id="__span-25-20"><a href="#__codelineno-25-20" id="__codelineno-25-20" name="__codelineno-25-20"></a>0x00000000800001a4<span class="w"> </span><span class="k">in</span><span class="w"> </span>??<span class="w"> </span><span class="o">()</span>
</span></code></pre></div>
<p>可以看到调试功能都正常了。</p>
<h3 id="总结"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#总结">总结</a></h3>
<p>调试这个功能大概花了一天的时间，主要遇到了下面这些问题：</p>
<ol>
<li>调试模块的 reset 信号需要是异步的，这个是通过仿真（Remote Bitbang 连接 OpenOCD）调试出来的</li>
<li>看 schematic 的时候 rxd/txd 搞反了，后来仔细对比才找到了正确的对应关系</li>
<li>OpenOCD 配置的 irlen 一开始写的不对，dmcontrol 读出来是 0，一直以为是有别的问题，结果改了 irlen 后立马就成功了，这个问题可以让 OpenOCD 自动推断 irlen 来发现</li>
</ol>
<h3 id="参考"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#参考">参考</a></h3>
<ul>
<li><a href="https://www.xilinx.com/support/documentation/boards_and_kits/vcu128/ug1302-vcu128-eval-bd.pdf">VCU128 User Guide</a></li>
<li><a href="https://ftdichip.com/wp-content/uploads/2020/08/DS_FT4232H.pdf">FT4232H</a></li>
<li><a href="https://github.com/sequencer/rocket-doc/blob/e55f7af549c5859b3c8f5a52c81c4c802153ed60/sanitytests/vcu118/src/DesignKeyWrapper.scala">DesignKeyWrapper from 中国 Chisel 之父 @sequencer</a></li>
<li><a href="https://github.com/pulp-platform/pulp/blob/770b4e1d69baf7daceaadcb301ba7212a4310577/fpga/pulp-vcu118/constraints/vcu118.xdc">pulp VCU118 constraints</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-05 00:00:00+00:00">2022年1月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="分析-diplomacy-系统"><a class="toclink" href="../../../../hardware/2022/01/05/diplomacy/">分析 Diplomacy 系统</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/01/05/diplomacy/#背景">背景</a></h3>
<p>在使用 Rocket Chip 的时候，难免要和 Diplomacy 打交道，那么它比较特别的语法和使用方式会带来一些学习上的困难，并且文档也比较少。本人在学习 Diplomacy 源码的时候，记录了这个笔记，希望对读者有所启发。</p>
<nav class="md-post__action">
<a href="../../../../hardware/2022/01/05/diplomacy/">
          继续阅读
        </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-03 00:00:00+00:00">2022年1月3日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="chisel3-cookbook"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/">Chisel3 Cookbook</a></h2>
<h3 id="chisel-版本选择"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#chisel-版本选择">Chisel 版本选择</a></h3>
<p>尽量选择较新版本的 Chisel。Chisel v3.5 完善了编译器插件，使得生成的代码中会包括更多变量名信息。</p>
<h3 id="去掉输出-verilog-文件中的寄存器随机初始化"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#去掉输出-verilog-文件中的寄存器随机初始化">去掉输出 Verilog 文件中的寄存器随机初始化</a></h3>
<p>版本：FIRRTL &gt;= 1.5.0-RC2</p>
<p>代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">"-X"</span><span class="p">,</span><span class="w"> </span><span class="s">"verilog"</span><span class="p">,</span><span class="w"> </span><span class="s">"-o"</span><span class="p">,</span><span class="w"> </span><span class="s">s"</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v"</span><span class="p">),</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="nc">CustomDefaultRegisterEmission</span><span class="p">(</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">      </span><span class="n">useInitAsPreset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">      </span><span class="n">disableRandomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="p">)</span>
</span></code></pre></div>
<p>设置 disableRandomization=true 即可。useInitAsPreset 不建议开启。</p>
<h3 id="关闭-firrtl-优化输出尽可能与源代码一致的-verilog"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#关闭-firrtl-优化输出尽可能与源代码一致的-verilog">关闭 FIRRTL 优化，输出尽可能与源代码一致的 Verilog</a></h3>
<p>设置 Chisel 生成 MinimumVerilog：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">"-X"</span><span class="p">,</span><span class="w"> </span><span class="s">"mverilog"</span><span class="p">,</span><span class="w"> </span><span class="s">"-o"</span><span class="p">,</span><span class="w"> </span><span class="s">s"</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v"</span><span class="p">),</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">)</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="p">)</span>
</span></code></pre></div>
<p>此时代码中会保留更多原始 Chisel 代码的元素。</p>
<h3 id="重命名-axi4-为标准命名"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#重命名-axi4-为标准命名">重命名 AXI4 为标准命名</a></h3>
<p>Rocket Chip 中 AXI4Bundle 直接生成的名字和标准写法不同，可以利用 Chisel3 3.5.0 的 DataView 功能进行重命名：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1">// https://www.chisel-lang.org/chisel3/docs/explanations/dataview.html</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="c1">// use standard names</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">addrBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">dataBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">idBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-11"><a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-12"><a href="#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-13"><a href="#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-14"><a href="#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-15"><a href="#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-16"><a href="#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a>
</span><span id="__span-14-17"><a href="#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-18"><a href="#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-19"><a href="#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-20"><a href="#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">((</span><span class="n">dataBits</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-21"><a href="#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-22"><a href="#__codelineno-14-22" id="__codelineno-14-22" name="__codelineno-14-22"></a>
</span><span id="__span-14-23"><a href="#__codelineno-14-23" id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-24"><a href="#__codelineno-14-24" id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-25"><a href="#__codelineno-14-25" id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-26"><a href="#__codelineno-14-26" id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-27"><a href="#__codelineno-14-27" id="__codelineno-14-27" name="__codelineno-14-27"></a>
</span><span id="__span-14-28"><a href="#__codelineno-14-28" id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-29"><a href="#__codelineno-14-29" id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-30"><a href="#__codelineno-14-30" id="__codelineno-14-30" name="__codelineno-14-30"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-31"><a href="#__codelineno-14-31" id="__codelineno-14-31" name="__codelineno-14-31"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-32"><a href="#__codelineno-14-32" id="__codelineno-14-32" name="__codelineno-14-32"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-33"><a href="#__codelineno-14-33" id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-34"><a href="#__codelineno-14-34" id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-35"><a href="#__codelineno-14-35" id="__codelineno-14-35" name="__codelineno-14-35"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-36"><a href="#__codelineno-14-36" id="__codelineno-14-36" name="__codelineno-14-36"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-37"><a href="#__codelineno-14-37" id="__codelineno-14-37" name="__codelineno-14-37"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-38"><a href="#__codelineno-14-38" id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-39"><a href="#__codelineno-14-39" id="__codelineno-14-39" name="__codelineno-14-39"></a>
</span><span id="__span-14-40"><a href="#__codelineno-14-40" id="__codelineno-14-40" name="__codelineno-14-40"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-41"><a href="#__codelineno-14-41" id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-42"><a href="#__codelineno-14-42" id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-43"><a href="#__codelineno-14-43" id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-44"><a href="#__codelineno-14-44" id="__codelineno-14-44" name="__codelineno-14-44"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-14-45"><a href="#__codelineno-14-45" id="__codelineno-14-45" name="__codelineno-14-45"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-14-46"><a href="#__codelineno-14-46" id="__codelineno-14-46" name="__codelineno-14-46"></a><span class="p">}</span>
</span><span id="__span-14-47"><a href="#__codelineno-14-47" id="__codelineno-14-47" name="__codelineno-14-47"></a>
</span><span id="__span-14-48"><a href="#__codelineno-14-48" id="__codelineno-14-48" name="__codelineno-14-48"></a><span class="k">object</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-49"><a href="#__codelineno-14-49" id="__codelineno-14-49" name="__codelineno-14-49"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataView</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">,</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">](</span>
</span><span id="__span-14-50"><a href="#__codelineno-14-50" id="__codelineno-14-50" name="__codelineno-14-50"></a><span class="w">    </span><span class="n">vab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-14-51"><a href="#__codelineno-14-51" id="__codelineno-14-51" name="__codelineno-14-51"></a><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">(</span>
</span><span id="__span-14-52"><a href="#__codelineno-14-52" id="__codelineno-14-52" name="__codelineno-14-52"></a><span class="w">        </span><span class="nc">AXI4BundleParameters</span><span class="p">(</span><span class="n">vab</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">idBits</span><span class="p">)</span>
</span><span id="__span-14-53"><a href="#__codelineno-14-53" id="__codelineno-14-53" name="__codelineno-14-53"></a><span class="w">      </span><span class="p">),</span>
</span><span id="__span-14-54"><a href="#__codelineno-14-54" id="__codelineno-14-54" name="__codelineno-14-54"></a><span class="w">    </span><span class="c1">// AW</span>
</span><span id="__span-14-55"><a href="#__codelineno-14-55" id="__codelineno-14-55" name="__codelineno-14-55"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-14-56"><a href="#__codelineno-14-56" id="__codelineno-14-56" name="__codelineno-14-56"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-14-57"><a href="#__codelineno-14-57" id="__codelineno-14-57" name="__codelineno-14-57"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-14-58"><a href="#__codelineno-14-58" id="__codelineno-14-58" name="__codelineno-14-58"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-14-59"><a href="#__codelineno-14-59" id="__codelineno-14-59" name="__codelineno-14-59"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-14-60"><a href="#__codelineno-14-60" id="__codelineno-14-60" name="__codelineno-14-60"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-14-61"><a href="#__codelineno-14-61" id="__codelineno-14-61" name="__codelineno-14-61"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-14-62"><a href="#__codelineno-14-62" id="__codelineno-14-62" name="__codelineno-14-62"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-14-63"><a href="#__codelineno-14-63" id="__codelineno-14-63" name="__codelineno-14-63"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-14-64"><a href="#__codelineno-14-64" id="__codelineno-14-64" name="__codelineno-14-64"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-14-65"><a href="#__codelineno-14-65" id="__codelineno-14-65" name="__codelineno-14-65"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-14-66"><a href="#__codelineno-14-66" id="__codelineno-14-66" name="__codelineno-14-66"></a><span class="w">    </span><span class="c1">// W</span>
</span><span id="__span-14-67"><a href="#__codelineno-14-67" id="__codelineno-14-67" name="__codelineno-14-67"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-14-68"><a href="#__codelineno-14-68" id="__codelineno-14-68" name="__codelineno-14-68"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-14-69"><a href="#__codelineno-14-69" id="__codelineno-14-69" name="__codelineno-14-69"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-14-70"><a href="#__codelineno-14-70" id="__codelineno-14-70" name="__codelineno-14-70"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">strb</span><span class="p">,</span>
</span><span id="__span-14-71"><a href="#__codelineno-14-71" id="__codelineno-14-71" name="__codelineno-14-71"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span><span class="p">,</span>
</span><span id="__span-14-72"><a href="#__codelineno-14-72" id="__codelineno-14-72" name="__codelineno-14-72"></a><span class="w">    </span><span class="c1">// B</span>
</span><span id="__span-14-73"><a href="#__codelineno-14-73" id="__codelineno-14-73" name="__codelineno-14-73"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-14-74"><a href="#__codelineno-14-74" id="__codelineno-14-74" name="__codelineno-14-74"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-14-75"><a href="#__codelineno-14-75" id="__codelineno-14-75" name="__codelineno-14-75"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-14-76"><a href="#__codelineno-14-76" id="__codelineno-14-76" name="__codelineno-14-76"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-14-77"><a href="#__codelineno-14-77" id="__codelineno-14-77" name="__codelineno-14-77"></a><span class="w">    </span><span class="c1">// AR</span>
</span><span id="__span-14-78"><a href="#__codelineno-14-78" id="__codelineno-14-78" name="__codelineno-14-78"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-14-79"><a href="#__codelineno-14-79" id="__codelineno-14-79" name="__codelineno-14-79"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-14-80"><a href="#__codelineno-14-80" id="__codelineno-14-80" name="__codelineno-14-80"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-14-81"><a href="#__codelineno-14-81" id="__codelineno-14-81" name="__codelineno-14-81"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-14-82"><a href="#__codelineno-14-82" id="__codelineno-14-82" name="__codelineno-14-82"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-14-83"><a href="#__codelineno-14-83" id="__codelineno-14-83" name="__codelineno-14-83"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-14-84"><a href="#__codelineno-14-84" id="__codelineno-14-84" name="__codelineno-14-84"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-14-85"><a href="#__codelineno-14-85" id="__codelineno-14-85" name="__codelineno-14-85"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-14-86"><a href="#__codelineno-14-86" id="__codelineno-14-86" name="__codelineno-14-86"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-14-87"><a href="#__codelineno-14-87" id="__codelineno-14-87" name="__codelineno-14-87"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-14-88"><a href="#__codelineno-14-88" id="__codelineno-14-88" name="__codelineno-14-88"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-14-89"><a href="#__codelineno-14-89" id="__codelineno-14-89" name="__codelineno-14-89"></a><span class="w">    </span><span class="c1">// R</span>
</span><span id="__span-14-90"><a href="#__codelineno-14-90" id="__codelineno-14-90" name="__codelineno-14-90"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-14-91"><a href="#__codelineno-14-91" id="__codelineno-14-91" name="__codelineno-14-91"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-14-92"><a href="#__codelineno-14-92" id="__codelineno-14-92" name="__codelineno-14-92"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-14-93"><a href="#__codelineno-14-93" id="__codelineno-14-93" name="__codelineno-14-93"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-14-94"><a href="#__codelineno-14-94" id="__codelineno-14-94" name="__codelineno-14-94"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-14-95"><a href="#__codelineno-14-95" id="__codelineno-14-95" name="__codelineno-14-95"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span>
</span><span id="__span-14-96"><a href="#__codelineno-14-96" id="__codelineno-14-96" name="__codelineno-14-96"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-14-97"><a href="#__codelineno-14-97" id="__codelineno-14-97" name="__codelineno-14-97"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">.</span><span class="n">axiView</span><span class="p">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-14-98"><a href="#__codelineno-14-98" id="__codelineno-14-98" name="__codelineno-14-98"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span>
</span><span id="__span-14-99"><a href="#__codelineno-14-99" id="__codelineno-14-99" name="__codelineno-14-99"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span>
</span><span id="__span-14-100"><a href="#__codelineno-14-100" id="__codelineno-14-100" name="__codelineno-14-100"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span>
</span><span id="__span-14-101"><a href="#__codelineno-14-101" id="__codelineno-14-101" name="__codelineno-14-101"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">idBits</span>
</span><span id="__span-14-102"><a href="#__codelineno-14-102" id="__codelineno-14-102" name="__codelineno-14-102"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-14-103"><a href="#__codelineno-14-103" id="__codelineno-14-103" name="__codelineno-14-103"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-14-104"><a href="#__codelineno-14-104" id="__codelineno-14-104" name="__codelineno-14-104"></a><span class="p">}</span>
</span><span id="__span-14-105"><a href="#__codelineno-14-105" id="__codelineno-14-105" name="__codelineno-14-105"></a>
</span><span id="__span-14-106"><a href="#__codelineno-14-106" id="__codelineno-14-106" name="__codelineno-14-106"></a><span class="c1">// usage</span>
</span><span id="__span-14-107"><a href="#__codelineno-14-107" id="__codelineno-14-107" name="__codelineno-14-107"></a><span class="kd">val</span><span class="w"> </span><span class="nc">MEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
</span><span id="__span-14-108"><a href="#__codelineno-14-108" id="__codelineno-14-108" name="__codelineno-14-108"></a><span class="nc">MEM</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mem_axi4</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">viewAs</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">]</span>
</span></code></pre></div>
<h3 id="给所有模块添加名称前缀"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#给所有模块添加名称前缀">给所有模块添加名称前缀</a></h3>
<p>有些时候，我们希望给所有模块添加一个名称前缀，防止可能出现的冲突。</p>
<p>在 Chisel 3 中，可以使用自定义 FIRRTL Transform 来实现这个功能。这一部分的实现参考了 <a href="https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578">chisel issue #1059</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">options</span><span class="p">.</span><span class="nc">Dependency</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">passes</span><span class="p">.</span><span class="nc">PassException</span>
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">transforms</span><span class="p">.</span><span class="nc">DedupModules</span>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="c1">// adapted from https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="cm">/** Specifies a global prefix for all module names. */</span>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-15-11"><a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a>
</span><span id="__span-15-12"><a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="cm">/** FIRRTL pass to add prefix to module names</span>
</span><span id="__span-15-13"><a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="cm">  */</span>
</span><span id="__span-15-14"><a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="k">object</span><span class="w"> </span><span class="nc">PrefixModulesPass</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Transform</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">DependencyAPIMigration</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-15"><a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">  </span><span class="c1">// we run after deduplication to save some work</span>
</span><span id="__span-15-16"><a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">prerequisites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">[</span><span class="nc">DedupModules</span><span class="p">])</span>
</span><span id="__span-15-17"><a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a>
</span><span id="__span-15-18"><a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">  </span><span class="c1">// we do not invalidate the results of any prior passes</span>
</span><span id="__span-15-19"><a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">invalidates</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Transform</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-15-20"><a href="#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a>
</span><span id="__span-15-21"><a href="#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">protected</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nc">CircuitState</span><span class="p">):</span><span class="w"> </span><span class="nc">CircuitState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-22"><a href="#__codelineno-15-22" id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">prefixes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-15-23"><a href="#__codelineno-15-23" id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">prefix</span>
</span><span id="__span-15-24"><a href="#__codelineno-15-24" id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="w">    </span><span class="p">}.</span><span class="n">distinct</span>
</span><span id="__span-15-25"><a href="#__codelineno-15-25" id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">    </span><span class="n">prefixes</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-26"><a href="#__codelineno-15-26" id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-15-27"><a href="#__codelineno-15-27" id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"[PrefixModulesPass] No ModulePrefix annotation found."</span><span class="p">)</span>
</span><span id="__span-15-28"><a href="#__codelineno-15-28" id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">        </span><span class="n">state</span>
</span><span id="__span-15-29"><a href="#__codelineno-15-29" id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="s">""</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">state</span>
</span><span id="__span-15-30"><a href="#__codelineno-15-30" id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-15-31"><a href="#__codelineno-15-31" id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">circuit</span><span class="p">.</span><span class="n">mapModule</span><span class="p">(</span><span class="n">onModule</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-15-32"><a href="#__codelineno-15-32" id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">main</span><span class="p">))</span>
</span><span id="__span-15-33"><a href="#__codelineno-15-33" id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-15-34"><a href="#__codelineno-15-34" id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PassException</span><span class="p">(</span>
</span><span id="__span-15-35"><a href="#__codelineno-15-35" id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="w">          </span><span class="s">s"[PrefixModulesPass] found more than one prefix annotation: </span><span class="si">$</span><span class="n">other</span><span class="s">"</span>
</span><span id="__span-15-36"><a href="#__codelineno-15-36" id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="w">        </span><span class="p">)</span>
</span><span id="__span-15-37"><a href="#__codelineno-15-37" id="__codelineno-15-37" name="__codelineno-15-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-38"><a href="#__codelineno-15-38" id="__codelineno-15-38" name="__codelineno-15-38"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-39"><a href="#__codelineno-15-39" id="__codelineno-15-39" name="__codelineno-15-39"></a>
</span><span id="__span-15-40"><a href="#__codelineno-15-40" id="__codelineno-15-40" name="__codelineno-15-40"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onModule</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-15-41"><a href="#__codelineno-15-41" id="__codelineno-15-41" name="__codelineno-15-41"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-42"><a href="#__codelineno-15-42" id="__codelineno-15-42" name="__codelineno-15-42"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">ExtModule</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-15-43"><a href="#__codelineno-15-43" id="__codelineno-15-43" name="__codelineno-15-43"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">mod</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Module</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-15-44"><a href="#__codelineno-15-44" id="__codelineno-15-44" name="__codelineno-15-44"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">name</span>
</span><span id="__span-15-45"><a href="#__codelineno-15-45" id="__codelineno-15-45" name="__codelineno-15-45"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onStmt</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-15-46"><a href="#__codelineno-15-46" id="__codelineno-15-46" name="__codelineno-15-46"></a><span class="w">        </span><span class="n">mod</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</span><span id="__span-15-47"><a href="#__codelineno-15-47" id="__codelineno-15-47" name="__codelineno-15-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-48"><a href="#__codelineno-15-48" id="__codelineno-15-48" name="__codelineno-15-48"></a>
</span><span id="__span-15-49"><a href="#__codelineno-15-49" id="__codelineno-15-49" name="__codelineno-15-49"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onStmt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-50"><a href="#__codelineno-15-50" id="__codelineno-15-50" name="__codelineno-15-50"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefInstance</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">module</span><span class="p">)</span>
</span><span id="__span-15-51"><a href="#__codelineno-15-51" id="__codelineno-15-51" name="__codelineno-15-51"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w">             </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">mapStmt</span><span class="p">(</span><span class="n">onStmt</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-15-52"><a href="#__codelineno-15-52" id="__codelineno-15-52" name="__codelineno-15-52"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-53"><a href="#__codelineno-15-53" id="__codelineno-15-53" name="__codelineno-15-53"></a><span class="p">}</span>
</span></code></pre></div>
<p>实现思路就是遍历 IR，找到所有的 Module 并改名，再把所有模块例化也做一次替换。最后在生成 Verilog 的时候添加 Annotation 即可：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">"-o"</span><span class="p">,</span><span class="w"> </span><span class="s">s"</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v"</span><span class="p">),</span>
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-16-4"><a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-16-5"><a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="nc">RunFirrtlTransformAnnotation</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">(</span><span class="nc">PrefixModulesPass</span><span class="p">)),</span>
</span><span id="__span-16-6"><a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-16-7"><a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">  </span><span class="p">)</span>
</span></code></pre></div>
<p>如果使用新的 MLIR FIRRTL Compiler，则可以利用 <code>sifive.enterprise.firrtl.NestedPrefixModulesAnnotation</code> annotation，让 firtool 来进行 <a href="https://github.com/llvm/circt/blob/fc6b00fd20d8a50f17a908cc681c8cf3a4d1c000/lib/Dialect/FIRRTL/Transforms/PrefixModules.cpp">prefix 操作</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">package</span><span class="w"> </span><span class="n">sifive</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">  </span><span class="k">package</span><span class="w"> </span><span class="n">enterprise</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="k">package</span><span class="w"> </span><span class="n">firrtl</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-17-4"><a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">      </span><span class="k">import</span><span class="w"> </span><span class="nn">_root_</span><span class="p">.</span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-17-5"><a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a>
</span><span id="__span-17-6"><a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span>
</span><span id="__span-17-7"><a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">target</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">,</span>
</span><span id="__span-17-8"><a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">          </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span>
</span><span id="__span-17-9"><a href="#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">          </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span>
</span><span id="__span-17-10"><a href="#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SingleTargetAnnotation</span><span class="p">[</span><span class="nc">Target</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-11"><a href="#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a>
</span><span id="__span-17-12"><a href="#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">duplicate</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">):</span><span class="w"> </span><span class="nc">Annotation</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-17-13"><a href="#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">          </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-17-14"><a href="#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-17-15"><a href="#__codelineno-17-15" id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-16"><a href="#__codelineno-17-16" id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-17-17"><a href="#__codelineno-17-17" id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="p">}</span>
</span><span id="__span-17-18"><a href="#__codelineno-17-18" id="__codelineno-17-18" name="__codelineno-17-18"></a>
</span><span id="__span-17-19"><a href="#__codelineno-17-19" id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="k">object</span><span class="w"> </span><span class="nc">AddPrefix</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-20"><a href="#__codelineno-17-20" id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="nc">Module</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-21"><a href="#__codelineno-17-21" id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">    </span><span class="n">annotate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">ChiselAnnotation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-22"><a href="#__codelineno-17-22" id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">toFirrtl</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-17-23"><a href="#__codelineno-17-23" id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">toTarget</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-17-24"><a href="#__codelineno-17-24" id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-17-25"><a href="#__codelineno-17-25" id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-17-26"><a href="#__codelineno-17-26" id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个方法的灵感来自 @sequencer。唯一的缺点就是比较 Hack，建议 SiFive 把相关的类也开源出来用。</p>
<h3 id="关闭-rtl-级别的优化"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#关闭-rtl-级别的优化">关闭 RTL 级别的优化</a></h3>
<p>Chisel3 生成 Verilog/System Verilog 的时候会进行一些优化。如果想要关闭这些优化，可以使用：</p>
<ol>
<li><a href="https://www.chisel-lang.org/docs/cookbooks/naming">dontTouch annotation</a></li>
<li>添加命令行参数：<code>--preserve-values=[none/named/all]</code>，见 <a href="https://circt.llvm.org/docs/Dialects/FIRRTL/RationaleFIRRTL/">FIRRTL Dialect Rationale</a></li>
</ol>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-12-17 00:00:00+00:00">2021年12月17日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="教学缓存一致性协议分析"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/">「教学」缓存一致性协议分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#背景">背景</a></h3>
<p>最近在《高等计算机系统结构》课程中学习缓存一致性协议算法，这里用自己的语言来组织一下相关知识的讲解。</p>
<h3 id="write-invalidate-和-write-update"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#write-invalidate-和-write-update">Write-invalidate 和 Write-update</a></h3>
<p>最基础的缓存一致性思想有两种：</p>
<ol>
<li>Write-invalidate：写入数据的时候，将其他 Cache 中这条 Cache Line 设为 Invalid</li>
<li>Write-update：写入数据的时候，把新的结果写入到有这条 Cache Line 的其他 Cache</li>
</ol>
<h3 id="write-once-协议"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#write-once-协议">Write-once 协议</a></h3>
<p>Write-once 协议定义了四个状态：</p>
<ol>
<li>Invalid：表示这个块不合法</li>
<li>Valid：表示这个块合法，并可能是共享的，同时数据没有修改</li>
<li>Reserved：表示这个块合法，不是共享的，同时数据没有更改</li>
<li>Dirty：表示这个块合法，不是共享的，数据做了修改，和内存不同。</li>
</ol>
<p>可见，当一个缓存状态在 R 或者 D，其他缓存只能是 I；而缓存状态是 V 的时候，可以有多个缓存在 V 状态。</p>
<p>Write-once 协议的特点是，第一次写的时候，会写入到内存（类似 Write-through），连续写入则只写到缓存中，类似 Write-back。</p>
<p>当 Read hit 的时候，状态不变。</p>
<div class="language-text highlight"><pre><span></span><code>Read hit: The information is supplied by the current cache. No state change.
</code></pre></div>
<p>当 Read miss 的时候，会查看所有缓存，如果有其他缓存处于 Valid/Reserved/Dirty 状态，就从其他缓存处读取数据，然后设为 Valid，其他缓存也设为 Valid。如果其他缓存处于 Dirty 状态，还要把数据写入内存。</p>
<div class="language-text highlight"><pre><span></span><code>Read miss: The data is read from main memory. The read is snooped by other caches; if any of them have the line in the Dirty state, the read is interrupted long enough to write the data back to memory before it is allowed to continue. Any copies in the Dirty or Reserved states are set to the Valid state.
</code></pre></div>
<p>当 Write hit 的时候，如果是 Valid 状态，首先写入内存，把其他 Cache 都设为 Invalid，进入 Reserved 状态，这意味着第一次写是 Write-through。如果是 Reserved/Dirty 状态，则不修改内存，进入 Dirty 状态，这表示后续的写入都是 Write-back。</p>
<div class="language-text highlight"><pre><span></span><code>Write hit: If the information in the cache is in Dirty or Reserved state, the cache line is updated in place and its state is set to Dirty without updating memory. If the information is in Valid state, a write-through operation is executed updating the block and the memory and the block state is changed to Reserved. Other caches snoop the write and set their copies to Invalid.
</code></pre></div>
<p>当 Write miss 的时候，这个行为 Wikipedia 上和上课讲的不一样。按照 Wikipedia 的说法，首先按照 Read miss 处理，再按照 Write hit 处理，类似于 Write Allocate 的思路。如果是这样的话，那么首先从其他缓存或者内存读取数据，然后把其他缓存都设为 Invalid，把更新后的数据写入内存，进入 Reserved 状态。相当于 Write miss 的时候，也是按照 Write-through 实现。</p>
<div class="language-text highlight"><pre><span></span><code>Write miss: A partial cache line write is handled as a read miss (if necessary to fetch the unwritten portion of the cache line) followed by a write hit. This leaves all other caches in the Invalid state, and the current cache in the Reserved state.
</code></pre></div>
<p>教材上则是 Write miss 的时候按照 Write-back 处理。如果其他缓存都是 Invalid 时，从内存里读取数据，然后写入到缓存中，进入 Dirty 状态。如果其他缓存是 Valid/Reserved/Dirty 状态，就从其他缓存里读取数据，让其他缓存都进入 Invalid 状态，然后更新自己的数据，进入 Dirty 状态。</p>
<h3 id="msi-协议"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#msi-协议">MSI 协议</a></h3>
<p>MSI 协议比较简单，它定义了三个状态：</p>
<ol>
<li>Modified：表示数据已经修改，和内存里不一致</li>
<li>Shared：数据和内存一致，可以有一到多个缓存同时处在 Shared 状态</li>
<li>Invalid：不在缓存中</li>
</ol>
<p>当 Read hit 的时候，状态不变。</p>
<p>当 Read miss 的时候，检查其他缓存的状态，如果都是 Invalid，就从内存里读取，然后进入 Shared 状态。如果有 Shared，就从其他缓存处读取。如果有 Dirty，那就要把其他缓存的数据写入内存和本地缓存，然后进入 Shared 状态。</p>
<p>当 Write hit 的时候，如果现在是 Shared 状态，则要让其他的 Shared 缓存进入 Invalid 状态，然后更新数据，进入 Modified 状态。如果是 Modified 状态，那就修改数据，状态保持不变。</p>
<p>当 Write miss 的时候，如果有其他缓存处于 Modified/Shared 状态，那就从其他缓存处读取数据，并让其他缓存进入 Invalid 状态，然后修改本地数据，进入 Modified 状态。如果所有缓存都是 Invalid 状态，那就从内存读入，然后修改缓存数据，进入 Modified 状态。</p>
<h3 id="mesi-协议"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#mesi-协议">MESI 协议</a></h3>
<p>MESI 协议定义了四种状态：</p>
<ol>
<li>Modified：数据与内存不一致，并且只有一个缓存有数据</li>
<li>Exclusive：数据与内存一致，并且只有一个缓存有数据</li>
<li>Shared：数据与内存一致，可以有多个缓存同时有数据</li>
<li>Invalid：不在缓存中</li>
</ol>
<p>当 Read hit 的时候，状态不变。</p>
<p>当 Read miss 的时候，首先会检查其他缓存的状态，如果有数据，就从其他缓存读取数据，并且都进入 Shared 状态，如果其他缓存处于 Modified 状态，还需要把数据写入内存；如果其他缓存都没有数据，就从内存里读取，然后进入 Exclusive 状态。</p>
<p>当 Write hit 的时候，进入 Modified 状态，同时让其他缓存进入 Invalid 状态。</p>
<p>当 Write miss 的时候，检查其他缓存的状态，如果有数据，就从其他缓存读取，否则从内存读取。然后，其他缓存都进入 Invalid 状态，本地缓存更新数据，进入 Modified 状态。</p>
<p>值得一提的是，Shared 状态不一定表示只有一个缓存有数据：比如本来有两个缓存都是 Shared 状态，然后其中一个因为缓存替换变成了 Invalid，那么另一个是不会受到通知变成 Exclusive 的。Exclusive 的设置是为了减少一些总线请求，比如当数据只有一个核心访问的时候，只有第一次 Read miss 会发送总线请求，之后一直在 Exclusive/Modified 状态中，不需要发送总线请求。</p>
<h3 id="moesi-协议"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#moesi-协议">MOESI 协议</a></h3>
<p>MOESI 定义了五个状态：</p>
<ol>
<li>Modified：数据经过修改，并且只有一个缓存有这个数据</li>
<li>Owned：同时有多个缓存有这个数据，但是只有这个缓存可以修改数据</li>
<li>Exclusive：数据没有修改，并且只有一个缓存有这个数据</li>
<li>Shared：同时有多个缓存有这个数据，但是不能修改数据</li>
<li>Invalid：不在缓存中</li>
</ol>
<p>状态中，M 和 E 是独占的，所有缓存里只能有一个。此外，可以同时有多个 S，或者多个 S 加一个 O，但是不能同时有多个 O。</p>
<p>它的状态转移与 MESI 类似，区别在于：当核心写入 Owned 状态的缓存时，有两种方式：1）通知其他 Shared 的缓存更新数据；2）把其他 Shared 缓存设为 Invalid，然后本地缓存进入 Modified 状态。在 Read miss 的时候，则可以从 Owned 缓存读取数据，进入 Shared 状态，而不用写入内存。它相比 MESI 的好处是，减少了写回内存的次数。</p>
<p>AMD64 文档里采用的就是 MOESI 协议。AMBA ACE 协议其实也是 MOESI 协议，只不过换了一些名称，表示可以兼容 MEI/MESI/MOESI 中的一个协议。ACE 对应关系如下：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>需要注意的是，SharedClean 并不代表它的数据和内存一致，比如说和 SharedDirty 缓存一致，它只是说缓存替换的时候，不需要写回内存。</p>
<h3 id="dragon-协议"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#dragon-协议">Dragon 协议</a></h3>
<p>Dragon 协议是一个基于更新的协议，意味着写入缓存的时候，会把更新的数据同步到拥有这个缓存行的其他核心。它定义了四个状态：</p>
<ol>
<li>Exclusive clean(E)：独占，并且数据和内存一致</li>
<li>Shared clean(Sc)：数据同时存在多个缓存中，并且自己不是最后一个写入该缓存数据的</li>
<li>Shared modified(Sm)：数据同时存在多个缓存中，并且自己设最后一个写入该缓存数据的，类似于前面 MOESI 协议的 Owner 状态</li>
<li>Modify(M)：独占，并且数据和内存不一致</li>
</ol>
<p>可以看到，E 和 M 都是独占的，如果出现了多个缓存有同一个缓存行，那就是若干个 Sc 和一个 Sm。</p>
<p>当 Read miss 的时候，在总线上检查是否有缓存已经有这个缓存行的数据，如果没有，则从内存读取并转到 Exclusive clean 状态；如果已经在其他缓存中，则从其他缓存读取，将其他缓存转移到 Shared clean/Shared modified 状态，然后该缓存转移到 Shared clean 状态。</p>
<p>当 Write miss 的时候，同样检查其他缓存的状态，如果是第一个访问的，就从内存读取，更新数据，然后转到 Modify 状态；如果不是第一个访问的，就进入 Shared modified 状态，并且让原来 Shared modified 的缓存进入 Shared clean 状态。</p>
<p>当 Write hit 的时候，如果状态是 Shared modified，这时候需要通知其他缓存更新数据；如果状态是 Shared clean，则要通知其他缓存更新数据的同时，让原来 Shared modified 的缓存进入 Shared clean 状态；如果状态是 Exclusive clean，则进入 Modify 状态。</p>
<p>在这里，Shared modified 的缓存负责在换出的时候，写入数据到内存中。</p>
<h3 id="ace-协议"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#ace-协议">ACE 协议</a></h3>
<p>ACE 协议在 AXI 的基础上，添加了三个 channel：</p>
<ol>
<li>AC: Coherent address channel, Input to master: ACADDR, ACSNOOP, ACPROT</li>
<li>CR: Coherent response channel, Output from master: CRRESP</li>
<li>CD: Coherent data channel, Output from master: CDDATA, CDLAST</li>
</ol>
<p>此外，已有的 Channel 也添加了信号：</p>
<ol>
<li>ARSNOOP[3:0]/ARBAR[1:0]/ARDOMAIN[1:0]</li>
<li>AWSNOOP[3:0]/AWBAR[1:0]/AWDOMAIN[1:0]/AWUNIQUE</li>
<li>RRESP[3:2]</li>
<li>RACK/WACK</li>
</ol>
<p>ACE-lite 只在已有 Channel 上添加了新信号，没有添加新的 Channel。因此它内部不能有 Cache，但是可以访问一致的缓存内容。</p>
<p>当 Read miss 的时候，首先 AXI master 发送 read transaction 给 Interconnect，Interconnect 向保存了这个缓存行的缓存发送 AC 请求，如果有其他 master 提供了数据，就向请求的 master 返回数据；如果没有其他 master 提供数据，则向内存发起读请求，并把结果返回给 master，最后 master 提供 RACK 信号。</p>
<p>当 Write miss 的时候，也是类似地，AXI master 发送 MakeUnique 请求给 Interconnect，Interconnect 向保存了该缓存行的缓存发送请求，要求其他 master 状态改为 Invalid；当所有 master 都已经 invalidate 成功，就向原 AXI master 返回结果。</p>
<h3 id="基于目录的缓存一致性"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#基于目录的缓存一致性">基于目录的缓存一致性</a></h3>
<p>上面的缓存一致性协议中，经常有这么一个操作：向所有有这个缓存行的缓存发送/接受消息。简单的方法是直接广播，然后接受端自己判断是否处理。但是这个方法在核心很多的时候会导致广播流量太大，因此需要先保存下来哪些缓存会有这个缓存的信息，然后对这些缓存点对点地发送。这样就可以节省一些网络流量。</p>
<p>那么，怎么记录这个信息呢？一个简单的办法（Full bit vector format）是，有一个全局的表，对每个缓存行，都记录一个大小为 N（N 为核心数）的位向量，1 表示对应的核心中有这个缓存行。但这个方法保存数据量太大：缓存行数正比于 N，还要再乘以一次 N，总容量是 O(N^2) 的。</p>
<p>一个稍微好一些的方法（Coarse bit vector format）是，我把核心分组，比如按照 NUMA 节点进行划分，此时每个缓存行都保存一个大小为 M（M 为 NUMA 数量）的位向量，只要这个 NUMA 节点里有这个缓存行，对应位就取 1。这样相当于是以牺牲一部分流量为代价（NUMA 节点内部广播），来节省一些目录的存储空间。</p>
<p>但实际上，通常情况下，一个缓存行通常只会在很少的核心中保存，所以这里有很大的优化空间。比如说，可以设置一个缓存行同时出现的缓存数量上限 (Limited pointer format)，然后保存核心的下标而不是位向量，这样的存储空间就是 O(Nlog2N)。但是呢，这样限制了缓存行同时出现的次数，如果超过了上限，需要替换掉已有的缓存，可能在一些场景下性能会降低。</p>
<p>还有一种方式，就是链表 (Chained directory format)。目录中保存最后一次访问的核心编号，然后每个核心的缓存里，保存了下一个保存了这个缓存行的核心编号，或者表示链表终止。这样存储空间也是 O(Nlog2N)，不过发送消息的延迟更长，因为要串行遍历一遍，而不能同时发送。类似地，可以用二叉树 (Number-balanced binary tree format) 来组织：每个缓存保存两个指针，指向左子树和右子树，然后分别遍历，目的还是加快遍历的速度，可以同时发送消息给多个核心。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2021/12/17/cache-coherency-protocol/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Cache_coherence">Cache coherence</a></li>
<li><a href="https://en.wikipedia.org/wiki/MSI_protocol">MSI protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/Write-once_(cache_coherence)">Write-once (cache coherence)</a></li>
<li><a href="https://en.wikipedia.org/wiki/MESI_protocol">MESI protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/MOESI_protocol">MOESI protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/Dragon_protocol">Dragon protocol</a></li>
<li><a href="https://blogs.synopsys.com/vip-central/2014/12/23/a-strategy-to-verify-an-axi-ace-compliant-interconnect-part-2-of-4/">A Strategy to Verify an AXI/ACE Compliant Interconnect (2 of 4)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Directory-based_cache_coherence">Directory-based cache coherence</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-12-13 00:00:00+00:00">2021年12月13日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="dram-在-kintex-7-fpga-上内部-vref-的性能问题"><a class="toclink" href="../../../../hardware/2021/12/13/dram-fpga-vref-problem/">DRAM 在 Kintex 7 FPGA 上内部 Vref 的性能问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/12/13/dram-fpga-vref-problem/#背景">背景</a></h3>
<p>最近我们设计的 Kintex 7 FPGA 开发板在测试 DDR SDRAM 的时候遇到了一个问题，因为采用了 Internel VREF，MIG 在配置的时候限制了频率只能是 400 MHz，对应 800 MT/s，这样无法达到 DDR 的最好性能。</p>
<h3 id="原理"><a class="toclink" href="../../../../hardware/2021/12/13/dram-fpga-vref-problem/#原理">原理</a></h3>
<p>首先，VREF 在 DDR 中是用来区分低电平和高电平的。在 JESD79-4B 标准中，可以看到，对于直流信号，电压不小于 VREF+0.075V 时表示高电平，而电压不高于 VREF-0.075V 时表示低电平。VREF 本身应该介于 VDD 的 0.49 倍到 0.51 倍之间。</p>
<p>在连接 FPGA 的时候，有两种选择：</p>
<ul>
<li>Internal VREF: 从 FPGA 输出 VREF 信号到 DRAM</li>
<li>External VREF：接入 FPGA 以外的 VREF</li>
</ul>
<p>对于 7 Series 的 FPGA，Xilinx 要求如下：</p>
<div class="language-text highlight"><pre><span></span><code>For DDR3 SDRAM interfaces running at or below 800 Mb/s (400 MHz),
users have the option of selecting Internal VREF to save two I/O
pins or using external VREF. VREF is required for banks containing
DDR3 interface input pins (DQ/DQS).
</code></pre></div>
<p>进一步，Xilinx 在 UltraScale 文档下解释了背后的原因：</p>
<div class="language-text highlight"><pre><span></span><code>The UltraScale internal VREF circuit includes enhancements compared
to the 7 Series internal VREF circuit. Whereas 7 Series MIG had datarate
limitations on internal VREF usage (see (Xilinx Answer 42036)), internal
VREF is recommended in UltraScale. The VREF for 7 Series had coarse steps
of VREF value that were based on VCCAUX. This saved pins but limited the
performance because VCCAUX did not track with VCCO as voltage went up and
down. Not being able to track with VCCO enforced the performance
limitations of internal VREF in MIG 7 Series. UltraScale includes several
changes to internal VREF including a much finer resolution of VREF for DDR4
read VREF training. Additionally, internal VREF is based on the VCCO supply
enabling it to track with VCCO. Internal VREF is not subject to PCB and
Package inductance and capacitance. These changes in design now give internal
VREF the highest performance.
</code></pre></div>
<p>用中文简单来说：</p>
<ol>
<li>7 Series FPGA 中，Internal VREF 可以节省引脚，代价是 VREF 不会随着 VCCO 变化而变化（而是随着 VCCAUX 变化而变化），当 DRAM 频率提高的时候，可能无法满足 VREF 约等于 VDD 一半的要求</li>
<li>UltraScale FPGA 中，Internal VREF 是随着 VCCO 变化而变化的，并且会比 External VREF 性能更好；因此 UltraScale FPGA 的 DDR4 只支持 Internal VREF。</li>
</ol>
<p>以 MA703FA-35T 开发板为例，它使用的 FPGA 是 Artix7 35T，内存是 DDR3，采用的是 External VREF。它采用了 <a href="https://www.ti.com/lit/ds/symlink/tps51200.pdf">TPS51200 Sink and Source DDR Termination Regulator</a> 芯片，将芯片的 REFOUT 芯片接到 DRAM 的 VREFDQ 和 VREFCA 引脚上。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2021/12/13/dram-fpga-vref-problem/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://support.xilinx.com/s/article/42036?language=en_US">MIG 7 Series - Internal/External VREF Guidelines</a></li>
<li><a href="https://support.xilinx.com/s/article/64410?language=en_US">UltraScale/UltraScale+ Memory IP - Can either external or internal VREF be used?</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-12-12 00:00:00+00:00">2021年12月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="教学dram-结构和特性"><a class="toclink" href="../../../../hardware/2021/12/12/dram/">「教学」DRAM 结构和特性</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/sdram.html">知识库</a>中。</p>
<h3 id="dram-是如何组织的"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#dram-是如何组织的">DRAM 是如何组织的</a></h3>
<p>DRAM 分成很多层次：Bank Group，Bank，Row，Column，从大到小，容量也是各级别的乘积。</p>
<p>举例子：</p>
<ul>
<li>4 Bank Group</li>
<li>4 Bank per Bank Group</li>
<li>32,768 Row per Bank</li>
<li>1024 Column per Row</li>
<li>4 Bits per Column</li>
</ul>
<p>那么总大小就是 <code>4*4*32768*1024*4=2 Gb</code>。</p>
<h3 id="访问模式"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#访问模式">访问模式</a></h3>
<p>DRAM 的访问模式决定了访问内存的实际带宽。对于每次访问，需要这样的操作：</p>
<ol>
<li>用 ACT(Bank Activate) 命令打开某个 Bank Group 下面的某个 Bank 的某个 Row，此时整个 Row 的数据都会复制到 Sense Amplifier 中。这一步叫做 RAS（Row Address Strobe）</li>
<li>用 RD(Read)/WR(Write) 命令按照 Column 访问数据。这一步叫做 CAS（Column Address Strobe）。</li>
<li>在访问其他 Row 之前，需要用 PRE(Single Bank Precharge) 命令将 Sense Amplifier 中整个 Row 的数据写回 Row 中。</li>
</ol>
<p>可以看到，如果访问连续的地址，就可以省下 ACT 命令的时间，可以连续的进行 RD/WR 命令操作。</p>
<p>除了显式 PRE 以外，还可以在某次读写之后自动进行 PRE：WRA(Write with Auto-Precharge) 和 RDA(Read with Auto-Precharge)。</p>
<p>总结一下上面提到的六种命令：</p>
<ol>
<li>ACT: Bank Activate，激活一个 Row，用于接下来的访问</li>
<li>PRE: Single Bank Precharge，与 ACT 是逆操作，解除 Row 的激活状态</li>
<li>RD: Read，读取当前 Row 的某个 Column 数据</li>
<li>RDA: Read with Auto-Precharge，读取后执行 Precharge</li>
<li>WR: Write，写入当前 Row 的某个 Column 数据</li>
<li>WRA: Write with Auto-Precharge，写入后执行 Precharge</li>
</ol>
<p>除此之外，还有一些常用命令：</p>
<ol>
<li>REF: Refresh，需要定期执行，保证 DRAM 数据不会丢失。</li>
</ol>
<h3 id="参数"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#参数">参数</a></h3>
<p>DRAM 有很多参数，以服务器上的内存 <a href="https://in.micron.com/products/dram-modules/rdimm/part-catalog/mta36asf2g72pz-2g3">MTA36ASF2G72PZ-2G3A3</a> 为例子：</p>
<ul>
<li>16GB 容量，DDR4 SDRAM RDIMM</li>
<li>PC4-2400</li>
<li>Row address: 64K A[15:0]</li>
<li>Column address: 1K A[9:0]</li>
<li>Device bank group address: 4 BG[1:0]</li>
<li>Device bank address per group: 4 BA[1:0]</li>
<li>Device configuration: 4Gb (1Gig x 4), 16 banks</li>
<li>Module rank address: 2 CS_n[1:0]</li>
<li>Configuration: 2Gig x 72</li>
<li>Module Bandwidth: 19.2 GB/s=2400 MT/s * 8B/T</li>
<li>Memory Clock: 0.83ns(1200 MHz)</li>
<li>Data Rate: 2400 MT/s</li>
<li>Clock Cycles: CL-nRCD-nRP = 17-17-17</li>
</ul>
<p>容量：每个 DRAM 颗粒 <code>64K*1K*4*4*4=4Gb</code>，不考虑 ECC，一共有 <code>16*2=32</code> 个这样的颗粒，实际容量是 16 GB。32 个颗粒分为两组，每组 16 个颗粒，两组之间通过 CS_n 片选信号区分。每组 16 个颗粒，每个颗粒 4 位 DQ 数据信号，合并起来就是 64 位，如果考虑 ECC 就是 72 位。</p>
<p>再举一个 FPGA 开发板上内存的例子：<a href="https://www.micron.com/products/dram/ddr4-sdram/part-catalog/mt40a512m16ly-075">MT40A512M16LY-075E</a>，参数如下：</p>
<ol>
<li>Data Rate: 2666 MT/s, Clock Frequency: 1333 MHz, tCK=0.750ns=750ps</li>
<li>Target CL-nRCD-nRP: 18-18-18</li>
<li>tAA(Internal READ command to first data)=<code>13.50ns(=18*0.750)</code></li>
<li>tRCD(ACTIVATE to internal READ or WRITE delay time)=<code>13.50ns(=18*0.750)</code></li>
<li>tRP(PRECHARGE command period)=<code>13.50ns(=18*0.750)</code></li>
<li>tRAS(ACTIVATE-to-PRECHARGE command period)=32ns</li>
<li>512 Meg x 16</li>
<li>Number of bank groups: 2</li>
<li>Bank count per group: 4</li>
<li>Row addressing: 64K</li>
<li>Column addressing: 1K</li>
<li>Page size: 2KB=2K*16b</li>
</ol>
<p>总大小：<code>2*4*64K*1K*16=1GB</code>。这个开发板用了 5 个 DRAM 芯片，只采用了其中的 4.5 个芯片：最后一个芯片只用了 8 位数据，这样就是 <code>4.5*16=72</code> 位的数据线，对应 64 位+ECC。</p>
<h3 id="时序"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#时序">时序</a></h3>
<p>可以看到，上面的 DRAM Datasheet 里提到了三个时序参数：</p>
<ol>
<li>CL=17: CAS Latency，从发送读请求到第一个数据的延迟周期数</li>
<li>RCD=17: ACT to internal read or write delay time，表示从 ACT 到读/写需要的延迟周期数</li>
<li>RP=17: Row Precharge Time，表示 Precharge 后需要延迟周期数</li>
</ol>
<p>如果第一次访问一个 Row 中的数据，并且之前没有已经打开的 Row，那么要执行 ACT 和 RD 命令，需要的周期数是 RCD+CL；如果之前已经有打开了的 Row，那么要执行 PRE，ACT 和 RD 命令，需要的周期数是 RP+RCD+CL。但如果是连续访问，虽然还需要 CL 的延迟，但是可以流水线起来，充分利用 DDR 的带宽。</p>
<p>如果把这个换算到 CPU 角度的内存访问延迟的话，如果每次访问都是最坏情况，那么需要 17+17+17=51 个 DRAM 时钟周期，考虑 DRAM 时钟是 1200MHz，那就是 42.5ns，这个相当于是 DRAM 内部的延迟，实际上测得的是 100ns 左右。</p>
<p>更严格来说，读延迟 READ Latency = AL + CL + PL，其中 AL 和 PL 是可以配置的，CL 是固有的，所以简单可以认为 READ Latency = CL。同理 WRITE Latency = AL + CWL + PL，可以简单认为 WRITE Latency = CWL。CWL 也是可以配置的，不同的 DDR 速率对应不同的 CWL，范围从 1600 MT/s 的 CWL=9 到 3200 MT/s 的 CWL=20，具体见 JESD79-4B 标准的 Table 7 CWL (CAS Write Latency)。</p>
<h3 id="波形"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#波形">波形</a></h3>
<p>用 Micron 提供的 <a href="https://media-www.micron.com/-/media/client/global/documents/products/sim-model/dram/ddr4/ddr4_verilog_models.zip?rev=caf27a5eaf6b4a9f81eb894a874a4492">Verilog Model</a> 进行仿真，可以看到如下的波形图：</p>
<p><img alt="" src="../../../../hardware/ddr4_waveform.png"/></p>
<p>首先看第一个命令，ACT_n=0, ADDR=0x009C, CAS_n_A15=0, CKE=1-&gt;1, CS_n=0, RAS_n_A16=0, WE_n_A14=1，查阅标准可知这是 ACT(Bank Activate) 命令。接着第二个命令，ACT_n=1, ADDR=0x0400, CAS_n_A15=0, CKE=1-&gt;1, CS_n=0, RAS_n_A16=1, WE_n_A14=1, A10=1, 这是 RDA(Read with Auto Precharge) 命令。若干个周期后，读取的数据从 DQ 上输出，一共 8 个字节的数据。</p>
<h3 id="刷新"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#刷新">刷新</a></h3>
<p>DRAM 的一个特点是需要定期刷新。有一个参数 tREFI，表示刷新的时间周期，这个值通常是 7.8us，在温度大于 85 摄氏度时是 3.9 us（见 JESD79-4B Table 131）。在刷新之前，所有的 bank 都需要 Precharge 完成并等待 RP 的时间，这时候所有的 Bank 都是空闲的，再执行 REF(Refresh) 命令。等待 tRFC(Refresh Cycle) 时间后，可以继续正常使用。</p>
<p>为了更好的性能，DDR4 标准允许推迟一定次数的刷新，但是要在之后补充，保证平均下来依然满足每过 tREFI 时间至少一次刷新。</p>
<h3 id="地址映射"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#地址映射">地址映射</a></h3>
<p>如果研究 DRAM 内存控制器，比如 <a href="https://www.xilinx.com/support/documentation/ip_documentation/ultrascale_memory_ip/v1_4/pg150-ultrascale-memory-ip.pdf">FPGA 上的 MIG</a>，可以发现它可以配置不同的地址映射方式，例如：</p>
<ul>
<li>ROW_COLUMN_BANK</li>
<li>ROW_BANK_COLUMN</li>
<li>BANK_ROW_COLUMN</li>
<li>ROW_COLUMN_LRANK_BANK</li>
<li>ROW_LRANK_COLUMN_BANK</li>
<li>ROW_COLUMN_BANK_INTLV</li>
</ul>
<p>就是将地址的不同部分映射到 DRAM 的几个地址：Row，Column，Bank。可以想象，不同的地址映射方式针对不同的访存模式会有不同的性能。对于连续的内存访问，ROW_COLUMN_BANK 方式是比较适合的，因为连续的访问会分布到不同的 Bank 上，这样性能就会更好。</p>
<p>此外，如果访问会连续命中同一个 Page，那么直接读写即可；反之如果每次读写几乎都不会命中同一个 Page，那么可以设置 Auto Precharge，即读写以后自动 Precharge，减少了下一次访问前因为 Row 不同导致的 PRE 命令。一个思路是在对每个 Page 的最后一次访问采用 Auto Precharge。</p>
<h3 id="传输速率"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#传输速率">传输速率</a></h3>
<p>DDR SDRAM 的传输速率计算方式如下：</p>
<div class="language-text highlight"><pre><span></span><code>Memory Speed (MT/s) * 64 (bits/transfer)
</code></pre></div>
<p>例如一个 DDR4-3200 的内存，带宽就是 <code>3200 * 64 = 204.8 Gb/s = 25.6 GB/s</code>。但前面已经看到，除了传输数据，还需要进行很多命令，实际上很难达到 100% 的带宽。然后 CPU 可以连接多个 channel 的 DRAM，再考虑多个 CPU Socket，系统的总带宽就是</p>
<div class="language-text highlight"><pre><span></span><code>Memory Speed (MT/s) * 64 (bits/transfer) * Channels * Sockets
</code></pre></div>
<p>使用 MLC 等工具进行测试，计算实际与理论的比值，我测试得到的大概在 70%-90% 之间。</p>
<h3 id="hbm"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#hbm">HBM</a></h3>
<p>HBM 相比前面的 DDR SDRAM，它堆叠了多个 DRAM，提供多个 channel 并且提高了位宽。例如 <a href="https://media-www.micron.com/-/media/client/global/documents/products/data-sheet/dram/hbm2e/8gb_and_16gb_hbm2e_dram.pdf">Micron HBM with ECC</a>，堆叠了 4/8 层 DRAM，提供 8 个 channel，每个 channel 的数据宽度是 128 位，以 3200 MT/s 计算，一个 HBM 芯片的传输速率最大是：</p>
<div class="language-text highlight"><pre><span></span><code>3200 (MT/s) * 128 (bits/transfer) * 8 (Channels) = 3276.8 Gb/s = 409.6 GB/s
</code></pre></div>
<p>所以一片 HBM 的传输速率就相当于 16 个传统的 DDR SDRAM：8 个 Channel 加双倍的位宽。128 位实际上就是把两片 64-bit DDR SDRAM 并起来了，可以当成一个 128 位的用，也可以在 Pseudo Channel 模式下，当成共享地址和命令信号的两个 DDR SDRAM 用。</p>
<p>Xilinx 的 Virtex Ultrascale Plus HBM FPGA 提供了 <code>1800 (MT/s) * 128 (bits/transfer) * 8 (Channels) = 230.4 GB/s</code> 的带宽，如果用了两片 HBM 就是 460.8 GB/s。暴露给 FPGA 逻辑的是 16 个 256 位的 AXI3 端口，AXI 频率 450 MHz，内存频率 900 MHz。可以看到，每个 AXI3 就对应了一个 HBM 的 pseudo channel。每个 pseudo channel 是 64 位，但是 AXI 端口是 256 位：在速率不变的情况下，从 450MHz 到 900MHz，再加上 DDR，相当于频率翻了四倍，所以位宽要从 64 位翻四倍到 256 位。</p>
<p>当然了，HBM 的高带宽的代价就是引脚数量很多。根据 <a href="https://www.jedec.org/system/files/docs/JESD238A.pdf">HBM3 JESD238A</a>，每个 Channel 要 120 个 pin，一共 16 个 channel（HBM2 是 8 channel，每个 channel 128 位；HBM3 是 16 channel，每个 channel 64 位），然后还有其他的 52 个 pin，这些加起来就 1972 个 pin 了。所以一般在 Silicon Interposer 上连接，而不是传统的在 PCB 上走线（图源 <a href="https://picture.iczhiku.com/resource/ieee/WYifSuFTZuHLFcMV.pdf">A 1.2V 20nm 307GB/s HBM DRAM with At-Speed Wafer-Level I/O Test Scheme and Adaptive Refresh Considering Temperature Distribution</a>）：</p>
<p><img alt="" src="../../../../hardware/dram-hbm-stack.png"/></p>
<p>所以在 HBM3 标准里，用 Microbump 来描述 HBM 的 pin。</p>
<p>可以理解为把原来插在主板上的内存条，通过堆叠，变成一个 HBM Die，然后紧密地连接到 CPU 中。但是另一方面，密度上去了，价格也更贵了。</p>
<p>A100 显卡 40GB PCIe 版本提供了 1555 GB/s 的内存带宽。根据倍数关系，可以猜测是 5 个 8GB 的 HBM，每个提供 <code>1555 / 5 = 311 GB/s</code> 的带宽，那么时钟频率就是 <code>311 (GB/s) * 8 (bits/byte) / 128 (bits/transfer) / 8 (channels) / 2 (DDR) = 1215 MHz</code>，这与 <code>nvidia-smi -q</code> 看到的结果是一致的。</p>
<p>进一步，A100 80GB PCIe 版本提供了 1935 GB/s 的带宽，按照同样的方法计算，可得时钟频率是 <code>1935 (GB/s) / 5 * 8 (bits/byte) / 128 (bits/transfer) / 8 (channels) / 2(DDR) = 1512 MHz</code>，与 <a href="https://www.nvidia.com/content/dam/en-zz/Solutions/Data-Center/a100/pdf/PB-10577-001_v02.pdf">Product Brief</a> 一致。频率的提高是因为从 HBM2 升级到了 HBM2e。</p>
<p>A100 文档中的 Memory bus width 5120 的计算方式也就清楚了：<code>128 (bits/transfer) * 8 (channels) * 5 (stacks) = 5120 (bits)</code>。</p>
<p>H100 SXM5 升级到了 HBM3，内存容量依然是 80GB，但是时钟频率提高，内存带宽是 <code>2619 (MHz) * 2 (DDR) * 128 (bits/transfer) * 8 (channels) * 5 (stacks) / 8 (bits/byte) = 3352 GB/s</code>。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2021/12/12/dram/#参考文档">参考文档</a></h3>
<ul>
<li>Memory systems: Cache, DRAM &amp; Disk</li>
<li><a href="https://zhuanlan.zhihu.com/p/262052220">译文：DDR4 SDRAM - Understanding the Basics（上）</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/263080272">译文：DDR4 SDRAM - Understanding the Basics（下）</a></li>
<li><a href="https://github.com/RAMGuide/TheRamGuide-WIP-/raw/main/DDR5%20Spec%20JESD79-5.pdf">JEDEC STANDARD DDR5 SDRAM JESD79-5</a></li>
<li><a href="http://www.softnology.biz/pdf/JESD79-4B.pdf">JEDEC STANDARD DDR4 SDRAM JESD79-4B</a></li>
<li><a href="https://documents.pub/document/jesd79-3e-ddr3-sdram-specification.html">JEDEC STANDARD DDR3 SDRAM JESD79-3E</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-12-12 00:00:00+00:00">2021年12月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="教学risc-v-debug-协议"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/">「教学」RISC-V Debug 协议</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#背景">背景</a></h3>
<p>之前用过一些 RISC-V 核心，但是遇到调试相关的内容的时候就两眼一抹黑，不知道原理，出了问题也不知道如何排查，趁此机会研究一下工作原理。</p>
<h3 id="架构"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#架构">架构</a></h3>
<p>为了调试 RISC-V 核心，需要很多部件一起工作。按 RISC-V Debug Spec 所述，有这么几部分：</p>
<ol>
<li>Debugger: GDB，连接到 OpenOCD 启动的 GDB Server</li>
<li>Debug Translator: OpenOCD，向 GDB 提供 Server 实现，同时会通过 FTDI 等芯片控制 JTAG</li>
<li>Debug Transport Hardware: 比如 FTDI 的芯片，可以提供 USB 接口，让 OpenOCD 控制 JTAG 信号 TMS/TDI/TCK 的变化，并读取 TDO</li>
<li>Debug Transport Module: 在芯片内部的 JTAG 控制器（TAP），符合 JTAG 标准</li>
<li>Debug Module Interface：RISC-V 自定义的一系列寄存器，通过这些寄存器来控制 Debug Module 的行为</li>
<li>Debug Module：调试器，控制 RISC-V 核心，同时也支持直接访问总线，也有内部的 Program Buffer</li>
</ol>
<p>可以看到，DMI 是实际的调试接口，而 JTAG 可以认为是一个传输协议。</p>
<h3 id="jtag"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#jtag">JTAG</a></h3>
<p>首先什么是 JTAG？简单来说，它工作流程是这样的：</p>
<ol>
<li>JTAG TAP 维护了一个状态机，由 TMS 信号控制</li>
<li>当状态机进入 CaptureDR/CaptureIR 状态的时候，加载数据到 DR/IR 中</li>
<li>在 ShiftDR/ShiftIR 状态下，寄存器从 TDI 移入，从 TDO 移出</li>
<li>当进入 UpdateDR/UpdateIR 状态的时候，把 DR/IR 的结果输出到其他单元</li>
</ol>
<p>具体来说，JTAG 定义了两类寄存器：IR 和 DR。可以把 JTAG 理解成一个小的总线，我通过 IR 选择总线上的设备，通过 DR 向指定的设备上进行数据传输。比如在 RISC-V Debug Spec 里面，规定了以下的 5 位 IR 地址定义：</p>
<ol>
<li>0x00/0x1f: BYPASS</li>
<li>0x01: IDCODE</li>
<li>0x10: dtmcs</li>
<li>0x11: dmi</li>
</ol>
<p>可以类比为有四个设备：BYPASS，IDCODE，dtmcs，dmi，对应了一些地址。如果要选择 dtmcs 这个设备，就在 ShiftIR 阶段向 TDI 输入二进制的 00001 即可。选择地址以后，再向 DR 写入时，操作的就是 dtmcs 设备。</p>
<p>那么，每个设备是怎么操作的呢？假如我已经通过 IR 设置了当前设备是 dtmcs，然后进入 ShiftDR 模式时，JTAG 会同时输入和输出。输入的就是当前要输入的数据，输出的就是原来寄存器里的结果，这个结果可能是固定的，也可能是表示上一次输入对应的结果。</p>
<p>举个例子：IDCODE 设备，在 CaptureDR 阶段的时候，DR 总会被设为一个固定的 IDCODE，表示设备的 ID；在 Shift 的时候，这个 IDCODE 就会一位一位从 TDO 中输出，而 TDI 输入的数据都会被忽略掉。BYPASS 设备则是一个 1 位的寄存器，直接从 TDI 到寄存器，寄存器到 TDO，数据就这么流过去了。</p>
<p>那么，在 RISC-V Debug 里面，JTAG 是怎么用的呢？我们可以这么类比一下：CaptureDR 相当于读取寄存器到缓冲区，然后 ShiftDR 在读取缓冲区的同时写入缓冲区，最后 UpdateDR 则是把缓冲区中的数据写入到寄存器中。这和 MMIO 有点类似，只不过每次操作不是单独的写和读，而是一次操作等于先读后写。</p>
<p>还是来看例子。dtmcs 这个设备表示的是 DTM 当前的状态，它有 32 位，读取的时候可以得到 DMI 的状态和配置，写入的时候可以 reset DMI。以 OpenOCD 代码 <code>dtmcontrol_scan</code> 为例子，它做了这么几个事情：</p>
<ol>
<li>首先设置 IR 为 0x10，对应 dtmcs。</li>
<li>向 DR 中写入数据，同时读取数据。</li>
<li>设置 IR 为 0x11，对应 dmi，因为 dmi 操作是比较多的，所以它默认恢复到 dmi。</li>
</ol>
<p>如果我只想读取 dtmcs 寄存器，那么只要设置写入数据为 0 即可，因为寄存器的设计里考虑到，如果写入全 0 是没有副作用的。同理，如果只想写入 dtmcs 寄存器，直接写入即可，因为设计的时候也保证读入寄存器的值是没有副作用的。这样，就在一个一读一写的操作中，实现了读或者写的功能。</p>
<p>那么，dmi 寄存器的用途是什么呢？我们前面提到过，JTAG 其实是一个传输层，而 DMI 又定义了一系列的寄存器，这会让人有点混乱，为啥到处都是寄存器？又是 JTAG 的 IR/DR，又是 dmi，dmi 又有一堆寄存器，这是什么关系？</p>
<p>首先我们来看 dmi 寄存器的定义。它由三部分组成：地址、数据和操作。由于 JTAG 每次操作是一读一写，虽然寄存器定义差不多，但是读和写的含义是不同的。</p>
<p>比如读的时候，它表示的是上一次 dmi 请求的结果。地址还是上一次请求的地址，数据则是上一次请求的结果，操作字段 0 表示成功，2 表示失败，3 表示还没执行完。而写的时候，地址和数据表示了对哪个寄存器写入什么数据，操作字段 0 表示无操作，1 表示读，2 表示写。</p>
<p>可以看到，如果想操作 dmi 定义的寄存器，需要如下几个步骤，这也是 OpenOCD <code>dmi_op_timeout</code> 要做的事情：</p>
<ol>
<li>设置 IR 为 0x11，对应 DMI。</li>
<li>向 DR 写入请求的地址 + 数据 + 操作，丢弃读取的结果。</li>
<li>等待若干个周期。</li>
<li>向 DR 写入全 0，对应无操作，同时读取结果，这个结果就对应上面的请求。</li>
</ol>
<p>可以预期，如果首先写入了一个写操作，那么第二次 DR scan 得到的结果就是是否成功写入；如果首先写入了一个读操作，那么第二次 DR scan 得到的结果就是目标寄存器的值。</p>
<p>可能看起来还是很绕，确实很绕，因为这里有一个封装的过程。首先，DMI 本身定义了一些寄存器，这些寄存器读/写都有一定的含义，比如控制某一个 RISC-V 核心暂停等等。接着，JTAG 需要传输 DMI 的读取和写入操作，同时还要考虑读写尚未完成的情况，怎么办？结论就是通过 DR 来实现，写入 DR 时，按照 DR 中的操作数，对应到 DMI 的写入/读取；然后读取 DR 的时候，按照 DMI 的状态，告诉 OpenOCD 目前是否已经完成了上一次 DMI 操作，和操作的结果。</p>
<h3 id="dmi"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#dmi">DMI</a></h3>
<p>讲完 JTAG 以后，终于来到了 DMI。其实 DMI 就是一系列的寄存器，类似于 MMIO 设备，只不过访问方式不是我们通常的内存读写，而是通过 JTAG 的方式进行。它有很多个寄存器，摘录如下：</p>
<ol>
<li>dmcontrol 0x10: Debug Module Control</li>
<li>dmstatus 0x11: Debug Module Status</li>
<li>hartinfo 0x12: Hart Info</li>
<li>hartsum 0x13: Hart Summary</li>
<li>command 0x16: Abstract Control and Status</li>
<li>data0 0x04: Abstract Data 0</li>
<li>progbuf0 0x20: Program Buffer 0</li>
<li>sbcs 0x38: System Bus Access Control and Status</li>
<li>sbaddress0 0x39: System Bus Address 31:0</li>
<li>sbdata0 0x3c: System Bus Data 31:0</li>
</ol>
<p>OpenOCD 的 <code>examine</code> 函数对 DMI 初始化并进行一些参数的获取。它的操作如下：</p>
<ol>
<li>调用 dtmcontrol_scan，读取 JTAG 里的 dtmcs，可以得到 JTAG-DMI 的配置信息</li>
<li>向 dmcontrol 写入，进行复位</li>
<li>向 dmcontrol 写入，启用调试模块</li>
<li>从 hartinfo 读取 hart 信息</li>
<li>检查各个 hart 的状态</li>
</ol>
<p>类似地，其他各种调试操作都是对这些 DMI 寄存器的读和写进行。RISC-V Debug Spec 附录里还提到了如何实现调试器的一些功能。</p>
<p>比如要读取 CPU 的寄存器（比如通用寄存器，CSR 等等）的话，有如下的方式：</p>
<p>第一种是 Abstract Command，直接向 DMI 写入要寄存器编号，就可以实现读/写。</p>
<p>第二种是 Program Buffer。它是一块小的代码存储，可以通过 DMI 向其中写入指令，比如 <code>csrw s0, mstatus; ebreak</code>，然后设置 s0 寄存器的值，再执行 Program Buffer 里的代码。</p>
<p>以 OpenOCD 代码为例，<code>register_read_abstract</code> 做了以下操作：</p>
<ol>
<li>找到要读取的寄存器对应的 Abstract Register Number</li>
<li>进行 transfer 命令，DM 会读取对应寄存器到 data0 中</li>
<li>从 data0 中读取寄存器内容</li>
</ol>
<p>如果要读取内存的话，也有两种方法。一种是直接向 DMI 写入要读取的总线地址，然后再向指定的寄存器中读取数据。第二种还是利用 Program Buffer，写入一条 <code>lw s0, 0(s0)</code> 指令，然后先向 s0 写入地址，执行 Program Buffer 后，再把 s0 寄存器的值读出来。</p>
<h3 id="abstract-command-实现"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#abstract-command-实现">Abstract Command 实现</a></h3>
<p>那么，如何实现上面提到的 Abstract Command（比如读写寄存器，读写内存等）呢？Debug Spec 里面提到一种 Execution-Based 的方式，即在 Debug mode 下，核心依然在执行代码，只不过执行的是调试用的特殊代码。它做的就是轮询 Debug Module 等待命令，接受到命令以后，就去读写寄存器/内存，然后通过 data0-12 来传输数据。</p>
<p>这里还有一个比较特别的点，就是读取寄存器的时候，寄存器的编号是直接记录在指令中的，所以可以让 Debug Module 动态生成指令，然后让核心刷新 ICache 然后跳转过去。另外，还可以利用 dscratch0/dscratch1 寄存器来保存 gpr，然后用 dret 退出的时候再恢复，这样就有两个 gpr 可以用来实现功能了，实际上这已经够用了（一个技巧是，把地址设为 0 附近，然后直接用 zero 寄存器加偏移来寻址）。</p>
<h3 id="单步调试实现"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#单步调试实现">单步调试实现</a></h3>
<p>在 dcsr 中，有一个值 step 表示是否在单步调试状态。设 step 为 1 的时候，如果不在 debug mode 中，只需要记录以及执行的指令数，当执行了一条指令后，视为下一个指令发生了进入 debug mode 的异常，这样就实现了单步调试。</p>
<h3 id="软件断点实现"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#软件断点实现">软件断点实现</a></h3>
<p>调试器为了打断点，一种简单的方式是，往断点处写入 ebreak 指令，然后设置 dcsr 的 ebreakm/s/u，表示在这些特权集里，ebreak 是进入 debug mode，而不是原来的处理过程。然后，程序运行到 ebreak 指令的时候，进入 debug mode，openocd 发现核心进入 halted 状态后，让 gdb 继续进行调试。</p>
<p>硬件方面的实现方法就是，在遇到 ebreak 的时候，判断一下当前的特权集，结合 ebreakm/s/u 判断跳转到什么状态。此外，由于它会写入指令到内存，所以还需要执行 fence.i 指令，而 OpenOCD 需要依赖 progbuf 来执行 fence.i 指令，所以为了让这个方案工作，还得实现 Program Buffer。</p>
<p>当然了，软件断点也有局限性，比如内存不可写，比如 ROM，不能覆盖里面的指令，这样就有可能出问题。而且硬件断点性能也更好，不需要来回这样写指令。</p>
<h3 id="semihosting"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#semihosting">Semihosting</a></h3>
<p>ARM 有一种 semihosting 机制，就是处理器执行一种特定的指令序列，然后调试器看到整个序列的时候，不是进入 GDB 调试状态，而是去进行一些操作，比如输出信息，读写文件等等，然后结果通过 JTAG 写回去。OpenOCD 给 RISC-V 也做了类似的 semihosting 机制，只不过触发的指令序列不大一样，但是机制是类似的。</p>
<p>如果用过 Rocket Chip 仿真的或者以前的 ucb-bar/fpga-zynq 项目的话，会知道还有一个目的有些类似的东西：HTIF + fesvr，它是通过 fromhost/tohost 两组地址来进行通信，但是这个方法缺点是需要 poll tohost/fromhost 地址的内容，相对来说比较麻烦。</p>
<h3 id="program-buffer"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#program-buffer">Program Buffer</a></h3>
<p>此外，debug spec 还有一个可选的功能，就是 Program Buffer，调试器可以往里面插入自定义的指令，然后结合 abstract command 进行操作。这样就可以做一些比较高效的操作，比如 OpenOCD 实现的批量写入内存：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nf">sw</span><span class="w"> </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nf">ebreak</span>
</span></code></pre></div>
<p>并且设置 abstractauto，然后重复的操作是往 s1 里面写入新的数据，然后跳转到 program buffer，进行上面的 sw 操作，这样就可以一次 dmi 请求完成一次内存的写入，比较高效。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2021/12/12/riscv-debug/#参考文档">参考文档</a></h3>
<ol>
<li>RISC-V Debug Spec 0.13</li>
<li>IEEE Standard for JTAG 1149.1-2013</li>
<li>OpenOCD 相关代码</li>
</ol>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-12-06 00:00:00+00:00">2021年12月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="manycore-处理器架构分析"><a class="toclink" href="../../../../hardware/2021/12/06/manycore/">Manycore 处理器架构分析</a></h2>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2021/12/06/manycore/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://openlab-mu-internal.web.cern.ch/02_Press_Corner/Spotlights/Spotlights_items/Copies_of_Spotlights_items/2011/ManyIntegratedCore(MIC)ArchitectureAdvanced.pdf">Intel® Many Integrated Core Architecture (Intel® MIC Architecture) - Advanced</a></li>
<li><a href="https://ieeexplore.ieee.org/abstract/document/7476487">Intel® Xeon Phi coprocessor (codename Knights Corner)</a></li>
<li><a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=7453080">https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=7453080</a></li>
<li><a href="https://www.alcf.anl.gov/files/HC27.25.710-Knights-Landing-Sodani-Intel.pdf">Knights Landing (KNL): 2nd Generation Intel® Xeon Phi™ Processor</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fujitsu_A64FX">Fujitsu A64FX</a></li>
<li><a href="https://www.fujitsu.com/global/about/resources/news/press-releases/2018/0822-02.html">Fujitsu Presents Post-K CPU Specifications</a></li>
<li><a href="https://web.archive.org/web/20201205202434/https://hotchips.org/hc30/2conf/2.13_Fujitsu_HC30.Fujitsu.Yoshida.rev1.2.pdf">Fujitsu High Performance CPU for the Post-K Computer</a></li>
<li><a href="https://www.top500.org/system/179807/">SUPERCOMPUTER FUGAKU - SUPERCOMPUTER FUGAKU, A64FX 48C 2.2GHZ, TOFU INTERCONNECT D</a></li>
<li><a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=9229635">Preliminary Performance Evaluation of the Fujitsu A64FX Using HPC Applications</a></li>
<li><a href="https://www.fujitsu.com/downloads/SUPER/a64fx/a64fx_datasheet.pdf">FUJITSU Processor A64FX</a></li>
<li><a href="https://images.nvidia.cn/aem-dam/en-zz/Solutions/data-center/nvidia-ampere-architecture-whitepaper.pdf">NVIDIA A100 Tensor Core GPU Architecture</a></li>
<li><a href="https://images.nvidia.cn/content/volta-architecture/pdf/volta-architecture-whitepaper.pdf">NVIDIA TESLA V100 GPU ARCHITECTURE</a></li>
<li><a href="https://www.nvidia.com/content/dam/en-zz/Solutions/Data-Center/a100/pdf/nvidia-a100-datasheet-us-nvidia-1758950-r4-web.pdf">NVIDIA A100 TENSOR CORE GPU</a></li>
</ul>
<h3 id="xeon-phi---intel-mic"><a class="toclink" href="../../../../hardware/2021/12/06/manycore/#xeon-phi---intel-mic">Xeon Phi - Intel MIC</a></h3>
<p>MIC: Many Integrated Core Architecture</p>
<p>Knights Corner:</p>
<p>4 路 SMT，AVX512 指令，32 KB L1I，32 KB L1D，每核心 512KB L2，乱序执行，一条 512 位计算流水线，每个周期双精度性能 <code>512 / 64 * 2 = 16 FLOP/cycle</code>。61 核 1.053GHz 双精度性能是 <code>16 * 61 * 1.053 = 1028 GFLOPS</code>。</p>
<p>向量寄存器分为四组，每组 128 位，两个 DP/四个 SP。SP 和 DP 计算共享乘法器，来优化面积。</p>
<p>Knights Landing:</p>
<p>核心：4 路 SMT，AVX512 指令，乱序执行，两条 512 位计算流水线，每个周期双精度性能 <code>512 / 64 * 2 * 2 = 32 FLOP/cycle</code>，如果是 64 核 1.3 GHz，总双精度性能是 <code>32 * 64 * 1.3 = 2662 GFLOPS</code>。一共 36 个 Tile，每个 Tile 有 2 Core + 2 VPU/core + 1MB 16-way L2，最大 72 个核心。</p>
<p>内存：6-channel 384GB DDR4 2400 RAM（理论 <code>2400 * 6 * 8 = 115.2 GB/s</code>），8-16GB 3D MCDRAM（400+ GB/s）。</p>
<h3 id="fujitsu-a64fx"><a class="toclink" href="../../../../hardware/2021/12/06/manycore/#fujitsu-a64fx">Fujitsu A64FX</a></h3>
<p>内存：4 组，每组 8GB HBM2，带宽 256 GB/s（<code>1024 bit * 2G</code>），总共 32GB HBM2，带宽 1TB/s。Cache Line 大小 256 B。</p>
<p>核心：4 个 NUMA Node（Core Memory Group），每个 NUMA Node 包括 12 计算核，有 8MB 16 路的 L2 Cache。总共 48 计算核，4 辅助核。</p>
<p>指令集：ARMv8.2+SVE，512 位向量宽度，乱序执行，两个浮点流水线和两个整数流水线，每个周期双精度性能 <code>512 / 64 * 2 * 2 = 32 FLOP/cycle</code>，主频 2.2 GHz，按主频算理论双精度浮点性能 <code>32 * 2.2 * 48 = 3.4 TFLOPS</code>。文档里写的是双精度浮点性能 2.7 TFLOPS，单精度 5.4 TFLOPS，半精度 10.8 TFLOPS，8 位整数 21.6 TOPS，应该是按照实际测出来的算。TOP 500 配置是 7630848 核，对应 <code>7630848 / 48 = 158976</code> 个节点，Rpeak 是 <code>537212 TFLOPS</code>，那么每个节点是 <code>537212 / 158976 = 3.38 TFLOPS</code>，和上面的 3.4 接近。Linpack 跑出来的 Rmax 是 442010 TFLOPS，每个节点是 <code>442010 / 158976 = 2.78 TFLOPS</code>，和文档里说的比较接近。</p>
<p>部分主要特性：</p>
<ul>
<li>Four-operand FMA: ARM FMA 指令只能是 <code>R0=R0+R1*R2</code>，A64FX 可以合并 <code>R0=R3,R0=R0+R1*R2</code> 两条为一条 <code>R0=R3+R1*R2</code> 指令</li>
<li>Gather/Scatter: 非连续访存，同一个 128B 内连续的 lane 可以合并访问，如果数据有局部性的话，可以得到两倍带宽</li>
</ul>
<h3 id="nvidia-gpu"><a class="toclink" href="../../../../hardware/2021/12/06/manycore/#nvidia-gpu">NVIDIA GPU</a></h3>
<table>
<thead>
<tr>
<th>型号</th>
<th>工艺</th>
<th>Peak DP(TFLOPS)</th>
<th>功耗 (W)</th>
<th>性能功耗比 (TFLOPS/W)</th>
</tr>
</thead>
<tbody>
<tr>
<td>P100</td>
<td>16 nm FinFET+</td>
<td>4.7</td>
<td>250</td>
<td>0.019</td>
</tr>
<tr>
<td>V100</td>
<td>12 nm FFN</td>
<td>7</td>
<td>250-300</td>
<td>0.023-0.028</td>
</tr>
<tr>
<td>A100</td>
<td>7 nm N7</td>
<td>9.7</td>
<td>250-400</td>
<td>0.024-0.039</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>型号</th>
<th>内存容量 (GB)</th>
<th>内存带宽 (GB/s)</th>
<th>内存类型</th>
<th>L2 缓存大小</th>
<th>寄存器堆大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>P100</td>
<td>12-16</td>
<td>549-732</td>
<td>4096 bit HBM2</td>
<td>4096 KB</td>
<td>14336 KB</td>
</tr>
<tr>
<td>V100</td>
<td>16-32</td>
<td>900</td>
<td>4096 bit HBM2</td>
<td>6144 KB</td>
<td>20480 KB</td>
</tr>
<tr>
<td>A100</td>
<td>40-80</td>
<td>1555-2039</td>
<td>5120 bit HBM2</td>
<td>40960 KB</td>
<td>27648 KB</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>型号</th>
<th>SM 数量</th>
<th>CUDA 核心数</th>
<th>FP64 核心数</th>
<th>SM 频率 (MHz)</th>
</tr>
</thead>
<tbody>
<tr>
<td>P100</td>
<td>56</td>
<td>3584</td>
<td>1792</td>
<td>1328</td>
</tr>
<tr>
<td>V100</td>
<td>80</td>
<td>5120</td>
<td>2560</td>
<td>1380</td>
</tr>
<tr>
<td>A100</td>
<td>108</td>
<td>6912</td>
<td>3456</td>
<td>1410</td>
</tr>
</tbody>
</table>
<ul>
<li>CUDA 核心数 = SM 数量 * 64</li>
<li>FP64 核心数 = SM 数量 * 32</li>
<li>Peak DP = FP64 核心数 * SM 频率 * 2</li>
<li>寄存器堆大小 = SM 数量 * 256 KB</li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-12-04 00:00:00+00:00">2021年12月4日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="sunway-处理器架构分析"><a class="toclink" href="../../../../hardware/2021/12/04/sunway/">Sunway 处理器架构分析</a></h2>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2021/12/04/sunway/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://crad.ict.ac.cn/CN/10.7544/issn1000-1239.2021.20201041">高性能众核处理器申威 26010</a></li>
<li><a href="https://cjc.ict.ac.cn/online/onlinepaper/lyy-202065163512.pdf">稀疏矩阵向量乘法在申威众核架构上的性能优化</a></li>
<li><a href="https://en.wikipedia.org/wiki/Sunway_SW26010">Sunway SW26010</a></li>
<li><a href="https://link.springer.com/content/pdf/10.1007/s11432-016-5588-7.pdf">The Sunway TaihuLight supercomputer: system and applications</a></li>
<li><a href="https://www.netlib.org/utk/people/JackDongarra/PAPERS/sunway-report-2016.pdf">Report on the Sunway TaihuLight System</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/3458817.3487399">Closing the “Quantum Supremacy” Gap: Achieving Real-Time Simulation of a Random Quantum Circuit Using a New Sunway Supercomputer</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/3458817.3476161">SW_Qsim: A Minimize-Memory Quantum Simulator with High-Performance on a New Sunway Supercomputer</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/3126908.3126910">18.9-Pflops Nonlinear Earthquake Simulation on Sunway TaihuLight: Enabling Depiction of 18-Hz and 8-Meter Scenarios</a></li>
<li><a href="https://www.nextplatform.com/2021/02/10/a-sneak-peek-at-chinas-sunway-exascale-supercomputer/">A FIRST PEEK AT CHINA’S SUNWAY EXASCALE SUPERCOMPUTER</a></li>
<li><a href="https://www.nextplatform.com/2021/03/10/the-nitty-gritty-of-the-sunway-exascale-system-network-and-storage/">THE NITTY GRITTY OF THE SUNWAY EXASCALE SYSTEM NETWORK AND STORAGE</a></li>
<li><a href="https://www.sciengine.com/publisher/scp/journal/SCIS/64/4/10.1007/s11432-020-3104-7?slug=fulltext">Sunway supercomputer architecture towards exascale computing: analysis and practice</a></li>
<li><a href="https://chipsandcheese.com/2023/11/20/chinas-newish-sw26010-pro-supercomputer-at-sc23/">China’s New(ish</a></li>
<li><a href="https://dl.acm.org/doi/abs/10.1145/3581784.3607030">5 ExaFlop/s HPL-MxP Benchmark with Linear Scalability on the 40-Million-Core Sunway Supercomputer</a></li>
</ul>
<h3 id="sw26010"><a class="toclink" href="../../../../hardware/2021/12/04/sunway/#sw26010">SW26010</a></h3>
<p>Sunway TaihuLight 的层次：</p>
<ol>
<li>1 Sunway TaihuLight = 40 Cabinet</li>
<li>1 Cabinet = 4 Super nodes</li>
<li>1 Super node = 256 nodes</li>
<li>1 node = 4 core groups</li>
<li>1 core group = 1 MPE(management processing element) + 8*8 CPE(computer processing element)</li>
</ol>
<p>MPE 双精度性能：<code>16 FLOP/cycle * 1.45 GHz = 23.2 GFlops</code>
CPE 双精度性能：<code>8 FLOP/cycle * 1.45 GHz = 11.6 GFlops</code>
CPE 单精度性能：<code>8 FLOP/cycle * 1.45 GHz = 11.6 GFlops</code>
单节点双精度性能：<code>4 * 8 * 8 * 11.6 + 4 * 23.2 = 3.0624 TFlops</code>
Sunway TaihuLight 双精度性能：<code>40 * 4 * 256 * 3.0624 = 125.435904 PFlops</code></p>
<p>MPE: 32KB L1I, 32 KB L1D, 256 KB L2(中文文献里写的是 512 KB)。乱序执行，4 译码，7 发射（5 整数 2 浮点）。指令预取，分支预测，寄存器重命名，预测执行。5 条整数流水线，2 条 256 位 SIMD 浮点流水线。</p>
<p>CPE：16KB L1I，无 DCache，有 64KB 可重构局部数据存储器（SPM scratch pad memory/LDM local data memory）。2 译码 2 发射，乱序执行，1 条 256 位 SIMD 流水线，1 条整数流水线。不同精度的 SIMD 宽度不同，单精度浮点运算 128 位（4 个单精度），双精度浮点运算 256 位（4 个双精度）。从 SPM 每个周期可以读取 32 字节的数据（正好一个 SIMD 寄存器）。</p>
<p>每个 core group 中还有一个 MC（Memory Controller），连接 8GB DDR3 memory，每个 MC 内存带宽 <code>128 bit * 2133 MT/s = 34.128 GB/s</code>，单节点内存带宽 <code>4 * 34.128 = 136.512 GB/s</code>。在 Stream Triad 测试，每个 core group 用 DMA 从内存到 SPM 传输数据带宽为 22.6 GB/s，而全局读写 gload/gstore 带宽只有 1.5 GB/s。访问全局内存需要 120+ 个周期。</p>
<p>8x8 矩阵中的从核可以在同行和同列方向上进行低延迟和高带宽的数据传递：2 个从核点对点通信延迟不超过 11 个周期，单个 core group 寄存器通信集合带宽达到 637 GB/s。</p>
<p>28nm 工艺流片，芯片 die 面积超过 500 mm^2，峰值功耗 292.7W，峰值能效比达 10.559 GFLOPS∕W（HPL 6.05 GFLOPS/W）。</p>
<h3 id="sw26010-pro"><a class="toclink" href="../../../../hardware/2021/12/04/sunway/#sw26010-pro">SW26010-Pro</a></h3>
<p>SW26010-Pro 是升级版 SW26010，升级的内容在于：</p>
<ol>
<li>每个 node 从 4 个 core group 升级到 6 个，一共有 <code>6 * (8 * 8 + 1) = 390</code> 个核心。频率也提高了，MPE 频率 2.1GHz，CPE 频率 2.25 GHz。SIMD 宽度扩展到 512 位。</li>
<li>每个 MC 连接了 16 GB DDR4 内存，带宽是 <code>128 bit * 3200 MT/s = 51.2 GB/s</code>；单节点总内存 96 GB，总内存带宽 <code>51.2 * 6 = 307.2 GB/s</code>。</li>
<li>每个 CPE 的局部存储（LDM）从 64KB 升级到 256KB。</li>
<li>CPE 之间的通信可以通过 RMA 进行，而之前的 SW26010 只能在同一行/列之间进行寄存器通信。</li>
</ol>
<h3 id="sw52020"><a class="toclink" href="../../../../hardware/2021/12/04/sunway/#sw52020">SW52020</a></h3>
<p>在新闻稿和 Sunway supercomputer architecture towards exascale computing: analysis and practice 文章中出现，没有在今年发出来的论文里实际采用，名称可能是新闻稿自己编的，我猜可能没有实际采用，而是做了 SW26010P。和 SW26010 区别：</p>
<ol>
<li>Core Group 从 4 个提升到了 8 个，所以每个 node 有 <code>8 * (8 * 8 + 1) = 520</code> 个核心。</li>
<li>MPE 和 CPE 向量宽度从 256 位扩展到了 512 位。添加了 16 位半精度浮点支持。</li>
<li>每个 node 提供超过 12 TFlops 的双精度浮点性能。应该是靠两倍的 Core Group，乘上两倍的向量计算宽度，达到四倍的性能。</li>
</ol>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-10-18 00:00:00+00:00">2021年10月18日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="移植系统到-rocket-chip-on-vcu128"><a class="toclink" href="../../../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/">移植系统到 Rocket Chip on VCU128</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#背景">背景</a></h3>
<p>最近需要在 VCU128 上搭建一个 SOC，然后想到可以把 OpenSBI、U-Boot 和 Linux 移植到这个平台上方便测试，于是又开始折腾这些东西。代码仓库都已经开源：</p>
<ul>
<li><a href="https://github.com/jiegec/rocket-chip-vcu128">rocket-chip-vcu128</a></li>
<li><a href="https://github.com/jiegec/opensbi/tree/rocket-chip-vcu128">opensbi</a></li>
<li><a href="https://github.com/jiegec/u-boot/tree/rocket-chip-vcu128">u-boot</a></li>
<li><a href="https://github.com/jiegec/linux/tree/rocket-chip-vcu128">linux</a></li>
</ul>
<h3 id="rocket-chip-on-vcu128"><a class="toclink" href="../../../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#rocket-chip-on-vcu128">Rocket Chip on VCU128</a></h3>
<p>第一部分是基于之前 <a href="https://github.com/jiegec/rocket2thinpad">rocket2thinpad</a> 在 Thinpad 上移植 Rocket Chip 的经验，做了一些更新，主要是因为 VCU128 的外设不大一样，同时我也要运行更复杂的程序，主要做了这些事情：</p>
<ol>
<li>添加了 VCU128 的内存和外设：HBM、SPI、I2C、UART、ETH</li>
<li>打开了更多核心选项：S-mode 和 U-mode</li>
</ol>
<p>主要踩过的坑：</p>
<ol>
<li>BSCAN 不工作，估计是因为一些参数不对，@jsteward 之前在 zcu 平台上做了一些测试，估计要用类似的办法进行修改；我最后直接去掉了这部分逻辑</li>
<li>这个板子的 PHY RESET 信号要通过 I2C 接口访问 TI 的 Port Expander，所以没法直接连，要通过 gpio 输出来手动 reset</li>
<li>SPI Startup Flash 的时序配置，见我之前的<a href="../../../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/">博客</a></li>
<li>Xilinx PCS/PMA IP 也会自己挂一个设备到 MDIO bus 上，应该有自己的 PHY 地址，而不要和物理的 PHY 冲突</li>
</ol>
<h3 id="u-boot"><a class="toclink" href="../../../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#u-boot">U-Boot</a></h3>
<p>在 U-Boot 上花了比较多的时间，用它的目的主要是：</p>
<ol>
<li>BootROM 中的代码只支持从串口加载程序，如果后续要加载 Linux 内核等软件，性能太差。</li>
<li>U-Boot 驱动比较完善，而且 dts 也可以很容易地迁移到 Linux 中</li>
<li>有一些可以参考的资料</li>
</ol>
<p>移植的时候，首先新建一个自定义的 board，然后自己写 defconfig 和 dts，其中 dts 可以参考 rocket chip 生成的 dts 文件。然后，按照各个外设的 device tree binding 去写，然后打开/关闭各个 CONFIG 开关。</p>
<p>对代码主要的改动是，实现了 DCache 的 flush 功能，因为以太网部分用了 DMA，所以要让外设看到内存的更改，这里采用的是 SiFive 的扩展指令 <code>cflush.d.l1</code>。由于编译器还不支持这个指令，就按照网上的方式去构造了汇编指令。实现完成以后，就可以用网络了。</p>
<p>一开始的时候，为了简单，直接在 M-mode 中运行 U-Boot，这样不需要 OpenSBI，同时 DTB 也是内置的。但后续为了运行 Linux，还是需要一个 SBI 实现：OpenSBI，然后在 S-mode 中运行 U-Boot，再引导到 Linux。</p>
<p>此外还花了很多努力来缩小 binary 大小，首先可以用 <code>nm --size -r u-boot | head -20</code> 来找到比较大的一些符号，不考虑其中 BSS 的部分（type=b），主要看哪些代码/数据比较占空间。</p>
<p>UPDATE: U-Boot 在 v2022.01 版本<a href="https://github.com/u-boot/u-boot/commit/eeaa3fe65270758ab0bdb1515e14f9bf936d3a25">修复了一个 BUG</a>，之前的版本在 riscv 架构下没有 reserve lmb region，使得加载 initrd 的时候，会覆盖掉自己的栈空间，这解释了之前的诸多玄学内存问题，升级到 v2022.01 后就好了。</p>
<h3 id="opensbi"><a class="toclink" href="../../../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#opensbi">OpenSBI</a></h3>
<p>OpenSBI 移植比较简单，直接参考 template 修改即可，主要就是串口的配置，其他基本不用改。然后，我把 U-Boot 作为 OpenSBI 的 Payload 放到 OpenSBI 的后面，此时要把 U-Boot 配置为 S-mode 模式。接着，遇到了新的问题：<code>cflush.d.l1</code> 指令只能在 M-mode 用，因此我在 OpenSBI 代码中处理了 trap，转而在 M-mode 里面运行这条指令。这样，就可以在 S-mode 里刷新 Cache 了。</p>
<h3 id="linux"><a class="toclink" href="../../../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#linux">Linux</a></h3>
<p>Linux 目前可以 boot 到寻找 init，还没有碰文件系统，之后计划用 buildroot 打一个 initramfs 出来。为了在 U-Boot 中启动 Linux，用 U-Boot 的 mkimage 工具生成了 FIT 格式的 uImage，里面打包了 kernel image 和 dtb，就可以用 bootm 命令启动了，注意地址不要和加载地址重复。</p>
<p>此外还遇到一个坑：RV64 里面 Linux dts 的 address cell 得是 2（对应 64 位），否则会有错误。但 U-Boot 对这个没有做要求。</p>
<h3 id="缓存一致性"><a class="toclink" href="../../../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#缓存一致性">缓存一致性</a></h3>
<p>一开始的时候，AXI DMA 直接接到内存上，所以与 CPU 缓存是不一致的，网卡驱动需要经常地刷缓存。在 Rocket Chip 上，可以用 sifive 自己的 cflush 指令来刷缓存，但是它只能在 M 态执行，同时又支持虚拟地址，这种奇怪的设计就使得要在 OpenSBI，U-Boot 和 Linux 三处都添加逻辑：OpenSBI 处理 illegal instruction，如果发现是 cflush 指令，就再次 cflush；U-Boot 和 Linux 修改驱动，在合适的地方添加 cflush 指令。U-Boot 驱动比较简单，工作得比较好，但是 Linux 的网卡驱动怎么都改不好。</p>
<p>最后决定，打开 Rocket Chip 的 Frontend Bus，添加一个 AXI Slave 接口，然后让 AXI DMA 通过 AXI Slave 接入到 Rocket Chip 中，然后通过 TLBroadcast 实现缓存一致性。这样软件实现会比较简单，但是硬件就更复杂了。</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-09-27 00:00:00+00:00">2021年9月27日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="教学axi-quad-spi-时序分析"><a class="toclink" href="../../../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/">「教学」AXI Quad SPI 时序分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/spi.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#背景">背景</a></h3>
<p>之前一直没搞懂 Vivado 中 xdc 需要怎么编写，遇到一些必须要写 xdc 的时候就很头疼，不知道怎么写才可以得到正确的结果。今天分析了一下 AXI Quad SPI 的时序 xdc，终于理解了其中的含义。</p>
<h3 id="axi-quad-spi"><a class="toclink" href="../../../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#axi-quad-spi">AXI Quad SPI</a></h3>
<p>AXI Quad SPI 是一个 SPI 的控制器，它支持 XIP（eXecute In Place）模式，即可以暴露一个只读 AXI Slave 接口，当接收到读请求的时候，就按照标准的 SPI Flash 命令去对应的地址进行读取，然后返回结果。由于不同厂家的 SPI Flash 支持有所不同，所以 IP 上的设置可以看到厂家的选择。</p>
<p>特别地，一个常见的需求是希望访问 Cfg（Configuration）Flash，亦即用来保存 Bitstream 的 Flash。当 FPGA 上电的时候，如果启动模式设置为 SPI Flash，FPGA 就会向 Cfg Flash 读取 Bitstream，Cfg Flash 需要连接到 FPGA 的指定引脚上，当 FPGA 初始化的时候由内部逻辑驱动，初始化完成后又要转交给用户逻辑。转交的方式就是通过 STARTUP 系列的 primitive。</p>
<p>通常，如果要连接外部的 SPI Flash，需要连接几条信号线到顶层，然后通过 xdc 把信号绑定到引脚上，然后引脚连接了一个外部的 SPI Flash。但由于 Cfg Flash 比较特殊，所以信号从 AXI Quad SPI 直接连到 STARTUP 系列的 primitive 上。如果是采用 STARTUPE2 原语的 7 系列的 FPGA，那么只有时钟会通过 STARTUPE2 pritimive 连接到 SPI Flash 上，其他数据信号还是正常通过顶层绑定；如果是采用 STARTUPE3 原语的 UltraScale 系列的 FPGA，那么时钟和数据都通过 STARTUPE3 primitive 连接到 SPI Flash。</p>
<h3 id="virtex-ultrascale-时序"><a class="toclink" href="../../../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#virtex-ultrascale-时序">Virtex UltraScale+ 时序</a></h3>
<p>把信号连好了只是第一步，因为外设对时序要求比较复杂，如果用一个比较高直接跑，很大可能就读取到错误的数据了。很贴心的是，AXI Quad SPI 已经在生成的文件里提供了一个样例的 xdc，在文档里也有体现。在这里，我使用的设备是 Virtex Ultrascale+ 的 FPGA，其他系列的 FPGA 会有所不一样。它内容如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>#### All the delay numbers have to be provided by the user
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>#### Following are the SPI device parameters
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>#### Max Tco
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>set tco_max 7
</span><span id="__span-20-6"><a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>#### Min Tco
</span><span id="__span-20-7"><a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a>set tco_min 1
</span><span id="__span-20-8"><a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a>#### Setup time requirement
</span><span id="__span-20-9"><a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a>set tsu 2
</span><span id="__span-20-10"><a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a>#### Hold time requirement
</span><span id="__span-20-11"><a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a>set th 3
</span><span id="__span-20-12"><a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a>#####################################################################################################
</span><span id="__span-20-13"><a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a># STARTUPE3 primitive included inside IP for US+                                                             #
</span><span id="__span-20-14"><a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a>#####################################################################################################
</span><span id="__span-20-15"><a href="#__codelineno-20-15" id="__codelineno-20-15" name="__codelineno-20-15"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-20-16"><a href="#__codelineno-20-16" id="__codelineno-20-16" name="__codelineno-20-16"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-20-17"><a href="#__codelineno-20-17" id="__codelineno-20-17" name="__codelineno-20-17"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-20-18"><a href="#__codelineno-20-18" id="__codelineno-20-18" name="__codelineno-20-18"></a>set tclk_trace_delay_min 0.2
</span><span id="__span-20-19"><a href="#__codelineno-20-19" id="__codelineno-20-19" name="__codelineno-20-19"></a>
</span><span id="__span-20-20"><a href="#__codelineno-20-20" id="__codelineno-20-20" name="__codelineno-20-20"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical *axi_quad_spi_0/ext_spi_clk] [get_pins -hierarchical */CCLK] -edges {3 5 7}
</span><span id="__span-20-21"><a href="#__codelineno-20-21" id="__codelineno-20-21" name="__codelineno-20-21"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max + $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-20-22"><a href="#__codelineno-20-22" id="__codelineno-20-22" name="__codelineno-20-22"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min + $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-20-23"><a href="#__codelineno-20-23" id="__codelineno-20-23" name="__codelineno-20-23"></a>set_multicycle_path 2 -setup -from clk_sck -to [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]]
</span><span id="__span-20-24"><a href="#__codelineno-20-24" id="__codelineno-20-24" name="__codelineno-20-24"></a>set_multicycle_path 1 -hold -end -from clk_sck -to [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]]
</span><span id="__span-20-25"><a href="#__codelineno-20-25" id="__codelineno-20-25" name="__codelineno-20-25"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max - $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span><span id="__span-20-26"><a href="#__codelineno-20-26" id="__codelineno-20-26" name="__codelineno-20-26"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th - $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span><span id="__span-20-27"><a href="#__codelineno-20-27" id="__codelineno-20-27" name="__codelineno-20-27"></a>set_multicycle_path 2 -setup -start -from [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]] -to clk_sck
</span><span id="__span-20-28"><a href="#__codelineno-20-28" id="__codelineno-20-28" name="__codelineno-20-28"></a>set_multicycle_path 1 -hold -from [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]] -to clk_sck
</span></code></pre></div>
<p>我们分段来看这个 xdc 都做了什么：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical *axi_quad_spi_0/ext_spi_clk] [get_pins -hierarchical */CCLK] -edges {3 5 7}
</span></code></pre></div>
<p>首先，它创建了一个时钟 <code>clk_sck</code>。CCLK 是 STARTUP 输出的实际时钟，会连接到 Cfg Flash 的时钟信号上。而 AXI Quad SPI 的 ext_spi_clk 会输出到 CCLK 上，因此这里是一个生成的时钟，并且指定上下边沿的位置。<code>edges</code> 参数有三个，分别表示上升、下降和上升沿分别的位置。1 表示源时钟的第一个上升沿，2 表示源时钟的第一个下降沿，以此类推，所以 {3, 5, 7} 的意思就是频率减半，相位差半个周期。</p>
<p>接着，最主要的就是，怎么设置延迟。可以看到，代码中首先定义了一些参数：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>#### Max Tco
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a>set tco_max 7
</span><span id="__span-22-3"><a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>#### Min Tco
</span><span id="__span-22-4"><a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a>set tco_min 1
</span><span id="__span-22-5"><a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a>#### Setup time requirement
</span><span id="__span-22-6"><a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a>set tsu 2
</span><span id="__span-22-7"><a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a>#### Hold time requirement
</span><span id="__span-22-8"><a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a>set th 3
</span><span id="__span-22-9"><a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a>
</span><span id="__span-22-10"><a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a>#### Trace delay
</span><span id="__span-22-11"><a href="#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-22-12"><a href="#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-22-13"><a href="#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-22-14"><a href="#__codelineno-22-14" id="__codelineno-22-14" name="__codelineno-22-14"></a>set tclk_trace_delay_min 0.2
</span></code></pre></div>
<p>首先是 <span class="arithmatex">\(t_{co}\)</span>，应该表示的是 SPI Flash 的时钟到输出的延迟。本文用的 SPI Flash 型号是 Micron MT25QU02GCBB8E12-0SIT，可以从它的 <a href="https://media-www.micron.com/-/media/client/global/documents/products/data-sheet/nor-flash/serial-nor/mt25q/die-rev-b/mt25q_qlkt_u_02g_cbb_0.pdf">Datasheet</a> 看到，时钟到输出的延迟应该是 Max 7ns：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>Clock LOW to output valid under 30pF Max 7ns
</span><span id="__span-23-2"><a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a>Clock LOW to output valid under 10pF Max 6ns
</span></code></pre></div>
<p>因此 <code>tco_max</code> 设为 7，<code>tco_min</code> 默认即可，因为 Datasheet 中没有做要求。</p>
<p>然后 <span class="arithmatex">\(t_{su}\)</span> 和 <span class="arithmatex">\(t_h\)</span> 则是输入的 setup 和 hold time。类似的，可以查到 SPI Flash 的参数：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>Data in setup time Min 2.5ns
</span><span id="__span-24-2"><a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>Data in hold time Min 2ns
</span></code></pre></div>
<p>所以 <code>tsu</code> 设为 2.5，<code>th</code> 设为 2。</p>
<p>接下来则是 tdata 和 tclk 的 trace delay。这指的是从 FPGA 引脚到 SPI Flash 引脚的信号传输延迟。从严谨的角度来说，可以从板子的布线上测量长度来计算出来，不过这里就先用默认值了。一个简单的估算方法：光速 <span class="arithmatex">\(3*10^8 \text{m/s}\)</span>，考虑电信号传播速度是光速的一半，可以得到延迟和长度的比值： <span class="arithmatex">\(0.06 \text{ns/cm} = 0.15 \text{ns/inch}\)</span>。</p>
<p>那么，这些变量怎么参与到 input/output delay 的计算呢？</p>
<p>首先考虑 input delay。它指的是，从 SPI Flash 到 FPGA 的数据，相对于时钟的延迟。这个延迟由三部分组成：</p>
<ol>
<li>从 FPGA 输出的时钟 CCLK 到 SPI Flash 的时钟有延迟 <span class="arithmatex">\(t_{clk}\)</span>，下图 <code>a -&gt; b</code></li>
<li>从 SPI Flash 的时钟到数据输出有延迟 <span class="arithmatex">\(t_{co}\)</span>，下图 <code>b -&gt; c</code></li>
<li>从 SPI Flash 的数据到 FPGA 的数据输入有延迟 <span class="arithmatex">\(t_{data}\)</span>，下图 <code>c -&gt; d</code></li>
</ol>
<svg baseprofile="full" class="WaveDrom" height="120" id="svgcontent_0" overflow="hidden" version="1.1" viewbox="0,0,500,120" width="500" xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><g id="socket"><rect height="20" width="20" x="6" y="15"></rect></g><g id="pclk"><path class="s1" d="M0,20 0,0 20,0"></path></g><g id="nclk"><path class="s1" d="m0,0 0,20 20,0"></path></g><g id="000"><path class="s1" d="m0,20 20,0"></path></g><g id="0m0"><path class="s1" d="m0,20 3,0 3,-10 3,10 11,0"></path></g><g id="0m1"><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="0mx"><path class="s1" d="M3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 5,20"></path><path class="s2" d="M20,0 4,16"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 9,1"></path><path class="s1" d="m0,20 20,0"></path></g><g id="0md"><path class="s3" d="m8,20 10,0"></path><path class="s1" d="m0,20 5,0"></path></g><g id="0mu"><path class="s1" d="m0,20 3,0 C 7,10 10.107603,0 20,0"></path></g><g id="0mz"><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="111"><path class="s1" d="M0,0 20,0"></path></g><g id="1m0"><path class="s1" d="m0,0 3,0 6,20 11,0"></path></g><g id="1m1"><path class="s1" d="M0,0 3,0 6,10 9,0 20,0"></path></g><g id="1mx"><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 5,5"></path><path class="s2" d="M3.5,1.5 5,0"></path></g><g id="1md"><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path></g><g id="1mu"><path class="s1" d="M0,0 5,0"></path><path class="s3" d="M8,0 18,0"></path></g><g id="1mz"><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path></g><g id="xxx"><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 15,0"></path><path class="s2" d="M0,20 20,0"></path><path class="s2" d="M5,20 20,5"></path><path class="s2" d="M10,20 20,10"></path><path class="s2" d="m15,20 5,-5"></path></g><g id="xm0"><path class="s1" d="M0,0 4,0 9,20"></path><path class="s1" d="m0,20 20,0"></path><path class="s2" d="M0,5 4,1"></path><path class="s2" d="M0,10 5,5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 7,13"></path><path class="s2" d="M5,20 8,17"></path></g><g id="xm1"><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 4,20 9,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 9,1"></path><path class="s2" d="M0,15 7,8"></path><path class="s2" d="M0,20 5,15"></path></g><g id="xmx"><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 15,0"></path><path class="s2" d="M0,20 20,0"></path><path class="s2" d="M5,20 20,5"></path><path class="s2" d="M10,20 20,10"></path><path class="s2" d="m15,20 5,-5"></path></g><g id="xmd"><path class="s1" d="m0,0 4,0 c 3,10 6,20 16,20"></path><path class="s1" d="m0,20 20,0"></path><path class="s2" d="M0,5 4,1"></path><path class="s2" d="M0,10 5.5,4.5"></path><path class="s2" d="M0,15 6.5,8.5"></path><path class="s2" d="M0,20 8,12"></path><path class="s2" d="m5,20 5,-5"></path><path class="s2" d="m10,20 2.5,-2.5"></path></g><g id="xmu"><path class="s1" d="M0,0 20,0"></path><path class="s1" d="m0,20 4,0 C 7,10 10,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 10,5"></path><path class="s2" d="M0,20 6,14"></path></g><g id="xmz"><path class="s1" d="m0,0 4,0 c 6,10 11,10 16,10"></path><path class="s1" d="m0,20 4,0 C 10,10 15,10 20,10"></path><path class="s2" d="M0,5 4.5,0.5"></path><path class="s2" d="M0,10 6.5,3.5"></path><path class="s2" d="M0,15 8.5,6.5"></path><path class="s2" d="M0,20 11.5,8.5"></path></g><g id="ddd"><path class="s3" d="m0,20 20,0"></path></g><g id="dm0"><path class="s3" d="m0,20 10,0"></path><path class="s1" d="m12,20 8,0"></path></g><g id="dm1"><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="dmx"><path class="s1" d="M3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 5,20"></path><path class="s2" d="M20,0 4,16"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 9,1"></path><path class="s1" d="m0,20 20,0"></path></g><g id="dmd"><path class="s3" d="m0,20 20,0"></path></g><g id="dmu"><path class="s1" d="m0,20 3,0 C 7,10 10.107603,0 20,0"></path></g><g id="dmz"><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="uuu"><path class="s3" d="M0,0 20,0"></path></g><g id="um0"><path class="s1" d="m0,0 3,0 6,20 11,0"></path></g><g id="um1"><path class="s3" d="M0,0 10,0"></path><path class="s1" d="m12,0 8,0"></path></g><g id="umx"><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 5,5"></path><path class="s2" d="M3.5,1.5 5,0"></path></g><g id="umd"><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path></g><g id="umu"><path class="s3" d="M0,0 20,0"></path></g><g id="umz"><path class="s4" d="m0,0 3,0 c 7,10 12,10 17,10"></path></g><g id="zzz"><path class="s1" d="m0,10 20,0"></path></g><g id="zm0"><path class="s1" d="m0,10 6,0 3,10 11,0"></path></g><g id="zm1"><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="zmx"><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6.5,8.5"></path><path class="s2" d="M10,0 9,1"></path></g><g id="zmd"><path class="s1" d="m0,10 7,0 c 3,5 8,10 13,10"></path></g><g id="zmu"><path class="s1" d="m0,10 7,0 C 10,5 15,0 20,0"></path></g><g id="zmz"><path class="s1" d="m0,10 20,0"></path></g><g id="gap"><path class="s5" d="m7,-2 -4,0 c -5,0 -5,24 -10,24 l 4,0 C 2,22 2,-2 7,-2 z"></path><path class="s1" d="M-7,22 C -2,22 -2,-2 3,-2"></path><path class="s1" d="M-3,22 C 2,22 2,-2 7,-2"></path></g><g id="Pclk"><path class="s6" d="M-3,12 0,3 3,12 C 1,11 -1,11 -3,12 z"></path><path class="s1" d="M0,20 0,0 20,0"></path></g><g id="Nclk"><path class="s6" d="M-3,8 0,17 3,8 C 1,9 -1,9 -3,8 z"></path><path class="s1" d="m0,0 0,20 20,0"></path></g><g id="0mv-2"><path class="s7" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-2"><path class="s7" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-2"><path class="s7" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-2"><path class="s7" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-2"><path class="s7" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-2"><path class="s7" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-2"><path class="s7" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-2"><path class="s7" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-2"><path class="s7" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-2"><path class="s7" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-2"><path class="s7" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-3"><path class="s8" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-3"><path class="s8" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-3"><path class="s8" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-3"><path class="s8" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-3"><path class="s8" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-3"><path class="s8" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-3"><path class="s8" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-3"><path class="s8" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-3"><path class="s8" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-3"><path class="s8" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-3"><path class="s8" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-4"><path class="s9" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-4"><path class="s9" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-4"><path class="s9" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-4"><path class="s9" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-4"><path class="s9" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-4"><path class="s9" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-4"><path class="s9" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-4"><path class="s9" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-4"><path class="s9" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-4"><path class="s9" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-4"><path class="s9" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-5"><path class="s10" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-5"><path class="s10" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-5"><path class="s10" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-5"><path class="s10" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-5"><path class="s10" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-5"><path class="s10" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-5"><path class="s10" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-5"><path class="s10" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-5"><path class="s10" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-5"><path class="s10" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-5"><path class="s10" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-6"><path class="s11" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-6"><path class="s11" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-6"><path class="s11" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-6"><path class="s11" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-6"><path class="s11" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-6"><path class="s11" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-6"><path class="s11" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-6"><path class="s11" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-6"><path class="s11" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-6"><path class="s11" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-6"><path class="s11" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-7"><path class="s12" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-7"><path class="s12" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-7"><path class="s12" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-7"><path class="s12" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-7"><path class="s12" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-7"><path class="s12" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-7"><path class="s12" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-7"><path class="s12" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-7"><path class="s12" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-7"><path class="s12" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-7"><path class="s12" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-8"><path class="s13" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-8"><path class="s13" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-8"><path class="s13" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-8"><path class="s13" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-8"><path class="s13" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-8"><path class="s13" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-8"><path class="s13" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-8"><path class="s13" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-8"><path class="s13" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-8"><path class="s13" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-8"><path class="s13" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-9"><path class="s14" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-9"><path class="s14" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-9"><path class="s14" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-9"><path class="s14" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-9"><path class="s14" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-9"><path class="s14" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-9"><path class="s14" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-9"><path class="s14" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-9"><path class="s14" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-9"><path class="s14" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-9"><path class="s14" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="vmv-2-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="arrow0"><path class="s15" d="m-12,-3 9,3 -9,3 c 1,-2 1,-4 0,-6 z"></path><path class="s16" d="M0,0 -15,0"></path></g><marker id="arrowhead" markerheight="7" markerunits="strokeWidth" markerwidth="10" orient="auto" refx="15" refy="0" style="fill:#0041c4" viewbox="0 -4 11 8"><path d="M0 -4 11 0 0 4z"></path></marker><marker id="arrowtail" markerheight="7" markerunits="strokeWidth" markerwidth="10" orient="auto" refx="-15" refy="0" style="fill:#0041c4" viewbox="-11 -4 11 8"><path d="M0 -4 -11 0 0 4z"></path></marker></defs><style type="text/css"><![CDATA[
text{font-size:11pt;
     font-style:normal;
     font-variant:normal;
     font-weight:normal;
     font-stretch:normal;
     text-align:center;
     fill-opacity:1;
     font-family:Helvetica}
.h1{font-size:33pt;
    font-weight:bold}
.h2{font-size:27pt;
    font-weight:bold}
.h3{font-size:20pt;
    font-weight:bold}
.h4{font-size:14pt;
    font-weight:bold}
.h5{font-size:11pt;
    font-weight:bold}
.h6{font-size:8pt;
    font-weight:bold}
.muted{fill:#aaa}
.warning{fill:#f6b900}
.error{fill:#f60000}
.info{fill:#0041c4}
.success{fill:#00ab00}
.s1{fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none}
.s2{fill:none;
    stroke:#000;
    stroke-width:0.5;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none}
.s3{color:#000;
    fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:1, 3;
    stroke-dashoffset:0;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s4{color:#000;
    fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none;
    stroke-dashoffset:0;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s5{fill:#fff;
    stroke:none}
.s6{fill:#000;
    fill-opacity:1;
    stroke:none}
.s7{color:#000;
    fill:#fff;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s8{color:#000;
    fill:#ffffb4;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s9{color:#000;
    fill:#ffe0b9;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s10{color:#000;
     fill:#b9e0ff;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s11{color:#000;
     fill:#ccfdfe;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s12{color:#000;
     fill:#cdfdc5;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s13{color:#000;
     fill:#f0c1fb;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s14{color:#000;
     fill:#f5c2c0;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s15{fill:#0041c4;
     fill-opacity:1;
     stroke:none}
.s16{fill:none;
     stroke:#0041c4;
     stroke-width:1;
     stroke-linecap:round;
     stroke-linejoin:miter;
     stroke-miterlimit:4;
     stroke-opacity:1;
     stroke-dasharray:none}
]]></style><g id="waves_0"><g id="lanes_0" transform="translate(100.5,0.5)"><g id="labels_0"><g id="labels_0_0" transform="translate(0,5)"></g><g id="labels_1_0" transform="translate(0,35)"></g><g id="labels_2_0" transform="translate(0,65)"></g><g id="labels_3_0" transform="translate(0,95)"></g></g><g id="gmarks_0"><path d="m 0,0 0,120" id="gmark_0_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 120,0 0,120" id="gmark_1_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 240,0 0,120" id="gmark_2_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 360,0 0,120" id="gmark_3_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path></g><g id="wavelane_0_0" transform="translate(0,5)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>clk_fpga</tspan></text><g id="wavelane_draw_0_0" transform="translate(0,0)"><use transform="translate(0)" xlink:href="#pclk"></use><use transform="translate(20)" xlink:href="#111"></use><use transform="translate(40)" xlink:href="#111"></use><use transform="translate(60)" xlink:href="#nclk"></use><use transform="translate(80)" xlink:href="#000"></use><use transform="translate(100)" xlink:href="#000"></use><use transform="translate(120)" xlink:href="#pclk"></use><use transform="translate(140)" xlink:href="#111"></use><use transform="translate(160)" xlink:href="#111"></use><use transform="translate(180)" xlink:href="#nclk"></use><use transform="translate(200)" xlink:href="#000"></use><use transform="translate(220)" xlink:href="#000"></use><use transform="translate(240)" xlink:href="#pclk"></use><use transform="translate(260)" xlink:href="#111"></use><use transform="translate(280)" xlink:href="#111"></use><use transform="translate(300)" xlink:href="#nclk"></use><use transform="translate(320)" xlink:href="#000"></use><use transform="translate(340)" xlink:href="#000"></use></g></g><g id="wavelane_1_0" transform="translate(0,35)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>clk_flash</tspan></text><g id="wavelane_draw_1_0" transform="translate(11.999999999999993,0)"><use transform="translate(0)" xlink:href="#pclk"></use><use transform="translate(20)" xlink:href="#111"></use><use transform="translate(40)" xlink:href="#111"></use><use transform="translate(60)" xlink:href="#nclk"></use><use transform="translate(80)" xlink:href="#000"></use><use transform="translate(100)" xlink:href="#000"></use><use transform="translate(120)" xlink:href="#pclk"></use><use transform="translate(140)" xlink:href="#111"></use><use transform="translate(160)" xlink:href="#111"></use><use transform="translate(180)" xlink:href="#nclk"></use><use transform="translate(200)" xlink:href="#000"></use><use transform="translate(220)" xlink:href="#000"></use><use transform="translate(240)" xlink:href="#pclk"></use><use transform="translate(260)" xlink:href="#111"></use><use transform="translate(280)" xlink:href="#111"></use><use transform="translate(300)" xlink:href="#nclk"></use><use transform="translate(320)" xlink:href="#000"></use><use transform="translate(340)" xlink:href="#000"></use></g></g><g id="wavelane_2_0" transform="translate(0,65)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>data_flash</tspan></text><g id="wavelane_draw_2_0" transform="translate(0.0,0)"><use transform="translate(0)" xlink:href="#vvv-3"></use><use transform="translate(20)" xlink:href="#vmv-3-4"></use><use transform="translate(40)" xlink:href="#vvv-4"></use><use transform="translate(60)" xlink:href="#vvv-4"></use><use transform="translate(80)" xlink:href="#vvv-4"></use><use transform="translate(100)" xlink:href="#vvv-4"></use><use transform="translate(120)" xlink:href="#vvv-4"></use><use transform="translate(140)" xlink:href="#vmv-4-5"></use><use transform="translate(160)" xlink:href="#vvv-5"></use><use transform="translate(180)" xlink:href="#vvv-5"></use><use transform="translate(200)" xlink:href="#vvv-5"></use><use transform="translate(220)" xlink:href="#vvv-5"></use><use transform="translate(240)" xlink:href="#vvv-5"></use><use transform="translate(260)" xlink:href="#vmv-5-6"></use><use transform="translate(280)" xlink:href="#vvv-6"></use><use transform="translate(300)" xlink:href="#vvv-6"></use><use transform="translate(320)" xlink:href="#vvv-6"></use><use transform="translate(340)" xlink:href="#vvv-6"></use><use transform="translate(360)" xlink:href="#vvv-6"></use></g></g><g id="wavelane_3_0" transform="translate(0,95)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>data_fpga</tspan></text><g id="wavelane_draw_3_0" transform="translate(8.000000000000007,0)"><use transform="translate(0)" xlink:href="#vvv-3"></use><use transform="translate(20)" xlink:href="#vmv-3-4"></use><use transform="translate(40)" xlink:href="#vvv-4"></use><use transform="translate(60)" xlink:href="#vvv-4"></use><use transform="translate(80)" xlink:href="#vvv-4"></use><use transform="translate(100)" xlink:href="#vvv-4"></use><use transform="translate(120)" xlink:href="#vvv-4"></use><use transform="translate(140)" xlink:href="#vmv-4-5"></use><use transform="translate(160)" xlink:href="#vvv-5"></use><use transform="translate(180)" xlink:href="#vvv-5"></use><use transform="translate(200)" xlink:href="#vvv-5"></use><use transform="translate(220)" xlink:href="#vvv-5"></use><use transform="translate(240)" xlink:href="#vvv-5"></use><use transform="translate(260)" xlink:href="#vmv-5-6"></use><use transform="translate(280)" xlink:href="#vvv-6"></use><use transform="translate(300)" xlink:href="#vvv-6"></use><use transform="translate(320)" xlink:href="#vvv-6"></use><use transform="translate(340)" xlink:href="#vvv-6"></use><use transform="translate(360)" xlink:href="#vvv-6"></use></g></g><g id="wavearcs_0"><g transform="translate(126,15)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>a</tspan></text></g><g transform="translate(138,45)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>b</tspan></text></g><g transform="translate(146,75)"><rect height="10" style="fill:#FFF;" width="7.36" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>c</tspan></text></g><g transform="translate(154,105)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>d</tspan></text></g></g><g id="wavegaps_0"><g id="wavegap_0_0" transform="translate(0,5)"></g><g id="wavegap_1_0" transform="translate(0,35)"></g><g id="wavegap_2_0" transform="translate(0,65)"></g><g id="wavegap_3_0" transform="translate(0,95)"></g></g></g><g id="groups_0"></g></g></svg>
<p>因此总延迟就是 <span class="arithmatex">\(t_{clk}+t_{co}+t_{data}\)</span>，就可以得到对应的设置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max + $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min + $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span></code></pre></div>
<p>接下来要考虑 output delay。虽然 output delay 也有 min 和 max，但其含义有所区别，需要分别考虑。</p>
<p>首先是 max，它对应的是 setup time。如果定义时间 0 为时钟的上升沿，沿更早的时间为正的时间轴，沿更晚的时间为负的时间轴。那么，我们希望的是，数据到达寄存器输入的时间大于 setup time，此时可以满足 setup 条件。那么，具体怎么算呢？注意，我们要考虑的是从 FPGA 数据输出到 SPI Flash 上时钟的延迟。</p>
<p>假设 FPGA CCLK 时钟上升沿在 <span class="arithmatex">\(0\)</span> 时刻（下图的 <code>a</code>），那么 SPI Flash 时钟上升沿在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻（下图的 <code>b</code>）。假设 FPGA 数据输出时刻为 <span class="arithmatex">\(t_0\)</span>（通常为正，下图的 <code>c</code>），那么 FPGA 数据输出到达 SPI Flash 在 <span class="arithmatex">\(t_0-t_{data}\)</span> 时刻（下图的 <code>d</code>），我们期望 <span class="arithmatex">\(t_0-t_{data}\)</span> 在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻之前（下图的 <code>d -&gt; b</code>）至少 <span class="arithmatex">\(t_{su}\)</span> 时间到达，可以得到表达式：</p>
<svg baseprofile="full" class="WaveDrom" height="120" id="svgcontent_0" overflow="hidden" version="1.1" viewbox="0,0,480,120" width="480" xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><g id="socket"><rect height="20" width="20" x="6" y="15"></rect></g><g id="pclk"><path class="s1" d="M0,20 0,0 20,0"></path></g><g id="nclk"><path class="s1" d="m0,0 0,20 20,0"></path></g><g id="000"><path class="s1" d="m0,20 20,0"></path></g><g id="0m0"><path class="s1" d="m0,20 3,0 3,-10 3,10 11,0"></path></g><g id="0m1"><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="0mx"><path class="s1" d="M3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 5,20"></path><path class="s2" d="M20,0 4,16"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 9,1"></path><path class="s1" d="m0,20 20,0"></path></g><g id="0md"><path class="s3" d="m8,20 10,0"></path><path class="s1" d="m0,20 5,0"></path></g><g id="0mu"><path class="s1" d="m0,20 3,0 C 7,10 10.107603,0 20,0"></path></g><g id="0mz"><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="111"><path class="s1" d="M0,0 20,0"></path></g><g id="1m0"><path class="s1" d="m0,0 3,0 6,20 11,0"></path></g><g id="1m1"><path class="s1" d="M0,0 3,0 6,10 9,0 20,0"></path></g><g id="1mx"><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 5,5"></path><path class="s2" d="M3.5,1.5 5,0"></path></g><g id="1md"><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path></g><g id="1mu"><path class="s1" d="M0,0 5,0"></path><path class="s3" d="M8,0 18,0"></path></g><g id="1mz"><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path></g><g id="xxx"><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 15,0"></path><path class="s2" d="M0,20 20,0"></path><path class="s2" d="M5,20 20,5"></path><path class="s2" d="M10,20 20,10"></path><path class="s2" d="m15,20 5,-5"></path></g><g id="xm0"><path class="s1" d="M0,0 4,0 9,20"></path><path class="s1" d="m0,20 20,0"></path><path class="s2" d="M0,5 4,1"></path><path class="s2" d="M0,10 5,5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 7,13"></path><path class="s2" d="M5,20 8,17"></path></g><g id="xm1"><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 4,20 9,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 9,1"></path><path class="s2" d="M0,15 7,8"></path><path class="s2" d="M0,20 5,15"></path></g><g id="xmx"><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 15,0"></path><path class="s2" d="M0,20 20,0"></path><path class="s2" d="M5,20 20,5"></path><path class="s2" d="M10,20 20,10"></path><path class="s2" d="m15,20 5,-5"></path></g><g id="xmd"><path class="s1" d="m0,0 4,0 c 3,10 6,20 16,20"></path><path class="s1" d="m0,20 20,0"></path><path class="s2" d="M0,5 4,1"></path><path class="s2" d="M0,10 5.5,4.5"></path><path class="s2" d="M0,15 6.5,8.5"></path><path class="s2" d="M0,20 8,12"></path><path class="s2" d="m5,20 5,-5"></path><path class="s2" d="m10,20 2.5,-2.5"></path></g><g id="xmu"><path class="s1" d="M0,0 20,0"></path><path class="s1" d="m0,20 4,0 C 7,10 10,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 10,5"></path><path class="s2" d="M0,20 6,14"></path></g><g id="xmz"><path class="s1" d="m0,0 4,0 c 6,10 11,10 16,10"></path><path class="s1" d="m0,20 4,0 C 10,10 15,10 20,10"></path><path class="s2" d="M0,5 4.5,0.5"></path><path class="s2" d="M0,10 6.5,3.5"></path><path class="s2" d="M0,15 8.5,6.5"></path><path class="s2" d="M0,20 11.5,8.5"></path></g><g id="ddd"><path class="s3" d="m0,20 20,0"></path></g><g id="dm0"><path class="s3" d="m0,20 10,0"></path><path class="s1" d="m12,20 8,0"></path></g><g id="dm1"><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="dmx"><path class="s1" d="M3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 5,20"></path><path class="s2" d="M20,0 4,16"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 9,1"></path><path class="s1" d="m0,20 20,0"></path></g><g id="dmd"><path class="s3" d="m0,20 20,0"></path></g><g id="dmu"><path class="s1" d="m0,20 3,0 C 7,10 10.107603,0 20,0"></path></g><g id="dmz"><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="uuu"><path class="s3" d="M0,0 20,0"></path></g><g id="um0"><path class="s1" d="m0,0 3,0 6,20 11,0"></path></g><g id="um1"><path class="s3" d="M0,0 10,0"></path><path class="s1" d="m12,0 8,0"></path></g><g id="umx"><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 5,5"></path><path class="s2" d="M3.5,1.5 5,0"></path></g><g id="umd"><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path></g><g id="umu"><path class="s3" d="M0,0 20,0"></path></g><g id="umz"><path class="s4" d="m0,0 3,0 c 7,10 12,10 17,10"></path></g><g id="zzz"><path class="s1" d="m0,10 20,0"></path></g><g id="zm0"><path class="s1" d="m0,10 6,0 3,10 11,0"></path></g><g id="zm1"><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="zmx"><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6.5,8.5"></path><path class="s2" d="M10,0 9,1"></path></g><g id="zmd"><path class="s1" d="m0,10 7,0 c 3,5 8,10 13,10"></path></g><g id="zmu"><path class="s1" d="m0,10 7,0 C 10,5 15,0 20,0"></path></g><g id="zmz"><path class="s1" d="m0,10 20,0"></path></g><g id="gap"><path class="s5" d="m7,-2 -4,0 c -5,0 -5,24 -10,24 l 4,0 C 2,22 2,-2 7,-2 z"></path><path class="s1" d="M-7,22 C -2,22 -2,-2 3,-2"></path><path class="s1" d="M-3,22 C 2,22 2,-2 7,-2"></path></g><g id="Pclk"><path class="s6" d="M-3,12 0,3 3,12 C 1,11 -1,11 -3,12 z"></path><path class="s1" d="M0,20 0,0 20,0"></path></g><g id="Nclk"><path class="s6" d="M-3,8 0,17 3,8 C 1,9 -1,9 -3,8 z"></path><path class="s1" d="m0,0 0,20 20,0"></path></g><g id="0mv-2"><path class="s7" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-2"><path class="s7" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-2"><path class="s7" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-2"><path class="s7" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-2"><path class="s7" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-2"><path class="s7" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-2"><path class="s7" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-2"><path class="s7" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-2"><path class="s7" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-2"><path class="s7" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-2"><path class="s7" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-3"><path class="s8" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-3"><path class="s8" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-3"><path class="s8" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-3"><path class="s8" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-3"><path class="s8" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-3"><path class="s8" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-3"><path class="s8" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-3"><path class="s8" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-3"><path class="s8" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-3"><path class="s8" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-3"><path class="s8" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-4"><path class="s9" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-4"><path class="s9" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-4"><path class="s9" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-4"><path class="s9" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-4"><path class="s9" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-4"><path class="s9" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-4"><path class="s9" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-4"><path class="s9" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-4"><path class="s9" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-4"><path class="s9" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-4"><path class="s9" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-5"><path class="s10" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-5"><path class="s10" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-5"><path class="s10" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-5"><path class="s10" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-5"><path class="s10" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-5"><path class="s10" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-5"><path class="s10" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-5"><path class="s10" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-5"><path class="s10" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-5"><path class="s10" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-5"><path class="s10" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-6"><path class="s11" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-6"><path class="s11" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-6"><path class="s11" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-6"><path class="s11" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-6"><path class="s11" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-6"><path class="s11" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-6"><path class="s11" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-6"><path class="s11" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-6"><path class="s11" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-6"><path class="s11" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-6"><path class="s11" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-7"><path class="s12" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-7"><path class="s12" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-7"><path class="s12" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-7"><path class="s12" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-7"><path class="s12" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-7"><path class="s12" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-7"><path class="s12" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-7"><path class="s12" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-7"><path class="s12" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-7"><path class="s12" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-7"><path class="s12" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-8"><path class="s13" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-8"><path class="s13" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-8"><path class="s13" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-8"><path class="s13" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-8"><path class="s13" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-8"><path class="s13" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-8"><path class="s13" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-8"><path class="s13" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-8"><path class="s13" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-8"><path class="s13" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-8"><path class="s13" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-9"><path class="s14" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-9"><path class="s14" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-9"><path class="s14" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-9"><path class="s14" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-9"><path class="s14" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-9"><path class="s14" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-9"><path class="s14" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-9"><path class="s14" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-9"><path class="s14" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-9"><path class="s14" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-9"><path class="s14" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="vmv-2-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="arrow0"><path class="s15" d="m-12,-3 9,3 -9,3 c 1,-2 1,-4 0,-6 z"></path><path class="s16" d="M0,0 -15,0"></path></g><marker id="arrowhead" markerheight="7" markerunits="strokeWidth" markerwidth="10" orient="auto" refx="15" refy="0" style="fill:#0041c4" viewbox="0 -4 11 8"><path d="M0 -4 11 0 0 4z"></path></marker><marker id="arrowtail" markerheight="7" markerunits="strokeWidth" markerwidth="10" orient="auto" refx="-15" refy="0" style="fill:#0041c4" viewbox="-11 -4 11 8"><path d="M0 -4 -11 0 0 4z"></path></marker></defs><style type="text/css"><![CDATA[
text{font-size:11pt;
     font-style:normal;
     font-variant:normal;
     font-weight:normal;
     font-stretch:normal;
     text-align:center;
     fill-opacity:1;
     font-family:Helvetica}
.h1{font-size:33pt;
    font-weight:bold}
.h2{font-size:27pt;
    font-weight:bold}
.h3{font-size:20pt;
    font-weight:bold}
.h4{font-size:14pt;
    font-weight:bold}
.h5{font-size:11pt;
    font-weight:bold}
.h6{font-size:8pt;
    font-weight:bold}
.muted{fill:#aaa}
.warning{fill:#f6b900}
.error{fill:#f60000}
.info{fill:#0041c4}
.success{fill:#00ab00}
.s1{fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none}
.s2{fill:none;
    stroke:#000;
    stroke-width:0.5;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none}
.s3{color:#000;
    fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:1, 3;
    stroke-dashoffset:0;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s4{color:#000;
    fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none;
    stroke-dashoffset:0;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s5{fill:#fff;
    stroke:none}
.s6{fill:#000;
    fill-opacity:1;
    stroke:none}
.s7{color:#000;
    fill:#fff;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s8{color:#000;
    fill:#ffffb4;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s9{color:#000;
    fill:#ffe0b9;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s10{color:#000;
     fill:#b9e0ff;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s11{color:#000;
     fill:#ccfdfe;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s12{color:#000;
     fill:#cdfdc5;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s13{color:#000;
     fill:#f0c1fb;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s14{color:#000;
     fill:#f5c2c0;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s15{fill:#0041c4;
     fill-opacity:1;
     stroke:none}
.s16{fill:none;
     stroke:#0041c4;
     stroke-width:1;
     stroke-linecap:round;
     stroke-linejoin:miter;
     stroke-miterlimit:4;
     stroke-opacity:1;
     stroke-dasharray:none}
]]></style><g id="waves_0"><g id="lanes_0" transform="translate(100.5,0.5)"><g id="labels_0"><g id="labels_0_0" transform="translate(0,5)"></g><g id="labels_1_0" transform="translate(0,35)"></g><g id="labels_2_0" transform="translate(0,65)"></g><g id="labels_3_0" transform="translate(0,95)"></g></g><g id="gmarks_0"><path d="m 0,0 0,120" id="gmark_0_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 120,0 0,120" id="gmark_1_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 240,0 0,120" id="gmark_2_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 360,0 0,120" id="gmark_3_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path></g><g id="wavelane_0_0" transform="translate(0,5)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>clk_fpga</tspan></text><g id="wavelane_draw_0_0" transform="translate(0,0)"><use transform="translate(0)" xlink:href="#pclk"></use><use transform="translate(20)" xlink:href="#111"></use><use transform="translate(40)" xlink:href="#111"></use><use transform="translate(60)" xlink:href="#nclk"></use><use transform="translate(80)" xlink:href="#000"></use><use transform="translate(100)" xlink:href="#000"></use><use transform="translate(120)" xlink:href="#pclk"></use><use transform="translate(140)" xlink:href="#111"></use><use transform="translate(160)" xlink:href="#111"></use><use transform="translate(180)" xlink:href="#nclk"></use><use transform="translate(200)" xlink:href="#000"></use><use transform="translate(220)" xlink:href="#000"></use><use transform="translate(240)" xlink:href="#pclk"></use><use transform="translate(260)" xlink:href="#111"></use><use transform="translate(280)" xlink:href="#111"></use><use transform="translate(300)" xlink:href="#nclk"></use><use transform="translate(320)" xlink:href="#000"></use><use transform="translate(340)" xlink:href="#000"></use></g></g><g id="wavelane_1_0" transform="translate(0,35)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>clk_flash</tspan></text><g id="wavelane_draw_1_0" transform="translate(11.999999999999993,0)"><use transform="translate(0)" xlink:href="#pclk"></use><use transform="translate(20)" xlink:href="#111"></use><use transform="translate(40)" xlink:href="#111"></use><use transform="translate(60)" xlink:href="#nclk"></use><use transform="translate(80)" xlink:href="#000"></use><use transform="translate(100)" xlink:href="#000"></use><use transform="translate(120)" xlink:href="#pclk"></use><use transform="translate(140)" xlink:href="#111"></use><use transform="translate(160)" xlink:href="#111"></use><use transform="translate(180)" xlink:href="#nclk"></use><use transform="translate(200)" xlink:href="#000"></use><use transform="translate(220)" xlink:href="#000"></use><use transform="translate(240)" xlink:href="#pclk"></use><use transform="translate(260)" xlink:href="#111"></use><use transform="translate(280)" xlink:href="#111"></use><use transform="translate(300)" xlink:href="#nclk"></use><use transform="translate(320)" xlink:href="#000"></use><use transform="translate(340)" xlink:href="#000"></use></g></g><g id="wavelane_2_0" transform="translate(0,65)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>data_fpga</tspan></text><g id="wavelane_draw_2_0" transform="translate(15.999999999999996,0)"><use transform="translate(0)" xlink:href="#vvv-4"></use><use transform="translate(20)" xlink:href="#vvv-4"></use><use transform="translate(40)" xlink:href="#vvv-4"></use><use transform="translate(60)" xlink:href="#vvv-4"></use><use transform="translate(80)" xlink:href="#vmv-4-5"></use><use transform="translate(100)" xlink:href="#vvv-5"></use><use transform="translate(120)" xlink:href="#vvv-5"></use><use transform="translate(140)" xlink:href="#vvv-5"></use><use transform="translate(160)" xlink:href="#vvv-5"></use><use transform="translate(180)" xlink:href="#vvv-5"></use><use transform="translate(200)" xlink:href="#vmv-5-6"></use><use transform="translate(220)" xlink:href="#vvv-6"></use><use transform="translate(240)" xlink:href="#vvv-6"></use><use transform="translate(260)" xlink:href="#vvv-6"></use><use transform="translate(280)" xlink:href="#vvv-6"></use><use transform="translate(300)" xlink:href="#vvv-6"></use></g></g><g id="wavelane_3_0" transform="translate(0,95)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>data_flash</tspan></text><g id="wavelane_draw_3_0" transform="translate(4.0000000000000036,0)"><use transform="translate(0)" xlink:href="#vvv-4"></use><use transform="translate(20)" xlink:href="#vvv-4"></use><use transform="translate(40)" xlink:href="#vvv-4"></use><use transform="translate(60)" xlink:href="#vvv-4"></use><use transform="translate(80)" xlink:href="#vvv-4"></use><use transform="translate(100)" xlink:href="#vmv-4-5"></use><use transform="translate(120)" xlink:href="#vvv-5"></use><use transform="translate(140)" xlink:href="#vvv-5"></use><use transform="translate(160)" xlink:href="#vvv-5"></use><use transform="translate(180)" xlink:href="#vvv-5"></use><use transform="translate(200)" xlink:href="#vvv-5"></use><use transform="translate(220)" xlink:href="#vmv-5-6"></use><use transform="translate(240)" xlink:href="#vvv-6"></use><use transform="translate(260)" xlink:href="#vvv-6"></use><use transform="translate(280)" xlink:href="#vvv-6"></use><use transform="translate(300)" xlink:href="#vvv-6"></use><use transform="translate(320)" xlink:href="#vvv-6"></use></g></g><g id="wavearcs_0"><g transform="translate(126,15)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>a</tspan></text></g><g transform="translate(138,45)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>b</tspan></text></g><g transform="translate(102,75)"><rect height="10" style="fill:#FFF;" width="7.36" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>c</tspan></text></g><g transform="translate(110,105)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>d</tspan></text></g></g><g id="wavegaps_0"><g id="wavegap_0_0" transform="translate(0,5)"></g><g id="wavegap_1_0" transform="translate(0,35)"></g><g id="wavegap_2_0" transform="translate(0,65)"></g><g id="wavegap_3_0" transform="translate(0,95)"></g></g></g><g id="groups_0"></g></g></svg>
<div class="arithmatex">\[
t_0 - t_{data} &gt; -t_{clk} + t_{su}
\]</div>
<p>化简一下，就可以得到 <span class="arithmatex">\(t_0 &gt; t_{data} + t_{su} - t_{clk}\)</span>，如果考虑极端情况，右侧 <span class="arithmatex">\(t_{data}\)</span> 取最大值，<span class="arithmatex">\(t_{clk}\)</span> 取最小值，我们就可以得到约束：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max - $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span></code></pre></div>
<p>接下来考虑 output delay 的 min，这对应的是 hold time。我们希望数据到达 SPI Flash 寄存器的时候，距离上升沿时间超过了 <span class="arithmatex">\(t_h\)</span>。还是一样的假设，如果 FPGA CCLK 时钟上升沿在 0 时刻（下图的 <code>a</code>），那么 SPI Flash 时钟上升沿在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻（下图的 <code>b</code>）。假设 FPGA 数据输出时刻为 <span class="arithmatex">\(t_0\)</span>（下图的 <code>c</code>），那么 FPGA 数据输出到达 SPI Flash 在 <span class="arithmatex">\(t_0-t_{data}\)</span> 时刻（下图的 <code>d</code>），要求满足 hold 条件，可以得到：</p>
<svg baseprofile="full" class="WaveDrom" height="120" id="svgcontent_0" overflow="hidden" version="1.1" viewbox="0,0,500,120" width="500" xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><g id="socket"><rect height="20" width="20" x="6" y="15"></rect></g><g id="pclk"><path class="s1" d="M0,20 0,0 20,0"></path></g><g id="nclk"><path class="s1" d="m0,0 0,20 20,0"></path></g><g id="000"><path class="s1" d="m0,20 20,0"></path></g><g id="0m0"><path class="s1" d="m0,20 3,0 3,-10 3,10 11,0"></path></g><g id="0m1"><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="0mx"><path class="s1" d="M3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 5,20"></path><path class="s2" d="M20,0 4,16"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 9,1"></path><path class="s1" d="m0,20 20,0"></path></g><g id="0md"><path class="s3" d="m8,20 10,0"></path><path class="s1" d="m0,20 5,0"></path></g><g id="0mu"><path class="s1" d="m0,20 3,0 C 7,10 10.107603,0 20,0"></path></g><g id="0mz"><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="111"><path class="s1" d="M0,0 20,0"></path></g><g id="1m0"><path class="s1" d="m0,0 3,0 6,20 11,0"></path></g><g id="1m1"><path class="s1" d="M0,0 3,0 6,10 9,0 20,0"></path></g><g id="1mx"><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 5,5"></path><path class="s2" d="M3.5,1.5 5,0"></path></g><g id="1md"><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path></g><g id="1mu"><path class="s1" d="M0,0 5,0"></path><path class="s3" d="M8,0 18,0"></path></g><g id="1mz"><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path></g><g id="xxx"><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 15,0"></path><path class="s2" d="M0,20 20,0"></path><path class="s2" d="M5,20 20,5"></path><path class="s2" d="M10,20 20,10"></path><path class="s2" d="m15,20 5,-5"></path></g><g id="xm0"><path class="s1" d="M0,0 4,0 9,20"></path><path class="s1" d="m0,20 20,0"></path><path class="s2" d="M0,5 4,1"></path><path class="s2" d="M0,10 5,5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 7,13"></path><path class="s2" d="M5,20 8,17"></path></g><g id="xm1"><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 4,20 9,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 9,1"></path><path class="s2" d="M0,15 7,8"></path><path class="s2" d="M0,20 5,15"></path></g><g id="xmx"><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 15,0"></path><path class="s2" d="M0,20 20,0"></path><path class="s2" d="M5,20 20,5"></path><path class="s2" d="M10,20 20,10"></path><path class="s2" d="m15,20 5,-5"></path></g><g id="xmd"><path class="s1" d="m0,0 4,0 c 3,10 6,20 16,20"></path><path class="s1" d="m0,20 20,0"></path><path class="s2" d="M0,5 4,1"></path><path class="s2" d="M0,10 5.5,4.5"></path><path class="s2" d="M0,15 6.5,8.5"></path><path class="s2" d="M0,20 8,12"></path><path class="s2" d="m5,20 5,-5"></path><path class="s2" d="m10,20 2.5,-2.5"></path></g><g id="xmu"><path class="s1" d="M0,0 20,0"></path><path class="s1" d="m0,20 4,0 C 7,10 10,0 20,0"></path><path class="s2" d="M0,5 5,0"></path><path class="s2" d="M0,10 10,0"></path><path class="s2" d="M0,15 10,5"></path><path class="s2" d="M0,20 6,14"></path></g><g id="xmz"><path class="s1" d="m0,0 4,0 c 6,10 11,10 16,10"></path><path class="s1" d="m0,20 4,0 C 10,10 15,10 20,10"></path><path class="s2" d="M0,5 4.5,0.5"></path><path class="s2" d="M0,10 6.5,3.5"></path><path class="s2" d="M0,15 8.5,6.5"></path><path class="s2" d="M0,20 11.5,8.5"></path></g><g id="ddd"><path class="s3" d="m0,20 20,0"></path></g><g id="dm0"><path class="s3" d="m0,20 10,0"></path><path class="s1" d="m12,20 8,0"></path></g><g id="dm1"><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="dmx"><path class="s1" d="M3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 5,20"></path><path class="s2" d="M20,0 4,16"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 9,1"></path><path class="s1" d="m0,20 20,0"></path></g><g id="dmd"><path class="s3" d="m0,20 20,0"></path></g><g id="dmu"><path class="s1" d="m0,20 3,0 C 7,10 10.107603,0 20,0"></path></g><g id="dmz"><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="uuu"><path class="s3" d="M0,0 20,0"></path></g><g id="um0"><path class="s1" d="m0,0 3,0 6,20 11,0"></path></g><g id="um1"><path class="s3" d="M0,0 10,0"></path><path class="s1" d="m12,0 8,0"></path></g><g id="umx"><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6,9"></path><path class="s2" d="M10,0 5,5"></path><path class="s2" d="M3.5,1.5 5,0"></path></g><g id="umd"><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path></g><g id="umu"><path class="s3" d="M0,0 20,0"></path></g><g id="umz"><path class="s4" d="m0,0 3,0 c 7,10 12,10 17,10"></path></g><g id="zzz"><path class="s1" d="m0,10 20,0"></path></g><g id="zm0"><path class="s1" d="m0,10 6,0 3,10 11,0"></path></g><g id="zm1"><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="zmx"><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 6.5,8.5"></path><path class="s2" d="M10,0 9,1"></path></g><g id="zmd"><path class="s1" d="m0,10 7,0 c 3,5 8,10 13,10"></path></g><g id="zmu"><path class="s1" d="m0,10 7,0 C 10,5 15,0 20,0"></path></g><g id="zmz"><path class="s1" d="m0,10 20,0"></path></g><g id="gap"><path class="s5" d="m7,-2 -4,0 c -5,0 -5,24 -10,24 l 4,0 C 2,22 2,-2 7,-2 z"></path><path class="s1" d="M-7,22 C -2,22 -2,-2 3,-2"></path><path class="s1" d="M-3,22 C 2,22 2,-2 7,-2"></path></g><g id="Pclk"><path class="s6" d="M-3,12 0,3 3,12 C 1,11 -1,11 -3,12 z"></path><path class="s1" d="M0,20 0,0 20,0"></path></g><g id="Nclk"><path class="s6" d="M-3,8 0,17 3,8 C 1,9 -1,9 -3,8 z"></path><path class="s1" d="m0,0 0,20 20,0"></path></g><g id="0mv-2"><path class="s7" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-2"><path class="s7" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-2"><path class="s7" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-2"><path class="s7" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-2"><path class="s7" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-2"><path class="s7" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-2"><path class="s7" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-2"><path class="s7" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-2"><path class="s7" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-2"><path class="s7" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-2"><path class="s7" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-3"><path class="s8" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-3"><path class="s8" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-3"><path class="s8" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-3"><path class="s8" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-3"><path class="s8" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-3"><path class="s8" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-3"><path class="s8" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-3"><path class="s8" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-3"><path class="s8" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-3"><path class="s8" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-3"><path class="s8" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-4"><path class="s9" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-4"><path class="s9" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-4"><path class="s9" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-4"><path class="s9" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-4"><path class="s9" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-4"><path class="s9" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-4"><path class="s9" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-4"><path class="s9" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-4"><path class="s9" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-4"><path class="s9" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-4"><path class="s9" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-5"><path class="s10" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-5"><path class="s10" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-5"><path class="s10" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-5"><path class="s10" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-5"><path class="s10" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-5"><path class="s10" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-5"><path class="s10" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-5"><path class="s10" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-5"><path class="s10" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-5"><path class="s10" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-5"><path class="s10" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-6"><path class="s11" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-6"><path class="s11" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-6"><path class="s11" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-6"><path class="s11" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-6"><path class="s11" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-6"><path class="s11" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-6"><path class="s11" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-6"><path class="s11" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-6"><path class="s11" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-6"><path class="s11" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-6"><path class="s11" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-7"><path class="s12" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-7"><path class="s12" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-7"><path class="s12" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-7"><path class="s12" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-7"><path class="s12" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-7"><path class="s12" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-7"><path class="s12" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-7"><path class="s12" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-7"><path class="s12" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-7"><path class="s12" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-7"><path class="s12" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-8"><path class="s13" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-8"><path class="s13" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-8"><path class="s13" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-8"><path class="s13" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-8"><path class="s13" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-8"><path class="s13" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-8"><path class="s13" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-8"><path class="s13" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-8"><path class="s13" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-8"><path class="s13" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-8"><path class="s13" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="0mv-9"><path class="s14" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="1mv-9"><path class="s14" d="M2.875,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="xmv-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s2" d="M0,5 3.5,1.5"></path><path class="s2" d="M0,10 4.5,5.5"></path><path class="s2" d="M0,15 6,9"></path><path class="s2" d="M0,20 4,16"></path></g><g id="dmv-9"><path class="s14" d="M9,0 20,0 20,20 3,20 z"></path><path class="s1" d="M3,20 9,0 20,0"></path><path class="s1" d="m0,20 20,0"></path></g><g id="umv-9"><path class="s14" d="M3,0 20,0 20,20 9,20 z"></path><path class="s1" d="m3,0 6,20 11,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="zmv-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s1" d="m6,10 3,10 11,0"></path><path class="s1" d="M0,10 6,10 9,0 20,0"></path></g><g id="vvv-9"><path class="s14" d="M20,20 0,20 0,0 20,0"></path><path class="s1" d="m0,20 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vm0-9"><path class="s14" d="M0,20 0,0 3,0 9,20"></path><path class="s1" d="M0,0 3,0 9,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vm1-9"><path class="s14" d="M0,0 0,20 3,20 9,0"></path><path class="s1" d="M0,0 20,0"></path><path class="s1" d="M0,20 3,20 9,0"></path></g><g id="vmx-9"><path class="s14" d="M0,0 0,20 3,20 6,10 3,0"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path><path class="s2" d="m20,15 -5,5"></path><path class="s2" d="M20,10 10,20"></path><path class="s2" d="M20,5 8,17"></path><path class="s2" d="M20,0 7,13"></path><path class="s2" d="M15,0 7,8"></path><path class="s2" d="M10,0 9,1"></path></g><g id="vmd-9"><path class="s14" d="m0,0 0,20 20,0 C 10,20 7,10 3,0"></path><path class="s1" d="m0,0 3,0 c 4,10 7,20 17,20"></path><path class="s1" d="m0,20 20,0"></path></g><g id="vmu-9"><path class="s14" d="m0,0 0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="m0,20 3,0 C 7,10 10,0 20,0"></path><path class="s1" d="M0,0 20,0"></path></g><g id="vmz-9"><path class="s14" d="M0,0 3,0 C 10,10 15,10 20,10 15,10 10,10 3,20 L 0,20"></path><path class="s1" d="m0,0 3,0 c 7,10 12,10 17,10"></path><path class="s1" d="m0,20 3,0 C 10,10 15,10 20,10"></path></g><g id="vmv-2-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-2"><path class="s7" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-3"><path class="s8" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-4"><path class="s9" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-5"><path class="s10" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-6"><path class="s11" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-7"><path class="s12" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-8"><path class="s13" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-2-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s7" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-3-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s8" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-4-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s9" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-5-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s10" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-6-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s11" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-7-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s12" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-8-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s13" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="vmv-9-9"><path class="s14" d="M9,0 20,0 20,20 9,20 6,10 z"></path><path class="s14" d="M3,0 0,0 0,20 3,20 6,10 z"></path><path class="s1" d="m0,0 3,0 6,20 11,0"></path><path class="s1" d="M0,20 3,20 9,0 20,0"></path></g><g id="arrow0"><path class="s15" d="m-12,-3 9,3 -9,3 c 1,-2 1,-4 0,-6 z"></path><path class="s16" d="M0,0 -15,0"></path></g><marker id="arrowhead" markerheight="7" markerunits="strokeWidth" markerwidth="10" orient="auto" refx="15" refy="0" style="fill:#0041c4" viewbox="0 -4 11 8"><path d="M0 -4 11 0 0 4z"></path></marker><marker id="arrowtail" markerheight="7" markerunits="strokeWidth" markerwidth="10" orient="auto" refx="-15" refy="0" style="fill:#0041c4" viewbox="-11 -4 11 8"><path d="M0 -4 -11 0 0 4z"></path></marker></defs><style type="text/css"><![CDATA[
text{font-size:11pt;
     font-style:normal;
     font-variant:normal;
     font-weight:normal;
     font-stretch:normal;
     text-align:center;
     fill-opacity:1;
     font-family:Helvetica}
.h1{font-size:33pt;
    font-weight:bold}
.h2{font-size:27pt;
    font-weight:bold}
.h3{font-size:20pt;
    font-weight:bold}
.h4{font-size:14pt;
    font-weight:bold}
.h5{font-size:11pt;
    font-weight:bold}
.h6{font-size:8pt;
    font-weight:bold}
.muted{fill:#aaa}
.warning{fill:#f6b900}
.error{fill:#f60000}
.info{fill:#0041c4}
.success{fill:#00ab00}
.s1{fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none}
.s2{fill:none;
    stroke:#000;
    stroke-width:0.5;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none}
.s3{color:#000;
    fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:1, 3;
    stroke-dashoffset:0;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s4{color:#000;
    fill:none;
    stroke:#000;
    stroke-width:1;
    stroke-linecap:round;
    stroke-linejoin:miter;
    stroke-miterlimit:4;
    stroke-opacity:1;
    stroke-dasharray:none;
    stroke-dashoffset:0;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s5{fill:#fff;
    stroke:none}
.s6{fill:#000;
    fill-opacity:1;
    stroke:none}
.s7{color:#000;
    fill:#fff;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s8{color:#000;
    fill:#ffffb4;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s9{color:#000;
    fill:#ffe0b9;
    fill-opacity:1;
    fill-rule:nonzero;
    stroke:none;
    stroke-width:1px;
    marker:none;
    visibility:visible;
    display:inline;
    overflow:visible}
.s10{color:#000;
     fill:#b9e0ff;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s11{color:#000;
     fill:#ccfdfe;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s12{color:#000;
     fill:#cdfdc5;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s13{color:#000;
     fill:#f0c1fb;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s14{color:#000;
     fill:#f5c2c0;
     fill-opacity:1;
     fill-rule:nonzero;
     stroke:none;
     stroke-width:1px;
     marker:none;
     visibility:visible;
     display:inline;
     overflow:visible}
.s15{fill:#0041c4;
     fill-opacity:1;
     stroke:none}
.s16{fill:none;
     stroke:#0041c4;
     stroke-width:1;
     stroke-linecap:round;
     stroke-linejoin:miter;
     stroke-miterlimit:4;
     stroke-opacity:1;
     stroke-dasharray:none}
]]></style><g id="waves_0"><g id="lanes_0" transform="translate(100.5,0.5)"><g id="labels_0"><g id="labels_0_0" transform="translate(0,5)"></g><g id="labels_1_0" transform="translate(0,35)"></g><g id="labels_2_0" transform="translate(0,65)"></g><g id="labels_3_0" transform="translate(0,95)"></g></g><g id="gmarks_0"><path d="m 0,0 0,120" id="gmark_0_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 120,0 0,120" id="gmark_1_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 240,0 0,120" id="gmark_2_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path><path d="m 360,0 0,120" id="gmark_3_0" style="stroke:#888;stroke-width:0.5;stroke-dasharray:1,3"></path></g><g id="wavelane_0_0" transform="translate(0,5)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>clk_fpga</tspan></text><g id="wavelane_draw_0_0" transform="translate(0,0)"><use transform="translate(0)" xlink:href="#pclk"></use><use transform="translate(20)" xlink:href="#111"></use><use transform="translate(40)" xlink:href="#111"></use><use transform="translate(60)" xlink:href="#nclk"></use><use transform="translate(80)" xlink:href="#000"></use><use transform="translate(100)" xlink:href="#000"></use><use transform="translate(120)" xlink:href="#pclk"></use><use transform="translate(140)" xlink:href="#111"></use><use transform="translate(160)" xlink:href="#111"></use><use transform="translate(180)" xlink:href="#nclk"></use><use transform="translate(200)" xlink:href="#000"></use><use transform="translate(220)" xlink:href="#000"></use><use transform="translate(240)" xlink:href="#pclk"></use><use transform="translate(260)" xlink:href="#111"></use><use transform="translate(280)" xlink:href="#111"></use><use transform="translate(300)" xlink:href="#nclk"></use><use transform="translate(320)" xlink:href="#000"></use><use transform="translate(340)" xlink:href="#000"></use></g></g><g id="wavelane_1_0" transform="translate(0,35)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>data_fpga</tspan></text><g id="wavelane_draw_1_0" transform="translate(15.999999999999996,0)"><use transform="translate(0)" xlink:href="#vmv-3-4"></use><use transform="translate(20)" xlink:href="#vvv-4"></use><use transform="translate(40)" xlink:href="#vvv-4"></use><use transform="translate(60)" xlink:href="#vvv-4"></use><use transform="translate(80)" xlink:href="#vvv-4"></use><use transform="translate(100)" xlink:href="#vvv-4"></use><use transform="translate(120)" xlink:href="#vmv-4-5"></use><use transform="translate(140)" xlink:href="#vvv-5"></use><use transform="translate(160)" xlink:href="#vvv-5"></use><use transform="translate(180)" xlink:href="#vvv-5"></use><use transform="translate(200)" xlink:href="#vvv-5"></use><use transform="translate(220)" xlink:href="#vvv-5"></use><use transform="translate(240)" xlink:href="#vmv-5-6"></use><use transform="translate(260)" xlink:href="#vvv-6"></use><use transform="translate(280)" xlink:href="#vvv-6"></use><use transform="translate(300)" xlink:href="#vvv-6"></use><use transform="translate(320)" xlink:href="#vvv-6"></use><use transform="translate(340)" xlink:href="#vvv-6"></use></g></g><g id="wavelane_2_0" transform="translate(0,65)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>clk_flash</tspan></text><g id="wavelane_draw_2_0" transform="translate(8.000000000000007,0)"><use transform="translate(0)" xlink:href="#000"></use><use transform="translate(20)" xlink:href="#pclk"></use><use transform="translate(40)" xlink:href="#111"></use><use transform="translate(60)" xlink:href="#111"></use><use transform="translate(80)" xlink:href="#nclk"></use><use transform="translate(100)" xlink:href="#000"></use><use transform="translate(120)" xlink:href="#000"></use><use transform="translate(140)" xlink:href="#pclk"></use><use transform="translate(160)" xlink:href="#111"></use><use transform="translate(180)" xlink:href="#111"></use><use transform="translate(200)" xlink:href="#nclk"></use><use transform="translate(220)" xlink:href="#000"></use><use transform="translate(240)" xlink:href="#000"></use><use transform="translate(260)" xlink:href="#pclk"></use><use transform="translate(280)" xlink:href="#111"></use><use transform="translate(300)" xlink:href="#111"></use><use transform="translate(320)" xlink:href="#nclk"></use><use transform="translate(340)" xlink:href="#000"></use><use transform="translate(360)" xlink:href="#000"></use></g></g><g id="wavelane_3_0" transform="translate(0,95)"><text class="info" text-anchor="end" x="-10" xml:space="preserve" y="15"><tspan>data_flash</tspan></text><g id="wavelane_draw_3_0" transform="translate(11.999999999999993,0)"><use transform="translate(0)" xlink:href="#vvv-3"></use><use transform="translate(20)" xlink:href="#vmv-3-4"></use><use transform="translate(40)" xlink:href="#vvv-4"></use><use transform="translate(60)" xlink:href="#vvv-4"></use><use transform="translate(80)" xlink:href="#vvv-4"></use><use transform="translate(100)" xlink:href="#vvv-4"></use><use transform="translate(120)" xlink:href="#vvv-4"></use><use transform="translate(140)" xlink:href="#vmv-4-5"></use><use transform="translate(160)" xlink:href="#vvv-5"></use><use transform="translate(180)" xlink:href="#vvv-5"></use><use transform="translate(200)" xlink:href="#vvv-5"></use><use transform="translate(220)" xlink:href="#vvv-5"></use><use transform="translate(240)" xlink:href="#vvv-5"></use><use transform="translate(260)" xlink:href="#vmv-5-6"></use><use transform="translate(280)" xlink:href="#vvv-6"></use><use transform="translate(300)" xlink:href="#vvv-6"></use><use transform="translate(320)" xlink:href="#vvv-6"></use><use transform="translate(340)" xlink:href="#vvv-6"></use><use transform="translate(360)" xlink:href="#vvv-6"></use></g></g><g id="wavearcs_0"><g transform="translate(126,15)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>a</tspan></text></g><g transform="translate(142,45)"><rect height="10" style="fill:#FFF;" width="7.36" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>c</tspan></text></g><g transform="translate(154,75)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>b</tspan></text></g><g transform="translate(158,105)"><rect height="10" style="fill:#FFF;" width="7.92" x="-3" y="-5"></rect><text style="font-size:8px;" text-anchor="middle" y="3"><tspan>d</tspan></text></g></g><g id="wavegaps_0"><g id="wavegap_0_0" transform="translate(0,5)"></g><g id="wavegap_1_0" transform="translate(0,35)"></g><g id="wavegap_2_0" transform="translate(0,65)"></g><g id="wavegap_3_0" transform="translate(0,95)"></g></g></g><g id="groups_0"></g></g></svg>
<div class="arithmatex">\[
t_0 - t_{data} &lt; -t_{clk} - t_h
\]</div>
<p>化简以后，可以得到 <span class="arithmatex">\(t_0 &lt; t_{data} - t_{clk} - t_h\)</span>，按照极限来取，<span class="arithmatex">\(t_{data}\)</span> 取最小值，<span class="arithmatex">\(t_{clk}\)</span> 取最大值，可以得到最终的时序约束：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th - $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span></code></pre></div>
<p>这样就可以实现 FPGA 和 SPI Flash 之间的正常通讯了。我觉得，这里比较绕的就是时间轴的定义，和我们平常思考的是反过来的。而且，这里的 min 和 max 并不是指 <span class="arithmatex">\([\min, \max]\)</span>，而是 <span class="arithmatex">\((-\inf, \min] \cup [\max, \inf)\)</span>。代入上面的数据，可以得到 <span class="arithmatex">\(\max=2.05, \min=-2.95, t_0 \in (\inf, -2.95] \cup [2.05, \inf)\)</span>。如果变化的时刻距离时钟上升沿太接近，就会导致在 SPI Flash 侧出现不满足 setup 或者 hold 约束的情况。</p>
<p>也可以换个角度来理解 min 和 max：对于同一个周期的时钟和数据来说，数据相对时钟有一个延迟，这个延迟不能太小，至少要满足 hold，所以这是一个最小的延迟；同时这个延迟不能太大，最多需要满足下一个时钟上升沿的 setup，所以这是一个最大的延迟。如果从这个角度来看，那就是延迟在一个 <span class="arithmatex">\([\min, \max]\)</span> 的范围内。但是，这样在计算的时候就需要把时钟周期纳入到 <span class="arithmatex">\(\max\)</span> 的计算中，比如 <span class="arithmatex">\(\max=t_c-t_{su}\)</span>。如果我们把坐标轴修改一下，原点变成原来的下一个时钟周期的上升沿，x 的正方向变成反向，就可以得到上面的形式了。</p>
<h3 id="artix-7-时序"><a class="toclink" href="../../../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#artix-7-时序">Artix 7 时序</a></h3>
<p>那么，更常见的 FPGA 是 7 系列的，比如 Artix 7，它采用的是 STARTUPE2 原语，只有时钟是通过 STARTUPE2 原语的 USRCCLKO 信号传递到 CCLK 引脚上的，其他数据信号都是需要在顶层信号绑定对应的引脚。在 AXI Quad SPI 文档中，描述了 STARTUPE2 所需要的时序约束，我们分段来分析一下。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a># You must provide all the delay numbers
</span><span id="__span-28-2"><a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a># CCLK delay is 0.5, 6.7 ns min/max for K7-2; refer Data sheet
</span><span id="__span-28-3"><a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a># Consider the max delay for worst case analysis
</span><span id="__span-28-4"><a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a>set cclk_delay 6.7
</span><span id="__span-28-5"><a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a># Following are the SPI device parameters
</span><span id="__span-28-6"><a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a># Max Tco
</span><span id="__span-28-7"><a href="#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a>set tco_max 7
</span><span id="__span-28-8"><a href="#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a># Min Tco
</span><span id="__span-28-9"><a href="#__codelineno-28-9" id="__codelineno-28-9" name="__codelineno-28-9"></a>set tco_min 1
</span><span id="__span-28-10"><a href="#__codelineno-28-10" id="__codelineno-28-10" name="__codelineno-28-10"></a># Setup time requirement
</span><span id="__span-28-11"><a href="#__codelineno-28-11" id="__codelineno-28-11" name="__codelineno-28-11"></a>set tsu 2
</span><span id="__span-28-12"><a href="#__codelineno-28-12" id="__codelineno-28-12" name="__codelineno-28-12"></a># Hold time requirement
</span><span id="__span-28-13"><a href="#__codelineno-28-13" id="__codelineno-28-13" name="__codelineno-28-13"></a>set th 3
</span><span id="__span-28-14"><a href="#__codelineno-28-14" id="__codelineno-28-14" name="__codelineno-28-14"></a># Following are the board/trace delay numbers
</span><span id="__span-28-15"><a href="#__codelineno-28-15" id="__codelineno-28-15" name="__codelineno-28-15"></a># Assumption is that all Data lines are matched
</span><span id="__span-28-16"><a href="#__codelineno-28-16" id="__codelineno-28-16" name="__codelineno-28-16"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-28-17"><a href="#__codelineno-28-17" id="__codelineno-28-17" name="__codelineno-28-17"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-28-18"><a href="#__codelineno-28-18" id="__codelineno-28-18" name="__codelineno-28-18"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-28-19"><a href="#__codelineno-28-19" id="__codelineno-28-19" name="__codelineno-28-19"></a>set tclk_trace_delay_min 0.2
</span><span id="__span-28-20"><a href="#__codelineno-28-20" id="__codelineno-28-20" name="__codelineno-28-20"></a>### End of user provided delay numbers
</span></code></pre></div>
<p>可以看到，这一部分和上面 UltraScale+ 部分差不多，只是多一个 <code>cclk_delay</code> 变量，这是因为 Artix 7 中，时钟只能创建到 USRCCLKO 引脚上，但是实际 SPI Flash 接收到的时钟等于 USRCCLKO 到 CCLK 引脚，然后再通过 PCB 上的线传播到 SPI Flash，所以需要手动添加一个偏移，这个偏移就是 USRCCLKO 到 CCLK 的延迟，可以在 <a href="https://www.xilinx.com/support/documentation/data_sheets/ds181_Artix_7_Data_Sheet.pdf">Artix 7 Data Sheet</a> 里面看到：对于 1.0V，-2 速度的 FPGA，这个延迟最小值为 0.50ns，最大值为 6.70ns，这里采用了最大值。</p>
<p>所以，下面的约束，除了时钟部分以外，和上面分析的 UltraScale+ 时序约束计算方法是相同的。不同点在于，首先约束了从 AXI Quad SPI 到 STARTUPE2 的路由时延，从 0.1ns 到 1.5ns，然后又从 USRCCLKO 创建了一个分频 + 延迟 <code>cclk_delay</code> 纳秒的时钟，作为 SPI Flash 上 SCK 引脚的时钟。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a># this is to ensure min routing delay from SCK generation to STARTUP input
</span><span id="__span-29-2"><a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a># User should change this value based on the results
</span><span id="__span-29-3"><a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a># having more delay on this net reduces the Fmax
</span><span id="__span-29-4"><a href="#__codelineno-29-4" id="__codelineno-29-4" name="__codelineno-29-4"></a>set_max_delay 1.5 -from [get_pins -hier *SCK_O_reg_reg/C] -to [get_pins -hier
</span><span id="__span-29-5"><a href="#__codelineno-29-5" id="__codelineno-29-5" name="__codelineno-29-5"></a>*USRCCLKO] -datapath_only
</span><span id="__span-29-6"><a href="#__codelineno-29-6" id="__codelineno-29-6" name="__codelineno-29-6"></a>set_min_delay 0.1 -from [get_pins -hier *SCK_O_reg_reg/C] -to [get_pins -hier
</span><span id="__span-29-7"><a href="#__codelineno-29-7" id="__codelineno-29-7" name="__codelineno-29-7"></a>*USRCCLKO]
</span><span id="__span-29-8"><a href="#__codelineno-29-8" id="__codelineno-29-8" name="__codelineno-29-8"></a># Following command creates a divide by 2 clock
</span><span id="__span-29-9"><a href="#__codelineno-29-9" id="__codelineno-29-9" name="__codelineno-29-9"></a># It also takes into account the delay added by STARTUP block to route the CCLK
</span><span id="__span-29-10"><a href="#__codelineno-29-10" id="__codelineno-29-10" name="__codelineno-29-10"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical
</span><span id="__span-29-11"><a href="#__codelineno-29-11" id="__codelineno-29-11" name="__codelineno-29-11"></a>*axi_quad_spi_1/ext_spi_clk] [get_pins -hierarchical *USRCCLKO] -edges {3 5 7}
</span><span id="__span-29-12"><a href="#__codelineno-29-12" id="__codelineno-29-12" name="__codelineno-29-12"></a>-edge_shift [list $cclk_delay $cclk_delay $cclk_delay]
</span><span id="__span-29-13"><a href="#__codelineno-29-13" id="__codelineno-29-13" name="__codelineno-29-13"></a># Data is captured into FPGA on the second rising edge of ext_spi_clk after the SCK
</span><span id="__span-29-14"><a href="#__codelineno-29-14" id="__codelineno-29-14" name="__codelineno-29-14"></a>falling edge
</span><span id="__span-29-15"><a href="#__codelineno-29-15" id="__codelineno-29-15" name="__codelineno-29-15"></a>
</span><span id="__span-29-16"><a href="#__codelineno-29-16" id="__codelineno-29-16" name="__codelineno-29-16"></a># Data is driven by the FPGA on every alternate rising_edge of ext_spi_clk
</span><span id="__span-29-17"><a href="#__codelineno-29-17" id="__codelineno-29-17" name="__codelineno-29-17"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max +
</span><span id="__span-29-18"><a href="#__codelineno-29-18" id="__codelineno-29-18" name="__codelineno-29-18"></a>$tclk_trace_delay_max] [get_ports IO*_IO] -clock_fall;
</span><span id="__span-29-19"><a href="#__codelineno-29-19" id="__codelineno-29-19" name="__codelineno-29-19"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min +
</span><span id="__span-29-20"><a href="#__codelineno-29-20" id="__codelineno-29-20" name="__codelineno-29-20"></a>$tclk_trace_delay_min] [get_ports IO*_IO] -clock_fall;
</span><span id="__span-29-21"><a href="#__codelineno-29-21" id="__codelineno-29-21" name="__codelineno-29-21"></a>set_multicycle_path 2 -setup -from clk_sck -to [get_clocks -of_objects [get_pins
</span><span id="__span-29-22"><a href="#__codelineno-29-22" id="__codelineno-29-22" name="__codelineno-29-22"></a>-hierarchical */ext_spi_clk]]
</span><span id="__span-29-23"><a href="#__codelineno-29-23" id="__codelineno-29-23" name="__codelineno-29-23"></a>set_multicycle_path 1 -hold -end -from clk_sck -to [get_clocks -of_objects [get_pins
</span><span id="__span-29-24"><a href="#__codelineno-29-24" id="__codelineno-29-24" name="__codelineno-29-24"></a>-hierarchical */ext_spi_clk]]
</span><span id="__span-29-25"><a href="#__codelineno-29-25" id="__codelineno-29-25" name="__codelineno-29-25"></a># Data is captured into SPI on the following rising edge of SCK
</span><span id="__span-29-26"><a href="#__codelineno-29-26" id="__codelineno-29-26" name="__codelineno-29-26"></a># Data is driven by the IP on alternate rising_edge of the ext_spi_clk
</span><span id="__span-29-27"><a href="#__codelineno-29-27" id="__codelineno-29-27" name="__codelineno-29-27"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max -
</span><span id="__span-29-28"><a href="#__codelineno-29-28" id="__codelineno-29-28" name="__codelineno-29-28"></a>$tclk_trace_delay_min] [get_ports IO*_IO];
</span><span id="__span-29-29"><a href="#__codelineno-29-29" id="__codelineno-29-29" name="__codelineno-29-29"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th -
</span><span id="__span-29-30"><a href="#__codelineno-29-30" id="__codelineno-29-30" name="__codelineno-29-30"></a>$tclk_trace_delay_max] [get_ports IO*_IO];
</span><span id="__span-29-31"><a href="#__codelineno-29-31" id="__codelineno-29-31" name="__codelineno-29-31"></a>set_multicycle_path 2 -setup -start -from [get_clocks -of_objects [get_pins
</span><span id="__span-29-32"><a href="#__codelineno-29-32" id="__codelineno-29-32" name="__codelineno-29-32"></a>-hierarchical */ext_spi_clk]] -to clk_sck
</span><span id="__span-29-33"><a href="#__codelineno-29-33" id="__codelineno-29-33" name="__codelineno-29-33"></a>set_multicycle_path 1 -hold -from [get_clocks -of_objects [get_pins -hierarchical */
</span><span id="__span-29-34"><a href="#__codelineno-29-34" id="__codelineno-29-34" name="__codelineno-29-34"></a>ext_spi_clk]] -to clk_sck
</span></code></pre></div>
<p>一个 Artix 7 上配置 STARTUP SPI Flash 的例子 <a href="https://github.com/trivialmips/nontrivial-mips/blob/master/vivado/NonTrivialMIPS.srcs/constrs_1/new/io_timings.xdc">io_timings.xdc</a> 可供参考。</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-09-14 00:00:00+00:00">2021年9月14日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="浅谈乱序执行-cpu一乱序"><a class="toclink" href="../../../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU（一：乱序）</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/ooo_cpu.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/09/14/brief-into-ooo/#背景">背景</a></h3>
<p>最早学习乱序执行 CPU 的时候，是在 Wikipedia 上自学的，后来在计算机系统结构课上又学了一遍，但发现学的和现在实际采用的乱序执行 CPU 又有很大区别，后来又仔细研究了一下，觉得理解更多了，就想总结一下。</p>
<p>本文主要讨论乱序执行的部分。</p>
<p>本系列的所有文章：</p>
<ul>
<li><a href="../../../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU（一：乱序）</a></li>
<li><a href="../../../../hardware/2022/03/31/brief-into-ooo-2/">浅谈乱序执行 CPU（二：访存）</a></li>
<li><a href="../../../../hardware/2024/09/12/brief-into-ooo-3/">浅谈乱序执行 CPU（三：前端）</a></li>
</ul>
<nav class="md-post__action">
<a href="../../../../hardware/2021/09/14/brief-into-ooo/">
          继续阅读
        </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-05-06 00:00:00+00:00">2021年5月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="硬盘相关的概念"><a class="toclink" href="../../../../hardware/2021/05/06/disk/">硬盘相关的概念</a></h2>
<h3 id="ata"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#ata">ATA</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Parallel_ATA">ATA</a> 定义了发送给硬盘的命令，<a href="https://people.freebsd.org/~imp/asiabsdcon2015/works/d2161r5-ATAATAPI_Command_Set_-_3.pdf">标准</a>定义了命令：</p>
<ul>
<li>ech IDENTIFY DEVICE: 获取设备信息</li>
<li>25h READ DMA EXT: 读取扇区</li>
<li>35h WRITE DMA EXT: 写入扇区</li>
</ul>
<p>ATA 同时也是接口，图片如下。ATA 前身是 IDE，现在 ATA 叫做 PATA。</p>
<p><img alt="PATA Pin" src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/ATA_Plug.svg/600px-ATA_Plug.svg.png"/></p>
<h3 id="ahci"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#ahci">AHCI</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Advanced_Host_Controller_Interface">AHCI</a> 可以简单理解为 PCIe &lt;-&gt; SATA 的转换器。AHCI 暴露为一个 PCIe 设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>lspci<span class="w"> </span>-vv
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="m">00</span>:1f.2<span class="w"> </span>SATA<span class="w"> </span>controller:<span class="w"> </span>Intel<span class="w"> </span>Corporation<span class="w"> </span>C600/X79<span class="w"> </span>series<span class="w"> </span>chipset<span class="w"> </span><span class="m">6</span>-Port<span class="w"> </span>SATA<span class="w"> </span>AHCI<span class="w"> </span>Controller<span class="w"> </span><span class="o">(</span>rev<span class="w"> </span><span class="m">05</span><span class="o">)</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">        </span>Kernel<span class="w"> </span>modules:<span class="w"> </span>ahci
</span></code></pre></div>
<p>处理器通过 IO port/MMIO 访问 AHCI，然后 AHCI HBA 连接到 SATA 设备。</p>
<h3 id="sata"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sata">SATA</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Serial_ATA">SATA</a> 一般说的是接口。它一般分为两个部分，数据和电源。数据部分只有 7 个 pin，三个 GND 和两对差分线（A+A- B+B-），图片如下：</p>
<p><img alt="SATA Data" src="https://upload.wikimedia.org/wikipedia/commons/e/ef/SATA_Data_Cable.jpg"/></p>
<p>电源部分有 15 个 pin，有 GND 3.3V 5V 和 12V，图片如下：</p>
<p><img alt="SATA Power" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/SATA_power_cable.jpg/400px-SATA_power_cable.jpg"/></p>
<p>常见的 SATA 盘有 2.5 英寸（small form factor, SFF）和 3.5 英寸（large form factor，LFF）两种规格。</p>
<h3 id="m2"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#m2">M.2</a></h3>
<p><a href="https://en.wikipedia.org/wiki/M.2">M.2</a> 又称 NGFF，有不同的 key 类型。常见的是 B 和 M：</p>
<ul>
<li>B key: 12-19 notched, PCIe x2, SATA</li>
<li>M key: 59-66 notched, PCIe x4, SATA</li>
</ul>
<p>都有部分引脚的位置是空的：</p>
<p><img alt="M.2" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ed/M2_Edge_Connector_Keying.svg/620px-M2_Edge_Connector_Keying.svg.png"/></p>
<p>在<a href="https://pinoutguide.com/HD/M.2_NGFF_connector_pinout.shtml">这里</a>可以看到两种 key 的 pinout。</p>
<ul>
<li>B key: SATA pin B(41,43) A(47,49), PCIe x2 pin R1(29,31) T1(35,37) R0(41,43) T0(47,49), USB 3.0 pin TX(29, 31) RX(35,37)</li>
<li>M key: SATA 同上，PCIe x4 pin R3(5,7) T3(11,13) R2(17,19) T2(23,25) Lane 0,1 同上</li>
</ul>
<p>可以看到，SATA pin 和 PCIe 的两个 lane 在 B 和 M key 中是一样的，物理上也是可以兼容的。</p>
<p>因为支持 SATA 和 PCIe，就有下面三种可能的使用方式：</p>
<ul>
<li>PCIe -- AHCI HBA(Board) -- SATA(M.2) -- Disk: 传统方式，只不过物理接口从 SATA 变成了 M.2</li>
<li>PCIe -- PCIe Device(M.2) -- Disk(AHCI)：硬盘实现了 AHCI 的接口，通过 PCIe 连接到 CPU</li>
<li>PCIe -- PCIe Device(M.2) -- Disk(NVMe)：硬盘实现了 NVMe 的接口，通过 PCIe 连接到 CPU</li>
</ul>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/SATA_Express_interface.svg/620px-SATA_Express_interface.svg.png"/></p>
<h3 id="sata-express"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sata-express">SATA express</a></h3>
<p><a href="https://en.wikipedia.org/wiki/SATA_Express">SATA express</a> 在 SATA 3.2 引入，它用的很少，被 U.2 取代。提供了 PCIe x2 或者 SATA x2。</p>
<h3 id="u2"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#u2">U.2</a></h3>
<p><a href="https://en.wikipedia.org/wiki/U.2">U.2</a> 也叫 <a href="https://members.snia.org/document/dl/26489">SFF-8639</a>。它和 <a href="https://en.wikipedia.org/wiki/SATA_Express">SATA express</a> 接口一样，但提供了 PCIe x4 或者 SATA x2。详见 <a href="https://pinoutguide.com/HD/U.2_SATA_connector_pinout.shtml">pinout</a>。</p>
<p><img alt="U.2" src="https://www.delock.com/infothek/U.2-NVMe/images/teaser.jpg"/></p>
<h3 id="速度比较"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#速度比较">速度比较</a></h3>
<p>不同的协议的速度如下：</p>
<ul>
<li>SATA 3.0: 6Gb/s(8b/10b, 4Gb/s uncoded)</li>
<li>SAS-1: 3Gb/s</li>
<li>SAS-2: 6Gb/s</li>
<li>SAS-3: 12Gb/s</li>
<li>SAS-4: 22.5Gb/s</li>
<li>PCIe 3.0 x4: 32Gb/s(8GT/s, 128b/130b, 31.5 Gb/s uncoded)</li>
</ul>
<p>更完整的可以看<a href="https://en.wikipedia.org/wiki/List_of_interface_bit_rates">List of interface bit rates</a>。</p>
<p><a href="https://ark.intel.com/content/www/us/en/ark/products/192574/intel-ssd-dc-p4618-series-6-4tb-1-2-height-pcie-3-1-x8-3d2-tlc.html">Intel SSD DC P4618 Series</a> 读写速度可以达到 40~50 Gb/s，它采用的是 PCIe 3.0 x8(64Gb/s) NVMe。</p>
<p><a href="https://ark.intel.com/content/www/us/en/ark/products/125024/intel-ssd-545s-series-1-024tb-2-5in-sata-6gb-s-3d2-tlc.html">Intel SSD 545s Series</a> 读写速度约 4Gb/s，采用的是 SATA 3.0 6Gb/s。</p>
<p><a href="https://www.samsung.com/semiconductor/minisite/ssd/product/consumer/970evo/">SAMSUNG 970 EVO</a> 读写速度 20~30 Gb/s，它采用的是 PCIe 3.0 x4(32Gb/s) NVMe。</p>
<h3 id="sas"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sas">SAS</a></h3>
<p>SAS 涉及的物理接口比较多，下面举一个具体的例子：DELL SCv2000</p>
<p>文档：https://dl.dell.com/topicspdf/storage-sc2000_owners-manual_en-us.pdf</p>
<p>它的背面：</p>
<p><img alt="" src="../../../../hardware/scv2000.png"/></p>
<p>它有四个前端接口 Mini-SAS High Density (HD)，即 SFF-8644；两个后端接口 Mini-SAS，即 SFF-8088。</p>
<p>RAID 卡例子：MegaRAID SAS 9361-8i</p>
<p>文档：https://docs.broadcom.com/doc/12351995</p>
<p>它的接口有：</p>
<ol>
<li>两个 mini-SAS SFF-8643(Mini Multilane 4/8X 12 Gb/s Unshielded Connector (HD12un)) 内部连接器，连接到硬盘</li>
<li>PCIe 3.0 8x 连接主板</li>
</ol>
<p>SAS 标准：</p>
<ul>
<li>INCITS 417 Serial Attached SCSI 1.1 (SAS-1.1)</li>
<li>INCITS 457 Serial Attached SCSI 2 (SAS-2)</li>
<li>INCITS 478 Serial Attached SCSI 2.1 (SAS-2.1)</li>
<li>INCITS 519 Serial Attached SCSI - 3 (SAS-3)</li>
<li>INCITS 534 Serial Attached SCSI - 4 (SAS-4)</li>
</ul>
<p>可以从 https://www.t10.org/drafts.htm#SCSI3_SAS 免费下载尚未成为标准的 SAS-4.1 Working Draft。</p>
<h3 id="sas-相关的物理接口"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sas-相关的物理接口">SAS 相关的物理接口</a></h3>
<p>查找 SFF 标准：https://www.snia.org/technology-communities/sff/specifications</p>
<p>中文介绍：https://www.163.com/dy/article/H8TGPEUA0532B75P.html</p>
<h4 id="sff-8087"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sff-8087">SFF-8087</a></h4>
<p>Mini Multilane 4X Unshielded Connector Shell and Plug</p>
<p><img alt="" src="../../../../hardware/sff8087.png"/></p>
<p>介绍：https://cs-electronics.com/sff-8087/</p>
<p>Mini SAS 4i 连接器就是 36 pin 的 SFF-8087，支持四路 SAS。i 表示用于 internal 连接。对应的 external 接口是 SFF-8088。</p>
<p>标准下载地址：https://members.snia.org/document/dl/25823</p>
<p>它的引脚定义可以在 <a href="https://members.snia.org/document/dl/27380">SFF-9402</a> 看到，它的引脚分为 A 面和 B 面，每面有 18 个 PIN，用途如下：</p>
<ul>
<li>A2(Rx0+), A3(Rx0-), B2(Tx0+), B3(Tx0-)：第一组差分对</li>
<li>A4(Rx1+), A5(Rx1-), B4(Tx1+), B5(Tx1-)：第二组差分对</li>
<li>A13(Rx2+), A14(Rx2-), B13(Tx2+), B14(Tx2-)：第三组差分对</li>
<li>A16(Rx3+), A17(Rx3-), B16(Tx3+), B17(Tx3-)：第四组差分对</li>
<li>B8(Sclock), B9(Sload), A10(SDataOut), A11(SDataIn)：SGPIO 协议</li>
<li>B8(2W-CLK), B9(2W-DATA)：用于 SES 的 I2C 协议</li>
</ul>
<p>这四组差分对对应四路 SAS 或者 SATA。SGPIO 协议的标准是 <a href="https://members.snia.org/document/dl/25923">SFF-8485</a>，主要用途是控制硬盘状态灯，以及判断盘是否插入。</p>
<p>相关标准：</p>
<ul>
<li>SFF-8086: Mini Multilane 10 Gb/s 4X Common Elements Connector</li>
</ul>
<h4 id="sff-8088"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sff-8088">SFF-8088</a></h4>
<p>Mini Multilane 4X Shielded Connector Shell and Plug</p>
<p><img alt="" src="../../../../hardware/sff8088.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/25824</p>
<p>Mini SAS 4x 连接器就是 26 pin 的 SFF-8088，支持四路 SAS。用于 external 连接。对应的 internal 接口是 SFF-8087。</p>
<h4 id="sff-8482sff-8678sff-8680sff-8681"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sff-8482sff-8678sff-8680sff-8681">SFF-8482/SFF-8678/SFF-8680/SFF-8681</a></h4>
<p>SFF-8482: Serial Attachment 2X Unshielded Connector (EIA-966)</p>
<p><img alt="" src="../../../../hardware/sff8482.png"/></p>
<p>介绍：https://cs-electronics.com/sff-8482/</p>
<p>支持两路 SAS，29 个引脚。和 SATA 的接口大小一样，目的是为了可以兼容 SATA 和 SAS 盘，比较常见。</p>
<p>标准下载地址：https://members.snia.org/document/dl/25920</p>
<p>不同速率的版本：</p>
<ul>
<li>SFF-8678: Serial Attachment 2X 6Gb/s Unshielded Connector</li>
<li>SFF-8680: Serial Attachment 2X 12Gb/s Unshielded Connector, 支持 SAS-2.x 和 SAS-3</li>
<li>SFF-8681: Serial Attachment 2X 24Gb/s Unshielded Connector, 支持 SAS-4</li>
</ul>
<h4 id="sff-86148644"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sff-86148644">SFF-8614/8644</a></h4>
<p>SFF-8614: Mini Multilane 4/8X Shielded Cage/Connector (HDsh)</p>
<p><img alt="" src="../../../../hardware/sff8614.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/25939</p>
<p>对应的 internal 版本是 SFF-8643: Mini Multilane 4/8X 12 Gb/s Unshielded Connector</p>
<p>名称：External Mini-SAS HD(High Density)</p>
<p>升级版本：</p>
<p>SFF-8644: Mini Multilane 4/8X 12 Gb/s Shielded Cage/Connector (HD12sh)</p>
<p>标准下载地址：https://members.snia.org/document/dl/25952</p>
<p>支持 SAS-3 和 PCIe 3.0</p>
<h4 id="sff-8639"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sff-8639">SFF-8639</a></h4>
<p>Multifunction 6X Unshielded Connector</p>
<p>又称 U.2</p>
<p><img alt="" src="../../../../hardware/sff8639.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/26489</p>
<p>用途：</p>
<ul>
<li>Single port SATA (as defined by Serial ATA revision 3.1)</li>
<li>Two port SATA Express (as defined in Serial ATA Technical Proposal #TPR_C109, currently under development)</li>
<li>Dual port SAS (as defined by SFF-8482)</li>
<li>MultiLink SAS (as defined by SFF-8630)</li>
<li>Up to 4 lanes of PCIe (as defined in this specification)</li>
</ul>
<h4 id="sff-8611"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#sff-8611">SFF-8611</a></h4>
<p>MiniLink 4/8X I/O Cable Assemblies</p>
<p>又称 OCuLink 1.0</p>
<p><img alt="" src="../../../../hardware/sff8611.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/27937</p>
<p>用途：</p>
<ul>
<li>PCIe</li>
<li>SAS</li>
</ul>
<h3 id="硬盘性能指标"><a class="toclink" href="../../../../hardware/2021/05/06/disk/#硬盘性能指标">硬盘性能指标</a></h3>
<p>硬盘性能一般会看如下几个指标：</p>
<ol>
<li>顺序读写性能，在指定的 block size 下，顺序读写的传输速度，单位通常是 MB/s</li>
<li>随机读写性能，在指定的 block size 下（一般是 4KB），随机地址读写的每秒读写操作次数，单位通常是 IOPS</li>
<li>延迟</li>
</ol>
<p>CrystalDiskInfo 术语：</p>
<ul>
<li>SEQ1MQ8T1：顺序读写（SEQ），一次读写 1 MB（1M），队列深度是 8（Q8），单线程（T1）</li>
<li>SEQ128KQ32T1：顺序读写（SEQ），一次读写 128 KB（128K），队列深度是 32（Q32），单线程（T1）</li>
<li>RND4KQ32T16：随机读写（RND），一次读写 4KB（4K），队列深度是 32（Q32），16 线程（T16）</li>
<li>RND4KQ1T1：随机读写（RND），一次读写 4KB（4K），队列深度是 1（Q1），单线程（T1）</li>
</ul>
<p>根据 <a href="https://www.buildcomputers.net/ssd-vs-hdd.html">SSD vs HDD - Should You Buy a Solid State Drive or Hard Disk Drive?</a>，SSD 和 HDD 在顺序读写性能上的常见范围：</p>
<ul>
<li>SSD: 300 ~ 500 MB/s</li>
<li>HDD: 100 ~ 160 MB/s</li>
</ul>
<p>SSD 和 HDD 在随机读写性能上的常见范围：</p>
<ul>
<li>SSD: 20,000 ~ 100,000 IOPS</li>
<li>HDD: 75 ~ 100 IOPS</li>
</ul>
<p>可以看到，SSD 和 HDD 相比，顺序读写性能高，随机读写性能显著高。但实际上，这个数据有些过时了。</p>
<p>下面看一些具体的例子：</p>
<ul>
<li><a href="https://toshiba.semicon-storage.com/ap-en/storage/product/data-center-enterprise/enterprise-performance/articles/al15sebxxex.html">HDD TOSHIBA AL15SEB120N</a>: 顺序读写性能 234.0 MB/s，延迟 2.86ms</li>
<li><a href="https://www.seagate.com/www-content/datasheets/pdfs/ent-cap-3-5-hdd-10tb-channelDS1863-5C-1608US-en_US.pdf">HDD SEAGATE ST10000NM0096</a>: 顺序读写性能 254 MB/s，随机读 170 IOPS，随机写 370 IOPS，延迟 4.16ms</li>
<li><a href="https://documents.westerndigital.com/content/dam/doc-library/en_us/assets/public/western-digital/product/data-center-drives/ultrastar-ssd-sas-series/data-sheet-ultrastar-dc-ss200.pdf">SSD Ultrastar DC SS200</a>: 顺序读 1,800 MB/s，顺序写 1,000 MB/s，随机读 250,000 IOPS，随机写 86,000 IOPS，延迟 100us</li>
<li><a href="https://apac.kioxia.com/en-apac/personal/ssd/exceria-pro.html">SSD KIOXIA EXCERIA PRO NVMe SSD</a>: 顺序读 7,300 MB/s，顺序写 6,400 MB/s，随机读 800,000 IOPS，随机写 1,300,000 IOPS</li>
<li><a href="https://semiconductor.samsung.com/cn/ssd/pc-ssd/pm9a1/">SSD SAMSUNG PM9A1</a>: 顺序读 7,000 MB/s，顺序写 5,200 MB/s，随机读 1,000,000 IOPS，随机写 850,000 IOPS</li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-03-18 00:00:00+00:00">2021年3月18日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="linksys-e8450-openwrt-配置-w-80211ax"><a class="toclink" href="../../../../hardware/2021/03/18/linksys-e8450-openwrt/">Linksys E8450 OpenWRT 配置 w/ 802.11ax</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/03/18/linksys-e8450-openwrt/#背景">背景</a></h3>
<p>之前用的 newifi 路由器（Lenovo y1s）无线网总是出问题，于是换了一个新的支持 802.11ax 的路由器 Linksys E8450，目前在 openwrt snapshot 支持。Openwrt 的支持页面：<a href="https://openwrt.org/toh/linksys/linksys_e8450">Linksys E8450</a>。</p>
<h3 id="过程"><a class="toclink" href="../../../../hardware/2021/03/18/linksys-e8450-openwrt/#过程">过程</a></h3>
<p>按照支持页面，下载固件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>$<span class="w"> </span>wget<span class="w"> </span>https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin
</span></code></pre></div>
<p>更新（2023-02-27）：固件已经从 snapshot 进入正式版，下载链接为 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin</a>。如果已经替换为 UBI，则使用 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb</a> 固件。</p>
<p>然后访问固件升级页面：http://192.168.1.1/config-admin-firmware.html#firmware，选择下载的 bin 文件。点击“开始升级”，然后等待。一段时间后，ssh 到路由器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>root@192.168.1.1
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>The<span class="w"> </span>authenticity<span class="w"> </span>of<span class="w"> </span>host<span class="w"> </span><span class="s1">'192.168.1.1 (192.168.1.1)'</span><span class="w"> </span>can<span class="s1">'t be established.</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="s1">ED25519 key fingerprint is SHA256:REDACTED.</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="s1">No matching host key fingerprint found in DNS.</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="s1">This key is not known by any other names</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="s1">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="s1">Warning: Permanently added '</span><span class="m">192</span>.168.1.1<span class="err">'</span><span class="w"> </span><span class="o">(</span>ED25519<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>known<span class="w"> </span>hosts.
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>BusyBox<span class="w"> </span>v1.33.0<span class="w"> </span><span class="o">()</span><span class="w"> </span>built-in<span class="w"> </span>shell<span class="w"> </span><span class="o">(</span>ash<span class="o">)</span>
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>
</span><span id="__span-9-12"><a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">  </span>_______<span class="w">                     </span>________<span class="w">        </span>__
</span><span id="__span-9-13"><a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>.-----.-----.-----.<span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span>.----.<span class="p">|</span><span class="w">  </span><span class="p">|</span>_
</span><span id="__span-9-14"><a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w"> </span><span class="p">|</span><span class="w">   </span>-<span class="w">   </span><span class="o">||</span><span class="w">  </span>_<span class="w">  </span><span class="p">|</span><span class="w">  </span>-__<span class="p">|</span><span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="o">||</span><span class="w">   </span>_<span class="o">||</span><span class="w">   </span>_<span class="p">|</span>
</span><span id="__span-9-15"><a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w"> </span><span class="p">|</span>_______<span class="o">||</span><span class="w">   </span>__<span class="p">|</span>_____<span class="p">|</span>__<span class="p">|</span>__<span class="o">||</span>________<span class="o">||</span>__<span class="p">|</span><span class="w">  </span><span class="p">|</span>____<span class="p">|</span>
</span><span id="__span-9-16"><a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">          </span><span class="p">|</span>__<span class="p">|</span><span class="w"> </span>W<span class="w"> </span>I<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>L<span class="w"> </span>E<span class="w"> </span>S<span class="w"> </span>S<span class="w">   </span>F<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>E<span class="w"> </span>D<span class="w"> </span>O<span class="w"> </span>M
</span><span id="__span-9-17"><a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-9-18"><a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w"> </span>OpenWrt<span class="w"> </span>SNAPSHOT,<span class="w"> </span>r16242-41af8735d4
</span><span id="__span-9-19"><a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-9-20"><a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="o">===</span><span class="w"> </span>WARNING!<span class="w"> </span><span class="o">=====================================</span>
</span><span id="__span-9-21"><a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a>There<span class="w"> </span>is<span class="w"> </span>no<span class="w"> </span>root<span class="w"> </span>password<span class="w"> </span>defined<span class="w"> </span>on<span class="w"> </span>this<span class="w"> </span>device!
</span><span id="__span-9-22"><a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a>Use<span class="w"> </span>the<span class="w"> </span><span class="s2">"passwd"</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>to<span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>password
</span><span id="__span-9-23"><a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="k">in</span><span class="w"> </span>order<span class="w"> </span>to<span class="w"> </span>prevent<span class="w"> </span>unauthorized<span class="w"> </span>SSH<span class="w"> </span>logins.
</span><span id="__span-9-24"><a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a>--------------------------------------------------
</span><span id="__span-9-25"><a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a>root@OpenWrt:~#<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-9-26"><a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a>Linux<span class="w"> </span>OpenWrt<span class="w"> </span><span class="m">5</span>.10.23<span class="w"> </span><span class="c1">#0 SMP Wed Mar 17 19:55:38 2021 aarch64 GNU/Linux</span>
</span></code></pre></div>
<p>配置 luci:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>$<span class="w"> </span>opkg<span class="w"> </span>update
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>$<span class="w"> </span>opkg<span class="w"> </span>install<span class="w"> </span>luci
</span></code></pre></div>
<p>然后就可以网页访问看到 luci 了：Powered by LuCI Master (git-21.060.51374-cd06e70) / OpenWrt SNAPSHOT r16242-41af8735d4。</p>
<p>由于目前 luci 不支持 802.11ax 的配置，可以直接修改 uci 配置来达到效果：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span>show<span class="w"> </span>wireless
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wireless.radio1.htmode<span class="o">=</span><span class="s1">'HE80'</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>root@OpenWrt:/#<span class="w"> </span>/etc/init.d/network<span class="w"> </span>restart
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="s1">'radio0'</span><span class="w"> </span>is<span class="w"> </span>disabled
</span></code></pre></div>
<p>注：实际上设置为 HE 开头的字符串即可，见 <a href="https://github.com/openwrt/openwrt/blob/8019c54d8a191cfb90c3bf06ff367f601f872fd1/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh#L334">mac80211.sh</a>。</p>
<p>再连接上 Wi-Fi 的时候就可以看到是 802.11ax 模式了。也在 <a href="https://forum.openwrt.org/t/got-802-11ax-working-in-linksys-e8450/91533">OpenWRT 论坛</a> 上分享了一下这个方案。</p>
<p>更新（2021-07-31）：目前最新的 luci 版本已经可以在网页上配置 802.11ax 模式了。</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-03-08 00:00:00+00:00">2021年3月8日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="pcb-笔记"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/">PCB 笔记</a></h2>
<p>记录一下在学习画板子过程中学到的心得。</p>
<h3 id="工具"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#工具">工具</a></h3>
<p>目前使用过 <a href="https://kicad.org/">KiCad</a> 和 <a href="https://lceda.cn/">lceda</a>：</p>
<ul>
<li>KiCad: 开源软件，跨平台。</li>
<li>lceda：在线编辑，不需要安装，和 lcsc 有深度集成。</li>
</ul>
<p>项目 <a href="https://github.com/jiegec/HT42B534USB2UART">jiegec/HT42B534USB2UART</a> 采用的是 KiCad 5 编写的。目前正在做的另一个项目采用 lceda</p>
<h3 id="流程"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#流程">流程</a></h3>
<ol>
<li>选择所需要使用的芯片，查找芯片的 datasheet。</li>
<li>寻找采用了芯片的一些设计，特别是看 schematic。</li>
<li>按照 datasheet 里面推荐的电路，或者是其他人的设计，画自己需要的 schematic。</li>
<li>设置好各个元件的 footprint，然后转到 PCB 设计。</li>
<li>在 PCB 里面布线，生成 Gerber 等文件。</li>
<li>把 Gerber 给到生产商（比如 jlc），交付生产。</li>
<li>如果是自己焊接，则需要购买元件，比如从 lcsc 购买。</li>
<li>收到 PCB 和元件后，自己按照 BOM 和 schematic 焊接各个元件。</li>
</ol>
<h3 id="笔记"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#笔记">笔记</a></h3>
<ol>
<li>对于一些连接很多元件的信号，比如 GND，可以留作铺铜解决。也就是说，先不管 GND，把其他所有的信号都接好以后，再在顶层铺铜；如果还是有没有连接上的 GND，可以通过过孔（Via）走到底层，在底层再铺一层铜。</li>
<li>对于外部供电的 VCC 和 GND，在 KiCad 中需要用 PWR_FLAG 标记一下。</li>
<li>在 KiCad 中设计 PCB 前，要把生产商的工艺参数设置好，不然画了也要重画。</li>
<li>lceda 在选择元件的时候，可以直接从 lcsc 里选择，这样可以保证封装和商品可以对得上，不需要手动进行匹配。</li>
<li>如果要用 jlc 的 SMT 贴片，先在 <a href="https://www.jlc.com/portal/smtComponentList.html">SMT 元件列表</a> 里搜索所需要的元件；推荐用基本库，如果用其他库，则要加钱；选好元件以后，用元件编号去 lceda 里搜索并添加到 schematic。</li>
<li>对于涉及模拟信号的设计，比如音频，需要特别注意模拟信号的电和地都是单独的：<code>AVCC</code> 和 <code>AGND</code>。所以要特别注意 datasheet 里面不同的地的表示方法。最后，再用磁珠把 <code>VCC</code> 和 <code>AVCC</code>、<code>GND</code> 和 <code>AGND</code> 分别连接起来就可以了。可以参考 <a href="https://wiki.bu.ost.ch/infoportal/_media/fpga/cyclone_iv/de2_115_schematic.pdf">DE2 板子中第 19 页的音频部分设计</a> 和 <a href="https://www.analog.com/en/analog-dialogue/articles/staying-well-grounded.html">Staying well grounded</a>。</li>
<li>在 schematic 里经常会出现在电源附近的电容，那么，在 PCB 中，也尽量把这些电容放在对应的电源的旁边。</li>
<li>耳机插座里面，一般分三种组成部件：Tip，Ring，Sleeve。只有两段的是 TS，三段的是 TRS，四段的是 TRRS。TS 是单声道，T 是声音，S 是地。TRS 是双声道，T 是左声道（或者单声道），R 是右声道，S 是地。TRRS 则是双声道加录音。一般来说，LINE IN 是双声道，MIC IN 是单声道，它们的阻抗也不同；LINE OUT 和 HEADPHONE OUT 都是双声道，但 HEADPHONE OUT 经过了额外的放大器。</li>
<li>遇到一个 SPI 协议没有 <code>SPI_MISO</code> 引脚的芯片，可能说明它是 write-only 的。</li>
<li>手焊的基本元件，一般用 0603 加一些 Padding 的封装；SMT 的话，则建议用 0402 封装。</li>
<li>I2C 的信号线一般需要加一个几 K 欧姆的上拉电阻到 VCC。</li>
</ol>
<p>JLC SMT 的基础库不需要换料费，如何寻找<a href="https://www.jlcsmt.com/lcsc/basic">基础库</a>中的元件：</p>
<ol>
<li>电阻品牌是 UNI-ROYAL，型号命名规则是：<ol>
<li>封装：0603/0402</li>
<li>功率：WA/WG/W8</li>
<li>误差：F(1%)</li>
<li>阻值：三位整数 + 一位 exp（J 表示 -1，K 表示 -2，L 表示 -3），例如 2002 表示 <code>200*10^2=20k</code>，1003 表示 <code>100*10^3=100k</code>，3300 表示 <code>330*10^0=330</code>，330J 表示 <code>330*10^-1=33</code>，330K 表示 <code>330*10^-2=3.3</code>
例子：要找 0402 封装的 10k 欧电阻，搜索 0402WGF1003；要找 0603 封装的 33 欧电阻，搜索 0603WAF330。</li>
</ol>
</li>
<li>电容品牌有风华/三星/国巨，三星的电容型号命名规则是：<ol>
<li>封装：05(0402)/10(0603)</li>
<li>字母：A/B/C</li>
<li>电容：两位整数 + 一位 exp，单位是 pF，例如 105 表示 <code>10*10^5pF=10^6pF=1uF</code>，104 表示 <code>10*10^4pF=10^5pF=0.1uF</code>
例子：要找 0402 封装的 100nF 电容，搜索 CL05B104；要找 0603 封装的 1uF 电容，搜索 CL10A105。也可以只搜电容的数字部分，可以找到更多品牌。</li>
</ol>
</li>
</ol>
<h3 id="阻抗匹配"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#阻抗匹配">阻抗匹配</a></h3>
<p>在传输线上，如果出现阻抗变化，就会导致信号出现反射，质量变差。因此，需要保证传输线的两端和传输线整个过程的阻抗一致。</p>
<p>阻抗设置为多少，一般要看协议的规定。确定好协议定义的阻抗以后，需要查看信号两端的芯片内部的阻抗，如果和协议不一致，需要额外添加电阻，并且电阻要尽量放在接近芯片的位置上。由于传输线在 PCB 上，所以和 PCB 厂商的工艺有关，需要去厂商的阻抗计算器上进行计算，例如 <a href="https://tools.jlc.com/jlcTools/index.html#/impedanceCalculatenew">jlc 阻抗计算器</a>。涉及到的参数有：</p>
<ol>
<li>板子层数：PCB 层数，最简单的正反面就是 2 层</li>
<li>成品厚度：整个 PCB 加起来的厚度，例如 1.6mm</li>
<li>内层铜厚：夹在内部的 PCB 的铜的厚度，例如 0.5 oz，就是 1.37/2=0.685 mil</li>
<li>外层铜厚：PCB 上下暴露在外面的两层的铜的厚度，常见 1 oz=1.37 mil</li>
<li>需求阻抗：协议所要求的阻抗，例如单端 50 欧姆（SDIO），差分 90 欧姆（USB）</li>
<li>阻抗模式：传输线的连接方式，见下（图源 KiCad）<ol>
<li>单端阻抗（Microstrip Line）：一根线传输信号，地线在另一个平面，图中上面的长方形就是传输线，底部就是地平面
<img alt="" src="../../../../hardware/pcb-notes-microstrip-line.png"/></li>
<li>差分阻抗（Coupled Microstrip Line）：差分线传输信号，地线在另一个平面，图中上方两个长方形就是差分传输线，底部是地平面
<img alt="" src="../../../../hardware/pcb-notes-couple-microstrip-line.png"/></li>
<li>共面单端：一根线传输信号，周围就是地平面
<img alt="" src="../../../../hardware/pcb-notes-coplanar-wave-guide.png"/>
<img alt="" src="../../../../hardware/pcb-notes-coplanar-wave-guide-ground-plane.png"/></li>
<li>共面差分：差分线传输信号，周围就是地平面</li>
</ol>
</li>
<li>阻抗层：传输线所在的层</li>
<li>参考层：地线所在的层</li>
</ol>
<p>由于双层 PCB 的两层铜之间距离比较远（例如 57.68 mil），如果采用单端阻抗，那么需要比较大的线宽，例如用 jlc 阻抗计算器，50 欧姆阻抗需要 106.68 mil 的线宽。如果采用四层 PCB，最上面两层之间距离缩小了很多（例如 7.99 mil），此时即使用单端阻抗，用 jlc 计算得出只需要 13.2 mil 的线宽。所以双层 PCB 更适合使用共面单端的方式，此时传输线和地线放在了同一个平面，距离比较小，就不需要那么大的线宽。</p>
<p>这里的单位：1 mil = 0.0254 mm，1 inch = 1000 mil = 0.0254 m，1 oz = 1.37 mil = 0.0348 mm</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-01-26 00:00:00+00:00">2021年1月26日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="skid-buffer"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/">Skid Buffer</a></h2>
<h3 id="skid-buffer_1"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#skid-buffer_1">Skid buffer</a></h3>
<p>Skid buffer 指的就是，对于 valid + ready 的握手信号，用空间（更多的逻辑）来换取时间（更好的时序）的一个硬件模块。</p>
<p>简单来说，背景就是，为了解决 valid 和 ready 信号在数据流水线上一路经过组合逻辑导致的时序问题，在中途加上一些寄存器来阻隔。当然了，代价就是延迟和面积，不过吞吐量还是需要保持的。</p>
<p>由于需求的不同，Skid buffer 也有不同的实现。目前，找到了四个实现，实现上有所不同，特性也不大一样。</p>
<h4 id="统一约定"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#统一约定">统一约定</a></h4>
<p>由于我在 SpinalHDL 语言中重新实现了下面的这些 Skid buffer，所以按照 SpinalHDL 的 Stream 定义接口：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SkidBufferCommon</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="n">gen</span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">T</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>在这里，<code>io.s</code> 表示从上游取的数据，<code>io.m</code> 表示传递给下游的数据。</p>
<p>输出信号共有：<code>io.s.ready</code>、<code>io.m.valid</code> 和 <code>io.m.payload</code>。</p>
<h4 id="zipcpu-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#zipcpu-版本">ZipCPU 版本</a></h4>
<p>第一个版本来自 ZipCPU：</p>
<p>博客地址：<a href="https://zipcpu.com/blog/2019/05/22/skidbuffer.html">Building a Skid Buffer for AXI processing</a>
代码地址：<a href="https://github.com/ZipCPU/wb2axip/blob/master/rtl/skidbuffer.v">skidbuffer.v</a></p>
<p>它有两个参数，一个表示是否有额外的输出寄存器（outputReg），一个表示是否低功耗（lowPower）。</p>
<h4 id="fpgacpu-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#fpgacpu-版本">FPGACPU 版本</a></h4>
<p>第二个版本来自 FPGACPU：</p>
<p>文章地址：<a href="http://fpgacpu.ca/fpga/Pipeline_Skid_Buffer.html">Pipeline Skid Buffer</a></p>
<h4 id="spinalhdl-s2m-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#spinalhdl-s2m-版本">SpinalHDL S2M 版本</a></h4>
<p>第三个版本来自 SpinalHDL Library 的 s2mPipe：</p>
<p>代码地址：<a href="https://github.com/SpinalHDL/SpinalHDL/blob/f9eda46bb5968659fe4e97cad8b69c8c0cb2bf89/lib/src/main/scala/spinal/lib/Stream.scala#L348">Stream.scala L348</a></p>
<h4 id="spinalhdl-m2s-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#spinalhdl-m2s-版本">SpinalHDL M2S 版本</a></h4>
<p>第四个版本来自 SpinalHDL Library 的 m2sPipe：</p>
<p>代码地址：<a href="https://github.com/SpinalHDL/SpinalHDL/blob/f9eda46bb5968659fe4e97cad8b69c8c0cb2bf89/lib/src/main/scala/spinal/lib/Stream.scala#L327">Stream.scala L327</a></p>
<h4 id="四个版本的对比"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#四个版本的对比">四个版本的对比</a></h4>
<p>在研究了代码以后，可以看到这四个版本的区别：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>ZipCPU w/ outputReg</th>
<th>ZipCPU w/o outputReg</th>
<th>FPGACPU</th>
<th>S2M</th>
<th>M2S</th>
</tr>
</thead>
<tbody>
<tr>
<td>io.s.ready</td>
<td>Reg</td>
<td>Reg</td>
<td>Reg</td>
<td>Reg</td>
<td>Comb</td>
</tr>
<tr>
<td>io.m.valid</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
</tr>
<tr>
<td>io.m.payload</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
</tr>
<tr>
<td>latency</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>buffer 数量</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>注：</p>
<ol>
<li>Reg 表示从寄存器输出，Comb 表示从组合逻辑输出</li>
<li>Latency 表示从 <code>io.s.fire</code> 到 <code>io.m.fire</code> 的延迟</li>
<li>Buffer 表示缓冲的 payload 个数</li>
<li>ZipCPU w/o outputReg 和 S2M 实现的逻辑是一样的</li>
</ol>
<h4 id="形式化验证"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#形式化验证">形式化验证</a></h4>
<p>为了确认上面这些类型的 Skid Buffer 都可以正常工作，按照 ZipCPU Skid Buffer 的文章，也照着写了几个 property：</p>
<p>1: 在 valid &amp;&amp; ~ready 的时候，valid 需要继续保持为高，并且 payload 不变：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">// When valid goes high, data is stable and valid stays high before ready</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="n">when</span><span class="p">(</span><span class="n">past</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">stream</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">outerReset</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="n">slaveAssume</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="p">);</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dataStable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">        </span><span class="n">slaveAssume</span><span class="p">(</span><span class="n">stable</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">asBits</span><span class="p">));</span>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>2: 在 reset 释放的第一个周期里，valid 不能为高：</p>
<p>参考 AXI 标准 (IHI0022E Page 38 A3.1.2) 原文：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>The earliest point after reset that a master is permitted to begin driving ARVALID, AWVALID, or WVALID HIGH is at a rising ACLK edge after ARESETn is HIGH.
</span></code></pre></div>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">// Valid is low in the first cycle after reset falls</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="n">when</span><span class="p">(</span><span class="n">pastValid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">past</span><span class="p">(</span><span class="n">outerReset</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">outerReset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="n">slaveAssume</span><span class="p">(</span><span class="o">~</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="p">);</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>3: 添加 cover property，要求 <code>io.s</code> 和 <code>io.m</code> 可以连续若干个周期 valid &amp;&amp; ready，保证吞吐率：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">cover</span><span class="p">(</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="n">pastValid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span><span class="n">pastValid</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">        </span><span class="o">~</span><span class="n">outerReset</span><span class="p">,</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">        </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">        </span><span class="n">cycles</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">fire</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="p">)</span>
</span></code></pre></div>
<p>采用 <code>yosys-smtbmc</code> 工具验证了以上四种 Skid buffer 都满足这些属性。</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-12-27 00:00:00+00:00">2020年12月27日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="以太网的物理接口"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/">以太网的物理接口</a></h2>
<p>本文的内容已经整合到<a href="/kb/networking/ethernet.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#背景">背景</a></h3>
<p>最近逐渐接触到了一些高速的以太网的接口，被一大堆的名字搞得有点懵，所以特意学习了一下并整理成这篇博客。</p>
<p>更新：经 <a href="https://github.com/z4yx">@z4yx</a> 指出，还可以看<a href="https://support.huawei.com/hedex/hdx.do?docid=EDOC1100156553&amp;id=ZH-CN_TOPIC_0250303640&amp;lang=zh">华为的介绍文档</a></p>
<h3 id="几几-base-杠什么是什么意思"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#几几-base-杠什么是什么意思">几几 BASE 杠什么是什么意思</a></h3>
<p>在下文里，经常可以看到类似 100BASE-TX 这种写法，它表示的意思是：</p>
<ol>
<li>BASE 前面的数字表示速率，比如 10，100，1000，10G 等等</li>
<li>BASE 之后的第一个字母，常见的 T 表示双绞线，S 表示 850nm 光纤，L 表示 1310nm 光纤，C 表示同轴电缆</li>
<li>之后可能还有别的字母，比如 X 表示 8b/10b 或者 4b/5b（FE）的编码，R 表示 64b/66b 的编码</li>
<li>之后可能还有别的数字，如果是 LAN PHY 表示的是所使用的 lane 数量；如果是 WAN PHY 表示的是传输的公里数</li>
</ol>
<p>详见 <a href="https://en.wikipedia.org/wiki/Ethernet_physical_layer#Naming_conventions">Wikipedia - Ethernet Physical Layer # Naming Conventions</a> 和 IEEE 802.3 1.2.3 节 Physical Layer and media notation：</p>
<div class="language-text highlight"><pre><span></span><code>The data rate, if only a number, is in Mb/s, and if suffixed by a “G”, is in
Gb/s. The modulation type (e.g., BASE) indicates how encoded data is
transmitted on the medium. The additional distinction may identify
characteristics of transmission or medium and, in some cases, the type of PCS
encoding used (examples of additional distinctions are “T” for twisted pair,
“B” for bidirectional optics, and “X” for a block PCS coding used for that
speed of operation). Expansions for defined Physical Layer types are included
in 1.4.
</code></pre></div>
<p>和 IEEE 802.3 1.4 节 Definitions 中的几个例子：</p>
<ul>
<li>100BASE-T: IEEE 802.3 Physical Layer specification for a 100 Mb/s CSMA/CD local area network. (See IEEE Std 802.3, Clause 22 and Clause 28.)</li>
<li>100BASE-TX: IEEE 802.3 Physical Layer specification for a 100 Mb/s CSMA/CD local area network over two pairs of Category 5 twisted-pair cabling. (See IEEE Std 802.3, Clause 24 and Clause 25.)</li>
<li>1000BASE-T: IEEE 802.3 Physical Layer specification for a 1000 Mb/s CSMA/CD LAN using four pairs of Category 5 balanced copper cabling. (See IEEE Std 802.3, Clause 40.)</li>
<li>1000BASE-X: IEEE 802.3 Physical Layer specification for a 1000 Mb/s CSMA/CD LAN that uses a Physical Layer derived from ANSI X3.230-1994 (FC-PH) [B21]23. (See IEEE Std 802.3, Clause 36.)</li>
<li>2.5GBASE-T: IEEE 802.3 Physical Layer specification for a 2.5 Gb/s LAN using four pairs of Category 5e/Class D balanced copper cabling. (See IEEE Std 802.3, Clause 126.)</li>
<li>5GBASE-T: IEEE 802.3 Physical Layer specification for a 5 Gb/s LAN using four pairs of Category 5e/Class D balanced copper cabling. (See IEEE Std 802.3, Clause 126.)</li>
<li>10GBASE-T: IEEE 802.3 Physical Layer specification for a 10 Gb/s LAN using four pairs of Class E or Class F balanced copper cabling. (See IEEE Std 802.3, Clause 55.)</li>
</ul>
<h3 id="各个速率对应的英文单词是什么"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#各个速率对应的英文单词是什么">各个速率对应的英文单词是什么</a></h3>
<ul>
<li>Fast Ethernet: 100Mbps</li>
<li>Gigabit Ethernet: 1Gbps</li>
<li>Multi Gigabit Ethernet: 2.5Gbps</li>
<li>Ten Gigabit Ethernet: 10Gbps</li>
<li>Forty Gigabit Ethernet: 40Gbps</li>
<li>Hundred Gigabit Ethernet: 100Gbps</li>
</ul>
<h3 id="常见的连接器"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#常见的连接器">常见的连接器</a></h3>
<p>连接器（connector）一般来说指的就是线缆和网络设备之间的物理接口了。常见的有：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Modular_connector#8P8C">8P8C</a>：一般我们会称之为 RJ45，关于它们俩的关系，可以看 Wikipedia 上面的说明，不过在日常生活中，这两个混用其实也没有什么大问题</li>
<li><a href="https://en.wikipedia.org/wiki/Optical_fiber_connector#LC">LC</a>：一种光纤的接口，有两个突出来的插到 SFP 光模块中的突起，比较常见</li>
<li><a href="https://en.wikipedia.org/wiki/Twinaxial_cabling#SFP+_Direct-Attach_Copper_(10GSFP+Cu)">SFP+ DAC</a>：一般是 DAC（Direct Attatched Cable）线，线的两端直接就是 SFP+ 的接口，直接插到 SFP+ 笼子中，不需要光模块；更高速率的也有 DAC 线</li>
</ul>
<p>对于光纤的接口，注意购买的时候要和光模块对应，不然可能插不进去。常见的有 LC-LC，SC-LC，SC-SC 等等，表示线的两端分别是什么接口。</p>
<h3 id="mdi-和-mdi-x"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#mdi-和-mdi-x">MDI 和 MDI-X</a></h3>
<p>这其实就是大家常见的 RJ45 里面 8 根线对应的信号，在十兆和百兆的时候，需要区分 MDI 和 MDI-X，在同种类型的端口之间用交叉线，在不同类型的端口之间用直通线。在后来，有了 Auto MDI-X，也就是会按照实际情况自动检测并且匹配。从千兆开始，设备都支持 Auto MDI-X 了，所以线本身是交叉还是直通就无所谓了。</p>
<h3 id="各种-sfp"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#各种-sfp">各种 SFP</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Small_form-factor_pluggable_transceiver">SFP</a> 是很常见的，特别是在高速的网络之中。而它又分为几种，对应不同的速率：</p>
<ul>
<li>SFP: 1Gbps/100Mbps</li>
<li>SFP+: 10Gbps</li>
<li>SFP28: 25Gbps</li>
<li>SFP56: 50Gbps</li>
<li>QSFP: 4Gbps</li>
<li>QSFP+: 40Gbps</li>
<li>QSFP28: 100Gbps/50Gbps</li>
<li>QSFP56: 200Gbps</li>
<li>QSFP-DD: 400Gbps/200Gbps</li>
<li>QSFP-DD112: 800Gbps</li>
<li>OSFP: 800Gbps/400Gbps</li>
</ul>
<p>可以看到，名字前面加了个 Q（Quad），速率就翻了 4 倍，因为有 4 个 lane，同时物理接口的尺寸也变大了。所以，不带 Q 的 SFP 的物理尺寸都一样，带 Q 的 SFP 物理尺寸都一样大，但后者比前者大一些（SFP 是 113.9 mm^2，QSFP 是 156 mm^2）。OSFP 又比 QSFP 更大一些，O 表示 Octal，就是 8 个 lane 的意思。</p>
<p>可以在 <a href="https://community.fs.com/blog/400g-qsfp-dd-transceiver-types-overview.html">400G QSFP Transceiver Types and Fiber Connections</a> 和 <a href="https://community.fs.com/blog/400g-osfp-transceiver-types-overview.html">400G OSFP Transceiver Types Overview</a> 看到 QSFP-DD 和 OSFP 的对比。</p>
<p>通常，网络设备也会支持把一个 QSFP 接口拆成多个 SFP 接口来使用，比如有的线，一边是 QSFP28，另一边是 4xSFP28，只要设备支持即可，目的是节省空间。</p>
<p><a href="https://members.snia.org/document/dl/26184">SFP 标准 SFF INF-8074</a> 规定了 <a href="https://en.wikipedia.org/wiki/Small_form-factor_pluggable_transceiver#Signals">20 根信号线</a>，正反面各 10 根，重要的是下面的这些（括号里写得是 Pin 的编号）：</p>
<ol>
<li>Mod_ABS（6）：模块是否插入</li>
<li>RD+（13）、RD-（12）：接收数据的差分对</li>
<li>TD+（18）、TD-（19）：传输数据的差分对</li>
<li>SDA（4）、SCL（5）：模块的 I2C</li>
<li>Tx_Fault（2）、Tx_Disable（3）、Rx_LOS（8）：一些状态信号</li>
</ol>
<p>可以看到，收和发各有一个差分对共 4 条数据线。相对应的，QSFP 收和发各有四对差分对共 16 条数据线，一共 38 根线。并且有一些信号是复用了同样的 pin，这样的设计可以节省一些 pin，是很常见的。</p>
<h3 id="mii"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#mii">MII</a></h3>
<p>有时候，还会遇到各种 <a href="https://en.wikipedia.org/wiki/Media-independent_interface">MII</a> 接口，也就是 MAC 和 PHY 之间的接口。有时候，还会伴随着 MDIO 接口，来进行控制信息的传输。它又分不同的类型：</p>
<ul>
<li>Standard MII：速率是 100Mbps（25MHz*4）或者 10Mbps（2.5Mhz*4），TX 7 根线（4 DATA+CLK+EN+ER），RX 7+2 根线（4 DATA+CLK+DV+ER+CRS+COL），加上 MDIO 2 根线共 18 根线</li>
<li>RMII：速率是 100Mbps 或者 10Mbps，频率都是 50MHz，一共 10 根线（4 DATA+CLK+TX_EN+CRS_DV+RX_ER+MDIO+MDC），数据线是 TX 和 RX 各 2 根</li>
<li>GMII：速率是 1000Mbps（125MHz*8），数据线是 TX 和 RX 各 8 根；也支持速率 100Mbps（25MHz）和 10Mbps（2.5MHz）</li>
<li>RGMII：速率是 1000Mbps（125MHz*4*2，DDR），数据线是 TX 和 RX 各 4 根；也支持速率 100Mbps（25MHz*4）和 10Mbps（2.5MHz*4），一共是 5+5+2 根线</li>
<li>SGMII：速率是 1000Mbps（625MHz*2*8/10），采用 625MHz DDR 差分对 SerDes，采用 8b/10b 的编码</li>
<li>XGMII：支持 2500Mbps/5000Mbps/10000Mbps（156.25 MHz*32*2，DDR）速率，数据线是 TX 和 RX 各 32 根</li>
</ul>
<p>有的时候，MAC 和 PHY 是独立的，比如很多常见的 FPGA 开发板，在使用千兆网的时候，在板子上是 PHY 芯片，从 FPGA 到 PHY 通过 RGMII 连接，然后 PHY 再连接到 8P8C（RJ45）的连接器上。一般还会把 MDIO 也接到 FPGA 上面。如果有多个 PHY，就会吧 MDIO 通过总线的方式合并起来，给每个 PHY 配置不同的地址（一般是在指定的 PIN 上设置上拉/下拉电阻实现），就可以保证不冲突的访问。</p>
<p>扩展阅读：<a href="https://ww1.microchip.com/downloads/en/DeviceDoc/00002117F.pdf">KXZ9031RNX Datasheet</a></p>
<h3 id="sgmii"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#sgmii">SGMII</a></h3>
<p>上面比较常见的是 GMII/RGMII/SGMII。其中比较特殊的是 <a href="https://archive.org/details/sgmii/mode/2up">SGMII</a>，首先可以发现它信号很少，只有两对差分线 TX_P TX_N RX_P RX_N，其中时钟是可选的，因为可以从数据中恢复。你可能感到很奇怪，那么其他的信号，比如 DV/ER/CRS 等都去哪里了呢？其实是因为，SGMII 采用了 <a href="https://zh.wikipedia.org/wiki/8b/10b">8b/10b</a> 的编码的同时，把这些控制信号通过一定的方式顺便编码进去了。具体来说，就是从 8 位的数据信号编码为 10 位的时候，有一些特殊的 10 位符号是没有对应 8 位的数据的，因此可以用这些特殊符号来表示一些信号，比如用 SPD（Start_of_Packet Delimiter，对应 /S/）和 EPD（End_of_Packet Delimiter，对应 /T/R/ 等）表示传输数据的开始和结尾，对应 TX_EN/RX_DV 信号；用 Error_Propagation（/V/）表示错误，对应 RX_ER 信号等等。所以，SGMII 其实还是一个 GMII 的变种，只不过采用 SerDes 的方式减少了引脚，MAC 内部或者 PHY 内部也是经过一个 GMII-SGMII 的转换，而其余部分是一样的。</p>
<p>关于 8b/10b 的编码方式，可以阅读 IEEE 802.3 标准中的 <code>Table 36–1a—Valid data code-groups</code>，里面提到了两类的 Code Group：D 打头的，表示数据，有 256 种，从 8b 映射到 10b 的表达方式，并且为了保持直流平衡，有一种到两种表示方法。此外还有 12 个特殊的 Code Group：K 打头，它们的 10b 表达方式不会和数据冲突。表 <code>Table 36–3—Defined ordered sets</code> 中定义了 K 打头的 Code Group 含义：</p>
<ul>
<li>/C/ Configuration:</li>
<li>/C1/ Configuration 1: /K28.5/D21.5/Config_Reg</li>
<li>/C2/ Configuration 2: /K28.5/D2.2/Config_Reg</li>
<li>/I/ IDLE:</li>
<li>/I1/ IDLE 1: /K28.5/D5.6/</li>
<li>/I2/ IDLE 2: /K28.5/D16.2/</li>
<li>Encapsulation:</li>
<li>/R/ Carrier_Extend: /K23.7/</li>
<li>/S/ Start_of_Packet: /K27.7/</li>
<li>/T/ End_of_Packet: /K29.7/</li>
<li>/V/ Error_Propagation: /K30.7/</li>
<li>/LI/ LPI (Low Power Idle):</li>
<li>/LI1/ LPI 1: /K28.5/D6.5/</li>
<li>/LI2/ LPI 2: /K28.5/D26.4/</li>
</ul>
<p>IEEE 802.3 Figure 36-4 中给了一个例子，就是在发送一段数据的时候，首先是 /I/，然后 /S/，接着一系列的 /D/，最后结束的时候 /T/R/I/。</p>
<p>扩展阅读：</p>
<ul>
<li><a href="https://www.intel.com/content/www/us/en/programmable/solutions/technology/transceiver/protocols/pro-sgmii.html">Serial Gigabit Media Independent Interface</a></li>
<li><a href="https://www.xilinx.com/support/documentation/ip_documentation/gig_ethernet_pcs_pma/v16_0/pg047-gig-eth-pcs-pma.pdf">1G/2.5G Ethernet PCS/PMA or SGMII v16.0</a></li>
<li><a href="https://en.wikipedia.org/wiki/Physical_coding_sublayer">https://en.wikipedia.org/wiki/Physical_coding_sublayer</a></li>
</ul>
<h3 id="1000base-x-与-sfp-的关系"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#1000base-x-与-sfp-的关系">1000BASE-X 与 SFP 的关系</a></h3>
<p>1000BASE-X 在 802.3 Clause 36 中定义，它的层级是这样的：</p>
<p><img alt="" src="../../../../hardware/1000basex.png"/></p>
<p>它支持三种不同的介质，对应了三个 PMD 层，也就是 LX、SX 和 CX。这些体现在设备上，其实就是不同的 SFP 模块。SFP 模块实际上就是图中的 PMD 层，SFP 接口上连接的是 1000BASE-X 的 PCS/PMA，这也就是为什么说在带有 SFP 的 FPGA 上，Xilinx 的 IP 叫做 1G/2.5G Ethernet PCS/PMA。在这里，PCS 和 PMA 层在 FPGA 内部通过 IP 实现，通过 PCB 连接到 SFP 上，光模块就是 PMD 层。见下图：</p>
<p><img alt="" src="../../../../hardware/xilinx_pcs_pma.png"/></p>
<p>左边通过 GMII 连接到内部的 MAC，右边连接到 SFP 上，通过光模块，连接到光纤。这里光模块只需要负责光电转换。另一种比较常见的形式，就是 MAC 在 FPGA 内部，PHY（包括 PCS/PMA/PMD）都在 FPGA 外部，此时 FPGA IO 上就是各种 MII。</p>
<p>那么 SFP 电口模块是怎么工作的呢？我们知道，电口采用的是 1000BASE-T 标准。实际上，它里面有一个 PHY 芯片，发送的时候，首先解码 1000BASE-X 变回原始数据，再按照 1000BASE-T 的方式编码再发出去；接收的时候，按照 1000BASE-T 进行解码，再重新编码为 1000BASE-X 发送给 PMA 层。</p>
<p>还有一类电口模块，与上面不同的地方在于，SFP 上走的是 SGMII，而不是 1000BASE-X。这两种模式没有太大的区别，都是两对差分线，一收一发，所以很多时候二者是同时支持，可以切换的。例如 <a href="https://www.fs.com/products/177936.html?attribute=44906&amp;id=1109184">Cisco Compatible 10/100/1000BASE-T SFP SGMII Copper RJ-45 100m Industrial Transceiver Module (LOS)</a> 就是在 SFP 上走 SGMII 协议。</p>
<p>推荐阅读 <a href="https://ww1.microchip.com/downloads/en/Appnotes/VPPD-01080.pdf">Designing a Copper SFP using the VSC8221 10/100/1000BASE-T PHY</a>，它里面讲了如何将 VSC8221 芯片用于电口模块：VSC8221 芯片一头是 1000BASEX（又称 802.3z SerDes，802.3z 就是 1000BASE-X）或者 SGMII，另一头是 1000BASE-T MDI。</p>
<h3 id="物理层"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#物理层">物理层</a></h3>
<h4 id="100base-tx"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#100base-tx">100BASE-TX</a></h4>
<p>在 IEEE 802.3 的 Clause 24 和 25 中定义。</p>
<p>100BASE-TX 的物理层分为 PCS，PMA，PMD。与 MAC 的连接是 MII 接口，MII 频率是 25MHz，每周期传输 4 bit 的数据。然后 PCS 负责把 4 bit 的数据通过 4B/5B 转换为 5 bit 的 code group；PMA 使用 NRZI 进行编码；PMD 层借用了 FDDI 协议的 PMD 层，只使用 MDI 的 1-3 和 6 四根线传输，两对差分对，一收一发。</p>
<h4 id="1000base-t"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#1000base-t">1000BASE-T</a></h4>
<p>在 IEEE 802.3ab-1999 中定义，具体位置是 Clause 40。</p>
<p><img alt="" src="../../../../hardware/1000baset.png"/></p>
<p>物理层往上通过 GMII 连接 MAC，往下通过 MDI 连接其他网络设备。物理层又包括 PCS 和 PMA。</p>
<p>1000BASE-T 使用四对差分线，每对差分线上都是全双工传输，波特率 125Mbaud，symbol 的范围是 <code>{2, 1, 0, -1, -2}</code>，通过 PAM5 传输。</p>
<p>具体来讲，PCS 从 MAC 的 GMII 接口接收要发送的数据，GMII 是 125MHz，每个周期 8 位数据。这些数据与 scrambler 一起，生成 9 位的 <code>Sd_n[8:0]</code>，然后再编码为 <code>(TA_n, TB_n, TC_n, TD_n)</code>，也就是在四对差分线上传输的 symbol，取值范围是 <code>[-2, 2]</code>。简单总结一下，就是每个周期 8 位数据，先变成 9 位数据，再变成 4 个 symbol，每个 symbol 取值范围是 -2 到 2，这就叫做 8B1Q4，<code>converting GMII data (8B-8 bits) to four quinary symbols (Q4) that are transmitted during one clock (1Q4)</code>，把 8 位的数据转换为四个 symbol，每个 symbol 有五种取值（Quinary 表示 5）。</p>
<h3 id="mdio"><a class="toclink" href="../../../../hardware/2020/12/27/ethernet-physical-interfaces/#mdio">MDIO</a></h3>
<p>MDIO 是 MAC 和 PHY 之间一个低速的通信接口，定义在 IEEE 802.3 Clause 45，可以用来配置一些寄存器。它支持读和写，多个 PHY 可以共享一个 MDIO 总线，通过 5 位的地址区分。为了让 PHY 分配到不同的地址，PHY 通常会通过某些引脚的上下拉来决定它自己的 MDIO 地址，这样可以避免冲突。以 RTL8201F 为例，它的 PHY 的 MDIO 地址配置与 LED 输出引脚是共享的，根据外部电路的上下拉不同，配置 MDIO 地址的最低两位：</p>
<p><img alt="" src="../../../../hardware/rtl8201f_phyad.png"/></p>
<p>也就是说，这款芯片的 MDIO 地址可以在二进制的 00000 到 00011 之间取。但不建议用 00000 地址，这是因为一些芯片会把 00000 重定义为广播，此时总线上的所有 PHY 芯片都要响应目标地址为自己的地址（非 00000）或者 00000 地址的请求（见 <a href="https://docs.amd.com/r/en-US/pg047-gig-eth-pcs-pma/MDIO-Addressing">MDIO Addressing</a>）。RTL8211 在它的文档里描述了这个行为：</p>
<p><img alt="" src="../../../../hardware/rtl8211_phyad_0.png"/></p>
<p>这样的好处是可以同时往多个 PHY 芯片写入寄存器，但如果要从 00000 地址读寄存器的话，一旦多个 PHY 同时响应，MDIO 总线上就会出现冲突。不过如果只有一个 PHY 芯片连接到 MDIO 总线上，那么让 MAC 通过 00000 地址访问 PHY 也是可以的。</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-11-19 00:00:00+00:00">2020年11月19日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="arm-m1-macbook-air-开箱"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/">ARM M1 MacBook Air 开箱</a></h2>
<h3 id="购买"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#购买">购买</a></h3>
<p>我是 11.12 的时候在 Apple Store 上下单的，选的是 MacBookAir，带 M1 芯片，8 核 CPU + 8 核 GPU，加了一些内存和硬盘。今天（11.19）的时候顺丰到货，比 Apple Store 上显示的预计到达时间 21-28 号要更早。另外，我也听朋友说现在一些线下的店也有货，也有朋友直接在京东上买到了 Mac mini，总之第一波 M1 的用户最近应该都可以拿到设备了。</p>
<p>现在这篇博客，就是在 ARM MBA 上编写的，使用的是 Intel 的 VSCode，毕竟 VSCode 的 ARM64 版不久后才正式发布。</p>
<h3 id="开箱"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#开箱">开箱</a></h3>
<p>从外观来看，一切都和 Intel MBA 一样，包装上也看不出区别，模具也是一样的。</p>
<p><img alt="" src="../../../../hardware/arm-m1-macbookair-1.png"/></p>
<p>进了系统才能看得出区别。预装的系统是 macOS Big Sur 11.0，之后手动更新到了目前最新的 11.0.1。</p>
<p>顺带 <a href="https://github.com/FactorialN">@FactorialN</a> 同学提醒我在这里提一句：包装里有电源适配器，不太环保。</p>
<h3 id="体验"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#体验">体验</a></h3>
<h4 id="arm64"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#arm64">ARM64</a></h4>
<p>首先自然是传统艺能，证明一下确实是 Apple Silicon：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>$<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>Darwin<span class="w"> </span>macbookair.lan<span class="w"> </span><span class="m">20</span>.1.0<span class="w"> </span>Darwin<span class="w"> </span>Kernel<span class="w"> </span>Version<span class="w"> </span><span class="m">20</span>.1.0:<span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">00</span>:07:10<span class="w"> </span>PDT<span class="w"> </span><span class="m">2020</span><span class="p">;</span><span class="w"> </span>root:xnu-7195.50.7~2/RELEASE_ARM64_T8101<span class="w"> </span>x86_64
</span></code></pre></div>
<p>啊对不起我用错了，上面是在 Rosetta 里面跑的 shell 看到的结果。实际是这样子的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>$<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>Darwin<span class="w"> </span>macbookair.lan<span class="w"> </span><span class="m">20</span>.1.0<span class="w"> </span>Darwin<span class="w"> </span>Kernel<span class="w"> </span>Version<span class="w"> </span><span class="m">20</span>.1.0:<span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">00</span>:07:10<span class="w"> </span>PDT<span class="w"> </span><span class="m">2020</span><span class="p">;</span><span class="w"> </span>root:xnu-7195.50.7~2/RELEASE_ARM64_T8101<span class="w"> </span>arm64
</span></code></pre></div>
<p>货真价实的 ARM64 内核，系统的很多 binary 也都是 Universal 的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>$<span class="w"> </span>file<span class="w"> </span>/bin/bash
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>/bin/bash:<span class="w"> </span>Mach-O<span class="w"> </span>universal<span class="w"> </span>binary<span class="w"> </span>with<span class="w"> </span><span class="m">2</span><span class="w"> </span>architectures:<span class="w"> </span><span class="o">[</span>x86_64:Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>x86_64<span class="o">]</span><span class="w"> </span><span class="o">[</span>arm64e:Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>arm64e<span class="o">]</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>/bin/bash<span class="w"> </span><span class="o">(</span><span class="k">for</span><span class="w"> </span>architecture<span class="w"> </span>x86_64<span class="o">)</span>:<span class="w">    </span>Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>x86_64
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>/bin/bash<span class="w"> </span><span class="o">(</span><span class="k">for</span><span class="w"> </span>architecture<span class="w"> </span>arm64e<span class="o">)</span>:<span class="w">    </span>Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>arm64e
</span></code></pre></div>
<h4 id="rosetta"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#rosetta">Rosetta</a></h4>
<p>接着，就是重头戏 Rosetta 了。第一次打开 Intel 的程序的时候，会弹出窗口安装 Rosetta，确定以后立马就装好了。接着常用的各种软件啥的，都没有什么问题。</p>
<p>唯一能看出区别的，就是在 Activity Monitor 可以看到架构的区别：</p>
<p><img alt="" src="../../../../hardware/arm-m1-macbookair-2.png"/></p>
<p>实际体验的时候，其实没有什么感觉。默认情况下，在 Terminal 下打开的是 ARM64 架构的，如果要切换的话，只需要：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>$<span class="w"> </span>uname<span class="w"> </span>-m
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>arm64
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>$<span class="w"> </span>arch<span class="w"> </span>-arch<span class="w"> </span>x86_64<span class="w"> </span>uname<span class="w"> </span>-m
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>x86_64
</span></code></pre></div>
<p>这样就可以了。如果开了一个 x86_64 的 shell，在 shell 里面执行的命令就都是 x86_64 架构的了。</p>
<h4 id="homebrew"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#homebrew">Homebrew</a></h4>
<p>目前，Homebrew 的支持是这样子的，Intel 的 Homebrew 工作很正常，没有遇到任何问题。。ARM 的 Homebrew 目前还在进行移植，由于官方的 build farm 还没有支持 ARM，所以各种包都需要自己编译，试了几个常用的软件都没问题。</p>
<p>目前 Homebrew 推荐的方法是，在老地方 <code>/usr/local/Homebrew</code> 下面放 Intel 的 Homebrew，在 <code>/opt/homebrew</code> 下面放 ARM 的 Homebrew。虽然还是有很多警告，但目前来看基本使用都没有什么问题。Homebrew cask 也正常，毕竟基本就是一个下载器。</p>
<p>另外，试了一下用 ARM Homebrew 从源码编译 GCC，编译中途失败了。</p>
<h4 id="其他软件"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#其他软件">其他软件</a></h4>
<p>换到 ARM 上自然会想到，之前的那些软件还能不能跑。答案是，大多都可以，只是很多还是 Intel 版走翻译而已。</p>
<p>目前已经测试过正常使用的：VSCode、Google Chrome、Alacrity、iStat Menus、Alfred、Rectangle、Typora、Microsoft Office、Karabiner Elements、Jetbrains Toolbox、WeChat、CineBench、Dozer、Squirrel、Zoom、Tencent Meeting、Seafile、Skim、Mendeley、1 Password、Wireshark、Slack、iMazing、Office for Mac。</p>
<p>这些里面已经移植到 ARM64 的有 Alfred、iStat Menus、Karabiner Elements、Rectangle、Google Chrome、Slack、Typora、iMazing、Office for Mac、Zoom、VSCode Insiders。</p>
<p>这里有一部分是已经移植到 ARM64 的，有一些也很快就会移植过来。其中 iStat Menus 的电池健康显示有点 BUG，其他没发现问题（更新：已修复）。</p>
<p>另外，大家也知道 ARM Mac 很重要的一点是可以跑 iOS Apps，我们也确实跑了一些，不过都有一些问题：</p>
<ul>
<li>Doodle Jump：跑起来很正常，就是卡关了，别问为什么，没有加速度计，再怎么晃电脑也不会动</li>
<li>Bilibili：部分内容可以加载出来，部分不可以，估计是什么组件没有配置好</li>
<li>QQ Music：可以跑起来，但是在启动之后的引导页面，期望用户点一下屏幕，但怎么用鼠标点都没反应</li>
<li>Weibo：毕竟正常，可以正常浏览啥都，就是 UI 有点错位，估计是因为显示窗口和实际都不大一样，小问题。</li>
<li>Network Tools：很正常，各种网络信息都可以正常取出来。</li>
<li>NFSee：没有 NFC 读卡功能，自然没法用。</li>
<li>彩云天气（ColorfulClouds Weather）：正常使用。</li>
</ul>
<p>其他还有很多 App 还没有测试。</p>
<h4 id="发热"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#发热">发热</a></h4>
<p>大家也知道，这款 MBA 是没有风扇的。但我实际测试的过程中发现，确实不大需要。拿 stress 跑了一段时间 CPU 满载运行，也没感觉到电脑发热，只是在更新 macOS Big Sur 11.0.1 的时候稍微热了一点点，也只是一点点，距离烫手还有很长的距离。</p>
<p>续航方面目前来看也挺好的，捣鼓了一个下午，也没耗多少电。</p>
<h4 id="性能测试"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#性能测试">性能测试</a></h4>
<p>在不同平台上进行 OpenSSL 测试：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>$<span class="w"> </span>openssl<span class="w"> </span>speed<span class="w"> </span>-evp<span class="w"> </span>aes-128-cbc<span class="w"> </span>aes-256-cbc<span class="w"> </span>des-ede3<span class="w"> </span>rsa2048<span class="w"> </span>sha256
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="c1"># M1 MacBookAir</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1j<span class="w">  </span><span class="m">16</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">2021</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>built<span class="w"> </span>on:<span class="w"> </span>Wed<span class="w"> </span>Feb<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">12</span>:34:00<span class="w"> </span><span class="m">2021</span><span class="w"> </span>UTC
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>idea<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span><span class="w"> </span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>compiler:<span class="w"> </span>clang<span class="w"> </span>-fPIC<span class="w"> </span>-arch<span class="w"> </span>arm64<span class="w"> </span>-O3<span class="w"> </span>-Wall<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-D_REENTRANT<span class="w"> </span>-DNDEBUG
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a>The<span class="w"> </span><span class="s1">'numbers'</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">30466</span>.76k<span class="w">    </span><span class="m">30644</span>.63k<span class="w">    </span><span class="m">30592</span>.26k<span class="w">    </span><span class="m">30106</span>.97k<span class="w">    </span><span class="m">29961</span>.69k<span class="w">    </span><span class="m">29951</span>.49k
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">229863</span>.42k<span class="w">   </span><span class="m">238671</span>.82k<span class="w">   </span><span class="m">232654</span>.34k<span class="w">   </span><span class="m">237194</span>.70k<span class="w">   </span><span class="m">238092</span>.29k<span class="w">   </span><span class="m">237791</span>.91k
</span><span id="__span-14-11"><a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a>aes-128-cbc<span class="w">    </span><span class="m">1020384</span>.58k<span class="w">  </span><span class="m">1427866</span>.73k<span class="w">  </span><span class="m">1521123</span>.84k<span class="w">  </span><span class="m">1558199</span>.30k<span class="w">  </span><span class="m">1569978</span>.99k<span class="w">  </span><span class="m">1566288</span>.55k
</span><span id="__span-14-12"><a href="#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a>sha256<span class="w">          </span><span class="m">378646</span>.12k<span class="w">  </span><span class="m">1140355</span>.52k<span class="w">  </span><span class="m">1894169</span>.69k<span class="w">  </span><span class="m">2287211</span>.18k<span class="w">  </span><span class="m">2445602</span>.42k<span class="w">  </span><span class="m">2453209</span>.09k
</span><span id="__span-14-13"><a href="#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-14-14"><a href="#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000561s<span class="w"> </span><span class="m">0</span>.000014s<span class="w">   </span><span class="m">1782</span>.0<span class="w">  </span><span class="m">69645</span>.9
</span><span id="__span-14-15"><a href="#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="c1"># AMD EPYC 7742</span>
</span><span id="__span-14-16"><a href="#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1d<span class="w">  </span><span class="m">10</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-14-17"><a href="#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a>built<span class="w"> </span>on:<span class="w"> </span>Mon<span class="w"> </span>Dec<span class="w">  </span><span class="m">7</span><span class="w"> </span><span class="m">20</span>:44:45<span class="w"> </span><span class="m">2020</span><span class="w"> </span>UTC
</span><span id="__span-14-18"><a href="#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>8x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-14-19"><a href="#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-CKx7Fo/openssl-1.1.1d<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAESNI_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-14-20"><a href="#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a>The<span class="w"> </span><span class="s1">'numbers'</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-14-21"><a href="#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-14-22"><a href="#__codelineno-14-22" id="__codelineno-14-22" name="__codelineno-14-22"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">28734</span>.07k<span class="w">    </span><span class="m">28942</span>.08k<span class="w">    </span><span class="m">28982</span>.78k<span class="w">    </span><span class="m">29217</span>.91k<span class="w">    </span><span class="m">29136</span>.21k<span class="w">    </span><span class="m">29103</span>.45k
</span><span id="__span-14-23"><a href="#__codelineno-14-23" id="__codelineno-14-23" name="__codelineno-14-23"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">176843</span>.84k<span class="w">   </span><span class="m">183040</span>.83k<span class="w">   </span><span class="m">183156</span>.82k<span class="w">   </span><span class="m">184132</span>.61k<span class="w">   </span><span class="m">184464</span>.73k<span class="w">   </span><span class="m">184642</span>.22k
</span><span id="__span-14-24"><a href="#__codelineno-14-24" id="__codelineno-14-24" name="__codelineno-14-24"></a>aes-128-cbc<span class="w">     </span><span class="m">602680</span>.15k<span class="w">  </span><span class="m">1178207</span>.32k<span class="w">  </span><span class="m">1239931</span>.82k<span class="w">  </span><span class="m">1251810</span>.30k<span class="w">  </span><span class="m">1258359</span>.47k<span class="w">  </span><span class="m">1261316</span>.78k
</span><span id="__span-14-25"><a href="#__codelineno-14-25" id="__codelineno-14-25" name="__codelineno-14-25"></a>sha256<span class="w">          </span><span class="m">201482</span>.20k<span class="w">   </span><span class="m">513504</span>.00k<span class="w">  </span><span class="m">1075572</span>.14k<span class="w">  </span><span class="m">1474850</span>.82k<span class="w">  </span><span class="m">1648746</span>.50k<span class="w">  </span><span class="m">1663030</span>.61k
</span><span id="__span-14-26"><a href="#__codelineno-14-26" id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-14-27"><a href="#__codelineno-14-27" id="__codelineno-14-27" name="__codelineno-14-27"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000620s<span class="w"> </span><span class="m">0</span>.000018s<span class="w">   </span><span class="m">1613</span>.7<span class="w">  </span><span class="m">54756</span>.4
</span><span id="__span-14-28"><a href="#__codelineno-14-28" id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="c1"># AMD EPYC 7282</span>
</span><span id="__span-14-29"><a href="#__codelineno-14-29" id="__codelineno-14-29" name="__codelineno-14-29"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1d<span class="w">  </span><span class="m">10</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-14-30"><a href="#__codelineno-14-30" id="__codelineno-14-30" name="__codelineno-14-30"></a>built<span class="w"> </span>on:<span class="w"> </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">20</span>:23:01<span class="w"> </span><span class="m">2020</span><span class="w"> </span>UTC
</span><span id="__span-14-31"><a href="#__codelineno-14-31" id="__codelineno-14-31" name="__codelineno-14-31"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>8x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-14-32"><a href="#__codelineno-14-32" id="__codelineno-14-32" name="__codelineno-14-32"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-8Ocme2/openssl-1.1.1d<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAESNI_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-14-33"><a href="#__codelineno-14-33" id="__codelineno-14-33" name="__codelineno-14-33"></a>The<span class="w"> </span><span class="s1">'numbers'</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-14-34"><a href="#__codelineno-14-34" id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-14-35"><a href="#__codelineno-14-35" id="__codelineno-14-35" name="__codelineno-14-35"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">27052</span>.31k<span class="w">    </span><span class="m">27392</span>.85k<span class="w">    </span><span class="m">27455</span>.57k<span class="w">    </span><span class="m">27569</span>.49k<span class="w">    </span><span class="m">27503</span>.27k<span class="w">    </span><span class="m">27514</span>.20k
</span><span id="__span-14-36"><a href="#__codelineno-14-36" id="__codelineno-14-36" name="__codelineno-14-36"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">158578</span>.10k<span class="w">   </span><span class="m">168502</span>.21k<span class="w">   </span><span class="m">172365</span>.91k<span class="w">   </span><span class="m">173904</span>.90k<span class="w">   </span><span class="m">174391</span>.30k<span class="w">   </span><span class="m">174429</span>.53k
</span><span id="__span-14-37"><a href="#__codelineno-14-37" id="__codelineno-14-37" name="__codelineno-14-37"></a>aes-128-cbc<span class="w">     </span><span class="m">594506</span>.35k<span class="w">  </span><span class="m">1111762</span>.07k<span class="w">  </span><span class="m">1169014</span>.02k<span class="w">  </span><span class="m">1184384</span>.00k<span class="w">  </span><span class="m">1192793</span>.56k<span class="w">  </span><span class="m">1189167</span>.10k
</span><span id="__span-14-38"><a href="#__codelineno-14-38" id="__codelineno-14-38" name="__codelineno-14-38"></a>sha256<span class="w">          </span><span class="m">194382</span>.61k<span class="w">   </span><span class="m">487875</span>.93k<span class="w">  </span><span class="m">1017121</span>.56k<span class="w">  </span><span class="m">1390122</span>.33k<span class="w">  </span><span class="m">1558735</span>.53k<span class="w">  </span><span class="m">1572274</span>.18k
</span><span id="__span-14-39"><a href="#__codelineno-14-39" id="__codelineno-14-39" name="__codelineno-14-39"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-14-40"><a href="#__codelineno-14-40" id="__codelineno-14-40" name="__codelineno-14-40"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000655s<span class="w"> </span><span class="m">0</span>.000019s<span class="w">   </span><span class="m">1526</span>.8<span class="w">  </span><span class="m">52089</span>.2
</span><span id="__span-14-41"><a href="#__codelineno-14-41" id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="c1"># AMD EPYC 7551</span>
</span><span id="__span-14-42"><a href="#__codelineno-14-42" id="__codelineno-14-42" name="__codelineno-14-42"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1d<span class="w">  </span><span class="m">10</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-14-43"><a href="#__codelineno-14-43" id="__codelineno-14-43" name="__codelineno-14-43"></a>built<span class="w"> </span>on:<span class="w"> </span>Tue<span class="w"> </span>Feb<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">22</span>:08:43<span class="w"> </span><span class="m">2021</span><span class="w"> </span>UTC
</span><span id="__span-14-44"><a href="#__codelineno-14-44" id="__codelineno-14-44" name="__codelineno-14-44"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>8x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-14-45"><a href="#__codelineno-14-45" id="__codelineno-14-45" name="__codelineno-14-45"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-m9Qnvk/openssl-1.1.1d<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAESNI_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-14-46"><a href="#__codelineno-14-46" id="__codelineno-14-46" name="__codelineno-14-46"></a>The<span class="w"> </span><span class="s1">'numbers'</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-14-47"><a href="#__codelineno-14-47" id="__codelineno-14-47" name="__codelineno-14-47"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-14-48"><a href="#__codelineno-14-48" id="__codelineno-14-48" name="__codelineno-14-48"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">20850</span>.88k<span class="w">    </span><span class="m">21260</span>.78k<span class="w">    </span><span class="m">21315</span>.84k<span class="w">    </span><span class="m">21368</span>.49k<span class="w">    </span><span class="m">21321</span>.05k<span class="w">    </span><span class="m">21392</span>.04k
</span><span id="__span-14-49"><a href="#__codelineno-14-49" id="__codelineno-14-49" name="__codelineno-14-49"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">122059</span>.94k<span class="w">   </span><span class="m">125701</span>.42k<span class="w">   </span><span class="m">126591</span>.06k<span class="w">   </span><span class="m">126770</span>.52k<span class="w">   </span><span class="m">127049</span>.73k<span class="w">   </span><span class="m">126937</span>.77k
</span><span id="__span-14-50"><a href="#__codelineno-14-50" id="__codelineno-14-50" name="__codelineno-14-50"></a>aes-128-cbc<span class="w">     </span><span class="m">441625</span>.34k<span class="w">   </span><span class="m">883733</span>.48k<span class="w">   </span><span class="m">928208</span>.21k<span class="w">   </span><span class="m">941480</span>.96k<span class="w">   </span><span class="m">944889</span>.86k<span class="w">   </span><span class="m">945307</span>.65k
</span><span id="__span-14-51"><a href="#__codelineno-14-51" id="__codelineno-14-51" name="__codelineno-14-51"></a>sha256<span class="w">          </span><span class="m">151161</span>.13k<span class="w">   </span><span class="m">388304</span>.60k<span class="w">   </span><span class="m">809272</span>.15k<span class="w">  </span><span class="m">1106645</span>.33k<span class="w">  </span><span class="m">1238966</span>.27k<span class="w">  </span><span class="m">1249219</span>.93k
</span><span id="__span-14-52"><a href="#__codelineno-14-52" id="__codelineno-14-52" name="__codelineno-14-52"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-14-53"><a href="#__codelineno-14-53" id="__codelineno-14-53" name="__codelineno-14-53"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.001096s<span class="w"> </span><span class="m">0</span>.000033s<span class="w">    </span><span class="m">912</span>.8<span class="w">  </span><span class="m">30284</span>.7
</span><span id="__span-14-54"><a href="#__codelineno-14-54" id="__codelineno-14-54" name="__codelineno-14-54"></a><span class="c1"># Intel Xeon E5-2699 v4 (Broadwell)</span>
</span><span id="__span-14-55"><a href="#__codelineno-14-55" id="__codelineno-14-55" name="__codelineno-14-55"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.0.2u<span class="w">  </span><span class="m">20</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-14-56"><a href="#__codelineno-14-56" id="__codelineno-14-56" name="__codelineno-14-56"></a>built<span class="w"> </span>on:<span class="w"> </span>reproducible<span class="w"> </span>build,<span class="w"> </span>date<span class="w"> </span>unspecified
</span><span id="__span-14-57"><a href="#__codelineno-14-57" id="__codelineno-14-57" name="__codelineno-14-57"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>16x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>idx,cisc,16,int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>idea<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>idx<span class="o">)</span>
</span><span id="__span-14-58"><a href="#__codelineno-14-58" id="__codelineno-14-58" name="__codelineno-14-58"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-I.<span class="w"> </span>-I..<span class="w"> </span>-I../include<span class="w">  </span>-fPIC<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_THREADS<span class="w"> </span>-D_REENTRANT<span class="w"> </span>-DDSO_DLFCN<span class="w"> </span>-DHAVE_DLFCN_H<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-m64<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-O3<span class="w"> </span>-Wall<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAES_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DBSAES_ASM<span class="w"> </span>-DWHIRLPOOL_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM
</span><span id="__span-14-59"><a href="#__codelineno-14-59" id="__codelineno-14-59" name="__codelineno-14-59"></a>The<span class="w"> </span><span class="s1">'numbers'</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-14-60"><a href="#__codelineno-14-60" id="__codelineno-14-60" name="__codelineno-14-60"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes
</span><span id="__span-14-61"><a href="#__codelineno-14-61" id="__codelineno-14-61" name="__codelineno-14-61"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">29863</span>.80k<span class="w">    </span><span class="m">30156</span>.69k<span class="w">    </span><span class="m">30243</span>.07k<span class="w">    </span><span class="m">30237</span>.70k<span class="w">    </span><span class="m">30302</span>.21k
</span><span id="__span-14-62"><a href="#__codelineno-14-62" id="__codelineno-14-62" name="__codelineno-14-62"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">103491</span>.45k<span class="w">   </span><span class="m">110240</span>.94k<span class="w">   </span><span class="m">112029</span>.95k<span class="w">   </span><span class="m">112400</span>.38k<span class="w">   </span><span class="m">112833</span>.88k
</span><span id="__span-14-63"><a href="#__codelineno-14-63" id="__codelineno-14-63" name="__codelineno-14-63"></a>aes-128-cbc<span class="w">     </span><span class="m">734225</span>.68k<span class="w">   </span><span class="m">788483</span>.88k<span class="w">   </span><span class="m">802857</span>.39k<span class="w">   </span><span class="m">805860</span>.69k<span class="w">   </span><span class="m">807848</span>.62k
</span><span id="__span-14-64"><a href="#__codelineno-14-64" id="__codelineno-14-64" name="__codelineno-14-64"></a>sha256<span class="w">           </span><span class="m">82720</span>.89k<span class="w">   </span><span class="m">184528</span>.45k<span class="w">   </span><span class="m">342888</span>.28k<span class="w">   </span><span class="m">425826</span>.30k<span class="w">   </span><span class="m">457149</span>.10k
</span><span id="__span-14-65"><a href="#__codelineno-14-65" id="__codelineno-14-65" name="__codelineno-14-65"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-14-66"><a href="#__codelineno-14-66" id="__codelineno-14-66" name="__codelineno-14-66"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000573s<span class="w"> </span><span class="m">0</span>.000017s<span class="w">   </span><span class="m">1745</span>.5<span class="w">  </span><span class="m">60236</span>.3
</span><span id="__span-14-67"><a href="#__codelineno-14-67" id="__codelineno-14-67" name="__codelineno-14-67"></a><span class="c1"># Intel Xeon E5-2680 v4 (Broadwell) TODO</span>
</span><span id="__span-14-68"><a href="#__codelineno-14-68" id="__codelineno-14-68" name="__codelineno-14-68"></a><span class="c1"># Intel Xeon Gold 5218 (Cascade Lake) TODO</span>
</span><span id="__span-14-69"><a href="#__codelineno-14-69" id="__codelineno-14-69" name="__codelineno-14-69"></a><span class="c1"># IBM POWER8NVL</span>
</span><span id="__span-14-70"><a href="#__codelineno-14-70" id="__codelineno-14-70" name="__codelineno-14-70"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1<span class="w">  </span><span class="m">11</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2018</span>
</span><span id="__span-14-71"><a href="#__codelineno-14-71" id="__codelineno-14-71" name="__codelineno-14-71"></a>built<span class="w"> </span>on:<span class="w"> </span>Wed<span class="w"> </span>Feb<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">12</span>:35:54<span class="w"> </span><span class="m">2021</span><span class="w"> </span>UTC
</span><span id="__span-14-72"><a href="#__codelineno-14-72" id="__codelineno-14-72" name="__codelineno-14-72"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>char<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-14-73"><a href="#__codelineno-14-73" id="__codelineno-14-73" name="__codelineno-14-73"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O3<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-avwOZX/openssl-1.1.1<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DAES_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-14-74"><a href="#__codelineno-14-74" id="__codelineno-14-74" name="__codelineno-14-74"></a>The<span class="w"> </span><span class="s1">'numbers'</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-14-75"><a href="#__codelineno-14-75" id="__codelineno-14-75" name="__codelineno-14-75"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-14-76"><a href="#__codelineno-14-76" id="__codelineno-14-76" name="__codelineno-14-76"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">25120</span>.65k<span class="w">    </span><span class="m">25479</span>.70k<span class="w">    </span><span class="m">25570</span>.13k<span class="w">    </span><span class="m">25604</span>.10k<span class="w">    </span><span class="m">25616</span>.38k<span class="w">    </span><span class="m">25613</span>.65k
</span><span id="__span-14-77"><a href="#__codelineno-14-77" id="__codelineno-14-77" name="__codelineno-14-77"></a>aes-256<span class="w"> </span>cbc<span class="w">      </span><span class="m">79140</span>.44k<span class="w">    </span><span class="m">82350</span>.23k<span class="w">    </span><span class="m">83815</span>.94k<span class="w">    </span><span class="m">84183</span>.72k<span class="w">    </span><span class="m">84290</span>.22k<span class="w">    </span><span class="m">84306</span>.60k
</span><span id="__span-14-78"><a href="#__codelineno-14-78" id="__codelineno-14-78" name="__codelineno-14-78"></a>aes-128-cbc<span class="w">     </span><span class="m">310027</span>.28k<span class="w">   </span><span class="m">647168</span>.64k<span class="w">   </span><span class="m">890896</span>.81k<span class="w">   </span><span class="m">984001</span>.19k<span class="w">  </span><span class="m">1014827</span>.69k<span class="w">  </span><span class="m">1017096</span>.87k
</span><span id="__span-14-79"><a href="#__codelineno-14-79" id="__codelineno-14-79" name="__codelineno-14-79"></a>sha256<span class="w">           </span><span class="m">58347</span>.98k<span class="w">   </span><span class="m">151006</span>.68k<span class="w">   </span><span class="m">286465</span>.28k<span class="w">   </span><span class="m">373490</span>.69k<span class="w">   </span><span class="m">411044</span>.52k<span class="w">   </span><span class="m">414012</span>.76k
</span><span id="__span-14-80"><a href="#__codelineno-14-80" id="__codelineno-14-80" name="__codelineno-14-80"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-14-81"><a href="#__codelineno-14-81" id="__codelineno-14-81" name="__codelineno-14-81"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.001442s<span class="w"> </span><span class="m">0</span>.000040s<span class="w">    </span><span class="m">693</span>.5<span class="w">  </span><span class="m">25212</span>.7
</span></code></pre></div>
<h3 id="总结"><a class="toclink" href="../../../../hardware/2020/11/19/arm-m1-macbookair/#总结">总结</a></h3>
<p>总的来说，还是挺香的。不错的性能，没有风扇的喧闹，没有烫手的键盘。可能有少部分软件还不能正常运行，然后很多程序还需要 Rosetta 翻译，但目前来看兼容性还是挺不错的，并且这些应该明年就都适配地差不多了吧。</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-05-18 00:00:00+00:00">2020年5月18日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="fido-u2ffido2-和-ctap-的关系"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/">FIDO U2F、FIDO2 和 CTAP 的关系</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#背景">背景</a></h3>
<p>2012 年，Yubico 和 Google 设计了 U2F 协议，第二年 U2F 成为 FIDO 组织的标准，之后加入了 NFC 的支持。之后，FIDO2 作为替代 U2F 的新标准产生，原来的 U2F 以兼容的方式成为了 CTAP1，而采用 CBOR 封装格式的 CTAP(CTAP2) 则是 FIDO2 的主要协议。</p>
<h3 id="u2f"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#u2f">U2F</a></h3>
<h4 id="命令格式"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#命令格式">命令格式</a></h4>
<p>U2F 定义了它的<a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-raw-message-formats-v1.2-ps-20170411.pdf">命令格式</a>，基于 ISO7816-4 APDU（short APDU） ：</p>
<table>
<thead>
<tr>
<th>CLA</th>
<th>INS</th>
<th>P1</th>
<th>P2</th>
<th>Lc</th>
<th>data</th>
<th>Le</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>0-1 bytes</td>
<td>variable length</td>
<td>0-1 bytes</td>
</tr>
</tbody>
</table>
<p>比如 U2F_VERSION 就是：</p>
<table>
<thead>
<tr>
<th>CLA</th>
<th>INS</th>
<th>P1</th>
<th>P2</th>
<th>Lc</th>
<th>data</th>
<th>Le</th>
</tr>
</thead>
<tbody>
<tr>
<td>00</td>
<td>03</td>
<td>00</td>
<td>00</td>
<td>0</td>
<td>empty</td>
<td>00</td>
</tr>
</tbody>
</table>
<p>返回的数据就是 <code>U2F_V2</code> 的 ASCII 加上 <code>9000</code> 的状态。</p>
<p>除此之外，它还有一种 extended length 格式的 APDU，和上面的是等价的不同表示。</p>
<h4 id="传输方式"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#传输方式">传输方式</a></h4>
<p>实际使用 U2F 的时候，又有三种情况，分别是 USB、Bluetooth 和 NFC。</p>
<h5 id="usb"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#usb">USB</a></h5>
<p>在 <a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-hid-protocol-v1.2-ps-20170411.pdf">U2FHID</a> 里面，为了让 U2F 的命令通过 HID 接口传输，它规定了两个 endpoint，分别是 Interrupt IN 和 Interrupt OUT，还有一个固定的 HID Report Descriptor。为了发 U2F 命令，首先会进行一次封装：</p>
<table>
<thead>
<tr>
<th>CMD</th>
<th>BCNT</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>U2FHID_MSG</td>
<td>4..n</td>
<td>n bytes</td>
</tr>
</tbody>
</table>
<p>添加了一个头，表示载荷是一个 U2F 的 command（自然也是 APDU）。</p>
<p>在 cmd 之上，还会封装一层，为了解决 USB 的 packet size 限制等问题，定义了 init packet：</p>
<table>
<thead>
<tr>
<th>CID</th>
<th>CMD</th>
<th>BCNTH</th>
<th>BCNTL</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>4 bytes</td>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>variable length</td>
</tr>
</tbody>
</table>
<p>如果数据太长，就会拆分成一个 init 和 多个 continuation packet：</p>
<table>
<thead>
<tr>
<th>CID</th>
<th>SEQ</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>4 bytes</td>
<td>1 byte</td>
<td>variable length</td>
</tr>
</tbody>
</table>
<p>把 init 和 continuation 里面的 data 组合起来，就是 U2F 的 message，message 里面可能又有 U2F raw command，也就是 APDU。</p>
<p>发送的时候，先 Interrupt OUT 发送请求，再 Interrupt IN 读取回应。</p>
<h5 id="bluetooth"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#bluetooth">Bluetooth</a></h5>
<p>在 <a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-bt-protocol-v1.2-ps-20170411.pdf">U2F/Bluetooth</a> 里面，也用了一个类似的封装格式，请求：</p>
<table>
<thead>
<tr>
<th>CMD</th>
<th>HLEN</th>
<th>LLEN</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>variable length</td>
</tr>
</tbody>
</table>
<p>这里的 DATA payload 就是 extended length 格式的 APDU</p>
<h5 id="nfc"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#nfc">NFC</a></h5>
<p>在 <a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-nfc-protocol-v1.2-ps-20170411.pdf">U2F/NFC</a> 里面，既然 ISO 7816-4 本来就是 NFC-native 的格式，就不要额外的封装了。只需要规定一个 Applet 的 AID 即可：<code>A0000006472F0001</code></p>
<h4 id="总结"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#总结">总结</a></h4>
<p>总而言之，U2F raw commands 就是在 APDU 格式上定义了几个命令。在 USB 和 Bluetooth 上都加了几个小的 Header，而 NFC 上则是规定了一个 AID。这对应用程序来说很方便，核心的命令只有一套，需要的时候封装一下即可。</p>
<h3 id="fido2"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#fido2">FIDO2</a></h3>
<p>在之后，<a href="https://fidoalliance.org/specs/fido-v2.0-rd-20170927/fido-client-to-authenticator-protocol-v2.0-rd-20170927.html#message-encoding">FIDO2</a> 出现了，在保持 U2F 兼容的基础上添加了新的功能，并且出现了 WebAuthN 作为浏览器使用 FIDO2 的协议。U2F 就变成了第一代的 CTAP，称为 CTAP1，然后 CTAP 默认指的就是 CTAP2。</p>
<h4 id="命令格式_1"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#命令格式_1">命令格式</a></h4>
<p>FIDO2 里面，定义了一些 CTAP 命令，比如 authenticatorMakeCredential，对应 U2F 的 U2F_REGISTER 命令。然后，规定了一个 <a href="https://tools.ietf.org/html/rfc7049">CBOR</a> 的格式，来表示命令附带的数据。CBOR 是 RFC 7049，所以也是借用过来的格式。</p>
<h4 id="传输方式_1"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#传输方式_1">传输方式</a></h4>
<p>FIDO2 定义了在 USB 和 NFC 上的传输格式。</p>
<h5 id="usb_1"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#usb_1">USB</a></h5>
<p>在 USB 上传输的时候，定义了 CTAPHID 的协议，与 U2FHID 基本是一样的，规定了 init packet 和 continuation packet，packet 里面也是 CTAPHID 的消息，这部分是兼容 U2F 的。并且，额外添加了 CTAPHID_CBOR 消息：</p>
<table>
<thead>
<tr>
<th>CMD</th>
<th>BCNT</th>
<th>DATA</th>
<th>DATA + 1</th>
</tr>
</thead>
<tbody>
<tr>
<td>CTAPHID_CBOR</td>
<td>1..(n+1)</td>
<td>CTAP command</td>
<td>n bytes of CBOR data</td>
</tr>
</tbody>
</table>
<p>它的载荷就是 CBOR 格式的请求。</p>
<p>类似地，它也是通过 Interrupt OUT 发送请求，从 Interrupt IN 读取回应。</p>
<h5 id="nfc_1"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#nfc_1">NFC</a></h5>
<p>在 NFC 上传输的时候，因为内部的格式是 CBOR，不再是 APDU 了，所以需要一些封装。</p>
<p>首先，它也定义了一个 Applet ID：<code>A0000006472F0001</code>，和 U2F 一样。为了保持兼容，它都支持 U2F 定义的 APDU 命令。</p>
<p>那怎么区分设备是否支持 CTAP1/U2F 和 CTAP2 呢？使用前面提到的 U2F_VERSION 命令即可。如果得到 U2F_V2，说明是支持 CTAP1/U2F 的；如果得到是其他的，说明只支持 CTAP2，不支持 CTAP1/U2F。</p>
<p>如果要发 CTAP2 的命令，就要把 CTAP command 和 CBOR 格式的数据封装到 APDU 里面：</p>
<table>
<thead>
<tr>
<th>CLA</th>
<th>INS</th>
<th>P1</th>
<th>P2</th>
<th>Data</th>
<th>Le</th>
</tr>
</thead>
<tbody>
<tr>
<td>80</td>
<td>10</td>
<td>00</td>
<td>00</td>
<td>CTAP Command || CBOR Data</td>
<td>variable</td>
</tr>
</tbody>
</table>
<p>它规定，如果请求采用的是 extended length 的 APDU，那么响应也要是 extended length 的 APDU；如果请求是 short APDU，那么响应也要支持 short APDU 的 chaining。</p>
<h4 id="兼容性"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#兼容性">兼容性</a></h4>
<p>可以看到，CTAP2 设计的基本都考虑了兼容 U2F，允许用 U2F 的 API 操作 U2F 和 CTAP2 的设备；也允许用 CTAP2 的 API 操作 U2F（只支持部分命令）和  CTAP2 的设备。</p>
<h3 id="总结_1"><a class="toclink" href="../../../../hardware/2020/05/18/fido-u2f-fido2-ctap/#总结_1">总结</a></h3>
<p>可以看到，这里有一堆套娃的过程：</p>
<p>U2F：</p>
<table>
<thead>
<tr>
<th></th>
<th>USB HID</th>
<th>Bluetooth</th>
<th>NFC</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>APDU</td>
<td>APDU</td>
<td>APDU</td>
</tr>
<tr>
<td>3</td>
<td>U2F message</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>USB HID packet</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>USB</td>
<td>Bluetooth</td>
<td>ISO 14443-4/ISO 18092</td>
</tr>
</tbody>
</table>
<p>FIDO2:</p>
<table>
<thead>
<tr>
<th></th>
<th>USB HID</th>
<th>NFC</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>CTAP command + CBOR data</td>
<td>CTAP command + CBOR data</td>
</tr>
<tr>
<td>3</td>
<td>CTAP message</td>
<td>APDU</td>
</tr>
<tr>
<td>2</td>
<td>USB HID packet</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>USB</td>
<td>ISO 14443-4/ISO 18092</td>
</tr>
</tbody>
</table>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-05-10 00:00:00+00:00">2020年5月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="mifare-classic-上配置-ndef"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/">MIFARE Classic 上配置 NDEF</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#背景">背景</a></h3>
<p>最近买了一堆 NFC 的智能卡拿来测试，其中一张 MIFARE Classic 的总是在 iOS 上读不出来，无论是以 Tag 模式还是 NDEF 模式。于是通过一系列的研究，终于知道上怎么一回事，然后成功地把一个 MIFARE Classic 卡配置成了 NDEF。</p>
<h3 id="背景知识"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#背景知识">背景知识</a></h3>
<p>NFC 有很多协议，其中 MIFARE Classic 基于 ISO 14443-3 Type A 标准，里面有一些 MIFARE 的命令。通过这些命令，就可以控制 MIFARE Classic 卡的内容。具体来说，以我使用的 <a href="https://www.nxp.com/docs/en/data-sheet/MF1S70YYX_V1.pdf">MIFARE Classic EV1 4K S70</a> 为例，这篇文章会涉及到如下的背景知识：</p>
<h4 id="mifare-classic-内存布局"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#mifare-classic-内存布局">MIFARE Classic 内存布局</a></h4>
<p>在 MIFARE Classic 中，有 Sector 和 Block 的概念，每个 Sector 有若干个 Block，其中最后一个 Block 是特殊的（称为 Sector Trailer），保存了这个 Sector 的一些信息：Key A、Access Bits、GPB 和 Key B。对于 Classic 4K，首先是 32 个有 4 blocks 的 sector，然后是 8 个 有 16 blocks 的 sector，整体的内存布局大概是：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>Sector 0:
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>    Block 0
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>    Block 1
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>    Block 2
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>    Block 3(Sector Trailer)
</span><span id="__span-20-6"><a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>Sector 1:
</span><span id="__span-20-7"><a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a>    Block 4
</span><span id="__span-20-8"><a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a>    Block 5
</span><span id="__span-20-9"><a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a>    Block 6
</span><span id="__span-20-10"><a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a>    Block 7(Sector Trailer)
</span><span id="__span-20-11"><a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a>...
</span><span id="__span-20-12"><a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a>Sector 32:
</span><span id="__span-20-13"><a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a>    Block 128
</span><span id="__span-20-14"><a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a>    Block 129
</span><span id="__span-20-15"><a href="#__codelineno-20-15" id="__codelineno-20-15" name="__codelineno-20-15"></a>    ...
</span><span id="__span-20-16"><a href="#__codelineno-20-16" id="__codelineno-20-16" name="__codelineno-20-16"></a>    Block 143(Sector Trailer)
</span><span id="__span-20-17"><a href="#__codelineno-20-17" id="__codelineno-20-17" name="__codelineno-20-17"></a>...
</span><span id="__span-20-18"><a href="#__codelineno-20-18" id="__codelineno-20-18" name="__codelineno-20-18"></a>Sector 39:
</span><span id="__span-20-19"><a href="#__codelineno-20-19" id="__codelineno-20-19" name="__codelineno-20-19"></a>    ...
</span></code></pre></div>
<p>每个 Block 有 16 字节，一共 256 个 block，所以是 4K 大小的存储空间。Block 0 比较特殊，保存的是生产商写入的信息，不可更改。</p>
<p>Sector Trailer 的布局如下：</p>
<table>
<thead>
<tr>
<th>Key A</th>
<th>Access Bits</th>
<th>GPB</th>
<th>Key B</th>
</tr>
</thead>
<tbody>
<tr>
<td>6 字节</td>
<td>3 字节</td>
<td>1 字节</td>
<td>6 字节</td>
</tr>
</tbody>
</table>
<p>其中 Key A 和 Key B 上用于当前 Sector 认证的两个 Key，用相应的 Key 认证以后就可以修改 Sector 里面 Block 的内容。既然有 Key，就会有细粒度的权限控制，就是 Access Bits。它的计算方式比较复杂，首先举个文档<a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305</a>出现过的例子 <code>0x7F 0x07 0x88</code>：</p>
<ol>
<li>按字节翻转：0x88 0x07 0x7F</li>
<li>改写成二进制：1000 1000 0000 0111 0111 1111</li>
<li>拆成前半部分：1000 1000 0000 和后半部分：0111 0111 1111</li>
<li>如果前后部分互补，说明这是个合法的 Access Bits（这种取反拼接做校验的方法挺常见的）</li>
<li>取出前半部分：1000 1000 0000</li>
<li>从后往前取三个字节的最高位：011</li>
<li>从后往前取第三个字节的次高位，依此类推：000 000 000</li>
</ol>
<p>这里的 011 表示的是 Sector Trailer 的访问权限，特别地，它表示，不能读出 Key A，只能用 Key B 认证后修改 Key A；用 Key A 或者 Key B 认证后都可以读 Access Bits，但只能在 Key B 认证后修改 Access Bits；不能读出 Key B，只能用 Key B 认证后修改 Key B。也就是说，Key A 认证只能读 Access Bits，而 Key B 认证有权限写入 Key A、Access Bits 和 Key B 字段。完整表格见<a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305 Table 7</a> 。</p>
<p>之后的三个 000 分别对应前三个 Blocks（又称 Data Blocks，先只考虑带 4 Blocks 的 Sector）的访问权限。000 表示的是，用 Key A 和 Key B 都有完整的读写权限。完整的表格见 <a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN 1305 Table 8</a> 。</p>
<p>这里可以给读者留一个练习：0x78 0x77 0x88 对应的权限上什么？</p>
<p>答案：对 Sector Trailer：011；对 Data Blocks：100；此时 Data Blocks 可以用 Key A 或者 Key B 认证读取，但只能用 Key B 认证写入。</p>
<p>如果查看完整的表格就可以发现，Key B 的权限一般是比 Key A 大的，所以 Key B 一般是保密的，而 Key A 可以是公开的。</p>
<h4 id="mifare-命令"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#mifare-命令">MIFARE 命令</a></h4>
<p>为了向 MIFARE Classic 卡发送命令，首先需要一个 ISO 14443-3 Type A 的接口，Android 的 NfcA 或者 libnfc 都提供了接口。这里发送的命令实际上会再经过一层解析、用 CRYPTO1 算法加密（猜测是读卡器做的？不是很确定），不过对应用程序来说是透明的。可以参考 <a href="https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf">MIFARE Classic EV1 1K</a> 和 <a href="https://link.springer.com/chapter/10.1007/978-3-540-85893-5_20">A Practical Attack on the MIFARE Classic</a> 中的描述。</p>
<h5 id="mifare-read"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#mifare-read">MIFARE Read</a></h5>
<p>读出一个 Block 的内容，每个 Block 有 16 字节。命令格式如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>30 XX
</span></code></pre></div>
<p>如果要读第一个 Block，就是 <code>30 00</code>，如果要读第二个 Block，就是 <code>30 01</code> 。</p>
<p>返回的数据里刚好是 16 个字节。</p>
<h5 id="mifare-write"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#mifare-write">MIFARE Write</a></h5>
<p>向一个 Block 写入数据，命令格式如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>A0 XX YY YY YY YY YY YY YY YY YY YY YY YY YY YY YY YY
</span></code></pre></div>
<p>这里的 XX 和上面一样，也是 Block 地址；之后是十六字节的数据。</p>
<h5 id="mifare-authentiate-with-ab"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#mifare-authentiate-with-ab">MIFARE Authentiate with A/B</a></h5>
<p>注：这里和 S70 datasheet 里写的不完全一样。</p>
<p>这个命令会进行 Key A 或者 Key B 的认证，如果是对 Key A 认证：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>60 XX YY YY YY YY ZZ ZZ ZZ ZZ ZZ ZZ
</span></code></pre></div>
<p>这里的 XX 也是 Block 地址，但实际上认证的粒度上 Sector，所以只要认证了 Sector 里面的一个 Block，其他 Block 也是同时认证，也是用同一个 Sector Trailer 中的信息进行认证。YY 则是 ISO 14443-3 Type A 中的 UID，如果用 Android 的 API 读取，就可以在 NfcA 中找到这个四字节的信息。ZZ 就是要认证的密钥，六个字节。</p>
<p>如果是对 Key B 认证，把第一个字节的 0x60 改成 0x61 即可。</p>
<p>认证成功后，返回一个 0x00；如果认证失败，则会断开 NFC。</p>
<h4 id="ndef-是什么"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#ndef-是什么">NDEF 是什么</a></h4>
<p>NDEF 实际上是比较高层次的数据，就像 HTML，表示了一个格式化的数组数据，数组的元素可能是文本、URI 等等。它是由若干个 Record 组成的。一个 Record 如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>03 0B 01 07 54 02 65 6E 61 62 63 64
</span></code></pre></div>
<p>首先是一个 03 表示类型，然后是长度 0x0B（11，从下一个字节开始数），接着是 0x01 0x07 表示这似乎一个 Well Known 类型的 Record，内容的长度为 7，0x54（ASCII T）表示这是文本格式，0x02 表示编码是 UTF-8，0x65 0x6E (ASCII "en") 表示语言是英语，之后的 0x61 0x62 0x63 0x64（ASCII "abcd"）就是文本内容。</p>
<p>很多个 record 连起来，最终一个 0xFE 表示结束，这就是完整的 NDEF 信息了。</p>
<h4 id="在-mifare-classic-上使用-ndef"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#在-mifare-classic-上使用-ndef">在 MIFARE Classic 上使用 NDEF</a></h4>
<p>NDEF 只定义了数据格式，但为了实际使用，还得看具体情况。就好像文件内容保存在硬盘上的时候，并不是直接保存，而是通过文件系统，人为定义一个路径，这样大家才知道要从 /etc/shadow 文件去读 Linux 的用户密码信息，NDEF 也需要人为定义一些规则，再作为数据存放在智能卡里的某个地方，这样大家去读取 metadata，发现上 NDEF Tag，然后才会去解析 NDEF 信息。</p>
<p>有些时候，这个定义很简单，比如直接把 NDEF 数据放在某个 block 里面；有的时候又很复杂，因为可能同时存在很多应用，NDEF 只是其中的一种，所以要有一种类似目录的东西去索引 NDEF“文件”。</p>
<p>MIFARE Classic 上采用的方法上，在特定的 Sector（比如 Sector 0）放一些元数据，元数据里注明了其他的 Sector（从 1 开始的其它 sector）分别用于什么用途，然后 NDEF 是其中一种用途。这个结构叫做 <a href="https://www.nxp.com/docs/en/application-note/AN10787.pdf">MIFARE Application Directory</a>。具体来说，在 MIFARE Classic 里面，它规定 Block 1 和 Block 2 的内容如下：</p>
<table>
<thead>
<tr>
<th>0-1</th>
<th>2-3</th>
<th>4-5</th>
<th>6-7</th>
<th>8-9</th>
<th>10-11</th>
<th>12-13</th>
<th>14-15</th>
</tr>
</thead>
<tbody>
<tr>
<td>Info &amp; CRC</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
</tr>
<tr>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
</tr>
</tbody>
</table>
<p>第一个字节是 CRC 8，它的定义可以在<a href="http://reveng.sourceforge.net/crc-catalogue/1-15.htm">这里的 CRC-8/MIFARE-MAD</a> 里找到：初始值 0xC7，多项式上 0x1D。参与 CRC 计算的是按顺序从第二个字节开始的 31 个字节。</p>
<p>第二个字节是 Info Byte，用处不大，见 MAD 的文档。</p>
<p>之后每两个字节对应一个 Sector 的 AID（Application ID），比如 Block 1 的 2-3 字节对应 Sector 1 的 AID，Block 1 的 4-5 字节对应 Sector 2 的 AID，最后 Block 2 的 14-15 字节对应 Sector 15 的 AID。NDEF 的 AID 就是 0x03 0xE1。当软件发现这里的 AID 是 0x03E1 的时候，它就会去相应的 Sector 去读取 NDEF 信息。</p>
<p>一个用 TagInfo 读出来的例子如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>Sector 0 (0x00)
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>[skipped]
</span><span id="__span-25-3"><a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a>[01]  F3 01 03 E1 03 E1 00 00
</span><span id="__span-25-4"><a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a> rW-  00 00 00 00 00 00 00 00
</span><span id="__span-25-5"><a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a>[02]  00 00 00 00 00 00 00 00
</span><span id="__span-25-6"><a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a> rW-  00 00 00 00 00 00 00 00
</span><span id="__span-25-7"><a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a>[03]  A0:A1:A2:A3:A4:A5  MAD access key
</span><span id="__span-25-8"><a href="#__codelineno-25-8" id="__codelineno-25-8" name="__codelineno-25-8"></a> WXW  78:77:88 C1
</span><span id="__span-25-9"><a href="#__codelineno-25-9" id="__codelineno-25-9" name="__codelineno-25-9"></a>      XX:XX:XX:XX:XX:XX  (key unavailable)
</span></code></pre></div>
<p>可以看到，这里表示的是 Sector 1 和 Sector 2 是 03E1 NDEF。下面 [03] 行表示的是 Key A，下一行是 Access bits、GPD，最后一行是 Key B。TagInfo 会尝试从 well known 里的 Key A 和 Key B 一个个试，直到认证成功为止。常见的如下：</p>
<ol>
<li>A0 A1 A2 A3 A4 A5：MAD 的 Key A</li>
<li>D3 F7 D3 F7 D3 F7：NDEF 的 Key A</li>
<li>FF FF FF FF FF FF：出场默认的 Key A 和 Key B</li>
</ol>
<h3 id="如何在-mifare-classic-上配置-ndef"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#如何在-mifare-classic-上配置-ndef">如何在 MIFARE Classic 上配置 NDEF</a></h3>
<p>如果看了这么多背景知识，你还有心情看到这里，那要给个掌声。</p>
<p>为什么要在 MIFARE Classic 上配置 NDEF 呢？因为直接买到的 MIFARE Classic（比如我用的 EV1 4K S70）里面都是出厂状态，Key A 和 Key B 都是 FF FF FF FF FF FF，除了 Block 0 以外数据都是 0，所以它并不能用作 NDEF，Android 也只是认为它 NdefFormattable。所以我们要做的就是，Format as NDEF。为啥要自己搞呢，也是因为试了几个现成的工具 format 都失败了。</p>
<p>其实整个流程在 <a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305</a> 的 8.1 章节都写了，但看起来简单，实现起来还是有很多细节，在搞的时候也是来来回回做了很多尝试，同时也利用 TagInfo 强大的 Memory dump 配合调试。</p>
<p>首先复习一下我们可以用哪些命令：</p>
<ol>
<li>MIFARE Authenticate：对一个 sector 认证，认证成功了才能写操作</li>
<li>MIFARE Read：读取一个 Block</li>
<li>MIFARE Write：写入一个 Block</li>
</ol>
<p>仔细观察 <a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305</a> 的 Fig.10 和下面的文本描述，大概需要做这些事情：</p>
<ol>
<li>修改 Block 1 和 Block 2 中的信息，符合 MAD 的格式</li>
<li>修改 Sector 0 的 Sector Trailer</li>
<li>修改 Block 4，填入一个空白的 NDEF，或者直接前面背景知识里的例子。</li>
<li>修改 Sector 1 和 Sector 2 的 Sector Trailer</li>
</ol>
<p>但有一些细节：</p>
<ol>
<li>修改 Sector Trailer 的时候要谨慎，因为会修改 Key，如果改完又忘了，这卡就废了</li>
<li>注意用 Key A 还是 Key B 进行认证。上面这些流程结束后，Sector 0 被保护了，需要用 Key B 才能修改数据；而 Sector 1 和 Sector 2 是开放的；如果执行完第一步和第二步以后，发现第一步写错了，就要注意权限的问题，必要时还可以先修改 Access bits 再修改数据</li>
<li>在这里为了简单，Key B 都用 FF FF FF FF FF FF 了，实际情况下可以用别的自己的密钥，只要记住就行</li>
</ol>
<p>那么，按照前面的这些知识，就可以构造出每一步的 MIFARE 命令了：</p>
<p><strong>注意：下面的命令不一定能工作，在执行前请仔细理解每条命令的结果，本文作者对卡的损失概不负责</strong></p>
<p>第一步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a>60 00 YY YY YY YY FF FF FF FF FF FF
</span><span id="__span-26-2"><a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a>A0 01 F3 01 03 E1 03 E1 00 00 00 00 00 00 00 00 00 00
</span><span id="__span-26-3"><a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>A0 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span></code></pre></div>
<p>注意 YY 要填入 ID。这一步首先用 FF FF FF FF FF FF 认证了 Sector 0 的 Key A，然后写入了 Block 1 和 Block 2。Info Byte 用的是 0x01，然后用在线工具计算了一下 CRC=F3。</p>
<p>第二步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a>A0 03 A0 A1 A2 A3 A4 A5 78 77 88 C1 FF FF FF FF FF FF
</span></code></pre></div>
<p>这一步设置了 Key A 为 MAD access key，权限是 78 77 88，GPB 是 C1，Key B 为 FF FF FF FF FF FF</p>
<p>第三步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a>60 04 YY YY YY YY FF FF FF FF FF FF
</span><span id="__span-28-2"><a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a>A0 04 00 00 03 0B D1 01 07 54 02 65 6E 61 62 63 64 FE
</span></code></pre></div>
<p>这一步认证了 Sector 1，然后往 Block 4 写入了一个 abcd 的 NDEF 记录。</p>
<p>第四步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a>A0 07 D3 F7 D3 F7 D3 F7 7F 07 88 40 FF FF FF FF FF FF
</span><span id="__span-29-2"><a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a>60 08 YY YY YY YY FF FF FF FF FF FF
</span><span id="__span-29-3"><a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a>A0 0B D3 F7 D3 F7 D3 F7 7F 07 88 40 FF FF FF FF FF FF
</span></code></pre></div>
<p>写入了 Sector 1 的 Sector Trailer，然后认证 Sector 2，再写入 Sector 2 的 Sector Trailer</p>
<p>这样就完成了，再用 TagInfo 等软件，就可以读取出来 NDEF 信息了。此时 iOS 也可以读出来。</p>
<p>上面这些过程，在实际情况下在不同 sector 的时候需要打断，每次重新认证一下。这里默认了一些卡的初始密钥，如果初始情况并不一致，可能并不会工作。</p>
<h3 id="踩的坑"><a class="toclink" href="../../../../hardware/2020/05/10/mifare-classic-ndef/#踩的坑">踩的坑</a></h3>
<p>在这个过程中踩过很多的坑：</p>
<ol>
<li>在空 NDEF 的时候，NFC Tools 能读出来是 Ndef，并且内容是空，但写入的时候表示 Write error，也读不出来；去 TagInfo 读内存，发现确实写进去了，但内容不对，有一个位置的长度写成了 0，可能是 BUG</li>
<li>上面也提到过的，就是在修改为只读以后，发现数据写错了，只好重新改成可写，把数据改好了以后再设为只读。</li>
<li>iOS 上用 NFCNDEFReaderSession 可以读出来这个 NDEF 的内容，但 NFCTagReaderSession 并不能 poll 出来。</li>
</ol>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-04-04 00:00:00+00:00">2020年4月4日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../">hardware</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="在命令行中进行-vivado-仿真"><a class="toclink" href="../../../../hardware/2020/04/04/vivado-simulation-command/">在命令行中进行 Vivado 仿真</a></h2>
<h3 id="已有-vivado-项目"><a class="toclink" href="../../../../hardware/2020/04/04/vivado-simulation-command/#已有-vivado-项目">已有 Vivado 项目</a></h3>
<p>想要在命令行里进行 Vivado 仿真，所以查了下 Xilinx 的 UG900 文档，找到了命令行仿真的方法。首先是生成仿真所需的文件：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c"># assuming batch mode</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nv">open_project</span><span class="w"> </span>xxx.xpr
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nv">set_property</span><span class="w"> </span>top<span class="w"> </span>YOUR_SIM_TOP<span class="w"> </span><span class="k">[</span><span class="nv">current_fileset</span><span class="w"> </span><span class="o">-</span>simset<span class="k">]</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="nv">export_ip_user_files</span><span class="w"> </span><span class="o">-</span>no_script<span class="w"> </span><span class="o">-</span>force
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="nv">export_simulation</span><span class="w"> </span><span class="o">-</span>simulator<span class="w"> </span>xsim<span class="w"> </span><span class="o">-</span>force
</span></code></pre></div>
<p>可以把这些语句放到 tcl 文件里然后用 batch mode 执行。执行成功以后，会在 <code>export_sim/xsim</code> 目录下生成一些文件。里面会有生成的脚本以供仿真：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nb">cd</span><span class="w"> </span>export_sim/xsim<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./YOUR_SIM_TOP.sh
</span></code></pre></div>
<p>默认情况下它会执行 export_sim/xsim/cmd.tcl 里面的命令。如果想要记录 vcd 文件，修改内容为：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nv">open_vcd</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nv">log_vcd</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="nv">run</span><span class="w"> </span><span class="mi">20</span>us
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="nv">close_vcd</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="nv">quit</span>
</span></code></pre></div>
<p>这样就可以把仿真的波形输出到 dump.vcd 文件，拖到本地然后用 GTKWave 看。更多支持的命令可以到 UG900 里找。</p>
<h3 id="无项目模式"><a class="toclink" href="../../../../hardware/2020/04/04/vivado-simulation-command/#无项目模式">无项目模式</a></h3>
<p>如果没有创建 Vivado 项目，也可以单独进行仿真，具体分为三个步骤：</p>
<ol>
<li>第一步，对每个源 Verilog 文件，运行 <code>xvlog module.v</code> 命令</li>
<li>第二步，生成 snapshot，运行 <code>xelab -debug all --snapshot snapshot_name top_module_name</code></li>
<li>第三步，仿真，运行 <code>xsim snapshot_name</code></li>
</ol>
<p>如果想要生成波形文件，编辑 <code>xsim.tcl</code> 为以下内容：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nv">open_vcd</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nv">log_vcd</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nv">run</span><span class="w"> </span><span class="o">-</span>all
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="nv">close_vcd</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="nv">quit</span>
</span></code></pre></div>
<p>把第三步运行的命令改为：<code>xsim snapshot_name -tclbatch xsim.tcl</code> 即可。</p>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../../">1</a> <a class="md-pagination__link" href="../2/">2</a> <span class="md-pagination__current">3</span> <a class="md-pagination__link" href="../4/">4</a>
</nav>
</div>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="上一页: devops" class="md-footer__link md-footer__link--prev" href="../../../devops/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                上一页
              </span>
<div class="md-ellipsis">
                devops
              </div>
</div>
</a>
<a aria-label="下一页: meta" class="md-footer__link md-footer__link--next" href="../../../meta/">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                meta
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2016-2025 Jiajie Chen
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<div class="md-progress" data-md-component="progress" role="progressbar"></div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="../../../../javascripts/mathjax.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>