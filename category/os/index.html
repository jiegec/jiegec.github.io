
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维,编程,调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/category/os/">
      
      
        <link rel="prev" href="../news/">
      
      
        <link rel="next" href="../others/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.1, mkdocs-material-9.2.0-b2">
    
    
      
        <title>os - 杰哥的{运维,编程,调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.83068744.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-3109FRSVTT",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#os" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              os
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/README.md" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../archive/2023/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/README.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    os
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    os
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#在-m1-上运行-windows-arm-虚拟机" class="md-nav__link">
    在 M1 上运行 Windows ARM 虚拟机
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#给-rocket-chip-挂接串口外设" class="md-nav__link">
    给 Rocket Chip 挂接串口外设
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-macos-的-virtualbox-上从-usb-启动" class="md-nav__link">
    在 macOS 的 VirtualBox 上从 USB 启动
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#更改-macos-屏幕亮度的按键" class="md-nav__link">
    更改 macOS 屏幕亮度的按键
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#构建简易的-initramfs" class="md-nav__link">
    构建简易的 initramfs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#向-nexus-6p-中刷入-lineageos-实践" class="md-nav__link">
    向 Nexus 6P 中刷入 LineageOS 实践
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-wsl-上开启一个-getty-到串口的方法" class="md-nav__link">
    在 WSL 上开启一个 getty 到串口的方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#体验-fedora-on-riscv" class="md-nav__link">
    体验 Fedora on RISCV
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="os">os<a class="headerlink" href="#os" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-30 00:00:00">2022年1月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-m1-上运行-windows-arm-虚拟机"><a class="toclink" href="../../os/2022/01/30/windows-on-arm-on-m1/">在 M1 上运行 Windows ARM 虚拟机</a></h2>
<p>目前 Windows ARM 出了预览版，可以从 <a href="https://www.microsoft.com/en-us/software-download/windowsinsiderpreviewARM64">Windows Insider Preview Downloads</a> 下载，得到一个 9.5GB 的 vhdx 文件。</p>
<p>接着，用 qemu-img 转换为 vmdk 格式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-0-1"></a>$<span class="w"> </span>qemu-img<span class="w"> </span>convert<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vhdx<span class="w"> </span>-O<span class="w"> </span>vmdk<span class="w"> </span>-o<span class="w"> </span><span class="nv">adapter_type</span><span class="o">=</span>lsilogic<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vmdk
</span></code></pre></div>
<p>转换后，在 VMWare Fusion for Apple Silicon Tech Preview 中，选择从已有的 vmdk 中创建虚拟机，启动前修改一些设置，特别是内存，默认 256MB 肯定不够，默认单核 CPU 也太少了一些。内存不足可能导致安装失败，记住要第一次启动前设置。</p>
<p>启动以后会无法访问网络，按照下面网页里的方法设置网络：</p>
<p>https://www.gerjon.com/vmware/vmware-fusion-on-apple-silicion-m1/</p>
<p>需要注意的是，bcdedit 选项填的 IP 地址一般是 bridge 上的地址，比如 bridge101 的地址。</p>
<p>然后就可以正常工作了！</p>
<p>在 <a href="https://communities.vmware.com/t5/Fusion-for-Apple-Silicon-Tech/Vmware-Fusion-Apple-Silicon-Support-Windows/m-p/2868331">VMWare 论坛里</a>，还谈到了下面几个问题的解决方法：</p>
<p>为了让声音工作，可以修改 vmx 文件，设置 guestOS：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-1-1"></a>guestOS = &quot;arm-windows11-64&quot;
</span></code></pre></div>
<p>这样声音就可以正常播放了。</p>
<p>分辨率的问题，可以用 RDP 来解决：首先在虚拟机里打开 Remote Desktop，然后用 macOS 的 Microsoft Remote Desktop Beta 访问即可。</p>
<p>系统里没有 Microsoft Store，要安装的话，用命令行的 Powershell 执行下面的命令：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-2-1"></a>wsreset.exe -i
</span></code></pre></div>
<p>这个方法见 <a href="https://kb.parallels.com/128520">Parallels Desktop KB128520</a>。</p>
<p>UPDATE:</p>
<p>VMware Fusion 发布了新版本 <a href="https://blogs.vmware.com/teamfusion/2022/07/just-released-vmware-fusion-22h2-tech-preview.html">22H2</a>，有官方的 Windows 11 on ARM 支持了：</p>
<ul>
<li>Windows 11 on Intel and Apple Silicon with 2D GFX and Networking</li>
<li>VMtools installation for Windows 11 GOS on M1</li>
<li>Improved Linux support on M1</li>
<li>3D Graphics HW Acceleration and OpenGL 4.3 in Linux VMs* (Requires Linux 5.19+ &amp; Mesa 22.1.3+)</li>
<li>Virtual TPM Device</li>
<li>Fast Encryption</li>
<li>Universal Binary</li>
</ul>
<p>并且不需要上面写的网卡的 workaround 了：</p>
<div class="language-text highlight"><pre><span></span><code>vmxnet3 Networking Drivers for Windows on ARM

While Windows does not yet ship with our vmxnet3 networking driver for
Windows on ARM as it now does for Intel, the VMware Tools ISO on ARM
contains the 2 currently supported drivers for graphics and networking.
</code></pre></div>
<p>实测安装 VMware Tools 以后，就可以成功用 vmxnet3 网卡上网了，不需要之前的 bcdedit 方案。</p>
<p>但是目前测试 Linux 虚拟机有一些问题，一些内核版本在启动的时候 vmwgfx 驱动会报错，不能正常显示，但是系统是正常启动的，可以通过 SSH 访问。我测试的情况见下：</p>
<p>Linux 5.19.6(5.19.0-1-arm64): 可以正常启动和显示，但是没有 3D 加速（按照 VMware 的说法是需要 5.19 内核 + Mesa 22.1.1 以上，但是我的环境版本已经符合了这个要求，可能是 Debian 打包缺了什么东西）；</p>
<p>UPDATE（2022-09-27）：更新了一下系统，现在 <code>glxinfo</code> 可以看到 SVGA 了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-1"></a>Device: SVGA3D; build: RELEASE; LLVM; (0x406)
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-2"></a>Version: 22.2.0
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-3"></a>Accelerated: no
</span></code></pre></div>
<p>但是显示有一些 BUG，刷新不正常。</p>
<p>Linux 5.18(5.18.0-0.bpo.1-arm64): <code>VMware Fusion has encountered an error and has shut down the virtual machine</code></p>
<p>Linux 5.16(5.16.0-0.bpo.4-arm64): SSH 也没启动，看不到内核日志</p>
<p>Linux 5.15.15(5.15.0-0.bpo.3-arm64):</p>
<p>图形界面起不来，可以通过 SSH 访问。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-1"></a>[   10.765945] kernel BUG at drivers/gpu/drm/vmwgfx/vmwgfx_drv.h:1627!
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-2"></a>[   10.766206] Call trace:
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-3"></a>[   10.766207]  vmw_event_fence_action_queue+0x328/0x330 [vmwgfx]
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-4"></a>[   10.766210]  vmw_stdu_primary_plane_atomic_update+0xd8/0x220 [vmwgfx]
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-5"></a>[   10.766214]  drm_atomic_helper_commit_planes+0xf8/0x21c [drm_kms_helper]
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-6"></a>[   10.766222]  drm_atomic_helper_commit_tail+0x5c/0xb0 [drm_kms_helper]
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-7"></a>[   10.766225]  commit_tail+0x160/0x190 [drm_kms_helper]
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-8"></a>[   10.766227]  drm_atomic_helper_commit+0x16c/0x400 [drm_kms_helper]
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-9"></a>[   10.766230]  drm_atomic_commit+0x58/0x6c [drm]
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-10"></a>[   10.766242]  drm_atomic_helper_set_config+0xe0/0x120 [drm_kms_helper]
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-11"></a>[   10.766245]  drm_mode_setcrtc+0x1ac/0x680 [drm]
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-12"></a>[   10.766249]  drm_ioctl_kernel+0xd0/0x120 [drm]
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-13"></a>[   10.766253]  drm_ioctl+0x250/0x460 [drm]
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-14"></a>[   10.766257]  vmw_generic_ioctl+0xbc/0x160 [vmwgfx]
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-15"></a>[   10.766261]  vmw_unlocked_ioctl+0x24/0x30 [vmwgfx]
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-16"></a>[   10.766264]  __arm64_sys_ioctl+0xb4/0x100
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-17"></a>[   10.766287]  invoke_syscall+0x50/0x120
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-18"></a>[   10.766300]  el0_svc_common.constprop.0+0x4c/0xf4
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-19"></a>[   10.766302]  do_el0_svc+0x30/0x9c
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-20"></a>[   10.766303]  el0_svc+0x28/0xb0
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-21"></a>[   10.766327]  el0t_64_sync_handler+0x1a4/0x1b0
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-22"></a>[   10.766328]  el0t_64_sync+0x1a0/0x1a4
</span></code></pre></div>
<p>回收硬盘空间：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-5-1"></a>sudo<span class="w"> </span>vmware-toolbox-cmd<span class="w"> </span>disk<span class="w"> </span>shrink<span class="w"> </span>/
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../os/2022/01/30/windows-on-arm-on-m1/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-05-08 00:00:00">2019年5月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="给-rocket-chip-挂接串口外设"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/">给 Rocket Chip 挂接串口外设</a></h2>
<h3 id="前言"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#%C3%A5%C2%89%C2%8D%C3%A8%C2%A8%C2%80">前言</a></h3>
<p>最近在给 rCore 添加 Rocket Chip 支持。下面讲讲最近做了哪些工作，遇到了哪些坑，都是怎么解决的。</p>
<h3 id="踩坑过程"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#%C3%A8%C2%B8%C2%A9%C3%A5%C2%9D%C2%91%C3%A8%C2%BF%C2%87%C3%A7%C2%A8%C2%8B">踩坑过程</a></h3>
<h4 id="rocket-chip-运行代码"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#rocket-chip-%C3%A8%C2%BF%C2%90%C3%A8%C2%A1%C2%8C%C3%A4%C2%BB%C2%A3%C3%A7%C2%A0%C2%81">Rocket Chip 运行代码</a></h4>
<p>首先分析了一下已有的代码和工作方式，这个 Rocket Chip（ucb-bar/fpga-zynq）的设计大概是这样的：在 PS 上通过 fesvr 向 Rocket Chip 写入程序。Rocket Chip 本身暴露出一个 TSI，一个串口的调试接口，通过 Zynq Adapter 挂到了 PS 下的 AXI 总线，暴露出若干个寄存器，大概如下：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-1"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-2"></a><span class="cm">   * Address Map</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-3"></a><span class="cm">   * 0x00 - serial out FIFO data</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-4"></a><span class="cm">   * 0x04 - serial out FIFO data available (words)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-5"></a><span class="cm">   * 0x08 - serial in  FIFO data</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-6"></a><span class="cm">   * 0x0C - serial in  FIFO space available (words)</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-7"></a><span class="cm">   * 0x10 - system reset</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-8"></a><span class="cm">   * 0x20 - req FIFO data</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-9"></a><span class="cm">   * 0x24 - req FIFO data available (words)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-10"></a><span class="cm">   * 0x28 - data FIFO data</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-11"></a><span class="cm">   * 0x2C - data FIFO data available (words)</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-12"></a><span class="cm">   * 0x30 - resp FIFO data</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-13"></a><span class="cm">   * 0x34 - resp FIFO space available (words)</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-14"></a><span class="cm">   * 0x38 - nsectors</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-15"></a><span class="cm">   * 0x3C - max request length</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-0-16"></a><span class="cm">   */</span>
</span></code></pre></div>
<p>前面的是调试接口，后面的是 block device 和 network，我们暂时还没有用到这些 UCB BAR 做的私货。在 Vivado 中，地址 Offset 是 0x43C00000，所以代码中就这样访问对应的物理地址：</p>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-1"></a><span class="cp">##define ZYNQ_BASE_PADDR 0x43C00000L</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-3"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/mem&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">O_SYNC</span><span class="p">);</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-4"></a><span class="n">assert</span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-5"></a><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-6"></a><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGESIZE</span><span class="p">),</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-7"></a><span class="w">  </span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ZYNQ_BASE_PADDR</span><span class="p">);</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-1-8"></a><span class="n">assert</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">);</span>
</span></code></pre></div>
<p>这块地址在 Device Tree 里也有对应的项，于是 PS 在访问的时候就会找到总线上的 Rocket Chip 的 Slave，也就对应到了上面的那个寄存器的 Map。接着就是由 fesvr 向 Rocket Chip 里写程序，然后跑起来了。</p>
<h4 id="opensbi-输出"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#opensbi-%C3%A8%C2%BE%C2%93%C3%A5%C2%87%C2%BA">OpenSBI 输出</a></h4>
<p>接着就需要先把输入输出做起来，需要移植一个 bootloader。相比之下，OpenSBI 明显比 bbl 更适合于这个用途，于是拿着 OpenSBI 就拿来改了。考虑到 fesvr 采用的是 htif 进行输入输出，于是从 bbl 里抄了相关代码过来，得到了正确的输出：</p>
<p><img alt="" src="/images/opensbi_uart.jpg" /></p>
<h4 id="rcore启动"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#rcore%C3%A5%C2%90%C2%AF%C3%A5%C2%8A%C2%A8">rCore，启动！</a></h4>
<p>接下来，就想着怎么把 rCore 丢进去跑。把 payload 替换掉，丢进去，gg 了。一直出现一个玄学的问题，只要我修改页表，就出现 instruction access fault。也一直没有找到真实的原因，最后把 PMP 保护关了就好了。。怀疑是 Rocket Chip 实现有误。</p>
<p>又做了一些小的修改和适配，用户态也可以正常跑起来了。但是，现在串口只能轮询读取，而 htif 是通过读写内存进行的，也没有类似 MSI 的机制（现在想了想，其实可以，给 PS 挂一个 AXI Interrupt Controller，采用软件产生中断模式，然后接到 Rocket Chip 上，其实也是可以的），另外 Rocket Chip 原来的 Config 还没有向外暴露中断，我想挂一个串口也得让 Rocket Chip 访问得到。于是就开始了阅读 Chisel 代码然后魔改的过程了。</p>
<h4 id="魔改-rocket-chip"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#%C3%A9%C2%AD%C2%94%C3%A6%C2%94%C2%B9-rocket-chip">魔改 Rocket Chip</a></h4>
<p>其实算不上魔改，克服了对 Rocket Chip 的恐惧，仔细阅读代码以后，发现还是比较容易理解的。譬如，我要添加一个外部总线，只需要添加一句：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-2-1"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">ExtBus</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">up</span><span class="p">(</span><span class="nc">ExtBus</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="n">idBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span>
</span></code></pre></div>
<p>那么对应地，就多了一片地址映射：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-3-1"></a>60000000 - 80000000  RWX  mmio-port-axi4@60000000
</span></code></pre></div>
<p>意味着，只要我在 Rocket Chip 里访问这片地址，那么就会访问这个 AXI 总线上的外设了。但是事情没有这么简单，在踩了很久的坑以后才最终解决。。</p>
<h5 id="axi-总线地址的计算方式"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#axi-%C3%A6%C2%80%C2%BB%C3%A7%C2%BA%C2%BF%C3%A5%C2%9C%C2%B0%C3%A5%C2%9D%C2%80%C3%A7%C2%9A%C2%84%C3%A8%C2%AE%C2%A1%C3%A7%C2%AE%C2%97%C3%A6%C2%96%C2%B9%C3%A5%C2%BC%C2%8F">AXI 总线地址的计算方式</a></h5>
<p>首先谈谈 AXI 总线上地址是怎么计算的。AXI 总线是一个星形结构，一个 Master 多个 Slave，在这里出现的例子是：</p>
<ol>
<li>PS 是 Master，Rocket Chip 是 Slave — 刚才谈到过的那片 register space</li>
<li>Rocket Chip 是 Master，PS 是 Slave — 让 Rocket Chip 访问 DDR 控制器</li>
<li>Rocket Chip 是 Master，外设 是 Slave — 这就是现在要做的事情</li>
</ol>
<p>之前省略没说的是上面的第二点，就是让 Rocket Chip 也可以拿到内存用。那问题来了，怎么让 Rocket Chip 和 ARM 上的 Linux 不要打架？把地址空间分成两块就好了：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-4-1"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_araddr</span><span class="p">;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-4-2"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_awaddr</span><span class="p">;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-4-4"></a><span class="c1">// Memory given to Rocket is the upper 256 MB of the 512 MB DRAM</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-4-5"></a><span class="k">assign</span><span class="w"> </span><span class="n">S_AXI_araddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="w"> </span><span class="n">mem_araddr</span><span class="p">[</span><span class="mh">27</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-4-6"></a><span class="k">assign</span><span class="w"> </span><span class="n">S_AXI_awaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">,</span><span class="w"> </span><span class="n">mem_awaddr</span><span class="p">[</span><span class="mh">27</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span></code></pre></div>
<p>这样做，就透明地把 Rocket Chip 看到的内存空间都映射到了实际内存的 [256MB, 512MB) 这片空间上了。</p>
<p>注：我实验用的板子实际上有 1GB 的 DRAM，但实际上已经足够用了，所以就没有改原来 zedboard 的配置。</p>
<p>我在前面也提到，在 PS 上访问 0x43C00000 就是对应了 Zynq Adapter 的 0x0 地址。这里也是，在 Rocket Chip 上访问 0x0 的地址，我强行改成了 0x10000000，然后 Offset 是 0，所以最后到内存就是 0x10000000 的地址了。</p>
<p>所以 AXI 总线上 Slave Register 的地址 = Master 地址 - 匹配到的 Slave 的 Offset 地址。但是，<strong>如果只有单个 Slave 的时候，AXI Interconnect 可能不检查地址范围，而是直接截断，但在有多个 Slave 的时候，会先检查地址范围，如果找不到就返回错误。</strong>这个问题让我困惑了许久，直到我挂上了 <code>System ILA</code> 看。。</p>
<h5 id="axi-uartlite"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#axi-uartlite">AXI Uartlite</a></h5>
<p>既然有了外设总线，第一个想到的外设就是 UART 咯，于是加了一个 AXI Uartlite，用 AXI Interconnect 连到外设总线上。写了程序简单测试了一下，确实读取到了数据，然后也很快就可以成功地从串口读数据，写数据。于是我又加了一个串口，拉到 AXI Interconnect 第二个接口上，结果就不工作了。</p>
<p>细心的读者可能已经从我上面讲到的一些内容上猜到了问题所在。。但这一点直到后面我才明白发生了什么，后面会再讲到这里的问题。</p>
<h5 id="axi-interrupt-controller"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#axi-interrupt-controller">AXI Interrupt Controller</a></h5>
<p>接着，回到我们最初的目标，既然可以输入输出了，还要真的串口干啥？添加中断或者拉一路 JTAG 出来，脱离 PS 来进行调试。所以接下来需要从 Rocket Chip 中暴露外部中断。在原来的代码中，是直接关掉了的：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-5-1"></a><span class="n">target</span><span class="p">.</span><span class="n">tieOffInterrupts</span><span class="p">()</span>
</span></code></pre></div>
<p>它的功能很简单，直接把中断置 0。但我要的是拉到外面，经过了一番挣扎：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ps_axi_slave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Flipped</span><span class="p">(</span><span class="n">adapter</span><span class="p">.</span><span class="n">axi</span><span class="p">.</span><span class="n">cloneType</span><span class="p">)</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-3"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">mem_axi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mem_axi4</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">cloneType</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-4"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">mmio_axi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mmio_axi4</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">cloneType</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-5"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-6"></a><span class="p">})</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-8"></a><span class="n">io</span><span class="p">.</span><span class="n">mem_axi</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mem_axi4</span><span class="p">.</span><span class="n">head</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-9"></a><span class="n">io</span><span class="p">.</span><span class="n">mmio_axi</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mmio_axi4</span><span class="p">.</span><span class="n">head</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../os/2019/05/08/axi-uart-interrupt/#__codelineno-6-10"></a><span class="n">target</span><span class="p">.</span><span class="n">interrupts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">interrupts</span>
</span></code></pre></div>
<p>终于找到了正确的方法，拉出来两路中断信号。于是很开心地直接接到了 Uartlite 上，但是事情肯定不会这么简单：</p>
<p>Uartlite 是正边沿触发的中断，但是 Rocket Chip 期望的是高电平触发的中断。所以我们需要一个中断控制器来实现这个，加了一个 AXI Interrupt  Controller。但是问题来了，我们还没解决那个只要加俩 Slave 就都访问不到的问题呢！于是到处挂 System ILA 调试，发现了问题所在：</p>
<p>我们之前提到，0x60000000 - 0x80000000 地址段是对应到了外部 AXI 总线的，这没错，但是，如果在 Rocket Chip 上读 0x60000000 的地址，到总线上还是 0x60000000 的地址而不是 0x0，而之前只有一个 Slave 的时候，没有真的去检查这个地址范围，所以找到了正确的寄存器，现在不行了，于是出错了。</p>
<p>解决方法也很简单，乖乖地把 Offset 调成 0x60000000 和 0x61200000，然后再映射到 rCore 的内核态里。一番挣扎，又参照了 Linux 的 Uartlite 驱动（发现了遗忘设置的 MER 寄存器，不认真阅读文档的后果），终于在 ILA 上看到 uartlite 的输出上有一个脉冲，紧接着看到中断控制器输出了一个 irq，然后 Rocket Chip 收到了 external interrupt。Cheers！</p>
<h4 id="中断处理"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#%C3%A4%C2%B8%C2%AD%C3%A6%C2%96%C2%AD%C3%A5%C2%A4%C2%84%C3%A7%C2%90%C2%86">中断处理</a></h4>
<p>事情虽然差不多解决了，但是还没有结束。收到了一个 interrupt 以后，打印了一下寄存器状态，马上又来下一个 interrupt 了。现在不仅要在 Rocket Chip 的 PLIC 上把中断给确认了（吐槽一下，Rocket 的 PLIC 文档也比较欠缺，我是照着 U54 核的地址找到，但是 U54 呢是一个 4+1 的组合，hart0 没有 M 态，所以我为了打开 hart0 的 S 态中断，要找 hart1 的 M 态地址，详见 SiFive 文档），在 AXI Interrupt Controller 上也得把中断给确认了。但还是不行，每次 interrupt controller 输出的 irq 拉低不久，uartlite 又出现了新的一次中断。</p>
<p>这次的问题很有戏剧性：处理中断的时候输出调试信息，调试信息把 tx fifo 写满了，uartlite 也会产生一个中断。。于是没完了。解决方法很简单，牺牲一些性能，每次输出的时候都等到 tx fifo 空了才写，然后在处理串口中断的时候不要输出调试信息。</p>
<p>这下没有新的问题了，串口中断终于是工作了。</p>
<h3 id="总结和致谢"><a class="toclink" href="../../os/2019/05/08/axi-uart-interrupt/#%C3%A6%C2%80%C2%BB%C3%A7%C2%BB%C2%93%C3%A5%C2%92%C2%8C%C3%A8%C2%87%C2%B4%C3%A8%C2%B0%C2%A2">总结和致谢</a></h3>
<p>这么一番搞下来，对 Vivado 和 AXI 的相关知识都比较熟悉了吧，也踩了很多的坑。需要特别感谢 @cq_z4yx 提供的技术支持。</p>
<p>相关文档和链接：</p>
<ol>
<li>PG099 AXI Interrupt Controller</li>
<li>PG142 AXI Uartlite</li>
<li><a href="https://github.com/rcore-os/opensbi/compare/c1d01b0c2efea86348235a1c7f83382e53f87e0e...7fe82c135e394bc6e6dca610f3771344449568ed">OpenSBI 适配</a></li>
<li><a href="https://github.com/rcore-os/rCore/commit/2e599b0bab2ee522bd11d0c665207841939d2711">rCore 适配</a></li>
</ol>

    <nav class="md-post__action">
      <a href="../../os/2019/05/08/axi-uart-interrupt/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-09-14 00:00:00">2018年9月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-macos-的-virtualbox-上从-usb-启动"><a class="toclink" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/">在 macOS 的 VirtualBox 上从 USB 启动</a></h2>
<p>做了一个 Windows 10 安装 U 盘，想测试一下能不能启动，于是想用 VirtualBox 起一个虚拟机。但是发现，一般情况下要从 ISO 或者把 U 盘克隆成一个 vdi/vmdk etc 再启动。不过找到了 Cem Arslan 的 <a href="https://www.linkedin.com/pulse/virtualbox-booting-from-usb-mac-cem-arslan">VirtualBox - Booting From USB (MAC)</a> 实验了一下，确实可以用，以 <code>/dev/disk2</code> 为例方法如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-0-1"></a>$<span class="w"> </span>diskutil<span class="w"> </span>unmountDisk<span class="w"> </span>/dev/disk2
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-0-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span><span class="k">$(</span>whoami<span class="k">)</span><span class="w"> </span>/dev/disk2
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-0-3"></a>$<span class="w"> </span>VBoxManage<span class="w"> </span>internalcommands<span class="w"> </span>createrawvmdk<span class="w"> </span>-filename<span class="w"> </span>PATH_TO_VMDK<span class="w"> </span>-rawdisk<span class="w"> </span>/dev/disk2
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-0-4"></a>$<span class="w"> </span><span class="c1"># Now boot from VirtualBox</span>
</span></code></pre></div>
<p>对于其它平台，可以参考 Tu Nguyen 的 <a href="https://www.aioboot.com/en/boot-from-usb-in-virtualbox/">How to boot from USB in VirtualBox</a> 。</p>
<p>研究了一下生成的 vmdk 文件，大概是这样的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-1"></a>## Disk DescriptorFile
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-2"></a>version=1
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-3"></a>CID=12345678
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-4"></a>parentCID=ffffffff
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-5"></a>createType=&quot;fullDevice&quot;
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-7"></a>## Extent description
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-8"></a>RW 12345678 FLAT &quot;/dev/disk2&quot; 0
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-10"></a>## The disk Data Base 
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-11"></a>##DDB
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-13"></a>ddb.virtualHWVersion = &quot;4&quot;
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-14"></a>ddb.adapterType=&quot;ide&quot;
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-15"></a>ddb.geometry.cylinders=&quot;1234&quot;
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-16"></a>ddb.geometry.heads=&quot;1234&quot;
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-17"></a>ddb.geometry.sectors=&quot;1234&quot;
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-18"></a>ddb.uuid.image=&quot;12341234-1234-1234-1234-123412341234&quot;
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-19"></a>ddb.uuid.parent=&quot;00000000-0000-0000-0000-000000000000&quot;
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-20"></a>ddb.uuid.modification=&quot;00000000-0000-0000-0000-000000000000&quot;
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-21"></a>ddb.uuid.parentmodification=&quot;00000000-0000-0000-0000-000000000000&quot;
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-22"></a>ddb.geometry.biosCylinders=&quot;1234&quot;
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-23"></a>ddb.geometry.biosHeads=&quot;1234&quot;
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/#__codelineno-1-24"></a>ddb.geometry.biosSectors=&quot;1234&quot;
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../os/2018/09/14/virtualbox-booting-from-usb-on-mac/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-08-05 00:00:00">2018年8月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="更改-macos-屏幕亮度的按键"><a class="toclink" href="../../os/2018/08/05/changing-screen-brightness-key/">更改 macOS 屏幕亮度的按键</a></h2>
<p>由于我打开了「Invert Fn」功能，所以需要调亮度的时候，是采用 Fn+F1/F2 的方法。但是，我的机械键盘则是，不按 Fn 时为 1-9，按着 Fn 时为对应的 F1-F9，但是就无法调整亮度和声音了。</p>
<p>然后捣腾了一下，发现可以用 ScLk 和 Pa/Br（名称在各个键盘上不大一样）调整亮度。不过，还没发现如何更改音量。。。</p>

    <nav class="md-post__action">
      <a href="../../os/2018/08/05/changing-screen-brightness-key/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-07-16 00:00:00">2018年7月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="构建简易的-initramfs"><a class="toclink" href="../../os/2018/07/16/build-custom-initramfs/">构建简易的 initramfs</a></h2>
<p>一直对 Linux 的启动很感兴趣，但对 initrd 和 initramfs 等概念不大了解，于是上网找了资料，自己成功地看到了现象。</p>
<p>参考资料：
<a href="http://www.kaizou.org/2016/09/boot-minimal-linux-qemu/">Build and boot a minimal Linux system with qemu</a>
<a href="https://wiki.gentoo.org/wiki/Custom_Initramfs">Custom Initramfs</a>
<a href="https://dazdaztech.wordpress.com/2013/04/04/initrd-vs-initramfs/">initramfs vs initrd</a>
<a href="https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt">ramfs, rootfs and initramfs</a>
<a href="https://www.linux.com/learn/kernel-newbie-corner-initrd-and-initramfs-whats">The Kernel Newbie Corner: "initrd" and "initramfs"-- What's Up With That?</a></p>
<p>具体步骤：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-1"></a>$<span class="w"> </span>cat<span class="w"> </span>hello.c
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-2"></a><span class="c1">##include &lt;stdio.h&gt;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-3"></a><span class="c1">##include &lt;unistd.h&gt;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-5"></a>int<span class="w"> </span>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="o">(</span><span class="p">;;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-7"></a><span class="w">        </span>printf<span class="o">(</span><span class="s2">&quot;Hello, world!\n&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-8"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-9"></a><span class="o">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-10"></a>$<span class="w"> </span>gcc<span class="w"> </span>-static<span class="w"> </span>hello.c<span class="w"> </span>-o<span class="w"> </span>init
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-11"></a>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>init<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-o<span class="w"> </span>-H<span class="w"> </span>newc<span class="w"> </span><span class="p">|</span><span class="w"> </span>gzip<span class="w"> </span>&gt;<span class="w"> </span>initrd
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-12"></a>$<span class="w"> </span>qemu-system-x86_64<span class="w"> </span>-kernel<span class="w"> </span>/boot/vmlinuz-linux<span class="w"> </span>-initrd<span class="w"> </span>initrd<span class="w"> </span>-nographic<span class="w"> </span>-append<span class="w"> </span><span class="s1">&#39;console=ttyS0&#39;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../os/2018/07/16/build-custom-initramfs/#__codelineno-0-13"></a><span class="c1">## Use C-a c q u i t &lt;Enter&gt; to exit</span>
</span></code></pre></div></p>
<p>可以看到过一会（三四秒？），可以看到满屏的 Hello world 在输出。</p>

    <nav class="md-post__action">
      <a href="../../os/2018/07/16/build-custom-initramfs/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-29 00:00:00">2018年5月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="向-nexus-6p-中刷入-lineageos-实践"><a class="toclink" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/">向 Nexus 6P 中刷入 LineageOS 实践</a></h2>
<p>Nexus 6P 自带的系统没有允许 Root，所以需要自己解锁 bootloader 并且刷上别的系统。我选择了 LineageOS。Nexus 6P 的代号为 angler，首先可以找到官方的<a href="https://wiki.lineageos.org/devices/angler/install">安装教程</a>。</p>
<p>我们需要下载的东西：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-1"></a>$<span class="w"> </span>wget<span class="w"> </span>https://mirrorbits.lineageos.org/full/angler/20180521/lineage-15.1-20180521-nightly-angler-signed.zip
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-2"></a>$<span class="w"> </span>wget<span class="w"> </span>https://mirrorbits.lineageos.org/full/angler/20180521/lineage-15.1-20180521-nightly-angler-signed.zip?sha256<span class="w"> </span>-O<span class="w"> </span>lineage-15.1-20180521-nightly-angler-signed.zip.sha256
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-3"></a>$<span class="w"> </span>wget<span class="w"> </span>https://mirrorbits.lineageos.org/su/addonsu-15.1-arm64-signed.zip
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-4"></a>$<span class="w"> </span>wget<span class="w"> </span>https://mirrorbits.lineageos.org/su/addonsu-15.1-arm64-signed.zip?sha256<span class="w"> </span>-O<span class="w"> </span>addonsu-15.1-arm64-signed.zip
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-5"></a>$<span class="w"> </span>wget<span class="w"> </span>https://github.com/opengapps/arm64/releases/download/20180527/open_gapps-arm64-8.1-full-20180527.zip
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-6"></a>$<span class="w"> </span>wget<span class="w"> </span>https://github.com/opengapps/arm64/releases/download/20180527/open_gapps-arm64-8.1-full-20180527.zip.md5
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-7"></a>$<span class="w"> </span>wget<span class="w"> </span>https://dl.twrp.me/angler/twrp-3.2.1-0-angler.img
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-8"></a>$<span class="w"> </span>wget<span class="w"> </span>https://dl.twrp.me/angler/twrp-3.2.1-0-angler.img.asc
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-9"></a>$<span class="w"> </span>wget<span class="w"> </span>https://dl.twrp.me/angler/twrp-3.2.1-0-angler.img.md5
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-10"></a>$<span class="w"> </span>gpg<span class="w"> </span>--verify<span class="w"> </span>*.asc
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-11"></a>$<span class="w"> </span>md5sum<span class="w"> </span>-c<span class="w"> </span>*.md5
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-0-12"></a>$<span class="w"> </span>sha256sum<span class="w"> </span>-c<span class="w"> </span>*.sha256
</span></code></pre></div>
<p>其中 Open GApps 可以自己考虑选择 full 还是其它的选择。</p>
<p>接下来，按照教程，先解锁 bootloader。连接手机，进入 USB Debugging Mode，重启进入 bootloader 并且解锁：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-1-1"></a>$<span class="w"> </span>adb<span class="w"> </span>reboot<span class="w"> </span>bootloader
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-1-2"></a>$<span class="w"> </span>fastboot<span class="w"> </span>flashing<span class="w"> </span>unlock
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-1-3"></a><span class="c1">## Confirm unlocking, and then the data should be wiped</span>
</span></code></pre></div>
<p>接下来刷入 TWRP。还是进入 bootloader，然后刷入。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-2-1"></a>$ fastboot flash recovery twrp-3.2.1-0-angler.img
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-2-2"></a>## Select recovery, and enter it
</span></code></pre></div>
<p>进入 TWRP 后，把我们刚刚下载的 zip 文件都 push 到手机上，并用 TWRP 安装：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-3-1"></a>## Select Wipe -&gt; Advanced Wipe, Select Cache, System and Data and wipe then
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-3-2"></a>## Install lineageos, opengapps, addonsu and follow on-screen instructions
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/#__codelineno-3-3"></a>## Reboot into system
</span></code></pre></div>
<p>经过一段时间的等待，LineageOS 就安装成功了。但是遇到了一些问题：</p>
<ol>
<li>开机时提示 vendor image 版本与打包 LineagesOS 时采用的版本不同。
    于是我下载了官方的 <a href="https://dl.google.com/dl/android/aosp/angler-opm2.171019.029.a1-factory-bf17e552.zip">factory image</a>，找到其中的 vendor.img，用 TWRP 刷到了 vendor 分区中。并且执行了 flash-bash.sh 更新 bootloader 和 radio。重启的时候这个错误就解决了。2018-06-12 更新 注意：不要下载 Driver Binaries 里面的 vendor, 刷上去系统还是提示版本 mismatch，建议还是下载完整的 factory 镜像。</li>
<li>检测不到 SIM 卡。
    回到 bootloader 看 Barcode, 是有 IMEI 等信息的，说明分区没有被写坏。在网上搜索一段时间以后，发现禁用登录密码重启一次后即可使用，之后把密码加回来即可。</li>
</ol>

    <nav class="md-post__action">
      <a href="../../os/2018/05/29/flashing-lineageos-in-nexus6p/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-25 00:00:00">2018年5月25日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-wsl-上开启一个-getty-到串口的方法"><a class="toclink" href="../../os/2018/05/25/opening-tty-terminal-in-wsl/">在 WSL 上开启一个 getty 到串口的方法</a></h2>
<p>为了测试一个硬件的 terminal，想在 Windows 上向串口开一个 tty，跑各种软件来测试。这件事情在 Linux 上和 macOS 上都有实践，但一直不知道 Windows 上怎么搞。经过了一番搜索，找到了 https://blogs.msdn.microsoft.com/wsl/2017/04/14/serial-support-on-the-windows-subsystem-for-linux/ 和 https://unix.stackexchange.com/a/123559 的方案。</p>
<p>以 COM5 为例：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2018/05/25/opening-tty-terminal-in-wsl/#__codelineno-0-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">666</span><span class="w"> </span>/dev/ttyS5
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../os/2018/05/25/opening-tty-terminal-in-wsl/#__codelineno-0-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>agetty<span class="w"> </span>-s<span class="w"> </span><span class="m">115200</span><span class="w"> </span>ttyS5<span class="w"> </span>linux
</span></code></pre></div>
<p>这样就可以看到一个登录的界面了。</p>
<p>在 macOS 上 (https://superuser.com/questions/1059744/serial-console-login-on-osx)：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../os/2018/05/25/opening-tty-terminal-in-wsl/#__codelineno-1-1"></a>$<span class="w"> </span>screen<span class="w"> </span>/dev/tty.SLAB_USBtoUART<span class="w"> </span><span class="m">115200</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../os/2018/05/25/opening-tty-terminal-in-wsl/#__codelineno-1-2"></a><span class="c1">## type C-b : exec ::: /usr/libexec/getty std.115200</span>
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../os/2018/05/25/opening-tty-terminal-in-wsl/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2018-05-24 00:00:00">2018年5月24日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="体验-fedora-on-riscv"><a class="toclink" href="../../os/2018/05/24/trying-fedora-on-riscv/">体验 Fedora on RISCV</a></h2>
<p>看到 RISCV 很久了，但一直没能体验。最近工具链不断更新，QEMU 在 2.12.0 也正式加入了 riscv 的模拟。但是自己编译一个内核又太麻烦，就找到了 Fedora 做的 RISCV port，下载下来试用了一下。之前试过一次，但是遇到了一些问题，刚才总算是成功地搞出来了。</p>
<p>官方文档地址：https://fedorapeople.org/groups/risc-v/disk-images/readme.txt
首先下载 https://fedorapeople.org/groups/risc-v/disk-images/ 下的 bbl vmlinux 和 stage4-disk.img.xz 三个文件，然后解压 stage4-disk.img.xz，大约有 5G 的样子。之前作者在脚本里作死开得特别大，导致我以前光是解压这一步就成功不了。现在终于解决了。</p>
<p>然后启动 qemu 命令打开虚拟机：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-1"></a>qemu-system-riscv64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-2"></a><span class="w">  </span>-nographic<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-3"></a><span class="w">  </span>-machine<span class="w"> </span>virt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-4"></a><span class="w">  </span>-m<span class="w"> </span>2G<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-5"></a><span class="w">  </span>-kernel<span class="w"> </span>bbl<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-6"></a><span class="w">  </span>-object<span class="w"> </span>rng-random,filename<span class="o">=</span>/dev/urandom,id<span class="o">=</span>rng0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-7"></a><span class="w">  </span>-device<span class="w"> </span>virtio-rng-device,rng<span class="o">=</span>rng0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-8"></a><span class="w">  </span>-append<span class="w"> </span><span class="s2">&quot;console=ttyS0 ro root=/dev/vda&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-9"></a><span class="w">  </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-10"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>stage4-disk.img,format<span class="o">=</span>raw,id<span class="o">=</span>hd0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-11"></a><span class="w">  </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>usernet<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-0-12"></a><span class="w">  </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>usernet,hostfwd<span class="o">=</span>tcp::10000-:22
</span></code></pre></div></p>
<p>这段命令摘自 readme.txt，区别只在于把 -smp 4 去掉了。不知道为什么不能正常工作，可能和作者提到的 FPU patch 有关。然后系统就可以正常起来了（firewalld 和 systemd-logind 不止为啥起不来，但是不用管）。</p>
<p>可以验证一下我们的系统：
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-1-1"></a>$<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../os/2018/05/24/trying-fedora-on-riscv/#__codelineno-1-2"></a>Linux<span class="w"> </span>stage4.fedoraproject.org<span class="w"> </span><span class="m">4</span>.15.0-00046-g48fb45691946<span class="w"> </span><span class="c1">#27 SMP Mon May 14 08:25:14 UTC 2018 riscv64 riscv64 riscv64 GNU/Linux</span>
</span></code></pre></div></p>

    <nav class="md-post__action">
      <a href="../../os/2018/05/24/trying-fedora-on-riscv/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../news/" class="md-footer__link md-footer__link--prev" aria-label="上一页: news" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                news
              </div>
            </div>
          </a>
        
        
          
          <a href="../others/" class="md-footer__link md-footer__link--next" aria-label="下一页: others" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                others
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.4e31edb1.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
        
      
    
  </body>
</html>