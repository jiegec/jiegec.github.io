{"version": "https://jsonfeed.org/version/1", "title": "\u6770\u54e5\u7684{\u8fd0\u7ef4\uff0c\u7f16\u7a0b\uff0c\u8c03\u677f\u5b50}\u5c0f\u7b14\u8bb0", "home_page_url": "https://jia.je/", "feed_url": "https://jia.je/feed_json_created.json", "description": "\u6770\u54e5\u7684{\u8fd0\u7ef4\uff0c\u7f16\u7a0b\uff0c\u8c03\u677f\u5b50}\u5c0f\u7b14\u8bb0", "icon": null, "authors": [], "language": "zh", "items": [{"id": "https://jia.je/hardware/2024/12/27/cpu_uarch_reverse_engineering_methodology/", "url": "https://jia.je/hardware/2024/12/27/cpu_uarch_reverse_engineering_methodology/", "title": "CPU \u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66", "content_html": "<h1 id=\"cpu-\u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66\">CPU \u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66<a class=\"headerlink\" href=\"#cpu-\u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u505a\u4e86\u4e0d\u5c11\u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\uff0c\u5176\u4e2d\u6d89\u53ca\u5230\u4e86\u5f88\u591a\u7684 CPU \u5fae\u67b6\u6784\u7684\u9006\u5411\uff1a</p>\n<ul>\n<li><a href=\"../../26/apple_m1/\">Apple M1 \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../09/01/qualcomm_oryon/\">Qualcomm Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../11/11/amd_zen5/\">AMD Zen 5 \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../11/07/arm_neoverse_v2/\">ARM Neoverse V2 \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n</ul>\n<p>\u56e0\u6b64\u603b\u7ed3\u4e00\u4e0b CPU \u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b9a\u4e49\">\u5b9a\u4e49<a class=\"headerlink\" href=\"#\u5b9a\u4e49\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u5b9a\u4e49\u4e00\u4e0b\uff1a\u4ec0\u4e48\u662f CPU \u5fae\u67b6\u6784\u9006\u5411\uff0c\u6211\u8ba4\u4e3a CPU \u5fae\u67b6\u6784\u9006\u5411\u5305\u62ec\u4e24\u90e8\u5206\u542b\u4e49\uff1a</p>\n<ol>\n<li>\u5728\u5df2\u7ecf\u77e5\u9053\u67d0 CPU \u5fae\u67b6\u6784\u91c7\u7528\u67d0\u79cd\u8bbe\u8ba1\uff0c\u53ea\u662f\u4e0d\u77e5\u9053\u5176\u8bbe\u8ba1\u53c2\u6570\u65f6\uff0c\u901a\u8fc7\u9006\u5411\uff0c\u5f97\u5230\u5b83\u7684\u8bbe\u8ba1\u53c2\u6570</li>\n<li>\u5728\u4e0d\u786e\u5b9a\u67d0 CPU \u5fae\u67b6\u6784\u91c7\u7528\u7684\u662f\u4ec0\u4e48\u8bbe\u8ba1\uff0c\u7ed9\u51fa\u4e00\u4e9b\u53ef\u80fd\u7684\u8bbe\u8ba1\uff0c\u901a\u8fc7\u9006\u5411\uff0c\u6392\u9664\u6216\u786e\u8ba4\u5176\u8bbe\u8ba1\uff0c\u518d\u8fdb\u4e00\u6b65\u627e\u5230\u5b83\u7684\u8bbe\u8ba1\u53c2\u6570</li>\n</ol>\n<p>\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5df2\u7ecf\u77e5\u9053\u67d0 CPU \u5fae\u67b6\u6784\u6709\u4e00\u4e2a\u7ec4\u76f8\u8fde\u7684 L1 DCache\uff0c\u4f46\u4e0d\u77e5\u9053\u5b83\u7684\u5bb9\u91cf\uff0c\u51e0\u8def\u7ec4\u76f8\u8fde\uff0c\u6b64\u65f6\u901a\u8fc7\u5fae\u67b6\u6784\u9006\u5411\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5f97\u5230\u5b83\u7684\u5bb9\u91cf\uff0c\u5177\u4f53\u662f\u51e0\u8def\u7ec4\u76f8\u8fde\uff0c\u8fdb\u4e00\u6b65\u53ef\u80fd\u628a\u5b83\u7684 Index \u51fd\u6570\u4e5f\u9006\u5411\u51fa\u6765\u3002\u8fd9\u662f\u7b2c\u4e00\u90e8\u5206\u542b\u4e49\u3002</p>\n<p>\u518d\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5df2\u7ecf\u77e5\u9053\u67d0 CPU \u5fae\u67b6\u6784\u6709\u4e00\u4e2a\u5206\u652f\u9884\u6d4b\u5668\uff0c\u4f46\u4e0d\u77e5\u9053\u5b83\u4f7f\u7528\u4e86\u4ec0\u4e48\u4fe1\u606f\u6765\u505a\u9884\u6d4b\uff0c\u53ef\u80fd\u7528\u4e86\u5206\u652f\u7684\u5730\u5740\uff0c\u53ef\u80fd\u7528\u4e86\u5206\u652f\u8981\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740\uff0c\u53ef\u80fd\u7528\u4e86\u5206\u652f\u7684\u65b9\u5411\uff0c\u8fd9\u65f6\u5019\u901a\u8fc7\u5fae\u67b6\u6784\u9006\u5411\u7684\u65b9\u6cd5\uff0c\u5bf9\u4e0d\u540c\u7684\u53ef\u80fd\u6027\u505a\u6392\u9664\uff0c\u627e\u5230\u771f\u6b63\u7684\u90a3\u4e00\u4e2a\u3002\u5982\u679c\u4e0d\u80fd\u6392\u9664\u5230\u53ea\u5269\u4e00\u4e2a\u53ef\u80fd\uff0c\u6216\u8005\u5168\u90e8\u53ef\u80fd\u90fd\u88ab\u6392\u9664\u6389\uff0c\u8bf4\u660e\u5b9e\u9645\u7684\u5fae\u67b6\u6784\u8bbe\u8ba1\u548c\u9884\u671f\u4e0d\u76f8\u7b26\u3002</p>\n<p>\u7b2c\u4e00\u90e8\u5206\u542b\u4e49\uff0c\u76ee\u524d\u5df2\u7ecf\u6709\u5927\u91cf\u7684\u6210\u719f\u7684 Microbenchmark\uff08\u9488\u5bf9\u5fae\u67b6\u6784 Microarchitecture \u8bbe\u8ba1\u7684 Benchmark\uff0c\u53eb\u505a Microbenchmark\uff09\u6765\u89e3\u51b3\uff0c\u5b83\u4eec\u9488\u5bf9\u5e38\u89c1\u7684\u5fae\u67b6\u6784\u8bbe\u8ba1\uff0c\u5b9e\u73b0\u4e86\u5bf9\u76f8\u5e94\u8bbe\u8ba1\u53c2\u6570\u7684\u9006\u5411\u7684 Microbenchmark\uff0c\u53ef\u4ee5\u5728\u5f88\u591a\u5e73\u53f0\u4e0a\u76f4\u63a5\u4f7f\u7528\u3002\u7b2c\u4e8c\u90e8\u5206\u542b\u4e49\uff0c\u76ee\u524d\u8fd8\u53ea\u80fd\u9010\u4e2a\u5206\u6790\uff0c\u53bb\u731c\u6d4b\u80cc\u540e\u7684\u8bbe\u8ba1\uff0c\u518d\u6839\u636e\u8bbe\u8ba1\u53bb\u6784\u9020\u5bf9\u5e94\u8be5\u8bbe\u8ba1\u7684 Microbenchmark\u3002</p>\n<p>\u4e0b\u9762\u4e3b\u8981\u6765\u4ecb\u7ecd\uff0c\u8bbe\u8ba1\u548c\u5b9e\u73b0 Microbenchmark \u7684\u65b9\u6cd5\u5b66\u3002</p>\n<h2 id=\"\u539f\u7406\">\u539f\u7406<a class=\"headerlink\" href=\"#\u539f\u7406\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u8981\u4e86\u89e3 Microbenchmark \u7684\u539f\u7406\uff0c\u5b83\u7684\u6838\u5fc3\u601d\u8def\u5c31\u662f\uff0c\u901a\u8fc7\u6784\u9020\u7a0b\u5e8f\uff0c\u8ba9\u67d0\u4e2a\u5fae\u67b6\u6784\u90e8\u4ef6\u6210\u4e3a\u74f6\u9888\uff0c\u63a5\u7740\u5728\u60f3\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u7684\u7ef4\u5ea6\u4e0a\u8fdb\u884c\u626b\u63cf\uff0c\u901a\u8fc7\u67d0\u79cd\u6307\u6807\u6765\u53cd\u6620\u662f\u5426\u51fa\u73b0\u4e86\u74f6\u9888\uff0c\u901a\u8fc7\u74f6\u9888\u5bf9\u5e94\u7684\u8bbe\u8ba1\u53c2\u6570\uff0c\u5c31\u53ef\u4ee5\u9006\u5411\u51fa\u6765\u8bbe\u8ba1\u53c2\u6570\u7684\u53d6\u503c\u3002\u8fd9\u4e00\u6bb5\u6709\u70b9\u96be\u7406\u89e3\uff0c\u4e0b\u9762\u7ed9\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<p>\u6bd4\u5982\u8981\u6d4b\u8bd5\u7684\u662f L1 DCache \u7684\u5bb9\u91cf\uff0c\u90a3\u5c31\u5e0c\u671b L1 DCache \u7684\u5bb9\u91cf\u53d8\u6210\u74f6\u9888\u3002\u4e3a\u4e86\u8ba9\u5b83\u6210\u4e3a\u74f6\u9888\uff0c\u90a3\u5c31\u9700\u8981\u4e0d\u65ad\u5730\u8bbf\u95ee\u4e00\u7247\u5185\u5b58\uff0c\u5b83\u7684\u5927\u5c0f\u6bd4 L1 DCache \u8981\u66f4\u5927\uff0c\u8ba9 L1 DCache \u65e0\u6cd5\u5b8c\u6574\u4fdd\u5b58\u4e0b\u6765\uff0c\u51fa\u73b0\u7f13\u5b58\u7f3a\u5931\u3002\u4e3a\u4e86\u5224\u65ad\u7f13\u5b58\u7f3a\u5931\u662f\u5426\u51fa\u73b0\uff0c\u53ef\u4ee5\u901a\u8fc7\u65f6\u95f4\u6216\u5468\u671f\uff0c\u56e0\u4e3a\u7f13\u5b58\u7f3a\u5931\u80af\u5b9a\u4f1a\u5e26\u6765\u6027\u80fd\u635f\u5931\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u7f13\u5b58\u7f3a\u5931\u7684\u6027\u80fd\u8ba1\u6570\u5668\u3002\u65e2\u7136\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u662f L1 DCache \u7684\u5bb9\u91cf\uff0c\u90a3\u5c31\u5728\u5bb9\u91cf\u4e0a\u8fdb\u884c\u4e00\u4e2a\u626b\u63cf\uff1a\u5728\u5185\u5b58\u4e2d\u5f00\u8f9f\u4e0d\u540c\u5927\u5c0f\u7684\u6570\u7ec4\uff0c\u6bd4\u5982\u4e00\u4e2a\u662f 32KB\uff0c\u53e6\u4e00\u4e2a\u662f 64KB\uff0c\u6bcf\u6b21\u6d4b\u8bd5\u7684\u65f6\u5019\u53ea\u8bbf\u95ee\u5176\u4e2d\u4e00\u4e2a\u6570\u7ec4\u3002\u6bcf\u4e2a\u6570\u7ec4\u626b\u63cf\u8bbf\u95ee\u82e5\u5e72\u6b21\uff0c\u7136\u540e\u7edf\u8ba1\u603b\u65f6\u95f4\u6216\u5468\u671f\u6570\u6216\u7f13\u5b58\u7f3a\u5931\u6b21\u6570\u3002\u5047\u5982\u5b9e\u9645 L1 DCache \u5bb9\u91cf\u4ecb\u4e8e 32KB \u548c 64KB \u4e4b\u95f4\uff0c\u90a3\u4e48\u5e94\u8be5\u53ef\u4ee5\u89c2\u5bdf\u5230 64KB \u6570\u7ec4\u5927\u5c0f\u6d4b\u5f97\u7684\u6027\u80fd\u76f8\u6bd4 32KB \u6709\u660e\u663e\u4e0b\u964d\u3002\u5982\u679c\u628a\u6d4b\u8bd5\u7c92\u5ea6\u53d8\u7ec6\uff0c\u6bcf 1KB \u8bbe\u7f6e\u4e00\u4e2a\u6570\u7ec4\u5927\u5c0f\uff0c\u6700\u7ec8\u5c31\u53ef\u4ee5\u786e\u5b9a\u5b9e\u9645\u7684 L1 DCache \u5bb9\u91cf\u3002</p>\n<p>\u5728\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u6210\u4e3a\u74f6\u9888\u7684\u5fae\u67b6\u6784\u90e8\u4ef6\u662f L1 DCache\uff0c\u60f3\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u662f\u5b83\u7684\u5bb9\u91cf\uff0c\u53cd\u6620\u662f\u5426\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u6027\u80fd\u6216\u7f13\u5b58\u7f3a\u5931\u6b21\u6570\uff0c\u6784\u9020\u7684\u7a0b\u5e8f\u505a\u7684\u4e8b\u60c5\u662f\u4e0d\u65ad\u5730\u8bbf\u95ee\u4e00\u4e2a\u53ef\u53d8\u5927\u5c0f\u7684\u6570\u7ec4\uff0c\u5176\u4e2d\u6570\u7ec4\u5927\u5c0f\u548c\u60f3\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u662f\u6302\u94a9\u7684\u3002</p>\n<p>\u56e0\u6b64\u53ef\u4ee5\u603b\u7ed3\u51fa Microbenchmark \u8bbe\u8ba1\u7684\u51e0\u4e2a\u8981\u7d20\uff1a</p>\n<ol>\n<li>\u9488\u5bf9\u4ec0\u4e48\u5fae\u67b6\u6784\u90e8\u4ef6</li>\n<li>\u9488\u5bf9\u8be5\u90e8\u4ef6\u7684\u4ec0\u4e48\u8bbe\u8ba1\u53c2\u6570</li>\n<li>\u53cd\u6620\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u4ec0\u4e48</li>\n<li>\u5982\u4f55\u6784\u9020\u7a0b\u5e8f\u6765\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0</li>\n<li>\u7a0b\u5e8f\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0</li>\n<li>\u7a0b\u5e8f\u7684\u53c2\u6570\u5982\u4f55\u5bf9\u5e94\u5230\u8bbe\u8ba1\u53c2\u6570\u4e0a</li>\n</ol>\n<p>\u6bd4\u5982\u4e0a\u9762\u7684 L1 DCache \u5bb9\u91cf\u7684\u6d4b\u8bd5\u4e0a\uff0c\u8fd9\u51e0\u4e2a\u8981\u7d20\u7684\u56de\u7b54\u662f\uff1a</p>\n<ol>\n<li>\u9488\u5bf9\u4ec0\u4e48\u5fae\u67b6\u6784\u90e8\u4ef6\uff1aL1 DCache</li>\n<li>\u9488\u5bf9\u8be5\u90e8\u4ef6\u7684\u4ec0\u4e48\u8bbe\u8ba1\u53c2\u6570\uff1aL1 DCache \u7684\u5bb9\u91cf</li>\n<li>\u53cd\u6620\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u4ec0\u4e48\uff1a\u65f6\u95f4\uff0c\u5468\u671f\u6570\uff0c\u7f13\u5b58\u7f3a\u5931\u6b21\u6570</li>\n<li>\u5982\u4f55\u6784\u9020\u7a0b\u5e8f\u6765\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u5728\u5185\u5b58\u4e2d\u5f00\u8f9f\u6570\u7ec4\uff0c\u7136\u540e\u4e0d\u65ad\u5730\u626b\u63cf\u8bbf\u95ee</li>\n<li>\u7a0b\u5e8f\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u6570\u7ec4\u5927\u5c0f\u8d85\u8fc7 L1 DCache \u5bb9\u91cf</li>\n<li>\u7a0b\u5e8f\u7684\u53c2\u6570\u5982\u4f55\u5bf9\u5e94\u5230\u8bbe\u8ba1\u53c2\u6570\u4e0a\uff1a\u6570\u7ec4\u7684\u5927\u5c0f\u5bf9\u5e94\u5230 L1 DCache \u7684\u5bb9\u91cf</li>\n</ol>\n<p>\u5047\u5982\u8981\u8bbe\u8ba1\u4e00\u4e2a\u9488\u5bf9 ROB(ReOrder Buffer) \u5bb9\u91cf\u7684\u6d4b\u8bd5\uff0c\u601d\u8003\u540c\u6837\u7684\u8981\u7d20\uff1a</p>\n<ol>\n<li>\u9488\u5bf9\u4ec0\u4e48\u5fae\u67b6\u6784\u90e8\u4ef6\uff1aROB</li>\n<li>\u9488\u5bf9\u8be5\u90e8\u4ef6\u7684\u4ec0\u4e48\u8bbe\u8ba1\u53c2\u6570\uff1aROB \u80fd\u5bb9\u7eb3\u591a\u5c11\u6761\u6307\u4ee4</li>\n<li>\u53cd\u6620\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u4ec0\u4e48\uff1a\u65f6\u95f4\uff0c\u5468\u671f\u6570</li>\n<li>\u5982\u4f55\u6784\u9020\u7a0b\u5e8f\u6765\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u5728 ROB \u5f00\u5934\u548c\u7ed3\u5c3e\u5404\u653e\u4e00\u6761\u957f\u5ef6\u8fdf\u6307\u4ee4\uff0c\u4e2d\u95f4\u586b\u5145\u82e5\u5e72\u6761\u6307\u4ee4</li>\n<li>\u7a0b\u5e8f\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u5982\u679c\u6307\u4ee4\u586b\u5145\u5f97\u8db3\u591f\u591a\uff0c\u5bfc\u81f4\u7ed3\u5c3e\u7684\u957f\u5ef6\u8fdf\u6307\u4ee4\u4e0d\u80fd\u8fdb\u5165 ROB\uff0c\u90a3\u4e48\u5b83\u65e0\u6cd5\u88ab\u9884\u6d4b\u6267\u884c</li>\n<li>\u7a0b\u5e8f\u7684\u53c2\u6570\u5982\u4f55\u5bf9\u5e94\u5230\u8bbe\u8ba1\u53c2\u6570\u4e0a\uff1a\u628a\u7ed3\u5c3e\u7684\u957f\u5ef6\u8fdf\u6307\u4ee4\u963b\u62e6\u5728 ROB \u4e4b\u5916\u65f6\uff0c\u5728 ROB \u4e2d\u7684\u6307\u4ee4\u6570</li>\n</ol>\n<p>\u601d\u8003\u660e\u767d\u8fd9\u4e9b\u8981\u7d20\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u600e\u4e48\u8bbe\u8ba1\u51fa\u4e00\u4e2a Microbenchmark \u4e86\u3002</p>\n<p>\u539f\u7406\u4ecb\u7ecd\u5b8c\u4e86\uff0c\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u7528\u7684\u65b9\u6cd5\u3002</p>\n<h2 id=\"\u6307\u6807\u7684\u83b7\u53d6\">\u6307\u6807\u7684\u83b7\u53d6<a class=\"headerlink\" href=\"#\u6307\u6807\u7684\u83b7\u53d6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0a\u9762\u63d0\u5230\uff0c\u4e3a\u4e86\u53cd\u6620\u51fa\u74f6\u9888\uff0c\u9700\u8981\u6709\u4e00\u4e2a\u6307\u6807\uff0c\u5b83\u6700\u597d\u80fd\u591f\u7cbe\u786e\u5730\u53cd\u6620\u51fa\u74f6\u9888\u7684\u53d1\u751f\u4e0e\u5426\uff0c\u540c\u65f6\u4e5f\u5c3d\u91cf\u8981\u51cf\u5c11\u566a\u58f0\u3002\u80fd\u7528\u7684\u6307\u6807\u4e0d\u591a\uff0c\u53ea\u6709\u4e24\u7c7b\uff1a</p>\n<ol>\n<li>\u65f6\u95f4\uff1a\u6700\u901a\u7528\uff0c\u6240\u6709\u5e73\u53f0\u90fd\u53ef\u4ee5\u7528\uff0c\u5728\u7a0b\u5e8f\u524d\u540e\u5404\u8bb0\u4e00\u6b21\u65f6\u95f4\uff0c\u53d6\u5dee</li>\n<li>\u6027\u80fd\u8ba1\u6570\u5668\uff1a\u4f7f\u7528\u8d77\u6765\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6709\u65f6\u9700\u8981 root \u6743\u9650\uff0c\u6216\u8005\u786c\u4ef6\u76f8\u5173\u4fe1\u606f\u4e0d\u516c\u5f00\uff0c\u53c8\u6216\u8005\u786c\u4ef6\u5c31\u6ca1\u6709\u5b9e\u73b0\u5bf9\u5e94\u7684\u6027\u80fd\u8ba1\u6570\u5668\u3002\u5404\u5e73\u53f0\u6027\u80fd\u8ba1\u6570\u5668\u53ef\u7528\u60c5\u51b5\uff1a<ol>\n<li>Windows\uff1a\u53ef\u7528\uff0c\u6709\u73b0\u6210 <a href=\"https://learn.microsoft.com/en-us/windows/win32/perfctrs/performance-counters-portal\">API</a></li>\n<li>macOS\uff1a\u53ef\u7528\uff0c<a href=\"https://gist.github.com/ibireme/173517c208c7dc333ba962c1f0d67d12\">\u6709\u9006\u5411\u51fa\u6765\u7684\u79c1\u6709\u6846\u67b6 API</a></li>\n<li>Linux\uff1a\u53ef\u7528\uff0c<a href=\"https://man7.org/linux/man-pages/man2/perf_event_open.2.html\">\u6709\u73b0\u6210 API</a></li>\n<li>iOS\uff1a\u5728 iOS \u5916\u53ef\u4ee5\u901a\u8fc7 Xcode Instruments \u8bbf\u95ee\u6240\u6709 PMU\uff0c\u4f46\u4e0d\u65b9\u4fbf\u81ea\u52a8\u5316\uff1b\u5728 iOS \u5185\u53ea\u80fd\u901a\u8fc7 <a href=\"https://github.com/Androp0v/PowerMetricsKit/blob/3be0fd2d61785d848a32b6f5ea59aacad7739909/Sources/SampleThreads/sample_threads.c#L23\">PROC_PIDTHREADCOUNTS</a> \u83b7\u5f97\u5468\u671f\u6570\u548c\u6307\u4ee4\u6570</li>\n<li>Android\uff1a\u9700\u8981 root \u6216\u901a\u8fc7 adb shell \u4f7f\u7528\uff0c\u6bd4\u8f83\u9ebb\u70e6\uff0c<a href=\"https://man7.org/linux/man-pages/man2/perf_event_open.2.html\">API</a> \u548c Linux \u4e00\u6837</li>\n<li>HarmonyOS NEXT\uff1a\u6ca1\u627e\u5230\u65b9\u6848</li>\n</ol>\n</li>\n</ol>\n<p>\u867d\u7136\u6d4b\u65f6\u95f4\u6700\u7b80\u5355\u4e5f\u6700\u901a\u7528\uff0c\u4f46\u5b83\u4f1a\u53d7\u5230\u9891\u7387\u6ce2\u52a8\u7684\u9650\u5236\uff0c\u5982\u679c\u5728\u8fd0\u884c\u6d4b\u8bd5\u7684\u65f6\u5019\uff0c\u9891\u7387\u5267\u70c8\u53d8\u5316\uff08\u7279\u522b\u662f\u624b\u673a\u5e73\u53f0\uff09\uff0c\u5f15\u5165\u4e86\u5927\u91cf\u566a\u58f0\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6709\u6548\u4fe1\u606f\u88ab\u6df9\u6ca1\u5728\u566a\u58f0\u5f53\u4e2d\u3002</p>\n<p>\u5176\u4e2d\u6027\u80fd\u8ba1\u6570\u5668\u662f\u6700\u4e3a\u7cbe\u786e\u7684\uff0c\u867d\u7136\u4f7f\u7528\u8d77\u6765\u8f83\u4e3a\u9ebb\u70e6\uff0c\u4f46\u4e5f\u786e\u5b9e\u652f\u6491\u4e86\u5f88\u591a\u66f4\u6df1\u5165\u7684 CPU \u5fae\u67b6\u6784\u7684\u9006\u5411\u3002\u5e0c\u671b\u786c\u4ef6\u5382\u5546\u770b\u5230\u8fd9\u7bc7\u6587\u7ae0\uff0c\u4e0d\u8981\u4e3a\u4e86\u907f\u514d\u9006\u5411\u628a\u6027\u80fd\u8ba1\u6570\u5668\u85cf\u8d77\u6765\uff1a\u56e0\u4e3a\u5b83\u5bf9\u4e8e\u5e94\u7528\u7684\u6027\u80fd\u5206\u6790\u771f\u7684\u5f88\u6709\u7528\u3002\u5177\u4f53\u600e\u4e48\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u53ef\u4ee5\u53c2\u8003\u4e00\u4e9b\u73b0\u6210\u7684 Microbenchmark \u6846\u67b6\u3002</p>\n<p>\u5728\u6709\u5f02\u6784\u6838\u7684\u5904\u7406\u5668\u4e0a\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6d4b\u8bd5\u7684\u662f\u9884\u671f\u5fae\u67b6\u6784\u7684\u6838\u5fc3\uff0c\u4e00\u822c\u8fd8\u4f1a\u914d\u5408\u7ed1\u6838\uff0c\u7ed1\u6838\u5728\u9664\u4e86 macOS \u548c iOS \u4ee5\u5916\u7684\u7cfb\u7edf\u90fd\u53ef\u4ee5\u76f4\u63a5\u6307\u5b9a\u7ed1\u54ea\u4e2a\u6838\u5fc3\uff0c\u800c macOS \u548c iOS \u53ea\u80fd\u901a\u8fc7\u6307\u5b9a QoS \u6765\u5efa\u8bae\u8c03\u5ea6\u5668\u8c03\u5ea6\u5230 P \u6838\u8fd8\u662f E\u6838\uff0c\u9996\u5148\u662f\u4e0d\u80fd\u786e\u5b9a\u662f\u54ea\u4e2a P \u6838\u6216\u54ea\u4e2a E \u6838\uff0c\u5176\u6b21\u8fd9\u53ea\u662f\u4e2a\u5efa\u8bae\uff0c\u5e76\u975e\u5f3a\u5236\u3002</p>\n<h2 id=\"\u5957\u8def\">\u5957\u8def<a class=\"headerlink\" href=\"#\u5957\u8def\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u4ecb\u7ecd\u4e00\u4e9b\u6784\u9020\u74f6\u9888\u7684\u4e00\u4e9b\u5e38\u89c1\u5957\u8def\uff1a</p>\n<ol>\n<li>\u6d4b\u8bd5\u5bb9\u91cf\uff08\u6bd4\u5982\u5404\u7ea7 I/D Cache \u548c TLB\uff09\uff1a\u6784\u9020\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u53bb\u628a\u5bb9\u91cf\u7528\u6ee1\uff0c\u5f53\u5bb9\u91cf\u88ab\u7528\u6ee1\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u89c2\u5bdf\u5230\u6027\u80fd\u4e0b\u964d</li>\n<li>\u6d4b\u8bd5\u5fae\u67b6\u6784\u961f\u5217\u6216 Buffer \u6df1\u5ea6\uff08\u6bd4\u5982 ROB\uff0c\u5bc4\u5b58\u5668\u5806\uff0c\u8c03\u5ea6\u961f\u5217\uff09\uff1a\u5728\u961f\u5217\u5f00\u5934\u901a\u8fc7\u6307\u4ee4\u5835\u4f4f\u961f\u5217\u7684\u51fa\u961f\uff0c\u63a5\u7740\u4e0d\u65ad\u5730\u5411\u961f\u5217\u4e2d\u5165\u961f\u65b0\u7684\u6307\u4ee4\uff0c\u5f53\u961f\u5217\u6ee1\u7684\u65f6\u5019\uff0c\u4e0d\u518d\u80fd\u591f\u5165\u961f\u65b0\u7684\u6307\u4ee4\uff0c\u6b64\u65f6\u518d\u5f15\u5165\u4e00\u4e9b\u539f\u6765\u4e0d\u4f1a\u88ab\u5835\u4f4f\u7684\u6307\u4ee4\uff0c\u73b0\u5728\u56e0\u4e3a\u961f\u5217\u88ab\u5835\u4f4f\u4e86\u800c\u8fdb\u4e0d\u53bb\uff0c\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d</li>\n<li>\u6d4b\u8bd5\u7ec4\u76f8\u8fde\u7ed3\u6784\uff08\u6bd4\u5982 BTB\uff0cCache \u7b49\u7ec4\u76f8\u8fde\u7ed3\u6784\uff09\uff1a\u7ec4\u76f8\u8fde\u7ed3\u6784\u4e0b\uff0c\u6bcf\u4e2a Index \u5185\u7684\u5bb9\u91cf\u662f\u56fa\u5b9a\u7684\uff0c\u901a\u8fc7\u6d4b\u8bd5\u5bb9\u91cf\uff0c\u53ef\u4ee5\u5f97\u5230\u6709\u591a\u5c11 Index \u88ab\u8986\u76d6\u4e86\uff0c\u5982\u679c\u901a\u8fc7\u4fee\u6539 Index \u51fd\u6570\u7684\u8f93\u5165\uff08\u6bd4\u5982 PC\uff09\uff0c\u4f7f\u5f97\u67d0\u4e9b Index \u65e0\u6cd5\u88ab\u8bbf\u95ee\u5230\uff0c\u5c31\u53ef\u4ee5\u89c2\u5bdf\u5230\u5bb9\u91cf\u4e0a\u7684\u51cf\u5c11\uff0c\u5e76\u4e14\u5b9e\u9645\u5bb9\u91cf\u4e5f\u53cd\u9988\u51fa\u4e86\u8fd8\u6709\u591a\u5c11 Index \u80fd\u591f\u88ab\u8bbf\u95ee\u5230\u7684\u4fe1\u606f</li>\n<li>\u6784\u9020 pointer chasing\uff1a\u4ee5 8B(\u5bf9\u5e94 64 \u4f4d\u6307\u9488)\u3001\u7f13\u5b58\u884c\u5927\u5c0f\u6216\u9875\u5927\u5c0f\u4e3a\u7c92\u5ea6\uff0c\u8fdb\u884c\u968f\u673a\u6253\u4e71\uff0c\u7136\u540e\u628a\u5b83\u4eec\u7528\u6307\u9488\u4e32\u8054\u8d77\u6765\uff0c\u524d\u4e00\u4e2a\u6307\u9488\u6307\u5411\u7684\u5185\u5b58\u4e2d\u4fdd\u5b58\u540e\u4e00\u4e2a\u6307\u9488\u7684\u5730\u5740</li>\n<li>\u6784\u9020\u957f\u5ef6\u8fdf\u6307\u4ee4\uff1a\u5728\u6d4b\u8bd5\u6307\u4ee4\u961f\u5217\u76f8\u5173\u7684\u573a\u666f\u4e0b\u5e38\u7528\uff0c\u901a\u5e38\u53ef\u4ee5\u7528 pointer chasing long latency load \u6216\u8005\u4e00\u6bb5\u5177\u6709\u4e32\u884c\u4f9d\u8d56\u7684\u6d6e\u70b9\u9664\u6cd5\u6216\u5f00\u6839\u6307\u4ee4\u6765\u5b9e\u73b0</li>\n</ol>\n<p>\u518d\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u89c1\u7684\u5751\uff1a</p>\n<ol>\n<li>\u5c3d\u91cf\u7528\u6c47\u7f16\u6765\u6784\u9020\u6d4b\u4f8b\uff0cC/C++ \u7f16\u8bd1\u5668\u53ef\u80fd\u4f1a\u5e26\u6765\u4e0d\u671f\u671b\u7684\u884c\u4e3a</li>\n<li>\u94fe\u63a5\u5668\u6709\u4e00\u4e9b\u884c\u4e3a\u53ef\u80fd\u662f\u9700\u8981\u907f\u514d\u7684\uff0c\u4f8b\u5982\u5b83\u53ef\u80fd\u4f1a\u4fee\u6539\u4e00\u4e9b\u6307\u4ee4</li>\n<li>\u94fe\u63a5\u5668\u8fd8\u53ef\u80fd\u6709\u4e00\u4e9b\u5c40\u9650\u6027\uff0c\u4f8b\u5982\u5b83\u4e0d\u652f\u6301\u5de8\u5927\u7684\u5bf9\u9f50</li>\n<li>Linux \u5185\u6838\u4f1a\u505a\u4f18\u5316\uff0c\u4f8b\u5982 Copy-on-Write \u548c Transparent Huge Page</li>\n</ol>\n<h2 id=\"\u73b0\u6210-microbenchmark\">\u73b0\u6210 Microbenchmark<a class=\"headerlink\" href=\"#\u73b0\u6210-microbenchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5b9e\u9645\u4e0a\uff0c\u73b0\u5728\u5df2\u7ecf\u6709\u5f88\u591a\u73b0\u6210\u7684 Microbenchmark\uff0c\u4ee5\u53ca\u4e00\u4e9b\u8bb0\u5f55\u4e86 Microbenchmark \u7684\u6587\u6863\uff1a</p>\n<ul>\n<li><a href=\"https://www.agner.org/optimize/\">https://www.agner.org/optimize/</a></li>\n<li><a href=\"https://github.com/clamchowder/Microbenchmarks/\">https://github.com/clamchowder/Microbenchmarks/</a></li>\n<li><a href=\"https://github.com/JamesAslan/MicroArchBench\">https://github.com/JamesAslan/MicroArchBench</a></li>\n<li><a href=\"https://github.com/name99-org/AArch64-Explore\">https://github.com/name99-org/AArch64-Explore</a></li>\n<li><a href=\"https://github.com/jiegec/cpu-micro-benchmarks\">https://github.com/jiegec/cpu-micro-benchmarks</a></li>\n</ul>\n<p>\u4ee5\u53ca\u4e00\u4e9b\u7528 Microbenchmark \u505a\u9006\u5411\u5e76\u516c\u5f00\u7684\u7f51\u7ad9\uff1a</p>\n<ul>\n<li><a href=\"https://chipsandcheese.com\">https://chipsandcheese.com</a></li>\n<li><a href=\"https://www.anandtech.com\">https://www.anandtech.com</a>\uff08\u53ef\u60dc\u4e0d\u518d\u66f4\u65b0\uff09</li>\n<li><a href=\"https://blog.hjc.im/\">https://blog.hjc.im/</a></li>\n<li><a href=\"https://www.zhihu.com/people/jamesaslan\">https://www.zhihu.com/people/jamesaslan</a></li>\n<li><a href=\"https://uops.info\">https://uops.info</a></li>\n<li>\u672c\u535a\u5ba2</li>\n</ul>\n<p>\u5982\u679c\u4f60\u60f3\u8981\u53bb\u9006\u5411\u67d0\u4e2a\u5fae\u67b6\u6784\u7684\u67d0\u4e2a\u90e8\u4ef6\uff0c\u4f46\u4e0d\u77e5\u9053\u600e\u4e48\u505a\uff0c\u4e0d\u59a8\u5728\u4e0a\u9762\u8fd9\u4e9b\u7f51\u7ad9\u4e0a\u5bfb\u627e\u4e00\u4e0b\uff0c\u662f\u4e0d\u662f\u5df2\u7ecf\u6709\u73b0\u6210\u7684\u5b9e\u73b0\u4e86\u3002</p>\n<p>\u5982\u679c\u4f60\u5bf9\u5982\u4f55\u7f16\u5199\u8fd9\u4e9b Microbenchmark \u4e0d\u611f\u5174\u8da3\uff0c\u4e5f\u53ef\u4ee5\u8bd5\u8bd5\u5728\u81ea\u5df1\u7535\u8111\u4e0a\u8fd0\u884c\u8fd9\u4e9b\u7a0b\u5e8f\uff0c\u6216\u8005\u76f4\u63a5\u9605\u8bfb\u5df2\u6709\u7684\u5206\u6790\u3002</p>", "image": null, "date_published": "2024-12-27T00:00:00+00:00", "authors": [], "tags": ["cpu", "hardware", "uarch-review"]}, {"id": "https://jia.je/hardware/2024/12/26/apple_m1/", "url": "https://jia.je/hardware/2024/12/26/apple_m1/", "title": "Apple M1 \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"apple-m1-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Apple M1 \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#apple-m1-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u867d\u7136 Apple M1 \u5df2\u7ecf\u662f 2020 \u5e74\u7684\u5904\u7406\u5668\uff0c\u4f46\u5b83\u5bf9\u82f9\u679c\u81ea\u7814\u82af\u7247\u6765\u8bf4\u662f\u4e00\u4e2a\u91cc\u7a0b\u7891\uff0c\u8003\u8651\u5230 X Elite \u5904\u7406\u5668\u7684 Oryon \u5fae\u67b6\u6784\u548c Apple M1 \u6027\u80fd\u6838 Firestorm \u5fae\u67b6\u6784\u7684\u76f8\u4f3c\u6027\uff0c\u8fd8\u662f\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a Firestorm + Icestorm \u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>Apple M1 \u7684\u5b98\u65b9\u4fe1\u606f\u4e4f\u5584\u53ef\u9648\uff0c\u5173\u4e8e\u5fae\u67b6\u6784\u7684\u4fe1\u606f\u51e0\u4e4e\u4e3a\u96f6\uff0c\u4f46\u80fd\u4ece\u64cd\u4f5c\u7cfb\u7edf\u6c47\u62a5\u7684\u786c\u4ef6\u4fe1\u606f\u4e2d\u627e\u5230\u4e00\u4e9b\u5185\u5bb9\u3002</p>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Apple M1 \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://dougallj.github.io/applecpu/firestorm.html\">Apple Microarchitecture Research by Dougall Johnson</a></li>\n<li><a href=\"https://www.anandtech.com/show/16226/apple-silicon-m1-a14-deep-dive\">Apple Announces The Apple Silicon M1: Ditching x86 - What to Expect, Based on A14 - Anandtech</a></li>\n<li><a href=\"https://github.com/name99-org/AArch64-Explore\">Exploration of Apple CPUs</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/611213899\">Apple M1 Icestorm \u5fae\u67b6\u6784\u8bc4\u6d4b\uff08\u4e0a\uff09:\u91cd\u94f8\u5c0f\u6838\u8363\u5149</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/613097964\">Apple M1 Icestorm \u5fae\u67b6\u6784\uff08\u4e0b\uff09:\u91cd\u94f8\u5c0f\u6838\u8363\u5149</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/595582920\">\u82f9\u679c\u7684\u9ed1\u9b54\u6cd5\uff1fApple M1 \u7684\u6808\u64cd\u4f5c\u6d88\u9664\uff08\u4e0a\uff09</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/600349467\">\u82f9\u679c\u7684\u9ed1\u9b54\u6cd5\uff1f\uff08\u4e0b\uff09Apple M1 \u7684\u6808\u64cd\u4f5c\u6d88\u9664</a></li>\n<li><a href=\"https://github.com/dougallj/applecpu\">Apple Firestorm/Icestorm CPU microarchitecture docs</a></li>\n<li><a href=\"https://www.anandtech.com/show/16252/mac-mini-apple-m1-tested\">The 2020 Mac Mini Unleashed: Putting Apple Silicon M1 To The Test</a></li>\n<li><a href=\"https://github.com/name99-org/AArch64-Explore\">Exploration of Apple CPUs</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Apple Firestorm \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002Apple Icestorm \u5c1a\u672a\u8fdb\u884c\u6027\u80fd\u6d4b\u8bd5\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u53d6\u6307\">\u53d6\u6307<a class=\"headerlink\" href=\"#\u53d6\u6307\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u5b9e\u9645\u7684 Fetch \u5bbd\u5ea6\uff0c\u53c2\u8003 <a href=\"https://zhuanlan.zhihu.com/p/720136752\">\u5982\u4f55\u6d4b\u91cf\u771f\u6b63\u7684\u53d6\u6307\u5e26\u5bbd\uff08I-fetch width\uff09 - JamesAslan</a> \u6784\u9020\u4e86\u6d4b\u8bd5\u3002\u5176\u539f\u7406\u662f\u5f53 Fetch \u8981\u8de8\u9875\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u4e24\u4e2a\u76f8\u90bb\u9875\u53ef\u80fd\u6620\u5c04\u5230\u4e0d\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u5982\u679c\u8981\u652f\u6301\u5355\u5468\u671f\u8de8\u9875\u53d6\u6307\uff0c\u9700\u8981\u67e5\u8be2\u4e24\u6b21 ITLB\uff0c\u6216\u8005 ITLB \u9700\u8981\u628a\u76f8\u90bb\u4e24\u4e2a\u9875\u7684\u6620\u5c04\u5b58\u5728\u4e00\u8d77\u3002\u8fd9\u4e2a\u573a\u666f\u4e00\u822c\u6bd4\u8f83\u5c11\uff0c\u5904\u7406\u5668\u5f88\u5c11\u4f1a\u9488\u5bf9\u8fd9\u79cd\u7279\u6b8a\u60c5\u51b5\u505a\u4f18\u5316\uff0c\u4f46\u4e5f\u4e0d\u662f\u6ca1\u6709\u3002\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u628a\u5faa\u73af\u653e\u5728\u4e24\u4e2a\u9875\u7684\u8fb9\u754c\u4e0a\uff0c\u53d1\u73b0 Firestorm \u5fae\u67b6\u6784\u9047\u5230\u8de8\u9875\u7684\u53d6\u6307\u65f6\u786e\u5b9e\u4f1a\u62c6\u6210\u4e24\u4e2a\u5468\u671f\u6765\u8fdb\u884c\u3002\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u5728\u7b2c\u4e00\u4e2a\u9875\u7684\u6700\u540e\u56db\u4e2a\u5b57\u8282\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u4e0a\uff0c\u90a3\u4e48\u6bcf\u6b21\u5faa\u73af\u7684\u53d6\u6307\u65f6\u95f4\uff0c\u5c31\u662f\u4e00\u4e2a\u5468\u671f\uff08\u8bfb\u53d6\u7b2c\u4e00\u4e2a\u9875\u5185\u7684\u6307\u4ee4\uff09\u52a0\u4e0a\u7b2c\u4e8c\u4e2a\u9875\u5185\u6307\u4ee4\u9700\u8981 Fetch \u7684\u5468\u671f\u6570\uff0c\u591a\u7684\u8fd9\u4e00\u4e2a\u5468\u671f\u5c31\u8db3\u4ee5\u628a Fetch \u5bbd\u5ea6\u4ece\u540e\u7aef\u9650\u5236\u4e2d\u533a\u5206\u5f00\uff0c\u5b9e\u9a8c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_if_width.png\" /></p>\n<p>\u56fe\u4e2d\u84dd\u7ebf\uff08cross-page\uff09\u8868\u793a\u7684\u5c31\u662f\u4e0a\u9762\u6240\u8ff0\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u4e00\u4e2a\u9875\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u7684\u60c5\u51b5\uff0c\u6a2a\u5750\u6807\u662f\u7b2c\u4e8c\u4e2a\u9875\u5185\u7684\u6307\u4ee4\u6570\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u7684\u6307\u4ee4\u6570\u7b49\u4e8e\u6a2a\u5750\u6807 +1\u3002\u7eb5\u5750\u6807\u662f\u8fd0\u884c\u5f88\u591a\u6b21\u5faa\u73af\u7684\u603b cycle \u6570\u9664\u4ee5\u5faa\u73af\u6b21\u6570\uff0c\u4e5f\u5c31\u662f\u5e73\u5747\u6bcf\u6b21\u5faa\u73af\u8017\u8d39\u7684\u5468\u671f\u6570\u3002\u53ef\u4ee5\u770b\u5230\u6bcf 16 \u6761\u6307\u4ee4\u4f1a\u591a\u4e00\u4e2a\u5468\u671f\uff0c\u56e0\u6b64 Firestorm \u7684\u524d\u7aef\u53d6\u6307\u5bbd\u5ea6\u786e\u5b9e\u662f 16 \u6761\u6307\u4ee4\u3002\u4e3a\u4e86\u786e\u8ba4\u8fd9\u4e2a\u74f6\u9888\u662f\u7531\u53d6\u6307\u9020\u6210\u7684\uff0c\u53c8\u6784\u9020\u4e86\u4e00\u7ec4\u5b9e\u9a8c\uff0c\u628a\u5faa\u73af\u7684\u6240\u6709\u6307\u4ee4\u90fd\u653e\u5230\u4e00\u4e2a\u9875\u4e2d\uff0c\u8fd9\u4e2a\u65f6\u5019 Fetch \u4e0d\u518d\u6210\u4e3a\u74f6\u9888\uff08\u56fe\u4e2d aligned\uff09\uff0c\u4e24\u4e2a\u66f2\u7ebf\u7684\u5bf9\u6bd4\u53ef\u4ee5\u660e\u786e\u5730\u5f97\u51fa\u4e0a\u8ff0\u7ed3\u8bba\u3002</p>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 Icestorm\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_if_width.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u6bcf 8 \u6761\u6307\u4ee4\u4f1a\u591a\u4e00\u4e2a\u5468\u671f\uff0c\u610f\u5473\u7740 Icestorm \u7684\u524d\u7aef\u53d6\u6307\u5bbd\u5ea6\u4e3a 8 \u6761\u6307\u4ee4\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0cFirestorm \u5177\u6709 192KB L1 ICache\uff0cIcestorm \u5177\u6709 128KB L1 ICache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>hw.perflevel0.l1icachesize: 196608\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>hw.perflevel1.l1icachesize: 131072\n</span></code></pre></div>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b Firestorm \u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 192 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 8 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2.22 IPC\uff0c\u8fd9\u91cc\u7684 192 KB \u5c31\u5bf9\u5e94\u4e86 Firestorm \u7684 L1 ICache \u7684\u5bb9\u91cf\u3002\u867d\u7136 Fetch \u53ef\u4ee5\u6bcf\u5468\u671f 16 \u6761\u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u4e00\u6761 64B \u7684\u7f13\u5b58\u884c\uff0c\u7531\u4e8e\u540e\u7aef\u7684\u9650\u5236\uff0c\u53ea\u80fd\u89c2\u5bdf\u5230 8 \u7684 IPC\u3002</p>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 Icestorm\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 128 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 4 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2.10 IPC\uff0c\u8fd9\u91cc\u7684 128 KB \u5c31\u5bf9\u5e94\u4e86 Icestorm \u7684 L1 ICache \u7684\u5bb9\u91cf\u3002\u867d\u7136 Fetch \u53ef\u4ee5\u6bcf\u5468\u671f 8 \u6761\u6307\u4ee4\uff0c\u7531\u4e8e\u540e\u7aef\u7684\u9650\u5236\uff0c\u53ea\u80fd\u89c2\u5bdf\u5230 4 \u7684 IPC\u3002</p>\n<h3 id=\"btb\">BTB<a class=\"headerlink\" href=\"#btb\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"firestorm\">Firestorm<a class=\"headerlink\" href=\"#firestorm\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u5927\u91cf\u7684\u65e0\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff08B \u6307\u4ee4\uff09\uff0cBTB \u9700\u8981\u8bb0\u5f55\u8fd9\u4e9b\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\uff0c\u90a3\u4e48\u5982\u679c\u5206\u652f\u6570\u91cf\u8d85\u8fc7\u4e86 BTB \u7684\u5bb9\u91cf\uff0c\u6027\u80fd\u4f1a\u51fa\u73b0\u660e\u663e\u4e0b\u964d\u3002\u5f53\u628a\u5927\u91cf B \u6307\u4ee4\u7d27\u5bc6\u653e\u7f6e\uff0c\u4e5f\u5c31\u662f\u6bcf 4 \u5b57\u8282\u4e00\u6761 B \u6307\u4ee4\u65f6\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_btb_4b.png\" /></p>\n<p>\u53ef\u89c1\u5728 1024 \u4e2a\u5206\u652f\u4e4b\u5185\u53ef\u4ee5\u8fbe\u5230 1 \u7684 CPI\uff0c\u8d85\u8fc7 1024 \u4e2a\u5206\u652f\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u5e73\u53f0\uff0c\u4e00\u76f4\u5ef6\u7eed\u5230 49152 \u4e2a\u5206\u652f\u3002\u8d85\u51fa BTB \u5bb9\u91cf\u4ee5\u540e\uff0c\u5206\u652f\u9884\u6d4b\u65f6\uff0c\u65e0\u6cd5\u4ece BTB \u4e2d\u5f97\u5230\u54ea\u4e9b\u6307\u4ee4\u662f\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u53ea\u80fd\u7b49\u5230\u53d6\u6307\u751a\u81f3\u8bd1\u7801\u540e\u624d\u80fd\u540e\u77e5\u540e\u89c9\u5730\u53d1\u73b0\u8fd9\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u8fd9\u6837\u5c31\u51fa\u73b0\u4e86\u6027\u80fd\u635f\u5931\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u60c5\u51b5\u3002\u7b2c\u4e8c\u4e2a\u62d0\u70b9 49152\uff0c\u5bf9\u5e94\u7684\u662f\u6307\u4ee4 footprint \u8d85\u51fa L1 ICache \u7684\u60c5\u51b5\uff1aL1 ICache \u662f 192KB\uff0c\u6309\u7167\u6bcf 4 \u5b57\u8282\u4e00\u4e2a B \u6307\u4ee4\u8ba1\u7b97\uff0c\u6700\u591a\u53ef\u4ee5\u5b58\u653e 49152 \u6761 B \u6307\u4ee4\u3002</p>\n<p>\u964d\u4f4e\u5206\u652f\u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u5728 B \u6307\u4ee4\u4e4b\u95f4\u63d2\u5165 NOP \u6307\u4ee4\uff0c\u4f7f\u5f97\u6bcf 8 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_btb_8b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 CPI=1 \u7684\u62d0\u70b9\u524d\u79fb\u5230 1024 \u4e2a\u5206\u652f\uff0c\u540c\u65f6 CPI=3 \u7684\u5e73\u53f0\u7684\u62d0\u70b9\u4e5f\u524d\u79fb\u5230\u4e86 24576\u3002\u62d0\u70b9\u7684\u524d\u79fb\uff0c\u610f\u5473\u7740 BTB \u91c7\u7528\u4e86\u7ec4\u76f8\u8fde\u7684\u7ed3\u6784\uff0c\u5f53 B \u6307\u4ee4\u7684 PC \u7684\u90e8\u5206\u4f4e\u4f4d\u603b\u662f\u4e3a 0 \u65f6\uff0c\u7ec4\u76f8\u8fde\u7684 Index \u53ef\u80fd\u65e0\u6cd5\u53d6\u5230\u6240\u6709\u7684 Set\uff0c\u5bfc\u81f4\u8868\u73b0\u51fa\u6765\u7684 BTB \u5bb9\u91cf\u53ea\u6709\u90e8\u5206 Set\uff0c\u4f8b\u5982\u6b64\u5904\u5bb9\u91cf\u51cf\u534a\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u534a\u7684 Set \u88ab\u7528\u5230\u4e86\u3002</p>\n<p>\u5982\u679c\u8fdb\u4e00\u6b65\u964d\u4f4e B \u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u4f7f\u5f97\u5b83\u7684\u4f4e\u82e5\u5e72\u4f4d\u90fd\u7b49\u4e8e 0\uff0c\u6700\u7ec8 CPI=1 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 2 \u6761\u5206\u652f\uff0c\u6b64\u65f6\u5206\u652f\u7684\u95f4\u8ddd\u5927\u4e8e\u6216\u7b49\u4e8e 2048B\uff1bCPI=3 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 6 \u6761\u5206\u652f\uff0c\u6b64\u65f6\u5206\u652f\u7684\u95f4\u8ddd\u5927\u4e8e\u6216\u7b49\u4e8e 32KB\u3002\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\uff0c\u53ef\u4ee5\u8ba4\u4e3a Firestorm \u7684 BTB \u662f 512 Set 2 Way \u7684\u7ed3\u6784\uff0cIndex \u662f PC[10:2]\uff1b\u540c\u65f6\u4e5f\u4fa7\u9762\u4f50\u8bc1\u4e86 192KB L1 ICache \u662f 512 Set 6 Way\uff0cIndex \u662f PC[14:6]\u3002</p>\n<h4 id=\"icestorm\">Icestorm<a class=\"headerlink\" href=\"#icestorm\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 Icestorm\uff0c\u9996\u5148\u7528 4B \u7684\u95f4\u8ddd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 1024 \u7684\u62d0\u70b9\uff0c1024 \u4e4b\u524d\u662f 1 IPC\uff0c\u4e4b\u540e\u589e\u52a0\u5230 3 IPC\u3002\u6bd4\u8f83\u5947\u602a\u7684\u662f\uff0c\u6ca1\u6709\u770b\u5230\u7b2c\u4e8c\u4e2a\u62d0\u70b9\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u5728 8B \u7684\u95f4\u8ddd\u4e0b\u663e\u73b0\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_8b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u524d\u79fb\u5230 512\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 16384\uff0c\u800c Icestorm \u7684 L1 ICache \u5bb9\u91cf\u662f 128KB\uff0c8B \u95f4\u8ddd\u4e0b\u6b63\u597d\u53ef\u4ee5\u4fdd\u5b58 16384 \u4e2a\u5206\u652f\u3002</p>\n<p>\u7528 16B \u95f4\u8ddd\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_16b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u524d\u79fb\u5230 256\uff0c\u7136\u540e\u51fa\u73b0\u4e86\u4e00\u4e2a 2 CPI \u7684\u65b0\u5e73\u53f0\uff0c2 CPI \u7684\u5e73\u53f0\u7684\u62d0\u70b9\u51fa\u73b0\u5728 2048\uff0c\u7b2c\u4e09\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 8192\uff0c\u5bf9\u5e94 L1 ICache \u5bb9\u91cf\u3002</p>\n<p>\u7528 32B \u95f4\u8ddd\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_32b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u5728 1024\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 4096\uff0c\u5bf9\u5e94 L1 ICache \u5bb9\u91cf\uff0c\u6ca1\u6709\u89c2\u5bdf\u5230 2 CPI\u3002</p>\n<p>\u7528 64B \u95f4\u8ddd\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_64b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u5728 512\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 2048\uff0c\u5bf9\u5e94 L1 ICache \u5bb9\u91cf\u3002</p>\n<p>Icestorm \u7684 BTB \u6d4b\u8bd5\u7ed3\u679c\u5e76\u4e0d\u50cf Firestorm \u90a3\u6837\u6709\u89c4\u5f8b\uff0c\u6839\u636e\u8fd9\u4e2a\u73b0\u8c61\uff0c\u7ed9\u51fa\u4e00\u4e9b\u731c\u6d4b\uff1a</p>\n<ol>\n<li>\u53ef\u80fd\u53ea\u6709\u4e00\u7ea7 BTB\uff0c\u4f46\u5b83\u7684 Index \u51fd\u6570\u8fdb\u884c\u4e86\u4e00\u4e9b Hash \u800c\u975e\u76f4\u63a5\u53d6 PC \u67d0\u51e0\u4f4d\uff0c\u4f7f\u5f97\u968f\u7740\u5206\u652f\u7684\u95f4\u8ddd\u589e\u5927\uff0cCPI=1 \u7684\u62d0\u70b9\u5e76\u975e\u5355\u8c03\u9012\u51cf\uff1b\u4f46\u8fd9\u65e0\u6cd5\u89e3\u91ca\u4e3a\u4f55 16B \u95f4\u8ddd\u65f6\u4f1a\u51fa\u73b0 2 CPI \u7684\u5e73\u53f0</li>\n<li>\u53ef\u80fd\u6709\u4e24\u7ea7 BTB\uff0c\u5b83\u4eec\u5e76\u975e\u7b80\u5355\u5730\u7ea7\u8054\uff0c\u800c\u662f\u901a\u8fc7\u4e0d\u540c\u7684\u7ec4\u7ec7\u65b9\u5f0f\uff0c\u5728\u4e0d\u540c\u7684\u533a\u95f4\u5185\u53d1\u6325\u4f5c\u7528</li>\n</ol>\n<p>\u9488\u5bf9 4B \u95f4\u8ddd\u6ca1\u6709\u51fa\u73b0 CPI&gt;3 \u7684\u60c5\u51b5\uff0c\u7ed9\u51fa\u4e00\u4e9b\u731c\u6d4b\uff1a</p>\n<ol>\n<li>\u6d4b\u8bd5\u89c4\u6a21\u4e0d\u591f\u5927\uff0c\u628a\u5206\u652f\u6570\u91cf\u7ee7\u7eed\u589e\u5927\uff0c\u624d\u80fd\u51fa\u73b0 CPI&gt;3 \u7684\u60c5\u51b5</li>\n<li>\u6307\u4ee4\u9884\u53d6\u5668\u5728\u5de5\u4f5c\uff0c\u5f53 footprint \u5927\u4e8e 128KB L1 ICache \u65f6\uff0c\u80fd\u63d0\u524d\u628a\u6307\u4ee4\u53d6\u8fdb\u6765</li>\n</ol>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 B \u6307\u4ee4\uff0c\u4f7f\u5f97 B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff0c\u5728 Firestorm \u4e0a\u8fdb\u884c\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_itlb.png\" /></p>\n<p>\u4ece 1 Cycle \u5230 3 Cycle \u7684\u589e\u52a0\u662f\u7531\u4e8e L1 BTB \u7684\u51b2\u7a81\u7f3a\u5931\uff0c\u4e4b\u540e\u5728 192 \u4e2a\u9875\u65f6\u4ece 3 Cycle \u5feb\u901f\u589e\u52a0\u5230 13 Cycle\uff0c\u5219\u5bf9\u5e94\u4e86 192 \u9879\u7684 L1 ITLB \u5bb9\u91cf\u3002</p>\n<p>\u5728 Icestorm \u4e0a\u91cd\u590d\u5b9e\u9a8c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_itlb.png\" /></p>\n<p>\u53ea\u6709\u4e00\u4e2a\u62d0\u70b9\uff0c\u5728 128 \u4e2a\u9875\u65f6\uff0c\u6027\u80fd\u4ece 1 Cycle \u4e0b\u964d\u5230 8 Cycle\uff0c\u610f\u5473 L1 ITLB \u5bb9\u91cf\u662f 128 \u9879\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece\u524d\u9762\u7684\u6d4b\u8bd5\u6765\u770b\uff0cFirestorm \u6700\u5927\u89c2\u5bdf\u5230 8 IPC\uff0cIcestorm \u6700\u5927\u89c2\u5bdf\u5230 4 IPC\uff0c\u90a3\u4e48 Decode \u5bbd\u5ea6\u4e5f\u81f3\u5c11\u662f\u8fd9\u4e48\u591a\uff0c\u6682\u65f6\u4e5f\u4e0d\u80fd\u6392\u9664\u6709\u66f4\u5927\u7684 Decode \u5bbd\u5ea6\u3002</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\uff0c\u5728 Firestorm \u4e0a\u5f97\u5230\u4e0b\u9762\u7684\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 50 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 Firestorm \u7684 Return Stack \u6df1\u5ea6\u4e3a 50\u3002\u5728 Icestorm \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 32 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 Icestorm \u7684 Return Stack \u6df1\u5ea6\u4e3a 32\u3002</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u7269\u7406\u5bc4\u5b58\u5668\u5806\">\u7269\u7406\u5bc4\u5b58\u5668\u5806<a class=\"headerlink\" href=\"#\u7269\u7406\u5bc4\u5b58\u5668\u5806\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u7269\u7406\u5bc4\u5b58\u5668\u5806\u7684\u5927\u5c0f\uff0c\u4e00\u822c\u4f1a\u7528\u4e24\u4e2a\u4f9d\u8d56\u94fe\u5f88\u957f\u7684\u64cd\u4f5c\u653e\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\uff0c\u4e2d\u95f4\u586b\u5165\u82e5\u5e72\u4e2a\u65e0\u5173\u7684\u6307\u4ee4\uff0c\u5e76\u4e14\u7528\u8fd9\u4e9b\u6307\u4ee4\u6765\u8017\u8d39\u7269\u7406\u5bc4\u5b58\u5668\u5806\u3002Firestorm \u6d4b\u8bd5\u7ed3\u679c\u89c1\u4e0b\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_prf.png\" /></p>\n<ul>\n<li>32b/64b int\uff1a\u6d4b\u8bd5 speculative 32/64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 362</li>\n<li>32b fp\uff1a\u6d4b\u8bd5 speculative 32 \u4f4d\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 382</li>\n<li>flags\uff1a\u6d4b\u8bd5 speculative NZCV \u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 123</li>\n</ul>\n<p>Icestorm \u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_prf.png\" /></p>\n<ul>\n<li>32b/64b int\uff1a\u6d4b\u8bd5 speculative 32/64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 78</li>\n<li>32b fp\uff1a\u6d4b\u8bd5 speculative 32 \u4f4d\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 382</li>\n<li>flags\uff1a\u6d4b\u8bd5 speculative NZCV \u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 75</li>\n</ul>\n<p>\u6ce8\u610f\u8fd9\u91cc\u6d4b\u8bd5\u7684\u90fd\u662f\u80fd\u591f\u7528\u4e8e\u9884\u6d4b\u6267\u884c\u7684\u5bc4\u5b58\u5668\u6570\u91cf\uff0c\u5b9e\u9645\u7684\u7269\u7406\u5bc4\u5b58\u5668\u5806\u8fd8\u9700\u8981\u4fdd\u5b58\u67b6\u6784\u5bc4\u5b58\u5668\u3002\u4f46\u5177\u4f53\u4fdd\u5b58\u591a\u5c11\u4e2a\u67b6\u6784\u5bc4\u5b58\u5668\u4e0d\u786e\u5b9a\uff0c\u4f46\u81f3\u5c11 32 \u4e2a\u6574\u6570\u901a\u7528\u5bc4\u5b58\u5668\u548c\u6d6e\u70b9\u5bc4\u5b58\u5668\u662f\u4e00\u5b9a\u6709\u7684\uff0c\u4f46\u53ef\u80fd\u8fd8\u6709\u4e00\u4e9b\u989d\u5916\u7684\u9700\u8981\u91cd\u547d\u540d\u7684\u72b6\u6001\u4e5f\u8981\u7b97\u8fdb\u6765\u3002</p>\n<h3 id=\"load-store-unit--l1-dcache\">Load Store Unit + L1 DCache<a class=\"headerlink\" href=\"#load-store-unit--l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"l1-dcache-\u5bb9\u91cf\">L1 DCache \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dcache-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0cFirestorm \u5177\u6709 128KB L1 DCache\uff0cIcestorm \u5177\u6709 64KB L1 DCache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>hw.perflevel0.l1dcachesize: 131072\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>hw.perflevel1.l1dcachesize: 65536\n</span></code></pre></div>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff0cFirestorm \u4e0a\u7684\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 128KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 128KB \u7684 L1 DCache \u5bb9\u91cf\u3002L1 DCache \u8303\u56f4\u5185\u5ef6\u8fdf\u662f 3 cycle\uff0c\u4e4b\u540e\u63d0\u5347\u5230 16 cycle\u3002</p>\n<p>Icestorm \u4e0a\u7684\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 64KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 64KB \u7684 L1 DCache \u5bb9\u91cf\u3002L1 DCache \u8303\u56f4\u5185\u5ef6\u8fdf\u662f 3 cycle\uff0c\u4e4b\u540e\u63d0\u5347\u5230 14 cycle\u3002</p>\n<h4 id=\"l1-dtlb-\u5bb9\u91cf\">L1 DTLB \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dtlb-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21 pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff0c\u5728 Firestorm \u4e0a\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_l1dtlb.png\" /></p>\n<p>\u4ece 160 \u4e2a\u9875\u5f00\u59cb\u6027\u80fd\u4e0b\u964d\uff0c\u5230 250 \u4e2a\u9875\u65f6\u6027\u80fd\u7a33\u5b9a\u5728 9 CPI\uff0c\u8ba4\u4e3a Firestorm \u7684 L1 DTLB \u6709 160 \u9879\u30029 CPI \u5305\u62ec\u4e86 L1 DTLB miss L2 TLB hit \u5e26\u6765\u7684\u989d\u5916\u5ef6\u8fdf\u3002</p>\n<p>\u5982\u679c\u6bcf\u4e24\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u5219\u62d0\u70b9\u524d\u79fb\u5230 80\uff1b\u6bcf\u56db\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 40\uff1b\u6bcf\u516b\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 20\uff1b\u6bcf 16 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u662f 10\uff1b\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 5\uff1b\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u4f9d\u7136\u662f 5\u3002\u8bf4\u660e Firestorm \u7684 L1 DTLB \u662f 5 \u8def\u7ec4\u76f8\u8fde\uff0c32 \u4e2a Set\uff0cIndex \u662f VA[18:14]\uff0c\u6ce8\u610f\u9875\u8868\u5927\u5c0f\u662f 16KB\u3002</p>\n<p>Icestorm:</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_l1dtlb.png\" /></p>\n<p>\u4ece 128 \u4e2a\u9875\u5f00\u59cb\u6027\u80fd\u4e0b\u964d\uff0c\u5230 160 \u4e2a\u9875\u65f6\u6027\u80fd\u7a33\u5b9a\u5728 10 CPI\uff0c\u8ba4\u4e3a Icestorm \u7684 L1 DTLB \u6709 128 \u9879\u300210 CPI \u5305\u62ec\u4e86 L1 DTLB miss L2 TLB hit \u5e26\u6765\u7684\u989d\u5916\u5ef6\u8fdf\u3002</p>\n<p>\u5982\u679c\u6bcf\u4e24\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u5219\u62d0\u70b9\u524d\u79fb\u5230 64\uff1b\u6bcf\u56db\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 32\uff1b\u6bcf\u516b\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 16\uff1b\u6bcf 16 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u662f 8\uff1b\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 4\uff1b\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u4f9d\u7136\u662f 4\u3002\u8bf4\u660e Icestorm \u7684 L1 DTLB \u662f 4 \u8def\u7ec4\u76f8\u8fde\uff0c32 \u4e2a Set\uff0cIndex \u662f VA[18:14]\u3002</p>\n<h4 id=\"loadstore-\u5e26\u5bbd\">Load/Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#loadstore-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b Firestorm \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>3x 128b Load + 1x 128b Store</li>\n<li>2x 128b Load + 2x 128b Store</li>\n<li>1x 128b Load + 2x 128b Store</li>\n<li>2x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 48B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 32B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002</p>\n<p>\u5b9e\u6d4b Icestorm \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>2x 128b Load</li>\n<li>1x 128b Load + 1x 128b Store</li>\n<li>1x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 32B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 16B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002</p>\n<h4 id=\"memory-dependency-predictor\">Memory Dependency Predictor<a class=\"headerlink\" href=\"#memory-dependency-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u9884\u6d4b\u6267\u884c Load\uff0c\u9700\u8981\u4fdd\u8bc1 Load \u548c\u4e4b\u524d\u7684 Store \u8bbf\u95ee\u7684\u5185\u5b58\u6ca1\u6709 Overlap\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u9884\u6d4b\u5668\u6765\u9884\u6d4b Load \u548c Store \u4e4b\u524d\u5728\u5185\u5b58\u4e0a\u7684\u4f9d\u8d56\u3002\u53c2\u8003 <a href=\"https://blog.stuffedcow.net/2014/01/x86-memory-disambiguation/\">Store-to-Load Forwarding and Memory Disambiguation in x86 Processors</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e24\u4e2a\u6307\u4ee4\u6a21\u5f0f\uff0c\u5206\u522b\u5728\u5730\u5740\u548c\u6570\u636e\u4e0a\u6709\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>\u6570\u636e\u4f9d\u8d56\uff0c\u5730\u5740\u65e0\u4f9d\u8d56\uff1a<code>str x3, [x1]</code> \u548c <code>ldr x3, [x2]</code></li>\n<li>\u5730\u5740\u4f9d\u8d56\uff0c\u6570\u636e\u65e0\u4f9d\u8d56\uff1a<code>str x2, [x1]</code> \u548c <code>ldr x1, [x2]</code></li>\n</ul>\n<p>\u521d\u59cb\u5316\u65f6\uff0c<code>x1</code> \u548c <code>x2</code> \u6307\u5411\u540c\u4e00\u4e2a\u5730\u5740\uff0c\u91cd\u590d\u5982\u4e0a\u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u89c2\u5bdf\u5230\u591a\u5c11\u6761 <code>ldr</code> \u6307\u4ee4\u65f6\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff0c\u5728 Firestorm \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_memory_dependency_predictor.png\" /></p>\n<p>\u6570\u636e\u4f9d\u8d56\u6ca1\u6709\u660e\u663e\u7684\u9608\u503c\uff0c\u4f46\u4ece 84 \u5f00\u59cb\u51fa\u73b0\u4e86\u4e00\u4e2a\u5c0f\u7684\u589e\u957f\uff0c\u4e14\u659c\u7387\u4e0d\u4e3a\u96f6\uff1b\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 70\u3002</p>\n<p>Icestorm:</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_memory_dependency_predictor.png\" /></p>\n<p>\u6570\u636e\u4f9d\u8d56\u548c\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u90fd\u662f 13\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<h5 id=\"firestorm_1\">Firestorm<a class=\"headerlink\" href=\"#firestorm_1\" title=\"Permanent link\">&para;</a></h5>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0cFirestorm \u4e0a\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>[-1,0]</td>\n<td>[-3,0]</td>\n<td>[-7,0]</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>[-1,1]</td>\n<td>[-3,1]</td>\n<td>[-7,1]</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[-1,3]</td>\n<td>[-3,3]</td>\n<td>[-7,3]</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[-1,7]</td>\n<td>[-3,7]</td>\n<td>[-7,7]</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u8868\u53ef\u4ee5\u770b\u5230\uff0c\u6240\u6709 Store \u548c Load Overlap \u7684\u60c5\u51b5\uff0c\u65e0\u8bba\u5730\u5740\u504f\u79fb\uff0c\u90fd\u80fd\u6210\u529f\u8f6c\u53d1\u3002\u751a\u81f3\u5728 Load \u6216 Store \u8de8\u8d8a 64B \u7f13\u5b58\u884c\u8fb9\u754c\u65f6\uff0c\u4e5f\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u4ee3\u4ef7\u662f\u591a\u4e00\u4e2a\u5468\u671f\u3002</p>\n<p>\u4e00\u4e2a Load \u9700\u8981\u8f6c\u53d1\u4e24\u4e2a\u3001\u56db\u4e2a\u751a\u81f3\u516b\u4e2a Store \u7684\u6570\u636e\u65f6\uff0c\u5982\u679c\u6570\u636e\u8de8\u8d8a\u7f13\u5b58\u884c\uff0c\u5219\u4e0d\u80fd\u8f6c\u53d1\uff0c\u4f46\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0c\u65e0\u8bba\u5730\u5740\u504f\u79fb\uff0c\u90fd\u53ef\u4ee5\u8f6c\u53d1\uff0c\u53ea\u662f\u6bd4\u4ece\u5355\u4e2a Store \u8f6c\u53d1\u9700\u8981\u591a\u8017\u8d39 1-4 \u4e2a\u5468\u671f\u3002</p>\n<p>\u6210\u529f\u8f6c\u53d1\u65f6 7.5 cycle\uff0c\u8de8\u7f13\u5b58\u884c\u4e14\u8f6c\u53d1\u5931\u8d25\u65f6 28+ cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aApple Firestorm \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u652f\u6301</li>\n<li>1 ld + 2 st: \u652f\u6301\uff0c\u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 4 st: \u652f\u6301\uff0c\u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 8 st: \u652f\u6301\uff0c\u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n</ul>\n<h5 id=\"icestorm_1\">Icestorm<a class=\"headerlink\" href=\"#icestorm_1\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5728 Icestorm \u4e0a\uff0c\u5982\u679c Load \u548c Store \u8bbf\u95ee\u8303\u56f4\u51fa\u73b0\u91cd\u53e0\uff0c\u5219\u9700\u8981 10 Cycle\uff0c\u65e0\u8bba\u662f\u548c\u51e0\u4e2a Store \u91cd\u53e0\uff0c\u4e5f\u65e0\u8bba\u662f\u5426\u8de8\u7f13\u5b58\u884c\u3002</p>\n<h4 id=\"load-to-use-latency\">Load to use latency<a class=\"headerlink\" href=\"#load-to-use-latency\" title=\"Permanent link\">&para;</a></h4>\n<h5 id=\"firestorm_2\">Firestorm<a class=\"headerlink\" href=\"#firestorm_2\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5b9e\u6d4b Firestorm \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5982\u679c\u8bbf\u5b58\u8de8\u8d8a\u4e86 8B \u8fb9\u754c\uff0c\u5219\u9000\u5316\u5230 4 cycle\u3002</p>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<h5 id=\"icestorm_2\">Icestorm<a class=\"headerlink\" href=\"#icestorm_2\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5b9e\u6d4b Icestorm \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5982\u679c\u8bbf\u5b58\u8de8\u8d8a\u4e86 8B/16B/32B \u8fb9\u754c\uff0c\u4f9d\u7136\u662f 3 cycle\uff1b\u8de8\u8d8a\u4e86 64B \u8fb9\u754c\u5219\u9000\u5316\u5230 7 cycle\u3002</p>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<h4 id=\"virtual-address-utagway-predictor\">Virtual Address UTag/Way-Predictor<a class=\"headerlink\" href=\"#virtual-address-utagway-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>Linear Address UTag/Way-Predictor \u662f AMD \u7684\u53eb\u6cd5\uff0c\u4f46\u4f7f\u7528\u76f8\u540c\u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u5728 Apple M1 \u4e0a\u89c2\u5bdf\u5230\u7c7b\u4f3c\u7684\u73b0\u8c61\uff0c\u731c\u60f3\u5b83\u4e5f\u7528\u4e86\u7c7b\u4f3c\u7684\u57fa\u4e8e\u865a\u62df\u5730\u5740\u7684 UTag/Way Predictor \u65b9\u6848\uff0c\u5e76\u6d4b\u51fa\u6765\u5b83\u7684 UTag \u4e5f\u6709 8 bit\uff0cFirestorm \u548c Icestorm \u90fd\u662f\u76f8\u540c\u7684\uff1a</p>\n<ul>\n<li>VA[14] xor VA[22] xor VA[30] xor VA[38] xor VA[46]</li>\n<li>VA[15] xor VA[23] xor VA[31] xor VA[39] xor VA[47]</li>\n<li>VA[16] xor VA[24] xor VA[32] xor VA[40]</li>\n<li>VA[17] xor VA[25] xor VA[33] xor VA[41]</li>\n<li>VA[18] xor VA[26] xor VA[34] xor VA[42]</li>\n<li>VA[19] xor VA[27] xor VA[35] xor VA[43]</li>\n<li>VA[20] xor VA[28] xor VA[36] xor VA[44]</li>\n<li>VA[21] xor VA[29] xor VA[37] xor VA[45]</li>\n</ul>\n<p>\u4e00\u5171\u6709 8 bit\uff0c\u7531 VA[47:14] \u6298\u53e0\u800c\u6765\u3002</p>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u60f3\u8981\u6d4b\u8bd5\u6709\u591a\u5c11\u4e2a\u6267\u884c\u5355\u5143\uff0c\u6bcf\u4e2a\u6267\u884c\u5355\u5143\u53ef\u4ee5\u8fd0\u884c\u54ea\u4e9b\u6307\u4ee4\uff0c\u9996\u5148\u8981\u6d4b\u8bd5\u5404\u7c7b\u6307\u4ee4\u5728\u65e0\u4f9d\u8d56\u60c5\u51b5\u4e0b\u7684\u7684 IPC\uff0c\u901a\u8fc7 IPC \u6765\u63a8\u65ad\u6709\u591a\u5c11\u4e2a\u80fd\u591f\u6267\u884c\u8fd9\u7c7b\u6307\u4ee4\u7684\u6267\u884c\u5355\u5143\uff1b\u4f46\u7531\u4e8e\u4e00\u4e2a\u6267\u884c\u5355\u5143\u53ef\u80fd\u53ef\u4ee5\u6267\u884c\u591a\u7c7b\u6307\u4ee4\uff0c\u4e8e\u662f\u8fdb\u4e00\u6b65\u9700\u8981\u89c2\u5bdf\u5728\u6df7\u5408\u4e0d\u540c\u7c7b\u7684\u6307\u4ee4\u65f6\u7684 IPC\uff0c\u4ece\u800c\u63a8\u65ad\u51fa\u5b8c\u6574\u7684\u7ed3\u679c\u3002</p>\n<h4 id=\"firestorm_3\">Firestorm<a class=\"headerlink\" href=\"#firestorm_3\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 Firestorm \u4e0a\u6d4b\u8bd5\u5982\u4e0b\u5404\u7c7b\u6307\u4ee4\u7684\u5ef6\u8fdf\u548c\u6bcf\u5468\u671f\u541e\u5410\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u5ef6\u8fdf</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>asimd int add</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd aesd/aese</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd aesimc/aesmc</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fabs</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fadd</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fmax</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmin</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmla</td>\n<td>4</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmul</td>\n<td>4</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fneg</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp cvtf2i (fcvtzs)</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp cvti2f (scvtf)</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fabs</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fadd</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fjcvtzs</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fmax</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fmin</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fmov f2i</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmov i2f</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fmul</td>\n<td>4</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fneg</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frecpx</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int add</td>\n<td>1</td>\n<td>4.6</td>\n</tr>\n<tr>\n<td>int addi</td>\n<td>1</td>\n<td>6</td>\n</tr>\n<tr>\n<td>int bfm</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int crc</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int csel</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int madd (addend)</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int madd (others)</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int mrs nzcv</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>int mul</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>int nop</td>\n<td>-</td>\n<td>8</td>\n</tr>\n<tr>\n<td>int sbfm</td>\n<td>1</td>\n<td>4.7</td>\n</tr>\n<tr>\n<td>int sdiv</td>\n<td>7</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int smull</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>int ubfm</td>\n<td>1</td>\n<td>4.7</td>\n</tr>\n<tr>\n<td>int udiv</td>\n<td>7</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>not taken branch</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>taken branch</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem asimd load</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>mem asimd store</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem int load</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>mem int store</td>\n<td>-</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u521d\u6b65\u5f97\u5230\u7684\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6807\u91cf\u6d6e\u70b9\u548c ASIMD \u541e\u5410\u6700\u5927\u90fd\u662f 4\uff0c\u610f\u5473\u7740\u6709 4 \u4e2a\u6d6e\u70b9/ASIMD \u6267\u884c\u5355\u5143\uff0c\u4f46\u5e76\u975e\u5b8c\u5168\u5bf9\u79f0\uff0c\u4f8b\u5982 fdiv/frecpe/frecpx/frsqrte/fsqrt/fjcvtzs \u7531\u4e8e\u541e\u5410\u4e0d\u8d85\u8fc7 1\uff0c\u5927\u6982\u7387\u53ea\u80fd\u5728\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\u3002\u4f46\u8fd9\u4e9b\u6307\u4ee4\u662f\u4e0d\u662f\u90fd\u53ea\u80fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\uff0c\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u6d4b\u8bd5</li>\n<li>\u6d6e\u70b9\u548c\u6574\u6570\u4e4b\u95f4\u7684 move \u6216 convert \u6307\u4ee4\uff0cfmov i2f/cvti2f \u541e\u5410\u662f 3\uff0cfmov f2i/cvtf2i \u541e\u5410\u662f 2\uff0c\u90a3\u4e48\u8fd9\u4e9b\u6307\u4ee4\u662f\u5728\u54ea\u4e2a\u6267\u884c\u5355\u5143\u91cc\u5b9e\u73b0\u7684\uff0c\u662f\u5426\u9700\u8981\u540c\u65f6\u5360\u7528\u6574\u6570\u6267\u884c\u5355\u5143\u548c\u6d6e\u70b9\u6267\u884c\u5355\u5143\uff0c\u9700\u8981\u8fdb\u4e00\u6b65\u6d4b\u8bd5</li>\n<li>\u6574\u6570\u65b9\u9762\uff0c\u6839\u636e\u541e\u5410\uff0c\u63a8\u65ad\u51fa\u5982\u4e0b\u51e0\u7c7b\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u6570\u91cf\uff1a<ol>\n<li>ALU: 6</li>\n<li>CSEL: 3</li>\n<li>Mul/Br/MRS NZCV: 2</li>\n<li>CRC/BFM/MAdd/Div: 1</li>\n</ol>\n</li>\n<li>\u867d\u7136 Br \u7684\u541e\u5410\u53ef\u4ee5\u8fbe\u5230 2\uff0c\u4f46\u662f\u6bcf\u5468\u671f\u53ea\u80fd\u6709\u4e00\u4e2a taken branch\uff1b\u76ee\u524d\u4e00\u4e9b\u67b6\u6784\u53ef\u4ee5\u505a\u5230\u6bcf\u5468\u671f\u8d85\u8fc7\u4e00\u4e2a taken branch\uff0c\u6b64\u65f6 Br \u7684\u541e\u5410\u4e00\u822c\u4f1a\u7ed9\u5230 3</li>\n<li>\u8bbf\u5b58\u65b9\u9762\uff0c\u6bcf\u5468\u671f\u6700\u591a 3 Load \u6216\u8005 2 Store</li>\n</ol>\n<p>\u9996\u5148\u6765\u770b\u6d6e\u70b9\u548c ASIMD \u5355\u5143\uff0c\u6839\u636e\u4e0a\u9762\u7684\u4fe1\u606f\uff0c\u8ba4\u4e3a\u81f3\u5c11\u6709 4 \u4e2a\u6267\u884c\u5355\u5143\uff0c\u6bcf\u4e2a\u6267\u884c\u5355\u5143\u90fd\u53ef\u4ee5\u505a\u8fd9\u4e9b\u64cd\u4f5c\uff1aasimd int add/aes/fabs/fadd/fmax/fmin/fmla/fmul/fneg\uff0c\u4e0b\u9762\u628a\u8fd9\u4e9b\u6307\u4ee4\u79f0\u4e3a basic fp/asimd ops + aes\u3002\u63a5\u4e0b\u6765\u8981\u5224\u65ad\uff0cfmov f2i/fmov i2f/fdiv/frecpe/frecpx/frsqrte/fsqrt \u7531\u54ea\u4e9b\u6267\u884c\u5355\u5143\u8d1f\u8d23\u6267\u884c\uff0c\u65b9\u6cd5\u662f\u628a\u8fd9\u4e9b\u6307\u4ee4\u6df7\u5408\u8d77\u6765\u6d4b\u8bd5\u541e\u5410\uff08\u6b64\u5904\u7684\u541e\u5410\u4e0d\u4ee3\u8868 CPI\uff0c\u800c\u662f\u6bcf\u5468\u80fd\u591f\u6267\u884c\u591a\u5c11\u6b21\u6307\u4ee4\u7ec4\u5408\uff0c\u4f8b\u5982\u7528 2 \u6761\u6307\u4ee4\u7684\u7ec4\u5408\u6d4b\u8bd5\uff0c\u90a3\u4e48\u541e\u5410\u7b49\u4e8e CPI \u9664\u4ee5 2\uff09\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fp fdiv + fp frecpe</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frecpx</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frsqrte</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp fsqrt</td>\n<td>0.32=3/3.12</td>\n</tr>\n<tr>\n<td>fp fdiv + fmov f2i</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fmov f2i</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>fp fdiv + 3x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 4x fmov i2f</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>fmov i2f + 4x fp fadd</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fmov f2i + 4x fp fadd</td>\n<td>0.67=1/1.50</td>\n</tr>\n</tbody>\n</table>\n<p>\u6839\u636e\u4ee5\u4e0a\u6d4b\u8bd5\u7ed3\u679c\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7684\u63a8\u8bba\uff1a</p>\n<ol>\n<li>fp fdiv/frecpe/frecpx/frsqrte \u6df7\u5408\u7684\u65f6\u5019\uff0c\u541e\u5410\u53ea\u6709\u4e00\u534a\uff0cIPC \u4e0d\u53d8\uff0c\u8bf4\u660e\u8fd9\u4e9b\u6307\u4ee4\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u4e2d\uff0c\u6df7\u5408\u5e76\u4e0d\u80fd\u5e26\u6765\u66f4\u9ad8\u7684 IPC</li>\n<li>fp fdiv \u548c fp fsqrt \u6df7\u5408\u65f6\uff0c\u541e\u5410\u4e0b\u964d\u5230 0.32 \u4e00\u4e2a\u4e0d\u592a\u6574\u7684\u6570\u5b57\uff0c\u731c\u6d4b\u662f\u56e0\u4e3a\u5b83\u4eec\u5c5e\u4e8e\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u7684\u4e0d\u540c\u6d41\u6c34\u7ebf\uff0c\u62a2\u5360\u5bc4\u5b58\u5668\u5806\u5199\u53e3</li>\n<li>fp fdiv + fmov f2i \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u800c fdiv + 2x fmov f2i \u65f6\u541e\u5410\u4e0b\u964d\u5230 0.67\uff0cIPC \u7ef4\u6301\u5728 2\uff0c\u8bf4\u660e\u6709\u4e24\u4e2a\u6267\u884c\u5355\u5143\uff0c\u90fd\u53ef\u4ee5\u6267\u884c fmov f2i\uff0c\u4f46\u53ea\u6709\u5176\u4e2d\u4e00\u4e2a\u53ef\u4ee5\u6267\u884c fp fdiv\uff0c\u5bfc\u81f4 fdiv + 2x fmov f2i \u7684\u65f6\u5019\u4f1a\u62a2\u6267\u884c\u5355\u5143</li>\n<li>fp fdiv + 3x fmov i2f \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u800c fdiv + 4x fmov i2f \u65f6\u541e\u5410\u4e0b\u964d\u5230 0.75\uff0c\u6b64\u65f6\u6bcf\u5468\u671f\u8fd8\u662f\u6267\u884c 3 \u6761 fmov i2f \u6307\u4ee4\uff0c\u610f\u5473\u7740 fdiv \u6ca1\u6709\u62a2\u5360 fmov i2f \u7684\u6267\u884c\u5355\u5143\uff0c\u5b83\u4eec\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u72ec\u7acb\u7684</li>\n<li>fmov i2f + 4x fp fadd \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u8bf4\u660e fmov i2f \u6ca1\u6709\u62a2\u5360 fp fadd \u7684\u6267\u884c\u5355\u5143</li>\n</ol>\n<p>\u63a8\u65ad\u8fd9\u56db\u4e2a\u6267\u884c\u5355\u5143\u652f\u6301\u7684\u64cd\u4f5c\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u5f53\u7136\u8fd8\u6709\u5f88\u591a\u6307\u4ee4\u6ca1\u6709\u6d4b\uff0c\u4e0d\u8fc7\u539f\u7406\u662f\u4e00\u6837\u7684\u3002</p>\n<p>\u8bbf\u5b58\u90e8\u5206\uff0c\u524d\u9762\u5df2\u7ecf\u5728\u6d4b LSU \u7684\u65f6\u5019\u6d4b\u8fc7\u4e86\uff0c\u6bcf\u5468\u671f Load + Store \u4e0d\u8d85\u8fc7 4 \u4e2a\uff0c\u5176\u4e2d Load \u4e0d\u8d85\u8fc7 3 \u4e2a\uff0cStore \u4e0d\u8d85\u8fc7 2 \u4e2a\u3002\u867d\u7136\u4ece IPC \u7684\u89d2\u5ea6\u6765\u770b LSU \u7684 Load/Store Pipe \u672a\u5fc5\u51c6\u786e\uff0c\u6bd4\u5982\u53ef\u80fd\u5b83\u53d1\u5c04\u548c\u63d0\u4ea4\u7684\u5e26\u5bbd\u662f\u4e0d\u540c\u7684\uff0c\u4f46\u5148\u6682\u65f6\u7b80\u5316\u4e3a\u5982\u4e0b\u7684\u6267\u884c\u5355\u5143\uff1a</p>\n<ol>\n<li>load + store</li>\n<li>load</li>\n<li>load</li>\n<li>store</li>\n</ol>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\u3002\u4ece addi \u7684\u6307\u4ee4\u6765\u770b\uff0c\u6709 6 \u4e2a ALU\uff0c\u80fd\u591f\u6267\u884c\u57fa\u672c\u7684\u6574\u6570\u6307\u4ee4\uff08add/ubfm/sbfm \u7684\u541e\u5410\u6709\u65f6\u5019\u6d4b\u51fa\u6765 4.6-4.7\uff0c\u6709\u65f6\u5019\u6d4b\u51fa\u6765 6\uff0c\u6000\u7591\u662f\u8fdb\u5165\u4e86\u4ec0\u4e48\u4f4e\u529f\u8017\u6a21\u5f0f\uff09\u3002\u4f46\u5176\u4ed6\u5f88\u591a\u6307\u4ee4\u53ef\u80fd\u53ea\u6709\u4e00\u90e8\u5206\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c\uff1abfm/crc/csel/madd/mrs nzcv/mul/div/branch/fmov i2f\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e9b\u6307\u4ee4\u4f7f\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u5426\u91cd\u5408\uff0c\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u6df7\u5408\u6307\u4ee4\u6d4b\u8bd5\uff0c\u541e\u5410\u7684\u5b9a\u4e49\u548c\u4e0a\u9762\u76f8\u540c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3x int csel + 3x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + 2x fmov f2i</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>3x int csel + int bfm</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int crc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int madd</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int mul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int sdiv</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>3x int csel + mrs nzcv</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>3x int csel + not taken branch</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>mrs nzcv + not taken branch</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mrs nzcv + 2x not taken branch</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>2x fmov f2i + 2x not taken branch</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2x fmov f2i + 2x int mul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int madd + 2x int mul</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>int madd + int sdiv</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + int crc</td>\n<td>0.5</td>\n</tr>\n</tbody>\n</table>\n<p>\u6839\u636e\u4e0a\u8ff0\u7ed3\u679c\u5206\u6790\uff1a</p>\n<ol>\n<li>\u541e\u5410\u4e0e\u4e0d\u6df7\u5408\u65f6\u76f8\u540c\uff0c\u4ee3\u8868\u6df7\u5408\u7684\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408</li>\n<li>3x int csel + 2x fmov f2i \u7684 IPC \u7b49\u4e8e 4\uff0c\u610f\u5473\u7740\u6709\u56db\u4e2a\u6267\u884c\u5355\u5143\uff0c\u5176\u4e2d\u6709\u4e09\u4e2a\u53ef\u4ee5\u6267\u884c int csel\uff0c\u4e24\u4e2a\u53ef\u4ee5\u6267\u884c fmov f2i\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u5176\u4e2d\u6709\u4e00\u4e2a\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c int csel \u548c fmov f2i\uff0c\u5373\u6709\u8fd9\u6837\u7684\u56db\u4e2a\u6267\u884c\u5355\u5143\uff1a<ol>\n<li>alu + csel</li>\n<li>alu + csel</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n</ol>\n</li>\n<li>3x int csel + mrs nzcv/not taken branch \u7684 IPC \u7b49\u4e8e 3\uff0c\u8bf4\u660e\u5b83\u4eec\u7684\u6267\u884c\u5355\u5143\u662f\u91cd\u5408\u7684\uff1b\u53c8\u56e0\u4e3a 2x fmov f2i + 2x not taken branch \u7684\u541e\u5410\u662f 1\uff0c\u8bf4\u660e\u5b83\u4eec\u7684\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408\uff0c\u90a3\u4e48\u4e0a\u8ff0\u56db\u4e2a\u6267\u884c\u5355\u5143\u53ea\u80fd\u662f\uff1a<ol>\n<li>alu + csel + branch</li>\n<li>alu + csel + branch</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n</ol>\n</li>\n<li>mrs nzcv + 2x not taken branch \u7684 IPC \u7b49\u4e8e 2\uff0c\u8bf4\u660e\u5b83\u4eec\u7684\u6267\u884c\u5355\u5143\u662f\u91cd\u5408\u7684\uff0c\u90a3\u4e48\u4e0a\u8ff0\u56db\u4e2a\u6267\u884c\u5355\u5143\u662f\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n</ol>\n</li>\n<li>csel \u548c mul \u4e0d\u91cd\u5408\uff0cf2i \u548c mul \u4e5f\u4e0d\u91cd\u5408\uff0c\u8bf4\u660e mul \u5728\u5269\u4e0b\u7684\u4e24\u4e2a\u6267\u884c\u5355\u5143\u5185\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul</li>\n<li>alu + mul</li>\n</ol>\n</li>\n<li>madd \u548c mul \u91cd\u5408\uff0cmadd \u548c crc \u91cd\u5408\uff0c\u90a3\u4e48\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul + madd + crc</li>\n<li>alu + mul</li>\n</ol>\n</li>\n</ol>\n<p>\u5f97\u5230\u521d\u6b65\u7684\u7ed3\u679c\uff1a</p>\n<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul + madd + crc</li>\n<li>alu + mul</li>\n</ol>\n<p>\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u6307\u4ee4\u6ca1\u6709\u6d4b\u8bd5\uff0c\u4e0d\u8fc7\u65b9\u6cd5\u662f\u7c7b\u4f3c\u7684\u3002\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u91cc\uff0c\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u503c\u5f97\u4e00\u63d0\u7684\u70b9\uff1a</p>\n<ol>\n<li>fmov f2i \u540c\u65f6\u5360\u7528\u4e86\u4e24\u4e2a\u6d6e\u70b9\u6267\u884c\u5355\u5143\u548c\u4e24\u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u8fd9\u4e3b\u8981\u662f\u4e3a\u4e86\u590d\u7528\u5bc4\u5b58\u5668\u5806\u8bfb\u5199\u53e3\uff1afmov f2i \u9700\u8981\u8bfb\u6d6e\u70b9\u5bc4\u5b58\u5668\u5806\uff0c\u53c8\u9700\u8981\u5199\u6574\u6570\u5bc4\u5b58\u5668\u5806\uff0c\u90a3\u5c31\u5728\u6d6e\u70b9\u4fa7\u8bfb\u5bc4\u5b58\u5668\uff0c\u5728\u6574\u6570\u4fa7\u5199\u5bc4\u5b58\u5668\u3002</li>\n<li>fmov i2f \u65e2\u4e0d\u5728\u6d6e\u70b9\uff0c\u4e5f\u4e0d\u5728\u6574\u6570\uff0c\u90a3\u53ea\u80fd\u5728\u8bbf\u5b58\u4e86\uff1a\u800c\u6b63\u597d\u8bbf\u5b58\u6267\u884c\u5355\u5143\u9700\u8981\u8bfb\u6574\u6570\uff0c\u5199\u6574\u6570\u6216\u6d6e\u70b9\uff0c\u90a3\u5c31\u53ef\u4ee5\u590d\u7528\u5b83\u7684\u5bc4\u5b58\u5668\u5806\u5199\u53e3\u6765\u5b9e\u73b0 fmov i2f \u7684\u529f\u80fd\u3002</li>\n<li>\u53ef\u89c1\u6574\u6570/\u6d6e\u70b9/\u8bbf\u5b58\u6267\u884c\u5355\u5143\u5e76\u4e0d\u662f\u5b8c\u5168\u9694\u79bb\u7684\uff0c\u4f8b\u5982\u4e00\u4e9b\u5fae\u67b6\u6784\uff0c\u6574\u6570\u548c\u6d6e\u70b9\u662f\u76f4\u63a5\u653e\u5728\u4e00\u8d77\u7684\u3002</li>\n</ol>\n<p>\u5c0f\u7ed3\uff1aFirestorm \u7684\u6267\u884c\u5355\u5143\u5982\u4e0b\uff1a</p>\n<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul + madd + crc</li>\n<li>alu + mul</li>\n<li>load + store</li>\n<li>load</li>\n<li>load</li>\n<li>store</li>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<h4 id=\"icestorm_3\">Icestorm<a class=\"headerlink\" href=\"#icestorm_3\" title=\"Permanent link\">&para;</a></h4>\n<p>\u63a5\u4e0b\u6765\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 Icestorm\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u5ef6\u8fdf</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>asimd int add</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd aesd/aese</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd aesimc/aesmc</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fabs</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fadd</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fdiv 64b</td>\n<td>11</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fdiv 32b</td>\n<td>9</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fmax</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fmin</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fmla</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fmul</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fneg</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd frecpe</td>\n<td>4</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd frsqrte</td>\n<td>4</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 64b</td>\n<td>15</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 32b</td>\n<td>12</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp cvtf2i (fcvtzs)</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp cvti2f (scvtf)</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fabs</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fadd</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fjcvtzs</td>\n<td>-</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fmax</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmin</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmov f2i</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fmov i2f</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmul</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fneg</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frecpx</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int add</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int addi</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int bfm</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int crc</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int csel</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int madd (addend)</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int madd (others)</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int mrs nzcv</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int mul</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int nop</td>\n<td>-</td>\n<td>4</td>\n</tr>\n<tr>\n<td>int sbfm</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int sdiv</td>\n<td>7</td>\n<td>0.125=1/8</td>\n</tr>\n<tr>\n<td>int smull</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int ubfm</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int udiv</td>\n<td>7</td>\n<td>0.125=1/8</td>\n</tr>\n<tr>\n<td>not taken branch</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>taken branch</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem asimd load</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem asimd store</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem int load</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem int store</td>\n<td>-</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u521d\u6b65\u5f97\u5230\u7684\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6807\u91cf\u6d6e\u70b9\u548c ASIMD \u541e\u5410\u6700\u5927\u90fd\u662f 2\uff0c\u610f\u5473\u7740\u6709 2 \u4e2a\u6d6e\u70b9/ASIMD \u6267\u884c\u5355\u5143\uff0c\u4f46\u5e76\u975e\u5b8c\u5168\u5bf9\u79f0\uff0c\u4f8b\u5982 fdiv/frecpe/frecpx/frsqrte/fsqrt/fjcvtzs \u7531\u4e8e\u541e\u5410\u4e0d\u8d85\u8fc7 1\uff0c\u5927\u6982\u7387\u53ea\u80fd\u5728\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\u3002\u4f46\u8fd9\u4e9b\u6307\u4ee4\u662f\u4e0d\u662f\u90fd\u53ea\u80fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\uff0c\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u6d4b\u8bd5</li>\n<li>\u6574\u6570\u65b9\u9762\uff0c\u6839\u636e\u541e\u5410\uff0c\u63a8\u65ad\u51fa\u5982\u4e0b\u51e0\u7c7b\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u6570\u91cf\uff1a<ol>\n<li>ALU/CSEL/MRS NZCV/SBFM/UBFM: 3</li>\n<li>Br: 2</li>\n<li>Mul/CRC/BFM/MAdd/Div: 1</li>\n</ol>\n</li>\n<li>\u867d\u7136 Br \u7684\u541e\u5410\u53ef\u4ee5\u8fbe\u5230 2\uff0c\u4f46\u662f\u6bcf\u5468\u671f\u53ea\u80fd\u6709\u4e00\u4e2a taken branch</li>\n<li>\u8bbf\u5b58\u65b9\u9762\uff0c\u6bcf\u5468\u671f\u6700\u591a 2 Load \u6216\u8005 1 Store</li>\n</ol>\n<p>\u8fd8\u662f\u5148\u770b\u6d6e\u70b9\uff0c\u57fa\u672c\u6307\u4ee4 add/aes/fabs/fadd/fmax/fmin/fmla/fmul/fneg \u90fd\u80fd\u505a\u5230 2 \u7684\u541e\u5410\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e24\u4e2a\u6307\u5b9a\u5355\u5143\u90fd\u80fd\u6267\u884c\u8fd9\u4e9b\u57fa\u672c\u6307\u4ee4\u3002\u63a5\u4e0b\u6765\u6d4b\u5176\u4f59\u6307\u4ee4\u7684\u6df7\u5408\u541e\u5410\uff08\u541e\u5410\u5b9a\u4e49\u89c1\u4e0a\uff09\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fp fdiv + fp frecpe</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frecpx</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frsqrte</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp fsqrt</td>\n<td>0.31=3/3.25</td>\n</tr>\n<tr>\n<td>fp fdiv + fmov f2i</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 3x fmov i2f</td>\n<td>0.67/1/1.50</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u89c1 fdiv/frecpe/frecpx/frsqrte/fsqrt/fmov f2i \u90fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u8fd8\u6709\u5f88\u591a\u6307\u4ee4\u6ca1\u6709\u6d4b\uff0c\u4e0d\u8fc7\u539f\u7406\u662f\u4e00\u6837\u7684\u3002\u8bbf\u5b58\u5728\u524d\u9762\u6d4b LSU \u7684\u65f6\u5019\u5df2\u7ecf\u6d4b\u8fc7\u4e86\uff1a</p>\n<ol>\n<li>load + store</li>\n<li>load</li>\n</ol>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\u3002\u4ece addi \u7684\u6307\u4ee4\u6765\u770b\uff0c\u6709 3 \u4e2a ALU\uff0c\u80fd\u591f\u6267\u884c\u57fa\u672c\u7684\u6574\u6570\u6307\u4ee4\u3002\u4f46\u5176\u4ed6\u5f88\u591a\u6307\u4ee4\u53ef\u80fd\u53ea\u6709\u4e00\u90e8\u5206\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c\uff1abfm/crc/csel/madd/mul/div/branch\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e9b\u6307\u4ee4\u4f7f\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u5426\u91cd\u5408\uff0c\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u6df7\u5408\u6307\u4ee4\u6d4b\u8bd5\uff0c\u541e\u5410\u7684\u5b9a\u4e49\u548c\u4e0a\u9762\u76f8\u540c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>int madd + int mul</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + int crc</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + 2x not taken branch</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u6b64\u53ef\u89c1\uff0cmadd/mul/crc \u662f\u4e00\u4e2a\u6267\u884c\u5355\u5143\uff0c\u548c branch \u7684\u4e24\u4e2a\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408\uff0c\u56e0\u6b64\u6574\u6570\u4fa7\u7684\u6267\u884c\u5355\u5143\u6709\uff1a</p>\n<ol>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + madd + mul + crc</li>\n</ol>\n<p>\u5c0f\u7ed3\uff1aIcestorm \u7684\u6267\u884c\u5355\u5143\u5982\u4e0b\uff1a</p>\n<ol>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + madd + mul + crc</li>\n<li>load + store</li>\n<li>load</li>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<h3 id=\"scheduler\">Scheduler<a class=\"headerlink\" href=\"#scheduler\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 Scheduler \u7684\u5927\u5c0f\u548c\u7ec4\u7ec7\u65b9\u5f0f\uff08\u5206\u5e03\u5f0f\u8fd8\u662f\u96c6\u4e2d\u5f0f\uff09\uff0c\u6d4b\u8bd5\u65b9\u6cd5\u662f\uff1a\u9996\u5148\u7528\u957f\u5ef6\u8fdf\u7684\u64cd\u4f5c\u5835\u4f4f ROB\uff0c\u63a5\u7740\u7528\u82e5\u5e72\u6761\u4f9d\u8d56\u957f\u5ef6\u8fdf\u64cd\u4f5c\u7684\u6307\u4ee4\u5835\u4f4f Scheduler\uff0c\u5f53\u6307\u4ee4\u585e\u4e0d\u8fdb\u53bb\u7684\u65f6\u5019\uff0c\u5c31\u8bf4\u660e Scheduler \u6ee1\u4e86\u3002\u66f4\u8fdb\u4e00\u6b65\uff0c\u7531\u4e8e\u73b0\u5728\u5f88\u591a\u5904\u7406\u5668\u4f1a\u5f15\u5165 Non Scheduling Queue\uff0c\u91cc\u9762\u7684\u6307\u4ee4\u4e0d\u4f1a\u76f4\u63a5\u8c03\u5ea6\u8fdb\u6267\u884c\u5355\u5143\uff0c\u4e5f\u4e0d\u68c0\u67e5\u5b83\u4f9d\u8d56\u7684\u64cd\u4f5c\u6570\u662f\u5426\u5df2\u7ecf\u51c6\u5907\u597d\uff0c\u6b64\u65f6\u4e3a\u4e86\u533a\u5206\u53ef\u8c03\u5ea6\u90e8\u5206\u548c\u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\uff0c\u5728\u4f9d\u8d56\u957f\u5ef6\u8fdf\u64cd\u4f5c\u7684\u6307\u4ee4\u540e\u9762\uff0c\u6dfb\u52a0\u82e5\u5e72\u6761\u4e0d\u4f9d\u8d56\u957f\u5ef6\u8fdf\u64cd\u4f5c\u7684\u6307\u4ee4\uff0c\u8fd9\u6837\u6d4b\u51fa\u6765\u7684\u5c31\u662f\u53ef\u8c03\u5ea6\u90e8\u5206\u7684\u6df1\u5ea6\u3002</p>\n<h4 id=\"firestorm_4\">Firestorm<a class=\"headerlink\" href=\"#firestorm_4\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 Firestorm \u4e0a\u6d4b\u8bd5\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u53ef\u8c03\u5ea6 + \u4e0d\u53ef\u8c03\u5ea6</th>\n<th>\u53ef\u8c03\u5ea6</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ld</td>\n<td>58</td>\n<td>48</td>\n</tr>\n<tr>\n<td>st</td>\n<td>58</td>\n<td>43</td>\n</tr>\n<tr>\n<td>alu</td>\n<td>158</td>\n<td>134</td>\n</tr>\n<tr>\n<td>fp</td>\n<td>156</td>\n<td>144</td>\n</tr>\n<tr>\n<td>crc</td>\n<td>40</td>\n<td>28</td>\n</tr>\n<tr>\n<td>idiv</td>\n<td>40</td>\n<td>28</td>\n</tr>\n<tr>\n<td>bfm</td>\n<td>40</td>\n<td>28</td>\n</tr>\n<tr>\n<td>fjcvtzs</td>\n<td>42</td>\n<td>36</td>\n</tr>\n<tr>\n<td>fmov f2i</td>\n<td>84</td>\n<td>72</td>\n</tr>\n<tr>\n<td>csel</td>\n<td>76</td>\n<td>64</td>\n</tr>\n<tr>\n<td>mrs nzcv</td>\n<td>62</td>\n<td>50</td>\n</tr>\n</tbody>\n</table>\n<p>\u9996\u5148\u770b\u6d6e\u70b9\uff1a</p>\n<ol>\n<li>\u53ef\u8c03\u5ea6\u90e8\u5206 fp \u662f 144\uff0cfmov f2i \u662f 72\uff0cfjcvtzs \u662f 36\uff0c\u6709\u660e\u663e\u7684 4:2:1 \u7684\u5173\u7cfb</li>\n<li>fp/fmov f2i/fjcvtzs \u541e\u5410\u521a\u597d\u4e5f\u662f 4:2:1 \u7684\u5173\u7cfb</li>\n<li>\u56e0\u6b64\u56db\u4e2a\u6267\u884c\u5355\u5143\u524d\u9762\u5404\u6709\u4e00\u4e2a\u72ec\u7acb\u7684 36 entry \u7684 Scheduler</li>\n<li>\u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\uff0c156-144=12\uff0c84-72=12\uff0c42-36=6\uff0c\u731c\u6d4b\u6709\u4e24\u4e2a Non Scheduling Queue\uff0c\u6bcf\u4e2a Non Scheduling Queue 6 entry\uff0c\u5206\u522b\u5bf9\u5e94\u4e24\u4e2a Scheduler</li>\n</ol>\n<p>\u4e0b\u9762\u662f\u8bbf\u5b58\u90e8\u5206\uff0cload \u548c store \u603b\u6570\u4e00\u6837\u4f46 Scheduler \u5dee\u4e86 5\uff0c\u4e0d\u786e\u5b9a\u662f\u6d4b\u8bd5\u8bef\u5dee\u8fd8\u662f\u4ec0\u4e48\u95ee\u9898\uff0c\u6682\u4e14\u8003\u8651\u4e3a\u4e00\u4e2a\u7edf\u4e00\u7684 Scheduler \u548c\u540c\u4e00\u4e2a Non Scheduling Queue\u3002</p>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\uff0c\u7531\u4e8e\u6709 6 \u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u60c5\u51b5\u4f1a\u6bd4\u8f83\u590d\u6742\uff1a</p>\n<ol>\n<li>\u53ef\u8c03\u5ea6\u90e8\u5206 alu \u4e00\u5171\u662f 134\uff0c\u5176\u4e2d csel \u662f 64\uff0ccrc/idiv/bfm \u90fd\u662f 28\uff0cmrs nzcv \u662f 50\uff0c\u7ed3\u5408\u516d\u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u53ef\u4ee5\u5f97\u5230\u8fd9\u516d\u4e2a\u6267\u884c\u5355\u5143\u5bf9\u5e94\u7684 Scheduler \u5927\u5c0f\u5173\u7cfb\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv: x entries</li>\n<li>alu + csel + branch + mrs nzcv: 50-x entries</li>\n<li>alu + csel + fmov f2i: 14 entries</li>\n<li>alu + fmov f2i: y entries</li>\n<li>alu + mul + madd + crc: 28 entries</li>\n<li>alu + mul: 42-y entries</li>\n</ol>\n</li>\n<li>alu \u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\u662f 158-134=24\uff0ccrc/idiv/bfm/csel/mrs nzcv \u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\u90fd\u662f 12\uff0c\u8003\u8651\u5230 csel \u5bf9\u5e94\u524d\u4e09\u4e2a\u6267\u884c\u5355\u5143\uff0c\u5e76\u4e14\u548c mrs nzcv \u4e00\u6837\u591a\uff0c\u8bf4\u660e\u524d\u4e09\u4e2a\u6267\u884c\u5355\u5143\u5171\u4eab\u4e00\u4e2a 12 entry \u7684 Non Scheduling Queue\uff1b\u5269\u4e0b\u4e09\u4e2a\u6267\u884c\u5355\u5143\u5171\u4eab\u5269\u4e0b\u7684 12 entry \u7684 Non Scheduling Queue</li>\n<li>\u6700\u540e\u53ea\u5dee x \u548c y \u7684\u53d6\u503c\u6ca1\u6709\u6c42\u51fa\u6765\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fdb\u4e00\u6b65\u6d4b\u8bd5\u6765\u66f4\u52a0\u7cbe\u786e\u5730\u6c42\u51fa</li>\n</ol>\n<h3 id=\"reorder-buffer\">Reorder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"firestorm_5\">Firestorm<a class=\"headerlink\" href=\"#firestorm_5\" title=\"Permanent link\">&para;</a></h4>\n<p>Firestorm \u7684 ROB \u91c7\u7528\u7684\u662f\u6bd4\u8f83\u7279\u522b\u7684\u65b9\u6848\uff0c\u5b83\u7684 entry \u5730\u4f4d\u4e0d\u662f\u7b49\u540c\u7684\uff0c\u800c\u662f\u82e5\u5e72\u4e2a entry \u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u6210\u4e3a\u4e00\u4e2a group\uff0c\u6bcf\u4e2a group \u6709\u82e5\u5e72\u4e2a entry\uff0c\u4e00\u4e2a group \u5bf9 group \u5185\u6307\u4ee4\u7684\u7c7b\u578b\u548c\u6570\u91cf\u6709\u8981\u6c42\uff0c\u8fd9\u5c31\u5bfc\u81f4\u7528\u4f20\u7edf\u65b9\u6cd5\u6d4b Firestorm \u7684 ROB\uff0c\u53ef\u80fd\u4f1a\u6d4b\u5230\u7279\u522b\u5de8\u5927\u7684\u6570\uff1a2200+\uff0c\u4e5f\u53ef\u80fd\u6d4b\u5230\u6bd4\u8f83\u5c0f\u7684\u6570\uff1a320+\uff0c\u8fd9\u5c31\u548c\u6307\u4ee4\u7c7b\u578b\u6709\u5173\u7cfb\u3002\u4e3a\u4ec0\u4e48\u5bf9\u6307\u4ee4\u7684\u7c7b\u578b\u548c\u4f4d\u7f6e\u6709\u8981\u6c42\u5462\uff0c\u8fd9\u662f\u4e3a\u4e86\u65b9\u4fbf\u5904\u7406\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u3002\u5f88\u591a\u6307\u4ee4\u662f\u6ca1\u6709\u526f\u4f5c\u7528\u7684\uff0c\u4e5f\u4e0d\u4f1a\u629b\u5f02\u5e38\uff0c\u8fd9\u4e9b\u6307\u4ee4\u53ef\u4ee5\u6bd4\u8f83\u968f\u610f\u5730\u653e\u7f6e\uff1b\u4f46\u662f\u5bf9\u4e8e\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\uff0cretire \u65f6\u662f\u9700\u8981\u7279\u6b8a\u5904\u7406\u7684\uff0c\u56e0\u6b64\u4e00\u4e2a\u5408\u7406\u7684\u8bbe\u8ba1\u5c31\u662f\uff0c\u8ba9\u8fd9\u4e9b\u6307\u4ee4\u53ea\u80fd\u653e\u5728 group \u7684\u5f00\u5934\u3002</p>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u53d1\u73b0 Firestorm \u4e0a pointer chasing \u7684\u5ef6\u8fdf\u6ce2\u52a8\u6bd4\u8f83\u5927\uff0c\u76ee\u6d4b\u662f prefetcher \u505a\u4e86\u9488\u5bf9\u6027\u7684\u4f18\u5316\uff0c\u56e0\u6b64\u7528 fsqrt chain \u6765\u505a\u5ef6\u8fdf\uff0cFirestorm \u4e0a\u4e00\u6761\u53cc\u7cbe\u5ea6 fsqrt \u7684\u5ef6\u8fdf\u662f 13 \u4e2a\u5468\u671f\u3002\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5305\u62ec M \u4e2a\u4e32\u884c\u7684 sqrt \u548c N \u4e2a nop\uff0c\u5982\u679c\u6ca1\u6709\u89e6\u78b0\u5230 ROB \u7684\u74f6\u9888\uff0c\u90a3\u4e48\u5f53 N \u6bd4\u8f83\u5c0f\u7684\u65f6\u5019\uff0c\u74f6\u9888\u5728\u4e32\u884c fsqrt \u4e0a\uff0c\u6bcf\u6b21\u5faa\u73af\u7684\u5468\u671f\u6570\u5e94\u8be5\u4e3a <code>M*13</code>\uff1b\u5f53 N \u6bd4\u8f83\u5927\u7684\u65f6\u5019\uff0c\u74f6\u9888\u5728\u6bcf\u4e2a\u5468\u671f\u6267\u884c 8 \u4e2a NOP \u4e0a\uff08NOP \u88ab eliminate \u4e86\uff0c\u4e0d\u7528\u8fdb ALU\uff0c\u53ef\u4ee5\u6253\u6ee1 8 \u7684\u53d1\u5c04\u5bbd\u5ea6\uff09\uff0c\u6bcf\u6b21\u5faa\u73af\u7684\u5468\u671f\u6570\u5e94\u8be5\u4e3a <code>N/8</code> \u518d\u52a0\u4e0a\u4e00\u4e2a\u5e38\u6570\u3002</p>\n<p>\u4f46\u5f53 N \u5f88\u5927\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4f1a\u649e\u4e0a ROB \u5927\u5c0f\u7684\u9650\u5236\u3002\u4e0b\u9762\u7ed9\u51fa\u4e86\u4e0d\u540c\u7684 M \u53d6\u503c\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5faa\u73af\u5468\u671f\u6570\u5728 <code>M*13</code> \u5de6\u53f3\u7684\u6700\u5927\u7684 N \u53d6\u503c\uff1a</p>\n<ul>\n<li>M=21, N &lt;= 2109, cycle=273.74, M*13=273</li>\n<li>M=22, N &lt;= 2205, cycle=286.75, M*13=286</li>\n<li>M=23, N &lt;= 2269, cycle=299.76, M*13=299</li>\n<li>M=24, N &lt;= 2277, cycle=312.77, M*13=312</li>\n<li>M=25, N &lt;= 2275, cycle=325.77, M*13=325</li>\n<li>M=26, N &lt;= 2274, cycle=338.77, M*13=338</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230 N \u6700\u5927\u5728 2277 \u9644\u8fd1\u5c31\u4e0d\u80fd\u518d\u589e\u52a0\u4e86\uff0c\u8bf4\u660e\u9047\u5230\u4e86 ROB \u7684\u74f6\u9888\uff0c\u9884\u8ba1 ROB \u7684\u6240\u6709 group \u7684 entry \u4e2a\u6570\u52a0\u8d77\u6765\u5927\u6982\u662f 2277 \u5de6\u53f3\u3002</p>\n<p>\u800c\u5982\u679c\u628a\u586b\u5145\u7684\u6307\u4ee4\u6539\u6210 load/store\uff0cinflight \u7684 load \u548c store \u6700\u591a\u90fd\u662f 325 \u4e2a\uff0c\u5e76\u4e14\u8fd9\u548c load/store queue \u5927\u5c0f\u65e0\u5173\uff0c\u800c load/store \u53c8\u662f\u6709\u526f\u4f5c\u7528\u7684\uff0c\u5f88\u53ef\u80fd\u662f\u56e0\u4e3a\u5b83\u4eec\u53ea\u80fd\u5728 ROB \u6bcf\u4e2a group \u91cc\u53ea\u80fd\u653e\u4e00\u6761\uff0c\u4e8e\u662f\u770b\u8d77\u6765 ROB \u7684\u5bb9\u91cf\u6bd4 2277 \u5c0f\u4e86\u5f88\u591a\uff0c\u53ea\u8868\u73b0\u51fa 325\u3002\u6309\u7167\u8fd9\u4e2a\u731c\u60f3\uff0c\u5bf9\u4e8c\u8005\u8fdb\u884c\u9664\u6cd5\uff0c\u53d1\u73b0\u5546\u548c 7 \u5341\u5206\u63a5\u8fd1\uff0c\u8fd9\u5927\u6982\u7387\u610f\u5473\u7740 Firestorm \u7684 ROB \u6709 325 \u5de6\u53f3\u4e2a group\uff0c\u6bcf\u4e2a group \u5185\u6709 7 \u4e2a entry\uff0c\u6bcf\u4e2a entry \u53ef\u4ee5\u653e\u4e00\u6761\u6307\u4ee4\uff08uop\uff09\u3002\u6d4b\u8bd5\u91cc\u5f00\u5934\u7684 20 \u4e2a sqrt \u4e5f\u8981\u5360\u7528 ROB\uff0c\u5b9e\u9645\u7684 ROB group \u6570\u91cf\u53ef\u80fd\u6bd4 325 \u7565\u591a\u3002</p>\n<p>\u7ed3\u8bba\uff1aFirestorm \u7684 ROB \u6709\u5927\u7ea6 330 \u4e2a group\uff0c\u6bcf\u4e2a group \u6700\u591a\u4fdd\u5b58 7 \u4e2a uop\u3002</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0c4 \u4e2a Firestorm \u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 12MB L2 Cache\uff0c4 \u4e2a Icestorm \u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 4MB L2 Cache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>hw.perflevel0.l2cachesize: 12582912\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>hw.perflevel0.cpusperl2: 4\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>hw.perflevel1.l2cachesize: 4194304\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>hw.perflevel1.cpusperl2: 4\n</span></code></pre></div>\n<h3 id=\"l2-tlb\">L2 TLB<a class=\"headerlink\" href=\"#l2-tlb\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"firestorm_6\">Firestorm<a class=\"headerlink\" href=\"#firestorm_6\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4ece\u82f9\u679c\u63d0\u4f9b\u7684\u6027\u80fd\u8ba1\u6570\u5668\u6765\u770b\uff0cL1 TLB \u5206\u4e3a\u6307\u4ee4\u548c\u6570\u636e\uff0c\u800c L2 TLB \u662f Unified\uff0c\u4e0d\u533a\u5206\u6307\u4ee4\u548c\u6570\u636e\u3002\u6cbf\u7528\u4e4b\u524d\u6d4b\u8bd5 L1 DTLB \u7684\u65b9\u6cd5\uff0c\u628a\u89c4\u6a21\u6269\u5927\u5230 L2 Unified TLB \u7684\u8303\u56f4\uff0c\u5c31\u53ef\u4ee5\u6d4b\u51fa\u6765 L2 Unified TLB \u7684\u5bb9\u91cf\uff0c\u4e0b\u9762\u662f Firestorm \u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 3072 \u4e2a Page\uff0c\u8bf4\u660e Firestorm \u7684 L2 TLB \u5bb9\u91cf\u662f 3072 \u9879\u3002</p>\n<p>\u628a\u6307\u9488\u7684\u8de8\u5ea6\u589e\u5927\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 96\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 36.5</li>\n<li>\u5982\u679c\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 48\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 36.5</li>\n<li>\u5982\u679c\u6bcf 128 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 24\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 36.5</li>\n<li>\u5982\u679c\u6bcf 256 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 12\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 35</li>\n<li>\u5982\u679c\u6bcf 512 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u4f9d\u7136\u5728 12\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 35</li>\n<li>\u89c2\u5bdf\u5230\u547d\u4e2d L1 DTLB \u65f6 CPI \u662f 3\uff0c\u547d\u4e2d L2 TLB \u65f6 CPI \u662f 9\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u662f 35-36.5\uff0c\u6b64\u65f6\u7f13\u5b58\u7f3a\u5931\u7387\u4e3a 0</li>\n</ul>\n<p>\u8ba4\u4e3a Firestorm \u7684 L2 TLB \u662f 12 Way\uff0c256 Set\uff0cIndex \u4f4d\u662f VA[21:14]\u3002</p>\n<h4 id=\"icestorm_4\">Icestorm<a class=\"headerlink\" href=\"#icestorm_4\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 Icestorm \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 1024 \u4e2a Page\uff0c\u8bf4\u660e Icestorm \u7684 L2 TLB \u5bb9\u91cf\u662f 1024 \u9879\u3002</p>\n<p>\u628a\u6307\u9488\u7684\u8de8\u5ea6\u589e\u5927\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 32\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 33</li>\n<li>\u5982\u679c\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 16\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 32</li>\n<li>\u5982\u679c\u6bcf 128 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 8\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 32</li>\n<li>\u5982\u679c\u6bcf 256 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 4 \u548c L1 DTLB \u62d0\u70b9\u91cd\u5408\uff0c\u4e00\u65e6 L1 DTLB \u7f3a\u5931\uff0cL2 TLB \u4e5f\u7f3a\u5931\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 32</li>\n<li>\u89c2\u5bdf\u5230\u547d\u4e2d L1 DTLB \u65f6 CPI \u662f 3\uff0c\u547d\u4e2d L2 TLB \u65f6 CPI \u662f 10\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u662f 32-33\uff0c\u6b64\u65f6\u7f13\u5b58\u7f3a\u5931\u7387\u4e3a 0</li>\n</ul>\n<p>\u7531\u4e8e Icestorm \u7684 L1 DTLB \u5c31\u662f 4 Way\uff0c\u4e0d\u786e\u5b9a Icestorm \u7684 L2 TLB \u7ec4\u76f8\u8fde\u662f 1/2/4 Way \u7684\u54ea\u4e00\u79cd\uff0c\u5047\u5982\u662f 4 Way\uff0c\u90a3\u4e48 Icestorm \u7684 L2 TLB \u662f 4 Way\uff0c256 Set\uff0cIndex \u4f4d\u662f VA[21:14]\u3002</p>", "image": null, "date_published": "2024-12-26T00:00:00+00:00", "authors": [], "tags": ["apple", "cpu", "firestorm", "hardware", "icestorm", "m1", "performance", "uarch-review"]}, {"id": "https://jia.je/software/2024/12/10/linux-perf-pmu/", "url": "https://jia.je/software/2024/12/10/linux-perf-pmu/", "title": "Linux \u7684\u6027\u80fd\u5206\u6790\uff08Perf\uff09\u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"linux-\u7684\u6027\u80fd\u5206\u6790perf\u5b9e\u73b0\u63a2\u7a76\">Linux \u7684\u6027\u80fd\u5206\u6790\uff08Perf\uff09\u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#linux-\u7684\u6027\u80fd\u5206\u6790perf\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u4f7f\u7528 Linux \u7684\u6027\u80fd\u5206\u6790\u529f\u80fd\u6bd4\u8f83\u591a\uff0c\u4f46\u662f\u5f88\u5c11\u53bb\u63a2\u7a76\u80cc\u540e\u7684\u539f\u7406\uff0c\u4f8b\u5982\u786c\u4ef6\u7684 PMU \u662f\u600e\u4e48\u914d\u7f6e\u7684\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u4e43\u81f3\u6bcf\u4e2a\u7ebf\u7a0b\u7ea7\u522b\u7684 PMU \u662f\u600e\u4e48\u91c7\u6837\u7684\u3002\u8fd9\u7bc7\u535a\u5ba2\u5c1d\u8bd5\u63a2\u7a76\u8fd9\u80cc\u540e\u7684\u539f\u7406\u3002</p>\n<!-- more -->\n\n<h2 id=\"pmu\">PMU<a class=\"headerlink\" href=\"#pmu\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u786c\u4ef6\">\u786c\u4ef6<a class=\"headerlink\" href=\"#\u786c\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u652f\u6491\u6027\u80fd\u5206\u6790\u7684\u80cc\u540e\u662f\u786c\u4ef6\u63d0\u4f9b\u7684\u673a\u5236\uff0c\u6700\u5e38\u7528\u7684\u5c31\u662f\u6027\u80fd\u8ba1\u6570\u5668\uff1a\u786c\u4ef6\u4f1a\u63d0\u4f9b\u4e00\u4e9b\u53ef\u4ee5\u914d\u7f6e\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u5728\u5bf9\u5e94\u7684\u786c\u4ef6\u4e8b\u4ef6\u89e6\u53d1\u662f\uff0c\u66f4\u65b0\u8fd9\u4e9b\u8ba1\u6570\u5668\uff0c\u7136\u540e\u518d\u7531\u7a0b\u5e8f\u8bfb\u53d6\u8ba1\u6570\u5668\u7684\u503c\u5e76\u7edf\u8ba1\u3002\u4e0b\u9762\u4ee5 ARM \u4e3a\u4f8b\uff0c\u5206\u6790\u4e00\u4e0b\u786c\u4ef6\u63d0\u4f9b\u7684\u6027\u80fd\u8ba1\u6570\u7684\u63a5\u53e3\uff1a</p>\n<ol>\n<li>Cycle \u8ba1\u6570\u5668\uff1aCycle Counter Register(PMCCNTR_EL0) \u548c Cycle Count Filter Register(PMCCFILTR_EL0)\uff0c\u5176\u4e2d\u540e\u8005\u63a7\u5236\u524d\u8005\u5728\u4ec0\u4e48\u7279\u6743\u6001\u4e0b\u4f1a\u8fdb\u884c\u8ba1\u6570</li>\n<li>\u6700\u591a 31 \u4e2a\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff1a<ol>\n<li>\u8be5\u6027\u80fd\u8ba1\u6570\u5668\u8bb0\u5f55\u7684\u786c\u4ef6\u4e8b\u4ef6\u4ee5\u53ca\u8ba1\u6570\u7684\u6761\u4ef6\uff1aPMEVTYPER<n>_EL0\uff0cn \u53d6 0 \u5230 31</li>\n<li>\u8be5\u6027\u80fd\u8ba1\u6570\u5668\u5f53\u524d\u7684\u503c\uff1aPMEVCNTR<n>_EL0\uff0cn \u53d6 0 \u5230 31</li>\n</ol>\n</li>\n<li>\u63a7\u5236 Cycle \u8ba1\u6570\u5668\u548c\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\u7684\u72b6\u6001\uff1aPMCNTENCLR_EL0/PMCNTENSET_EL0/PMCR_EL0</li>\n<li>\u5404\u8ba1\u6570\u5668\u662f\u5426\u6ea2\u51fa\uff1aPMOVSCLR_EL0/PMOVSSET_EL0</li>\n<li>\u5f53\u8ba1\u6570\u5668\u6ea2\u51fa\u65f6\uff0cPMU \u4f1a\u62c9\u8d77\u4e2d\u65ad\uff0c\u9488\u5bf9\u8fd9\u4e9b\u4e2d\u65ad\u7684\u914d\u7f6e\uff1aPMINTENCLR_EL1/PMINTENSET_EL1</li>\n</ol>\n<p>\u6ce8\uff1a\u5b9e\u9645\u4e0a\uff0c\u7531\u4e8e\u7ecf\u5e38\u4f1a\u5bf9\u6307\u4ee4\u6570\u8fdb\u884c\u91c7\u6837\uff0cARM v9.4/8.9 \u5141\u8bb8\u786c\u4ef6\u5b9e\u73b0\u4e00\u4e2a\u989d\u5916\u7684\u6307\u4ee4\u8ba1\u6570\u5668\uff0c\u548c Cycle \u8ba1\u6570\u5668\u7c7b\u4f3c\u3002</p>\n<p>\u5982\u679c\u60f3\u8981\u5728\u7528\u6237\u6001\u9891\u7e41\u5730\u8bfb\u53d6\u6027\u80fd\u8ba1\u6570\u5668\uff08cap_user_rdpmc\uff09\uff0c\u907f\u514d\u9891\u7e41\u8fdb\u5165\u5185\u6838\u7684\u5f00\u9500\uff0c\u4e5f\u53ef\u4ee5\u5728\u7528\u6237\u6001\u4e2d\u76f4\u63a5\u8bfb\u53d6\u6027\u80fd\u8ba1\u6570\u5668 PMCCNTR_EL0/PMEVCNTR<n>_EL0\uff1a\u5185\u6838\u5728 PMUSERENR_EL0 \u4e2d\u8fdb\u884c\u76f8\u5e94\u7684\u6743\u9650\u914d\u7f6e\u5373\u53ef\u3002v3.9 \u6216\u66f4\u9ad8\u7248\u672c\u7684 PMU \u5b9e\u73b0\u5141\u8bb8\u6309\u7167\u6bcf\u4e2a counter \u7684\u7c92\u5ea6\u6765\u63a7\u5236\u7528\u6237\u6001\u662f\u5426\u5141\u8bb8\u8bbf\u95ee\uff08PMUACR\uff09\u3002</p>\n<p>LoongArch \u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u5176\u63a5\u53e3\u66f4\u7b80\u5355\uff1a\u5b83\u53ea\u6709\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6709\u5982\u4e0b\u7684 csr \u6765\u914d\u7f6e\u5404\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\uff1a</p>\n<ol>\n<li>\u6027\u80fd\u8ba1\u6570\u5668\u7684\u503c\uff1aperfcntr<n></li>\n<li>\u6027\u80fd\u8ba1\u6570\u5668\u7684\u914d\u7f6e\uff1aperfctrl<n>\uff0c\u6709\u5982\u4e0b\u5b57\u6bb5\uff1a<ol>\n<li>EVENT: \u4e8b\u4ef6\u7f16\u53f7</li>\n<li>PLV{0,1,2,3}: \u7279\u6743\u6001\u8fc7\u6ee4\uff0c\u5bf9\u5e94\u56db\u4e2a\u7279\u6743\u6001\u4e0b\u662f\u5426\u91c7\u6837</li>\n<li>IE\uff1a\u662f\u5426\u542f\u7528\u6ea2\u51fa\u4e2d\u65ad</li>\n</ol>\n</li>\n<li>misc.rpcntl3\uff1a\u5141\u8bb8\u7528\u6237\u6001\u7a0b\u5e8f\u8bfb\u53d6\u6027\u80fd\u8ba1\u6570\u5668</li>\n</ol>\n<h3 id=\"\u5185\u6838\u9a71\u52a8\">\u5185\u6838\u9a71\u52a8<a class=\"headerlink\" href=\"#\u5185\u6838\u9a71\u52a8\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 Linux \u5185\u6838\u4e2d\uff0c\u8d1f\u8d23\u63a7\u5236 ARM \u6027\u80fd\u8ba1\u6570\u63a5\u53e3\u7684\u4ee3\u7801\u5728 <a href=\"https://github.com/torvalds/linux/blob/master/drivers/perf/arm_pmuv3.c\">arm_pmuv3.c</a> \u5f53\u4e2d\u3002\u6839\u636e\u8fd9\u4e2a\u786c\u4ef6\u63a5\u53e3\uff0c\u53ef\u4ee5\u9884\u60f3\u5230\uff0c\u5982\u679c\u8981\u5bf9\u4e00\u6bb5\u7a0b\u5e8f\u89c2\u5bdf\u5b83\u5728\u67d0\u4e2a\u8ba1\u6570\u5668\u4e0a\u7684\u53d6\u503c\uff0c\u9700\u8981\uff1a</p>\n<ol>\n<li>\u5206\u914d\u4e00\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u53ef\u80fd\u662f Cycle \u8ba1\u6570\u5668\u6216\u8005\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff1a\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L938\">armv8pmu_get_event_idx</a> \u51fd\u6570\uff0c\u5148\u5206\u914d Cycle \u8ba1\u6570\u5668\uff0c\u518d\u4ece\u5269\u4e0b\u7684\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\u4e2d\u627e\u5230\u4e00\u4e2a\u7a7a\u95f2\u7684</li>\n<li>\u914d\u7f6e\u5e76\u542f\u7528\u8be5\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L796\">armv8pmu_enable_event</a> \u51fd\u6570\uff1a<ol>\n<li>\u628a\u4e8b\u4ef6\u7c7b\u578b\u5199\u5165\u5230 PMEVTYPER<n>_EL0 \u4e2d\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L629\">armv8pmu_write_event_type</a> \u51fd\u6570</li>\n<li>\u542f\u7528\u4e8b\u4ef6\u5bf9\u5e94\u7684\u6ea2\u51fa\u4e2d\u65ad\uff0c\u5199\u5165 PMINTENSET_EL1\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L714\">armv8pmu_enable_event_irq</a> \u51fd\u6570</li>\n<li>\u4e8b\u4ef6\u5f00\u59cb\u8ba1\u6570\uff0c\u5199\u5165 PMCNTENSET_EL0\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L675\">armv8pmu_enable_event_counter</a> \u51fd\u6570</li>\n</ol>\n</li>\n<li>\u5728\u7a0b\u5e8f\u5f00\u59cb\u524d\uff0c\u4ece PMEVCNTR<n>_EL0 \u8bfb\u53d6\u4e00\u6b21\u8ba1\u6570\u5668\u7684\u5f53\u524d\u53d6\u503c\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L566\">armv8pmu_read_counter</a> \u51fd\u6570</li>\n<li>\u5728\u7a0b\u5e8f\u7ed3\u675f\u65f6\uff0c\u518d\u8bfb\u53d6\u4e00\u6b21\u8ba1\u6570\u5668\u7684\u5f53\u524d\u53d6\u503c\uff0c\u548c\u7a0b\u5e8f\u5f00\u59cb\u65f6\u7684\u503c\u6c42\u5dee</li>\n<li>\u4e3a\u4e86\u89e3\u51b3\u6ea2\u51fa\u7684\u95ee\u9898\uff1a\u914d\u7f6e\u4e2d\u65ad\uff0c\u5728\u6ea2\u51fa\u65f6\u4f1a\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u4ee3\u7801\uff0c\u7edf\u8ba1\u6ea2\u51fa\u6b21\u6570\uff0c\u8ba1\u5165\u5dee\u503c\u7684\u9ad8\u4f4d\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L840\">armv8pmu_handle_irq</a> \u51fd\u6570</li>\n</ol>\n<h3 id=\"perf-\u5b50\u7cfb\u7edf\">Perf \u5b50\u7cfb\u7edf<a class=\"headerlink\" href=\"#perf-\u5b50\u7cfb\u7edf\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9664\u4e86\u7531\u5355\u72ec\u7684\u67b6\u6784\u76f8\u5173\u7684\u5185\u6838\u9a71\u52a8\u8d1f\u8d23\u914d\u7f6e\u786c\u4ef6\u4ee5\u5916\uff0c\u8fd8\u9700\u8981\u7531 Perf \u5b50\u7cfb\u7edf\u6765\u5904\u7406\u6765\u81ea\u7528\u6237\u7684 perf \u4f7f\u7528\u3002\u5177\u4f53\u5730\uff0c\u5185\u6838\u9a71\u52a8\u4f1a\u6ce8\u518c\u4e00\u4e2a <code>struct pmu</code> \u7ed9 Perf \u5b50\u7cfb\u7edf\uff0c\u5b9e\u73b0\u8fd9\u4e9b\u51fd\u6570\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\">// Fully disable/enable this PMU</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">pmu_enable</span><span class=\"p\">)</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pmu</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">pmu</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"cm\">/* optional */</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">pmu_disable</span><span class=\"p\">)</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pmu</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">pmu</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"cm\">/* optional */</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"c1\">// Try and initialize the event for this PMU.</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">event_init</span><span class=\"p\">)</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"c1\">// Adds/Removes a counter to/from the PMU</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"kt\">int</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">add</span><span class=\"p\">)</span><span class=\"w\">         </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">del</span><span class=\"p\">)</span><span class=\"w\">         </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"c1\">// Starts/Stops a counter present on the PMU.</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">start</span><span class=\"p\">)</span><span class=\"w\">           </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">stop</span><span class=\"p\">)</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"c1\">// Updates the counter value of the event.</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">read</span><span class=\"p\">)</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u53ef\u89c1\u5728\u5185\u6838\u91cc\uff0cPMU \u8ba1\u6570\u5668\u7684\u62bd\u8c61\u662f <code>struct perf_event</code>\uff0c\u8fd9\u4e2a\u662f\u67b6\u6784\u65e0\u5173\u7684\uff0c\u6839\u636e\u7528\u6237\u6001\u7a0b\u5e8f\u901a\u8fc7 <code>perf_event_open</code> \u6784\u9020\u51fa\u6765\u7684\uff1b\u5185\u6838\u9a71\u52a8\u5c31\u4f1a\u6839\u636e\u8fd9\u4e2a <code>struct perf_event</code> \u53bb\u8fdb\u884c\u5b9e\u9645\u7684\u786c\u4ef6\u8ba1\u6570\u5668\u7684\u914d\u7f6e\u3002\u4f8b\u5982\u7528\u6237\u7a0b\u5e8f\u5728 <code>struct perf_event_attr</code> \u91cc\u8bbe\u7f6e <code>exclude_kernel = 1</code>\uff0c\u5c31\u4f1a\u4f20\u5230 <code>struct perf_event</code> \u5f53\u4e2d\uff0c\u6700\u540e\u5728\u76f8\u5e94\u7684\u5185\u6838\u9a71\u52a8\u4e2d\uff0c\u53d8\u6210\u786c\u4ef6\u6027\u80fd\u8ba1\u6570\u5668\u914d\u7f6e\u91cc\uff0c\u8ba1\u6570\u65f6\u5ffd\u7565\u5185\u6838\u6240\u5728\u7279\u6743\u6001\u7684\u914d\u7f6e\u3002</p>\n<p><code>perf record</code> \u662f\u57fa\u4e8e\u91c7\u6837\u5b9e\u73b0\u7684\uff1a\u5f53\u6027\u80fd\u8ba1\u6570\u5668\u6ea2\u51fa\uff08\u4e00\u822c\u662f Cycle \u8ba1\u6570\u5668\uff09\u7684\u65f6\u5019\uff0c\u89e6\u53d1\u4e2d\u65ad\u8fdb\u5165\u5185\u6838\uff0c\u6b64\u65f6\u7531\u8f6f\u4ef6\u6765\u6536\u96c6\u88ab\u6253\u65ad\u7684\u7a0b\u5e8f\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u6536\u96c6\u5b8c\u6210\u540e\u518d\u56de\u5230\u88ab\u6253\u65ad\u7684\u7a0b\u5e8f\u7ee7\u7eed\u6267\u884c\u3002</p>\n<h3 id=\"\u865a\u62df\u5316\">\u865a\u62df\u5316<a class=\"headerlink\" href=\"#\u865a\u62df\u5316\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u865a\u62df\u5316\u573a\u666f\u4e0b\uff0c\u4f9d\u7136\u5e0c\u671b\u865a\u62df\u673a\u5185\u7684 OS \u53ef\u4ee5\u6709\u6027\u80fd\u8ba1\u6570\u5668\u53ef\u4ee5\u7528\uff0c\u540c\u65f6\u5bbf\u4e3b\u673a\u4e0a\u4e5f\u53ef\u80fd\u5e0c\u671b\u83b7\u53d6\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\u4fe1\u606f\u3002</p>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f\u4ee5\u7eaf\u8f6f\u4ef6\u7684\u65b9\u6cd5\u53bb\u5b9e\u73b0\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6bd4\u5982 <a href=\"https://github.com/qemu/qemu/blob/1cf9bc6eba7506ab6d9de635f224259225f63466/target/arm/helper.c#L996\">QEMU \u7684 TCG \u6a21\u5f0f</a>\uff0c\u53ef\u4ee5\u6a21\u62df\u51fa\u4e00\u4e2a\u4ee5\u56fa\u5b9a\u9891\u7387\u8fd0\u884c\u7684\u5904\u7406\u5668\u7684 Cycle \u8ba1\u6570\u5668\uff0c\u4f46\u5b9e\u9645\u4e0a\u5c31\u662f\u62ff\u65f6\u95f4\u9664\u4ee5\u9891\u7387\uff0c\u662f\u5047\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff1b\u6b64\u5916\u8fd8\u80fd\u6a21\u62df\u51fa Instruction \u8ba1\u6570\u5668\uff0c\u56e0\u4e3a QEMU \u5728\u505a\u6307\u4ee4\u7ffb\u8bd1\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u987a\u5e26\u8bb0\u5f55\u4e0b\u6267\u884c\u7684\u6307\u4ee4\u6570\uff1b\u800c\u5fae\u67b6\u6784\u76f8\u5173\u7684\u6027\u80fd\u8ba1\u6570\u5668\u5c31\u6ca1\u6cd5\u9760\u8fd9\u4e2a\u6765\u5b9e\u73b0\u4e86\u3002</p>\n<p>\u53e6\u4e00\u79cd\u65b9\u6cd5\u5219\u662f\u5728\u786c\u4ef6\u865a\u62df\u5316\u7684\u57fa\u7840\u4e0a\uff0c\u8ba9\u865a\u62df\u673a\u4eab\u53d7\u5230\u6027\u80fd\u8ba1\u6570\u5668\u3002\u4e0d\u8fc7\u4e3a\u4e86\u5b89\u5168\u6027\uff0c\u5bbf\u4e3b\u673a\u53ef\u4ee5\u83b7\u53d6\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u4f46\u53cd\u8fc7\u6765\uff0c\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\u4e0d\u5e94\u8be5\u5f97\u5230\u5bbf\u4e3b\u673a\u7684\u4fe1\u606f\u3002</p>\n<p>\u76ee\u524d LoongArch KVM \u5df2\u7ecf\u652f\u6301\u6027\u80fd\u8ba1\u6570\u5668\u7684\u865a\u62df\u5316\uff0c\u4e0b\u9762\u6765\u770b\u5b83\u662f\u600e\u4e48\u505a\u7684\uff1a</p>\n<ol>\n<li>\u7ed9\u5bbf\u4e3b\u673a\uff08host\uff09\u7ef4\u62a4\u4e00\u4efd\u6027\u80fd\u8ba1\u6570\u5668\u7684\u4e0a\u4e0b\u6587\uff0c\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L35\">kvm_save_host_pmu</a> \u4fdd\u5b58\uff0c\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L50\">kvm_restore_host_pmu</a> \u6062\u590d</li>\n<li>\u518d\u7ed9\u6bcf\u4e2a\u865a\u62df\u673a\uff08guest\uff09\u7ef4\u62a4\u4e00\u4efd\u6027\u80fd\u8ba1\u6570\u5668\u7684\u4e0a\u4e0b\u6587\uff0c\u6b64\u65f6\u4e3a\u4e86\u8bbf\u95ee\u865a\u62df\u673a\u7684 csr\uff0c\u8981\u8bbf\u95ee gcsr(guest csr)\uff1a\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L66\">kvm_save_guest_pmu</a> \u4fdd\u5b58\uff0c\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L80\">kvm_restore_guest_pmu</a></li>\n<li>\u5f53\u865a\u62df\u673a\uff08guest\uff09\u56e0\u4e3a\u5404\u79cd\u539f\u56e0\u56de\u5230\u4e86 VMM\uff0c\u5c31\u8981\u8fdb\u884c<a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L94\">\u4e0a\u4e0b\u6587\u5207\u6362</a>\uff0c\u4fdd\u5b58\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6062\u590d\u5bbf\u4e3b\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff1b\u540c\u7406\uff0c\u8fdb\u5165\u865a\u62df\u673a\u65f6\uff0c\u518d\u6b21\u8fdb\u884c<a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L113\">\u4e0a\u4e0b\u6587\u5207\u6362</a>\uff0c\u4fdd\u5b58\u5bbf\u4e3b\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6062\u590d\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668</li>\n</ol>\n<h2 id=\"intel-pt\">Intel PT<a class=\"headerlink\" href=\"#intel-pt\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel PT \u662f Intel \u5e73\u53f0\u4e0a\u8ddf\u8e2a\u6307\u4ee4\u6d41\u7684\u673a\u5236\uff0c\u5b83\u53ef\u4ee5\u8bb0\u5f55\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u9875\u8868\u7684\u4fee\u6539</li>\n<li>\u65f6\u949f\u5468\u671f</li>\n<li>\u5206\u652f\u8df3\u8f6c</li>\n<li>\u529f\u8017\u72b6\u6001\u53d8\u5316</li>\n</ol>\n<p>perf \u5de5\u5177\u4e5f\u662f\u652f\u6301\u7528 Intel PT \u8fdb\u884c\u8ddf\u8e2a\u7684\uff1a<a href=\"https://www.man7.org/linux/man-pages/man1/perf-intel-pt.1.html\">perf-intel-pt(1) \u2014 Linux manual page</a>\uff0c\u4e0b\u9762\u7684\u547d\u4ee4\u7528 Intel PT \u8ddf\u8e2a\u4e00\u6761\u547d\u4ee4\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u5e76\u663e\u793a\u51fa\u5b83\u751f\u6210\u7684\u8ddf\u8e2a\u4fe1\u606f\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>perf<span class=\"w\"> </span>record<span class=\"w\"> </span>-e<span class=\"w\"> </span>intel_pt//u<span class=\"w\"> </span>ls\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"c1\"># itrace: instruction trace</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"c1\"># i: instructions events</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"c1\"># y: cycles events</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"c1\"># b: branches events</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"c1\"># x: transactions events</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"c1\"># w: ptwrite events</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a><span class=\"c1\"># p: power events</span>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"c1\"># e: error events</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a>perf<span class=\"w\"> </span>script<span class=\"w\"> </span>--itrace<span class=\"o\">=</span>iybxwpe\n</span></code></pre></div>\n<p>\u6bd4\u5982\u5199\u4e00\u4e2a\u5faa\u73af 10 \u6b21\u7684\u4ee3\u7801\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5bf9\u5e94\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"err\">0000000000001129</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">main</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"err\">1129:</span><span class=\"w\">       </span><span class=\"err\">55</span><span class=\"w\">                      </span><span class=\"nf\">push</span><span class=\"w\">   </span><span class=\"nv\">%rbp</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"err\">112</span><span class=\"nl\">a:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"err\">89</span><span class=\"w\"> </span><span class=\"nf\">e5</span><span class=\"w\">                </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"nv\">%rsp</span><span class=\"p\">,</span><span class=\"nv\">%rbp</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"err\">112</span><span class=\"nl\">d:</span><span class=\"w\">       </span><span class=\"nf\">c7</span><span class=\"w\"> </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"no\">fc</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">movl</span><span class=\"w\">   </span><span class=\"no\">$0x0</span><span class=\"p\">,-</span><span class=\"mi\">0x4</span><span class=\"p\">(</span><span class=\"nv\">%rbp</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"err\">1134:</span><span class=\"w\">       </span><span class=\"nf\">eb</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\">                   </span><span class=\"no\">jmp</span><span class=\"w\">    </span><span class=\"mh\">113a</span> <span class=\"p\">&lt;</span><span class=\"no\">main</span><span class=\"p\">+</span><span class=\"mi\">0x11</span><span class=\"p\">&gt;</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"err\">1136:</span><span class=\"w\">       </span><span class=\"err\">83</span><span class=\"w\"> </span><span class=\"err\">45</span><span class=\"w\"> </span><span class=\"nf\">fc</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">             </span><span class=\"no\">addl</span><span class=\"w\">   </span><span class=\"no\">$0x1</span><span class=\"p\">,-</span><span class=\"mi\">0x4</span><span class=\"p\">(</span><span class=\"nv\">%rbp</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">    </span><span class=\"err\">113</span><span class=\"nl\">a:</span><span class=\"w\">       </span><span class=\"err\">83</span><span class=\"w\"> </span><span class=\"err\">7</span><span class=\"nf\">d</span><span class=\"w\"> </span><span class=\"no\">fc</span><span class=\"w\"> </span><span class=\"mi\">09</span><span class=\"w\">             </span><span class=\"no\">cmpl</span><span class=\"w\">   </span><span class=\"no\">$0x9</span><span class=\"p\">,-</span><span class=\"mi\">0x4</span><span class=\"p\">(</span><span class=\"nv\">%rbp</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"err\">113</span><span class=\"nl\">e:</span><span class=\"w\">       </span><span class=\"err\">7</span><span class=\"nf\">e</span><span class=\"w\"> </span><span class=\"no\">f6</span><span class=\"w\">                   </span><span class=\"no\">jle</span><span class=\"w\">    </span><span class=\"mh\">1136</span> <span class=\"p\">&lt;</span><span class=\"no\">main</span><span class=\"p\">+</span><span class=\"mi\">0xd</span><span class=\"p\">&gt;</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"err\">1140:</span><span class=\"w\">       </span><span class=\"nf\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"no\">$0x0</span><span class=\"p\">,</span><span class=\"nv\">%eax</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"err\">1145:</span><span class=\"w\">       </span><span class=\"err\">5</span><span class=\"nf\">d</span><span class=\"w\">                      </span><span class=\"no\">pop</span><span class=\"w\">    </span><span class=\"nv\">%rbp</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">    </span><span class=\"err\">1146:</span><span class=\"w\">       </span><span class=\"nf\">c3</span><span class=\"w\">                      </span><span class=\"no\">ret</span>\n</span></code></pre></div>\n<p>\u6309\u7167\u4e0a\u8ff0\u65b9\u6cd5\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u751f\u6210\u4e86\u5404\u4e2a\u5206\u652f\u8df3\u8f6c\u7684\u4fe1\u606f\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      7311943d6248 __libc_start_call_main+0x78 (/usr/lib/x86_64-linux-gnu/libc.so.6) =&gt;     5b4f1df51129 main+0x0 (/home/jiegec/test1)\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df51134 main+0xb (/home/jiegec/test1) =&gt;     5b4f1df5113a main+0x11 (/home/jiegec/test1)\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df51146 main+0x1d (/home/jiegec/test1) =&gt;     7311943d624a __libc_start_call_main+0x7a (/usr/lib/x86_64-linux-gnu/libc.so.6)\n</span></code></pre></div>\n<p>\u901a\u8fc7\u8fd9\u4e2a\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u8fd8\u539f\u51fa\u7a0b\u5e8f\u6267\u884c\u4e86\u54ea\u4e9b\u4ee3\u7801\uff1a</p>\n<ol>\n<li>__libc_start_call_main \u8c03\u7528 main \u51fd\u6570\uff0c\u5230\u5165\u53e3 0x1129(main+0x0)</li>\n<li>\u4ece 0x1134(main+0xb) \u8df3\u8f6c\u5230 0x113a(main+0x11)</li>\n<li>\u5faa\u73af 10 \u6b21\uff1a0x113e(main+0x15) \u8df3\u8f6c\u5230 0x1136(main+0xd)</li>\n<li>\u6700\u7ec8 \u5728 0x1146(main+0x1d) return \u56de\u5230 __libc_start_call_main \u51fd\u6570</li>\n</ol>\n<p>\u5982\u679c\u8981\u770b Intel PT \u5230\u5e95\u751f\u6210\u4e86\u4ec0\u4e48\u6570\u636e\uff0c\u53ef\u4ee5\u7528 <code>perf script -D</code> \u663e\u793a\u3002\u4f8b\u5982\u8981\u8bb0\u5f55\u5206\u652f\u8df3\u8f6c\u8fd8\u662f\u4e0d\u8df3\u8f6c\u7684\u5386\u53f2\uff0c\u7528\u7684\u662f\u5982\u4e0b\u7684 TNT(Taken/Not Taken) packet\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-perf-pmu-intel-pt-dump.png\" /></p>\n<p>TNT packet \u7684\u5b9a\u4e49\u5728 <a href=\"https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html\">Intel\u00ae 64 and IA-32 Architectures Software Developer Manuals</a> \u4e2d\u7ed9\u51fa\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-perf-pmu-intel-tnt.png\" /></p>\n<p>\u7531\u4e8e Intel PT \u7684\u6570\u636e\u91cf\u5f88\u5927\uff0c\u5b83\u548c SPE \u7c7b\u4f3c\uff0c\u4e5f\u662f\u5728\u5185\u5b58\u4e2d\u4fdd\u5b58 trace \u4fe1\u606f\u3002</p>\n<h2 id=\"intel-lbr\">Intel LBR<a class=\"headerlink\" href=\"#intel-lbr\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel LBR(Last Branch Record) \u673a\u5236\u8bb0\u5f55\u4e86\u5904\u7406\u5668\u6700\u8fd1\u82e5\u5e72\u6b21\u63a7\u5236\u6d41\u8f6c\u79fb\uff0c\u6bd4\u5982 taken branch\u3002\u5b83\u8bb0\u5f55\u7684\u6570\u91cf\u5f88\u5c0f\uff0c\u4fe1\u606f\u76f4\u63a5\u4fdd\u5b58\u5728 MSR \u5f53\u4e2d\uff0c\u800c\u4e0d\u662f\u50cf\u524d\u9762\u7684 SPE \u548c Intel PT \u90a3\u6837\uff0c\u9700\u8981\u5728\u5185\u5b58\u4e2d\u8bb0\u5f55\u4fe1\u606f\u3002</p>\n<p>LBR \u5728 perf \u4e2d\uff0c\u4e3b\u8981\u7528\u6765\u8ddf\u8e2a call stack\uff1a\u8bbe\u7f6e LBR\uff0c\u53ea\u8bb0\u5f55 call \u6307\u4ee4\uff0c\u5e76\u4e14\u6253\u5f00 call-stack \u6a21\u5f0f\uff0c\u90a3\u4e48 LBR \u8bb0\u5f55\u7684\u5c31\u662f\u5f53\u524d\u7684 call stack\uff0cperf \u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a\u4fe1\u606f\u6765\u627e\u5230\u5f53\u524d\u51fd\u6570\u7684\u8c03\u7528\u94fe\uff0c\u867d\u7136\u6709\u957f\u5ea6\u9650\u5236\u3002\u9664\u4e86 lbr \u4ee5\u5916\uff0cperf \u8fd8\u652f\u6301\u5229\u7528 fp(frame pointer) \u6216 dwarf(\u8c03\u8bd5\u4fe1\u606f) \u6765<a href=\"https://man7.org/linux/man-pages/man1/perf-record.1.html\">\u5bfb\u627e\u8c03\u7528\u94fe</a>\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a>--call-graph\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a>    Setup and enable call-graph (stack chain/backtrace)\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a>    recording, implies -g. Default is &quot;fp&quot; (for user space).\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a>    Valid options are &quot;fp&quot; (frame pointer), &quot;dwarf&quot; (DWARF&#39;s CFI -\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>    Call Frame Information) or &quot;lbr&quot; (Hardware Last Branch Record\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>    facility).\n</span></code></pre></div>\n<p>\u548c Intel PT \u76f8\u6bd4\uff0c\u5b83\u8bb0\u5f55\u7684\u4fe1\u606f\u8f83\u5c11\uff0c\u4f46\u5b9e\u73b0\u4e0a\u4e5f\u66f4\u7b80\u5355\uff0c\u5f00\u9500\u66f4\u5c0f\u3002\u800c\u4e14 LBR \u53ea\u4f1a\u8bb0\u5f55\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u4e0d\u4f1a\u8bb0\u5f55\u6ca1\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u6b64\u5916\u5c31\u662f\u8bb0\u5f55\u7684\u5206\u652f\u6570\u6709\u4e0a\u9650\u3002</p>\n<h2 id=\"intel-bts\">Intel BTS<a class=\"headerlink\" href=\"#intel-bts\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8f83\u65e9\u7684 Intel \u5904\u7406\u5668\u6ca1\u6709\u5b9e\u73b0 Intel PT\uff0c\u4f46\u8003\u8651\u5230 LBR \u8bb0\u5f55\u7684\u5386\u53f2\u957f\u5ea6\u9650\u5236\uff0c\u57fa\u4e8e LBR \u505a\u4e86\u4e00\u4e2a\u628a LBR \u4fe1\u606f\u4fdd\u5b58\u5230\u5185\u5b58\u91cc\u7684\u6280\u672f\uff0c\u53eb\u505a Branch Trace Store\u3002perf \u4e5f\u652f\u6301<a href=\"https://github.com/torvalds/linux/blob/master/tools/perf/Documentation/intel-bts.txt\">\u57fa\u4e8e BTS</a> \u6765\u8bb0\u5f55\u5206\u652f\u5386\u53f2\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"c1\"># record</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a>sudo<span class=\"w\"> </span>perf<span class=\"w\"> </span>record<span class=\"w\"> </span>--per-thread<span class=\"w\"> </span>-e<span class=\"w\"> </span>intel_bts//u<span class=\"w\"> </span>ls\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"c1\"># display trace</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a>sudo<span class=\"w\"> </span>perf<span class=\"w\"> </span>script\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"c1\"># dump raw data</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a>sudo<span class=\"w\"> </span>perf<span class=\"w\"> </span>script<span class=\"w\"> </span>-D\n</span></code></pre></div>\n<p>BTS \u6bcf\u4e2a entry \u5360\u7528 24 \u5b57\u8282\uff0c\u5305\u62ec 8 \u5b57\u8282\u7684 Last Branch From \u548c 8 \u5b57\u8282\u7684 Last Branch To\uff0c\u8fd8\u6709 8 \u5b57\u8282\u8bb0\u5f55\u4e86\u5206\u652f\u9884\u6d4b\u6b63\u786e\u8fd8\u662f\u9519\u8bef\uff08\u56fe\u6e90 <a href=\"https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html\">Intel\u00ae 64 and IA-32 Architectures Software Developer Manuals</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-perf-pmu-intel-bts.png\" /></p>\n<p>\u548c LBR \u4e00\u6837\uff0cBTS \u53ea\u8bb0\u5f55\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u4e0d\u8bb0\u5f55\u6ca1\u8df3\u8f6c\u7684\u5206\u652f\u3002</p>\n<h2 id=\"intel-pebs\">Intel PEBS<a class=\"headerlink\" href=\"#intel-pebs\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel PEBS(Processor Event Based Sampling) \u662f\u4e00\u79cd\u786c\u4ef6\u7684\u91c7\u6837\u65b9\u6cd5\uff0c\u987e\u540d\u601d\u4e49\uff0c\u5f53\u5904\u7406\u5668\u89e6\u53d1\u67d0\u4e9b\u4e8b\u4ef6\u65f6\uff0c\u81ea\u52a8\u8fdb\u884c\u4e00\u6b21\u91c7\u6837\u3002\u8fd9\u4e2a\u4e8b\u4ef6\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u67d0\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\u6ea2\u51fa\u3002\u672c\u6765\uff0c\u6027\u80fd\u8ba1\u6570\u5668\u6ea2\u51fa\u7684\u65f6\u5019\uff0c\u5e94\u8be5\u89e6\u53d1\u4e2d\u65ad\uff0c\u8ba9\u5185\u6838\u7ef4\u62a4\u6027\u80fd\u8ba1\u6570\u5668\u7684\u771f\u5b9e\u503c\uff08\u4f8b\u5982\u786c\u4ef6\u5b9e\u73b0\u4e86 32 \u4f4d\u8ba1\u6570\u5668\uff0c\u4f46\u5185\u6838\u7ef4\u62a4\u7684\u662f 64 \u4f4d\uff09\uff1b\u4f46\u5728 PEBS \u4e2d\uff0c\u8fd9\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\u7684\u6ea2\u51fa\u4e8b\u4ef6\u88ab\u7528\u6765\u89e6\u53d1\u786c\u4ef6\u7684\u91c7\u6837\uff1a\u8ba1\u6570\u6ea2\u51fa\u7684\u65f6\u5019\uff0c\u4f1a\u6355\u6349\u5f53\u524d\u7684\u5904\u7406\u5668\u72b6\u6001\uff08PC\u3001\u8bbf\u5b58\u5730\u5740\u548c\u5ef6\u8fdf\u3001\u901a\u7528\u5bc4\u5b58\u5668\u548c\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u503c\u3001\u65f6\u949f\u5468\u671f\u8ba1\u6570\u548c LBR \u4fe1\u606f\uff09\uff0c\u628a\u72b6\u6001\u5199\u5165\u5230\u5185\u5b58\u4e2d\u7684\u7f13\u51b2\u533a\uff0c\u5e76\u81ea\u52a8\u628a\u6027\u80fd\u8ba1\u6570\u5668\u8bbe\u4e3a\u6307\u5b9a\u7684\u590d\u4f4d\u503c\u3002\u5f53\u5185\u5b58\u4e2d\u7684\u7f13\u51b2\u533a\u6ee1\u7684\u65f6\u5019\uff0c\u624d\u4f1a\u89e6\u53d1\u4e2d\u65ad\uff0c\u8ba9\u5185\u6838\u6765\u5904\u7406 PEBS \u751f\u6210\u7684\u6570\u636e\uff0c\u5e76\u5206\u914d\u65b0\u7684\u7a7a\u95f4\u3002</p>\n<p>PEBS \u53ef\u4ee5\u7cbe\u7ec6\u5730\u6839\u636e\u6027\u80fd\u8ba1\u6570\u5668\u6765\u51b3\u5b9a\u91c7\u6837\u7684\u9891\u7387\uff0c\u4f8b\u5982\u6bcf 1000 \u6761\u6307\u4ee4\u91c7\u6837\u4e00\u6b21\uff0c\u6bcf 1000 \u4e2a\u5468\u671f\u91c7\u6837\u4e00\u6b21\uff0c\u751a\u81f3\u6bcf 1000 \u6b21\u7f13\u5b58\u7f3a\u5931\u91c7\u6837\u4e00\u6b21\u3002\u5177\u4f53\u505a\u6cd5\u662f\uff0c\u628a\u5bf9\u5e94\u7684\u6027\u80fd\u8ba1\u6570\u5668\u7684\u590d\u4f4d\u503c\u8bbe\u7f6e\u4e3a\u6700\u5927\u503c\u51cf 1000\uff0c\u90a3\u4e48\u6bcf\u6b21\u6ea2\u51fa\u89e6\u53d1 PEBS \u91c7\u6837\u4ee5\u540e\uff0c\u6027\u80fd\u8ba1\u6570\u5668\u4f1a\u88ab\u8bbe\u7f6e\u4e3a\u6700\u5927\u503c\u51cf 1000\uff0c\u7b49\u6027\u80fd\u8ba1\u6570\u5668\u589e\u52a0 1000 \u4ee5\u540e\uff0c\u518d\u6b21\u6ea2\u51fa\uff0c\u89e6\u53d1 PEBS \u91c7\u6837\uff0c\u5982\u6b64\u5faa\u73af\u3002</p>\n<p>AMD \u4e5f\u6709\u7c7b\u4f3c\u7684\u673a\u5236\uff0c\u53eb\u505a IBS(Instruction Based Sampling)\u3002IBS \u6ca1\u6709\u548c PMU \u7ed1\u5b9a\u8d77\u6765\uff0c\u800c\u662f\u6570\u6307\u4ee4\u6570\u6216\u6570\u5468\u671f\u3002\u63a8\u8350\u9605\u8bfb\u8bba\u6587 <a href=\"https://ieeexplore.ieee.org/document/10068807\">Precise Event Sampling on AMD Versus Intel: Quantitative and Qualitative Comparison</a>\uff0c\u5b83\u6df1\u5165\u6bd4\u8f83\u4e86 AMD IBS \u548c Intel PEBS \u7684\u5dee\u5f02\u3002</p>\n<p>\u5982\u679c\u8981\u542f\u7528 PEBS \u6216 IBS\uff0c\u5728 <code>perf record</code> \u6307\u4ee4\u4e8b\u4ef6\u65f6\uff0c\u8ffd\u52a0 <code>:p</code>\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a>The p modifier can be used for specifying how precise the instruction address should be. The p modifier can be specified\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a>multiple times:\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a>    0 - SAMPLE_IP can have arbitrary skid\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a>    1 - SAMPLE_IP must have constant skid\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a>    2 - SAMPLE_IP requested to have 0 skid\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a>    3 - SAMPLE_IP must have 0 skid, or uses randomization to avoid\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a>        sample shadowing effects.\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a>For Intel systems precise event sampling is implemented with PEBS which supports up to precise-level 2, and precise level 3 for some special cases.\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a>On AMD systems it is implemented using IBS OP (up to precise-level 2).\n</span></code></pre></div>\n<p>\u8be6\u7ec6\u4fe1\u606f\u89c1 <a href=\"https://man7.org/linux/man-pages/man1/perf-list.1.html\">perf-list(1) \u2014 Linux manual page</a>\u3002</p>\n<h2 id=\"arm-brbe\">ARM BRBE<a class=\"headerlink\" href=\"#arm-brbe\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u5e73\u53f0\u5b9a\u4e49\u4e86 BRBE(Branch Record Buffer Extension)\uff0c\u5b83\u548c Intel LBR \u7c7b\u4f3c\uff0c\u4e5f\u662f\u5728 System Register \u4e2d\u8bb0\u5f55\u6700\u8fd1\u82e5\u5e72\u6761\u8df3\u8f6c\u7684\u5206\u652f\u7684\u4fe1\u606f\u3002\u5b83\u4f1a\u8bb0\u5f55 taken branch \u7684\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6e90\u5730\u5740</li>\n<li>\u76ee\u7684\u5730\u5740</li>\n<li>\u8ddd\u79bb\u4e0a\u4e00\u6b21 taken branch \u7684\u5468\u671f\u6570</li>\n<li>\u5206\u652f\u7c7b\u578b</li>\n<li>\u7279\u6743\u6001\uff08EL\uff09</li>\n<li>\u5206\u652f\u9884\u6d4b\u7ed3\u679c</li>\n</ol>\n<p>\u4e0d\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u5c31\u4e0d\u8bb0\u5f55\u3002\u548c LBR \u7c7b\u4f3c\uff0c\u5b83\u4e5f\u652f\u6301\u6839\u636e\u5206\u652f\u7c7b\u578b\u8fc7\u6ee4\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u7528\u4e8e call graph \u7684\u6293\u53d6\u3002</p>\n<h2 id=\"arm-spe\">ARM SPE<a class=\"headerlink\" href=\"#arm-spe\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u5e73\u53f0\u5b9a\u4e49\u4e86 SPE(Statistical Profiling Extension)\uff0c\u5b83\u7684\u505a\u6cd5\u662f\u57fa\u4e8e\u91c7\u6837\u7684\uff1a\u786c\u4ef6\u4e0a\u6bcf\u8fc7\u4e00\u6bb5\u65f6\u95f4\uff0c\u91c7\u6837\u4e00\u4e2a\u64cd\u4f5c\uff0c\u6bd4\u5982\u6b63\u5728\u6267\u884c\u7684\u6307\u4ee4\uff1b\u91c7\u6837\u5f97\u5230\u7684\u64cd\u4f5c\u7684\u8be6\u7ec6\u4fe1\u606f\u4f1a\u5199\u5165\u5230\u5185\u5b58\u5f53\u4e2d\uff0c\u7531\u5185\u6838\u9a71\u52a8\u51c6\u5907\u597d\u7684\u4e00\u6bb5\u7a7a\u95f4\u3002\u7a7a\u95f4\u6ee1\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u4e2d\u65ad\u901a\u77e5\u5185\u6838\u5e76\u8ba9\u5185\u6838\u91cd\u65b0\u5206\u914d\u7a7a\u95f4\u3002</p>\n<p><code>perf record</code> \u5728\u9ed8\u8ba4\u53c2\u6570\u4e0b\u7684\u5de5\u4f5c\u539f\u7406\u548c SPE \u6709\u70b9\u50cf\uff0c\u90fd\u662f\u5b9a\u65f6\u6253\u65ad\u7a0b\u5e8f\u5e76\u91c7\u6837\uff1a\u4f46 <code>perf record</code> \u662f\u5728\u7a0b\u5e8f\u88ab\u6253\u65ad\u540e\uff0c\u7531\u8f6f\u4ef6\u6765\u6536\u96c6\u4fe1\u606f\uff1b\u800c SPE \u662f\u7531\u786c\u4ef6\u91c7\u6837\uff0c\u53ef\u4ee5\u63d0\u4f9b\u66f4\u591a\u7684\u5fae\u67b6\u6784\u4fe1\u606f\uff08\u5ef6\u8fdf\uff0c\u8bbf\u5b58\u5730\u5740\uff0c\u662f\u5426\u547d\u4e2d TLB\uff0c\u5206\u652f\u8df3\u8f6c\u4e0e\u5426\u7b49\u7b49\uff09\u3002</p>\n<p>SPE \u7684\u5185\u6838\u9a71\u52a8\u5b9e\u73b0\u5728 <a href=\"https://github.com/torvalds/linux/blob/f92f4749861b06fed908d336b4dee1326003291b/drivers/perf/arm_spe_pmu.c#L754\">arm_spe_pmu.c</a> \u5f53\u4e2d\uff1b\u5b83\u505a\u7684\u4e8b\u60c5\u662f\uff0c\u5728\u5185\u5b58\u4e2d\u5206\u914d\u597d\u7f13\u51b2\u533a\uff0c\u542f\u52a8 SPE\uff0c\u5e76\u4e14\u5728 SPE \u89e6\u53d1\u4e2d\u65ad\u65f6\uff0c\u8fdb\u884c\u7f13\u51b2\u533a\u7684\u7ef4\u62a4\uff1b\u540c\u65f6\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\u4f1a\u901a\u8fc7 <a href=\"https://docs.kernel.org/userspace-api/perf_ring_buffer.html\">perf ring buffer (aka perf aux)</a> \u4f20\u9012\u7ed9\u7528\u6237\u6001\u7684\u7a0b\u5e8f\uff0c\u5177\u4f53\u6570\u636e\u7684\u89e3\u6790\u662f\u7531\u7528\u6237\u6001\u7684\u7a0b\u5e8f\u5b8c\u6210\u7684\u3002\u5982\u679c\u7528 perf \u5de5\u5177\uff0c\u90a3\u4e48\u8fd9\u4e2a\u89e3\u6790\u548c\u5c55\u793a\u7684\u5de5\u4f5c\u5c31\u662f\u7531 perf \u5b8c\u6210\u7684\u3002</p>\n<p>SPE \u548c AMD IBS \u7c7b\u4f3c\uff0c\u4e5f\u662f\u6570\u6307\u4ee4\u6570\uff1b\u548c Intel PEBS \u4e0d\u540c\uff0c\u5b83\u6ca1\u6709\u548c\u6027\u80fd\u8ba1\u6570\u5668\u8026\u5408\u8d77\u6765\u3002</p>\n<h2 id=\"arm-amu\">ARM AMU<a class=\"headerlink\" href=\"#arm-amu\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u9664\u4e86\u63d0\u4f9b\u6027\u80fd\u8ba1\u6570\u5355\u5143\uff08PMU\uff09\u4ee5\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86 AMU\uff08Activity Monitor Unit\uff09\u3002\u5b83\u548c PMU \u5f88\u7c7b\u4f3c\uff0c\u4e5f\u662f\u6709\u4e00\u4e9b\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u4f46 AMU \u5728\u8ba1\u6570\u5668\u6ea2\u51fa\u7684\u65f6\u5019\u4e0d\u4f1a\u89e6\u53d1\u4e2d\u65ad\uff0c\u6240\u4ee5\u5b83\u5e76\u4e0d\u662f\u62ff\u6765\u89c2\u5bdf\u67d0\u4e2a\u7a0b\u5e8f\u7684\u6027\u80fd\u600e\u4e48\u6837\uff0c\u800c\u662f\u89c2\u5bdf\u7cfb\u7edf\u6574\u4f53\u7684\u72b6\u6001\uff0c\u6bd4\u5982\u65f6\u949f\u9891\u7387\uff0cIPC \u7b49\u7b49\u3002</p>\n<p>\u76ee\u524d AMU \u7684\u4e3b\u8981\u7528\u9014\u662f\u5728\u5185\u6838\u7684\u8c03\u5ea6\u5668\u4e0a\uff1a\u8c03\u5ea6\u5668\u9700\u8981\u4f30\u8ba1\u4e00\u6bb5\u65f6\u95f4\u5185\u505a\u4e86\u591a\u5c11\u5355\u4f4d\u7684\u4efb\u52a1\uff0c\u9700\u8981\u77e5\u9053 CPU \u7684\u9891\u7387\uff0c\u6bd4\u5982\u9891\u7387\u9ad8\uff0c\u5c31\u8ba4\u4e3a\u5b83\u505a\u4e86\u66f4\u591a\u7684\u4efb\u52a1\u3002\u4e4b\u524d\u7684\u505a\u6cd5\u662f\u8ba9\u8c03\u5ea6\u5668\u901a\u8fc7 cpufreq \u8bfb\u53d6\u5f53\u524d\u7684 CPU \u9891\u7387\uff0c\u4f46\u7531\u4e8e CPU \u7684\u9891\u7387\u4f1a\u4e0d\u65ad\u53d8\u5316\uff0c\u8fd9\u6837\u8bfb\u53d6\u5230\u7684\u9891\u7387\u662f\u4e00\u4e2a\u77ac\u65f6\u529f\u7387\uff0c\u4e0d\u80fd\u4ee3\u8868\u4e00\u6bb5\u65f6\u95f4\u7684\u5e73\u5747\u503c\uff0c\u5c31\u4f1a\u5e26\u6765\u8bef\u5dee\u3002</p>\n<p>\u4e3a\u4e86\u83b7\u53d6\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u5e73\u5747\u9891\u7387\uff0c<a href=\"https://github.com/torvalds/linux/blob/f92f4749861b06fed908d336b4dee1326003291b/arch/arm64/kernel/topology.c#L153\">amu_scale_freq_tick</a> \u51fd\u6570\u5c31\u4f7f\u7528\u4e86 AMU \u7684\u4e24\u4e2a\u8ba1\u6570\u5668\uff1a</p>\n<ol>\n<li>Processor Cycle \u8ba1\u6570\u5668\uff1a\u8bb0\u5f55\u6838\u5fc3\u7684\u5468\u671f\u6570\uff0c\u4e5f\u5c31\u662f\u4ee5 CPU \u9891\u7387\u81ea\u589e\u7684\u8ba1\u6570\u5668</li>\n<li>Constant Cycle \u8ba1\u6570\u5668\uff1a\u4ee5\u56fa\u5b9a\u9891\u7387\uff08\u800c\u975e CPU \u9891\u7387\uff09\u81ea\u589e\u7684\u8ba1\u6570\u5668</li>\n</ol>\n<p>\u901a\u8fc7\u8bb0\u5f55\u4e00\u6bb5\u65f6\u95f4\u5185\u4e24\u4e2a\u8ba1\u6570\u5668\u7684\u53d8\u5316\u91cf\uff0c\u5c06\u4e24\u4e2a\u53d8\u5316\u91cf\u505a\u9664\u6cd5\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u6b63\u6bd4\u4e8e\u8fd9\u6bb5\u65f6\u95f4\u5185 CPU \u7684\u5e73\u5747\u9891\u7387\u7684\u503c\uff0c\u4ea4\u7ed9\u8c03\u5ea6\u5668\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://developer.arm.com/documentation/ddi0487/latest/\">Arm Architecture Reference Manual for A-profile architecture</a></li>\n<li><a href=\"https://loongson.github.io/LoongArch-Documentation/LoongArch-Vol1-EN.html\">LoongArch Reference Manual Volume 1: Basic Architecture</a></li>\n<li><a href=\"https://perfwiki.github.io/main/\">perf: Linux profiling with performance counters</a></li>\n<li><a href=\"https://perfwiki.github.io/main/perf-tools-support-for-intel-processor-trace/\">Perf tools support for Intel\u00ae Processor Trace</a></li>\n<li><a href=\"https://ieeexplore.ieee.org/document/10068807\">Precise Event Sampling on AMD Versus Intel: Quantitative and Qualitative Comparison</a></li>\n</ul>", "image": null, "date_published": "2024-12-10T00:00:00+00:00", "authors": [], "tags": ["aarch64", "arm", "linux", "perf", "pmu", "software"]}, {"id": "https://jia.je/hardware/2024/11/11/amd_zen5/", "url": "https://jia.je/hardware/2024/11/11/amd_zen5/", "title": "AMD Zen 5 \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"amd-zen-5-\u5fae\u67b6\u6784\u8bc4\u6d4b\">AMD Zen 5 \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#amd-zen-5-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>Zen 5 \u662f AMD \u6700\u65b0\u7684\u4e00\u4ee3\u5fae\u67b6\u6784\uff0c\u5728\u5f88\u591a\u5730\u65b9\u548c\u4e4b\u524d\u4e0d\u540c\uff0c\u56e0\u6b64\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD \u4e00\u5411\u516c\u5f00\u5f97\u6bd4\u8f83\u5927\u65b9\uff0c\u5173\u4e8e Zen 5 \u7684\u4fe1\u606f\u6709\uff1a</p>\n<ul>\n<li><a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/58455.zip\">Software Optimization Guide for the AMD Zen5 Microarchitecture</a></li>\n<li><a href=\"https://www.amd.com/content/dam/amd/en/documents/epyc-business-docs/white-papers/5th-gen-amd-epyc-processor-architecture-white-paper.pdf\">5TH GEN AMD EPYC\u2122 PROCESSOR ARCHITECTURE</a></li>\n</ul>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Zen 5 \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://www.phoronix.com/review/amd-zen-5-core\">AMD Reveals More Zen 5 CPU Core Details</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/07/26/zen-5s-2-ahead-branch-predictor-unit-how-30-year-old-idea-allows-for-new-tricks/\">Zen 5\u2019s 2-Ahead Branch Predictor Unit: How a 30 Year Old Idea Allows for New Tricks</a></li>\n<li><a href=\"https://chipsandcheese.com/2023/10/08/zen-5s-leaked-slides/\">Zen 5\u2019s Leaked Slides</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/08/10/amds-strix-point-zen-5-hits-mobile/\">AMD\u2019s Strix Point: Zen 5 Hits Mobile</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/08/14/amds-ryzen-9950x-zen-5-on-desktop/\">AMD\u2019s Ryzen 9950X: Zen 5 on Desktop</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/09/15/discussing-amds-zen-5-at-hot-chips-2024/\">Discussing AMD\u2019s Zen 5 at Hot Chips 2024</a></li>\n<li><a href=\"https://blog.hjc.im/zen-5-more-details-1.html\">Zen 5 \u8865\u5145\u6d4b\u8bd5 (1/2): \u66f4\u591a\u5fae\u67b6\u6784\u7ec6\u8282</a></li>\n<li><a href=\"http://www.numberworld.org/blogs/2024_8_7_zen5_avx512_teardown/\">Zen5's AVX512 Teardown + More...</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD Zen 5 \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"mop-vs-uop\">MOP vs uOP<a class=\"headerlink\" href=\"#mop-vs-uop\" title=\"Permanent link\">&para;</a></h2>\n<p>MOP = Macro operation, uOP = Micro operation</p>\n<p>AMD \u7684\u6587\u6863\u91cc\u662f\u8fd9\u4e48\u8bf4\u7684\uff1a</p>\n<blockquote>\n<p>The processor implements AMD64 instruction set by means of macro-ops (the primary units of\nwork managed by the processor) and micro-ops (the primitive operations executed in the\nprocessor's execution units).\nInstructions are marked as fast path single (one macro-op), fast path double (two macro-ops), or\nmicrocode (greater than two macro-ops). Macro ops can normally contain up to two micro-ops.</p>\n</blockquote>\n<p>\u4e00\u6761\u6307\u4ee4\u53ef\u4ee5\u5206\u6210\u82e5\u5e72\u4e2a MOP\uff08\u6bd4\u5982 REP MOVS \u4f1a\u62c6\u6210\u5f88\u591a\u4e2a MOP\uff09\uff0c\u4e00\u4e2a MOP \u53ef\u4ee5\u7ee7\u7eed\u7ec6\u5206\u4e3a uOP\uff08\u6bd4\u5982 store \u62c6\u5206\u6210 store data \u548c store address\uff1b\u628a\u5185\u5b58\u7684\u503c\u52a0\u5230\u5bc4\u5b58\u5668\u4e0a\u7684 add \u6307\u4ee4\u62c6\u5206\u6210 load \u548c add\uff09\u3002Dispatch \u7684\u5355\u4f4d\u662f MOP\uff0cROB \u4fdd\u5b58\u7684\u4e5f\u662f MOP\u3002\u4e0e Zen3/Zen4 \u4e0d\u540c\uff0cOp Cache \u4fdd\u5b58\u7684\u4e0d\u662f MOP\uff0c\u800c\u662f Fused Instructions\uff0c\u8fd9\u4e2a Fusion \u6765\u81ea\u4e8e Branch Fusion \u6216 MOV + ALU Fusion\u3002Fusion \u76f8\u5f53\u4e8e\u628a\u591a\u6761\u6307\u4ee4\u5408\u6210\u4e86\u4e00\u4e2a\uff0c\u51cf\u5c11\u4e86 MOP \u7684\u6570\u91cf\u3002</p>\n<p>MOP \u5230 uOP \u7684\u62c6\u5206\u9700\u8981\u7b49\u5230 Scheduler \u4e2d\u624d\u8fdb\u884c\uff0cScheduler \u8f93\u5165 MOP\uff0c\u8f93\u51fa uOP\uff0c\u4e5f\u5c31\u662f\u8bf4\u6700\u7ec8\u7ed9\u5230\u6267\u884c\u5355\u5143\u7684\u662f uOP\u3002</p>\n<p>\u548c ARM \u516c\u7248\u6838\u7684 MOP/uOP \u5bf9\u6bd4\uff0c\u5176\u5b9e\u662f\u5f88\u7c7b\u4f3c\u7684\uff1auOP \u662f\u6267\u884c\u5355\u5143\u770b\u5230\u7684\u6307\u4ee4\u7c92\u5ea6\uff0cMOP \u662f\u7ef4\u62a4\u7cbe\u786e\u5f02\u5e38\u7684\u6307\u4ee4\u7c92\u5ea6\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"op-cache\">Op Cache<a class=\"headerlink\" href=\"#op-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a64 set, 16 way, <strong>1024 entry</strong>, <strong>6 (fused) inst/entry</strong>, \u4f9b\u6307 <strong>2 entry/cycle</strong></p>\n<h4 id=\"\u5f00\u542f\u5173\u95ed\">\u5f00\u542f/\u5173\u95ed<a class=\"headerlink\" href=\"#\u5f00\u542f\u5173\u95ed\" title=\"Permanent link\">&para;</a></h4>\n<p>AMD \u5728 UEFI \u56fa\u4ef6\u4e2d\u63d0\u4f9b\u4e86\u5173\u95ed Op Cache \u7684\u8bbe\u7f6e\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u6d4b\u8bd5\u5728 Op Cache \u5f00\u542f/\u5173\u95ed\u4e0d\u540c\u60c5\u51b5\u4e0b\u7684\u6027\u80fd\u3002\u901a\u8fc7\u8fdb\u4e00\u6b65\u7814\u7a76\uff0c\u53d1\u73b0\u56fa\u4ef6\u7684 Op Cache \u5173\u95ed\u8bbe\u7f6e\uff0c\u5b9e\u9645\u4e0a\u5bf9\u5e94\u4e86 MSR[0xc0011021] \u7684 bit 5\uff1a\u521d\u59cb\u60c5\u51b5\u4e0b\uff0cMSR[0xc0011021] \u7684\u503c\u4e3a 0x20000000000040\uff0c\u5982\u679c\u8fdb\u5165\u56fa\u4ef6\u5173\u95ed Op Cache\uff0c\u53ef\u4ee5\u89c2\u5bdf\u5230 MSR[0xc0011021] \u53d8\u6210\u4e86 0x20000000000060\u3002\u5b9e\u9645\u4e0a\uff0cOp Cache \u53ef\u4ee5\u5728\u8fdb\u5165 Linux \u540e\u52a8\u6001\u5f00\u542f/\u5173\u95ed\uff08\u611f\u8c22 David Huang \u5728\u535a\u5ba2\u4e2d\u63d0\u4f9b\u7684\u4fe1\u606f\uff09\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>sudo<span class=\"w\"> </span>modprobe<span class=\"w\"> </span>msr\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"c1\"># Disable Op Cache for Core 0</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>sudo<span class=\"w\"> </span>wrmsr<span class=\"w\"> </span>-p<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>0xc0011021<span class=\"w\"> </span>0x20000000000060\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"c1\"># Enable Op Cache for Core 0</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>sudo<span class=\"w\"> </span>wrmsr<span class=\"w\"> </span>-p<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>0xc0011021<span class=\"w\"> </span>0x20000000000040\n</span></code></pre></div>\n<p>\u56e0\u6b64\u5f00\u5173 Op Cache \u4e0d\u9700\u8981\u91cd\u542f\u8fdb\u56fa\u4ef6\u4e86\u3002</p>\n<h4 id=\"\u5bb9\u91cf\">\u5bb9\u91cf<a class=\"headerlink\" href=\"#\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>Zen 5 \u7684 Op Cache \u6bcf\u4e2a entry \u662f 6 (fused) inst\uff0c\u4e3a\u4e86\u6d4b\u51fa Op Cache \u7684\u5bb9\u91cf\uff0c\u4ee5\u53ca\u786e\u8ba4\u4fdd\u5b58\u7684\u662f fused inst\uff0c\u5229\u7528 MOV + ALU Fusion \u6765\u6784\u9020\u6307\u4ee4\u5e8f\u5217\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\"># rsi = rdi</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"c1\"># rsi += rdx</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span></code></pre></div>\n<p>\u8fd9\u4e24\u6761\u6307\u4ee4\u6ee1\u8db3 Zen 5 \u7684 MOV + ALU Fusion \u8981\u6c42\uff0c\u786c\u4ef6\u4e0a\u878d\u5408\u6210\u4e00\u4e2a <code>rsi = rdx + rdi</code> \u7684\u64cd\u4f5c\u3002\u505a\u8fd9\u4e2a\u878d\u5408\u4e5f\u662f\u56e0\u4e3a x86 \u6307\u4ee4\u96c6\u7f3a\u5c11 3 \u5730\u5740\u6307\u4ee4\uff0c\u5f53\u7136\u672a\u6765 APX \u4f1a\u8865\u4e0a\u8fd9\u4e2a\u7f3a\u5931\u3002\u5b9e\u6d4b\u53d1\u73b0\uff0c\u8fd9\u6837\u7684\u6307\u4ee4\u5e8f\u5217\u53ef\u4ee5\u8fbe\u5230 12 \u7684 IPC\uff0c\u6b63\u597d Zen 5 \u7684 ALU \u6709 6 \u4e2a\uff0c\u4e5f\u5c31\u662f\u6bcf\u5468\u671f\u6267\u884c 6 \u6761\u878d\u5408\u540e\u7684\u6307\u4ee4\uff0c\u548c 12 IPC \u662f\u543b\u5408\u7684\u300212 \u7684 IPC \u53ef\u4ee5\u4e00\u76f4\u7ef4\u6301\u5230 36KB \u7684 footprint\uff0c\u8fd9\u91cc\u7684 mov \u548c add \u6307\u4ee4\u90fd\u662f 3 \u5b57\u8282\uff0c\u6362\u7b97\u4e0b\u6765 36KB \u5bf9\u5e94 <code>36*1024/6=6144</code> \u4e2a fused instruction\uff0c\u6b63\u597d <code>64*16*6=6144</code>\uff0c\u5bf9\u4e0a\u4e86\u3002\u5173\u6389 Op Cache \u540e\uff0c\u6027\u80fd\u4e0b\u964d\u5230 4 IPC\uff0c\u5bf9\u5e94\u4e86 Decode \u5bbd\u5ea6\uff0c\u540c\u65f6\u4e5f\u8bf4\u660e Decode \u7684 4 Wide \u5bf9\u5e94\u7684\u662f\u6307\u4ee4\uff0c\u800c\u4e0d\u662f\u878d\u5408\u540e\u7684\u6307\u4ee4\u3002</p>\n<h4 id=\"\u541e\u5410\">\u541e\u5410<a class=\"headerlink\" href=\"#\u541e\u5410\" title=\"Permanent link\">&para;</a></h4>\n<p>\u63a5\u4e0b\u6765\u8981\u6d4b\u8bd5 Op Cache \u80fd\u5426\u5355\u5468\u671f\u7ed9\u5355\u4e2a\u7ebf\u7a0b\u63d0\u4f9b 2 \u4e2a entry \u7684\u541e\u5410\u3002\u7531\u4e8e\u6bcf\u4e2a entry \u6700\u591a\u53ef\u4ee5\u6709 6 (fused) inst\uff0c\u52a0\u8d77\u6765\u662f 12\uff0c\u800c dispatch \u53ea\u6709 8 MOP/cycle\uff0c\u56e0\u6b64\u9000\u800c\u6c42\u5176\u6b21\uff0c\u4e0d\u8981\u6c42\u7528\u5b8c entry \u7684 6 \u6761\u6307\u4ee4\uff0c\u800c\u662f\u7528 jmp \u6307\u4ee4\u6765\u63d0\u524d\u7ed3\u675f entry\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\"># rsi = rdi</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"no\">f</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"err\">2:</span>\n</span></code></pre></div>\n<p>\u91cd\u590d\u4e0a\u8ff0\u6307\u4ee4\uff0c\u53d1\u73b0\u5728 5KB \u4e4b\u524d\u90fd\u53ef\u4ee5\u8fbe\u5230 4 \u7684 IPC\uff0c\u4e4b\u540e\u5219\u4e0b\u964d\u5230 2 IPC\uff0c\u8bf4\u660e 5KB \u65f6\u7528\u6ee1\u4e86 Op Cache\u3002\u8fd9\u91cc\u7684 mov \u6307\u4ee4\u662f 3 \u5b57\u8282\uff0cjmp \u6307\u4ee4\u662f 2 \u5b57\u8282\uff0c\u4e5f\u5c31\u662f\u8bf4 5KB \u5bf9\u5e94\u4e0a\u8ff0\u6307\u4ee4\u6a21\u5f0f\u91cd\u590d\u4e86 1024 \u6b21\uff0c\u6b64\u65f6 Op Cache \u7528\u6ee1\u4e86\u5bb9\u91cf\uff0c\u6b63\u597d Op Cache \u4e5f\u662f <code>64*16=1024</code> \u4e2a entry\uff0c\u5370\u8bc1\u4e86 Op Cache \u7684 entry \u4f1a\u88ab jmp \u63d0\u524d\u7ed3\u675f\uff0c\u5728\u4e0a\u8ff0\u7684\u6307\u4ee4\u6a21\u5f0f\u4e0b\uff0centry \u4e0d\u4f1a\u8de8\u8d8a jmp \u6307\u4ee4\u8bb0\u5f55\u540e\u9762\u7684\u6307\u4ee4\uff0c\u6bcf\u4e2a entry \u53ea\u6709\u4e24\u6761\u6307\u4ee4\u3002\u90a3\u4e48 4 IPC \u8bc1\u660e\u4e86 Op Cache \u53ef\u4ee5\u6bcf\u5468\u671f\u63d0\u4f9b 2 entry\uff0c\u76f8\u6bd4 Decode \u53ea\u80fd\u6bcf\u5468\u671f\u7ed9\u5355\u7ebf\u7a0b\u63d0\u4f9b 4 \u6761\u6307\u4ee4\u660e\u663e\u8981\u5feb\u3002</p>\n<h3 id=\"\u53d6\u6307\">\u53d6\u6307<a class=\"headerlink\" href=\"#\u53d6\u6307\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6bcf\u5468\u671f\u5171 64B\uff0c\u53ef\u4ee5\u53d6<strong>\u4e24\u4e2a</strong> 32B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u53d6\u6307\uff0c\u9700\u8981\u5173\u6389 Op Cache\uff0c\u4f46\u7531\u4e8e Decode \u74f6\u9888\u592a\u660e\u663e\uff0c\u4e0d\u5bb9\u6613\u6d4b\u51fa\u53d6\u6307\u7684\u6027\u80fd\uff0c\u4f8b\u5982\u662f\u5426\u4e00\u4e2a\u5468\u671f\u53ef\u4ee5\u7ed9\u5355\u7ebf\u7a0b\u53d6\u4e24\u4e2a 32B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757\u3002\u76ee\u524d\u901a\u8fc7\u5b9e\u6d4b\u53ef\u4ee5\u77e5\u9053\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\uff0c\u6d4b\u8bd5\u5faa\u73af\u4f53\u8de8\u8d8a 64B \u7f13\u5b58\u884c\u8fb9\u754c\u7684\u60c5\u51b5\uff0c\u6307\u4ee4\u6a21\u5f0f\u89c1\u4e0b\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"nf\">dec</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"c1\"># 64B cache line boundary here</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">b</span>\n</span></code></pre></div>\n<p>\u5faa\u73af\u4e00\u6b21\u9700\u8981 1.5 \u4e2a\u5468\u671f\u3002\u5982\u679c Fetch \u6bcf\u5468\u671f\u53ea\u80fd\u53d6\u4e00\u4e2a 32B/64B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u9700\u8981 2 \u4e2a\u5468\u671f\u6765\u53d6\u6307\uff0c\u4f46\u5982\u679c Fetch \u6bcf\u5468\u671f\u53ef\u4ee5\u53d6\u4e24\u4e2a 32B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u53ea\u9700\u8981 1 \u4e2a\u5468\u671f\u53d6\u6307\uff0c\u4f46\u5b9e\u9645\u6d4b\u51fa\u6765\u53c8\u662f 1.5 \u4e2a\u5468\u671f\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u627e\u5230\u5408\u7406\u7684\u89e3\u91ca\uff0c\u4f46\u5927\u6982\u7387 Fetch \u8fd8\u662f\u53ef\u4ee5\u7ed9\u5355\u7ebf\u7a0b\u6bcf\u5468\u671f\u63d0\u4f9b\u4e24\u4e2a 32B \u6307\u4ee4\u5757\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a2x <strong>4-wide</strong> decode pipeline, <strong>one pipeline per thread</strong></p>\n<p>AMD Zen 5 \u7684 Decode \u867d\u7136\u6709\u4e24\u4e2a Pipe\uff0c\u4f46\u662f\u6bcf\u4e2a\u903b\u8f91\u7ebf\u7a0b\u53ea\u80fd\u7528\u4e00\u4e2a\uff0c\u610f\u5473\u7740\u5355\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u65e0\u6cd5\u505a\u5230 8-wide Decode\uff0c\u800c 4-wide Decode \u53c8\u592a\u7a84\u4e86\u70b9\uff0c\u56e0\u6b64 Op Cache \u7684\u547d\u4e2d\u7387\u5c31\u663e\u5f97\u5f88\u91cd\u8981\u3002</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 Decode\uff0c\u9700\u8981\u9996\u5148\u6309\u7167\u4e0a\u9762\u7684\u65b9\u6cd5\u5173\u95ed Op Cache\uff0c\u7136\u540e\u6784\u9020\u4e0d\u540c\u7684\u6307\u4ee4\u5e8f\u5217\u4ee5\u89c2\u5bdf IPC\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\u91cd\u590d 1-4 \u5b57\u8282 nop\uff1a4 IPC</li>\n<li>\u91cd\u590d 5 \u5b57\u8282 nop\uff1a3.2 IPC</li>\n<li>\u91cd\u590d 6 \u5b57\u8282 nop\uff1a2.67 IPC</li>\n<li>\u91cd\u590d 7 \u5b57\u8282 nop\uff1a2.3 IPC</li>\n<li>\u91cd\u590d 8 \u5b57\u8282 nop\uff1a2 IPC</li>\n<li>\u91cd\u590d 9 \u5b57\u8282 nop\uff1a1.78 IPC</li>\n<li>\u91cd\u590d 10 \u5b57\u8282 nop\uff1a1.6 IPC</li>\n<li>\u91cd\u590d 11-15 \u5b57\u8282 nop\uff1a1 IPC</li>\n</ul>\n<p>\u4e0a\u8ff0 nop \u7684\u7f16\u7801\u53d6\u81ea Software Optimization Guide \u7684 Encodings for NOP Instructions 1 to 15 \u8868\u683c\u3002</p>\n<p>\u9996\u5148\u53ef\u4ee5\u770b\u5230 Zen5 4-wide Decode \u7684\u9650\u5236\uff0c\u5176\u6b21\u53ef\u4ee5\u53d1\u73b0\u91cd\u590d 5-10 \u5b57\u8282\u7684 nop\uff0c\u6bcf\u5468\u671f\u7684 Decode \u541e\u5410\u90fd\u662f 16B\u300211 \u5b57\u8282\u4ee5\u4e0a\u5219\u662f\u649e\u5230\u4e86 Decode \u7684\u9650\u5236\uff1a<code>Only the first decode slot (of four) can decode instructions greater than 10 bytes in length</code>\u3002</p>\n<p>\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f\u8fd9\u4e2a 16B \u7684\u9650\u5236\uff0c\u8003\u8651\u79fb\u52a8\u7a97\u53e3\u7684\u8bd1\u7801\u8bbe\u8ba1\uff0c\u6bcf\u5468\u671f\u53ef\u4ee5\u5bf9\u4e24\u4e2a\u8fde\u7eed 16B \u7684\u7a97\u53e3\u8bd1\u7801\uff08<code>IBQ entries hold 16 byte-aligned fetch windows of the instruction byte stream. The decode pipes each scan two IBQ entries.</code>\uff09\uff0c\u5728 5 \u5b57\u8282\u7684 nop \u6a21\u5f0f\u4e0b\uff0c\u6bcf\u4e2a\u5468\u671f\u7684 Decode \u5e94\u8be5\u662f\uff1a</p>\n<ul>\n<li>Cycle 0: Window 0-31, Decode 0, 5, 10, 15</li>\n<li>Cycle 1: Window 16-47, Decode 20, 25, 30, 35</li>\n<li>Cycle 2: Window 32-63, Decode 40, 45, 50, 55</li>\n<li>Cycle 3: Window 48-79, Decode 60, 65, 70, 75</li>\n<li>Cycle 4: Window 80-111, Decode 80, 85, 90, 95</li>\n</ul>\n<p>\u6309\u8fd9\u4e2a\u7406\u60f3\u7684\u65b9\u6cd5\u6765\u770b\uff0c\u5e94\u8be5\u53ef\u4ee5\u505a\u5230 4 \u7684 IPC\uff0c\u4f46\u5b9e\u9645\u4e0a\u6ca1\u6709\u3002\u4e00\u4e2a\u731c\u6d4b\u662f\uff0c\u6ed1\u52a8\u7a97\u53e3\u6bcf\u6b21\u53ea\u80fd\u79fb\u52a8 1 \u4e2a 16B\uff0c\u800c\u4e0d\u80fd\u4ece 48 \u8df3\u5230 80\uff0c\u90a3\u4e48\u4ece Cycle 4 \u5f00\u59cb\u4f1a\u51fa\u73b0\u6027\u80fd\u635f\u5931\uff1a</p>\n<ul>\n<li>Cycle 4: Window 64-95, Decode 80, 85, 90</li>\n<li>Cycle 5: Window 80-111, Decode 95, 100, 105</li>\n<li>Cycle 6: Window 96-127, Decode 110, 115, 120</li>\n<li>Cycle 7: Window 112-143, Decode 125, 130, 135</li>\n<li>Cycle 8: Window 128-159, Decode 140, 145, 150, 155</li>\n</ul>\n<p>\u8fd9\u4e2a\u89c4\u5f8b\u5ef6\u7eed\u4e0b\u53bb\uff0c\u5e73\u5747\u4e0b\u6765\u5c31\u662f 3.2 IPC\u3002</p>\n<p>\u6839\u636e\u8fd9\u4e2a\u731c\u60f3\uff0cDecode \u4ece\u4e24\u4e2a\u8fde\u7eed\u7684 IBQ entry \u8bd1\u7801\u6700\u591a\u56db\u6761\u6307\u4ee4\uff0c\u662f\u6ca1\u6709 16B \u7684\u9650\u5236\u7684\uff0c\u4f46 IBQ \u6bcf\u5468\u671f\u53ea\u80fd\u5f39\u51fa\u4e00\u4e2a entry\uff0c\u800c\u4e0d\u5141\u8bb8\u6bcf\u5468\u671f\u5f39\u51fa\u4e24\u4e2a\uff0c\u8fd9\u624d\u5bfc\u81f4\u4e86 16B \u7684\u541e\u5410\u3002\u603b\u4e4b\uff0c4-wide \u4ee5\u53ca 16B \u7684\u9650\u5236\uff0c\u5e94\u8be5\u8bf4\u662f\u5f88\u5c0f\u7684\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>32KB</strong>, 8-way set associative</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u7684\u5bb9\u91cf\uff0c\u9700\u8981\u5173\u95ed Op Cache\uff0c\u4f46\u7531\u4e8e Decode \u7684\u9650\u5236\uff0c\u5373\u4f7f footprint \u5927\u4e8e L1 ICache \u5bb9\u91cf\uff0cIPC \u4f9d\u7136\u6ca1\u6709\u53d8\u5316\uff0c\u9488\u5bf9\u8fd9\u4e2a\u73b0\u8c61\uff0c\u731c\u6d4b L1 ICache \u7684\u9884\u53d6\u5728\u8d77\u4f5c\u7528\uff0c\u5e76\u4e14 L2 Cache \u5230 L1 ICache \u7684 Refill \u5e26\u5bbd\u4e0d\u5c0f\u4e8e Decode \u5e26\u5bbd\uff0c\u5bfc\u81f4\u74f6\u9888\u5728 Decode\u3002</p>\n<p>\u56e0\u6b64\uff0c\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u7684\u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a jmp \u5e8f\u5217\uff0c\u4ee5 4B \u4f4d\u95f4\u8ddd\u6392\u5e03\uff0c\u89c2\u5bdf\u5230\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 8192 \u6761 jmp \u6307\u4ee4\u4e4b\u524d\u53ef\u4ee5\u505a\u5230 1 CPI\uff0c\u4e4b\u540e\u9010\u6e10\u63d0\u5347\u5230 1.5 CPI\uff0c\u6b63\u597d 8192 \u5bf9\u5e94\u4e86 <code>8192*4=32768</code> \u4e5f\u5c31\u662f 32KB L1 ICache \u7684\u5bb9\u91cf\u9650\u5236\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>64-entry</strong>, fully associative</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ITLB \u7684\u5bb9\u91cf\uff0c\u6784\u9020 jmp \u5e8f\u5217\uff0c\u6bcf\u4e2a jmp \u5728\u4e00\u4e2a\u5355\u72ec\u7684\u9875\u4e2d\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\u89c2\u5bdf jmp \u7684\u6027\u80fd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u660e\u663e\u7684 64 pages \u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u4e86 64 entry \u7684 L1 ITLB\u3002</p>\n<h3 id=\"l2-itlb\">L2 ITLB<a class=\"headerlink\" href=\"#l2-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>2048-entry</strong>, 8-way set associative L2 ITLB</p>\n<p>\u7ee7\u7eed\u6cbf\u7528\u6d4b\u8bd5 L1 ITLB \u7684\u65b9\u5f0f\uff0c\u628a\u9875\u7684\u6570\u91cf\u63d0\u9ad8\u5230 2000+\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\u5f97\u5230\u4ee5\u4e0b\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_l2itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u660e\u663e\u7684 2048 pages \u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u4e86 2048 entry \u7684 L2 ITLB\u3002</p>\n<h3 id=\"btb\">BTB<a class=\"headerlink\" href=\"#btb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a16K-entry L1 BTB, 8K-entry L2 BTB</p>\n<p>\u56e0\u4e3a L1 ICache \u53ea\u6709 32KB\uff0c\u800c L1 BTB \u6709 16K entry\uff0c\u6bcf\u4e2a entry \u6700\u591a\u80fd\u4fdd\u5b58\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u56e0\u6b64\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u9996\u5148\u9047\u5230\u7684\u662f L1 ICache \u7684\u74f6\u9888\uff0c\u800c\u4e0d\u662f L1 BTB \u7684\u74f6\u9888\u3002</p>\n<h3 id=\"return-address-stack\">Return Address Stack<a class=\"headerlink\" href=\"#return-address-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>52-entry</strong> per thread</p>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u65f6\u95f4\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\u5f97\u5230\u5982\u4e0b\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_ras.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 52 \u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f Return Address Stack \u7684\u5927\u5c0f\u3002</p>\n<h3 id=\"indirect-target-predictor\">Indirect Target Predictor<a class=\"headerlink\" href=\"#indirect-target-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a3072-entry Indirect Target Array</p>\n<h3 id=\"move-elimination-zero-cycle-move-and-zeroingones-idiom\">Move Elimination (Zero Cycle Move) and Zeroing/Ones Idiom<a class=\"headerlink\" href=\"#move-elimination-zero-cycle-move-and-zeroingones-idiom\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u652f\u6301 xor/sub/cmp/sbb/vxorp/vandnp/vpcmpgt/vpandn/vpxor/vpsub \u7684 Zeroing Idiom\uff0c\u652f\u6301 pcmpeq/vpcmpeq \u7684 Ones Idiom\uff0c\u652f\u6301 mov/movsxd/xchg/(v)vmovap/(v)movdp/(v)movup \u7684 Zero Cycle Move\u3002</p>\n<p>\u5b9e\u6d4b\u4e0b\u6765\uff0c\u4ee5\u4e0b\u6307\u4ee4\u5e8f\u5217\u7684 IPC \u4e3a\uff1a</p>\n<ul>\n<li>\u6709\u4f9d\u8d56\u94fe\u7684 mov r, r\uff1a7 IPC</li>\n<li>\u6ca1\u6709\u4f9d\u8d56\u7684 mov r, r\uff1a7 IPC</li>\n<li>xor r, r, r\uff1a7 IPC</li>\n<li>sub r, r, r\uff1a7 IPC</li>\n<li>\u6709\u4f9d\u8d56\u94fe\u7684 mov vr, vr\uff1a6 IPC</li>\n<li>\u6ca1\u6709\u4f9d\u8d56\u7684 mov vr, vr\uff1a6 IPC</li>\n<li>xor vr, vr, vr\uff1a6 IPC</li>\n<li>mov r, imm\uff1a6 IPC</li>\n</ul>\n<p>\u5176\u4e2d r \u8868\u793a\u6574\u6570\u5bc4\u5b58\u5668\uff0cvr \u8868\u793a\u6d6e\u70b9/\u5411\u91cf\u5bc4\u5b58\u5668\u3002\u603b\u4f53\u6765\u8bf4\u8fd8\u662f\u505a\u7684\u6bd4\u8f83\u5b8c\u5584\u7684\u3002</p>\n<h3 id=\"dispatch\">Dispatch<a class=\"headerlink\" href=\"#dispatch\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a8 MOP/cycle, up to 2 taken branches/cycle</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"rob\">ROB<a class=\"headerlink\" href=\"#rob\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>224-entry per thread</strong>, 1-2 MOP per entry</p>\n<p>\u628a\u4e24\u4e2a\u72ec\u7acb\u7684 long latency pointer chasing load \u653e\u5728\u5faa\u73af\u7684\u5934\u548c\u5c3e\uff0c\u4e2d\u95f4\u7528 NOP \u586b\u5145\uff0c\u5f53 NOP \u586b\u6ee1\u4e86 ROB\uff0c\u7b2c\u4e8c\u4e2a pointer chasing load \u65e0\u6cd5\u63d0\u524d\u6267\u884c\uff0c\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\u3002\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_rob.png\" /></p>\n<p>\u5f53 NOP \u6307\u4ee4\u8fbe\u5230 446 \u6761\u65f6\u51fa\u73b0\u6027\u80fd\u7a81\u53d8\uff0c\u6b64\u65f6\u5e94\u8be5\u662f\u89e6\u53d1\u4e86 Zen 5 \u7684\u6bcf\u4e2a entry \u4fdd\u5b58\u4e24\u4e2a MOP \u7684\u6761\u4ef6\uff0c\u56e0\u6b64 446 \u6761 NOP \u6307\u4ee4\u5bf9\u5e94 223 \u4e2a entry\uff0c\u52a0\u4e0a\u5faa\u73af\u5f00\u5934\u7684 load \u6307\u4ee4\uff0c\u6b63\u597d\u628a\u5faa\u73af\u5c3e\u90e8\u7684 load \u62e6\u5728\u4e86 ROB \u5916\u9762\uff0c\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\u3002</p>\n<p>\u8bf4\u660e\u5355\u7ebf\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u5230\u7684 ROB \u5bb9\u91cf\u662f 224 entry\u3002</p>\n<h3 id=\"register-file\">Register File<a class=\"headerlink\" href=\"#register-file\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a240-entry(40 per thread for architectural) integer physical register file, 192-entry flag physical register file, 384-entry 512b vector register file</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u7269\u7406\u5bc4\u5b58\u5668\u5806\u5927\u5c0f\uff0c\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5f00\u5934\u548c\u7ed3\u5c3e\u5404\u662f\u4e00\u4e2a\u957f\u5ef6\u8fdf\u7684\u64cd\u4f5c\uff0c\u7531\u4e8e Zen 5 \u6ca1\u6709\u5b9e\u73b0 temporal prefetcher\uff0c\u4f7f\u7528\u7684\u662f pointer chasing load\u3002\u7136\u540e\u5728\u4e24\u4e2a\u957f\u5ef6\u8fdf\u7684\u64cd\u4f5c\u4e2d\u95f4\u7a7f\u63d2\u4e0d\u540c\u7684\u6307\u4ee4\u7c7b\u578b\uff0c\u4ece\u800c\u6d4b\u51fa\u5bf9\u5e94\u7684\u7269\u7406\u5bc4\u5b58\u5668\u5806\u53ef\u4f9b\u9884\u6d4b\u6267\u884c\u7684\u5bc4\u5b58\u5668\u6570\u91cf\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_rf.png\" /></p>\n<p>\u6574\u6570\u65b9\u9762\u4f7f\u7528 lea \u6307\u4ee4\u6765\u6d88\u8017\u6574\u6570\u7269\u7406\u5bc4\u5b58\u5668\u800c\u4e0d\u6d88\u8017 flags \u5bc4\u5b58\u5668\uff0c\u6b64\u65f6\u65e0\u8bba\u662f 32 \u4f4d\u8fd8\u662f 64 \u4f4d\u5bc4\u5b58\u5668\uff0c\u4f9b\u9884\u6d4b\u6267\u884c\u7684\u5bc4\u5b58\u5668\u6570\u90fd\u6709 200 \u4e2a\uff0c\u548c\u5b98\u65b9\u7684\u4fe1\u606f\u543b\u5408\uff1a<code>200+40=240</code>\uff0c\u8bf4\u660e\u8d85\u7ebf\u7a0b\u5728\u6ca1\u6709\u8d1f\u8f7d\u7684\u65f6\u5019\uff0c\u4e0d\u4f1a\u5360\u7528\u6574\u6570\u7269\u7406\u5bc4\u5b58\u5668\u5806\uff0c\u8fd9\u5728 AMD \u7684\u6587\u6863\u4e2d\u53eb\u505a Watermarked\uff1a<code>Resource entries are assigned on demand</code>\u3002356 \u4e2a flags \u5bc4\u5b58\u5668\u8d85\u8fc7\u4e86\u5b98\u65b9\u5ba3\u4f20\u7684 192 \u7684\u5927\u5c0f\uff0c\u731c\u6d4b\u505a\u4e86\u4e00\u4e9b\u4f18\u5316\uff0c\u6d4b\u5230\u7684\u5e76\u975e flags \u5bc4\u5b58\u5668\u5806\u5927\u5c0f\u3002</p>\n<p>\u6d6e\u70b9\u65b9\u9762\uff0c\u6d4b\u5f97 430 \u4e2a\u4f9b\u9884\u6d4b\u6267\u884c\u7684\u6d6e\u70b9\u5bc4\u5b58\u5668\uff0c\u8d85\u8fc7\u4e86\u5b98\u65b9\u5ba3\u4f20\u7684 384 \u4e2a 512 \u4f4d\u6d6e\u70b9\u5bc4\u5b58\u5668\u3002\u8003\u8651\u5230 Zen5 \u5f15\u5165\u4e86\u5728 Rename \u4e4b\u524d\u7684 96-entry Non-Scheduling Queue(NSQ)\uff0c\u5728 NSQ \u4e2d\u7684\u6307\u4ee4\u8fd8\u6ca1\u6709\u7ecf\u8fc7\u91cd\u547d\u540d\uff0c\u56e0\u6b64\u4e0d\u6d88\u8017\u7269\u7406\u5bc4\u5b58\u5668\uff1a<code>384+96=480</code>\uff0c\u518d\u53bb\u6389\u81f3\u5c11 32 \u4e2a\u67b6\u6784\u5bc4\u5b58\u5668 zmm0-zmm31\uff0c\u548c\u89c2\u5bdf\u5230\u7684 430 \u662f\u6bd4\u8f83\u63a5\u8fd1\u7684\u3002</p>\n<p>\u9488\u5bf9\u6d6e\u70b9\u5bc4\u5b58\u5668\uff0cZen5 \u7684\u4e0d\u540c\u5e73\u53f0\u7684\u8bbe\u8ba1\u4e0d\u5b8c\u5168\u4e00\u6837\uff0c\u4e0a\u9762\u7684\u6d4b\u8bd5\u662f\u5728 9950X \u4e0a\u8fdb\u884c\u7684\uff0c\u5176\u4ed6\u5e73\u53f0\u7684\u6d4b\u8bd5\u4ee5\u53ca\u5206\u6790\u89c1 <a href=\"http://www.numberworld.org/blogs/2024_8_7_zen5_avx512_teardown/#vector_register_file\">Zen5's AVX512 Teardown + More...</a>\u3002</p>\n<h3 id=\"l1-dcache\">L1 DCache<a class=\"headerlink\" href=\"#l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>48KB</strong>, 12-way set associative, index \u662f VA[11:6]</p>\n<p>\u4f7f\u7528\u4e0d\u540c footprint \u7684\u968f\u673a\u7684 pointer chasing load\uff0c\u6d4b\u8bd5\u6027\u80fd\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\u660e\u663e\u7684 48KB \u7684\u62d0\u70b9\uff0c\u547d\u4e2d L1 DCache \u65f6 load to use latency \u662f 4 cycle\uff0c\u547d\u4e2d L2 \u65f6\u589e\u5927\u5230\u4e86 14 cycle\u3002</p>\n<h4 id=\"linear-address-utagway-predictor\">Linear Address UTAG/Way-Predictor<a class=\"headerlink\" href=\"#linear-address-utagway-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>\u590d\u73b0\u8bba\u6587 <a href=\"https://dl.acm.org/doi/10.1145/3320269.3384746\">Take A Way: Exploring the Security Implications of AMD's Cache Way Predictors</a>\uff0c\u53ef\u4ee5\u770b\u5230 Zen 5 \u7684 UTAG \u54c8\u5e0c\u51fd\u6570\u548c Zen 2 \u4e00\u6837\u4e5f\u662f\u5982\u4e0b 8 bit\uff1a</p>\n<ul>\n<li>VA[12] xor VA[27]</li>\n<li>VA[13] xor VA[26]</li>\n<li>VA[14] xor VA[25]</li>\n<li>VA[15] xor VA[20]</li>\n<li>VA[16] xor VA[21]</li>\n<li>VA[17] xor VA[22]</li>\n<li>VA[18] xor VA[23]</li>\n<li>VA[19] xor VA[24]</li>\n</ul>\n<p>\u5982\u679c\u4e24\u4e2a\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u540c\u4e00\u4e2a DCache Set \u4e0a\u7684\u4e0d\u540c Way\uff08Set \u6839\u636e VA[11:6] \u552f\u4e00\u786e\u5b9a\uff09\uff0c\u5e76\u4e14\u5b83\u4eec\u7684 uTag \u51fa\u73b0\u51b2\u7a81\uff0c\u90a3\u4e48\u8bbf\u95ee\u4e00\u4e2a\u865a\u62df\u5730\u5740\u4f1a\u628a\u53e6\u4e00\u4e2a\u865a\u62df\u5730\u5740\u4ece L1 DCache \u4e2d\u6e05\u6389\u3002</p>\n<h3 id=\"load-store-unit\">Load Store Unit<a class=\"headerlink\" href=\"#load-store-unit\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6bcf\u5468\u671f\u6700\u591a\u56db\u4e2a\u5185\u5b58\u64cd\u4f5c\u3002\u6bcf\u5468\u671f\u6700\u591a\u56db\u4e2a\u8bfb\uff0c\u5176\u4e2d\u6700\u591a\u4e24\u4e2a 128b/256b/512b \u8bfb\uff1b\u6bcf\u5468\u671f\u6700\u591a\u4e24\u4e2a\u5199\uff0c\u5176\u4e2d\u6700\u591a\u4e00\u4e2a 512b \u5199\u3002load to use latency\uff0c\u6574\u6570\u662f 4-5 \u4e2a\u5468\u671f\uff0c\u6d6e\u70b9\u662f 7-8 \u4e2a\u5468\u671f\u3002\u8de8\u8d8a 64B \u8fb9\u754c\u7684\u8bfb\u4f1a\u6709\u989d\u5916\u7684\u4e00\u4e2a\u5468\u671f\u7684\u5ef6\u8fdf\u3002\u652f\u6301 Store to load forwarding\uff0c\u8981\u6c42\u5148\u524d\u7684 store \u5305\u62ec\u4e86 load \u7684\u6240\u6709\u5b57\u8282\uff0c\u4e0d\u8981\u6c42\u5bf9\u9f50\u3002</p>\n<h4 id=\"\u541e\u5410_1\">\u541e\u5410<a class=\"headerlink\" href=\"#\u541e\u5410_1\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b9e\u6d4b Zen 5 \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\u5982\u4e0b\u7684\u8bbf\u5b58\u64cd\u4f5c\uff1a</p>\n<ul>\n<li>4x 32b Load: 1 cycle</li>\n<li>4x 64b Load: 1 cycle</li>\n<li>2x 128b Load: 1 cycle</li>\n<li>2x 256b Load: 1 cycle</li>\n<li>2x 32b Store: 1 cycle</li>\n<li>2x 64b Store: 1 cycle</li>\n<li>2x 128b Store: 1 cycle</li>\n<li>2x 256b Store: 1 cycle</li>\n<li>1x 64b Load + 2x 64b Store: 1 cycle</li>\n<li>2x 64b Load + 2x 64b Store: 1 cycle</li>\n<li>3x 64b Load + 1x 64b Store: 1 cycle</li>\n<li>1x 128b Load + 2x 128b Store: 1 cycle</li>\n<li>2x 128b Load + 1x 128b Store: 1 cycle</li>\n</ul>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u6bcf\u5468\u671f\u652f\u6301 4 \u4e2a 64b \u7684 Load/Store\uff0c\u5176\u4e2d Store \u6700\u591a\u4e24\u6761\u3002\u4e00\u4e2a 128b \u7684 Load \u76f8\u5f53\u4e8e\u4e24\u4e2a 64b\uff0c\u5bf9\u5e94 IPC \u51cf\u534a\u3002</p>\n<h4 id=\"\u5ef6\u8fdf\">\u5ef6\u8fdf<a class=\"headerlink\" href=\"#\u5ef6\u8fdf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e32\u884c\u7684 load \u94fe\uff0c\u89c2\u5bdf\u5230\u591a\u6570\u60c5\u51b5\u4e0b load to use latency \u662f 4 \u4e2a\u5468\u671f\uff0c\u5728\u8de8\u8d8a 64B \u8fb9\u754c\u65f6\uff0c\u4f1a\u589e\u52a0\u4e00\u4e2a\u5468\u671f\u53d8\u6210 5 \u4e2a\u5468\u671f\u3002\u6b64\u5916\uff0c\u5982\u679c\u6d89\u53ca\u5230 index \u8ba1\u7b97\uff08\u5373 <code>offset(base, index, shift)</code>\uff09\uff0c\u4e5f\u4f1a\u589e\u52a0\u4e00\u4e2a\u5468\u671f\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff1a</p>\n<p>\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[0,2]</td>\n<td>{0}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[0,6]</td>\n<td>[0,4]</td>\n<td>{0}</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cZen 5 \u5728 Store \u5b8c\u5168\u5305\u542b Load \u7684\u60c5\u51b5\u4e0b\u90fd\u53ef\u4ee5\u8f6c\u53d1\uff0c\u6ca1\u6709\u989d\u5916\u7684\u5bf9\u9f50\u8981\u6c42\u3002\u4f46\u5f53 Load \u548c Store \u53ea\u6709\u90e8\u5206\u91cd\u5408\u65f6\uff0c\u5c31\u65e0\u6cd5\u8f6c\u53d1\u3002\u4e24\u4e2a\u8fde\u7eed\u7684 32 \u4f4d\u7684 Store \u548c\u4e00\u4e2a 64 \u4f4d\u7684 Load \u91cd\u5408\u4e5f\u4e0d\u80fd\u8f6c\u53d1\u3002</p>\n<p>\u53ef\u89c1 Zen 5 \u7684 Store to Load Forwarding \u5b9e\u73b0\u6bd4\u8f83\u7c97\u66b4\uff0c\u53ea\u5141\u8bb8 Load \u4ece\u5355\u4e2a\u5b8c\u5168\u5305\u542b Load \u7684 Store \u4e2d\u8f6c\u53d1\u6570\u636e\u3002\u548c <a href=\"../../07/arm_neoverse_v2/\">Neoverse V2</a> \u76f8\u6bd4\uff0cZen 5 \u5bf9 Load \u5728 Store \u5185\u7684\u504f\u79fb\u6ca1\u6709\u8981\u6c42\uff0c\u4f46\u4e5f\u4e0d\u5141\u8bb8 Load \u548c Store \u53ea\u6709\u4e00\u90e8\u5206\u8986\u76d6\uff0c\u4e5f\u4e0d\u652f\u6301\u4e00\u4e2a Load \u4ece\u4e24\u4e2a\u6216\u66f4\u591a\u7684 Store \u4e2d\u83b7\u53d6\u6570\u636e\u3002</p>\n<p>\u6210\u529f\u8f6c\u53d1\u65f6 8 cycle\uff0c\u6709 Overlap \u4f46\u8f6c\u53d1\u5931\u8d25\u65f6 14-15 cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aZen 5 \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42 st \u5305\u542b ld</li>\n<li>1 ld + 2+ st: \u4e0d\u652f\u6301</li>\n</ul>\n<h3 id=\"l1-dtlb\">L1 DTLB<a class=\"headerlink\" href=\"#l1-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a96-entry, fully associative</p>\n<p>\u4f7f\u7528\u4e0d\u540c footprint \u7684\u968f\u673a\u7684 pointer chasing load \u4e14\u6bcf\u6b21 load \u90fd\u5728\u5355\u72ec\u7684\u9875\u5185\uff0c\u6d4b\u8bd5\u6027\u80fd\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_l1dtlb.png\" /></p>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\u660e\u663e\u7684 96 page \u7684\u62d0\u70b9\uff0c\u547d\u4e2d L1 DTLB \u65f6 load to use latency \u662f 4 cycle\uff0c\u547d\u4e2d L2 DTLB \u65f6\u589e\u5927\u5230\u4e86 11 cycle\u3002</p>\n<h3 id=\"l2-dtlb\">L2 DTLB<a class=\"headerlink\" href=\"#l2-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a4096-entry, 16-way set associative</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a16-way set associative, inclusive, 1MB, <strong>&gt;= 14 cycle load to use latency</strong></p>\n<h3 id=\"l3-cache\">L3 Cache<a class=\"headerlink\" href=\"#l3-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a16-way set associative, exclusive</p>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aZen 5 \u7684\u540e\u7aef\u6709 6 \u6761 ALU \u6d41\u6c34\u7ebf\uff0c4 \u6761\u8bbf\u5b58\u6d41\u6c34\u7ebf\uff0c4 \u6761 512 \u4f4d\u5bbd\u5411\u91cf\u6d41\u6c34\u7ebf\uff08\u5176\u4e2d 2 \u6761\u652f\u6301 FMA\uff09\uff0c2 \u6761\u5411\u91cf\u8bbf\u5b58\u6d41\u6c34\u7ebf</p>\n<p>\u5b9e\u6d4b\u53d1\u73b0 Zen 5 \u6bcf\u5468\u671f\u6700\u591a\u53ef\u4ee5\u6267\u884c 2 \u6761 AVX512 \u7684\u6d6e\u70b9 FMA \u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u5468\u671f\u6d6e\u70b9\u5cf0\u503c\u6027\u80fd\uff1a</p>\n<ul>\n<li>\u5355\u7cbe\u5ea6\uff1a<code>512/32*2*2=64</code> FLOP per cycle</li>\n<li>\u53cc\u7cbe\u5ea6\uff1a<code>512/64*2*2=32</code> FLOP per cycle</li>\n</ul>\n<p>\u901a\u8fc7 512 \u4f4d\u7684\u6d6e\u70b9 datapath\uff0c\u7ec8\u4e8e\u8fbe\u5230\u4e86\u7b2c\u4e00\u68af\u961f\u7684\u6d6e\u70b9\u5cf0\u503c\u6027\u80fd\u3002</p>", "image": null, "date_published": "2024-11-11T00:00:00+00:00", "authors": [], "tags": ["amd", "cpu", "hardware", "performance", "ryzen", "uarch-review", "zen5"]}, {"id": "https://jia.je/meta/2024/11/10/migrate-from-disqus-to-giscus/", "url": "https://jia.je/meta/2024/11/10/migrate-from-disqus-to-giscus/", "title": "\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece Disqus \u8fc1\u79fb\u5230 Giscus", "content_html": "<h1 id=\"\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece-disqus-\u8fc1\u79fb\u5230-giscus\">\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece Disqus \u8fc1\u79fb\u5230 Giscus<a class=\"headerlink\" href=\"#\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece-disqus-\u8fc1\u79fb\u5230-giscus\" title=\"Permanent link\">&para;</a></h1>\n<p>Disqus \u8981\u52a0\u5e7f\u544a\u4e86\uff0c\u4e8e\u662f\u672c\u535a\u5ba2\u7684\u8bc4\u8bba\u7cfb\u7edf\u8fc1\u79fb\u5230\u4e86 Giscus\u3002</p>", "image": null, "date_published": "2024-11-10T00:00:00+00:00", "authors": [], "tags": ["meta", "site"]}, {"id": "https://jia.je/hardware/2024/11/07/arm_neoverse_v2/", "url": "https://jia.je/hardware/2024/11/07/arm_neoverse_v2/", "title": "ARM Neoverse V2 \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"arm-neoverse-v2-\u5fae\u67b6\u6784\u8bc4\u6d4b\">ARM Neoverse V2 \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#arm-neoverse-v2-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM Neoverse V2 \u662f\u76ee\u524d\uff082024 \u5e74\uff09\u5728\u670d\u52a1\u5668\u4e0a\u80fd\u7528\u5230\u7684\u6700\u65b0\u7684 ARM \u516c\u7248\u6838\u5e73\u53f0\uff08AWS Graviton 4\uff09\uff0c\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u5173\u4e8e Neoverse V2 \u5fae\u67b6\u6784\u6709\u5982\u4e0b\u516c\u5f00\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://hc2023.hotchips.org/assets/program/conference/day1/CPU1/HC2023.Arm.MagnusBruce.v04.FINAL.pdf\">Arm Neoverse V2 platform: Leadership Performance and Power Efficiency for Next-Generation Cloud Computing, ML and HPC Workloads</a></li>\n<li><a href=\"https://developer.arm.com/documentation/102375/latest/\">Arm\u00ae Neoverse\u2122 V2 Core Technical Reference Manual</a></li>\n<li><a href=\"https://developer.arm.com/documentation/109898/latest/\">Arm Neoverse V2 Software Optimization Guide</a></li>\n</ul>\n<p>\u8003\u8651\u5230 Neoverse V2 \u4e0e Cortex X3 \u7684\u9ad8\u5ea6\u76f8\u4f3c\u6027\uff0c\u8fd9\u91cc\u4e5f\u5217\u51fa Cortex X3 \u7684\u76f8\u5173\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://fuse.wikichip.org/news/6855/arm-unveils-next-gen-flagship-core-cortex-x3/\">Arm Unveils Next-Gen Flagship Core: Cortex-X3</a></li>\n<li><a href=\"https://developer.arm.com/documentation/101593/latest/\">Arm\u00ae Cortex\u2011X3 Core Technical Reference Manual</a></li>\n</ul>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709 Neoverse V2 \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://chipsandcheese.com/p/hot-chips-2023-arms-neoverse-v2\">Hot Chips 2023: Arm\u2019s Neoverse V2</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Neoverse V2 (AWS Graviton 4) \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"mop-vs-uop\">MOP vs uOP<a class=\"headerlink\" href=\"#mop-vs-uop\" title=\"Permanent link\">&para;</a></h2>\n<p>MOP = Macro operation, uOP = Micro operation</p>\n<p>ARM \u516c\u7248\u6838\u5fae\u67b6\u6784\u65e2\u6709 MOP \u7684\u6982\u5ff5\uff0c\u53c8\u6709 uOP \u7684\u6982\u5ff5\u3002uOP \u4e3b\u8981\u662f\u9488\u5bf9\u540e\u7aef\uff0c\u6267\u884c\u5355\u5143\u5904\u7406\u7684\u662f uOP\u3002MOP \u51fa\u73b0\u5728 MOP Cache \u4ee5\u53ca ROB \u5f53\u4e2d\u3002\u4ed6\u4eec\u548c\u6307\u4ee4\u90fd\u5e76\u4e0d\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u5173\u7cfb\u3002</p>\n<p>\u4f8b\u5982 Instruction Fusion \u7279\u6027\uff0c\u53ef\u4ee5\u628a\u591a\u6761\u6307\u4ee4\u5408\u5e76\u5230\u4e00\u6761 uOP \u5f53\u4e2d\uff0c\u4f8b\u5982 CMP + CSET\uff0c\u5408\u5e76\u6210\u4e00\u4e2a uOP \u4ee5\u540e\uff0c\u53ea\u9700\u8981\u4e00\u4e2a ALU \u5c31\u53ef\u4ee5\u5b8c\u6210\u6574\u4e2a\u64cd\u4f5c\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e00\u6761\u6307\u4ee4\u4e5f\u53ef\u80fd\u62c6\u6210\u591a\u4e2a uOP\uff0c\u4f8b\u5982 128b Load Pair \u6307\u4ee4\uff0c\u4e00\u6761\u6307\u4ee4\u88ab\u62c6\u6210\u4e24\u4e2a uOP\uff0c\u53ef\u4ee5\u72ec\u7acb\u6267\u884c\uff0c\u4f46\u4e3a\u4e86\u4fdd\u8bc1\u7cbe\u786e\u5f02\u5e38\uff0c\u5728 ROB \u4e2d\u8fd8\u662f\u540c\u4e00\u4e2a MOP\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u5982\u679c\u4e0d\u8003\u8651\u8fd9\u4e9b\u7ec6\u8282\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4e00\u6761\u6307\u4ee4\u5bf9\u5e94\u4e00\u4e2a MOP \u5bf9\u5e94\u4e00\u4e2a uOP \u4e5f\u662f\u6210\u7acb\u7684\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"branch-predictor\">Branch Predictor<a class=\"headerlink\" href=\"#branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aTwo predicted branches per cycle, nanoBTB + two level main BTB, 8 table 2 way TAGE direction predictor</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>64KB</strong>, 4-way set associative, VIPT behaving as PIPT, 64B cacheline, PLRU replacement policy</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b\u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_fetch_bandwidth.png\" /></p>\n<p>\u5f00\u59cb\u6709\u4e00\u6bb5 IPC \u63a5\u8fd1 12\uff0c\u6b64\u65f6\u6307\u4ee4\u7531 MOP Cache \u63d0\u4f9b\uff0c\u7531\u4e8e\u8fde\u7eed\u7684\u4e24\u6761 NOP \u53ef\u4ee5\u88ab\u878d\u5408\u6210\u4e00\u4e2a uOP\uff0c\u56e0\u6b64\u53ef\u4ee5\u7a81\u7834 8 \u7684\u9650\u5236\uff0c\u4f46\u4e3a\u4ec0\u4e48\u662f 12 \u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7814\u7a76\u3002</p>\n<p>\u5f53\u6307\u4ee4\u8d85\u51fa MOP Cache \u5bb9\u91cf\u540e\uff0c\u6307\u4ee4\u8d70 ICache + Decode\uff0c\u6b64\u65f6\u53ef\u4ee5\u8fbe\u5230 6 \u7684 IPC\uff0c\u4e0e 6-wide \u7684 Decode Width \u543b\u5408\u3002\u5f53 footprint \u8d85\u51fa 64 KB \u65f6\uff0cIPC \u4e0b\u964d\uff0c\u5bf9\u5e94\u4e86 64KB \u7684 L1 ICache \u5bb9\u91cf\u3002</p>\n<p>\u8d85\u51fa L1 ICache \u5bb9\u91cf\u540e\uff0c\u53ef\u4ee5\u8fbe\u5230 4 \u7684 IPC\uff0c\u8bf4\u660e L2 Cache \u53ef\u4ee5\u63d0\u4f9b\u6bcf\u5468\u671f 16 \u5b57\u8282\u7684\u53d6\u6307\u5e26\u5bbd\u3002</p>\n<h3 id=\"mop-cache\">MOP Cache<a class=\"headerlink\" href=\"#mop-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>1536 macro-operations</strong>, 4-way skewed associative, VIVT behaving as PIPT, NRU replacement policy, <strong>8 MOP/cycle</strong></p>\n<p>\u56e0\u4e3a MOP Cache \u7684\u5e26\u5bbd\u6bd4 Decode \u9ad8\uff0c\u4e3a\u4e86\u6d4b\u8bd5\u51fa MOP Cache \u7684\u89c4\u683c\uff0c\u9700\u8981\u6784\u9020\u6307\u4ee4\u5e8f\u5217\uff0c\u4f7f\u5176\u53ef\u4ee5\u8fbe\u5230 8 MOP/cycle \u7684 IPC\uff0c\u5982\u679c\u8d70\u7684\u662f Instruction Fetch + Decode\uff0c\u5219\u8fbe\u4e0d\u5230\u8fd9\u4e2a IPC\u3002\u4f46\u662f Neoverse V2 \u7684 Dispatch \u6709\u6bd4\u8f83\u660e\u786e\u7684\u9650\u5236\uff1a</p>\n<p>The dispatch stage can process up to 8 MOPs per cycle and dispatch up to 16 \u00b5OPs per cycle, with the following limitations on the number of \u00b5OPs of each type that may be simultaneously dispatched.</p>\n<ul>\n<li>Up to 4 \u00b5OPs utilizing the S\uff08\u5355\u5468\u671f\u6574\u6570\uff09or B\uff08\u5206\u652f\uff09pipelines</li>\n<li>Up to 4 \u00b5OPs utilizing the M\uff08\u591a\u5468\u671f\u6574\u6570\uff09pipelines</li>\n<li>Up to 2 \u00b5OPs utilizing the M0\uff08\u591a\u5468\u671f\u6574\u6570\uff09pipelines</li>\n<li>Up to 2 \u00b5OPs utilizing the V0\uff08\u6d6e\u70b9/\u5411\u91cf\uff09 pipeline</li>\n<li>Up to 2 \u00b5OPs utilizing the V1\uff08\u6d6e\u70b9/\u5411\u91cf\uff09 pipeline</li>\n<li>Up to 6 \u00b5OPs utilizing the L\uff08\u8bbf\u5b58\uff09pipelines</li>\n</ul>\n<p>\u8003\u8651\u5230\u8fd9\u4e2a\u9650\u5236\uff0c\u4f7f\u7528 4 \u6761 add \u6307\u4ee4\uff0c4 \u6761 fadd \u6307\u4ee4\u4e3a\u4e00\u7ec4\uff0c\u4e0d\u65ad\u91cd\u590d\u3002\u901a\u8fc7\u6d4b\u8bd5\uff0c\u8fd9\u6837\u7684\u6307\u4ee4\u5e8f\u5217\u786e\u5b9e\u53ef\u4ee5\u8fbe\u5230 8 \u7684 IPC\u3002\u5f53\u6307\u4ee4\u4e2a\u6570\u589e\u52a0\u5230\u8d85\u51fa MOP Cache \u5bb9\u91cf\u65f6\uff0c\u5c06\u4f1a\u89c2\u5bdf\u5230\u6027\u80fd\u7684\u4e0b\u964d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_mop_cache.png\" /></p>\n<p>\u62d0\u70b9\u51fa\u73b0\u5728 192 \u4e2a\u6307\u4ee4\u7ec4\uff0c\u6b64\u65f6\u8fbe\u5230 MOP Cache \u7684\u5bb9\u91cf\u74f6\u9888\uff0c<code>192*8=1536</code>\uff0c\u6b63\u597d\u662f MOP Cache \u7684\u5bb9\u91cf\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aCaches entries at the 4KB, 16KB, 64KB, or 2MB granularity, Fully associative, 48 entries</p>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 B \u6307\u4ee4\uff0c\u4f7f\u5f97 B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 48 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 48 \u7684 L1 ITLB \u5bb9\u91cf\u3002\u6b64\u540e\u6027\u80fd\u964d\u4f4e\u5230 7 CPI\uff0c\u6b64\u65f6\u5bf9\u5e94\u4e86 L2 Unified TLB \u7684\u5ef6\u8fdf\u3002</p>\n<p>\u8fdb\u4e00\u6b65\u589e\u52a0 Page \u6570\u91cf\uff0c\u53d1\u73b0\u5728\u5927\u7ea6 1000 \u4e2a\u9875\u7684\u65f6\u5019\uff0c\u65f6\u95f4\u4ece 7 cycle \u9010\u6e10\u4e0a\u5347\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_itlb_l2.png\" /></p>\n<p>\u8003\u8651\u5230 L2 Unified TLB \u4e00\u5171\u6709 2048 \u4e2a Entry\uff0c\u731c\u6d4b\u5b83\u9650\u5236\u4e86 ITLB \u80fd\u4f7f\u7528\u7684 L2 TLB \u7684\u5bb9\u91cf\u53ea\u6709 2048 \u7684\u4e00\u534a\uff0c\u4e5f\u5c31\u662f 1024 \u9879\u3002\u8d85\u51fa 1024 \u9879\u4ee5\u540e\uff0c\u9700\u8981 Page Table Walker \u8fdb\u884c\u5730\u5740\u7ffb\u8bd1\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a6-wide Decode</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>Return Stack \u8bb0\u5f55\u4e86\u6700\u8fd1\u7684\u51fd\u6570\u8c03\u7528\u94fe\uff0ccall \u65f6\u538b\u6808\uff0creturn \u65f6\u5f39\u6808\uff0c\u4ece\u800c\u5b9e\u73b0 return \u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u7684\u9884\u6d4b\u3002\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u53d1\u73b0 Neoverse V2 \u7684 Return Stack \u6df1\u5ea6\u4e3a 32\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_return_stack.png\" /></p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"dispatch\">Dispatch<a class=\"headerlink\" href=\"#dispatch\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aup to 8 MOPs per cycle and up to 16 uOPs per cycle</p>\n<h3 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<p>The Neoverse V2 core allows data to be forwarded from store instructions to a load instruction with the restrictions mentioned below:</p>\n<ul>\n<li>Load start address should align with the start or middle address of the older store</li>\n<li>Loads of size greater than or equal to 8 bytes can get the data forwarded from a maximum of 2 stores. If there are 2 stores, then each store should forward to either first or second half of the load</li>\n<li>Loads of size less than or equal to 4 bytes can get their data forwarded from only 1 store</li>\n</ul>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff1a</p>\n<p>\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>{0,1}</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>{0,2}</td>\n<td>{0,2}</td>\n<td>{0}</td>\n<td>{-4,0}</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>{0,4}</td>\n<td>{0,4}</td>\n<td>{0,4}</td>\n<td>{-4,0,4}</td>\n</tr>\n</tbody>\n</table>\n<p>\u4e00\u4e2a Load \u9700\u8981\u8f6c\u53d1\u4e24\u4e2a Store \u7684\u6570\u636e\u7684\u60c5\u51b5\uff1a\u5bf9\u5730\u5740 x \u7684 32b Store \u548c\u5bf9\u5730\u5740 x+4 \u7684 32b Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 64b Load\uff0c\u5728 Overlap \u7684\u60c5\u51b5\u4e0b\uff0c\u8981\u6c42 y=x\uff0c\u4e5f\u5c31\u662f\u6070\u597d\u524d\u534a\u6765\u81ea\u7b2c\u4e00\u4e2a Store\uff0c\u540e\u534a\u6765\u81ea\u7b2c\u4e8c\u4e2a Store\u3002</p>\n<p>\u548c\u5b98\u65b9\u7684\u63cf\u8ff0\u662f\u6bd4\u8f83\u7b26\u5408\u7684\uff0c\u53ea\u8003\u8651\u4e86\u5168\u90e8\u8f6c\u53d1\u3001\u8f6c\u53d1\u524d\u534a\u548c\u8f6c\u53d1\u540e\u534a\u7684\u4e09\u79cd\u573a\u666f\u3002\u7279\u522b\u5730\uff0c\u9488\u5bf9\u5e38\u89c1\u7684 64b Load\uff0c\u652f\u6301 y-x=-4\u3002\u540c\u65f6\u4e5f\u652f\u6301\u524d\u534a\u548c\u540e\u534a\u6765\u81ea\u4e24\u4e2a\u4e0d\u540c\u7684 Store\u3002\u5bf9\u5730\u5740\u672c\u8eab\u7684\u5bf9\u9f50\u6ca1\u6709\u8981\u6c42\uff0c\u751a\u81f3\u5728\u8de8\u7f13\u5b58\u884c\u8fb9\u754c\u65f6\u4e5f\u53ef\u4ee5\u8f6c\u53d1\uff0c\u53ea\u662f\u5bf9 Load \u548c Store \u7684\u76f8\u5bf9\u4f4d\u7f6e\u6709\u8981\u6c42\u3002</p>\n<p>\u548c <a href=\"../../11/amd_zen5/\">Zen 5</a> \u76f8\u6bd4\uff0cNeoverse V2 \u5bf9 Store \u548c Load \u7684\u76f8\u5bf9\u4f4d\u7f6e\u6709\u989d\u5916\u7684\u8981\u6c42\uff08\u5f00\u5934\u6216\u6b63\u4e2d\u592e\uff09\uff0c\u4f46\u652f\u6301\u4e86 Store \u548c Load \u53ea\u6709\u4e00\u90e8\u5206\u8986\u76d6\u7684\u60c5\u51b5\uff0c\u4e5f\u5141\u8bb8\u4e00\u4e2a Load \u4ece\u4e24\u4e2a Store \u4e2d\u53d6\u5f97\u6570\u636e\u3002</p>\n<p>\u4ece\u6027\u80fd\u4e0a\uff0c\u53ef\u4ee5\u8f6c\u53d1\u65f6 5 Cycle\uff0c\u6709 Overlap \u4f46\u65e0\u6cd5\u8f6c\u53d1\u65f6 10.5 Cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aARM Neoverse V2 \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42 ld \u548c st \u5730\u5740\u76f8\u540c\u6216\u5dee\u51fa\u534a\u4e2a st \u5bbd\u5ea6</li>\n<li>1 ld + 2 st: \u8981\u6c42 ld \u548c st \u5730\u5740\u76f8\u540c</li>\n<li>1 ld + 4 st: \u4e0d\u652f\u6301</li>\n</ul>\n<h3 id=\"\u8ba1\u7b97\u5355\u5143\">\u8ba1\u7b97\u5355\u5143<a class=\"headerlink\" href=\"#\u8ba1\u7b97\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a6x ALU, <strong>2x Branch</strong>, <strong>4x 128b SIMD</strong></p>\n<p>\u5b9e\u6d4b\u4ee5\u4e0b\u6307\u4ee4\u7684\u541e\u5410\uff1a</p>\n<ul>\n<li>int add: 4 IPC\uff0c\u53d7\u5230 Dispatch \u9650\u5236\uff1a<code>Up to 4 \u00b5OPs utilizing the S\uff08\u5355\u5468\u671f\u6574\u6570\uff09or B\uff08\u5206\u652f\uff09pipelines</code></li>\n<li>int mul: 2 IPC\uff0c\u5bf9\u5e94\u4e24\u4e2a Multi Cycle \u5355\u5143</li>\n<li>int not taken branch: 2 IPC\uff0c\u5bf9\u5e94\u4e24\u4e2a Branch \u5355\u5143</li>\n<li>asimd fadd double: 4 IPC\uff0c\u5bf9\u5e94\u56db\u4e2a FP/ASIMD \u5355\u5143</li>\n</ul>\n<h3 id=\"load-store-unit\">Load Store Unit<a class=\"headerlink\" href=\"#load-store-unit\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>2 Load/Store Pipe + 1 Load Pipe</strong>, Reduce bandwidth or <strong>incur additional latency</strong> for:</p>\n<ol>\n<li>Load operations that cross a cache-line (64-byte) boundary.</li>\n<li>Quad-word load operations that are not 4B aligned.</li>\n<li>Store operations that cross a 32B boundary.</li>\n</ol>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u4e00\u4e2a\u5468\u671f\u5185\u53ef\u4ee5\u6700\u591a\u5b8c\u6210\u5982\u4e0b\u7684 Load/Store \u6307\u4ee4\uff1a</p>\n<ul>\n<li>3x 64b Load</li>\n<li>2x 64b Load + 1x 64b Store</li>\n<li>1x 64b Load + 2x 64b Store</li>\n<li>2x 64b Store</li>\n</ul>\n<p>\u8fd9\u4e2a\u6027\u80fd\u7b26\u5408 2 LS + 1 LD pipe \u7684\u8bbe\u8ba1\u3002</p>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u5f53 Load \u6307\u4ee4\u6ca1\u6709\u8de8\u8d8a\u7f13\u5b58\u884c\u65f6\uff0cload to use \u5ef6\u8fdf\u662f 4 cycle\uff1b\u5f53 Load \u6307\u4ee4\u8de8\u8fc7 64B \u7f13\u5b58\u884c\u8fb9\u754c\u65f6\uff0cload to use \u5ef6\u8fdf\u589e\u52a0\u5230 5 cycle\u3002</p>\n<h3 id=\"memory-dependency-predictor\">Memory Dependency Predictor<a class=\"headerlink\" href=\"#memory-dependency-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u9884\u6d4b\u6267\u884c Load\uff0c\u9700\u8981\u4fdd\u8bc1 Load \u548c\u4e4b\u524d\u7684 Store \u8bbf\u95ee\u7684\u5185\u5b58\u6ca1\u6709 Overlap\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u9884\u6d4b\u5668\u6765\u9884\u6d4b Load \u548c Store \u4e4b\u524d\u5728\u5185\u5b58\u4e0a\u7684\u4f9d\u8d56\u3002\u53c2\u8003 <a href=\"https://blog.stuffedcow.net/2014/01/x86-memory-disambiguation/\">Store-to-Load Forwarding and Memory Disambiguation in x86 Processors</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e24\u4e2a\u6307\u4ee4\u6a21\u5f0f\uff0c\u5206\u522b\u5728\u5730\u5740\u548c\u6570\u636e\u4e0a\u6709\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>\u6570\u636e\u4f9d\u8d56\uff0c\u5730\u5740\u65e0\u4f9d\u8d56\uff1a<code>str x3, [x1]</code> \u548c <code>ldr x3, [x2]</code></li>\n<li>\u5730\u5740\u4f9d\u8d56\uff0c\u6570\u636e\u65e0\u4f9d\u8d56\uff1a<code>str x2, [x1]</code> \u548c <code>ldr x1, [x2]</code></li>\n</ul>\n<p>\u521d\u59cb\u5316\u65f6\uff0c<code>x1</code> \u548c <code>x2</code> \u6307\u5411\u540c\u4e00\u4e2a\u5730\u5740\uff0c\u91cd\u590d\u5982\u4e0a\u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u89c2\u5bdf\u5230\u591a\u5c11\u6761 <code>ldr</code> \u6307\u4ee4\u65f6\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_memory_dependency_predictor.png\" /></p>\n<p>\u6709\u610f\u601d\u7684\u662f\uff0c\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 40\uff0c\u800c\u6570\u636e\u4f9d\u8d56\u6ca1\u6709\u9608\u503c\u3002</p>\n<h3 id=\"move-elimination\">Move Elimination<a class=\"headerlink\" href=\"#move-elimination\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u7279\u5b9a\u60c5\u51b5\u4e0b\u8fd9\u4e9b\u6307\u4ee4\u53ef\u4ee5\u88ab\u4f18\u5316\uff1amov reg, 0; mov reg, zero; mov vreg, 0; mov reg, reg;mov vreg, vreg</p>\n<p>\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5404\u79cd\u6a21\u5f0f\u7684 IPC \u5982\u4e0b\uff1a</p>\n<ul>\n<li>mov reg, 0: IPC 6</li>\n<li>mov vreg, 0: IPC 6</li>\n<li>mov reg, reg: \u65e0\u4f9d\u8d56\u94fe\u65f6 IPC 4</li>\n<li>mov vreg, vreg: \u65e0\u4f9d\u8d56\u94fe\u65f6 IPC 3.6</li>\n</ul>\n<p>\u867d\u7136\u505a\u4e86\u4f18\u5316\uff0c\u4f46\u7b97\u4e0d\u4e0a\u5f88\u5feb\u3002</p>\n<h3 id=\"reorder-buffer\">Reorder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>320 MOP</strong> ROB, 8-wide retire</p>\n<p>\u628a\u4e24\u4e2a\u4e32\u884c\u7684 fsqrt \u5e8f\u5217\u653e\u5728\u5faa\u73af\u7684\u5934\u548c\u5c3e\uff0c\u4e2d\u95f4\u7528 NOP \u586b\u5145\uff0c\u5982\u679c ROB \u8db3\u591f\u5927\uff0c\u53ef\u4ee5\u5728\u6267\u884c\u5f00\u5934\u4e32\u884c\u7684 fsqrt \u5e8f\u5217\u65f6\uff0c\u540c\u65f6\u6267\u884c\u7ed3\u5c3e\u4e32\u884c\u7684 fsqrt \u5e8f\u5217\uff0c\u6b64\u65f6\u6027\u80fd\u662f\u6700\u4f18\u7684\u3002\u5982\u679c ROB \u4e0d\u591f\u5927\uff0c\u90a3\u4e48\u4f1a\u89c2\u5bdf\u5230\u6027\u80fd\u4e0b\u964d\u3002\u7531\u4e8e Neoverse V2 \u6267\u884c NOP \u53ef\u4ee5\u8fbe\u5230\u63a5\u8fd1 12 \u7684 IPC\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u5f88\u5c11\u7684 fsqrt \u5c31\u8db3\u591f\u751f\u6210\u8db3\u591f\u7684\u5ef6\u8fdf\u3002</p>\n<p>\u901a\u8fc7\u6d4b\u8bd5\uff0c\u53d1\u73b0\u5728\u5927\u7ea6 640 \u6761 NOP \u65f6\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff0c\u800c Neoverse V2 \u5b9e\u73b0\u4e86 Instruction Fusion\uff0c\u4e24\u6761 NOP \u6307\u4ee4\u7b97\u505a\u4e00\u6761 uOP\uff0c\u540c\u65f6\u4e5f\u662f\u4e00\u6761 MOP\uff0c\u56e0\u6b64 640 \u6761 NOP \u5bf9\u5e94 320 MOP \u7684 ROB \u5927\u5c0f\u3002\u6781\u9650\u60c5\u51b5\u4e0b\uff0c320 MOP \u53ef\u4ee5\u5b58 640 uOP\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u6bd4\u8f83\u96be\u8fbe\u5230\uff0c\u5f88\u5bb9\u6613\u53d7\u9650\u4e8e\u5176\u4ed6\u7ed3\u6784\u3002</p>\n<h3 id=\"l1-dcache\">L1 DCache<a class=\"headerlink\" href=\"#l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>64KB</strong>, 4-way set associative, <strong>VIPT behaving as PIPT</strong>, 64B cacheline, ECC protected, RRIP replacement policy, <strong>4\u00d764-bit read paths</strong> and <strong>4\u00d764-bit write</strong> paths for the integer execute pipeline, <strong>3\u00d7128-bit read paths</strong> and <strong>2\u00d7128-bit</strong> write paths for the vector execute pipeline</p>\n<h4 id=\"\u5bb9\u91cf\">\u5bb9\u91cf<a class=\"headerlink\" href=\"#\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 64KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 64KB \u7684 L1 DCache \u5bb9\u91cf\u3002\u4e4b\u540e\u5ef6\u8fdf\u5148\u4e0a\u5347\u540e\u4e0b\u964d\uff0c\u4e0e ARM \u91c7\u7528\u7684 Correlated Miss Caching(CMC) \u9884\u53d6\u5668\u8bb0\u4f4f\u4e86 pointer chasing \u7684\u5386\u53f2\u6709\u5173\uff0c\u8be6\u7ec6\u53ef\u4ee5\u9605\u8bfb <a href=\"https://hc33.hotchips.org/assets/program/conference/day1/20210818_Hotchips_NeoverseN2.pdf\">Arm Neoverse N2: Arm\u2019s 2nd generation high performance infrastructure CPUs and system IPs</a>\u3002</p>\n<h4 id=\"\u5ef6\u8fdf\">\u5ef6\u8fdf<a class=\"headerlink\" href=\"#\u5ef6\u8fdf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0cL1 DCache \u7684 load to use latency \u662f 4 cycle\uff0c\u6ca1\u6709\u9488\u5bf9 pointer chasing \u505a 3 cycle \u7684\u4f18\u5316\u3002</p>\n<h4 id=\"\u541e\u5410\">\u541e\u5410<a class=\"headerlink\" href=\"#\u541e\u5410\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4f7f\u7528 FP/ASIMD 128b Load \u53ef\u4ee5\u8fbe\u5230 3 IPC\uff0c\u5bf9\u5e94\u4e86 3x128b read paths\uff1b\u800c\u5982\u679c\u4f7f\u7528 2x64b \u6574\u6570 LDP\uff0c\u5219\u53ea\u80fd\u8fbe\u5230 2 IPC\uff0c\u5bf9\u5e94 4x64b read paths\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8981\u8fbe\u5230\u5cf0\u503c\u7684\u8bfb\u53d6\u6027\u80fd\uff0c\u5fc5\u987b\u7528 FP/ASIMD \u6307\u4ee4\u3002\u5199\u5165\u65b9\u9762\uff0c\u5411\u91cf 128b Store \u53ef\u4ee5\u8fbe\u5230 2 IPC\uff0c\u5bf9\u5e94\u4e86 2x128b write paths\uff1b\u7c7b\u4f3c\u5730\uff0c2x64b \u6574\u6570 STP \u80fd\u8fbe\u5230 2 IPC\uff0c\u5bf9\u5e94 4x64b write paths\u3002</p>\n<h4 id=\"vipt\">VIPT<a class=\"headerlink\" href=\"#vipt\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 4KB page \u7684\u60c5\u51b5\u4e0b\uff0c64KB 4-way \u7684 L1 DCache \u4e0d\u6ee1\u8db3 VIPT \u7684 Index \u5168\u5728\u9875\u5185\u504f\u79fb\u7684\u6761\u4ef6\uff08\u8be6\u89c1 <a href=\"../../../../2023/12/08/vipt-l1-cache-page-size/\">VIPT \u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb</a>\uff09\uff0c\u6b64\u65f6\u8981\u4e48\u6539\u7528 PIPT\uff0c\u8981\u4e48\u5728 VIPT \u7684\u57fa\u7840\u4e0a\u5904\u7406 alias \u7684\u95ee\u9898\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e00\u70b9\uff0c\u53c2\u8003 <a href=\"https://blog.cyyself.name/why-the-big-l1-cache-is-so-hard/\">\u6d45\u8c08\u73b0\u4ee3\u5904\u7406\u5668\u5b9e\u73b0\u8d85\u5927 L1 Cache \u7684\u65b9\u5f0f</a> \u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u7528 shm \u6784\u9020\u51fa\u4e24\u4e2a 4KB \u865a\u62df\u9875\u6620\u5c04\u5230\u540c\u4e00\u4e2a\u7269\u7406\u9875\u7684\u60c5\u51b5\uff0c\u7136\u540e\u5728\u4e24\u4e2a\u865a\u62df\u9875\u4e4b\u95f4 copy\uff0c\u53d1\u73b0\u76f8\u6bd4\u5728\u540c\u4e00\u4e2a\u865a\u62df\u9875\u5185 copy \u6709\u663e\u8457\u7684\u6027\u80fd\u4e0b\u964d\uff0c\u5e76\u4e14\u4ea7\u751f\u4e86\u5927\u91cf\u7684 L1 DCache Refill\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>copy from aliased page = 3261121467 cycles, 285103870 refills\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>baseline = 1520692165 cycles, 1200 refills\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>slowdown = 2.14x\n</span></code></pre></div>\n<p>\u56e0\u6b64\u9a8c\u8bc1\u4e86 L1 DCache \u91c7\u7528\u7684\u662f VIPT\uff0c\u5e76\u505a\u4e86\u9488\u5bf9 alias \u7684\u6b63\u786e\u6027\u5904\u7406\u3002\u5982\u679c\u662f PIPT\uff0c\u90a3\u4e48 L1 DCache \u4f1a\u53d1\u73b0\u8fd9\u4e24\u4e2a\u9875\u5bf9\u5e94\u7684\u662f\u76f8\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u6027\u80fd\u4e0d\u4f1a\u4e0b\u964d\uff0c\u4e5f\u4e0d\u9700\u8981\u9891\u7e41\u7684 refill\u3002</p>\n<h4 id=\"\u6784\u9020\">\u6784\u9020<a class=\"headerlink\" href=\"#\u6784\u9020\" title=\"Permanent link\">&para;</a></h4>\n<p>\u8fdb\u4e00\u6b65\u5c1d\u8bd5\u7814\u7a76 Neoverse V2 \u7684 L1 DCache \u7684\u6784\u9020\uff0c\u4e3a\u4e86\u652f\u6301\u6bcf\u5468\u671f 3 \u6761 Load \u6307\u4ee4\uff0cL1 DCache \u901a\u5e38\u4f1a\u5206 Bank\uff0c\u6bcf\u4e2a Bank \u90fd\u6709\u81ea\u5df1\u7684\u8bfb\u53e3\u3002\u5982\u679c Load \u5206\u5e03\u5230\u4e0d\u540c\u7684 Bank \u4e0a\uff0c\u5404 Bank \u53ef\u4ee5\u540c\u65f6\u8bfb\u53d6\uff0c\u83b7\u5f97\u66f4\u9ad8\u7684\u6027\u80fd\uff1b\u5982\u679c Load \u547d\u4e2d\u76f8\u540c\u7684 Bank\uff0c\u4f46\u662f\u8bbf\u95ee\u7684 Bank \u5185\u5730\u5740\u4e0d\u540c\uff0c\u5c31\u53ea\u80fd\u7b49\u5230\u4e0b\u4e00\u4e2a\u5468\u671f\u518d\u8bfb\u53d6\u3002\u4e3a\u4e86\u6d4b\u8bd5 Bank \u7684\u6784\u9020\uff0c\u8bbe\u8ba1\u4e00\u7cfb\u5217\u4ee5\u4e0d\u540c\u7684\u56fa\u5b9a stride \u95f4\u9694\u7684 Load \u6307\u4ee4\uff0c\u89c2\u5bdf Load \u7684 IPC\uff1a</p>\n<ul>\n<li>Stride=1B/2B/4B/8B/16B/32B: IPC=3</li>\n<li>Stride=64B: IPC=2</li>\n<li>Stride=128B/256B/512B: IPC=1</li>\n</ul>\n<p>Stride=64B \u65f6\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff0c\u8bf4\u660e\u6b64\u65f6\u51fa\u73b0\u4e86 Bank Conflict\uff0c\u8fdb\u4e00\u6b65\u5230 Stride=128B \u65f6\uff0c\u53ea\u80fd\u8fbe\u5230 1 \u7684 IPC\uff0c\u8bf4\u660e\u6b64\u65f6\u6240\u6709\u7684 Load \u90fd\u547d\u4e2d\u4e86\u540c\u4e00\u4e2a Bank\uff0c\u5e76\u4e14\u662f\u4e32\u884c\u8bfb\u53d6\u3002\u6839\u636e\u8fd9\u4e2a\u73b0\u8c61\uff0c\u8ba4\u4e3a Neoverse V2 \u7684 L1 DCache \u7ec4\u7ec7\u65b9\u5f0f\u548c\u9650\u5236\u662f\uff1a</p>\n<ul>\n<li>\u4e00\u5171\u6709\u4e24\u4e2a Bank\uff0cBank Index \u662f VA[6]</li>\n<li>\u6bcf\u4e2a Bank \u6bcf\u5468\u671f\u53ef\u4ee5\u4ece\u4e00\u4e2a\u7f13\u5b58\u884c\u8bfb\u53d6\u6570\u636e</li>\n<li>\u652f\u6301\u591a\u4e2a Load \u8bbf\u95ee\u540c\u4e00\u4e2a\u7f13\u5b58\u884c</li>\n<li>\u5982\u679c\u591a\u4e2a Load \u8bbf\u95ee\u540c\u4e00\u4e2a Bank \u7684\u4e0d\u540c\u7f13\u5b58\u884c\uff0c\u53ea\u80fd\u4e00\u4e2a\u5468\u671f\u5b8c\u6210\u4e00\u4e2a Load</li>\n</ul>\n<p>\u8fd9\u91cc\u8ba8\u8bba\u7684\u662f\u7f13\u5b58\u884c\u7ea7\u522b\u7684 Bank\uff0c\u5b9e\u9645\u4e0a\u901a\u5e38\u7f13\u5b58\u884c\u5185\u90e8\u4e5f\u4f1a\u8fdb\u884c Bank \u5212\u5206\uff0c\u4f46\u4e3b\u8981\u662f\u4e3a\u4e86\u529f\u8017\uff0c\u6bd4\u5982\u4ece\u4e00\u4e2a 64B \u7f13\u5b58\u884c\u91cc\u8bfb\u53d6 8B \u6570\u636e\uff0c\u4e0d\u9700\u8981\u628a\u6574\u4e2a 64B \u90fd\u8bfb\u51fa\u6765\u3002</p>\n<h3 id=\"l1-dtlb\">L1 DTLB<a class=\"headerlink\" href=\"#l1-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aCaches entries at the 4KB, 16KB, 64KB, 2MB or 512MB granularity, Fully associative, <strong>48</strong> entries. A miss in the L1 data TLB and a hit in the L2 TLB has a 6-cycle penalty compared to a hit in the L1 data TLB.</p>\n<p>\u7528 pointer chasing \u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_l1dtlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 48 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 48 \u7684 L1 DTLB \u5bb9\u91cf\u3002\u8d85\u51fa\u5bb9\u91cf\u540e\uff0c\u9700\u8981\u989d\u5916\u7684 5 cycle \u7684 latency \u8bbf\u95ee L2 Unified TLB\u3002</p>\n<h3 id=\"l2-unified-tlb\">L2 Unified TLB<a class=\"headerlink\" href=\"#l2-unified-tlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aShared by instructions and data, 8-way set associative, 2048 entries</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a1MB or 2MB, 8-way set associative, 4 banks, PIPT, ECC protected, 64B cacheline, 10 cycle load-to-use, 128 B/cycle</p>\n<h3 id=\"sve\">SVE<a class=\"headerlink\" href=\"#sve\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a128b SVE vector length</p>\n<p>\u5728 Linux \u4e0b\u67e5\u770b <code>/proc/sys/abi/sve_default_vector_length</code> \u7684\u5185\u5bb9\uff0c\u5f97\u5230 SVE \u5bbd\u5ea6\u4e3a 16 \u5b57\u8282\uff0c\u4e5f\u5c31\u662f 128b\u3002</p>\n<p>\u5b9e\u6d4b\u53d1\u73b0 Neoverse V2 \u6bcf\u5468\u671f\u6700\u591a\u53ef\u4ee5\u6267\u884c 4 \u6761 ASIMD \u6216 SVE \u7684\u6d6e\u70b9 FMA \u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u5468\u671f\u6d6e\u70b9\u5cf0\u503c\u6027\u80fd\uff1a</p>\n<ul>\n<li>\u5355\u7cbe\u5ea6\uff1a<code>128/32*2*4=32</code> FLOP per cycle</li>\n<li>\u53cc\u7cbe\u5ea6\uff1a<code>128/64*2*4=16</code> FLOP per cycle</li>\n</ul>\n<p>\u4e0e Zen 2-4\u3001Oryon\u3001Firestorm\u3001LA464\u3001Haswell \u7b49\u5fae\u67b6\u6784\u770b\u9f50\uff0c\u4f46\u4e0d\u53ca Zen 5\u3001Skylake \u7b49\u901a\u8fc7 AVX512 \u63d0\u4f9b\u7684\u5cf0\u503c\u6d6e\u70b9\u6027\u80fd\u3002</p>", "image": null, "date_published": "2024-11-07T00:00:00+00:00", "authors": [], "tags": ["arm", "cpu", "hardware", "neoverse", "performance", "uarch-review"]}, {"id": "https://jia.je/software/2024/10/23/linux-core-scheduling/", "url": "https://jia.je/software/2024/10/23/linux-core-scheduling/", "title": "Linux \u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76", "content_html": "<h1 id=\"linux-\u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76\">Linux \u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76<a class=\"headerlink\" href=\"#linux-\u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u770b\u5230\u4e00\u4e9b\u5173\u4e8e Linux \u5927\u5c0f\u6838\u8c03\u5ea6\u7b97\u6cd5\u7684\u4e00\u4e9b\u535a\u5ba2\uff0c\u8003\u8651\u5230\u5927\u5c0f\u6838\u76ee\u524d\u5df2\u7ecf\u6bd4\u8f83\u5e38\u89c1\u4e86\uff0c\u56e0\u6b64\u505a\u4e00\u4e9b\u73b0\u72b6\u7684\u63a2\u7a76\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u73b0\u8c61\">\u73b0\u8c61<a class=\"headerlink\" href=\"#\u73b0\u8c61\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"intel\">Intel<a class=\"headerlink\" href=\"#intel\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u53ef\u4ee5\u505a\u4e00\u4e0b\u5b9e\u9a8c\uff0c\u7528 <code>stress --cpu N</code> \u542f\u52a8 N \u4e2a\u8ba1\u7b97\u8d1f\u8f7d\uff0c\u770b\u770b\u8fd9\u4e9b\u7ebf\u7a0b\u90fd\u4f1a\u88ab\u5206\u914d\u5230\u54ea\u4e9b\u6838\u4e0a\u3002\u5728 Intel Core i9-14900K \u4e0a\u5b9e\u9a8c\uff0c\u8fd9\u4e2a CPU \u662f 8P+16E\uff0c8P \u5bf9\u5e94 0-15 \u6838\uff0c\u8d85\u7ebf\u7a0b\u7684\u6838\u7684 ID \u662f\u8fde\u53f7\u7684\uff0c16E \u5bf9\u5e94 16-31 \u6838\uff0c\u89c2\u5bdf\u5230\u4e0b\u9762\u7684\u7ed3\u679c\uff1a</p>\n<ul>\n<li><code>N=1</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 12-15 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c\u8fd9\u5bf9\u5e94\u7684\u662f 8P \u4e2d\u7684\u6700\u540e 2P</li>\n<li><code>N=2</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 12-13 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c\u4ee5\u53ca 14-15 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c\u540c\u6837\u4e5f\u662f 8P \u4e2d\u7684\u6700\u540e 2P\uff0c\u6bcf\u4e2a P \u4e0a\u5206\u914d\u4e00\u4e2a\u4efb\u52a1</li>\n<li><code>N=3</code> \u65f6\uff0c\u5728 <code>N=2</code> \u7684\u57fa\u7840\u4e0a\uff0c\u5728 0-11 \u6838\u91cc\u518d\u8c03\u5ea6\u4e00\u4e2a</li>\n<li><code>N=4..=8</code> \u65f6\uff0c\u5728 <code>N=2</code> \u7684\u57fa\u7840\u4e0a\uff0c\u5728 0-11 \u6838\u91cc\u8c03\u5ea6\u5269\u4e0b\u7684\u4efb\u52a1\uff0c\u4f46\u4e0d\u4f1a\u5206\u914d\u5230\u4e00\u4e2a P \u6838\u7684\u4e24\u4e2a\u903b\u8f91\u6838\u4e0a</li>\n<li><code>N=9..=24</code> \u65f6\uff0c\u5728 <code>N=8</code> \u7684\u57fa\u7840\u4e0a\uff0c\u5728 16-31 \u6838\u91cc\u8c03\u5ea6\u5269\u4e0b\u7684\u4efb\u52a1</li>\n<li><code>N=25..=32</code> \u65f6\uff0c\u5728 <code>N=24</code> \u7684\u57fa\u7840\u4e0a\uff0c\u628a\u4efb\u52a1\u5206\u914d\u5230 P \u6838\u7684\u7b2c\u4e8c\u4e2a\u903b\u8f91\u6838\u4e0a</li>\n</ul>\n<p>\u53ef\u89c1\u5728\u8c03\u5ea6\u65f6\uff0c\u6309\u7167\u5982\u4e0b\u7684\u4f18\u5148\u7ea7\uff1a</p>\n<ol>\n<li>\u6700\u540e 2 \u4e2a P \u6838</li>\n<li>\u5176\u4f59 6 \u4e2a P \u6838</li>\n<li>E \u6838</li>\n<li>P \u6838\u7684\u8d85\u7ebf\u7a0b</li>\n</ol>\n<p>\u53ef\u89c1 P \u6838\u5185\u90e8\u4e5f\u6709\u4f18\u5148\u7ea7\u4e0d\u540c\uff0c\u6700\u540e 2 \u4e2a P \u6838\u5177\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\uff0c\u800c\u5b83\u4eec\u7684 Boost \u9891\u7387\u786e\u5b9e\u4e5f\u66f4\u9ad8\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"m\">5700000</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/sys/devices/system/cpu/cpufreq/policy12/scaling_max_freq\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"m\">6000000</span>\n</span></code></pre></div>\n<p>6 \u4e2a P \u6838\u7684\u6700\u5927\u9891\u7387\u8bbe\u5b9a\u4e3a 5.7 GHz\uff0c2 \u4e2a P \u6838\u7684\u6700\u5927\u9891\u7387\u8bbe\u5b9a\u4e3a 6.0 GHz\u3002\u56e0\u6b64\u8fd9\u4e24\u4e2a 6.0 GHz \u7684 P \u6838\u4f1a\u88ab\u4f18\u5148\u8c03\u5ea6\u3002\u6b64\u65f6\u518d\u6765\u770b <a href=\"https://www.intel.com/content/www/us/en/products/sku/236773/intel-core-i9-processor-14900k-36m-cache-up-to-6-00-ghz/specifications.html\">Intel\u00ae Core\u2122 i9 processor 14900K Spec</a>:</p>\n<ul>\n<li>Max Turbo Frequency: 6 GHz</li>\n<li>Intel\u00ae Thermal Velocity Boost Frequency: 6 GHz</li>\n<li>Intel\u00ae Turbo Boost Max Technology 3.0 Frequency: 5.8 GHz</li>\n<li>Performance-core Max Turbo Frequency: 5.6 GHz</li>\n<li>Performance-core Base Frequency: 3.2 GHz</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b98\u65b9\u5ba3\u4f20\u7684\u6700\u9ad8 Turbo \u9891\u7387\u662f 6 GHz\uff0c\u4f46\u5b9e\u9645\u4e0a\u53ea\u6709\u4e24\u4e2a P \u6838\u53ef\u4ee5\u8fbe\u5230\u3002</p>\n<p>\u4f46\u5e76\u975e\u6240\u6709\u5e73\u53f0\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u90fd\u80fd\u8fbe\u5230\u5ba3\u79f0\u7684\u6700\u9ad8\u9891\u7387\u7684\u3002\u4f8b\u5982\u5728 Dell R730 \u4e0a\uff0cXeon E5-2680 v4 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u53ea\u80fd\u8fbe\u5230 2.9 GHz \u7684 Boost \u9891\u7387\uff0c\u4f46\u6309\u7167 Intel \u5b98\u7f51\uff0c\u8fd9\u4e2a CPU \u7684 Boost \u6700\u9ad8\u53ef\u4ee5\u8fbe\u5230 3.3 GHz\u3002\u5f53\u7136\u4e86\uff0c2.9 GHz \u662f\u5168\u6838\u80fd\u591f\u8fbe\u5230\u7684 Boost\uff0c3.3 GHz \u53ea\u80fd\u5c11\u6570\u7684\u6838\u8fbe\u5230\uff0c\u800c\u670d\u52a1\u5668\u573a\u666f\u4e0b\uff0c\u5927\u591a\u65f6\u95f4\u662f\u8dd1\u591a\u6838\u8d1f\u8f7d\uff0c\u9650\u5236\u5230 2.9 GHz \u4e5f\u53ef\u4ee5\u7406\u89e3\u3002\u5982\u679c\u60f3\u8981 3.3 GHz\uff0c\u5c31\u9700\u8981\u8fdb BIOS \u8bbe\u7f6e\uff0c\u628a\u8c03\u9891\u4ea4\u7ed9 OS\uff0cC-State \u4e5f\u5168\u90e8\u653e\u5f00\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5b9e\u73b0 3.3 GHz \u4e86\u3002\u8fd9\u91cc\u6bd4\u8f83\u91cd\u8981\u7684\u662f\u8981\u6253\u5f00 C6\uff0c\u56e0\u4e3a\u628a\u7a7a\u95f2\u7684\u6838\u653e\u5230 C6 \u4ee5\u540e\uff0c\u624d\u80fd\u628a\u5355\u6838\u8dd1\u5230\u6700\u9ad8\u7684\u9891\u7387\u3002</p>\n<h3 id=\"amd\">AMD<a class=\"headerlink\" href=\"#amd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 AMD Ryzen 9 9950X \u4e0a\u8fdb\u884c\u7c7b\u4f3c\u7684\u5b9e\u9a8c\uff0c\u8fd9\u4e2a CPU \u6709 16 \u4e2a\u6838\uff0c0 \u6838\u548c 16 \u6838\u5bf9\u5e94\u4e00\u4e2a\u7269\u7406\u6838\uff0c\u5176\u4ed6\u4f9d\u6b64\u7c7b\u63a8\uff0c0-7 \u662f\u4e00\u4e2a CCD\uff0c8-15 \u662f\u53e6\u4e00\u4e2a CCD\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<ul>\n<li><code>N=1</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 4\uff0c9 \u548c 20 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=2</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 0 \u548c 16 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c9 \u548c 25 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=3</code> \u65f6\uff0c\u5728 <code>N=2</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 4 \u548c 20 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=4</code> \u65f6\uff0c\u5728 <code>N=3</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 11 \u548c 27 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=5</code> \u65f6\uff0c\u5728 <code>N=4</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 5 \u548c 21 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=6</code> \u65f6\uff0c\u5728 <code>N=5</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 8 \u548c 24 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=7</code> \u65f6\uff0c\u5728 <code>N=6</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 3 \u548c 19 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=8</code> \u65f6\uff0c\u5728 <code>N=7</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 10 \u548c 26 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n</ul>\n<p>\u67e5\u770b\u5b83\u4eec\u7684 <code>scaling_max_freq</code>\uff0c\u4f1a\u53d1\u73b0\u90fd\u662f\u76f8\u540c\u7684 5.752 GHz\u3002\u67e5\u770b\u5b83\u4eec\u7684 <code>amd_pstate_prefcore_ranking</code>\uff0c\u53d1\u73b0\u53d6\u503c\u548c\u903b\u8f91\u6838\u7684\u6620\u5c04\u5173\u7cfb\uff1a</p>\n<ul>\n<li>236: 0,4,16,20</li>\n<li>231: 5,21</li>\n<li>226: 3,19</li>\n<li>221: 1,17</li>\n<li>216: 2,18</li>\n<li>211: 7,23</li>\n<li>206: 6,22</li>\n<li>201: 9,25</li>\n<li>196: 11,27</li>\n<li>191: 8,24</li>\n<li>186: 10,26</li>\n<li>181: 12,28</li>\n<li>176: 13,29</li>\n<li>171: 15,31</li>\n<li>166: 14,30</li>\n</ul>\n<p>\u6309\u7406\u8bf4\u503c\u8d8a\u5927\u7684\uff0c\u8d8a\u5e94\u8be5\u5148\u88ab\u8c03\u5ea6\uff0c\u5e94\u8be5\u6309 0-&gt;4-&gt;5-&gt;3 \u7684\u987a\u5e8f\u5206\u914d\uff0c\u4f46\u5b9e\u9645\u4e0a\u89c2\u5bdf\u7684\u7ed3\u679c\u5e76\u4e0d\u662f\u8fd9\u6837\u3002\u5bfb\u627e\u89c4\u5f8b\uff0c\u53d1\u73b0\u5b83\u5148\u4ece\u7b2c\u4e00\u4e2a CCD \u627e\u5230\u5206\u6570\u6700\u9ad8\u7684\uff0c\u518d\u4ece\u7b2c\u4e8c\u4e2a CCD \u627e\uff0c\u518d\u56de\u5230\u7b2c\u4e00\u4e2a CCD \u627e\u5206\u6570\u7b2c\u4e8c\u9ad8\u7684\uff0c\u4f9d\u6b64\u7c7b\u63a8\uff1a</p>\n<ol>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u6700\u9ad8\u7684\u6838\uff1a0</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u6700\u9ad8\u7684\u6838\uff1a9</li>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u7b2c\u4e8c\u9ad8\u7684\u6838\uff1a4</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u7b2c\u4e8c\u9ad8\u7684\u6838\uff1a11</li>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u7b2c\u4e09\u9ad8\u7684\u6838\uff1a5</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u7b2c\u4e09\u9ad8\u7684\u6838\uff1a8</li>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u7b2c\u56db\u9ad8\u7684\u6838\uff1a3</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u7b2c\u56db\u9ad8\u7684\u6838\uff1a10</li>\n</ol>\n<p>\u8bf4\u660e\u5b83\u7684\u903b\u8f91\u662f\uff0c\u8f6e\u6d41\u4ece\u4e24\u4e2a CCD \u4e2d\u53d6\u51fa\u4e00\u4e2a\u5206\u6570\u5c3d\u91cf\u9ad8\u7684\u6838\u53bb\u5206\u914d\u8d1f\u8f7d\u3002\u5b9e\u9645\u6d4b\u4e0b\u6765\uff0c\u5206\u6570\u9ad8\u7684\u6838\u4e5f\u786e\u5b9e\u80fd\u591f Boost \u5230\u66f4\u9ad8\u7684\u9891\u7387\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>$<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>i<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">$(</span>seq<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">15</span><span class=\"k\">)</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"s2\">&quot;</span><span class=\"nv\">$i</span><span class=\"s2\">:&quot;</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span>numactl<span class=\"w\"> </span>-C<span class=\"w\"> </span><span class=\"nv\">$i</span><span class=\"w\"> </span>perf<span class=\"w\"> </span>stat<span class=\"w\"> </span>-e<span class=\"w\"> </span>cycles,task-clock<span class=\"w\"> </span>stress<span class=\"w\"> </span>--cpu<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>--timeout<span class=\"w\"> </span>1s<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>GHz<span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span>sleep<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">done</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"m\">0</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,700,258,748<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.717 GHz</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"m\">1</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,642,814,521<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.659 GHz</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"m\">2</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,648,004,395<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.665 GHz</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"m\">3</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,663,175,321<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.680 GHz</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"m\">4</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,687,251,660<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.704 GHz</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"m\">5</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,667,947,179<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.685 GHz</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a><span class=\"m\">6</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,595,919,881<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.613 GHz</span>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"m\">7</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,599,885,078<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.617 GHz</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"m\">8</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,424,861,894<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.441 GHz</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a><span class=\"m\">9</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,427,318,403<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.443 GHz</span>\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a><span class=\"m\">10</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,422,689,654<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.439 GHz</span>\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a><span class=\"m\">11</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,425,760,950<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.442 GHz</span>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a><span class=\"m\">12</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,418,583,254<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.435 GHz</span>\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a><span class=\"m\">13</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,425,842,189<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.442 GHz</span>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a><span class=\"m\">14</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,375,985,781<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.392 GHz</span>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a><span class=\"m\">15</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,377,887,646<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.394 GHz</span>\n</span></code></pre></div>\n<p>\u5206\u6570\u9ad8\u7684\u53ef\u4ee5\u51b2\u5230 5.7 GHz\uff0c\u5206\u6570\u4f4e\u4e00\u4e9b\u7684\u5c31\u53ea\u80fd\u5230 5.4 GHz \u4e86\u3002</p>\n<p>\u6ce8\uff1a\u6839\u636e David Huang \u63d0\u4f9b\u7684\u4fe1\u606f\uff0cAMD \u7684 Linux \u5185\u6838\u7ef4\u62a4\u8005\u5df2\u7ecf\u63d0\u4ea4 <a href=\"https://lore.kernel.org/lkml/20241203201129.31957-1-mario.limonciello@amd.com/\">Patch</a> \u6765\u4fee\u6539\u8fd9\u4e2a\u884c\u4e3a\uff0c\u4f7f\u5f97\u8fdb\u7a0b\u5c3d\u91cf\u8c03\u5ea6\u5230\u5206\u6570\u66f4\u9ad8\u7684\u6838\uff0c\u65e0\u8bba\u5b83\u5728\u54ea\u4e2a CCD\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5373\u4f7f\u4e0d\u7ed1\u6838\uff0c\u4e5f\u53ef\u4ee5\u4fdd\u8bc1\u5355\u6838\u8d1f\u8f7d\u4f1a\u7a33\u5b9a\u8dd1\u5728\u9891\u7387\u6700\u9ad8\u7684\u6838\u4e0a\u3002</p>\n<h3 id=\"qualcomm\">Qualcomm<a class=\"headerlink\" href=\"#qualcomm\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6700\u540e\u518d\u770b\u4e00\u4e0b Qualcomm X1E80100 \u5e73\u53f0\uff0c\u8fd9\u4e2a\u5e73\u53f0\u6709\u4e09\u4e2a Cluster\uff1a0-3\uff0c4-7 \u548c 8-11 \u662f\u4e09\u4e2a Cluster\u3002\u5176\u4e2d\u540e\u4e24\u4e2a Cluster \u7684\u6bcf\u4e2a Cluster \u53ef\u4ee5\u652f\u6301\u5176\u4e2d\u4e00\u4e2a\u6838\u5fc3\u4ece 3.4 GHz Boost \u5230 4.0 GHz\uff0c\u52a0\u8d77\u6765\u5c31\u662f\u6700\u591a\u4e24\u4e2a\u6838\u5fc3 Boost \u5230 4.0 GHz\u3002\u6253\u4e0a <a href=\"https://patchew.org/linux/20240612124056.39230-1-quic._5Fsibis@quicinc.com/\">cpufreq</a> \u7684\u8865\u4e01\u540e\uff0c\u5185\u6838\u901a\u8fc7 scmi \u63a5\u53e3\u5f97\u5230\u4e86\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/sys/devices/system/cpu/cpufreq/policy*/scaling_max_freq\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"m\">3417600</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"m\">4012800</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"m\">4012800</span>\n</span></code></pre></div>\n<p>\u4f46\u5b9e\u9645\u8c03\u5ea6\u8d77\u6765\uff0c\u5404\u4e2a\u6838\u5fc3\u4e71\u8dd1\uff0c\u800c 3.4 GHz \u8ddd\u79bb 4.0 GHz \u5dee\u8ddd\u4e0d\u5c0f\uff0c\u6027\u80fd\u5dee\u63a5\u8fd1 15%\uff0c\u53ef\u89c1\u76ee\u524d Linux \u5185\u6838\u5e76\u6ca1\u6709\u5f88\u597d\u5730\u9002\u914d\uff0c\u76ee\u524d\u8fd8\u662f\u9700\u8981\u624b\u52a8\u7ed1\u6838\u3002\u9ad8\u901a\u76ee\u524d\u8fd8\u63d0\u4ea4\u4e86 <a href=\"https://patchwork.kernel.org/project/linux-arm-msm/list/?series=867688&amp;state=*\">memlat govenor</a> \u8865\u4e01\u6765\u5bf9 LLC/DDR \u6765\u8fdb\u884c DVFS\uff0c\u4f46\u5bf9\u8fd9\u4e2a\u95ee\u9898\u5e94\u8be5\u6ca1\u6709\u6539\u8fdb\u3002</p>\n<h2 id=\"\u5206\u6790\">\u5206\u6790<a class=\"headerlink\" href=\"#\u5206\u6790\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u5c31\u8981\u8fdb\u5165\u5230 Linux \u6e90\u7801\uff0c\u627e\u5230 Linux \u662f\u5982\u4f55\u5904\u7406\u8fd9\u4e9b\u8c03\u5ea6\u4f18\u5148\u7ea7\u7684\uff0c\u8fd9\u4e9b\u4f18\u5148\u7ea7\u662f\u8c01\u786e\u5b9a\u7684\uff0c\u53c8\u662f\u600e\u4e48\u4f20\u9012\u5230 Linux \u5185\u6838\uff0c\u53c8\u662f\u600e\u4e48\u53c2\u4e0e\u5230\u8c03\u5ea6\u7684\u5462\uff1f</p>\n<h3 id=\"intel-itmt\">Intel ITMT<a class=\"headerlink\" href=\"#intel-itmt\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u6765\u770b\u4e00\u4e0b Intel \u7684\u8865\u4e01\uff1a<a href=\"https://lore.kernel.org/lkml/cover.1479844244.git.tim.c.chen@linux.intel.com/\">Support Intel Turbo Boost Max Technology 3.0</a>\uff0c\u8fd9\u4e2a patch \u505a\u4e86\u8fd9\u4e9b\u4e8b\u60c5\uff1a</p>\n<ol>\n<li><a href=\"https://lore.kernel.org/lkml/0998b98943bcdec7d1ddd4ff27358da555ea8e92.1479844244.git.tim.c.chen@linux.intel.com/\">PATCH v8 8/8</a>: \u8bfb\u53d6 ACPI \u7684 CPPC \u4fe1\u606f\uff0c\u5f97\u5230\u6bcf\u4e2a\u6838\u5fc3\u7684 highest_perf\uff0c\u6839\u636e highest_perf\uff0c\u8bbe\u7f6e\u903b\u8f91\u6838\u7684\u8c03\u5ea6\u4f18\u5148\u7ea7\uff1a<code>sched_set_itmt_core_prio(cppc_perf.highest_perf, cpu);</code></li>\n<li><a href=\"https://lore.kernel.org/lkml/0e73ae12737dfaafa46c07066cc7c5d3f1675e46.1479844244.git.tim.c.chen@linux.intel.com/\">PATCH v8 1/8</a>: \u4fee\u6539\u8c03\u5ea6\u5668\uff0c\u8ba9\u5b83\u5c0a\u91cd arch_asym_cpu_priority \u51fd\u6570\u8ba1\u7b97\u51fa\u6765\u7684\u4f18\u5148\u7ea7\uff0c\u800c\u4e0d\u662f\u6309\u7167\u6838\u5fc3\u7f16\u53f7\u4ece\u5c0f\u5230\u5927</li>\n<li><a href=\"https://lore.kernel.org/lkml/cd401ccdff88f88c8349314febdc25d51f7c48f7.1479844244.git.tim.c.chen@linux.intel.com/\">PATCH v8 3/8</a>: \u5b9e\u73b0 arch_asym_cpu_priority\uff0c\u5982\u679c\u4e00\u4e2a\u7269\u7406\u6838\u5bf9\u5e94 n \u4e2a\u903b\u8f91\u6838\uff0c\u90a3\u4e48\u7b2c\u4e00\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u4e58\u4ee5 n/1\uff0c\u7b2c\u4e8c\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u4e58\u4ee5 n/2\uff0c\u4f9d\u6b21\u7c7b\u63a8\u3002</li>\n</ol>\n<p>\u7b80\u800c\u8a00\u4e4b\uff0c\u4ece ACPI \u4e2d\u83b7\u53d6 CPPC \u4fe1\u606f\uff0c\u628a CPPC \u7684 Highest Perf \u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7269\u7406\u6838\u7684\u4f18\u5148\u7ea7\uff0c\u518d\u6839\u636e\u7269\u7406\u6838\u7684\u4f18\u5148\u7ea7\u8ba1\u7b97\u6bcf\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\uff0c\u5982\u679c\u662f 2-SMT\uff0c\u90a3\u5c31\u662f\u7b2c\u4e00\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u7ffb\u500d\uff0c\u7b2c\u4e8c\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u4e0d\u53d8\u3002\u4f46\u8fd9\u4e2a\u65b9\u6cd5\u6709\u5c40\u9650\u6027\uff0c\u5c31\u662f\u8981\u6c42 E \u6838\u7684\u4f18\u5148\u7ea7\u4ecb\u4e8e P \u6838\u7684\u4e24\u4e2a\u4f18\u5148\u7ea7\u4e4b\u95f4\uff0c\u8bbe\u7f6e\u8d77\u6765\u6bd4\u8f83\u522b\u626d\u3002\u540e\u6765\u9488\u5bf9 SMT \u7684\u5904\u7406\u88ab\u96c6\u6210\u5230\u4e86\u8c03\u5ea6\u5668\u5f53\u4e2d\uff0c\u56e0\u6b64\u4ece itmt \u7684\u89c6\u89d2\u6765\u770b\uff0c\u4e0d\u9700\u8981\u9488\u5bf9 SMT \u8fdb\u884c\u7279\u6b8a\u5904\u7406\uff0cSMT \u7684\u6838\u8bbe\u7f6e\u4e3a\u540c\u4e00\u4e2a\u4f18\u5148\u7ea7\u5373\u53ef\uff1a<a href=\"https://github.com/torvalds/linux/commit/046a5a95c3b0425cfe79e43021d8ee90c1c4f8c9\">x86/sched/itmt: Give all SMT siblings of a core the same priority</a>\u3002</p>\n<p>\u5728 Intel i9-14900K \u5e73\u53f0\u4e0a\uff0c\u65e0\u8bba\u5927\u5c0f\u6838\uff0cHighest Perf \u90fd\u7b49\u4e8e 255\uff0c\u6b64\u65f6\u65e0\u6cd5\u901a\u8fc7 Highest Perf \u6765\u533a\u5206\u6838\u5fc3\u7684\u4f53\u8d28\uff0c\u6b64\u65f6\u4f1a\u89e6\u53d1\u4e0b\u9762\u7684<a href=\"https://github.com/torvalds/linux/blob/c2ee9f594da826bea183ed14f2cc029c719bf4da/drivers/cpufreq/intel_pstate.c#L363-L371\">\u4ee3\u7801</a>\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"cm\">/*</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"cm\"> * If CPPC is not available, fall back to MSR_HWP_CAPABILITIES bits [8:0].</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"cm\"> *</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"cm\"> * Also, on some systems with overclocking enabled, CPPC.highest_perf is</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"cm\"> * hardcoded to 0xff, so CPPC.highest_perf cannot be used to enable ITMT.</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"cm\"> * Fall back to MSR_HWP_CAPABILITIES then too.</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"cm\"> */</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">cppc_perf</span><span class=\"p\">.</span><span class=\"n\">highest_perf</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">CPPC_MAX_PERF</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"n\">cppc_perf</span><span class=\"p\">.</span><span class=\"n\">highest_perf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">HWP_HIGHEST_PERF</span><span class=\"p\">(</span><span class=\"n\">READ_ONCE</span><span class=\"p\">(</span><span class=\"n\">all_cpu_data</span><span class=\"p\">[</span><span class=\"n\">cpu</span><span class=\"p\">]</span><span class=\"o\">-&gt;</span><span class=\"n\">hwp_cap_cached</span><span class=\"p\">));</span>\n</span></code></pre></div>\n<p>\u67e5\u770b\u5404\u4e2a\u6838\u5fc3\u4e0a MSR_HWP_CAPABILITIES MSR \u8bb0\u5f55\u7684 Highest Perf \u503c\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"k\">for</span><span class=\"w\"> </span>i<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">$(</span>seq<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">31</span><span class=\"k\">)</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span>sudo<span class=\"w\"> </span>turbostat<span class=\"w\"> </span>-c<span class=\"w\"> </span><span class=\"nv\">$i</span><span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>--interval<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>MSR_HWP_CAPABILITIES<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">done</span>\n</span></code></pre></div>\n<p>\u53d1\u73b0\u540e\u4e24\u4e2a P \u6838\u7684 highest perf \u662f 77\uff0c\u5176\u4ed6 P \u6838\u7684 highest perf \u662f 73\uff0cE \u6838\u7684 highest perf \u662f 44\u3002\u56e0\u6b64 Linux \u7684\u8c03\u5ea6\u7b56\u7565\u5c31\u51fa\u6765\u4e86\uff1a\u5148\u662f\u540e\u4e24\u4e2a P \u6838\uff0c\u518d\u662f\u5176\u4ed6 P \u6838\uff0c\u7136\u540e\u662f E \u6838\uff0c\u6700\u540e\u662f SMT \u51fa\u6765\u7684\u903b\u8f91\u6838\u3002</p>\n<h3 id=\"acpi-cppc\">ACPI CPPC<a class=\"headerlink\" href=\"#acpi-cppc\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u67e5\u770b ACPI \u7684 CPPC \u4fe1\u606f\u4fdd\u5b58\u4e86\u4ec0\u4e48\u3002<a href=\"https://uefi.org/specs/ACPI/6.5/08_Processor_Configuration_and_Control.html?highlight=cppc#collaborative-processor-performance-control\">CPPC</a> \u5168\u79f0\u662f Collaborative Processor Performance Control\uff0c\u662f\u5bf9\u5df2\u6709\u7684 P State \u7684\u6539\u8fdb\uff0c\u539f\u6765\u7684 P State \u662f\u5206\u7acb\u7684\u51e0\u4e2a\u914d\u7f6e\uff0c\u53ef\u9009\u9879\u6bd4\u8f83\u5c11\uff0cCPPC \u5bf9\u6027\u80fd\u505a\u4e86\u62bd\u8c61\uff0c\u6bcf\u4e2a\u6838\u5fc3\u53ef\u4ee5\u6709 Highest Performance\uff0cNominal Performance\uff0cLowest Nonlinear Performance \u548c Lowest Performance \u8fd9\u51e0\u4e2a\u503c\uff0c\u6027\u80fd\u53ef\u4ee5\u5728\u8fd9\u4e9b\u503c\u4e4b\u95f4\u6d6e\u52a8\u3002\u7b80\u5355\u6765\u8bf4\uff0cHighest \u5bf9\u5e94\u5355\u6838 Boost \u5230\u7684\u6700\u9ad8\u6027\u80fd\uff0cNominal \u5bf9\u5e94\u5168\u6838\u80fd\u8fbe\u5230\u7684\u6027\u80fd\uff0cLowest \u5bf9\u5e94\u6700\u4f4e\u9891\u4e0b\u7684\u6027\u80fd\uff0cLowest Nonlinear \u4ee3\u8868\u6027\u80fd\u529f\u8017\u6bd4\u7ebf\u6027\u7684\u754c\u9650\uff0c\u5f80\u4e0b\u6027\u80fd\u6838\u529f\u8017\u662f\u7ebf\u6027\u7684\uff0c\u5f80\u4e0a\u6027\u80fd\u529f\u8017\u6bd4\u4f1a\u4e0b\u964d\u3002OS \u53ef\u4ee5\u8bbe\u5b9a\u60f3\u8981\u7684\u6027\u80fd\u8303\u56f4\uff1aMinimum \u548c Maximum Perf\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u60f3\u8981\u7684\u6027\u80fd Desired Performance\u3002\u5f53\u7136\u4e86\uff0c\u786c\u4ef6\u4e5f\u4e0d\u4e00\u5b9a\u80fd\u591f\u8fbe\u5230 Highest Perf\uff0c\u5f53\u524d\u80fd\u4fdd\u8bc1\u8fbe\u5230\u7684\u6700\u9ad8\u6027\u80fd\u53eb\u505a Guaranteed Perf\u3002\u6b64\u5916\u8fd8\u6709 Energy Performance Preference (EPP)\uff0cOS \u544a\u8bc9\u786c\u4ef6\uff0c\u6211\u60f3\u8981\u80fd\u6548\u8fd8\u662f\u6027\u80fd\uff0c\u6700\u5c0f\u7684 0 \u8868\u793a\u6027\u80fd\uff0c\u6700\u5927\u7684 255 \u8868\u793a\u80fd\u6548\u3002</p>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u786c\u4ef6\u544a\u8bc9 OS \u4e94\u4e2a\u503c\uff1aHighest Perf\uff0cNominal Perf\uff0cLowest Nonlinear Perf\uff0cLowest Perf \u548c Guaranteed Perf\uff0cOS \u901a\u8fc7\u4e09\u4e2a\u503c\u544a\u8bc9\u786c\u4ef6\uff0c\u6211\u60f3\u8981\u4ec0\u4e48\u6837\u7684\u6027\u80fd\uff1aMin Perf\uff0cMax Perf\uff0cDesired Perf\uff0c\u4ee5\u53ca\u6027\u80fd\u548c\u529f\u8017\u54ea\u4e2a\u66f4\u770b\u91cd\uff1aEPP\u3002</p>\n<h3 id=\"amd-cppc\">AMD CPPC<a class=\"headerlink\" href=\"#amd-cppc\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 AMD \u5e73\u53f0\u4e0a\uff0cCPPC \u7684\u8fd9\u4e9b\u6027\u80fd\u503c\u65e2\u53ef\u4ee5\u901a\u8fc7 ACPI \u83b7\u53d6\uff0c\u53c8\u53ef\u4ee5\u901a\u8fc7 MSR \u6765\u8bfb\u5199\uff08\u6765\u6e90\uff1a<a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/57254-PUB_3.00.zip\">Processor Programming Reference (PPR) for AMD Family 1Ah Model 24h, Revision B0 Processors</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-core-scheduling-cppc-1.png\" /></p>\n<p><img alt=\"\" src=\"../../../../linux-core-scheduling-cppc-2.png\" /></p>\n<p>\u5728\u66f4\u65e9\u7684 AMD \u5904\u7406\u5668\u4e2d\uff0c\u6ca1\u6709\u8fd9\u4e9b MSR\uff0c\u800c\u662f\u901a\u8fc7 MMIO \u6765\u63a7\u5236\uff0c\u8fd9\u4e9b\u4fe1\u606f\u8bb0\u5f55\u5728 ACPI CPPC \u5f53\u4e2d\u3002</p>\n<p>\u901a\u8fc7\u6bd4\u5bf9 <code>/sys/devices/system/cpu/cpu*/acpi_cppc/highest_perf</code> \u548c <code>/sys/devices/system/cpu/cpu*/cpufreq/amd_pstate_prefcore_ranking</code>\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u5b83\u4eec\u662f\u4e00\u6837\u7684\uff0c\u8bf4\u660e amd-pstate \u9a71\u52a8\u505a\u7684\u4e8b\u60c5\u548c itmt \u7c7b\u4f3c\uff0c\u6839\u636e ACPI \u7684 Highest Perf \u4fe1\u606f\uff08\u6216\u8005\u4ece MSR 0xC001_02B0 \u8bfb\u51fa Highest Perf\uff09\uff0c\u8bbe\u7f6e Preferred Core Ranking \u4ee5\u53ca\u8c03\u5ea6\u5668\u7684\u4f18\u5148\u7ea7\u3002\u9605\u8bfb\u4ee3\u7801\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u786e\u5b9e\u662f\u8fd9\u4e48\u505a\u7684\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u5316\u4e2d\uff0c\u8bbe\u7f6e\u4f18\u5148\u7ea7\u4e3a <code>highest_perf</code>\uff1a<a href=\"https://github.com/torvalds/linux/blob/c2ee9f594da826bea183ed14f2cc029c719bf4da/drivers/cpufreq/amd-pstate.c#L796\"><code>sched_set_itmt_core_prio((int)READ_ONCE(cpudata-&gt;highest_perf), cpudata-&gt;cpu);</code></a></li>\n<li>\u8bbe\u7f6e <code>prefcore_ranking</code> \u4e3a <code>highest_perf</code>: <a href=\"https://github.com/torvalds/linux/blob/c2ee9f594da826bea183ed14f2cc029c719bf4da/drivers/cpufreq/amd-pstate.c#L402\"><code>WRITE_ONCE(cpudata-&gt;prefcore_ranking, cppc_perf.highest_perf)</code></a></li>\n<li>\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u53d1\u73b0 <code>highest_perf</code> \u51fa\u73b0\u53d8\u5316\uff0c\u4e5f\u66f4\u65b0\u5230\u8c03\u5ea6\u5668\u7684\u4f18\u5148\u7ea7\u5f53\u4e2d\uff1a<a href=\"https://github.com/torvalds/linux/blob/master/drivers/cpufreq/amd-pstate.c#L822\"><code>sched_set_itmt_core_prio((int)cur_high, cpu);</code></a></li>\n</ol>\n<p>\u5269\u4e0b\u7684\u5c31\u548c Intel \u4e00\u6837\u4e86\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u8c03\u5ea6\u5668\u8f6e\u6d41\u4ece\u4e24\u4e2a CCD \u53d6\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u6838\u5fc3\u8c03\u5ea6\uff0c\u5e94\u8be5\u662f\u8c03\u5ea6\u5668\u8003\u8651\u4e86\u8fd9\u4e9b\u6838\u5fc3\u7684\u62d3\u6251\uff0c\u8fdb\u884c\u4e86\u8d1f\u8f7d\u5747\u8861\uff0c\u5c3d\u91cf\u4fdd\u8bc1\u6bcf\u4e2a CCD \u4e0a\u7684\u8d1f\u8f7d\u76f8\u5f53\u3002\u8fd9\u6837\u7684\u8bbe\u8ba1\u5728 9950X \u8fd9\u79cd\u5bf9\u79f0\u7684\u67b6\u6784\u4e0a\u6ca1\u5565\u95ee\u9898\uff0c\u4f46\u5982\u679c\u662f Strix Point \u8fd9\u79cd\u6df7\u5408 Zen5 \u548c Zen5c \u7684\u60c5\u51b5\uff0c\u5982\u679c\u8fd8\u50cf\u8fd9\u6837\uff0c\u5c31\u4f1a\u5728 Zen5 \u548c Zen5c \u4e4b\u95f4\u6765\u56de\u8c03\u5ea6\uff0c\u8fd9\u6837\u5c31\u4e0d\u592a\u5408\u9002\u4e86\uff1a\u5e94\u8be5\u5148\u8c03\u5ea6 Zen5\uff0c\u518d\u8c03\u5ea6 Zen5c\u3002\u5b8c\u6574\u7684\u8ba8\u8bba\u89c1 <a href=\"https://blog.hjc.im/thoughts-on-linux-preferred-cores-and-multi-ccx.html\">\u8c08\u8c08 Linux \u4e0e ITMT \u8c03\u5ea6\u5668\u4e0e\u591a\u7c07\u5904\u7406\u5668</a>\u3002\u6700\u8fd1 Linux \u4e5f\u4e0a\u6e38\u5316\u4e86\u76f8\u5173\u7684 Patch\uff0c\u4f7f\u5f97 P \u6838\u4f18\u5148\u88ab\u8c03\u5ea6\uff1a<a href=\"https://www.phoronix.com/news/AMD-Hetero-Topo-Linux-6.13\">AMD Heterogeneous CPU Design Topology Patches Coming For Linux 6.13</a>\u3002</p>\n<p>\u800c\u6211\u4eec\u77e5\u9053 Linux \u7684 cpufreq \u8bbe\u7f6e\u4e86\u4e0d\u540c\u7684 governor\uff0c\u4f8b\u5982 performance \u548c powersave\u3002\u90a3\u4e48\u5b83\u4eec\u662f\u600e\u4e48\u6620\u5c04\u5230 Min/Max/Desired Perf \u7684\u5462\uff1f\u901a\u8fc7\u9605\u8bfb\u4ee3\u7801\uff0c\u53ef\u4ee5\u53d1\u73b0\uff1a</p>\n<ol>\n<li>powersave \u5bf9\u5e94\u7684\u914d\u7f6e\u662f\uff1aMin Perf \u8bbe\u7f6e\u4e3a Lowest/Lowest Nonlinear Perf\uff0cMax Perf \u8bbe\u7f6e\u4e3a Highest/Nominal Perf</li>\n<li>performance \u5bf9\u5e94\u7684\u914d\u7f6e\u662f\uff1aMin Perf \u548c Max Perf \u90fd\u8bbe\u7f6e\u4e3a Highest/Nominal Perf</li>\n</ol>\n<p>\u5982\u679c\u542f\u7528 boost\uff08<code>echo 1 &gt; /sys/devices/system/cpu/cpufreq/policy0/boost</code>\uff09\uff0c\u90a3\u5c31\u628a Max Perf \u8bbe\u7f6e\u5230 Highest Perf\uff1b\u5982\u679c\u4e0d\u542f\u7528 Boost\uff0c\u5c31\u8bbe\u7f6e\u5230 Nominal Perf\u3002</p>\n<p>\u4e0b\u9762\u7ed9\u51fa\u51e0\u4e2a\u4f8b\u5b50\uff0c\u5176\u4e2d Highest Perf \u4e3a 166\uff0cNominal Perf \u4e3a 124\uff0cLowest Perf \u4e3a 18\uff1a</p>\n<ol>\n<li>performance + boost=1: Min = 166, Max = 166</li>\n<li>performance + boost=0: Min = 124, Max = 124</li>\n<li>powersave + boost=1: Min = 18, Max = 166</li>\n<li>powersave + boost=0: Min = 18, Max = 124</li>\n</ol>\n<p>\u800c\u5176\u4ed6\u7531 Linux \u5b9e\u73b0\u53d8\u9891\u7684 governor\uff1aschedutil \u548c ondemand\uff0c\u4f1a\u901a\u8fc7 Desired Perf \u6765\u5b9e\u73b0\u3002</p>\n<p>amd-pstate \u652f\u6301\u4e09\u4e2a<a href=\"https://www.phoronix.com/news/AMD-P-State-Guided-Auto\">\u8fd0\u884c\u6a21\u5f0f</a>\uff1a</p>\n<ol>\n<li>active(\u9ed8\u8ba4): \u8f6f\u4ef6\u5c31\u8bbe\u7f6e\u4e00\u4e0b\u8981\u6027\u80fd\u8fd8\u662f\u80fd\u8017\uff08\u901a\u8fc7 performance/powersave governor \u548c EPP <code>/sys/devices/system/cpu/cpufreq/policy0/energy_performance_preference</code>\uff09\uff0c\u5176\u4ed6\u7684\u90fd\u4ea4\u7ed9\u786c\u4ef6\u81ea\u52a8\u8c03\u6574</li>\n<li>guided\uff1a\u8f6f\u4ef6\u8bbe\u7f6e\u4e00\u4e2a\u6700\u4f4e\u548c\u6700\u9ad8\u7684\u6027\u80fd\uff0c\u5176\u4ed6\u90fd\u4ea4\u7ed9\u786c\u4ef6</li>\n<li>passive\uff1a\u8f6f\u4ef6\u6765\u8d1f\u8d23\u8c03\u9891\uff0c\u7ed3\u679c\u901a\u8fc7 Desired Perf \u544a\u8bc9\u786c\u4ef6</li>\n</ol>\n<p>\u8fd9\u91cc\u8bf4\u7684 active \u548c passive \u662f\u4ece\u786c\u4ef6\u7684\u89d2\u5ea6\u51fa\u53d1\u7684\uff0c\u800c\u4e0d\u662f OS\u3002</p>\n<p>\u6ce8\uff1a\u867d\u7136\u8fd9\u91cc\u8bf4\u662f\u786c\u4ef6\u8c03\u6574\uff0c\u5b9e\u9645\u4e0a\u5927\u6982\u7387\u662f\u7531\u5728\u4e00\u4e2a\u7247\u4e0a\u7684\u5c0f CPU \u8fd0\u884c\u7684\u56fa\u4ef6\uff08PMFW\uff0cPower Management Firmware\uff09\u8d1f\u8d23\u8c03\u6574\u3002</p>\n<h3 id=\"qualcomm_1\">Qualcomm<a class=\"headerlink\" href=\"#qualcomm_1\" title=\"Permanent link\">&para;</a></h3>\n<p>arm64 \u67b6\u6784\u6ca1\u6709\u5b9e\u73b0 arch_asym_cpu_priority \u51fd\u6570\uff0c\u56e0\u6b64\u7528\u7684\u4e0d\u662f\u4e0a\u8ff0 Intel/AMD \u7684\u673a\u5236\uff0c\u800c\u662f\u5728 Device Tree \u4e2d\u7528 <a href=\"https://www.kernel.org/doc/Documentation/devicetree/bindings/arm/cpu-capacity.txt\">capacity-dmips-mhz</a> \u6807\u8bb0\u6bcf\u4e2a\u6838\u5fc3\u7684\u6027\u80fd\uff0c\u4f46\u662f X Elite \u7684 DTS \u6ca1\u6709\u8bb0\u5f55\u8fd9\u4e2a\u4fe1\u606f\uff0c\u56e0\u6b64 Linux \u5185\u6838\u4e5f\u5c31\u65e0\u6cd5\u5408\u7406\u5730\u8c03\u5ea6\u4e86\u3002\u56e0\u6b64\u4e00\u4e2a\u53ef\u80fd\u7684\u89e3\u51b3\u529e\u6cd5\u662f\uff0c\u7ed9\u540e\u4e24\u4e2a Cluster \u7684\u4e00\u4e2a\u6838\u8bbe\u7f6e\u66f4\u9ad8\u7684 capacity-dmips-mhz\uff0c\u5176\u4ed6\u7684\u6838\u5fc3\u90fd\u8bbe\u7f6e\u6210\u4e00\u6837\u3002\u4f46\u5176\u5b9e\u901a\u5e38\u6765\u8bf4\uff0c\u5bf9\u4e8e\u540c\u4e00\u4e2a\u6838\u6765\u8bf4\uff0c\u63d0\u9ad8\u9891\u7387\u4ee5\u540e\uff0cDMIPS/MHz \u53cd\u800c\u662f\u4e0b\u964d\u7684\uff0c\u5185\u6838\u7528 DMIPS/MHz \u8fd9\u4e2a\u6307\u6807\uff0c\u4e3b\u8981\u662f\u7528\u6765\u533a\u5206\u5927\u5c0f\u6838\uff0c\u800c\u4e0d\u662f\u7528\u6765\u5224\u65ad\u6709\u6ca1\u6709 Boost\u3002</p>\n<p>\u5b9e\u9645\u5c1d\u8bd5\u4e86\u4e00\u4e0b\uff0c\u7ed9 4 \u548c 8 \u8fd9\u4e24\u4e2a\u6838\u6807\u8bb0\u66f4\u9ad8\u7684 capacity-dmips-mhz\uff0c\u73b0\u5728\u8dd1\u5355\u6838\u6216\u53cc\u6838\u8d1f\u8f7d\u53ef\u4ee5\u81ea\u52a8\u8dd1\u5230 4.0 GHz \u4e0a\u4e86\u3002\u8868\u73b0\u5728 Geekbench 6 \u4e0a\uff0c\u5c31\u662f\u5355\u6838\u6027\u80fd 2452 \u5206\u5230 2892 \u5206\u7684\u533a\u522b\u3002\u4fee\u6539\u7684\u5185\u5bb9\u5df2\u7ecf\u63d0\u4ea4\uff1a<a href=\"https://lore.kernel.org/lkml/20241025031257.6284-2-c@jia.je/\">[PATCH] arm64: dts: qcom: x1e80100: Add performance hint for boost clock</a>\uff0c\u4e0d\u8fc7\u5408\u5e76\u7684\u6982\u7387\u4e0d\u5927\uff0c\u6bd5\u7adf\u4e0d\u662f\u4ec0\u4e48\u4f18\u96c5\u7684\u89e3\u51b3\u529e\u6cd5\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9488\u5bf9\u4e0d\u540c\u6838\u5fc3\u7684\u4e0d\u540c\u6027\u80fd\u4ee5\u53ca SMT\uff0cLinux \u7684\u8c03\u5ea6\u5668\u9700\u8981\u77e5\u9053\u5404\u4e2a\u903b\u8f91\u6838\u5fc3\u7684\u8c03\u5ea6\u4f18\u5148\u7ea7\u3002\u5728 Intel/AMD \u5e73\u53f0\u4e0a\uff0c\u8fd9\u4e2a\u4fe1\u606f\u76ee\u524d\u4e3b\u8981\u662f\u901a\u8fc7 CPPC \u7684 Highest Perf \u6765\u83b7\u53d6\uff0c\u4e5f\u53ef\u80fd Fallback \u5230 MSR_HWP_CAPABILITIES \u4e0a\u3002\u5728 ARM64 \u5e73\u53f0\u4e0a\uff0c\u5219\u9700\u8981 DTS \u6807\u8bb0\u5404\u6838\u5fc3\u7684\u6027\u80fd\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://blog.hjc.im/thoughts-on-linux-preferred-cores-and-multi-ccx.html\">\u8c08\u8c08 Linux \u4e0e ITMT \u8c03\u5ea6\u5668\u4e0e\u591a\u7c07\u5904\u7406\u5668</a></li>\n<li><a href=\"https://zhiwei-lii.github.io/intel-cpu%E4%B8%8A%E9%9D%A2%E7%9A%84linux%E5%A4%A7%E5%B0%8F%E6%A0%B8%E8%B0%83%E5%BA%A6%E9%97%AE%E9%A2%98/\">Intel CPU \u4e0a\u9762\u7684 Linux \u5927\u5c0f\u6838\u8c03\u5ea6\u95ee\u9898</a></li>\n</ul>", "image": null, "date_published": "2024-10-23T00:00:00+00:00", "authors": [], "tags": ["cpu", "intel", "linux", "qualcomm", "scheduler", "software"]}, {"id": "https://jia.je/hardware/2024/09/21/ibm-z15-branch-predictor/", "url": "https://jia.je/hardware/2024/09/21/ibm-z15-branch-predictor/", "title": "IBM z15 Mainframe CPU \u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0", "content_html": "<h1 id=\"ibm-z15-mainframe-cpu-\u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0\">IBM z15 Mainframe CPU \u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0<a class=\"headerlink\" href=\"#ibm-z15-mainframe-cpu-\u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ISCA 2020 \u7684\u4e00\u7bc7\u6587\u7ae0 <a href=\"https://ieeexplore.ieee.org/document/9138999\">The IBM z15 High Frequency Mainframe Branch Predictor Industrial Product</a> \u975e\u5e38\u8be6\u7ec6\u5730\u89e3\u6790\u4e86 IBM z15 Mainframe CPU \u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u3002\u672c\u6587\u662f\u5bf9\u8fd9\u7bc7\u8bba\u6587\u7684\u5b66\u4e60\u548c\u6574\u7406\u7684\u7b14\u8bb0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u8bbe\u8ba1\u601d\u8def\">\u8bbe\u8ba1\u601d\u8def<a class=\"headerlink\" href=\"#\u8bbe\u8ba1\u601d\u8def\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8bba\u6587\u7684\u7b2c\u4e8c\u8282 Branch Prediction Design Considerations \u63d0\u5230\u4e86\u5b83\u8bbe\u8ba1\u5206\u652f\u9884\u6d4b\u5668\u65f6\u9700\u8981\u8003\u8651\u7684\u4e8b\u60c5\u3002z15 \u5904\u7406\u5668\u9762\u5411\u7684\u662f\u5177\u6709\u5f88\u5927\u6307\u4ee4 footprint \u7684\u7a0b\u5e8f\uff0c\u4e3a\u6b64\u51c6\u5907\u4e86 128KB \u7684 L1 ICache\uff0c\u4ee5\u53ca 4MB \u7684 L2 Private ICache\u3002\u4e3a\u4e86\u652f\u6491 MB \u7ea7\u522b\u7684\u6307\u4ee4\uff0cBTB \u4e5f\u8981\u76f8\u5e94\u589e\u5927\u3002</p>\n<p>IBM z \u7cfb\u5217\u7528\u7684\u662f\u53d8\u957f\u6307\u4ee4\u96c6\uff0c\u6307\u4ee4\u957f\u5ea6\u53ef\u80fd\u662f 2 \u6216 4 \u6216 6 \u5b57\u8282\uff0c\u5e73\u5747\u957f\u5ea6\u662f 5 \u5b57\u8282\u3002\u8003\u8651\u5230\u6bcf 5 \u6761\u6307\u4ee4\u6709\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u5c31\u662f\u6bcf 25 \u4e2a\u5b57\u8282\u6709\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48 4MB \u7684 L2 ICache \u5e73\u5747\u4e0b\u6765\u53ef\u80fd\u6709 164K \u6761\u5206\u652f\u3002\u56e0\u6b64\uff0cz15 \u8bbe\u8ba1\u4e86\u53ef\u4ee5\u4fdd\u5b58 128K \u6761\u5206\u652f\u7684 L2 BTB\u3002z15 \u7684\u6d41\u6c34\u7ebf\u5f88\u957f\uff0c\u5206\u652f\u9884\u6d4b\u9519\u8bef\u4f1a\u5e26\u6765 26 \u4e2a\u5468\u671f\u7684\u5f00\u9500\uff0c\u56e0\u6b64\u5206\u652f\u9884\u6d4b\u7684\u6b63\u786e\u7387\u5c31\u5f88\u91cd\u8981\u3002z15 \u5904\u7406\u5668\u8bbe\u8ba1\u4e86\u4e24\u7ea7\u7684 BTB\uff0cL1 BTB\uff08\u8bba\u6587\u4e2d\u79f0 BTB1\uff09\u5bb9\u91cf\u662f 16K=2K x 8 way\uff0cL2 BTB\uff08\u8bba\u6587\u4e2d\u79f0 BTB2\uff09\u5bb9\u91cf\u662f 128K=32K x 4-way\u3002\u4e3a\u4e86\u52a0\u901f L1 BTB \u7684\u9884\u6d4b\uff0cz15 \u6709 Column Predictor\uff08CPRED\uff0c1K x 8\uff09\u3002\u4e3a\u4e86\u9884\u6d4b\u5206\u652f\u7684\u65b9\u5411\uff0cz15 \u8fd8\u5f15\u5165\u4e86 PHT\uff08short \u548c long \u4e24\u4e2a PHT\uff0c\u90fd\u662f 512 x 8\uff09\uff0cPerceptron\uff0816 x 2\uff09\u3002\u4e3a\u4e86\u9884\u6d4b\u95f4\u63a5\u5206\u652f\u548c\u8fd4\u56de\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\uff0cz15 \u8bbe\u8ba1\u4e86 Changing Target Buffer\uff08CTB\uff0c2K x 1\uff09\u548c Call/Return Stack\uff08CRS\uff09\u3002</p>\n<h2 id=\"\u5177\u4f53\u5b9e\u73b0\">\u5177\u4f53\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u5177\u4f53\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>z15 \u91c7\u7528\u7684\u662f\u5206\u79bb\u5f0f\u524d\u7aef\uff0c\u5206\u652f\u9884\u6d4b\u5668\u6709 6 \u7ea7\u7684\u6d41\u6c34\u7ebf\uff0c\u6bcf\u4e00\u7ea7\u5206\u522b\u8bb0\u4e3a b0-b5\u3002\u5404\u7ea7\u7684\u529f\u80fd\u5982\u4e0b\uff1a</p>\n<blockquote>\n<p>Indexing into the BTB arrays occurs in\nthe b0 cycle, which when superimposed over the z15 core\npipeline in figure 1 coincides with the very stage after a\nrestart, but deviates away from the core pipeline after that.\nAn array access cycle is in b1. Metadata from the arrays is\nobtained in b2, and hit detection and direction application\non a per branch basis performed across the b2 and b3\ncycles. Ordering of the branches based on their low-order\ninstruction address bits is also done in b3. In b4, the final\nprediction is prepared, including selection of the\nappropriate target address provider. The prediction is\npresented to the consumers, namely the IDU and ICM, in\nthe b5 cycle.</p>\n</blockquote>\n<p>\u5982\u679c\u7b49\u5230 b5 \u624d\u51fa\u9884\u6d4b\u7ed3\u679c\u5c31\u6bd4\u8f83\u6162\u4e86\uff0c\u56e0\u6b64\u5b83\u8fd8\u53ef\u4ee5\u5728 b2 \u5468\u671f\u51fa\u7ed3\u679c\uff0c\u5229\u7528\u7684\u662f CPRED \u9884\u6d4b\u5668\u3002\u5728 CPRED \u5de5\u4f5c\u7684\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e24\u4e2a\u5468\u671f\u53ef\u4ee5\u9884\u6d4b\u4e00\u4e2a taken branch\uff0c\u5982\u679c CPRED \u6ca1\u6709\u9884\u6d4b\uff0c\u90a3\u5c31\u9700\u8981\u6bcf 5 \u4e2a\u5468\u671f\u9884\u6d4b\u4e00\u4e2a taken branch\uff0c\u800c\u5728 SMT2 \u6a21\u5f0f\u4e0b\uff0c\u4e24\u4e2a\u7ebf\u7a0b\u8f6e\u6d41\u8bbf\u95ee BTB\uff0c\u6b64\u65f6\u6bcf\u4e2a\u7ebf\u7a0b\u9700\u8981\u6bcf 6 \u4e2a\u5468\u671f\u9884\u6d4b\u4e00\u4e2a taken branch\u3002</p>\n<p>z15 \u7684 L1 BTB \u7684 8-way \u610f\u5473\u7740\u5728\u4e00\u4e2a\u5468\u671f\u53ef\u4ee5\u8fdb\u884c 8 \u6761\u5206\u652f\u7684\u9884\u6d4b\uff0c\u4ece 64B \u7684\u6307\u4ee4\u4e2d\uff0c\u8bc6\u522b\u6700\u591a 8 \u6761\u6307\u4ee4\uff0c\u4ece\u4e2d\u627e\u5230\u7b2c\u4e00\u6761\u8df3\u8f6c\u7684\u5206\u652f\u3002\u4e3a\u4e86\u4f18\u5316\u6027\u80fd\u548c\u529f\u8017\uff0c\u5728\u9762\u5bf9\u8fde\u7eed\u7684\u65e0\u5206\u652f\u6307\u4ee4\u7684\u4ee3\u7801\u65f6\uff0c\u53ef\u4ee5\u5feb\u901f\u8df3\u8fc7\uff0c\u8fd9\u91cc\u7528\u7684\u662f SKOOT\uff08Skip Over OffseT\uff09\u9884\u6d4b\u5668\uff0c\u5728 BTB \u7684\u5206\u652f\u8bb0\u5f55\u4e86\u5230\u4e0b\u4e00\u6b21\u5206\u652f\u7684\u8ddd\u79bb\uff0c\u5982\u679c\u8fd9\u4e2a\u8ddd\u79bb\u5f88\u957f\uff0c\u90a3\u5c31\u53ef\u4ee5\u5feb\u901f\u8df3\u8fc7\u82e5\u5e72\u4e2a 64B \u6307\u4ee4\u5757\u3002</p>\n<p>\u4e3a\u4e86\u9884\u6d4b\u5206\u652f\u7684\u65b9\u5411\uff0c\u5728 L1 BTB \u91cc\uff0c\u4e5f\u4fdd\u5b58\u4e86 2 bit saturating counter\uff0c\u4e5f\u5c31\u662f BTB \u4e5f\u5145\u5f53\u4e86\u901a\u5e38\u8bf4\u7684 BHT\u3002\u9664\u4e86 BHT \u4ee5\u5916\uff0c\u4e3a\u4e86\u9884\u6d4b\u5206\u652f\u65b9\u5411\uff0cz15 \u8bb0\u5f55\u4e86 Global Path Vector\uff0c\u4e5f\u5c31\u662f\u5e38\u8bf4\u7684 PHR\uff0c\u8bb0\u5f55\u6700\u8fd1\u7684 n \u6761 taken branch \u7684\u5386\u53f2\u3002z14 \u4e4b\u524d\uff0cGPV \u8bb0\u5f55\u4e86\u6700\u8fd1 9 \u6761 taken branch \u7684\u5386\u53f2\uff0cz14 \u548c z15\uff0cGPV \u8bb0\u5f55\u4e86\u6700\u8fd1 17 \u6761 taken branch \u7684\u5386\u53f2\u3002GPV \u4e2d\u6bcf\u4e2a taken branch \u63d0\u4f9b 2 bit \u7684\u4fe1\u606f\u3002</p>\n<p>GPV \u548c PC \u4f5c\u4e3a TAGE \u7684\u8f93\u5165\uff0c\u8fdb\u884c\u65b9\u5411\u9884\u6d4b\u3002z15 \u91c7\u7528\u4e86\u4e24\u4e2a TAGE PHT\uff0c\u90fd\u662f 512 x 8 way\uff0c\u4e00\u5171\u662f 8K \u5206\u652f\u7684\u5bb9\u91cf\uff0c\u5386\u53f2\u77ed\u7684 TAGE PHT \u53ea\u7528\u6700\u8fd1 9 \u6761 taken branch \u7684\u5386\u53f2\uff0c\u5386\u53f2\u957f\u7684 TAGE PHT \u5219\u4f1a\u7528\u5b8c\u6574\u7684 17 \u6761 taken branch \u7684\u5386\u53f2\u3002\u8bba\u6587\u91cc\u6bd4\u8f83\u8be6\u7ec6\u5730\u63cf\u8ff0\u4e86 TAGE \u7684\u5b9e\u73b0\uff0c\u57fa\u672c\u548c A. Seznec \u7684\u8bbe\u8ba1\u662f\u4e00\u6837\u7684\uff0c\u4e5f\u505a\u4e86 USE_ALT_ON_NA \u7684\u6539\u8fdb\u3002\u9664\u4e86 TAGE \u4ee5\u5916\uff0cz15 \u8fd8\u6709 Perceptron \u9884\u6d4b\u5668\uff0c\u6709 32 \u4e2a entry\uff0c16 x 2 way\uff0c\u628a\u7cfb\u6570\u548c GPV \u8fdb\u884c\u70b9\u79ef\uff08GPV \u7684\u6bcf\u4e2a bit \u6620\u5c04\u4e3a 1 \u548c -1\uff09\uff0c\u6839\u636e\u7ed3\u679c\u7684\u7b26\u53f7\u51b3\u5b9a\u8df3\u8f6c\u7684\u65b9\u5411\u3002</p>\n<p>\u56e0\u6b64\u4e00\u5171\u6709 BHT\u3001TAGE \u548c Perceptron \u53ef\u4ee5\u63d0\u4f9b\u65b9\u5411\u9884\u6d4b\u3002\u4e3a\u4e86\u5224\u65ad\u7528\u54ea\u4e2a\u9884\u6d4b\u5668\u6765\u63d0\u4f9b\u6700\u7ec8\u7684\u65b9\u5411\uff0c\u89c4\u5219\u662f\uff1a</p>\n<ol>\n<li>\u5bf9\u4e8e\u6761\u4ef6\u5206\u652f\uff0c\u8bb0\u5f55\u5b83\u662f\u5426\u66fe\u7ecf\u8df3\u548c\u4e0d\u8df3\u8fc7\uff08Bidirectional\uff09\uff0c\u5982\u679c\u53ea\u5f80\u4e00\u4e2a\u65b9\u5411\u8df3\uff0c\u5c31\u67e5 BHT</li>\n<li>\u5982\u679c\u4e24\u4e2a\u65b9\u5411\u90fd\u8df3\u8fc7\uff0c\u6b64\u65f6 Perceptron \u4f18\u5148\u7ea7\u66f4\u9ad8\uff0c\u5982\u679c Perceptron \u547d\u4e2d\u4e14\u7f6e\u4fe1\u5ea6\u9ad8\uff0c\u5219\u7528 Perceptron \u7684\u7ed3\u679c</li>\n<li>\u5426\u5219\u8003\u5bdf TAGE \u7684\u9884\u6d4b\u7ed3\u679c\uff0c\u5982\u679c TAGE \u547d\u4e2d\u4e14\u7f6e\u4fe1\u5ea6\u9ad8\uff0c\u5219\u7528 TAGE \u7684\u7ed3\u679c</li>\n<li>\u5982\u679c Perceptron \u548c TAGE \u90fd\u6ca1\u6709\u547d\u4e2d\uff0c\u518d\u7528 BHT \u7684\u7ed3\u679c</li>\n</ol>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u4f18\u5148\u7ea7\u662f Perceptron &gt; TAGE &gt; BHT\u3002</p>\n<p>\u4e3a\u4e86\u9884\u6d4b\u95f4\u63a5\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\uff0cz15 \u4e0a PC \u548c GPV \u901a\u8fc7\u54c8\u5e0c\u6620\u5c04\u5230 CTB\uff08Changing Target Buffer\uff09\u7684\u8868\u9879\u4e0a\uff0c\u6bcf\u4e2a\u8868\u9879\u8bb0\u5f55\u4e86\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u3002</p>\n<p>\u6709\u610f\u601d\u7684\u662f\uff0cz15 \u6307\u4ee4\u96c6\u91cc\u6ca1\u6709\u5355\u72ec\u7684 call \u548c return \u6307\u4ee4\uff0c\u56e0\u6b64\u786c\u4ef6\u9700\u8981\u8bc6\u522b\u95f4\u63a5\u5206\u652f\u91cc\u7684 call \u548c return \u6a21\u5f0f\u3002\u8bba\u6587\u91cc\u4ecb\u7ecd\u4e86\u5177\u4f53\u7684\u8bc6\u522b\u65b9\u6cd5\uff0c\u4f46\u76ee\u524d\u4e3b\u6d41\u6307\u4ee4\u96c6\u90fd\u505a\u4e86\u533a\u5206\uff08\u8981\u4e48\u662f\u5355\u72ec\u7684\u6307\u4ee4\uff0c\u8981\u4e48\u5efa\u8bae\u7f16\u8bd1\u5668\u7528\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\uff0c\u6807\u8bb0 call \u548c return\uff09\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65b9\u6cd5\u4e5f\u6ca1\u5565\u53c2\u8003\u4ef7\u503c\u3002</p>", "image": null, "date_published": "2024-09-21T00:00:00+00:00", "authors": [], "tags": ["bp", "cpu", "hardware", "ibm", "microarchitecture"]}, {"id": "https://jia.je/hardware/2024/09/12/brief-into-ooo-3/", "url": "https://jia.je/hardware/2024/09/12/brief-into-ooo-3/", "title": "\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e09\uff1a\u524d\u7aef\uff09", "content_html": "<h1 id=\"\u6d45\u8c08\u4e71\u5e8f\u6267\u884c-cpu\u4e09\u524d\u7aef\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e09\uff1a\u524d\u7aef\uff09<a class=\"headerlink\" href=\"#\u6d45\u8c08\u4e71\u5e8f\u6267\u884c-cpu\u4e09\u524d\u7aef\" title=\"Permanent link\">&para;</a></h1>\n<p>\u672c\u6587\u7684\u5185\u5bb9\u5df2\u7ecf\u6574\u5408\u5230<a href=\"/kb/hardware/ooo_cpu.html\">\u77e5\u8bc6\u5e93</a>\u4e2d\u3002</p>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u662f <a href=\"../../../../2021/09/14/brief-into-ooo/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU</a> \u7cfb\u5217\u535a\u5ba2\u7684\u7b2c\u4e09\u7bc7\u3002</p>\n<p>\u672c\u6587\u4e3b\u8981\u8ba8\u8bba\u5904\u7406\u5668\u524d\u7aef\u7684\u90e8\u5206\u3002</p>\n<p>\u672c\u7cfb\u5217\u7684\u6240\u6709\u6587\u7ae0\uff1a</p>\n<ul>\n<li><a href=\"../../../../2021/09/14/brief-into-ooo/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e00\uff1a\u4e71\u5e8f\uff09</a></li>\n<li><a href=\"../../../../2022/03/31/brief-into-ooo-2/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e8c\uff1a\u8bbf\u5b58\uff09</a></li>\n<li><a href=\"./\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e09\uff1a\u524d\u7aef\uff09</a></li>\n</ul>\n<!-- more -->\n\n<h2 id=\"\u5904\u7406\u5668\u524d\u7aef\">\u5904\u7406\u5668\u524d\u7aef<a class=\"headerlink\" href=\"#\u5904\u7406\u5668\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<p>\u518d\u6765\u5206\u6790\u4e00\u4e0b\u4e71\u5e8f\u6267\u884c CPU \u7684\u524d\u7aef\u90e8\u5206\u3002\u4ee5 RISC-V \u4e3a\u4f8b\uff0c\u6307\u4ee4\u957f\u5ea6\u6709 4 \u5b57\u8282\u6216\u8005 2 \u5b57\u8282\u4e24\u79cd\uff0c\u5176\u4e2d 2 \u5b57\u8282\u5c5e\u4e8e\u538b\u7f29\u6307\u4ee4\u96c6\u3002\u5982\u4f55\u6b63\u786e\u5e76\u9ad8\u6548\u5730\u8fdb\u884c\u53d6\u6307\u4ee4\u8bd1\u7801\uff1f</p>\n<p>\u9996\u5148\uff0c\u6211\u4eec\u5e0c\u671b\u524d\u7aef\u80fd\u591f\u5c3d\u53ef\u80fd\u5feb\u5730\u53d6\u6307\u4ee4\uff0c\u524d\u7aef\u7684\u53d6\u6307\u80fd\u529b\u8981\u548c\u540e\u7aef\u5339\u914d\uff0c\u6bd4\u5982\u5bf9\u4e8e\u4e00\u4e2a\u56db\u53d1\u5c04\u7684 CPU\uff0c\u524d\u7aef\u5bf9\u5e94\u5730\u9700\u8981\u4e00\u4e2a\u5468\u671f\u53d6 <code>4*4=16</code> \u5b57\u8282\u7684\u6307\u4ee4\u3002\u4f46\u662f\uff0c\u8fd9 16 \u5b57\u8282\u53ef\u80fd\u662f 4 \u6761\u975e\u538b\u7f29\u6307\u4ee4\uff0c\u4e5f\u53ef\u80fd\u662f 8 \u6761\u538b\u7f29\u6307\u4ee4\uff0c\u4e5f\u53ef\u80fd\u662f\u6df7\u5408\u7684\u60c5\u51b5\u3002\u6240\u4ee5\uff0c\u8fd9\u91cc\u4f1a\u51fa\u73b0\u4e00\u4e2a\u53ef\u80fd\u51fa\u73b0\u6307\u4ee4\u6761\u6570\u4e0d\u5339\u914d\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u4e2d\u95f4\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a Fetch Buffer\uff0c\u6bd4\u5982 <a href=\"https://github.com/riscv-boom/riscv-boom\">BOOM</a> \u7684\u5b9e\u73b0\u4e2d\uff0cL1 ICache \u6bcf\u5468\u671f\u8bfb\u53d6 16 \u5b57\u8282\uff0c\u7136\u540e\u8fdb\u884c\u9884\u8bd1\u7801\uff0c\u51fa\u6765 8 \u6761\u6307\u4ee4\uff0c\u4fdd\u5b58\u5230 Fetch Buffer \u4e2d\u3002\u8fd9\u91cc\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u51e0\u70b9\uff1a\u9996\u5148\u4ece ICache \u8bfb\u53d6\u7684\u6570\u636e\u662f\u5bf9\u9f50\u7684\uff0c\u4f46\u662f PC \u53ef\u80fd\u4e0d\u662f\uff0c\u6bd4\u5982\u4e2d\u95f4\u7684\u5730\u5740\u3002\u5176\u6b21\uff0c\u53ef\u80fd\u4e00\u4e2a 4 \u5b57\u8282\u7684\u975e\u538b\u7f29\u6307\u4ee4\u8de8\u8d8a\u4e86\u4e24\u6b21 Fetch\uff0c\u6bd4\u5982\u524d 2 \u4e2a\u5b57\u8282\u5728\u524d\u4e00\u4e2a Fetch Bundle\uff0c\u540e 2 \u4e2a\u5b57\u8282\u5728\u540e\u4e00\u4e2a Fetch Bundle\uff1b\u6b64\u5916\uff0c\u6bcf\u4e2a 2 \u5b57\u8282\u7684\u8fb9\u754c\u90fd\u9700\u8981\u5224\u65ad\u4e00\u4e0b\u662f\u538b\u7f29\u6307\u4ee4\u8fd8\u662f\u975e\u538b\u7f29\u6307\u4ee4\u3002\u4e00\u4e2a\u975e\u5e38\u7279\u6b8a\u7684\u60c5\u51b5\u5c31\u662f\uff0c\u4e00\u4e2a 4 \u5b57\u8282\u7684\u6307\u4ee4\u8de8\u8d8a\u4e86\u4e24\u4e2a\u9875\uff0c\u6240\u4ee5\u4e24\u4e2a\u9875\u90fd\u9700\u8981\u67e5\u8be2\u9875\u8868\uff1b\u5982\u679c\u6070\u597d\u5728\u7b2c\u4e8c\u4e2a\u9875\u5904\u53d1\u751f\u4e86\u9875\u7f3a\u5931\uff0c\u6b64\u65f6 epc \u662f\u6307\u4ee4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u4f46 tval \u662f\u7b2c\u4e8c\u4e2a\u9875\u7684\u5730\u5740\uff0c\u8fd9\u6837\u5185\u6838\u624d\u77e5\u9053\u662f\u54ea\u4e2a\u9875\u53d1\u751f\u4e86\u7f3a\u5931\u3002</p>\n<p>\u5176\u6b21\uff0c\u9700\u8981\u914d\u5408\u5206\u652f\u9884\u6d4b\u3002\u5982\u679c\u9700\u8981\u4fdd\u8bc1\u5206\u652f\u9884\u6d4b\u6b63\u786e\u7684\u60c5\u51b5\u4e0b\uff0c\u80fd\u591f\u5728\u5faa\u73af\u4e2d\u8fbe\u5230\u63a5\u8fd1 100% \u7684\u6027\u80fd\uff0c\u90a3\u4e48\uff0c\u5728 Fetch \u5206\u652f\u7ed3\u5c3e\u7684\u5206\u652f\u6307\u4ee4\u7684\u540c\u65f6\uff0c\u9700\u8981\u4fdd\u8bc1\u4e0b\u4e00\u6b21 Fetch \u5df2\u7ecf\u5f97\u5230\u4e86\u5206\u652f\u9884\u6d4b\u7684\u76ee\u7684\u5730\u5740\u3002\u8fd9\u4e2a\u5c31\u662f BOOM \u91cc\u9762\u7684 L0 BTB (1-cycle redirect)\u3002\u4f46\u662f\uff0c\u4e00\u4e2a\u5468\u671f\u5185\u5b8c\u6210\u7684\u5206\u652f\u9884\u6d4b\uff0c\u5b83\u7684\u9762\u79ef\u80af\u5b9a\u4e0d\u80fd\u5927\uff0c\u5426\u5219\u65f6\u5e8f\u65e0\u6cd5\u6ee1\u8db3\uff0c\u6240\u4ee5 BOOM \u91cc\u9762\u8fd8\u8bbe\u8ba1\u4e86 2-cycle \u548c 3-cycle \u7684\u6bd4\u8f83\u9ad8\u7ea7\u7684\u5206\u652f\u9884\u6d4b\u5668\uff0c\u8fd8\u6709\u9488\u5bf9\u51fd\u6570\u8c03\u7528\u7684 RAS\uff08Return Address Stack\uff09\u3002</p>\n<p>\u5206\u652f\u9884\u6d4b\u4e5f\u6709\u5f88\u591a\u65b9\u6cd5\u3002\u6bd4\u8f83\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5b9e\u73b0\u4e00\u4e2a BHT\uff0c\u6bcf\u4e2a\u9879\u662f\u4e00\u4e2a 2 \u4f4d\u7684\u9971\u548c\u8ba1\u6570\u5668\uff0c\u8d85\u8fc7\u4e00\u534a\u7684\u65f6\u5019\u589e\u52a0\uff0c\u5c11\u4e8e\u4e00\u534a\u65f6\u51cf\u5c11\u3002\u4f46\u662f\uff0c\u5982\u679c\u9047\u5230\u4e86\u8df3\u8f6c/\u4e0d\u8df3\u8f6c/\u8df3\u8f6c/\u4e0d\u8df3\u8f6c\u8fd9\u79cd\u6765\u56de\u5207\u6362\u7684\u60c5\u51b5\uff0c\u51c6\u786e\u7387\u5c31\u5f88\u4f4e\u3002\u4e00\u4e2a\u590d\u6742\u4e00\u4e9b\u7684\u8bbe\u8ba1\uff0c\u5c31\u662f\u7528 BHR\uff0c\u8bb0\u5f55\u8fd9\u4e2a\u5206\u652f\u6307\u4ee4\u6700\u8fd1\u51e0\u6b21\u7684\u5386\u53f2\uff0c\u5bf9\u4e8e\u6bcf\u79cd\u53ef\u80fd\u7684\u5386\u53f2\uff0c\u90fd\u5bf9\u5e94\u4e00\u4e2a 2 \u4f4d\u7684\u9971\u548c\u8ba1\u6570\u5668\u3002\u8fd9\u6837\uff0c\u9047\u5230\u521a\u624d\u6240\u8bf4\u7684\u60c5\u51b5\u5c31\u4f1a\u5f88\u597d\u5730\u9884\u6d4b\u3002\u4f46\u5b9e\u8df5\u4e2d\u4f1a\u9047\u5230\u95ee\u9898\uff1a\u5982\u679c\u5728\u5199\u56de\u4e4b\u524d\uff0c\u53c8\u8fdb\u884c\u4e86\u4e00\u6b21\u9884\u6d4b\uff0c\u56e0\u4e3a\u9884\u6d4b\u662f\u5728\u53d6\u6307\u7684\u65f6\u5019\u505a\u7684\uff0c\u4f46\u662f\u66f4\u65b0 BPU \u662f\u5728\u5199\u56de\u7684\u65f6\u5019\u5b8c\u6210\u7684\uff0c\u8fd9\u65f6\u5019\u9884\u6d4b\u5c31\u662f\u57fa\u4e8e\u65e7\u7684\u72b6\u6001\u8fdb\u884c\u9884\u6d4b\uff0c\u8fd9\u65f6\u5019 BHR \u5c31\u4f1a\u51fa\u73b0\u4e0d\u51c6\u786e\u7684\u95ee\u9898\uff1b\u800c\u4e14\u5199\u56de BPU \u7684\u65f6\u5019\uff0c\u4f1a\u6309\u7167\u539f\u6765\u7684\u72b6\u6001\u8fdb\u884c\u66f4\u65b0\uff0c\u8fd9\u4e2a\u72b6\u6001\u53ef\u80fd\u4e5f\u662f\u9519\u8bef\u7684\uff0c\u5bfc\u81f4\u4e22\u5931\u4e00\u6b21\u66f4\u65b0\uff0c\u8bc6\u522b\u7684\u6a21\u5f0f\u4ece\u8df3\u8f6c/\u4e0d\u8df3\u8f6c/\u8df3\u8f6c/\u4e0d\u8df3\u8f6c\u53d8\u6210\u4e86\u8df3\u8f6c/\u8df3\u8f6c/\u8df3\u8f6c/\u4e0d\u8df3\u8f6c\uff0c\u8fd9\u6837\u53c8\u4f1a\u9884\u6d4b\u9519\u8bef\u3002\u4e00\u4e2a\u89e3\u51b3\u529e\u6cd5\u662f\uff0c\u5728\u53d6\u6307\u9636\u6bb5\uff0cBPU \u9884\u6d4b\u5b8c\u5c31\u7acb\u5373\u6309\u7167\u9884\u6d4b\u7684\u7ed3\u679c\u66f4\u65b0 BHR\uff0c\u4e4b\u540e\u5199\u56de\u9636\u6bb5\u4f1a\u6062\u590d\u5230\u5b9e\u9645\u7684 BHR \u53d6\u503c\u3002\u8bba\u6587 <a href=\"https://dl.acm.org/doi/10.1145/192724.192756\">The effect of speculatively updating branch history on branch prediction accuracy, revisited</a> \u548c <a href=\"https://jilp.org/vol2/v2paper1.pdf\">Speculative Updates of Local and Global Branch History: A Quantitative Analysis</a> \u8ba8\u8bba\u4e86\u8fd9\u4e2a\u5b9e\u73b0\u65b9\u5f0f\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u3002</p>\n<p>\u6bd4\u8f83\u5bb9\u6613\u505a\u9884\u6d4b\u66f4\u65b0\u548c\u6062\u590d\u7684\u662f\u5168\u5c40\u5206\u652f\u5386\u53f2\uff0c\u53ef\u4ee5\u7ef4\u62a4\u4e24\u4e2a GHR\uff08Global History Register\uff09\uff0c\u4e00\u4e2a\u662f\u76ee\u524d\u53d6\u6307\u4ee4\u6700\u65b0\u7684\uff0c\u4e00\u4e2a\u662f\u63d0\u4ea4\u7684\u6700\u65b0\u7684\u3002\u5728\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u7528 GHR \u53bb\u627e\u5bf9\u5e94\u7684 2-bit \u72b6\u6001\uff0c\u7136\u540e\u628a\u9884\u6d4b\u7ed3\u679c\u66f4\u65b0\u5230 GHR \u4e0a\u3002\u5728\u9884\u6d4b\u5931\u8d25\u7684\u65f6\u5019\uff0c\u628a GHR \u6062\u590d\u4e3a\u63d0\u4ea4\u7684\u72b6\u6001\u3002\u5982\u679c\u8981\u652f\u6301\u4e00\u4e2a Fetch Packet \u4e2d\u6709\u591a\u4e2a\u5206\u652f\uff0c\u53ef\u4ee5\u8ba9 GHR \u5bf9\u5e94\u82e5\u5e72\u4e2a 2-bit \u72b6\u6001\uff0c\u5206\u522b\u5bf9\u5e94\u76f8\u5e94\u4f4d\u7f6e\u4e0a\u7684\u5206\u652f\u7684\u72b6\u6001\uff0c\u5f53\u7136\u8fd9\u6837\u9762\u79ef\u4e5f\u4f1a\u589e\u52a0\u5f88\u591a\u3002</p>\n<p>\u9664\u4e86\u8bb0\u5f55\u6761\u4ef6\u5206\u652f\u7684\u8df3\u4e0e\u4e0d\u8df3\u4ee5\u5916\uff0c\u901a\u5e38\u8fd8\u53ef\u4ee5\u7ef4\u62a4 taken branch \u7684\u5730\u5740\uff0c\u8bb0\u5f55\u8fd9\u6837\u7684\u5206\u652f\u5386\u53f2\u7684 GHR \u5c31\u53eb\u505a PHR\uff08Path History Register\uff09\u3002</p>\n<p>\u76ee\u524d\u6bd4\u8f83\u4e3b\u6d41\u7684\u5206\u652f\u9884\u6d4b\u7b97\u6cd5\u5c31\u662f <a href=\"https://inria.hal.science/hal-03408381/document\">TAGE</a> \u4e86\uff1a\u7ef4\u62a4\u591a\u4e2a\u8868\uff0c\u6bcf\u4e2a\u8868\u91c7\u53d6\u7684\u5386\u53f2\u957f\u5ea6\u4e0d\u540c\uff0c\u5448\u51e0\u4f55\u7ea7\u6570\uff0c\u4f7f\u5f97\u9700\u8981\u6bd4\u8f83\u77ed\u7684\u5386\u53f2\u5c31\u53ef\u4ee5\u9884\u6d4b\u7684\u5206\u652f\u53ef\u4ee5\u66f4\u5feb\u7684\u9884\u70ed\uff0c\u9700\u8981\u6bd4\u8f83\u957f\u7684\u5386\u53f2\u624d\u80fd\u9884\u6d4b\u7684\u5206\u652f\u4e5f\u53ef\u4ee5\u6709\u8f83\u597d\u7684\u51c6\u786e\u5ea6\u3002\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f TAGE \u7684\u8868\u9879\u5206\u914d\u548c\u66ff\u6362\u7684\u7b97\u6cd5\uff0cuseful counter \u548c altpred \u7684\u8bbe\u8ba1\uff0c\u4ee5\u53ca USE_ALT_ON_NA \u7684\u4f18\u5316\u3002\u4e3a\u4e86\u9884\u6d4b\u95f4\u63a5\u5206\u652f\uff0c\u53ef\u4ee5\u628a\u76ee\u7684\u5730\u5740\u653e\u5230 TAGE \u7684\u8868\u9879\u91cc\uff0c\u628a\u9884\u6d4b\u65b9\u5411\u53d8\u4e3a\u9884\u6d4b\u76ee\u7684\u5730\u5740\uff0c\u8fd9\u79cd\u9884\u6d4b\u95f4\u63a5\u5206\u652f\u7684 TAGE \u5c31\u53eb\u505a ITTAGE\u3002\u90e8\u5206\u5b9e\u73b0\u8fd8\u4f1a\u7ed9 TAGE \u6dfb\u52a0 Statistical Corrector \u6216\u8005 Loop Predictor\u3002\u8fd9\u4e9b\u7b97\u6cd5\u57fa\u672c\u7edf\u6cbb\u4e86\u5f53\u4eca\u9ad8\u6027\u80fd\u7684\u5904\u7406\u5668\u8bbe\u8ba1\u3002</p>\n<p>\u6211\u5728\u535a\u5ba2 <a href=\"../../10/samsung-exynos-cpu/\">\u4e09\u661f Exynos CPU \u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0</a> \u4e2d\u8be6\u7ec6\u5206\u6790\u4e86 Exynos \u5fae\u67b6\u6784\u7684\u524d\u7aef\u8bbe\u8ba1\uff0c\u5efa\u8bae\u611f\u5174\u8da3\u7684\u8bfb\u8005\u9605\u8bfb\u3002</p>\n<h2 id=\"short-forward-branch\">Short Forward Branch<a class=\"headerlink\" href=\"#short-forward-branch\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8bba\u6587 <a href=\"https://carrv.github.io/2020/papers/CARRV2020_paper_15_Zhao.pdf\">SonicBOOM: The 3rd Generation Berkeley Out-of-Order Machine</a> \u63d0\u5230\u4e86\u4e00\u4e2a\u6709\u610f\u601d\u7684\u4f18\u5316\uff1aShort Forward Branch\u3002\u5b83\u9762\u5bf9\u7684\u573a\u666f\u662f\u4e00\u4e9b\u5c0f\u7684 if \u8bed\u53e5\uff0c\u5728 if \u7684\u6761\u4ef6\u6ee1\u8db3\u65f6\uff0c\u6267\u884c\u5c11\u91cf\u7684\u6307\u4ee4\u3002\u6b63\u5e38\u6765\u8bf4\uff0c\u8fd9\u6837\u7684\u4ee3\u7801\u4f1a\u88ab\u7f16\u8bd1\u6210\u4e00\u4e2a Forward \u7684\u5206\u652f\uff0c\u88ab\u8df3\u8fc7\u7684\u5c31\u662f if \u6761\u4ef6\u6ee1\u8db3\u65f6\u8981\u6267\u884c\u7684\u4ee3\u7801\u5bf9\u5e94\u7684\u6307\u4ee4\u3002\u5982\u679c\u5206\u652f\u6bd4\u8f83\u597d\u9884\u6d4b\uff0c\u90a3\u73b0\u6709\u7684\u5206\u652f\u9884\u6d4b\u5668\u5c31\u53ef\u4ee5\u5f97\u5230\u5f88\u597d\u7684\u6027\u80fd\uff0c\u4f46\u5982\u679c\u5206\u652f\u4e0d\u597d\u9884\u6d4b\uff0c\u4f8b\u5982\u5b83\u4f1a\u4f9d\u8d56\u6570\u636e\u7684\u503c\uff0c\u5e76\u4e14\u5177\u6709\u4e00\u5b9a\u7684\u968f\u673a\u6027\uff0c\u8fd9\u65f6\u5019\u6027\u80fd\u5c31\u4f1a\u4e0b\u964d\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u7528\u6761\u4ef6\u6267\u884c\u6765\u4ee3\u66ff\u5206\u652f\uff1a\u628a\u5206\u652f\u6307\u4ee4\u66ff\u6362\u4e3a\u6bd4\u8f83\u6307\u4ee4\uff0c\u7136\u540e\u6839\u636e\u6bd4\u8f83\u7684\u7ed3\u679c\u6765\u6761\u4ef6\u6267\u884c\u672c\u6765\u53ef\u80fd\u4f1a\u88ab\u8df3\u8fc7\u7684\u6307\u4ee4\u3002\u4e0b\u9762\u662f\u8bba\u6587\u4e2d\u7ed9\u7684\u4f8b\u5b50\uff0c\u8bf4\u7684\u6bd4\u8f83\u7684\u6e05\u6670\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-sfb.png\" /></p>\n<p>\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f\uff0c\u8fd9\u4e2a\u4f18\u5316\u662f\u5b8c\u5168\u7531\u786c\u4ef6\u6765\u505a\u7684\uff0c\u800c\u4e0d\u662f\u7f16\u8bd1\u5668\u3002\u5f53\u7136\u4e86\uff0c\u5982\u679c\u7f16\u8bd1\u5668\u8981\u505a\u7684\u524d\u63d0\u662f\u786c\u4ef6\u652f\u6301\u8fd9\u7c7b\u6807\u91cf\u7684\u6761\u4ef6\u6267\u884c\u6307\u4ee4\uff0c\u867d\u7136 Zicond \u6269\u5c55\u786e\u5b9e\u63d0\u4f9b\u4e86\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u5f88\u591a RISC-V \u5b9e\u73b0\u8fd8\u6ca1\u6709\u5b9e\u73b0 Zicond\u3002\u786c\u4ef6\u4e0a\u505a\u7684\u8bdd\uff0c\u5c31\u4e0d\u9700\u8981\u6269\u5c55\u6307\u4ee4\u96c6\uff0c\u76f4\u63a5\u5728\u524d\u7aef\u8fdb\u884c\u8bc6\u522b\uff0c\u5f53\u53d1\u73b0\u8fd9\u79cd Short Forward Branch \u65f6\uff0c\u628a\u5206\u652f\u6307\u4ee4\u672c\u8eab\u6539\u6210\u4e00\u6761 set-flag \u6307\u4ee4\uff0c\u7136\u540e\u628a\u5206\u652f\u5230\u8df3\u8f6c\u76ee\u7684\u5730\u8fd9\u4e00\u6bb5\u7684\u6307\u4ee4\u6539\u4e3a\u6761\u4ef6\u6267\u884c\u3002\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u8fdb\u884c\u5206\u652f\u9884\u6d4b\u4e86\uff0c\u65e0\u8bba\u539f\u6765\u7684\u5206\u652f\u662f\u5426\u8df3\u8f6c\uff0c\u540e\u7eed\u7684\u8fd9\u4e9b\u6307\u4ee4\u90fd\u4f1a\u8fdb\u5165\u6d41\u6c34\u7ebf\uff0c\u770b\u8d77\u6765\u505a\u4e86\u66f4\u591a\u7684\u4e8b\u60c5\uff0c\u4f46\u5f88\u591a\u65f6\u5019\u53cd\u800c\u6bd4\u9519\u8bef\u7684\u5206\u652f\u9884\u6d4b\u8fd8\u8981\u5feb\u3002</p>\n<p>\u8fd9\u4e2a\u4f18\u5316\u601d\u8def\u5728 Intel \u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US9367314B2/en\">Converting conditional short forward branches to computationally equivalent predicated instructions</a> \u4e5f\u6709\u9610\u8ff0\uff0c\u4e0d\u77e5\u9053\u8fd9\u4e2a\u4f18\u5316\u6709\u6ca1\u6709\u5b9e\u9645\u52a0\u5230 Intel \u7684\u5904\u7406\u5668\u5f53\u4e2d\u3002\u4e13\u5229\u7684\u56fe 6 \u5f88\u597d\u5730\u7528 X86 \u7684\u6307\u4ee4\u9610\u8ff0\u4e86\u8fd9\u4e2a\u4f18\u5316\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-intel.png\" /></p>\n<p>Intel \u5728 <a href=\"https://ieeexplore.ieee.org/document/9138936\">ISCA 2020 \u7684\u8bba\u6587 Auto-Predication of Critical Branches</a> \u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e9b\u786c\u4ef6\u7684\u5b9e\u73b0\u601d\u8def\uff0c\u8ba8\u8bba\u4e86\u600e\u6837\u53bb\u68c0\u6d4b\u8fd9\u6837\u7684\u5316\u5206\u652f\u6307\u4ee4\u4e3a\u6761\u4ef6\u6267\u884c\u6307\u4ee4\u7684\u60c5\u51b5\uff0c\u5982\u4f55\u5728\u786c\u4ef6\u4e2d\u5b9e\u73b0\u9ad8\u6548\u7684\u6761\u4ef6\u6267\u884c\uff0c\u600e\u4e48\u907f\u514d\u8d1f\u4f18\u5316\uff08\u4f8b\u5982\u53bb\u6389\u5206\u652f\u6307\u4ee4\u4ee5\u540e\uff0c\u5206\u652f\u9884\u6d4b\u5668\u773c\u91cc\u5c31\u4e22\u5931\u4e86\u5206\u652f\u7684\u5386\u53f2\uff1b\u8f6c\u5316\u4e3a\u6761\u4ef6\u6267\u884c\u4ee5\u540e\uff0c\u672c\u6765\u53ef\u80fd\u6ca1\u6709\u4f9d\u8d56\u7684\u6307\u4ee4\u4e5f\u53d8\u5f97\u5f3a\u5236\u6709\u4f9d\u8d56\u4e86\uff09\uff0c\u5efa\u8bae\u6709\u5174\u8da3\u7684\u8bfb\u8005\u9605\u8bfb\u3002</p>\n<p>\u90a3\u4e48\u8fd9\u6837\u7684\u6307\u4ee4\u5e8f\u5217\u5728\u5b9e\u9645\u7684\u7a0b\u5e8f\u91cc\u51fa\u73b0\u7684\u591a\u5417\uff1f\u8bba\u6587 <a href=\"http://ieeexplore.ieee.org/document/717459/\">The Effects of Predicated Execution on Branch Prediction</a> \u5206\u6790\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u7ed3\u8bba\u662f\u8fd8\u771f\u4e0d\u5c11\u3002\u5f53\u7136\u4e86\uff0c\u8fd9\u7bc7\u8bba\u6587\u4e3b\u8981\u7684\u8bba\u70b9\u662f\uff0c\u6307\u4ee4\u96c6\u5e94\u8be5\u5f15\u5165\u5404\u79cd\u6761\u4ef6\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u6837\u7f16\u8bd1\u5668\u5c31\u53ef\u4ee5\u5229\u7528\u73b0\u6709\u5904\u7406\u5668\u7684\u6761\u4ef6\u6267\u884c\u6307\u4ee4\u6765\u4f18\u5316\uff0c\u6ca1\u6709\u53bb\u8ba8\u8bba\u7eaf\u786c\u4ef6\u7684\u5b9e\u73b0\u65b9\u6cd5\u3002</p>\n<p>\u4ece SiFive \u63d0\u4ea4\u7ed9 GCC \u7684 <a href=\"https://patchwork.ozlabs.org/project/gcc/patch/20190430234741.8120-1-jimw@sifive.com/#2163277\">patch</a> \u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u7c7b\u4f3c\u7684\u4f18\u5316\u88ab\u5b9e\u88c5\u5230\u4e86 SiFive \u7684 CPU \u5f53\u4e2d\uff0c\u4e0d\u8fc7\u8fd9\u91cc\u505a\u7684\u4f1a\u66f4\u52a0\u7b80\u5355\uff0c\u53ea\u8003\u8651\u4e86\u5206\u652f\u8df3\u8fc7\u4e00\u6761\u6307\u4ee4\u7684\u60c5\u51b5\uff0c\u8fd9\u79cd\u4e5f\u6bd4\u8f83\u597d\u5b9e\u73b0\uff0c\u53ef\u4ee5\u5728\u73b0\u6709\u7684\u6307\u4ee4\u878d\u5408\u673a\u5236\u7684\u57fa\u7840\u4e0a\uff0c\u628a\u4e24\u6761\u6307\u4ee4\u5408\u6210\u4e00\u6761\uff1a</p>\n<blockquote>\n<p>The SiFive 7 series cores have macro fusion support to convert a branch over a\nsingle instruction into a conditionally executed instruction.  This adds a\nconditional move pattern, enabled only for the SiFive 7 series cores, that\nimplements the initial optimization support for this feature.  This gives us\nabout a 10% increase in coremark scores for this core.</p>\n</blockquote>\n<p>SiFive \u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US10996952B2/en\">Macro-op fusion</a> \u4e5f\u63d0\u5230\u4e86\u5f88\u591a\u5728 RISC-V \u4e0a\u5b9e\u73b0\u7684\u6307\u4ee4\u878d\u5408\u7684\u4f18\u5316\uff0c\u4e0b\u9762\u4e3e\u51e0\u4e2a\u4f8b\u5b50\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"w\">    </span><span class=\"nf\">bne</span><span class=\"w\"> </span><span class=\"no\">x1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">target</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"nl\">target:</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u8f6c\u5316\u4e3a\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"w\">    </span><span class=\"nf\">ifeqz_addi</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</span></code></pre></div>\n<p>\u8fd9\u5c31\u662f\u4e0a\u9762\u6240\u8bf4\u7684 SiFive \u5b9e\u73b0\u7684\u53ea\u8df3\u8fc7\u5355\u6761\u6307\u4ee4\u7684 Short Forward Branch\uff0c\u628a bne + add \u6307\u4ee4\u53d8\u6210\u4e86\u6761\u4ef6 add \u6307\u4ee4\uff0c\u5e76\u4e14\u81ea\u5e26\u548c 0 \u6bd4\u8f83\u7684\u903b\u8f91\uff1a\u5982\u679c x1 == 0\uff08ifeqz\uff0cif equals to zero\uff09\uff0c\u5c31\u8bbe\u7f6e x3 = x3 + 1\uff0c\u5426\u5219 x3 \u4fdd\u6301\u4e0d\u53d8\u3002\u7c7b\u4f3c\u5730\uff0c\u628a add \u6362\u6210 sub \u4e5f\u53ef\u4ee5\u7c7b\u4f3c\u5730\u505a\u878d\u5408\uff0c\u751a\u81f3\u8fde\u51fd\u6570\u8c03\u7528 jal \u6307\u4ee4\u4e5f\u53ef\u4ee5\u3002</p>\n<p>\u8fd8\u6709\u4e00\u4e2a\u6709\u8da3\u7684\u6307\u4ee4\u878d\u5408\u573a\u666f\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"w\">    </span><span class=\"nf\">beq</span><span class=\"w\"> </span><span class=\"no\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">skip</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"w\">    </span><span class=\"nf\">j</span><span class=\"w\"> </span><span class=\"no\">target</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"nl\">skip:</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"w\">    </span><span class=\"c1\">// ...</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"nl\">target:</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u878d\u5408\u4e3a\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"w\">    </span><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"no\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">target</span>\n</span></code></pre></div>\n<p>\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\uff0c\u4e3a\u4ec0\u4e48\u7f16\u8bd1\u5668\u8981\u591a\u6b64\u4e00\u4e3e\uff0c\u4e0d\u76f4\u63a5\u751f\u6210\u4e00\u4e2a bne\uff1f\u7b54\u6848\u662f RISC-V \u7684 bne \u7684\u7acb\u5373\u6570\u8303\u56f4\u592a\u5c0f\uff0c\u8981\u60f3\u8df3\u5230\u66f4\u5927\u7684\u8303\u56f4\uff0c\u5c31\u9700\u8981\u7528 j \u6307\u4ee4\uff0c\u4e8e\u662f\u7f16\u8bd1\u5668\u53ea\u597d\u7528 beq + j \u7684\u7ec4\u5408\u6765\u5b9e\u73b0\u5927\u8303\u56f4\u7684 bne\u3002\u7136\u540e SiFive \u7684\u5904\u7406\u5668\u4f1a\u8bc6\u522b\u8fd9\u79cd\u6a21\u5f0f\uff0c\u628a\u5b83\u8f6c\u6362\u6210\u4e00\u6761 jne\uff1a\u6761\u4ef6\u5206\u652f\uff0c\u4f46\u53c8\u6709 j \u6307\u4ee4\u7684 imm \u8df3\u8f6c\u8303\u56f4\u3002\u8fd9\u4e5f\u633a\u6709\u610f\u601d\u7684\uff0c\u6307\u4ee4\u5728\u8bbe\u8ba1\u7684\u65f6\u5019\uff0c\u4e0d\u597d\u505a\u592a\u591a\u7684 imm \u4f4d\u6570\uff0c\u7f16\u8bd1\u5668\u56e0\u6b64\u751f\u6210\u4e86\u66f4\u590d\u6742\u7684\u4ee3\u7801\uff0c\u786c\u4ef6\u518d\u7ffb\u8bd1\u56de\u6765\u3002</p>\n<p>\u82f9\u679c\u7533\u8bf7\u4e86 <a href=\"https://patents.google.com/patent/US20240028339A1/en\">Using a Next Fetch Predictor Circuit with Short Branches and Return Fetch Groups</a> \u4e13\u5229\uff0c\u5b83\u548c\u4e0a\u9762\u63d0\u5230\u7684\u4f18\u5316\u4e0d\u592a\u4e00\u6837\uff0c\u4f46\u662f\u6709\u4e9b\u7c7b\u4f3c\u3002\u4e13\u5229\u91cc\u63d0\u5230\u4e86\u8fd9\u4e48\u51e0\u79cd\u60c5\u51b5\uff1a</p>\n<ul>\n<li>\u5982\u679c Fetch Group \u5185\u6709\u4e00\u4e2a\u8981\u8df3\u8f6c\u7684\u5206\u652f\u6307\u4ee4\u4f1a Forward \u8df3\u8f6c\u5230\u540c\u4e00\u4e2a Fetch Group \u5185\u90e8\uff0c\u539f\u6765\u7684\u505a\u6cd5\u662f\u4ece\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u518d Fetch \u4e00\u6b21\uff0c\u4f46\u65e2\u7136\u662f\u540c\u4e00\u4e2a Fetch Group\uff0cFetch \u5206\u652f\u6307\u4ee4\u7684\u540c\u65f6\uff0c\u5df2\u7ecf\u628a\u4ece\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u5f00\u59cb\u7684\u6307\u4ee4\u53d6\u8fdb\u6765\u4e86\uff0c\u8df3\u8fc7\u4e2d\u95f4\u7684\u6307\u4ee4\uff0c\u628a\u4e24\u6bb5\u6307\u4ee4\u62fc\u63a5\u8d77\u6765\uff0c\u53ef\u4ee5\u7701\u4e0b\u91cd\u65b0 Fetch \u4e00\u6b21\u7684\u65f6\u95f4\u3002</li>\n<li>\u5982\u679c Fetch Group \u5185\u6709\u4e00\u6761 call \u6307\u4ee4\uff0c\u5728\u539f\u6765\u7684\u505a\u6cd5\u91cc\uff0ccall \u6307\u4ee4\u4e4b\u540e\u7684\u6307\u4ee4\u5c31\u88ab\u4e22\u5f03\u4e86\uff0c\u7b49\u5230\u672a\u6765 return \u56de\u6765\u7684\u65f6\u5019\uff0c\u518d\u91cd\u65b0 Fetch \u4e00\u6b21\uff1b\u4e13\u5229\u91cc\u7684\u505a\u6cd5\u662f\uff0c\u5728 call \u7684\u65f6\u5019\uff0c\u628a call \u6307\u4ee4\u4e4b\u540e\u7684\u6307\u4ee4\u4fdd\u5b58\u4e0b\u6765\uff0c\u5f53\u672a\u6765 return \u56de\u6765\u7684\u65f6\u5019\uff0c\u4e0d\u518d\u91cd\u65b0 Fetch\uff0c\u800c\u662f\u53d6\u51fa\u4fdd\u5b58\u4e0b\u6765\u7684 call \u6307\u4ee4\u4e4b\u540e\u7684\u6307\u4ee4\uff0c\u8fd9\u6837\u5c31\u8282\u7701\u4e86\u91cd\u65b0 Fetch \u4e00\u6b21\u7684\u65f6\u95f4\u3002</li>\n</ul>\n<p>\u56e0\u6b64\u5b83\u7684\u76ee\u7684\u4e3b\u8981\u662f\u89e3\u51b3\u91cd\u590d Fetch \u7684\u80fd\u8017\u95ee\u9898\uff0c\u800c\u4e0d\u662f\u5206\u652f\u9884\u6d4b\u9519\u8bef\u7387\u9ad8\u7684\u95ee\u9898\u3002</p>\n<h2 id=\"clustered-decode\">Clustered Decode<a class=\"headerlink\" href=\"#clustered-decode\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a8\u8350\u9605\u8bfb\uff1a<a href=\"https://zhuanlan.zhihu.com/p/720301269\">\u89e3\u7801\u7c07\u4e8c\u4e09\u4e8b\uff08\u4e00\uff09\uff1a\u4e3a\u4ec0\u4e48\uff1f&amp;\u52a0\u6599\uff01</a></p>\n<p>Intel \u7684 E \u6838\u4ece Tremont \u5fae\u67b6\u6784\u5f00\u59cb\u5b9e\u73b0\u4e86 Clustered Decode\uff0c\u4ece Goldmont Plus \u5fae\u67b6\u6784\u7684\u4f20\u7edf\u7684 3-wide decode\uff0c\u53d8\u6210\u4e86\u4e24\u6761 3-wide decode \u7684\u6d41\u6c34\u7ebf\uff0c\u52a0\u8d77\u6765\u5b9e\u73b0 6-wide decode \u7684\u6548\u679c\u3002\u4f46\u662f\u8fd9\u4e24\u4e2a\u6d41\u6c34\u7ebf\u600e\u4e48\u534f\u540c\u5de5\u4f5c\u5462\uff1f</p>\n<p>Intel \u5728 <a href=\"https://cdrdv2-public.intel.com/671488/248966-046A-software-optimization-manual.pdf\">Software Optimization Manual</a> \u4e2d\u662f\u8fd9\u4e48\u63cf\u8ff0\u7684\uff1a</p>\n<blockquote>\n<p>Tremont microarchitecture has a 32B predict pipeline that feeds dual 3-wide decode clusters capable of 6 instruction decode per cycle. Each cluster can access a banked 32KB instruction cache at 16B/cycle for a maximum of 32B/cycle.</p>\n</blockquote>\n<p>ICache \u5206\u6210\u4e24\u4e2a bank\uff0c\u4e24\u4e2a bank \u53ef\u4ee5\u540c\u65f6\u8bbf\u95ee\uff0c\u6bcf\u4e2a bank \u63d0\u4f9b 16B/cycle \u7684\u5e26\u5bbd\uff0c\u5bf9\u5e94\u4e24\u4e2a decode pipeline\u3002\u7531\u4e8e\u4e0d\u540c\u7684 bank \u53ef\u4ee5\u7528\u4e0d\u540c\u7684\u5730\u5740\u7684\u8bbf\u95ee\uff0c\u8fd9\u610f\u5473\u7740\u8fd9\u4e24\u6b21\u8bbf\u95ee\u53ef\u4ee5\u8bbf\u95ee\u4e0d\u540c cacheline \u5185\u7684\u6307\u4ee4\uff0c\u8fd9\u6b63\u597d\u5bf9\u5e94\u4e86\u6307\u4ee4\u6d41\u91cc\u6709\u8df3\u8f6c\u7684\u60c5\u51b5\uff1a</p>\n<p>\u5047\u5982\u6709\u4e00\u6bb5\u6307\u4ee4\uff08\u4e0b\u9762\u7684\u6307\u4ee4\u6d41 A\uff09\uff0c\u6700\u540e\u4e00\u6761\u6307\u4ee4\u4f1a\u8df3\u8f6c\u5230\u53e6\u4e00\u4e2a\u5730\u5740\uff08\u4e0b\u9762\u7684 1: label\uff09\uff0c\u5206\u652f\u9884\u6d4b\u5668\u5728\u770b\u5230\u8fd9\u4e2a\u6a21\u5f0f\u540e\uff0c\u5c31\u53ef\u4ee5\u8ba9\u4e24\u4e2a decode cluster \u5206\u522b\u5904\u7406\u8df3\u8f6c\u524d\u7684\u4ee3\u7801\uff08\u6307\u4ee4\u6d41 A \u5185\u7684 <code>dec + jne</code>\uff09\u548c\u8df3\u8f6c\u540e\u7684\u4ee3\u7801\uff08\u6307\u4ee4\u6d41 B \u5185\u7684 <code>mov</code>\uff09\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"c1\"># instruction stream A</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"nf\">dec</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"c1\"># instruction stream B</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">(</span><span class=\"nv\">%rsp</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u5728\u4fdd\u6301\u786c\u4ef6\u5b9e\u73b0\u6bd4\u8f83\u7b80\u5355\u7684\u524d\u63d0\u4e0b\uff0c\u5b9e\u73b0\u4e86\u6bd4\u8f83\u5bbd\u7684 decode width\uff08Intel \u539f\u6587\uff1a<code>Whereas increasing decode width in a traditional fashion for x86 requires exponential resources and triggers efficiency loss, clustering allows for x86 decode to be built with linear resources and little efficiency loss.</code>\uff09\u3002\u8fd9\u5bf9\u4e8e x86 \u6765\u8bf4\u662f\u6bd4\u8f83\u96be\u63d0\u5347\u7684\uff0c\u56e0\u4e3a\u6307\u4ee4\u662f\u53d8\u957f\u7684\uff0c\u5982\u679c\u4e0d\u77e5\u9053\u6307\u4ee4\u4ece\u54ea\u91cc\u5f00\u59cb\uff0c\u8bd1\u7801\u5c06\u4f1a\u5341\u5206\u590d\u6742\u800c\u4e14\u4e32\u884c\u3002\u53ef\u4ee5\u770b\u5230 ARM \u9635\u8425\u7684\u9ad8\u6027\u80fd\u5904\u7406\u5668\u5728 decode width \u4e0a\u6709\u4e00\u5b9a\u7684\u9886\u5148\uff0c\u4e5f\u662f\u56e0\u4e3a ARMv8 \u662f\u5b9a\u957f\u6307\u4ee4\u96c6\u3002</p>\n<p>\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4e5f\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u5047\u5982\u6ca1\u6709\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u600e\u4e48\u529e\uff1f\u5982\u679c\u9047\u5230\u4e00\u5927\u6bb5\u6ca1\u6709\u5206\u652f\u7684\u6307\u4ee4\uff0c\u4f3c\u4e4e\u5c31\u53ea\u80fd\u7528\u4e0a 3-wide decode\uff0c\u90a3\u4e48\u8fd9\u5f88\u5bb9\u6613\u6210\u4e3a\u4e00\u4e2a\u74f6\u9888\u3002Tremont \u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5efa\u8bae\u7528\u6237\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u63d2\u5165\u4e00\u4e9b jmp \u6307\u4ee4\u3002</p>\n<p>Intel \u5728 Tremont \u7684\u4e0b\u4e00\u4ee3 Gracemont \u5fae\u67b6\u6784\u4e2d\u7f13\u89e3\u4e86\u8fd9\u4e2a\u74f6\u9888\u3002\u65e2\u7136\u63d2\u5165\u4e00\u4e9b jmp \u6307\u4ee4\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u7531\u786c\u4ef6\u81ea\u52a8\u63d2\u5165\u4e00\u4e9b\u4f2a jmp \u6307\u4ee4\uff0c\u4e5f\u89e3\u51b3\u4e86\u540c\u6837\u7684\u95ee\u9898\uff0c\u8fd9\u5c31\u662f Gracemont \u7684\u89e3\u51b3\u601d\u8def\uff1a</p>\n<blockquote>\n<p>Gracemont microarchitecture addresses this bottleneck by introducing a hardware load-balancer. When the hardware detects long basic blocks, additional toggle points can be created based on internal heuristics. These toggle points are added to the predictors, thus guiding the machine to toggle within the basic block.</p>\n</blockquote>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u786c\u4ef6\u4f1a\u68c0\u6d4b\u8fd9\u79cd\u957f\u7684\u8fde\u7eed\u6307\u4ee4\u5757\uff08\u4f8b\u5982\u8fde\u7eed 32 \u6761\u6307\u4ee4\u90fd\u6ca1\u6709\u4e00\u4e2a\u8df3\u8f6c\u7684\u6307\u4ee4\uff09\uff0c\u9002\u65f6\u63d2\u5165\u4e00\u4e9b toggle point\uff08\u4f8b\u5982\u63d2\u5230\u7b2c 24 \u6761\u6307\u4ee4\u540e\u9762\uff09\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684\u4f2a jmp \u6307\u4ee4\uff0c\u8fd9\u6761\u6307\u4ee4\u5e76\u4e0d\u5b58\u5728\uff0c\u800c\u662f\u5728\u5206\u652f\u9884\u6d4b\u5668\u4e2d\u505a\u6807\u8bb0\uff0c\u90a3\u4e48\u672a\u6765\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u4e24\u6761 Decode Pipeline \u4e86\uff1a</p>\n<blockquote>\n<p>If there are no natural toggle points (i.e., taken branches) within 32 uops, the hardware will insert a toggle point on the instruction after or corresponding to the 24th uop of the stream. As inserted toggle points consume resources in the predictor, it typically doesn't insert immediately but rather marks the location of the instruction in a table of addresses. If the same inserted toggle point is marked a second time, it allocates this location into the predictor.</p>\n</blockquote>\n<p>\u6b64\u5916\uff0c\u4e3a\u4e86\u89e3\u51b3\u53d8\u957f\u6307\u4ee4\u96c6\u7684\u8bd1\u7801\u95ee\u9898\uff0c\u8fd8\u6709\u4e00\u4e2a\u4f18\u5316\uff1a\u5728 ICache \u4e2d\u6807\u8bb0\u6bcf\u6761\u6307\u4ee4\u7684\u8fb9\u754c\uff0c\u8fd9\u6837\u8bd1\u7801\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5feb\u901f\u5bfb\u627e\u5230\u6307\u4ee4\u8fb9\u754c\uff0c\u4ece\u6307\u4ee4\u8fb9\u754c\u5e76\u884c\u5730\u8fdb\u884c\u8bd1\u7801\uff0c\u800c\u4e0d\u7528\u5148\u5224\u65ad\u7b2c\u4e00\u6761\u6307\u4ee4\u6709\u591a\u957f\uff0c\u518d\u627e\u5230\u7b2c\u4e8c\u6761\u6307\u4ee4\u5728\u54ea\uff0c\u518d\u5224\u65ad\u7b2c\u4e8c\u6761\u6307\u4ee4\u6709\u591a\u957f\uff0c\u518d\u53bb\u627e\u7b2c\u4e09\u6761\u6307\u4ee4\u3002\u4e0d\u8fc7\u8fd9\u4e2a\u4fe1\u606f\u600e\u4e48\u6765\u5462\uff1f</p>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f\u5728 ICache \u4e2d\u8fdb\u884c\u9884\u8bd1\u7801\uff08Pre-decode\uff09\uff0c\u5f53 ICache \u5728 refill \u7684\u65f6\u5019\uff0c\u5c31\u8fdb\u884c\u4e00\u5b9a\u7684\u8bd1\u7801\uff0c\u628a\u6307\u4ee4\u8fb9\u754c\u6807\u8bb0\u51fa\u6765\u3002\u4f46 x86 \u7684\u6307\u4ee4\u4ece\u4e0d\u540c\u4f4d\u7f6e\u5f00\u59cb\u8bd1\u7801\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u4e5f\u56e0\u4e3a\u8fd9\u4e00\u70b9 ROP \u653b\u51fb\u5728 x86 \u4e0a\u6bd4\u8f83\u5bb9\u6613\u5b9e\u73b0\u3002\u8fd9\u5bf9\u4e8e\u9884\u8bd1\u7801\u4e5f\u5e26\u6765\u4e86\u56f0\u96be\uff0c\u4e0d\u77e5\u9053\u4ece\u54ea\u4e2a\u5b57\u8282\u5f00\u59cb\u6267\u884c\u3002</p>\n<p>\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u7b49\u5230\u8bd1\u7801\u7684\u65f6\u5019\uff0c\u5148\u68c0\u67e5\u4e00\u4e0b\u6709\u6ca1\u6709\u6307\u4ee4\u8fb9\u754c\u7684\u4fe1\u606f\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u4e34\u65f6\u8017\u8d39\u4e24\u4e2a\u5468\u671f\u6765\u8fdb\u884c\u9884\u8bd1\u7801\u7684\u64cd\u4f5c\uff0c\u628a\u6307\u4ee4\u8fb9\u754c\u6807\u8bb0\u51fa\u6765\uff0c\u628a\u7ed3\u679c\u5199\u5165 ICache \u4e2d\u3002\u7531\u4e8e\u6b64\u65f6\u5df2\u7ecf\u4ece\u5206\u652f\u9884\u6d4b\u5668\u77e5\u9053\u4e86\u6307\u4ee4\u6267\u884c\u7684\u8d77\u59cb\u5730\u5740\uff0c\u6240\u4ee5\u5f97\u5230\u7684\u7ed3\u679c\u66f4\u52a0\u7cbe\u786e\u3002\u8fd9\u4e2a\u65b9\u6cd5\u5728 Gracemont \u4e2d\u91c7\u7528\uff0c\u53eb\u505a On Demand Instruction Length Decoder\uff08OD-ILD\uff09\uff0c\u987e\u540d\u601d\u4e49\uff0c\u5b83\u7684\u8bd1\u7801\u7ed3\u679c\u662f\u6307\u4ee4\u7684\u957f\u5ea6\uff0c\u4e5f\u5c31\u5f97\u5230\u4e86\u6307\u4ee4\u7684\u8fb9\u754c\u4fe1\u606f\uff1a</p>\n<blockquote>\n<p>Instead of a second level predecode cache, the Gracemont microarchitecture introduces an \u201con-demand\u201d instruction length decoder (OD-ILD). This block is typically only active when new instruction bytes are brought into the instruction cache from a miss. When this happens, two extra cycles are added to the fetch pipeline in order to generate predecode bits on the fly.</p>\n</blockquote>\n<p>\u8fd9\u4e2a\u65b9\u6cd5\u5728 Intel \u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US20220100516A1/en\">Circuitry and methods for power efficient generation of length markers for a variable length instruction set</a> \u6709\u6bd4\u8f83\u8be6\u7ec6\u7684\u63cf\u8ff0\u3002</p>\n<p>Intel \u5728 Skymont \u8fd9\u4e00\u4ee3 E-core \u5fae\u67b6\u6784\u5728\u5927\u5927\u62d3\u5bbd\u540e\u7aef\u7684\u540c\u65f6\uff0c\u628a Decode \u4ece\u4e24\u6761 3-wide pipeline \u6539\u6210\u4e86\u4e09\u6761 3-wide pipeline\uff0c\u90a3\u4e48\u600e\u4e48\u628a\u8fd9\u4e09\u6761 Decode pipeline \u5582\u6ee1\uff0c\u662f\u7ee7\u7eed\u5ef6\u7eed\u4e0a\u9762\u7684\u601d\u8def\uff0c\u53ea\u4e0d\u8fc7\u63d2\u5165\u66f4\u591a\u7684 toggle point\uff0c\u8fd8\u662f\u6709\u4e00\u4e9b\u65b0\u7684\u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u62ed\u76ee\u4ee5\u5f85\u3002</p>\n<h2 id=\"btb-organization\">BTB Organization<a class=\"headerlink\" href=\"#btb-organization\" title=\"Permanent link\">&para;</a></h2>\n<p>BTB \u7684\u76ee\u7684\u662f\u5728\u5206\u652f\u9884\u6d4b\u9636\u6bb5\uff0c\u63d0\u4f9b\u54ea\u4e9b\u6307\u4ee4\u662f\u5206\u652f\u6307\u4ee4\uff0c\u4ee5\u53ca\u8fd9\u4e9b\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u7684\u4fe1\u606f\u3002\u90a3\u4e48 BTB \u662f\u600e\u4e48\u4fdd\u5b58\u8fd9\u4e9b\u4fe1\u606f\u7684\u5462\uff1f\u8bba\u6587 <a href=\"https://dl.acm.org/doi/pdf/10.1145/3613424.3623774\">Branch Target Buffer Organizations</a> \u603b\u7ed3\u4e86\u51e0\u79cd\u5e38\u89c1\u7684 BTB \u7ec4\u7ec7\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u79cd\u65b9\u6cd5\uff1aI-BTB\uff0cInstruction BTB\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u53ef\u80fd\u51fa\u73b0\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0c\u90fd\u8fdb\u884c\u4e00\u6b21 BTB \u67e5\u8be2\uff0c\u770b\u770b\u8fd9\u4e2a\u5730\u5740\u662f\u4e0d\u662f\u6709\u5206\u652f\u6307\u4ee4\u3002\u6b64\u65f6 BTB entry \u53ea\u9700\u8981\u8bb0\u5f55 tag\uff08\u7528\u4e8e\u7ec4\u76f8\u8fde\u7684 Way \u5339\u914d\uff09\u3001branch type \u548c branch target\u3002\u4ee5 ARMv8 \u4e3a\u4f8b\uff0c\u6307\u4ee4\u90fd\u662f 4 \u5b57\u8282\uff0c\u5047\u5982\u8981\u5bf9 32 \u5b57\u8282\u7684\u5757\u8fdb\u884c\u9884\u6d4b\uff0c\u90a3\u4e48\u5c31\u8981\u5bf9\u8fd9 32 \u5b57\u8282\u7684 8 \u4e2a 4 \u5b57\u8282\u90fd\u8fdb\u884c\u4e00\u6b21 BTB \u67e5\u8be2\uff0c\u5f97\u5230\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u4e0a\u7684\u5206\u652f\u4fe1\u606f\u3002x86 \u7684\u8bdd\u6bcf\u4e2a\u5b57\u8282\u90fd\u53ef\u80fd\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7528\u8fd9\u6837\u7684\u65b9\u6cd5\u9700\u8981\u67e5\u8be2\u7684\u6b21\u6570\u8fc7\u591a\u3002</li>\n<li>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff1aR-BTB\uff0cRegion BTB\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u5bf9\u9f50\u7684\u5757\uff0c\u8bb0\u5f55\u8fd9\u4e2a\u5757\u5185\u7684\u6709\u9650\u6761\u5206\u652f\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u5bf9\u6bcf\u4e2a\u5bf9\u9f50\u5230 32 \u5b57\u8282\u7684\u5757\uff0c\u8bb0\u5f55\u6700\u591a 4 \u6761\u5206\u652f\u3002\u6b64\u65f6 BTB entry \u9700\u8981\u8bb0\u5f55 tag\uff08\u7528\u4e8e\u7ec4\u76f8\u8fde\u7684 Way \u5339\u914d\uff09\u3001\u6bcf\u6761\u5206\u652f\u7684 offset\u3001\u7c7b\u578b \u548c target\u3002\u8fd9\u6837 BTB \u67e5\u8be2\u7684\u6b21\u6570\u4f1a\u6bd4\u8f83\u5c11\uff0c\u4f46\u5982\u679c\u4e00\u4e2a\u5757\u5185\u5206\u652f\u592a\u591a\uff0c\u4f1a\u51fa\u73b0\u5b58\u4e0d\u4e0b\u7684\u60c5\u51b5\u3002</li>\n<li>\u7b2c\u4e09\u79cd\u65b9\u6cd5\uff1aB-BTB\uff0cBlock BTB\uff0c\u8bb0\u5f55\u7684\u662f\u4ece\u67d0\u4e2a PC \u5f00\u59cb\u8fde\u7eed\u7684\u4e00\u6bb5\u6307\u4ee4\uff0c\u8fd9\u6bb5\u6307\u4ee4\u4e0d\u80fd\u6709\u591a\u4e8e n \u6761\u5206\u652f\uff0c\u5e76\u4e14\u4e0d\u80fd\u591a\u4e8e m \u6761\u6307\u4ee4\u6216 m \u4e2a\u5b57\u8282\u3002\u6b64\u65f6 BTB entry \u9700\u8981\u8bb0\u5f55 tag\uff08\u7528\u4e8e\u7ec4\u76f8\u8fde\u7684 Way \u5339\u914d\uff09\u3001\u6bcf\u6761\u5206\u652f\u7684 offset\u3001\u7c7b\u578b \u548c target\u3002\u8fd9\u79cd\u65b9\u6cd5\u5728\u5206\u652f\u5f88\u5bc6\u96c6\u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u7528\u591a\u4e2a BTB entry \u4fdd\u5b58\u8fd9\u4e9b\u5206\u652f\u3002\u6b64\u5916\u4e5f\u6bd4\u8f83\u65b9\u4fbf\u505a 2 predictions/cycle\uff1a\u540c\u65f6\u9884\u6d4b\u4e24\u4e2a\u6761\u4ef6\u5206\u652f\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5206\u652f\u4e0d\u8df3\u8f6c\uff0c\u90a3\u5c31\u7528\u7b2c\u4e8c\u4e2a\u5206\u652f\u7684\u7ed3\u679c\u3002\u4f46\u540c\u4e00\u4e2a\u5206\u652f\u53ef\u80fd\u91cd\u590d\u4fdd\u5b58\u5728\u591a\u4e2a BTB entry \u4e2d\uff0c\u56e0\u4e3a\u5165\u53e3 PC \u53ef\u80fd\u4e0d\u540c\u3002</li>\n</ol>\n<p>\u4e0b\u9762\u770b\u4e00\u4e9b\u4f8b\u5b50\uff0c\u4f8b\u5982 AMD \u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/software-optimization-guides/56665.zip\">Software Optimization Guide for AMD EPYC\u2122 7003 Processors</a> \u4e2d\u6709\u5982\u4e0b\u8868\u8ff0\uff1a</p>\n<blockquote>\n<p>Each BTB entry includes information for branches and their targets. Each BTB\nentry can hold up to two branches if the last bytes of the branches reside in the same 64-byte aligned\ncache line and the first branch is a conditional branch.</p>\n</blockquote>\n<p>\u8fd9\u548c\u4e0a\u9762\u6240\u8bf4\u7684 B-BTB \u662f\u7c7b\u4f3c\u7684\uff0c\u5982\u679c\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a 64B \u5bf9\u9f50\u7684 cacheline \u5185\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u5206\u652f\u662f\u6761\u4ef6\u5206\u652f\uff0c\u5c31\u53ef\u4ee5\u4fdd\u5b58\u5728\u540c\u4e00\u4e2a BTB entry \u5185\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e00\u4e2a BTB entry \u53ef\u4ee5\u4fdd\u5b58 1 \u5230 2 \u6761\u5206\u652f\u3002</p>\n<p>\u9999\u5c71<a href=\"https://raw.githubusercontent.com/OpenXiangShan/XiangShan-doc/main/slides/20220825-RVSC-%E9%A6%99%E5%B1%B1%E5%A4%84%E7%90%86%E5%99%A8%E5%89%8D%E7%AB%AF%E5%8F%96%E6%8C%87%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B.pdf\">\u5357\u6e56\u5fae\u67b6\u6784</a>\u4e5f\u91c7\u7528\u4e86\u7c7b\u4f3c\u7684<a href=\"https://docs.xiangshan.cc/zh-cn/latest/frontend/bp/\">B-BTB \u8bbe\u8ba1</a>\uff0c\u4e0b\u9762\u662f\u9999\u5c71\u5fae\u67b6\u6784\u6587\u6863\u7684\u622a\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-ftb.png\" /></p>\n<p>\u5982\u679c\u7a0b\u5e8f\u91cc\u6709\u5f88\u591a\u7ecf\u5e38\u6216\u8005\u603b\u662f\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u90a3\u4e48\u4e0a\u9762\u8fd9\u79cd B-BTB \u8bbe\u8ba1\u5c31\u6709\u4e00\u4e9b\u6d6a\u8d39\uff0c\u56e0\u4e3a\u627e\u4e0d\u5230\u5f88\u591a\u6761\u4ef6\u5206\u652f + \u5206\u652f\u7684\u7ec4\u5408\uff0c\u5373\u4f7f\u627e\u5230\u4e86\uff0c\u5982\u679c\u6761\u4ef6\u5206\u652f\u603b\u662f\u8df3\u8f6c\uff0c\u90a3\u4e48\u7b2c\u4e8c\u6761\u5206\u652f\u5c31\u6d6a\u8d39\u4e86\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cAMD \u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/57647.zip\">Software Optimization Guide for the AMD Zen4 Microarchitecture</a> \u4e2d\u63d0\u5230\u4e00\u79cd\u89e3\u51b3\u65b9\u6848\uff1a</p>\n<blockquote>\n<p>Each BTB entry can hold up to two branches, and two pair cases are supported:\n\u2022 A conditional branch followed by another branch with both branches having their last byte in the\nsame 64 byte aligned cacheline.\n\u2022 A direct branch (excluding CALLs) followed by a branch ending within the 64 byte aligned\ncacheline containing the target of the first branch.\nPredicting with BTB pairs allows two fetches to be predicted in one prediction cycle.</p>\n</blockquote>\n<p>\u53ef\u4ee5\u770b\u5230\u7b2c\u4e00\u79cd\u60c5\u51b5\u5c31\u662f\u524d\u9762 Zen 3 \u7684\u6a21\u5f0f\uff0c\u4e00\u4e2a cacheline \u5185\uff0c\u6761\u4ef6\u5206\u652f + \u5206\u652f\uff1b\u7b2c\u4e8c\u79cd\u60c5\u51b5\u5c31\u662f\u65b0\u7684\u8bbe\u8ba1\uff0c\u5b83\u53ef\u4ee5\u8bb0\u5f55\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7b2c\u4e8c\u6761\u5206\u652f\u6307\u4ee4\u548c\u7b2c\u4e00\u6761\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u5728\u540c\u4e00\u4e2a cacheline \u4e2d\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a BTB \u8bb0\u5f55\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7b2c\u4e00\u6761\u8df3\u5230\u7b2c\u4e8c\u6761\uff0c\u7b2c\u4e8c\u6761\u518d\u8df3\u8f6c\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4e00\u4e2a\u5468\u671f\u7ed9\u51fa\u4e24\u4e2a Fetch Bundle\uff0c\u4e5f\u5c31\u662f 2 taken predictions/cycle\u3002\u8bba\u6587\u4e2d\u8fd9\u79cd\u8bbe\u8ba1\u53eb\u505a MB-BTB\u3002</p>\n<p>\u63a8\u8350\u9605\u8bfb\uff1a<a href=\"https://blog.eastonman.com/blog/2023/12/modern-branch-prediction-from-academy-to-industry/\">\u73b0\u4ee3\u5206\u652f\u9884\u6d4b\uff1a\u4ece\u5b66\u672f\u754c\u5230\u5de5\u4e1a\u754c</a></p>\n<h2 id=\"instruction-prefetcher\">Instruction Prefetcher<a class=\"headerlink\" href=\"#instruction-prefetcher\" title=\"Permanent link\">&para;</a></h2>\n<p>\u968f\u7740\u7a0b\u5e8f\u7684\u6307\u4ee4 footprint \u589e\u5927\uff0c\u9664\u4e86\u589e\u5927 L1 ICache \u5bb9\u91cf\uff0c\u4e5f\u9700\u8981\u5b9e\u73b0\u5408\u7406\u7684 Instruction Prefetcher\uff0c\u628a\u6307\u4ee4\u9884\u53d6\u5230 L1 ICache \u5f53\u4e2d\u3002\u5bf9\u4e8e Decoupled Frontend\uff0c\u76ee\u524d\u6bd4\u8f83\u5e38\u89c1\u7684\u65b9\u6cd5\u662f\u4f7f\u7528 <a href=\"https://ieeexplore.ieee.org/document/809439\">Fetch Directed Intruction Prefetching(FDIP)</a>\uff0c\u5229\u7528 Decoupled Frontend \u91cc\u5206\u652f\u9884\u6d4b\u53ef\u4ee5\u5728\u53d6\u6307\u4e4b\u524d\u8dd1\u5f97\u66f4\u8fdc\u7684\u7279\u6027\uff0c\u4f7f\u7528\u5206\u652f\u9884\u6d4b\u7684\u5730\u5740\u6765\u8fdb\u884c\u9884\u53d6\u3002\u5177\u4f53\u5730\uff0cDecoupled Frontend \u4f1a\u628a\u5206\u652f\u9884\u6d4b\u5f97\u5230\u7684\u5730\u5740\u5199\u5165 Fetch Target Queue(FTQ)\uff0c\u8fd9\u4e9b\u5730\u5740\u7531 ICache \u6765\u6d88\u8d39\u3002\u4e0e\u6b64\u540c\u65f6\uff0cFTQ \u4e2d\u7684\u5730\u5740\u4e5f\u4f1a\u7528\u4e8e\u6307\u4ee4\u9884\u53d6\uff0c\u7ed3\u6784\u5982\u8bba\u6587\u4e2d\u7684\u56fe 1\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-fdip.png\" /></p>\n<p>\u5bf9\u4e8e Coupled Frontend\uff0c\u9884\u6d4b\u548c\u53d6\u6307\u7d27\u5bc6\u76f8\u8fde\uff0cFDIP \u7684\u65b9\u6cd5\u5c31\u4e0d\u597d\u7528\u4e86\uff0c\u9700\u8981\u5bfb\u627e\u5176\u4ed6\u7684\u65b9\u6cd5\u3002</p>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f Call Graph Prefetching(CGP)\uff0c\u6765\u81ea\u8bba\u6587 <a href=\"https://ieeexplore.ieee.org/abstract/document/903270\">Call graph prefetching for database applications</a>\u3002\u4ece\u540d\u5b57\u4e5f\u53ef\u4ee5\u770b\u51fa\uff0c\u5b83\u9488\u5bf9\u7684\u662f\u6570\u636e\u5e93\u573a\u666f\uff0c\u800c\u8fd9\u4e2a\u573a\u666f\u4e0b\uff0c\u4ee3\u7801\u7684\u89c4\u6a21\u5f88\u5927\uff0c\u66f4\u52a0\u5bb9\u6613\u51fa\u73b0 ICache Miss\u3002</p>\n<p>\u5b83\u7684\u6838\u5fc3\u601d\u8def\u662f\uff0c\u7ef4\u62a4\u4e00\u4e2a Call Graph History Cache(CGHC) \u6765\u8bb0\u5f55\u7a0b\u5e8f\u6267\u884c\u7684\u8c03\u7528\u56fe\uff0c\u6839\u636e\u5386\u53f2\u4fe1\u606f\u6765\u9884\u53d6\u672a\u6765\u53ef\u80fd\u4f1a\u6267\u884c\u7684\u51fd\u6570\u7684\u6307\u4ee4\uff0c\u8fd9\u9488\u5bf9\u7684\u662f\u9891\u7e41\u7684\u51fd\u6570\u8c03\u7528\uff1b\u9488\u5bf9\u51fd\u6570\u4f53\u6bd4\u8f83\u5927\u7684\u60c5\u51b5\uff0c\u51fd\u6570\u8c03\u7528\u7684\u6bd4\u4f8b\u6bd4\u8f83\u5c0f\uff0c\u5229\u7528 Next N-Line Prefetching\uff0c\u4e5f\u5c31\u662f\u5728 miss \u7684\u65f6\u5019\u628a\u8fde\u7eed\u7684\u51e0\u6761\u7f13\u5b58\u884c\u9884\u53d6\u8fdb\u6765\u3002</p>\n<p>\u90a3\u4e48\u8fd9\u4e2a Call Graph History Cache \u662f\u600e\u4e48\u7ef4\u62a4\u51fd\u6570\u8c03\u7528\u7684\u5462\uff1f\u5b83\u8bb0\u5f55\u4e86\u4e24\u4e2a Array\uff1aTag Array \u548c Data Array\u3002Tag Array \u8bb0\u5f55\u7684\u662f\u51fd\u6570\u7684\u5165\u53e3\u5730\u5740\uff0c\u4ee5\u53ca\u5728\u8fd9\u4e2a\u51fd\u6570\u5185\u6267\u884c\u5230\u4e86\u7b2c\u51e0\u4e2a\u51fd\u6570\uff08Index\uff09\uff1bData Array \u5219\u8bb0\u5f55\u4e86\u88ab\u8be5\u51fd\u6570\u8c03\u7528\u7684\u51fd\u6570\u7684\u5165\u53e3\u5730\u5740\uff0c\u6700\u591a\u516b\u4e2a\u3002\u4f8b\u5982\u51fd\u6570 A \u4f1a\u8c03\u7528\u51fd\u6570 B \u548c C\uff0c\u90a3\u4e48 CGHC \u4f1a\u4fdd\u5b58\u8fd9\u4e48\u4e00\u6761\u8bb0\u5f55\uff1a</p>\n<ul>\n<li>Tag Array\uff1a\u8bb0\u5f55\u51fd\u6570 A \u7684\u5165\u53e3\u5730\u5740\u4ee5\u53ca Index\uff0cIndex \u521d\u59cb\u5316\u4e3a 1</li>\n<li>Data Array\uff1a\u8bb0\u5f55\u51fd\u6570 B \u548c C \u7684\u5730\u5740</li>\n</ul>\n<p>\u5f53\u524d\u7aef\u901a\u8fc7\u5206\u652f\u9884\u6d4b\uff0c\u9884\u6d4b\u5230\u8981\u6267\u884c\u51fd\u6570 A\uff0c\u90a3\u4e48\u5c31\u901a\u8fc7 A \u7684\u5730\u5740\u53bb\u67e5\u8be2 Tag Array\uff0c\u627e\u5230\u5339\u914d\uff0c\u5e76\u4e14\u53d1\u73b0\u5176 Index \u7b49\u4e8e 1\uff1b\u90a3\u4e48\u63a5\u7740\u7528 Index \u8bbf\u95ee Data Array\uff0c\u53d6\u51fa\u7b2c\u4e00\u4e2a\u51fd\u6570\u7684\u5730\u5740\uff0c\u4e5f\u5c31\u662f B\uff0c\u90a3\u5c31\u9884\u53d6 B\u3002\u5f53\u51fd\u6570 B \u88ab\u8c03\u7528\u7684\u65f6\u5019\uff0c\u66f4\u65b0 Index \u4e3a 2\uff0c\u8868\u793a\u51fd\u6570 B \u5df2\u7ecf\u88ab\u8c03\u7528\uff0c\u4e0b\u4e00\u4e2a\u8981\u88ab\u8c03\u7528\u7684\u662f C\u3002\u5f53\u51fd\u6570 B \u8fd4\u56de\u7684\u65f6\u5019\uff0c\u7528 Index \u8bbf\u95ee Data Array\uff0c\u5f97\u5230\u51fd\u6570 C \u7684\u5730\u5740\uff0c\u9884\u53d6 C\u3002\u5982\u679c\u8bf4 Call Graph \u662f\u4e2a\u56fe\uff0c\u90a3\u4e48 Tag Array \u548c Data Array \u5c31\u7ec4\u6210\u4e86\u90bb\u63a5\u8868\u3002</p>\n<p>\u82f9\u679c\u7684\u4e13\u5229 <a href=\"https://patentimages.storage.googleapis.com/4d/f2/31/acf69ce6f289ff/US10642618.pdf\">Callgraph Signature Prefetch</a> \u4f7f\u7528\u4e86\u7c7b\u4f3c\u7684\u601d\u60f3\uff0c\u4e0d\u8fc7\u5728\u7ef4\u62a4 Call Graph \u7684\u65b9\u5f0f\u4e0a\u4e0d\u540c\uff1a\u4e0a\u9762\u7684\u8bba\u6587\u662f\u901a\u8fc7\u663e\u5f0f\u7684\u65b9\u6cd5\u8bb0\u5f55 Call Graph\uff0c\u6bcf\u4e2a\u51fd\u6570\u8c03\u7528\u4e86\u54ea\u4e9b\u51fd\u6570\uff0c\u800c\u4e13\u5229\u4e2d\uff0c\u53c2\u8003\u4e86\u5206\u652f\u9884\u6d4b\u8bb0\u5f55\u5206\u652f\u5386\u53f2\u7684\u65b9\u6cd5\uff0c\u628a\u6700\u8fd1\u7684 call \u548c return \u5730\u5740\u538b\u7f29\u8bb0\u5f55\u4e0b\u6765\uff0c\u901a\u8fc7 hash \u5f97\u5230 Signature\uff0c\u518d\u7528 Signature \u53bb\u67e5\u8be2 Prefetch Table\uff0c\u76f8\u5f53\u4e8e\u5728\u62ff\u6700\u8fd1\u82e5\u5e72\u6b21\u8c03\u7528\u548c\u8fd4\u56de\u7684\u5386\u53f2\u6765\u9884\u6d4b\u4e0b\u4e00\u6b21 call \u7684\u5730\u5740\u3002Prefetch Table \u7684\u6bcf\u4e2a Entry \u8bb0\u5f55\u4e86\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Signature\uff1a\u8bb0\u5f55\u4e86\u8fd9\u4e2a Entry \u5bf9\u5e94\u7684 Signature\uff0c\u5373\u6700\u8fd1\u51fd\u6570\u8c03\u7528\u7684\u538b\u7f29\u8868\u793a\uff1b\u5b9e\u9645\u53ef\u80fd\u5b9e\u73b0\u4e3a\u5168\u76f8\u8fde\uff0c\u4e5f\u53ef\u80fd\u662f\u7ec4\u76f8\u8fde\uff0c\u901a\u8fc7 tag \u5339\u914d</li>\n<li>Address\uff1a\u8981\u9884\u53d6\u7684\u6307\u4ee4\u5730\u5740\uff1b\u4e13\u5229\u4e2d\u8fd8\u8c08\u5230\u4e86 Address \u7684\u538b\u7f29\uff0c\u5373\u628a Address \u7684\u9ad8\u4f4d\u5355\u72ec\u5b58\u653e\u5728\u4e00\u4e2a Address Table \u4e2d\uff0c\u90a3\u4e48 Prefetch Table \u7684 Entry \u8bb0\u5f55\u4e86 Address Table \u7684 Index \u4ee5\u53ca\u4f4e\u4f4d Offset\uff0c\u9700\u8981\u9884\u53d6\u65f6\uff0c\u518d\u4ece Address Table \u8bfb\u53d6\u9ad8\u4f4d\uff0c\u62fc\u63a5\u8d77\u6765</li>\n<li>Counter\uff1a\u7ed9\u4ece Address \u5f00\u59cb\u7684\u82e5\u5e72\u4e2a\u7f13\u5b58\u884c\u7ef4\u62a4 Saturating Counter\uff0c\u7528\u6765\u5224\u65ad\u662f\u5426\u8981\u8fdb\u884c\u9884\u53d6</li>\n<li>Order\uff1a\u7528\u6765\u7ef4\u62a4 Replacement Policy \u6240\u9700\u8981\u7684\u4fe1\u606f</li>\n</ul>\n<p>\u90a3\u4e48\u524d\u7aef\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff0c\u6839\u636e\u5206\u652f\u9884\u6d4b\u53bb\u66f4\u65b0 Signature\uff0c\u6839\u636e Signature \u67e5\u8be2 Prefetch Table\uff0c\u5982\u679c\u6709\u547d\u4e2d\uff0c\u6839\u636e Counter \u7684\u5927\u5c0f\u51b3\u5b9a\u662f\u5426\u8981\u9884\u53d6\uff0c\u4ece Address \u5f00\u59cb\u9884\u53d6\u54ea\u4e9b\u6570\u636e\u3002</p>\n<h2 id=\"championship-branch-prediction\">Championship Branch Prediction<a class=\"headerlink\" href=\"#championship-branch-prediction\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9488\u5bf9\u5206\u652f\u65b9\u5411\u9884\u6d4b\uff0c\u66fe\u7ecf\u529e\u8fc7 5 \u5c4a\u7684 Championship Branch Prediction \u7ade\u8d5b\uff0c\u6700\u540e\u4e00\u6b21\u662f 2016 \u5e74\u7684 CBP-5\uff0c\u7f51\u7ad9\u662f <a href=\"https://jilp.org/cbp2016/\">Championship Branch Prediction (CBP-5)</a>\u3002\u5176\u6587\u4ef6\u53ef\u4ee5\u4ece\u4e0b\u5217\u5730\u5740\u5f97\u5230\uff1a</p>\n<ul>\n<li>https://web.archive.org/web/20220814115014/http://hpca23.cse.tamu.edu/cbp2016/cbp2016.final.tar.gz</li>\n<li>https://web.archive.org/web/20190907061905/http://hpca23.cse.tamu.edu/cbp2016/MD5SUM.txt</li>\n<li>https://drive.google.com/drive/folders/1VAdmqdOEFLvnRKkQQidxvGJA_C6S2RWo \u6765\u81ea https://github.com/craymichael/CBP-16-Simulation</li>\n</ul>\n<p>\u540e\u7eed\u8fd8\u6709\u4e00\u4e9b\u8bba\u6587\u4e5f\u662f\u5728 CBP2016 \u7684\u73af\u5883\u4e0b\u8fdb\u884c\u7684\u6d4b\u8bd5\u3002</p>", "image": null, "date_published": "2024-09-12T00:00:00+00:00", "authors": [], "tags": ["bp", "brief-into-ooo", "cpu", "frontend", "hardware", "ooo", "prediction"]}, {"id": "https://jia.je/hardware/2024/09/10/samsung-exynos-cpu/", "url": "https://jia.je/hardware/2024/09/10/samsung-exynos-cpu/", "title": "\u4e09\u661f Exynos CPU \u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0", "content_html": "<h1 id=\"\u4e09\u661f-exynos-cpu-\u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0\">\u4e09\u661f Exynos CPU \u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0<a class=\"headerlink\" href=\"#\u4e09\u661f-exynos-cpu-\u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ISCA 2020 \u7684\u4e00\u7bc7\u6587\u7ae0 <a href=\"https://ieeexplore.ieee.org/document/9138988\">Evolution of the Samsung Exynos CPU Microarchitecture</a> \u975e\u5e38\u8be6\u7ec6\u5730\u89e3\u6790\u4e86\u4e09\u661f Exynos \u81ea\u7814 CPU \u5fae\u67b6\u6784\u7684\u6f14\u8fdb\u5386\u53f2\u3002\u672c\u6587\u662f\u5bf9\u8fd9\u7bc7\u8bba\u6587\u7684\u5b66\u4e60\u548c\u6574\u7406\u7684\u7b14\u8bb0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5206\u652f\u9884\u6d4b\u5668\">\u5206\u652f\u9884\u6d4b\u5668<a class=\"headerlink\" href=\"#\u5206\u652f\u9884\u6d4b\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6587\u7ae0 Chapter IV \u8bb2\u8ff0\u4e86 Exynos \u7cfb\u5217\u5fae\u67b6\u6784\u7684\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u73b0\u3002Exynos \u5fae\u67b6\u6784\u7528\u7684\u662f <a href=\"https://ieeexplore.ieee.org/document/903263\">Scaled Hashed Perceptron</a> \u5206\u652f\u65b9\u5411\u9884\u6d4b\u5668\uff0c\u8fd9\u4e2a\u5206\u652f\u9884\u6d4b\u5668\u7684\u63d0\u51fa\u8005 Daniel A. Jim\u00e9nez \u4e5f\u5728\u8fd9\u7bc7\u8bba\u6587\u7684\u4f5c\u8005\u5217\u8868\u4e2d\u3002\u73b0\u5728\u91c7\u7528\u57fa\u4e8e Perceptron \u7684\u5206\u652f\u9884\u6d4b\u5668\u7684\u5904\u7406\u5668\u4e0d\u591a\uff0cAMD \u7684 Zen 1 \u7528\u4e86\uff0cZen 2 \u662f Perceptron \u52a0 TAGE\uff0cZen 3 \u4ee5\u540e\u5c31\u53ea\u6709 TAGE \u4e86\u3002</p>\n<p>\u9664\u4e86\u65b9\u5411\u9884\u6d4b\u5668\uff0c\u8fd8\u9700\u8981\u6709 BTB \u6765\u8bc6\u522b\u5206\u652f\u4ee5\u53ca\u8bb0\u5f55\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u3002\u4e3a\u4e86\u6027\u80fd\uff0c\u6bcf\u4e2a\u5468\u671f\u90fd\u8981\u9884\u6d4b\u81f3\u5c11\u4e00\u4e2a\u5206\u652f\uff0c\u6240\u4ee5\u4e00\u822c\u4f1a\u6709\u4e00\u4e2a 0-bubble \u7684 BTB\uff0c\u5728\u8fd9\u91cc\u53eb uBTB\uff08microBTB\uff0c\u7528 u \u4ee3\u66ff\u5e0c\u814a\u5b57\u6bcd \u03bc\uff09\u3002\u4f46\u4e5f\u56e0\u4e3a\u65f6\u5e8f\u7684\u9650\u5236\uff0c\u4e0d\u4f1a\u505a\u7684\u592a\u5927\u3002\u4e3a\u4e86\u652f\u6301\u6709\u66f4\u5927\u7684\u5bb9\u91cf\uff0c\u901a\u5e38\u8fd8\u4f1a\u6709\u66f4\u5927\u7684\uff0c\u5ef6\u8fdf\u4e5f\u66f4\u957f\u7684 BTB\uff0c\u5728\u8fd9\u91cc\u53eb mBTB\uff08Main BTB\uff09\uff0c\u6700\u5927\u7684\u662f L2 BTB\uff0c\u8fd8\u6709\u540e\u9762\u4f1a\u8bb2\u5230\u5904\u7406\u8fb9\u754c\u60c5\u51b5\u7684 vBTB\u3002\u540c\u7406\uff0c\u5206\u652f\u9884\u6d4b\u5668\u4e5f\u6709\u5bb9\u91cf\u548c\u5ef6\u8fdf\u7684\u53cc\u91cd\u8003\u8651\uff0c\u8bbe\u7f6e\u4e0d\u540c\u5927\u5c0f\u548c\u5bb9\u91cf\u7684\u5206\u652f\u9884\u6d4b\u5668\uff0c\u4e5f\u53ef\u80fd\u4f1a\u5206\u591a\u7ea7\uff0c\u548c 0-bubble uBTB \u914d\u5bf9\u7684 LHP\uff08Local History Perception\uff09\u4ee5\u53ca 1-2 bubble mBTB \u914d\u5bf9\u7684\u5b8c\u6574\u7684 SHP\uff08Scaled Hashed Perception\uff09\u3002\u6b64\u5916\u8fd8\u6709 RAS\uff08Return Address Stack\uff09\u8d1f\u8d23\u51fd\u6570\u8fd4\u56de\u5730\u5740\u7684\u9884\u6d4b\u3002</p>\n<p>\u9996\u5148\u4ece Exynos \u6700\u65e9\u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u5f00\u59cb\u3002\u4e00\u5f00\u59cb\u8bbe\u8ba1\u7684\u65f6\u5019\uff0c\u5c31\u8003\u8651\u5230\u8981\u652f\u6301 2 prediction/clock \u7684\u573a\u666f\uff0c\u524d\u63d0\u662f\u7b2c\u4e00\u4e2a\u5206\u652f\u662f not taken \u7684\u3002\u4f8b\u5982\u6709\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7b2c\u4e00\u6761\u662f\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5982\u679c\u7b2c\u4e00\u6761\u5206\u652f taken\uff0c\u90a3\u5c31\u4ee5\u7b2c\u4e00\u6761\u5206\u652f\u7684\u7ed3\u679c\u4e3a\u51c6\uff1b\u5982\u679c\u7b2c\u4e00\u6761\u5206\u652f not taken\uff0c\u90a3\u5c31\u5e94\u8be5\u4ee5\u7b2c\u4e8c\u6761\u5206\u652f\u7684\u7ed3\u679c\u4e3a\u51c6\u3002\u8fd9\u6837\u53ef\u4ee5\u5728\u6bd4\u8f83\u4f4e\u7684\u5f00\u9500\u7684\u524d\u63d0\u4e0b\uff0c\u4e00\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u63d0\u9ad8\u5206\u652f\u9884\u6d4b\u7684\u6027\u80fd\uff0c\u5982\u679c\u4e0d\u505a\u8fd9\u4e2a\u4f18\u5316\u7684\u8bdd\uff0c\u9700\u8981\u5148\u9884\u6d4b\u7b2c\u4e00\u6761\u5206\u652f\uff0c\u9884\u6d4b\u5b8c\uff0c\u518d\u53bb\u9884\u6d4b\u7b2c\u4e8c\u6761\u5206\u652f\u3002\u8bba\u6587\u4e2d\u6307\u51fa\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u9700\u8981\u9884\u6d4b 2 \u4e2a\u5206\u652f\u7684\u573a\u666f\uff0c\u6709 60% \u7684\u60c5\u51b5\u662f\u7b2c\u4e00\u6761\u5206\u652f taken\uff0c24% \u60c5\u51b5\u662f\u7b2c\u4e00\u6761\u5206\u652f not taken \u5e76\u4e14\u7b2c\u4e8c\u6761\u5206\u652f taken\uff0c\u4e24\u4e2a\u90fd not taken \u7684\u60c5\u51b5\u5360 16%\u3002\u90a3\u4e48\u540e 40% \u7684\u60c5\u51b5\u5c31\u53ef\u4ee5\u5f97\u5230\u6027\u80fd\u63d0\u5347\u3002\u8fd9\u4e2a\u4f18\u5316\u8fd8\u662f\u633a\u5e38\u89c1\u7684\uff0c\u4f8b\u5982<a href=\"https://raw.githubusercontent.com/OpenXiangShan/XiangShan-doc/main/slides/20220825-RVSC-%E9%A6%99%E5%B1%B1%E5%A4%84%E7%90%86%E5%99%A8%E5%89%8D%E7%AB%AF%E5%8F%96%E6%8C%87%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B.pdf\">\u9999\u5c71\u5357\u6e56\u67b6\u6784</a>\u505a\u4e86\u8fd9\u4e2a\u4f18\u5316\uff0c\u800c\u4e14\u867d\u7136\u53ef\u4ee5 2 predictions/cycle\uff0c\u4f46\u5b9e\u9645\u4e0a\u53ea\u6709\u4e00\u4e2a Fetch Packet\uff0c\u4e5f\u6700\u591a 1 taken prediction/cycle\u3002</p>\n<p>SHP\uff0c\u4e5f\u5c31\u662f\u90a3\u4e2a\u6700\u5927\u7684 Perceptron \u9884\u6d4b\u5668\uff0c\u5305\u542b\u4e86 8 \u4e2a\u8868\uff0c\u6bcf\u4e2a\u8868\u6709 1024 \u4e2a\u6743\u91cd\uff0c\u6bcf\u4e2a BTB \u8868\u9879\u8fd8\u7ed9\u6bcf\u4e2a\u5206\u652f\u8bb0\u5f55\u4e86\u4e00\u4e2a bias\u3002\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u6839\u636e GHR\uff08\u6839\u636e\u5206\u652f taken/not taken \u5386\u53f2\uff09\u548c PHR\uff08\u6839\u636e taken branch \u5730\u5740\uff09\u4ee5\u53ca\u5206\u652f\u7684 PC \u7ecf\u8fc7\u54c8\u5e0c\uff0c\u5f97\u5230 table \u7684 index\uff0c\u6839\u636e index \u53bb\u8bbf\u95ee\u6743\u91cd\u3002\u628a\u4ece 8 \u4e2a\u8868\u91cc\u8bfb\u51fa\u6765\u7684\u6743\u91cd\u52a0\u8d77\u6765\uff0c\u518d\u52a0\u4e0a bias \u7684\u4e24\u500d\uff0c\u5f97\u5230\u6700\u65e9\u7684\u8ba1\u7b97\u7ed3\u679c\uff0c\u5982\u679c\u662f\u975e\u8d1f\u6570\uff0c\u5219\u9884\u6d4b\u4e3a taken\uff1b\u8d1f\u6570\u5219\u9884\u6d4b\u4e3a not taken\u3002</p>\n<p>\u77e5\u9053\u5206\u652f\u7684\u5b9e\u9645\u8df3\u8f6c\u65b9\u5411\u540e\uff0c\u5982\u679c\u9884\u6d4b\u9519\u8bef\u4e86\uff0c\u6216\u8005\u9884\u6d4b\u5bf9\u4e86\uff0c\u4f46\u662f\u8ba1\u7b97\u7ed3\u679c\u592a\u63a5\u8fd1 0\uff0c\u5c31\u9700\u8981\u66f4\u65b0 weight\u3002\u66f4\u65b0\u65f6\uff0c\u4f1a\u66f4\u65b0\u53c2\u4e0e\u5230\u8ba1\u7b97\u7684\u6765\u81ea\u5404\u4e2a\u8868\u7684 weight\uff0c\u5982\u679c\u662f taken\uff0c\u90a3\u5c31\u589e\u52a0 weight\uff1b\u5982\u679c\u662f not taken\uff0c\u5c31\u51cf\u5c11 weight\u3002Exynos M1 \u91c7\u7528\u4e86 165 \u4f4d\u7684 GHR\uff0c\u4e5f\u5c31\u662f\u6700\u8fd1 165 \u6761\u6761\u4ef6\u5206\u652f\u7684\u8df3\u8f6c\u65b9\u5411\uff0c\u4ee5\u53ca 80 \u4f4d\u7684 PHR\uff0c\u6bcf\u4e2a taken branch \u4f1a\u5411 PHR \u8d21\u732e 3 \u4e2a bit\uff08B[4:2]\uff09\uff0c\u4f46\u662f\u6ca1\u8bf4\u79fb\u4f4d\u591a\u5c11\u3002\u8fd9\u6837\u5c31\u6784\u6210\u4e86\u4e00\u4e2a Perceptron \u9884\u6d4b\u5668\u3002</p>\n<p>\u7279\u522b\u5730\uff0c\u9488\u5bf9\u603b\u662f\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u4f8b\u5982\u65e0\u6761\u4ef6\u8df3\u8f6c\u5206\u652f\uff0c\u6216\u8005\u603b\u662f\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\uff0c\u5c31\u4e0d\u7528\u66f4\u65b0 SHP \u4e86\uff0c\u4ed6\u4eec\u53ea\u9700\u8981\u5728 BTB \u4e2d\u6807\u8bb0\u4e00\u4e0b\u5373\u53ef\uff0c\u907f\u514d\u6c61\u67d3 SHP\uff0c\u5e72\u6270\u5176\u4ed6\u5206\u652f\u7684\u9884\u6d4b\u3002\u7c7b\u4f3c\u7684\u601d\u8def\u4e5f\u633a\u5e38\u89c1\u7684\uff0cAMD \u7684\u505a\u6cd5\u662f\uff0c\u5bf9\u4e8e\u4ece\u6765\u6ca1\u6709\u8df3\u8f6c\u8fc7\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u4e0d\u5206\u914d BTB \u8868\u9879\uff0c\u5e76\u4e14\u9884\u6d4b\u4e3a\u4e0d\u8df3\u8f6c\uff1b\u5f53\u6761\u4ef6\u5206\u652f\u4e86\u8df3\u8f6c\u7b2c\u4e00\u6b21\uff0c\u90a3\u5c31\u4f1a\u5728 BTB \u4e2d\u5206\u914d\u8868\u9879\uff0c\u6807\u8bb0\u4e3a always taken\uff0c\u8868\u793a\u9884\u6d4b\u4e3a\u603b\u662f\u8df3\u8f6c\uff1b\u5f53\u6761\u4ef6\u5206\u652f\u8df3\u8f6c\u548c\u4e0d\u8df3\u8f6c\u5404\u81f3\u5c11\u4e00\u6b21\uff0c\u624d\u542f\u7528\u5206\u652f\u65b9\u5411\u9884\u6d4b\u5668\u3002</p>\n<p>\u63a5\u4e0b\u6765\u662f BTB\u3002mBTB\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684\u6709 1-2 bubble \u7684\u7565\u5fae\u5927\u4e00\u4e9b\u7684 BTB\uff0c\u53ef\u4ee5\u7ed9 128B \u5927\u5c0f\u7684 cacheline \u4fdd\u5b58 8 \u6761\u5206\u652f\u6307\u4ee4\u3002\u7edf\u8ba1\u6570\u636e\u8868\u793a\uff0c\u5e73\u5747\u6bcf 5 \u6761\u6307\u4ee4\u6709\u4e00\u6761\u662f\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48 128B \u5728 4 \u5b57\u8282\u5b9a\u957f\u6307\u4ee4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u5b58 32 \u6761\u6307\u4ee4\uff0c\u4f30\u7b97\u5f97\u5230\u5927\u7ea6\u6709 6-7 \u6761\u5206\u652f\u6307\u4ee4\uff0c\u6240\u4ee5\u8bbe\u8ba1\u4e86\u53ef\u4ee5\u5b58 8 \u6761\u3002\u4f46\u4e5f\u6709\u53ef\u80fd\u5206\u652f\u5bc6\u5ea6\u5f88\u9ad8\uff0c128B \u5168\u662f\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u5c31\u4f1a\u6709 32 \u6761\u5206\u652f\u6307\u4ee4\u4e86\u3002</p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u8bbe\u8ba1\u4e86 vBTB\uff08virtual indexed BTB\uff09\uff0c\u53ef\u4ee5\u628a 128B \u7684 cacheline \u91cc\u8d85\u8fc7 8 \u4e2a branch \u7684\u591a\u4f59\u90e8\u5206\u4fdd\u5b58\u4e0b\u6765\uff0c\u5f53\u7136\u4e86\uff0c\u4f1a\u6709\u989d\u5916\u7684\u5f00\u9500\u3002</p>\n<p>\u6bd4\u8f83\u7279\u522b\u7684\u662f\uff0c\u6ca1\u6709\u8bbe\u8ba1\u5355\u72ec\u7684\u4f8b\u5982 ITTAGE \u90a3\u6837\u7684 Indirect Predictor\uff0c\u800c\u662f\u91c7\u7528\u4e86\u53eb\u505a VPC\uff08Virtual PC\uff09\u7684\u65b9\u6848\uff0c\u5b83\u7684\u601d\u8def\u662f\uff0c\u590d\u7528\u65b9\u5411\u9884\u6d4b\u5668\u548c BTB \u7684\u80fd\u529b\uff0c\u628a\u4e00\u6761 Indirect Branch \u6620\u5c04\u4e3a\u591a\u6761 Conditional Branch\uff0c\u6bcf\u4e2a Conditional Branch \u7684 Target \u5bf9\u5e94\u4e00\u4e2a\u53ef\u80fd\u7684 Indirect Branch Target\uff0c\u8fd9\u4e2a Target \u5c31\u5b58\u5728 BTB \u5f53\u4e2d\u3002\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u6309\u7167\u987a\u5e8f\u904d\u5386\u6bcf\u4e2a\u865a\u62df\u7684 Conditional Branch\uff0c\u5982\u679c\u9884\u6d4b\u4e3a taken\uff0c\u90a3\u5c31\u8df3\u8f6c\u5230\u8fd9\u4e2a\u865a\u62df\u7684\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\uff1b\u5982\u679c\u9884\u6d4b\u4e3a not taken\uff0c\u90a3\u5c31\u904d\u5386\u5230\u4e0b\u4e00\u4e2a\u865a\u62df\u7684\u5206\u652f\u3002\u5982\u679c\u6240\u6709\u7684\u865a\u62df\u6761\u4ef6\u5206\u652f\u90fd\u88ab\u9884\u6d4b\u4e3a\u4e0d\u8df3\u8f6c\uff0c\u90a3\u5c31\u9700\u8981\u7b49\u5230\u540e\u7aef\u8ba1\u7b97\u51fa\u5b9e\u9645\u7684\u76ee\u7684\u5730\u5740\uff0c\u518d\u8df3\u8f6c\u3002\u5bf9\u4e8e\u6bcf\u4e2a Indirect Branch\uff0c\u8fd9\u6837\u7684\u865a\u62df\u6761\u4ef6\u5206\u652f\u6700\u591a\u751f\u6210 16 \u4e2a\u3002</p>\n<p>\u8fd9\u4e9b\u865a\u62df\u7684\u6761\u4ef6\u5206\u652f\u65e2\u7136\u8981\u5229\u7528 BTB \u7684\u7a7a\u95f4\uff0c\u81ea\u7136\u4e5f\u4f1a\u62a2\u5360 128B cacheline \u6700\u591a 8 \u6761\u5206\u652f\u7684\u9650\u5236\uff0c\u591a\u4f59\u7684\u5206\u652f\u6216\u8005 Indirect Branch \u751f\u6210\u7684\u865a\u62df\u6761\u4ef6\u5206\u652f\u4e5f\u4f1a\u6ea2\u51fa\u5230 vBTB \u5185\u3002\u8fd9\u79cd\u8bbe\u8ba1\u8fd8\u662f\u7b2c\u4e00\u6b21\u89c1\u3002</p>\n<p>\u7531\u4e8e\u8fd9\u4e2a\u521d\u59cb\u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u53ea\u6709\u4e00\u4e2a main BTB\uff0c\u9700\u8981 2 bubble \u624d\u80fd\u51fa\u4e00\u4e2a taken branch\uff0c\u5728 taken branch \u5f88\u5bc6\u96c6\u7684\u65f6\u5019\uff0c\u5c31\u9700\u8981\u4e09\u4e2a\u5468\u671f\u4e00\u4e2a taken branch \u4e86\uff0c\u8fd9\u6027\u80fd\u80af\u5b9a\u4e0d\u591f\u597d\u3002\u6240\u4ee5 Exynos M1 \u5f15\u5165\u4e86 0-bubble \u7684 uBTB\uff0c\u5bb9\u91cf\u6bd4\u8f83\u5c0f\uff0c\u597d\u5904\u662f\u5feb\uff0c\u4e00\u822c\u8fd9\u79cd 0-bubble BTB \u4e5f\u53ef\u4ee5\u53eb\u505a Next Line Predictor\uff0c\u9884\u6d4b\u4e0b\u4e00\u4e2a\u5468\u671f\u7684 Fetch \u5730\u5740\u3002</p>\n<p>\u4e3a\u4e86\u5b9e\u73b0 0-bubble \u7684 uBTB\uff0cExynos M1 \u7528\u4e86\u4e00\u4e2a\u57fa\u4e8e\u56fe\u7684\u7ed3\u6784\u6765\u8bb0\u5f55\u5206\u652f\u4e4b\u95f4\u7684\u8df3\u8f6c\u5173\u7cfb\uff0c\u914d\u5408\u4e00\u4e2a\u8bb0\u5f55\u5206\u652f\u5c40\u90e8\u5386\u53f2\u7684 Hashed Perceptron \u7b97\u6cd5\u6765\u9884\u6d4b\u65b9\u5411\u3002\u8fd9\u4e2a\u9884\u6d4b\u7b97\u6cd5\u4e5f\u662f\u7b2c\u4e00\u6b21\u89c1\uff0c\u5728\u4e09\u661f\u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US20170068539A1/en\">High performance zero bubble conditional branch prediction using micro branch target buffer </a> \u4e2d\u63d0\u51fa\uff0c\u5927\u9898\u601d\u8def\u5176\u5b9e\u5c31\u662f\u628a\u57fa\u672c\u5757\u5b66\u4e60\u51fa\u6765\uff0c\u627e\u5230\u5206\u652f\u4e4b\u95f4 taken \u548c not taken \u7684\u5173\u7cfb\uff0c\u4ee5\u6bcf\u4e2a\u5206\u652f\u4e3a\u4e00\u4e2a\u7ed3\u70b9\uff0c\u5982\u679c\u4e00\u4e2a\u5206\u652f taken \u4ee5\u540e\u4f1a\u5230\u53e6\u4e00\u4e2a\u5206\u652f\uff0c\u90a3\u5c31\u5728\u8fd9\u4e24\u4e2a\u5206\u652f\u5bf9\u5e94\u7684\u7ed3\u70b9\u4e4b\u95f4\u8fde\u4e00\u6761 taken \u7684\u6709\u5411\u8fb9\uff0c\u7c7b\u4f3c\u5730\uff0cnot taken \u4e5f\u4f1a\u8fde not taken \u7684\u6709\u5411\u8fb9\u3002</p>\n<p>\u6709\u4e86\u56fe\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u56fe\u4e2d\u77e5\u9053\u4e0b\u4e00\u4e2a\u4f1a\u5230\u8fbe\u7684\u5206\u652f\u5728\u54ea\u91cc\uff0c\u5373\u4f7f\u8fd9\u4e2a\u5206\u652f\u53ef\u80fd\u8ddd\u79bb\u5f88\u8fdc\uff1b\u800c\u5e38\u89c4\u7684 BTB \u8bbe\u8ba1\u91cc\uff0c\u5219\u662f\u62ff\u5230\u5730\u5740\u4ee5\u540e\uff0c\u7528\u5730\u5740\u53bb\u5bfb\u627e\u5339\u914d\u7684 BTB entry\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f1a\u626b\u63cf\u5230\u4e00\u4e9b\u4e0d\u5b58\u5728\u5206\u652f\u6307\u4ee4\u7684\u4ee3\u7801\u5757\u3002\u8fd9\u91cc\u4e5f\u652f\u6301\u524d\u9762\u8bf4\u7684\u8fde\u7eed\u4e24\u4e2a\u5206\u652f\u540c\u65f6\u9884\u6d4b\u7684\u60c5\u51b5\uff0c\u5728\u540c\u4e00\u4e2a\u5468\u671f\u5185\u9884\u6d4b\u4e24\u4e2a\u5206\u652f\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5206\u652f\u4e0d\u8df3\uff0c\u5c31\u7528\u7b2c\u4e8c\u4e2a\u5206\u652f\u7684\u7ed3\u679c\uff0c\u5728\u6811\u4e0a\u8f6c\u79fb\u3002\u4e3a\u4e86\u7701\u7535\uff0c\u5f53 uBTB \u9884\u6d4b\u51c6\u786e\u7387\u8f83\u9ad8\uff0c\u56fe\u8bb0\u5f55\u4e86\u6700\u8fd1\u6267\u884c\u7684\u6240\u6709\u5206\u652f\uff0c\u90a3\u4e48 uBTB \u5c31\u53ef\u4ee5\u706b\u529b\u5168\u5f00\uff0c\u4fdd\u6301 0-bubble \u7684\u9884\u6d4b\uff0c\u8fd9\u4e2a\u9884\u6d4b\u5728\u540e\u9762\u7684\u6d41\u6c34\u7ebf\u4e2d\u4f1a\u88ab mBTB \u548c SHP \u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u786e\u8ba4\u3002\u5982\u679c\u51c6\u786e\u7387\u7279\u522b\u9ad8\uff0c\u8ba4\u4e3a mBTB \u548c SHP \u5927\u6982\u7387\u4e5f\u4f1a\u5f97\u5230\u76f8\u540c\u7684\u9884\u6d4b\u7ed3\u679c\uff0c\u5c31\u4f1a\u8fdb\u4e00\u6b65\u505c\u6b62 mBTB \u548c SHP \u7684\u4f7f\u7528\uff0c\u964d\u4f4e\u529f\u8017\uff0c\u8fd9\u65f6\u5019\u5c31\u8981\u9760\u540e\u7aef\u7684 Branch Unit \u6765\u68c0\u67e5\u9884\u6d4b\u662f\u5426\u6b63\u786e\u3002</p>\n<p>\u8fd9\u5c31\u662f Exynos M1 \u548c M2 \u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u3002\u4e0a\u9762\u7684\u4e13\u5229<a href=\"https://patents.google.com/patent/US20170068539A1/en\">High performance zero bubble conditional branch prediction using micro branch target buffer</a>\u8fd8\u7ed9\u51fa\u4e86\u524d\u7aef\u7684\u6d41\u6c34\u7ebf\u5404\u7ea7\u7684\u529f\u80fd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../samsung-exynos-cpu-frontend-1.png\" /></p>\n<p>\u8fd9\u4e2a\u56fe\u4e2d\u6ca1\u6709\u7ed8\u5236 uBTB \u5185\u90e8\u7684\u7ed3\u6784\uff0cuBTB \u8d1f\u8d23\u7ed9\u51fa\u521d\u59cb\u7684\u9884\u6d4b\uff0c\u5230 B1 \u9636\u6bb5\uff0c\u4ece B1 \u5f00\u59cb\uff0c\u4f1a\u7ecf\u8fc7\u4e24\u6761\u6d41\u6c34\u7ebf\uff0c\u4e0a\u9762\u7684\u6d41\u6c34\u7ebf\u662f mBTB + SHP \u8d1f\u8d23\u66f4\u7cbe\u786e\u7684\u9884\u6d4b\uff0c\u4e0b\u9762\u7684\u6d41\u6c34\u7ebf\u662f\u67e5\u8be2 ITLB + \u8bfb\u53d6 ICache\u3002\u4e0a\u9762\u8bf4 2-bubble \u7684 mBTB\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u4ece B1 \u5f97\u5230 Fetch Window\uff0cB2 \u8bfb\u53d6 mBTB \u548c SHP \u7684\u6743\u91cd\uff0c\u7b49\u5230 B3 \u5b8c\u6210\u4e4b\u540e\u624d\u53ef\u4ee5\u8ba1\u7b97\u51fa\u7ed3\u679c\uff0c\u5224\u65ad\u662f taken \u8fd8\u662f not taken\uff0c\u5982\u679c\u9884\u6d4b\u7684\u7ed3\u679c\u548c uBTB \u9884\u6d4b\u4e0d\u4e00\u81f4\uff0c\u5c31\u9700\u8981\u5237\u6d41\u6c34\uff0c\u4ece B1 \u91cd\u65b0\u5f00\u59cb\uff1aB1 B2 B3 B1 B2 B3\uff0c\u4e09\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002</p>\n<p>\u56fe\u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230 vBTB \u5728 B4\uff0c\u6240\u4ee5\u5982\u679c\u4e00\u4e2a cacheline \u6709\u8d85\u8fc7 8 \u4e2a branch\uff0c\u90a3\u4e48\u5728\u9884\u6d4b\u8fd9\u4e9b\u6ea2\u51fa\u5230 vBTB \u4e2d\u7684\u5206\u652f\u65f6\uff0c\u9700\u8981\u989d\u5916\u7684\u4e24\u4e2a\u5468\u671f\uff1aB1 B2 B3 B4 B3\uff0c\u4e94\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002</p>\n<p>Exynos M3 \u7ee7\u7eed\u6539\u8fdb\u4e86\u5206\u652f\u9884\u6d4b\u5668\u3002\u9996\u5148\u662f uBTB \u7684\u56fe\u7684\u5bb9\u91cf\u7ffb\u500d\uff0c\u6dfb\u52a0\u4e86\u9488\u5bf9\u65e0\u6761\u4ef6\u5206\u652f\u7684\u5bb9\u91cf\u3002\u4e3a\u4e86\u52a0\u901f\u603b\u662f\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5f53 mBTB \u68c0\u6d4b\u5230\u603b\u662f\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u65f6\uff0c\u63d0\u524d\u4e00\u4e2a\u5468\u671f\u5f97\u5230\u7ed3\u679c\uff0c\u4e5f\u5c31\u662f\u4e0a\u56fe\u4e2d B3 \u5230 B1 \u7684\u8fde\u7ebf\uff0c\u6ca1\u6709\u7ecf\u8fc7\u6743\u91cd\u8ba1\u7b97\uff0c\u76f4\u63a5\u5237 B1\uff1aB1 B2 B1 B2\uff0c\u4e24\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\uff0c1-bubble\uff0c\u5728\u8bba\u6587\u91cc\u53eb\u505a 1AT\uff081-bubble Always Taken\uff09\u3002Exynos M3 \u8fd8\u7ffb\u500d\u4e86 SHP \u7684\u884c\u7684\u4e2a\u6570\uff0c\u4e5f\u7ffb\u500d\u4e86 L2 BTB \u5bb9\u91cf\u3002</p>\n<p>Exynos M4 \u7ee7\u7eed\u7ffb\u500d\u4e86 L2 BTB \u5bb9\u91cf\uff0c\u51cf\u5c11\u4e86 L2 BTB refill \u5230 mBTB \u7684\u5ef6\u8fdf\uff0c\u5e26\u5bbd\u7ffb\u500d\u3002\u8fd9\u4e2a\u4f18\u5316\u4e3b\u8981\u662f\u9488\u5bf9\u5206\u652f\u6bd4\u8f83\u591a\uff0cmBTB \u5b58\u4e0d\u4e0b\u7684\u7a0b\u5e8f\u3002</p>\n<p>Exynos M5 \u589e\u52a0\u4e86 Empty Line Optimization \u4f18\u5316\uff1a\u68c0\u6d4b\u6ca1\u6709\u5206\u652f\u7684\u7f13\u5b58\u884c\uff0c\u5982\u679c\u786e\u8ba4\u7f13\u5b58\u884c\u6ca1\u6709\u5206\u652f\uff0c\u90a3\u5c31\u4e0d\u7528\u9884\u6d4b\u91cc\u9762\u7684\u5206\u652f\u4e86\uff0c\u53ef\u4ee5\u8282\u7701\u529f\u8017\u3002</p>\n<p>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u4f18\u5316 taken branch \u7684\u541e\u5410\uff0c\u5728 mBTB \u4e2d\u8bb0\u5f55\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u65f6\uff0c\u4e0d\u4ec5\u8bb0\u5f55\u5728\u5206\u652f\u672c\u8eab\u6240\u5728\u7684 mBTB entry \u4e2d\uff0c\u8fd8\u8981\u8bb0\u5f55\u5728\u8fd9\u6761\u5206\u652f\u7684\u524d\u5e8f\u5206\u652f\u7684 mBTB entry \u4e2d\uff1a\u4f8b\u5982 A \u8df3\u8f6c\u5230 B\uff0cB \u8df3\u8f6c\u5230 C\uff0c\u7ecf\u5178\u7684\u5b9e\u73b0\u662f\u7528 A \u7684\u5730\u5740\u627e\u5230 A \u7684 BTB entry\uff0centry \u4e2d\u8bb0\u5f55\u4e86 A \u76ee\u7684\u5730\u5740\u662f B\uff0c\u63a5\u7740\u7528 B \u7684\u5730\u5740\u627e\u5230 B \u7684 BTB entry\uff0centry \u4e2d\u8bb0\u5f55\u4e86 B \u7684\u76ee\u7684\u5730\u5740\u662f C\uff1b\u800c Exynos M5 \u7684\u8bbe\u8ba1\u662f\uff0cC \u7684\u76ee\u7684\u5730\u5740\uff0c\u4e0d\u4ec5\u8981\u8bb0\u5f55\u5728 B \u7684 BTB entry \u4e2d\uff0c\u8fd8\u8981\u8bb0\u5f55\u5728 A \u7684 BTB entry \u4e2d\u3002\u4e0d\u8fc7\u8fd9\u91cc\u8981\u6c42 B \u7684\u8df3\u8f6c\u662f always-taken \u6216\u8005 often-taken\uff0c\u56e0\u4e3a\u5e76\u6ca1\u6709\u5bf9\u7b2c\u4e8c\u6761\u5206\u652f\u505a\u9884\u6d4b\uff0c\u800c\u662f\u9884\u6d4b\u5b83\u4e00\u5b9a\u4f1a\u8df3\u3002\u901a\u8fc7\u8fd9\u6837\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728 2-bubble \u7684\u9884\u6d4b\u5668\u7684\u5b9e\u73b0\u4e0b\uff0c\u5b9e\u73b0 1 taken branch/cycle \u7684\u541e\u5410\uff0c\u7b49\u6548\u4e8e\u4e00\u4e2a 0-bubble \u7684\u9884\u6d4b\u5668\u3002\u4e0b\u9762\u662f\u8bba\u6587\u4e2d\u5bf9 mBTB \u4ece 2-bubble \u5230 1-bubble \u6700\u7ec8\u5230 0-bubble \u7684\u53d8\u5316\u7684\u5bf9\u6bd4\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../samsung-exynos-cpu-mbtb.png\" /></p>\n<p>\u6700\u5de6\u8fb9\u7684 SHP 2-bubble \u5c31\u662f\u6700\u521d\u7684\u5b9e\u73b0\uff0c\u5b83\u9700\u8981\u5728 B3 \u5f97\u5230\u5206\u652f\u662f taken \u8fd8\u662f not taken \u7684\u4fe1\u606f\uff0c\u5982\u679c\u548c\u4e4b\u524d\u9884\u6d4b\u7684\u4e0d\u4e00\u6837\uff0c\u90a3\u5c31\u9700\u8981 flush \u6389\u6d41\u6c34\u7ebf\uff0cB1 \u91cd\u65b0\u4ece\u6b63\u786e\u7684\u5730\u5740\u5f00\u59cb\uff0c\u7136\u540e\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u7531\u4e8e\u6bcf\u6b21\u90fd\u9700\u8981\u5230 B3 \u624d\u80fd\u5f97\u5230\u6b63\u786e\u7684\u5730\u5740\uff0c\u6240\u4ee5\u4e09\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002</p>\n<p>\u4e2d\u95f4\u662f\u6539\u8fdb\u7684 1AT 1-bubble \u5b9e\u73b0\uff0c\u5b83\u5728 mBTB \u4e2d\u8bb0\u5f55\u4e86\u8fd9\u4e2a\u5206\u652f\u662f\u5426\u662f Always Taken\u3002\u56e0\u4e3a mBTB \u5728 B2 \u4e2d\u8bfb\u53d6\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4fe1\u606f\u5728 B2 \u5c31\u53ef\u4ee5\u5f97\u77e5\uff0c\u4f8b\u5982\u56fe\u4e2d A \u5206\u652f\u5230\u8fbe B2 \u65f6\uff0c\u68c0\u6d4b\u5230\u5b83\u662f Always Taken\uff0c\u4e0b\u4e2a\u5468\u671f\u7684 B1 \u76f4\u63a5\u5c31\u4ece\u6b63\u786e\u7684\u5730\u5740 B \u5f00\u59cb\uff0c\u540c\u7406 B \u5230\u8fbe B2 \u65f6\uff0c\u53c8\u53d1\u73b0\u5b83\u662f Always Taken\uff0c\u4e0b\u4e00\u4e2a\u5468\u671f\u7684 B1 \u53c8\u4ece C \u5f00\u59cb\uff0c\u6240\u4ee5\u4e24\u5468\u671f\u4e00\u4e2a taken branch\uff0c\u524d\u63d0\u662f\u5206\u652f\u662f Always Taken\uff0c\u901a\u8fc7\u907f\u514d\u5206\u652f\u9884\u6d4b\u6765\u51cf\u5c11\u4e00\u4e2a\u5468\u671f\u7684 bubble\u3002</p>\n<p>\u53f3\u8fb9\u662f\u6700\u540e\u7684 ZAT/ZOT 0-bubble \u5b9e\u73b0\uff0c\u5b83\u5728 mBTB \u4e2d\u8bb0\u5f55\u4e86\u540e\u7eed\u4e24\u4e2a\u5206\u652f\u7684\u5730\u5740\uff0c\u4f8b\u5982 X \u5728 mBTB \u4e2d\u8bb0\u5f55\u4e86 A \u548c B \u7684\u5730\u5740\u3002\u5f53 B3 \u53d1\u73b0 X \u8981\u8df3\u8f6c\u7684\u65f6\u5019\uff0c\u5237\u6d41\u6c34\u7ebf\uff0c\u5728\u63a5\u4e0b\u6765\u7684\u4e24\u4e2a\u5468\u671f\u91cc\u5206\u522b\u7ed9 B1 \u63d0\u4f9b\u4e86 A \u548c B \u7684\u5730\u5740\u3002\u5f53 A \u5230\u8fbe B2 \u65f6\uff0cA \u5728 mBTB \u91cc\u8bb0\u5f55\u4e86 B \u548c C \u7684\u5730\u5740\uff0c\u4e8e\u662f\u628a C \u7684\u5730\u5740\u8f6c\u53d1\u5230\u4e0b\u4e00\u4e2a\u5468\u671f\u7684 B1\uff0c\u4f9d\u6b64\u7c7b\u63a8\uff0cB2 \u7684 B \u5f97\u5230\u4e86 D \u7684\u5730\u5740\uff0cB2 \u7684 C \u5f97\u5230\u4e86 E \u7684\u5730\u5740\uff0c\u8fd9\u6837\u5b9e\u73b0\u4e86\u6bcf\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002\u901a\u8fc7\u8bb0\u5f55\u4e24\u8df3\u7684\u5730\u5740\u548c\u907f\u514d\u5206\u652f\u9884\u6d4b\uff08\u628a Always Taken \u548c Often Taken \u90fd\u9884\u6d4b\u4e3a Taken\uff09\uff0c\u4e24\u4e2a\u5468\u671f\u7ed9\u51fa\u4e24\u4e2a\u5730\u5740\uff0c\u51cf\u5c11\u4e24\u4e2a\u5468\u671f\u7684 bubble\u3002</p>\n<p>\u8fd9\u65f6\u5019\u5c31\u76f8\u5f53\u4e8e\u6709\u4e24\u4e2a 0-bubble \u9884\u6d4b\u5668\u4e86\uff0cmBTB \u6709 0-bubble \u80fd\u529b\uff0cuBTB \u4e5f\u6709\uff0c\u6240\u4ee5 Exynos M5 \u51cf\u5c11\u4e86 uBTB \u7684\u5bb9\u91cf\uff0c\u6362\u53d6\u66f4\u5927\u7684 mBTB \u7684\u9884\u6d4b\u5668\u5bb9\u91cf\uff1aSHP \u7684\u8868\u6570\u91cf\u7ffb\u500d\uff0cGHR \u5386\u53f2\u957f\u5ea6\u589e\u52a0\u3002</p>\n<p>\u867d\u7136 mBTB \u5728\u7279\u5b9a\u60c5\u51b5\u4e0b\u53ef\u4ee5\u505a\u5230 0-bubble\uff0c\u4f46\u662f\u5982\u679c\u603b\u662f\u9700\u8981\u7ea0\u6b63\u9884\u6d4b\u9519\u8bef\uff0c\u5c31\u4f1a\u56de\u9000\u5230\u4e09\u4e2a\u5468\u671f\u4e00\u6761\u5206\u652f\u7684\u6027\u80fd\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cExynos M5 \u5f15\u5165\u4e86 Mispredict Recovery Buffer\uff08MRB\uff09\uff1a\u9488\u5bf9\u6bd4\u8f83\u96be\u9884\u6d4b\u7684\u5206\u652f\uff0c\u8bb0\u5f55\u5b83\u540e\u7eed\u6700\u53ef\u80fd\u6267\u884c\u7684\u4e09\u6b21 fetch \u7684\u5730\u5740\uff0c\u5982\u679c\u547d\u4e2d\u4e86 MRB\uff0c\u90a3\u5c31\u76f4\u63a5\u4ece MRB \u4e2d\u6309\u987a\u5e8f\u7528\u4e09\u4e2a\u5468\u671f\u628a\u8fd9\u4e09\u6b21 fetch \u7684\u5730\u5740\u653e\u5230 B1\uff0c\u7136\u540e\u6d41\u6c34\u7ebf\u53bb\u9a8c\u8bc1\u8fd9\u4e09\u4e2a fetch \u5730\u5740\u662f\u5426\u6b63\u786e\uff0c\u8282\u7701\u4e86\u91cd\u590d\u7684 B3 \u5230 B1 \u7684\u91cd\u5b9a\u5411\u65f6\u95f4\u3002\u8fd9\u4e2a\u601d\u8def\u6709\u70b9\u50cf\u5927\u6a21\u578b\u7684\u63a8\u6d4b\u751f\u6210\uff1a\u7528\u6bd4\u8f83\u77ed\u7684\u65f6\u95f4\u9884\u6d4b\uff08\u5728\u8fd9\u91cc\u662f\u76f4\u63a5\u7528 MRB \u8bb0\u4e0b\u6765\u4e86\uff09\u51fa\u4e00\u4e2a\u672c\u6765\u662f\u4e32\u884c\u7684\u8fc7\u7a0b\u7684\u7ed3\u679c\uff0c\u7136\u540e\u518d\u7528\u6d41\u6c34\u7ebf\u6216\u8005\u5e76\u884c\u7684\u65b9\u5f0f\u53bb\u9a8c\u8bc1\u7ed3\u679c\u662f\u5426\u6b63\u786e\u3002\u5229\u7528\u7684\u6027\u8d28\u90fd\u662f\uff0c\u4e32\u884c\u751f\u6210\u6162\uff0c\u4f46\u662f\u9a8c\u8bc1\u7ed3\u679c\u5374\u6bd4\u8f83\u5feb\u3002</p>\n<p>Exynos M6 \u6269\u5927\u4e86 mBTB \u5bb9\u91cf\uff0c\u9488\u5bf9\u95f4\u63a5\u8df3\u8f6c\u6307\u4ee4\u505a\u4e86\u66f4\u591a\u7684\u4f18\u5316\uff0c\u4e3b\u8981\u662f\u8003\u8651\u5e94\u7528\u7a0b\u5e8f\u4f1a\u51fa\u73b0\u4e00\u4e2a\u95f4\u63a5\u8df3\u8f6c\u4f1a\u8df3\u8f6c\u5230\u4e0a\u767e\u4e2a\u4e0d\u540c\u7684\u76ee\u7684\u5730\u5740\u8fd9\u79cd\u6a21\u5f0f\uff0c\u4e4b\u524d\u7684 VPC \u65b9\u6cd5\u662f O(n) \u7684\uff0cn \u662f\u53ef\u80fd\u7684\u76ee\u7684\u5730\u5740\u7684\u4e2a\u6570\uff0cn \u5c0f\u7684\u65f6\u5019\u6bd4\u8f83\u597d\uff0cn \u5927\u4e86\u5c31\u5f88\u6162\u4e86\u3002</p>\n<p>Exynos M6 \u7684\u529e\u6cd5\u662f\uff0c\u9488\u5bf9\u8fd9\u4e9b\u76ee\u7684\u5730\u5740\u7279\u522b\u591a\u7684\u95f4\u63a5\u8df3\u8f6c\u6307\u4ee4\uff0c\u8bbe\u8ba1\u5355\u72ec\u7684\u5b58\u50a8\uff0c\u4e0d\u53bb\u5360\u7528 vBTB \u7684\u7a7a\u95f4\uff0c\u8fd9\u4e2a\u7a7a\u95f4\u662f Indirect target storage\uff0c\u91c7\u7528 4 \u8def\u7ec4\u76f8\u8fde\uff0c\u4e00\u5171 256 \u4e2a set\u3002\u7ecf\u5e38\u51fa\u73b0\u7684\u76ee\u7684\u5730\u5740\u8fd8\u662f\u548c\u4e4b\u524d\u4e00\u6837\uff0c\u653e\u5728 mBTB \u4e2d\uff0c\u4f46\u662f\u5bf9\u4e8e\u5269\u4e0b\u7684\u76ee\u7684\u5730\u5740\uff0c\u5219\u662f\u653e\u5230 Indirect target storage \u4e2d\uff0c\u6839\u636e\u6700\u8fd1\u7684 indirect branch target \u8ba1\u7b97\u51fa Index \u548c Tag\uff0c\u53bb Indirect target storage \u4e2d\u5bfb\u627e\uff0c\u5176\u5b9e\u8fd9\u4e2a\u5c31\u548c ITTAGE \u91cc\u7684\u4e00\u4e2a table \u6709\u70b9\u7c7b\u4f3c\u4e86\u3002</p>\n<p>\u6700\u540e\u8bba\u6587\u603b\u7ed3\u4e86 Exynos \u4ece M1 \u5230 M6 \u7684\u5404\u7ea7\u5206\u652f\u9884\u6d4b\u5668\u7684\u5b58\u50a8\u9762\u79ef\u5f00\u9500\uff0c\u57fa\u672c\u6bcf\u4e00\u4ee3\u90fd\u6709\u6240\u589e\u52a0\uff0c\u65e2\u6709 MPKI \u7684\u51cf\u5c11\uff08M6 \u76f8\u6bd4 M1 \u5728 SPECint2006 \u4e0a MPKI \u51cf\u5c11 25.6%\uff09\uff0c\u53c8\u6709\u9884\u6d4b\u6027\u80fd\u7684\u63d0\u5347\u3002</p>\n<h2 id=\"\u5206\u652f\u9884\u6d4b\u5b89\u5168\">\u5206\u652f\u9884\u6d4b\u5b89\u5168<a class=\"headerlink\" href=\"#\u5206\u652f\u9884\u6d4b\u5b89\u5168\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6709\u610f\u601d\u7684\uff0c\u8bba\u6587\u4e5f\u63d0\u5230\u4e86\u5206\u652f\u9884\u6d4b\u7684\u5b89\u5168\u95ee\u9898\uff0c\u4e3b\u8981\u662f\u907f\u514d\u8de8\u4e0a\u4e0b\u6587\u7684\u5206\u652f\u9884\u6d4b\u5668\u6ce8\u5165\u653b\u51fb\u3002\u6838\u5fc3\u601d\u8def\u662f\uff0c\u7ed9\u6bcf\u4e2a\u4e0a\u4e0b\u6587\u751f\u6210\u4e00\u4e2a\u968f\u673a\u6570\uff08<code>CONTEXT_HASH</code>\uff09\uff0c\u7136\u540e\u628a\u968f\u673a\u6570\u5f02\u6216\u5230 BTB \u4fdd\u5b58\u7684\u76ee\u7684\u5730\u5740\u91cc\u9762\u53bb\uff0c\u5728\u4ece BTB \u8bfb\u51fa\u6765\u76ee\u7684\u5730\u5740\u4f7f\u7528\u4e4b\u524d\uff0c\u8981\u518d\u6b21\u5f02\u6216\u540c\u4e00\u4e2a\u968f\u673a\u6570\u3002\u90a3\u4e48\u5982\u679c\u662f\u8bfb\u53d6\u4e86\u6765\u81ea\u540c\u4e00\u4e2a\u4e0a\u4e0b\u6587\u7684 BTB entry\uff0c\u901a\u8fc7\u4e24\u6b21\u5f02\u6216\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u539f\u59cb\u6570\u636e\uff1b\u5982\u679c\u662f\u8bfb\u53d6\u4e86\u6765\u81ea\u4e0d\u540c\u4e0a\u4e0b\u6587\u7684 BTB entry\uff0c\u7531\u4e8e\u968f\u673a\u6570\u4e0d\u540c\uff0c\u6700\u540e\u4f1a\u5f97\u5230\u968f\u673a\u7684\u6570\u636e\u3002\u5f53\u7136\u4e86\uff0c\u524d\u63d0\u662f\u8fd9\u4e9b\u968f\u673a\u6570\u4e0d\u80fd\u88ab\u653b\u51fb\u8005\u5f97\u5230\uff0c\u5bf9\u8f6f\u4ef6\u662f\u4e0d\u53ef\u89c1\u7684\u3002</p>\n<h2 id=\"uop-cache\">uOP Cache<a class=\"headerlink\" href=\"#uop-cache\" title=\"Permanent link\">&para;</a></h2>\n<p>Exynos M1 \u5230 M4 \u6ca1\u6709 uOP Cache\uff0c\u6240\u6709\u6307\u4ee4\u90fd\u9700\u8981\u7ecf\u8fc7\u53d6\u6307\u548c\u8bd1\u7801\uff0c\u5f97\u5230 uOP\u3002\u4ece Exynos M5 \u5f00\u59cb\u5f15\u5165\u4e86 uOP Cache\uff0c\u4f1a\u7f13\u5b58\u8bd1\u7801\u540e\u7684 uOP\u3002Exynos M5 \u7684 uOP Cache \u6700\u591a\u53ef\u4ee5\u4fdd\u5b58 384 \u4e2a uOP\uff0c\u6bcf\u4e2a entry \u53ef\u4ee5\u4fdd\u5b58 6 \u4e2a uOP\uff0c\u4e00\u4e2a\u5468\u671f\u63d0\u4f9b\u4e00\u4e2a entry\u3002\u4e00\u4e2a uOP Cache Entry \u4e2d\u7684 uOP \u6765\u81ea\u8fde\u7eed\u7684\u6307\u4ee4\uff0c\u4ee5\u5206\u652f\u6307\u4ee4\u4f5c\u4e3a\u7ed3\u5c3e\u3002\u4e0b\u9762\u662f\u8bba\u6587\u7ed9\u51fa\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<p><img alt=\"\" src=\"../../../../samsung-exynos-cpu-uop.png\" /></p>\n<p>\u8fd9\u6bb5\u6307\u4ee4\u7684\u5165\u53e3\u5728\u7b2c\u4e00\u4e2a\u7f13\u5b58\u884c\u7684\u6700\u540e\uff0c\u4ece I0 \u5f00\u59cb\uff0c\u6267\u884c I0 I1 I2 I3\uff0cI3 \u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u56e0\u6b64 uOP \u7684 entry \u5230\u6b64\u7ed3\u675f\uff0c\u8bb0\u5f55\u4e86 I0-I3 \u8bd1\u7801\u540e\u7684 uOP\uff0c\u8fd9\u91cc I2 \u6307\u4ee4\u88ab\u8bd1\u7801\u6210\u4e86\u4e24\u6761 uOP\uff0c\u4e8e\u662f\u8fd9\u4e2a entry \u5c31\u662f U0 U1 U2A U2B U3 \u8fd9\u4e94\u4e2a uOP\u3002I3 \u8df3\u8f6c\u5230\u4e86 I4\uff0cI4 \u7d27\u63a5\u7740\u53c8\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4 I5\uff0c\u6240\u4ee5 uOP \u7684 entry \u5230\u8fd9\u91cc\u7ed3\u675f\uff0c\u8bb0\u5f55 I4 \u548c I5 \u8bd1\u7801\u540e\u7684 uOP\uff1aU4 \u548c U5\u3002\u540e\u9762\u4f9d\u6b64\u7c7b\u63a8\u3002</p>\n<p>\u90a3\u4e48\u4ec0\u4e48\u65f6\u5019 uOP Cache \u542f\u7528\u5462\uff1f\u8bba\u6587\u4e2d\u63d0\u5230\u4e86\u4e00\u4e2a\u72b6\u6001\u673a\uff1a</p>\n<ol>\n<li>FilterMode\uff1a\u5f53 uBTB \u5728\u5b66\u4e60\u5206\u652f\u4e4b\u95f4\u7684\u5173\u7cfb\u65f6\uff0c\u4e5f\u5728\u68c0\u67e5\u8fd9\u6bb5\u4ee3\u7801\u80fd\u5426\u653e\u5230 uOP Cache \u91cc\uff0c\u5982\u679c\u53ef\u4ee5\u7684\u8bdd\uff0c\u8f6c\u79fb\u5230 BuildMode</li>\n<li>BuildMode\uff1a\u5f00\u59cb\u628a\u8bd1\u7801\u5f97\u5230\u7684 uOP \u4fdd\u5b58\u5230 uOP Cache \u5185\u90e8\uff0c\u540c\u65f6\u548c uBTB \u5b66\u4e60\u5230\u7684\u56fe\u8fdb\u884c\u6bd4\u5bf9\uff0c\u5f53\u56fe\u4e2d\u5927\u90e8\u5206\u7684\u8fb9\u5bf9\u5e94\u7684\u6307\u4ee4\u90fd\u5df2\u7ecf\u88ab uOP Cache \u5b66\u4e60\u5230\uff0c\u8bf4\u660e uOP Cache \u5df2\u7ecf\u6355\u6349\u4e86\u5927\u90e8\u5206\u9700\u8981\u7684\u6307\u4ee4\uff0c\u8fdb\u5165 FetchMode</li>\n<li>FetchMode\uff1a\u6307\u4ee4\u7f13\u5b58\u548c\u8bd1\u7801\u90e8\u4ef6\u88ab\u5173\u95ed\uff0c\u8282\u7701\u529f\u8017\uff0c\u6240\u6709\u6307\u4ee4\u90fd\u4ece uOP Cache \u63d0\u4f9b\uff1b\u6b64\u65f6\u5982\u679c uBTB \u7684\u51c6\u786e\u7387\u5f88\u9ad8\uff0cmBTB \u4e5f\u53ef\u4ee5\u5173\u6389\uff0c\u8fdb\u4e00\u6b65\u8282\u7701\u529f\u8017\u3002\u5f53 uOP Cache \u547d\u4e2d\u7387\u964d\u4f4e\uff0c\u5207\u6362\u56de FilterMode</li>\n</ol>\n<p>\u8fd9\u79cd\u8bbe\u8ba1\u8fd8\u662f\u6bd4\u8f83\u5e38\u89c1\u7684\uff0cuOP Cache \u548c Decoder \u4e0d\u4f1a\u540c\u65f6\u5de5\u4f5c\uff0c\u800c\u662f\u4e8c\u9009\u4e00\uff0c\u6839\u636e uOP Cache \u7684\u547d\u4e2d\u7387\u6765\u51b3\u5b9a\u8c01\u6765\u5de5\u4f5c\u3002\u7136\u540e\u8fdb\u4e00\u6b65\u4e3a\u4e86\u907f\u514d uOP Cache \u586b\u5145\u7684\u529f\u8017\uff0c\u5982\u679c uBTB \u53d1\u73b0\u8fd9\u4e9b\u4ee3\u7801\u653e\u4e0d\u4e0b uOP Cache \u4e2d\uff0c\u5c31\u4e0d\u586b\u5145 uOP Cache \u4e86\uff0c\u8fd9\u5c31\u662f FilterMode \u7684\u8bbe\u8ba1\u7684\u610f\u4e49\u3002</p>\n<h2 id=\"l1-\u6570\u636e\u9884\u53d6\">L1 \u6570\u636e\u9884\u53d6<a class=\"headerlink\" href=\"#l1-\u6570\u636e\u9884\u53d6\" title=\"Permanent link\">&para;</a></h2>\n<p>L1 \u6570\u636e\u9884\u53d6\u5668\u4f1a\u68c0\u6d4b\u4e0d\u540c\u7684 stride\uff0c\u5728\u865a\u62df\u5730\u5740\u4e0a\uff0c\u8ddf\u8e2a\u8bbf\u5b58\u7684\u5386\u53f2\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8bc6\u522b\u8bbf\u5b58\u7684\u5e8f\u5217\uff0c\u7531\u4e8e\u8bbf\u5b58\u662f\u53ef\u4ee5\u4e71\u5e8f\u6267\u884c\u7684\uff0c\u5b83\u4f1a\u8fdb\u884c\u91cd\u6392\uff0c\u4f7f\u5f97\u8bbf\u5b58\u6a21\u5f0f\u7684\u8bc6\u522b\u770b\u5230\u5c31\u662f\u7a0b\u5e8f\u7684\u987a\u5e8f\u3002\u4e3a\u4e86\u9a8c\u8bc1\u9884\u53d6\u662f\u5426\u6b63\u786e\uff0c\u5728\u9884\u53d6\u7684\u540c\u65f6\uff0c\u4e5f\u4f1a\u628a\u8fd9\u4e9b\u9884\u53d6\u7684\u5730\u5740\u8bb0\u5f55\u4e0b\u6765\uff0c\u653e\u5728 Confirmation Queue \u4e2d\uff0c\u548c\u672a\u6765\u7684 load \u5730\u5740\u505a\u6bd4\u5bf9\u3002\u5982\u679c\u9884\u53d6\u5668\u548c\u672a\u6765\u7684 load \u5339\u914d\u7684\u6bd4\u4f8b\u5f88\u9ad8\uff0c\u8bf4\u660e\u9884\u53d6\u5668\u5f88\u51c6\u786e\uff0c\u53ef\u4ee5\u7ee7\u7eed\u8ba9\u4ed6\u9884\u53d6\u3002\u5982\u679c\u51c6\u786e\u7387\u8f83\u4f4e\uff0c\u4e3a\u4e86\u907f\u514d\u6d6a\u8d39\u5185\u5b58\u5e26\u5bbd\uff0c\u5c31\u4f1a\u505c\u6b62\u9884\u53d6\u3002</p>\n<p>\u9664\u4e86 strided \u8bbf\u5b58\u6a21\u5f0f\uff0cExynos M3 \u8fd8\u5f15\u5165\u4e86 Spatial Memory Stream \u9884\u53d6\u5668\uff0c\u5b83\u4f1a\u8ddf\u8e2a\u4e00\u4e2a\u533a\u95f4\u7684\u7b2c\u4e00\u6b21 cache miss \u548c\u540e\u7eed\u7684 miss\uff0c\u5f53\u518d\u6b21\u9047\u5230\u7b2c\u4e00\u6b21 cache miss \u7684\u5730\u5740\u65f6\uff0c\u9884\u53d6\u540e\u7eed\u53ef\u80fd\u4f1a\u51fa\u73b0 miss \u7684\u5730\u5740\u3002</p>\n<h2 id=\"l2l3-\u7f13\u5b58\">L2/L3 \u7f13\u5b58<a class=\"headerlink\" href=\"#l2l3-\u7f13\u5b58\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e3a\u4e86\u51cf\u5c11\u6570\u636e\u7684\u91cd\u590d\uff0cL3 \u7f13\u5b58\u548c L1/L2 \u662f exclusive \u7684\u5173\u7cfb\uff0c\u6570\u636e\u662f\u4e92\u65a5\u7684\uff0c\u8981\u4e48\u5b58\u5728 L3 \u91cc\uff0c\u8981\u4e48\u5b58\u5728 L1/L2 \u91cc\uff0c\u8981\u4e48\u90fd\u4e0d\u5b58\u3002</p>\n<p>Exynos M4 \u9488\u5bf9 L2 \u7f13\u5b58\u5f15\u5165\u4e86 Buddy Prefetcher\uff1a\u5982\u679c\u4e00\u4e2a\u7f13\u5b58\u884c\u7f3a\u5931\u4e86\uff0c\u90a3\u5c31\u628a\u5b83\u76f8\u90bb\u7684\u4e0b\u4e00\u4e2a\u7f13\u5b58\u884c\u4e5f\u9884\u53d6\u8fdb\u6765\u3002</p>\n<h2 id=\"\u8bbf\u5b58\u5ef6\u8fdf\">\u8bbf\u5b58\u5ef6\u8fdf<a class=\"headerlink\" href=\"#\u8bbf\u5b58\u5ef6\u8fdf\" title=\"Permanent link\">&para;</a></h2>\n<p>Exynos \u7cfb\u5217\u7684 load to use latency \u901a\u5e38\u60c5\u51b5\u4e0b\u662f 4 cycle\uff0c\u4f46\u9488\u5bf9 load to load \u7684\u60c5\u51b5\uff0c\u4e5f\u5c31\u662f\u524d\u4e00\u4e2a load \u7684\u7ed3\u679c\uff0c\u4f5c\u4e3a\u540e\u4e00\u4e2a load \u7684\u57fa\u5730\u5740\u7684\u60c5\u51b5\uff0c\u4ece Exynos M4 \u5f00\u59cb\u53ef\u4ee5\u505a\u5230 3 cycle \u7684 load to use latency\uff0c\u8fd9\u5728\u8bba\u6587\u4e2d\u53eb\u505a cascading load\u3002\u8fd9\u4e2a 4 cycle \u51cf\u5230 3 cycle \u7684\u7279\u6027\u5728\u82f9\u679c\uff0c\u9ad8\u901a\u548c Intel\uff08E-core\uff09\u7684 CPU \u4e2d\u90fd\u6709\u770b\u5230\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u867d\u7136 Exynos \u7cfb\u5217\u5fae\u67b6\u6784\u7684\u82af\u7247\u6ca1\u6709\u65b0\u7684\u6f14\u8fdb\u4e86\uff0c\u4f46\u662f\u4e5f\u975e\u5e38\u611f\u8c22\u8fd9\u4e9b\u4f5c\u8005\u6177\u6168\u5730\u4ecb\u7ecd\u4e86\u4ed6\u4eec\u8fd9\u4e9b\u5e74\u4f18\u5316\u5fae\u67b6\u6784\u7684\u52aa\u529b\uff0c\u63d0\u4f9b\u4e86\u5f88\u591a\u6709\u4ef7\u503c\u7684\u4fe1\u606f\u3002\u4ece\u4f5c\u8005\u4fe1\u606f\u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65f6\u5f00\u53d1 Exynos \u7684\u56e2\u961f\u6210\u5458\uff0c\u5728\u56e2\u961f\u89e3\u6563\u4ee5\u540e\uff0c\u53bb\u7684\u57fa\u672c\u4e5f\u662f\u6709\u81ea\u7814\u6838\u7684\u516c\u53f8\uff1aSifive\uff0cCentaur\uff0cARM\uff0cAMD\uff0cNuvia\u3002</p>\n<p>\u7531\u4e8e\u672c\u4eba\u5bf9 DCache \u4ee5\u53ca Prefetch \u90e8\u5206\u7f3a\u4e4f\u6df1\u5165\u4e86\u89e3\uff0c\u6240\u4ee5\u8fd9\u90e8\u5206\u7684\u4ecb\u7ecd\u6bd4\u8f83\u5c11\uff0c\u6709\u5174\u8da3\u7684\u8bfb\u8005\u5efa\u8bae\u53c2\u8003\u539f\u6587\u3002</p>", "image": null, "date_published": "2024-09-10T00:00:00+00:00", "authors": [], "tags": ["arm", "cpu", "exynos", "hardware", "microarchitecture", "samsung"]}, {"id": "https://jia.je/hardware/2024/09/04/memory_model_and_memory_ordering/", "url": "https://jia.je/hardware/2024/09/04/memory_model_and_memory_ordering/", "title": "\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f", "content_html": "<h1 id=\"\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\">\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f<a class=\"headerlink\" href=\"#\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\u662f\u4e00\u4e2a\u8d2f\u7a7f\u8f6f\u786c\u4ef6\u5b9e\u73b0\u7684\u6982\u5ff5\uff0c\u4f60\u53ef\u4ee5\u5728 CPU \u5fae\u67b6\u6784\uff0c\u603b\u7ebf\uff0c\u5230\u6c47\u7f16\u6307\u4ee4\uff0c\u7f16\u8bd1\u5668\u548c\u7f16\u7a0b\u8bed\u8a00\u4e2d\u770b\u5230\u5b83\u4eec\u3002\u672c\u6587\u4e3b\u8981\u6765\u63a2\u8ba8\u8fd9\u4e9b\u95ee\u9898\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5185\u5b58\u6a21\u578b\">\u5185\u5b58\u6a21\u578b<a class=\"headerlink\" href=\"#\u5185\u5b58\u6a21\u578b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5bf9\u4e8e\u5904\u7406\u5668\u6838\u5fc3\u6765\u8bf4\uff0c\u5982\u4f55\u5b9e\u73b0\u8bbf\u5b58\u6307\u4ee4\uff0c\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u662f\u5341\u5206\u663e\u8457\u7684\u3002\u6700\u57fa\u7840\u7684\u786c\u4ef6\u5b9e\u73b0\u65b9\u6cd5\uff0c\u5c31\u662f\u4e32\u884c\u5730\u5b8c\u6210\u6bcf\u4e00\u6761 Load \u548c Store \u6307\u4ee4\uff0c\u6bcf\u4e00\u6761\u8bbf\u5b58\u6307\u4ee4\u6267\u884c\u5b8c\uff0c\u624d\u80fd\u5f00\u59cb\u6267\u884c\u4e0b\u4e00\u6761\u8bbf\u5b58\u6307\u4ee4\u3002\u4f46\u5982\u679c\u6b63\u5728\u6267\u884c\u7684\u8bbf\u5b58\u6307\u4ee4 A \u9047\u5230\u4e86\u7f13\u5b58\u7f3a\u5931\uff0c\u9700\u8981\u7b49\u5f85\u7f13\u5b58\u7684\u56de\u586b\uff0c\u7531\u4e8e\u786c\u4ef6\u53ea\u5b9e\u73b0\u4e86\u4e32\u884c\u6267\u884c\uff0c\u5728 A \u4e4b\u540e\u672a\u6765\u8981\u6267\u884c\u7684\u8bbf\u5b58\u6307\u4ee4 B \u53c8\u5fc5\u987b\u7b49\u5f85 A \u7684\u5b8c\u6210\uff0c\u8017\u8d39\u7684\u65f6\u95f4\u5c31\u4f1a\u6bd4\u8f83\u957f\u3002</p>\n<p>\u4f46\u5f88\u591a\u65f6\u5019\uff0cB \u6307\u4ee4\u5e76\u4e0d\u4f9d\u8d56 A \u6307\u4ee4\uff0c\u53ef\u80fd\u8bbf\u95ee\u7684\u662f\u4e0d\u540c\u7684\u5185\u5b58\u5730\u5740\uff0c\u53ef\u80fd B \u8981\u8bbf\u95ee\u7684\u6570\u636e\u5c31\u5728\u7f13\u5b58\u4e2d\uff0c\u5982\u679c\u80fd\u591f\u5728 A \u7b49\u5f85\u7f13\u5b58\u56de\u586b\u7684\u65f6\u95f4\u540c\u65f6\u6267\u884c B\uff0c\u6027\u80fd\u53ef\u4ee5\u5f97\u5230\u63d0\u5347\u3002\u4f46\u5e76\u975e\u6240\u6709\u7684 B \u90fd\u53ef\u4ee5\u63d0\u524d\u6267\u884c\u7684\uff0c\u6bd4\u5982</p>\n<ul>\n<li>\u4ece\u6838\u5185\u7684\u89c6\u89d2\u6765\u770b\uff0cA \u548c B \u8bbf\u95ee\u7684\u5185\u5b58\u8303\u56f4\u6709\u91cd\u5408\uff0c\u90a3\u4e48\u5b83\u4eec\u7684\u6267\u884c\u987a\u5e8f\u5c31\u5f88\u91cd\u8981\uff1a<ul>\n<li>\u5982\u679c A \u662f Store \u6307\u4ee4\uff0cB \u662f Load \u6307\u4ee4\uff0cB \u5728 A \u4e4b\u524d\u6267\u884c\uff0cB \u63d0\u65e9\u4ece Cache \u8bfb\u53d6\u6570\u636e\uff0c\u5f97\u5230\u7684\u662f A \u5199\u5165\u4e4b\u524d\u7684\u7ed3\u679c\uff0c\u6570\u636e\u5c31\u9519\u4e86\u3002\u4e0d\u8fc7\u597d\u5728\u8fd9\u53ef\u4ee5\u901a\u8fc7 Store to Load Forwarding \u89e3\u51b3\uff0c\u628a A \u8981\u5199\u5165\u7684\u6570\u636e\u4ee5\u53ca Cache \u4e2d\u7684\u6570\u636e\u62fc\u63a5\u51fa\uff0c\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684 B \u8981\u8bfb\u53d6\u7684\u6570\u636e\u3002</li>\n<li>\u5982\u679c A \u662f Load \u6307\u4ee4\uff0cB \u662f Store \u6307\u4ee4\uff0cB \u5728 A \u4e4b\u524d\u6267\u884c\uff0c\u63d0\u65e9\u5411 Cache \u5199\u5165\u6570\u636e\uff0c\u90a3\u4e48 A \u90fd\u51fa\u6765\u7684\u5c31\u662f B \u5199\u5165\u4e4b\u540e\u7684\u7ed3\u679c\uff0c\u6570\u636e\u5c31\u9519\u4e86\u3002</li>\n<li>\u5982\u679c A \u548c B \u90fd\u662f Store \u6307\u4ee4\uff0cB \u5728 A \u4e4b\u524d\u6267\u884c\uff0c\u90a3\u4e48\u6700\u7ec8\u5185\u5b58\u4e2d\u7684\u503c\u662f A \u8986\u76d6\u4e86 B\uff0c\u800c\u4e0d\u662f\u9884\u671f\u7684 B \u8986\u76d6\u4e86 A</li>\n</ul>\n</li>\n<li>\u4ece\u6838\u5916\u7684\u89c6\u89d2\u6765\u770b\uff0c\u5047\u5982\u76ee\u524d\u6b63\u5728\u4e00\u4e2a\u88ab\u9501\u4fdd\u62a4\u7684\u4e34\u754c\u533a\uff0cA \u662f\u5bf9\u88ab\u4fdd\u62a4\u7684\u6570\u636e\u7684\u4fee\u6539\uff0cB \u662f\u91ca\u653e\u9501\uff0c\u5982\u679c B \u5728 A \u4e4b\u524d\u6267\u884c\uff0c\u5c31\u4f1a\u5bfc\u81f4\u9501\u91ca\u653e\u4e86\uff0c\u4f46\u8fd8\u5728\u4fee\u6539\u88ab\u4fdd\u62a4\u7684\u6570\u636e\u7684\u60c5\u51b5\u3002</li>\n</ul>\n<p>\u53ef\u80fd\u8fd8\u6709\u5176\u4ed6\u7c7b\u4f3c\u7684\u573a\u666f\uff0c\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b\uff0c\u51b3\u5b9a\u8bbf\u5b58\u7684\u662f\u5426\u4e71\u5e8f\uff0c\u5982\u4f55\u4e71\u5e8f\uff0c\u9700\u8981\u8003\u8651\uff1a</p>\n<ul>\n<li>\u4ece\u6838\u5185\u7684\u89c6\u89d2\u6765\u770b\uff0c\u4e71\u5e8f\u6267\u884c\u4e0d\u80fd\u4fee\u6539\u7a0b\u5e8f\u7684\u4e00\u6837\u3002\u5b9e\u73b0\u4e71\u5e8f\u7684\u6027\u80fd\uff0c\u53c8\u8981\u8868\u73b0\u51fa\u7c7b\u4f3c\u4e32\u884c\u7684\u884c\u4e3a</li>\n<li>\u4ece\u6838\u95f4\u7684\u89c6\u89d2\u6765\u770b\uff0c\u6709\u4e00\u4e9b\u6307\u4ee4\u4e0d\u80fd\u4e71\u5e8f\uff0c\u5426\u5219\u4f1a\u5f71\u54cd\u6838\u95f4\u540c\u6b65\u4e92\u65a5\u7684\u6b63\u786e\u6027</li>\n</ul>\n<p>\u9664\u4e86 CPU \u6838\u4e4b\u95f4\uff0c\u5982\u679c\u4e00\u4e9b\u5916\u8bbe\uff08\u4f8b\u5982\u663e\u5361\uff0c\u7f51\u5361\uff09\u4e5f\u8981\u8bbf\u95ee\u5185\u5b58\uff0c\u90a3\u4e48 CPU \u548c\u5916\u8bbe\u4e4b\u95f4\uff0c\u4e5f\u53ef\u80fd\u6709\u7c7b\u4f3c\u7684\u987a\u5e8f\u95ee\u9898\u3002</p>\n<p>\u56e0\u6b64\u5c31\u9700\u8981\u660e\u786e\u89c4\u5b9a\u786c\u4ef6\u4e71\u5e8f\u6267\u884c\u7684\u6a21\u5f0f\u548c\u8fb9\u754c\uff0c\u4f7f\u5f97\u8f6f\u4ef6\u5f00\u53d1\u8005\u4e00\u65b9\u9762\u53ef\u4ee5\u6839\u636e\u9700\u8981\u5728\u8f6f\u4ef6\u4e2d\u63d2\u5165\u6307\u4ee4\u6765\u963b\u6b62\u4e0d\u671f\u671b\u53d1\u751f\u7684\u4e71\u5e8f\uff0c\u4ece\u800c\u4fdd\u8bc1\u6b63\u786e\u6027\uff1b\u53e6\u4e00\u65b9\u9762\u5728\u5927\u591a\u6570\u65f6\u95f4\uff0c\u786c\u4ef6\u63d0\u4f9b\u7684\u4e71\u5e8f\u53ef\u4ee5\u5728\u4fdd\u8bc1\u6b63\u786e\u6027\u7684\u60c5\u51b5\u4e0b\uff0c\u63d0\u4f9b\u66f4\u597d\u7684\u6027\u80fd\u3002</p>\n<p>\u4f46\u8fd9\u4e2a\u6a21\u5f0f\u548c\u8fb9\u754c\u4e0d\u662f\u4e00\u5929\u5efa\u6210\u7684\u3002\u786c\u4ef6\u5382\u5546\u5e0c\u671b\u80fd\u591f\u4e0d\u65ad\u63a8\u51fa\u6027\u80fd\u66f4\u597d\u7684\u65b0\u5904\u7406\u5668\uff0c\u8fd9\u4e9b\u65b0\u5904\u7406\u5668\u53ef\u80fd\u4e3a\u4e86\u6027\u80fd\u53bb\u505a\u66f4\u591a\u7684\u4f18\u5316\uff0c\u8fd9\u4e9b\u4f18\u5316\u53ef\u80fd\u4f1a\u6d89\u53ca\u5230\u66f4\u591a\u7684\u4e71\u5e8f\u60c5\u51b5\uff0c\u8fd9\u65f6\u5019\u517c\u5bb9\u6027\u5c31\u6210\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u65e7\u8f6f\u4ef6\u5047\u8bbe\u4e86\u786c\u4ef6\u4e0d\u4f1a\u505a\u67d0\u79cd\u4e71\u5e8f\uff0c\u7ed3\u679c\u65b0\u786c\u4ef6\u505a\u4e86\uff0c\u90a3\u65e7\u8f6f\u4ef6\u5728\u65b0\u786c\u4ef6\u4e0a\u5c31\u4f1a\u51fa\u73b0\u517c\u5bb9\u6027\u95ee\u9898\u3002\u4e8e\u662f\u8f6f\u4ef6\u5f00\u53d1\u8005\u5f88\u5e0c\u671b\u6709\u4e00\u4e2a\u6807\u51c6\u6216\u8005\u8bf4\u6a21\u578b\u51fa\u6765\uff0c\u786c\u4ef6\u4fdd\u8bc1\u6309\u7167\u8fd9\u4e2a\u6a21\u578b\u5b9e\u73b0\u4e71\u5e8f\uff0c\u8f6f\u4ef6\u6309\u7167\u8fd9\u4e2a\u6a21\u578b\u6765\u5f00\u53d1\uff0c\u8fd9\u6837\u8f6f\u4ef6\u786c\u4ef6\u5206\u522b\u53d1\u5c55\uff0c\u4e5f\u4e0d\u4f1a\u51fa\u9519\u3002</p>\n<p>\u4f46\u786c\u4ef6\u5382\u5546\u5bf9\u8fd9\u4e2a\u4e8b\u60c5\u4e5f\u626d\u626d\u634f\u634f\uff0c\u751f\u6015\u4eca\u5929\u505a\u4e86\u4ec0\u4e48\u89c4\u5b9a\uff0c\u660e\u5929\u53d1\u73b0\u8fd9\u4e2a\u89c4\u5b9a\u4f1a\u6d6a\u8d39\u4e86\u4e00\u4e2a\u5de8\u5927\u7684\u6027\u80fd\u63d0\u5347\u673a\u4f1a\uff0c\u4f46\u7ade\u4e89\u5bf9\u624b\u6ca1\u6709\u505a\u8fd9\u4e2a\u627f\u8bfa\uff0c\u7ade\u4e89\u5bf9\u624b\u5c31\u5f97\u5230\u4e86\u4f18\u52bf\u3002\u4f46\u662f\u4e0d\u505a\u627f\u8bfa\u5462\uff0c\u8f6f\u4ef6\u751f\u6001\u53c8\u6210\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u5728\u4eca\u5e74\u7684\u5904\u7406\u5668\u4e0a\u5199\u4ee3\u7801\uff0c\u53ea\u80fd\u4fdd\u8bc1\u5728\u4eca\u5e74\u7684\u5904\u7406\u5668\u4e0a\u53ef\u4ee5\u6b63\u5e38\u8dd1\uff0c\u660e\u5e74\u51fa\u4e86\u65b0\u7684\u5904\u7406\u5668\uff0c\u51fa\u73b0\u4e86\u4e0d\u517c\u5bb9\u7684\u5730\u65b9\uff0c\u53c8\u8981\u91cd\u65b0\u6539\u4e00\u904d\uff0c\u8fd9\u4f1a\u628a\u8f6f\u4ef6\u5f00\u53d1\u8005\u7ed9\u8d76\u8dd1\u7684\u3002\u5728\u8fd9\u79cd\u522b\u626d\u7684\u5fc3\u6001\u4e0b\uff0c\u5f88\u957f\u65f6\u95f4\u4ee5\u6765\uff0c\u786c\u4ef6\u5382\u5546\u5bf9\u6b64\u90fd\u5199\u7684\u6709\u4e9b\u8bed\u7109\u4e0d\u8be6\uff0c\u76f8\u5173\u7684\u4e89\u8bba\u5728\u96f6\u51e0\u5e74\u90fd\u4e00\u76f4\u80fd\u770b\u5230\u3002</p>\n<p>\u4e0d\u8fc7\u597d\u5728\u73b0\u5728\u662f 2024 \u5e74\uff0c\u5927\u591a\u6570\u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\u90fd\u5df2\u7ecf\u6bd4\u8f83\u660e\u786e\uff0c\u867d\u7136\u5f88\u591a\u65f6\u5019\u786c\u4ef6\u5382\u5546\u505a\u7684\u662f\u6bd4\u8f83\u5bbd\u677e\u7684\u4fdd\u8bc1\uff0c\u5b9e\u9645\u5b9e\u73b0\u7684\u65f6\u5019\u4f1a\u66f4\u52a0\u4e25\u683c\uff0c\u4f8b\u5982\u58f0\u79f0 A \u548c B \u662f\u5141\u8bb8\u4e71\u5e8f\u6267\u884c\u7684\uff0c\u4f46\u5b9e\u9645\u4e0a\u76ee\u524d\u7684\u6240\u6709\u786c\u4ef6\u90fd\u6ca1\u6709\u8fd9\u4e48\u505a\uff0c\u8f6f\u4ef6\u4e5f\u53ea\u80fd\u6309\u7167\u6700\u4fdd\u5b88\u7684\u65b9\u5f0f\u6765\u505a\u5047\u8bbe\u3002\u4f46\u6709\u603b\u6bd4\u6ca1\u6709\u597d\uff0c\u53ef\u80fd\u4e5f\u662f\u786c\u4ef6\u5382\u5546\u7814\u7a76\u4e86\u5f88\u591a\u5e74\uff0c\u6ca1\u53d1\u73b0\u4ec0\u4e48\u53ef\u4ee5\u7ee7\u7eed\u4f18\u5316\u7684\u4f59\u5730\u4e86\uff0c\u4e0d\u5982\u6b7b\u4e86\u5fc3\u628a\u89c4\u77e9\u7ed9\u5b9a\u4e0b\u6765\uff0c\u628a\u8f6f\u4ef6\u751f\u6001\u7ed9\u6253\u597d\u3002</p>\n<p>\u73b0\u5728\u5f00\u59cb\u8bb2\u5b9e\u9645\u7684\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e24\u4e2a\u6982\u5ff5\u603b\u662f\u653e\u5728\u4e00\u8d77\u8bb2\uff1f\u4ec0\u4e48\u662f\u6a21\u578b\uff1f\u4ec0\u4e48\u662f\u5e8f\uff1f</p>\n<p>CPU \u6838\u5fc3\u7684\u5b9e\u73b0\u662f\u5f88\u590d\u6742\u7684\uff0c\u4e0d\u540c\u4ee3\u7684 CPU \u67b6\u6784\u7684\u5b9e\u73b0\u4e5f\u6709\u5f88\u591a\u4e0d\u540c\uff0c\u5c4f\u853d\u8fd9\u4e9b\u5fae\u67b6\u6784\u7684\u7ec6\u8282\uff0c\u628a\u5b83\u4eec\u5bf9\u8f6f\u4ef6\u66b4\u9732\u51fa\u6765\u7684\u884c\u4e3a\uff0c\u62bd\u8c61\u51fa\u4e00\u4e2a\u7edf\u4e00\u7684\u786c\u4ef6\u6a21\u578b\uff0c\u8fd9\u4e2a\u6a21\u578b\u5c55\u73b0\u4e86\u786c\u4ef6\u9488\u5bf9\u5185\u5b58\u8bbf\u95ee\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u5c31\u662f\u5185\u5b58\u6a21\u578b\u3002\u6839\u636e\u5185\u5b58\u6a21\u578b\uff0c\u5b9a\u4e49\u54ea\u4e9b\u60c5\u51b5\u4e0b\uff0c\u54ea\u4e9b\u6307\u4ee4\u53ef\u4ee5\u548c\u54ea\u4e9b\u6307\u4ee4\u4e71\u5e8f\uff0c\u4e3a\u4e86\u907f\u514d\u4e71\u5e8f\uff0c\u53c8\u53ef\u4ee5\u6dfb\u52a0\u54ea\u4e9b\u6307\u4ee4\u6765\u907f\u514d\u4e71\u5e8f\uff0c\u8fd9\u5c31\u662f\u5185\u5b58\u5e8f\u3002\u901a\u8fc7\u5bf9\u786c\u4ef6\u7684\u5efa\u6a21\uff0c\u628a\u590d\u6742\u7684\u5fae\u67b6\u6784\u5b9e\u73b0\u5265\u79bb\u51fa\u6765\uff0c\u5f97\u5230\u4e00\u4e2a\u62bd\u8c61\u7684\u6a21\u578b\uff0c\u4ee5\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u7406\u8bba\u53bb\u7814\u7a76\u5b83\u7684\u884c\u4e3a\u3002</p>\n<h3 id=\"sc\">SC<a class=\"headerlink\" href=\"#sc\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u6765\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u5185\u5b58\u6a21\u578b\u7684\u4f8b\u5b50\uff1a\u5047\u5982 CPU \u4e0d\u505a\u4efb\u4f55\u7684\u4e71\u5e8f\uff0c\u4e25\u683c\u6309\u7167\u6307\u4ee4\u7684\u987a\u5e8f\u8fdb\u884c\u8bbf\u5b58\uff1b\u4ece\u591a\u6838\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u6765\u81ea\u4e0d\u540c\u6838\u5fc3\u7684\u8bbf\u5b58\u90fd\u4f1a\u5230\u8fbe\u5185\u5b58\u5b50\u7cfb\u7edf\uff0c\u6bcf\u4e2a\u8bbf\u5b58\u90fd\u662f\u539f\u5b50\u7684\u3002\u90a3\u4e48\u6700\u540e\u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u8fdb\u884c\u7684\u8bbf\u5b58\u5e8f\u5217\uff0c\u5c31\u662f\u5404\u4e2a\u6838\u5fc3\u7684\u7a0b\u5e8f\u7684\u8bbf\u5b58\u5e8f\u5217\u4ea4\u9519\u7684\u7ed3\u679c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff1a</p>\n<p>A \u6838\u5fc3\u4e0a\u7684\u7a0b\u5e8f\u8981\u8fdb\u884c Read a\uff08\u8868\u793a\u8bfb\u53d6 a \u5730\u5740\u7684\u6570\u636e\uff0c\u4e0b\u9762\u7b80\u79f0 Ra\uff09\u548c Write a \u64cd\u4f5c\uff08\u8868\u793a\u628a\u6570\u636e\u5199\u5165 a \u5730\u5740\uff0c\u4e0b\u9762\u7b80\u79f0 Wa\uff09\uff1bB \u6838\u5fc3\u4e0a\u7684\u7a0b\u5e8f\u8981\u8fdb\u884c Read b \u548c Write b \u64cd\u4f5c\u3002\u7531\u4e8e\u6bcf\u4e2a\u6838\u5fc3\u5185\u90e8\u4e0d\u4f1a\u5bf9\u8bbf\u5b58\u8fdb\u884c\u91cd\u6392\uff0c\u6240\u4ee5\u8fd9\u4e9b\u8bbf\u5b58\u64cd\u4f5c\u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u6267\u884c\u65f6\uff0c\u4f1a\u4fdd\u6301\u5b83\u5728\u7a0b\u5e8f\u91cc\u7684\u6267\u884c\u987a\u5e8f\uff0c\u8fd9\u4e2a\u53eb\u505a program order\u3002\u7531\u4e8e\u4e0d\u540c\u6838\u5fc3\u53d1\u8d77\u8bbf\u5b58\u7684\u65f6\u95f4\u4e0d\u540c\uff0c\u6700\u540e\u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u6267\u884c\u7684\u8bbf\u5b58\u53ef\u80fd\u6709\u8fd9\u4e9b\u60c5\u51b5\uff1a</p>\n<ul>\n<li>Ra Wa Rb Wb</li>\n<li>Ra Rb Wa Wb</li>\n<li>Ra Rb Wb Wa</li>\n<li>Rb Ra Wa Wb</li>\n<li>Rb Ra Wb Wa</li>\n<li>Rb Wb Ra Wa</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u53ef\u80fd\u662f\u5148\u5b8c\u6210\u6240\u6709 A \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff0c\u518d\u5b8c\u6210 B \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff08Ra Wa Rb Wb\uff09\uff0c\u4e5f\u53ef\u80fd\u53cd\u8fc7\u6765\uff0c\u5148\u5b8c\u6210 B \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff0c\u518d\u5b8c\u6210 A \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff08Rb Wb Ra Wa\uff09\uff0c\u4e5f\u53ef\u80fd\u4e24\u4e2a\u6838\u5fc3\u7684\u8bbf\u5b58\u4ea4\u9519\u8fdb\u884c\uff08\u4f8b\u5982 Ra Rb Wa Wb\uff09\u3002\u5b83\u4eec\u90fd\u6ee1\u8db3\u4e00\u4e2a\u6761\u4ef6\uff1aRa \u4e00\u5b9a\u5728 Wa \u4e4b\u524d\uff0cRb \u4e00\u5b9a\u5728 Wb \u4e4b\u524d\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0cRa \u4e00\u5b9a\u5728 Wa \u4e4b\u524d\u7684\u8fd9\u79cd program order \u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u7684\u6267\u884c\u987a\u5e8f memory order \u91cc\u4e5f\u4e00\u5b9a\u4f1a\u4fdd\u8bc1\u3002</p>\n<p>\u8fd9\u79cd\u5185\u5b58\u6a21\u578b\u5c31\u662f Sequential Consistency (\u7b80\u79f0 SC)\uff0c\u5b83\u7684\u6027\u8d28\u5c31\u662f\u9075\u5faa program order\uff0c\u4ece\u6bcf\u4e2a\u6838\u5fc3\u6765\u770b\uff0c\u4ee3\u7801\u600e\u4e48\u5199\u7684\u5c31\u600e\u4e48\u8dd1\uff0c\u4e0d\u505a\u91cd\u6392\uff0c\u800c\u6765\u81ea\u4e0d\u540c\u6838\u5fc3\u7684\u8bbf\u5b58\u4e4b\u95f4\u7684\u987a\u5e8f\u4e0d\u505a\u8981\u6c42\u3002\u4e0b\u9762\u662f SC \u6a21\u578b\u7684\u56fe\u793a\uff08\u56fe\u6e90 <a href=\"https://www.cl.cam.ac.uk/~pes20/ppc-supplemental/test7.pdf\">A Tutorial Introduction to the ARM and POWER Relaxed Memory Model</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_sc.png\" /></p>\n<p>\u6839\u636e\u8fd9\u4e2a\u6027\u8d28\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5206\u6790\u8f6f\u4ef6\u7684\u884c\u4e3a\uff0c\u5224\u65ad\u5b83\u662f\u5426\u53ef\u80fd\u51fa\u73b0\u7279\u5b9a\u7684\u7ed3\u679c\u3002\u4e0b\u9762\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<p>\u5047\u5982\u6709\u4e24\u4e2a\u7ebf\u7a0b\uff0cA \u7ebf\u7a0b\u8981\u7ed9 B \u7ebf\u7a0b\u4f20\u8f93\u6570\u636e\uff0c\u4e24\u4e2a\u7ebf\u7a0b\u5206\u522b\u8dd1\u5728\u4e24\u4e2a\u6838\u5fc3\u4e0a\u3002\u4e3a\u4e86\u4f20\u8f93\u6570\u636e\uff0cA \u628a\u6570\u636e\u653e\u5728\u5185\u5b58\u5730\u5740 x \u91cc\uff0c\u4e3a\u4e86\u6807\u8bb0\u6570\u636e\u51c6\u5907\u5b8c\u6210\uff0c\u53e6\u5916\u5728\u5185\u5b58\u5730\u5740 y \u653e\u4e86\u4e00\u4e2a\u6807\u8bb0\uff0c0 \u8868\u793a\u6570\u636e\u8fd8\u6ca1\u51c6\u5907\u597d\uff0c1 \u8868\u793a\u6570\u636e\u51c6\u5907\u597d\u4e86\u3002\u90a3\u4e48 A \u8981\u4f20\u8f93\u6570\u636e\u7684\u65f6\u5019\uff0c\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u5f80 y \u5730\u5740\u5199\u5165 0</li>\n<li>\u8981\u4f20\u8f93\u6570\u636e\u65f6\uff0c\u5148\u5f80 x \u5730\u5740\u5199\u5165\u8981\u4f20\u8f93\u7684\u6570\u636e\uff0c\u518d\u5f80 y \u5730\u5740\u5199\u5165 1</li>\n</ol>\n<p>\u53e6\u4e00\u8fb9\uff0cB \u7ebf\u7a0b\u8981\u7b49\u5f85 A \u7ebf\u7a0b\u53d1\u9001\u7684\u6570\u636e\uff0c\u90a3\u4e48\u5b83\u5e94\u8be5\uff1a</p>\n<ol>\n<li>\u8bfb\u53d6 y \u5730\u5740\u7684\u5185\u5bb9\uff0c\u68c0\u67e5\u662f\u5426\u4e3a 1</li>\n<li>\u5982\u679c\u662f 1\uff0c\u8bf4\u660e\u4f20\u8f93\u7684\u6570\u636e\u5df2\u7ecf\u5728 x \u5730\u5740\u4e2d\u4e86\uff0c\u518d\u4ece x \u5730\u5740\u8bfb\u53d6\u8981\u4f20\u8f93\u7684\u6570\u636e</li>\n</ol>\n<p>\u73b0\u5728\u95ee\u9898\u6765\u4e86\uff1a\u4ee5\u4e0a\u7684\u5199\u6cd5\uff0c\u5b83\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u5417\uff1f\u6211\u5f53\u7136\u53ef\u4ee5\u53bb\u5404\u4e2a\u786c\u4ef6\u5e73\u53f0\u4e0a\u90fd\u6d4b\u8bd5\u6d4b\u8bd5\uff0c\u770b\u770b\u5230\u5e95\u80fd\u4e0d\u80fd\u5de5\u4f5c\u3002\u4f46\u662f\u65e2\u7136\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u4e86\u786c\u4ef6\u662f\u6309\u7167\u4e00\u5b9a\u7684\u5185\u5b58\u6a21\u578b\u5b9e\u73b0\u7684\uff0c\u90a3\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\uff0c\u662f\u5426\u53ef\u4ee5\u4ece\u5185\u5b58\u6a21\u578b\u7684\u89d2\u5ea6\u6765\u5224\u65ad\u5b83\u5230\u5e95\u662f\u5426\u53ef\u884c\u3002</p>\n<p>\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u53cd\u8bc1\u6cd5\uff1a\u5982\u679c\u4e0a\u9762\u7684\u4f20\u8f93\u6570\u636e\u65b9\u6cd5\u4e0d\u53ef\u884c\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u6837\u7684\u7ed3\u679c\uff1f\u90a3\u5c31\u662f B \u8bfb\u53d6\u5230\u4e86\u9519\u8bef\u7684\u6570\u636e\uff0c\u4e5f\u5c31\u662f B \u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\u65f6\uff0cA \u8fd8\u6ca1\u6709\u6765\u5f97\u53ca\u5f80 x \u5730\u5740\u5199\u5165\u6570\u636e\u3002\u8fd9\u53ef\u80fd\u5417\uff1f\u6211\u4eec\u6765\u8fdb\u884c\u63a8\u5bfc\uff1a</p>\n<p>\u9996\u5148\u7b80\u5316\u4e00\u4e0b A \u7ebf\u7a0b\u505a\u7684\u64cd\u4f5c\uff1a</p>\n<ol>\n<li>\u5411 x \u5730\u5740\u5199\u5165\u6570\u636e\uff0c\u4e0d\u59a8\u8bbe\u8fd9\u4e2a\u6570\u636e\u662f 1\uff0c\u4e5f\u5c31\u662f <code>*x = 1</code>\uff0c\u8bb0\u4e3a Wx1\uff08W \u8868\u793a write\uff0c\u540e\u9762\u8ddf\u968f\u5730\u5740\u4ee5\u53ca\u5199\u5165\u7684\u6570\u636e\uff09</li>\n<li>\u5411 y \u5730\u5740\u5199\u5165 1\uff0c\u8868\u793a\u6570\u636e\u51c6\u5907\u5b8c\u6210\uff0c\u4e5f\u5c31\u662f <code>*y = 1</code>\uff0c\u8bb0\u4e3a Wy1</li>\n</ol>\n<p>\u63a5\u7740\u662f B \u7ebf\u7a0b\u505a\u7684\u64cd\u4f5c\uff0c\u5047\u8bbe\u51fa\u73b0\u4e86\u9519\u8bef\u60c5\u51b5\uff0c\u4e5f\u5c31\u662f\u5728 <code>y = 1</code> \u7684\u65f6\u5019\uff0c\u4ece x \u8bfb\u53d6\u4e86\u9519\u8bef\u7684\u6570\u636e\uff1a</p>\n<ol>\n<li>\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u5f97\u5230\u4e86 1\uff0c\u8868\u793a\u6570\u636e\u51c6\u5907\u5b8c\u6210\uff0c\u4e5f\u5c31\u662f <code>r1 = *y</code>\uff0cr1 \u7b49\u4e8e 1\uff0c\u8bb0\u4e3a Ry1\uff08R \u8868\u793a read\uff0c\u540e\u9762\u8ddf\u968f\u5730\u5740\u4ee5\u53ca\u8bfb\u53d6\u5230\u7684\u6570\u636e\uff09</li>\n<li>\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u56e0\u4e3a\u524d\u9762\u5047\u8bbe\u4e86\u8bfb\u53d6\u4e86\u9519\u8bef\u7684\u6570\u636e\uff0c\u6b63\u786e\u7684\u6570\u636e\u662f 1\uff0c\u4e0d\u59a8\u8bbe\u9519\u8bef\u7684\u6570\u636e\u662f 0\uff0c\u4e5f\u5c31\u662f <code>r2 = *x</code>\uff0cr2 \u7b49\u4e8e 0\uff0c\u8bb0\u4e3a Rx0</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u8bc1\u660e\uff1a\u5728 SC \u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u8fd9\u79cd\u53ef\u80fd\u6027\u4e0d\u5b58\u5728\uff1a</p>\n<ol>\n<li>\u5728 SC \u5185\u5b58\u6a21\u578b\u4e0b\uff0cprogram order \u5f97\u5230\u4fdd\u6301\uff0c\u4e5f\u5c31\u662f A \u548c B \u7ebf\u7a0b\u5404\u81ea\u7684\u6267\u884c\u987a\u5e8f\u662f\u4fdd\u8bc1\u7684\uff0c\u53ef\u77e5 Wx1 \u5fc5\u987b\u51fa\u73b0\u5728 Wy1 \u4e4b\u524d\uff0cRy1 \u5fc5\u987b\u51fa\u73b0\u5728 Rx0 \u4e4b\u524d\uff0c\u8bb0\u4f5c Wx1 -&gt; Wy1\uff0cRy1 -&gt; Rx0</li>\n<li>\u5bf9\u4e8e x \u5730\u5740\u6765\u8bf4\uff0cWx1 \u5199\u5165\u4e86 1\uff0cRx0 \u8bfb\u51fa\u4e86 0\uff0c\u8bf4\u660e Rx0 \u5fc5\u987b\u5728 Wx1 \u4e4b\u524d\u6267\u884c\uff0c\u624d\u53ef\u80fd\u8bfb\u5230 0\uff0c\u5373 Rx0 -&gt; Wx1\uff1b\u5bf9\u4e8e y \u5730\u5740\u6765\u8bf4\uff0cWy1 \u5199\u5165\u4e86 1\uff0cRy1 \u8bfb\u51fa\u4e86 1\uff0c\u7531\u4e8e y \u5730\u5740\u7684\u521d\u59cb\u503c\u662f 0\uff0c\u8bf4\u660e Ry1 \u5fc5\u987b\u5728 Wy1 \u4e4b\u540e\u6267\u884c\uff0c\u624d\u53ef\u80fd\u8bfb\u5230 0\uff0c\u5373 Wy1 -&gt; Ry1</li>\n</ol>\n<p>\u8fd9\u6837\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff1a</p>\n<ol>\n<li>Wx1 -&gt; Wy1</li>\n<li>Wy1 -&gt; Ry1</li>\n<li>Ry1 -&gt; Rx0</li>\n<li>Rx0 -&gt; Wx1</li>\n</ol>\n<p>\u4f60\u4f1a\u53d1\u73b0\u8fd9\u56db\u4e2a\u64cd\u4f5c\u7684\u987a\u5e8f\u5173\u7cfb\u51fa\u73b0\u4e86\u73af\uff0c\u8bf4\u660e\u4e0d\u5b58\u5728\u4e00\u4e2a\u6267\u884c\u5e8f\u5217\uff0c\u53ef\u4ee5\u540c\u65f6\u6ee1\u8db3\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u3002\u4e5f\u5c31\u8bf4\u660e SC \u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u4e0d\u53ef\u80fd\u5f97\u5230\u8fd9\u4e2a\u6267\u884c\u7ed3\u679c\u3002\u901a\u8fc7\u5185\u5b58\u6a21\u578b\uff0c\u6211\u53ef\u4ee5\u4ece\u7406\u8bba\u4e0a\u8bc1\u660e\u8fd9\u6bb5\u4ee3\u7801\u5728 SC \u5185\u5b58\u6a21\u578b\u4e0b\u662f\u6ca1\u6709\u95ee\u9898\u7684\uff0c\u90a3\u4e48\u8fd9\u6bb5\u4ee3\u7801\u5728\u6240\u6709\u5b9e\u73b0\u4e86 SC \u5185\u5b58\u6a21\u578b\u7684\u5904\u7406\u5668\u4e0a\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u3002</p>\n<h3 id=\"litmus\">Litmus<a class=\"headerlink\" href=\"#litmus\" title=\"Permanent link\">&para;</a></h3>\n<p>\u50cf\u4e0a\u9762\u8fd9\u79cd\u6765\u81ea\u591a\u7ebf\u7a0b\u7f16\u7a0b\u7684\u4e00\u4e2a\u5c0f\u7247\u6bb5\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u5185\u5b58\u6a21\u578b\u7684\u89d2\u5ea6\u5206\u6790\u5b83\u53ef\u80fd\u7684\u6267\u884c\u7ed3\u679c\uff0c\u4e5f\u53ef\u4ee5\u5728\u5b9e\u9645\u7684\u5904\u7406\u5668\u4e0a\u8fd0\u884c\uff0c\u8fd9\u79cd\u5c0f\u7247\u6bb5\u5c31\u53eb\u505a Litmus test\uff0c\u4e0a\u9762\u770b\u5230\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u5176\u5b9e\u662f Litmus test \u5f53\u4e2d\u7684 Message Passing \u6d4b\u8bd5\uff08MP\uff09\u3002\u5229\u7528 <a href=\"https://github.com/herd/herdtools7\">herd/herdtools7 on GitHub</a> \u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u7535\u8111\u4e0a\u5b9e\u9645\u53bb\u8fd0\u884c Litmus test\uff0c\u89c2\u5bdf\u5b83\u7684\u5b9e\u9645\u8fd0\u884c\u7ed3\u679c\u3002herdtools7 \u7684\u5b89\u88c5\u6d41\u7a0b\uff1a</p>\n<ol>\n<li>\u5b89\u88c5 OCaml \u5de5\u5177\u94fe\uff08\u5305\u62ec opam\uff09\uff0c\u914d\u7f6e opam</li>\n<li>\u7528 opam \u5b89\u88c5 herdtools7: <code>opam install herdtools7</code></li>\n</ol>\n<p>\u6709\u4e86 herdtools7 \u4ee5\u540e\uff0c\u5982\u679c\u8981\u6267\u884c\u4e0a\u9762\u7684 Message Passing \u6d4b\u8bd5\uff0c\u53ea\u9700\u8981\u6309\u7167\u8fd0\u884c\u5982\u4e0b\u7684\u547d\u4ee4\uff08\u4ee5 x86 \u4e3a\u4f8b\uff09\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>diycross7<span class=\"w\"> </span>-arch<span class=\"w\"> </span>X86<span class=\"w\"> </span>-name<span class=\"w\"> </span>MP-X86<span class=\"w\"> </span>PodWW<span class=\"w\"> </span>Rfe<span class=\"w\"> </span>PodRR<span class=\"w\"> </span>Fre\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>litmus7<span class=\"w\"> </span>MP-X86.litmus\n</span></code></pre></div>\n<p>\u5b83\u5c31\u4f1a\u5728 x86 \u673a\u5668\u4e0a\u8fd0\u884c MP \u6d4b\u8bd5\uff0c\u8fd0\u884c 1000000 \u6b21\u540e\uff0c\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0\u524d\u9762\u6240\u8ff0\u7684\u8bfb\u51fa\u6765 y \u7b49\u4e8e 1 \u4f46\u662f x \u7b49\u4e8e 0 \u7684\u60c5\u51b5\u3002\u90a3\u4e48\u4e0a\u9762\u51fa\u73b0\u7684 <code>PodWW Rfe PodRR Fre</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f\u6211\u4eec\u9996\u5148\u6765\u770b\u770b\u751f\u6210\u7684 <code>MP-X86.litmus</code> \u6587\u4ef6\u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>X86 MP-X86\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>&quot;PodWW Rfe PodRR Fre&quot;\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>Cycle=Rfe PodRR Fre PodWW\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>Generator=diycross7 (version 7.56+03)\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>Prefetch=0:x=F,0:y=W,1:y=F,1:x=T\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>Com=Rf Fr\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>Orig=PodWW Rfe PodRR Fre\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>{\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a>}\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a> P0         | P1          ;\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a> MOV [x],$1 | MOV EAX,[y] ;\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a> MOV [y],$1 | MOV EBX,[x] ;\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a>exists (1:EAX=1 /\\ 1:EBX=0)\n</span></code></pre></div>\n<p>\u5ffd\u7565\u5f00\u5934\u7684\u90e8\u5206\uff0c\u76f4\u63a5\u4ece P0 P1 \u8fd9\u4e00\u884c\u5f00\u59cb\u770b\uff1aP0 \u548c P1 \u5bf9\u5e94\u4e24\u4e2a\u5904\u7406\u5668\u6838\u5fc3\uff0c\u4e0b\u9762\u662f\u5728\u8fd9\u4e24\u4e2a\u6838\u5fc3\u4e0a\u8981\u8fd0\u884c\u7684\u6c47\u7f16\u6307\u4ee4\uff1a</p>\n<ul>\n<li>P0 \u4e0a\u8fd0\u884c\uff1a<ul>\n<li>MOV [x], $1\uff1a\u5f80 x \u5730\u5740\u5199\u5165 1\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>*x = 1</code>, Wx1</li>\n<li>MOV [y], $1\uff1a\u5f80 y \u5730\u5740\u5199\u5165 1\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>*y = 1</code>, Wy1</li>\n</ul>\n</li>\n<li>P1 \u4e0a\u8fd0\u884c\uff1a<ul>\n<li>MOV EAX, [y]\uff1a\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u4fdd\u5b58\u5728 EAX \u5bc4\u5b58\u5668\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>r1 = *y</code></li>\n<li>MOV EBX, [x]\uff1a\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u4fdd\u5b58\u5728 EAX \u5bc4\u5b58\u5668\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>r2 = *x</code></li>\n</ul>\n</li>\n</ul>\n<p>\u6b63\u597d\u5c31\u662f Message Passing \u6d4b\u8bd5\u7684\u5185\u5bb9\uff0c\u53ea\u4e0d\u8fc7\u7528\u6c47\u7f16\u5b8c\u6210\u4e86\u5b9e\u73b0\u3002\u6700\u540e\uff0c\u5b83\u63d0\u95ee\uff1a<code>exists (1:EAX=1 /\\ 1:EBX=0)</code>\uff0c\u5373\u662f\u5426\u5b58\u5728\u4e00\u79cd\u53ef\u80fd\uff0cP1 \u7684 EAX \u5bc4\u5b58\u5668\uff08<code>1:EAX</code>\uff09\u7b49\u4e8e 1\uff0c\u540c\u65f6\uff08<code>/\\</code> \u8868\u793a\u903b\u8f91\u4e0e\uff09P1 \u7684 EBX \u5bc4\u5b58\u5668\uff08<code>1:EBX</code>\uff09\u7b49\u4e8e 0\uff1f\u8fd9\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684\u9519\u8bef\u60c5\u51b5\uff0cy \u7b49\u4e8e 1 \u4f46\u662f x \u7b49\u4e8e 0\u3002</p>\n<p>\u63a5\u4e0b\u6765\u7684 <code>litmus7 MP-X86.litmus</code> \u547d\u4ee4\u5c31\u4f1a\u5728\u4e24\u4e2a\u6838\u5fc3\u4e0a\u8fd0\u884c\u8fd9\u6bb5\u6c47\u7f16\uff0c\u5e76\u4e14\u7edf\u8ba1\u6700\u7ec8\u7684\u6267\u884c\u7ed3\u679c\uff0c\u53d1\u73b0\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>Histogram (3 states)\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>500087:&gt;1:EAX=0; 1:EBX=0;\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>1281  :&gt;1:EAX=0; 1:EBX=1;\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>498632:&gt;1:EAX=1; 1:EBX=1;\n</span></code></pre></div>\n<p>\u8fd0\u884c\u4e86 1000000 \u6b21\uff0c\u89c2\u5bdf\u5230 500087 \u6b21 y=1, x=0\uff1b1281 \u6b21 y=0, x=1\uff1b498632 \u6b21 y=1, x=1\uff1b\u6ca1\u6709\u89c2\u5bdf\u5230 y=1 &amp;&amp; x=0\u3002\u4e5f\u5c31\u662f\u6ca1\u6709\u627e\u5230\u53cd\u4f8b\u3002</p>\n<p>\u90a3\u4e48 diycross7 \u547d\u4ee4\u662f\u600e\u4e48\u751f\u6210\u8fd9\u6bb5\u6c47\u7f16\u7684\u5462\uff1f\u7b54\u6848\u5c31\u5728 <code>PodWW Rfe PodRR Fre</code> \u53c2\u6570\u5f53\u4e2d\u3002\u5b83\u63cf\u8ff0\u7684\u5c31\u662f\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff1a</p>\n<ol>\n<li>Wx1 -&gt; Wy1: P0 \u4e0a\u7684 program order</li>\n<li>Wy1 -&gt; Ry1: memory \u4e0a\u7684\u5199\u540e\u8bfb</li>\n<li>Ry1 -&gt; Rx0: P1 \u4e0a\u7684 program order</li>\n<li>Rx0 -&gt; Wx1: memory \u4e0a\u7684\u8bfb\u540e\u5199</li>\n</ol>\n<p>\u5982\u679c\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u90fd\u5f97\u5230\u4fdd\u8bc1\uff0c\u90a3\u4e48\u5c31\u4e0d\u5b58\u5728\u4e00\u4e2a\u6267\u884c\u5e8f\u5217\u53ef\u4ee5\u540c\u65f6\u6ee1\u8db3\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u3002\u5728 diycross7 \u7684\u8bed\u8a00\u91cc\u9762\uff0c\u6211\u4eec\u628a\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u63cf\u8ff0\u51fa\u6765\uff1a</p>\n<ol>\n<li>Wx1 -&gt; Wy1: P0 \u4e0a\u7684 program order\uff0c\u5e76\u4e14\u662f\u4e24\u4e2a Write \u4e4b\u95f4\u7684 program order\uff0c\u6240\u4ee5\u662f PodWW\uff08Pod = program order\uff0cWW = write to write\uff09</li>\n<li>Wy1 -&gt; Ry1: memory \u4e0a\u7684\u5199\u540e\u8bfb\uff0c\u5e76\u4e14\u5206\u522b\u5728 P0 \u548c P1 \u4e0a\u6267\u884c\uff0c\u6240\u4ee5\u662f Rfe\uff08Rf = read from\uff0c\u540e\u9762\u7684 read \u7684\u6570\u636e\u6765\u81ea\u524d\u9762\u7684 write\uff0c\u7bad\u5934\u4ece W \u6307\u5411 R\uff0ce = external\uff0c\u8868\u793a\u8bfb\u548c\u5199\u5728\u4e24\u4e2a\u6838\u4e0a\uff09</li>\n<li>Ry1 -&gt; Rx0: P1 \u4e0a\u7684 program order\uff0c\u5e76\u4e14\u662f\u4e24\u4e2a Read \u4e4b\u95f4\u7684 program order\uff0c\u6240\u4ee5\u662f PodRR\uff08Pod = program order\uff0cRR = read to read\uff09</li>\n<li>Rx0 -&gt; Wx1: memory \u4e0a\u7684\u8bfb\u540e\u5199\uff0c\u5e76\u4e14\u5206\u522b\u5728 P1 \u548c P0 \u4e0a\u6267\u884c\uff0c\u6240\u4ee5\u662f Fre\uff08Fr = from read\uff0c\u8bfb\u5728\u524d\uff0c\u5199\u5728\u540e\uff0c\u7bad\u5934\u4ece R \u6307\u5411 W\uff0ce = external\uff0c\u8868\u793a\u8bfb\u548c\u5199\u5728\u4e24\u4e2a\u6838\u4e0a\uff09</li>\n</ol>\n<p>\u4e8e\u662f\u6211\u4eec\u5c31\u7528 <code>PodWW Rfe PodRR Fre</code> \u63cf\u8ff0\u4e86\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff0cdiycross7 \u5de5\u5177\u5c31\u6839\u636e\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff0c\u751f\u6210\u4e86\u6c47\u7f16\u7a0b\u5e8f\uff0c\u8fd9\u4e2a\u6c47\u7f16\u7a0b\u5e8f\u4f1a\u7528\u5230\u8fd9\u4e9b\u987a\u5e8f\u5173\u7cfb\uff0c\u90a3\u4e48\u5728\u5904\u7406\u5668\u4e0a\u6267\u884c\uff0c\u5c31\u53ef\u4ee5\u5224\u65ad\u5728\u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u8fd9\u4e2a\u73af\u662f\u5426\u53ef\u80fd\u6253\u7834\uff0c\u53cd\u4f8b\u662f\u5426\u53ef\u80fd\u5b58\u5728\u3002\u901a\u8fc7\u8fd9\u79cd\u63cf\u8ff0\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u51fa\u5404\u79cd\u5404\u6837\u7684 Litmus test\uff0c\u6d4b\u8bd5\u548c\u5206\u6790\u4e0d\u540c\u7684\u4ee3\u7801\u5728\u5404\u79cd\u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u4f1a\u6709\u600e\u6837\u7684\u8868\u73b0\u3002</p>\n<h3 id=\"store-buffer\">Store Buffer<a class=\"headerlink\" href=\"#store-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6682\u65f6\u5148\u4e0d\u8bb2\u5185\u5b58\u6a21\u578b\uff0c\u5148\u8bb2\u8bb2\u5904\u7406\u5668\u5728\u8bbf\u5b58\u4e0a\u7684\u4e00\u4e2a\u91cd\u8981\u7684\u4f18\u5316\uff1aStore Buffer\u3002\u5bf9\u4e8e\u4e71\u5e8f\u6267\u884c\u5904\u7406\u5668\u6765\u8bf4\uff0c\u9884\u6d4b\u6267\u884c\u662f\u6709\u9650\u5ea6\u7684\uff0c\u56e0\u4e3a\u5982\u679c\u9884\u6d4b\u9519\u8bef\u4e86\uff0c\u9700\u8981\u56de\u6eda\u5230\u6b63\u786e\u7684\u72b6\u6001\uff0c\u8fd9\u4e5f\u610f\u5473\u7740\uff0c\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u4e0d\u80fd\u7b80\u5355\u5730\u9884\u6d4b\u6267\u884c\uff1a\u4f8b\u5982\u5728\u4e00\u6bb5\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u4ee3\u7801\u91cc\uff0c\u9700\u8981\u6839\u636e\u7528\u6237\u7684\u8f93\u5165\u51b3\u5b9a\u7535\u8111\u8981\u5173\u673a\u8fd8\u662f\u91cd\u542f\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">shutdown</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"n\">do_shutdown</span><span class=\"p\">();</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"n\">do_reboot</span><span class=\"p\">();</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5047\u5982\u5904\u7406\u5668\u5b9e\u73b0\u4e86\u5206\u652f\u9884\u6d4b\uff0c\u9884\u6d4b <code>shutdown == true</code>\uff0c\u63a5\u7740\u9884\u6d4b\u6267\u884c\u4e86 <code>do_shutdown</code>\uff0c\u5982\u679c\u5904\u7406\u5668\u771f\u7684\u9884\u6d4b\u6267\u884c\u4e86\u5173\u673a\u64cd\u4f5c\uff0c\u90a3\u4e48\u7535\u8111\u5c31\u76f4\u63a5\u5173\u673a\u4e86\uff0c\u90fd\u6ca1\u6709\u6765\u5f97\u53ca\u786e\u8ba4\u662f\u4e0d\u662f\u8981\u5173\u673a\u3002\u4f8b\u5982\u5b9e\u9645\u4e0a\u53ef\u80fd <code>shutdown == false</code>\uff0c\u5e94\u8be5\u6267\u884c\u7684\u662f <code>do_reboot</code>\uff0c\u672c\u6765\u662f\u91cd\u542f\u7684\uff0c\u5374\u53d8\u6210\u4e86\u5173\u673a\u3002\u6240\u4ee5\u9884\u6d4b\u6267\u884c\u9047\u5230\u8fd9\u79cd\u5e26\u6709\u526f\u4f5c\u7528\uff08side effect\uff09\u7684\u6307\u4ee4\uff0c\u9700\u8981\u5355\u72ec\u5904\u7406\u3002</p>\n<p>\u4e00\u4e2a\u7b80\u5355\u7684\u529e\u6cd5\u5c31\u662f\u8981\u6c42\u6240\u6709\u5e26\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u987a\u5e8f\u6267\u884c\uff0c\u53ea\u6709\u524d\u9762\u7684\u6240\u6709\u6307\u4ee4\u6267\u884c\u5b8c\u4e86\uff0c\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u624d\u53ef\u4ee5\u6267\u884c\uff0c\u56e0\u4e3a\u6b64\u65f6\u4e0d\u53ef\u80fd\u56de\u6eda\u5230\u66f4\u65e9\u7684\u6307\u4ee4\u4e86\u3002\u4f46\u662f\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u5f88\u591a\uff0c\u901a\u5e38\u8ba4\u4e3a Store \u6307\u4ee4\u90fd\u6709\u526f\u4f5c\u7528\uff0c\u5982\u679c\u8003\u8651\u5230\u4fa7\u4fe1\u9053\u653b\u51fb\u548c\u5b89\u5168\u6027\uff0c\u53ef\u80fd\u8fde Load \u6307\u4ee4\u90fd\u6709\u526f\u4f5c\u7528\uff0c\u56e0\u4e3a\u5b83\u4f1a\u6539\u53d8 Cache \u7684\u72b6\u6001\uff1b\u5982\u679c\u8981\u8bbf\u95ee\u5916\u8bbe\uff0c\u90a3\u4e48 Load \u548c Store \u90fd\u6709\u526f\u4f5c\u7528\u3002\u5728\u4e71\u5e8f\u5904\u7406\u5668\u4e0a\uff0c\u5c31\u662f\u53ea\u5141\u8bb8\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u5728 Reorder Buffer\uff08ROB\uff09\u5934\u90e8\uff0c\u624d\u53ef\u4ee5\u6267\u884c\u3002\u4f46\u5982\u679c\u9047\u5230\u4e86\u7f13\u5b58\u7f3a\u5931\uff0c\u8fd9\u4e2a\u65f6\u95f4\u5c31\u4f1a\u5f88\u957f\uff0c\u4e00\u76f4\u5835\u4f4f ROB\uff0c\u5f71\u54cd\u6027\u80fd\u3002</p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u9488\u5bf9\u5199\u5165\u5185\u5b58\u7684 Store \u6307\u4ee4\uff0c\u867d\u7136\u5b83\u6709\u526f\u4f5c\u7528\uff0c\u4f46\u901a\u5e38\u8ba4\u4e3a\u7f13\u5b58\u5199\u5165\u662f\u4e0d\u4f1a\u5931\u8d25\u7684\uff0c\u6240\u4ee5\u4e0d\u7528\u62c5\u5fc3\u5199\u5165\u5931\u8d25\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u53ef\u4ee5\u628a\u8fd9\u4e9b Store \u6307\u4ee4\u653e\u5728\u4e00\u4e2a\u961f\u5217\u91cc\u9762\uff0c\u8fd9\u4e2a\u961f\u5217\u79f0\u4e3a Store Buffer\u3002\u4ece ROB \u63d0\u4ea4\u7684 Store \u6307\u4ee4\u4f1a\u653e\u5230 Store Buffer \u91cc\u9762\uff0c\u6b64\u65f6\u53ef\u4ee5\u8ba4\u4e3a Store \u6307\u4ee4\u5b8c\u6210\u4e86\u63d0\u4ea4\uff0cStore \u6307\u4ee4\u4ece ROB \u4e2d\u5220\u9664\uff0c\u4e0d\u518d\u5835\u585e\u540e\u9762\u7684\u5176\u4ed6\u6307\u4ee4\u3002Store Buffer \u961f\u5217\u91cc\u7684 Store \u6307\u4ee4\u4f1a\u6309\u987a\u5e8f\u628a\u6570\u636e\u5199\u5165\u7f13\u5b58\uff0c\u8fd9\u65f6\u5019\u518d\u9047\u5230\u7f13\u5b58\u7f3a\u5931\uff0c\u5f71\u54cd\u4e5f\u6bd4\u8f83\u5c0f\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u7531\u4e8e Store Buffer \u91cc\u7684\u6570\u636e\u8fd8\u6ca1\u5199\u5165\u7f13\u5b58\uff0c\u7f13\u5b58\u91cc\u7684\u6570\u636e\u4e0d\u4e00\u5b9a\u662f\u6700\u65b0\u7684\uff0c\u6240\u4ee5\u540e\u7eed Load \u6307\u4ee4\u8bfb\u53d6\u6570\u636e\u65f6\uff0c\u4e0d\u4ec5\u8981\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\uff0c\u8fd8\u8981\u67e5\u8be2 Store Buffer\uff0c\u5982\u679c\u7f13\u5b58\u548c Store Buffer \u90fd\u6709\u6570\u636e\uff0c\u8981\u4ee5 Store Buffer \u4e3a\u51c6\u3002\u8fd9\u6837\u5b9e\u73b0\u4ee5\u540e\uff0c\u4ece\u5355\u7ebf\u7a0b\u7a0b\u5e8f\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\u3002\u4f46\u662f\u591a\u7ebf\u7a0b\u7a0b\u5e8f\u5c31\u9047\u5230\u4e86\u4e00\u4e2a\u65b0\u95ee\u9898\uff1a</p>\n<ul>\n<li>A \u6838\u5fc3\u5411 x \u5730\u5740\u5199\u5165 1\uff0c\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e</li>\n<li>B \u6838\u5fc3\u5411 y \u5730\u5740\u5199\u5165 1\uff0c\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e</li>\n<li>A \u6838\u5fc3\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u56e0\u4e3a A \u6ca1\u6709\u5199\u5165 y \u5730\u5740\uff0c\u6240\u4ee5 A \u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6 y \u5730\u5740\u7684\u6570\u636e\uff1b\u540c\u65f6 B \u6838\u5fc3\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u540c\u7406 B \u4e5f\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6 x \u5730\u5740\u7684\u6570\u636e</li>\n<li>\u4e24\u4e2a\u6838\u5fc3\u5199\u5165\u6570\u636e\u7684\u6307\u4ee4\u8fdb\u5165\u4e86\u5404\u81ea\u6838\u5fc3\u7684 Store Buffer\uff0c\u4f46\u662f\u8fd8\u6ca1\u5199\u5165\u7f13\u5b58\uff1b\u56e0\u6b64 A \u548c B \u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\u7684\u6570\u636e\u90fd\u662f 0</li>\n</ul>\n<p>\u7528\u7a0b\u5e8f\u6765\u8868\u8fbe\uff0c\u5c31\u662f\uff1a</p>\n<p>A \u6838\u5fc3\uff1a</p>\n<ul>\n<li>Wx1: *x = 1</li>\n<li>Ry0: r1 = *y</li>\n</ul>\n<p>B \u6838\u5fc3\uff1a</p>\n<ul>\n<li>Wy1: *y = 1</li>\n<li>Rx0: r2 = *x</li>\n</ul>\n<p>\u4f60\u53ef\u80fd\u4f1a\u60f3\uff0c\u8fd9\u600e\u4e48\u53ef\u80fd\uff1f\u660e\u660e\u4e24\u8fb9\u90fd\u662f\u5148\u5199\u540e\u8bfb\uff0c\u600e\u4e48\u7ed3\u679c\u5374\u597d\u50cf\u662f\u5148\u8bfb\u540e\u5199\uff1f\u5982\u679c\u6211\u4eec\u7ee7\u7eed\u6309\u7167 SC \u6a21\u578b\u7684\u89c4\u5b9a\u6765\u5bfb\u627e\u987a\u5e8f\u5173\u7cfb\uff1a</p>\n<ul>\n<li>program order: Wx1 -&gt; Ry0, Wy1 -&gt; Rx0</li>\n<li>coherence\uff1aRy0 -&gt; Wy1\uff0cRx0 -&gt; Wx1</li>\n</ul>\n<p>\u51fa\u73b0\u4e86\u73af\uff1aWx1 -&gt; Ry0 -&gt; Wy1 -&gt; Rx0 -&gt; Wx1\uff0c\u8bf4\u660e\u8fd9\u4e2a\u7ed3\u679c\u5728 SC \u6a21\u578b\u4e0b\u4e0d\u53ef\u80fd\u6210\u7acb\u3002\u4f46\u5982\u679c\u6211\u4eec\u5728 x86 \u673a\u5668\u4e0a\u771f\u7684\u8dd1\u4e00\u4e0b\u8fd9\u4e2a\u6d4b\u8bd5\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>diycross7<span class=\"w\"> </span>-arch<span class=\"w\"> </span>X86<span class=\"w\"> </span>-name<span class=\"w\"> </span>SB-X86<span class=\"w\"> </span>PodWR<span class=\"w\"> </span>Fre<span class=\"w\"> </span>PodWR<span class=\"w\"> </span>Fre\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a>litmus7<span class=\"w\"> </span>SB-X86.litmus\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u7684 <code>PodWR Fre PodWR Fre</code> \u662f\u8fd9\u4e48\u6765\u7684\uff1a</p>\n<ul>\n<li>Wx1 -&gt; Ry0: PodWR, program order, write to read</li>\n<li>Ry0 -&gt; Wy1: Fre, from-read, external</li>\n<li>Wy1 -&gt; Rx0: PodWR, program order, write to read</li>\n<li>Rx0 -&gt; Wx1: Fre, from-read, external</li>\n</ul>\n<p>diycross7 \u547d\u4ee4\u751f\u6210\u4e86\u4e0b\u9762\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"w\"> </span><span class=\"nf\">P0</span><span class=\"w\">          </span><span class=\"err\">|</span><span class=\"w\"> </span><span class=\"no\">P1</span><span class=\"w\">          </span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"w\"> </span><span class=\"nf\">MOV</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x</span><span class=\"p\">],</span><span class=\"no\">$1</span><span class=\"w\">  </span><span class=\"err\">|</span><span class=\"w\"> </span><span class=\"no\">MOV</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">y</span><span class=\"p\">],</span><span class=\"no\">$1</span><span class=\"w\">  </span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\"> </span><span class=\"nf\">MOV</span><span class=\"w\"> </span><span class=\"no\">EAX</span><span class=\"p\">,[</span><span class=\"no\">y</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"err\">|</span><span class=\"w\"> </span><span class=\"no\">MOV</span><span class=\"w\"> </span><span class=\"no\">EAX</span><span class=\"p\">,[</span><span class=\"no\">x</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"nf\">exists</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"no\">EAX</span><span class=\"err\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">/\\</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"no\">EAX</span><span class=\"err\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span></code></pre></div>\n<p>\u8fd0\u884c litmus7 \u5f97\u5230\u5982\u4e0b\u7684\u7ed3\u679c\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a>Histogram (4 states)\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a>540   *&gt;0:EAX=0; 1:EAX=0;\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>499697:&gt;0:EAX=1; 1:EAX=0;\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a>499760:&gt;0:EAX=0; 1:EAX=1;\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a>3     :&gt;0:EAX=1; 1:EAX=1;\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a>Ok\n</span></code></pre></div>\n<p>\u4f60\u4f1a\u53d1\u73b0\u5728 x86 \u673a\u5668\u4e0a\u771f\u7684\u51fa\u73b0\u4e86\u8fd9\u4e2a\u7ed3\u679c\uff1a\u4ece x \u548c y \u8bfb\u51fa\u6765\u7684\u6570\u636e\u90fd\u662f 0\u3002\u8fd9\u5c31\u8bf4\u660e x86 \u673a\u5668\u5b9e\u73b0\u7684\u5e76\u4e0d\u662f SC \u7684\u5185\u5b58\u6a21\u578b\u3002\u5728 SC \u6a21\u578b\u4e0b\uff0c\u8fd9\u6bb5\u4ee3\u7801\u7684\u56db\u4e2a\u987a\u5e8f\u5173\u7cfb\u6210\u73af\uff0c\u4f7f\u5f97\u4e0d\u5b58\u5728 x \u548c y \u8bfb\u51fa\u6765\u90fd\u4e3a 0 \u7684\u60c5\u51b5\uff1b\u73b0\u5728\u786e\u5b9e\u89c2\u5bdf\u5230\u4e86\u8bfb\u51fa\u6765 x \u548c y \u90fd\u4e3a 0 \u7684\u60c5\u51b5\uff0c\u8bf4\u660e\u8fd9\u4e2a\u73af\u88ab\u65ad\u5f00\u4e86\uff0c\u6709\u7684\u8fb9\u4e0d\u518d\u6210\u7acb\u3002</p>\n<p>\u56de\u60f3\u524d\u9762\u63d0\u5230\u7684 Store Buffer \u7684\u786c\u4ef6\u5b9e\u73b0\uff0c\u95ee\u9898\u51fa\u73b0\u5728\uff0cx \u548c y \u5904\u4e8e\u4e0d\u540c\u7684\u5730\u5740\uff0cA \u6838\u5fc3\u8bfb\u53d6 y \u65f6\uff0c\u76f4\u63a5\u901a\u8fc7\u7f13\u5b58\u8bfb\u53d6\u6570\u636e\uff0c\u6b64\u65f6\u4ece\u7f13\u5b58\u7684\u89c6\u89d2\u6765\u770b\uff0c\u5148\u770b\u5230\u4e86 A \u6838\u5fc3\u8bfb\u53d6 y\uff0c\u540e\u770b\u5230\u4e86 A \u6838\u5fc3\u5199\u5165\u4e86 x\uff0c\u8fd9\u548c\u6307\u4ee4\u7684\u987a\u5e8f\u4e0d\u540c\u3002\u4e5f\u5c31\u662f PodWR\uff08Program order write to read\uff09\u8fd9\u6761\u8fb9\u4e0d\u518d\u6210\u7acb\u4e86\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4ece\u6838\u5916\u7684\u89c6\u89d2\u770b\uff0c\u7a0b\u5e8f\u7684\u5148 Store \u540e Load\uff0c\u53ef\u80fd\u88ab\u91cd\u6392\u4e3a\u5148 Load \u540e Store\u3002\u8fd9\u4e5f\u8bf4\u660e x86 \u7684\u5904\u7406\u5668\u505a\u4e86 Store Buffer \u7684\u786c\u4ef6\u5b9e\u73b0\u3002\u5728\u4f18\u5316\u6027\u80fd\u7684\u540c\u65f6\uff0c\u4e5f\u5207\u5b9e\u6539\u53d8\u4e86\u5185\u5b58\u6a21\u578b\u3002</p>\n<h3 id=\"x86-tso\">X86-TSO<a class=\"headerlink\" href=\"#x86-tso\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f9d\u6258 Store Buffer\uff0c\u6211\u4eec\u53ef\u4ee5\u6784\u5efa\u51fa\u4e00\u4e2a\u65b0\u7684\u5185\u5b58\u6a21\u578b\uff1a\u5728\u6bcf\u4e2a\u6838\u5fc3\u548c\u5185\u5b58\u5b50\u7cfb\u7edf\u4e4b\u95f4\uff0c\u591a\u4e86\u4e00\u4e2a Store Buffer\uff0cStore \u6307\u4ee4\u4f1a\u5148\u8fdb\u5165 Store Buffer\uff0c\u518d\u8fdb\u5165\u5185\u5b58\u5b50\u7cfb\u7edf\u3002\u5f53 Load \u6307\u4ee4\u548c Store Buffer \u4e2d\u7684 Store \u6307\u4ee4\u6709\u6570\u636e\u76f8\u5173\u65f6\uff0c\u4f1a\u4ece Store Buffer \u4e2d\u53d6\u6570\u636e\uff0c\u5982\u679c\u4e0d\u76f8\u5173\uff0c\u6216\u8005\u4e0d\u5b8c\u5168\u76f8\u5173\uff08\u4f8b\u5982\u53ea\u6709\u4e00\u90e8\u5206\u91cd\u5408\uff09\uff0c\u5219\u4f1a\u4ece\u5185\u5b58\u5b50\u7cfb\u7edf\u4e2d\u53d6\u6570\u636e\uff0c\u6b64\u65f6\u4ece\u5185\u5b58\u5b50\u7cfb\u7edf\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5c31\u53d1\u751f\u4e86 Load \u63d0\u524d\u4e8e Store \u6267\u884c\u7684\u91cd\u6392\u3002\u8fd9\u4e2a\u6a21\u578b\u88ab\u79f0\u4e3a <a href=\"https://dl.acm.org/doi/10.1145/1785414.1785443\">X86-TSO</a>\uff08\u56fe\u6e90 <a href=\"https://link.springer.com/book/10.1007/978-3-031-01764-3\">A Primer on Memory Consistency and Cache Coherence, Second Edition</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_x86_tso.png\" /></p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cX86-TSO \u6a21\u578b\u662f\u5728 <a href=\"https://dl.acm.org/doi/10.1145/1785414.1785443\">2010 \u5e74\u7684\u8bba\u6587 x86-TSO: a rigorous and usable programmer's model for x86 multiprocessors</a>\u4e2d\u7531\u5b66\u672f\u754c\u5bf9\u73b0\u6709 x86 \u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u7684\u603b\u7ed3\uff0c\u4f46 Intel \u548c AMD \u5728\u4ed6\u4eec\u7684\u6587\u6863\u4e2d\u6ca1\u6709\u76f4\u63a5\u91c7\u7528\u8fd9\u4e2a\u6a21\u578b\uff0c\u800c\u662f\u7ed9\u51fa\u4e86\u5404\u79cd\u5404\u6837\u7684\u89c4\u5219\u3002\u4f46\u5b9e\u8df5\u4e2d\uff0c\u53ef\u4ee5\u8ba4\u4e3a x86 \u5904\u7406\u5668\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u6a21\u578b\uff0c\u4ece\u5404\u81ea litmus \u6d4b\u8bd5\u4e2d\uff0c\u4e5f\u6ca1\u6709\u53d1\u73b0\u7406\u8bba\u548c\u5b9e\u9645\u4e0d\u4e00\u81f4\u7684\u5730\u65b9\u3002</p>\n<p>\u8fd9\u91cc\u7684 TSO \u7684\u5168\u79f0\u662f Total Store Order\uff0c\u610f\u601d\u662f\u9488\u5bf9 Store \u6307\u4ee4\uff08\u53ea\u6709\u79bb\u5f00 Store Buffer \u8fdb\u5165\u7f13\u5b58\u7684\u624d\u7b97\uff09\uff0c\u6709\u4e00\u4e2a\u5168\u5c40\u7684\u987a\u5e8f\u3002\u5185\u5b58\u5b50\u7cfb\u7edf\u4f1a\u5904\u7406\u6765\u81ea\u4e0d\u540c\u6838\u5fc3\u7684 Store\uff0c\u4f46\u4f1a\u4fdd\u8bc1 Store \u6709\u4e00\u4e2a\u5148\u540e\u987a\u5e8f\uff0c\u5e76\u4e14\u6240\u6709\u6838\u5fc3\u4f1a\u770b\u5230\u540c\u4e00\u4e2a\u987a\u5e8f\u3002\u8fd9\u4e2a\u6982\u5ff5\u6709\u4e9b\u65f6\u5019\u8fd8\u4f1a\u88ab\u79f0\u4e3a Multi-copy Atomic\uff0c\u5b57\u9762\u610f\u601d\u662f\u5f53\u4e00\u4e2a Store \u88ab\u5176\u4ed6\u6838\u5fc3\u770b\u5230\u65f6\uff0c\u6240\u6709\u6838\u5fc3\u90fd\u4f1a\u201c\u540c\u65f6\u201d\u770b\u5230\uff0c\u4e0d\u4f1a\u8bf4\u4e00\u90e8\u5206\u6838\u5148\u770b\u5230\uff0c\u53e6\u4e00\u90e8\u5206\u6838\u540e\u770b\u5230\u3002</p>\n<p>\u4ece TSO \u7684\u5b57\u9762\u610f\u601d\u6765\u8bf4\uff0c\u5e76\u6ca1\u6709\u63d0\u5230 Load \u53ef\u4ee5\u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff0c\u662f X86 \u7684 TSO \u5b9e\u73b0\u4e86\u8fd9\u79cd\u91cd\u6392\u3002\u4e0d\u8fc7\u5e73\u5e38\u4e5f\u4e0d\u4f1a\u4e13\u95e8\u53bb\u533a\u5206\u8fd9\u4ef6\u4e8b\u60c5\uff0c\u63d0\u5230 TSO\uff0c\u5927\u5bb6\u60f3\u5230\u7684\u90fd\u662f X86 \u7684 TSO\uff0c\u4e5f\u5c31\u662f X86-TSO \u6a21\u578b\u3002</p>\n<p>\u603b\u7ed3\u4e00\u4e0b\uff0cX86-TSO \u6a21\u578b\u7684\u89c4\u5b9a\u5c31\u662f\u5982\u4e0b\u51e0\u70b9\uff1a</p>\n<ul>\n<li>Total Store Order\uff1a\u6240\u6709\u6838\u5fc3\u4f1a\u89c2\u5bdf\u5230\u76f8\u540c\u7684\u5168\u5c40\u7684 Store \u987a\u5e8f</li>\n<li>Load \u53ef\u4ee5\u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d</li>\n<li>Load \u4f1a\u4ece Store Buffer \u548c\u7f13\u5b58\u4e24\u4e2a\u5730\u65b9\u53d6\u6570\u636e</li>\n</ul>\n<p>\u5bf9\u6bd4 SC \u548c X86-TSO \u6a21\u578b\uff1a</p>\n<ul>\n<li>X86-TSO \u6a21\u578b\u5141\u8bb8 Load \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d</li>\n<li>Store Buffer \u6d4b\u8bd5\u4e0b\uff0cSC \u7981\u6b62\u91cd\u6392\uff0cX86-TSO \u5141\u8bb8\u91cd\u6392</li>\n<li>Message Passing \u6d4b\u8bd5\u4e0b\uff0cSC \u548c X86-TSO \u90fd\u7981\u6b62\u91cd\u6392</li>\n</ul>\n<h3 id=\"weakrelaxed-memory-model\">Weak/Relaxed Memory Model<a class=\"headerlink\" href=\"#weakrelaxed-memory-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 X86 \u4ee5\u5916\u7684\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u7ecf\u5e38\u53ef\u4ee5\u770b\u5230\u53e6\u5916\u4e00\u79cd\u5185\u5b58\u6a21\u578b\uff0c\u4e00\u822c\u79f0\u4e3a Weak Memory Model \u6216\u8005 Relaxed Memory Model\u3002\u600e\u4e48\u4e2a Weak \u6cd5\u5462\uff1f\u5c31\u662f\u786c\u4ef6\u60f3\u91cd\u6392\u5c31\u91cd\u6392\uff0c\u5f53\u7136\u4e86\uff0c\u662f\u5728\u4fdd\u8bc1\u6838\u5185\u89c6\u89d2\u6b63\u786e\u7684\u524d\u63d0\u4e0b\u3002\u56de\u60f3\u524d\u9762 SC \u6a21\u578b\u548c X86-TSO \u6a21\u578b\uff0c\u5b83\u4eec\u5bf9\u4e8e Load \u548c Store \u4e4b\u95f4\u91cd\u6392\u7684\u8981\u6c42\u662f\uff1a</p>\n<ul>\n<li>\u5148 Load \u540e Load\uff1aSC \u548c X86-TSO \u4e0d\u5141\u8bb8\u91cd\u6392</li>\n<li>\u5148 Load \u540e Store\uff1aSC \u548c X86-TSO \u4e0d\u5141\u8bb8\u91cd\u6392</li>\n<li>\u5148 Store \u540e Load\uff1aSC \u4e0d\u5141\u8bb8\u91cd\u6392\uff0cX86-TSO \u5141\u8bb8\u91cd\u6392</li>\n<li>\u5148 Store \u540e Store\uff1aSC \u548c X86-TSO \u4e0d\u5141\u8bb8\u91cd\u6392</li>\n</ul>\n<p>\u65e2\u7136 Weak \u4e86\uff0c\u90a3\u5c31\u81ea\u7531\u5230\u5e95\uff1a\u5168\u90fd\u5141\u8bb8\u91cd\u6392\u3002\u5982\u679c\u7528\u6237\u4e0d\u60f3\u91cd\u6392\uff0c\u90a3\u518d\u52a0\u5408\u9002\u7684 fence \u6216 barrier \u6307\u4ee4\uff0c\u963b\u6b62\u4e0d\u60f3\u8981\u7684\u91cd\u6392\u3002\u5728\u8fd9\u4e2a\u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u6bcf\u4e2a\u6838\u5fc3\u53ef\u4ee5\u5728\u5411\u5185\u5b58\u5b50\u7cfb\u7edf\u8bfb\u5199\u524d\uff0c\u5bf9\u81ea\u5df1\u7684\u8bfb\u5199\u8fdb\u884c\u91cd\u6392\uff08\u56fe\u6e90 <a href=\"https://link.springer.com/book/10.1007/978-3-031-01764-3\">A Primer on Memory Consistency and Cache Coherence, Second Edition</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_weak.png\" /></p>\n<p>\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\u5462\uff1f\u524d\u9762\u51fa\u73b0\u8fc7 Message Passing \u7684\u4f8b\u5b50\uff0c\u7ed3\u8bba\u662f MP \u6d4b\u8bd5\u7684\u60c5\u51b5\u5728 SC \u548c X86-TSO \u573a\u666f\u4e0b\u90fd\u88ab\u7981\u6b62\u3002\u4f46\u5982\u679c\u6211\u4eec\u5728\u4e00\u4e2a\u5177\u6709 Weak Memory Model \u7684\u673a\u5668\u4e0a\u8fd0\u884c\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"c1\"># P0:</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"c1\"># 1. Wx1</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"c1\"># 2. Wy1</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"c1\"># P1:</span>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"c1\"># 1. Ry1</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a><span class=\"c1\"># 2. Rx0</span>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"c1\"># orders:</span>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"c1\"># Wx1 -&gt; Wy1: PodWW</span>\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a><span class=\"c1\"># Wy1 -&gt; Ry1: Rfe</span>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"c1\"># Ry1 -&gt; Rx0: PodRR</span>\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"c1\"># Rx0 -&gt; Wx1: Fre</span>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a>diycross7<span class=\"w\"> </span>-arch<span class=\"w\"> </span>AArch64<span class=\"w\"> </span>-name<span class=\"w\"> </span>MP-AArch64<span class=\"w\"> </span>PodWW<span class=\"w\"> </span>Rfe<span class=\"w\"> </span>PodRR<span class=\"w\"> </span>Fre\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a>litmus7<span class=\"w\"> </span>MP-AArch64.litmus<span class=\"w\"> </span><span class=\"c1\"># MP = Message Passing</span>\n</span></code></pre></div>\n<p>\u4f1a\u53d1\u73b0\u867d\u7136\u6982\u7387\u6bd4\u8f83\u4f4e\uff0c\u4f46\u786e\u5b9e\u4f1a\u51fa\u73b0 y=1\uff0cx=0 \u7684\u60c5\u51b5\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a>Histogram (4 states)\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a>500000:&gt;1:X1=0; 1:X3=0;\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a>1     *&gt;1:X1=1; 1:X3=0;\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a>1     :&gt;1:X1=0; 1:X3=1;\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a>499998:&gt;1:X1=1; 1:X3=1;\n</span></code></pre></div>\n<p>\u65e2\u7136\u5728\u5b9e\u9645\u7684 ARM \u673a\u5668\u4e0a\u6d4b\u51fa\u6765\u8fd9\u79cd\u60c5\u51b5\uff0c\u8bf4\u660e PodWW \u6216\u8005 PodRR \u81f3\u5c11\u6709\u4e00\u4e2a\u51fa\u73b0\u4e86\u91cd\u6392\uff0c\u6253\u7834\u4e86\u73af\u3002</p>\n<p>\u66f4\u8fdb\u4e00\u6b65\uff0cSC \u548c X86-TSO \u90fd\u8981\u6c42\u6709 Total Store Order\uff08Multi-copy Atomic\uff09\uff1a\u6240\u6709\u6838\u5fc3\u4f1a\u770b\u5230\u7edf\u4e00\u7684 Store \u987a\u5e8f\u3002\u6709\u8981\u6c42\uff0c\u5c31\u53ef\u4ee5\u820d\u5f03\uff0c\u90e8\u5206 Weak Memory Model \u4e5f\u4e0d\u8981\u6c42\u8fd9\u4e00\u70b9\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c\u5185\u5b58\u6a21\u578b\u5c31\u597d\u50cf\u6bcf\u4e2a\u6838\u5fc3\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u4efd\u5185\u5b58\uff0c\u8fd9\u4e9b\u5185\u5b58\u4e4b\u95f4\u4f1a\u4e92\u76f8\u4f20\u64ad Store \u4ee5\u4fdd\u8bc1\u7f13\u5b58\u4e00\u81f4\u6027\uff0c\u4f46\u662f\u6709\u7684\u6838\u5fc3\u53ef\u80fd\u5148\u770b\u5230\uff0c\u6709\u7684\u6838\u5fc3\u53ef\u80fd\u540e\u770b\u5230\uff08\u56fe\u6e90 <a href=\"https://www.cl.cam.ac.uk/~pes20/ppc-supplemental/test7.pdf\">A Tutorial Introduction to the ARM and POWER Relaxed Memory Model</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_weak_2.png\" /></p>\n<p>\u8fd9\u4e00\u70b9\u53ef\u4ee5\u5728 IRIW\uff08\u5168\u79f0 Independent Read of Independent Write\uff1b\u51c6\u786e\u5730\u8bf4\uff0c\u4e3a\u4e86\u6392\u9664 PodRR \u91cd\u6392\u7684\u60c5\u51b5\uff0c\u8981\u7528 IRIW+addrs \u6216\u8005\u52a0 barrier\uff09Litmus \u6d4b\u8bd5\u4e2d\u770b\u5230\u3002\u7b80\u5355\u6765\u8bf4\uff0cIRIW \u6d4b\u8bd5\u4e2d\uff0c\u6709\u4e24\u4e2a\u6838\u5fc3\u8d1f\u8d23\u5199\u5165\uff0c\u53e6\u5916\u4e24\u4e2a\u6838\u5fc3\u8d1f\u8d23\u8bfb\uff0c\u5982\u679c\u8fd9\u4e24\u4e2a\u8d1f\u8d23\u8bfb\u7684\u6838\u5fc3\u89c2\u5bdf\u5230\u4e86\u4e0d\u540c\u7684\u5199\u5165\u987a\u5e8f\uff0c\u8bf4\u660e\u6ca1\u6709 Total Store Order\uff08Multi-copy Atomic\uff09\uff1a\u5199\u5165\u4f20\u64ad\u5230\u4e0d\u540c\u6838\u5fc3\u7684\u987a\u5e8f\u53ef\u80fd\u6253\u4e71\u3002</p>\n<h2 id=\"\u5185\u5b58\u5e8f\">\u5185\u5b58\u5e8f<a class=\"headerlink\" href=\"#\u5185\u5b58\u5e8f\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u6307\u4ee4\u96c6\">\u6307\u4ee4\u96c6<a class=\"headerlink\" href=\"#\u6307\u4ee4\u96c6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e2\u7136 X86-TSO \u5df2\u7ecf\u51fa\u73b0\u4e86\u4e00\u79cd\u53ef\u80fd\u7684\u91cd\u6392\u60c5\u51b5\uff1aLoad \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff0c\u5047\u5982\u6211\u4eec\u4e0d\u5e0c\u671b\u51fa\u73b0\u8fd9\u79cd\u91cd\u6392\uff0c\u600e\u4e48\u529e\uff1f\u5404\u4e2a\u6307\u4ee4\u96c6\u90fd\u63d0\u4f9b\u4e86\u4e00\u4e9b fence \u6216\u8005 barrier \u6307\u4ee4\uff0c\u53ef\u4ee5\u963b\u6b62\u5404\u79cd\u7c7b\u578b\u7684\u91cd\u6392\u3002\u4ee5 x86 \u4e3a\u4f8b\uff1a</p>\n<ul>\n<li>sfence: store fence\uff0c\u4fdd\u8bc1 sfence \u4e4b\u524d\u7684 store \u90fd\u5b8c\u6210\uff08globally visible\uff0c\u5f97\u5199\u5230\u7f13\u5b58\u91cc\u624d\u7b97\uff09\u4e4b\u540e\uff0c\u624d\u5f00\u59cb sfence \u4e4b\u540e\u7684 store</li>\n<li>lfence: load fence\uff0c\u4fdd\u8bc1 lfence \u4e4b\u524d\u7684 load \u90fd\u5b8c\u6210\uff08globally visible\uff09\u4e4b\u540e\uff0c\u624d\u5f00\u59cb lfence \u4e4b\u540e\u7684 load</li>\n<li>mfence: memory fence, \u4fdd\u8bc1 mfence \u4e4b\u524d\u7684 load \u548c store \u90fd\u5b8c\u6210\uff08globally visible\uff09\u4e4b\u540e\uff0c\u624d\u5f00\u59cb mfence \u4e4b\u540e\u7684 load \u548c store</li>\n</ul>\n<p>\u8fd9\u5176\u4e2d\u5e38\u7528\u7684\u5176\u5b9e\u5c31\u662f mfence\uff1a\u524d\u9762\u63d0\u5230 X86-TSO \u5141\u8bb8 Load \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff0c\u4e3a\u4e86\u963b\u6b62\u8fd9\u4e00\u70b9\uff0clfence \u548c sfence \u90fd\u4e0d\u591f\uff0c\u56e0\u4e3a lfence \u7ba1\u7684\u662f Load \u88ab\u91cd\u6392\u5230 Load \u4e4b\u524d\uff0csfence \u7ba1\u7684\u662f Store \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\u3002mfence \u5219\u53ef\u4ee5\uff1a\u5728 Store \u540e\u9762\u7d27\u6328\u7740\u4e00\u6761 mfence \u6307\u4ee4\uff0c\u90a3\u4e48 mfence \u4e4b\u540e\u7684 Load \u6307\u4ee4\u5c31\u65e0\u6cd5\u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff1a</p>\n<ol>\n<li>store</li>\n<li>mfence</li>\n<li>load</li>\n</ol>\n<p>\u6240\u4ee5\u5982\u679c\u8981\u5728 x86 \u4e0a\u8fd0\u884c\u6309\u7167 SC \u5185\u5b58\u6a21\u578b\u7f16\u5199\u7684\u7a0b\u5e8f\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6b63\u786e\u6027\uff0c\u9700\u8981\u5728\u6bcf\u4e2a Store \u540e\u9762\u52a0\u4e00\u6761 mfence \u6307\u4ee4\u3002</p>\n<p>\u518d\u6765\u770b\u770b\u5bf9\u4e8e ARMv8 \u8fd9\u79cd\u5177\u6709 Weak/Relaxed Memory Model \u7684\u67b6\u6784\uff0c\u6307\u4ee4\u96c6\u63d0\u4f9b\u4e86\u54ea\u4e9b\u6307\u4ee4\u6765\u907f\u514d\u91cd\u6392\uff1a</p>\n<ul>\n<li>DMB\uff1a\u76f8\u5f53\u4e8e x86 \u7684 mfence\uff0c\u4fdd\u8bc1 DMB \u540e\u7684 Load \u548c Store \u4e0d\u4f1a\u91cd\u6392\u5230 DMB \u4e4b\u524d\uff0cDMB \u524d\u7684 Load \u548c Store \u4e5f\u4e0d\u4f1a\u91cd\u6392\u5230 DMB \u4e4b\u540e</li>\n<li>Load Acquire\uff1a\u5bf9 Load \u6307\u4ee4\u6dfb\u52a0 Acquire \u8bed\u4e49\uff0c\u4fdd\u8bc1 Load Acquire \u4e4b\u540e\u7684 Load/Store \u4e0d\u4f1a\u88ab\u91cd\u6392\u5230 Load  Acquire \u4e4b\u524d</li>\n<li>Store Release\uff1a\u5bf9 Release \u6307\u4ee4\u6dfb\u52a0 Release \u8bed\u4e49\uff0c\u4fdd\u8bc1 Store Release \u4e4b\u524d\u7684 Load/Store \u4e0d\u4f1a\u88ab\u91cd\u6392\u5230 Store Release \u4e4b\u540e</li>\n</ul>\n<p>\u770b\u5230 Acquire \u548c Release\uff0c\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u8fd9\u4e2a\u8bf4\u6cd5\u6709\u70b9\u719f\u6089\uff1a\u5728\u9501\u91cc\u9762\uff0c\u83b7\u5f97\u9501\u53ef\u4ee5\u8bf4 Lock \u6216\u8005\u8bf4 Acquire\uff1b\u91ca\u653e\u9501\u53ef\u4ee5\u8bf4 Unlock \u6216\u8005\u8bf4 Release\u3002\u4e8b\u5b9e\u4e0a\uff0cLoad Acquire \u548c Store Release \u6b63\u597d\u5c31\u53ef\u4ee5\u7528\u5728 Lock \u548c Unlock \u7684\u573a\u5408\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"n\">lock</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// Load Acquire</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"n\">unlock</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// Store Release</span>\n</span></code></pre></div>\n<p>\u5728\u4e34\u754c\u533a\u4e2d\u8bfb\u53d6 x\uff0c\u80af\u5b9a\u5e0c\u671b\u662f\u5728\u6301\u6709\u9501\u7684\u524d\u63d0\u4e0b\u8fdb\u884c Load\uff0c\u4e5f\u5c31\u662f\u8bf4 Load x \u4e0d\u80fd\u88ab\u91cd\u6392\u5230 <code>lock()</code> \u4e4b\u524d\uff0c\u4e5f\u4e0d\u80fd\u88ab\u91cd\u6392\u5230 <code>unlock()</code> \u4e4b\u540e\uff1b\u540c\u7406\u5728\u4e34\u754c\u533a\u4e2d\u5199\u5165 y\uff0c\u80af\u5b9a\u4e5f\u662f\u5e0c\u671b\u5728\u6301\u6709\u9501\u7684\u524d\u63d0\u4e0b\u8fdb\u884c Store\uff0c\u4e5f\u5c31\u662f\u8bf4 Store y \u4e0d\u80fd\u88ab\u91cd\u6392\u5230 <code>lock()</code> \u4e4b\u524d\u6216 <code>unlock()</code> \u4e4b\u540e\u3002\u4e3a\u4e86\u907f\u514d\u8fd9\u4e2a\u91cd\u6392\uff0c\u5728\u4e00\u5934\u4e00\u5c3e\u5206\u522b\u52a0\u4e0a Acquire \u548c Release \u6807\u8bb0\uff0c\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u4e34\u754c\u533a\u5185\u7684 Load/Store \u90fd\u662f\u5728\u6301\u6709\u9501\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u3002</p>\n<p>\u9664\u4e86\u9501\u4ee5\u5916\uff0c\u8fd9\u4e2a\u6a21\u5f0f\u4e5f\u53ef\u4ee5\u7528\u6765\u5b9e\u73b0\u6b63\u786e\u7684 Message Passing\uff0c\u539f\u6765\u7684 Message Passing \u5b9e\u73b0\u662f\uff1a</p>\n<p>P0:</p>\n<ol>\n<li>*x = 1</li>\n<li>*y = 1</li>\n</ol>\n<p>P1:</p>\n<ol>\n<li>r1 = *y</li>\n<li>r2 = *x</li>\n</ol>\n<p>\u8fd9\u91cc\u4f1a\u6709 Store-Store \u91cd\u6392\u4ee5\u53ca Load-Load \u91cd\u6392\u7684\u98ce\u9669\uff0c\u52a0\u4e0a Load Acquire \u548c Store Release \u4ee5\u540e\uff1a</p>\n<p>P0:</p>\n<ol>\n<li>*x = 1</li>\n<li>*y = 1 (Store Release)</li>\n</ol>\n<p>P1:</p>\n<ol>\n<li>r1 = *y (Load Acquire)</li>\n<li>r2 = *x</li>\n</ol>\n<p>\u8fd9\u6837\u5c31\u907f\u514d\u4e86\u91cd\u6392\uff0cP1 \u53ef\u4ee5\u89c2\u5bdf\u5230\u6b63\u786e\u7684\u7ed3\u679c\u3002</p>\n<p>\u6b64\u5916\uff0cAcquire \u548c Release \u6807\u8bb0\u4e5f\u53ef\u4ee5\u6dfb\u52a0\u5230\u539f\u5b50\u6307\u4ee4\u4e0a\uff0c\u6bd5\u7adf\u539f\u5b50\u6307\u4ee4\u5176\u5b9e\u5c31\u662f Load + Store\u3002\u76f8\u6bd4 Fence\uff0cAcquire \u548c Release \u662f\u5355\u5411\u7684\uff0c\u53ea\u5f71\u54cd\u524d\u9762\u7684\u6307\u4ee4\uff0c\u6216\u8005\u53ea\u5f71\u54cd\u540e\u9762\u7684\u6307\u4ee4\uff0c\u800c Fence \u901a\u5e38\u662f\u4e24\u4e2a\u65b9\u5411\u90fd\u963b\u6b62\uff0c\u4e0d\u8bb8\u524d\u9762\u7684\u6392\u5230\u540e\u9762\uff0c\u4e5f\u4e0d\u8bb8\u540e\u9762\u7684\u6392\u5230\u524d\u9762\u3002</p>\n<h3 id=\"\u8f6f\u4ef6\">\u8f6f\u4ef6<a class=\"headerlink\" href=\"#\u8f6f\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece\u4e0a\u9762\u7684\u5206\u6790\u53ef\u89c1\uff0c\u4e0d\u540c\u7684\u5904\u7406\u5668\u548c\u6307\u4ee4\u96c6\u4f7f\u7528\u4e86\u4e0d\u540c\u7684\u5185\u5b58\u6a21\u578b\uff0c\u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u6307\u4ee4\u6765\u63a7\u5236\u4e71\u5e8f\u91cd\u6392\uff0c\u4f46\u662f\u5bf9\u4e8e\u8f6f\u4ef6\u5f00\u53d1\u8005\u6765\u8bf4\uff0c\u4f1a\u5e0c\u671b\u5c3d\u91cf\u7528\u4e00\u5957\u901a\u7528\u7684 API \u6765\u63a7\u5236\u4e71\u5e8f\u91cd\u6392\uff0c\u53ef\u4ee5\u517c\u5bb9\u5404\u79cd\u6307\u4ee4\u96c6\uff0c\u4e0d\u7528\u53bb\u8bb0\u5fc6\u6bcf\u4e2a\u5904\u7406\u5668\u7528\u7684\u662f\u4ec0\u4e48\u5185\u5b58\u6a21\u578b\uff0c\u4e0d\u7528\u53bb\u77e5\u9053\u54ea\u4e9b\u6307\u4ee4\u53ef\u4ee5\u7528\u6765\u89e3\u51b3\u54ea\u4e9b\u91cd\u6392\u3002</p>\n<p>\u8fd9\u4e2a API \u5728\u5f88\u591a\u7f16\u7a0b\u8bed\u8a00\u4e2d\u90fd\u6709\uff0cC \u7684 stdatomic.h\uff0cC++ \u7684 std::memory_order\uff0cRust \u7684 std::sync::atomic::Ordering \u7b49\u7b49\u3002\u5b83\u4eec\u5bf9\u5404\u79cd\u5904\u7406\u5668\u7684\u5185\u5b58\u5e8f\u8fdb\u884c\u4e86\u8fdb\u4e00\u6b65\u7684\u62bd\u8c61\uff0c\u5e76\u4e14\u5728\u7f16\u8bd1\u7684\u65f6\u5019\uff0c\u7531\u7f16\u8bd1\u5668\u6216\u6807\u51c6\u5e93\u628a\u8fd9\u4e9b\u62bd\u8c61\u7684\u5185\u5b58\u5e8f\u7ffb\u8bd1\u6210\u5b9e\u9645\u7684\u6307\u4ee4\u3002\u4ee5 C++ \u7684\u62bd\u8c61\u4e3a\u4f8b\uff0c\u6709\u5982\u4e0b\u51e0\u79cd\u5185\u5b58\u5e8f\uff08\u56fe\u6e90 <a href=\"https://en.cppreference.com/w/cpp/atomic/memory_order\">cppreference</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_order.png\" /></p>\n<p>\u5176\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684 acquire \u548c release\uff0c\u5176\u5b9e\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684 Load Acquire \u548c Store Release\u3002\u6700\u540e\u7684 seq_cst\uff0c\u5c31\u5bf9\u5e94\u4e86 Sequential Consistency\uff08SC\uff09\u6a21\u578b\uff0c\u8981\u6a21\u62df SC \u6a21\u578b\u7684\u884c\u4e3a\u3002</p>\n<p>\u7531\u4e8e C++ \u53ef\u4ee5\u88ab\u7f16\u8bd1\u5230\u4e0d\u540c\u7684\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u6240\u4ee5\u8fd9\u4e9b memory order \u5728\u7f16\u8bd1\u7684\u65f6\u5019\uff0c\u4f1a\u53d8\u6210\u5bf9\u5e94\u7684\u6307\u4ee4\uff0c\u4e5f\u53ef\u80fd\u7531\u4e8e\u5185\u5b58\u6a21\u578b\u4fdd\u8bc1\u4e86\u4e0d\u51fa\u73b0\u5bf9\u5e94\u7684\u4e71\u5e8f\uff0c\u4e0d\u9700\u8981\u751f\u6210\u989d\u5916\u7684\u6307\u4ee4\u3002\u4ee5 X86 \u4e3a\u4f8b\u5b50\uff1a</p>\n<ul>\n<li>Load Acquire\uff1a\u9632\u6b62 Load \u4e4b\u540e\u7684 Load/Store \u6307\u4ee4\u88ab\u91cd\u6392\u5230 Load \u4e4b\u524d\uff0c\u56e0\u4e3a X86-TSO \u963b\u6b62\u4e86 Load-Load \u548c Load-Store\uff08\u5148 Load \u540e Store\uff09\u91cd\u6392\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u989d\u5916\u7684\u6307\u4ee4</li>\n<li>Store Release\uff1a\u9632\u6b62 Store \u4e4b\u524d\u7684 Load/Store \u6307\u4ee4\u88ab\u91cd\u6392\u5230 Store \u4e4b\u540e\uff0c\u56e0\u4e3a X86-TSO \u963b\u6b62\u4e86 Load-Store \u548c Store-Store \u91cd\u6392\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u989d\u5916\u7684\u6307\u4ee4</li>\n</ul>\n<p>\u5b8c\u6574\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u5efa\u8bae\u9605\u8bfb <a href=\"https://www.cl.cam.ac.uk/~pes20/cpp/cpp0xmappings.html\">C/C++11 mappings to processors</a>\u3002</p>\n<p>\u7f16\u8bd1\u5668\u7684\u4f18\u5316\u53ef\u80fd\u4f1a\u5bf9\u5185\u5b58\u5e8f\u4ea7\u751f\u4e00\u4e9b\u610f\u6599\u4e4b\u5916\u7684\u5f71\u54cd\uff0c\u63a8\u8350\u9605\u8bfb Linux \u5185\u6838\u7684 <a href=\"https://www.kernel.org/doc/Documentation/memory-barriers.txt\">LINUX KERNEL MEMORY BARRIERS</a> \u6587\u6863\u3002</p>\n<h2 id=\"\u53c2\u8003\u6587\u732e\">\u53c2\u8003\u6587\u732e<a class=\"headerlink\" href=\"#\u53c2\u8003\u6587\u732e\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://www.cl.cam.ac.uk/~pes20/ppc-supplemental/test7.pdf\">A Tutorial Introduction to the ARM and POWER Relaxed Memory Model</a></li>\n<li><a href=\"https://www.cl.cam.ac.uk/~pes20/weakmemory/x86tso-paper.tphols.pdf\">A Better x86 Memory Model: x86-TSO</a></li>\n<li><a href=\"https://research.swtch.com/hwmm\">Hardware Memory Models - Russ Cox</a></li>\n<li><a href=\"https://github.com/herd/herdtools7\">herd/herdtools7 on GitHub</a></li>\n<li><a href=\"https://link.springer.com/book/10.1007/978-3-031-01764-3\">A Primer on Memory Consistency and Cache Coherence, Second Edition</a></li>\n<li><a href=\"https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/generate-litmus-tests-automatically-diy7-tool\">How to generate litmus tests automatically with the diy7 tool</a></li>\n</ul>", "image": null, "date_published": "2024-09-04T00:00:00+00:00", "authors": [], "tags": ["acquire", "arm64", "cpu", "hardware", "lock", "mca", "ordering", "release", "tso", "x86"]}, {"id": "https://jia.je/hardware/2024/09/01/qualcomm_oryon/", "url": "https://jia.je/hardware/2024/09/01/qualcomm_oryon/", "title": "Qualcomm Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"qualcomm-oryon-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Qualcomm Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#qualcomm-oryon-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u501f\u5230\u4e00\u53f0 Surface Laptop 7 \u53ef\u4ee5\u62ff\u6765\u6298\u817e\uff0c\u5b83\u7528\u7684\u662f\u9ad8\u901a Snapdragon X Elite \u5904\u7406\u5668\uff0c\u501f\u6b64\u673a\u4f1a\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9ad8\u901a\u5173\u4e8e Oryon \u5fae\u67b6\u6784\u6709\u4e24\u4e2a slides\uff0c\u5185\u5bb9\u53ef\u4ee5\u5728\u4ee5\u4e0b\u7684\u94fe\u63a5\u4e2d\u770b\u5230\uff1a</p>\n<ul>\n<li><a href=\"https://www.anandtech.com/show/21445/qualcomm-snapdragon-x-architecture-deep-dive/2\">The Qualcomm Snapdragon X Architecture Deep Dive: Getting To Know Oryon and Adreno X1 - Anandtech</a></li>\n<li><a href=\"https://hc2024.hotchips.org/assets/program/conference/day1/25_HC2024.Qualcomm.GWilliams.pdf\">Hot Chips 2024: Qualcomm\u2019s Oryon Core</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/08/26/hot-chips-2024-qualcomms-oryon-core/\">Hot Chips 2024: Qualcomm\u2019s Oryon Core - Chips and Cheese</a></li>\n</ul>\n<p>\u4e24\u6b21\u5185\u5bb9\u5927\u4f53\u4e00\u81f4\uff0cHot Chips 2024 \u7684\u5185\u5bb9\u66f4\u52a0\u8be6\u7ec6\uff0c\u4f46\u4e5f\u51fa\u73b0\u4e86\u4e00\u4e9b\u524d\u540e\u77db\u76fe\u7684\u5730\u65b9\u3002</p>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Oryon \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/704707254\">\u9ad8\u901a X Elite Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b\uff1a\u8d70\u8d70\u505c\u505c</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/07/09/qualcomms-oryon-core-a-long-time-in-the-making/\">Qualcomm\u2019s Oryon Core: A Long Time in the Making</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/05/15/qualcomms-oryon-llvm-patches/\">Qualcomm\u2019s Oryon LLVM Patches</a></li>\n<li><a href=\"https://www.bilibili.com/video/BV1Ue41197Qb/\">\u9ad8\u901a\u81ea\u7814 PC \u82af\u7247 X Elite \u5b9e\u6d4b\uff1a\u771f\u80fd\u5e72\u7ffb\u82f9\u679c\u82f1\u7279\u5c14\uff1f</a></li>\n<li><a href=\"https://www.bilibili.com/video/BV1z1421r7dZ/\">\u592a\u8d35\u4e86\uff0c\u5b83\u6ca1\u4f60\u60f3\u7684\u90a3\u4e48\u7f8e\u597d\uff01\u9ad8\u901a\u9a81\u9f99 X Elite 78-100 \u7b14\u8bb0\u672c\u8be6\u7ec6\u8bc4\u6d4b</a></li>\n<li><a href=\"https://www.qualcomm.com/products/mobile/snapdragon/laptops-and-tablets/snapdragon-x-elite\">Snapdragon X Elite</a></li>\n<li><a href=\"https://www.qualcomm.com/products/technology/processors/oryon\">Qualcomm Oryon CPU</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Qualcomm Oryon \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u53d6\u6307\">\u53d6\u6307<a class=\"headerlink\" href=\"#\u53d6\u6307\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u53d6\u6307\u53ef\u4ee5\u8fbe\u5230\u6bcf\u5468\u671f\u6700\u591a <strong>16</strong> \u6307\u4ee4</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u5b9e\u9645\u7684 Fetch \u5bbd\u5ea6\uff0c\u53c2\u8003 <a href=\"https://zhuanlan.zhihu.com/p/720136752\">\u5982\u4f55\u6d4b\u91cf\u771f\u6b63\u7684\u53d6\u6307\u5e26\u5bbd\uff08I-fetch width\uff09 - JamesAslan</a> \u6784\u9020\u4e86\u6d4b\u8bd5\u3002</p>\n<p>\u5176\u539f\u7406\u662f\u5f53 Fetch \u8981\u8de8\u9875\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u4e24\u4e2a\u76f8\u90bb\u9875\u53ef\u80fd\u6620\u5c04\u5230\u4e0d\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u5982\u679c\u8981\u652f\u6301\u5355\u5468\u671f\u8de8\u9875\u53d6\u6307\uff0c\u9700\u8981\u67e5\u8be2\u4e24\u6b21 ITLB\uff0c\u6216\u8005 ITLB \u9700\u8981\u628a\u76f8\u90bb\u4e24\u4e2a\u9875\u7684\u6620\u5c04\u5b58\u5728\u4e00\u8d77\u3002\u8fd9\u4e2a\u573a\u666f\u4e00\u822c\u6bd4\u8f83\u5c11\uff0c\u5904\u7406\u5668\u5f88\u5c11\u4f1a\u9488\u5bf9\u8fd9\u79cd\u7279\u6b8a\u60c5\u51b5\u505a\u4f18\u5316\uff0c\u4f46\u4e5f\u4e0d\u662f\u6ca1\u6709\u3002\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u628a\u5faa\u73af\u653e\u5728\u4e24\u4e2a\u9875\u7684\u8fb9\u754c\u4e0a\uff0c\u53d1\u73b0 Oryon \u5fae\u67b6\u6784\u9047\u5230\u8de8\u9875\u7684\u53d6\u6307\u65f6\u786e\u5b9e\u4f1a\u62c6\u6210\u4e24\u4e2a\u5468\u671f\u6765\u8fdb\u884c\u3002\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u5728\u7b2c\u4e00\u4e2a\u9875\u7684\u6700\u540e\u56db\u4e2a\u5b57\u8282\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u4e0a\uff0c\u90a3\u4e48\u6bcf\u6b21\u5faa\u73af\u7684\u53d6\u6307\u65f6\u95f4\uff0c\u5c31\u662f\u4e00\u4e2a\u5468\u671f\uff08\u8bfb\u53d6\u7b2c\u4e00\u4e2a\u9875\u5185\u7684\u6307\u4ee4\uff09\u52a0\u4e0a\u7b2c\u4e8c\u4e2a\u9875\u5185\u6307\u4ee4\u9700\u8981 Fetch \u7684\u5468\u671f\u6570\uff0c\u591a\u7684\u8fd9\u4e00\u4e2a\u5468\u671f\u5c31\u8db3\u4ee5\u628a Fetch \u5bbd\u5ea6\u4ece\u540e\u7aef\u9650\u5236\u4e2d\u533a\u5206\u5f00\uff0c\u5b9e\u9a8c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_if_width.png\" /></p>\n<p>\u56fe\u4e2d\u84dd\u7ebf\uff08cross-page\uff09\u8868\u793a\u7684\u5c31\u662f\u4e0a\u9762\u6240\u8ff0\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u4e00\u4e2a\u9875\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u7684\u60c5\u51b5\uff0c\u6a2a\u5750\u6807\u662f\u7b2c\u4e8c\u4e2a\u9875\u5185\u7684\u6307\u4ee4\u6570\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u7684\u6307\u4ee4\u6570\u7b49\u4e8e\u6a2a\u5750\u6807 +1\u3002\u7eb5\u5750\u6807\u662f\u8fd0\u884c\u5f88\u591a\u6b21\u5faa\u73af\u7684\u603b cycle \u6570\u9664\u4ee5\u5faa\u73af\u6b21\u6570\uff0c\u4e5f\u5c31\u662f\u5e73\u5747\u6bcf\u6b21\u5faa\u73af\u8017\u8d39\u7684\u5468\u671f\u6570\u3002\u53ef\u4ee5\u770b\u5230\u6bcf 16 \u6761\u6307\u4ee4\u4f1a\u591a\u4e00\u4e2a\u5468\u671f\uff0c\u56e0\u6b64 Oryon \u7684\u524d\u7aef\u53d6\u6307\u5bbd\u5ea6\u786e\u5b9e\u662f 16 \u6761\u6307\u4ee4\u3002</p>\n<p>\u4e3a\u4e86\u786e\u8ba4\u8fd9\u4e2a\u74f6\u9888\u662f\u7531\u53d6\u6307\u9020\u6210\u7684\uff0c\u53c8\u6784\u9020\u4e86\u4e00\u7ec4\u5b9e\u9a8c\uff0c\u628a\u5faa\u73af\u7684\u6240\u6709\u6307\u4ee4\u90fd\u653e\u5230\u4e00\u4e2a\u9875\u4e2d\uff0c\u8fd9\u4e2a\u65f6\u5019 Fetch \u4e0d\u518d\u6210\u4e3a\u74f6\u9888\uff08\u56fe\u4e2d aligned\uff09\uff0c\u4e24\u4e2a\u66f2\u7ebf\u7684\u5bf9\u6bd4\u53ef\u4ee5\u660e\u786e\u5730\u5f97\u51fa\u4e0a\u8ff0\u7ed3\u8bba\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>192KB</strong> <strong>6-way</strong> L1 ICache</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b\u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 192 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 8 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2 IPC\uff0c\u8fd9\u91cc\u7684 192 KB \u5c31\u5bf9\u5e94\u4e86 L1 ICache \u7684\u5bb9\u91cf\u3002\u867d\u7136 Fetch \u53ef\u4ee5\u6bcf\u5468\u671f 16 \u6761\u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u4e00\u6761 64B \u7684\u7f13\u5b58\u884c\uff0c\u7531\u4e8e\u540e\u7aef\u7684\u9650\u5236\uff0c\u53ea\u80fd\u89c2\u5bdf\u5230 8 \u7684 IPC\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>256-entry</strong> <strong>8-way</strong> L1 ITLB\uff0c\u652f\u6301 4KB \u548c 64KB \u7684\u9875\u8868\u5927\u5c0f</p>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 B \u6307\u4ee4\uff0c\u4f7f\u5f97 B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 256 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 256 \u7684 L1 ITLB \u5bb9\u91cf\u3002\u6ce8\u610f\u8981\u907f\u514d ICache \u548c BTB \u7684\u5bb9\u91cf\u6210\u4e3a\u74f6\u9888\uff0c\u628a B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 Cache Line \u548c BTB entry \u4e0a\u3002</p>\n<p>\u5982\u679c\u6bcf\u4e24\u4e2a page \u653e\u4e00\u6761 B \u6307\u4ee4\uff0c\u5bb9\u91cf\u51cf\u5c0f\u5230 128 Page\uff1b\u8fdb\u4e00\u6b65\u628a B \u6307\u4ee4\u653e\u5f97\u66f4\u52a0\u7a00\u758f\uff0c\u6700\u7ec8\u5728\u6bcf 32 \u4e2a page \u653e\u4e00\u6761 B \u6307\u4ee4\u65f6\uff0c\u5bb9\u91cf\u51cf\u5230 8 Page\uff0c\u4e4b\u540e\u4e0d\u518d\u51cf\u5c0f\u3002\u8bf4\u660e L1 ITLB \u662f 32 Set 8 Way\uff0cIndex \u662f PC[16:12]\u3002\u8fd9\u662f\u9875\u8868\u5927\u5c0f\u4e3a 4KB \u7684\u60c5\u51b5\uff0c64KB \u6ca1\u6709\u6d4b\u8bd5\uff0c\u9884\u8ba1\u662f\u7c7b\u4f3c\u7684\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a8 inst/cycle decoded</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>50-entry</strong> return stack</p>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\uff0c\u5f97\u5230\u4e0b\u9762\u7684\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 50 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 Return Stack \u6df1\u5ea6\u4e3a 50\u3002</p>\n<h3 id=\"branch-predictor\">Branch Predictor<a class=\"headerlink\" href=\"#branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a80KB Conditional Predictor, 40KB Indirect Predictor</p>\n<h3 id=\"btb\">BTB<a class=\"headerlink\" href=\"#btb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>2K+</strong> entry BTB</p>\n<p>\u6784\u9020\u5927\u91cf\u7684\u65e0\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff08B \u6307\u4ee4\uff09\uff0cBTB \u9700\u8981\u8bb0\u5f55\u8fd9\u4e9b\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\uff0c\u90a3\u4e48\u5982\u679c\u5206\u652f\u6570\u91cf\u8d85\u8fc7\u4e86 BTB \u7684\u5bb9\u91cf\uff0c\u6027\u80fd\u4f1a\u51fa\u73b0\u660e\u663e\u4e0b\u964d\u3002\u5f53\u628a\u5927\u91cf B \u6307\u4ee4\u7d27\u5bc6\u653e\u7f6e\uff0c\u4e5f\u5c31\u662f\u6bcf 4 \u5b57\u8282\u4e00\u6761 B \u6307\u4ee4\u65f6\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_btb_4b.png\" /></p>\n<p>\u53ef\u89c1\u5728 2048 \u4e2a\u5206\u652f\u4e4b\u5185\u53ef\u4ee5\u8fbe\u5230 1 \u7684 CPI\uff0c\u8d85\u8fc7 2048 \u4e2a\u5206\u652f\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u5e73\u53f0\uff0c\u4e00\u76f4\u5ef6\u7eed\u5230 32768 \u4e2a\u5206\u652f\u6216\u66f4\u591a\u3002\u8d85\u51fa BTB \u5bb9\u91cf\u4ee5\u540e\uff0c\u5206\u652f\u9884\u6d4b\u65f6\uff0c\u65e0\u6cd5\u4ece BTB \u4e2d\u5f97\u5230\u54ea\u4e9b\u6307\u4ee4\u662f\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u53ea\u80fd\u7b49\u5230\u53d6\u6307\u751a\u81f3\u8bd1\u7801\u540e\u624d\u80fd\u540e\u77e5\u540e\u89c9\u5730\u53d1\u73b0\u8fd9\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u8fd9\u6837\u5c31\u51fa\u73b0\u4e86\u6027\u80fd\u635f\u5931\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u60c5\u51b5\u3002</p>\n<p>\u964d\u4f4e\u5206\u652f\u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u5728 B \u6307\u4ee4\u4e4b\u95f4\u63d2\u5165 NOP \u6307\u4ee4\uff0c\u4f7f\u5f97\u6bcf 8 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_btb_8b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 CPI=1 \u7684\u62d0\u70b9\u524d\u79fb\u5230 1024 \u4e2a\u5206\u652f\uff0c\u540c\u65f6 CPI=3 \u7684\u5e73\u53f0\u4e5f\u51fa\u73b0\u4e86\u65b0\u7684\u62d0\u70b9\uff0c\u5728 16384 \u548c 32768 \u4e4b\u95f4\u3002\u62d0\u70b9\u7684\u524d\u79fb\uff0c\u610f\u5473\u7740 BTB \u91c7\u7528\u4e86\u7ec4\u76f8\u8fde\u7684\u7ed3\u6784\uff0c\u5f53 B \u6307\u4ee4\u7684 PC \u7684\u90e8\u5206\u4f4e\u4f4d\u603b\u662f\u4e3a 0 \u65f6\uff0c\u7ec4\u76f8\u8fde\u7684 Index \u53ef\u80fd\u65e0\u6cd5\u53d6\u5230\u6240\u6709\u7684 Set\uff0c\u5bfc\u81f4\u8868\u73b0\u51fa\u6765\u7684 BTB \u5bb9\u91cf\u53ea\u6709\u90e8\u5206 Set\uff0c\u4f8b\u5982\u6b64\u5904\u5bb9\u91cf\u51cf\u534a\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u534a\u7684 Set \u88ab\u7528\u5230\u4e86\u3002</p>\n<p>\u51fa\u73b0\u65b0\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u662f\u6307\u4ee4 footprint \u8d85\u51fa L1 ICache \u7684\u60c5\u51b5\uff1aL1 ICache \u662f 192KB\uff0c\u6309\u7167\u6bcf 8 \u5b57\u8282\u4e00\u4e2a B \u6307\u4ee4\u8ba1\u7b97\uff0c\u6700\u591a\u53ef\u4ee5\u5b58\u653e 24576 \u6761 B \u6307\u4ee4\uff0c\u8fd9\u4e2a\u503c\u6b63\u597d\u5904\u5728 16384 \u548c 32768 \u4e4b\u95f4\uff0c\u548c\u62d0\u70b9\u543b\u5408\u3002</p>\n<p>\u5982\u679c\u8fdb\u4e00\u6b65\u964d\u4f4e B \u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u4f7f\u5f97\u5b83\u7684\u4f4e\u82e5\u5e72\u4f4d\u90fd\u7b49\u4e8e 0\uff0c\u6700\u7ec8 CPI=1 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 2 \u6761\u5206\u652f\uff0cCPI=3/3.5 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 6 \u6761\u5206\u652f\u3002\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\uff0c\u8ba4\u4e3a BTB \u662f 1024 Set 2 Way \u7684\u7ed3\u6784\uff0cIndex \u662f PC[11:2]\uff1b\u540c\u65f6\u4e5f\u4fa7\u9762\u4f50\u8bc1\u4e86 192KB L1 ICache \u662f 512 Set 6 Way\uff0cIndex \u662f PC[14:6]\u3002\u4e0d\u8fc7\u8003\u8651\u5230 Oryon \u652f\u6301\u8de8 64B \u8fb9\u754c\u8bbf\u5b58\uff0c\u5b9e\u9645\u7684 L1 ICache \u5927\u6982\u7387\u662f\u5206 bank \u7684\uff0c\u8fd9\u6837\u624d\u80fd\u5728\u4fdd\u6301\u5355\u8bfb\u53e3\u7684\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u5468\u671f\u4ece\u8fde\u7eed\u7684\u4e24\u4e2a Cache Line \u4e2d\u53d6\u6307\u4ee4\u3002</p>\n<p>\u5c0f\u7ed3\uff1aBTB \u5bb9\u91cf\u4e3a 2048 \u9879\uff0c\u91c7\u7528 2 \u8def\u7ec4\u76f8\u8fde\u65b9\u5f0f\uff0c\u5f53\u6240\u6709\u5206\u652f\u547d\u4e2d BTB \u65f6\uff0c\u53ef\u4ee5\u8fbe\u5230 1 CPI\uff1b\u5982\u679c\u8d85\u51fa\u4e86 BTB \u5bb9\u91cf\uff0c\u4f46\u6ca1\u6709\u8d85\u51fa L1 ICache \u5bb9\u91cf\uff0c\u53ef\u4ee5\u8fbe\u5230 3 CPI\u3002</p>\n<h3 id=\"branch-mispredict-latency\">Branch Mispredict Latency<a class=\"headerlink\" href=\"#branch-mispredict-latency\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a13 cycle Branch Mispredict Latency</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u7269\u7406\u5bc4\u5b58\u5668\u5806\">\u7269\u7406\u5bc4\u5b58\u5668\u5806<a class=\"headerlink\" href=\"#\u7269\u7406\u5bc4\u5b58\u5668\u5806\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a400+ registers Integer pool, 400+ registers Vector pool</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u7269\u7406\u5bc4\u5b58\u5668\u5806\u7684\u5927\u5c0f\uff0c\u4e00\u822c\u4f1a\u7528\u4e24\u4e2a\u4f9d\u8d56\u94fe\u5f88\u957f\u7684\u64cd\u4f5c\u653e\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\uff0c\u4e2d\u95f4\u586b\u5165\u82e5\u5e72\u4e2a\u65e0\u5173\u7684\u6307\u4ee4\uff0c\u5e76\u4e14\u7528\u8fd9\u4e9b\u6307\u4ee4\u6765\u8017\u8d39\u7269\u7406\u5bc4\u5b58\u5668\u5806\u3002\u6d4b\u8bd5\u7ed3\u679c\u89c1\u4e0b\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_prf.png\" /></p>\n<ul>\n<li>32b/64b int\uff1a\u6d4b\u8bd5 32/64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 362-374</li>\n<li>fp\uff1a\u6d4b\u8bd5\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 362-372</li>\n<li>flags\uff1a\u6d4b\u8bd5 NZCV \u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 119-126</li>\n</ul>\n<p>\u53ef\u89c1\u6574\u6570\u548c\u6d6e\u70b9\u6570\u90fd\u80fd\u63d0\u4f9b\u5927\u7ea6 360+ \u4e2a\u5bc4\u5b58\u5668\u7528\u4e8e\u4e71\u5e8f\u6267\u884c\uff0c\u52a0\u4e0a\u7528\u4e8e\u4fdd\u5b58\u67b6\u6784\u5bc4\u5b58\u5668\u7684\u81f3\u5c11 32 \u4e2a\u5bc4\u5b58\u5668\uff0c\u52a0\u8d77\u6765\u548c\u9ad8\u901a\u5ba3\u79f0\u7684 400+ \u662f\u6bd4\u8f83\u4e00\u81f4\u7684\u3002\u6574\u6570\u548c\u6d6e\u70b9\u4e2a\u6570\u6d4b\u51fa\u6765\u4e00\u6837\uff0c\u53ef\u80fd\u662f\u8fd9\u4e24\u4e2a\u5bc4\u5b58\u5668\u5806\u5927\u5c0f\u4e00\u6837\uff0c\u4e5f\u53ef\u80fd\u662f\u6574\u6570\u548c\u6d6e\u70b9\u653e\u540c\u4e00\u4e2a\u5bc4\u5b58\u5668\u5806\u4e2d\u3002\u7ecf\u8fc7\u6df7\u5408\u6574\u6570\u548c\u6d6e\u70b9\u6307\u4ee4\u6d4b\u8bd5\uff0c\u8ba4\u4e3a\u8fd9\u4e24\u4e2a\u5bc4\u5b58\u5668\u5806\u5e76\u4e0d\u5171\u4eab\uff0c\u53ea\u662f\u6570\u91cf\u5dee\u4e0d\u591a\u3002</p>\n<p>NZCV \u91cd\u547d\u540d\u5219\u6bd4\u6574\u6570\u5bc4\u5b58\u5668\u5c11\u5f97\u591a\uff0c\u53ea\u6709 120+\uff0c\u4e5f\u662f\u8003\u8651\u5230 ARMv8 \u6307\u4ee4\u96c6\u5927\u90e8\u5206\u6307\u4ee4\u4e0d\u50cf X86 \u90a3\u6837\u4f1a\u4fee\u6539 NZCV\u3002</p>\n<h3 id=\"reservation-stations\">Reservation Stations<a class=\"headerlink\" href=\"#reservation-stations\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>IXU 6-wide 64-bit, each with 20 entry queue</li>\n<li>VXU 4-wide 128-bit, each with 48 entry queue</li>\n<li>LSU 4-wide 128-bit, each with 16 entry queue (\u6ce8\uff1aHot Chips \u4e0a\u7684 Slides \u5199\u7684\u662f\u56db\u4e2a 64-entry\uff0c\u51fa\u73b0\u4e86\u4e0d\u4e00\u81f4)</li>\n</ul>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Up to <strong>6</strong> ALU/cycle</li>\n<li>Up to <strong>2</strong> Branch/cycle</li>\n<li>Up to <strong>2</strong> multiply/MLA per cycle</li>\n</ul>\n<p>\u5728\u5faa\u73af\u4e2d\u91cd\u590d\u4e0b\u5217\u6307\u4ee4\u591a\u6b21\uff0c\u6d4b\u91cf CPI\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<ul>\n<li><code>add x0, x0, 1</code>\uff1aCPI = 6.0\uff0c\u8bf4\u660e\u53ef\u4ee5 6 ALU/cycle</li>\n<li><code>cbnz xzr, target;target:</code>\uff1aCPI = 2.0\uff0c\u8bf4\u660e\u53ef\u4ee5 2 Branch/cycle\uff0c\u6ce8\u610f\u8fd9\u91cc\u662f not taken \u5206\u652f</li>\n<li><code>mul x0, x1, x2</code>\uff1aCPI = 2.0\uff0c\u8bf4\u660e\u53ef\u4ee5 2 Multiply/cycle</li>\n</ul>\n<h3 id=\"reorder-buffer\">Reorder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Retirement 8 uOps/cycle</li>\n<li>Reorder Buffer is 650+ uOps</li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 ROB \u7684\u5927\u5c0f\uff0c\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5f00\u59cb\u662f 8 \u6761\u4e32\u884c\u7684 fsqrt \u6307\u4ee4\uff0c\u6bcf\u6761\u6307\u4ee4\u9700\u8981 13 \u4e2a\u5468\u671f\uff0c\u7531\u4e8e\u6570\u636e\u4f9d\u8d56\uff0c\u4e00\u5171\u9700\u8981 8*13=104 \u4e2a\u5468\u671f\u5b8c\u6210\u3002\u4e4b\u540e\u662f\u82e5\u5e72\u6761 NOP \u6307\u4ee4\uff0c\u5f53 NOP \u6307\u4ee4\u6bd4\u8f83\u5c11\u65f6\uff0c\u5faa\u73af\u7684\u65f6\u5019\u53d6\u51b3\u4e8e fsqrt \u6307\u4ee4\u7684\u65f6\u95f4\uff0c\u4e00\u6b21\u5faa\u73af\u5927\u7ea6\u9700\u8981 104 \u4e2a\u5468\u671f\uff1b\u5f53 NOP \u6307\u4ee4\u6570\u91cf\u8fc7\u591a\uff0c\u586b\u6ee1\u4e86 ROB \u4ee5\u540e\uff0c\u5c31\u4f1a\u5bfc\u81f4 ROB \u65e0\u6cd5\u4fdd\u5b58\u4e0b\u4e00\u6b21\u5faa\u73af\u7684 fsqrt \u6307\u4ee4\uff0c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\u3002\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_rob.png\" /></p>\n<p>\u5f53 NOP \u6570\u91cf\u8fbe\u5230 676 \u65f6\uff0c\u6027\u80fd\u5f00\u59cb\u6025\u5267\u4e0b\u6ed1\uff0c\u800c\u6267\u884c 676 \u6761 NOP \u53ea\u9700\u8981 676/8=84.5 \u4e2a\u5468\u671f\uff0c\u5c0f\u4e8e 104 \u4e2a\u5468\u671f\uff0c\u8bf4\u660e\u74f6\u9888\u4e0d\u5728\u6267\u884c NOP \u4e0a\uff0c\u800c\u662f\u56e0\u4e3a ROB \u88ab\u586b\u6ee1\uff0c\u5bfc\u81f4\u540e\u7eed\u7684 fsqrt \u6307\u4ee4\u65e0\u6cd5\u53ca\u65f6\u6267\u884c\u3002\u56e0\u6b64\u8ba4\u4e3a Oryon \u7684 ROB \u5927\u5c0f\u5728 680+\u3002</p>\n<p>\u6ca1\u6709\u89c2\u5bdf\u5230\u7c7b\u4f3c Firestorm \u7684 Coalesced ROB \u7684\u8bbe\u8ba1\u3002</p>\n<h3 id=\"load-store-unit--l1-dcache\">Load Store Unit + L1 DCache<a class=\"headerlink\" href=\"#load-store-unit--l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>96KB</strong> 6-way L1 DCache</li>\n<li><strong>224-entry</strong> <strong>7-way</strong> L1 DTLB, supports 4KB and 64KB translation granules</li>\n<li>Up to 4 Load-Store operations per cycle</li>\n<li>192 entry Load Queue, 56 entry Store Queue</li>\n<li>Full 64B/cycle for both fills and evictions to L2 cache</li>\n</ul>\n<h4 id=\"l1-dcache-\u5bb9\u91cf\">L1 DCache \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dcache-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 96KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 96KB \u7684 L1 DCache \u5bb9\u91cf\u3002</p>\n<h4 id=\"l1-dtlb-\u5bb9\u91cf\">L1 DTLB \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dtlb-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21 pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_dtlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 224 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 224 \u7684 L1 DTLB \u5bb9\u91cf\u3002\u4ece\u6bcf\u4e2a page \u4e00\u4e2a\u6307\u9488\u6539\u6210\u6bcf 32 page \u4e00\u4e2a\u6307\u9488\u5e76\u6ce8\u610f\u5bf9\u9f50\u5c3d\u91cf\u4fdd\u8bc1 Index \u4e3a 0\uff0c\u6b64\u65f6 L1 DTLB \u5bb9\u91cf\u964d\u4e3a 7\uff0c\u8bf4\u660e L1 DTLB \u662f 7 \u8def\u7ec4\u76f8\u8fde\u7ed3\u6784\uff0c32 \u4e2a Set\uff0cIndex \u4f4d\u662f VA[16:12]\uff0c\u8fd9\u4e9b\u9875\u88ab\u6620\u5c04\u5230\u4e86\u76f8\u540c\u7684 Set \u5f53\u4e2d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_dtlb_7.png\" /></p>\n<p>\u6a2a\u5ea7\u6807\u4e3a 8\uff0c\u4e5f\u5c31\u662f\u6709 8 \u4e2a\u9875\u65f6\uff0c\u6b64\u65f6\u8fd9 8 \u4e2a\u9875\u90fd\u6620\u5c04\u5230\u540c\u4e00\u4e2a set \u5f53\u4e2d\uff0c\u6709\u56db\u5206\u4e4b\u4e00\u7684\u6982\u7387\u4f1a\u51fa\u73b0 L1 DTLB miss\uff0c\u6b64\u65f6 load latency \u662f 11 cycle\uff0c\u5269\u4e0b\u56db\u5206\u4e4b\u4e09\u7684\u6982\u7387 L1 DTLB hit\uff0cload latency \u662f 3 cycle\uff0c\u52a0\u6743\u5e73\u5747\u4e0b\u6765\u5f97\u5230 <code>11*1/4+3*3/4=5</code>\uff0c\u7b26\u5408\u9884\u671f\u3002\u8fd9\u4e2a\u56db\u5206\u4e4b\u4e00\u5bf9\u5e94\u4e86\u67d0\u79cd\u66ff\u6362\u7b56\u7565\u3002\u4ece\u6a2a\u5ea7\u6807\u4e3a 9 \u5f00\u59cb\uff0c\u5219\u6240\u6709\u8bbf\u95ee\u90fd\u51fa\u73b0 L1 DTLB miss\uff0c\u5ef6\u8fdf\u964d\u4f4e\u5230 11 cycle\uff0c\u8fd9\u4ee3\u8868\u4e86 L1 DTLB miss\uff0cL2 Unified TLB hit \u7684\u5ef6\u8fdf\u3002</p>\n<p>\u547d\u4e2d L1 DTLB \u65f6\u6bcf\u6761 Load \u6307\u4ee4\u662f 3 cycle\uff0c\u610f\u5473\u7740\u9ad8\u901a\u5b9e\u73b0\u4e86 3 cycle \u7684 pointer chasing load to use latency\uff0c\u8fd9\u4e2a\u7279\u6027\u5728\u82f9\u679c\uff0cExynos M-series \u548c Intel \u7684 E-core \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u9488\u5bf9\u8fd9\u4e2a\u4f18\u5316\u7684\u8ba8\u8bba\uff0c\u8be6\u89c1 <a href=\"../../../../2022/03/31/brief-into-ooo-2/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e8c\uff1a\u8bbf\u5b58\uff09</a> \u7684 Load Pipeline \u5c0f\u8282\u3002\u5728\u5176\u4ed6\u573a\u666f\u4e0b\uff0c\u4f9d\u7136\u662f 4 cycle \u7684 load to use latency\u3002</p>\n<h4 id=\"loadstore-\u5e26\u5bbd\">Load/Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#loadstore-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>4x 128b Load</li>\n<li>3x 128b Load + 1x 128b Store</li>\n<li>2x 128b Load + 2x 128b Store</li>\n<li>1x 128b Load + 2x 128b Store</li>\n<li>2x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 64B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 32B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002</p>\n<p>\u4e0d\u592a\u786e\u5b9a\u7684\u662f\u9ad8\u901a\u5b98\u65b9\u7684\u8868\u8ff0\u91cc <code>Up to 4 Load-Store operations per cycle</code> \u5bf9\u4e8e 4 Store ops per cycle \u4ee5\u4ec0\u4e48\u65b9\u5f0f\u6210\u7acb\uff0c\u56e0\u4e3a\u4ece IPC \u6765\u770b\uff0c\u53ea\u80fd\u8fbe\u5230 2 Store Per Cycle\u3002</p>\n<h4 id=\"l1-dcache-\u5206-bank\">L1 DCache \u5206 Bank<a class=\"headerlink\" href=\"#l1-dcache-\u5206-bank\" title=\"Permanent link\">&para;</a></h4>\n<p>\u8003\u8651\u5230 L1 DCache \u9700\u8981\u5355\u5468\u671f\u652f\u6301 4 \u6761 Load \u6307\u4ee4\uff0c\u5982\u679c\u8981\u7528\u5355\u8bfb\u53e3\u7684 SRAM\uff0c\u4e00\u822c\u7684\u505a\u6cd5\u662f\u8bbe\u8ba1 4 \u4e2a Bank\uff0c\u6bcf\u4e2a Bank \u5bf9\u5e94\u4e00\u7ec4 SRAM\u3002\u4e3a\u4e86\u6d4b\u8bd5 Bank \u7684\u7c92\u5ea6\uff0c\u4f7f\u7528\u4e0d\u540c\u8de8\u6b65\uff08Stride\uff09\u7684 Load\uff0c\u89c2\u5bdf IPC\uff1a</p>\n<ul>\n<li>Stride=1B/2B/4B/8B/16B/32B/64B \u65f6 IPC=4</li>\n<li>Stride=128B \u65f6 IPC=2</li>\n<li>Stride=256B \u65f6 IPC=1</li>\n</ul>\n<p>\u5f53\u591a\u4e2a Load \u8bbf\u95ee\u540c\u4e00\u4e2a Cache Line \u65f6\uff0c\u8fd9\u4e9b Load \u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\uff0c\u6781\u9650\u60c5\u51b5\u4e0b\u7528 4 \u6761 128b Load \u53ef\u4ee5\u505a\u5230\u4e00\u4e2a\u5468\u671f\u628a\u6574\u4e2a 64B Cache Line \u90fd\u8bfb\u51fa\u6765\uff1bStride=128B \u65f6\uff0cIPC \u780d\u534a\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u534a\u7684 Bank \u5f97\u5230\u4e86\u5229\u7528\uff0c\u8fdb\u4e00\u6b65 Stride=256B \u65f6\uff0cIPC=1\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u4e2a Bank \u88ab\u7528\u4e0a\u3002</p>\n<p>\u90a3\u4e48 L1 DCache \u7684\u7ec4\u7ec7\u65b9\u5f0f\u5e94\u8be5\u662f 4 \u4e2a Bank\uff0cBank Index \u5bf9\u5e94 PA[7:6]\uff0c\u4e5f\u5c31\u662f\u8fde\u7eed\u7684\u56db\u4e2a 64B Cache Line \u4f1a\u88ab\u6620\u5c04\u5230\u56db\u4e2a Bank \u4e0a\u3002\u5f53\u591a\u4e2a Load \u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a Bank \u4e14\u8bbf\u95ee\u7684\u4e0d\u662f\u540c\u4e00\u4e2a Cache Line \u65f6\uff0c\u4f1a\u51fa\u73b0\u6027\u80fd\u635f\u5931\u3002</p>\n<p>\u8fd9\u91cc\u8ba8\u8bba\u7684\u662f\u7f13\u5b58\u884c\u7ea7\u522b\u7684 Bank\uff0c\u5b9e\u9645\u4e0a\u901a\u5e38\u7f13\u5b58\u884c\u5185\u90e8\u4e5f\u4f1a\u8fdb\u884c Bank \u5212\u5206\uff0c\u4f46\u4e3b\u8981\u662f\u4e3a\u4e86\u529f\u8017\uff0c\u6bd4\u5982\u4ece\u4e00\u4e2a 64B \u7f13\u5b58\u884c\u91cc\u8bfb\u53d6 8B \u6570\u636e\uff0c\u4e0d\u9700\u8981\u628a\u6574\u4e2a 64B \u90fd\u8bfb\u51fa\u6765\u3002</p>\n<h4 id=\"vipt\">VIPT<a class=\"headerlink\" href=\"#vipt\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 4KB page \u7684\u60c5\u51b5\u4e0b\uff0c96KB 6-way \u7684 L1 DCache \u4e0d\u6ee1\u8db3 VIPT \u7684 Index \u5168\u5728\u9875\u5185\u504f\u79fb\u7684\u6761\u4ef6\uff08\u8be6\u89c1 <a href=\"../../../../2023/12/08/vipt-l1-cache-page-size/\">VIPT \u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb</a>\uff09\uff0c\u6b64\u65f6\u8981\u4e48\u6539\u7528 PIPT\uff0c\u8981\u4e48\u5728 VIPT \u7684\u57fa\u7840\u4e0a\u5904\u7406 alias \u7684\u95ee\u9898\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e00\u70b9\uff0c\u53c2\u8003 <a href=\"https://blog.cyyself.name/why-the-big-l1-cache-is-so-hard/\">\u6d45\u8c08\u73b0\u4ee3\u5904\u7406\u5668\u5b9e\u73b0\u8d85\u5927 L1 Cache \u7684\u65b9\u5f0f</a> \u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u7528 shm \u6784\u9020\u51fa\u4e24\u4e2a 4KB \u865a\u62df\u9875\u6620\u5c04\u5230\u540c\u4e00\u4e2a\u7269\u7406\u9875\u7684\u60c5\u51b5\uff0c\u7136\u540e\u5728\u4e24\u4e2a\u865a\u62df\u9875\u4e4b\u95f4 copy\uff0c\u53d1\u73b0\u76f8\u6bd4\u5728\u540c\u4e00\u4e2a\u865a\u62df\u9875\u5185 copy \u6709\u663e\u8457\u7684\u6027\u80fd\u4e0b\u964d\uff0c\u5e76\u4e14\u4ea7\u751f\u4e86\u5927\u91cf\u7684 L1 DCache Refill\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>copy from aliased page = 8407465601 cycles, 321782134 refills\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>baseline = 1239053083 cycles, 20 refills\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>slowdown = 6.79x\n</span></code></pre></div>\n<p>\u56e0\u6b64\u731c\u6d4b L1 DCache \u91c7\u7528\u7684\u662f VIPT\uff0c\u5e76\u505a\u4e86\u9488\u5bf9 alias \u7684\u6b63\u786e\u6027\u5904\u7406\u3002\u5982\u679c\u662f PIPT\uff0c\u90a3\u4e48 L1 DCache \u4f1a\u53d1\u73b0\u8fd9\u4e24\u4e2a\u9875\u5bf9\u5e94\u7684\u662f\u76f8\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u6027\u80fd\u4e0d\u4f1a\u4e0b\u964d\uff0c\u4e5f\u4e0d\u9700\u8981\u9891\u7e41\u7684 refill\u3002</p>\n<h4 id=\"memory-dependency-predictor\">Memory Dependency Predictor<a class=\"headerlink\" href=\"#memory-dependency-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u9884\u6d4b\u6267\u884c Load\uff0c\u9700\u8981\u4fdd\u8bc1 Load \u548c\u4e4b\u524d\u7684 Store \u8bbf\u95ee\u7684\u5185\u5b58\u6ca1\u6709 Overlap\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u9884\u6d4b\u5668\u6765\u9884\u6d4b Load \u548c Store \u4e4b\u524d\u5728\u5185\u5b58\u4e0a\u7684\u4f9d\u8d56\u3002\u53c2\u8003 <a href=\"https://blog.stuffedcow.net/2014/01/x86-memory-disambiguation/\">Store-to-Load Forwarding and Memory Disambiguation in x86 Processors</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e24\u4e2a\u6307\u4ee4\u6a21\u5f0f\uff0c\u5206\u522b\u5728\u5730\u5740\u548c\u6570\u636e\u4e0a\u6709\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>\u6570\u636e\u4f9d\u8d56\uff0c\u5730\u5740\u65e0\u4f9d\u8d56\uff1a<code>str x3, [x1]</code> \u548c <code>ldr x3, [x2]</code></li>\n<li>\u5730\u5740\u4f9d\u8d56\uff0c\u6570\u636e\u65e0\u4f9d\u8d56\uff1a<code>str x2, [x1]</code> \u548c <code>ldr x1, [x2]</code></li>\n</ul>\n<p>\u521d\u59cb\u5316\u65f6\uff0c<code>x1</code> \u548c <code>x2</code> \u6307\u5411\u540c\u4e00\u4e2a\u5730\u5740\uff0c\u91cd\u590d\u5982\u4e0a\u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u89c2\u5bdf\u5230\u591a\u5c11\u6761 <code>ldr</code> \u6307\u4ee4\u65f6\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_memory_dependency_predictor.png\" /></p>\n<p>\u6709\u610f\u601d\u7684\u662f\uff0c\u4e24\u79cd\u6a21\u5f0f\u51fa\u73b0\u4e86\u4e0d\u540c\u7684\u9608\u503c\uff0c\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 64\uff0c\u800c\u6570\u636e\u4f9d\u8d56\u7684\u9608\u503c\u662f 96\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff1a</p>\n<p>\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>[-1,0]</td>\n<td>[-3,0]</td>\n<td>[-7,0]</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>[-1,1]</td>\n<td>[-3,1]</td>\n<td>[-7,1]</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[-1,3]</td>\n<td>[-3,3]</td>\n<td>[-7,3]</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[-1,7]</td>\n<td>[-3,7]</td>\n<td>[-7,7]</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u8868\u53ef\u4ee5\u770b\u5230\uff0c\u6240\u6709 Store \u548c Load Overlap \u7684\u60c5\u51b5\uff0c\u65e0\u8bba\u5730\u5740\u504f\u79fb\uff0c\u90fd\u80fd\u6210\u529f\u8f6c\u53d1\uff0c\u4e0d\u8fc7\u4ee3\u4ef7\u662f\u5982\u679c Load \u6216 Store \u8de8\u8d8a 64B \u7f13\u5b58\u884c\u7684\u8fb9\u754c\u65f6\u5c31\u4f1a\u8f6c\u53d1\u5931\u8d25\uff0c\u6bd5\u7adf\u5728\u53ea\u6709\u90e8\u5206\u8986\u76d6\u7684\u60c5\u51b5\u4e0b\uff0c\u5269\u4e0b\u7684\u90e8\u5206\u9700\u8981\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\u3002<a href=\"../../../12/26/apple_m1/\">Apple Firestorm</a> \u548c Qualcomm Oryon \u6bd4\u8f83\u7c7b\u4f3c\uff0c\u6240\u6709 Overlap \u60c5\u51b5\u4e0b\u90fd\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u4f46\u5373\u4f7f\u662f\u8de8\u8d8a 64B \u7f13\u5b58\u884c\u4e5f\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u53ea\u9700\u8981\u591a\u82b1\u8d39\u4e00\u4e2a\u5468\u671f\u3002</p>\n<p>\u4e00\u4e2a Load \u9700\u8981\u8f6c\u53d1\u4e24\u4e2a Store \u7684\u6570\u636e\u7684\u60c5\u51b5\u6bd4\u8f83\u5947\u602a\uff1a\u5bf9\u5730\u5740 x \u7684 32b Store \u548c\u5bf9\u5730\u5740 x+4 \u7684 32b Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 64b Load\uff0c\u8981\u6c42 x%4==0\uff0c\u4e0d\u8de8\u8d8a 64B \u7f13\u5b58\u884c\uff0c\u5bf9 y-x \u9664\u4e86 Overlap \u4ee5\u5916\u6ca1\u6709\u989d\u5916\u7684\u8981\u6c42\u3002Apple Firestorm \u5219\u6ca1\u6709 x%4==0 \u8fd9\u4e2a\u5c40\u9650\u6027\uff0c\u4f46\u5728\u8de8\u8d8a 64B \u7f13\u5b58\u884c\u65f6\u4e5f\u4e0d\u80fd\u8f6c\u53d1\u3002</p>\n<p>\u4f46 64b Load \u5c31\u4e0d\u652f\u6301\u4ece 4 \u4e2a 16b Store \u8f6c\u53d1\u4e86\uff0c8 \u4e2a 8b Store \u4e5f\u4e0d\u652f\u6301\u3002Apple Firestorm \u5219\u90fd\u652f\u6301\uff0c\u76f8\u6bd4\u4ece\u5355\u4e2a Store \u8f6c\u53d1\u591a 1-4 \u4e2a\u5468\u671f\u3002</p>\n<p>\u7531\u6b64\u770b\u51fa Oryon \u548c <a href=\"../../../11/11/amd_zen5/\">Zen 5</a> \u4ee5\u53ca <a href=\"../../../11/07/arm_neoverse_v2/\">Neoverse V2</a> \u5728\u8bbe\u8ba1\u601d\u8def\u4e0a\u7684\u4e0d\u540c\uff1aOryon \u8ffd\u6c42 Load \u548c Store \u7684\u81ea\u7531\u7ec4\u5408\uff0c\u5141\u8bb8\u53ea\u6709\u4e00\u90e8\u5206\u8986\u76d6\uff0c\u4e5f\u65e0\u6240\u8c13\u5730\u5740\u504f\u79fb\u662f\u591a\u5c11\uff0c\u4f46\u4e5f\u727a\u7272\u4e86\u8de8 64B \u7f13\u5b58\u884c\u65f6\u7684\u6027\u80fd\u3002\u6b64\u5916\uff0cOryon \u9488\u5bf9\u4e00\u4e2a Load \u8f6c\u53d1\u4e24\u4e2a Store \u7684\u60c5\u51b5\u7684\u652f\u6301\u6bd4\u8f83\u7279\u522b\uff0c\u8981\u6c42 Store \u5730\u5740\u5bf9\u9f50\u5230 4B\u3002</p>\n<p>\u6210\u529f\u8f6c\u53d1\u65f6 9 cycle\uff0c\u6709 Overlap \u4f46\u8f6c\u53d1\u5931\u8d25\u65f6 17-23 cycle\uff0c\u8de8\u7f13\u5b58\u884c\u65f6\u8981 40+ cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aQualcomm Oryon \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 2 st: \u8981\u6c42 ld \u5bf9\u9f50\u5230 4B \u8fb9\u754c\u4e14\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 4 st: \u4e0d\u652f\u6301</li>\n</ul>\n<h4 id=\"load-to-use-latency\">Load to use latency<a class=\"headerlink\" href=\"#load-to-use-latency\" title=\"Permanent link\">&para;</a></h4>\n<p>Oryon \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n</ul>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 5 cycle\uff1a</p>\n<ul>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u6bd4\u8f83\u5947\u602a\u7684\u662f <code>ldr x0, [x0]</code> \u5728\u8de8\u8d8a 8B \u8fb9\u754c\u65f6\u7684\u884c\u4e3a\uff0cload to load latency \u9000\u5316\u4e3a 6 cycle\uff0cload to alu latency \u5219\u662f 4 cycle\u3002Apple Firestorm \u5219\u6ca1\u6709\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728\u8de8\u8d8a 8B \u8fb9\u754c\u751a\u81f3 64B \u8fb9\u754c\u65f6\uff0c\u5b9e\u73b0\u4e86 4 cycle load to load latency \u548c 4 cycle load to alu latency\u3002</p>\n<h4 id=\"virtual-address-utagway-predictor\">Virtual Address UTag/Way-Predictor<a class=\"headerlink\" href=\"#virtual-address-utagway-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>Linear Address UTag/Way-Predictor \u662f AMD \u7684\u53eb\u6cd5\uff0c\u4f46\u4f7f\u7528\u76f8\u540c\u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u5728 Qualcomm Oryon \u4e0a\u89c2\u5bdf\u5230\u7c7b\u4f3c\u7684\u73b0\u8c61\uff0c\u731c\u60f3\u5b83\u4e5f\u7528\u4e86\u7c7b\u4f3c\u7684\u57fa\u4e8e\u865a\u62df\u5730\u5740\u7684 UTag/Way Predictor \u65b9\u6848\uff0c\u5e76\u6d4b\u51fa\u6765\u5b83\u7684 UTag \u4e5f\u6709 8 bit\uff1a</p>\n<ul>\n<li>VA[14] xor VA[22] xor VA[30] xor VA[38] xor VA[46]</li>\n<li>VA[15] xor VA[23] xor VA[31] xor VA[39] xor VA[47]</li>\n<li>VA[16] xor VA[24] xor VA[32] xor VA[40]</li>\n<li>VA[17] xor VA[25] xor VA[33] xor VA[41]</li>\n<li>VA[18] xor VA[26] xor VA[34] xor VA[42]</li>\n<li>VA[19] xor VA[27] xor VA[35] xor VA[43]</li>\n<li>VA[20] xor VA[28] xor VA[36] xor VA[44]</li>\n<li>VA[21] xor VA[29] xor VA[37] xor VA[45]</li>\n</ul>\n<p>\u4e00\u5171\u6709 8 bit\uff0c\u7531 VA[47:14] \u6298\u53e0\u800c\u6765\uff0c\u548c Apple M1 \u4e00\u6837\u3002</p>\n<p>\u9664\u4e86 UTag \u53ef\u80fd\u51b2\u7a81\u4ee5\u5916\uff0c\u5982\u679c VA[13:12] \u51fa\u73b0\u4e86 VIPT \u5bfc\u81f4\u7684 alias\uff0c\u4e5f\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\u3002</p>\n<h3 id=\"mmu\">MMU<a class=\"headerlink\" href=\"#mmu\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>4KB and 64KB translation granules</li>\n<li>1 cycle access for L1 ITLB &amp; L1 DTLB</li>\n<li>Unified L2 TLB, 8-way &gt;8K entry</li>\n</ul>\n<h4 id=\"l2-tlb\">L2 TLB<a class=\"headerlink\" href=\"#l2-tlb\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6cbf\u7528\u4e4b\u524d\u6d4b\u8bd5 L1 DTLB \u7684\u65b9\u6cd5\uff0c\u628a\u89c4\u6a21\u6269\u5927\u5230 L2 Unified TLB \u7684\u8303\u56f4\uff0c\u5c31\u53ef\u4ee5\u6d4b\u51fa\u6765 L2 Unified TLB \u7684\u5bb9\u91cf\uff0c\u4e0b\u9762\u662f Oryon \u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 32768 \u4e2a Page \u9644\u8fd1\uff0c\u8bf4\u660e Oryon \u7684 L2 TLB \u5bb9\u91cf\u662f 32768 \u9879\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u628a\u6d4b\u8bd5\u8303\u56f4\u6269\u5927\uff0c\u770b\u5230\u5b8c\u6574\u7684\u56fe\u50cf\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_tlb.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u662f 224 * 4 KB = 896 KB\uff0c\u5bf9\u5e94 L1 DTLB\uff0c\u6b64\u65f6\u8bbf\u5b58\u5ef6\u8fdf\u662f 3 cycle\uff1b\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u662f 32768 * 4 KB = 131072 KB\uff0c\u5bf9\u5e94 L2 TLB\uff0c\u6b64\u65f6\u8bbf\u5b58\u5ef6\u8fdf\u662f 29.5 cycle\uff0c\u8fd9\u4e2a\u65f6\u5019\u5bf9 Cache \u7684\u5360\u7528\u662f 32768 * 64 = 2 MB\uff0c\u5df2\u7ecf\u8d85\u8fc7\u4e86 L1 DCache \u5bb9\u91cf\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5ef6\u8fdf\u5305\u62ec\u4e86 L1 DCache miss \u7684\u5ef6\u8fdf\uff0c\u5982\u679c\u53bb\u6389\u5b98\u65b9\u5ba3\u79f0\u7684 17 cycle \u7684 L1 DCache miss \u5ef6\u8fdf\uff0c\u5c31\u5f97\u5230 29.5 - 17 = 12.5 cycle\u3002</p>\n<p>\u7531\u4e8e Oryon \u7684 L2 TLB \u5f88\u5927\uff0c\u5f88\u5bb9\u6613\u9047\u5230\u6570\u636e\u7f13\u5b58\u5bb9\u91cf\u7684\u74f6\u9888\uff0c\u56e0\u6b64\u628a\u6307\u9488\u7684\u8de8\u5ea6\u8c03\u5927\uff0c\u4f7f\u5f97\u7b49\u6548 L2 TLB \u5bb9\u91cf\u53d8\u5c0f\uff0c\u4f46\u6570\u636e\u7f13\u5b58\u5bb9\u91cf\u4e0d\u53d8\uff0c\u53ef\u4ee5\u6d4b\u8bd5\u53bb\u6389\u7f13\u5b58\u7f3a\u5931\u5ef6\u8fdf\u540e\u7684\u6027\u80fd\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6bcf 512 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 64\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e0d\u592a\u7a33\u5b9a\uff0c\u6000\u7591\u6709\u9884\u53d6</li>\n<li>\u5982\u679c\u6bcf 1024 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 32\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 55-57</li>\n<li>\u5982\u679c\u6bcf 2048 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 16\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 53-57</li>\n<li>\u5982\u679c\u6bcf 4096 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 8\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 59-67</li>\n<li>\u5982\u679c\u6bcf 8192 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u4f9d\u7136\u5728 8\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 59-71</li>\n<li>\u89c2\u5bdf\u5230\u547d\u4e2d L1 DTLB \u65f6 CPI \u662f 3\uff0c\u547d\u4e2d L2 TLB \u65f6 CPI \u662f 11\uff08\u6bcf 1024 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\u65f6\u4f8b\u5916\uff0cCPI \u4ece 11 \u7f13\u6162\u4e0b\u964d\u5230 14.5\uff09\uff0c\u6b64\u65f6 L1 \u6570\u636e\u7f13\u5b58\u7f3a\u5931\u7387\u4e3a 0\uff0c\u5ef6\u8fdf\u90fd\u6765\u81ea\u4e8e L1 DTLB miss</li>\n</ul>\n<p>\u8ba4\u4e3a Oryon \u7684 L2 TLB \u662f 8 Way\uff0c4096 Set\uff0c\u90a3\u5c31\u662f 32768 \u4e2a entry\uff0cIndex \u662f VA[23:12]\u3002\u4f46\u5b98\u65b9\u58f0\u79f0\u7684\u662f <code>&gt;8K</code>\uff0c\u8fd9\u4e2a\u8868\u8ff0\u6bd4\u8f83\u8010\u4eba\u5bfb\u5473\uff0c\u53ef\u80fd\u662f 8K \u4e2a entry\uff0c\u6bcf\u4e2a entry \u6700\u591a\u8bb0\u5f55\u56db\u4e2a\u9875\u7684\u6620\u5c04\u5173\u7cfb\u3002</p>\n<p>\u547d\u4e2d L2 TLB \u7684\u65f6\u95f4\u6709\u957f\u6709\u77ed\uff0c\u8bf4\u660e\u5b83\u7684 entry \u4e0d\u662f\u7b49\u540c\u7684\uff0c\u968f\u7740\u8bbf\u95ee\u8303\u56f4\u53d8\u5927\uff0c\u5373\u4f7f\u90fd\u547d\u4e2d\uff0c\u5ef6\u8fdf\u4e5f\u4f1a\u4e0a\u5347\u3002</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>\u6bcf 4 \u4e2a\u6838\u5fc3\u7ec4\u6210\u4e00\u4e2a Cluster\uff0cCluster \u5185\u7684\u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 12MB 12-way L2 Cache</li>\n<li>MOESI</li>\n<li>17 cycle latency for L1 miss to L2 hit</li>\n</ul>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_l2.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u5728 96KB\uff0c\u5bf9\u5e94 L1 DCache \u7684\u5bb9\u91cf\uff0c\u4e4b\u540e\u5ef6\u8fdf\u5728 18-22 \u5468\u671f\u4e4b\u95f4\u6ce2\u52a8\uff0c\u4e2d\u95f4\u4e00\u6bb5\u6bd4\u8f83\u7a33\u5b9a\u5728 20 cycle\uff0c\u8fd9\u5bf9\u5e94\u4e86 3 cycle load to load latency + 17 cycle l1 miss penalty\u3002</p>\n<p>\u5ef6\u8fdf\u8d85\u8fc7 6MB \u4ee5\u540e\u5ef6\u8fdf\u5feb\u901f\u4e0a\u5347\uff0c\u5bf9\u6b64\u6709\u4e24\u79cd\u731c\u6d4b\uff1a</p>\n<ol>\n<li>L2 Cache \u5e76\u975e\u6240\u6709\u5bb9\u91cf\u90fd\u53ef\u4ee5\u5728\u5dee\u4e0d\u591a\u7684\u65f6\u95f4\u5185\u8bbf\u95ee\uff0c\u79bb\u6838\u5fc3\u8fd1\u7684\u66f4\u5feb\uff0c\u79bb\u6838\u5fc3\u8fdc\u7684\u8f83\u6162</li>\n<li>\u4e3a\u4e86\u9632\u6b62\u67d0\u4e2a\u6838\u5fc3\u5bf9 L2 Cache \u7684\u5360\u7528\u592a\u5927\uff0c\u5bfc\u81f4\u540c\u4e00\u4e2a Cluster \u5185\u5176\u4ed6\u6838\u5fc3\u5206\u4e0d\u5230 L2 \u7f13\u5b58\uff0c\u8fdb\u884c QoS\uff0c\u9650\u5236\u6bcf\u4e2a\u6838\u5fc3\u80fd\u591f\u5360\u7528\u7684 L2 Cache \u5bb9\u91cf</li>\n</ol>\n<p>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u9a8c\u8bc1\u4ee5\u4e0a\u7684\u731c\u6d4b\uff0c\u9664\u4e86\u5468\u671f\u6570\u4ee5\u5916\uff0c\u4e5f\u6d4b\u8bd5\u4e86\u4e0d\u540c footprint \u4e0b L2D_CACHE_REFILL \u4e8b\u4ef6\u7684\u6b21\u6570\uff0c\u53d1\u73b0\uff1a</p>\n<ol>\n<li>footprint \u5728 8MB \u8303\u56f4\u5185\u65f6\uff0cL2D_CACHE_REFILL \u7ea6\u7b49\u4e8e 0\uff0c\u610f\u5473\u7740\u6b64\u65f6\u6570\u636e\u90fd\u547d\u4e2d\u4e86 L2 Cache\uff0c\u4f46\u5f53 footprint \u8fbe\u5230 8MB \u65f6\uff0c\u8bbf\u95ee\u5ef6\u8fdf\u5df2\u7ecf\u589e\u52a0\u5230 45 \u4e2a\u5468\u671f\uff0c\u8fd9\u7b26\u5408\u7b2c\u4e00\u70b9\u731c\u6d4b\uff0c\u5373\u4f7f\u90fd\u547d\u4e2d L2 Cache\uff0c\u4e5f\u6709\u5feb\u6162\u4e4b\u5206</li>\n<li>footprint \u8fbe\u5230 12 MB \u65f6\uff0c\u6bcf\u6b21\u8bbf\u5b58\u7684\u5e73\u5747 L2D_CACHE_REFILL \u7ea6\u7b49\u4e8e 0.23\uff0c\u5047\u5982\u4e00\u4e2a\u6838\u5fc3\u53ef\u4ee5\u7528\u6ee1\u6574\u4e2a L2 Cache\uff0c\u6b64\u65f6\u5e94\u5f53\u6ca1\u6709\u8fd9\u4e48\u9ad8\u7684\u7f3a\u5931\u7387\uff0c\u8fd9\u7b26\u5408\u7b2c\u4e8c\u70b9\u731c\u6d4b</li>\n</ol>\n<p>\u56e0\u6b64\u53ef\u80fd\u4e0a\u8ff0\u4e24\u4e2a\u731c\u6d4b\u90fd\u662f\u5bf9\u7684\uff0c\u5f53\u7136\u4e86\uff0c\u4e5f\u4e0d\u6392\u9664\u8fd8\u6709\u522b\u7684\u89e3\u91ca\u3002</p>\n<h3 id=\"memory\">Memory<a class=\"headerlink\" href=\"#memory\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>6MB System Level Cache, 26-29ns latency, 135GB/s bandwidth in each direction</li>\n<li>LPDDR5x DRAM, 8448 MT/s, 8 channel of 16 bits, 135GB/s bandwidth, 102-104ns latency</li>\n</ul>\n<p>\u901a\u8fc7 dmidecode\uff0c\u53ef\u4ee5\u770b\u5230 Surface Laptop 7 \u7684\u5185\u5b58\u578b\u53f7\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>Handle 0x0004, DMI type 17, 92 bytes\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>Memory Device\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>        Total Width: 16 bits\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>        Data Width: 16 bits\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>        Size: 32 GB\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>        Form Factor: TSOP\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>        Locator: Top - on board\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>        Bank Locator: Bank 0\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a>        Type: LPDDR5\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a>        Speed: 8448 MT/s\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a>        Manufacturer: Hynix\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a>        Part Number: H58G66BK8BX067\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a>        Configured Memory Speed: 8448 MT/s\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a>        Minimum Voltage: 0.348 V\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a>        Maximum Voltage: 0.856 V\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a>        Configured Voltage: 0.8 V\n</span></code></pre></div>", "image": null, "date_published": "2024-09-01T00:00:00+00:00", "authors": [], "tags": ["cpu", "hardware", "oryon", "performance", "qualcomm", "uarch-review", "xelite"]}, {"id": "https://jia.je/hardware/2024/08/02/branch-prediction-2-taken-2-ahead/", "url": "https://jia.je/hardware/2024/08/02/branch-prediction-2-taken-2-ahead/", "title": "\u5206\u652f\u9884\u6d4b\u7684 2-taken \u548c 2-ahead", "content_html": "<h1 id=\"\u5206\u652f\u9884\u6d4b\u7684-2-taken-\u548c-2-ahead\">\u5206\u652f\u9884\u6d4b\u7684 2-taken \u548c 2-ahead<a class=\"headerlink\" href=\"#\u5206\u652f\u9884\u6d4b\u7684-2-taken-\u548c-2-ahead\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u968f\u7740 Zen 5 \u7684\u63a8\u51fa\uff0c\u66f4\u591a Zen5 \u7684\u67b6\u6784\u8bbe\u8ba1\u7ec6\u8282\u88ab\u516c\u5f00\uff0c\u53ef\u4ee5\u770b\u5230 Zen 5 \u524d\u7aef\u51fa\u73b0\u4e86\u4ee4\u4eba\u77a9\u76ee\u7684\u53d8\u5316\uff1a\u5f15\u5165\u4e86 2-taken, 2-ahead \u5206\u652f\u9884\u6d4b\u7684\u8bbe\u8ba1\u3002\u8fd9\u662f\u4ec0\u4e48\u610f\u601d\uff1f\u5b83\u67b6\u6784\u4e0a\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1f\u53ef\u4ee5\u5e26\u6765\u54ea\u4e9b\u6027\u80fd\u63d0\u5347\uff1f</p>\n<!-- more -->\n\n<h2 id=\"\u80cc\u666f\u77e5\u8bc6\">\u80cc\u666f\u77e5\u8bc6<a class=\"headerlink\" href=\"#\u80cc\u666f\u77e5\u8bc6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u8fd8\u662f\u56de\u987e\u4e00\u4e0b\u5904\u7406\u5668\u524d\u7aef\u5728\u505a\u7684\u4e8b\u60c5\uff1a\u6839\u636e PC\uff0c\u4ece ICache \u8bfb\u53d6\u6307\u4ee4\uff0c\u7136\u540e\u8bd1\u7801\uff0c\u53d1\u7ed9\u540e\u7aef\u53d6\u6267\u884c\u3002\u4f46\u662f\u6267\u884c\u7684\u7684\u6307\u4ee4\u91cc\u6709\u5927\u91cf\u7684\u5206\u652f\u6307\u4ee4\uff0c\u5b83\u4eec\u4f1a\u6539\u53d8 PC\uff0c\u540e\u7eed\u6307\u4ee4\u9700\u8981\u4ece\u65b0\u7684 PC \u5904\u53d6\uff0c\u4f46\u662f\u53d6\u6307\u7684\u65f6\u5019\u5e76\u4e0d\u77e5\u9053\u5206\u652f\u6307\u4ee4\u672a\u6765\u4f1a\u5982\u4f55\u8df3\u8f6c\uff0c\u5982\u679c\u6bcf\u6b21\u5206\u652f\u6307\u4ee4\u90fd\u8981\u5237\u6d41\u6c34\u7ebf\u91cd\u65b0\u53d6\u6307\uff0c\u5c31\u4f1a\u4ea7\u751f\u5f88\u591a\u7684\u6d41\u6c34\u7ebf\u7a7a\u6ce1\uff0c\u56e0\u6b64\u5c31\u6709\u4e86\u5206\u652f\u9884\u6d4b\u3002</p>\n<p>\u5206\u652f\u9884\u6d4b\u548c\u53d6\u6307\u662f\u540c\u65f6\u8fdb\u884c\u7684\uff1a\u53d6\u6307\u4ee4\u7684\u540c\u65f6\uff0c\u4e5f\u5728\u9884\u6d4b\u8fd9\u4e9b\u6307\u4ee4\u662f\u5426\u4f1a\u8df3\u8f6c\uff0c\u5982\u679c\u4f1a\u8df3\u8f6c\uff0c\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740\u662f\u591a\u5c11\uff0c\u7528\u4e8e\u6307\u5bfc\u4e0b\u4e00\u4e2a\u5468\u671f\u4ece\u54ea\u91cc\u53d6\u6307\u3002\u4e3a\u4e86\u505a\u5230\u8fd9\u4e2a\u4e8b\u60c5\uff0c\u9996\u5148\u9700\u8981\u77e5\u9053\u6709\u6ca1\u6709\u5206\u652f\u6216\u8df3\u8f6c\u6307\u4ee4\uff0c\u8fd9\u4e2a\u4fe1\u606f\u4f1a\u4fdd\u5b58\u5728 BTB \u4e2d\uff0c\u6216\u8005\u8981\u7b49\u5230\u53d6\u6307\u5b8c\u6210\uff0c\u8bd1\u7801\u540e\u624d\u77e5\u9053\u54ea\u4e9b\u662f\u5206\u652f\u6216\u8df3\u8f6c\u6307\u4ee4\u3002\u5982\u679c\u6709\uff0c\u5bf9\u4e8e\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u6765\u8bf4\uff0c\u9700\u8981\u4e00\u4e2a\u65b9\u5411\u9884\u6d4b\u5668\uff08CBP\uff09\uff0c\u5224\u65ad\u5206\u652f\u662f\u5426\u4f1a\u8df3\u8f6c\uff0c\u8fd8\u9700\u8981\u4e00\u4e2a\u5206\u652f\u76ee\u7684\u5730\u5740\u7f13\u5b58\uff08BTB\uff09\uff0c\u5982\u679c\u5206\u652f\u8981\u8df3\u7684\u8bdd\uff0c\u77e5\u9053\u8981\u8df3\u5230\u4ec0\u4e48\u5730\u65b9\u3002\u9664\u4e86\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u4ee5\u5916\uff0c\u9488\u5bf9 return \u6307\u4ee4\uff0c\u8df3\u8f6c\u7684\u5730\u5740\u548c\u6b64\u524d call \u5bf9\u5e94\uff0c\u9700\u8981\u8bb0\u5f55\u8c03\u7528\u7684\u8fd4\u56de\u5730\u5740\u6808\uff08RAS\uff09\u3002\u9488\u5bf9\u5176\u4ed6\u7684\u95f4\u63a5\u8df3\u8f6c\u6307\u4ee4\uff0c\u4f8b\u5982\u51fd\u6570\u6307\u9488\u8c03\u7528\uff0c\u4e00\u4e2a\u8df3\u8f6c\u53ef\u80fd\u6709\u591a\u4e2a\u76ee\u7684\u5730\u5740\uff0c\u8fd8\u9700\u8981\u4e00\u4e2a\u9488\u5bf9\u95f4\u63a5\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740\u7684\u9884\u6d4b\u5668\uff08IBP\uff09\u3002\u8fd9\u4e9b\u7ec4\u4ef6\uff08CBP\u3001BTB\u3001RAS \u548c IBP\uff09\u6784\u6210\u4e86\u73b0\u4ee3\u5904\u7406\u5668\u7684\u5206\u652f\u9884\u6d4b\u5668\u3002</p>\n<p>\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u5206\u79bb\u5f0f/\u89e3\u8026\u5f0f\u524d\u7aef\uff08Decoupled Frontend\uff09\uff1a\u548c\u8026\u5408/\u975e\u5206\u79bb\u5f0f\u524d\u7aef\u76f8\u5bf9\uff0c\u8026\u5408\u524d\u7aef\u662f\u8bf4\u5206\u652f\u9884\u6d4b\u5668\u548c\u6307\u4ee4\u7f13\u5b58\u7d27\u5bc6\u534f\u4f5c\uff0c\u5206\u652f\u9884\u6d4b\u5668\u6307\u5bfc\u4e0b\u4e00\u6b21\u53d6\u6307\u7684\u5730\u5740\uff0c\u53d6\u51fa\u7684\u6307\u4ee4\u7acb\u5373\u7528\u4e8e\u5206\u652f\u9884\u6d4b\u5668\u3002\u5206\u79bb\u5f0f\u524d\u7aef\u628a\u5206\u652f\u9884\u6d4b\u5668\u53d8\u6210\u4e86\u751f\u4ea7\u8005\uff0c\u751f\u4ea7\u53d6\u6307\u7684\u5730\u5740\uff0c\u7136\u540e\u6307\u4ee4\u7f13\u5b58\u662f\u751f\u4ea7\u8005\uff0c\u6d88\u8d39\u53d6\u6307\u7684\u5730\u5740\uff0c\u4ece\u7f13\u5b58\u8bfb\u53d6\u6307\u4ee4\uff0c\u8fdb\u884c\u540e\u7eed\u7684\u8bd1\u7801\uff0c\u6d88\u8d39\u8005\u548c\u751f\u4ea7\u8005\u4e4b\u95f4\u901a\u8fc7\u961f\u5217\uff08Fetch Target Queue\uff09\u9694\u5f00\u3002\u8fd9\u6837\uff0c\u5206\u652f\u9884\u6d4b\u5668\u53ef\u4ee5\u72ec\u7acb\u6307\u4ee4\u7f13\u5b58\u5de5\u4f5c\uff0c\u5728\u524d\u9762\u62a2\u8dd1\uff0c\u5373\u4f7f\u6307\u4ee4\u7f13\u5b58\u51fa\u73b0\u4e86\u7f3a\u5931\uff0c\u4e5f\u53ef\u4ee5\u7ee7\u7eed\u9884\u6d4b\u672a\u6765\u5f88\u591a\u4e2a\u6307\u4ee4\u4e4b\u540e\u7684\u5206\u652f\u3002\u66f4\u8fdb\u4e00\u6b65\uff0c\u8fd8\u53ef\u4ee5\u6839\u636e\u62a2\u8dd1\u7684\u8fd9\u4e9b\u5206\u652f\u7684\u4fe1\u606f\uff0c\u63d0\u524d\u628a\u6307\u4ee4\u4ece L2 \u7f13\u5b58\u9884\u53d6\u5230 L1 \u6307\u4ee4\u7f13\u5b58\uff0c\u90a3\u4e48\u672a\u6765\u6307\u4ee4\u7f13\u5b58\u8981\u53d6\u6307\u4ee4\u7684\u65f6\u5019\uff0c\u5927\u6982\u7387\u5df2\u7ecf\u5728\u7f13\u5b58\u5f53\u4e2d\u4e86\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u89e3\u8026\u5f0f\u524d\u7aef\u7684\u62a2\u8dd1\u4e5f\u662f\u6709\u4ee3\u4ef7\u7684\uff1a\u6b64\u65f6\u5206\u652f\u9884\u6d4b\u5668\u5bf9\u672a\u6765\u53d6\u51fa\u7684\u6307\u4ee4\u5b9e\u9645\u4e0a\u4f1a\u662f\u4ec0\u4e48\u6837\u662f\u4e0d\u77e5\u9053\u7684\uff0c\u53ea\u80fd\u4f9d\u8d56 BTB \u4e2d\u8bb0\u5f55\u7684\u5386\u53f2\u4fe1\u606f\uff0c\u6240\u4ee5 BTB \u4e00\u822c\u90fd\u4f1a\u505a\u7684\u6bd4\u8f83\u5927\u3002\u4f46\u4e0e\u6b64\u540c\u65f6\uff0c\u8026\u5408\u5f0f\u524d\u7aef\u53ef\u4ee5\u5728 L1 \u6307\u4ee4\u7f13\u5b58\u4ece L2 \u52a0\u8f7d\u6307\u4ee4\u65f6\u505a\u9884\u8bd1\u7801\uff0c\u627e\u5230\u5176\u4e2d\u7684\u5206\u652f\uff0c\u7136\u540e\u62ff L1 \u6307\u4ee4\u7f13\u5b58\u4f5c\u4e3a\u66f4\u5927\u7684 BTB\uff0c\u4f8b\u5982 Apple M1 Firestorm \u5c31\u53ef\u4ee5\u62ff\u5de8\u5927\u7684 192KB L1 \u6307\u4ee4\u7f13\u5b58\u4f5c\u4e3a BTB\uff0c\u7b49\u6548 BTB \u5bb9\u91cf\u7279\u522b\u5de8\u5927\u3002\u5b70\u597d\u5b70\u574f\uff0c\u73b0\u5728\u8fd8\u770b\u4e0d\u6e05\u695a\u3002</p>\n<p>\u90a3\u4e48\u4e00\u4e2a\u5206\u652f\uff0c\u4ece\u5206\u652f\u9884\u6d4b\uff0c\u5230\u53d6\u6307\uff0c\u6267\u884c\uff0c\u4f1a\u7ecf\u5386\u54ea\u4e9b\u9636\u6bb5\u5462\uff1f\u9996\u5148\u662f\u5206\u652f\u9884\u6d4b\uff0c\u5206\u652f\u9884\u6d4b\u5668\u4f1a\u628a\u90a3\u4e9b\u4f1a\u8df3\u8f6c\u7684\u60c5\u51b5\u627e\u51fa\u6765\uff0c\u56e0\u4e3a\u5b83\u4f1a\u5f71\u54cd\u4e0b\u4e00\u6b21\u53d6\u6307\u7684\u5730\u5740\uff1b\u5982\u679c\u6ca1\u6709\u5206\u652f\u8df3\u8f6c\uff0c\u6216\u8005\u6709\u5206\u652f\u4f46\u662f\u4e0d\u8df3\u8f6c\uff0c\u90a3\u5c31\u6bd4\u8f83\u7b80\u5355\uff0c\u4e0b\u4e00\u6b21\u53d6\u6307\u5730\u5740\u5c31\u76f4\u63a5\u987a\u7740\u5730\u5740\u5f80\u4e0b\u7b97\u5c31\u53ef\u4ee5\u3002\u53d6\u6307\u8bd1\u7801\u4ee5\u540e\uff0c\u4f1a\u548c\u4e4b\u524d\u9884\u6d4b\u7684\u60c5\u51b5\u505a\u6bd4\u5bf9\uff0c\u5982\u679c\u53d1\u73b0\u9884\u6d4b\u6210\u4e86\u5206\u652f\uff0c\u7ed3\u679c\u5b9e\u9645\u4e0a\u4e0d\u662f\u5206\u652f\uff0c\u8bf4\u660e\u5206\u652f\u9884\u6d4b\u5668\u9519\u4e86\uff0c\u53ca\u65f6\u4fee\u6b63\u3002\u6267\u884c\u7684\u65f6\u5019\uff0c\u6309\u7167\u5206\u652f\u6307\u4ee4\u7684\u64cd\u4f5c\u6570\uff0c\u5b9e\u9645\u5224\u65ad\u4e00\u4e0b\u8981\u4e0d\u8981\u8df3\u8f6c\uff0c\u548c\u4e4b\u524d\u9884\u6d4b\u7684\u7ed3\u679c\u6bd4\u5bf9\u3002\u5982\u679c\u5bf9\u4e86\uff0c\u90a3\u5c31\u7686\u5927\u6b22\u559c\uff1b\u5982\u679c\u9519\u4e86\uff0c\u90a3\u5c31\u8981\u5237\u6389\u90a3\u4e9b\u9519\u8bef\u9884\u6d4b\u7684\u6307\u4ee4\u3002\u5f53\u7136\u8fd8\u8981\u901a\u77e5\u4e00\u4e0b\u5206\u652f\u9884\u6d4b\u5668\uff0c\u8ba9\u4ed6\u66f4\u65b0\u9884\u6d4b\u7684\u8ba1\u6570\u5668\u3002</p>\n<p>\u63a5\u4e0b\u6765\u56de\u5230\u672c\u6587\u7684\u4e3b\u9898\uff1a\u5206\u652f\u9884\u6d4b\u6700\u8fd1\u51e0\u5e74\u6765\u6bd4\u8f83\u5927\u7684\u4e00\u4e9b\u6539\u52a8\u3002</p>\n<h2 id=\"2-branch\">2 branch<a class=\"headerlink\" href=\"#2-branch\" title=\"Permanent link\">&para;</a></h2>\n<p>\u521a\u624d\u63d0\u5230\uff0c\u5206\u652f\u53c2\u4e0e\u5230\u9884\u6d4b\uff0c\u53d6\u6307\uff0c\u6267\u884c\u7b49\u9636\u6bb5\u4e4b\u4e2d\uff0c\u5176\u4e2d\u6267\u884c\u9636\u6bb5\u662f\u6bd4\u8f83\u7b80\u5355\u7684\uff0c\u6240\u4ee5\u6bd4\u8f83\u5bb9\u6613\u6269\u5c55\uff0c\u4f8b\u5982 Cortex-A77 \u5f15\u5165\u4e86\u7b2c\u4e8c\u4e2a\u5206\u652f\u6267\u884c\u5355\u5143\uff0c\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u6267\u884c\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u76ee\u524d\u5f88\u591a\u9ad8\u6027\u80fd\u5904\u7406\u5668\u90fd\u91c7\u7528\u4e86\u4e24\u4e2a\u5206\u652f\u6267\u884c\u5355\u5143\u3002\u4f46\u5927\u90e8\u5206\u5904\u7406\u5668\u6bcf\u4e2a\u5468\u671f\u53ea\u80fd\u9884\u6d4b\u4e00\u4e2a\u5206\u652f\uff0c\u8fd9\u6837\u6bcf\u4e2a\u5468\u671f\u53ea\u7528\u8bbf\u95ee\u4e00\u6b21 BTB \u7b49\u7ed3\u6784\uff0c\u90a3\u4f3c\u4e4e\u4e24\u4e2a\u5206\u652f\u6267\u884c\u5355\u5143\u6ca1\u6709\u4ec0\u4e48\u7528\uff1f\u6bd5\u7adf\u5982\u679c\u7b2c\u4e00\u4e2a\u5206\u652f\u8df3\u8f6c\u4e86\uff0c\u90a3\u7b2c\u4e8c\u4e2a\u5206\u652f\u7684\u5730\u5740\u9700\u8981\u4f9d\u8d56\u7b2c\u4e00\u4e2a\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u8ba1\u7b97\u5f97\u51fa\uff0c\u8fd9\u6837\u8fd9\u4e24\u4e2a\u5206\u652f\u7684\u9884\u6d4b\u5c31\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u5c31\u4e32\u884c\u5316\u4e86\uff0c\u8fd9\u4e2a\u662f\u6bd4\u8f83\u56f0\u96be\u7684\u3002\u4f46\u5982\u679c\u7b2c\u4e00\u4e2a\u5206\u652f\u4e0d\u8df3\u8f6c\uff0c\u53bb\u9884\u6d4b\u7b2c\u4e8c\u4e2a\u5206\u652f\u8df3\u8f6c\u6216\u8005\u4e0d\u8df3\u8f6c\uff0c\u8fd9\u4e2a\u8fd8\u662f\u76f8\u5bf9\u6bd4\u8f83\u597d\u652f\u6301\u7684\u3002\u8fd9\u6837\uff0c\u5206\u652f\u9884\u6d4b\u65f6\uff0c\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u6700\u591a\u9884\u6d4b\u4e00\u4e2a taken \u5206\u652f\uff0c\u4f46\u540c\u65f6\u8fd8\u53ef\u4ee5\u6709 not taken \u5206\u652f\u3002\u6b64\u5916\uff0c\u8fd8\u6709\u90a3\u79cd\u4ece\u6765\u6ca1\u6709 taken \u8fc7\u7684\u5206\u652f\uff0c\u8fd9\u79cd\u4e00\u822c\u4e3a\u4e86\u8282\u7701 BTB \u5b58\u50a8\uff0c\u4e00\u822c\u662f\u4e0d\u8bb0\u5f55\u5728 BTB \u5185\u90e8\u7684\u3002\u8003\u8651\u5230\u8fd9\u4e9b\u60c5\u51b5\uff0c\u8bbe\u8ba1\u4e24\u4e2a\u5206\u652f\u6267\u884c\u5355\u5143\u4f1a\u6709\u4e00\u4e9b\u6536\u76ca\u3002</p>\n<p>\u4f46\u662f\u4e3a\u4ec0\u4e48\u6ca1\u6709\u589e\u52a0\u5230\u4e09\u4e2a\u5462\uff1f\u8fd8\u771f\u6709\uff0cZen 5 \u5c31\u589e\u52a0\u5230\u4e86\u4e09\u4e2a\u5206\u652f\u6267\u884c\u5355\u5143\uff0c\u4f46\u662f\u589e\u52a0\u5230\u4e09\u4e2a\u7684\u524d\u63d0\u662f\u6bcf\u5468\u671f\u53ef\u4ee5\u9884\u6d4b\u4e24\u4e2a taken \u5206\u652f\uff0c\u5426\u5219\u6027\u80fd\u6536\u76ca\u5f88\u5c0f\u3002\u8fd9\u662f\u600e\u4e48\u505a\u5230\u7684\u5462\uff1f\u4e0b\u9762\u6211\u4eec\u6765\u8ba8\u8bba\u8fd9\u4e2a\u95ee\u9898\u3002</p>\n<h2 id=\"2-taken2-ahead\">2-taken/2-ahead<a class=\"headerlink\" href=\"#2-taken2-ahead\" title=\"Permanent link\">&para;</a></h2>\n<p>\u521a\u624d\u63d0\u5230\uff0c\u60f3\u8981\u8fdb\u4e00\u6b65\u63d0\u5347\u5206\u652f\u9884\u6d4b\u548c\u6267\u884c\u80fd\u529b\uff0c\u9700\u8981\u652f\u6301\u6bcf\u4e2a\u5468\u671f\u9884\u6d4b\u66f4\u591a\u7684 taken \u5206\u652f\uff0c\u521a\u624d\u662f 1 \u4e2a\uff0c\u73b0\u5728\u5c31\u8981 2 \u4e2a\u3002ARM \u5728 Cortex-A78 \u4e0a\u6dfb\u52a0\u4e86 2-taken \u5206\u652f\u9884\u6d4b\u7684\u652f\u6301\uff0c\u4e5f\u5c31\u662f\u53ef\u4ee5\u6bcf\u5468\u671f\u6700\u591a\u53ef\u4ee5\u9884\u6d4b\u4e24\u4e2a taken \u7684\u5206\u652f\u3002\u8fd9\u662f\u600e\u4e48\u505a\u5230\u7684\uff1f\u5982\u679c\u505a\u7684\u975e\u5e38\u901a\u7528\uff0c\u5c31\u8981\u50cf\u4e0a\u9762\u8bf4\u7684\u90a3\u6837\uff0c\u5148\u9884\u6d4b\u7b2c\u4e00\u4e2a\u5206\u652f\uff0c\u62ff\u7b2c\u4e00\u4e2a\u5206\u652f\u9884\u6d4b\u7684\u7ed3\u679c\uff0c\u518d\u53bb\u9884\u6d4b\u7b2c\u4e8c\u4e2a\u5206\u652f\uff0c\u8fd9\u4ef6\u4e8b\u60c5\u8981\u5728\u4e00\u4e2a\u5468\u671f\u5185\u5b8c\u6210\uff0c\u8fd9\u4e2a\u6311\u6218\u662f\u5f88\u5927\u7684\u3002\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\uff1a</p>\n<p>\u5047\u5982\u73b0\u5728\u6709\u56db\u4e2a\u57fa\u672c\u5757 A\u3001B\u3001C \u548c D\uff0c\u5e76\u4e14\u6309\u7167\u8fd9\u4e2a\u987a\u5e8f\u6267\u884c\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0cA \u6700\u540e\u7684\u6307\u4ee4\u662f\u4e00\u4e2a\u5206\u652f\uff0c\u8df3\u8f6c\u5230 B\uff0c\u540c\u7406 B \u8df3\u8f6c\u5230 C\uff0cC \u8df3\u8f6c\u5230 D\u3002\u7ecf\u5178\u7684\u5206\u652f\u9884\u6d4b\u7b97\u6cd5\uff0c\u7528 A \u53bb\u9884\u6d4b B\uff0c\u7528 B \u53bb\u9884\u6d4b C\uff0c\u7528 C \u53bb\u9884\u6d4b D\uff0c\u8fd9\u6837\u6bcf\u4e2a\u5468\u671f\u9884\u6d4b\u4e00\u4e2a taken \u5206\u652f\u3002\u90a3\u4e48\u5982\u679c\u8981\u5b9e\u73b0 2-taken \u9884\u6d4b\u7b97\u6cd5\uff0c\u5047\u5982\u5df2\u77e5\u4e86 A\uff0c\u90a3\u5c31\u8981\u9884\u6d4b B \u548c C\uff0c\u4f46\u662f\u5c31\u5fc5\u987b\u5148\u62ff A \u9884\u6d4b B\uff0c\u518d\u62ff B \u9884\u6d4b C\uff0c\u8fd9\u6837\u5c31\u4e32\u884c\u4e86\uff0c\u65f6\u5e8f\u5f88\u96be\u4fdd\u8bc1\u3002\u5f53\u7136\u4e5f\u53ef\u4ee5\u540c\u65f6\u641e\u4e24\u5957\u9884\u6d4b\uff0c\u4e00\u5957\u7528 A \u9884\u6d4b B\uff0c\u4e00\u5957\u7528 A \u9884\u6d4b C\uff0c\u4f46\u662f\u8fd9\u6837\u6bcf\u4e2a\u5206\u652f\u8981\u8bb0\u5f55\u7684\u4fe1\u606f\u5c31\u7ffb\u500d\u4e86\u3002</p>\n<p>\u5728\u8bba\u6587 Multiple-Block Ahead Branch Predictors \u4e2d\u53ef\u4ee5\u770b\u5230\u4e00\u79cd\u66f4\u901a\u7528\u505a\u6cd5\uff0c\u79f0\u4e3a 2-ahead\uff1a\u5df2\u77e5 A \u548c B\uff0c\u7528 A \u53bb\u9884\u6d4b C\uff0c\u7528 B \u53bb\u9884\u6d4b D\u3002\u6b64\u65f6\u5206\u652f\u9884\u6d4b\u7684\u5c31\u662f\u95f4\u9694\u4e00\u6b21\u4ee5\u540e\u7684\u76ee\u7684\u5730\u5740\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u7684\u76ee\u7684\u5730\u5740\uff0c\u8fd9\u6837\u7684\u8bbe\u8ba1\u4e0b\uff0cBTB \u7b49\u7ed3\u6784\u9700\u8981\u53d8\u6210\u53cc\u7aef\u53e3\uff0c\u8fd9\u6837\u624d\u80fd\u540c\u65f6\u9884\u6d4b\u4e24\u4e2a\u5206\u652f\uff1aA \u548c B\u3002\u9884\u6d4b\u51fa C \u548c D \u4ee5\u540e\uff0c\u518d\u7528\u540c\u6837\u7684\u529e\u6cd5\u53bb\u9884\u6d4b E \u548c F\uff0c\u8fd9\u6837\u6301\u7eed\u4e0b\u53bb\u3002\u5f53\u7136\u8bba\u6587\u8bbe\u8ba1\u7684\u6bd4\u8fd9\u91cc\u8bb2\u7684\u66f4\u590d\u6742\u4e00\u70b9\uff0c\u5177\u4f53\u7ec6\u8282\u89c1\u8bba\u6587\u3002</p>\n<p>\u6211\u4eec\u4e0d\u77e5\u9053 ARM \u5177\u4f53\u5982\u4f55\u5b9e\u73b0\u7684 2-taken\uff0c\u4f46\u662f\u53ef\u4ee5\u731c\u60f3\u5b83\u505a\u4e86\u4e00\u4e9b\u9650\u5236\uff0c\u4f8b\u5982\u867d\u7136\u4e24\u4e2a\u5206\u652f\u90fd\u662f taken\uff0c\u4f46\u662f\u53ef\u80fd\u5bf9\u504f\u79fb\u3001\u5730\u5740\u6709\u4e00\u4e9b\u9650\u5236\uff0c\u4f8b\u5982\u8981\u6c42\u5728\u540c\u4e00\u4e2a cacheline \u5185\u3002Intel \u7684 Golden Cove \u67b6\u6784\uff0cAMD \u7684 Zen 4 \u67b6\u6784\u4e5f\u5b9e\u73b0\u4e86 2-taken\uff0c\u90fd\u6709\u6216\u591a\u6216\u5c11\u7c7b\u4f3c\u7684\u9650\u5236\u3002<a href=\"https://chipsandcheese.com/2023/10/08/zen-5s-leaked-slides/\">Chips and Cheese</a> \u662f\u8fd9\u4e48\u63cf\u8ff0 Intel \u548c ARM \u7684 2-taken \u652f\u6301\u7684\uff1a</p>\n<blockquote>\n<p>Rocket Lake could unroll small loops within its loop buffer, turning taken\nbranches into not-taken ones from the fetch perspective. Arm\u2019s Neoverse N2 and\nCortex X2 can also sustain two taken branches per cycle by using a 64 entry\nnano-BTB.</p>\n</blockquote>\n<p>\u5728 AMD \u9488\u5bf9 Zen 2 \u7684 Software Optimization Guide for AMD Family 17h Models 30h and Greater Processors \u4e2d\u4e5f\u660e\u786e\u6307\u51fa\uff0cBTB \u6bcf\u4e2a\u6761\u76ee\u6700\u591a\u53ef\u4ee5\u8bb0\u5f55\u540c\u4e00\u4e2a cache line \u91cc\u7684\u4e24\u4e2a\u5206\u652f\uff0c\u4f46\u662f\u8981\u6c42\u7b2c\u4e00\u4e2a\u5206\u652f\u662f\u6761\u4ef6\u5206\u652f\uff0c\u8fd9\u4e3a 2-taken \u5206\u652f\u9884\u6d4b\u63d0\u4f9b\u4e86\u5fc5\u8981\u7684\u4fe1\u606f\uff0c\u4f46\u4e5f\u6709\u9650\u5236\uff1a</p>\n<blockquote>\n<p>The branch target buffer (BTB) is a three-level structure accessed using the\nfetch address of the current fetch block. Each BTB entry includes information\nfor branches and their targets. Each BTB entry can hold up to two branches if\nthe branches reside in the same 64-byte aligned cache line and the first branch\nis a conditional branch.</p>\n</blockquote>\n<p>\u56e0\u6b64\uff0c\u53ef\u4ee5\u7528 2-taken \u8868\u793a\u9650\u5236\u6bd4\u8f83\u591a\u7684\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u9884\u6d4b 2 \u4e2a taken \u7684\u7b97\u6cd5\uff0c\u800c\u7528 2-ahead \u8868\u793a\u66f4\u52a0\u901a\u7528\u7684\u9884\u6d4b 2 \u4e2a taken \u7684\u7b97\u6cd5\u3002\u5373\u4f7f\u505a\u4e86 2-taken \u7684\u9884\u6d4b\u5668\u652f\u6301\uff0c\u4e5f\u672a\u5fc5\u53ef\u4ee5\u6bcf\u5468\u671f\u6267\u884c 2 \u4e2a taken \u5206\u652f\uff0c\u4f8b\u5982 AMD \u5728\u8bba\u6587 <a href=\"https://ieeexplore.ieee.org/document/10466769\">AMD Next-Generation \u201cZen 4\u201d Core and 4th Gen AMD EPYC Server CPUs</a> \u662f\u8fd9\u4e48\u8868\u8ff0 Zen 4 \u7684 2-taken \u5b9e\u73b0\u7684\uff1a</p>\n<blockquote>\n<p>To better feed the wide execution engine, AMD has implemented several front-end\nbandwidth improvements on \u201cZen 4.\u201d One is the ability to predict and dispatch up\nto two taken branches per cycle. While the Instruction Cache (I-Cache) or\nOperation Cache (Op Cache) fetch limits the sustained fetch bandwidth to one\ntaken branch per cycle, predicting two taken branches per cycle allows the\nbranch predictor to run ahead more often and compensate for existing branch\nprediction stall cycles. Dispatching up to two taken branches per cycle, and\noptimizations of the integer scheduler assignment allow \u201cZen 4\u201d to fill the\nout-of-order part of the machine faster once a dispatch (allocation) stall has\nbeen resolved.</p>\n</blockquote>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u867d\u7136\u505a\u4e86 2-taken/2-ahead\uff0c\u53ea\u662f\u5206\u652f\u9884\u6d4b\u7684\u5e26\u5bbd\u589e\u52a0\u4e86\uff0c\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u9884\u6d4b\u66f4\u591a\u7684\u5206\u652f\uff0c\u4f46\u8fd9\u8fd8\u4e0d\u591f\u3002\u524d\u9762\u4e5f\u63d0\u5230\u4e86\uff0c\u5206\u652f\u9884\u6d4b\u5668\u662f\u751f\u4ea7\u8005\uff0c\u6307\u4ee4\u7f13\u5b58\u662f\u6d88\u8d39\u8005\uff0c\u751f\u4ea7\u8005\u7684\u6027\u80fd\u63d0\u5347\u4e86\uff0c\u90a3\u4e48\u6d88\u8d39\u8005\u7684\u6027\u80fd\u4e5f\u8981\u76f8\u5e94\u63d0\u5347\u624d\u662f\u3002\u4f46\u662f\u6307\u4ee4\u7f13\u5b58\u662f\u4e00\u7247\u5f88\u5927\u7684 SRAM\uff0c\u529f\u8017\u548c\u65f6\u5e8f\u90fd\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6240\u4ee5\u6539\u8d77\u6765\u6bd4\u8f83\u56f0\u96be\u3002\u5982\u679c\u5355\u7eaf\u589e\u52a0\u6307\u4ee4\u7f13\u5b58\u4e00\u6b21\u53d6\u6307\u7684\u5bbd\u5ea6\uff0c\u4f8b\u5982 8 \u5b57\u8282\u63d0\u5347\u5230 16 \u5b57\u8282\uff0c\u5bf9\u4e8e\u5206\u652f\u5bc6\u5ea6\u4f4e\u7684\u60c5\u51b5\u6bd4\u8f83\u6709\u6548\uff0c\u4f46\u5982\u679c\u5206\u652f\u5f88\u591a\uff0c\u90a3\u4e48\u8fd9\u6837\u6548\u679c\u4e5f\u4e0d\u4f1a\u5f88\u597d\uff0c\u8981\u63d0\u5347\u6027\u80fd\uff0c\u5c31\u8981\u8003\u8651\u53cc\u7aef\u53e3\uff0c\u6bcf\u4e2a\u5468\u671f\u4ece\u4e24\u4e2a\u4e0d\u540c\u7684\u5730\u5740\u53d6\u6307\u3002\u8fd9\u5c31\u662f Zen 5 \u505a\u7684\u4e8b\u60c5\u3002</p>\n<h2 id=\"2-fetch\">2-fetch<a class=\"headerlink\" href=\"#2-fetch\" title=\"Permanent link\">&para;</a></h2>\n<p>Zen 5 \u9664\u4e86 2-taken \u4ee5\u5916\uff0c\u8fd8\u5b9e\u73b0\u4e86 2-fetch\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u9884\u6d4b\u672a\u6765\u7684\u4e24\u4e2a\u5206\u652f\uff0c\u5e76\u4ece\u4e24\u4e2a\u5730\u5740\u53d6\u6307\u4ee4\uff0c\u5206\u522b\u8bd1\u7801\uff0c\u7136\u540e\u518d\u62fc\u8d77\u6765\u3002\u6b64\u5916\uff0cZen 5 \u7684\u53cc\u53d6\u6307\u8fd8\u53ef\u4ee5\u670d\u52a1\u4e8e\u8d85\u7ebf\u7a0b\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u7528\u4e00\u4e2a\u53d6\u6307\u6d41\u6c34\u7ebf\u3002\u5f53\u8d85\u7ebf\u7a0b\u7a7a\u95f2\u7684\u65f6\u5019\uff0c\u4e24\u4e2a\u53d6\u503c\u6d41\u6c34\u7ebf\u53ef\u4ee5\u670d\u52a1\u4e8e\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u63d0\u4f9b\u66f4\u9ad8\u7684\u6027\u80fd\u3002</p>\n<p>\u76ee\u524d Zen 5 \u7684\u5b9e\u73b0\u7ec6\u8282\u8fd8\u4e0d\u6e05\u6670\uff0c\u671f\u5f85\u672a\u6765\u66f4\u591a\u7684\u5fae\u67b6\u6784\u89e3\u6790\u3002</p>\n<h2 id=\"\u53c2\u8003\u6587\u732e\">\u53c2\u8003\u6587\u732e<a class=\"headerlink\" href=\"#\u53c2\u8003\u6587\u732e\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://chipsandcheese.com/2024/07/26/zen-5s-2-ahead-branch-predictor-unit-how-30-year-old-idea-allows-for-new-tricks/\">Zen 5\u2019s 2-Ahead Branch Predictor Unit: How a 30 Year Old Idea Allows for New Tricks</a></li>\n<li><a href=\"https://www.anandtech.com/show/15813/arm-cortex-a78-cortex-x1-cpu-ip-diverging/2\">Arm's New Cortex-A78 and Cortex-X1 Microarchitectures: An Efficiency and Performance Divergence - Anandtech</a></li>\n<li><a href=\"https://www.techpowerup.com/review/amd-zen-5-technical-deep-dive/3.html\">AMD Zen 5 Technical Deep Dive</a></li>\n<li><a href=\"https://hothardware.com/reviews/amd-ryzen-ai-zen-5-architecture-overview\">AMD Zen 5 Architecture Reveal: A Ryzen 9000 And Ryzen AI 300 Deep Dive</a></li>\n<li><a href=\"https://www.tomshardware.com/pc-components/cpus/amd-deep-dives-zen-5-ryzen-9000-and-strix-point-cpu-rdna-35-gpu-and-xdna-2-architectures/4\">AMD deep-dives Zen 5 architecture \u2014 Ryzen 9000 and AI 300 benchmarks, RDNA 3.5 GPU, XDNA 2, and more</a></li>\n<li><a href=\"https://cseweb.ucsd.edu/~calder/papers/UCSD-CS00-645.pdf\">Optimizations Enabled by a Decoupled Front-End Architecture</a></li>\n<li><a href=\"https://www.anandtech.com/show/14384/arm-announces-cortexa77-cpu-ip/3\">The Cortex-A77 \u00b5arch: Added ALUs &amp; Better Load/Stores</a></li>\n<li><a href=\"https://dl.acm.org/doi/pdf/10.1145/237090.237169\">Multiple-Block Ahead Branch Predictors</a></li>\n<li><a href=\"https://chipsandcheese.com/2021/12/02/popping-the-hood-on-golden-cove/\">Popping the Hood on Golden Cove</a></li>\n<li><a href=\"https://www.anandtech.com/show/17585/amd-zen-4-ryzen-9-7950x-and-ryzen-5-7600x-review-retaking-the-high-end/8\">AMD Zen 4 Ryzen 9 7950X and Ryzen 5 7600X Review: Retaking The High-End</a></li>\n<li><a href=\"https://ieeexplore.ieee.org/document/10466769\">AMD Next-Generation \u201cZen 4\u201d Core and 4th Gen AMD EPYC Server CPUs</a></li>\n</ul>", "image": null, "date_published": "2024-08-02T00:00:00+00:00", "authors": [], "tags": ["arm", "branch", "cortex", "cpu", "hardware", "ooo", "prediction", "predictor"]}, {"id": "https://jia.je/hardware/2024/07/30/debian-linux-on-surface-laptop-7/", "url": "https://jia.je/hardware/2024/07/30/debian-linux-on-surface-laptop-7/", "title": "\u5728 Surface Laptop 7 \u4e0a\u8fd0\u884c Debian Linux", "content_html": "<h1 id=\"\u5728-surface-laptop-7-\u4e0a\u8fd0\u884c-debian-linux\">\u5728 Surface Laptop 7 \u4e0a\u8fd0\u884c Debian Linux<a class=\"headerlink\" href=\"#\u5728-surface-laptop-7-\u4e0a\u8fd0\u884c-debian-linux\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u501f\u5230\u4e00\u53f0 Surface Laptop 7 \u53ef\u4ee5\u62ff\u6765\u6298\u817e\uff0c\u5b83\u7528\u7684\u662f\u9ad8\u901a Snapdragon X Elite \u5904\u7406\u5668\uff0c\u8dd1\u7684\u662f Windows on Arm \u7cfb\u7edf\u3002\u4f46\u4f5c\u4e3a Linux \u7528\u6237\uff0c\u80af\u5b9a\u4e0d\u6ee1\u8db3\u4e8e WSL\uff0c\u800c\u8981\u88f8\u673a\u4e0a\u5b89\u88c5 Linux\u3002\u7531\u4e8e\u8fd9\u4e2a\u673a\u5668\u592a\u65b0\uff0c\u6240\u4ee5\u5b89\u88c5\u7684\u8fc7\u7a0b\u9047\u5230\u4e86\u5f88\u591a\u574e\u5777\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u4e0a\u6e38\u8fdb\u5c55\">\u4e0a\u6e38\u8fdb\u5c55<a class=\"headerlink\" href=\"#\u4e0a\u6e38\u8fdb\u5c55\" title=\"Permanent link\">&para;</a></h2>\n<p>\u76ee\u524d X Elite \u5904\u7406\u5668\u7684\u4e0a\u6e38\u652f\u6301\u5df2\u7ecf\u9010\u6b65\u5b8c\u5584\uff0c\u4f46\u662f\u8fd8\u662f\u9700\u8981\u5f88\u65b0\u7684\u5185\u6838\uff0c\u4e5f\u5c31\u662f\u6700\u8fd1\u624d\u5408\u5e76\u4e86 X Elite \u7684\u4e24\u4e2a\u7b14\u8bb0\u672c\u7684 device tree \u652f\u6301\u8fdb\u5185\u6838\u3002\u6211\u7528\u7684\u662f v6.11-rc1-43-g94ede2a3e913 \u7248\u672c\u7684\u5185\u6838\uff0c\u76ee\u524d\u53ef\u4ee5\u6b63\u5e38\u663e\u793a\uff0cWi-Fi \u6b63\u5e38\uff0cUSB Type-C \u53e3\u6b63\u5e38\u5de5\u4f5c\uff08\u952e\u76d8\uff0c\u9f20\u6807\uff0c\u6709\u7ebf\u7f51\u90fd\u53ef\u4ee5\u901a\u8fc7 USB \u63a5\u5230\u7535\u8111\u4e0a\uff09\uff0c\u5185\u7f6e\u7684\u952e\u76d8\u3001\u89e6\u6478\u677f\u548c\u89e6\u6478\u5c4f\u4e0d\u5de5\u4f5c\u3002\u5e0c\u671b\u540e\u7eed\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u786c\u4ef6\u652f\u6301\u3002</p>\n<h2 id=\"\u6298\u817e\u8fc7\u7a0b\">\u6298\u817e\u8fc7\u7a0b<a class=\"headerlink\" href=\"#\u6298\u817e\u8fc7\u7a0b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9ad8\u901a\u548c Linaro \u5728\u53bb\u5e74\u7684\u65f6\u5019\u63a8\u51fa\u4e86\u4e00\u4e2a\u5b9e\u9a8c\u6027\u7684 Debian Installer Image\uff1ahttps://git.codelinaro.org/linaro/qcomlt/demos/debian-12-installer-image\uff0c\u5b83\u9488\u5bf9\u7684\u8bbe\u5907\u662f\u9ad8\u901a\u81ea\u5df1\u7684 CRD \u8bbe\u5907\uff0c\u548c Surface Laptop 7 \u4e0d\u540c\u3002\u81ea\u7136\uff0c\u628a\u8fd9\u4e2a image \u5199\u5230 U \u76d8\u91cc\u5e76\u542f\u52a8\u662f\u4e0d\u884c\u7684\u3002</p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cSurface Laptop 7 \u9ed8\u8ba4\u5b89\u88c5\u4e86 Windows\uff0c\u5e76\u4e14\u5f00\u542f\u4e86\u5b89\u5168\u542f\u52a8\uff0c\u800c\u6211\u4eec\u81ea\u5df1\u7f16\u8bd1\u7684 Linux \u5185\u6838\u81ea\u7136\u662f\u8fc7\u4e0d\u4e86\u5b89\u5168\u542f\u52a8\u7684\uff0c\u6240\u4ee5\u8981\u53bb\u56fa\u4ef6\u5173\u95ed\u5b89\u5168\u542f\u52a8\u3002\u7531\u4e8e Windows \u7684 Bitlocker \u9ed8\u8ba4\u662f\u6253\u5f00\u7684\uff0c\u8bf7\u5148\u4fdd\u8bc1\u4f60\u53ef\u4ee5\u83b7\u53d6 Bitlocker recovery key\uff0c\u4e0d\u7136\u4e4b\u540e\u53ef\u80fd\u8fdb\u4e0d\u53bb Windows \u7cfb\u7edf\u4e86\u3002\u5b89\u88c5\u53cc\u7cfb\u7edf\u524d\uff0c\u8bb0\u5f97\u5728 Windows \u91cc\u51c6\u5907\u597d\u5206\u533a\u8868\uff0c\u7a7a\u95f4\u4e0d\u591f\u7684\u8bdd\uff0c\u53ef\u4ee5\u5728\u7ebf\u7f29\u5c0f NTFS\u3002</p>\n<p>\u8fdb\u5165\u56fa\u4ef6\u7684\u65b9\u6cd5\uff1a\u6309\u4f4f\u97f3\u91cf\u4e0a\u952e\u5f00\u673a\u3002\u5f00\u673a\u540e\uff0c\u53ef\u4ee5\u770b\u5230 Surface UEFI \u7684\u754c\u9762\uff0c\u53ef\u4ee5\u8c03\u542f\u52a8\u987a\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u5173\u95ed\u5b89\u5168\u542f\u52a8\u3002\u4e3a\u4e86\u5b89\u88c5\u65b9\u4fbf\uff0c\u5efa\u8bae\u628a USB Storage \u653e\u5230\u7b2c\u4e00\u4e2a\u3002</p>\n<p>\u63a5\u7740\u5c31\u5f00\u59cb\u542f\u52a8 U \u76d8\u91cc\u7684 Debian Installer Image \u4e86\u3002\u542f\u52a8\u4ee5\u540e\uff0c\u53ef\u4ee5\u770b\u5230\u8fdb\u5165\u4e86 grub shell\uff0c\u76ee\u6d4b\u662f grub \u627e\u4e0d\u5230\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u5728 (hd1,msdos1)/boot/grub \u4e0b\u9762\u627e\u5230\u3002\u4f46\u662f\u8fd9\u4e2a image \u7684 device tree \u548c kernel \u90fd\u6bd4\u8f83\u8001\uff0c\u76f4\u63a5\u542f\u52a8\u4f1a\u53d1\u73b0\uff0cDebian Install \u8fdb\u53bb\u4e86\uff0c\u4f46\u662f\u5185\u7f6e\u952e\u76d8\u548c\u5916\u7f6e USB \u952e\u76d8\u90fd\u4e0d\u5de5\u4f5c\uff0c\u4e8e\u662f\u6ca1\u6cd5\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u5b89\u88c5\u3002</p>\n<p>\u8fd9\u65f6\u5019\uff0c\u5728\u7f51\u4e0a\u641c\u7d22\u4e86\u4e00\u4e0b\u5df2\u6709\u7684\u5728 X Elite \u4e0a\u8fd0\u884c Linux \u7684\u5c1d\u8bd5\uff0c\u53d1\u73b0\u6709\u4eba\u5728 ASUS \u7684 X Elite \u7b14\u8bb0\u672c\u4e0a\u88c5\u597d\u4e86\uff08<a href=\"https://matrix.org/_matrix/media/v3/download/matrix.org/hrxnkHBVEacnUGKSnHPMUHRX/1000004724.jpg\">\u6765\u6e90</a>\uff09\uff0c\u6211\u5c31\u8bd5\u7740\u7528 ASUS \u5bf9\u5e94\u578b\u53f7\u7b14\u8bb0\u672c\u7684 device tree \u53bb\u542f\u52a8\uff0c\u4f9d\u7136\u4e0d\u884c\uff0c\u7ecf\u8fc7\u4e86\u89e3\u540e\uff08\u611f\u8c22 @imbushuo\uff09\uff0c\u5f97\u77e5 Surface \u7684\u5185\u7f6e\u952e\u76d8\u7b49\u5916\u8bbe\u9700\u8981\u901a\u8fc7 SAM \u8bbf\u95ee\uff0c\u9700\u8981\u989d\u5916\u7684\u914d\u7f6e\uff0c\u76ee\u524d\u4e0d\u786e\u5b9a\u80fd\u5426\u901a\u8fc7 device tree \u542f\u7528\u3002</p>\n<p>\u4f46\u5f88\u5feb\u4e5f\u53d1\u73b0\u6709\u4eba\u5728 Surface Laptop 7 \u4e0a\u8dd1\u8d77\u6765\u4e86\uff08<a href=\"https://x.com/merckhung/status/1804972131182354604\">\u6765\u6e90</a>\uff09\uff0c\u6211\u53d1\u90ae\u4ef6\u95ee\u4e86\u8fd9\u4e2a\u4f5c\u8005\uff0c\u4f5c\u8005\u8bf4\u4ed6\u7528\u7684\u662f\u5916\u7f6e\u7684\u952e\u76d8\uff0c\u5185\u7f6e\u7684\u952e\u76d8\u4e5f\u4e0d\u5de5\u4f5c\u3002\u653e\u5927\u89c2\u5bdf\u4f5c\u8005\u5f55\u7684\u89c6\u9891\uff0c\u53d1\u73b0\u7528\u7684\u662f\u6700\u65b0\u7684 master \u5206\u652f\u7684 Linux \u5185\u6838\uff0c\u5e76\u4e14\u7528\u7684\u5c31\u662f CRD \u7684 device tree\u3002\u5230\u8fd9\u91cc\u5c31\u6bd4\u8f83\u6709\u601d\u8def\u4e86\uff1a\u81ea\u5df1\u7f16\u8bd1\u4e00\u4e2a\u5185\u6838\uff0c\u7136\u540e\u7528 x1e80100-crd.dtb \u4f5c\u4e3a device tree\u3002</p>\n<p>\u4e8e\u662f\u9b54\u6539\u4e86 Debian Installer Image\uff1a\u66ff\u6362\u6389 linux \u5185\u6838\uff0c\u6362\u6210\u81ea\u5df1\u7f16\u8bd1\u7684\u6700\u65b0\u7248\uff0c\u89e3\u5f00 initrd\uff0c\u628a\u91cc\u9762\u7684 kernel modules \u4e5f\u6362\u6210\u65b0\u5185\u6838\u7684\u7248\u672c\uff0c\u518d\u628a\u65b0\u7684 x1e80100-crd.dtb \u590d\u5236\u4e0a\u53bb\uff0c\u518d\u7528 grub \u542f\u52a8\u65b0\u5185\u6838 + \u65b0 initrd + \u65b0 Device Tree\uff0c\u53d1\u73b0 USB \u5916\u63a5\u952e\u76d8\u5de5\u4f5c\u4e86\uff01\u867d\u7136\u53ea\u6709 Type-C \u5de5\u4f5c\uff0c\u4f46\u662f\u4e5f\u8db3\u591f\u5b8c\u6210\u5269\u4e0b\u7684\u5de5\u4f5c\u4e86\u3002</p>\n<p>\u4e0d\u8fc7\u5728\u5b89\u88c5 Debian \u7684\u65f6\u5019\uff0c\u8fd8\u9047\u5230\u4e86\u5c0f\u63d2\u66f2\uff1aglibc \u7248\u672c\u4e0d\u591f\u65b0\uff0c\u4f30\u8ba1\u662f Linaro \u7684 Image \u592a\u8001\u4e86\u3002\u4e8e\u662f\u6211\u4ece\u65b0\u7684 debian arm64 \u91cc\u590d\u5236\u4e86 libc.so.6 \u548c ld-linux-aarch64.so.1\uff0c\u8986\u76d6\u6389 initrd \u91cc\u7684\u65e7\u7248\u672c\uff0c\u8fd9\u6837\u5c31\u597d\u4e86\u3002</p>\n<p>\u5b89\u88c5\u5b8c\u4ee5\u540e\uff0c\u5b89\u88c5\u7684\u7cfb\u7edf\u91cc\u7684\u5185\u6838\u662f debian \u7684\u6700\u65b0\u5185\u6838\uff0c\u4f46\u662f\u4e0d\u591f\u65b0\uff0c\u4e8e\u662f\u53c8\u8001\u4f20\u7edf\uff1a\u624b\u52a8 arch-chroot \u8fdb\u65b0\u7684 sysroot\uff0c\u5b89\u88c5\u65b0\u7684\u5185\u6838\u3002\u4e5f\u53ef\u4ee5\u50cf Linaro \u4ed3\u5e93\u91cc\u6307\u51fa\u7684\u90a3\u6837\uff0c\u76f4\u63a5\u66ff\u6362 Debian Installer Image \u91cc\u7684 deb\uff0c\u4f46\u662f\u6211\u53d1\u73b0\u6211\u6253\u7684 deb \u592a\u5927\u4e86\uff08\u6bd5\u7adf defconfig\uff09\uff0c\u653e\u4e0d\u8fdb\u6587\u4ef6\u7cfb\u7edf\uff0c\u53ea\u597d\u6700\u540e\u81ea\u5df1\u624b\u52a8\u88c5\u3002</p>\n<p>\u6700\u540e\u5728 grub \u914d\u7f6e\u91cc\u6dfb\u52a0 devicetree \u52a0\u8f7d\u547d\u4ee4\uff0c\u518d\u4ece Debian Installer Image \u7684 grub \u914d\u7f6e\u5077 linux cmdline\uff0c\u6700\u7ec8\u662f grub \u914d\u7f6e\u662f\u8fd9\u4e2a\u6837\u5b50\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>devicetree<span class=\"w\"> </span>/boot/x1e80100-crd.dtb\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"nb\">echo</span><span class=\"w\">    </span><span class=\"s1\">&#39;Loading Linux 6.11.0-rc1-00043-g94ede2a3e913 ...&#39;</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>linux<span class=\"w\">   </span>/boot/vmlinuz-6.11.0-rc1-00043-g94ede2a3e913<span class=\"w\"> </span><span class=\"nv\">root</span><span class=\"o\">=</span><span class=\"nv\">UUID</span><span class=\"o\">=</span>aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee<span class=\"w\"> </span>ro<span class=\"w\"> </span><span class=\"nv\">efi</span><span class=\"o\">=</span>novamap<span class=\"w\"> </span>pd_ignore_unused<span class=\"w\"> </span>clk_ignore_unused<span class=\"w\"> </span><span class=\"nv\">fw_devlink</span><span class=\"o\">=</span>off<span class=\"w\"> </span><span class=\"nv\">cma</span><span class=\"o\">=</span>128M<span class=\"w\"> </span>quiet\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"nb\">echo</span><span class=\"w\">    </span><span class=\"s1\">&#39;Loading initial ramdisk ...&#39;</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>initrd<span class=\"w\">  </span>/boot/initrd.img-6.11.0-rc1-00043-g94ede2a3e913\n</span></code></pre></div>\n<p>\u8fd9\u6837\u641e\u5b8c\uff0cDebian \u7cfb\u7edf\u5c31\u6b63\u5e38\u8d77\u6765\u4e86\uff01</p>\n<p>\u672c\u6587\u4e5f\u53d1\u5230\u4e86 Reddit \u4e0a\uff1ahttps://www.reddit.com/r/SurfaceLinux/comments/1efmyb3/managed_to_install_baremetal_linux_on_snapdragon/</p>\n<p>UPDATE:</p>\n<ol>\n<li>(2024-07-31 \u66f4\u65b0) \u4e0d\u77e5\u9053\u4e3a\u5565\uff0c\u65e0\u7ebf\u7f51\u5361\u5ffd\u7136\u88ab rfkill \u4e86\uff0c\u6ca1\u6709\u627e\u5230\u539f\u56e0\uff0cWindows \u91cc\u53ef\u4ee5\u7ee7\u7eed\u6b63\u5e38\u4f7f\u7528</li>\n<li>(2024-07-31 \u66f4\u65b0) CPUFreq \u9a71\u52a8\u5df2\u7ecf\u6709 patch\uff1a<a href=\"https://patchew.org/linux/20240612124056.39230-1-quic._5Fsibis@quicinc.com/\">[PATCH V6 0/5] qcom: x1e80100: Enable CPUFreq</a>\uff0c\u6253\u4e0a\u5373\u53ef\u81ea\u52a8\u8c03\u9891</li>\n<li>(2024-07-31 \u66f4\u65b0) \u5185\u7f6e\u7684\u952e\u76d8\u7684\u95ee\u9898\u4fee\u597d\u4e86\uff0c\u9700\u8981\u989d\u5916\u7684\u8865\u4e01\uff0c\u89c1 https://github.com/jiegec/linux/tree/surface-laptop-7\u3002</li>\n<li>(2024-09-05 \u66f4\u65b0) \u4e0a\u6e38\u5408\u5e76\u4e86 Surface Laptop 7 (Romulus 13/15) \u7684 Device Tree (<code>arch/arm64/boot/dts/qcom/x1e80100-microsoft-romulus13.dts</code>)\uff0c\u5185\u7f6e\u7684\u952e\u76d8\u4e5f\u76f4\u63a5\u652f\u6301\u4e86\uff0c\u76f4\u63a5\u7528\u4e0a\u6e38\u7684 Device Tree \u5373\u53ef\u542f\u52a8\uff0c\u89c1 https://github.com/jiegec/linux/tree/surface-laptop-7-next\uff0c\u4f30\u8ba1 6.12 \u5c31\u6709\u6b63\u5f0f\u652f\u6301\u4e86</li>\n<li>(2024-09-05 \u66f4\u65b0) \u66f4\u65b0 Mesa \u5230 24.2.1\uff0c\u663e\u5361\u52a0\u901f\u4e5f\u5de5\u4f5c\u4e86</li>\n</ol>", "image": null, "date_published": "2024-07-30T00:00:00+00:00", "authors": [], "tags": ["aarch64", "debian", "hardware", "linux", "qcom", "qualcomm", "surface", "xelite"]}, {"id": "https://jia.je/software/2024/04/07/write-a-linker-4/", "url": "https://jia.je/software/2024/04/07/write-a-linker-4/", "title": "\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff084\uff09", "content_html": "<h1 id=\"\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56684\">\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff084\uff09<a class=\"headerlink\" href=\"#\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56684\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u524d\u8a00\">\u524d\u8a00<a class=\"headerlink\" href=\"#\u524d\u8a00\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u4e2a\u7cfb\u5217\u7684\u524d\u4e09\u7bc7\u535a\u5ba2\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u9759\u6001\u94fe\u63a5\u5668\uff0c\u5b83\u53ef\u4ee5\u8f93\u5165\u82e5\u5e72\u4e2a ELF .o \u6587\u4ef6\uff0c\u8f93\u51fa ELF \u53ef\u6267\u884c\u6587\u4ef6\u6216\u8005\u52a8\u6001\u5e93\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u8981\u8fdb\u4e00\u6b65\u652f\u6301\u52a8\u6001\u5e93\uff0c\u4e0d\u4ec5\u53ef\u4ee5\u751f\u6210\u52a8\u6001\u5e93\uff0c\u8fd8\u652f\u6301\u8ba9\u52a8\u6001\u5e93\u53c2\u4e0e\u5230\u9759\u6001\u94fe\u63a5\u5f53\u4e2d\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u56de\u987e\">\u56de\u987e<a class=\"headerlink\" href=\"#\u56de\u987e\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u56de\u987e\u4e00\u4e0b\uff1a\u5728\u8fd9\u4e2a\u7cfb\u5217\u7684\u524d\u4e09\u7bc7\u535a\u5ba2\u4e2d\uff0c\u6211\u4eec\u89c2\u5bdf\u4e86\u73b0\u6709\u94fe\u63a5\u5668\u7684\u5de5\u4f5c\u8fc7\u7a0b\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u94fe\u63a5\u5668\uff1a\u8f93\u5165\u82e5\u5e72\u4e2a ELF object\uff0c\u94fe\u63a5\u6210\u4e00\u4e2a\u53ef\u4ee5\u8fd0\u884c\u7684 ELF \u53ef\u6267\u884c\u6587\u4ef6\u6216\u8005 ELF \u52a8\u6001\u5e93\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u89e3\u6790\u8f93\u5165\u7684\u82e5\u5e72\u4e2a ELF\uff0c\u6536\u96c6\u5404\u4e2a section \u9700\u8981\u4fdd\u7559\u4e0b\u6765\u7684\u5185\u5bb9\uff0c\u5408\u5e76\u6765\u81ea\u4e0d\u540c ELF \u7684\u540c\u540d section</li>\n<li>\u89c4\u5212\u5c06\u8981\u751f\u6210\u7684 ELF \u53ef\u6267\u884c\u6587\u4ef6\u7684\u5185\u5bb9\u5e03\u5c40\uff1a\u5f00\u59cb\u662f\u56fa\u5b9a\u7684\u6587\u4ef6\u5934\uff0c\u4e4b\u540e\u662f\u5404\u4e2a section\uff0c\u8ba1\u7b97\u51fa\u5b83\u4eec\u4ece\u54ea\u91cc\u5f00\u59cb\u5230\u54ea\u91cc\u7ed3\u675f</li>\n<li>\u5982\u679c\u8981\u751f\u6210\u52a8\u6001\u5e93\uff0c\u8fd8\u9700\u8981\u9488\u5bf9\u52a8\u6001\u94fe\u63a5\u5668\uff0c\u6784\u9020\u4e00\u4e9b\u989d\u5916\u7684 section\uff08<code>.dynamic</code>\uff0c<code>.dynsym</code> \u548c <code>.dynstr</code>\uff09</li>\n<li>\u7b2c\u4e8c\u6b65\u5b8c\u6210\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u5728\u8fd0\u884c\u65f6\uff0c\u5404\u4e2a section \u5c06\u4f1a\u88ab\u52a0\u8f7d\u5230\u54ea\u4e2a\u5730\u5740\u4e0a\uff0c\u8fdb\u800c\u66f4\u65b0\u7b26\u53f7\u8868\uff0c\u5f97\u5230\u6bcf\u4e2a\u7b26\u53f7\u5728\u8fd0\u884c\u65f6\u4f1a\u5904\u5728\u54ea\u4e2a\u5730\u5740\u4e0a\uff1b\u6b64\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba1\u7b97\u91cd\u5b9a\u4f4d\uff0c\u628a\u5730\u5740\u6309\u7167\u9884\u8bbe\u7684\u89c4\u5219\u586b\u5165\u5230\u5bf9\u5e94\u7684\u5730\u65b9</li>\n<li>\u5982\u679c\u8981\u751f\u6210\u52a8\u6001\u5e93\uff0c\u56e0\u4e3a\u8fd0\u884c\u65f6\u52a8\u6001\u5e93\u7684\u52a0\u8f7d\u5730\u5740\u4e0d\u786e\u5b9a\uff0c\u6240\u4ee5\u5728 ELF \u4e2d\u628a\u52a0\u8f7d\u5730\u5740\u8bbe\u4e3a 0\uff0c\u5e76\u4e14\u8981\u6c42\u4ee3\u7801\u662f\u5730\u5740\u65e0\u5173\u4ee3\u7801\uff08PIC\uff0cPosition Independent Code\uff09</li>\n<li>\u6700\u540e\u6309\u7167\u9884\u8bbe\u7684\u6587\u4ef6\u5e03\u5c40\uff0c\u628a\u6587\u4ef6\u5185\u5bb9\u5199\u5165\u5230 ELF \u6587\u4ef6\u4e2d</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u8981\u652f\u6301\u94fe\u63a5\u52a8\u6001\u5e93\uff0c\u5728\u4e0a\u4e00\u7bc7\u535a\u5ba2\u4e2d\uff0c\u6700\u540e\u7684\u8fd9\u4e00\u6b65\u662f\u7528 GNU ld \u5b8c\u6210\u7684\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\"># assemble sources</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>main.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>main.o\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>printer.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>printer.o\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"c1\"># ld -shared: generate shared library</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"c1\"># we have implemented this in the previous blog post</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>-shared<span class=\"w\"> </span>printer.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libprinter.so\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"c1\"># ld -dynamic-linker: Set path to dynamic linker for the executable</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"c1\"># we are going to implement this one</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>-dynamic-linker<span class=\"w\"> </span>/lib64/ld-linux-x86-64.so.2<span class=\"w\"> </span>main.o<span class=\"w\"> </span>libprinter.so<span class=\"w\"> </span>-o<span class=\"w\"> </span>main\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a>$<span class=\"w\"> </span><span class=\"nv\">LD_LIBRARY_PATH</span><span class=\"o\">=</span><span class=\"nv\">$PWD</span><span class=\"w\"> </span>./main\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a>Hello<span class=\"w\"> </span>world!\n</span></code></pre></div>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u8981\u5b9e\u73b0\u7684\u5c31\u662f <code>ld -dynamic-linker /lib64/ld-linux-x86-64.so.2 main.o libprinter.so -o main</code> \u547d\u4ee4\u7684\u529f\u80fd\u3002</p>\n<h2 id=\"\u5206\u6790\">\u5206\u6790<a class=\"headerlink\" href=\"#\u5206\u6790\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\">\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6<a class=\"headerlink\" href=\"#\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u8981\u5206\u6790\u4e00\u4e0b ld \u5728\u5b9e\u73b0\u52a8\u6001\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u505a\u4e86\u4ec0\u4e48\u4e8b\u60c5\u3002\u89c2\u5bdf\u94fe\u63a5\u5f97\u5230\u7684\u53ef\u6267\u884c\u6587\u4ef6 <code>main</code>\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>-dynamic-linker<span class=\"w\"> </span>/lib64/ld-linux-x86-64.so.2<span class=\"w\"> </span>main.o<span class=\"w\"> </span>libprinter.so<span class=\"w\"> </span>-o<span class=\"w\"> </span>main\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>$<span class=\"w\"> </span>readelf<span class=\"w\"> </span>-a<span class=\"w\"> </span>main\n</span></code></pre></div>\n<p>\u9996\u5148\u662f ELF Header \u90e8\u5206\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>ELF<span class=\"w\"> </span>Header:\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"w\">  </span>Magic:<span class=\"w\">   </span>7f<span class=\"w\"> </span><span class=\"m\">45</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">46</span><span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"w\">  </span>Class:<span class=\"w\">                             </span>ELF64\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"w\">  </span>Data:<span class=\"w\">                              </span><span class=\"m\">2</span><span class=\"err\">&#39;</span>s<span class=\"w\"> </span>complement,<span class=\"w\"> </span>little<span class=\"w\"> </span>endian\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span>current<span class=\"o\">)</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"w\">  </span>OS/ABI:<span class=\"w\">                            </span>UNIX<span class=\"w\"> </span>-<span class=\"w\"> </span>System<span class=\"w\"> </span>V\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">  </span>ABI<span class=\"w\"> </span>Version:<span class=\"w\">                       </span><span class=\"m\">0</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"w\">  </span>Type:<span class=\"w\">                              </span>EXEC<span class=\"w\"> </span><span class=\"o\">(</span>Executable<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a><span class=\"w\">  </span>Machine:<span class=\"w\">                           </span>Advanced<span class=\"w\"> </span>Micro<span class=\"w\"> </span>Devices<span class=\"w\"> </span>X86-64\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span>0x1\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"w\">  </span>Entry<span class=\"w\"> </span>point<span class=\"w\"> </span>address:<span class=\"w\">               </span>0x401030\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">12696</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"w\">  </span>Flags:<span class=\"w\">                             </span>0x0\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>header:<span class=\"w\">               </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">56</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">8</span>\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">15</span>\n</span><span id=\"__span-2-20\"><a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\" href=\"#__codelineno-2-20\"></a><span class=\"w\">  </span>Section<span class=\"w\"> </span>header<span class=\"w\"> </span>string<span class=\"w\"> </span>table<span class=\"w\"> </span>index:<span class=\"w\"> </span><span class=\"m\">14</span>\n</span></code></pre></div>\n<p>\u548c\u4e4b\u524d\u770b\u5230\u7684\u53ef\u6267\u884c\u6587\u4ef6\u6ca1\u4ec0\u4e48\u4e0d\u540c\uff1aType \u662f EXEC \u8868\u793a\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u5165\u53e3\u5730\u5740\u6307\u5411\u4e86 <code>main</code> \u7684\u5730\u5740 <code>0x401030</code>\u3002</p>\n<p>\u63a5\u4e0b\u6765\u770b Section \u90e8\u5206\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a>Section<span class=\"w\"> </span>Headers:\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">  </span><span class=\"o\">[</span>Nr<span class=\"o\">]</span><span class=\"w\"> </span>Name<span class=\"w\">              </span>Type<span class=\"w\">             </span>Address<span class=\"w\">           </span>Offset\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">       </span>Size<span class=\"w\">              </span>EntSize<span class=\"w\">          </span>Flags<span class=\"w\">  </span>Link<span class=\"w\">  </span>Info<span class=\"w\">  </span>Align\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\">                   </span>NULL<span class=\"w\">             </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00000000</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span>.interp<span class=\"w\">           </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000400200</span><span class=\"w\">  </span><span class=\"m\">00000200</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">       </span>000000000000001c<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span>.hash<span class=\"w\">             </span>HASH<span class=\"w\">             </span><span class=\"m\">0000000000400220</span><span class=\"w\">  </span><span class=\"m\">00000220</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000018</span><span class=\"w\">  </span><span class=\"m\">0000000000000004</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">4</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span>.gnu.hash<span class=\"w\">         </span>GNU_HASH<span class=\"w\">         </span><span class=\"m\">0000000000400238</span><span class=\"w\">  </span><span class=\"m\">00000238</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">       </span>000000000000001c<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">4</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span>.dynsym<span class=\"w\">           </span>DYNSYM<span class=\"w\">           </span><span class=\"m\">0000000000400258</span><span class=\"w\">  </span><span class=\"m\">00000258</span>\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000048</span><span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">5</span><span class=\"w\">     </span><span class=\"m\">1</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span>.dynstr<span class=\"w\">           </span>STRTAB<span class=\"w\">           </span>00000000004002a0<span class=\"w\">  </span>000002a0\n</span><span id=\"__span-3-15\"><a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\" href=\"#__codelineno-3-15\"></a><span class=\"w\">       </span>000000000000001a<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-3-16\"><a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\" href=\"#__codelineno-3-16\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">6</span><span class=\"o\">]</span><span class=\"w\"> </span>.rela.plt<span class=\"w\">         </span>RELA<span class=\"w\">             </span>00000000004002c0<span class=\"w\">  </span>000002c0\n</span><span id=\"__span-3-17\"><a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\" href=\"#__codelineno-3-17\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000030</span><span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">  </span>AI<span class=\"w\">       </span><span class=\"m\">4</span><span class=\"w\">    </span><span class=\"m\">11</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-18\"><a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\" href=\"#__codelineno-3-18\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">7</span><span class=\"o\">]</span><span class=\"w\"> </span>.plt<span class=\"w\">              </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000401000</span><span class=\"w\">  </span><span class=\"m\">00001000</span>\n</span><span id=\"__span-3-19\"><a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\" href=\"#__codelineno-3-19\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000030</span><span class=\"w\">  </span><span class=\"m\">0000000000000010</span><span class=\"w\">  </span>AX<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">16</span>\n</span><span id=\"__span-3-20\"><a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\" href=\"#__codelineno-3-20\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"o\">]</span><span class=\"w\"> </span>.text<span class=\"w\">             </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000401030</span><span class=\"w\">  </span><span class=\"m\">00001030</span>\n</span><span id=\"__span-3-21\"><a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\" href=\"#__codelineno-3-21\"></a><span class=\"w\">       </span>000000000000000a<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>AX<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-3-22\"><a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\" href=\"#__codelineno-3-22\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">9</span><span class=\"o\">]</span><span class=\"w\"> </span>.eh_frame<span class=\"w\">         </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000402000</span><span class=\"w\">  </span><span class=\"m\">00002000</span>\n</span><span id=\"__span-3-23\"><a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\" href=\"#__codelineno-3-23\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-24\"><a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\" href=\"#__codelineno-3-24\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">10</span><span class=\"o\">]</span><span class=\"w\"> </span>.dynamic<span class=\"w\">          </span>DYNAMIC<span class=\"w\">          </span>0000000000402ec8<span class=\"w\">  </span>00002ec8\n</span><span id=\"__span-3-25\"><a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\" href=\"#__codelineno-3-25\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000120</span><span class=\"w\">  </span><span class=\"m\">0000000000000010</span><span class=\"w\">  </span>WA<span class=\"w\">       </span><span class=\"m\">5</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-26\"><a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\" href=\"#__codelineno-3-26\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">11</span><span class=\"o\">]</span><span class=\"w\"> </span>.got.plt<span class=\"w\">          </span>PROGBITS<span class=\"w\">         </span>0000000000402fe8<span class=\"w\">  </span>00002fe8\n</span><span id=\"__span-3-27\"><a id=\"__codelineno-3-27\" name=\"__codelineno-3-27\" href=\"#__codelineno-3-27\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000028</span><span class=\"w\">  </span><span class=\"m\">0000000000000008</span><span class=\"w\">  </span>WA<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-28\"><a id=\"__codelineno-3-28\" name=\"__codelineno-3-28\" href=\"#__codelineno-3-28\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">12</span><span class=\"o\">]</span><span class=\"w\"> </span>.symtab<span class=\"w\">           </span>SYMTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00003010</span>\n</span><span id=\"__span-3-29\"><a id=\"__codelineno-3-29\" name=\"__codelineno-3-29\" href=\"#__codelineno-3-29\"></a><span class=\"w\">       </span>00000000000000d8<span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">          </span><span class=\"m\">13</span><span class=\"w\">     </span><span class=\"m\">3</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-3-30\"><a id=\"__codelineno-3-30\" name=\"__codelineno-3-30\" href=\"#__codelineno-3-30\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">13</span><span class=\"o\">]</span><span class=\"w\"> </span>.strtab<span class=\"w\">           </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>000030e8\n</span><span id=\"__span-3-31\"><a id=\"__codelineno-3-31\" name=\"__codelineno-3-31\" href=\"#__codelineno-3-31\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000043</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-3-32\"><a id=\"__codelineno-3-32\" name=\"__codelineno-3-32\" href=\"#__codelineno-3-32\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">14</span><span class=\"o\">]</span><span class=\"w\"> </span>.shstrtab<span class=\"w\">         </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>0000312b\n</span><span id=\"__span-3-33\"><a id=\"__codelineno-3-33\" name=\"__codelineno-3-33\" href=\"#__codelineno-3-33\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000069</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-3-34\"><a id=\"__codelineno-3-34\" name=\"__codelineno-3-34\" href=\"#__codelineno-3-34\"></a>Key<span class=\"w\"> </span>to<span class=\"w\"> </span>Flags:\n</span><span id=\"__span-3-35\"><a id=\"__codelineno-3-35\" name=\"__codelineno-3-35\" href=\"#__codelineno-3-35\"></a><span class=\"w\">  </span>W<span class=\"w\"> </span><span class=\"o\">(</span>write<span class=\"o\">)</span>,<span class=\"w\"> </span>A<span class=\"w\"> </span><span class=\"o\">(</span>alloc<span class=\"o\">)</span>,<span class=\"w\"> </span>X<span class=\"w\"> </span><span class=\"o\">(</span>execute<span class=\"o\">)</span>,<span class=\"w\"> </span>M<span class=\"w\"> </span><span class=\"o\">(</span>merge<span class=\"o\">)</span>,<span class=\"w\"> </span>S<span class=\"w\"> </span><span class=\"o\">(</span>strings<span class=\"o\">)</span>,<span class=\"w\"> </span>I<span class=\"w\"> </span><span class=\"o\">(</span>info<span class=\"o\">)</span>,\n</span><span id=\"__span-3-36\"><a id=\"__codelineno-3-36\" name=\"__codelineno-3-36\" href=\"#__codelineno-3-36\"></a><span class=\"w\">  </span>L<span class=\"w\"> </span><span class=\"o\">(</span>link<span class=\"w\"> </span>order<span class=\"o\">)</span>,<span class=\"w\"> </span>O<span class=\"w\"> </span><span class=\"o\">(</span>extra<span class=\"w\"> </span>OS<span class=\"w\"> </span>processing<span class=\"w\"> </span>required<span class=\"o\">)</span>,<span class=\"w\"> </span>G<span class=\"w\"> </span><span class=\"o\">(</span>group<span class=\"o\">)</span>,<span class=\"w\"> </span>T<span class=\"w\"> </span><span class=\"o\">(</span>TLS<span class=\"o\">)</span>,\n</span><span id=\"__span-3-37\"><a id=\"__codelineno-3-37\" name=\"__codelineno-3-37\" href=\"#__codelineno-3-37\"></a><span class=\"w\">  </span>C<span class=\"w\"> </span><span class=\"o\">(</span>compressed<span class=\"o\">)</span>,<span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"o\">(</span>unknown<span class=\"o\">)</span>,<span class=\"w\"> </span>o<span class=\"w\"> </span><span class=\"o\">(</span>OS<span class=\"w\"> </span>specific<span class=\"o\">)</span>,<span class=\"w\"> </span>E<span class=\"w\"> </span><span class=\"o\">(</span>exclude<span class=\"o\">)</span>,\n</span><span id=\"__span-3-38\"><a id=\"__codelineno-3-38\" name=\"__codelineno-3-38\" href=\"#__codelineno-3-38\"></a><span class=\"w\">  </span>D<span class=\"w\"> </span><span class=\"o\">(</span>mbind<span class=\"o\">)</span>,<span class=\"w\"> </span>l<span class=\"w\"> </span><span class=\"o\">(</span>large<span class=\"o\">)</span>,<span class=\"w\"> </span>p<span class=\"w\"> </span><span class=\"o\">(</span>processor<span class=\"w\"> </span>specific<span class=\"o\">)</span>\n</span><span id=\"__span-3-39\"><a id=\"__codelineno-3-39\" name=\"__codelineno-3-39\" href=\"#__codelineno-3-39\"></a>\n</span><span id=\"__span-3-40\"><a id=\"__codelineno-3-40\" name=\"__codelineno-3-40\" href=\"#__codelineno-3-40\"></a>There<span class=\"w\"> </span>are<span class=\"w\"> </span>no<span class=\"w\"> </span>section<span class=\"w\"> </span>groups<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>this<span class=\"w\"> </span>file.\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u51fa\u73b0\u4e86\u4e00\u4e9b\u5728\u4e0a\u4e00\u7bc7\u535a\u5ba2\u91cc\u51fa\u73b0\u8fc7\u7684\u548c\u52a8\u6001\u94fe\u63a5\u76f8\u5173\u7684\u6bb5\uff1a</p>\n<ol>\n<li><code>.hash</code> \u548c <code>.gnu.hash</code>\uff1a\u4e0d\u540c\u683c\u5f0f\u7684\u54c8\u5e0c\u8868\uff0c\u63d0\u4f9b\u4e86\u4ece\u7b26\u53f7\u540d\u5b57\u5230\u7b26\u53f7\u7684\u6620\u5c04\uff0c\u63d0\u9ad8\u52a8\u6001\u94fe\u63a5\u5668\u67e5\u627e\u7b26\u53f7\u7684\u6027\u80fd</li>\n<li><code>.dynsym</code>\uff1aDynamic Symbol\uff0c\u548c\u52a8\u6001\u94fe\u63a5\u6709\u5173\u7684\u52a8\u6001\u7b26\u53f7\u8868</li>\n<li><code>.dynstr</code>\uff1aDynamic String\uff0c\u548c\u52a8\u6001\u94fe\u63a5\u6709\u5173\u7684\u5b57\u7b26\u4e32\u7684\u8868</li>\n<li><code>.dynamic</code>\uff1aDynamic\uff0c\u5411\u52a8\u6001\u94fe\u63a5\u5668\u63d0\u4f9b\u4e86\u4e00\u4e9b\u4fe1\u606f</li>\n</ol>\n<p>\u6b64\u5916\uff0c\u8fd8\u51fa\u73b0\u4e86\u4e00\u4e9b\u65b0\u7684\u6bb5\uff1a</p>\n<ol>\n<li><code>.interp</code>\uff1a\u8fd9\u4e2a\u6bb5\u8bb0\u5f55\u4e86 Program Interpreter \u7684\u8def\u5f84\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u7528\u547d\u4ee4\u884c <code>ld -dynamic-linker /lib64/ld-linux-x86-64.so.2</code> \u6240\u6307\u5b9a\u7684 <code>/lib64/ld-linux-x86-64.so.2</code>\uff0c\u7528\u6765\u544a\u8bc9\u64cd\u4f5c\u7cfb\u7edf\uff0c\u8981\u8fd0\u884c\u8fd9\u4e2a\u53ef\u6267\u884c\u7a0b\u5e8f\uff0c\u9700\u8981\u4f9d\u9760\u8fd9\u4e2a Program Interpreter\uff0c\u5b83\u540c\u65f6\u4e5f\u662f\u52a8\u6001\u94fe\u63a5\u5668</li>\n<li><code>.plt</code>\uff1aProcedure Linkage Table\uff0c\u6d89\u53ca\u5230\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u51fd\u6570\uff0c\u4e0b\u9762\u4f1a\u8be6\u7ec6\u4ecb\u7ecd</li>\n<li><code>.rela.plt</code>\uff1a\u9488\u5bf9 Procedure Linkage Table \u7684\u91cd\u5b9a\u4f4d\uff08Relocation\uff09\u4fe1\u606f\uff0c\u4e0b\u9762\u4f1a\u8be6\u7ec6\u4ecb\u7ecd</li>\n<li><code>.got.plt</code>\uff1a\u9488\u5bf9 Procedure Linkage Table \u7684 Global Offset Table\uff0c\u4e0b\u9762\u4f1a\u8be6\u7ec6\u4ecb\u7ecd</li>\n</ol>\n<p>\u8fd9\u65f6\u5019\u4f60\u89c9\u5f97\u5f88\u5947\u602a\uff1a\u901a\u5e38\u770b\u5230 <code>.rela</code> \u5f00\u5934\u7684\u6bb5\uff0c\u90fd\u662f\u5728\u5bf9\u8c61\u6587\u4ef6\u91cc\uff0c\u7528\u6765\u4fdd\u5b58\u5bf9\u5e94\u6bb5\u7684\u91cd\u5b9a\u4f4d\u4fe1\u606f\u3002\u4f46\u662f\u4e3a\u5565\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u8fd8\u6709\u5462\uff1f\u5728\u524d\u9762\u7684\u51e0\u7bc7\u535a\u5ba2\u4e2d\uff0c\u9759\u6001\u94fe\u63a5\u5668\u5df2\u7ecf\u89e3\u51b3\u4e86\u6240\u6709\u91cd\u5b9a\u4f4d\uff0c\u6240\u4ee5\u6700\u7ec8\u7684\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u6ca1\u6709\u91cd\u5b9a\u4f4d\u3002\u4f46\u662f\uff0c\u5bf9\u4e8e\u52a8\u6001\u5e93\uff0c\u7531\u4e8e\u9759\u6001\u94fe\u63a5\u5668\u65e0\u6cd5\u77e5\u9053\u52a8\u6001\u5e93\u4f1a\u88ab\u52a0\u8f7d\u5230\u4ec0\u4e48\u5730\u5740\u4e0a\u53bb\uff0c\u53ea\u597d\u4fdd\u7559\u4e86\u4e00\u4e9b\u91cd\u5b9a\u4f4d\u4fe1\u606f\uff0c\u800c\u8fd9\u4e9b\u4f1a\u7559\u7ed9\u540e\u6765\u7684\u52a8\u6001\u94fe\u63a5\u5668\uff1a\u52a8\u6001\u94fe\u63a5\u5668\u4f1a\u8d1f\u8d23\u52a0\u8f7d\u52a8\u6001\u5e93\uff0c\u4e5f\u5c31\u77e5\u9053\u4e86\u52a8\u6001\u5e93\u7684\u5730\u5740\uff0c\u56e0\u6b64\u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u5269\u4e0b\u7684\u8fd9\u4e9b\u9488\u5bf9\u52a8\u6001\u5e93\u7684\u91cd\u5b9a\u4f4d\u4e86\u3002</p>\n<p>\u7ee7\u7eed\u5f80\u4e0b\u770b Program Headers \u90e8\u5206\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>Program<span class=\"w\"> </span>Headers:\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"w\">  </span>Type<span class=\"w\">           </span>Offset<span class=\"w\">             </span>VirtAddr<span class=\"w\">           </span>PhysAddr\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"w\">                 </span>FileSiz<span class=\"w\">            </span>MemSiz<span class=\"w\">              </span>Flags<span class=\"w\">  </span>Align\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"w\">  </span>PHDR<span class=\"w\">           </span>0x0000000000000040<span class=\"w\"> </span>0x0000000000400040<span class=\"w\"> </span>0x0000000000400040\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"w\">                 </span>0x00000000000001c0<span class=\"w\"> </span>0x00000000000001c0<span class=\"w\">  </span>R<span class=\"w\">      </span>0x8\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"w\">  </span>INTERP<span class=\"w\">         </span>0x0000000000000200<span class=\"w\"> </span>0x0000000000400200<span class=\"w\"> </span>0x0000000000400200\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"w\">                 </span>0x000000000000001c<span class=\"w\"> </span>0x000000000000001c<span class=\"w\">  </span>R<span class=\"w\">      </span>0x1\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"w\">      </span><span class=\"o\">[</span>Requesting<span class=\"w\"> </span>program<span class=\"w\"> </span>interpreter:<span class=\"w\"> </span>/lib64/ld-linux-x86-64.so.2<span class=\"o\">]</span>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"w\">  </span>LOAD<span class=\"w\">           </span>0x0000000000000000<span class=\"w\"> </span>0x0000000000400000<span class=\"w\"> </span>0x0000000000400000\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"w\">                 </span>0x00000000000002f0<span class=\"w\"> </span>0x00000000000002f0<span class=\"w\">  </span>R<span class=\"w\">      </span>0x1000\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"w\">  </span>LOAD<span class=\"w\">           </span>0x0000000000001000<span class=\"w\"> </span>0x0000000000401000<span class=\"w\"> </span>0x0000000000401000\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"w\">                 </span>0x000000000000003a<span class=\"w\"> </span>0x000000000000003a<span class=\"w\">  </span>R<span class=\"w\"> </span>E<span class=\"w\">    </span>0x1000\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a><span class=\"w\">  </span>LOAD<span class=\"w\">           </span>0x0000000000002000<span class=\"w\"> </span>0x0000000000402000<span class=\"w\"> </span>0x0000000000402000\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">                 </span>0x0000000000000000<span class=\"w\"> </span>0x0000000000000000<span class=\"w\">  </span>R<span class=\"w\">      </span>0x1000\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a><span class=\"w\">  </span>LOAD<span class=\"w\">           </span>0x0000000000002ec8<span class=\"w\"> </span>0x0000000000402ec8<span class=\"w\"> </span>0x0000000000402ec8\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">                 </span>0x0000000000000148<span class=\"w\"> </span>0x0000000000000148<span class=\"w\">  </span>RW<span class=\"w\">     </span>0x1000\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a><span class=\"w\">  </span>DYNAMIC<span class=\"w\">        </span>0x0000000000002ec8<span class=\"w\"> </span>0x0000000000402ec8<span class=\"w\"> </span>0x0000000000402ec8\n</span><span id=\"__span-4-18\"><a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\" href=\"#__codelineno-4-18\"></a><span class=\"w\">                 </span>0x0000000000000120<span class=\"w\"> </span>0x0000000000000120<span class=\"w\">  </span>RW<span class=\"w\">     </span>0x8\n</span><span id=\"__span-4-19\"><a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\" href=\"#__codelineno-4-19\"></a><span class=\"w\">  </span>GNU_RELRO<span class=\"w\">      </span>0x0000000000002ec8<span class=\"w\"> </span>0x0000000000402ec8<span class=\"w\"> </span>0x0000000000402ec8\n</span><span id=\"__span-4-20\"><a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\" href=\"#__codelineno-4-20\"></a><span class=\"w\">                 </span>0x0000000000000138<span class=\"w\"> </span>0x0000000000000138<span class=\"w\">  </span>R<span class=\"w\">      </span>0x1\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u51fa\u73b0\u4e86\u4e00\u4e2a <code>INTERP</code> \u9879\uff0c\u5b83\u6307\u5411\u4e86 <code>.interp</code> \u6bb5\u7684\u5730\u5740\uff0c\u8fd9\u4e2a\u6bb5\u91cc\u4fdd\u5b58\u7684\u5c31\u662f <code>/lib64/ld-linux-x86-64.so.2</code> \u8fd9\u4e2a\u5b57\u7b26\u4e32\uff0c\u5176\u5b9e\u5c31\u662f\u5728\u544a\u8bc9\u64cd\u4f5c\u7cfb\u7edf\uff0c\u4ece\u8fd9\u4e2a\u5730\u5740\u8bfb\u53d6 Program Interpreter \u7684\u8def\u5f84\u3002\u548c\u4e4b\u524d\u7684\u52a8\u6001\u5e93\u4e00\u6837\uff0c\u4e5f\u51fa\u73b0\u4e86 <code>DYNAMIC</code>\uff0c\u6307\u5411\u4e86 <code>.dynamic</code> \u6bb5\uff0c\u610f\u5473\u7740\u8fd9\u5373\u4f7f\u662f\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u4e5f\u548c\u52a8\u6001\u5e93\u6709\u4e00\u4e9b\u76f8\u4f3c\u7684\u5730\u65b9\u3002</p>\n<p>\u4e0b\u9762\u53ef\u4ee5\u770b\u5230 <code>.dynamic</code> \u6bb5\u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a>Dynamic<span class=\"w\"> </span>section<span class=\"w\"> </span>at<span class=\"w\"> </span>offset<span class=\"w\"> </span>0x2ec8<span class=\"w\"> </span>contains<span class=\"w\"> </span><span class=\"m\">13</span><span class=\"w\"> </span>entries:\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"w\">  </span>Tag<span class=\"w\">        </span>Type<span class=\"w\">                         </span>Name/Value\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\"> </span>0x0000000000000001<span class=\"w\"> </span><span class=\"o\">(</span>NEEDED<span class=\"o\">)</span><span class=\"w\">             </span>Shared<span class=\"w\"> </span>library:<span class=\"w\"> </span><span class=\"o\">[</span>libprinter.so<span class=\"o\">]</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"w\"> </span>0x0000000000000004<span class=\"w\"> </span><span class=\"o\">(</span>HASH<span class=\"o\">)</span><span class=\"w\">               </span>0x400220\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"w\"> </span>0x000000006ffffef5<span class=\"w\"> </span><span class=\"o\">(</span>GNU_HASH<span class=\"o\">)</span><span class=\"w\">           </span>0x400238\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a><span class=\"w\"> </span>0x0000000000000005<span class=\"w\"> </span><span class=\"o\">(</span>STRTAB<span class=\"o\">)</span><span class=\"w\">             </span>0x4002a0\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a><span class=\"w\"> </span>0x0000000000000006<span class=\"w\"> </span><span class=\"o\">(</span>SYMTAB<span class=\"o\">)</span><span class=\"w\">             </span>0x400258\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"w\"> </span>0x000000000000000a<span class=\"w\"> </span><span class=\"o\">(</span>STRSZ<span class=\"o\">)</span><span class=\"w\">              </span><span class=\"m\">26</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\"> </span>0x000000000000000b<span class=\"w\"> </span><span class=\"o\">(</span>SYMENT<span class=\"o\">)</span><span class=\"w\">             </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\"> </span>0x0000000000000015<span class=\"w\"> </span><span class=\"o\">(</span>DEBUG<span class=\"o\">)</span><span class=\"w\">              </span>0x0\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\"> </span>0x0000000000000003<span class=\"w\"> </span><span class=\"o\">(</span>PLTGOT<span class=\"o\">)</span><span class=\"w\">             </span>0x402fe8\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\"> </span>0x0000000000000002<span class=\"w\"> </span><span class=\"o\">(</span>PLTRELSZ<span class=\"o\">)</span><span class=\"w\">           </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-5-13\"><a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\" href=\"#__codelineno-5-13\"></a><span class=\"w\"> </span>0x0000000000000014<span class=\"w\"> </span><span class=\"o\">(</span>PLTREL<span class=\"o\">)</span><span class=\"w\">             </span>RELA\n</span><span id=\"__span-5-14\"><a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\" href=\"#__codelineno-5-14\"></a><span class=\"w\"> </span>0x0000000000000017<span class=\"w\"> </span><span class=\"o\">(</span>JMPREL<span class=\"o\">)</span><span class=\"w\">             </span>0x4002c0\n</span><span id=\"__span-5-15\"><a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\" href=\"#__codelineno-5-15\"></a><span class=\"w\"> </span>0x0000000000000000<span class=\"w\"> </span><span class=\"o\">(</span>NULL<span class=\"o\">)</span><span class=\"w\">               </span>0x0\n</span></code></pre></div>\n<p>\u548c\u4e4b\u524d\u770b\u5230\u7684\u52a8\u6001\u5e93\u5bf9\u6bd4\uff0c\u591a\u51fa\u73b0\u4e86\u8fd9\u4e9b\u9879\uff1a</p>\n<ol>\n<li><code>NEEDED</code>\uff1a\u8868\u793a\u8fd0\u884c\u8fd9\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u6240\u9700\u8981\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u6587\u4ef6\u540d\uff0c\u5982\u679c\u627e\u4e0d\u5230\u5bf9\u5e94\u7684\u52a8\u6001\u5e93\uff0c\u5c31\u4f1a\u51fa\u73b0\u719f\u6089\u7684 <code>error while loading shared libraries</code> \u9519\u8bef</li>\n<li><code>DEBUG</code>\uff1a\u7528\u4e8e\u8c03\u8bd5\uff0c\u8fd9\u91cc\u4e0d\u8ba8\u8bba</li>\n<li><code>PLTGOT</code>\uff1a\u6307\u5411\u4e86 <code>.got.plt</code> \u6bb5\u7684\u5730\u5740</li>\n<li><code>PLTRELSZ</code>\uff1a\u8bb0\u5f55\u4e86 <code>.rela.plt</code> \u6bcf\u4e00\u9879\u7684\u5927\u5c0f</li>\n<li><code>PLTREL</code>\uff1a<code>RELA</code> \u8868\u793a <code>.rela.plt</code> \u6bcf\u4e00\u9879\u91cc\u5305\u542b addend \u9879\uff08RELA = REL with Addend\uff09</li>\n<li><code>JMPREL</code>\uff1a\u6307\u5411\u4e86 <code>.rela.plt</code> \u6bb5\u7684\u5730\u5740</li>\n</ol>\n<p>\u52a8\u6001\u94fe\u63a5\u5668\u5728\u52a0\u8f7d\u7a0b\u5e8f\u7684\u65f6\u5019\uff0c\u4f1a\u53bb\u5bfb\u627e <code>NEEDED</code> \u6240\u6307\u5411\u7684\u90a3\u4e9b\u52a8\u6001\u5e93\u5e76\u52a0\u8f7d\u8fdb\u6765\u3002\u90a3\u4e48\u8fd9\u4e9b\u6587\u4ef6\u4f1a\u4fdd\u5b58\u5728\u54ea\u91cc\u5462\uff1f\u548c\u6267\u884c\u7a0b\u5e8f\u8981\u53bb <code>PATH</code> \u4e2d\u5bfb\u627e\u7c7b\u4f3c\uff0c\u52a8\u6001\u5e93\u4e5f\u4f1a\u6839\u636e\u73af\u5883\u53d8\u91cf\u4ee5\u53ca\u7cfb\u7edf\u914d\u7f6e\u7684\u8def\u5f84\u53bb\u5bfb\u627e\u3002\u7531\u4e8e\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u9891\u7e41\u8fdb\u884c\u7684\u64cd\u4f5c\uff0c\u4e3a\u4e86\u63d0\u5347\u6027\u80fd\uff0c\u7cfb\u7edf\u4e2d\u4f1a\u6709\u4e00\u4efd\u7f13\u5b58\uff0c\u8fd9\u4e2a\u7f13\u5b58\u7684\u5185\u5bb9\u53ef\u4ee5\u901a\u8fc7 <code>ldconfig -p</code> \u547d\u4ee4\u67e5\u770b\u3002</p>\n<p>\u4e0a\u9762\u63d0\u5230\u4e86\u5f88\u591a\u6b21 Procedure Linkage Table\uff08PLT\uff09\uff0c\u90a3\u4e48\u5b83\u5230\u5e95\u662f\u4ec0\u4e48\u5462\uff1f\u4e0b\u9762\u6765\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\u7684\u4ee3\u7801\u6bb5\u3002</p>\n<h3 id=\"\u89c2\u5bdf\u4ee3\u7801\u6bb5\u548c-plt\">\u89c2\u5bdf\u4ee3\u7801\u6bb5\u548c PLT<a class=\"headerlink\" href=\"#\u89c2\u5bdf\u4ee3\u7801\u6bb5\u548c-plt\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7528 <code>objdump -S main</code> \u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\u7684\u4ee3\u7801\u6bb5\u548c PLT\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>main\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>main:<span class=\"w\">     </span>file<span class=\"w\"> </span>format<span class=\"w\"> </span>elf64-x86-64\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.plt:\n</span><span id=\"__span-6-7\"><a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\" href=\"#__codelineno-6-7\"></a>\n</span><span id=\"__span-6-8\"><a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\" href=\"#__codelineno-6-8\"></a><span class=\"m\">0000000000401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;:\n</span><span id=\"__span-6-9\"><a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\" href=\"#__codelineno-6-9\"></a><span class=\"w\">  </span><span class=\"m\">401000</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">35</span><span class=\"w\"> </span>ea<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>push<span class=\"w\">   </span>0x1fea<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 402ff0 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span>\n</span><span id=\"__span-6-10\"><a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\" href=\"#__codelineno-6-10\"></a><span class=\"w\">  </span><span class=\"m\">401006</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>ec<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fec<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 402ff8 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span>\n</span><span id=\"__span-6-11\"><a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\" href=\"#__codelineno-6-11\"></a><span class=\"w\">  </span>40100c:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">40</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">             </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-6-12\"><a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\" href=\"#__codelineno-6-12\"></a>\n</span><span id=\"__span-6-13\"><a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\" href=\"#__codelineno-6-13\"></a><span class=\"m\">0000000000401010</span><span class=\"w\"> </span>&lt;print@plt&gt;:\n</span><span id=\"__span-6-14\"><a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\" href=\"#__codelineno-6-14\"></a><span class=\"w\">  </span><span class=\"m\">401010</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>ea<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fea<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 403000 &lt;print&gt;</span>\n</span><span id=\"__span-6-15\"><a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\" href=\"#__codelineno-6-15\"></a><span class=\"w\">  </span><span class=\"m\">401016</span>:<span class=\"w\">   </span><span class=\"m\">68</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>push<span class=\"w\">   </span><span class=\"nv\">$0</span>x0\n</span><span id=\"__span-6-16\"><a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\" href=\"#__codelineno-6-16\"></a><span class=\"w\">  </span>40101b:<span class=\"w\">   </span>e9<span class=\"w\"> </span>e0<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>jmp<span class=\"w\">    </span><span class=\"m\">401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;\n</span><span id=\"__span-6-17\"><a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\" href=\"#__codelineno-6-17\"></a>\n</span><span id=\"__span-6-18\"><a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\" href=\"#__codelineno-6-18\"></a><span class=\"m\">0000000000401020</span><span class=\"w\"> </span>&lt;exit@plt&gt;:\n</span><span id=\"__span-6-19\"><a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\" href=\"#__codelineno-6-19\"></a><span class=\"w\">  </span><span class=\"m\">401020</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>e2<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fe2<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 403008 &lt;exit&gt;</span>\n</span><span id=\"__span-6-20\"><a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\" href=\"#__codelineno-6-20\"></a><span class=\"w\">  </span><span class=\"m\">401026</span>:<span class=\"w\">   </span><span class=\"m\">68</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>push<span class=\"w\">   </span><span class=\"nv\">$0</span>x1\n</span><span id=\"__span-6-21\"><a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\" href=\"#__codelineno-6-21\"></a><span class=\"w\">  </span>40102b:<span class=\"w\">   </span>e9<span class=\"w\"> </span>d0<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>jmp<span class=\"w\">    </span><span class=\"m\">401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;\n</span><span id=\"__span-6-22\"><a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\" href=\"#__codelineno-6-22\"></a>\n</span><span id=\"__span-6-23\"><a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\" href=\"#__codelineno-6-23\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-6-24\"><a id=\"__codelineno-6-24\" name=\"__codelineno-6-24\" href=\"#__codelineno-6-24\"></a>\n</span><span id=\"__span-6-25\"><a id=\"__codelineno-6-25\" name=\"__codelineno-6-25\" href=\"#__codelineno-6-25\"></a><span class=\"m\">0000000000401030</span><span class=\"w\"> </span>&lt;_start&gt;:\n</span><span id=\"__span-6-26\"><a id=\"__codelineno-6-26\" name=\"__codelineno-6-26\" href=\"#__codelineno-6-26\"></a><span class=\"w\">  </span><span class=\"m\">401030</span>:<span class=\"w\">   </span>e8<span class=\"w\"> </span>db<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">401010</span><span class=\"w\"> </span>&lt;print@plt&gt;\n</span><span id=\"__span-6-27\"><a id=\"__codelineno-6-27\" name=\"__codelineno-6-27\" href=\"#__codelineno-6-27\"></a><span class=\"w\">  </span><span class=\"m\">401035</span>:<span class=\"w\">   </span>e8<span class=\"w\"> </span>e6<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">401020</span><span class=\"w\"> </span>&lt;exit@plt&gt;\n</span></code></pre></div>\n<p>\u4f1a\u53d1\u73b0\u5728 <code>.plt</code> \u6bb5\u4e2d\u51fa\u73b0\u4e86\u4e24\u4e2a\u51fd\u6570\uff1a<code>print@plt</code> \u548c <code>exit@plt</code>\uff0c\u6b63\u597d\u662f <code>main</code> \u51fd\u6570\u8c03\u7528\u7684\uff0c\u7531\u52a8\u6001\u94fe\u63a5\u5e93\u63d0\u4f9b\u7684\u51fd\u6570\u3002\u5728 <code>main</code> \u51fd\u6570\u91cc\uff0c\u4e5f\u4e0d\u662f\u76f4\u63a5\u8c03\u7528\u52a8\u6001\u94fe\u63a5\u5e93\u7684 <code>print</code> \u548c <code>exit</code>\uff0c\u800c\u662f\u8c03\u7528 <code>.plt</code> \u6bb5\u91cc\u5bf9\u5e94\u7684\u5e26 <code>@plt</code> \u540e\u7f00\u7684\u7248\u672c\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\uff1f\u800c\u4e14\uff0c<code>.plt</code> \u6bb5\u5f00\u5934\u7684\u90a3\u6bb5\u4ee3\u7801\u53c8\u662f\u505a\u4ec0\u4e48\u7684\uff1f\u4e3a\u4ec0\u4e48 <code>print@plt</code> \u548c <code>exit@plt</code> \u51fd\u6570\u90fd\u8981\u8df3\u5230 <code>0x401000</code> \u5904\u7684\u4ee3\u7801\uff1f</p>\n<p>\u8fd9\u65f6\u5019\u5c31\u8981\u4e86\u89e3 PLT \u7684\u7528\u9014\u4e86\u3002\u5728\u9759\u6001\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u94fe\u63a5\u5668\u53ef\u4ee5\u77e5\u9053\u6240\u6709\u51fd\u6570\u7684\u5730\u5740\uff0c\u6240\u4ee5\u91cd\u5b9a\u4f4d\u90fd\u53ef\u4ee5\u8ba1\u7b97\u51fa\uff0c\u8df3\u8f6c\u548c\u8c03\u7528\u53ef\u4ee5\u76f4\u63a5\u5199\u5165\u5b9e\u9645\u7684\u7edd\u5bf9\u5730\u5740\u6216\u8005\u504f\u79fb\u91cf\u3002\u4f46\u5982\u679c\u94fe\u63a5\u4e86\u4e00\u4e2a\u52a8\u6001\u5e93\uff0c\u94fe\u63a5\u5668\u65e0\u6cd5\u77e5\u9053\u52a8\u6001\u5e93\u7684\u5730\u5740\uff0c\u6240\u4ee5\u91cd\u5b9a\u4f4d\u8fd8\u662f\u5f97\u7ee7\u7eed\u7559\u7740\uff0c\u4ea4\u7ed9\u6700\u540e\u7684\u52a8\u6001\u94fe\u63a5\u5668\u6765\u5b8c\u6210\u91cd\u5b9a\u4f4d\u3002\u90a3\u4e48\uff0c\u4e00\u4e2a\u6734\u7d20\u7684\u65b9\u6cd5\u5c31\u662f\uff0c\u4fdd\u7559\u5bf9\u52a8\u6001\u5e93\u7684\u6240\u6709\u91cd\u5b9a\u4f4d\u4fe1\u606f\u3002\u7b80\u5355\u5730\u628a\u5de5\u4f5c\u63a8\u8fdf\u7ed9\u4e86\u52a8\u6001\u94fe\u63a5\u5668\u3002\u4f46\u662f\uff0c\u52a8\u6001\u94fe\u63a5\u5668\u5de5\u4f5c\u5728\u7a0b\u5e8f\u542f\u52a8\u7684\u65f6\u5019\uff0c\u7528\u6237\u80af\u5b9a\u4e0d\u671f\u671b\u7a0b\u5e8f\u6bcf\u6b21\u542f\u52a8\u7684\u65f6\u5019\uff0c\u90fd\u8981\u82b1\u5f88\u957f\u7684\u65f6\u95f4\u5728\u52a8\u6001\u94fe\u63a5\u4e0a\uff0c\u6240\u4ee5\u52a8\u6001\u94fe\u63a5\u8fd8\u5f97\u8db3\u591f\u5feb\uff1a\u524d\u9762\u4e5f\u770b\u5230\u4e86\uff0c\u5404\u79cd\u54c8\u5e0c\u8868\u5404\u79cd\u4f18\u5316\uff0c\u5c31\u662f\u4e3a\u4e86\u63d0\u5347\u52a8\u6001\u94fe\u63a5\u7684\u6027\u80fd\u3002\u8981\u662f\u6bcf\u4e2a\u8c03\u7528\u90fd\u6709\u4e00\u4e2a\u91cd\u5b9a\u4f4d\u9700\u8981\u5904\u7406\uff0c\u90a3\u4e48\u6027\u80fd\u80af\u5b9a\u4e0d\u597d\u3002</p>\n<p>\u90a3\u4e48\u600e\u4e48\u529e\u5462\uff1f\u5f88\u591a\u5e38\u7528\u51fd\u6570\uff0c\u6bd4\u5982 <code>malloc</code> \u548c <code>free</code> \u7b49\u7b49\uff0c\u8c03\u7528\u7684\u5730\u65b9\u662f\u975e\u5e38\u591a\u7684\u3002\u4e0d\u8fc7\uff0c\u8f6c\u5ff5\u4e00\u60f3\uff0c\u867d\u7136\u8c03\u7528\u7684\u5730\u65b9\u5f88\u591a\uff0c\u4f46\u662f\u88ab\u8c03\u7528\u7684\u51fd\u6570\u76f8\u6bd4\u4e4b\u4e0b\u5374\u4f1a\u5c11\u5f88\u591a\uff1a\u53ef\u80fd\u6709\u4e00\u5343\u4e2a\u5730\u65b9\u8c03\u7528 <code>malloc</code>\uff0c\u4f46\u662f <code>malloc</code> \u51fd\u6570\u53ea\u6709\u4e00\u4e2a\uff0c\u5982\u679c\u53ea\u91cd\u5b9a\u4f4d\u4e00\u6b21\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u6240\u6709\u5bf9 <code>malloc</code> \u7684\u8c03\u7528\uff0c\u90a3\u8be5\u591a\u597d\uff01\u4f46\u662f\u91cd\u5b9a\u4f4d\u4e00\u6b21\u53ea\u80fd\u4fee\u6539\u4e00\u4e2a\u5730\u65b9\u7684\u4ee3\u7801\uff0c\u600e\u4e48\u529e\u5462\uff1f\u90a3\u5c31\u8ba9\u4e00\u5343\u4e2a\u5730\u65b9\u90fd\u8c03\u7528\u4e00\u4e2a\u4e34\u65f6\u7684 <code>malloc</code> \u51fd\u6570\uff0c\u8fd9\u4e2a\u4e34\u65f6\u7684 <code>malloc</code> \u51fd\u6570\u901a\u8fc7\u91cd\u5b9a\u4f4d\u8c03\u7528\u771f\u5b9e\u7684 <code>malloc</code> \u51fd\u6570\uff0c\u8fd9\u6837\u91cd\u5b9a\u4f4d\u53ea\u6709\u4e00\u6b21\uff0c\u4ee3\u4ef7\u5c31\u662f\u591a\u4e86\u4e00\u6b21\u8df3\u8f6c\u3002\u6211\u4eec\u628a\u8fd9\u4e2a\u4e34\u65f6\u7684 <code>malloc</code> \u51fd\u6570\u53eb\u505a <code>malloc@plt</code>\uff0c\u628a\u8bb0\u5f55\u6240\u6709\u8fd9\u4e9b\u4e34\u65f6\u51fd\u6570\u7684\u8868\u79f0\u4e3a Procedure Linkage Table\uff08PLT\uff09\uff0c\u90a3\u4e48\u4ee3\u7801\u53d8\u6210\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.plt</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"nl\">malloc@plt:</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">real_malloc</span><span class=\"w\"> </span><span class=\"c1\"># emit relocation to the real malloc</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a><span class=\"nl\">func1:</span>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">malloc@plt</span>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"w\">    </span><span class=\"c1\"># ...</span>\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"nl\">func2:</span>\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">malloc@plt</span>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a><span class=\"w\">    </span><span class=\"c1\"># ...</span>\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u89e3\u51b3\u4e86\u91cd\u5b9a\u4f4d\u6570\u91cf\u592a\u591a\u7684\u95ee\u9898\uff1a\u4ece\u6bcf\u4e2a\u8c03\u7528\u90fd\u8981\u4e00\u4e2a\u91cd\u5b9a\u4f4d\uff0c\u964d\u4f4e\u5230\u6bcf\u4e2a\u88ab\u8c03\u7528\u7684\u51fd\u6570\u4e00\u4e2a\u91cd\u5b9a\u4f4d\u3002\u4f46\u662f\uff0c\u8fd9\u6837\u7684 PLT \u548c\u5b9e\u9645\u770b\u5230\u7684\u8fd8\u662f\u6709\u5f88\u5927\u7684\u533a\u522b\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"m\">0000000000401010</span><span class=\"w\"> </span>&lt;print@plt&gt;:\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"w\">  </span><span class=\"m\">401010</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>ea<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fea<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 403000 &lt;print&gt;</span>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"w\">  </span><span class=\"m\">401016</span>:<span class=\"w\">   </span><span class=\"m\">68</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>push<span class=\"w\">   </span><span class=\"nv\">$0</span>x0\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"w\">  </span>40101b:<span class=\"w\">   </span>e9<span class=\"w\"> </span>e0<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>jmp<span class=\"w\">    </span><span class=\"m\">401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;\n</span></code></pre></div>\n<p>\u8fd9\u4e09\u6761\u6307\u4ee4\u662f\u5728\u505a\u4ec0\u4e48\u5462\uff1f\u4e3a\u4ec0\u4e48\u4e0d\u751f\u6210\u4e00\u4e2a\u91cd\u5b9a\u4f4d\uff0c\u76f4\u63a5\u8df3\u8f6c\u5230\u5b9e\u9645\u7684 print \u51fd\u6570\uff1f\u800c\u8981\u641e\u5f97\u8fd9\u4e48\u9ebb\u70e6\uff1f</p>\n<p>\u7b54\u6848\u662f\u8fd8\u4e0d\u6ee1\u8db3\u4e8e\u5f53\u524d\u7684\u6027\u80fd\uff1a\u5b8c\u6574\u7684\u4ee3\u7801\u91cc\u53ef\u80fd\u4f1a\u8c03\u7528\u52a8\u6001\u5e93\u91cc\u7684\u7684\u4e00\u5343\u4e2a\u51fd\u6570\uff0c\u4f46\u662f\u5b9e\u9645\u8fd0\u884c\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u4ee3\u7801\u90fd\u4f1a\u88ab\u6267\u884c\uff0c\u4e8e\u662f\u53ef\u80fd\u53ea\u6709\u4e00\u5c0f\u90e8\u5206\u52a8\u6001\u5e93\u7684\u51fd\u6570\u4f1a\u88ab\u8c03\u7528\u3002\u8fd9\u65f6\u5019\uff0c\u5c31\u5e0c\u671b\u5b9e\u73b0\u4e00\u70b9\uff1a\u7b2c\u4e00\u6b21\u8c03\u7528\u52a8\u6001\u5e93\u91cc\u7684\u51fd\u6570\u7684\u65f6\u5019\uff0c\u518d\u8fdb\u884c\u91cd\u5b9a\u4f4d\uff0c\u4e4b\u540e\u5c31\u4e00\u76f4\u7528\u8fd9\u4e2a\u91cd\u5b9a\u4f4d\u597d\u7684\u7ed3\u679c\u3002\u90a3\u4e48\u5982\u679c\u4e00\u4e2a\u51fd\u6570\u4ece\u6765\u6ca1\u6709\u88ab\u8c03\u7528\u8fc7\uff0c\u90a3\u5c31\u7701\u4e0b\u4e86\u91cd\u5b9a\u4f4d\u7684\u65f6\u95f4\u3002\u8fd9\u5c31\u662f\u60f0\u6027\uff08Lazy\uff09\u6216\u8005\u8bf4\u5ef6\u8fdf\uff08Deferred\uff09\u7684\u601d\u60f3\u3002</p>\n<p>\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c\u5b83\u662f\u8fd9\u4e48\u5b9e\u73b0\u7684\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u6b21\u8c03\u7528\u7684\u65f6\u5019\uff0c\u4f1a\u8df3\u8f6c\u5230\u52a8\u6001\u94fe\u63a5\u5668\u91cc\uff0c\u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u5b8c\u6210\u91cd\u5b9a\u4f4d\uff0c\u7136\u540e\u8df3\u8f6c\u5230\u5b9e\u9645\u7684\u52a8\u6001\u5e93\u91cc\u7684\u51fd\u6570</li>\n<li>\u7b2c\u4e8c\u6b21\u548c\u4e4b\u540e\u8c03\u7528\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u8df3\u8f6c\u5230\u5b9e\u9645\u7684\u52a8\u6001\u5e93\u91cc\u7684\u51fd\u6570</li>\n</ol>\n<p>\u90a3\u4e48\u600e\u4e48\u53bb\u8bb0\u5f55\u5b9e\u9645\u7684\u52a8\u6001\u5e93\u91cc\u7684\u51fd\u6570\u7684\u5730\u5740\u5462\uff1f\u90a3\u5c31\u627e\u4e2a\u5730\u65b9\uff0c\u628a\u8fd9\u4e2a\u5730\u5740\u5b58\u4e0b\u6765\u5c31\u597d\u3002\u7b2c\u4e00\u6b21\u8c03\u7528\u7684\u65f6\u5019\uff0c\u60f3\u529e\u6cd5\u8fdb\u5165\u5230\u52a8\u6001\u94fe\u63a5\u5668\uff0c\u8ba9\u5b83\u8fdb\u884c\u91cd\u5b9a\u4f4d\u3002\u91cd\u5b9a\u4f4d\u5b8c\u4ee5\u540e\uff0c\u5c31\u628a\u8fd9\u4e2a\u5730\u5740\u4fdd\u5b58\u4e0b\u6765\uff0c\u4e0b\u6b21\u8c03\u7528\u5c31\u4f1a\u76f4\u63a5\u8df3\u8f6c\u8fc7\u53bb\u4e86\u3002\u518d\u56de\u770b <code>print@plt</code> \u7684\u7b2c\u4e00\u6761\u6307\u4ee4\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"m\">0000000000401010</span><span class=\"w\"> </span>&lt;print@plt&gt;:\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"w\">  </span><span class=\"m\">401010</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>ea<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fea<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 403000 &lt;print&gt;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"w\">  </span><span class=\"m\">401016</span>:<span class=\"w\">   </span><span class=\"m\">68</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>push<span class=\"w\">   </span><span class=\"nv\">$0</span>x0\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"w\">  </span>40101b:<span class=\"w\">   </span>e9<span class=\"w\"> </span>e0<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>jmp<span class=\"w\">    </span><span class=\"m\">401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;\n</span></code></pre></div>\n<p>\u5b83\u8df3\u8f6c\u5230 <code>0x1fea(%rip) # 0x403000</code> \u6307\u5411\u7684\u5730\u5740\u7684\u5185\u5bb9\uff0c\u8fd9\u91cc\u4fdd\u5b58\u4e86\u672a\u6765 <code>print</code> \u5728\u52a8\u6001\u5e93\u4e2d\u7684\u771f\u5b9e\u5730\u5740\u3002\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff0c\u600e\u4e48\u5b9e\u73b0\u7b2c\u4e00\u6b21\u8c03\u7528 <code>print@plt</code> \u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u8fdb\u5165\u5230\u52a8\u6001\u94fe\u63a5\u5668\u5462\uff1f<code>0x1fea(%rip) # 0x403000</code> \u6307\u5411\u7684\u5730\u5740\u7684\u5185\u5bb9\u7684\u521d\u59cb\u503c\u53c8\u662f\u4ec0\u4e48\u5462\uff1f\u4e0b\u9762\u7684 <code>push</code> \u548c <code>jmp</code> \u53c8\u662f\u5728\u505a\u4ec0\u4e48\uff1f</p>\n<p>\u5176\u5b9e\uff0c\u591a\u4f59\u7684\u4e24\u6761\u6307\u4ee4\uff0c\u7ed3\u5408\u524d\u9762\u7684 <code>0x4010000</code> \u5730\u5740\u7684\u4ee3\u7801\uff0c\u5c31\u5b9e\u73b0\u4e86\u7b2c\u4e00\u6b21\u8c03\u7528\u8fdb\u52a8\u6001\u94fe\u63a5\u5668\u7684\u529f\u80fd\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"m\">0000000000401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;:\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a><span class=\"w\">  </span><span class=\"m\">401000</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">35</span><span class=\"w\"> </span>ea<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>push<span class=\"w\">   </span>0x1fea<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 402ff0 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span>\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a><span class=\"w\">  </span><span class=\"m\">401006</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>ec<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fec<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 402ff8 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span>\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">  </span>40100c:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">40</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">             </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a>\n</span><span id=\"__span-10-6\"><a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\" href=\"#__codelineno-10-6\"></a><span class=\"m\">0000000000401010</span><span class=\"w\"> </span>&lt;print@plt&gt;:\n</span><span id=\"__span-10-7\"><a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\" href=\"#__codelineno-10-7\"></a><span class=\"w\">  </span><span class=\"m\">401010</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>ea<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fea<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 403000 &lt;print&gt;</span>\n</span><span id=\"__span-10-8\"><a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\" href=\"#__codelineno-10-8\"></a><span class=\"w\">  </span><span class=\"m\">401016</span>:<span class=\"w\">   </span><span class=\"m\">68</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>push<span class=\"w\">   </span><span class=\"nv\">$0</span>x0\n</span><span id=\"__span-10-9\"><a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\" href=\"#__codelineno-10-9\"></a><span class=\"w\">  </span>40101b:<span class=\"w\">   </span>e9<span class=\"w\"> </span>e0<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>jmp<span class=\"w\">    </span><span class=\"m\">401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;\n</span><span id=\"__span-10-10\"><a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\" href=\"#__codelineno-10-10\"></a>\n</span><span id=\"__span-10-11\"><a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\" href=\"#__codelineno-10-11\"></a><span class=\"m\">0000000000401020</span><span class=\"w\"> </span>&lt;exit@plt&gt;:\n</span><span id=\"__span-10-12\"><a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\" href=\"#__codelineno-10-12\"></a><span class=\"w\">  </span><span class=\"m\">401020</span>:<span class=\"w\">   </span>ff<span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>e2<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>jmp<span class=\"w\">    </span>*0x1fe2<span class=\"o\">(</span>%rip<span class=\"o\">)</span><span class=\"w\">        </span><span class=\"c1\"># 403008 &lt;exit&gt;</span>\n</span><span id=\"__span-10-13\"><a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\" href=\"#__codelineno-10-13\"></a><span class=\"w\">  </span><span class=\"m\">401026</span>:<span class=\"w\">   </span><span class=\"m\">68</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>push<span class=\"w\">   </span><span class=\"nv\">$0</span>x1\n</span><span id=\"__span-10-14\"><a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\" href=\"#__codelineno-10-14\"></a><span class=\"w\">  </span>40102b:<span class=\"w\">   </span>e9<span class=\"w\"> </span>d0<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>jmp<span class=\"w\">    </span><span class=\"m\">401000</span><span class=\"w\"> </span>&lt;print@plt-0x10&gt;\n</span></code></pre></div>\n<p>\u521d\u59cb\u60c5\u51b5\u4e0b\uff0c<code>0x403000</code> \u5730\u5740\u4fdd\u5b58\u7684\u5730\u5740\u662f <code>0x401016</code>\uff0c\u4e5f\u5c31\u662f <code>print@plt</code> \u7684 <code>push</code> \u6307\u4ee4\u7684\u5730\u5740\u3002\u90a3\u4e48\uff0c\u7b2c\u4e00\u6b21\u8c03\u7528 <code>print@plt</code> \u4f1a\u53d1\u751f\u7684\u4e8b\u60c5\u662f\uff1a</p>\n<ol>\n<li>\u8c03\u7528 <code>print@plt</code>\uff0c\u6267\u884c <code>401010:   ff 25 ea 1f 00 00       jmp    *0x1fea(%rip)        # 403000 &lt;print&gt;</code>\uff0c\u6b64\u65f6 <code>0x403000</code> \u5730\u5740\u4fdd\u5b58\u7684\u5185\u5bb9\u662f <code>0x401016</code>\uff0c\u4e5f\u5c31\u662f\u8df3\u8f6c\u5230 <code>0x401016</code></li>\n<li>\u6267\u884c <code>401016:  68 00 00 00 00          push   $0x0</code>\uff0c\u5411\u6808\u4e0a\u538b\u5165\u4e86 <code>0</code>\uff0c\u5177\u4f53\u4ec0\u4e48\u542b\u4e49\uff0c\u4e0b\u9762\u4f1a\u8fdb\u884c\u5206\u6790</li>\n<li>\u6267\u884c <code>40101b:  e9 e0 ff ff ff          jmp    401000 &lt;print@plt-0x10&gt;</code>\uff0c\u8df3\u8f6c\u5230 <code>0x401000</code></li>\n<li>\u6267\u884c <code>401000:  ff 35 ea 1f 00 00       push   0x1fea(%rip)        # 402ff0 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</code>\uff0c\u5177\u4f53\u4ec0\u4e48\u542b\u4e49\uff0c\u4e0b\u9762\u4f1a\u8fdb\u884c\u5206\u6790</li>\n<li>\u6267\u884c <code>401006:  ff 25 ec 1f 00 00       jmp    *0x1fec(%rip)        # 402ff8 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</code>\uff0c\u8fd9\u4e00\u6761\u6307\u4ee4\u8df3\u8f6c\u5230 <code>0x402ff8</code> \u5730\u5740\u4fdd\u5b58\u7684\u5185\u5bb9\uff0c\u8fd9\u4e2a\u5185\u5bb9\u5c31\u662f\u52a8\u6001\u94fe\u63a5\u5668\u63d0\u4f9b\u7684\u51fd\u6570\uff0c\u5b83\u4f1a\u8d1f\u8d23\u8fdb\u884c\u91cd\u5b9a\u4f4d\uff0c\u91cd\u5b9a\u4f4d\u4ee5\u540e\uff0c\u5c31\u4f1a\u628a\u7ed3\u679c\u5199\u5230 <code>0x403000</code> \u5730\u5740\u91cc</li>\n</ol>\n<p>\u90a3\u4e48\uff0c\u4e4b\u540e\u8c03\u7528 <code>print@plt</code> \u4f1a\u53d1\u751f\u7684\u4e8b\u60c5\u662f\uff1a</p>\n<ol>\n<li>\u8c03\u7528 <code>print@plt</code>\uff0c\u6267\u884c <code>401010:   ff 25 ea 1f 00 00       jmp    *0x1fea(%rip)        # 403000 &lt;print&gt;</code>\uff0c\u6b64\u65f6 <code>0x403000</code> \u5730\u5740\u4fdd\u5b58\u7684\u5185\u5bb9\u662f\u7ecf\u8fc7\u91cd\u5b9a\u4f4d\u540e\u7684\u771f\u5b9e\u7684 <code>print</code> \u51fd\u6570\u7684\u5730\u5740</li>\n</ol>\n<p>\u90a3\u4e48\u8fd9\u4e2a\u903b\u8f91\u5c31\u6e05\u695a\u4e86\uff1a<code>0x403000</code> \u4fdd\u5b58\u4e86 <code>print</code> \u51fd\u6570\u7684\u5730\u5740\uff0c\u5982\u679c\u8fd8\u6ca1\u6709\u91cd\u5b9a\u4f4d\uff0c\u5c31\u6307\u5411\u521d\u59cb\u5316\u7684\u4ee3\u7801 <code>0x401016</code>\u3002\u8fd9\u6bb5\u4ee3\u7801\u5411\u6808\u4e0a\u538b\u5165\u4e86\u4e24\u4e2a\u5185\u5bb9\uff1a</p>\n<ol>\n<li><code>print@plt</code> \u538b\u5165\u4e86 0\uff0c<code>exit@plt</code> \u538b\u5165\u4e86 1\uff0c\u8fd9\u5bf9\u5e94\u4e86\u52a8\u6001\u7b26\u53f7\u8868\u91cc\u8fd9\u4e24\u4e2a\u7b26\u53f7\u7684\u4f4d\u7f6e\uff0c\u6839\u636e\u7f16\u53f7\uff0c\u5c31\u53ef\u4ee5\u67e5\u5230\u8981\u627e\u7684\u7b26\u53f7\u540d\u79f0</li>\n<li>\u538b\u5165\u4e86 <code>0x402ff0</code> \u5730\u5740\u7684\u5185\u5bb9\uff0c\u8fd9\u4e2a\u5185\u5bb9\u7531\u52a8\u6001\u94fe\u63a5\u5668\u521d\u59cb\u5316\uff0c\u53ef\u4ee5\u60f3\u5230\u5927\u6982\u662f\u7528\u6765\u8868\u793a\u5f53\u524d\u53ef\u6267\u884c\u6587\u4ef6\u7684\u67d0\u4e2a\u6307\u9488</li>\n</ol>\n<p>\u90a3\u4e48\u6700\u540e\u8df3\u8f6c\u5230\u52a8\u6001\u94fe\u63a5\u5668\u91cc\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u6839\u636e\u538b\u6808\u7684\u5185\u5bb9\uff0c\u627e\u5230\u8981\u91cd\u5b9a\u4f4d\u7684\u51fd\u6570\uff0c\u8fdb\u884c\u91cd\u5b9a\u4f4d\u3002</p>\n<p>\u4e3a\u4e86\u4fdd\u5b58\u4e0a\u9762\u7684\u8fd9\u4e9b\u6570\u636e\uff1a<code>0x403000</code> \u4fdd\u5b58\u7684 <code>print</code> \u51fd\u6570\u5730\u5740\uff0c\u6216\u662f\u52a8\u6001\u94fe\u63a5\u5668\u63d0\u4f9b\u7684 <code>0x402ff0</code> \u4ee5\u53ca <code>0x402ff8</code>\uff0c\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>.got.plt</code> \u6bb5\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a>0000000000402fe8<span class=\"w\"> </span>&lt;_GLOBAL_OFFSET_TABLE_&gt;:\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a><span class=\"w\">  </span>402fe8:<span class=\"w\">   </span>c8<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">40</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">             </span>enter<span class=\"w\">  </span><span class=\"nv\">$0</span>x402e,<span class=\"nv\">$0</span>x0\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"w\">    </span>...\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"w\">  </span><span class=\"m\">403000</span>:<span class=\"w\">   </span><span class=\"m\">16</span><span class=\"w\">                      </span><span class=\"o\">(</span>bad<span class=\"o\">)</span>\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">  </span><span class=\"m\">403001</span>:<span class=\"w\">   </span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"m\">40</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>adc<span class=\"w\">    </span>%al,0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">  </span><span class=\"m\">403004</span>:<span class=\"w\">   </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>add<span class=\"w\">    </span>%al,<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">  </span><span class=\"m\">403006</span>:<span class=\"w\">   </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>add<span class=\"w\">    </span>%al,<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">  </span><span class=\"m\">403008</span>:<span class=\"w\">   </span><span class=\"m\">26</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"m\">40</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">             </span>es<span class=\"w\"> </span>adc<span class=\"w\"> </span>%al,0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">  </span>40300c:<span class=\"w\">   </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>add<span class=\"w\">    </span>%al,<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a><span class=\"w\">    </span>...\n</span></code></pre></div>\n<p>\u8fd9\u4e2a\u5c31\u53eb\u505a Global Offset Table\uff0c\u8fd9\u91cc\u5c55\u793a\u7684\u662f\u7528\u4e8e PLT \u7684 GOT\u3002\u5b83\u7684\u5185\u5bb9\u5982\u4e0b\uff1a</p>\n<ol>\n<li>0x402fe8 \u5f00\u59cb\u7684 8 \u4e2a\u5b57\u8282\uff1a\u4fdd\u5b58\u4e86 .dynamic \u6bb5\u7684\u5730\u5740</li>\n<li>0x402ff0 \u5f00\u59cb\u7684 8 \u4e2a\u5b57\u8282\uff1a\u4fdd\u7559\u7ed9\u52a8\u6001\u94fe\u63a5\u5668</li>\n<li>0x402ff8 \u5f00\u59cb\u7684 8 \u4e2a\u5b57\u8282\uff1a\u4fdd\u7559\u7ed9\u52a8\u6001\u94fe\u63a5\u5668</li>\n<li>0x403000 \u5f00\u59cb\u7684 8 \u4e2a\u5b57\u8282\uff1a<code>print</code> \u7684\u5730\u5740\uff0c\u521d\u59cb\u5316\u4e3a <code>0x401016</code></li>\n<li>0x403008 \u5f00\u59cb\u7684 8 \u4e2a\u5b57\u8282\uff1a<code>exit</code> \u7684\u5730\u5740\uff0c\u521d\u59cb\u5316\u4e3a <code>0x401026</code></li>\n</ol>\n<p>\u90a3\u4e48\u5230\u8fd9\u91cc\uff0c\u5c31\u5b8c\u6210\u4e86 PLT \u4ee5\u53ca GOT \u7684\u5206\u6790\u4e86\u3002</p>\n<p>\u7b80\u5355\u5c0f\u7ed3\u4e00\u4e0b\uff1a</p>\n<ol>\n<li>\u4e3a\u4e86\u51cf\u5c11\u52a8\u6001\u94fe\u63a5\u8981\u8017\u8d39\u7684\u65f6\u95f4\uff0c\u91c7\u7528\u4e86\u60f0\u6027\u91cd\u5b9a\u4f4d\u7684\u65b9\u6cd5</li>\n<li>\u4e3a\u4e86\u51cf\u5c11\u91cd\u5b9a\u4f4d\u6b21\u6570\uff0c\u5728 PLT \u91cc\u7ed9\u6bcf\u4e2a\u8981\u8c03\u7528\u7684\u52a8\u6001\u5e93\u91cc\u7684\u51fd\u6570\u63d0\u4f9b\u4e86\u4e00\u4e2a\u8df3\u677f\u51fd\u6570</li>\n<li>\u4e3a\u4e86\u5b9e\u73b0\u60f0\u6027\u91cd\u5b9a\u4f4d\uff0c\u7b2c\u4e00\u6b21\u8c03\u7528\u8df3\u677f\u51fd\u6570\uff0c\u4f1a\u8c03\u7528\u52a8\u6001\u94fe\u63a5\u5668\u7684\u51fd\u6570\u6765\u5b9e\u73b0\u91cd\u5b9a\u4f4d\uff0c\u901a\u8fc7\u538b\u6808\u6765\u533a\u5206\u8981\u91cd\u5b9a\u4f4d\u7684\u51fd\u6570</li>\n<li>\u60f0\u6027\u91cd\u5b9a\u4f4d\u5b8c\u6210\u4ee5\u540e\uff0c\u8df3\u677f\u51fd\u6570\u76f4\u63a5 jmp \u5230\u76ee\u6807\u51fd\u6570</li>\n</ol>\n<h2 id=\"\u5b9e\u73b0\">\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7efc\u5408\u4ee5\u4e0a\u7684\u5206\u6790\uff0c\u843d\u5230\u5b9e\u73b0\u4e0a\uff0c\u9700\u8981\u505a\u8fd9\u4e9b\u5904\u7406\uff1a</p>\n<ol>\n<li>\u9047\u5230\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u65f6\u5019\uff0c\u4e0d\u518d\u590d\u5236\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u5185\u5bb9\u5230\u5404\u4e2a\u6bb5\u4e2d\uff0c\u66f4\u65b0\u7b26\u53f7\u8868\u5e76\u6253\u4e0a\u6807\u8bb0</li>\n<li>\u751f\u6210 .plt \u548c .got.plt \u6bb5\u7684\u5f00\u5934<ol>\n<li>.plt \u5f00\u5934\u8981\u751f\u6210 push\uff0cjmp \u548c nop \u7684\u6307\u4ee4\u5e8f\u5217</li>\n<li>.got.plt \u6bb5\u5f00\u5934\u4fdd\u5b58 .dynamic \u6bb5\u7684\u5730\u5740\uff0c\u7136\u540e\u9884\u7559 16 \u5b57\u8282\u7ed9\u52a8\u6001\u94fe\u63a5\u5668</li>\n</ol>\n</li>\n<li>\u8981\u8c03\u7528\u52a8\u6001\u94fe\u63a5\u5e93\u91cc\u7684\u51fd\u6570\u7684\u65f6\u5019\uff0c\u5728 PLT \u548c GOT \u91cc\u751f\u6210\u5bf9\u5e94\u7684\u9879\uff1a<ol>\n<li>.plt \u91cc\u8981\u751f\u6210 jmp\uff0cpush \u548c jmp \u4e09\u6761\u6307\u4ee4\u7684\u5e8f\u5217</li>\n<li>.got.plt \u8981\u6dfb\u52a0\u7528\u4e8e\u4fdd\u5b58\u5b9e\u9645\u5730\u5740\u7684\u4e00\u9879</li>\n<li>.rela.plt \u4e5f\u76f8\u5e94\u5730\u66f4\u65b0\uff0c\u6307\u5411 .got.plt \u91cc\u5bf9\u5e94\u9879\u7684\u5730\u5740</li>\n</ol>\n</li>\n<li>\u6839\u636e\u547d\u4ee4\u884c\u53c2\u6570\uff0c\u8bbe\u7f6e DT_INTERP\uff1b\u5bf9\u4e8e\u4f9d\u8d56\u7684\u52a8\u6001\u5e93\uff0c\u6dfb\u52a0 DT_NEEDED</li>\n<li>\u628a .plt\u3001.got.plt \u76f8\u5173\u7684\u4fe1\u606f\u8bb0\u5f55\u5230 .dynamic \u6bb5\u4e2d</li>\n</ol>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u6211\u7528 Rust \u5b8c\u6210\u4e86\u5b9e\u73b0\uff0c\u94fe\u63a5\u5668\u90e8\u5206\u7684\u4ee3\u7801\u91cf\u5927\u6982\u662f 1000 \u884c\uff0c\u6bd4\u4e0a\u4e00\u4e2a\u7248\u672c\u591a 400 \u884c\u3002</p>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u5c31\u662f\u300a\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\u300b\u7cfb\u5217\u535a\u5ba2\u7684\u6700\u540e\u4e00\u7bc7\u535a\u5ba2\u4e86\u3002\u56de\u987e\u4e00\u4e0b\uff0c\u6211\u4eec\u90fd\u5b8c\u6210\u4e86\u54ea\u4e9b\u529f\u80fd\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u7bc7\u535a\u5ba2\uff1a\u652f\u6301\u5355\u4e2a ELF \u5bf9\u8c61\u6587\u4ef6\u7684\u94fe\u63a5</li>\n<li>\u7b2c\u4e8c\u7bc7\u535a\u5ba2\uff1a\u652f\u6301\u591a\u4e2a ELF \u5bf9\u8c61\u6587\u4ef6\u7684\u94fe\u63a5</li>\n<li>\u7b2c\u4e09\u7bc7\u535a\u5ba2\uff1a\u652f\u6301\u751f\u6210\u52a8\u6001\u5e93</li>\n<li>\u7b2c\u56db\u7bc7\u535a\u5ba2\uff1a\u652f\u6301\u52a8\u6001\u94fe\u63a5</li>\n</ol>\n<p>\u8fd9\u8ddd\u79bb\u4e00\u4e2a\u771f\u6b63\u80fd\u7528\u7684\u94fe\u63a5\u5668\u8fd8\u5dee\u5f88\u591a\u4e1c\u897f\uff1aPIE\uff0cLinker Script\uff0c\u524d\u9762\u51fa\u73b0\u8fc7\u4f46\u662f\u6ca1\u6709\u8ba8\u8bba\u7684 <code>.eh_frame</code> \u7684\u5904\u7406\u7b49\u7b49\u3002\u4f46\u5e0c\u671b\u8fd9\u4e2a\u7cfb\u5217\u535a\u5ba2\u53ef\u4ee5\u8ba9\u4f60\u5bf9\u94fe\u63a5\u5668\u7684\u5de5\u4f5c\u65b9\u5f0f\u6709\u8fdb\u4e00\u6b65\u7684\u4e86\u89e3\u3002</p>\n<p>\u6211\u5b9e\u73b0\u7684\u94fe\u63a5\u5668\u4ee3\u7801\u5df2\u7ecf\u5f00\u6e90\u5728 <a href=\"https://github.com/jiegec/cold\">jiegec/cold</a>\uff0c\u7f16\u5199\u7684\u8fc7\u7a0b\u548c\u535a\u5ba2\u7684\u65f6\u95f4\u57fa\u672c\u662f\u4e00\u81f4\u7684\uff0c\u9488\u5bf9\u76f8\u5e94\u535a\u5ba2\u7684\u8fdb\u5ea6\uff0c\u53ef\u4ee5\u627e git commit \u5386\u53f2\uff0c\u67e5\u770b\u5bf9\u5e94\u7248\u672c\u7684\u5b9e\u73b0\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u7ed9\u51fa\u4e00\u4e9b\u6587\u6863\uff0c\u53ef\u4f9b\u5b9e\u73b0\u65f6\u53c2\u8003\uff1a</p>\n<ul>\n<li><a href=\"https://maskray.me/blog/2021-09-19-all-about-procedure-linkage-table\">All about Procedure Linkage Table</a></li>\n</ul>", "image": null, "date_published": "2024-04-07T00:00:00+00:00", "authors": [], "tags": ["elf", "linker", "linux", "software", "write-a-linker"]}, {"id": "https://jia.je/software/2024/04/06/write-a-linker-3/", "url": "https://jia.je/software/2024/04/06/write-a-linker-3/", "title": "\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff083\uff09", "content_html": "<h1 id=\"\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56683\">\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff083\uff09<a class=\"headerlink\" href=\"#\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56683\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u524d\u8a00\">\u524d\u8a00<a class=\"headerlink\" href=\"#\u524d\u8a00\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u4e2a\u7cfb\u5217\u7684\u524d\u4e24\u7bc7\u535a\u5ba2\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u9759\u6001\u94fe\u63a5\u5668\uff0c\u5b83\u53ef\u4ee5\u8f93\u5165\u82e5\u5e72\u4e2a ELF .o \u6587\u4ef6\uff0c\u8f93\u51fa ELF \u53ef\u6267\u884c\u6587\u4ef6\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u8fdb\u4e00\u6b65\u652f\u6301\u52a8\u6001\u5e93\uff1a\u8f93\u5165\u82e5\u5e72\u4e2a ELF .o \u6587\u4ef6\uff0c\u8f93\u51fa ELF \u52a8\u6001\u5e93\u3002</p>\n<!-- more -->\n\n<p>\u6ce8\u610f\uff0c\u672c\u7bc7\u535a\u5ba2\u53ea\u8ba8\u8bba\u5982\u4f55\u751f\u6210 ELF \u52a8\u6001\u5e93\uff0c\u5e76\u4e0d\u6d89\u53ca\u5982\u4f55\u94fe\u63a5 ELF \u52a8\u6001\u5e93\uff0c\u8fd9\u5c06\u4f1a\u4f5c\u4e3a\u540e\u7eed\u6587\u7ae0\u7684\u5185\u5bb9\u3002</p>\n<h2 id=\"\u56de\u987e\">\u56de\u987e<a class=\"headerlink\" href=\"#\u56de\u987e\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u56de\u987e\u4e00\u4e0b\uff1a\u5728\u8fd9\u4e2a\u7cfb\u5217\u7684\u524d\u4e24\u7bc7\u535a\u5ba2\u4e2d\uff0c\u6211\u4eec\u89c2\u5bdf\u4e86\u73b0\u6709\u94fe\u63a5\u5668\u7684\u5de5\u4f5c\u8fc7\u7a0b\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u94fe\u63a5\u5668\uff1a\u8f93\u5165\u82e5\u5e72\u4e2a ELF object\uff0c\u94fe\u63a5\u6210\u4e00\u4e2a\u53ef\u4ee5\u8fd0\u884c\u7684 ELF \u53ef\u6267\u884c\u6587\u4ef6\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u89e3\u6790\u8f93\u5165\u7684\u82e5\u5e72\u4e2a ELF\uff0c\u6536\u96c6\u5404\u4e2a section \u9700\u8981\u4fdd\u7559\u4e0b\u6765\u7684\u5185\u5bb9\uff0c\u5408\u5e76\u6765\u81ea\u4e0d\u540c ELF \u7684\u540c\u540d section</li>\n<li>\u89c4\u5212\u5c06\u8981\u751f\u6210\u7684 ELF \u53ef\u6267\u884c\u6587\u4ef6\u7684\u5185\u5bb9\u5e03\u5c40\uff1a\u5f00\u59cb\u662f\u56fa\u5b9a\u7684\u6587\u4ef6\u5934\uff0c\u4e4b\u540e\u662f\u5404\u4e2a section\uff0c\u8ba1\u7b97\u51fa\u5b83\u4eec\u4ece\u54ea\u91cc\u5f00\u59cb\u5230\u54ea\u91cc\u7ed3\u675f</li>\n<li>\u7b2c\u4e8c\u6b65\u5b8c\u6210\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u5728\u8fd0\u884c\u65f6\uff0c\u5404\u4e2a section \u5c06\u4f1a\u88ab\u52a0\u8f7d\u5230\u54ea\u4e2a\u5730\u5740\u4e0a\uff0c\u8fdb\u800c\u66f4\u65b0\u7b26\u53f7\u8868\uff0c\u5f97\u5230\u6bcf\u4e2a\u7b26\u53f7\u5728\u8fd0\u884c\u65f6\u4f1a\u5904\u5728\u54ea\u4e2a\u5730\u5740\u4e0a\uff1b\u6b64\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba1\u7b97\u91cd\u5b9a\u4f4d\uff0c\u628a\u5730\u5740\u6309\u7167\u9884\u8bbe\u7684\u89c4\u5219\u586b\u5165\u5230\u5bf9\u5e94\u7684\u5730\u65b9</li>\n<li>\u6700\u540e\u6309\u7167\u9884\u8bbe\u7684\u6587\u4ef6\u5e03\u5c40\uff0c\u628a\u6587\u4ef6\u5185\u5bb9\u5199\u5165\u5230 ELF \u6587\u4ef6\u4e2d</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u8981\u5b9e\u73b0\u751f\u6210\u52a8\u6001\u5e93\u6587\u4ef6\uff0c\u8ba9\u6211\u4eec\u9996\u5148\u5206\u6790\u4e00\u4e0b\uff0c\u8fd9\u91cc\u7684\u4e0d\u540c\u5728\u54ea\u91cc\u3002</p>\n<h2 id=\"\u5206\u6790\">\u5206\u6790<a class=\"headerlink\" href=\"#\u5206\u6790\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u52a8\u6001\u94fe\u63a5\">\u52a8\u6001\u94fe\u63a5<a class=\"headerlink\" href=\"#\u52a8\u6001\u94fe\u63a5\" title=\"Permanent link\">&para;</a></h3>\n<p>\u672c\u7cfb\u5217\u7684\u524d\u9762\u4e24\u7bc7\u6587\u7ae0\u535a\u5ba2\u5b9e\u73b0\u7684\u90fd\u662f\u9759\u6001\u94fe\u63a5\uff1a\u7531\u9759\u6001\u94fe\u63a5\u5668\u5b8c\u6210\u6240\u6709\u7684\u4e8b\u60c5\uff0c\u5f97\u5230\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u8fd9\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u5c31\u53ef\u4ee5\u8dd1\uff0c\u4e0d\u9700\u8981\u989d\u5916\u7684\u64cd\u4f5c\u3002\u4f46\u662f\u9759\u6001\u94fe\u63a5\u4e5f\u6709\u4e00\u4e9b\u7f3a\u70b9\uff1a</p>\n<ol>\n<li>\u4e8c\u8fdb\u5236\u4f53\u79ef\u5927\uff0c\u540c\u6837\u7684\u4ee3\u7801\u51fa\u73b0\u5728\u5f88\u591a\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u4e2d\uff0c\u540c\u65f6\u56e0\u4e3a\u8fd9\u4e9b\u4ee3\u7801\u7ecf\u8fc7\u4e86\u91cd\u5b9a\u4f4d\uff0c\u5185\u5bb9\u6709\u4e9b\u8bb8\u5dee\u522b\uff0c\u65e0\u6cd5\u590d\u7528\uff0c\u6d6a\u8d39\u786c\u76d8\u548c\u5185\u5b58\u7a7a\u95f4</li>\n<li>\u5982\u679c\u67d0\u4e2a\u5e95\u5c42\u5e93\u51fa\u73b0\u5b89\u5168\u95ee\u9898\uff0c\u7531\u4e8e\u8fd9\u4e2a\u5e93\u53ef\u80fd\u9759\u6001\u94fe\u63a5\u5230\u4e86\u5f88\u591a\u4e0d\u540c\u7684\u7a0b\u5e8f\u91cc\uff0c\u4e3a\u4e86\u53bb\u9664\u6709\u95ee\u9898\u7684\u4ee3\u7801\uff0c\u9700\u8981\u628a\u6240\u6709\u7528\u5230\u8fd9\u4e2a\u5e93\u7684\u7a0b\u5e8f\u90fd\u91cd\u65b0\u7f16\u8bd1\u4e00\u904d\uff0c\u624d\u80fd\u4fdd\u8bc1\u5b89\u5168\u7684\u4ee3\u7801\u88ab\u94fe\u63a5\u8fdb\u53bb</li>\n</ol>\n<p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5e38\u7528\u7684\u89e3\u51b3\u529e\u6cd5\u662f\u52a8\u6001\u94fe\u63a5\uff1a\u9759\u6001\u94fe\u63a5\u5668\u53ea\u5b8c\u6210\u4e00\u90e8\u5206\u7684\u94fe\u63a5\uff0c\u5269\u4e0b\u7684\u4e00\u90e8\u5206\u5de5\u4f5c\uff0c\u8981\u7b49\u5230\u7a0b\u5e8f\u542f\u52a8\u7684\u65f6\u5019\u5b8c\u6210\uff0c\u90a3\u4e48\u7a0b\u5e8f\u5728\u542f\u52a8\u65f6\u7531\u52a8\u6001\u94fe\u63a5\u5668\u5b8c\u6210\u7684\u94fe\u63a5\uff0c\u5c31\u662f\u52a8\u6001\u94fe\u63a5\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4e00\u6bb5 C \u4ee3\u7801\u8c03\u7528\u4e86\u6807\u51c6\u5e93\u91cc\u7684 C \u51fd\u6570\uff0c\u8981\u4e48\u7528\u9759\u6001\u94fe\u63a5\uff0c\u628a\u6574\u4e2a\u6807\u51c6\u5e93\u8fde\u63a5\u5230\u53ef\u6267\u884c\u6587\u4ef6\u91cc\uff1b\u8981\u4e48\u5c31\u7528\u52a8\u6001\u94fe\u63a5\uff0c\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4fdd\u7559\u4e0e\u51fd\u6570\u8c03\u7528\u76f8\u5173\u7684\u91cd\u5b9a\u4f4d\uff0c\u5728\u7a0b\u5e8f\u6267\u884c\u65f6\uff0c\u518d\u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u6765\u5b8c\u6210\u6700\u540e\u7684\u94fe\u63a5\u8fc7\u7a0b\u3002\u52a8\u6001\u94fe\u63a5\u89e3\u51b3\u4e86\u4e0a\u9762\u63d0\u5230\u7684\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u7531\u4e8e\u52a8\u6001\u94fe\u63a5\u7b49\u5230\u6700\u540e\u7a0b\u5e8f\u542f\u52a8\u65f6\u624d\u8fdb\u884c\uff0c\u6240\u4ee5\u53ef\u6267\u884c\u6587\u4ef6\u672c\u8eab\u7684\u4f53\u79ef\u5c31\u53ef\u4ee5\u505a\u5230\u5f88\u5c0f\uff0c\u4e0d\u518d\u9700\u8981\u9759\u6001\u94fe\u63a5\u4e00\u4e2a\u53ef\u80fd\u5de8\u5927\u7684\u9759\u6001\u5e93</li>\n<li>\u52a8\u6001\u94fe\u63a5\u662f\u6bcf\u6b21\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fdb\u884c\uff0c\u6240\u4ee5\u5982\u679c\u52a8\u6001\u5e93\u6587\u4ef6\u66ff\u6362\u4e86\uff0c\u90a3\u4e48\u7a0b\u5e8f\u672a\u6765\u518d\u6b21\u542f\u52a8\u65f6\uff0c\u81ea\u7136\u5c31\u4f1a\u7528\u5230\u65b0\u7684\u52a8\u6001\u5e93\u6587\u4ef6\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u7f16\u8bd1\u7a0b\u5e8f</li>\n</ol>\n<p>\u5f53\u7136\u4e86\uff0c\u52a8\u6001\u94fe\u63a5\u4e5f\u5e26\u6765\u4e86\u65b0\u7684\u8981\u6c42\u548c\u6311\u6218\uff1a</p>\n<ol>\n<li>\u9759\u6001\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u56e0\u4e3a\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u91cc\u53ea\u4f1a\u52a0\u8f7d\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u6240\u4ee5\u6240\u6709\u5730\u5740\u90fd\u53ef\u4ee5\u9884\u5148\u7b97\u597d\uff0c\u4e0d\u7528\u62c5\u5fc3\u51fa\u73b0\u51b2\u7a81\uff1b\u800c\u52a8\u6001\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u540c\u4e00\u4e2a\u52a8\u6001\u5e93\u6ca1\u529e\u6cd5\u4fdd\u8bc1\u603b\u662f\u6620\u5c04\u5230\u540c\u4e00\u4e2a\u5730\u5740\u4e0a\uff1a\u5982\u679c\u6bcf\u4e2a\u52a8\u6001\u5e93\u90fd\u5199\u6b7b\u4e86\u81ea\u5df1\u8981\u52a0\u8f7d\u5230\u7684\u5730\u5740\uff0c\u90a3\u4e48\u4e0d\u540c\u7684\u52a8\u6001\u5e93\u9009\u4e86\u540c\u6837\u7684\u5730\u5740\uff0c\u662f\u5426\u5c31\u610f\u5473\u7740\u4e0d\u80fd\u540c\u65f6\u7528\u8fd9\u4e24\u4e2a\u52a8\u6001\u5e93\u4e86\uff1f\u56e0\u6b64\u52a8\u6001\u5e93\u8981\u652f\u6301\u52a0\u8f7d\u5230\u4e0d\u540c\u7684\u5730\u5740\u4e0a\uff0c\u4e3a\u4e86\u8fbe\u5230\u8fd9\u4e2a\u76ee\u6807\uff0c\u5c31\u9700\u8981\u5728\u7f16\u8bd1\u52a8\u6001\u5e93\u7684\u65f6\u5019\uff0c\u4ee5 PIC\uff08Position Independent Code\uff0c\u4f4d\u7f6e\u65e0\u5173\u4ee3\u7801\uff09\u7684\u65b9\u5f0f\u7f16\u8bd1\uff0c\u4f7f\u5f97\u65e0\u8bba\u52a8\u6001\u5e93\u52a0\u8f7d\u5230\u54ea\u91cc\uff0c\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u3002\u4e0b\u9762\u4f1a\u7ed9\u51fa\u4e00\u4e2a\u4f8b\u5b50</li>\n<li>\u7531\u4e8e\u7a0b\u5e8f\u6bcf\u6b21\u542f\u52a8\u90fd\u9700\u8981\u52a8\u6001\u94fe\u63a5\uff0c\u90a3\u4e48\u52a8\u6001\u94fe\u63a5\u7684\u6027\u80fd\u5c31\u8981\u5c3d\u91cf\u597d\uff1b\u4e3a\u4e86\u8fbe\u5230\u8fd9\u4e2a\u76ee\u7684\uff0c\u540e\u9762\u4f1a\u770b\u5230\u9759\u6001\u94fe\u63a5\u5668\u548c\u52a8\u6001\u94fe\u63a5\u5668\u662f\u5982\u4f55\u914d\u5408\u7740\u63d0\u9ad8\u6027\u80fd\u7684</li>\n</ol>\n<h3 id=\"\u751f\u6210\u52a8\u6001\u5e93\">\u751f\u6210\u52a8\u6001\u5e93<a class=\"headerlink\" href=\"#\u751f\u6210\u52a8\u6001\u5e93\" title=\"Permanent link\">&para;</a></h3>\n<p>\u56de\u987e\u4e00\u4e0b\uff0c\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u628a\u4ee3\u7801\u5206\u6210\u4e86\u4e24\u90e8\u5206\uff1a<code>main.s</code> \u548c <code>printer.s</code>\uff0c\u524d\u8005\u8c03\u7528\u540e\u8005\u5b9e\u73b0\u7684 <code>print</code> \u548c <code>exit</code> \u51fd\u6570\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\"># https://gist.github.com/adrianratnapala/1321776</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"c1\"># printer.s</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.rodata</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"nl\">hello:</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"w\">    </span><span class=\"na\">.string</span><span class=\"w\"> </span><span class=\"s\">&quot;Hello world!\\n&quot;</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">print</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"nl\">print:</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a><span class=\"w\">    </span><span class=\"c1\"># write(1, hello, 13)</span>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$hello</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">exit</span>\n</span><span id=\"__span-0-20\"><a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\" href=\"#__codelineno-0-20\"></a><span class=\"nl\">exit:</span>\n</span><span id=\"__span-0-21\"><a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\" href=\"#__codelineno-0-21\"></a><span class=\"w\">    </span><span class=\"c1\"># _exit(0)</span>\n</span><span id=\"__span-0-22\"><a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\" href=\"#__codelineno-0-22\"></a><span class=\"w\">    </span><span class=\"nf\">xor</span><span class=\"w\">     </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-0-23\"><a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\" href=\"#__codelineno-0-23\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-0-24\"><a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\" href=\"#__codelineno-0-24\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span></code></pre></div>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\"># main.s</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">_start</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"nl\">_start:</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">print</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">exit</span>\n</span></code></pre></div>\n<p>\u90a3\u4e48\u6211\u4eec\u5c31\u60f3\u628a <code>printer.s</code> \u7f16\u8bd1\u6210\u4e00\u4e2a\u52a8\u6001\u5e93 <code>libprinter.so</code>\uff0c\u7136\u540e <code>main.s</code> \u7f16\u8bd1\u6210\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u52a8\u6001\u94fe\u63a5\u5230 <code>libprinter.so</code>\u3002\u4e3a\u4e86\u751f\u6210\u52a8\u6001\u94fe\u63a5\u5e93\uff0c\u9700\u8981\u4e3a <code>ld</code> \u6dfb\u52a0 <code>-shared</code> \u547d\u4ee4\u884c\u53c2\u6570\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>main.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>main.o\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>printer.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>printer.o\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"c1\"># ld -shared: generate shared library</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>-shared<span class=\"w\"> </span>printer.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libprinter.so\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a>ld:<span class=\"w\"> </span>printer.o:<span class=\"w\"> </span>relocation<span class=\"w\"> </span>R_X86_64_32S<span class=\"w\"> </span>against<span class=\"w\"> </span><span class=\"sb\">`</span>.rodata<span class=\"err\">&#39;</span><span class=\"w\"> </span>can<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>used<span class=\"w\"> </span>when<span class=\"w\"> </span>making<span class=\"w\"> </span>a<span class=\"w\"> </span>shared<span class=\"w\"> </span>object<span class=\"p\">;</span><span class=\"w\"> </span>recompile<span class=\"w\"> </span>with<span class=\"w\"> </span>-fPIC\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a>ld:<span class=\"w\"> </span>failed<span class=\"w\"> </span>to<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>dynamic<span class=\"w\"> </span>section<span class=\"w\"> </span>sizes:<span class=\"w\"> </span>bad<span class=\"w\"> </span>value\n</span></code></pre></div>\n<p>\u548c\u5f80\u5e38\u4e00\u6837\uff0c\u6211\u4eec\u5206\u522b\u4e3a <code>main.s</code> \u548c <code>printer.s</code> \u8c03\u7528\u6c47\u7f16\u5668 <code>as</code>\uff0c\u4f46\u8fd9\u6b21\uff0c\u5355\u72ec\u7528 <code>printer.o</code> \u94fe\u63a5\u51fa\u52a8\u6001\u5e93 <code>libprinter.so</code>\uff0c\u4e0d\u5e78\u7684\u662f\uff0c\u5b83\u62a5\u9519\u4e86\uff0c\u544a\u8bc9\u6211\u4eec\u751f\u6210\u52a8\u6001\u5e93\u7684\u65f6\u5019\uff0c\u4e0d\u5141\u8bb8\u51fa\u73b0 <code>R_X86_64_32S</code> \u7684 relocation \u7c7b\u578b\uff1a<code>ld: printer.o: relocation R_X86_64_32S against ``.rodata' can not be used when making a shared object</code>\u3002\u56de\u5fc6\u7b2c\u4e00\u7bc7\u535a\u5ba2\uff0c<code>R_X86_64_32S</code> \u7684\u610f\u601d\u662f\u628a\u76ee\u7684\u7b26\u53f7\u7684\u7edd\u5bf9\u5730\u5740\u4ee5 32 \u4f4d\u6709\u7b26\u53f7\u6570\u7684\u5f62\u5f0f\u586b\u5199\uff0c\u4f46\u524d\u9762\u4e5f\u63d0\u5230\uff0c\u52a8\u6001\u5e93\u662f\u65e0\u6cd5\u63d0\u524d\u77e5\u9053\u81ea\u5df1\u4f1a\u88ab\u52a0\u8f7d\u5230\u54ea\u4e2a\u5730\u5740\u4e0a\u7684\uff0c\u94fe\u63a5\u5668\u6ca1\u529e\u6cd5\u63d0\u524d\u77e5\u9053\u76ee\u7684\u7b26\u53f7\u7684\u7edd\u5bf9\u5730\u5740\u3002\u8fd9\u8bf4\u660e\u6211\u4eec\u9700\u8981\u628a <code>printer.s</code> \u6539\u5199\u6210\u53ea\u7528\u76f8\u5bf9\u5730\u5740\uff0c\u4e0d\u7528\u7edd\u5bf9\u5730\u5740\uff0c\u8fd9\u6837\u5c31\u6210\u4e3a\u4f4d\u7f6e\u65e0\u5173\u4ee3\u7801\uff08PIC\uff09\u4e86\u3002\u94fe\u63a5\u5668\u8fd8\u8d34\u5fc3\u5730\u544a\u8bc9\u6211\u4eec\uff0c\u53ef\u4ee5\u7ed9\u7f16\u8bd1\u5668\u4f20 <code>-fPIC</code> \u53c2\u6570\u6765\u8ba9\u7f16\u8bd1\u5668\u5728\u7f16\u8bd1 C \u4ee3\u7801\u7684\u65f6\u5019\u751f\u6210\u4f4d\u7f6e\u65e0\u5173\u4ee3\u7801\uff08PIC\uff09\u3002\u4e0d\u8fc7\u6211\u4eec\u6b63\u5728\u624b\u5199\u6c47\u7f16\uff0c\u90a3\u5c31\u5fc5\u987b\u624b\u52a8\u6539\u5199\u6210\u4f4d\u7f6e\u65e0\u5173\u4ee3\u7801\u4e86\uff0c\u600e\u4e48\u6539\u5462\uff1f</p>\n<p>\u65e2\u7136\u4e0d\u5141\u8bb8\u51fa\u73b0\u7684\u662f <code>R_X86_64_32S</code>\uff0c\u6211\u4eec\u8981\u627e\u5230\u4ea7\u751f\u8fd9\u4e2a relocation \u7684\u6c47\u7f16\u4ee3\u7801\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$hello</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u76ee\u7684\u662f\u628a <code>hello</code> \u7684\u5730\u5740\u5199\u5230 <code>%rsi</code> \u5bc4\u5b58\u5668\u4e2d\uff0c\u4f46\u662f\u8fd9\u4e2a\u5199\u6cd5\u4f1a\u8981\u6c42\u94fe\u63a5\u5668\u4ee5\u7acb\u5373\u6570\u7684\u5f62\u5f0f\u628a\u7edd\u5bf9\u5730\u5740\u5199\u8fdb\u53bb\u3002\u800c\u6211\u4eec\u60f3\u8981\u7684\u662f\u5730\u5740\u65e0\u5173\u4ee3\u7801\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u7528\u5230\u76f8\u5bf9\u5730\u5740\u3002\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u5728\u4ec0\u4e48\u5730\u65b9\u51fa\u73b0\u4e86\u76f8\u5bf9\u5730\u5740\uff1f\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c<code>main.s</code> \u8c03\u7528 <code>print</code> \u548c <code>exit</code> \u65f6\u7528\u5230\u4e86 <code>R_X86_64_PC32</code>\uff0c\u5b83\u7684\u7acb\u5373\u6570\u8bb0\u5f55\u7684\u662f\u76f8\u5bf9\u5730\u5740\u504f\u79fb\u3002\u5982\u679c\u5728\u8fd9\u91cc\uff0c\u4e5f\u8ba9\u94fe\u63a5\u5668\u751f\u6210\u4e00\u4e2a\u76f8\u5bf9\u7684 relocation\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5730\u5740\u65e0\u5173\u4e86\uff0c\u8fd9\u6761\u6307\u4ee4\u662f\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"w\">    </span><span class=\"nf\">lea</span><span class=\"w\">     </span><span class=\"no\">hello</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span></code></pre></div>\n<p><code>lea</code> \u662f x86 \u7684 LEA\uff08Load Effective Address\uff09\u6307\u4ee4\uff0c\u5b83\u7684\u529f\u80fd\u662f\u8ba1\u7b97 <code>%rip</code> \u52a0\u7acb\u5373\u6570\u7684\u503c\uff0c\u5199\u5165\u5230 <code>%rsi</code> \u7684\u503c\uff0c\u800c\u8fd9\u4e2a\u7acb\u5373\u6570\u5c31\u662f <code>hello</code> \u76f8\u5bf9\u4e8e <code>%rip</code> \u7684\u76f8\u5bf9\u5730\u5740\u504f\u79fb\u3002\u5f88\u9057\u61be\uff0c\u6c47\u7f16\u5668\u6ca1\u529e\u6cd5\u5e2e\u6211\u4eec\u505a\u8fd9\u4e2a\u6539\u5199\uff0c\u5fc5\u987b\u5728\u5199\u4ee3\u7801\u7684\u65f6\u5019\u5c31\u60f3\u7740\u8981\u5199\u5730\u5740\u65e0\u5173\u4ee3\u7801\u3002\u6539\u5199\u540e\u7684 <code>printer.s</code> \u5982\u4e0b\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"c1\"># https://gist.github.com/adrianratnapala/1321776</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"c1\"># printer.s</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.rodata</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"nl\">hello:</span>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"w\">    </span><span class=\"na\">.string</span><span class=\"w\"> </span><span class=\"s\">&quot;Hello world!\\n&quot;</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">print</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"nl\">print:</span>\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">    </span><span class=\"c1\"># write(1, hello, 13)</span>\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-5-13\"><a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\" href=\"#__codelineno-5-13\"></a><span class=\"w\">    </span><span class=\"c1\"># this instruction requires absolute addressing</span>\n</span><span id=\"__span-5-14\"><a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\" href=\"#__codelineno-5-14\"></a><span class=\"w\">    </span><span class=\"c1\"># mov     $hello, %rsi</span>\n</span><span id=\"__span-5-15\"><a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\" href=\"#__codelineno-5-15\"></a><span class=\"w\">    </span><span class=\"c1\"># this one is position independent</span>\n</span><span id=\"__span-5-16\"><a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\" href=\"#__codelineno-5-16\"></a><span class=\"w\">    </span><span class=\"nf\">lea</span><span class=\"w\">     </span><span class=\"no\">hello</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-5-17\"><a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\" href=\"#__codelineno-5-17\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span>\n</span><span id=\"__span-5-18\"><a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\" href=\"#__codelineno-5-18\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-5-19\"><a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\" href=\"#__codelineno-5-19\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span><span id=\"__span-5-20\"><a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\" href=\"#__codelineno-5-20\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-5-21\"><a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\" href=\"#__codelineno-5-21\"></a>\n</span><span id=\"__span-5-22\"><a id=\"__codelineno-5-22\" name=\"__codelineno-5-22\" href=\"#__codelineno-5-22\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">exit</span>\n</span><span id=\"__span-5-23\"><a id=\"__codelineno-5-23\" name=\"__codelineno-5-23\" href=\"#__codelineno-5-23\"></a><span class=\"nl\">exit:</span>\n</span><span id=\"__span-5-24\"><a id=\"__codelineno-5-24\" name=\"__codelineno-5-24\" href=\"#__codelineno-5-24\"></a><span class=\"w\">    </span><span class=\"c1\"># _exit(0)</span>\n</span><span id=\"__span-5-25\"><a id=\"__codelineno-5-25\" name=\"__codelineno-5-25\" href=\"#__codelineno-5-25\"></a><span class=\"w\">    </span><span class=\"nf\">xor</span><span class=\"w\">     </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-5-26\"><a id=\"__codelineno-5-26\" name=\"__codelineno-5-26\" href=\"#__codelineno-5-26\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-5-27\"><a id=\"__codelineno-5-27\" name=\"__codelineno-5-27\" href=\"#__codelineno-5-27\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\uff0c\u5b83\u786e\u5b9e\u4ea7\u751f\u4e86\u4e00\u4e2a\u76f8\u5bf9\u7684 relocation <code>R_X86_64_PC32</code>\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>printer.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>printer.o\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>-r<span class=\"w\"> </span>printer.o\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a>printer.o:<span class=\"w\">     </span>file<span class=\"w\"> </span>format<span class=\"w\"> </span>elf64-x86-64\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a>\n</span><span id=\"__span-6-7\"><a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\" href=\"#__codelineno-6-7\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-6-8\"><a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\" href=\"#__codelineno-6-8\"></a>\n</span><span id=\"__span-6-9\"><a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\" href=\"#__codelineno-6-9\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;print&gt;:\n</span><span id=\"__span-6-10\"><a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\" href=\"#__codelineno-6-10\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rdi\n</span><span id=\"__span-6-11\"><a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\" href=\"#__codelineno-6-11\"></a><span class=\"w\">   </span><span class=\"m\">7</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span><span class=\"m\">35</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rsi<span class=\"w\">        </span><span class=\"c1\"># e &lt;print+0xe&gt;</span>\n</span><span id=\"__span-6-12\"><a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\" href=\"#__codelineno-6-12\"></a><span class=\"w\">                        </span>a:<span class=\"w\"> </span>R_X86_64_PC32<span class=\"w\">        </span>.rodata-0x4\n</span><span id=\"__span-6-13\"><a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\" href=\"#__codelineno-6-13\"></a><span class=\"w\">   </span>e:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c2<span class=\"w\"> </span>0d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>xd,%rdx\n</span><span id=\"__span-6-14\"><a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\" href=\"#__codelineno-6-14\"></a><span class=\"w\">  </span><span class=\"m\">15</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rax\n</span><span id=\"__span-6-15\"><a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\" href=\"#__codelineno-6-15\"></a><span class=\"w\">  </span>1c:<span class=\"w\">   </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span><span id=\"__span-6-16\"><a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\" href=\"#__codelineno-6-16\"></a><span class=\"w\">  </span>1e:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-6-17\"><a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\" href=\"#__codelineno-6-17\"></a>\n</span><span id=\"__span-6-18\"><a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\" href=\"#__codelineno-6-18\"></a>000000000000001f<span class=\"w\"> </span>&lt;exit&gt;:\n</span><span id=\"__span-6-19\"><a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\" href=\"#__codelineno-6-19\"></a><span class=\"w\">  </span>1f:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">31</span><span class=\"w\"> </span>ff<span class=\"w\">                </span>xor<span class=\"w\">    </span>%rdi,%rdi\n</span><span id=\"__span-6-20\"><a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\" href=\"#__codelineno-6-20\"></a><span class=\"w\">  </span><span class=\"m\">22</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span>3c<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x3c,%rax\n</span><span id=\"__span-6-21\"><a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\" href=\"#__codelineno-6-21\"></a><span class=\"w\">  </span><span class=\"m\">29</span>:<span class=\"w\">   </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span></code></pre></div>\n<p>\u867d\u7136\u7edd\u5bf9\u5730\u5740\u65e0\u6cd5\u786e\u5b9a\uff0c\u4f46\u9759\u6001\u94fe\u63a5\u5668\u4f9d\u7136\u53ef\u4ee5\u8ba1\u7b97\u51fa\u76f8\u5bf9\u5730\u5740\u504f\u79fb\uff0c\u5b8c\u6210 relocation \u7684\u8ba1\u7b97\u3002\u91cd\u65b0\u94fe\u63a5\uff0c\u53d1\u73b0\u5b83\u786e\u5b9e\u6210\u529f\u751f\u6210\u4e86\u52a8\u6001\u5e93\uff0c\u4e0d\u518d\u62a5\u9519\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>-shared<span class=\"w\"> </span>printer.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libprinter.so\n</span></code></pre></div>\n<h3 id=\"\u89c2\u5bdf\u52a8\u6001\u5e93\">\u89c2\u5bdf\u52a8\u6001\u5e93<a class=\"headerlink\" href=\"#\u89c2\u5bdf\u52a8\u6001\u5e93\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u5c31\u6765\u770b\u770b\u65b0\u751f\u6210\u7684 <code>libprinter.so</code> \u548c\u4e4b\u524d\u7684\u53ef\u6267\u884c\u6587\u4ef6\u6709\u4ec0\u4e48\u4e0d\u540c\uff0c\u9996\u5148\u662f <code>ELF Header</code> \u90e8\u5206\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a>$<span class=\"w\"> </span>readelf<span class=\"w\"> </span>-a<span class=\"w\"> </span>libprinter.so\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a>ELF<span class=\"w\"> </span>Header:\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"w\">  </span>Magic:<span class=\"w\">   </span>7f<span class=\"w\"> </span><span class=\"m\">45</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">46</span><span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"w\">  </span>Class:<span class=\"w\">                             </span>ELF64\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"w\">  </span>Data:<span class=\"w\">                              </span><span class=\"m\">2</span><span class=\"err\">&#39;</span>s<span class=\"w\"> </span>complement,<span class=\"w\"> </span>little<span class=\"w\"> </span>endian\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span>current<span class=\"o\">)</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"w\">  </span>OS/ABI:<span class=\"w\">                            </span>UNIX<span class=\"w\"> </span>-<span class=\"w\"> </span>System<span class=\"w\"> </span>V\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"w\">  </span>ABI<span class=\"w\"> </span>Version:<span class=\"w\">                       </span><span class=\"m\">0</span>\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a><span class=\"w\">  </span>Type:<span class=\"w\">                              </span>DYN<span class=\"w\"> </span><span class=\"o\">(</span>Shared<span class=\"w\"> </span>object<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a><span class=\"w\">  </span>Machine:<span class=\"w\">                           </span>Advanced<span class=\"w\"> </span>Micro<span class=\"w\"> </span>Devices<span class=\"w\"> </span>X86-64\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span>0x1\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a><span class=\"w\">  </span>Entry<span class=\"w\"> </span>point<span class=\"w\"> </span>address:<span class=\"w\">               </span>0x0\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">12584</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a><span class=\"w\">  </span>Flags:<span class=\"w\">                             </span>0x0\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>header:<span class=\"w\">               </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">56</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">6</span>\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">12</span>\n</span><span id=\"__span-8-21\"><a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\" href=\"#__codelineno-8-21\"></a><span class=\"w\">  </span>Section<span class=\"w\"> </span>header<span class=\"w\"> </span>string<span class=\"w\"> </span>table<span class=\"w\"> </span>index:<span class=\"w\"> </span><span class=\"m\">11</span>\n</span></code></pre></div>\n<p>\u548c\u53ef\u6267\u884c\u6587\u4ef6\u7684\u533a\u522b\u5728\u4e8e\uff0c<code>Type</code> \u662f <code>DYN (Shared object file)</code>\uff0c\u8868\u793a\u8fd9\u662f\u4e00\u4e2a\u52a8\u6001\u5e93\u6587\u4ef6\uff1b<code>Entry point address</code> \u7b49\u4e8e\u96f6\uff0c\u56e0\u4e3a\u52a8\u6001\u5e93\u6ca1\u6709\u5165\u53e3\uff0c\u5165\u53e3\u5730\u5740\u8fd8\u662f\u7531\u53ef\u6267\u884c\u7a0b\u5e8f\u63d0\u4f9b\u3002</p>\n<p>\u63a5\u4e0b\u6765\u662f Section \u90e8\u5206\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a>Section<span class=\"w\"> </span>Headers:\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"w\">  </span><span class=\"o\">[</span>Nr<span class=\"o\">]</span><span class=\"w\"> </span>Name<span class=\"w\">              </span>Type<span class=\"w\">             </span>Address<span class=\"w\">           </span>Offset\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"w\">       </span>Size<span class=\"w\">              </span>EntSize<span class=\"w\">          </span>Flags<span class=\"w\">  </span>Link<span class=\"w\">  </span>Info<span class=\"w\">  </span>Align\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\">                   </span>NULL<span class=\"w\">             </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00000000</span>\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span>\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span>.hash<span class=\"w\">             </span>HASH<span class=\"w\">             </span><span class=\"m\">0000000000000190</span><span class=\"w\">  </span><span class=\"m\">00000190</span>\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000018</span><span class=\"w\">  </span><span class=\"m\">0000000000000004</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">3</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-9-8\"><a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\" href=\"#__codelineno-9-8\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span>.gnu.hash<span class=\"w\">         </span>GNU_HASH<span class=\"w\">         </span>00000000000001a8<span class=\"w\">  </span>000001a8\n</span><span id=\"__span-9-9\"><a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\" href=\"#__codelineno-9-9\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000028</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">3</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-9-10\"><a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\" href=\"#__codelineno-9-10\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span>.dynsym<span class=\"w\">           </span>DYNSYM<span class=\"w\">           </span>00000000000001d0<span class=\"w\">  </span>000001d0\n</span><span id=\"__span-9-11\"><a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\" href=\"#__codelineno-9-11\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000048</span><span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">4</span><span class=\"w\">     </span><span class=\"m\">1</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-9-12\"><a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\" href=\"#__codelineno-9-12\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span>.dynstr<span class=\"w\">           </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000218</span><span class=\"w\">  </span><span class=\"m\">00000218</span>\n</span><span id=\"__span-9-13\"><a id=\"__codelineno-9-13\" name=\"__codelineno-9-13\" href=\"#__codelineno-9-13\"></a><span class=\"w\">       </span>000000000000000c<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-9-14\"><a id=\"__codelineno-9-14\" name=\"__codelineno-9-14\" href=\"#__codelineno-9-14\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span>.text<span class=\"w\">             </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000001000</span><span class=\"w\">  </span><span class=\"m\">00001000</span>\n</span><span id=\"__span-9-15\"><a id=\"__codelineno-9-15\" name=\"__codelineno-9-15\" href=\"#__codelineno-9-15\"></a><span class=\"w\">       </span>000000000000002b<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>AX<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-9-16\"><a id=\"__codelineno-9-16\" name=\"__codelineno-9-16\" href=\"#__codelineno-9-16\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">6</span><span class=\"o\">]</span><span class=\"w\"> </span>.rodata<span class=\"w\">           </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000002000</span><span class=\"w\">  </span><span class=\"m\">00002000</span>\n</span><span id=\"__span-9-17\"><a id=\"__codelineno-9-17\" name=\"__codelineno-9-17\" href=\"#__codelineno-9-17\"></a><span class=\"w\">       </span>000000000000000e<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-9-18\"><a id=\"__codelineno-9-18\" name=\"__codelineno-9-18\" href=\"#__codelineno-9-18\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">7</span><span class=\"o\">]</span><span class=\"w\"> </span>.eh_frame<span class=\"w\">         </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000002010</span><span class=\"w\">  </span><span class=\"m\">00002010</span>\n</span><span id=\"__span-9-19\"><a id=\"__codelineno-9-19\" name=\"__codelineno-9-19\" href=\"#__codelineno-9-19\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-9-20\"><a id=\"__codelineno-9-20\" name=\"__codelineno-9-20\" href=\"#__codelineno-9-20\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"o\">]</span><span class=\"w\"> </span>.dynamic<span class=\"w\">          </span>DYNAMIC<span class=\"w\">          </span>0000000000003f40<span class=\"w\">  </span>00002f40\n</span><span id=\"__span-9-21\"><a id=\"__codelineno-9-21\" name=\"__codelineno-9-21\" href=\"#__codelineno-9-21\"></a><span class=\"w\">       </span>00000000000000c0<span class=\"w\">  </span><span class=\"m\">0000000000000010</span><span class=\"w\">  </span>WA<span class=\"w\">       </span><span class=\"m\">4</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-9-22\"><a id=\"__codelineno-9-22\" name=\"__codelineno-9-22\" href=\"#__codelineno-9-22\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">9</span><span class=\"o\">]</span><span class=\"w\"> </span>.symtab<span class=\"w\">           </span>SYMTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00003000</span>\n</span><span id=\"__span-9-23\"><a id=\"__codelineno-9-23\" name=\"__codelineno-9-23\" href=\"#__codelineno-9-23\"></a><span class=\"w\">       </span>00000000000000a8<span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">          </span><span class=\"m\">10</span><span class=\"w\">     </span><span class=\"m\">5</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-9-24\"><a id=\"__codelineno-9-24\" name=\"__codelineno-9-24\" href=\"#__codelineno-9-24\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">10</span><span class=\"o\">]</span><span class=\"w\"> </span>.strtab<span class=\"w\">           </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>000030a8\n</span><span id=\"__span-9-25\"><a id=\"__codelineno-9-25\" name=\"__codelineno-9-25\" href=\"#__codelineno-9-25\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000025</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-9-26\"><a id=\"__codelineno-9-26\" name=\"__codelineno-9-26\" href=\"#__codelineno-9-26\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">11</span><span class=\"o\">]</span><span class=\"w\"> </span>.shstrtab<span class=\"w\">         </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>000030cd\n</span><span id=\"__span-9-27\"><a id=\"__codelineno-9-27\" name=\"__codelineno-9-27\" href=\"#__codelineno-9-27\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000056</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-9-28\"><a id=\"__codelineno-9-28\" name=\"__codelineno-9-28\" href=\"#__codelineno-9-28\"></a>Key<span class=\"w\"> </span>to<span class=\"w\"> </span>Flags:\n</span><span id=\"__span-9-29\"><a id=\"__codelineno-9-29\" name=\"__codelineno-9-29\" href=\"#__codelineno-9-29\"></a><span class=\"w\">  </span>W<span class=\"w\"> </span><span class=\"o\">(</span>write<span class=\"o\">)</span>,<span class=\"w\"> </span>A<span class=\"w\"> </span><span class=\"o\">(</span>alloc<span class=\"o\">)</span>,<span class=\"w\"> </span>X<span class=\"w\"> </span><span class=\"o\">(</span>execute<span class=\"o\">)</span>,<span class=\"w\"> </span>M<span class=\"w\"> </span><span class=\"o\">(</span>merge<span class=\"o\">)</span>,<span class=\"w\"> </span>S<span class=\"w\"> </span><span class=\"o\">(</span>strings<span class=\"o\">)</span>,<span class=\"w\"> </span>I<span class=\"w\"> </span><span class=\"o\">(</span>info<span class=\"o\">)</span>,\n</span><span id=\"__span-9-30\"><a id=\"__codelineno-9-30\" name=\"__codelineno-9-30\" href=\"#__codelineno-9-30\"></a><span class=\"w\">  </span>L<span class=\"w\"> </span><span class=\"o\">(</span>link<span class=\"w\"> </span>order<span class=\"o\">)</span>,<span class=\"w\"> </span>O<span class=\"w\"> </span><span class=\"o\">(</span>extra<span class=\"w\"> </span>OS<span class=\"w\"> </span>processing<span class=\"w\"> </span>required<span class=\"o\">)</span>,<span class=\"w\"> </span>G<span class=\"w\"> </span><span class=\"o\">(</span>group<span class=\"o\">)</span>,<span class=\"w\"> </span>T<span class=\"w\"> </span><span class=\"o\">(</span>TLS<span class=\"o\">)</span>,\n</span><span id=\"__span-9-31\"><a id=\"__codelineno-9-31\" name=\"__codelineno-9-31\" href=\"#__codelineno-9-31\"></a><span class=\"w\">  </span>C<span class=\"w\"> </span><span class=\"o\">(</span>compressed<span class=\"o\">)</span>,<span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"o\">(</span>unknown<span class=\"o\">)</span>,<span class=\"w\"> </span>o<span class=\"w\"> </span><span class=\"o\">(</span>OS<span class=\"w\"> </span>specific<span class=\"o\">)</span>,<span class=\"w\"> </span>E<span class=\"w\"> </span><span class=\"o\">(</span>exclude<span class=\"o\">)</span>,\n</span><span id=\"__span-9-32\"><a id=\"__codelineno-9-32\" name=\"__codelineno-9-32\" href=\"#__codelineno-9-32\"></a><span class=\"w\">  </span>D<span class=\"w\"> </span><span class=\"o\">(</span>mbind<span class=\"o\">)</span>,<span class=\"w\"> </span>l<span class=\"w\"> </span><span class=\"o\">(</span>large<span class=\"o\">)</span>,<span class=\"w\"> </span>p<span class=\"w\"> </span><span class=\"o\">(</span>processor<span class=\"w\"> </span>specific<span class=\"o\">)</span>\n</span><span id=\"__span-9-33\"><a id=\"__codelineno-9-33\" name=\"__codelineno-9-33\" href=\"#__codelineno-9-33\"></a>\n</span><span id=\"__span-9-34\"><a id=\"__codelineno-9-34\" name=\"__codelineno-9-34\" href=\"#__codelineno-9-34\"></a>There<span class=\"w\"> </span>are<span class=\"w\"> </span>no<span class=\"w\"> </span>section<span class=\"w\"> </span>groups<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>this<span class=\"w\"> </span>file.\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\u591a\u4e86\u51e0\u4e2a\u6ca1\u6709\u89c1\u5230\u8fc7\u7684 section\uff0c\u8fd9\u91cc\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\uff0c\u540e\u9762\u4f1a\u8be6\u7ec6\u89e3\u91ca\uff1a</p>\n<ol>\n<li><code>.hash</code> \u548c <code>.gnu.hash</code>\uff1a\u4ece\u540d\u5b57\u53ef\u4ee5\u731c\u51fa\u6765\uff0c\u8fd9\u662f\u67d0\u79cd\u54c8\u5e0c\u8868\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u63d0\u4f9b\u4e00\u4e2a\u7b26\u53f7\u540d\u5b57\u5230\u7b26\u53f7\u7684\u6620\u5c04\uff0c\u63d0\u9ad8\u52a8\u6001\u94fe\u63a5\u5668\u67e5\u627e\u7b26\u53f7\u7684\u6027\u80fd</li>\n<li><code>.dynsym</code>\uff1aDynamic Symbol\uff0c\u548c\u52a8\u6001\u94fe\u63a5\u6709\u5173\u7684\u52a8\u6001\u7b26\u53f7\u8868</li>\n<li><code>.dynstr</code>\uff1aDynamic String\uff0c\u548c\u52a8\u6001\u94fe\u63a5\u6709\u5173\u7684\u5b57\u7b26\u4e32\u7684\u8868</li>\n<li><code>.dynamic</code>\uff1aDynamic\uff0c\u5411\u52a8\u6001\u94fe\u63a5\u5668\u63d0\u4f9b\u4e86\u4e00\u4e9b\u4fe1\u606f</li>\n</ol>\n<p>\u6b64\u5916\uff0c\u8fd9\u4e9b\u6bb5\u7684\u5730\u5740\u90fd\u4ece 0 \u5f00\u59cb\uff0c\u800c\u4e0d\u662f\u53ef\u6267\u884c\u6587\u4ef6\u90a3\u6837\uff0c\u4ece 0x400000 \u5f00\u59cb\uff0c\u6bd5\u7adf\u52a8\u6001\u5e93\u662f\u53ef\u80fd\u88ab\u52a0\u8f7d\u5230\u4e0d\u540c\u5730\u5740\u4e0a\u7684\uff0c\u662f\u6ca1\u529e\u6cd5\u63d0\u524d\u786e\u5b9a\u7684\u3002</p>\n<p>\u63a5\u4e0b\u6765\u662f Program Header \u90e8\u5206\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"nf\">Program</span><span class=\"w\"> </span><span class=\"no\">Headers</span><span class=\"p\">:</span>\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a><span class=\"w\">  </span><span class=\"nf\">Type</span><span class=\"w\">           </span><span class=\"no\">Offset</span><span class=\"w\">             </span><span class=\"no\">VirtAddr</span><span class=\"w\">           </span><span class=\"no\">PhysAddr</span>\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a><span class=\"w\">                 </span><span class=\"nf\">FileSiz</span><span class=\"w\">            </span><span class=\"no\">MemSiz</span><span class=\"w\">              </span><span class=\"no\">Flags</span><span class=\"w\">  </span><span class=\"no\">Align</span>\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">  </span><span class=\"nf\">LOAD</span><span class=\"w\">           </span><span class=\"mi\">0x0000000000000000</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000000000</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000000000</span>\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a><span class=\"w\">                 </span><span class=\"err\">0</span><span class=\"nf\">x0000000000000224</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000000224</span><span class=\"w\">  </span><span class=\"no\">R</span><span class=\"w\">      </span><span class=\"mi\">0x1000</span>\n</span><span id=\"__span-10-6\"><a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\" href=\"#__codelineno-10-6\"></a><span class=\"w\">  </span><span class=\"nf\">LOAD</span><span class=\"w\">           </span><span class=\"mi\">0x0000000000001000</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000001000</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000001000</span>\n</span><span id=\"__span-10-7\"><a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\" href=\"#__codelineno-10-7\"></a><span class=\"w\">                 </span><span class=\"err\">0</span><span class=\"nf\">x000000000000002b</span><span class=\"w\"> </span><span class=\"mi\">0x000000000000002b</span><span class=\"w\">  </span><span class=\"no\">R</span><span class=\"w\"> </span><span class=\"no\">E</span><span class=\"w\">    </span><span class=\"mi\">0x1000</span>\n</span><span id=\"__span-10-8\"><a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\" href=\"#__codelineno-10-8\"></a><span class=\"w\">  </span><span class=\"nf\">LOAD</span><span class=\"w\">           </span><span class=\"mi\">0x0000000000002000</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000002000</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000002000</span>\n</span><span id=\"__span-10-9\"><a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\" href=\"#__codelineno-10-9\"></a><span class=\"w\">                 </span><span class=\"err\">0</span><span class=\"nf\">x0000000000000010</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000000010</span><span class=\"w\">  </span><span class=\"no\">R</span><span class=\"w\">      </span><span class=\"mi\">0x1000</span>\n</span><span id=\"__span-10-10\"><a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\" href=\"#__codelineno-10-10\"></a><span class=\"w\">  </span><span class=\"nf\">LOAD</span><span class=\"w\">           </span><span class=\"mi\">0x0000000000002f40</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000003f40</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000003f40</span>\n</span><span id=\"__span-10-11\"><a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\" href=\"#__codelineno-10-11\"></a><span class=\"w\">                 </span><span class=\"err\">0</span><span class=\"nf\">x00000000000000c0</span><span class=\"w\"> </span><span class=\"mi\">0x00000000000000c0</span><span class=\"w\">  </span><span class=\"no\">RW</span><span class=\"w\">     </span><span class=\"mi\">0x1000</span>\n</span><span id=\"__span-10-12\"><a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\" href=\"#__codelineno-10-12\"></a><span class=\"w\">  </span><span class=\"nf\">DYNAMIC</span><span class=\"w\">        </span><span class=\"mi\">0x0000000000002f40</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000003f40</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000003f40</span>\n</span><span id=\"__span-10-13\"><a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\" href=\"#__codelineno-10-13\"></a><span class=\"w\">                 </span><span class=\"err\">0</span><span class=\"nf\">x00000000000000c0</span><span class=\"w\"> </span><span class=\"mi\">0x00000000000000c0</span><span class=\"w\">  </span><span class=\"no\">RW</span><span class=\"w\">     </span><span class=\"mi\">0x8</span>\n</span><span id=\"__span-10-14\"><a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\" href=\"#__codelineno-10-14\"></a><span class=\"w\">  </span><span class=\"nf\">GNU_RELRO</span><span class=\"w\">      </span><span class=\"mi\">0x0000000000002f40</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000003f40</span><span class=\"w\"> </span><span class=\"mi\">0x0000000000003f40</span>\n</span><span id=\"__span-10-15\"><a id=\"__codelineno-10-15\" name=\"__codelineno-10-15\" href=\"#__codelineno-10-15\"></a><span class=\"w\">                 </span><span class=\"err\">0</span><span class=\"nf\">x00000000000000c0</span><span class=\"w\"> </span><span class=\"mi\">0x00000000000000c0</span><span class=\"w\">  </span><span class=\"no\">R</span><span class=\"w\">      </span><span class=\"mi\">0x1</span>\n</span><span id=\"__span-10-16\"><a id=\"__codelineno-10-16\" name=\"__codelineno-10-16\" href=\"#__codelineno-10-16\"></a>\n</span><span id=\"__span-10-17\"><a id=\"__codelineno-10-17\" name=\"__codelineno-10-17\" href=\"#__codelineno-10-17\"></a><span class=\"w\"> </span><span class=\"nf\">Section</span><span class=\"w\"> </span><span class=\"no\">to</span><span class=\"w\"> </span><span class=\"no\">Segment</span><span class=\"w\"> </span><span class=\"no\">mapping</span><span class=\"p\">:</span>\n</span><span id=\"__span-10-18\"><a id=\"__codelineno-10-18\" name=\"__codelineno-10-18\" href=\"#__codelineno-10-18\"></a><span class=\"w\">  </span><span class=\"nf\">Segment</span><span class=\"w\"> </span><span class=\"no\">Sections...</span>\n</span><span id=\"__span-10-19\"><a id=\"__codelineno-10-19\" name=\"__codelineno-10-19\" href=\"#__codelineno-10-19\"></a><span class=\"w\">   </span><span class=\"err\">00</span><span class=\"w\">     </span><span class=\"na\">.hash</span><span class=\"w\"> </span><span class=\"no\">.gnu.hash</span><span class=\"w\"> </span><span class=\"no\">.dynsym</span><span class=\"w\"> </span><span class=\"no\">.dynstr</span><span class=\"w\"> </span>\n</span><span id=\"__span-10-20\"><a id=\"__codelineno-10-20\" name=\"__codelineno-10-20\" href=\"#__codelineno-10-20\"></a><span class=\"w\">   </span><span class=\"mi\">01</span><span class=\"w\">     </span><span class=\"no\">.text</span><span class=\"w\"> </span>\n</span><span id=\"__span-10-21\"><a id=\"__codelineno-10-21\" name=\"__codelineno-10-21\" href=\"#__codelineno-10-21\"></a><span class=\"w\">   </span><span class=\"mi\">02</span><span class=\"w\">     </span><span class=\"no\">.rodata</span><span class=\"w\"> </span>\n</span><span id=\"__span-10-22\"><a id=\"__codelineno-10-22\" name=\"__codelineno-10-22\" href=\"#__codelineno-10-22\"></a><span class=\"w\">   </span><span class=\"mi\">03</span><span class=\"w\">     </span><span class=\"no\">.dynamic</span><span class=\"w\"> </span>\n</span><span id=\"__span-10-23\"><a id=\"__codelineno-10-23\" name=\"__codelineno-10-23\" href=\"#__codelineno-10-23\"></a><span class=\"w\">   </span><span class=\"mi\">04</span><span class=\"w\">     </span><span class=\"no\">.dynamic</span><span class=\"w\"> </span>\n</span><span id=\"__span-10-24\"><a id=\"__codelineno-10-24\" name=\"__codelineno-10-24\" href=\"#__codelineno-10-24\"></a><span class=\"w\">   </span><span class=\"mi\">05</span><span class=\"w\">     </span><span class=\"no\">.dynamic</span><span class=\"w\"> </span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u9664\u4e86\u5df2\u6709\u7684 <code>LOAD</code> \u4ee5\u5916\uff0c\u8fd8\u51fa\u73b0\u4e86\u65b0\u7684\u9879\u76ee\uff1a</p>\n<ol>\n<li><code>DYNAMIC</code>\uff1a\u544a\u8bc9\u52a8\u6001\u94fe\u63a5\u5668\uff0c<code>.dynamic</code> section \u5728\u54ea\u4e2a\u5730\u65b9</li>\n<li><code>GNU_RELRO</code>\uff1a\u8fd9\u662f GNU \u94fe\u63a5\u5668\u5b89\u5168\u6027\u6269\u5c55\uff0c\u610f\u601d\u662f\u5728\u52a8\u6001\u94fe\u63a5\u5668\u5b8c\u6210\u91cd\u5b9a\u4f4d\u540e\uff0c\u54ea\u4e9b\u5185\u5b58\u533a\u57df\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\uff0c\u9632\u6b62\u7a0b\u5e8f\u7be1\u6539</li>\n</ol>\n<p>\u7d27\u63a5\u7740\u5c31\u662f <code>.dynamic</code> section \u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a>Dynamic<span class=\"w\"> </span>section<span class=\"w\"> </span>at<span class=\"w\"> </span>offset<span class=\"w\"> </span>0x2f40<span class=\"w\"> </span>contains<span class=\"w\"> </span><span class=\"m\">7</span><span class=\"w\"> </span>entries:\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a><span class=\"w\">  </span>Tag<span class=\"w\">        </span>Type<span class=\"w\">                         </span>Name/Value\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"w\"> </span>0x0000000000000004<span class=\"w\"> </span><span class=\"o\">(</span>HASH<span class=\"o\">)</span><span class=\"w\">               </span>0x190\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"w\"> </span>0x000000006ffffef5<span class=\"w\"> </span><span class=\"o\">(</span>GNU_HASH<span class=\"o\">)</span><span class=\"w\">           </span>0x1a8\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\"> </span>0x0000000000000005<span class=\"w\"> </span><span class=\"o\">(</span>STRTAB<span class=\"o\">)</span><span class=\"w\">             </span>0x218\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\"> </span>0x0000000000000006<span class=\"w\"> </span><span class=\"o\">(</span>SYMTAB<span class=\"o\">)</span><span class=\"w\">             </span>0x1d0\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\"> </span>0x000000000000000a<span class=\"w\"> </span><span class=\"o\">(</span>STRSZ<span class=\"o\">)</span><span class=\"w\">              </span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\"> </span>0x000000000000000b<span class=\"w\"> </span><span class=\"o\">(</span>SYMENT<span class=\"o\">)</span><span class=\"w\">             </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\"> </span>0x0000000000000000<span class=\"w\"> </span><span class=\"o\">(</span>NULL<span class=\"o\">)</span><span class=\"w\">               </span>0x0\n</span></code></pre></div>\n<p>\u8868\u793a\u8fd9\u4e2a\u52a8\u6001\u5e93\u5411\u52a8\u6001\u94fe\u63a5\u5668\u63d0\u4f9b\u4e86\u4e00\u4e9b\u4f1a\u5728\u52a8\u6001\u94fe\u63a5\u4e2d\u7528\u5230\u7684\u4fe1\u606f\uff1a</p>\n<ol>\n<li><code>HASH</code>\uff1a<code>.hash</code> section \u7684\u5730\u5740</li>\n<li><code>GNU_HASH</code>\uff1a<code>.gnu.hash</code> section \u7684\u5730\u5740</li>\n<li><code>STRTAB</code>: <code>.dynstr</code> section \u7684\u5730\u5740</li>\n<li><code>SYMTAB</code>: <code>.dynsym</code> section \u7684\u5730\u5740</li>\n<li><code>STRSZ</code>: <code>.dynstr</code> section \u7684\u5927\u5c0f</li>\n<li><code>SYMENT</code>: <code>.dynsym</code> \u6bcf\u4e00\u9879\u7684\u5927\u5c0f</li>\n<li><code>NULL</code>: \u8868\u793a\u540e\u9762\u6ca1\u6709\u66f4\u591a\u5185\u5bb9\u4e86</li>\n</ol>\n<p>\u4f60\u53ef\u80fd\u4f1a\u5947\u602a\uff0c\u8fd9\u91cc\u9762\u7684\u5730\u5740\u548c\u5927\u5c0f\u4fe1\u606f\uff0c\u5176\u5b9e\u90fd\u53ef\u4ee5\u4ece Section Headers \u91cc\u627e\u5230\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u591a\u6b64\u4e00\u4e3e\uff0c\u653e\u5230\u8fd9\u91cc\u5462\uff1f\u9996\u5148\uff0c\u8fd9\u91cc\u53ef\u4ee5\u5b58\u7684\u4e1c\u897f\u8fd8\u6709\u5f88\u591a\uff0c\u4e0d\u6b62\u662f\u8fd9\u4e9b\uff0c\u540e\u7eed\u4f1a\u770b\u5230\u66f4\u591a\u7684\u4f8b\u5b50\uff08\u4f8b\u5982 <code>DT_NEEDED</code>\uff0c<code>DT_SONAME</code>\uff0c<code>DT_RPATH</code> \u7b49\u7b49\uff09\uff1b\u5176\u6b21\uff0c\u524d\u6587\u63d0\u5230\uff0c\u52a8\u6001\u94fe\u63a5\u7684\u6027\u80fd\u8981\u6c42\u662f\u6bd4\u8f83\u9ad8\u7684\uff0c\u4e3a\u4e86\u51cf\u5c11\u5b83\u89e3\u6790 ELF \u7684\u8d1f\u62c5\uff0c\u63d0\u524d\u628a\u8981\u7528\u7684\u6570\u636e\u51c6\u5907\u597d\u3002</p>\n<p>\u4e0b\u9762\u662f relocation \u7684\u90e8\u5206\uff0c\u4e0d\u51fa\u610f\u6599\uff0c\u6ca1\u6709 relocation\uff0c\u56e0\u4e3a\u9759\u6001\u94fe\u63a5\u5668\u5df2\u7ecf\u628a <code>printer.s</code> \u91cc\u6d89\u53ca\u5230\u7684 relocation \u90fd\u8ba1\u7b97\u5b8c\u6210\u4e86\u3002</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a>There<span class=\"w\"> </span>are<span class=\"w\"> </span>no<span class=\"w\"> </span>relocations<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>this<span class=\"w\"> </span>file.\n</span><span id=\"__span-12-2\"><a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\" href=\"#__codelineno-12-2\"></a>No<span class=\"w\"> </span>processor<span class=\"w\"> </span>specific<span class=\"w\"> </span>unwind<span class=\"w\"> </span>information<span class=\"w\"> </span>to<span class=\"w\"> </span>decode\n</span></code></pre></div>\n<p>\u63a5\u4e0b\u6765\u662f\u7b26\u53f7\u8868\uff0c\u6709\u4e24\u4efd\uff0c<code>.dynsym</code> \u662f\u52a8\u6001\u7b26\u53f7\u8868\uff0c<code>.symtab</code> \u662f\u539f\u6765\u9759\u6001\u94fe\u63a5\u4f7f\u7528\u7684\u7b26\u53f7\u8868\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a>Symbol<span class=\"w\"> </span>table<span class=\"w\"> </span><span class=\"s1\">&#39;.dynsym&#39;</span><span class=\"w\"> </span>contains<span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span>entries:\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a><span class=\"w\">   </span>Num:<span class=\"w\">    </span>Value<span class=\"w\">          </span>Size<span class=\"w\"> </span>Type<span class=\"w\">    </span>Bind<span class=\"w\">   </span>Vis<span class=\"w\">      </span>Ndx<span class=\"w\"> </span>Name\n</span><span id=\"__span-13-3\"><a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\" href=\"#__codelineno-13-3\"></a><span class=\"w\">     </span><span class=\"m\">0</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">  </span>UND<span class=\"w\"> </span>\n</span><span id=\"__span-13-4\"><a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\" href=\"#__codelineno-13-4\"></a><span class=\"w\">     </span><span class=\"m\">1</span>:<span class=\"w\"> </span><span class=\"m\">0000000000001000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>GLOBAL<span class=\"w\"> </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">5</span><span class=\"w\"> </span>print\n</span><span id=\"__span-13-5\"><a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\" href=\"#__codelineno-13-5\"></a><span class=\"w\">     </span><span class=\"m\">2</span>:<span class=\"w\"> </span>000000000000101f<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>GLOBAL<span class=\"w\"> </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"nb\">exit</span>\n</span><span id=\"__span-13-6\"><a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\" href=\"#__codelineno-13-6\"></a>\n</span><span id=\"__span-13-7\"><a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\" href=\"#__codelineno-13-7\"></a>Symbol<span class=\"w\"> </span>table<span class=\"w\"> </span><span class=\"s1\">&#39;.symtab&#39;</span><span class=\"w\"> </span>contains<span class=\"w\"> </span><span class=\"m\">7</span><span class=\"w\"> </span>entries:\n</span><span id=\"__span-13-8\"><a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\" href=\"#__codelineno-13-8\"></a><span class=\"w\">   </span>Num:<span class=\"w\">    </span>Value<span class=\"w\">          </span>Size<span class=\"w\"> </span>Type<span class=\"w\">    </span>Bind<span class=\"w\">   </span>Vis<span class=\"w\">      </span>Ndx<span class=\"w\"> </span>Name\n</span><span id=\"__span-13-9\"><a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\" href=\"#__codelineno-13-9\"></a><span class=\"w\">     </span><span class=\"m\">0</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">  </span>UND<span class=\"w\"> </span>\n</span><span id=\"__span-13-10\"><a id=\"__codelineno-13-10\" name=\"__codelineno-13-10\" href=\"#__codelineno-13-10\"></a><span class=\"w\">     </span><span class=\"m\">1</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>FILE<span class=\"w\">    </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">  </span>ABS<span class=\"w\"> </span>printer.o\n</span><span id=\"__span-13-11\"><a id=\"__codelineno-13-11\" name=\"__codelineno-13-11\" href=\"#__codelineno-13-11\"></a><span class=\"w\">     </span><span class=\"m\">2</span>:<span class=\"w\"> </span><span class=\"m\">0000000000002000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">6</span><span class=\"w\"> </span>hello\n</span><span id=\"__span-13-12\"><a id=\"__codelineno-13-12\" name=\"__codelineno-13-12\" href=\"#__codelineno-13-12\"></a><span class=\"w\">     </span><span class=\"m\">3</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>FILE<span class=\"w\">    </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">  </span>ABS<span class=\"w\"> </span>\n</span><span id=\"__span-13-13\"><a id=\"__codelineno-13-13\" name=\"__codelineno-13-13\" href=\"#__codelineno-13-13\"></a><span class=\"w\">     </span><span class=\"m\">4</span>:<span class=\"w\"> </span>0000000000003f40<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>OBJECT<span class=\"w\">  </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">8</span><span class=\"w\"> </span>_DYNAMIC\n</span><span id=\"__span-13-14\"><a id=\"__codelineno-13-14\" name=\"__codelineno-13-14\" href=\"#__codelineno-13-14\"></a><span class=\"w\">     </span><span class=\"m\">5</span>:<span class=\"w\"> </span><span class=\"m\">0000000000001000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>GLOBAL<span class=\"w\"> </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">5</span><span class=\"w\"> </span>print\n</span><span id=\"__span-13-15\"><a id=\"__codelineno-13-15\" name=\"__codelineno-13-15\" href=\"#__codelineno-13-15\"></a><span class=\"w\">     </span><span class=\"m\">6</span>:<span class=\"w\"> </span>000000000000101f<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>GLOBAL<span class=\"w\"> </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"nb\">exit</span>\n</span></code></pre></div>\n<p>\u89c2\u5bdf\u53ef\u4ee5\u53d1\u73b0\uff0c<code>.dynsym</code> \u53ea\u4fdd\u7559\u4e86\u90a3\u4e9b\u5916\u90e8\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u7528\u5230\u7684\u7b26\u53f7\uff08<code>Bind=GLOBAL</code>\uff09\uff0c\u4e5f\u5c31\u662f <code>print</code> \u548c <code>exit</code>\uff0c\u800c\u5185\u90e8\u81ea\u5df1\u7528\u7684 <code>hello</code> \u6ca1\u6709\u653e\u5728\u91cc\u9762\uff0c\u53ea\u4fdd\u7559\u53ef\u80fd\u8981\u7528\u5230\u7684\u4e1c\u897f\uff0c\u7ed9\u52a8\u6001\u94fe\u63a5\u5668\u51cf\u8d1f\u3002\u6b64\u5916\uff0c<code>.symtab</code> \u8fd8\u4f1a\u591a\u51fa\u4e00\u4e2a <code>_DYNAMIC</code> \u7b26\u53f7\uff0c\u6307\u5411 <code>.dynamic</code> section\u3002</p>\n<p>\u6700\u540e\uff0c<code>readelf</code> \u8fd8\u8d34\u5fc3\u5730\u8ba1\u7b97\u4e86\u4e00\u4e0b\u54c8\u5e0c\u8868\u7684\u5e73\u5747\u67e5\u8be2\u6b21\u6570\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a>Histogram<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>bucket<span class=\"w\"> </span>list<span class=\"w\"> </span>length<span class=\"w\"> </span><span class=\"o\">(</span>total<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>bucket<span class=\"o\">)</span>:\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a><span class=\"w\"> </span>Length<span class=\"w\">  </span>Number<span class=\"w\">     </span>%<span class=\"w\"> </span>of<span class=\"w\"> </span>total<span class=\"w\">  </span>Coverage\n</span><span id=\"__span-14-3\"><a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\" href=\"#__codelineno-14-3\"></a><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">          </span><span class=\"o\">(</span><span class=\"w\">  </span><span class=\"m\">0</span>.0%<span class=\"o\">)</span>\n</span><span id=\"__span-14-4\"><a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\" href=\"#__codelineno-14-4\"></a><span class=\"w\">      </span><span class=\"m\">1</span><span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">          </span><span class=\"o\">(</span><span class=\"w\">  </span><span class=\"m\">0</span>.0%<span class=\"o\">)</span><span class=\"w\">      </span><span class=\"m\">0</span>.0%\n</span><span id=\"__span-14-5\"><a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\" href=\"#__codelineno-14-5\"></a><span class=\"w\">      </span><span class=\"m\">2</span><span class=\"w\">  </span><span class=\"m\">1</span><span class=\"w\">          </span><span class=\"o\">(</span><span class=\"m\">100</span>.0%<span class=\"o\">)</span><span class=\"w\">    </span><span class=\"m\">100</span>.0%\n</span><span id=\"__span-14-6\"><a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\" href=\"#__codelineno-14-6\"></a>\n</span><span id=\"__span-14-7\"><a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\" href=\"#__codelineno-14-7\"></a>Histogram<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"sb\">`</span>.gnu.hash<span class=\"err\">&#39;</span><span class=\"w\"> </span>bucket<span class=\"w\"> </span>list<span class=\"w\"> </span>length<span class=\"w\"> </span><span class=\"o\">(</span>total<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>buckets<span class=\"o\">)</span>:\n</span><span id=\"__span-14-8\"><a id=\"__codelineno-14-8\" name=\"__codelineno-14-8\" href=\"#__codelineno-14-8\"></a><span class=\"w\"> </span>Length<span class=\"w\">  </span>Number<span class=\"w\">     </span>%<span class=\"w\"> </span>of<span class=\"w\"> </span>total<span class=\"w\">  </span>Coverage\n</span><span id=\"__span-14-9\"><a id=\"__codelineno-14-9\" name=\"__codelineno-14-9\" href=\"#__codelineno-14-9\"></a><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">          </span><span class=\"o\">(</span><span class=\"w\">  </span><span class=\"m\">0</span>.0%<span class=\"o\">)</span>\n</span><span id=\"__span-14-10\"><a id=\"__codelineno-14-10\" name=\"__codelineno-14-10\" href=\"#__codelineno-14-10\"></a><span class=\"w\">      </span><span class=\"m\">1</span><span class=\"w\">  </span><span class=\"m\">2</span><span class=\"w\">          </span><span class=\"o\">(</span><span class=\"m\">100</span>.0%<span class=\"o\">)</span><span class=\"w\">    </span><span class=\"m\">100</span>.0%\n</span><span id=\"__span-14-11\"><a id=\"__codelineno-14-11\" name=\"__codelineno-14-11\" href=\"#__codelineno-14-11\"></a>\n</span><span id=\"__span-14-12\"><a id=\"__codelineno-14-12\" name=\"__codelineno-14-12\" href=\"#__codelineno-14-12\"></a>No<span class=\"w\"> </span>version<span class=\"w\"> </span>information<span class=\"w\"> </span>found<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>this<span class=\"w\"> </span>file.\n</span></code></pre></div>\n<p>\u540e\u9762\u4f1a\u518d\u7ec6\u8bb2\u4e00\u4e0b\u5b83\u6240\u91c7\u7528\u7684\u54c8\u5e0c\u8868\u7684\u67b6\u6784\u3002</p>\n<p>\u7ed3\u5408\u4e0a\u9762\u7684\u89c2\u5bdf\uff0c\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u521d\u6b65\u7684\u5370\u8c61\uff0c\u6bd4\u8f83\u751f\u6210\u53ef\u6267\u884c\u6587\u4ef6\u4e0e\u751f\u6210\u52a8\u6001\u94fe\u63a5\u5e93\u7684\u533a\u522b\uff1a</p>\n<ol>\n<li>ELF \u6587\u4ef6\u7c7b\u578b\u4e0d\u540c\uff0cDYN (Shared object file) vs EXEC (Executable file)</li>\n<li>\u52a8\u6001\u5e93\u6709\u989d\u5916\u7684\u4e00\u5957\u7528\u4e8e\u52a8\u6001\u94fe\u63a5\u7684 section\uff0c\u5305\u62ec\u52a8\u6001\u7684\u7b26\u53f7\u8868\uff0c\u52a8\u6001\u7684\u5b57\u7b26\u4e32\u8868\uff0c\u52a8\u6001\u8868\uff08<code>.dynamic</code>\uff09\uff0c\u4ee5\u53ca\u54c8\u5e0c\u8868\uff08\u5b9e\u73b0\u7b26\u53f7\u540d\u79f0\u5230\u7b26\u53f7\u7684\u6620\u5c04\uff09</li>\n<li>\u52a8\u6001\u5e93\u7684\u52a0\u8f7d\u5730\u5740\u4e0d\u786e\u5b9a\uff0c\u5728 ELF \u4e2d\u4ece 0 \u5f00\u59cb\u8ba1\u7b97\uff0c\u9700\u8981\u5730\u5740\u65e0\u5173\u4ee3\u7801</li>\n</ol>\n<h3 id=\"\u4f7f\u7528\u52a8\u6001\u5e93\">\u4f7f\u7528\u52a8\u6001\u5e93<a class=\"headerlink\" href=\"#\u4f7f\u7528\u52a8\u6001\u5e93\" title=\"Permanent link\">&para;</a></h3>\n<p>\u751f\u6210\u52a8\u6001\u5e93 <code>libprinter.so</code> \u4ee5\u540e\uff0c\u6700\u540e\u8fd8\u9700\u8981\u8ba9 <code>main.o</code> \u52a8\u6001\u94fe\u63a5 <code>libprinter.so</code>\uff0c\u5e76\u8fd0\u884c\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"c1\"># ld -dynamic-linker: Set path to dynamic linker for the executable</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>-dynamic-linker<span class=\"w\"> </span>/lib64/ld-linux-x86-64.so.2<span class=\"w\"> </span>main.o<span class=\"w\"> </span>libprinter.so<span class=\"w\"> </span>-o<span class=\"w\"> </span>main\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a>$<span class=\"w\"> </span><span class=\"nv\">LD_LIBRARY_PATH</span><span class=\"o\">=</span><span class=\"nv\">$PWD</span><span class=\"w\"> </span>./main\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a>Hello<span class=\"w\"> </span>world!\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u7279\u522b\u6307\u5b9a\u4e86 <code>main</code> \u7684\u52a8\u6001\u94fe\u63a5\u5668\u8def\u5f84\u4e3a <code>/lib64/ld-linux-x86-64.so.2</code>\uff0c\u8fd9\u662f\u56e0\u4e3a <code>main</code> \u5728\u542f\u52a8\u65f6\uff0c\u9700\u8981\u7531\u52a8\u6001\u94fe\u63a5\u5668\u6765\u5b8c\u6210\u6700\u540e\u7684\u52a8\u6001\u94fe\u63a5\uff0c\u90a3\u4e48\u7528\u54ea\u4e2a\u52a8\u6001\u94fe\u63a5\u5668\u53bb\u505a\u8fd9\u4e2a\u4e8b\u60c5\u5462\uff1f\u8fd9\u91cc\u5c31\u662f\u5728\u6307\u5b9a\u52a8\u6001\u94fe\u63a5\u5668\u7684\u8def\u5f84\u3002\u542f\u52a8 <code>main</code> \u7a0b\u5e8f\u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u627e\u5230\u5f53\u524d\u76ee\u5f55\u4e0b\u7684 <code>libprinter.so</code>\uff0c\u6dfb\u52a0\u4e86\u73af\u5883\u53d8\u91cf <code>LD_LIBRARY_PATH</code> \u5e76\u8bbe\u7f6e\u4e3a\u5f53\u524d\u76ee\u5f55\u3002\u8fd9\u6837 <code>main</code> \u7a0b\u5e8f\u5c31\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u8d77\u6765\u4e86\u3002</p>\n<p>\u867d\u7136 <code>libprinter.so</code> \u51fa\u73b0\u5728\u4e86 <code>ld</code> \u7684\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\uff0c\u4f46\u5e76\u4e0d\u4ee3\u8868\u5b83\u7684\u5185\u5bb9\u4f1a\u88ab\u9759\u6001\u94fe\u63a5\u5230 <code>main</code> \u5f53\u4e2d\uff1a\u5b9e\u9645\u4e0a\uff0c\u9759\u6001\u94fe\u63a5\u5668\u4f1a\u4ee5\u67d0\u79cd\u5f62\u5f0f\u544a\u8bc9\u52a8\u6001\u94fe\u63a5\u5668\uff0c\u5728 <code>main</code> \u7a0b\u5e8f\u542f\u52a8\u65f6\uff0c\u5982\u4f55\u53bb\u52a8\u6001\u94fe\u63a5 <code>libprinter.so</code>\u3002\u8fd9\u4e2a\u5177\u4f53\u5f62\u5f0f\uff0c\u4f1a\u5728\u4e0b\u4e00\u7bc7\u535a\u5ba2\u4e2d\u8be6\u7ec6\u4ecb\u7ecd\u3002\u73b0\u5728\u5148\u8ba8\u8bba\u4e00\u4e0b\uff0c\u52a8\u6001\u94fe\u63a5\u5668\u53ef\u80fd\u9700\u8981\u505a\u4e9b\u4ec0\u4e48\uff1a</p>\n<ol>\n<li>\u6839\u636e <code>main</code> \u7a0b\u5e8f\u8bb0\u5f55\u7684\u4fe1\u606f\uff0c\u53bb\u52a0\u8f7d <code>libprinter.so</code> \u7684\u5185\u5bb9\uff0c\u52a0\u8f7d\u5230\u67d0\u4e2a\u5185\u5b58\u5730\u5740\u4e0a</li>\n<li><code>main</code> \u7a0b\u5e8f\u9700\u8981\u8c03\u7528 <code>print</code> \u548c <code>exit</code> \u51fd\u6570\uff0c\u90a3\u4e48\u52a8\u6001\u94fe\u63a5\u5668\u5c31\u9700\u8981\u53bb\u67e5\u8be2\uff0c<code>libprinter.so</code> \u6709\u6ca1\u6709\u8fd9\u4e9b\u51fd\u6570\uff0c\u5982\u679c\u6709\u7684\u8bdd\uff0c\u5730\u5740\u662f\u4ec0\u4e48</li>\n</ol>\n<p>\u8fd9\u4e2a\u65f6\u5019\uff0c\u52a8\u6001\u94fe\u63a5\u5668\u5c31\u4f1a\u7528\u5230\u4e0a\u9762\u51fa\u73b0\u7684 <code>.dynamic</code> section\uff0c\u6839\u636e\u5b83\u7684\u5185\u5bb9\uff0c\u8bb0\u5f55\u4e0b\u54c8\u5e0c\u8868\u7684\u4f4d\u7f6e\u3002\u7a0b\u5e8f\u8981\u8c03\u7528 <code>print</code> \u51fd\u6570\uff0c\u90a3\u5c31\u5728\u54c8\u5e0c\u8868\u91cc\u67e5\u8be2 <code>print</code> \u51fd\u6570\u5bf9\u5e94\u7684\u7b26\u53f7\uff0c\u5982\u679c\u627e\u5230\u4e86\uff0c\u90a3\u5c31\u53ef\u4ee5\u5f97\u5230 <code>print</code> \u51fd\u6570\u5728 <code>libprinter.so</code> \u91cc\u7684\u504f\u79fb\uff0c\u504f\u79fb\u518d\u52a0\u4e0a <code>libprinter.so</code> \u52a8\u6001\u52a0\u8f7d\u7684\u57fa\u5730\u5740\uff0c\u5c31\u5f97\u5230\u4e86\u5b9e\u9645\u662f <code>print</code> \u51fd\u6570\u7684\u5730\u5740\uff0c\u5c31\u53ef\u4ee5\u6b63\u5e38\u8c03\u7528\u51fd\u6570\u4e86\u3002</p>\n<p>\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u53ef\u80fd\u4f1a\u53d1\u751f\u5f88\u591a\u6b21\uff0c\u6240\u4ee5\u6027\u80fd\u662f\u5f88\u91cd\u8981\u7684\uff0c\u6240\u4ee5\u5f15\u5165\u4e86\u54c8\u5e0c\u8868\u3002\u90a3\u4e48\u8fd9\u4e2a\u54c8\u5e0c\u8868\u5177\u4f53\u662f\u600e\u4e48\u4e00\u4e2a\u6784\u9020\u5462\uff1f\u4ee5\u5f80\u5728\u6570\u636e\u7ed3\u6784\u8bfe\u4e0a\u8bb2\u54c8\u5e0c\u8868\u7684\u65f6\u5019\uff0c\u66f4\u591a\u662f\u5728\u5185\u5b58\u4e2d\u7528\u54c8\u5e0c\u8868\uff0c\u7528\u62c9\u94fe\u6cd5\u89e3\u51b3\u54c8\u5e0c\u51b2\u7a81\u7684\u8bdd\uff0c\u76f4\u63a5\u7528\u6307\u9488\u6570\u7ec4\u5c31\u53ef\u4ee5\u4e86\uff1b\u800c\u8fd9\u91cc\u7684\u54c8\u5e0c\u8868\u9700\u8981\u4fdd\u5b58\u5728\u6587\u4ef6\u4e2d\uff0c\u6240\u4ee5\u90fd\u662f\u7528\u4e0b\u6807\u6765\u66ff\u4ee3\u6307\u9488\u3002</p>\n<p>\u9996\u5148\u8bb2\u4f20\u7edf\u7684 SystemV Hash \u5b9e\u73b0\uff0c\u5b83\u4fdd\u5b58\u5728 <code>.hash</code> \u6bb5\u5185\uff0c\u4f7f\u7528\u62c9\u94fe\u6cd5\u89e3\u51b3\u54c8\u5e0c\u51b2\u7a81\u3002\u5b83\u7684\u7ed3\u6784\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\u4e24\u4e2a 32 \u4f4d\u6570 <code>nbucket</code> \u548c <code>nchain</code>\uff0c\u5206\u522b\u4fdd\u5b58\u6709\u591a\u5c11\u4e2a bucket \u548c\u591a\u5c11\u4e2a chain</li>\n<li>\u63a5\u4e0b\u6765\u662f <code>nbucket</code> \u4e2a 32 \u4f4d\u6570\uff08bucket \u6570\u7ec4\uff09\uff0c\u5bf9\u5e94\u54c8\u5e0c\u8868\u7684 bucket\uff0c\u5185\u5bb9\u662f chain \u6570\u7ec4\u7684\u4e0b\u6807\uff0c\u4e5f\u5c31\u662f\u62c9\u94fe\u6cd5\u91cc\uff0c\u94fe\u8868\u7684\u8d77\u59cb\u7ed3\u70b9\u4e0b\u6807</li>\n<li>\u6700\u540e\u662f <code>nchain</code> \u4e2a 32 \u4f4d\u6570\uff08chain \u6570\u7ec4\uff09\uff0c\u8bb0\u5f55\u94fe\u8868\u7684\u4e0b\u4e00\u4e2a\u7ed3\u70b9\u7684\u4e0b\u6807\uff0c\u5982\u679c\u94fe\u8868\u540e\u7ee7\u7ed3\u70b9\u4e0d\u5b58\u5728\uff0c\u5219\u4fdd\u5b58 <code>STN_UNDEF</code></li>\n</ol>\n<p>chain \u6570\u7ec4\u548c\u52a8\u6001\u7b26\u53f7\u8868\u5927\u5c0f\u76f8\u540c\uff0c\u5143\u7d20\u4e00\u4e00\u5bf9\u5e94\u3002\u90a3\u4e48\u7528\u54c8\u5e0c\u8868\u67e5\u8be2\u7b26\u53f7\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u5bf9\u7b26\u53f7\u540d\u79f0\u6c42\u54c8\u5e0c\u503c\uff0c\u8fd9\u4e2a\u51fd\u6570\u662f\u89c4\u5b9a\u597d\u7684\uff0c\u8f93\u5165\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u8f93\u51fa\u4e00\u4e2a 32 \u4f4d\u6574\u6570</li>\n<li>\u67e5\u8be2\u54c8\u5e0c\u503c\u5bf9\u5e94\u7684 bucket\uff0c\u5f97\u5230 chain \u6570\u7ec4\u7684\u4e0b\u6807\uff0c\u8fd9\u4e2a\u4e0b\u6807\u4e5f\u5bf9\u5e94\u4e86\u4e00\u4e2a\u7b26\u53f7</li>\n<li>\u53bb\u7b26\u53f7\u8868\u67e5\u770b\u8fd9\u4e2a\u7b26\u53f7\u662f\u5426\u662f\u8981\u67e5\u8be2\u7684\u7b26\u53f7\uff08\u5b57\u7b26\u4e32\u6bd4\u8f83\uff09\uff0c\u5982\u679c\u662f\uff0c\u90a3\u5c31\u627e\u5230\u4e86\u76ee\u6807\u7b26\u53f7</li>\n<li>\u5982\u679c\u4e0d\u662f\uff0c\u68c0\u67e5 chain \u6570\u7ec4\uff0c\u67e5\u770b\u94fe\u8868\u662f\u5426\u6709\u540e\u7ee7\u7ed3\u70b9\uff0c\u5982\u679c\u6709\uff0c\u90a3\u4e48\u6cbf\u7740\u94fe\u8868\uff0c\u9010\u4e2a\u68c0\u67e5\u7b26\u53f7\u8868\u4e2d\u7684\u7b26\u53f7</li>\n<li>\u5982\u679c\u904d\u5386\u5230 <code>STT_UNDEF</code> \u90fd\u6ca1\u6709\u627e\u5230\u5339\u914d\u7684\u7b26\u53f7\uff0c\u8bf4\u660e\u76ee\u6807\u7b26\u53f7\u4e0d\u5b58\u5728</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u662f\u6bd4\u8f83\u539f\u59cb\u7684\u54c8\u5e0c\u8868\u5b9e\u73b0\u65b9\u6cd5\uff0c\u4e3a\u4e86\u51cf\u5c11\u78b0\u649e\uff0c\u5c31\u9700\u8981\u6bd4\u8f83\u5927\u7684 <code>nbucket</code>\uff0c\u4f46\u5c31\u9700\u8981\u66f4\u591a\u7684\u7a7a\u95f4\u4e86\u3002</p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u52a8\u6001\u5e93\u65e5\u76ca\u589e\u957f\u7684\u7b26\u53f7\u8868\u5927\u5c0f\u548c\u4e0d\u591f\u9ad8\u7684\u52a8\u6001\u94fe\u63a5\u6027\u80fd\u4e4b\u95f4\u7684\u77db\u76fe\uff0c\u76ee\u524d\u5e38\u89c1\u53e6\u4e00\u79cd\u54c8\u5e0c\u8868\u7684\u5b9e\u73b0\uff1aGNU Hash\uff0c\u5b83\u4fdd\u5b58\u5728 <code>.gnu.hash</code> \u6bb5\u5185\u3002\u867d\u8bf4\u662f\u54c8\u5e0c\u8868\uff0c\u4f46\u5b9e\u9645\u4e0a\u662f\u4e24\u79cd\u6570\u636e\u7ed3\u6784\u7684\u7ec4\u5408\uff1a</p>\n<ol>\n<li>Bloom Filter\uff1aBloom Filter \u662f\u4e00\u79cd\u5feb\u901f\u5224\u65ad\u67d0\u4e2a\u503c\u662f\u5426\u4e0d\u5728\u67d0\u4e2a\u96c6\u5408\u4e2d\u7684\u6570\u636e\u7ed3\u6784 <sup id=\"fnref:1\"><a class=\"footnote-ref\" href=\"#fn:1\">1</a></sup>\uff0c\u5728\u8fd9\u91cc\uff0c\u5c31\u662f\u5224\u65ad\u7b26\u53f7\u662f\u5426\u4e0d\u5728\u8be5\u52a8\u6001\u5e93\u7684\u7b26\u53f7\u8868\u4e2d\uff0c\u5982\u679c\u4e0d\u5728\uff0c\u90a3\u5c31\u4e0d\u9700\u8981\u8fdb\u884c\u540e\u7eed\u7684\u54c8\u5e0c\u67e5\u8868</li>\n<li>\u54c8\u5e0c\u8868\uff1a\u76f8\u6bd4 SystemV Hash\uff0c\u505a\u4e86\u8fd9\u4e9b\u6539\u52a8\uff1a<ol>\n<li>\u62c9\u94fe\u6cd5\u7684\u5185\u5b58\u8bbf\u95ee\u6bd4\u8f83\u968f\u673a\uff0c\u7f13\u5b58\u5c40\u90e8\u6027\u5dee\uff1b\u6240\u4ee5\u6539\u6210\u4e86\u7ebf\u6027\u6cd5\uff1a\u628a\u7b26\u53f7\u6309\u7167 bucket \u6392\u5e8f\uff0c\u4f7f\u5f97\u540c\u4e00\u4e2a bucket \u5185\u7684\u6240\u6709\u7b26\u53f7\u5728\u6570\u7ec4\u4e2d\u8fde\u7eed\u5b58\u653e\uff0c\u6539\u8fdb\u4e86\u7f13\u5b58\u5c40\u90e8\u6027</li>\n<li>\u5728 SystemV Hash \u4e2d\uff0c\u5728\u94fe\u8868\u904d\u5386\u7684\u65f6\u5019\uff0c\u6bcf\u4e2a\u7ed3\u70b9\u90fd\u9700\u8981\u8fdb\u884c\u4e00\u6b21\u5b57\u7b26\u4e32\u7684\u6bd4\u8f83\uff0c\u8fd9\u662f\u6bd4\u8f83\u6162\u7684\uff1b\u5728 GNU Hash \u4e2d\uff0c\u4e0d\u518d\u9700\u8981\u4fdd\u5b58\u94fe\u8868\u7684\u540e\u7ee7\u7ed3\u70b9\u7684\u53d8\u5316\uff0c\u6539\u4e3a\u4fdd\u5b58\u5bf9\u5e94\u7b26\u53f7\u7684\u54c8\u5e0c\u503c\uff0c\u90a3\u4e48\u5728\u904d\u5386\u8fde\u7eed\u7684 bucket \u5185\u7684\u7b26\u53f7\u65f6\uff0c\u9996\u5148\u6bd4\u8f83\u54c8\u5e0c\u503c\u662f\u5426\u76f8\u7b49\uff0c\u4e0d\u76f8\u7b49\u65f6\u5c31\u4e0d\u9700\u8981\u8fdb\u884c\u5b57\u7b26\u4e32\u6bd4\u8f83\u4e86</li>\n<li>\u4e3a\u4e86\u5224\u65ad\u5f53\u524d bucket \u5185\u7b26\u53f7\u662f\u5426\u904d\u5386\u5b8c\u6210\uff0c\u62ff\u54c8\u5e0c\u7684\u6700\u4f4e\u4f4d\u505a\u6807\u8bc6\uff0c\u6bd4\u8f83\u54c8\u5e0c\u65f6\u4e0d\u8003\u8651\u6700\u4f4e\u4f4d</li>\n</ol>\n</li>\n</ol>\n<p>\u90a3\u4e48\u7528 GNU Hash \u67e5\u8be2\u7b26\u53f7\u8868\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u5728 Bloom Filter \u4e2d\u67e5\u8be2\u76ee\u6807\u7b26\u53f7\u662f\u5426\u4e0d\u5b58\u5728\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u90a3\u5c31\u8bf4\u660e\u76ee\u6807\u7b26\u53f7\u4e0d\u5b58\u5728</li>\n<li>\u8ba1\u7b97\u51fa\u7b26\u53f7\u540d\u79f0\u7684\u54c8\u5e0c\uff0c\u627e\u5230\u5bf9\u5e94\u7684 bucket\uff0c\u904d\u5386 bucket \u5185\u7684\u5143\u7d20\uff0c\u5224\u65ad\u76ee\u6807\u7b26\u53f7\u4e0e\u5f53\u524d\u5143\u7d20\u7684\u54c8\u5e0c\u503c\u662f\u5426\u76f8\u7b49\uff0c\u5982\u679c\u76f8\u7b49\uff0c\u5e76\u4e14\u5b57\u7b26\u4e32\u6bd4\u8f83\u4e5f\u76f8\u540c\uff0c\u90a3\u5c31\u627e\u5230\u4e86\u76ee\u6807\u7b26\u53f7\uff1b\u5982\u679c\u6ca1\u67e5\u5230\uff0c\u5c31\u67e5\u5230\u76f4\u5230 bucket \u7ed3\u675f</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u7b97\u6cd5\u4f1a\u6bd4 SystemV Hash \u6027\u80fd\u66f4\u9ad8\uff0c\u6784\u5efa\u8d77\u6765\u81ea\u7136\u4e5f\u66f4\u52a0\u590d\u6742\u3002</p>\n<h2 id=\"\u5b9e\u73b0\">\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7ed3\u5408\u4ee5\u4e0a\u7684\u5206\u6790\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u4e0a\u4e00\u6b21\u535a\u5ba2\u7684\u57fa\u7840\u4e0a\u5b9e\u73b0\u7b2c\u4e09\u7248\u7684\u94fe\u63a5\u5668\uff0c\u8fd9\u4e2a\u94fe\u63a5\u5668\u53ef\u4ee5\u652f\u6301\u8f93\u5165\u591a\u4e2a ELF .o \u6587\u4ef6\uff0c\u8f93\u51fa\u53ef\u6267\u884c\u6587\u4ef6\u6216\u8005\u52a8\u6001\u5e93\u3002\u989d\u5916\u7684\u9700\u8981\u5b9e\u73b0\u7684\u5185\u5bb9\uff0c\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u4ece\u7b26\u53f7\u8868\uff08<code>.symtab</code>\uff09\u4e2d\uff0c\u53d6\u51fa\u90a3\u4e9b GLOBAL \u7684\u7b26\u53f7\uff0c\u6784\u5efa\u51fa\u52a8\u6001\u7b26\u53f7\u8868\uff08<code>.dynsym</code>\uff09\uff0c\u8ba1\u7b97\u51fa\u54c8\u5e0c\u8868\uff0c\u4fdd\u5b58\u5728 <code>.hash</code> \u548c <code>.gnu.hash</code> \u6bb5\u4e2d</li>\n<li>\u6784\u9020 <code>.dynamic</code> section\uff0c\u5e76\u5728 Program Header \u4e2d\u6dfb\u52a0 DYNAMIC\uff0c\u544a\u8bc9\u52a8\u6001\u94fe\u63a5\u5668\uff0c\u52a8\u6001\u94fe\u63a5\u65f6\u6240\u9700\u8981\u7684\u5404\u79cd\u4fe1\u606f</li>\n</ol>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u6211\u7528 Rust \u5b8c\u6210\u4e86\u5b9e\u73b0\uff0c\u94fe\u63a5\u5668\u90e8\u5206\u7684\u4ee3\u7801\u91cf\u5927\u6982\u662f 600 \u884c\uff0c\u6bd4\u4e0a\u4e00\u4e2a\u7248\u672c\u591a 200 \u884c\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u7ed9\u51fa\u4e00\u4e9b\u6587\u6863\uff0c\u53ef\u4f9b\u5b9e\u73b0\u65f6\u53c2\u8003\uff1a</p>\n<ul>\n<li><a href=\"https://refspecs.linuxbase.org/elf/gabi4+/ch5.dynamic.html\">Dynamic Linking</a></li>\n<li><a href=\"https://flapenguin.me/elf-dt-gnu-hash\">ELF: better symbol lookup via DT_GNU_HASH</a></li>\n<li><a href=\"https://blogs.oracle.com/solaris/post/gnu-hash-elf-sections\">GNU Hash ELF Sections</a></li>\n</ul>\n<div class=\"footnote\">\n<hr />\n<ol>\n<li id=\"fn:1\">\n<p>\u8fd9\u53e5\u8bdd\u6709\u70b9\u62d7\u53e3\uff0c\u4f46\u662f\u4f60\u6ca1\u6709\u770b\u9519\uff0cBloom Filter \u53ea\u80fd\u786e\u5b9a\u67d0\u4e2a\u5143\u7d20\u4e0d\u5728\u96c6\u5408\u4e2d\uff0c\u4f46\u53cd\u4e4b\uff0c\u4e0d\u80fd\u786e\u5b9a\u5143\u7d20\u662f\u5426\u4e00\u5b9a\u5728\u96c6\u5408\u4e2d\u3002\u5b83\u7684\u539f\u7406\u662f\uff0c\u8ba1\u7b97\u96c6\u5408\u7684\u6bcf\u4e2a\u5143\u7d20\u7684\u54c8\u5e0c\u503c\uff0c\u6784\u5efa\u51fa\u4e00\u4e2a bitset\uff0c\u628a\u54c8\u5e0c\u503c\u5bf9\u5e94\u7684\u4f4d\u8bbe\u4e3a 1\uff0c\u5176\u4f59\u8bbe\u4e3a 0\uff1b\u67e5\u8be2\u65f6\uff0c\u8ba1\u7b97\u5143\u7d20\u7684\u54c8\u5e0c\u503c\uff0c\u68c0\u67e5 bitset \u4e2d\u5bf9\u5e94\u4f4d\u662f\u5426\u4e3a 0\uff1a\u5982\u679c\u4e3a 0\uff0c\u90a3\u4e48\u5143\u7d20\u4e00\u5b9a\u4e0d\u5728\u96c6\u5408\u4e2d\uff1b\u5982\u679c\u4e3a 1\uff0c\u7531\u4e8e\u53ef\u80fd\u51fa\u73b0\u54c8\u5e0c\u51b2\u7a81\uff0c\u4e0d\u80fd\u786e\u5b9a\u8be5\u5143\u7d20\u4e00\u5b9a\u5728\u96c6\u5408\u4e2d\u3002&#160;<a class=\"footnote-backref\" href=\"#fnref:1\" title=\"Jump back to footnote 1 in the text\">&#8617;</a></p>\n</li>\n</ol>\n</div>", "image": null, "date_published": "2024-04-06T00:00:00+00:00", "authors": [], "tags": ["elf", "linker", "linux", "software", "write-a-linker"]}, {"id": "https://jia.je/software/2024/03/30/write-a-linker-2/", "url": "https://jia.je/software/2024/03/30/write-a-linker-2/", "title": "\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff082\uff09", "content_html": "<h1 id=\"\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56682\">\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff082\uff09<a class=\"headerlink\" href=\"#\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56682\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u524d\u8a00\">\u524d\u8a00<a class=\"headerlink\" href=\"#\u524d\u8a00\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u4e2a\u7cfb\u5217\u7684\u7b2c\u4e00\u7bc7\u535a\u5ba2\u5b9e\u73b0\u4e86\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u9759\u6001\u94fe\u63a5\u5668\uff0c\u5b83\u53ef\u4ee5\u8f93\u5165\u5355\u4e2a ELF .o \u6587\u4ef6\uff0c\u8f93\u51fa ELF \u53ef\u6267\u884c\u6587\u4ef6\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u9700\u8981\u628a\u5b83\u5347\u7ea7\u5230\u652f\u6301\u8f93\u5165\u4e24\u4e2a\u6216\u8005\u66f4\u591a\u7684 ELF .o \u6587\u4ef6\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u56de\u987e\">\u56de\u987e<a class=\"headerlink\" href=\"#\u56de\u987e\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u56de\u987e\u4e00\u4e0b\uff1a\u5728\u8fd9\u4e2a\u7cfb\u5217\u7684\u4e0a\u4e00\u7bc7\u535a\u5ba2\u4e2d\uff0c\u6211\u4eec\u89c2\u5bdf\u4e86\u73b0\u6709\u94fe\u63a5\u5668\u7684\u5de5\u4f5c\u8fc7\u7a0b\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u94fe\u63a5\u5668\uff1a\u8f93\u5165\u4e00\u4e2a ELF object\uff0c\u94fe\u63a5\u6210\u4e00\u4e2a\u53ef\u4ee5\u8fd0\u884c\u7684 ELF \u53ef\u6267\u884c\u6587\u4ef6\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u89e3\u6790\u8f93\u5165\u7684 ELF\uff0c\u6536\u96c6\u5404\u4e2a section \u9700\u8981\u4fdd\u7559\u4e0b\u6765\u7684\u5185\u5bb9</li>\n<li>\u89c4\u5212\u5c06\u8981\u751f\u6210\u7684 ELF \u53ef\u6267\u884c\u6587\u4ef6\u7684\u5185\u5bb9\u5e03\u5c40\uff1a\u5f00\u59cb\u662f\u56fa\u5b9a\u7684\u6587\u4ef6\u5934\uff0c\u4e4b\u540e\u662f\u5404\u4e2a section\uff0c\u8ba1\u7b97\u51fa\u5b83\u4eec\u4ece\u54ea\u91cc\u5f00\u59cb\u5230\u54ea\u91cc\u7ed3\u675f</li>\n<li>\u7b2c\u4e8c\u6b65\u5b8c\u6210\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u5728\u8fd0\u884c\u65f6\uff0c\u5404\u4e2a section \u5c06\u4f1a\u88ab\u52a0\u8f7d\u5230\u54ea\u4e2a\u5730\u5740\u4e0a\uff1b\u6b64\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba1\u7b97\u91cd\u5b9a\u4f4d\uff0c\u628a\u5730\u5740\u6309\u7167\u9884\u8bbe\u7684\u89c4\u5219\u586b\u5165\u5230\u5bf9\u5e94\u7684\u5730\u65b9</li>\n<li>\u6700\u540e\u6309\u7167\u9884\u8bbe\u7684\u6587\u4ef6\u5e03\u5c40\uff0c\u628a\u6587\u4ef6\u5185\u5bb9\u5199\u5165\u5230 ELF \u6587\u4ef6\u4e2d</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u8981\u5b9e\u73b0\u5355\u6587\u4ef6\u8f93\u5165\u5230\u591a\u6587\u4ef6\u8f93\u5165\u7684\u8de8\u8d8a\uff0c\u8ba9\u6211\u4eec\u9996\u5148\u5206\u6790\u4e00\u4e0b\uff0c\u8fd9\u91cc\u7684\u4e0d\u540c\u5728\u54ea\u91cc\u3002</p>\n<h2 id=\"\u5206\u6790\">\u5206\u6790<a class=\"headerlink\" href=\"#\u5206\u6790\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u62c6\u5206\u4ee3\u7801\">\u62c6\u5206\u4ee3\u7801<a class=\"headerlink\" href=\"#\u62c6\u5206\u4ee3\u7801\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8f93\u5165\u53ea\u6709\u4e00\u4e2a ELF object\uff08.o\uff09\u6587\u4ef6\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a object \u6587\u4ef6\u91cc\u9700\u8981\u7684\u6240\u6709\u4e1c\u897f\u90fd\u53ea\u80fd\u7531\u8fd9\u4e2a object \u81ea\u5df1\u6765\u63d0\u4f9b\uff0c\u6240\u4ee5\u6bd4\u8f83\u597d\u5b9e\u73b0\u3002\u4f46\u5982\u679c\u8981\u8f93\u5165\u591a\u4e2a ELF object \u6587\u4ef6\uff0c\u6b64\u65f6\u53ef\u80fd\u4f1a\u51fa\u73b0\u9700\u8981\u4f9d\u8d56\u7684\u60c5\u51b5\u3002\u9996\u5148\u56de\u5fc6\u4e00\u4e0b\u4e4b\u524d\u5b66\u4e60\u7684 C/C++ \u7684\u5185\u5bb9\uff0c\u5728\u7f16\u5199\u4ee3\u7801\u7684\u65f6\u5019\uff0c\u7ecf\u5e38\u4f1a\u628a\u58f0\u660e\uff08declaration\uff09\u653e\u5230\u5934\u6587\u4ef6\uff08.h\uff09\u91cc\uff0c\u5b9e\u73b0\uff08definition\uff09\u653e\u5728\u6e90\u6587\u4ef6\uff08.c/cpp\uff09\uff1a\u8fd9\u6837\u53ef\u4ee5\u5728 <code>A.cpp</code> \u4e2d\u8c03\u7528 <code>B.cpp</code> \u91cc\u7684\u51fd\u6570\uff0c\u4e0d\u4f1a\u51fa\u73b0\u5927\u5bb6\u7ecf\u5e38\u9047\u5230\u7684 <code>duplicate symbol</code> \u9519\u8bef\u3002\u90a3\u4e48\u8fd9\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f</p>\n<p>\u6211\u4eec\u9996\u5148\u5728\u6c47\u7f16\u8bed\u8a00\u4e2d\u6a21\u62df\u8fd9\u4e2a\u573a\u666f\u3002\u9996\u5148\u56de\u987e\u4e00\u4e0b\u4e0a\u4e00\u7bc7\u535a\u5ba2\u4e2d\u7528\u6c47\u7f16\u5b9e\u73b0\u7684 Hello World \u4f8b\u5b50\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\"># From https://gist.github.com/adrianratnapala/1321776</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"c1\"># Hello World on amd64 under Linux.</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"c1\">#</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"c1\"># One way to build this is with: </span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"c1\">#</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"c1\">#    gcc hello.S  -s -nostartfiles -nostdlib -o hello</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"c1\">#</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"c1\"># for syscall numbers look in /usr/include/asm/unistd_64.h</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"c1\"># for examples look at http://99-bottles-of-beer.net/language-assembler-(amd64)-933.html</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"c1\"># for insipration look at http://www.muppetlabs.com/~breadbox/software/tiny/teensy.html</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.rodata</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"nl\">hello:</span>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"na\">.string</span><span class=\"w\"> </span><span class=\"s\">&quot;Hello world!\\n&quot;</span>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">_start</span>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"nl\">_start:</span>\n</span><span id=\"__span-0-20\"><a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\" href=\"#__codelineno-0-20\"></a><span class=\"w\">    </span><span class=\"c1\"># write(1, hello, 13)</span>\n</span><span id=\"__span-0-21\"><a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\" href=\"#__codelineno-0-21\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-0-22\"><a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\" href=\"#__codelineno-0-22\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$hello</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-0-23\"><a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\" href=\"#__codelineno-0-23\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span>\n</span><span id=\"__span-0-24\"><a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\" href=\"#__codelineno-0-24\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span><span class=\"w\"> </span>\n</span><span id=\"__span-0-25\"><a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\" href=\"#__codelineno-0-25\"></a><span class=\"w\">    </span><span class=\"no\">syscall</span>\n</span><span id=\"__span-0-26\"><a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\" href=\"#__codelineno-0-26\"></a>\n</span><span id=\"__span-0-27\"><a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\" href=\"#__codelineno-0-27\"></a><span class=\"w\">    </span><span class=\"c1\"># _exit(0)</span>\n</span><span id=\"__span-0-28\"><a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\" href=\"#__codelineno-0-28\"></a><span class=\"w\">    </span><span class=\"nf\">xor</span><span class=\"w\">     </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-0-29\"><a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\" href=\"#__codelineno-0-29\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-0-30\"><a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\" href=\"#__codelineno-0-30\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\u4ee3\u7801\u5b9e\u9645\u4e0a\u505a\u4e86\u4e24\u4ef6\u4e8b\u60c5\uff0c\u9996\u5148\u8f93\u51fa Hello World\uff0c\u7136\u540e\u9000\u51fa\u7a0b\u5e8f\u3002\u6211\u4eec\u628a\u8fd9\u4e24\u90e8\u5206\u5206\u522b\u5b9e\u73b0\u6210\u4e00\u4e2a\u51fd\u6570\uff0c\u653e\u5230\u53e6\u4e00\u4e2a <code>.s</code> \u6587\u4ef6\uff08<code>printer.s</code>\uff09\u4e2d\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\"># https://gist.github.com/adrianratnapala/1321776</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"c1\"># printer.s</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.rodata</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"nl\">hello:</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"w\">    </span><span class=\"na\">.string</span><span class=\"w\"> </span><span class=\"s\">&quot;Hello world!\\n&quot;</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">print</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"nl\">print:</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a><span class=\"w\">    </span><span class=\"c1\"># write(1, hello, 13)</span>\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$hello</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span>\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a>\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">exit</span>\n</span><span id=\"__span-1-20\"><a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\" href=\"#__codelineno-1-20\"></a><span class=\"nl\">exit:</span>\n</span><span id=\"__span-1-21\"><a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\" href=\"#__codelineno-1-21\"></a><span class=\"w\">    </span><span class=\"c1\"># _exit(0)</span>\n</span><span id=\"__span-1-22\"><a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\" href=\"#__codelineno-1-22\"></a><span class=\"w\">    </span><span class=\"nf\">xor</span><span class=\"w\">     </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-1-23\"><a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\" href=\"#__codelineno-1-23\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-1-24\"><a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\" href=\"#__codelineno-1-24\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u628a\u4e0a\u9762\u7684\u4e24\u6bb5\u6c47\u7f16\u5206\u522b\u653e\u5728 <code>print</code> \u548c <code>exit</code> \u51fd\u6570\u4e2d\uff0c\u5e76\u4e14\u52a0\u4e0a\u4e86 <code>ret</code> \u6307\u4ee4\u4ee5\u5b9e\u73b0\u8fd4\u56de\u51fd\u6570\u7684\u8c03\u7528\u8005\u3002<code>exit</code> \u51fd\u6570\u6ca1\u6709\u6dfb\u52a0 <code>ret</code> \uff0c\u662f\u56e0\u4e3a\u8c03\u7528 <code>exit</code> \u7cfb\u7edf\u8c03\u7528\u540e\uff0c\u8fdb\u7a0b\u5c31\u9000\u51fa\u4e86\uff0c\u540e\u9762\u7684\u6307\u4ee4\u4e0d\u4f1a\u88ab\u6267\u884c\u3002\u63a5\u4e0b\u6765\uff0c\u9700\u8981\u5728\u5165\u53e3\u51fd\u6570\u4e2d\u8c03\u7528\u8fd9\u4e24\u4e2a\u51fd\u6570\u6765\u5b9e\u73b0 <code>Hello world</code> \u7684\u6253\u5370\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\"># main.s</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">_start</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"nl\">_start:</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">print</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">exit</span>\n</span></code></pre></div>\n<p>\u8c03\u7528 GNU as \u5206\u522b\u6c47\u7f16\u4e24\u4e2a\u6587\u4ef6\u7136\u540e\u94fe\u63a5\uff0c\u7a0b\u5e8f\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"c1\"># Use assembler (GNU as) to assemble</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>main.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>main.o\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>printer.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>printer.o\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"c1\"># Use ld (GNU ld.bfd) to link</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>main.o<span class=\"w\"> </span>printer.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>helloworld\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a>$<span class=\"w\"> </span>./helloworld\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a>Hello<span class=\"w\"> </span>world!\n</span></code></pre></div>\n<h3 id=\"\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6\">\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6<a class=\"headerlink\" href=\"#\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u8981\u63a2\u7a76\uff0c\u6c47\u7f16\u5668\u548c\u94fe\u63a5\u5668\u662f\u5982\u4f55\u534f\u4f5c\uff0c\u4f7f\u5f97 <code>main.s</code> \u4e2d\u7684\u4ee3\u7801\u53ef\u4ee5\u8c03\u7528 <code>printer.s</code> \u4e2d\u7684\u51fd\u6570\u3002\u5f53\u7136\u4e86\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u7528\u7684\u662f\u6c47\u7f16\u8bed\u8a00\uff0c\u6c47\u7f16\u5668\u9047\u5230\u4e0d\u5b58\u5728\u7684\u51fd\u6570\u540d\u5c31\u4f1a\u8ba4\u4e3a\u662f\u5916\u90e8\u51fd\u6570\u3002\u5982\u679c\u662f C/C++ \u8bed\u8a00\uff0c\u5219\u8981\u5148\u5728 <code>main.c</code> \u4e2d\u58f0\u660e\u8fd9\u4e24\u4e2a\u51fd\u6570\uff08\u6216\u8005 <code>#include</code> \u4e86\u4e00\u4e2a\u58f0\u660e\u4e86\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u5934\u6587\u4ef6\uff09\u518d\u8c03\u7528\uff08\u6bd4\u8f83\u8001\u7684 C \u6807\u51c6\u5141\u8bb8\u4e0d\u58f0\u660e\u76f4\u63a5\u8c03\u7528\uff0c\u4f46\u8fd9\u662f\u4e0d\u63a8\u8350\u7684\uff09\u3002</p>\n<p>\u9996\u5148\u89c2\u5bdf <code>main.s</code> \u7ecf\u8fc7\u6c47\u7f16\u5f97\u5230\u7684 <code>main.o</code>\uff0c\u770b\u5b83\u662f\u600e\u4e48\u8c03\u7528 <code>print</code> \u548c <code>exit</code> \u51fd\u6570\u7684\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"c1\"># objdump -S: Display assembly and intermix source code with disassembly</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>main.o\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a>main.o:<span class=\"w\">     </span>file<span class=\"w\"> </span>format<span class=\"w\"> </span>elf64-x86-64\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;_start&gt;:\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">5</span><span class=\"w\"> </span>&lt;_start+0x5&gt;\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"w\">   </span><span class=\"m\">5</span>:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span>a<span class=\"w\"> </span>&lt;_start+0xa&gt;\n</span></code></pre></div>\n<p>\u53cd\u6c47\u7f16\u51fa\u6765\u53ef\u4ee5\u770b\u5230\u4e24\u6761 <code>call</code> \u6307\u4ee4\uff0c\u4f46\u662f\u5b83\u4eec\u7684\u5730\u5740\u90fd\u5f88\u5947\u602a\uff1a\u7b2c\u4e00\u6761\u6307\u4ee4\u662f <code>call 5</code>\uff0c\u800c 0x5 \u662f\u7b2c\u4e8c\u6761 call \u5730\u5740\u7684\u5730\u5740\uff1b\u7b2c\u4e8c\u6761\u6307\u4ee4\u662f <code>call a</code>\uff0c\u6309\u7167\u89c4\u5f8b\uff0c\u53ef\u4ee5\u731c\u51fa\u6765 0xa \u662f\u7b2c\u4e8c\u6761\u6307\u4ee4\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u7684\u5730\u5740\uff0c\u6bcf\u6761\u6307\u4ee4 5 \u4e2a\u5b57\u8282\uff0c\u4e24\u6761\u6307\u4ee4\u521a\u597d 10 \u5b57\u8282\uff0c\u4e5f\u5c31\u662f 0xa\u3002\u8fd9\u4f3c\u4e4e\u4e0e <code>print</code> \u548c <code>exit</code> \u51fd\u6570\u90fd\u6ca1\u6709\u5173\u7cfb\uff0c\u6267\u884c\u7684\u65f6\u5019\u600e\u4e48\u4f1a\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\u5462\uff1f</p>\n<p>\u56de\u5fc6\u4e00\u4e0b\uff0c\u5728\u8fd9\u4e2a\u7cfb\u5217\u7684\u4e0a\u4e00\u7bc7\u535a\u5ba2\u4e2d\uff0c\u53cd\u6c47\u7f16 <code>.o</code> \u6587\u4ef6\u7684\u65f6\u5019\u4e5f\u51fa\u73b0\u8fc7\u7c7b\u4f3c\u7684\u60c5\u51b5\uff1a<code>_start</code> \u51fd\u6570\u9700\u8981\u77e5\u9053 <code>.rodata</code> \u6bb5\u91cc\u7684 <code>hello</code> \u5b57\u7b26\u4e32\u7684\u5730\u5740\uff0c\u4f46\u662f\u6c47\u7f16\u7684\u65f6\u5019\u8fd9\u4e2a\u5730\u5740\u65e0\u6cd5\u77e5\u9053\uff0c\u6240\u4ee5\u6c47\u7f16\u5668\u751f\u6210\u4e86\u4e00\u4e2a relocation\uff08relocation \u7684\u4e2d\u6587\u7ffb\u8bd1\u662f\u91cd\u5b9a\u4f4d\uff0c\u4f46\u6211\u4e0d\u559c\u6b22\u8fd9\u4e2a\u7ffb\u8bd1\uff0c\u6240\u4ee5\u4e0b\u6587\u8fd8\u662f\u7528 relocation\uff09\uff0c\u544a\u8bc9\u94fe\u63a5\u5668\u53bb\u586b\u5165\u6b63\u786e\u7684\u5730\u5740\u3002\u8fd9\u91cc\u4e5f\u662f\u7c7b\u4f3c\u7684\uff1a\u6c47\u7f16\u5668\u5728\u6c47\u7f16 <code>main.s</code> \u7684\u65f6\u5019\uff0c\u4e5f\u65e0\u6cd5\u77e5\u9053 <code>print</code> \u548c <code>exit</code> \u51fd\u6570\u4f1a\u5728\u4ec0\u4e48\u5730\u5740\uff0c\u6240\u4ee5\u53ea\u80fd\u751f\u6210\u4e00\u4e2a relocation\uff0c\u628a\u504f\u79fb\u521d\u59cb\u5316\u4e3a\u96f6\uff0c\u7b49\u7740\u94fe\u63a5\u5668\u6765\u586b\u5199\u3002\u800c x86 \u4e0a <code>call</code> \u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u8ba1\u7b97\u65b9\u6cd5\u662f <code>call</code> \u6307\u4ee4\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5730\u5740\u52a0\u4e0a\u504f\u79fb\uff0c\u8fd9\u4e2a\u504f\u79fb\u521d\u59cb\u5316\u4e3a 0\uff0c\u90a3\u4e48\u53cd\u6c47\u7f16\u770b\u5230\u7684\u5c31\u597d\u50cf\u662f <code>call</code> \u8981\u8c03\u7528\u5b83\u81ea\u5df1\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\uff0c\u8fd9\u5c31\u89e3\u91ca\u4e86\u4e0a\u9762\u89c2\u5bdf\u5230\u7684\u73b0\u8c61\u3002</p>\n<p>\u6b63\u597d <code>objdump</code> \u53ef\u4ee5\u5e2e\u6211\u4eec\u663e\u793a\u51fa relocation\uff0c\u53ea\u9700\u8981\u6dfb\u52a0 <code>-r</code> \u53c2\u6570\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"c1\"># objdump -r, --reloc: Display the relocation entries in the file</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>-r<span class=\"w\"> </span>main.o\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a>main.o:<span class=\"w\">     </span>file<span class=\"w\"> </span>format<span class=\"w\"> </span>elf64-x86-64\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;_start&gt;:\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">5</span><span class=\"w\"> </span>&lt;_start+0x5&gt;\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">                        </span><span class=\"m\">1</span>:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">       </span>print-0x4\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\">   </span><span class=\"m\">5</span>:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span>a<span class=\"w\"> </span>&lt;_start+0xa&gt;\n</span><span id=\"__span-5-13\"><a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\" href=\"#__codelineno-5-13\"></a><span class=\"w\">                        </span><span class=\"m\">6</span>:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">       </span>exit-0x4\n</span></code></pre></div>\n<p>\u8fd9\u65f6\u5019\u4f1a\u53d1\u73b0\uff0c<code>print</code> \u548c <code>exit</code> \u679c\u7136\u51fa\u73b0\u4e86\uff0c\u6240\u4ee5\u6c47\u7f16\u5668\u662f\u901a\u8fc7\u8fd9\u4e24\u6761 relocation \u544a\u8bc9\u94fe\u63a5\u5668\uff0c\u8fd9\u91cc\u5b9e\u9645\u4e0a\u8981\u8c03\u7528\u54ea\u4e2a\u51fd\u6570\u3002\u4f46\u662f\u8fd9\u91cc\u51fa\u73b0\u7684 <code>R_X86_64_PLT32</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f<code>print</code> \u548c <code>exit</code> \u540e\u9762\u7684 <code>-0x4</code> \u662f\u4ec0\u4e48\u610f\u601d\uff0c\u4e3a\u4ec0\u4e48\u8981\u51cf 4\uff1f\u5982\u679c\u8003\u8651\u5230\u524d\u9762\u6240\u8bf4\u7684\uff0c<code>call</code> \u6307\u4ee4\u5360\u7528 5 \u4e2a\u5b57\u8282\uff0c\u90a3\u4e0d\u5e94\u8be5\u662f\u51cf 5 \u624d\u5bf9\u5417\uff1f\u4e0b\u9762\u6765\u89e3\u91ca\u8fd9\u4e9b\u95ee\u9898\uff1a</p>\n<div class=\"admonition question\">\n<p class=\"admonition-title\">\u4ec0\u4e48\u662f <code>R_X86_64_PLT32</code> \uff1f</p>\n<p>\u5728\u4e0a\u4e00\u7bc7\u535a\u5ba2\u4e2d\uff0c\u51fa\u73b0\u8fc7 <code>R_X86_64_32S</code> \u8fd9\u79cd relocation \u7c7b\u578b\uff0c\u5b83\u7684\u610f\u601d\u662f\u628a\u76ee\u6807\u7b26\u53f7\u7684\u5730\u5740\u4ee5 32 \u4f4d\u6709\u7b26\u53f7\u6570\u7684\u683c\u5f0f\u5199\u5230\u5bf9\u5e94\u7684\u4f4d\u7f6e\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u7528\u7684\u662f\u7edd\u5bf9\u5730\u5740\uff0c\u4f8b\u5982 <code>0x402000</code>\u3002\u4f46\u662f\uff0c\u521a\u624d\u63d0\u5230\uff0cx86 \u7684 <code>call</code> \u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u8ba1\u7b97\u65b9\u6cd5\u662f\uff0c<code>call</code> \u6307\u4ee4\u540e\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u7684\u5730\u5740\uff0c\u52a0\u4e0a\u5730\u5740\u504f\u79fb\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u5730\u5740\u504f\u79fb\u662f\u76f8\u5bf9\u7684\uff0c\u518d\u586b\u5165\u7edd\u5bf9\u5730\u5740\u5c31\u51fa\u9519\u4e86\u3002\u5b9e\u9645\u4e0a\uff0c<code>R_X86_64_PLT32</code> \u8fd8\u6d89\u53ca\u5230\u4e00\u4e2a\u65b0\u7684\u8fd8\u6ca1\u6709\u6d89\u53ca\u5230\u7684\u6982\u5ff5 PLT\uff08Procedure Linkage Table\uff09\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u5148\u4e0d\u6d89\u53ca PLT\uff0c\u628a\u5b83\u5f53\u6210\u5355\u7eaf\u7684\u76f8\u5bf9\u5730\u5740\u8ba1\u7b97\u53bb\u5904\u7406\u3002\u8fd9\u4e2a\u5355\u7eaf\u7684\u76f8\u5bf9\u5730\u5740\u8ba1\u7b97\u7684 relocation \u4e5f\u6709\u6b63\u5f0f\u540d\u5b57\uff0c\u4e5f\u5c31\u662f <code>R_X86_64_PC32</code>\uff0c\u610f\u601d\u662f\u6839\u636e PC\uff08Program Counter\uff09\u8ba1\u7b97\u51fa\u548c\u76ee\u7684\u5730\u5740\u7684\u76f8\u5bf9\u504f\u79fb\uff0832 \u4f4d\uff09\u3002</p>\n</div>\n<div class=\"admonition question\">\n<p class=\"admonition-title\">\u4e3a\u4ec0\u4e48\u662f <code>print-0x4</code>\uff1f\u8fd9\u4e2a\u51cf\u53bb 0x4 \u662f\u600e\u4e48\u6765\u7684\uff1f</p>\n<p>\u521a\u624d\u63d0\u5230\uff0cx86 \u7684 <code>call</code> \u6307\u4ee4\u662f\u7528 <code>call</code> \u6307\u4ee4\u540e\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u7684\u5730\u5740\u52a0\u4e0a\u5730\u5740\u504f\u79fb\uff0c\u6c42\u7684\u548c\u5c31\u662f\u8981\u8c03\u7528\u7684\u51fd\u6570\u7684\u5730\u5740\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u6bd4\u8f83\u590d\u6742\uff0c\u6211\u4eec\u4e0b\u9762\u4e3e\u4e00\u4e2a\u5177\u4f53\u7684\u4f8b\u5b50\uff1a</p>\n<p>\u4ee5\u4e0a\u9762\u7684 <code>call exit</code> \u6307\u4ee4\u4e3a\u4f8b\uff0c\u4e5f\u5c31\u662f\u53cd\u6c47\u7f16\u51fa\u6765\u7684\u7b2c\u4e8c\u6761\u6307\u4ee4\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"w\">   </span><span class=\"err\">5:</span><span class=\"w\">   </span><span class=\"nf\">e8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"no\">call</span><span class=\"w\">   </span><span class=\"mh\">a</span> <span class=\"p\">&lt;</span><span class=\"no\">_start</span><span class=\"p\">+</span><span class=\"mi\">0xa</span><span class=\"p\">&gt;</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"w\">                        </span><span class=\"err\">6:</span><span class=\"w\"> </span><span class=\"nf\">R_X86_64_PLT32</span><span class=\"w\">       </span><span class=\"no\">exit-0x4</span>\n</span></code></pre></div>\n<p>\u5047\u8bbe\u6211\u4eec\u5df2\u7ecf\u77e5\u9053 <code>print</code> \u51fd\u6570\u7684\u5730\u5740\u5c31\u662f <code>0xbbbb</code>\uff0c\u4e5f\u5047\u8bbe\u8fd9\u6761 <code>call</code> \u6307\u4ee4\u6700\u7ec8\u5728\u5185\u5b58\u4e2d\u7684\u5730\u5740\u4e5f\u662f <code>0x5</code>\u3002\u90a3\u4e48\u6211\u4eec\u5e94\u8be5\u600e\u4e48\u586b\u5199\u8fd9\u6761 <code>call</code> \u6307\u4ee4\u7684\u5730\u5740\u504f\u79fb\u5462\uff1f</p>\n<p>\u5047\u8bbe\u5730\u5740\u504f\u79fb\u7b49\u4e8e <code>X</code>\uff0c\u5df2\u77e5 <code>call</code> \u6307\u4ee4\u7684\u5730\u5740\u662f 0x5\uff0c<code>call</code> \u6307\u4ee4\u5360\u7528 0x5 \u4e2a\u5b57\u8282\uff0c\u90a3\u4e48 <code>call</code> \u6307\u4ee4\u540e\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u7684\u5730\u5740\u5c31\u662f <code>0x5 + 0x5</code>\uff0c\u6309\u7167 x86 \u7684\u89c4\u5b9a\uff0c\u8981\u8c03\u7528\u7684\u51fd\u6570\u7684\u5730\u5740\u5c31\u662f <code>0x5 + 0x5 + X</code>\u3002\u800c\u6211\u4eec\u77e5\u9053\u8981\u8c03\u7528\u7684\u51fd\u6570\u662f <code>print</code>\uff0c<code>print</code> \u51fd\u6570\u7684\u5730\u5740\u662f <code>0xbbbb</code>\uff0c\u53cd\u89e3\u51fa <code>X = 0xbbb1</code>\uff0c\u90a3\u4e48\u8981\u586b\u8fdb\u53bb\u7684\u5730\u5740\u504f\u79fb\u5c31\u662f 0xbbb1 \u8fd9\u4e2a\u6570\u3002</p>\n<p>\u5982\u679c\u6309\u7167\u8fd9\u4e2a\u903b\u8f91\uff0c\u8981\u8ba1\u7b97 X \u7684\u8bdd\uff0c\u5e94\u8be5\u662f <code>print - 0x5 - 0x5</code> \u624d\u5bf9\uff0c\u7b2c\u4e00\u4e2a <code>0x5</code> \u662f <code>call</code> \u6307\u4ee4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u7b2c\u4e8c\u4e2a <code>0x5</code> \u662f <code>call</code> \u6307\u4ee4\u7684\u957f\u5ea6\u3002\u4f46\u662f\u4e3a\u4ec0\u4e48\u770b\u5230\u7684\u662f <code>print - 0x4</code> \u5462\uff1f\u4e3a\u4ec0\u4e48\u53ea\u51cf\u4e86\u4e00\u4e2a\u6570\uff08<code>-0x4</code>\uff09\uff0c\u800c\u4e0d\u662f\u4e24\u4e2a\uff08<code>- 0x5 - 0x5</code>\uff09\uff1f</p>\n<p>\u7ec6\u5fc3\u7684\u8bfb\u8005\u53ef\u80fd\u89c2\u5bdf\u5230\uff0c\u5728 <code>R_X86_64_PLT32</code> \u7684\u524d\u9762\uff0c\u663e\u793a\u7684\u662f <code>6:</code>\uff0c\u8fd9\u8868\u793a\u7684\u662f relocation \u6807\u8bb0\u7684\u5730\u5740\u662f 0x6\uff0c\u800c\u4e0d\u662f 0x5\uff08<code>call</code> \u6307\u4ee4\u7684\u8d77\u59cb\u5730\u5740\uff09\u3002\u8fdb\u4e00\u6b65\u89c2\u5bdf\uff0c\u4f1a\u53d1\u73b0 <code>call</code> \u6307\u4ee4\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282 <code>0xe8</code> \u51b3\u5b9a\u4e86\u8fd9\u662f\u4e00\u6761 <code>call</code> \u6307\u4ee4\uff0c\u5269\u4e0b\u7684\u56db\u4e2a\u5b57\u8282\u90fd\u662f\u5730\u5740\u504f\u79fb\uff0c\u800c\u94fe\u63a5\u5668\u8981\u6539\u7684\u4e5f\u5c31\u662f\u8fd9\u4e2a\u5730\u5740\u504f\u79fb\uff1a\u65e2\u7136\u8981\u6539\u7684\u662f\u4ece 0x6 \u5f00\u59cb\u7684\u56db\u4e2a\u5b57\u8282\uff0c\u90a3 relocation \u81ea\u7136\u6307\u5411\u7684\u5c31\u662f 0x6\uff01\u6362\u53e5\u8bdd\u8bf4\uff0c\u94fe\u63a5\u5668\u4e0d\u9700\u8981\u77e5\u9053\u8fd9\u662f\u4e00\u6761 <code>call</code> \u6307\u4ee4\uff0c\u53ea\u9700\u8981\u6309\u7167 relocation \u7684\u89c4\u5219\u8ba1\u7b97\u51fa\u503c\u586b\u8fdb\u53bb\u5c31\u597d\u4e86\u3002</p>\n<p>\u65e2\u7136\u8d77\u59cb\u5730\u5740\u8981\u4ece 0x6 \u5f00\u59cb\u7b97\u4e86\uff0c\u90a3\u4e48\u4e3a\u4ec0\u4e48\u51fa\u73b0 <code>0x4</code> \u5c31\u53ef\u4ee5\u89e3\u91ca\u4e86\uff1a\u4ece relocation \u7684 0x6 \u5730\u5740\u5f00\u59cb\u7b97\uff0c\u53ea\u9700\u8981\u51cf\u53bb 4\uff08<code>call</code> \u6307\u4ee4\u5185\u5730\u5740\u504f\u79fb\u7684\u957f\u5ea6\uff09\uff0c\u800c\u4e0d\u662f\u51cf\u53bb 5\uff08<code>call</code> \u6307\u4ee4\u7684\u957f\u5ea6\uff09\u3002\u53e6\u4e00\u65b9\u9762\uff0c<code>R_X86_64_PLT32</code> \u672c\u8eab\u5c31\u544a\u8bc9\u94fe\u63a5\u5668\uff0c\u8ba9\u94fe\u63a5\u5668\u8ba1\u7b97\u7684\u65f6\u5019\uff0c\u8981\u51cf\u53bb\u5f53\u524d relocation \u7684\u8d77\u59cb\u5730\u5740\u4e86\u3002\u6309\u7167\u8fd9\u4e2a\u89c4\u5219\uff0c\u6211\u4eec\u518d\u590d\u73b0\u4e00\u904d\u521a\u624d\u7684\u4f8b\u5b50\uff1a</p>\n<p>\u94fe\u63a5\u5668\u89c2\u5bdf\u5230\u4e00\u4e2a <code>R_X86_64_PLT32</code> \u7684 relocation\uff0crelocation \u81ea\u8eab\u7684\u5730\u5740\u662f 0x6\uff0c\u76ee\u6807\u5730\u5740\u662f <code>print-0x4</code>\uff0c<code>print</code> \u51fd\u6570\u7684\u5730\u5740\u662f <code>0xbbbb</code>\uff0c\u90a3\u4e48\u8981\u586b\u5165\u7684\u5730\u5740\u504f\u79fb\u5c31\u7b49\u4e8e <code>0xbbbb - 0x4 - 0x6 = 0xbbb1</code>\u3002\u8fd9\u4e2a\u8ba1\u7b97\u8fc7\u7a0b\u7528 ABI \u6587\u6863\u4e2d\u7684\u8868\u793a\u65b9\u6cd5\uff0c\u5c31\u662f <code>S + A - P</code>\uff0cS\uff08Symbol\uff09\u8868\u793a\u7b26\u53f7\u7684\u5730\u5740\uff08<code>print</code> \u7684\u5730\u5740\uff0c<code>S=0xbbbb</code>\uff09\uff0cA\uff08Addend\uff09\u8868\u793a\u989d\u5916\u52a0\u6216\u8005\u51cf\u53bb\u7684\u6570\uff08\u8fd9\u91cc\u662f\u51cf\u53bb 0x4\uff0c\u4e5f\u5c31\u662f <code>A=-0x4</code>\uff09\uff0cP \u8868\u793a relocation \u81ea\u5df1\u7684\u5730\u5740\uff08<code>P=0x6</code>\uff09\u3002</p>\n<p>\u8ba1\u7b97\u7ed3\u679c\u548c\u4e4b\u524d\u6211\u4eec\u624b\u52a8\u63a8\u5bfc\u7684\u662f\u4e00\u81f4\u7684\uff0c\u770b\u8d77\u6765\u8fd9\u4e24\u4e2a\u8ba1\u7b97\u65b9\u6cd5\u4f3c\u4e4e\u6ca1\u4ec0\u4e48\u533a\u522b\uff0c\u53cd\u6b63\u7ed3\u679c\u90fd\u4e00\u6837\uff1f\u533a\u522b\u5728\u4e8e\uff0c\u8fd9\u79cd\u8bbe\u8ba1\u4e0b\uff0c\u94fe\u63a5\u5668\u4e0d\u9700\u8981\u77e5\u9053\u6307\u4ee4\u662f\u4ec0\u4e48\uff0c\u4e0d\u7ba1\u662f\u4e0d\u662f <code>call</code> \u6307\u4ee4\uff0c\u53ea\u7ba1\u8ba1\u7b97\u548c\u586b\u6570\u3002\u90a3\u4e48\u5728\u4e0d\u540c\u7684\u573a\u666f\u4e0b\uff0c\u6216\u8bb8\u53ef\u4ee5\u590d\u7528\u76f8\u540c\u7684 relocation \u7c7b\u578b\u3002</p>\n</div>\n<p>relocation \u7684\u60c5\u51b5\u5206\u6790\u5b8c\u4e86\uff0c\u6211\u4eec\u5b66\u4e60\u5230\u6c47\u7f16\u5668\u5728\u9047\u5230\u5916\u90e8\u51fd\u6570\u65f6\uff0c\u5982\u4f55\u751f\u6210\u770b\u8d77\u6765\u9519\u8bef\u7684 <code>call</code> \u6307\u4ee4\uff0c\u53c8\u662f\u5982\u4f55\u8f93\u51fa relocation \u8ba9\u94fe\u63a5\u5668\u586b\u5165\u6b63\u786e\u7684\u504f\u79fb\uff0c\u4f7f\u5f97 <code>call</code> \u6307\u4ee4\u53ef\u4ee5\u8c03\u7528\u6b63\u786e\u7684\u51fd\u6570\u3002</p>\n<p>\u6b64\u65f6\u518d\u770b <code>printer.o</code> \u7684\u53cd\u6c47\u7f16\u7ed3\u679c\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>-r<span class=\"w\"> </span>printer.o\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a>printer.o:<span class=\"w\">     </span>file<span class=\"w\"> </span>format<span class=\"w\"> </span>elf64-x86-64\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;print&gt;:\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rdi\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"w\">   </span><span class=\"m\">7</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c6<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x0,%rsi\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"w\">                        </span>a:<span class=\"w\"> </span>R_X86_64_32S<span class=\"w\"> </span>.rodata\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a><span class=\"w\">   </span>e:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c2<span class=\"w\"> </span>0d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>xd,%rdx\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a><span class=\"w\">  </span><span class=\"m\">15</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rax\n</span><span id=\"__span-7-14\"><a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\" href=\"#__codelineno-7-14\"></a><span class=\"w\">  </span>1c:<span class=\"w\">   </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span><span id=\"__span-7-15\"><a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\" href=\"#__codelineno-7-15\"></a><span class=\"w\">  </span>1e:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-7-16\"><a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\" href=\"#__codelineno-7-16\"></a>\n</span><span id=\"__span-7-17\"><a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\" href=\"#__codelineno-7-17\"></a>000000000000001f<span class=\"w\"> </span>&lt;exit&gt;:\n</span><span id=\"__span-7-18\"><a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\" href=\"#__codelineno-7-18\"></a><span class=\"w\">  </span>1f:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">31</span><span class=\"w\"> </span>ff<span class=\"w\">                </span>xor<span class=\"w\">    </span>%rdi,%rdi\n</span><span id=\"__span-7-19\"><a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\" href=\"#__codelineno-7-19\"></a><span class=\"w\">  </span><span class=\"m\">22</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span>3c<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x3c,%rax\n</span><span id=\"__span-7-20\"><a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\" href=\"#__codelineno-7-20\"></a><span class=\"w\">  </span><span class=\"m\">29</span>:<span class=\"w\">   </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span></code></pre></div>\n<p>\u4e0d\u51fa\u610f\u5916\uff0c\u4e24\u4e2a\u51fd\u6570\u90fd\u51fa\u73b0\u4e86\uff0c\u540c\u65f6\u4e5f\u51fa\u73b0\u4e86\u4e0a\u4e00\u7bc7\u535a\u5ba2\u4e2d\u63d0\u5230\u7684 <code>R_X86_64_32S</code> \u7684 relocation \u7c7b\u578b\u3002\u4ed4\u7ec6\u89c2\u5bdf\uff0c\u4f1a\u53d1\u73b0\u8fd9\u4e2a relocation \u7684\u5730\u5740\u662f <code>0xa</code>\uff0c\u800c\u4e0d\u662f <code>mov</code> \u6307\u4ee4\u7684\u5730\u5740 <code>0x7</code>\uff0c\u806a\u660e\u7684\u4f60\u5e94\u8be5\u5df2\u7ecf\u89c2\u5bdf\u51fa\u6765\uff1a<code>mov</code> \u6307\u4ee4\u524d\u4e09\u4e2a\u5b57\u8282\u8868\u793a\u4e86\u8fd9\u662f\u4e00\u6761 <code>mov</code> \u6307\u4ee4\uff0c\u76ee\u7684\u5bc4\u5b58\u5668\u662f <code>%rsi</code>\uff0c\u540e\u56db\u4e2a\u5b57\u8282\u5c31\u662f\u8981 <code>mov</code> \u7684\u7acb\u5373\u6570\uff0c\u6240\u4ee5 relocation \u76f4\u63a5\u6307\u5411\u4e86\u540e\u56db\u4e2a\u5b57\u8282\u7684\u5730\u5740\u3002\u94fe\u63a5\u5668\u4e0d\u9700\u8981\u53cd\u6c47\u7f16\uff0c\u4e0d\u9700\u8981\u77e5\u9053\u8fd9\u662f\u4e00\u6761 <code>mov</code> \u6307\u4ee4\uff0c\u53ea\u7ba1\u627e relocation \u5f80\u91cc\u586b\u3002</p>\n<h3 id=\"\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\">\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6<a class=\"headerlink\" href=\"#\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5173\u4e8e\u4e24\u4e2a <code>.o</code> \u6587\u4ef6\u5206\u6790\u5f97\u5dee\u4e0d\u591a\u4e86\uff0c\u63a5\u4e0b\u6765\u770b\u6700\u540e\u8fd0\u884c <code>ld main.o printer.o -o helloworld</code> \u5f97\u5230\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"nl\">helloworld:</span><span class=\"w\">     </span><span class=\"nf\">file</span><span class=\"w\"> </span><span class=\"no\">format</span><span class=\"w\"> </span><span class=\"no\">elf64-x86-64</span>\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"nf\">Disassembly</span><span class=\"w\"> </span><span class=\"no\">of</span><span class=\"w\"> </span><span class=\"no\">section</span><span class=\"w\"> </span><span class=\"no\">.text</span><span class=\"p\">:</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a>\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"err\">0000000000401000</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">_start</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"w\">  </span><span class=\"err\">401000:</span><span class=\"w\">       </span><span class=\"nf\">e8</span><span class=\"w\"> </span><span class=\"mi\">05</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"no\">call</span><span class=\"w\">   </span><span class=\"mh\">40100a</span> <span class=\"p\">&lt;</span><span class=\"no\">print</span><span class=\"p\">&gt;</span>\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"w\">  </span><span class=\"err\">401005:</span><span class=\"w\">       </span><span class=\"nf\">e8</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"no\">call</span><span class=\"w\">   </span><span class=\"mh\">401029</span> <span class=\"p\">&lt;</span><span class=\"no\">exit</span><span class=\"p\">&gt;</span>\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a>\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a><span class=\"err\">000000000040100</span><span class=\"nf\">a</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"no\">print</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a><span class=\"w\">  </span><span class=\"err\">40100</span><span class=\"nl\">a:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"nf\">c7</span><span class=\"w\"> </span><span class=\"no\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"no\">$0x1</span><span class=\"p\">,</span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a><span class=\"w\">  </span><span class=\"err\">401011:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"nf\">c7</span><span class=\"w\"> </span><span class=\"no\">c6</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"no\">$0x402000</span><span class=\"p\">,</span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a><span class=\"w\">  </span><span class=\"err\">401018:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"nf\">c7</span><span class=\"w\"> </span><span class=\"no\">c2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"no\">d</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"no\">$0xd</span><span class=\"p\">,</span><span class=\"nv\">%rdx</span>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a><span class=\"w\">  </span><span class=\"err\">40101</span><span class=\"nl\">f:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"nf\">c7</span><span class=\"w\"> </span><span class=\"no\">c0</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"no\">$0x1</span><span class=\"p\">,</span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a><span class=\"w\">  </span><span class=\"err\">401026:</span><span class=\"w\">       </span><span class=\"err\">0</span><span class=\"nf\">f</span><span class=\"w\"> </span><span class=\"mi\">05</span><span class=\"w\">                   </span><span class=\"no\">syscall</span>\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a><span class=\"w\">  </span><span class=\"err\">401028:</span><span class=\"w\">       </span><span class=\"nf\">c3</span><span class=\"w\">                      </span><span class=\"no\">ret</span>\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a>\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a><span class=\"err\">0000000000401029</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">exit</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a><span class=\"w\">  </span><span class=\"err\">401029:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"err\">31</span><span class=\"w\"> </span><span class=\"nf\">ff</span><span class=\"w\">                </span><span class=\"no\">xor</span><span class=\"w\">    </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a><span class=\"w\">  </span><span class=\"err\">40102</span><span class=\"nl\">c:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"nf\">c7</span><span class=\"w\"> </span><span class=\"no\">c0</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"no\">c</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"no\">$0x3c</span><span class=\"p\">,</span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-8-21\"><a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\" href=\"#__codelineno-8-21\"></a><span class=\"w\">  </span><span class=\"err\">401033:</span><span class=\"w\">       </span><span class=\"err\">0</span><span class=\"nf\">f</span><span class=\"w\"> </span><span class=\"mi\">05</span><span class=\"w\">                   </span><span class=\"no\">syscall</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u5f97\u5230\u51e0\u70b9\u89c2\u5bdf\uff1a</p>\n<ol>\n<li><code>_start</code> \u51fd\u6570\u91cc\u51fd\u6570\u8c03\u7528\u7684\u6307\u4ee4 <code>call print</code> \u548c <code>call exit</code> \u5df2\u7ecf\u88ab\u94fe\u63a5\u5668\u4fee\u590d\uff0c<code>print</code> \u51fd\u6570\u5185\u5f15\u7528 <code>hello</code> \u5b57\u7b26\u4e32\u5730\u5740\u4e5f\u6b63\u786e\u88ab\u586b\u5199</li>\n<li>\u6765\u81ea\u4e24\u4e2a <code>.o</code> \u6587\u4ef6\u7684\u4ee3\u7801\u6bb5 <code>.text</code> \u7684\u5185\u5bb9\u88ab\u62fc\u63a5\u8d77\u6765\uff0c\u5f97\u5230\u4e86\u8f93\u51fa\u7684 ELF \u91cc\u7684 <code>.text</code> \u6bb5\u5185\u5bb9\uff1b\u7c7b\u4f3c\u5730\uff0c<code>printer.o</code> \u91cc\u9762\u7684\u53ea\u8bfb\u6570\u636e\u6bb5 <code>.rodata</code> \u7684\u5185\u5bb9\u4e5f\u590d\u5236\u5230\u4e86\u8f93\u51fa\u7684 ELF \u4e2d\uff0c\u5730\u5740\u662f <code>0x402000</code></li>\n<li>\u867d\u7136 <code>objdump</code> \u53c2\u6570\u91cc\u5199\u4e86 <code>-r</code>\uff0c\u8981\u6c42 <code>objdump</code> \u663e\u793a\u4ee3\u7801\u4e2d\u7684 relocation\uff0c\u4f46\u662f\u94fe\u63a5\u5668\u5df2\u7ecf\u5b8c\u6210\u4e86\u6240\u6709 relocation \u7684\u8ba1\u7b97\u5e76\u66f4\u65b0\u4e86\u5bf9\u5e94\u7684\u6570\uff0c\u56e0\u6b64\u8f93\u51fa\u7684 ELF \u91cc\u5c31\u6ca1\u6709 relocation \u4e86\u3002\u5728\u672a\u6765\u7684\u535a\u5ba2\u4e2d\uff0c\u6211\u4eec\u4f1a\u770b\u5230\uff0c\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e5f\u53ef\u4ee5\u6709 relocation</li>\n</ol>\n<h3 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6309\u7167\u8fd9\u4e9b\u89c2\u5bdf\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u51fa\uff0c\u4e3a\u4e86\u652f\u6301\u7b2c\u4e8c\u7248\u7684\u94fe\u63a5\u5668\uff0c\u4e5f\u5c31\u662f\u652f\u6301\u4e24\u4e2a\u6216\u8005\u66f4\u591a\u4e2a .o \u6587\u4ef6\u7684\u94fe\u63a5\u7684\u9759\u6001\u94fe\u63a5\u5668\uff0c\u9700\u8981\u505a\u7684\u989d\u5916\u5de5\u4f5c\uff1a</p>\n<div class=\"admonition note\">\n<p class=\"admonition-title\">\u5408\u5e76\u6765\u81ea\u591a\u4e2a\u6587\u4ef6\u7684\u540c\u4e00\u4e2a section</p>\n<p>\u4e0a\u9762\u5df2\u7ecf\u89c2\u5bdf\u5230\uff0c\u6765\u81ea\u4e0d\u540c .o \u7684 <code>.text</code> \u6bb5\u88ab\u5408\u5e76\u8d77\u6765\uff0c\u5199\u5165\u5230\u4e86\u6700\u7ec8\u8f93\u51fa\u7684 ELF \u7684 <code>.text</code> \u6bb5\u3002\u540c\u7406\uff0c\u5176\u4ed6\u9700\u8981\u8f93\u51fa\u5230\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u7684\u6bb5\uff0c\u4e5f\u9700\u8981\u5408\u5e76</p>\n</div>\n<div class=\"admonition note\">\n<p class=\"admonition-title\">\u5b8c\u5584\u6307\u5411 section \u7684 relocation \u7684\u5904\u7406</p>\n<p>\u4e0a\u4e00\u7bc7\u6587\u7ae0\u91cc\uff0c\u53ea\u6d89\u53ca\u5230\u4e00\u4e2a\u8f93\u5165\u7684 ELF object \u6587\u4ef6\uff0c\u5e76\u4e14\u4e5f\u53ea\u6d89\u53ca\u5230\u5bf9 section \u7684 relocation\uff0c\u6240\u4ee5\u6bcf\u4e2a section \u53ea\u6709\u4e00\u4efd\uff0c\u53ea\u9700\u8981\u4fdd\u5b58\u6bcf\u4e2a section \u5728\u5185\u5b58\u4e2d\u7684\u8d77\u59cb\u5730\u5740\u3002\u4f46\u6b64\u65f6\uff0c\u6bcf\u4e2a ELF object \u6587\u4ef6\u90fd\u53ef\u80fd\u6709\u81ea\u5df1\u7684 <code>.text</code> <code>.rodata</code> section\uff0c\u6b64\u65f6\u518d\u51fa\u73b0\u5bf9 section \u7684 relocation \u65f6\uff0c\u662f\u5bf9\u8f93\u5165\u7684 ELF object \u81ea\u5df1\u7684 <code>.rodata</code>\uff0c\u800c\u4e0d\u662f\u5bf9\u8f93\u51fa ELF executable \u7684 <code>.rodata</code>\u3002</p>\n<p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc\uff0c\u5982\u679c <code>main.s</code> \u548c <code>printer.s</code> \u90fd\u5f80 <code>.rodata</code> \u6bb5\u5199\u4e86\u6570\u636e\uff0c\u5047\u5982 <code>main.s</code> \u4ea7\u751f\u4e86 0x10 \u5b57\u8282\u7684\u6570\u636e\uff0c<code>printer.s</code> \u4ea7\u751f\u4e86 0x20 \u5b57\u8282\u7684\u6570\u636e\uff0c\u5047\u8bbe\u8f93\u51fa\u7684 <code>.rodata</code> \u6bb5\u4ece <code>0x402000</code> \u5730\u5740\u5f00\u59cb\uff0c\u5148\u5b58 <code>main.o</code> \u7684 <code>.rodata</code> \u7684\u5185\u5bb9\uff0c\u518d\u5b58 <code>printer.o</code> \u7684 <code>.rodata</code> \u7684\u5185\u5bb9\uff0c\u90a3\u4e48 <code>printer.o</code> \u7684 <code>.rodata</code> \u7684\u6570\u636e\u5728\u5185\u5b58\u4e2d\u7684\u8d77\u59cb\u5730\u5740\u5c31\u662f <code>0x402000 + 0x10 = 0x402010</code>\u3002</p>\n<p>\u540c\u65f6\uff0c\u5728 <code>printer.o</code> \u4e2d\uff0c<code>print</code> \u51fd\u6570\u4ea7\u751f\u4e86\u5bf9 <code>.rodata</code> \u7684 relocation\uff0c\u5b9e\u9645\u4e0a\u662f\u8981\u5f97\u5230 <code>printer.o</code> \u7684 <code>.rodata</code> \u6bb5\u4e2d\u7684 <code>Hello world</code> \u5b57\u7b26\u4e32\u7684\u8d77\u59cb\u5730\u5740\u3002\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u8ba1\u7b97 relocation \u7684\u65f6\u5019\uff0c\u5e94\u8be5\u7528 <code>0x402010</code>\uff08<code>printer.o</code> \u7684 <code>.rodata</code> \u5728\u5185\u5b58\u4e2d\u7684\u8d77\u59cb\u5730\u5740\uff09\uff0c\u800c\u4e0d\u662f <code>0x402000</code>\uff08\u8f93\u51fa\u7684 <code>.rodata</code> \u7684\u8d77\u59cb\u5730\u5740\uff09 \u4f5c\u4e3a <code>Hello world</code> \u5b57\u7b26\u4e32\u7684\u5730\u5740\u3002</p>\n<p>\u7b80\u800c\u8a00\u4e4b\uff0c\u73b0\u5728\u9700\u8981\u8bb0\u5f55\u6765\u81ea\u4e0d\u540c .o \u6587\u4ef6\u7684 section \u7684\u76f8\u5bf9\u4f4d\u7f6e\u3002\u5b9e\u9645\u4e0a\uff0c\u8fd9\u5728\u5b9e\u73b0\u4e0a\u4e5f\u5e76\u4e0d\u590d\u6742\uff0c\u53ea\u662f\u4e0d\u8981\u5fd8\u8bb0\u8fd9\u4ef6\u4e8b\u60c5\u3002</p>\n</div>\n<div class=\"admonition note\">\n<p class=\"admonition-title\">\u89e3\u6790\u548c\u7ef4\u62a4\u7b26\u53f7\u8868\uff0c\u627e\u5230\u7b26\u53f7\u5bf9\u5e94\u7684\u5730\u5740</p>\n<p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u7b26\u53f7\u8868\uff0c\u8bb0\u5f55\u5404\u4e2a\u7b26\u53f7\u5728\u5185\u5b58\u4e2d\u7684\u5730\u5740\uff0c\u90a3\u4e48\u540e\u7eed\u8ba1\u7b97 relocation \u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u5730\u5740\u4f1a\u53c2\u4e0e\u5230\u8ba1\u7b97\u5f53\u4e2d\u3002</p>\n<p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc\uff0c<code>main.s</code> \u548c <code>printer.s</code> \u90fd\u5f80 <code>.text</code> \u6bb5\u5199\u4e86\u6307\u4ee4\u3002<code>main.s</code> \u4ea7\u751f\u4e86 0xa \u5b57\u8282\u7684\u6307\u4ee4\uff0c<code>printer.s</code> \u4ea7\u751f\u4e86 0x2b \u5b57\u8282\u7684\u6307\u4ee4\u3002\u8f93\u51fa\u65f6\uff0c\u5047\u5982 <code>.text</code> \u6bb5\u4ece <code>0x401000</code> \u5f00\u59cb\uff0c\u6309\u7167\u4e0b\u9762\u7684\u903b\u8f91\u8ba1\u7b97\u5404\u4e2a\u7b26\u53f7\u7684\u5730\u5740\uff1a</p>\n<ol>\n<li>\u5148\u590d\u5236 <code>main.o</code> \u7684 <code>.text</code> \u4ee3\u7801\u6bb5\u7684\u5185\u5bb9\u5230\u8f93\u51fa\u7684 <code>.text</code> \u6bb5\uff0c\u6b64\u65f6\u8fd9\u90e8\u5206\u6307\u4ee4\u7684\u7684\u8d77\u59cb\u5185\u5b58\u5730\u5740\u5c31\u662f <code>0x401000</code></li>\n<li>\u7531\u4e8e <code>_start</code> \u51fd\u6570\u5728 <code>main.o</code> \u7684 <code>.text</code> \u6bb5\u5185\u7684\u504f\u79fb\u662f <code>0x0</code>\uff0c\u6240\u4ee5\u5b83\u5728\u5185\u5b58\u4e2d\u7684\u5730\u5740\u5c31\u662f <code>0x401000 + 0x0 = 0x401000</code></li>\n<li>\u63a5\u7740\u590d\u5236 <code>printer.o</code> \u7684 <code>.text</code> \u4ee3\u7801\u6bb5\u7684\u5185\u5bb9\u5230\u8f93\u51fa\u7684 <code>.text</code> \u6bb5\uff0c\u7531\u4e8e\u524d\u9762\u5df2\u7ecf\u6709 0xa \u4e2a\u5b57\u8282\u7684\u6570\u636e\u4e86\uff0c\u6240\u4ee5\u8fd9\u90e8\u5206\u6307\u4ee4\u7684\u8d77\u59cb\u5185\u5b58\u5730\u5740\u5c31\u662f <code>0x40100a</code></li>\n<li><code>print</code> \u51fd\u6570\u5728 <code>printer.o</code> \u7684 <code>.text</code> \u6bb5\u5185\u7684\u504f\u79fb\u662f <code>0x0</code>\uff0c\u6240\u4ee5\u5b83\u5728\u5185\u5b58\u4e2d\u7684\u5730\u5740\u5c31\u662f <code>0x40100a + 0x0 = 0x40100a</code></li>\n<li><code>exit</code> \u51fd\u6570\u5728 <code>printer.o</code> \u7684 <code>.text</code> \u6bb5\u5185\u7684\u504f\u79fb\u662f <code>0x1f</code>\uff0c\u6240\u4ee5\u5b83\u5728\u5185\u5b58\u4e2d\u7684\u5730\u5740\u5c31\u662f <code>0x40100a + 0x1f = 0x401029</code></li>\n</ol>\n<p>\u6240\u4ee5\u5728\u590d\u5236\u6bb5\u5185\u5bb9\u7684\u540c\u65f6\uff0c\u5404\u4e2a\u7b26\u53f7\u7684\u5730\u5740\u4e5f\u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u6765\u4e86\u3002\u6709\u4e86\u7b26\u53f7\u8868\u4ee5\u540e\uff0c\u4e4b\u540e\u8ba1\u7b97\u9488\u5bf9 <code>print</code> \u548c <code>exit</code> \u7684 relocation \u7684\u65f6\u5019\uff0c\u67e5\u7b26\u53f7\u8868\u5c31\u53ef\u4ee5\u77e5\u9053\u5730\u5740\u4e86\u3002</p>\n</div>\n<h2 id=\"\u5b9e\u73b0\">\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7ed3\u5408\u4ee5\u4e0a\u7684\u5206\u6790\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u4e0a\u4e00\u6b21\u535a\u5ba2\u7684\u57fa\u7840\u4e0a\u5b9e\u73b0\u7b2c\u4e8c\u7248\u7684\u94fe\u63a5\u5668\uff0c\u8fd9\u4e2a\u94fe\u63a5\u5668\u53ef\u4ee5\u652f\u6301\u8f93\u5165\u591a\u4e2a ELF .o \u6587\u4ef6\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u6211\u7528 Rust \u5b8c\u6210\u4e86\u5b9e\u73b0\uff0c\u94fe\u63a5\u5668\u90e8\u5206\u7684\u4ee3\u7801\u91cf\u5927\u6982\u662f 400 \u884c\uff0c\u6bd4\u4e0a\u4e00\u4e2a\u7248\u672c\u591a 200 \u884c\u3002</p>", "image": null, "date_published": "2024-03-30T00:00:00+00:00", "authors": [], "tags": ["elf", "linker", "linux", "software", "write-a-linker"]}, {"id": "https://jia.je/software/2024/02/18/write-a-linker-1/", "url": "https://jia.je/software/2024/02/18/write-a-linker-1/", "title": "\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff081\uff09", "content_html": "<h1 id=\"\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56681\">\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff081\uff09<a class=\"headerlink\" href=\"#\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u56681\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u524d\u8a00\">\u524d\u8a00<a class=\"headerlink\" href=\"#\u524d\u8a00\" title=\"Permanent link\">&para;</a></h2>\n<p>\u65e0\u8bba\u662f\u5728\u8bfe\u7a0b\u4e2d\u8fd8\u662f\u5b9e\u8df5\u4e2d\uff0c\u90fd\u7ecf\u5e38\u548c\u94fe\u63a5\u5668\u6253\u4ea4\u9053\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u5927\u6982\u4e86\u89e3\u4e86\u5b83\u7684\u5de5\u4f5c\u539f\u7406\uff0c\u5bf9\u4e8e\u5e38\u89c1\u7684\u9519\u8bef\u53ef\u4ee5\u77e5\u9053\u5927\u6982\u662f\u600e\u4e48\u4e00\u56de\u4e8b\uff0c\u4ee5\u53ca\u5982\u4f55\u89e3\u51b3\u3002\u4f46\u6700\u8fd1\u9047\u5230\u4e00\u4e9b\u6d89\u53ca\u5230\u94fe\u63a5\u5668\u5185\u90e8\u7684\u95ee\u9898\uff0c\u624d\u53d1\u73b0\u81ea\u5df1\u5bf9\u94fe\u63a5\u5668\u7684\u5185\u90e8\u7684\u4e86\u89e3\u8fd8\u662f\u6bd4\u8f83\u532e\u4e4f\u7684\u3002\u56e0\u6b64\u60f3\u5230\u81ea\u5df1\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff0c\u5728\u5f00\u53d1\u7684\u8fc7\u7a0b\u4e2d\u5b66\u4e60\u3002</p>\n<!-- more -->\n\n<p>\u672c\u6587\u5047\u5b9a\u8bfb\u8005\u5df2\u7ecf\u5bf9\u94fe\u63a5\u5668\u6709\u4e86\u4e00\u5b9a\u7684\u4e86\u89e3\uff0c\u5982\u679c\u4f60\u8fd8\u4e0d\u4e86\u89e3\u94fe\u63a5\u7684\u5927\u81f4\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u5148\u5b66\u4e60\u7f51\u7edc\u4e0a\u7684\u8d44\u6599\u3002</p>\n<p>\u8fd9\u4e2a\u7cfb\u5217\u7684\u7b2c\u4e00\u7bc7\u535a\u5ba2\u7684\u76ee\u6807\u662f\uff1a\u5b9e\u73b0\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u9759\u6001\u94fe\u63a5\u5668\uff0c\u8f93\u5165\u5355\u4e2a ELF .o \u6587\u4ef6\uff0c\u8f93\u51fa ELF \u53ef\u6267\u884c\u6587\u4ef6\u3002</p>\n<h2 id=\"\u5206\u6790\">\u5206\u6790<a class=\"headerlink\" href=\"#\u5206\u6790\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6\">\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6<a class=\"headerlink\" href=\"#\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff0c\u5148\u4ece\u6700\u7b80\u5355\u7684\u60c5\u51b5\u5f00\u59cb\uff1a\u8f93\u5165\u4e00\u4e2a ELF .o \u6587\u4ef6\uff0c\u8f93\u51fa\u4e00\u4e2a ELF \u53ef\u6267\u884c\u6587\u4ef6\u3002\u4e3a\u4e86\u907f\u514d\u5f15\u5165 libc \u7b49\u4f9d\u8d56\uff0c\u4ece\u7f51\u4e0a\u627e\u4e86\u4e00\u6bb5\u76f4\u63a5\u7528 syscall \u6253\u5370\u5b57\u7b26\u4e32\u7684\u6c47\u7f16\u4ee3\u7801\uff0c\u505a\u4e86\u7b80\u5355\u4fee\u6539\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\"># From https://gist.github.com/adrianratnapala/1321776</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"c1\"># Hello World on amd64 under Linux.</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"c1\">#</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"c1\"># One way to build this is with: </span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"c1\">#</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"c1\">#    gcc hello.S  -s -nostartfiles -nostdlib -o hello</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"c1\">#</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"c1\"># for syscall numbers look in /usr/include/asm/unistd_64.h</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"c1\"># for examples look at http://99-bottles-of-beer.net/language-assembler-(amd64)-933.html</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"c1\"># for inspiration look at http://www.muppetlabs.com/~breadbox/software/tiny/teensy.html</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.rodata</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"nl\">hello:</span>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"na\">.string</span><span class=\"w\"> </span><span class=\"s\">&quot;Hello world!\\n&quot;</span>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"w\">    </span><span class=\"na\">.section</span><span class=\"w\"> </span><span class=\"no\">.text</span>\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a><span class=\"w\">    </span><span class=\"na\">.globl</span><span class=\"w\"> </span><span class=\"no\">_start</span>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"nl\">_start:</span>\n</span><span id=\"__span-0-20\"><a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\" href=\"#__codelineno-0-20\"></a><span class=\"w\">    </span><span class=\"c1\"># write(1, hello, 13)</span>\n</span><span id=\"__span-0-21\"><a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\" href=\"#__codelineno-0-21\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-0-22\"><a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\" href=\"#__codelineno-0-22\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$hello</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-0-23\"><a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\" href=\"#__codelineno-0-23\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span>\n</span><span id=\"__span-0-24\"><a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\" href=\"#__codelineno-0-24\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-0-25\"><a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\" href=\"#__codelineno-0-25\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span><span id=\"__span-0-26\"><a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\" href=\"#__codelineno-0-26\"></a>\n</span><span id=\"__span-0-27\"><a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\" href=\"#__codelineno-0-27\"></a><span class=\"w\">    </span><span class=\"c1\"># _exit(0)</span>\n</span><span id=\"__span-0-28\"><a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\" href=\"#__codelineno-0-28\"></a><span class=\"w\">    </span><span class=\"nf\">xor</span><span class=\"w\">     </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-0-29\"><a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\" href=\"#__codelineno-0-29\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-0-30\"><a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\" href=\"#__codelineno-0-30\"></a><span class=\"w\">    </span><span class=\"nf\">syscall</span>\n</span></code></pre></div>\n<details class=\"question\">\n<summary>\u8fd9\u6bb5\u6c47\u7f16\u505a\u4e86\u4ec0\u4e48\uff1f</summary>\n<p>\u8fd9\u6bb5\u6c47\u7f16\u8981\u5b9e\u73b0\u7684\u662f\u5411\u6807\u51c6\u8f93\u51fa\u6253\u5370 <code>Hello world!\\n</code>\uff0c\u4f46\u4e3a\u4e86\u907f\u514d\u5f15\u5165 C \u6807\u51c6\u5e93\uff08libc\uff09\uff0c\u53ea\u80fd\u76f4\u63a5\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u6765\u5b8c\u6210\u6253\u5370\u3002\u5728 Linux \u4e2d\uff0c\u5411\u6807\u51c6\u8f93\u51fa\u6253\u5370\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u5411\u6807\u51c6\u8f93\u51fa\u5bf9\u5e94\u7684 file handle\uff08\u7b80\u79f0 fd\uff0c\u901a\u5e38\u7ea6\u5b9a\u6807\u51c6\u8f93\u5165 stdin \u662f 0\uff0c\u6807\u51c6\u8f93\u51fa stdout \u662f 1\uff0c\u6807\u51c6\u9519\u8bef\u8f93\u51fa stderr \u662f 2\uff09\u5199\u5165\u8981\u6253\u5370\u7684\u5185\u5bb9\u3002\u800c\u8fd9\u4e2a\u9700\u8981\u901a\u8fc7\u8c03\u7528 <code>write</code> syscall \u6765\u5b9e\u73b0\u3002</p>\n<p>\u77e5\u9053\u8fd9\u4e00\u70b9\u4ee5\u540e\uff0c\u5c31\u8981\u53bb\u67e5\u627e Linux \u7684 <a href=\"https://man7.org/linux/man-pages/man2/write.2.html\">write syscall</a> \u7684\u6587\u6863\u3002\u6587\u6863\u544a\u8bc9\u4f60\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f <code>fd</code>\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570 <code>buf</code> \u6307\u5411\u8981\u5199\u5165\u7684\u6570\u636e\uff0c\u7b2c\u4e09\u4e2a\u53c2\u6570 <code>count</code> \u662f\u8981\u5199\u5165\u7684\u6570\u636e\u7684\u957f\u5ea6\u3002\u7ed3\u5408\u4e0a\u9762\u7684\u5185\u5bb9\uff0c\u4e3a\u4e86\u6253\u5370 <code>Hello world!\\n</code>\uff0c\u5b9e\u9645\u4e0a\u8981\u5b8c\u6210\u7684\u76f8\u5f53\u4e8e\u662f C \u4ee3\u7801\u4e2d\u7684 <code>write(1, hello, 13)</code>\uff0c\u5176\u4e2d 1 \u5c31\u662f stdout \u7684 fd\uff0c<code>hello</code> \u6307\u5411\u4fdd\u5b58 <code>Hello world!\\n</code> \u5b57\u7b26\u4e32\u7684\u5730\u5740\uff0c13 \u662f\u5b57\u7b26\u4e32\u7684\u957f\u5ea6\u3002\u90a3\u4e48\u63a5\u4e0b\u6765\u5c31\u8981\u7814\u7a76\uff0c\u5982\u4f55\u7528\u6c47\u7f16\u8c03\u7528 syscall\u3002</p>\n<p>\u63a5\u4e0b\u6765\uff0c\u8981\u77e5\u9053\u5728 amd64 Linux \u4e0b\uff0c\u5982\u4f55\u7528\u6c47\u7f16\u8c03\u7528 syscall\u3002\u9996\u5148\u627e\u5230 <a href=\"https://www.ucw.cz/~hubicka/papers/abi/node33.html#features\">amd64 Linux syscall \u8c03\u7528\u7ea6\u5b9a</a>\uff0c\u5b83\u544a\u8bc9\u6211\u4eec\uff1a</p>\n<ol>\n<li>syscall \u7f16\u53f7\u4fdd\u5b58\u5728 rax \u5bc4\u5b58\u5668\u4e2d</li>\n<li>syscall \u7684\u53c2\u6570\u6309\u987a\u5e8f\uff0c\u4f9d\u6b21\u4fdd\u5b58\u5728 rdi, rsi, rdx, r10, r8, r9 \u5bc4\u5b58\u5668\u4e2d</li>\n<li>\u7528 syscall \u6307\u4ee4\u8c03\u7528 syscall</li>\n<li>syscall \u7684\u8fd4\u56de\u503c\u4e5f\u4f1a\u4fdd\u5b58\u5728 rax \u5bc4\u5b58\u5668\u4e2d</li>\n</ol>\n<p>\u65e2\u7136\u8981\u8c03\u7528 <code>write(1, hello, 13)</code>\uff0c\u90a3\u5c31\u6309\u7167\u4e0a\u9762\u7684\u8981\u6c42\uff0c\u8bbe\u7f6e <code>rdi=1</code>\u3001<code>rsi=hello</code> \u548c <code>rdx=13</code>\uff0c\u6700\u540e\u5728 <a href=\"https://filippo.io/linux-syscall-table/\">amd64 Linux syscall table</a> \u4e2d\u627e\u5230 <code>write</code> syscall \u7684\u7f16\u53f7\u662f 1\uff0c\u6240\u4ee5\u8bbe\u7f6e <code>rax=1</code>\u3002\u5230\u8fd9\u91cc\uff0c\u8c03\u7528 <code>write</code> syscall \u7684\u6240\u6709\u51c6\u5907\u4efb\u52a1\u90fd\u5df2\u7ecf\u5b8c\u6210\uff0c\u8c03\u7528 <code>syscall</code> \u6307\u4ee4\u5373\u53ef\u5b8c\u6210\u7cfb\u7edf\u8c03\u7528\u3002\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u4e00\u6b21 <code>Hello world!\\n</code> \u7684\u6253\u5370\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\"># write(1, hello, 13)</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$hello</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"nf\">mov</span><span class=\"w\">     </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"nf\">syscall</span>\n</span></code></pre></div>\n<p>\u540e\u9762 <code>exit(0)</code> \u7684\u7cfb\u7edf\u8c03\u7528\u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002\u4ee3\u7801\u4e2d\u5199 <code>_exit(0)</code> \u662f\u4e3a\u4e86\u548c C \u6807\u51c6\u5e93\u4e2d\u7684 <code>exit(0)</code> \u505a\u533a\u5206\uff1a\u524d\u8005\u76f4\u63a5\u9000\u51fa\u7a0b\u5e8f\uff08\u53ea\u4f1a\u7ed3\u675f\u5f53\u524d\u7ebf\u7a0b\uff0c\u4f46\u662f\u7531\u4e8e\u5f53\u524d\u8fdb\u7a0b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u6240\u4ee5\u6574\u4e2a\u8fdb\u7a0b\u90fd\u7ed3\u675f\u4e86\uff09\uff0c\u800c\u540e\u8005\u4f1a\u505a\u4e00\u4e9b\u6e05\u7406\u5de5\u4f5c\uff0c\u89c1 <a href=\"https://man7.org/linux/man-pages/man2/exit.2.html\">_exit manpage</a>\u3002</p>\n</details>\n<p>\u7531\u4e8e\u662f\u6c47\u7f16\u4ee3\u7801\uff0c\u6240\u4ee5\u76f4\u63a5\u8c03\u7528\u6c47\u7f16\u5668\u751f\u6210 ELF .o \u6587\u4ef6\uff0c\u7136\u540e\u89c2\u5bdf\u5b83\u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\"># Use assembler (GNU as) to assemble</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>helloworld_asm.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>helloworld_asm.o\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"c1\"># readelf -a, --all: Equivalent to: -h -l -S -s -r -d -V -A -I</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"c1\">#         -h, --file-header: Display the ELF file header</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"c1\">#         -l, --program-headers: Display the program headers</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"c1\">#         -S, --section-headers: Display the sections&#39; header</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"c1\">#         -s, --syms: Display the symbol table</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"c1\">#         -r, --relocs: Display the relocations (if present)</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a><span class=\"c1\">#         -d, --dynamic: Display the dynamic section (if present)</span>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"c1\">#         -V, --version-info: Display the version sections (if present)</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"c1\">#         -A, --arch-specific: Display architecture specific information (if any)</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"c1\">#         -I, --histogram: Display histogram of bucket list lengths</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a>$<span class=\"w\"> </span>readelf<span class=\"w\"> </span>-a<span class=\"w\"> </span>helloworld_asm.o\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"c1\"># Output is shown below</span>\n</span></code></pre></div>\n<p>\u4e0b\u9762\u89c2\u5bdf readelf \u547d\u4ee4\u7684\u8f93\u51fa\uff0c\u9996\u5148\u662f ELF \u7684\u5934\u90e8\uff0c\u4ea4\u4ee3\u4e86\u6587\u4ef6\u7c7b\u578b\uff0c\u6267\u884c\u5728\u4ec0\u4e48\u6307\u4ee4\u96c6\u67b6\u6784\u4e0a\u7b49\u7b49\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a>ELF<span class=\"w\"> </span>Header:\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">  </span>Magic:<span class=\"w\">   </span>7f<span class=\"w\"> </span><span class=\"m\">45</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">46</span><span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">  </span>Class:<span class=\"w\">                             </span>ELF64\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">  </span>Data:<span class=\"w\">                              </span><span class=\"m\">2</span><span class=\"err\">&#39;</span>s<span class=\"w\"> </span>complement,<span class=\"w\"> </span>little<span class=\"w\"> </span>endian\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span>current<span class=\"o\">)</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">  </span>OS/ABI:<span class=\"w\">                            </span>UNIX<span class=\"w\"> </span>-<span class=\"w\"> </span>System<span class=\"w\"> </span>V\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">  </span>ABI<span class=\"w\"> </span>Version:<span class=\"w\">                       </span><span class=\"m\">0</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">  </span>Type:<span class=\"w\">                              </span>REL<span class=\"w\"> </span><span class=\"o\">(</span>Relocatable<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">  </span>Machine:<span class=\"w\">                           </span>Advanced<span class=\"w\"> </span>Micro<span class=\"w\"> </span>Devices<span class=\"w\"> </span>X86-64\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span>0x1\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">  </span>Entry<span class=\"w\"> </span>point<span class=\"w\"> </span>address:<span class=\"w\">               </span>0x0\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">320</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a><span class=\"w\">  </span>Flags:<span class=\"w\">                             </span>0x0\n</span><span id=\"__span-3-15\"><a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\" href=\"#__codelineno-3-15\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>header:<span class=\"w\">               </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-3-16\"><a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\" href=\"#__codelineno-3-16\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-3-17\"><a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\" href=\"#__codelineno-3-17\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">0</span>\n</span><span id=\"__span-3-18\"><a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\" href=\"#__codelineno-3-18\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-3-19\"><a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\" href=\"#__codelineno-3-19\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">9</span>\n</span><span id=\"__span-3-20\"><a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\" href=\"#__codelineno-3-20\"></a><span class=\"w\">  </span>Section<span class=\"w\"> </span>header<span class=\"w\"> </span>string<span class=\"w\"> </span>table<span class=\"w\"> </span>index:<span class=\"w\"> </span><span class=\"m\">8</span>\n</span></code></pre></div>\n<p>\u63a5\u4e0b\u6765\u662f\u6bd4\u8f83\u91cd\u8981\u7684\u90e8\u5206\uff0cELF \u5305\u62ec\u591a\u4e2a section\uff0c\u6839\u636e\u7528\u9014\uff0c\u4e0d\u540c\u7684\u6307\u4ee4\u548c\u6570\u636e\u4f1a\u653e\u5728\u5bf9\u5e94\u7684 section \u4e2d\uff0c\u4f8b\u5982 .text \u5b58\u653e\u6307\u4ee4\uff0c.data .bss .rodata \u5b58\u653e\u5404\u79cd\u6570\u636e\uff0c.rela \u5b58\u653e\u91cd\u5b9a\u4f4d\uff08relocation\uff09\u3002</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>Section<span class=\"w\"> </span>Headers:\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"w\">  </span><span class=\"o\">[</span>Nr<span class=\"o\">]</span><span class=\"w\"> </span>Name<span class=\"w\">              </span>Type<span class=\"w\">             </span>Address<span class=\"w\">           </span>Offset\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"w\">       </span>Size<span class=\"w\">              </span>EntSize<span class=\"w\">          </span>Flags<span class=\"w\">  </span>Link<span class=\"w\">  </span>Info<span class=\"w\">  </span>Align\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\">                   </span>NULL<span class=\"w\">             </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00000000</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span>.text<span class=\"w\">             </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00000040</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"w\">       </span>000000000000002a<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>AX<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span>.rela.text<span class=\"w\">        </span>RELA<span class=\"w\">             </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>000000e8\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000018</span><span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">   </span>I<span class=\"w\">       </span><span class=\"m\">6</span><span class=\"w\">     </span><span class=\"m\">1</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span>.data<span class=\"w\">             </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>0000006a\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>WA<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span>.bss<span class=\"w\">              </span>NOBITS<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>0000006a\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>WA<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span>.rodata<span class=\"w\">           </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>0000006a\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a><span class=\"w\">       </span>000000000000000e<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">6</span><span class=\"o\">]</span><span class=\"w\"> </span>.symtab<span class=\"w\">           </span>SYMTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00000078</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000060</span><span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">           </span><span class=\"m\">7</span><span class=\"w\">     </span><span class=\"m\">3</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-4-18\"><a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\" href=\"#__codelineno-4-18\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">7</span><span class=\"o\">]</span><span class=\"w\"> </span>.strtab<span class=\"w\">           </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>000000d8\n</span><span id=\"__span-4-19\"><a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\" href=\"#__codelineno-4-19\"></a><span class=\"w\">       </span>000000000000000e<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-4-20\"><a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\" href=\"#__codelineno-4-20\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"o\">]</span><span class=\"w\"> </span>.shstrtab<span class=\"w\">         </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00000100</span>\n</span><span id=\"__span-4-21\"><a id=\"__codelineno-4-21\" name=\"__codelineno-4-21\" href=\"#__codelineno-4-21\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000039</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-4-22\"><a id=\"__codelineno-4-22\" name=\"__codelineno-4-22\" href=\"#__codelineno-4-22\"></a>Key<span class=\"w\"> </span>to<span class=\"w\"> </span>Flags:\n</span><span id=\"__span-4-23\"><a id=\"__codelineno-4-23\" name=\"__codelineno-4-23\" href=\"#__codelineno-4-23\"></a><span class=\"w\">  </span>W<span class=\"w\"> </span><span class=\"o\">(</span>write<span class=\"o\">)</span>,<span class=\"w\"> </span>A<span class=\"w\"> </span><span class=\"o\">(</span>alloc<span class=\"o\">)</span>,<span class=\"w\"> </span>X<span class=\"w\"> </span><span class=\"o\">(</span>execute<span class=\"o\">)</span>,<span class=\"w\"> </span>M<span class=\"w\"> </span><span class=\"o\">(</span>merge<span class=\"o\">)</span>,<span class=\"w\"> </span>S<span class=\"w\"> </span><span class=\"o\">(</span>strings<span class=\"o\">)</span>,<span class=\"w\"> </span>I<span class=\"w\"> </span><span class=\"o\">(</span>info<span class=\"o\">)</span>,\n</span><span id=\"__span-4-24\"><a id=\"__codelineno-4-24\" name=\"__codelineno-4-24\" href=\"#__codelineno-4-24\"></a><span class=\"w\">  </span>L<span class=\"w\"> </span><span class=\"o\">(</span>link<span class=\"w\"> </span>order<span class=\"o\">)</span>,<span class=\"w\"> </span>O<span class=\"w\"> </span><span class=\"o\">(</span>extra<span class=\"w\"> </span>OS<span class=\"w\"> </span>processing<span class=\"w\"> </span>required<span class=\"o\">)</span>,<span class=\"w\"> </span>G<span class=\"w\"> </span><span class=\"o\">(</span>group<span class=\"o\">)</span>,<span class=\"w\"> </span>T<span class=\"w\"> </span><span class=\"o\">(</span>TLS<span class=\"o\">)</span>,\n</span><span id=\"__span-4-25\"><a id=\"__codelineno-4-25\" name=\"__codelineno-4-25\" href=\"#__codelineno-4-25\"></a><span class=\"w\">  </span>C<span class=\"w\"> </span><span class=\"o\">(</span>compressed<span class=\"o\">)</span>,<span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"o\">(</span>unknown<span class=\"o\">)</span>,<span class=\"w\"> </span>o<span class=\"w\"> </span><span class=\"o\">(</span>OS<span class=\"w\"> </span>specific<span class=\"o\">)</span>,<span class=\"w\"> </span>E<span class=\"w\"> </span><span class=\"o\">(</span>exclude<span class=\"o\">)</span>,\n</span><span id=\"__span-4-26\"><a id=\"__codelineno-4-26\" name=\"__codelineno-4-26\" href=\"#__codelineno-4-26\"></a><span class=\"w\">  </span>D<span class=\"w\"> </span><span class=\"o\">(</span>mbind<span class=\"o\">)</span>,<span class=\"w\"> </span>l<span class=\"w\"> </span><span class=\"o\">(</span>large<span class=\"o\">)</span>,<span class=\"w\"> </span>p<span class=\"w\"> </span><span class=\"o\">(</span>processor<span class=\"w\"> </span>specific<span class=\"o\">)</span>\n</span></code></pre></div>\n<p>\u90a3\u4e48\u94fe\u63a5\u5668\u9700\u8981\u7279\u522b\u5173\u6ce8\u548c\u5904\u7406\u7684\u5c31\u662f\u91cc\u9762\u7684 relocation \u4ee5\u53ca\u7b26\u53f7\u8868\uff08Symbol table\uff09\u4e86\uff1a\u5728\u6c47\u7f16\u751f\u6210 .o \u6587\u4ef6\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u6307\u4ee4\u5f15\u7528\u4e86\u6570\u636e\uff08\"Hello world!\\n\"\uff09\uff0c\u4f46\u662f\u53c8\u65e0\u6cd5\u63d0\u524d\u77e5\u9053\u6570\u636e\u6240\u5904\u7684\u5730\u5740\uff0c\u56e0\u6b64\u6c47\u7f16\u5668\u4f1a\u751f\u6210\u4e00\u4e2a relocation \u6761\u76ee\uff0c\u4e5f\u5c31\u662f\u4e0b\u9762\u7684 <code>R_X86_64_32S</code>\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a>Relocation<span class=\"w\"> </span>section<span class=\"w\"> </span><span class=\"s1\">&#39;.rela.text&#39;</span><span class=\"w\"> </span>at<span class=\"w\"> </span>offset<span class=\"w\"> </span>0xe8<span class=\"w\"> </span>contains<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>entry:\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"w\">  </span>Offset<span class=\"w\">          </span>Info<span class=\"w\">           </span>Type<span class=\"w\">           </span>Sym.<span class=\"w\"> </span>Value<span class=\"w\">    </span>Sym.<span class=\"w\"> </span>Name<span class=\"w\"> </span>+<span class=\"w\"> </span>Addend\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a>00000000000a<span class=\"w\">  </span>00010000000b<span class=\"w\"> </span>R_X86_64_32S<span class=\"w\">      </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>.rodata<span class=\"w\"> </span>+<span class=\"w\"> </span><span class=\"m\">0</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a>No<span class=\"w\"> </span>processor<span class=\"w\"> </span>specific<span class=\"w\"> </span>unwind<span class=\"w\"> </span>information<span class=\"w\"> </span>to<span class=\"w\"> </span>decode\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>Symbol<span class=\"w\"> </span>table<span class=\"w\"> </span><span class=\"s1\">&#39;.symtab&#39;</span><span class=\"w\"> </span>contains<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>entries:\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a><span class=\"w\">   </span>Num:<span class=\"w\">    </span>Value<span class=\"w\">          </span>Size<span class=\"w\"> </span>Type<span class=\"w\">    </span>Bind<span class=\"w\">   </span>Vis<span class=\"w\">      </span>Ndx<span class=\"w\"> </span>Name\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"w\">     </span><span class=\"m\">0</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">  </span>UND<span class=\"w\"> </span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">     </span><span class=\"m\">1</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>SECTION<span class=\"w\"> </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">5</span><span class=\"w\"> </span>.rodata\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\">     </span><span class=\"m\">2</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>LOCAL<span class=\"w\">  </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">5</span><span class=\"w\"> </span>hello\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">     </span><span class=\"m\">3</span>:<span class=\"w\"> </span><span class=\"m\">0000000000000000</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span>NOTYPE<span class=\"w\">  </span>GLOBAL<span class=\"w\"> </span>DEFAULT<span class=\"w\">    </span><span class=\"m\">1</span><span class=\"w\"> </span>_start\n</span></code></pre></div>\n<p>\u800c\u5f53\u94fe\u63a5\u5668\u786e\u5b9a\u4e86\u4ee3\u7801\u548c\u6570\u636e\u7684\u5730\u5740\u4ee5\u540e\uff0c\u53d1\u73b0\u90e8\u5206 relocation \u7684\u5730\u5740\u5df2\u7ecf\u53ef\u4ee5\u786e\u5b9a\u4e0b\u6765\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u76f4\u63a5\u628a\u5730\u5740\u5199\u5165\u5230\u6307\u4ee4\u4e2d\uff0c\u4e0d\u518d\u9700\u8981\u52a8\u6001\u7684 relocation\u3002\u7b26\u53f7\u8868\u5219\u63d0\u4f9b\u4e86\u7b26\u53f7\u5230\u5730\u5740\u7684\u6620\u5c04\uff0c\u505a\u7b26\u53f7\u89e3\u6790\u7684\u65f6\u5019\u4f1a\u7528\u5230\u3002</p>\n<h3 id=\"\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\">\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6<a class=\"headerlink\" href=\"#\u89c2\u5bdf\u53ef\u6267\u884c\u6587\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u6211\u4eec\u8981\u5b9e\u73b0\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u94fe\u63a5\u5668\uff0c\u5c31\u628a\u8fd9\u4e00\u4e2a ELF .o \u751f\u6210\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u3002\u53ef\u4ee5\u5148\u8ba9\u73b0\u6709\u7684 ld \u94fe\u63a5\u51fa\u6765\uff0c\u770b\u770b\u5b83\u7684\u6700\u7ec8\u6548\u679c\u662f\u4ec0\u4e48\u6837\u7684\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"c1\"># Use ld (GNU ld.bfd) to link</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a>$<span class=\"w\"> </span>ld<span class=\"w\"> </span>helloworld_asm.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>helloworld_asm\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>$<span class=\"w\"> </span>readelf<span class=\"w\"> </span>-a<span class=\"w\"> </span>helloworld_asm\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"c1\"># Output is shown below</span>\n</span></code></pre></div>\n<p>\u9996\u5148\u662f ELF \u7684\u5934\u90e8\uff0c\u8fd9\u6b21\u53ef\u4ee5\u770b\u5230\u6587\u4ef6\u7c7b\u578b\u53d8\u6210\u4e86\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u5e76\u4e14\u6709\u4e86\u4e00\u4e2a\u5165\u53e3\u5730\u5740\uff080x401000\uff09\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a>ELF<span class=\"w\"> </span>Header:\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"w\">  </span>Magic:<span class=\"w\">   </span>7f<span class=\"w\"> </span><span class=\"m\">45</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">46</span><span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"w\">  </span>Class:<span class=\"w\">                             </span>ELF64\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"w\">  </span>Data:<span class=\"w\">                              </span><span class=\"m\">2</span><span class=\"err\">&#39;</span>s<span class=\"w\"> </span>complement,<span class=\"w\"> </span>little<span class=\"w\"> </span>endian\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span>current<span class=\"o\">)</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a><span class=\"w\">  </span>OS/ABI:<span class=\"w\">                            </span>UNIX<span class=\"w\"> </span>-<span class=\"w\"> </span>System<span class=\"w\"> </span>V\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"w\">  </span>ABI<span class=\"w\"> </span>Version:<span class=\"w\">                       </span><span class=\"m\">0</span>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"w\">  </span>Type:<span class=\"w\">                              </span>EXEC<span class=\"w\"> </span><span class=\"o\">(</span>Executable<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a><span class=\"w\">  </span>Machine:<span class=\"w\">                           </span>Advanced<span class=\"w\"> </span>Micro<span class=\"w\"> </span>Devices<span class=\"w\"> </span>X86-64\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"w\">  </span>Version:<span class=\"w\">                           </span>0x1\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"w\">  </span>Entry<span class=\"w\"> </span>point<span class=\"w\"> </span>address:<span class=\"w\">               </span>0x401000\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a><span class=\"w\">  </span>Start<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">          </span><span class=\"m\">8472</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"w\"> </span>into<span class=\"w\"> </span>file<span class=\"o\">)</span>\n</span><span id=\"__span-7-14\"><a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\" href=\"#__codelineno-7-14\"></a><span class=\"w\">  </span>Flags:<span class=\"w\">                             </span>0x0\n</span><span id=\"__span-7-15\"><a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\" href=\"#__codelineno-7-15\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>this<span class=\"w\"> </span>header:<span class=\"w\">               </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-7-16\"><a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\" href=\"#__codelineno-7-16\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">56</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-7-17\"><a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\" href=\"#__codelineno-7-17\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>program<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">3</span>\n</span><span id=\"__span-7-18\"><a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\" href=\"#__codelineno-7-18\"></a><span class=\"w\">  </span>Size<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">           </span><span class=\"m\">64</span><span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>\n</span><span id=\"__span-7-19\"><a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\" href=\"#__codelineno-7-19\"></a><span class=\"w\">  </span>Number<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>headers:<span class=\"w\">         </span><span class=\"m\">6</span>\n</span><span id=\"__span-7-20\"><a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\" href=\"#__codelineno-7-20\"></a><span class=\"w\">  </span>Section<span class=\"w\"> </span>header<span class=\"w\"> </span>string<span class=\"w\"> </span>table<span class=\"w\"> </span>index:<span class=\"w\"> </span><span class=\"m\">5</span>\n</span></code></pre></div>\n<p>\u800c section \u4e5f\u53d8\u5f97\u66f4\u5c11\uff1a\u6ca1\u7528\u5230\u7684 .data .bss \u6bb5\u90fd\u5220\u6389\u4e86\uff0c\u5e76\u4e14\u4e5f\u6ca1\u6709\u4e86 relocation\uff0c\u8fd9\u662f\u56e0\u4e3a\u8fd9\u4e2a\u7a0b\u5e8f\u91cc\u6240\u6709\u7684 relocation \u90fd\u662f\u5185\u90e8\u7684\uff0c\u94fe\u63a5\u7684\u65f6\u5019\u5c31\u76f4\u63a5\u8ba1\u7b97\u51fa\u5730\u5740\u4e86\u5e76\u586b\u8fdb\u53bb\u4e86\u3002</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a>Section<span class=\"w\"> </span>Headers:\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"w\">  </span><span class=\"o\">[</span>Nr<span class=\"o\">]</span><span class=\"w\"> </span>Name<span class=\"w\">              </span>Type<span class=\"w\">             </span>Address<span class=\"w\">           </span>Offset\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"w\">       </span>Size<span class=\"w\">              </span>EntSize<span class=\"w\">          </span>Flags<span class=\"w\">  </span>Link<span class=\"w\">  </span>Info<span class=\"w\">  </span>Align\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\">                   </span>NULL<span class=\"w\">             </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00000000</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span>\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span>.text<span class=\"w\">             </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000401000</span><span class=\"w\">  </span><span class=\"m\">00001000</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"w\">       </span>000000000000002a<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>AX<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span>.rodata<span class=\"w\">           </span>PROGBITS<span class=\"w\">         </span><span class=\"m\">0000000000402000</span><span class=\"w\">  </span><span class=\"m\">00002000</span>\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a><span class=\"w\">       </span>000000000000000e<span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">   </span>A<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span>.symtab<span class=\"w\">           </span>SYMTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span><span class=\"m\">00002010</span>\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a><span class=\"w\">       </span>00000000000000a8<span class=\"w\">  </span><span class=\"m\">0000000000000018</span><span class=\"w\">           </span><span class=\"m\">4</span><span class=\"w\">     </span><span class=\"m\">3</span><span class=\"w\">     </span><span class=\"m\">8</span>\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span>.strtab<span class=\"w\">           </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>000020b8\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000030</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span>.shstrtab<span class=\"w\">         </span>STRTAB<span class=\"w\">           </span><span class=\"m\">0000000000000000</span><span class=\"w\">  </span>000020e8\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a><span class=\"w\">       </span><span class=\"m\">0000000000000029</span><span class=\"w\">  </span><span class=\"m\">0000000000000000</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">1</span>\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a>Key<span class=\"w\"> </span>to<span class=\"w\"> </span>Flags:\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a><span class=\"w\">  </span>W<span class=\"w\"> </span><span class=\"o\">(</span>write<span class=\"o\">)</span>,<span class=\"w\"> </span>A<span class=\"w\"> </span><span class=\"o\">(</span>alloc<span class=\"o\">)</span>,<span class=\"w\"> </span>X<span class=\"w\"> </span><span class=\"o\">(</span>execute<span class=\"o\">)</span>,<span class=\"w\"> </span>M<span class=\"w\"> </span><span class=\"o\">(</span>merge<span class=\"o\">)</span>,<span class=\"w\"> </span>S<span class=\"w\"> </span><span class=\"o\">(</span>strings<span class=\"o\">)</span>,<span class=\"w\"> </span>I<span class=\"w\"> </span><span class=\"o\">(</span>info<span class=\"o\">)</span>,\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a><span class=\"w\">  </span>L<span class=\"w\"> </span><span class=\"o\">(</span>link<span class=\"w\"> </span>order<span class=\"o\">)</span>,<span class=\"w\"> </span>O<span class=\"w\"> </span><span class=\"o\">(</span>extra<span class=\"w\"> </span>OS<span class=\"w\"> </span>processing<span class=\"w\"> </span>required<span class=\"o\">)</span>,<span class=\"w\"> </span>G<span class=\"w\"> </span><span class=\"o\">(</span>group<span class=\"o\">)</span>,<span class=\"w\"> </span>T<span class=\"w\"> </span><span class=\"o\">(</span>TLS<span class=\"o\">)</span>,\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a><span class=\"w\">  </span>C<span class=\"w\"> </span><span class=\"o\">(</span>compressed<span class=\"o\">)</span>,<span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"o\">(</span>unknown<span class=\"o\">)</span>,<span class=\"w\"> </span>o<span class=\"w\"> </span><span class=\"o\">(</span>OS<span class=\"w\"> </span>specific<span class=\"o\">)</span>,<span class=\"w\"> </span>E<span class=\"w\"> </span><span class=\"o\">(</span>exclude<span class=\"o\">)</span>,\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a><span class=\"w\">  </span>D<span class=\"w\"> </span><span class=\"o\">(</span>mbind<span class=\"o\">)</span>,<span class=\"w\"> </span>l<span class=\"w\"> </span><span class=\"o\">(</span>large<span class=\"o\">)</span>,<span class=\"w\"> </span>p<span class=\"w\"> </span><span class=\"o\">(</span>processor<span class=\"w\"> </span>specific<span class=\"o\">)</span>\n</span></code></pre></div>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u6bd4\u8f83\u7279\u6b8a\u7684\u70b9\uff0c\u5b83\u6709 segment \u7684\u6982\u5ff5\uff0c\u6307\u793a\u5185\u6838\u5e94\u8be5\u600e\u6837\u628a\u7a0b\u5e8f\u52a0\u8f7d\u5230\u5185\u5b58\u91cc\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a>Program<span class=\"w\"> </span>Headers:\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"w\">  </span>Type<span class=\"w\">           </span>Offset<span class=\"w\">             </span>VirtAddr<span class=\"w\">           </span>PhysAddr\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"w\">                 </span>FileSiz<span class=\"w\">            </span>MemSiz<span class=\"w\">              </span>Flags<span class=\"w\">  </span>Align\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"w\">  </span>LOAD<span class=\"w\">           </span>0x0000000000000000<span class=\"w\"> </span>0x0000000000400000<span class=\"w\"> </span>0x0000000000400000\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"w\">                 </span>0x00000000000000e8<span class=\"w\"> </span>0x00000000000000e8<span class=\"w\">  </span>R<span class=\"w\">      </span>0x1000\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a><span class=\"w\">  </span>LOAD<span class=\"w\">           </span>0x0000000000001000<span class=\"w\"> </span>0x0000000000401000<span class=\"w\"> </span>0x0000000000401000\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a><span class=\"w\">                 </span>0x000000000000002a<span class=\"w\"> </span>0x000000000000002a<span class=\"w\">  </span>R<span class=\"w\"> </span>E<span class=\"w\">    </span>0x1000\n</span><span id=\"__span-9-8\"><a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\" href=\"#__codelineno-9-8\"></a><span class=\"w\">  </span>LOAD<span class=\"w\">           </span>0x0000000000002000<span class=\"w\"> </span>0x0000000000402000<span class=\"w\"> </span>0x0000000000402000\n</span><span id=\"__span-9-9\"><a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\" href=\"#__codelineno-9-9\"></a><span class=\"w\">                 </span>0x000000000000000e<span class=\"w\"> </span>0x000000000000000e<span class=\"w\">  </span>R<span class=\"w\">      </span>0x1000\n</span><span id=\"__span-9-10\"><a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\" href=\"#__codelineno-9-10\"></a>\n</span><span id=\"__span-9-11\"><a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\" href=\"#__codelineno-9-11\"></a><span class=\"w\"> </span>Section<span class=\"w\"> </span>to<span class=\"w\"> </span>Segment<span class=\"w\"> </span>mapping:\n</span><span id=\"__span-9-12\"><a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\" href=\"#__codelineno-9-12\"></a><span class=\"w\">  </span>Segment<span class=\"w\"> </span>Sections...\n</span><span id=\"__span-9-13\"><a id=\"__codelineno-9-13\" name=\"__codelineno-9-13\" href=\"#__codelineno-9-13\"></a><span class=\"w\">   </span><span class=\"m\">00</span><span class=\"w\">     </span>\n</span><span id=\"__span-9-14\"><a id=\"__codelineno-9-14\" name=\"__codelineno-9-14\" href=\"#__codelineno-9-14\"></a><span class=\"w\">   </span><span class=\"m\">01</span><span class=\"w\">     </span>.text<span class=\"w\"> </span>\n</span><span id=\"__span-9-15\"><a id=\"__codelineno-9-15\" name=\"__codelineno-9-15\" href=\"#__codelineno-9-15\"></a><span class=\"w\">   </span><span class=\"m\">02</span><span class=\"w\">     </span>.rodata<span class=\"w\"> </span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u6307\u793a\u5185\u6838\u4ece\u6587\u4ef6\u7684\u4e09\u4e2a\u504f\u79fb\u5904\u52a0\u8f7d\u4e09\u4e2a\u90e8\u5206\u5185\u5bb9\u5230\u5185\u5b58\u91cc\uff0c\u5206\u522b\u662f\u6587\u4ef6\u5934\u3001.text \u6bb5\u4ee5\u53ca .rodata \u6bb5\u3002\u52a0\u8f7d\u5b8c\u4ee5\u540e\uff0c\u5185\u6838\u4ece\u5934\u90e8\u91cc\u5199\u7684\u5165\u53e3\u5730\u5740\u5f00\u59cb\u6267\u884c\uff0c\u5c31\u53ef\u4ee5\u628a\u7a0b\u5e8f\u8dd1\u8d77\u6765\u3002\u8fd9\u65f6\u5019\u518d\u53bb\u770b\u6c47\u7f16\uff0c\u53ef\u4ee5\u53d1\u73b0\u94fe\u63a5\u540e\u7684\u4ee3\u7801\u4ece 0x4001000 \u5f00\u59cb\uff0c\u5e76\u4e14\u76f4\u63a5\u628a .rodata \u7684\u5730\u5740\u5199\u5230\u4e86\u6307\u4ee4\u7684\u7acb\u5373\u6570\u4e4b\u4e2d\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"c1\"># objdump -S: Display assembly and intermix source code with disassembly</span>\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>helloworld_asm.o\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;_start&gt;:\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rdi\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a><span class=\"w\">   </span><span class=\"m\">7</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c6<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x0,%rsi\n</span><span id=\"__span-10-6\"><a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\" href=\"#__codelineno-10-6\"></a><span class=\"w\">   </span>e:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c2<span class=\"w\"> </span>0d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>xd,%rdx\n</span><span id=\"__span-10-7\"><a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\" href=\"#__codelineno-10-7\"></a><span class=\"w\">  </span><span class=\"m\">15</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rax\n</span><span id=\"__span-10-8\"><a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\" href=\"#__codelineno-10-8\"></a><span class=\"w\">  </span>1c:<span class=\"w\">   </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span><span id=\"__span-10-9\"><a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\" href=\"#__codelineno-10-9\"></a><span class=\"w\">  </span>1e:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">31</span><span class=\"w\"> </span>ff<span class=\"w\">                </span>xor<span class=\"w\">    </span>%rdi,%rdi\n</span><span id=\"__span-10-10\"><a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\" href=\"#__codelineno-10-10\"></a><span class=\"w\">  </span><span class=\"m\">21</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span>3c<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x3c,%rax\n</span><span id=\"__span-10-11\"><a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\" href=\"#__codelineno-10-11\"></a><span class=\"w\">  </span><span class=\"m\">28</span>:<span class=\"w\">   </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span><span id=\"__span-10-12\"><a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\" href=\"#__codelineno-10-12\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>helloworld_asm\n</span><span id=\"__span-10-13\"><a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\" href=\"#__codelineno-10-13\"></a><span class=\"m\">0000000000401000</span><span class=\"w\"> </span>&lt;_start&gt;:\n</span><span id=\"__span-10-14\"><a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\" href=\"#__codelineno-10-14\"></a><span class=\"w\">  </span><span class=\"m\">401000</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rdi\n</span><span id=\"__span-10-15\"><a id=\"__codelineno-10-15\" name=\"__codelineno-10-15\" href=\"#__codelineno-10-15\"></a><span class=\"w\">  </span><span class=\"m\">401007</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c6<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">20</span><span class=\"w\"> </span><span class=\"m\">40</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x402000,%rsi\n</span><span id=\"__span-10-16\"><a id=\"__codelineno-10-16\" name=\"__codelineno-10-16\" href=\"#__codelineno-10-16\"></a><span class=\"w\">  </span>40100e:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c2<span class=\"w\"> </span>0d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>xd,%rdx\n</span><span id=\"__span-10-17\"><a id=\"__codelineno-10-17\" name=\"__codelineno-10-17\" href=\"#__codelineno-10-17\"></a><span class=\"w\">  </span><span class=\"m\">401015</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%rax\n</span><span id=\"__span-10-18\"><a id=\"__codelineno-10-18\" name=\"__codelineno-10-18\" href=\"#__codelineno-10-18\"></a><span class=\"w\">  </span>40101c:<span class=\"w\">       </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span><span id=\"__span-10-19\"><a id=\"__codelineno-10-19\" name=\"__codelineno-10-19\" href=\"#__codelineno-10-19\"></a><span class=\"w\">  </span>40101e:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">31</span><span class=\"w\"> </span>ff<span class=\"w\">                </span>xor<span class=\"w\">    </span>%rdi,%rdi\n</span><span id=\"__span-10-20\"><a id=\"__codelineno-10-20\" name=\"__codelineno-10-20\" href=\"#__codelineno-10-20\"></a><span class=\"w\">  </span><span class=\"m\">401021</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>c7<span class=\"w\"> </span>c0<span class=\"w\"> </span>3c<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x3c,%rax\n</span><span id=\"__span-10-21\"><a id=\"__codelineno-10-21\" name=\"__codelineno-10-21\" href=\"#__codelineno-10-21\"></a><span class=\"w\">  </span><span class=\"m\">401028</span>:<span class=\"w\">       </span>0f<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>syscall\n</span></code></pre></div>\n<h3 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece\u8fd9\u91cc\u53ef\u4ee5\u5f52\u7eb3\u51fa\uff0c\u5199\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u94fe\u63a5\u5668\uff0c\u628a\u4e0a\u8ff0\u7684 .o \u94fe\u63a5\u6210\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u5927\u81f4\u9700\u8981\u505a\u54ea\u4e9b\u4e8b\u60c5\uff1a</p>\n<ol>\n<li>\u89e3\u6790 ELF \u6587\u4ef6\uff0c\u89e3\u6790\u91cc\u9762\u7684\u5185\u5bb9</li>\n<li>\u8003\u8651\u5c06\u8981\u8f93\u51fa\u7684 ELF \u6587\u4ef6\u7684\u5e03\u5c40\uff0c\u8ba1\u7b97\u51fa\u5404\u4e2a section \u9700\u8981\u4fdd\u5b58\u7684\u5185\u5bb9\u4ee5\u53ca\u5730\u5740\uff0c\u9700\u8981\u8003\u8651 segment \u7684\u5e03\u5c40\u4ee5\u53ca\u5bf9\u9f50</li>\n<li>\u6839\u636e\u5730\u5740\uff0c\u5b8c\u6210 relocation \u6240\u9700\u8981\u7684\u8ba1\u7b97\u5e76\u586b\u5165\u5bf9\u5e94\u7684\u4f4d\u7f6e</li>\n</ol>\n<h2 id=\"\u5b9e\u73b0\">\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u63cf\u8ff0\u4e00\u4e0b\u5b9e\u73b0\u7684\u5177\u4f53\u601d\u8def\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u6b65\u5c31\u662f\u89e3\u6790\u8f93\u5165\u7684 ELF \u6587\u4ef6\uff0c\u63d0\u53d6\u51fa\u4e2d\u95f4\u7684\u5185\u5bb9\uff0c\u5305\u62ec\u6709\u54ea\u4e9b section\uff0c\u89e3\u6790 relocation \u7684\u5185\u5bb9\u7b49\u7b49\uff1b\u8fd9\u4e2a\u53ef\u4ee5\u7528\u73b0\u6210\u7684\u5e93\u6765\u8f85\u52a9\uff0c\u4e5f\u53ef\u4ee5\u81ea\u5df1\u5199\u3002</li>\n<li>\u628a section \u7684\u5185\u5bb9\u6536\u96c6\u4e0b\u6765\uff0c\u4f8b\u5982 .text .rodata \u7b49\u7b49\uff0c\u8fd9\u4e9b\u6570\u636e\u4e4b\u540e\u4f1a\u5199\u5165\u5230\u53ef\u6267\u884c ELF \u6587\u4ef6\u4e2d\u3002</li>\n<li>\u6536\u96c6\u5b8c\u4ee5\u540e\uff0c\u5c31\u77e5\u9053\u8f93\u51fa\u7684 ELF \u5927\u6982\u9700\u8981\u54ea\u4e9b\u5185\u5bb9\u4e86\u3002\u5728\u8fdb\u884c relocation \u4e4b\u524d\uff0c\u56e0\u4e3a\u76ee\u524d\u5b9e\u73b0\u7684\u662f\u91c7\u7528\u7edd\u5bf9\u5730\u5740\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u6240\u4ee5\u9700\u8981\u5148\u786e\u5b9a\u597d\u5404\u4e2a section \u548c symbol \u7684\u5730\u5740\uff0c\u4ece\u800c\u5b9e\u73b0 relocation \u7684\u8ba1\u7b97\u3002\u89c2\u5bdf ld.bfd \u8f93\u51fa\u7684\u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u5230 ELF \u6587\u4ef6\u5305\u62ec\u5982\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a<ol>\n<li>ELF file header\uff1aELF \u5934\u90e8\uff0c\u586b\u5199\u5404\u79cd\u4fe1\u606f\uff0c\u4ee5\u53ca\u5230\u540e\u7eed\u5404\u4e2a header \u7684\u5730\u5740\u504f\u79fb</li>\n<li>ELF program header\uff1a\u8ba9 ELF Loader \u77e5\u9053\u6709\u54ea\u4e9b Segment \u8981\u52a0\u8f7d</li>\n<li>section data\uff1a\u5404\u4e2a section \u7684\u5185\u5bb9\uff0c\u7531\u4e8e section \u9700\u8981\u4fdd\u8bc1\u5bf9\u9f50\uff0c\u56e0\u6b64\u4e2d\u95f4\u9700\u8981\u586b\u4e00\u4e9b\u989d\u5916\u7684\u96f6\u5b57\u8282</li>\n<li>ELF section header\uff1a\u4fdd\u5b58 section header\uff0c\u8bb0\u5f55\u4e86 section \u7684\u4fe1\u606f</li>\n</ol>\n</li>\n<li>\u800c\u52a0\u8f7d\u5230\u5185\u5b58\u91cc\u7684\u65f6\u5019\uff0c\u5c31\u662f\u76f4\u63a5\u5927\u6bb5\u5730\u8fde\u7eed\u5730\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\uff0c\u6240\u4ee5\u53ef\u4ee5\u63d0\u524d\u8ba1\u7b97\u597d\u5404\u4e2a\u90e8\u5206\u7684\u5730\u5740\u3002\u4f8b\u5982\u8981\u628a ELF \u52a0\u8f7d\u5230 0x400000\uff0c\u90a3\u5c31\u628a file header \u548c program header \u653e\u5728\u5f00\u5934\uff0c\u7136\u540e\u56e0\u4e3a segment \u9700\u8981\u5bf9\u9f50\u5230\u9875\u7684\u8fb9\u754c <sup id=\"fnref:1\"><a class=\"footnote-ref\" href=\"#fn:1\">1</a></sup> \uff0c\u4f8b\u5982\u5bf9\u9f50\u5230 0x1000\uff084 KB\uff09\uff0c\u90a3\u5c31\u628a\u8fde\u7eed\u7684\u76f8\u540c\u8bbf\u95ee\u6743\u9650\u7684 section \u653e\u5230\u4e00\u4e2a segment \u5185\uff0c\u7136\u540e\u7b2c\u4e00\u4e2a segment \u653e\u5230 0x401000\uff0c\u5f80\u540e\u518d\u5bf9\u9f50\u518d\u653e\u4e0b\u4e00\u4e2a segment\uff0c\u4f9d\u6b64\u7c7b\u63a8\uff0c\u76f4\u5230\u628a\u6240\u6709 segment \u90fd\u653e\u4e0b\u4e3a\u6b62\u3002</li>\n<li>\u8ba1\u7b97\u597d\u5404\u4e2a\u90e8\u5206\u7684\u5730\u5740\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u5404\u4e2a section \u548c symbol \u5728\u6700\u7ec8\u7684\u5185\u5b58\u91cc\u4f1a\u5904\u4e8e\u4ec0\u4e48\u5730\u5740\u4e86\u3002\u6b64\u65f6\u5c31\u6309\u7167 relocation \u7684\u8981\u6c42\u8fdb\u884c\u8ba1\u7b97\uff08\u4f8b\u5982\u524d\u9762\u51fa\u73b0\u8fc7\u7684 <code>R_X86_64_32S</code> \u5c31\u662f\u540e\u5199\u5165 64 \u4f4d\u7684\u5730\u5740\u7684\u4f4e 32 \u4f4d\uff0c\u5e76\u4e14\u68c0\u67e5\u5b83\u7b26\u53f7\u6269\u5c55\u540e\u7b49\u4e8e\u539f\u6765 64 \u4f4d\u7684\u5730\u5740\uff0c\u5982\u679c\u68c0\u67e5\u5931\u8d25\uff0c\u5c31\u4f1a\u5f97\u5230\u5927\u5bb6\u719f\u6089\u7684 <code>relocation truncated to fit</code> \u9519\u8bef\uff09\uff0c\u76f4\u63a5\u628a\u8ba1\u7b97\u7ed3\u679c\u586b\u5165\u5230\u6570\u636e\u4e2d\u3002\u7531\u4e8e\u76ee\u524d\u53ea\u8003\u8651\u6700\u7b80\u5355\u7684\u60c5\u51b5\uff0c\u4e0d\u6d89\u53ca\u5230\u52a8\u6001\u91cd\u5b9a\u4f4d\uff0c\u6240\u4ee5\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u6240\u6709\u91cd\u5b9a\u4f4d\u90fd\u4f1a\u88ab\u94fe\u63a5\u5668\u5b8c\u6210\u3002</li>\n<li>\u9488\u5bf9\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u8fd8\u9700\u8981\u751f\u6210 segment \u653e\u5230 program header \u91cc\u3002\u7b80\u5355\u7c97\u66b4\u7684\u529e\u6cd5\uff0c\u5c31\u662f\u6574\u4e2a\u6587\u4ef6\u76f4\u63a5\u6620\u5c04\u5230\u5185\u5b58\u7684 0x400000\uff0c\u8bbe\u7f6e\u6743\u9650\u4e3a read + write + execute\u3002\u66f4\u7cbe\u7ec6\u7684\u505a\u6cd5\uff0c\u5219\u662f\u628a\u4e0d\u540c\u7c7b\u578b\u7684\u6570\u636e\u6309\u7167\u5408\u9002\u7684\u6743\u9650\u6620\u5c04\uff0c\u4f8b\u5982 .rodata \u653e\u5230 read only \u7684 segment \u91cc\uff0c.text \u653e\u5230 read + execute \u7684 segment \u91cc\u3002</li>\n<li>\u518d\u6309\u7167\u524d\u9762\u6240\u8ff0\u7684\u6d41\u7a0b\uff0c\u6309\u7167\u9884\u8ba1\u597d\u7684\u5e03\u5c40\uff0c\u628a ELF \u7684\u5185\u5bb9\u5199\u5230\u6587\u4ef6\u91cc\u3002</li>\n</ol>\n<p>\u8fd9\u91cc\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\u6ca1\u6709\u4ea4\u4ee3\uff0c\u4f8b\u5982 section string table (.shstrtab) \u7684\u7ef4\u62a4\u7b49\u7b49\u3002\u5982\u679c\u53ea\u662f\u4e3a\u4e86\u8dd1\u8d77\u6765\uff0c\u7b26\u53f7\u8868\u90fd\u53ef\u4ee5\u76f4\u63a5\u5220\u6389\u4e0d\u8981\u3002</p>\n<p>\u5b9e\u73b0\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7075\u6d3b\u8fd0\u7528 readelf \u548c objdump \u7b49\u5de5\u5177\uff0c\u786e\u8ba4\u81ea\u5df1\u8f93\u51fa\u7684 ELF \u6587\u4ef6\u5185\u5bb9\u662f\u6b63\u786e\u7684\u3002\u5982\u679c\u5b9e\u73b0\u6210\u529f\uff0c\u5c31\u53ef\u4ee5\u6267\u884c\u751f\u6210\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u6210\u529f\u6253\u5370 <code>Hello world\uff01</code>\u3002</p>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u6211\u7528 Rust \u5b8c\u6210\u4e86\u5b9e\u73b0\uff0c\u4f7f\u7528\u4e86\u73b0\u6210\u7684 ELF \u8bfb\u5199\u5e93 <code>object</code>\uff0c\u94fe\u63a5\u5668\u90e8\u5206\u7684\u4ee3\u7801\u91cf\u5927\u6982\u662f 200 \u884c\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u7ed9\u51fa\u4e00\u4e9b\u6587\u6863\uff0c\u53ef\u4f9b\u5b9e\u73b0\u65f6\u53c2\u8003\uff1a</p>\n<ul>\n<li><a href=\"https://refspecs.linuxfoundation.org/elf/elf.pdf\">Tool Interface Standard (TIS) Executable and Linking Format (ELF) Specification</a></li>\n<li><a href=\"https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf\">System V Application Binary Interface AMD64 Architecture Processor Supplement Draft Version 0.99.6</a></li>\n</ul>\n<div class=\"footnote\">\n<hr />\n<ol>\n<li id=\"fn:1\">\n<p>\u8fd9\u662f\u4e3a\u4e86\u5728\u52a0\u8f7d ELF \u65f6\u53ef\u4ee5\u76f4\u63a5 mmap\uff0c\u800c\u4e0d\u9700\u8981\u7acb\u5373\u628a\u6587\u4ef6\u5185\u5bb9\u8bfb\u53d6\u5230\u5185\u5b58\u91cc\uff1b\u66f4\u8fdb\u4e00\u6b65\uff0cmmap \u662f\u5141\u8bb8\u591a\u4e2a\u865a\u62df\u9875\u6620\u5c04\u5230\u540c\u4e00\u4e2a\u7269\u7406\u9875\u4e0a\u7684\uff0c\u6240\u4ee5\u5141\u8bb8\u4e00\u4e9b\u51fa\u73b0\u4e00\u4e9b\u201c\u4e0d\u5bf9\u9f50\u201d\u7684\u60c5\u51b5\uff0c\u5f97\u4ee5\u8282\u7701\u56e0\u4e3a\u5bf9\u9f50\u800c\u6d6a\u8d39\u7684\u7a7a\u95f4\u3002\u5bf9\u4e8e\u8fd9\u4e2a\u8bdd\u9898\u7684\u8fdb\u4e00\u6b65\u4e86\u89e3\uff0c\u5efa\u8bae\u9605\u8bfb <a href=\"https://maskray.me/blog/2023-12-17-exploring-the-section-layout-in-linker-output\">Exploring the section layout in linker output</a>\u3002&#160;<a class=\"footnote-backref\" href=\"#fnref:1\" title=\"Jump back to footnote 1 in the text\">&#8617;</a></p>\n</li>\n</ol>\n</div>", "image": null, "date_published": "2024-02-18T00:00:00+00:00", "authors": [], "tags": ["elf", "linker", "linux", "software", "write-a-linker"]}, {"id": "https://jia.je/software/2024/01/25/chromium-build-port/", "url": "https://jia.je/software/2024/01/25/chromium-build-port/", "title": "Chromium \u6784\u5efa\u4e0e\u79fb\u690d", "content_html": "<h1 id=\"chromium-\u6784\u5efa\u4e0e\u79fb\u690d\">Chromium \u6784\u5efa\u4e0e\u79fb\u690d<a class=\"headerlink\" href=\"#chromium-\u6784\u5efa\u4e0e\u79fb\u690d\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>Google Chrome \u4e5f\u7528\u4e86\u5f88\u957f\u65f6\u95f4\u4e86\uff0c\u4f46\u662f\u4e00\u76f4\u6ca1\u6709\u5c1d\u8bd5\u8fc7\u6784\u5efa Chromium\uff0c\u8fd9\u6b21\u8d81\u7740\u5f80 LoongArch \u79fb\u690d Chromium \u7684\u673a\u4f1a\uff0c\u5b66\u4e60\u4e86\u4e00\u4e0b Chromium \u7684\u6784\u5efa\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u514b\u9686\u4ee3\u7801\">\u514b\u9686\u4ee3\u7801<a class=\"headerlink\" href=\"#\u514b\u9686\u4ee3\u7801\" title=\"Permanent link\">&para;</a></h2>\n<p>Chromium \u5b98\u65b9\u7684\u6784\u5efa\u6587\u6863\u94fe\u63a5\u662f <a href=\"https://chromium.googlesource.com/chromium/src/+/main/docs/linux/build_instructions.md\">Checking out and building Chromium on Linux</a>\uff0c\u6309\u7167\u6d41\u7a0b\u505a\u5c31\u53ef\u4ee5\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>build-chromium\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"c1\"># setup depot_tools</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>git<span class=\"w\"> </span>clone<span class=\"w\"> </span>https://chromium.googlesource.com/chromium/tools/depot_tools.git\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"c1\"># fish syntax to add depot_tools to PATH</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"nb\">set</span><span class=\"w\"> </span>-x<span class=\"w\"> </span>PATH<span class=\"w\"> </span><span class=\"nv\">$PWD</span>/depot_tools<span class=\"w\"> </span><span class=\"nv\">$PATH</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"c1\"># clone chromium using fetch from depot_tools</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>mkdir<span class=\"w\"> </span>chromium\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>chromium\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>fetch<span class=\"w\"> </span>--nohooks<span class=\"w\"> </span>chromium\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"c1\"># or</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a>fetch<span class=\"w\"> </span>--nohooks<span class=\"w\"> </span>--no-history<span class=\"w\"> </span>chromium\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a><span class=\"c1\"># setup build dependencies</span>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>src\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a>./build/install-build-deps.sh\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a>gclient<span class=\"w\"> </span>runhooks\n</span></code></pre></div>\n<p>\u5f53\u7136\u4e86\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e3b\u8981\u662f\u4e3a\u4e86\u5f00\u53d1 chromium \u505a\u7684\uff0c\u5b9e\u9645\u4e0a\u53ef\u4ee5\u505a\u4e00\u4e9b\u7b80\u5316\uff1a\u5982\u679c\u53ea\u662f\u8981\u7f16\u8bd1\u4e00\u4e2a\u5df2\u7ecf\u53d1\u5e03\u6b63\u5f0f\u7248\u7684 chromium\uff0c\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d tarball\uff0c\u4f8b\u5982 <a href=\"https://commondatastorage.googleapis.com/chromium-browser-official/chromium-120.0.6099.216.tar.xz\">https://commondatastorage.googleapis.com/chromium-browser-official/chromium-120.0.6099.216.tar.xz</a>\uff0c\u628a\u94fe\u63a5\u91cc\u7684\u7248\u672c\u53f7\u6539\u6389\u5373\u53ef\uff1b\u8fd9\u6837\u53ef\u4ee5\u7701\u53bb\u514b\u9686 git repo \u4ee5\u53ca\u4e00\u5806 submodule \u7684\u5927\u91cf\u65f6\u95f4\u3002\u5f53\u7136\u4e86\uff0c\u89e3\u538b\u672c\u8eab\u4e5f\u9700\u8981\u6bd4\u8f83\u957f\u7684\u65f6\u95f4\uff0c\u5bf9\u4ed8\u8fd9\u79cd\u5927\u578b\u8f6f\u4ef6\u5fc5\u987b\u8981\u6709\u8010\u5fc3\u3002\u540c\u7406\uff0cdepot_tools \u4e5f\u53ef\u4ee5\u4e0d\u8981\uff0c\u6bd5\u7adf\u81ea\u5df1\u628a\u4ee3\u7801\u4e0b\u8f7d\u4e0b\u6765\u4e86\uff0c\u53ea\u9700\u8981\u518d\u88c5\u4e00\u4e2a gn\uff0c\u5c31\u53ef\u4ee5\u5b8c\u6210\u5269\u4e0b\u7684\u6784\u5efa\u3002</p>\n<h2 id=\"\u6784\u5efa\">\u6784\u5efa<a class=\"headerlink\" href=\"#\u6784\u5efa\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6309\u7167\u9ed8\u8ba4\u914d\u7f6e\u6784\u5efa\uff0c\u53ea\u9700\u8981\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>gn<span class=\"w\"> </span>gen<span class=\"w\"> </span>out/Default\n</span></code></pre></div>\n<p>\u610f\u601d\u662f\u7528 <code>gn</code> \u5de5\u5177\u751f\u6210\u4e00\u5957\u7528 Ninja \u6784\u5efa\u7684\u914d\u7f6e\uff0c\u76ee\u5f55\u5728 <code>out/Default</code> \u4e0b\u9762\uff0c\u7136\u540e\u4e0d\u6dfb\u52a0\u989d\u5916\u7684\u8bbe\u7f6e\u3002\u8981\u6784\u5efa Chromium\uff0c\u90a3\u5c31\u5728\u91cc\u9762\u8dd1 ninja\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>ninja<span class=\"w\"> </span>-C<span class=\"w\"> </span>out/Default<span class=\"w\"> </span>chrome\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"c1\"># or</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>autoninja<span class=\"w\"> </span>-C<span class=\"w\"> </span>out/Default<span class=\"w\"> </span>chrome\n</span></code></pre></div>\n<p>\u4f46\u662f\u5982\u679c\u4f60\u53bb\u7ffb\u5404\u4e2a Linux \u53d1\u884c\u7248\uff0c\u5c31\u4f1a\u53d1\u73b0\u5b83\u4eec\u90fd\u4f1a\u4f20\u5f88\u591a\u7684\u53c2\u6570\u7ed9 gn\uff0c\u5b9e\u73b0\u5404\u79cd\u76ee\u7684\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a>gn<span class=\"w\"> </span>gen<span class=\"w\"> </span>out/Default<span class=\"w\"> </span>--args<span class=\"o\">=</span><span class=\"s1\">&#39;...&#39;</span>\n</span></code></pre></div>\n<p>\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e9b\u94fe\u63a5\uff1a</p>\n<ul>\n<li><a href=\"https://github.com/AOSC-Dev/aosc-os-abbs/tree/stable/app-web/chromium/autobuild\">AOSC OS</a></li>\n<li><a href=\"https://gitlab.archlinux.org/archlinux/packaging/packages/chromium/-/blob/main/PKGBUILD?ref_type=heads\">Arch Linux</a></li>\n<li><a href=\"https://salsa.debian.org/chromium-team/chromium/-/blob/master/debian/rules?ref_type=heads\">Debian</a></li>\n<li><a href=\"https://src.fedoraproject.org/rpms/chromium/blob/rawhide/f/chromium.spec\">Fedora</a></li>\n</ul>\n<p>\u8fd9\u91cc\u7684\u95e8\u95e8\u9053\u9053\u5c31\u5f88\u591a\u4e86\uff0c\u5f88\u591a\u7f16\u8bd1\u53c2\u6570\u5f71\u54cd\u4e86\u6700\u7ec8 Chromium \u7684\u529f\u80fd\u3001\u6027\u80fd\u7b49\u7b49\u91cd\u8981\u7684\u6307\u6807\u3002</p>\n<p>\u9996\u5148\u662f\u5de5\u5177\u94fe\u7684\u9009\u62e9\uff1aChromium \u5f00\u53d1\u7684\u65f6\u5019\u7528\u7684\u662f\u5f88\u65b0\u7684 Clang\uff0c\u8fd8\u81ea\u5e26\u4e86\u4e00\u4efd libc++\uff0c\u4f46\u662f\u5f88\u81ea\u7136\u5730\u5404\u5927\u53d1\u884c\u7248\u90fd\u4f1a\u503e\u5411\u4e8e\u7528\u81ea\u5df1\u7684\u5de5\u5177\u94fe\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5de5\u5177\u94fe\u53ef\u80fd\u662f\u7a0d\u5fae\u65e7\u4e00\u4e9b\u7684 Clang\uff0c\u6216\u8005\u662f GCC\uff0c\u8fd9\u91cc\u5c31\u4f1a\u51fa\u73b0\u5927\u91cf\u7684\u95ee\u9898\uff1aChromium \u5f00\u53d1\u7684\u65f6\u5019\u662f\u4e0d\u5728\u65e7 Clang \u6216\u8005 GCC \u4e0a\u6d4b\u8bd5\u7684\uff0c\u6240\u4ee5\u5404\u4e2a\u53d1\u884c\u7248\u90fd\u8981\u7ef4\u62a4\u4e00\u5806\u7684 patch\uff0c\u4f7f\u5f97\u7528\u7a0d\u5fae\u65e7\u4e00\u70b9\u7684\u6b63\u5f0f\u7248 Clang/GCC \u4e5f\u53ef\u4ee5\u6784\u5efa Chromium\u3002\u8fd9\u4e9b patch \u53ef\u4ee5\u5728\u4e0a\u9762\u7684\u94fe\u63a5\u4e2d\u627e\u5230\u3002</p>\n<p>\u9664\u4e86\u7f16\u8bd1\u5668\u4ee5\u5916\uff0c\u8fd8\u6709\u5f88\u591a\u4f9d\u8d56\u4e5f\u53ef\u4ee5\u9009\u62e9\u7528 chromium \u81ea\u5e26\u7684\u7248\u672c\uff0c\u8fd8\u662f\u7cfb\u7edf\u81ea\u5e26\u7684\u7248\u672c\uff0c\u8fd9\u91cc\u4e5f\u6709\u5f88\u591a\u53ef\u80fd\u6027\u3002\u4f8b\u5982\u8981\u7528\u7cfb\u7edf\u81ea\u5e26\u7684 Clang\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>host_toolchain=&quot;//build/toolchain/linux/unbundle:default&quot;\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a>custom_toolchain=&quot;//build/toolchain/linux/unbundle:default&quot;\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a>clang_base_path=&quot;/usr&quot; \n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a>clang_use_chrome_plugins=false\n</span></code></pre></div>\n<p>\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u7528 GCC\uff0c\u4f46\u662f\u9700\u8981\u6253\u4e0d\u5c11\u7684 patch\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a>CC=gcc CXX=g++ AR=ar NM=nm gn gen out/Default --args=&#39;is_clang=false ...&#39;\n</span></code></pre></div>\n<p>\u7b49\u7b49\uff0c\u8fd8\u6709\u5f88\u591a\u53ef\u80fd\u7684\u914d\u7f6e\u9009\u9879\uff0c\u8fd9\u4e9b\u53ef\u4ee5\u5728 Chromium \u7684\u6e90\u7801\u4e2d\u627e\u5230\uff1a\u5b83\u4eec\u4f1a\u7528 gn \u7684\u914d\u7f6e\u8bed\u8a00\u7f16\u5199\uff0c\u653e\u5728 <code>declare_args</code> \u91cc\u9762\u3002</p>\n<h2 id=\"\u79fb\u690d\">\u79fb\u690d<a class=\"headerlink\" href=\"#\u79fb\u690d\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9664\u4e86\u5728 amd64 \u6784\u5efa\u4ee5\u5916\uff0cChromium \u4e3b\u8981\u8fd8\u652f\u6301 arm64 \u67b6\u6784\uff0c\u5176\u4ed6\u67b6\u6784\u5c5e\u4e8e\u6709\u7b2c\u4e09\u65b9 patch\uff0c\u4f46\u662f Chromium \u5904\u4e8e\u4e00\u4e2a\u4ed8\u51fa\u989d\u5916\u7ef4\u62a4\u8d1f\u62c5\u7684\u72b6\u6001\uff0c\u6240\u4ee5\u5176\u4ed6\u67b6\u6784\u7684\u8865\u4e01\u5c31\u6ca1\u6709\u5408\u5e76\uff0c\u56e0\u6b64\u4f60\u4f1a\u53d1\u73b0 riscv64 \u548c ppc64le \u67b6\u6784\u4e0a\u80fd\u627e\u5230\u4e00\u4e9b\u53d1\u884c\u7248\u81ea\u5df1\u7ef4\u62a4\u7684 patch\uff0c\u5e76\u4e14\u6ca1\u6709\u5408\u5e76\u5230\u4e0a\u6e38\u3002loongarch64 \u7684\u5904\u5883\u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u9f99\u82af\u4e4b\u524d\u505a\u8fc7\u4e00\u4e9b\u79fb\u690d\uff0c\u5c1d\u8bd5\u63d0\u4ea4\u4e0a\u6e38\uff0c\u4f46\u662f\u6700\u540e\u6ca1\u6709\u5408\u5e76\u8fdb\u53bb\u3002</p>\n<p>\u4f46\u662f Chromium \u5bf9\u4e8e\u684c\u9762\u6765\u8bf4\u53c8\u662f\u6bd4\u8f83\u91cd\u8981\u7684\uff0c\u65e0\u8bba\u662f\u4f5c\u4e3a\u6d4f\u89c8\u5668\uff0c\u8fd8\u662f\u7528\u5728 Electron \u6216\u8005 QT \u751f\u6001\u4e2d\u3002\u56e0\u6b64\u501f\u7740\u9f99\u82af\u628a\u79fb\u690d Electron \u7684 patch \u653e\u51fa\u6765\u7684\u673a\u4f1a\uff0c\u987a\u4fbf\u628a Chromium \u7684\u79fb\u690d\u505a\u4e86\uff1a\u6700\u65e9\u662f <a href=\"https://github.com/prcups\">@prcups</a> \u628a\u8865\u4e01\u79fb\u690d\u5230 qt6-webengine \u4e0a\uff0c\u8bc1\u5b9e\u4e86\u8865\u4e01\u7684\u53ef\u7528\u6027\uff1b\u4e4b\u540e\u6211\u53c8\u79fb\u690d\u5230\u4e86\u6700\u65b0\u7248\u7684 Chromium \u4e0a\uff0c\u8865\u4e01\u53d1\u5e03\u5728 <a href=\"https://github.com/AOSC-Dev/chromium-loongarch64\">AOSC-Dev/chromium-loongarch64</a>\u3002\u76ee\u524d 120 \u5df2\u7ecf\u9002\u914d\u4e86\uff0c\u4f46\u662f\u8fd9\u51e0\u5929 121 \u53c8\u53d1\u5e03\u4e86\uff0c\u9700\u8981\u518d\u6b21\u66f4\u65b0\u8865\u4e01\u3002\u65b0\u7248 Electron \u7684\u8865\u4e01\u4e5f\u8fd8\u6ca1\u6709\u505a\u3002</p>\n<p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u53d1\u73b0\u9f99\u82af\u539f\u6765\u7684 patch \u5185\u7f6e\u7684 bug\uff1a\u4e0e seccomp sandbox \u6709\u5173\uff0c\u539f\u6765\u7684\u4ee3\u7801\u628a\u5bf9 stat \u7684\u5904\u7406\u7167\u6284\u5230\u4e86 statx \u4e0a\uff0c\u4f46\u662f\u5b83\u7684\u53c2\u6570\u987a\u5e8f\u548c\u542b\u4e49\u90fd\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u4e0d\u80fd\u76f4\u63a5\u7167\u6284\u3002\u5bf9\u7740\u4ee3\u7801\uff0c\u5927\u6982\u662f\u6b63\u786e\u5730\u5b9e\u73b0\u4e86\u51fa\u6765\u3002\u4e4b\u524d\u6ca1\u6709\u9047\u5230\u8fd9\u4e2a\u95ee\u9898\uff0c\u5927\u6982\u7387\u662f Electron \u4e0b\u4e0d\u4f1a\u7528\u5230\u8fd9\u4e2a sandbox\u3002\u56de\u987e\u4e0b\u6765\uff0c\u79fb\u690d\u7684\u8865\u4e01\u4e0d\u7b97\u591a\uff0c\u4e3b\u8981\u662f crashpad \u548c sandbox \u4e24\u90e8\u5206\u4ee3\u7801\uff0c\u89c2\u5bdf\u4e86\u4e00\u4e0b archriscv \u7ef4\u62a4\u7684 riscv \u8865\u4e01\uff0c\u5176\u5b9e\u4e5f\u662f\u7c7b\u4f3c\u7684\u3002</p>\n<p>\u8fd9\u4e2a\u8fc7\u7a0b\u9047\u5230\u4e86\u5f88\u591a\u56f0\u96be\uff1a\u4e00\u5f00\u59cb Clang \u6784\u5efa\u9047\u5230\u95ee\u9898\uff0c\u4e8e\u662f\u6539\u7528 GCC\uff0c\u4f46\u662f\u524d\u9762\u4e5f\u8bf4\u4e86\uff0cChromium \u6ca1\u6709\u7528 GCC \u6d4b\u8bd5\uff0c\u6240\u4ee5\u4f1a\u51fa\u73b0\u5f88\u591a\u95ee\u9898\uff0c\u9700\u8981\u7ec6\u5fc3\u5730\u4fee\u590d\uff1b\u6700\u540e\u7ec8\u4e8e\u641e\u597d\u4e86\u4ee5\u540e\uff0c\u518d\u56de\u5230 Clang\uff0c\u53d1\u73b0 Clang \u7684\u95ee\u9898\u5df2\u7ecf\u88ab Fedora/Debian \u7b49\u53d1\u884c\u7248\u89e3\u51b3\uff0c\u53ea\u9700\u8981\u5bfc\u5165\u5df2\u6709\u7684\u8865\u4e01\u5373\u53ef\u3002\u8fd9\u6837\u6298\u817e\u4e0b\u6765\uff0c\u7ec8\u4e8e\u662f\u641e\u5b9a\u4e86\u3002\u800c\u76ee\u524d\u9f99\u82af\u7684\u6784\u5efa\u673a\u5668\uff083C5000\uff09\u6027\u80fd\u8fd8\u662f\u4e0d\u591f\u597d\uff0c\u6784\u5efa\u4e00\u6b21\u5b8c\u6574\u7684 Chromium \u9700\u8981\u4e5d\u4e2a\u5c0f\u65f6\uff0c\u672a\u6765\u7b49\u9f99\u82af\u670d\u52a1\u5668\u6027\u80fd\u63d0\u5347\u4ee5\u540e\uff0c\u53ef\u4ee5\u9884\u89c1\u5230\u7ef4\u62a4\u6210\u672c\u7684\u964d\u4f4e\u3002</p>", "image": null, "date_published": "2024-01-25T00:00:00+00:00", "authors": [], "tags": ["chromium", "linux", "loongarch", "port", "software"]}, {"id": "https://jia.je/hardware/2023/12/08/vipt-l1-cache-page-size/", "url": "https://jia.je/hardware/2023/12/08/vipt-l1-cache-page-size/", "title": "VIPT \u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb", "content_html": "<h1 id=\"vipt-\u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb\">VIPT \u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb<a class=\"headerlink\" href=\"#vipt-\u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb\" title=\"Permanent link\">&para;</a></h1>\n<p>VIPT\uff08Virtual Index Physical Tag\uff09\u662f L1 \u6570\u636e\u7f13\u5b58\u5e38\u7528\u7684\u6280\u672f\uff0c\u5229\u7528\u4e86\u865a\u62df\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u7684 Index \u76f8\u540c\u7684\u7279\u6027\uff0c\u5f97\u4ee5\u4f18\u5316 L1 \u6570\u636e\u7f13\u5b58\u7684\u8bfb\u53d6\u3002\u4f46\u662f VIPT \u7684\u4f7f\u7528\uff0c\u4e0e\u9875\u8868\u5927\u5c0f\u548c L1 \u6570\u636e\u7f13\u5b58\u5927\u5c0f\u90fd\u6709\u5173\u7cfb\u3002\u8fd9\u7bc7\u535a\u5ba2\u63a2\u8ba8\u4e00\u4e0b\uff0cVIPT \u6280\u672f\u80cc\u540e\u7684\u4e00\u4e9b\u95ee\u9898\u3002</p>\n<!-- more -->\n\n<h2 id=\"vipt-\u662f\u4ec0\u4e48\">VIPT \u662f\u4ec0\u4e48<a class=\"headerlink\" href=\"#vipt-\u662f\u4ec0\u4e48\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4ee5\u9632\u8bfb\u8005\u4e0d\u8bb0\u5f97 VIPT \u662f\u4ec0\u4e48\uff0c\u8fd9\u91cc\u518d\u590d\u4e60\u4e00\u4e0b\u7f13\u5b58\u7684\u539f\u7406\u3002\u9996\u5148\uff0c\u628a\u6570\u636e\u7684\u7269\u7406\u5730\u5740\u5212\u5206\u4e3a\u4e09\u6bb5\uff1a</p>\n<ol>\n<li>Tag</li>\n<li>Index</li>\n<li>Offset</li>\n</ol>\n<p>\u7f13\u5b58\u7ec4\u7ec7\u6210\u591a\u8def\uff0c\u6bcf\u4e00\u8def\u6709\u82e5\u5e72\u4e2a\u9879\uff0c\u6bcf\u9879\u91cc\u9762\u662f\u4e00\u4e2a\u7f13\u5b58\u884c\u3002\u67e5\u8be2\u65f6\uff0c\u9996\u5148\u6839\u636e Index \u4f5c\u4e3a\u4e0b\u6807\uff0c\u53bb\u7d22\u5f15\u7f13\u5b58\uff0c\u5f97\u5230\u591a\u8def\u7684\u7f13\u5b58\u884c\uff1b\u7136\u540e\u518d\u7528 Tag \u548c\u591a\u8def\u7f13\u5b58\u884c\u8fdb\u884c\u6bd4\u8f83\uff0c\u5982\u679c\u6709\u5339\u914d\uff0c\u5219\u8bf4\u660e\u662f\u547d\u4e2d\uff1b\u5426\u5219\u5c31\u662f\u7f13\u5b58\u7f3a\u5931\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u5148\u7528 Index\uff0c\u540e\u7528 Tag\uff0c\u56e0\u6b64\u5982\u679c\u53ef\u4ee5\u5148\u5f97\u5230 Index\uff0c\u5c31\u53ef\u4ee5\u63d0\u524d\u5b8c\u6210\u7b2c\u4e00\u6b65\u3002\u56de\u987e\u4e00\u4e0b\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684\u8f6c\u6362\uff1a\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684\u9875\u5185\u504f\u79fb\u662f\u76f8\u540c\u7684\uff0c\u53ea\u4f1a\u4fee\u6539\u9875\u53f7\u3002\u90a3\u4e48\uff0c\u5982\u679c\u628a Index \u653e\u5728\u9875\u5185\u504f\u79fb\u7684\u90e8\u5206\uff0c\u90a3\u5c31\u53ef\u4ee5\u5728\u865a\u5b9e\u5730\u5740\u8f6c\u6362\u4e4b\u524d\uff0c\u76f4\u63a5\u4ece\u865a\u62df\u5730\u5740\u83b7\u53d6\u5230 Index\uff0c\u5e76\u4e14\u8fd9\u4e2a Index \u4e00\u5b9a\u662f\u7269\u7406\u5730\u5740\u7684 Index\uff0c\u6bd5\u7adf\u865a\u5b9e\u5730\u5740\u8f6c\u6362\u4e0d\u4f1a\u4fee\u6539 Index\u3002\u8fd9\u5c31\u662f VIPT\u3002</p>\n<p>\u6240\u4ee5\u5f88\u660e\u663e\uff0cVIPT \u662f\u4e00\u79cd\u4f18\u5316\u65b9\u6cd5\uff0c\u5229\u7528\u865a\u5b9e\u8f6c\u6362\u4e2d\u9875\u5185\u504f\u79fb\u4e0d\u53d8\u7684\u7279\u6027\uff0c\u5b9e\u73b0\u66f4\u5feb\u7684\u6570\u636e\u7f13\u5b58\u8bfb\u53d6\u3002</p>\n<h2 id=\"vipt-\u7684\u5c40\u9650\u6027\">VIPT \u7684\u5c40\u9650\u6027<a class=\"headerlink\" href=\"#vipt-\u7684\u5c40\u9650\u6027\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4f46\u540c\u65f6\uff0cVIPT \u4e5f\u7ed9 L1 \u6570\u636e\u7f13\u5b58\u5e26\u6765\u4e86\u5c40\u9650\u6027\u3002\u524d\u9762\u63d0\u5230\uff0cVIPT \u8981\u6c42 Index \u88ab\u5305\u542b\u5728\u9875\u5185\u504f\u79fb\u4e2d\uff0c\u90a3\u4e48\u53ef\u4ee5\u6765\u7b97\u4e00\u7b97\uff0cIndex \u6700\u5927\u662f\u591a\u5c11\uff1a</p>\n<p>\u5047\u5982\u9875\u5927\u5c0f\u662f <span class=\"arithmatex\">\\(P\\)</span>\uff0c\u6bcf\u4e2a\u7f13\u5b58\u884c\u5927\u5c0f\u662f <span class=\"arithmatex\">\\(C\\)</span>\uff0c\u4e3a\u4e86\u8ba9 Index \u5305\u542b\u5728\u9875\u5185\u504f\u79fb\u4e2d\uff0cIndex \u7684\u4e2a\u6570\uff08\u4e5f\u53eb\u505a Sets\uff09<span class=\"arithmatex\">\\(I\\)</span> \u9700\u8981\u6ee1\u8db3 <span class=\"arithmatex\">\\(I * C \\le P\\)</span>\u3002</p>\n<p>\u6b64\u65f6\u8003\u8651\u4e00\u4e0b\u6570\u636e\u7f13\u5b58\u7684\u603b\u5927\u5c0f\uff1a\u6bcf\u4e2a Index \u6709 Way \u8def\u7f13\u5b58\u884c\uff0c\u6240\u4ee5\u603b\u5927\u5c0f\u662f <span class=\"arithmatex\">\\(I * C * W\\)</span>\uff0c\u5176\u4e2d <span class=\"arithmatex\">\\(W\\)</span> \u6307\u7684\u662f\u8def\u6570\u3002\u6b64\u65f6\u4f60\u4f1a\u53d1\u73b0\uff0c\u6570\u636e\u7f13\u5b58\u7684\u603b\u5927\u5c0f\u4e0d\u5927\u4e8e <span class=\"arithmatex\">\\(W * P\\)</span>\uff0c\u4e5f\u5c31\u662f\u8def\u6570\u4e58\u4ee5\u9875\u7684\u5927\u5c0f\u3002</p>\n<p>\u6362\u53e5\u8bdd\u8bf4\uff0cL1 \u6570\u636e\u7f13\u5b58\u5927\u5c0f\uff0c\u53d7\u9650\u4e8e\u8def\u6570\u4e58\u4ee5\u9875\u7684\u5927\u5c0f\u3002\u5982\u679c\u4f60\u53bb\u67e5\u770b\u4e00\u4e9b\u5904\u7406\u5668\uff0c\u4f60\u4f1a\u53d1\u73b0\u5b83\u4eec\u90fd\u53d6\u5230\u4e86\u8fd9\u4e2a\u6700\u5927\u503c\uff1a</p>\n<ol>\n<li>i9-13900K: L1 \u6570\u636e\u7f13\u5b58 48KB\uff0c<span class=\"arithmatex\">\\(W=12, P=4096\\)</span></li>\n<li>i9-10980XE: L1 \u6570\u636e\u7f13\u5b58 32KB\uff0c<span class=\"arithmatex\">\\(W=8, P=4096\\)</span></li>\n<li>EPYC 7551: L1 \u6570\u636e\u7f13\u5b58 32KB\uff0c<span class=\"arithmatex\">\\(W=8, P=4096\\)</span></li>\n<li>3A6000: L1 \u6570\u636e\u7f13\u5b58 64KB\uff0c<span class=\"arithmatex\">\\(W=4, P=16384\\)</span></li>\n</ol>\n<p>\u6bd5\u7adf\u6bd4\u8f83\u5927\u7684 L1 \u6570\u636e\u7f13\u5b58\u5bf9\u6027\u80fd\u662f\u6709\u5e2e\u52a9\u7684\uff0c\u5f53\u7136\u4e86\uff0c\u592a\u5927\u4e86\u4e5f\u4f1a\u5bfc\u81f4 Load To Use \u5ef6\u8fdf\u589e\u52a0\uff0c\u53ef\u80fd\u5f97\u4e0d\u507f\u5931\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0cL2 L3 \u7b49\u7f13\u5b58\u5c31\u6ca1\u6709\u8fd9\u4e2a\u9650\u5236\u4e86\uff0c\u6bd5\u7adf\u901a\u5e38\u662f\u91c7\u7528\u7269\u7406\u5730\u5740\uff0c\u4e0d\u6d89\u53ca VIPT\u3002</p>\n<p>\u8fd9\u65f6\u5019\u4f60\u53ef\u80fd\u8981\u8bf4\u4e86\uff0c\u7b49\u7b49\uff01\u4e3a\u5565\u6709\u4e00\u4e9b\u5904\u7406\u5668\u4e0d\u7b26\u5408\u8fd9\u4e2a\u89c4\u5219\uff1a</p>\n<ol>\n<li>Kunpeng-920: L1 \u6570\u636e\u7f13\u5b58 64KB\uff0c<span class=\"arithmatex\">\\(W=4, P=4096\\)</span></li>\n</ol>\n<p>\u6b64\u65f6 <span class=\"arithmatex\">\\(W * P\\)</span> \u53ea\u6709 16KB\uff0c\u4e3a\u4ec0\u4e48\u80fd\u591f\u5b9e\u73b0 64KB \u7684\u6570\u636e\u7f13\u5b58\uff1f\u5b9e\u9645\u4e0a\uff0c\u524d\u9762\u7684\u8ba8\u8bba\u90fd\u57fa\u4e8e\u4e00\u4e2a\u5047\u8bbe\uff1a\u9875\u8868\u5927\u5c0f\u662f\u56fa\u5b9a\u7684\u3002\u8981\u662f\u9875\u8868\u5927\u5c0f\u4e0d\u552f\u4e00\u5462\uff1f</p>\n<h2 id=\"\u591a\u53d8\u7684\u9875\u8868\u5927\u5c0f\">\u591a\u53d8\u7684\u9875\u8868\u5927\u5c0f<a class=\"headerlink\" href=\"#\u591a\u53d8\u7684\u9875\u8868\u5927\u5c0f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u73b0\u5728\u4e00\u4e9b\u5904\u7406\u5668\uff0c\u7279\u522b\u662f\u975e x86 \u7684\u5904\u7406\u5668\uff0c\u901a\u5e38\u4f1a\u652f\u6301\u591a\u79cd\u9875\u8868\u5927\u5c0f\uff1a4KB\u300116KB \u548c 64KB\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u3002\u4f8b\u5982\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0cKunpeng-920 \u5c31\u652f\u6301\u591a\u79cd\u9875\u8868\u5927\u5c0f\uff0c\u5982\u679c\u4f60\u7528\u6570\u636e\u7f13\u5b58\u5927\u5c0f\u5012\u63a8\uff0c\u4f1a\u5f97\u5230\u9875\u8868\u662f 16KB \u7684\u7ed3\u8bba\u3002\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff0c\u5982\u679c\u8981\u652f\u6301\u591a\u79cd\u9875\u8868\u5927\u5c0f\uff0cVIPT \u8fd8\u80fd\u6b63\u5e38\u5de5\u4f5c\u5417\uff1f</p>\n<p>\u5047\u8bbe\u6709\u4e00\u4e2a CPU\uff0c\u6570\u636e\u7f13\u5b58\u5927\u5c0f\u662f 64KB\uff0c4 \u8def\uff0c\u7f13\u5b58\u884c\u5927\u5c0f\u662f 64 \u5b57\u8282\u3002\u90a3\u4e48\uff0c\u6839\u636e\u8fd9\u4e9b\u4fe1\u606f\uff0c\u53ef\u4ee5\u8ba1\u7b97\u51fa\u7f13\u5b58\u6709 256 \u4e2a Set\uff0c\u4e5f\u5c31\u662f Index \u53ef\u4ee5\u53d6 0 \u5230 255\uff0c\u5360\u7528\u5730\u5740\u7684 8 \u4e2a\u4f4d\u3002\u7f13\u5b58\u884c\u5927\u5c0f\u662f 64 \u5b57\u8282\uff0c\u884c\u5185\u4fbf\u5b9c\u5360\u7528\u5730\u5740\u7684 6 \u4f4d\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cIndex \u5bf9\u5e94\u7684\u662f\u5730\u5740\u7684 <code>[13:6]</code> \u4f4d\u3002\u63a5\u4e0b\u6765\u5bf9\u9875\u8868\u5927\u5c0f\u8fdb\u884c\u5206\u7c7b\u8ba8\u8bba\uff1a</p>\n<p>\u5047\u5982\u9875\u8868\u5927\u5c0f\u662f 64 KB\uff0c\u90a3\u4e48\u9875\u5185\u504f\u79fb\u5c31\u662f\u5730\u5740\u7684\u7b2c <code>[15:0]</code> \u4f4d\uff0c\u90a3\u4e48\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684 <code>[15:0]</code> \u4f4d\u76f8\u7b49\uff0c\u81ea\u7136 Index \u5bf9\u5e94\u7684 <code>[13:6]</code> \u4f4d\u4e5f\u76f8\u7b49\uff0cVIPT \u4e0d\u4f1a\u9047\u5230\u95ee\u9898\u3002</p>\n<p>\u5047\u5982\u9875\u8868\u5927\u5c0f\u662f 16 KB\uff0c\u90a3\u4e48\u9875\u5185\u504f\u79fb\u5c31\u662f\u5730\u5740\u7684\u7b2c <code>[13:0]</code> \u4f4d\uff0c\u90a3\u4e48\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684 <code>[13:0]</code> \u4f4d\u76f8\u7b49\uff0c\u81ea\u7136 Index \u5bf9\u5e94\u7684 <code>[13:6]</code> \u4f4d\u4e5f\u76f8\u7b49\uff0cVIPT \u4e0d\u4f1a\u9047\u5230\u95ee\u9898\u3002</p>\n<p>\u5047\u5982\u9875\u8868\u5927\u5c0f\u662f 4 KB\uff0c\u90a3\u4e48\u9875\u5185\u504f\u79fb\u5c31\u662f\u5730\u5740\u7684\u7b2c <code>[11:0]</code> \u4f4d\uff0c\u90a3\u4e48\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684 <code>[11:0]</code> \u4f4d\u76f8\u7b49\uff0c\u4f46\u662f Index \u5bf9\u5e94\u7684 <code>[13:6]</code> \u4f4d\u5c31\u4e0d\u4e00\u5b9a\u76f8\u7b49\u4e86\u3002\u8fd9\u65f6\u5019\u4f1a\u51fa\u73b0\u4ec0\u4e48\u95ee\u9898\u5462\uff1f</p>\n<p>\u5982\u679c\u865a\u62df\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u90fd\u662f\u4e00\u4e00\u5bf9\u5e94\uff0c\u90a3\u4e48\u5373\u4f7f\u6620\u5c04\u65f6\u4fee\u6539\u4e86 <code>[13:12]</code> \u4f4d\uff0cIndex \u53d8\u4e86\uff0c\u4e5f\u6ca1\u95ee\u9898\uff0c\u53ea\u8981\u4fdd\u5b58\u7684 Tag \u662f\u5b8c\u6574\u7684 <code>[VALEN-1:12]</code> \u4f4d\uff0c\u6570\u636e\u4f9d\u7136\u53ef\u4ee5\u7cbe\u786e\u5730\u627e\u5230\uff0c\u4e0d\u4f1a\u8bbf\u95ee\u5230\u9519\u8bef\u7684\u6570\u636e\u3002\u4f46\u662f\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u6709\u53ef\u80fd\u51fa\u73b0\u591a\u4e2a\u865a\u62df\u5730\u5740\u5bf9\u5e94\u540c\u4e00\u4e2a\u7269\u7406\u5730\u5740\uff0c\u4f8b\u5982\u5171\u4eab\u5185\u5b58\u7b49\u7b49\u3002\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\uff1a0x80000000 -&gt; 0x00000000</li>\n<li>\u7b2c\u4e8c\u4e2a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\uff1a0x80001000 -&gt; 0x00000000</li>\n</ol>\n<p>\u8fd9\u4e24\u4e2a\u865a\u62df\u9875\u5bf9\u5e94\u540c\u4e00\u4e2a\u7269\u7406\u9875\uff0c\u4f46\u662f\u8fd9\u4e24\u4e2a\u865a\u62df\u9875\u7684 Index \u5374\u4e0d\u76f8\u540c\uff0c\u56e0\u4e3a\u5b83\u4eec\u7684\u7b2c <code>[13:12]</code> \u4f4d\u4e0d\u76f8\u7b49\u3002\u56de\u987e L1 \u6570\u636e\u7f13\u5b58\u8bbf\u95ee\u7684\u6d41\u7a0b\uff0c\u7b2c\u4e00\u6b65\u5c31\u662f\u7528 Index \u4f5c\u4e3a\u4e0b\u6807\u53bb\u8bbf\u95ee\uff0c\u65e2\u7136\u4e24\u4e2a\u865a\u62df\u9875\u7684\u8bbf\u95ee\u65f6\u4e0b\u6807\u5c31\u4e0d\u4e00\u6837\uff0c\u81ea\u7136\u4e5f\u6ca1\u6cd5\u8bbf\u95ee\u5230\u540c\u6837\u7684\u6570\u636e\uff0c\u5f80\u7b2c\u4e00\u4e2a\u865a\u62df\u9875\u5199\u6570\u636e\uff0c\u4ece\u7b2c\u4e8c\u4e2a\u865a\u62df\u9875\u5374\u8bfb\u4e0d\u51fa\u6765\uff0c\u8fd9\u5c31\u574f\u4e8b\u4e86\u3002\u8fd9\u4e2a\u73b0\u8c61\u53eb\u505a virtual aliasing\u3002</p>\n<p>\u8fd9\u4e2a\u95ee\u9898\u600e\u4e48\u89e3\u51b3\u5462\uff1f\u9605\u8bfb <a href=\"https://www.kernel.org/doc/Documentation/cachetlb.txt\">Cache and TLB Flushing Under Linux</a>\uff0c\u91cc\u9762\u6709\u4e00\u6bb5\u8bdd\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>Is your port susceptible to virtual aliasing in its D-cache?\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>Well, if your D-cache is virtually indexed, is larger in size than\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>PAGE_SIZE, and does not prevent multiple cache lines for the same\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>physical address from existing at once, you have this problem.\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a>If your D-cache has this problem, first define asm/shmparam.h SHMLBA\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>properly, it should essentially be the size of your virtually\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a>addressed D-cache (or if the size is variable, the largest possible\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>size).  This setting will force the SYSv IPC layer to only allow user\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a>processes to mmap shared memory at address which are a multiple of\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>this value.\n</span></code></pre></div>\n<p>\u7ffb\u8bd1\u6210\u4e2d\u6587\uff0c\u610f\u601d\u5c31\u662f\uff0c\u5047\u5982\u6570\u636e\u7f13\u5b58\u7684 VIPT \u662f\u57fa\u4e8e\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u9875\uff08\u4e0a\u9762\u7684\u4f8b\u5b50\u662f 16KB\uff09\uff0c\u6bd4\u5b9e\u9645\u7684\u9875\u8868\u5927\u5c0f\u66f4\u5927\uff084KB\uff09\uff0c\u5e76\u4e14\u6ca1\u6709\u9632\u6b62\u540c\u4e00\u4e2a\u7269\u7406\u5730\u5740\u7684\u7f13\u5b58\u884c\u51fa\u73b0\u591a\u6b21\uff0c\u5c31\u4f1a\u9047\u5230\u95ee\u9898\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u9700\u8981\u5728 Linux \u91cc\u8bbe\u7f6e <code>SHMLBA</code> \u53c2\u6570\uff0c\u5b83\u7684\u5927\u5c0f\u5e94\u8be5\u662f VIPT \u5bf9\u5e94\u7684\u9875\u5927\u5c0f\uff0816KB\uff09\u3002\u5b83\u4f1a\u8981\u6c42\u5171\u4eab\u5185\u5b58\u7684\u57fa\u5730\u5740\u4e00\u5b9a\u662f <code>SHMLBA</code> \u7684\u500d\u6570\u3002</p>\n<p>\u8fd9\u5c31\u89e3\u51b3\u4e86\u524d\u9762\u7684\u95ee\u9898\uff1a\u51fa\u73b0\u591a\u4e2a\u865a\u62df\u5730\u5740\u6620\u5c04\u540c\u4e00\u4e2a\u7269\u7406\u5730\u5740\u65f6\uff0c\u65e2\u7136 Index \u4e0d\u4e00\u81f4\u4f1a\u6709\u95ee\u9898\uff0c\u90a3\u5c31\u8f6f\u4ef6\u4e0a\u53bb\u4fdd\u8bc1 Index \u4e00\u81f4\uff0c\u800c\u4fdd\u8bc1 Index \u4e00\u81f4\uff0c\u5176\u5b9e\u5c31\u662f\u5bf9\u9f50\u5230 <code>SHMLBA</code> \u7684\u500d\u6570\u3002\u56de\u987e\u4e0a\u9762\u7684\u4f8b\u5b50\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\uff1a0x80000000 -&gt; 0x00000000</li>\n<li>\u7b2c\u4e8c\u4e2a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\uff1a0x80001000 -&gt; 0x00000000</li>\n</ol>\n<p>\u7b2c\u4e8c\u4e2a\u9875\u5c31\u6ca1\u6709\u5bf9\u9f50\u5230 <code>SHMLBA</code>\uff0c\u4e5f\u5c31\u662f 16KB \u7684\u8fb9\u754c\u4e0a\u3002\u5047\u5982\u6620\u5c04\u7684\u65f6\u5019\uff0c\u5c31\u4fdd\u8bc1\u7b2c\u4e8c\u4e2a\u9875\u5bf9\u9f50\u5230 16KB \u7684\u8fb9\u754c\u4e0a\uff0c\u5c31\u53d8\u6210\u4e86\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\uff1a0x80000000 -&gt; 0x00000000</li>\n<li>\u7b2c\u4e8c\u4e2a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\uff1a0x80004000 -&gt; 0x00000000</li>\n</ol>\n<p>\u6b64\u65f6\u8fd9\u4e24\u4e2a\u9875\u7684\u865a\u62df\u5730\u5740\u7684 <code>[13:12]</code> \u4f4d\u5c31\u76f8\u540c\u4e86\uff0c\u4e0d\u4f1a\u51fa\u73b0 virtual aliasing \u7684\u95ee\u9898\u3002\u8fd9\u4e2a\u65b9\u6cd5\u4e5f\u53eb Page Coloring\uff08\u7684\u4e00\u79cd\uff09\uff0c\u989d\u5916\u8981\u6c42\u5171\u4eab\u5185\u5b58\u4e2d\u865a\u62df\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u7684\u7b2c <code>[13:12]</code> \u4f4d\u76f8\u540c\u3002</p>\n<p>\u56e0\u6b64\uff0c\u5728\u4f7f\u7528\u5171\u4eab\u5185\u5b58\u7684\u65f6\u5019\uff0c\u4e0d\u8981\u5fd8\u8bb0\u4e86\u5bf9\u9f50\u5230 <code>SHMLBA</code>\uff0c\u5b83\u4e0d\u4e00\u5b9a\u662f\u9875\u8868\u7684\u5927\u5c0f\u3002</p>\n<p>\u8fd9\u662f\u8f6f\u4ef6\u505a\u6cd5\uff0c\u6709\u6ca1\u6709\u786c\u4ef6\u505a\u6cd5\u5462\uff1f\u7b54\u6848\u662f\uff0c\u6709\uff0c\u53ef\u4ee5\u53c2\u8003 <a href=\"https://cs.stackexchange.com/a/32302\">What problem does cache coloring solve?</a> \u548c <a href=\"https://ntnuopen.ntnu.no/ntnu-xmlui/handle/11250/2467634\">Designing a Virtual Memory System for the SHMAC Research Infrastructure</a> \u7b2c 3.7 \u8282\u3002\u8fd9\u91cc\u5217\u51fa\u6765\u51e0\u79cd\u6bd4\u8f83\u597d\u7406\u89e3\u7684\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\u7f13\u5b58\u7f3a\u5931\u7684\u65f6\u5019\uff0c\u53bb\u5176\u4ed6 set \u91cc\u5bfb\u627e\u5339\u914d\uff0c\u5982\u679c\u53d1\u73b0\u4e86\uff0c\u5c31\u628a\u6570\u636e\u632a\u5230\u5f53\u524d\u7684 virtual index \u5bf9\u5e94\u7684\u4f4d\u7f6e\u3002\u8fd9\u4e2a\u65b9\u6cd5\u590d\u6742\u70b9\u5728\u4e8e\u9700\u8981\u53bb\u5176\u4ed6 set \u91cc\u5bfb\u627e\u53ef\u80fd\u7684\u5339\u914d\u3002</li>\n<li>\u5728 L2 \u7f13\u5b58\u4e2d\u8bb0\u5f55\u7f13\u5b58\u884c\u5bf9\u5e94\u7684 virtual index\uff0c\u7f13\u5b58\u7f3a\u5931\u7684\u65f6\u5019\uff0c\u53bb\u8be2\u95ee L2\uff0cL2 \u53d1\u73b0\u6709 alias \u7684\u60c5\u51b5\uff0c\u544a\u8bc9 L1 \u7f13\u5b58\uff0c\u8ba9\u4ed6\u53bb\u6307\u5b9a\u7684 set \u91cc\u5bfb\u627e\u6570\u636e\uff0c\u5e76\u4e14\u8fc1\u79fb\u3002\u8fd9\u4e2a\u65b9\u6cd5\u7684\u597d\u5904\u662f\u4e0d\u9700\u8981\u50cf\u7b2c\u4e00\u79cd\u65b9\u6cd5\u90a3\u6837\u53bb\u5bfb\u627e\u53ef\u80fd\u7684\u5339\u914d\uff0c\u800c\u662f\u8ba9 L2 \u53bb\u8bb0\u5f55\u4fe1\u606f\u3002\u7f3a\u70b9\u5c31\u662f\u9700\u8981\u8bb0\u5f55\u66f4\u591a\u4fe1\u606f\uff0c\u53e6\u5916\u8981\u6c42 L2 \u7f13\u5b58\u9700\u8981\u662f inclusive \u7684\u3002\u89c1 <a href=\"https://xiangshan-doc.readthedocs.io/zh-cn/latest/huancun/cache_alias/\">XiangShan Cache \u522b\u540d\u95ee\u9898</a></li>\n</ol>\n<p>\u6b64\u5916\u8fd8\u6709\u4e00\u4e9b\u6bd4\u8f83\u590d\u6742\u7684\u65b9\u6cd5\uff0c\u5efa\u8bae\u9605\u8bfb\u4e0a\u9762\u7684\u53c2\u8003\u8bba\u6587\u3002</p>\n<p>\u56e0\u6b64 VIPT \u4e5f\u53ef\u4ee5\u4e0d\u53d7\u5b9e\u9645\u7684\u9875\u5927\u5c0f\u7684\u9650\u5236\uff0c\u4f46\u662f\u4e3a\u4e86\u89e3\u51b3 aliasing \u7684\u95ee\u9898\uff0c\u9700\u8981\u5728\u8f6f\u4ef6\u4e0a\u6216\u8005\u786c\u4ef6\u4e0a\u627e\u8865\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/page-colouring-on-armv6-and-a-bit-on-armv7\">Page Colouring on ARMv6 (and a bit on ARMv7)</a></li>\n<li>\u63a8\u8350\u9605\u8bfb\uff1a<a href=\"https://blog.cyyself.name/why-the-big-l1-cache-is-so-hard/\">\u6d45\u8c08\u73b0\u4ee3\u5904\u7406\u5668\u5b9e\u73b0\u8d85\u5927 L1 Cache \u7684\u65b9\u5f0f</a></li>\n</ul>", "image": null, "date_published": "2023-12-08T00:00:00+00:00", "authors": [], "tags": ["cache", "cpu", "hardware", "paging", "vipt"]}]}