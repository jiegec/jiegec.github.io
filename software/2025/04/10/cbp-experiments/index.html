
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维，编程，调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/software/2025/04/10/cbp-experiments/">
      
      
        <link rel="prev" href="../../07/tls-internals/">
      
      
        <link rel="next" href="../../../../../hardware/2025/04/23/intel-redwood-cove/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>如何进行条件分支预测器实验 - 杰哥的{运维，编程，调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-3109FRSVTT",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#如何进行条件分支预测器实验" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维，编程，调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              如何进行条件分支预测器实验
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../../../../.." class="md-tabs__link">
        
  
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../about/" class="md-tabs__link">
        
  
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../open-source-contributions/" class="md-tabs__link">
        
  
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tags/" class="md-tabs__link">
        
  
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="/cpu/" class="md-tabs__link">
        
  
  
    
  
  CPU

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../series/" class="md-tabs__link">
        
  
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../projects/" class="md-tabs__link">
        
  
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tools/" class="md-tabs__link">
        
  
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../benchmark/" class="md-tabs__link">
        
  
  
    
  
  SPEC

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../archive/2025/" class="md-tabs__link">
          
  
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../category/crypto/" class="md-tabs__link">
          
  
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    杰哥的{运维，编程，调板子}小笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../open-source-contributions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    开源
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    知识库
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/cpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CPU
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    项目
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    订阅
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SPEC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2018/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2017/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2017
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2016/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2016
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2014/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2014
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/crypto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    crypto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/csdn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    csdn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/ctf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ctf
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    devops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/hardware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hardware
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/meta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    meta
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    misc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/networking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    networking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/os/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    os
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/others/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    others
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/programming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    system
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    回到主页
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    元数据
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2025-04-10 00:00:00+00:00" class="md-ellipsis">2025年4月10日</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            分类于
                            
                              <a href="../../../../../category/software/">software</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              需要 11 分钟阅读时间
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#背景" class="md-nav__link">
    <span class="md-ellipsis">
      背景
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#流程" class="md-nav__link">
    <span class="md-ellipsis">
      流程
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#benchmark-准备" class="md-nav__link">
    <span class="md-ellipsis">
      benchmark 准备
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simpoint" class="md-nav__link">
    <span class="md-ellipsis">
      SimPoint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trace-抓取" class="md-nav__link">
    <span class="md-ellipsis">
      trace 抓取
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#条件分支预测器模拟" class="md-nav__link">
    <span class="md-ellipsis">
      条件分支预测器模拟
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#实验数据" class="md-nav__link">
    <span class="md-ellipsis">
      实验数据
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实验数据">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trace-抓取_1" class="md-nav__link">
    <span class="md-ellipsis">
      Trace 抓取
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#时间开销" class="md-nav__link">
    <span class="md-ellipsis">
      时间开销
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simpoint_1" class="md-nav__link">
    <span class="md-ellipsis">
      SimPoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#分支预测器模拟" class="md-nav__link">
    <span class="md-ellipsis">
      分支预测器模拟
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#不同编译器编译选项和指令集下-spec-int-2017-的指令数和分支指令数规模" class="md-nav__link">
    <span class="md-ellipsis">
      不同编译器、编译选项和指令集下 SPEC INT 2017 的指令数和分支指令数规模
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#基于-pin-开发-branch-trace-工具" class="md-nav__link">
    <span class="md-ellipsis">
      基于 Pin 开发 branch trace 工具
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  


  <nav class="md-tags" >
    
      
      
      
        <a href="../../../../../tags/#tag:bp" class="md-tag">bp</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:cbp" class="md-tag">cbp</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:cpu" class="md-tag">cpu</a>
      
    
      
      
      
        <a href="../../../../../tags/#tag:ooo" class="md-tag">ooo</a>
      
    
  </nav>


  
  


<h1 id="如何进行条件分支预测器实验">如何进行条件分支预测器实验<a class="headerlink" href="#如何进行条件分支预测器实验" title="Permanent link">&para;</a></h1>
<h2 id="背景">背景<a class="headerlink" href="#背景" title="Permanent link">&para;</a></h2>
<p>最近针对各种条件分支预测器（Conditional Branch Predictor）做了在各种 benchmark 上的实验，在此记录一下做这个实验的流程。</p>
<!-- more -->

<h2 id="流程">流程<a class="headerlink" href="#流程" title="Permanent link">&para;</a></h2>
<p>说到做条件分支预测器实验，到底是做什么呢？其实就是针对未来的处理器中的条件分支预测器的设计，在提前准备好的一些 benchmark 上进行模拟，观察它的预测准确性。既然是未来的处理器，那么硬件肯定是没有的，如果直接用 RTL 去实现新的预测器，再用 RTL 仿真，结果固然准确，但这还是太复杂并且太慢了。所以在前期的时候，首先会构建一个单独的条件分支预测器的实验环境，在只考虑条件分支指令、不考虑其他指令的情况下，单纯来观察预测的效果，从而可以实现比较快速的设计迭代。</p>
<p>为了达成这个目的，需要：</p>
<ol>
<li>提前准备好一些 benchmark，提取出这个 benchmark 中所涉及到的条件分支 trace，以及条件分支预测器所需要的其他信息</li>
<li>为了进一步缩短模拟的时间和 trace 的大小，利用 SimPoint 等技术来减少要模拟的指令条数</li>
<li>搭建一个条件分支预测器模拟器，在上一步提取出来的 trace 中模拟条件分支预测器的执行，从而得到结果</li>
</ol>
<p>下面按照这个顺序，分别来讨论一下这个流程。</p>
<h2 id="benchmark-准备">benchmark 准备<a class="headerlink" href="#benchmark-准备" title="Permanent link">&para;</a></h2>
<p>比较常见的 benchmark 就是 SPEC INT 2017，当然现在很多论文也会自己去寻找一些其他的 benchmark，不同的 benchmark 它的程序的特性也是不一样的，未来也可能会有新的 benchmark 出来，所以有必要了解从 benchmark 到 trace 的过程。选好了 benchmark 以后，我们需要思考怎么去生成一个 trace：为了减少后续模拟的负担，我们需要从 benchmark 中提取条件分支的执行历史，作为 groundtruth，喂给条件分支预测器，这样才能知道每次预测是否准确。当然了，网上已经有很多现成的 trace，比如 CBP Championship 比赛也都有提供自己的 benchmark trace（P.S. 2025 年的 CBP Championship 正在火热进行中），但读完本文，你应该可以尝试自己完成这个从 benchmark 到 trace 的过程。</p>
<p>那么第一个问题就是，怎么获取 benchmark 中分支指令执行的信息呢？首先来看一组数据，在 amd64 上，用 <code>-O3</code> 编译 SPEC INT 2017 的 benchmark，一共 10 个子 benchmark，加起来运行的指令数大约是 1.6e13 条，其中有大约 2.9e12 条分支指令（包括了有条件和无条件），这个数量是非常巨大的，无论是保存这些执行信息的性能开销，还是需要的存储空间，都是比较巨大的。</p>
<p>考虑到条件分支预测器只需要分支指令的信息，所以只考虑 2.9e12 条分支指令的部分，而不去考虑完整的 1.6e13 条指令，首先可以减少一个数量级。接着，考虑每个分支指令需要记录哪些信息：</p>
<ol>
<li>知道每一条分支指令的地址、每一条直接分支指令的目的地址</li>
<li>对于执行的每一条条件分支指令，要记录它跳转与否</li>
<li>对于执行的每一条间接分支指令，需要记录它跳转的目的地址</li>
</ol>
<p>其中第一点，由于条件分支指令本身是不变的（不考虑 JIT），所以只需要存一份就行。而 SPEC INT 2017 所有程序的分支指令加起来大概只有 5e4 的量级，相比 2.9e12 的执行的分支指令数可以忽略不计。第三点，由于间接分支指令通常也是比较少的，而且同一条间接分支指令的目的地址通常来说不会特别多，也有压缩的空间。那么最主要的空间来自于：</p>
<ol>
<li>虽然条件分支指令数量不多，但是执行的条件分支指令次数很多，每一次执行的可能是不同的条件分支指令，如果要记录当前这次执行的是哪一条条件分支指令，那么这个指令的地址或者一个 id 所占用的空间会很大；如果不记录当前执行的是哪一条分支分支指令，就需要在后续处理的时候，结合可执行程序的汇编来推断，当前执行的是哪一条条件分支指令</li>
<li>其次就是要记录条件分支跳转与否，这一个的开销相对会小一些，只需要一个 bit</li>
</ol>
<p>由此可以推导出不同的 trace 记录方式：</p>
<p>第一种方式是，遇到条件分支指令时，只记录跳转（Taken）还是不跳转（Not Taken），这种方式保存的数据量最小（平均每个分支只需要比 1 bit 略多的空间），但是后续需要结合汇编，恢复出执行的过程，更进一步还可以压缩那些 return 的目的地址等于对应的 call 指令的下一条指令的地址的情况（Indirect Transfer Compression for Returns）。Intel PT 采用的是这种方法。</p>
<p>第二种方式是，遇到条件分支指令时，不仅记录跳转与否，还记录它执行的是哪一条分支指令。这种方式保存的数据量稍多，假如要支持 5e4 条不同的条件分支指令，为了保存这个 id，就需要 16 位。类似地，也可以只记录跳转了的条件分支指令，那么那些没有跳转的条件分支指令，就需要后续结合汇编或者完整的条件分支指令表来恢复出来。CBP Championship 的 trace 采用的是这种方法。</p>
<p>第一种方法明显空间会更小，以 2.9e12 条执行的分支指令数，大概需要 300GB 的磁盘空间；第二种方法，同样的分支指令数，就需要大概 5.8TB 的磁盘空间。当然了，第二种方法存的数据可以经过无损压缩进一步缩小空间，实测压缩后大概是每分支 0.16 字节（这个数字与所跑的 benchmark 有关系，分支容易被预测的 benchmark 对应更好的压缩率，因为某种意义来说分支预测也是一种无损压缩），只比第一种方法大概每分支 0.14 字节略大。同理，第一种方法存的数据也可以经过无损压缩进一步缩小空间，达到每分支大约 0.018 字节的程度（压缩率也和分支预测准确率有关）。</p>
<p>在评估条件分支预测器的时候，除了知道分支本身，还需要知道执行的指令数，用于计算 MPKI 等，这个可以通过 PMU 单独统计出来，或者直接根据控制流推算出执行的指令数，例如在等长指令的 ISA 上直接用地址差除以指令长度来计算指令数，在变长指令的 ISA 上 Parse ELF 去解析控制流经过的指令：</p>
<ol>
<li>解析 ELF，用反汇编器得到每条指令的地址，从小到大排序放到数组中</li>
<li>对于每个分支地址和目的地址，查询它对应的指令在指令数组中的下标，记录下来</li>
<li>统计指令数时，每遇到一个跳转的分支，就用当前跳转的分支的分支地址在指令数组中的下标，减去上一个跳转的分支的目的地址在指令数组中的下标，加上一，累加到指令数中</li>
</ol>
<p>当然了，这里有一些细节，例如如果程序是 PIE，那么需要知道它加载的基地址，从而把运行时的指令地址和 ELF 对应起来；类似地，如果程序加载了 libc 等动态库，也需要知道它们的加载地址。这些信息可以在抓取指令 trace 的同时，顺带记录下来。如果想规避这个麻烦，可以使用静态编译，不过 vdso 依然会动态加载，但 vdso 内指令很少，通常可以忽略不计，可以特判忽略掉。</p>
<p>此外，如果分支预测器需要知道分支指令的 fallthrough 地址（例如 Path History Register），且使用的是变长指令集，还需要记录分支指令的长度。这些需求实现起来都并不复杂，也只需要占用很小的空间。</p>
<p>TB 级别的规模，无论是保存这些数据，还是生成这些数据，或者更进一步在这些数据上模拟条件分支预测器，都会带来很大的负担。因此，需要一个办法来减少要模拟的 trace 长度。</p>
<h2 id="simpoint">SimPoint<a class="headerlink" href="#simpoint" title="Permanent link">&para;</a></h2>
<p><a href="https://cseweb.ucsd.edu/~calder/papers/ASPLOS-02-SimPoint.pdf">SimPoint</a> 是解决这个问题的一个很重要的方法：它观察到了一个很重要的现象，就是这些 benchmark 其实大多数时候是在重复做相同的事情，只不过涉及到的数据不同。这也很好理解，因为很多程序里面都是循环，而循环是很有规律的，我们可以预期程序的行为在时间尺度上也会有一定的周期性。下面是 SimPoint 论文中的一个图，它记录了 gzip-graphic benchmark 的 IPC（每周期指令数，图中的实线）和 L1 数据缓存缺失率（图中的虚线）随着执行过程的变化：</p>
<p><img alt="" src="../../../../cbp-experiments-simpoint.png" /></p>
<p>可以看到比较明显的周期性，而涉及到周期性，就会想到利用周期的性质：如果在一个周期上评估它的 IPC 或者分支预测器的准确率，然后外推到其他的周期，是不是大大缩小了执行时间？SimPoint 利用这个思想，设计了如下的步骤：</p>
<ol>
<li>首先把整个执行过程按照执行的指令数切分成很多个 slice</li>
<li>接着对 slice 进行聚类，使得每一个类内的 slice 的行为类似，这个类就叫做一个 phase</li>
<li>之后做实验的时候，只需要对每个 phase 内的一个 slice 进行实验，评估出它的 IPC 或者其他性能指标，再按照 phase 内的 slice 数量加权平均，就可以得到完整执行过程的性能指标了</li>
</ol>
<p>这里比较核心的步骤，就是怎么对 slice 聚类？SimPoint 论文采用了机器学习的方法：针对每个 slice，统计它在不同 Basic Block 内执行的时间的比例，把这个统计数据记为 Basic Block Vector；那么聚类，就是针对那些 Basic Block Vector 相近的 Slice，进行 K-Means 算法。</p>
<p>由于 K-Means 算法执行的时候，需要首先知道聚出来多少个类，所以 SimPoint 枚举了若干个不同的类的个数，对每个 K-Means 聚类结果进行打分：BIC（Bayesian Information Criterion），根据打分找到一个聚类效果足够好，但是类又不是特别多的结果。</p>
<p>进一步为了提升聚类的性能，SimPoint 还进行了一次降维操作，把很长的 Basic Block Vector 线性映射到一个比较小的 15 维的向量上。</p>
<p>SimPoint 论文中展示了聚类的效果，还是很可观的：</p>
<p><img alt="" src="../../../../cbp-experiments-simpoint-2.png" /></p>
<p>完成聚类以后，SimPoint 的输出就是若干个 phase，每一个类对应一个 phase，每个 phase 包括：</p>
<ol>
<li>权重：权重就是这个类中 slice 的个数</li>
<li>代表这个 phase 的一个 slice 的信息，例如它是从第几条指令开始到第几条指令</li>
</ol>
<p>完成 SimPoint 算法后，得到的 trace 长度大大减小，例如一段原始的长为 1e10 条指令的 trace，以 3e7 条指令为一个 slice，聚类以后，只剩下 10 个 phase，那么需要模拟和保存的 trace 长度只剩下了 3e8 条指令。SimPoint 聚类整个流程的性能大概在每秒 2e8 条分支指令的量级。</p>
<p>回顾前面提到的完整的 SPEC INT 2017 的量级：2.9e12 条执行的分支指令数，经过 SimPoint 处理后，假如每个子 benchmark 拆分成 15 个长度为 1e8 条指令的 phase，那么最终可能只需要 3e10 条指令，这就是一个比较好处理的大小了，以单核每秒模拟 1e7 条分支指令的速度，完整跑一次条件分支预测器实验，可能只需要几十分钟的时间，再加上多核，可以进一步缩短到几分钟。</p>
<h2 id="trace-抓取">trace 抓取<a class="headerlink" href="#trace-抓取" title="Permanent link">&para;</a></h2>
<p>刚才讨论了很多 trace 的大小以及如何用 SimPoint 压缩空间，那么这个 trace 到底怎么抓取呢？主要有两种方法：</p>
<ol>
<li>基于硬件已有的 trace，比如 <a href="../../../../2024/12/10/linux-perf-pmu/">Intel PT</a>，但需要注意，Intel PT 是可能丢失历史的，虽然比例比较小；为了避免丢失历史，建议设置 <code>sysctl kernel.perf_event_paranoid=-1</code>（或者用 root 权限来运行 <code>perf record</code>，即绕过 <code>mlock limit after perf_event_mlock_kb</code> 的限制）来扩大 Intel PT 使用的 buffer 大小，从 32KB 扩大到 1MB（参考 <a href="https://github.com/mysqlperformance/pt_perf">pt_perf</a>），在大小核机器上还要绑定到一个大核上</li>
<li>基于软件的 Binary Instrumentation，即针对分支指令插桩，比如 Pin、DynamoRIO 甚至 QEMU</li>
</ol>
<p>第一种方法性能是最好的，运行开销比较小，耗费 1.4x 的时间，但是后续处理也比较费劲一些，此外比较依赖平台，ARM 上虽然也有 SPE，但是支持的平台比较少。其他平台就不好说了。</p>
<p>第二种方法性能会差一些，大概会有 30-50x 的性能开销，但是一天一夜也能够把 SPEC INT 2017 跑完。实现的时候，需要注意在遇到分支的时候，首先把信息保存在内存的 buffer 中，buffer 满了再写盘；此外，为了减少磁盘空间以及写盘所耗费的 I/O 时间，可以在内存中一边生成数据一边压缩，直接把压缩好的数据写入到文件中。</p>
<p>实践中，可以先用 Intel PT 抓取 trace，再把 trace 转换为第二种格式，最终的抓取 + 转换的性能开销大概是 15x。大致算法如下：</p>
<ol>
<li>遍历程序中所有的分支，按照地址从小到大保存起来在数组当中，针对那些直接分支，提前计算好从它的目的地址开始遇到的第一个分支在数组的下标</li>
<li>解析 perf.data 中的 Intel PT packet，提取出其中的 TNT 和 TIP packet，从程序的 entrypoint 开始，沿着 Intel PT 的 trace 重建控制流：条件分支从 TNT packet 获取方向，间接分支从 TIP packet 获取目的地址，</li>
<li>如果分支跳转了，就根据目的地址找到从目的地址开始遇到的下一个分支（二分查找）；如果没有跳转，就直接访问数组的下一个分支</li>
<li>注意 RET compression 的处理：维护 call stack，如果遇到 return 的时候刚好在 TNT packet 中，且对应的 bit 是 Taken，则从 call stack 取出目的地址；一个优化是 call stack 不仅记录地址，还记录从这个地址开始遇到的下一个分支在数组的下标</li>
<li>重建控制流的同时，输出第二种格式的 trace，在内存中完成流式压缩</li>
</ol>
<p>以上的这些性能开销只是在一个程序上测得的结果，不同的程序上，其性能开销也有很大的不同。</p>
<p>对于动态链接，perf.data 会记录 mmap event；Pin 和 DynamoRIO 都可以对 module load 事件进行插桩。动态库可以从文件系统中访问，vdso 可以从内存中<a href="https://ldpreload.com/p/blog/dump-vdso.c">导出</a>。</p>
<h2 id="条件分支预测器模拟">条件分支预测器模拟<a class="headerlink" href="#条件分支预测器模拟" title="Permanent link">&para;</a></h2>
<p>在完成了前面的大部分步骤以后，最终就是搭建一个条件分支预测器的模拟器了。其实这一点倒是并不复杂，例如 CBP Championship 或者 ChampSim 都有现成的框架，它们也都提供了一些经典的分支预测器的实现代码，例如 TAGE-SC-L。在它们的基础上进行开发，就可以评估各种条件分支预测器的预测效果了。</p>
<p>实际上，除了条件分支预测器，还有很多其他的实验也可以用类似的方法构建 trace 然后运行。但条件分支预测器有个比较好的特点：它需要的状态比较简单，通常拿之前一段指令做预热即可，不需要 checkpoint；而如果要完整模拟整个处理器的执行，通常需要得到系统的整个状态，比如内存和寄存器，才能继续执行，这时候就可能需要提前把 slice 开始的状态保存下来（checkpoint），或者用一个简单的不精确的模拟器快速计算出 slice 开始的状态（fast forwarding）。</p>
<h2 id="实验数据">实验数据<a class="headerlink" href="#实验数据" title="Permanent link">&para;</a></h2>
<h3 id="trace-抓取_1">Trace 抓取<a class="headerlink" href="#trace-抓取_1" title="Permanent link">&para;</a></h3>
<p>在这里列出最终使用的 trace 格式和实验数据：</p>
<ol>
<li>trace 格式：使用第二种 trace 记录方法，每次执行 branch 记录 4 字节的信息，包括 branch id 和是否跳转，使用 zstd 进行无损压缩</li>
<li>trace 大小和运行时间统计（GCC 12.2.0，<code>-O3 -static</code> 编译，在 Intel i9-14900K 上实验）：</li>
</ol>
<table>
<thead>
<tr>
<th>benchmark</th>
<th>子 benchmark</th>
<th>分支执行次数</th>
<th>trace 大小</th>
<th>每分支空间开销</th>
<th>程序直接运行时间</th>
<th>Pin 抓取时间</th>
<th>时间开销</th>
</tr>
</thead>
<tbody>
<tr>
<td>500.perlbench_r</td>
<td>checkspam</td>
<td>2.40e11</td>
<td>8.87 GiB</td>
<td>0.32 bit</td>
<td>59s</td>
<td>6334s</td>
<td>107x</td>
</tr>
<tr>
<td>500.perlbench_r</td>
<td>diffmail</td>
<td>1.49e11</td>
<td>2.78 GiB</td>
<td>0.16 bit</td>
<td>33s</td>
<td>4615s</td>
<td>140x</td>
</tr>
<tr>
<td>500.perlbench_r</td>
<td>splitmail</td>
<td>1.33e11</td>
<td>1.49 GiB</td>
<td>0.10 bit</td>
<td>31s</td>
<td>3385s</td>
<td>109x</td>
</tr>
<tr>
<td>500.perlbench_r</td>
<td>Total</td>
<td>5.22e11</td>
<td>13.14 GiB</td>
<td>0.22 bit</td>
<td>123s</td>
<td>14334s</td>
<td>117x</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>gcc-pp -O3</td>
<td>4.50e10</td>
<td>3.28 GiB</td>
<td>0.63 bit</td>
<td>17s</td>
<td>1625s</td>
<td>96x</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>gcc-pp -O2</td>
<td>5.37e10</td>
<td>3.46 GiB</td>
<td>0.55 bit</td>
<td>20s</td>
<td>1930s</td>
<td>97x</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>gcc-smaller</td>
<td>5.51e10</td>
<td>2.84 GiB</td>
<td>0.44 bit</td>
<td>21s</td>
<td>1830s</td>
<td>87x</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>ref32 -O5</td>
<td>4.22e10</td>
<td>1.20 GiB</td>
<td>0.24 bit</td>
<td>16s</td>
<td>1369s</td>
<td>86x</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>ref32 -O3</td>
<td>4.80e10</td>
<td>1.50 GiB</td>
<td>0.27 bit</td>
<td>24s</td>
<td>2209s</td>
<td>92x</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>Total</td>
<td>2.44e11</td>
<td>12.24 GiB</td>
<td>0.43 bit</td>
<td>98s</td>
<td>8963s</td>
<td>91x</td>
</tr>
<tr>
<td>505.mcf_r</td>
<td>N/A</td>
<td>2.21e11</td>
<td>31.0 GiB</td>
<td>1.20 bit</td>
<td>168s</td>
<td>4800s</td>
<td>29x</td>
</tr>
<tr>
<td>520.omnetpp_r</td>
<td>N/A</td>
<td>2.15e11</td>
<td>13.3 GiB</td>
<td>0.53 bit</td>
<td>135s</td>
<td>7289s</td>
<td>54x</td>
</tr>
<tr>
<td>523.xalancbmk_r</td>
<td>N/A</td>
<td>3.27e11</td>
<td>4.45 GiB</td>
<td>0.12 bit</td>
<td>112s</td>
<td>8883s</td>
<td>79x</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>pass 1</td>
<td>1.44e10</td>
<td>579 MiB</td>
<td>0.34 bit</td>
<td>14s</td>
<td>348s</td>
<td>25x</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>pass 2</td>
<td>4.42e10</td>
<td>2.30 GiB</td>
<td>0.45 bit</td>
<td>39s</td>
<td>1202s</td>
<td>31x</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>seek 500</td>
<td>4.78e10</td>
<td>2.77 GiB</td>
<td>0.50 bit</td>
<td>41s</td>
<td>1258s</td>
<td>31x</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>Total</td>
<td>1.06e11</td>
<td>5.64 GiB</td>
<td>0.46 bit</td>
<td>94s</td>
<td>2808s</td>
<td>30x</td>
</tr>
<tr>
<td>531.deepsjeng_r</td>
<td>N/A</td>
<td>2.74e11</td>
<td>31.6 GiB</td>
<td>0.99 bit</td>
<td>140s</td>
<td>8093s</td>
<td>58x</td>
</tr>
<tr>
<td>541.leela_r</td>
<td>N/A</td>
<td>3.38e11</td>
<td>75.6 GiB</td>
<td>1.92 bit</td>
<td>224s</td>
<td>8894s</td>
<td>40x</td>
</tr>
<tr>
<td>548.exchange2_r</td>
<td>N/A</td>
<td>3.01e11</td>
<td>26.3 GiB</td>
<td>0.75 bit</td>
<td>88s</td>
<td>6753s</td>
<td>77x</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>cld</td>
<td>5.08e10</td>
<td>9.16 GiB</td>
<td>1.55 bit</td>
<td>60s</td>
<td>1252s</td>
<td>21x</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>cpu2006docs</td>
<td>1.84e11</td>
<td>7.80 GiB</td>
<td>0.36 bit</td>
<td>65s</td>
<td>3923s</td>
<td>60x</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>input</td>
<td>7.96e10</td>
<td>10.5 GiB</td>
<td>1.14 bit</td>
<td>55s</td>
<td>1842s</td>
<td>33x</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>Total</td>
<td>3.14e11</td>
<td>27.5 GiB</td>
<td>0.75 bit</td>
<td>180s</td>
<td>7017s</td>
<td>39x</td>
</tr>
<tr>
<td>Total</td>
<td>N/A</td>
<td>2.86e12</td>
<td>241 GiB</td>
<td>0.72 bit</td>
<td>1362s</td>
<td>77834s</td>
<td>57x</td>
</tr>
</tbody>
</table>
<p>每分支的空间开销和在 i9-14900K 上测得的 MPKI（Mispredictions Per Kilo Instructions）有比较明显的正相关性：</p>
<table>
<thead>
<tr>
<th>benchmark</th>
<th>MPKI</th>
<th>每分支空间开销</th>
</tr>
</thead>
<tbody>
<tr>
<td>523.xalancbmk_r</td>
<td>0.84</td>
<td>0.12 bit</td>
</tr>
<tr>
<td>500.perlbench_r</td>
<td>0.95</td>
<td>0.22 bit</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>1.06</td>
<td>0.46 bit</td>
</tr>
<tr>
<td>548.exchange2_r</td>
<td>2.66</td>
<td>0.75 bit</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>3.16</td>
<td>0.43 bit</td>
</tr>
<tr>
<td>531.deepsjeng_r</td>
<td>4.35</td>
<td>0.99 bit</td>
</tr>
<tr>
<td>520.omnetpp_r</td>
<td>4.47</td>
<td>0.53 bit</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>5.35</td>
<td>0.75 bit</td>
</tr>
<tr>
<td>541.leela_r</td>
<td>12.61</td>
<td>1.92 bit</td>
</tr>
<tr>
<td>505.mcf_r</td>
<td>13.24</td>
<td>1.20 bit</td>
</tr>
</tbody>
</table>
<p>由于 LTO 对分支数量的影响较大，额外对比了 <code>-O3</code> 和 <code>-O3 -flto</code> 的区别：</p>
<table>
<thead>
<tr>
<th>benchmark</th>
<th>子 benchmark</th>
<th>O3 分支执行次数</th>
<th>O3 trace 大小</th>
<th>O3+LTO 分支执行次数</th>
<th>O3+LTO trace 大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>500.perlbench_r</td>
<td>checkspam</td>
<td>2.40e11</td>
<td>8.87 GiB</td>
<td>2.32e11</td>
<td>8.77 GiB</td>
</tr>
<tr>
<td>500.perlbench_r</td>
<td>diffmail</td>
<td>1.49e11</td>
<td>2.78 GiB</td>
<td>1.45e11</td>
<td>2.70 GiB</td>
</tr>
<tr>
<td>500.perlbench_r</td>
<td>splitmail</td>
<td>1.33e11</td>
<td>1.49 GiB</td>
<td>1.31e11</td>
<td>1.48 GiB</td>
</tr>
<tr>
<td>500.perlbench_r</td>
<td>Total</td>
<td>5.22e11</td>
<td>13.14 GiB</td>
<td>5.08e11</td>
<td>12.95 GiB</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>gcc-pp -O3</td>
<td>4.50e10</td>
<td>3.28 GiB</td>
<td>4.27e10</td>
<td>3.20 GiB</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>gcc-pp -O2</td>
<td>5.37e10</td>
<td>3.46 GiB</td>
<td>5.10e10</td>
<td>3.38 GiB</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>gcc-smaller</td>
<td>5.51e10</td>
<td>2.84 GiB</td>
<td>5.31e10</td>
<td>2.78 GiB</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>ref32 -O5</td>
<td>4.22e10</td>
<td>1.20 GiB</td>
<td>4.05e10</td>
<td>1.17 GiB</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>ref32 -O3</td>
<td>4.80e10</td>
<td>1.50 GiB</td>
<td>4.58e10</td>
<td>1.45 GiB</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>Total</td>
<td>2.44e11</td>
<td>12.24 GiB</td>
<td>2.33e11</td>
<td>11.98 GiB</td>
</tr>
<tr>
<td>505.mcf_r</td>
<td>N/A</td>
<td>2.21e11</td>
<td>31.0 GiB</td>
<td>1.62e11</td>
<td>26.6 GiB</td>
</tr>
<tr>
<td>520.omnetpp_r</td>
<td>N/A</td>
<td>2.15e11</td>
<td>13.3 GiB</td>
<td>1.97e11</td>
<td>13.2 GiB</td>
</tr>
<tr>
<td>523.xalancbmk_r</td>
<td>N/A</td>
<td>3.27e11</td>
<td>4.45 GiB</td>
<td>3.16e11</td>
<td>4.37 GiB</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>pass 1</td>
<td>1.44e10</td>
<td>579 MiB</td>
<td>1.43e10</td>
<td>575 MiB</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>pass 2</td>
<td>4.42e10</td>
<td>2.30 GiB</td>
<td>4.42e10</td>
<td>2.29 GiB</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>seek 500</td>
<td>4.78e10</td>
<td>2.77 GiB</td>
<td>4.77e10</td>
<td>2.76 GiB</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>Total</td>
<td>1.06e11</td>
<td>5.64 GiB</td>
<td>1.06e11</td>
<td>5.61 GiB</td>
</tr>
<tr>
<td>531.deepsjeng_r</td>
<td>N/A</td>
<td>2.74e11</td>
<td>31.6 GiB</td>
<td>2.13e11</td>
<td>29.1 GiB</td>
</tr>
<tr>
<td>541.leela_r</td>
<td>N/A</td>
<td>3.38e11</td>
<td>75.6 GiB</td>
<td>2.61e11</td>
<td>72.3 GiB</td>
</tr>
<tr>
<td>548.exchange2_r</td>
<td>N/A</td>
<td>3.01e11</td>
<td>26.3 GiB</td>
<td>3.02e11</td>
<td>26.2 GiB</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>cld</td>
<td>5.08e10</td>
<td>9.16 GiB</td>
<td>5.07e10</td>
<td>9.12 GiB</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>cpu2006docs</td>
<td>1.84e11</td>
<td>7.80 GiB</td>
<td>1.84e11</td>
<td>7.78 GiB</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>input</td>
<td>7.96e10</td>
<td>10.5 GiB</td>
<td>7.94e10</td>
<td>10.5 GiB</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>Total</td>
<td>3.14e11</td>
<td>27.5 GiB</td>
<td>3.14e11</td>
<td>27.4 GiB</td>
</tr>
<tr>
<td>Total</td>
<td>N/A</td>
<td>2.86e12</td>
<td>241 GiB</td>
<td>2.61e12</td>
<td>230 GiB</td>
</tr>
</tbody>
</table>
<p>LTO 去掉了 9% 的分支指令，对整体性能的影响还是蛮大的，MPKI 的数值也有明显的变化。</p>
<h3 id="时间开销">时间开销<a class="headerlink" href="#时间开销" title="Permanent link">&para;</a></h3>
<p>各个步骤需要耗费的时间（单线程）：</p>
<ol>
<li>抓取 trace：约 20 小时</li>
<li>运行 SimPoint: 约 4 小时</li>
<li>模拟分支预测：约 1 小时</li>
</ol>
<h3 id="simpoint_1">SimPoint<a class="headerlink" href="#simpoint_1" title="Permanent link">&para;</a></h3>
<p>考虑到（子）benchmark 之间没有依赖关系，可以同时进行多个 trace/simpoint/simulate 操作，不过考虑到内存占用和硬盘 I/O 压力，实际的并行性也没有那么高。</p>
<p>跑出来的 SimPoint 聚类可视化中效果比较好的，图中横轴是按执行顺序的 SimPoint slice，纵轴每一个 y 值对应一个 SimPoint phase，图中的点代表哪个 slice 被归到了哪个 phase 上：</p>
<p>500.perlbench_r diffmail:</p>
<p><img alt="" src="../../../../cbp-experiments-simpoint-perlbench-diffmail.png" /></p>
<p>520.omnetpp_r:</p>
<p><img alt="" src="../../../../cbp-experiments-simpoint-omnetpp.png" /></p>
<p>557.xz_r input:</p>
<p><img alt="" src="../../../../cbp-experiments-simpoint-xz-input.png" /></p>
<p>以 1e8 条指令的粒度切分 SimPoint，把 241 GB 的 trace 缩减到 415 MB 的规模。</p>
<h3 id="分支预测器模拟">分支预测器模拟<a class="headerlink" href="#分支预测器模拟" title="Permanent link">&para;</a></h3>
<p>使用 CBP 2016 的 Andre Seznec TAGE-SC-L 8KB/64KB 的分支预测器在 SimPoint 上模拟 SPEC INT 2017 Rate-1，只需要 9-10 分钟。</p>
<p>使用 CBP 2016 的 Andre Seznec TAGE-SC-L 8KB/64KB 的分支预测器在 SimPoint 上模拟的 CMPKI（只考虑了方向分支），和 Intel i9-14900K 的 MPKI（考虑了所有分支）在 SPEC INT 2017 Rate-1（AMD64，<code>-O3</code>）的比较：</p>
<table>
<thead>
<tr>
<th>benchmark</th>
<th>TAGE-SC-L 8KB</th>
<th>TAGE-SC-L 64KB</th>
<th>i9-14900K</th>
</tr>
</thead>
<tbody>
<tr>
<td>500.perlbench_r</td>
<td>1.00</td>
<td>0.72</td>
<td>0.95</td>
</tr>
<tr>
<td>502.gcc_r</td>
<td>4.69</td>
<td>3.36</td>
<td>3.16</td>
</tr>
<tr>
<td>505.mcf_r</td>
<td>13.02</td>
<td>12.23</td>
<td>13.24</td>
</tr>
<tr>
<td>520.omnetpp_r</td>
<td>4.09</td>
<td>3.49</td>
<td>4.47</td>
</tr>
<tr>
<td>523.xalancbmk_r</td>
<td>0.85</td>
<td>0.68</td>
<td>0.84</td>
</tr>
<tr>
<td>525.x264_r</td>
<td>0.76</td>
<td>0.59</td>
<td>1.06</td>
</tr>
<tr>
<td>531.deepsjeng_r</td>
<td>4.59</td>
<td>3.45</td>
<td>4.35</td>
</tr>
<tr>
<td>541.leela_r</td>
<td>11.79</td>
<td>9.42</td>
<td>12.61</td>
</tr>
<tr>
<td>548.exchange2_r</td>
<td>2.96</td>
<td>1.25</td>
<td>2.66</td>
</tr>
<tr>
<td>557.xz_r</td>
<td>4.68</td>
<td>4.06</td>
<td>5.35</td>
</tr>
<tr>
<td>average</td>
<td>4.84</td>
<td>3.925</td>
<td>4.87</td>
</tr>
</tbody>
</table>
<h3 id="不同编译器编译选项和指令集下-spec-int-2017-的指令数和分支指令数规模">不同编译器、编译选项和指令集下 SPEC INT 2017 的指令数和分支指令数规模<a class="headerlink" href="#不同编译器编译选项和指令集下-spec-int-2017-的指令数和分支指令数规模" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ISA</th>
<th>Flags</th>
<th>Compiler</th>
<th># Inst</th>
<th># Branch Inst</th>
<th>% Branch Inst</th>
</tr>
</thead>
<tbody>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>LLVM 17.0.6</td>
<td>2.07e+13</td>
<td>3.27e+12</td>
<td>15.8%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>LLVM 18.1.8</td>
<td>1.99e+13</td>
<td>3.17e+12</td>
<td>14.8%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>LLVM 19.1.4</td>
<td>1.99e+13</td>
<td>3.13e+12</td>
<td>15.7%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>LLVM 20.1.5</td>
<td>2.10e+13</td>
<td>3.11e+12</td>
<td>14.8%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3+WRAPV</td>
<td>LLVM 20.1.5</td>
<td>2.01e+13</td>
<td>3.10e+12</td>
<td>15.4%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>GCC 11.3</td>
<td>1.69e+13</td>
<td>2.88e+12</td>
<td>17.0%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>GCC 12.2</td>
<td>1.67e+13</td>
<td>2.88e+12</td>
<td>17.2%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>GCC 13.3</td>
<td>1.66e+13</td>
<td>2.88e+12</td>
<td>17.3%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>GCC 14.2</td>
<td>1.65e+13</td>
<td>2.87e+12</td>
<td>17.4%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3</td>
<td>GCC 15.1</td>
<td>1.58e+13</td>
<td>2.85e+12</td>
<td>18.0%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3+LTO</td>
<td>GCC 12.2</td>
<td>1.57e+13</td>
<td>2.63e+12</td>
<td>16.8%</td>
</tr>
<tr>
<td>AMD64</td>
<td>O3+LTO+JEMALLOC</td>
<td>GCC 12.2</td>
<td>1.57e+13</td>
<td>2.62e+12</td>
<td>16.7%</td>
</tr>
<tr>
<td>ARM64</td>
<td>O3</td>
<td>GCC 12.2</td>
<td>1.62e+13</td>
<td>2.83e+12</td>
<td>17.5%</td>
</tr>
<tr>
<td>ARM64</td>
<td>O3+LTO</td>
<td>GCC 12.2</td>
<td>1.53e+13</td>
<td>2.59e+12</td>
<td>16.9%</td>
</tr>
<tr>
<td>ARM64</td>
<td>O3+LTO+JEMALLOC</td>
<td>GCC 12.2</td>
<td>1.52e+13</td>
<td>2.57e+12</td>
<td>16.9%</td>
</tr>
<tr>
<td>LoongArch</td>
<td>O3</td>
<td>GCC 14.2</td>
<td>1.75e+13</td>
<td>2.86e+12</td>
<td>16.3%</td>
</tr>
<tr>
<td>LoongArch</td>
<td>O3+LTO</td>
<td>GCC 14.2</td>
<td>1.66e+13</td>
<td>2.61e+12</td>
<td>15.7%</td>
</tr>
<tr>
<td>LoongArch</td>
<td>O3+LTO+JEMALLOC</td>
<td>GCC 14.2</td>
<td>1.65e+13</td>
<td>2.61e+12</td>
<td>15.8%</td>
</tr>
</tbody>
</table>
<ul>
<li>O3: <code>-O3</code></li>
<li>LTO: <code>-flto</code></li>
<li>JEMALLOC: <code>-ljemalloc</code></li>
<li>WRAPV: <code>-fwrapv</code></li>
</ul>
<h2 id="基于-pin-开发-branch-trace-工具">基于 Pin 开发 branch trace 工具<a class="headerlink" href="#基于-pin-开发-branch-trace-工具" title="Permanent link">&para;</a></h2>
<p>下面给出如何用 Pin 实现一个 branch trace 工具的过程：</p>
<ol>
<li>
<p>参考 Pin 的样例代码，Instrument 每一条指令，如果它是分支指令，就记录它的指令地址、目的地址、指令长度、分支类型以及是否跳转的信息：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">VOID</span><span class="w"> </span><span class="nf">Instruction</span><span class="p">(</span><span class="n">INS</span><span class="w"> </span><span class="n">ins</span><span class="p">,</span><span class="w"> </span><span class="n">VOID</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">INS_IsControlFlow</span><span class="p">(</span><span class="n">ins</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">        </span><span class="n">UINT32</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INS_Size</span><span class="p">(</span><span class="n">ins</span><span class="p">);</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">        </span><span class="k">enum</span><span class="w"> </span><span class="nc">branch_type</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* omitted */</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">        </span><span class="n">INS_InsertCall</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span><span class="w"> </span><span class="n">IPOINT_BEFORE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">AFUNPTR</span><span class="p">)</span><span class="n">RecordBranch</span><span class="p">,</span><span class="w"> </span><span class="n">IARG_INST_PTR</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">                    </span><span class="n">IARG_BRANCH_TARGET_ADDR</span><span class="p">,</span><span class="w"> </span><span class="n">IARG_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">IARG_UINT32</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">                    </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">IARG_BRANCH_TAKEN</span><span class="p">,</span><span class="w"> </span><span class="n">IARG_END</span><span class="p">);</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PIN_Init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">))</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Usage</span><span class="p">();</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="n">INS_AddInstrumentFunction</span><span class="p">(</span><span class="n">Instruction</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="n">PIN_StartProgram</span><span class="p">();</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>记录分支的时候，分别维护分支的数组和分支执行事件的数组，然后对于每次执行的分支，记录分支的 id 以及是否跳转的信息，到分支执行事件的数组当中：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">VOID</span><span class="w"> </span><span class="nf">RecordBranch</span><span class="p">(</span><span class="n">VOID</span><span class="w"> </span><span class="o">*</span><span class="n">inst_addr</span><span class="p">,</span><span class="w"> </span><span class="n">VOID</span><span class="w"> </span><span class="o">*</span><span class="n">targ_addr</span><span class="p">,</span><span class="w"> </span><span class="n">UINT32</span><span class="w"> </span><span class="n">inst_length</span><span class="p">,</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">                </span><span class="n">UINT32</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BOOL</span><span class="w"> </span><span class="n">taken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">branch</span><span class="w"> </span><span class="n">br</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="n">br</span><span class="p">.</span><span class="n">inst_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">inst_addr</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="n">br</span><span class="p">.</span><span class="n">targ_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">targ_addr</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="n">br</span><span class="p">.</span><span class="n">inst_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_length</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="n">br</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">branch_type</span><span class="p">)</span><span class="n">type</span><span class="p">;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">entry</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">taken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taken</span><span class="p">;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="c1">// insert branch if not exists</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">br_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">br</span><span class="p">);</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">br_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">num_brs</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_BRS</span><span class="p">);</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">        </span><span class="n">br_map</span><span class="p">[</span><span class="n">br</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_brs</span><span class="p">;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="n">br_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_brs</span><span class="p">;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">        </span><span class="n">brs</span><span class="p">[</span><span class="n">num_brs</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">br</span><span class="p">;</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="n">br_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">        </span><span class="c1">// omitted</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">    </span><span class="n">write_buffer</span><span class="p">[</span><span class="n">buffer_size</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">    </span><span class="n">num_entries</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>为了减少磁盘空间，当缓冲区满的时候，首先经过 zstd 的流压缩，再把压缩后的内容写入到文件中：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// https://github.com/facebook/zstd/blob/dev/examples/streaming_compression.c</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">ZSTD_EndDirective</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZSTD_e_continue</span><span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">ZSTD_inBuffer</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">write_buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">write_buffer</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kt">int</span><span class="w"> </span><span class="n">finished</span><span class="p">;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="n">ZSTD_outBuffer</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">zstd_output_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">zstd_output_buffer_size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZSTD_compressStream2</span><span class="p">(</span><span class="n">zstd_cctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">ZSTD_isError</span><span class="p">(</span><span class="n">remaining</span><span class="p">));</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">fwrite</span><span class="p">(</span><span class="n">zstd_output_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="n">finished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">pos</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">finished</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>最后在程序结束时，把分支数组写入到文件并记录元数据：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">VOID</span><span class="w"> </span><span class="nf">Fini</span><span class="p">(</span><span class="n">INT32</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">VOID</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="c1">// 1. compress the remaining data in write buffer and write to file</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="c1">// 2. save metadata, including:</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="c1">//    1. number of branch executions</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="c1">//    2. number of branches</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="c1">//    3. branches array</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="p">}</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="n">PIN_AddFiniFunction</span><span class="p">(</span><span class="n">Fini</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="n">PIN_StartProgram</span><span class="p">();</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>针对动态链接，可以利用 Pin 已有的 API <code>IMG_AddInstrumentFunction</code> 来跟踪，方便后续找到 trace 中各个地址对应的指令</p>
</li>
</ol>
<p>这样就完成了 Branch Trace 的抓取。</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年5月11日 10:41:11">2025年5月11日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年4月10日 08:31:56">2025年4月10日</span>
  </span>

    
    
    
  </aside>


  


  


<h2 id="__comments">评论</h2>
<!-- Insert generated snippet here -->
<script src="https://giscus.app/client.js"
  data-repo="jiegec/blog-source"
  data-repo-id="MDEwOlJlcG9zaXRvcnk1MTgyMTUzMQ=="
  data-category="General"
  data-category-id="DIC_kwDOAxa7284CkIjI"
  data-mapping="pathname"
  data-strict="1"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>
      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../07/tls-internals/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Thread Local Storage (TLS) 实现探究">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                Thread Local Storage (TLS) 实现探究
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../../../hardware/2025/04/23/intel-redwood-cove/" class="md-footer__link md-footer__link--next" aria-label="下一页: Intel Redwood Cove 微架构评测">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                Intel Redwood Cove 微架构评测
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016-2025 Jiajie Chen
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>