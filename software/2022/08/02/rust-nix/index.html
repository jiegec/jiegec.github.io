<!DOCTYPE html>
<html>
<head>
    <title>用 Nix 编译 Rust 项目 // 杰哥的{运维,编程,调板子}小笔记</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    

        <meta property="og:title" content="用 Nix 编译 Rust 项目" />
    <meta property="og:description" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en" />
    <meta property="og:url" content="https://jia.je/software/2022/08/02/rust-nix/" />
    

    <link rel="shortcut icon" href="/favicon.ico">

    <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/style.css">
    
    <script src="/js/wavedrom/default.js" type="text/javascript"></script>
    <script src="/js/wavedrom/wavedrom.min.js" type="text/javascript" /></script>

    <meta name="generator" content="Hugo 0.108.0">
</head>


<body onload="WaveDrom.ProcessAll()">
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="/">杰哥的{运维,编程,调板子}小笔记</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="/about/">关于</a>
                
                <a class="main-nav-link" href="/category/">分类</a>
                
                <a class="main-nav-link" href="/open-source-contributions/">开源</a>
                
                <a class="main-nav-link" href="/tags/">标签</a>
                
                <a class="main-nav-link" href="/series/">系列</a>
                
                <a class="main-nav-link" href="/feed.xml">订阅</a>
                
                <a class="main-nav-link" href="/projects/readme/">项目</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">用 Nix 编译 Rust 项目</h1>
        </header>
        
        <div class="article-meta">
            <a href="/software/2022/08/02/rust-nix/" class="article-date">
                <time datetime='2022-08-02T14:28:00.000&#43;08:00' itemprop="datePublished">2022-08-02</time>
            </a>
            
            
            
            <div class="article-comment-link-wrap">
                <a href="/software/2022/08/02/rust-nix/#disqus_thread" class="article-comment-link">Comments</a>
            </div>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <h2 id="背景">背景</h2>
<p>Rust 项目一般是用 Cargo 管理，但是它的缺点是每个项目都要重新编译一次所有依赖，硬盘空间占用较大，不能跨项目共享编译缓存。调研了一下，有若干基于 Nix 的 Rust 构建工具：</p>
<ul>
<li>cargo2nix: <a href="https://github.com/cargo2nix/cargo2nix">https://github.com/cargo2nix/cargo2nix</a></li>
<li>carnix: 不再更新</li>
<li>crane: <a href="https://github.com/ipetkov/crane">https://github.com/ipetkov/crane</a></li>
<li>crate2nix: <a href="https://github.com/kolloch/crate2nix">https://github.com/kolloch/crate2nix</a></li>
<li>naersk: <a href="https://github.com/nix-community/naersk">https://github.com/nix-community/naersk</a></li>
<li>nocargo: <a href="https://github.com/oxalica/nocargo">https://github.com/oxalica/nocargo</a></li>
</ul>
<p>下面我分别来尝试一下这几个工具的使用。</p>
<p>下面出现的一些命令参考了对应项目的文档。</p>
<h2 id="cargo2nix">cargo2nix</h2>
<h3 id="卖点">卖点</h3>
<p>cargo2nix 的 README 提到了它的卖点：</p>
<ul>
<li>Development Shell - knowing all the dependencies means easy creation of complete shells. Run nix develop or direnv allow in this repo and see!</li>
<li>Caching - CI &amp; CD pipelines move faster when purity guarantees allow skipping more work!</li>
<li>Reproducibility - Pure builds. Access to all of nixpkgs for repeatable environment setup across multiple distributions and platforms</li>
</ul>
<h3 id="安装">安装</h3>
<p>cargo2nix 提供了 flakes 支持，不需要单独安装。</p>
<h3 id="使用">使用</h3>
<p>cargo2nix 的运行比较简单，利用 flakes 的特性，直接 <code>nix run</code> 即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nix run github:cargo2nix/cargo2nix
</span></span></code></pre></div><p>它会生成一个 Cargo.nix 文件，还需要编写一个 <code>flake.nix</code> 配合使用，这里以 <code>jiegec/webhookd</code> 为例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    cargo2nix<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:cargo2nix/cargo2nix/release-0.11.0&#34;</span>;
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cargo2nix/flake-utils&#34;</span>;
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cargo2nix/nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> inputs: <span style="color:#66d9ef">with</span> inputs;
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>eachDefaultSystem (system:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>        pkgs <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> nixpkgs {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">inherit</span> system;
</span></span><span style="display:flex;"><span>          overlays <span style="color:#f92672">=</span> [cargo2nix<span style="color:#f92672">.</span>overlays<span style="color:#f92672">.</span>default];
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        rustPkgs <span style="color:#f92672">=</span> pkgs<span style="color:#f92672">.</span>rustBuilder<span style="color:#f92672">.</span>makePackageSet {
</span></span><span style="display:flex;"><span>          rustVersion <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1.61.0&#34;</span>;
</span></span><span style="display:flex;"><span>          packageFun <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">./Cargo.nix</span>;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">rec</span> {
</span></span><span style="display:flex;"><span>        packages <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          webhookd <span style="color:#f92672">=</span> (rustPkgs<span style="color:#f92672">.</span>workspace<span style="color:#f92672">.</span>webhookd {})<span style="color:#f92672">.</span>bin;
</span></span><span style="display:flex;"><span>          default <span style="color:#f92672">=</span> packages<span style="color:#f92672">.</span>webhookd;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后编译：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span>$ nix build
</span></span><span style="display:flex;"><span>$ ./result-bin/bin/webhookd --version
</span></span><span style="display:flex;"><span>webhookd 0.2.1
</span></span></code></pre></div><h3 id="原理">原理</h3>
<p>cargo2nix 解析了 Cargo.lock，生成 Cargo.nix 文件，最后包装成 flake.nix。</p>
<h2 id="crane">crane</h2>
<h3 id="卖点-1">卖点</h3>
<p>crane 的 README 提到了它的卖点：</p>
<ul>
<li>Source fetching: automatically done using a Cargo.lock file</li>
<li>Incremental: build your workspace dependencies just once, then quickly lint, build, and test changes to your project without slowing down</li>
<li>Composable: split builds and tests into granular steps. Gate CI without burdening downstream consumers building from source.</li>
</ul>
<h3 id="安装-1">安装</h3>
<p>crane 不需要安装，直接用 flakes 即可。</p>
<h3 id="使用-1">使用</h3>
<p>crane 使用的时候，直接在项目中编写 <code>flake.nix</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span>;
</span></span><span style="display:flex;"><span>    crane<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:ipetkov/crane&#34;</span>;
</span></span><span style="display:flex;"><span>    crane<span style="color:#f92672">.</span>inputs<span style="color:#f92672">.</span>nixpkgs<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:numtide/flake-utils&#34;</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> { self<span style="color:#f92672">,</span> nixpkgs<span style="color:#f92672">,</span> crane<span style="color:#f92672">,</span> flake-utils<span style="color:#f92672">,</span> <span style="color:#f92672">...</span> }:
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>eachDefaultSystem (system: {
</span></span><span style="display:flex;"><span>      packages<span style="color:#f92672">.</span>default <span style="color:#f92672">=</span> crane<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span><span style="color:#e6db74">${</span>system<span style="color:#e6db74">}</span><span style="color:#f92672">.</span>buildPackage {
</span></span><span style="display:flex;"><span>        src <span style="color:#f92672">=</span> <span style="color:#e6db74">./.</span>;
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样就可以了，不需要使用工具从 Cargo.lock 生成对应的 Cargo.nix。</p>
<p>但是由于 webhookd 依赖 native 库，所以还需要需要手动加入 native 依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span>;
</span></span><span style="display:flex;"><span>    crane<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:ipetkov/crane&#34;</span>;
</span></span><span style="display:flex;"><span>    crane<span style="color:#f92672">.</span>inputs<span style="color:#f92672">.</span>nixpkgs<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:numtide/flake-utils&#34;</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> { self<span style="color:#f92672">,</span> nixpkgs<span style="color:#f92672">,</span> crane<span style="color:#f92672">,</span> flake-utils<span style="color:#f92672">,</span> <span style="color:#f92672">...</span> }:
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>eachDefaultSystem (system:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>        pkgs <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> nixpkgs {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">inherit</span> system;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        packages<span style="color:#f92672">.</span>default <span style="color:#f92672">=</span> crane<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span><span style="color:#e6db74">${</span>system<span style="color:#e6db74">}</span><span style="color:#f92672">.</span>buildPackage {
</span></span><span style="display:flex;"><span>          src <span style="color:#f92672">=</span> <span style="color:#e6db74">./.</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          buildInputs <span style="color:#f92672">=</span> <span style="color:#66d9ef">with</span> pkgs; [
</span></span><span style="display:flex;"><span>            libiconv
</span></span><span style="display:flex;"><span>            darwin<span style="color:#f92672">.</span>apple_sdk<span style="color:#f92672">.</span>frameworks<span style="color:#f92672">.</span>Security
</span></span><span style="display:flex;"><span>          ];
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nix build
</span></span><span style="display:flex;"><span>$ ./result/bin/webhookd --version
</span></span><span style="display:flex;"><span>webhookd 0.2.1
</span></span></code></pre></div><h3 id="原理-1">原理</h3>
<p>crane 会把所有的依赖下载起来用 cargo 进行一次构建，把生成的 target 目录打成 <code>target.tar.zst</code>，然后再加上项目的源代码再构建一次，这样来实现 incremental compilation。它还提供了一些 check lint 等实用的命令。但是，它的目的和其他项目不大一样，它并不考虑跨项目的依赖缓存。</p>
<h2 id="crate2nix">crate2nix</h2>
<h3 id="卖点-2">卖点</h3>
<p>crate2nix 在 README 中写的卖点：</p>
<ul>
<li>Same dependency tree as cargo: It uses cargo_metadata to obtain the dependency tree from cargo. Therefore, it will use the exact same library versions as cargo and respect any locked down version in Cargo.lock.</li>
<li>Smart caching: It uses smart crate by crate caching so that nix rebuilds exactly the crates that need to be rebuilt. Compare that to docker layers&hellip;</li>
<li>Nix ecosystem goodness: You can use all things that make the nix/NixOS ecosystem great, e.g. distributed/remote builds, build minimal docker images, deploy your binary as a service to the cloud with NixOps, &hellip;</li>
<li>Out of the box support for libraries with non-rust dependencies: It builds on top of the buildRustCrate function from NixOS so that native dependencies of many rust libraries are already correctly fetched when needed. If your library with native dependencies is not yet supported, you can customize defaultCrateOverrides / crateOverrides, see below.</li>
<li>Easy to understand nix template: The actual nix code is generated via templates/build.nix.tera so you can fix/improve the nix code without knowing rust if all the data is already there.</li>
</ul>
<h3 id="安装-2">安装</h3>
<p>首先要安装 crate2nix，由于它的稳定版本 0.10.0 已经是去年的版本了，我直接用了 master 分支。如果是直接安装，用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nix-env -i -f https://github.com/kolloch/crate2nix/tarball/master
</span></span></code></pre></div><p>但我是用 flakes + home-manager 管理的，所以我实际的配置方法是：</p>
<ol>
<li>向 flake.nix 添加 crate2nix 到 inputs，并且设置 <code>crate2nix.flake = false</code></li>
<li>把 crate2nix 从 inputs 传到实际的 home manager 配置，然后在 <code>home.packages</code> 里加入 <code>callPackage crate2nix {}</code></li>
</ol>
<h3 id="使用-2">使用</h3>
<p>接下来，找到一个 Rust 项目，在其中运行 <code>crate2nix generate</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ crate2nix generate
</span></span><span style="display:flex;"><span>Generated ./Cargo.nix successfully.
</span></span></code></pre></div><p>构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nix build -f Cargo.nix rootCrate.build
</span></span></code></pre></div><p>编译的结果可以在 <code>result/bin</code> 下看到。</p>
<p>我编译的是 <code>jiegec/webhookd</code>，编译过程中出现了报错：</p>
<pre tabindex="0"><code>&gt;   = note: ld: framework not found Security
&gt;           clang-11: error: linker command failed with exit code 1 (use -v to see invocation)
&gt;
&gt;
&gt; error: aborting due to previous error
</code></pre><p>前面的 cargo2nix 没有出现这样的问题，应该是因为 cargo2nix 帮我们引入了 Security 的依赖，见 <a href="https://github.com/cargo2nix/cargo2nix/blob/9c3b846c727300f8146f20f01c5387b398d1e0e4/overlay/overrides.nix">overrides.nix</a>。</p>
<p>根据 crate2nix 的文档，需要添加额外的 native 依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{ pkgs <span style="color:#f92672">?</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">&lt;nixpkgs&gt;</span> { } }:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>  generatedBuild <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">./Cargo.nix</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">inherit</span> pkgs;
</span></span><span style="display:flex;"><span>    defaultCrateOverrides <span style="color:#f92672">=</span> <span style="color:#66d9ef">with</span> pkgs; defaultCrateOverrides <span style="color:#f92672">//</span> {
</span></span><span style="display:flex;"><span>      webhookd <span style="color:#f92672">=</span> attrs: {
</span></span><span style="display:flex;"><span>        buildInputs <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          lib<span style="color:#f92672">.</span>optionals
</span></span><span style="display:flex;"><span>            stdenv<span style="color:#f92672">.</span>isDarwin
</span></span><span style="display:flex;"><span>            [ darwin<span style="color:#f92672">.</span>apple_sdk<span style="color:#f92672">.</span>frameworks<span style="color:#f92672">.</span>Security ];
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>generatedBuild<span style="color:#f92672">.</span>rootCrate<span style="color:#f92672">.</span>build
</span></span></code></pre></div><p>然后构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nix build -f default.nix
</span></span><span style="display:flex;"><span>$ ./result/bin/webhookd --version
</span></span><span style="display:flex;"><span>webhookd 0.2.1
</span></span></code></pre></div><p>这样就可以正常运行了。</p>
<h3 id="原理-2">原理</h3>
<p>它的原理是使用 <code>cargo_metadata</code> 库从 Cargo.lock 中获取各个 crate 的信息，然后翻译成 <code>Cargo.nix</code>，之后就是由 nix 来编译各个 crate 的内容。所以一开始还是需要先用 Cargo 创建项目，添加依赖，生成 <code>Cargo.lock</code>；之后再用 <code>crate2nix generate</code> 同步依赖信息到 <code>Cargo.nix</code> 文件，构建的时候就不需要 Cargo 参与了，直接 rustc。</p>
<h2 id="naersk">naersk</h2>
<h3 id="安装-3">安装</h3>
<p>需要安装 <a href="https://github.com/nmattia/niv">niv</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nix-env -iA nixpkgs.niv
</span></span></code></pre></div><h3 id="使用-3">使用</h3>
<p>在项目目录下，首先用 <code>niv</code> 导入 naersk：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>niv init
</span></span><span style="display:flex;"><span>niv add nix-community/naersk
</span></span></code></pre></div><p>然后编写一个 <code>default.nix</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>  pkgs <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">&lt;nixpkgs&gt;</span> { };
</span></span><span style="display:flex;"><span>  sources <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">./nix/sources.nix</span>;
</span></span><span style="display:flex;"><span>  naersk <span style="color:#f92672">=</span> pkgs<span style="color:#f92672">.</span>callPackage sources<span style="color:#f92672">.</span>naersk { };
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>naersk<span style="color:#f92672">.</span>buildPackage <span style="color:#e6db74">./.</span>
</span></span></code></pre></div><p>构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nix build -f default.nix
</span></span><span style="display:flex;"><span>$ ./result/bin/webhookd --version
</span></span><span style="display:flex;"><span>webhookd 0.2.1
</span></span></code></pre></div><h3 id="原理-3">原理</h3>
<p>naersk 的原理和 crane 是类似的：把所有依赖下载下来，创建一个只有依赖的项目，然后用 cargo 预编译，编译完得到的 target 目录打成 <code>target.tar.zst</code>；然后基于预编译的结果再编译整个项目。</p>
<h2 id="nocargo">nocargo</h2>
<h3 id="卖点-3">卖点</h3>
<p>nocargo 的 README 提到了以下卖点：</p>
<ul>
<li>No IFDs (import-from-derivation). See meme.</li>
<li>No cargo dependency during building. Only rustc.</li>
<li>No need for hash prefetching or code generation1.</li>
<li>Crate level caching, globally shared.</li>
<li>nixpkgs integration for non-Rust dependencies.</li>
</ul>
<p>README 也提到了 nocargo, cargo2nix, naersk 和 buildRustPackage 的对比。</p>
<h3 id="使用-4">使用</h3>
<p>nocargo 目前<a href="https://github.com/oxalica/nocargo/blob/90a6d0e8dcfc2205fa69423d42bff6fd1b997121/flake.nix#L13">仅支持 x86_64-linux 平台</a>。</p>
<p>在一个 Cargo 项目中，运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nix run github:oxalica/nocargo init
</span></span></code></pre></div><p>它会生成 <code>flake.nix</code> 文件如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># See more usages of nocargo at https://github.com/oxalica/nocargo#readme</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Rust package webhookd&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:NixOS/nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:numtide/flake-utils&#34;</span>;
</span></span><span style="display:flex;"><span>    nocargo <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:oxalica/nocargo&#34;</span>;
</span></span><span style="display:flex;"><span>      inputs<span style="color:#f92672">.</span>nixpkgs<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># inputs.registry-crates-io.follows = &#34;registry-crates-io&#34;;</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Optionally, you can override crates.io index to get cutting-edge packages.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># registry-crates-io = { url = &#34;github:rust-lang/crates.io-index&#34;; flake = false; };</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> { nixpkgs<span style="color:#f92672">,</span> flake-utils<span style="color:#f92672">,</span> nocargo<span style="color:#f92672">,</span> <span style="color:#f92672">...</span> }<span style="color:#f92672">@</span>inputs:
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>eachSystem [ <span style="color:#e6db74">&#34;x86_64-linux&#34;</span> ] (system:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>        ws <span style="color:#f92672">=</span> nocargo<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span><span style="color:#e6db74">${</span>system<span style="color:#e6db74">}</span><span style="color:#f92672">.</span>mkRustPackageOrWorkspace {
</span></span><span style="display:flex;"><span>          src <span style="color:#f92672">=</span> <span style="color:#e6db74">./.</span>;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">rec</span> {
</span></span><span style="display:flex;"><span>        packages <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          default <span style="color:#f92672">=</span> packages<span style="color:#f92672">.</span>webhookd;
</span></span><span style="display:flex;"><span>          webhookd <span style="color:#f92672">=</span> ws<span style="color:#f92672">.</span>release<span style="color:#f92672">.</span>webhookd<span style="color:#f92672">.</span>bin;
</span></span><span style="display:flex;"><span>          webhookd-dev <span style="color:#f92672">=</span> ws<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span>webhookd<span style="color:#f92672">.</span>bin;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span>$ nix build
</span></span></code></pre></div><p>出现了编译错误，说明 crates.io index 版本不是最新的：</p>
<pre tabindex="0"><code>error: Package bytes doesn&#39;t have version 1.2.0 in index. Available versions: 0.0.1 0.1.0 0.1.1 0.1.2 0.2.0 0.2.1 0.2.10 0.2.11 0.2.2 0.2.3 0.2.4 0.2.5 0.2.6 0.2.7 0.2.8 0.2.9 0.3.0 0.4.0 0.4.1 0.4.10 0.4.11 0.4.12 0.4.2 0.4.3 0.4.4 0.4.5 0.4.6 0.4.7 0.4.8 0.4.9 0.5.0 0.5.1 0.5.2 0.5.3 0.5.4 0.5.5 0.5.6 0.6.0 1.0.0 1.0.1 1.1.0
(use &#39;--show-trace&#39; to show detailed location information)
</code></pre><p>按照 <code>flake.nix</code> 中的提示，使用最新的 crates.io index：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># See more usages of nocargo at https://github.com/oxalica/nocargo#readme</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Rust package webhookd&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:NixOS/nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:numtide/flake-utils&#34;</span>;
</span></span><span style="display:flex;"><span>    nocargo <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:oxalica/nocargo&#34;</span>;
</span></span><span style="display:flex;"><span>      inputs<span style="color:#f92672">.</span>nixpkgs<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>      inputs<span style="color:#f92672">.</span>registry-crates-io<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;registry-crates-io&#34;</span>;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Optionally, you can override crates.io index to get cutting-edge packages.</span>
</span></span><span style="display:flex;"><span>    registry-crates-io <span style="color:#f92672">=</span> { url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:rust-lang/crates.io-index&#34;</span>; flake <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>; };
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> { nixpkgs<span style="color:#f92672">,</span> flake-utils<span style="color:#f92672">,</span> nocargo<span style="color:#f92672">,</span> <span style="color:#f92672">...</span> }<span style="color:#f92672">@</span>inputs:
</span></span><span style="display:flex;"><span>    flake-utils<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>eachSystem [ <span style="color:#e6db74">&#34;x86_64-linux&#34;</span> ] (system:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>        ws <span style="color:#f92672">=</span> nocargo<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span><span style="color:#e6db74">${</span>system<span style="color:#e6db74">}</span><span style="color:#f92672">.</span>mkRustPackageOrWorkspace {
</span></span><span style="display:flex;"><span>          src <span style="color:#f92672">=</span> <span style="color:#e6db74">./.</span>;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">rec</span> {
</span></span><span style="display:flex;"><span>        packages <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          default <span style="color:#f92672">=</span> packages<span style="color:#f92672">.</span>webhookd;
</span></span><span style="display:flex;"><span>          webhookd <span style="color:#f92672">=</span> ws<span style="color:#f92672">.</span>release<span style="color:#f92672">.</span>webhookd<span style="color:#f92672">.</span>bin;
</span></span><span style="display:flex;"><span>          webhookd-dev <span style="color:#f92672">=</span> ws<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span>webhookd<span style="color:#f92672">.</span>bin;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>继续构建就成功了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nix build
</span></span><span style="display:flex;"><span>• Updated input <span style="color:#e6db74">&#39;nocargo/registry-crates-io&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;github:rust-lang/crates.io-index/1ce12a7e3367a2a673f91f07ab7cc505a0b8f069&#39;</span> <span style="color:#f92672">(</span>2022-07-17<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  → follows <span style="color:#e6db74">&#39;registry-crates-io&#39;</span>
</span></span><span style="display:flex;"><span>• Added input <span style="color:#e6db74">&#39;registry-crates-io&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;github:rust-lang/crates.io-index/627caba32f416e706bf3f2ceac55230ec79710c5&#39;</span> <span style="color:#f92672">(</span>2022-08-02<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ ./result/bin/webhookd --version
</span></span><span style="display:flex;"><span>webhookd 0.2.1
</span></span></code></pre></div><h2 id="总结">总结</h2>
<p>可以看到，上面的不同工具采用了不同的方法，如果要比较的话：</p>
<ul>
<li>Nix drv 粒度：每个依赖（cargo2nix，crate2nix，nocargo）、所有依赖（crane，naersk）。前者的好处是会跨项目共享依赖，进一步可以传到 binary cache。</li>
<li>是否生成包括完整依赖信息的 nix 文件：是（cargo2nix，crate2nix）、否（crane，naersk，nocargo）。生成的话，仓库里的 Cargo.lock 和 Cargo.nix 的信息是重复的，如果修改了 Cargo.lock，需要重新同步 Cargo.nix。</li>
</ul>

        </div>

        
        
        <div class="article-toc" style="display:none;">
            <h3>Contents</h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#cargo2nix">cargo2nix</a>
      <ul>
        <li><a href="#卖点">卖点</a></li>
        <li><a href="#安装">安装</a></li>
        <li><a href="#使用">使用</a></li>
        <li><a href="#原理">原理</a></li>
      </ul>
    </li>
    <li><a href="#crane">crane</a>
      <ul>
        <li><a href="#卖点-1">卖点</a></li>
        <li><a href="#安装-1">安装</a></li>
        <li><a href="#使用-1">使用</a></li>
        <li><a href="#原理-1">原理</a></li>
      </ul>
    </li>
    <li><a href="#crate2nix">crate2nix</a>
      <ul>
        <li><a href="#卖点-2">卖点</a></li>
        <li><a href="#安装-2">安装</a></li>
        <li><a href="#使用-2">使用</a></li>
        <li><a href="#原理-2">原理</a></li>
      </ul>
    </li>
    <li><a href="#naersk">naersk</a>
      <ul>
        <li><a href="#安装-3">安装</a></li>
        <li><a href="#使用-3">使用</a></li>
        <li><a href="#原理-3">原理</a></li>
      </ul>
    </li>
    <li><a href="#nocargo">nocargo</a>
      <ul>
        <li><a href="#卖点-3">卖点</a></li>
        <li><a href="#使用-4">使用</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
        </div>
        
        

        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
        <script>
            (function() {
                var $toc = $('#TableOfContents');
                if ($toc.length > 0) {
                    var $window = $(window);

                    function onScroll(){
                        var currentScroll = $window.scrollTop();
                        var h = $('.article-entry h1, .article-entry h2, .article-entry h3, .article-entry h4, .article-entry h5, .article-entry h6');
                        var id = "";
                        h.each(function (i, e) {
                            e = $(e);
                            if (e.offset().top - 10 <= currentScroll) {
                                id = e.attr('id');
                            }
                        });
                        var active = $toc.find('a.active');
                        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

                        active.each(function (i, e) {
                            $(e).removeClass('active').siblings('ul').hide();
                        });
                        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                            $(e).children('a').addClass('active').siblings('ul').show();
                        });
                    }

                    $window.on('scroll', onScroll);
                    $(document).ready(function() {
                        $toc.find('a').parent('li').find('ul').hide();
                        onScroll();
                        document.getElementsByClassName('article-toc')[0].style.display = '';
                    });
                }
            })();
        </script>
        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="/tags/nix">nix
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="/tags/rust">rust
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    
<nav id="article-nav">
    
    <a href="/software/2022/08/05/from-tex-to-pdf/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            从 TeX 到 PDF 的过程
        </div>
    </a>
    
    
    <a href="/software/2022/07/26/invalid-date-timezone/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">invalid date 报错与时区的关系&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>

        
            <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jiegec" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2022 杰哥的{运维,编程,调板子}小笔记
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-3109FRSVTT', { 'anonymize_ip': false });
}
</script>


    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/katex.min.css" integrity="sha384-ZPe7yZ91iWxYumsBEOn7ieg8q/o+qh/hQpSaPow8T6BwALcXSCS6C6fSRPIAnTQs" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/katex.min.js" integrity="sha384-ljao5I1l+8KYFXG7LNEA7DyaFvuvSCmedUf6Y6JI7LJqiu8q5dEivP2nDdFH31V4" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
        <script>renderMathInElement(document.body);</script>
    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
