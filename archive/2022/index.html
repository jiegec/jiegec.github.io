
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维,编程,调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/archive/2022/">
      
      
        <link rel="prev" href="../2023/">
      
      
        <link rel="next" href="../2021/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0">
    
    
      
        <title>2022 - 杰哥的{运维,编程,调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0c456da8.min.css">
      
      

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-3109FRSVTT",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2022" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2022
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../2023/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../category/crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2022
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#acpi" class="md-nav__link">
    ACPI 学习笔记
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#infiniband" class="md-nav__link">
    InfiniBand 学习笔记
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mellanox" class="md-nav__link">
    升级 Mellanox 网卡固件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cxl" class="md-nav__link">
    CXL 学习笔记
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pcie" class="md-nav__link">
    PCIe 学习笔记
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ppc64le-linux-nix" class="md-nav__link">
    在 ppc64le Linux 上运行 Nix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gnuradio-companion-fm" class="md-nav__link">
    在 GNURadio Companion 中收听 FM 广播
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esxi-lacp" class="md-nav__link">
    ESXi 配置 LACP 链路聚合
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buildroot-202008-fakeroot" class="md-nav__link">
    Buildroot 2020.08 的 Fakeroot 版本过旧导致的兼容性问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tex-pdf" class="md-nav__link">
    从 TeX 到 PDF 的过程
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nix-rust" class="md-nav__link">
    用 Nix 编译 Rust 项目
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invalid-date" class="md-nav__link">
    invalid date 报错与时区的关系
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ceph-cookbook" class="md-nav__link">
    Ceph Cookbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    编程作业中的学术诚信
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#archive-common" class="md-nav__link">
    Archive 中 COMMON 符号的链接问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nvidia-cuda" class="md-nav__link">
    NVIDIA 驱动和 CUDA 安装速查
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connectx-4" class="md-nav__link">
    切换 ConnectX-4 为以太网模式
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rsyslog" class="md-nav__link">
    rsyslog 收集远程日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wishbone" class="md-nav__link">
    「教学」Wishbone 总线协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nix-cookbook" class="md-nav__link">
    Nix Cookbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libvirt-risc-v" class="md-nav__link">
    在 libvirt 中运行 RISC-V 虚拟机
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sram" class="md-nav__link">
    「教学」异步 SRAM 时序
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ace" class="md-nav__link">
    「教学」ACE 缓存一致性协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rocket-chip" class="md-nav__link">
    向 Rocket Chip 添加自定义调试信号
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    「教学」内存认证算法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tilelink" class="md-nav__link">
    TileLink 总线协议分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nuc11-esxi-igpu" class="md-nav__link">
    NUC11 ESXi 中 iGPU 直通虚拟机
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loongarch64" class="md-nav__link">
    LoongArch64 工具链构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ch32v307" class="md-nav__link">
    试用沁恒 CH32V307 评估板
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vivado-bitstream-svf" class="md-nav__link">
    导出 Vivado 下载 Bitstream 的 SVF 文件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu" class="md-nav__link">
    浅谈乱序执行 CPU（二）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sv2vyosys-fpnew-verilog" class="md-nav__link">
    用 sv2v+yosys 把 fpnew 转为 verilog 网表
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synopsys-design-compiler" class="md-nav__link">
    Synopsys Design Compiler 综合实践
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openroad-flow" class="md-nav__link">
    OpenROAD Flow 初尝试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jtag-vcu128-rocket-chip" class="md-nav__link">
    通过 JTAG 对 VCU128 上的 Rocket Chip 进行调试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k3s-traefik-x-forwarded-for" class="md-nav__link">
    解决 k3s 中 traefik 不会转发 X-Forwarded-For 等头部的问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m1-windows-arm" class="md-nav__link">
    在 M1 上运行 Windows ARM 虚拟机
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-vector-10" class="md-nav__link">
    RISC-V Vector 1.0 工具链构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jiegech" class="md-nav__link">
    jiege.ch 停用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rocket-chip-diplomacy" class="md-nav__link">
    分析 Rocket Chip 中 Diplomacy 系统
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chisel3-cookbook" class="md-nav__link">
    Chisel3 Cookbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linksys-e8450-openwrt-ubi" class="md-nav__link">
    升级 Linksys E8450 的 OpenWRT 系统到 UBI
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2022">2022<a class="headerlink" href="#2022" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-12-10 00:00:00">2022年12月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 34 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="acpi"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/">ACPI 学习笔记</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_1">标准</a></h3>
<p>ACPI 标准可以从<a href="https://uefi.org/specifications">官网</a>下载。</p>
<p>ACPI 的表现形式为一颗树加若干个表，表的结构比较规整，里面每个字段都有固定的含义。树的结点可能是属性，或者是一些函数。操作系统可以操作上面的属性，调用 ACPI 中的函数，来进行一些硬件相关的操作。ACPI 一般与主板密切相关，主板厂家配置好 ACPI 后，操作系统就不需要给每个主板都写一遍代码了。</p>
<h3 id="asl"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#asl">ASL</a></h3>
<p>为了开发 ACPI，需要使用 ACPI Source Language(ASL) 来进行编程，使用 iasl 编译成 ACPI 表以后，由操作系统进行解释执行。推荐阅读一个比较好的 ASL 教程：<a href="https://acpica.org/sites/acpica/files/asl_tutorial_v20190625.pdf">ACPI Source Language (ASL) Tutorial</a>。</p>
<p>简单来说，ASL 中的变量类型：</p>
<ul>
<li>Integer: <code>int32_t/int64_t</code></li>
<li>String: <code>char *</code></li>
<li>Buffer: <code>uint8_t []</code></li>
<li>Package: <code>object []</code></li>
<li>Object Reference: <code>object &amp;</code></li>
<li>Method</li>
</ul>
<p>ACPI 需要访问硬件，一般是通过 MMIO 或者 IO Port 来进行访问。在内核开发的时候，MMIO 一般是用一系列 volatile 指针来对应硬件的寄存器定义。ASL 中也可以做类似的事情，分为两步：<code>OperationRegion</code> 和 <code>Field</code>。</p>
<p><code>OperationRegion</code> 就是声明了一片地址空间，以及对应的类型，常见的类型有 SystemMemory、SystemIO、PCI_Config、SMBus 等等。当 ACPI 中的代码要访问 <code>OperationRegion</code> 中的数据的时候，内核按照类型去进行实际的访问。</p>
<p>有了地址空间以后，还需要根据寄存器的定义，给各个字段起个名字，这就是 <code>Field</code>。<code>Field</code> 给 <code>OperationRegion</code> 中的字段起名，与硬件的定义想对应，这就像在内核中定义一个结构体，保证结构体的成员的偏移和硬件是一致的。这样就可以通过成员来访问，而不是每次都去计算一次偏移。</p>
<h3 id="acpi_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#acpi_1">获取当前系统的 ACPI 表</a></h3>
<p>使用以下命令获取 ACPI 表并转换为可以阅读的格式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-0-1"></a>sudo<span class="w"> </span>acpidump<span class="w"> </span>-o<span class="w"> </span>acpi.raw
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-0-2"></a>acpixtract<span class="w"> </span>-a<span class="w"> </span>acpi.raw
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-0-3"></a>iasl<span class="w"> </span>-d<span class="w"> </span>*.dat
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_2">串口</a></h3>
<h4 id="x86_64"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#x86_64">x86_64</a></h4>
<p>下面来看一个具体的例子，主板 <code>WS X299 PRO/SE</code> 的 ACPI 表中记录的串口信息：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-1"></a><span class="c1">// UART 1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-2"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">UAR1</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-3"></a><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0501&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* 16550A-compatible COM Serial Port */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-5"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_UID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w">  </span><span class="c1">// _UID: Unique ID</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-6"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">LDN</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-7"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_STA</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _STA: Status</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-8"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-9"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DSTA</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">))</span><span class="w"> </span><span class="c1">// Device Status</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-12"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_DIS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _DIS: Disable Device</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-14"></a><span class="w">        </span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DCNT</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Control</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-17"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-18"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-19"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DCRS</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">))</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-21"></a>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-22"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_SRS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _SRS: Set Resource Settings</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-23"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-24"></a><span class="w">        </span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DSRS</span><span class="w"> </span><span class="p">(</span><span class="n">Arg0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-27"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_PRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _PRS: Possible Resource Settings</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-28"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-29"></a><span class="w">        </span><span class="n">StartDependentFn</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-30"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-31"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-32"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-33"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-34"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-35"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-36"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-37"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-38"></a><span class="w">                </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-39"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-40"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-41"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-42"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-43"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-44"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-45"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-46"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-47"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-48"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-49"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-50"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-51"></a><span class="w">                </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-52"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-53"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-55"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-56"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-57"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-58"></a><span class="w">                </span><span class="mh">0x02F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-59"></a><span class="w">                </span><span class="mh">0x02F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-60"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-61"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-62"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-63"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-64"></a><span class="w">                </span><span class="p">{</span><span class="mi">3</span><span class="p">}</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-65"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-66"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-67"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-68"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-69"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-70"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-71"></a><span class="w">                </span><span class="mh">0x03E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-72"></a><span class="w">                </span><span class="mh">0x03E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-73"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-74"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-75"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-76"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-77"></a><span class="w">                </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-78"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-79"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-80"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-81"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-82"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-83"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-84"></a><span class="w">                </span><span class="mh">0x02E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-85"></a><span class="w">                </span><span class="mh">0x02E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-86"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-87"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-88"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-89"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-90"></a><span class="w">                </span><span class="p">{</span><span class="mi">3</span><span class="p">}</span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-91"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-92"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-93"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-94"></a><span class="w">        </span><span class="n">EndDependentFn</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-95"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-96"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个设备在 Linux 中的路径是 <code>/sys/devices/LNXSYSTM:00/LNXSYBUS:00/PNP0A08:00/device:86/PNP0501:00</code>，进一步可以发现，它的 <code>path</code> 是 <code>\_SB_.PC00.LPC0.UAR1</code>，与 DSDT 中的路径一致。进一步探索，可以发现它匹配到了 Linux 的 <code>serial</code> 驱动，并且最终对应到了 <code>/dev/ttyS0</code> 设备。还可以看到 Linux 生成的 <code>resources</code> 描述：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-1"></a>state = active
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-2"></a>io 0x3f8-0x3ff
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-3"></a>irq 4
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-4"></a>dma disabled
</span></code></pre></div>
<p>这和上面看到的是一致的：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-1"></a><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-2"></a><span class="w">    </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-3"></a><span class="w">    </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-4"></a><span class="w">    </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-5"></a><span class="w">    </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-6"></a><span class="w">    </span><span class="p">)</span>
</span></code></pre></div>
<p>这里表达的正是 <code>0x3F8-0x3FF</code> 这一段 IO Port。这个地址和 <a href="https://wiki.osdev.org/Serial_Ports#Port_Addresses">OSDev</a> 上看到的也是吻合的。</p>
<p>进一步分析代码，<code>_STA</code> 函数返回设备当前的状态。可以在 Linux 的 ACPI 结点路径下看 <code>status</code> 文件，其内容是 <code>15</code>，表示工作正常。实现中，它调用了 <code>^^SIO1.DSTA(0x00)</code>，这里的 <code>^</code> 表示上一级命名空间。进一步找到 <code>DSTA</code> 的实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-1"></a><span class="c1">// Device Status</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-2"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">DSTA</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-3"></a><span class="p">{</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-4"></a><span class="w">    </span><span class="c1">// Enter Configuration Mode</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-5"></a><span class="w">    </span><span class="n">ENFG</span><span class="w"> </span><span class="p">(</span><span class="n">CGLD</span><span class="w"> </span><span class="p">(</span><span class="n">Arg0</span><span class="p">))</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-6"></a><span class="w">    </span><span class="n">Local0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ACTR</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.LPC0.SIO1.ACTR */</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-7"></a><span class="w">    </span><span class="c1">// Exit Configuration Mode</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-8"></a><span class="w">    </span><span class="n">EXFG</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-9"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Local0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">))</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-10"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-11"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-14"></a><span class="w">    </span><span class="n">Local0</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x01</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-15"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">))</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-16"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-17"></a><span class="w">        </span><span class="c1">// IO State</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-18"></a><span class="w">        </span><span class="n">IOST</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">Local0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Arg0</span><span class="p">)</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-20"></a>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-21"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">Local0</span><span class="p">)</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-22"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-23"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-25"></a><span class="w">    </span><span class="n">ElseIf</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">))</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-26"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-27"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">(((</span><span class="mh">0x01</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Arg0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IOST</span><span class="p">))</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-28"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-29"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0D</span><span class="p">)</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-31"></a><span class="w">        </span><span class="n">Else</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-32"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-33"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-36"></a><span class="w">    </span><span class="n">Else</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-37"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-38"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-40"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，核心是要判断 <code>ACTR</code> 的取值，继续寻找，可以发现 <code>ACTR</code> 是一个 SuperIO 的寄存器：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-1"></a><span class="c1">// Super IO</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-2"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">SP1O</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2E</span><span class="p">)</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-4"></a><span class="n">OperationRegion</span><span class="w"> </span><span class="p">(</span><span class="n">IOID</span><span class="p">,</span><span class="w"> </span><span class="n">SystemIO</span><span class="p">,</span><span class="w"> </span><span class="n">SP1O</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-5"></a><span class="n">Field</span><span class="w"> </span><span class="p">(</span><span class="n">IOID</span><span class="p">,</span><span class="w"> </span><span class="n">ByteAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">Preserve</span><span class="p">)</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-6"></a><span class="p">{</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-7"></a><span class="w">    </span><span class="n">INDX</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-8"></a><span class="w">    </span><span class="n">DATA</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-9"></a><span class="p">}</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-11"></a><span class="n">IndexField</span><span class="w"> </span><span class="p">(</span><span class="n">INDX</span><span class="p">,</span><span class="w"> </span><span class="n">DATA</span><span class="p">,</span><span class="w"> </span><span class="n">ByteAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">Preserve</span><span class="p">)</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-12"></a><span class="p">{</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-13"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-14"></a><span class="w">    </span><span class="n">Offset</span><span class="w"> </span><span class="p">(</span><span class="mh">0x30</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-15"></a><span class="w">    </span><span class="n">ACTR</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span><span class="p">,</span><span class="w">  </span><span class="c1">// Activate Register</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-16"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>ACTR</code> 寄存器需要通过 0x2E/0x2F 这两个 IO Port 来访问，所以这里使用了 <code>IndexField</code>，例如要读取 <code>ACTR</code> 的当前值的话，首先要往 <code>0x2E</code> 处写入 <code>ACTR</code> 的偏移，再从 <code>0x2F</code> 处读出当前值。这些寄存器应该就属于 SuperIO 了。</p>
<p>其他的几个函数含义是，<code>_CRS</code> 返回当前的资源配置，<code>_SRS</code> 可以修改资源配置，<code>_PRS</code> 列出可能的资源配置，<code>_DIS</code> 禁用设备。</p>
<p>从 Linux 内核日志，可以发现这款主板用的是 NCT6796D 兼容的 SuperIO 芯片：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-6-1"></a>nct6775: Found NCT6796D or compatible chip at 0x2e:0x290
</span></code></pre></div>
<p>查询 <a href="https://www.nuvoton.com/resource-files/NCT6796D_Datasheet_V0_6.pdf">NCT6796D Datasheet</a>，可以发现：</p>
<ul>
<li>芯片通过 LPC 总线与 CPU 连接，支持多种外设接口，包括 UART，PS/2，红外，GPIO，SMBus 等等</li>
<li>偏移 0x30 的寄存器 <code>ACTR</code> 的最低位表示了 logical device 的当前状态。</li>
<li>读取 <code>ACTR</code> 之前需要设置 LDN(Logical Device Number) 为 2，2 对应 Serial Port 1(UARTA)。这一步是在 <code>ENFG(CGLD(Arg0))</code> 中完成的。</li>
<li><code>CGLD</code> 函数查询了 <code>DCAT</code>，可以发现，串口在 <code>DCAT</code> 的下标是 0，查表得到的是 2，也就是 Logial Device Number 为 2，和上面的发现是吻合的。<code>DCAT</code> 的下一项是 <code>0x3</code>，也就是 Logical Device Number 为 3，在 Datasheet 中可以看到是 Serial Port 2(UARTB)。</li>
<li>DSDT 中还可以找到 <code>PS2K</code> 的结点，就是 PS/2 键鼠，属性中标记了 <code>LDN=5</code>，和 Datasheet 也是一致的。</li>
</ul>
<h4 id="arm64"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#arm64">ARM64</a></h4>
<p>前面看过了 x86_64 平台的串口，是需要通过 IO Port 进行访问的。在 ARM 平台上，则一般是通过 MMIO 访问。搜索内核日志，可以发现内核从 SPCR(Serial Port Console Redirection table) 表获取得到串口的信息：</p>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-7-1"></a><span class="err">ACPI: SPCR: console: uart,mmio,0x3f00002f8,115200</span>
</span></code></pre></div>
<p>SPCR 表的内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-1"></a>[024h 0036   1]               Interface Type : 00
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-2"></a>[025h 0037   3]                     Reserved : 000000
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-4"></a>[028h 0040  12]         Serial Port Register : [Generic Address Structure]
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-5"></a>[028h 0040   1]                     Space ID : 00 [SystemMemory]
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-6"></a>[029h 0041   1]                    Bit Width : 08
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-7"></a>[02Ah 0042   1]                   Bit Offset : 00
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-8"></a>[02Bh 0043   1]         Encoded Access Width : 01 [Byte Access:8]
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-9"></a>[02Ch 0044   8]                      Address : 00000003F00002F8
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-11"></a>[034h 0052   1]               Interrupt Type : 08
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-12"></a>[035h 0053   1]          PCAT-compatible IRQ : 00
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-13"></a>[036h 0054   4]                    Interrupt : 000001E4
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-14"></a>[03Ah 0058   1]                    Baud Rate : 07
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-15"></a>[03Bh 0059   1]                       Parity : 00
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-16"></a>[03Ch 0060   1]                    Stop Bits : 01
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-17"></a>[03Dh 0061   1]                 Flow Control : 00
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-18"></a>[03Eh 0062   1]                Terminal Type : 03
</span></code></pre></div>
<p>SPCR 表的定义可以在 <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/serports/serial-port-console-redirection-table">Serial Port Console Redirection Table (SPCR)</a> 处看到：</p>
<ul>
<li>Interface Type(00): Full 16550 interface</li>
<li>Interrupt Type(08): ARMH GIC interrupt (Global System Interrupt)</li>
<li>Baud Rate(07): 115200</li>
<li>Terminal Type(03): ANSI</li>
</ul>
<p>和内核得到的信息是一致的。内核中解析 SPCR 表的函数是 <code>acpi_sparse_spcr</code>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">acpi_parse_spcr</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">enable_earlycon</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable_console</span><span class="p">)</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-2"></a><span class="p">{</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-3"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">serial_port</span><span class="p">.</span><span class="n">space_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACPI_ADR_SPACE_SYSTEM_MEMORY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-5"></a><span class="w">        </span><span class="c1">// omitted</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-6"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ACPI_ACCESS_BIT_WIDTH</span><span class="p">((</span><span class="n">bit_width</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-7"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-8"></a><span class="w">            </span><span class="n">iotype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mmio&quot;</span><span class="p">;</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-9"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-13"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">interface_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-14"></a><span class="w">        </span><span class="c1">// omitted</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-15"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACPI_DBG2_16550_COMPATIBLE</span><span class="p">:</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-16"></a><span class="w">        </span><span class="n">uart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;uart&quot;</span><span class="p">;</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-17"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-19"></a>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-20"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-21"></a><span class="w">        </span><span class="c1">// omitted</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-22"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-23"></a><span class="w">        </span><span class="n">baud_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">115200</span><span class="p">;</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-24"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-26"></a>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">baud_rate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-28"></a><span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%s,%s,0x%llx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">iotype</span><span class="p">,</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-29"></a><span class="w">             </span><span class="n">table</span><span class="o">-&gt;</span><span class="n">serial_port</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-30"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-31"></a><span class="w">        </span><span class="c1">// uart,mmio,0x3f00002f8,115200</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-32"></a><span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%s,%s,0x%llx,%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">iotype</span><span class="p">,</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-33"></a><span class="w">             </span><span class="n">table</span><span class="o">-&gt;</span><span class="n">serial_port</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">baud_rate</span><span class="p">);</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-35"></a>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-36"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-37"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="ipmi"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#ipmi">IPMI</a></h3>
<h4 id="x86_65"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#x86_65">x86_64</a></h4>
<p>接下来，再来看 ACPI 中是如何声明 IPMI 的。主板依然是 <code>WS X299 PRO/SE</code>，主板自带了 BMC，可以在 DSDT 中搜到相关的部分：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-1"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">IDTP</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0CA2</span><span class="p">)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-2"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">ICDP</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0CA3</span><span class="p">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-3"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">SRVV</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0200</span><span class="p">)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-5"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">SPMI</span><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-6"></a><span class="p">{</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-7"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;IPI0001&quot;</span><span class="p">))</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-8"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_STR</span><span class="p">,</span><span class="w"> </span><span class="n">Unicode</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;IPMI_KCS&quot;</span><span class="p">))</span><span class="w">  </span><span class="c1">// _STR: Description String</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-9"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_UID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w">  </span><span class="c1">// _UID: Unique ID</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-10"></a><span class="w">    </span><span class="c1">// IPMI Status</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-11"></a><span class="w">    </span><span class="n">OperationRegion</span><span class="w"> </span><span class="p">(</span><span class="n">IPST</span><span class="p">,</span><span class="w"> </span><span class="n">SystemIO</span><span class="p">,</span><span class="w"> </span><span class="n">ICDP</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-12"></a><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="p">(</span><span class="n">IPST</span><span class="p">,</span><span class="w"> </span><span class="n">ByteAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">Preserve</span><span class="p">)</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-14"></a><span class="w">        </span><span class="n">STAS</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-16"></a>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-17"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_STA</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _STA: Status</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-18"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-19"></a><span class="w">        </span><span class="n">Local0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STAS</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.LPC0.SPMI.STAS */</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-20"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Local0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">))</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-21"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-22"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-24"></a><span class="w">        </span><span class="n">Else</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-25"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-26"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-29"></a>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-30"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-31"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-32"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-33"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-34"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-35"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-36"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-37"></a><span class="w">            </span><span class="n">_Y1E</span><span class="p">)</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-38"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-39"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-40"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-41"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-42"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-43"></a><span class="w">            </span><span class="n">_Y1F</span><span class="p">)</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-44"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-45"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-46"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-47"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">IDTP</span><span class="p">)</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-48"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-49"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1E</span><span class="p">.</span><span class="n">_MIN</span><span class="p">,</span><span class="w"> </span><span class="n">IPDB</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MIN: Minimum Base Address</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-50"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1E</span><span class="p">.</span><span class="n">_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">IPDH</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MAX: Maximum Base Address</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-51"></a><span class="w">            </span><span class="n">CreateByteField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1E</span><span class="p">.</span><span class="n">_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">IPDL</span><span class="p">)</span><span class="w">  </span><span class="c1">// _LEN: Length</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-52"></a><span class="w">            </span><span class="n">IPDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDTP</span><span class="w"> </span><span class="cm">/* \IDTP */</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-53"></a><span class="w">            </span><span class="n">IPDH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDTP</span><span class="w"> </span><span class="cm">/* \IDTP */</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-54"></a><span class="w">            </span><span class="n">IPDL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-55"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-56"></a>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-57"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">ICDP</span><span class="p">)</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-58"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-59"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1F</span><span class="p">.</span><span class="n">_MIN</span><span class="p">,</span><span class="w"> </span><span class="n">IPCB</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MIN: Minimum Base Address</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-60"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1F</span><span class="p">.</span><span class="n">_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">IPCH</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MAX: Maximum Base Address</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-61"></a><span class="w">            </span><span class="n">CreateByteField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1F</span><span class="p">.</span><span class="n">_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">IPCL</span><span class="p">)</span><span class="w">  </span><span class="c1">// _LEN: Length</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-62"></a><span class="w">            </span><span class="n">IPCB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICDP</span><span class="w"> </span><span class="cm">/* \ICDP */</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-63"></a><span class="w">            </span><span class="n">IPCH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICDP</span><span class="w"> </span><span class="cm">/* \ICDP */</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-64"></a><span class="w">            </span><span class="n">IPCL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-65"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-66"></a>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-67"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">)</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.LPC0.SPMI.ICRS */</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-68"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-69"></a>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-70"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_IFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _IFT: IPMI Interface Type</span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-71"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-72"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-73"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-74"></a>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-75"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_SRV</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _SRV: IPMI Spec Revision</span>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-76"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-77"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">SRVV</span><span class="p">)</span><span class="w"> </span><span class="cm">/* \SRVV */</span>
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-79"></a><span class="p">}</span>
</span></code></pre></div>
<p>在 Linux 中可以找到相应的结点：<code>/sys/devices/LNXSYSTM:00/LNXSYBUS:00/PNP0A08:00/device:86/IPI0001:00</code>。可以发现匹配到了 <code>ipmi_si</code> 驱动，并且可以正常工作。</p>
<p>函数 <code>_STA</code> 返回设备的当前状态，它读取了 IO Port 0x0CA3 的内容，进而判断 IPMI 是否正常。</p>
<p>函数 <code>_CRS</code> 返回当前的资源配置，它动态地计算出一个资源配置，对应 IO Port 是 0x0CA2 和 0x0CA3。</p>
<p>函数 <code>_IFT</code> 返回 IPMI Interface Type，0x01 表示 KCS(Keyboard Controller Style)，<code>_SRV</code> 返回 IPMI Spec Revision，在这里是 0x0200，也就是 IPMI 2.0。</p>
<p>这些内容可以在 Linux 下 ACPI 结点的 <code>physical_node/params</code> 文件中看到：<code>kcs,i/o,0xca2,rsp=1,rsi=1,rsh=0,irq=0,ipmb=32</code>。</p>
<p>查阅 Linux 源码，可以找到 <code>acpi_ipmi_probe</code> 函数，这个函数负责从 ACPI 中寻找 IPMI 配置：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">acpi_ipmi_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-2"></a><span class="p">{</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-3"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-4"></a><span class="w">    </span><span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;probing via ACPI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-6"></a><span class="w">    </span><span class="cm">/* _IFT tells us the interface type: KCS, BT, etc */</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-7"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_IFT&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-9"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-10"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-11"></a><span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">si_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_KCS</span><span class="p">;</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-12"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-13"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-14"></a><span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">si_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_SMIC</span><span class="p">;</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-15"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-16"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-17"></a><span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">si_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_BT</span><span class="p">;</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-18"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-19"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="cm">/* SSIF, just ignore */</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-21"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-22"></a><span class="w">        </span><span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unknown IPMI type %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-25"></a>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-26"></a><span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipmi_get_info_from_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-29"></a>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-30"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-31"></a><span class="p">}</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-32"></a>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-33"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_device_id</span><span class="w"> </span><span class="n">acpi_ipmi_match</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-34"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;IPI0001&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-35"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-36"></a><span class="p">};</span>
</span></code></pre></div>
<p>和上面的分析是可以对上的。</p>
<h5 id="ipmi-kcs"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#ipmi-kcs">IPMI KCS</a></h5>
<p>查阅 IPMI 标准文档，可以看到 KCS(Keyboard Controller Style) Interface 下，操作系统通过两个 IO Port 来访问 BMC：</p>
<p><img alt="" src="/images/ipmi_kcs.png" /></p>
<p>图中的 <code>base</code> 就是上面 ACPI 表记录的 <code>IDTP=0x0CA2</code>，<code>base+1</code> 就是 ACPI 表记录的 <code>ICDP=0x0CA3</code>。结合寄存器的用途，可以猜测 IDTP 是 IPMI Data Transfer Port 的缩写，因为这个 Port 对应的是 <code>Data_In</code> 和 <code>Data_Out</code>；ICDP 是 IPMI Command Data Port 的缩写。</p>
<h4 id="arm64_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#arm64_1">ARM64</a></h4>
<p>再看一个 ARM64 平台上的 IPMI：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-1"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IPI0</span><span class="p">)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-2"></a><span class="p">{</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;IPI0001&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-4"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_IFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _IFT: IPMI Interface Type</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-6"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="c1">// BT</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-9"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-10"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-11"></a><span class="w">        </span><span class="n">QWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceConsumer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">Cacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-12"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Granularity</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-13"></a><span class="w">            </span><span class="mh">0x00000003F00000E4</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Minimum</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-14"></a><span class="w">            </span><span class="mh">0x00000003F00000E7</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Maximum</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-15"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Translation Offset</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-16"></a><span class="w">            </span><span class="mh">0x0000000000000004</span><span class="p">,</span><span class="w"> </span><span class="c1">// Length</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-17"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-18"></a><span class="w">        </span><span class="n">Interrupt</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceConsumer</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span><span class="p">,</span><span class="w"> </span><span class="n">ActiveHigh</span><span class="p">,</span><span class="w"> </span><span class="n">Shared</span><span class="p">,</span><span class="w"> </span><span class="p">,,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-19"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-20"></a><span class="w">            </span><span class="mh">0x000001E4</span><span class="p">,</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-21"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-22"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 <code>_IFT</code> 返回值是 0x3，查阅文档可知这表示的是 BT 类型。<code>_CRS</code> 中使用了 QWordMemory 宏来描述地址空间，这里实际上就是表示内存地址 <code>0x3F00000E4-0x3F00000E7</code>。</p>
<h3 id="io-apic"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#io-apic">IO APIC</a></h3>
<p>在 DSDT 中，可以找到 IO APIC 的基地址：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-1"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">APIC</span><span class="p">)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-2"></a><span class="p">{</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0003&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* IO-APIC Interrupt Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-6"></a><span class="w">        </span><span class="n">Memory32Fixed</span><span class="w"> </span><span class="p">(</span><span class="n">ReadOnly</span><span class="p">,</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-7"></a><span class="w">            </span><span class="mh">0xFEC00000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Address Base</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-8"></a><span class="w">            </span><span class="mh">0x00100000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Address Length</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-9"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-10"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到 IO APIC 基地址是 0xFEC00000，在网上也可以查到同样的结果。实际上，在 Multiple APIC Description Table (MADT) 中也可以找到 IO APIC 的基地址：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-1"></a>[1ECh 0492   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-2"></a>[1EDh 0493   1]                       Length : 0C
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-3"></a>[1EEh 0494   1]                  I/O Apic ID : 08
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-4"></a>[1EFh 0495   1]                     Reserved : 00
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-5"></a>[1F0h 0496   4]                      Address : FEC00000
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-6"></a>[1F4h 0500   4]                    Interrupt : 00000000
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-8"></a>[1F8h 0504   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-9"></a>[1F9h 0505   1]                       Length : 0C
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-10"></a>[1FAh 0506   1]                  I/O Apic ID : 09
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-11"></a>[1FBh 0507   1]                     Reserved : 00
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-12"></a>[1FCh 0508   4]                      Address : FEC01000
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-13"></a>[200h 0512   4]                    Interrupt : 00000018
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-14"></a>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-15"></a>[204h 0516   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-16"></a>[205h 0517   1]                       Length : 0C
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-17"></a>[206h 0518   1]                  I/O Apic ID : 0A
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-18"></a>[207h 0519   1]                     Reserved : 00
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-19"></a>[208h 0520   4]                      Address : FEC08000
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-20"></a>[20Ch 0524   4]                    Interrupt : 00000020
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-21"></a>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-22"></a>[210h 0528   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-23"></a>[211h 0529   1]                       Length : 0C
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-24"></a>[212h 0530   1]                  I/O Apic ID : 0B
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-25"></a>[213h 0531   1]                     Reserved : 00
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-26"></a>[214h 0532   4]                      Address : FEC10000
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-27"></a>[218h 0536   4]                    Interrupt : 00000028
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-28"></a>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-29"></a>[21Ch 0540   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-30"></a>[21Dh 0541   1]                       Length : 0C
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-31"></a>[21Eh 0542   1]                  I/O Apic ID : 0C
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-32"></a>[21Fh 0543   1]                     Reserved : 00
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-33"></a>[220h 0544   4]                      Address : FEC18000
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-34"></a>[224h 0548   4]                    Interrupt : 00000030
</span></code></pre></div>
<h3 id="dma"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#dma">DMA</a></h3>
<p>继续搜索 <code>_HID</code>，还可以找到一些传统的设备，比如 DMA Controller：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-1"></a><span class="c1">// DMA Controller</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-2"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DMAC</span><span class="p">)</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-3"></a><span class="p">{</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0200&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PC-class DMA Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-5"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-6"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-7"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-8"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-9"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-10"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-11"></a><span class="w">            </span><span class="mh">0x10</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-12"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-13"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-14"></a><span class="w">            </span><span class="mh">0x0081</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-15"></a><span class="w">            </span><span class="mh">0x0081</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-16"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-17"></a><span class="w">            </span><span class="mh">0x03</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-18"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-19"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-20"></a><span class="w">            </span><span class="mh">0x0087</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-21"></a><span class="w">            </span><span class="mh">0x0087</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-22"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-23"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-24"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-25"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-26"></a><span class="w">            </span><span class="mh">0x0089</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-27"></a><span class="w">            </span><span class="mh">0x0089</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-28"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-29"></a><span class="w">            </span><span class="mh">0x03</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-30"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-31"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-32"></a><span class="w">            </span><span class="mh">0x008F</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-33"></a><span class="w">            </span><span class="mh">0x008F</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-34"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-35"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-36"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-37"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-38"></a><span class="w">            </span><span class="mh">0x00C0</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-39"></a><span class="w">            </span><span class="mh">0x00C0</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-40"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-41"></a><span class="w">            </span><span class="mh">0x20</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-42"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-43"></a><span class="w">        </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-44"></a><span class="w">            </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-45"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-46"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它定义了如下的 IO Port 范围：</p>
<ul>
<li><code>0x00-0x0F</code></li>
<li>0x81, 0x87, 0x89, 0x8F</li>
<li><code>0xC0-0xDE</code></li>
</ul>
<p>寄存器定义可以在 <a href="https://wiki.osdev.org/ISA_DMA">ISA DMA - OSDev</a> 处找到。</p>
<h3 id="cmosrtc"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#cmosrtc">CMOS/RTC</a></h3>
<p>经典的 CMOS/RTC 的 IO 端口定义也可以找到：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-1"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">RTC</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-2"></a><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0B00&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* AT Real-Time Clock */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-6"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-7"></a><span class="w">            </span><span class="mh">0x0070</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-8"></a><span class="w">            </span><span class="mh">0x0070</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-9"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-10"></a><span class="w">            </span><span class="mh">0x02</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-11"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-12"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-13"></a><span class="w">            </span><span class="mh">0x0074</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-14"></a><span class="w">            </span><span class="mh">0x0074</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-15"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-16"></a><span class="w">            </span><span class="mh">0x04</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-17"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-18"></a><span class="w">        </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-19"></a><span class="w">            </span><span class="p">{</span><span class="mi">8</span><span class="p">}</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-20"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-21"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_STA</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _STA: Status</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-22"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-23"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">STAS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x01</span><span class="p">))</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-24"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-25"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-27"></a><span class="w">        </span><span class="n">Else</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-28"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-29"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-32"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它的 IO Port 是 0x70-0x71 和 0x74-0x78，中断号 8，和 <a href="https://wiki.osdev.org/CMOS">CMOS - OSDev</a> 是一致的。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_3">启动图片</a></h3>
<p>启动图片以 BMP 格式保存在内存中，基地址记录在 BGRT 表中。可以直接从 <code>/sys/firmware/acpi/bgrt/image</code> 获取启动的图片内容。</p>
<h3 id="pcie"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pcie">PCIe</a></h3>
<h4 id="root-bridge"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#root-bridge">Root Bridge</a></h4>
<p>PCIe 总线是自带枚举功能的，所以只需要找到 Root Bridge，其他设备都可以枚举出来。而 ACPI 就提供了寻找 Root Bridge 的方法。</p>
<p>搜索 <code>PNP0A08</code> 可以找到 PCIe 总线：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-1"></a><span class="c1">// PCIe Bus 00</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-2"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PC00</span><span class="p">)</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-3"></a><span class="p">{</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0A08&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PCI Express Bus */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-5"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0A03&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PCI Bus */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CID: Compatible ID</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-7"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">P0RS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-8"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-9"></a><span class="w">        </span><span class="n">WordBusNumber</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-10"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Granularity</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-11"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-12"></a><span class="w">            </span><span class="mh">0x0015</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-13"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-14"></a><span class="w">            </span><span class="mh">0x0016</span><span class="p">,</span><span class="w">             </span><span class="c1">// Length</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-15"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-16"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-17"></a><span class="w">            </span><span class="mh">0x0CF8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-18"></a><span class="w">            </span><span class="mh">0x0CF8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-19"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-20"></a><span class="w">            </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-21"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-22"></a><span class="w">        </span><span class="n">WordIO</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">EntireRange</span><span class="p">,</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-23"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Granularity</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-24"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-25"></a><span class="w">            </span><span class="mh">0x0CF7</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-26"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-27"></a><span class="w">            </span><span class="mh">0x0CF8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Length</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-28"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">,</span><span class="w"> </span><span class="n">DenseTranslation</span><span class="p">)</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-29"></a><span class="w">        </span><span class="n">WordIO</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">EntireRange</span><span class="p">,</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-30"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Granularity</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-31"></a><span class="w">            </span><span class="mh">0x1000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-32"></a><span class="w">            </span><span class="mh">0x57FF</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-33"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-34"></a><span class="w">            </span><span class="mh">0x4800</span><span class="p">,</span><span class="w">             </span><span class="c1">// Length</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-35"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">,</span><span class="w"> </span><span class="n">DenseTranslation</span><span class="p">)</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-36"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">Cacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-37"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-38"></a><span class="w">            </span><span class="mh">0x000A0000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-39"></a><span class="w">            </span><span class="mh">0x000BFFFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-40"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-41"></a><span class="w">            </span><span class="mh">0x00020000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-42"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-43"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">Cacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-44"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-45"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-46"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-47"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-48"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-49"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="n">_Y00</span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-50"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-51"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-52"></a><span class="w">            </span><span class="mh">0xFE010000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-53"></a><span class="w">            </span><span class="mh">0xFE010FFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-54"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-55"></a><span class="w">            </span><span class="mh">0x00001000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-56"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-57"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-58"><a id="__codelineno-17-58" name="__codelineno-17-58" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-58"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-59"><a id="__codelineno-17-59" name="__codelineno-17-59" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-59"></a><span class="w">            </span><span class="mh">0xFD000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-60"><a id="__codelineno-17-60" name="__codelineno-17-60" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-60"></a><span class="w">            </span><span class="mh">0xFE7FFFFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-61"><a id="__codelineno-17-61" name="__codelineno-17-61" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-61"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-62"><a id="__codelineno-17-62" name="__codelineno-17-62" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-62"></a><span class="w">            </span><span class="mh">0x01800000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-63"><a id="__codelineno-17-63" name="__codelineno-17-63" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-63"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-64"><a id="__codelineno-17-64" name="__codelineno-17-64" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-64"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-65"><a id="__codelineno-17-65" name="__codelineno-17-65" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-65"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-66"><a id="__codelineno-17-66" name="__codelineno-17-66" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-66"></a><span class="w">            </span><span class="mh">0x70000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-67"><a id="__codelineno-17-67" name="__codelineno-17-67" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-67"></a><span class="w">            </span><span class="mh">0x92FFFFFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-68"><a id="__codelineno-17-68" name="__codelineno-17-68" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-68"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-69"><a id="__codelineno-17-69" name="__codelineno-17-69" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-69"></a><span class="w">            </span><span class="mh">0x23000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-70"><a id="__codelineno-17-70" name="__codelineno-17-70" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-70"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-71"><a id="__codelineno-17-71" name="__codelineno-17-71" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-71"></a><span class="w">        </span><span class="n">QWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-72"><a id="__codelineno-17-72" name="__codelineno-17-72" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-72"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Granularity</span>
</span><span id="__span-17-73"><a id="__codelineno-17-73" name="__codelineno-17-73" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-73"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-74"><a id="__codelineno-17-74" name="__codelineno-17-74" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-74"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-75"><a id="__codelineno-17-75" name="__codelineno-17-75" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-75"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-76"><a id="__codelineno-17-76" name="__codelineno-17-76" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-76"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Length</span>
</span><span id="__span-17-77"><a id="__codelineno-17-77" name="__codelineno-17-77" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-77"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-78"><a id="__codelineno-17-78" name="__codelineno-17-78" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-78"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-17-79"><a id="__codelineno-17-79" name="__codelineno-17-79" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-79"></a>
</span><span id="__span-17-80"><a id="__codelineno-17-80" name="__codelineno-17-80" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-80"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-17-81"><a id="__codelineno-17-81" name="__codelineno-17-81" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-81"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-17-82"><a id="__codelineno-17-82" name="__codelineno-17-82" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-82"></a><span class="w">        </span><span class="n">EROM</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-17-83"><a id="__codelineno-17-83" name="__codelineno-17-83" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-83"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">P0RS</span><span class="p">)</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.P0RS */</span>
</span><span id="__span-17-84"><a id="__codelineno-17-84" name="__codelineno-17-84" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-84"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-85"><a id="__codelineno-17-85" name="__codelineno-17-85" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-85"></a><span class="p">}</span>
</span></code></pre></div>
<p>上面省略掉了很多内容，只保留了 Root Bridge 的资源 <code>_CRS</code>，这部分内容和 Linux 的 dmesg 是一致的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-1"></a>ACPI: PCI Root Bridge [PC00] (domain 0000 [bus 00-15])
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-2"></a>acpi PNP0A08:00: _OSC: OS supports [ExtendedConfig ASPM ClockPM Segments MSI]
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-3"></a>acpi PNP0A08:00: _OSC: platform does not support [SHPCHotplug AER LTR]
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-4"></a>acpi PNP0A08:00: _OSC: OS now controls [PCIeHotplug PME PCIeCapability]
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-5"></a>acpi PNP0A08:00: host bridge window expanded to [mem 0xfd000000-0xfe7fffff window]; [mem 0xfd000000-0xfe7fffff window] ignored
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-6"></a>PCI host bridge to bus 0000:00
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-7"></a>pci_bus 0000:00: root bus resource [io  0x0000-0x0cf7 window]
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-8"></a>pci_bus 0000:00: root bus resource [io  0x1000-0x57ff window]
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-9"></a>pci_bus 0000:00: root bus resource [mem 0x000a0000-0x000bffff window]
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-10"></a>pci_bus 0000:00: root bus resource [mem 0x000c4000-0x000c7fff window]
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-11"></a>pci_bus 0000:00: root bus resource [mem 0xfd000000-0xfe7fffff window]
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-12"></a>pci_bus 0000:00: root bus resource [mem 0x70000000-0x92ffffff window]
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-13"></a>pci_bus 0000:00: root bus resource [bus 00-15]
</span></code></pre></div>
<p>Linux 相关代码在 <code>acpi_pci_root_create</code> 函数中：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">pci_bus</span><span class="w"> </span><span class="o">*</span><span class="n">acpi_pci_root_create</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_pci_root</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">,</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-2"></a><span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_pci_root_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">,</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-3"></a><span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_pci_root_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-4"></a><span class="w">                     </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sysdata</span><span class="p">)</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-5"></a><span class="p">{</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-6"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-7"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_pci_probe_root_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-8"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-9"></a><span class="w">    </span><span class="n">pci_acpi_root_add_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-10"></a><span class="w">    </span><span class="n">pci_add_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">);</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-11"></a><span class="w">    </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_create_root_bus</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">busnum</span><span class="p">,</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pci_ops</span><span class="p">,</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-12"></a><span class="w">                  </span><span class="n">sysdata</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">);</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-13"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="mcfg"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#mcfg">MCFG</a></h4>
<p>除了上面的 Root Bridge 以外，还有一个很重要的问题是，如何访问 PCIe 的 Configuration Space。传统的办法是通过 IO Port 0xCF8 和 0xCFC，但是这个方法慢，并且有局限性。而较新的办法是 Enhanced Configuration Access Mechanism (ECAM)，把 PCIe 设备的 Configuration Space 映射到内存中，那么就需要一个基地址。这个基地址是在 MCFG 表中给出的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-1"></a>[02Ch 0044   8]                 Base Address : 0000000060000000
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-2"></a>[034h 0052   2]         Segment Group Number : 0000
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-3"></a>[036h 0054   1]             Start Bus Number : 00
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-4"></a>[037h 0055   1]               End Bus Number : FF
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-5"></a>[038h 0056   4]                     Reserved : 00000000
</span></code></pre></div>
<p>内核输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-21-1"></a>PCI: MMCONFIG for domain 0000 [bus 00-ff] at [mem 0x60000000-0x6fffffff] (base 0x60000000)
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-21-2"></a>PCI: MMCONFIG at [mem 0x60000000-0x6fffffff] reserved in E820
</span></code></pre></div>
<p>有了这个信息以后，就可以计算出要访问 Configuration Space 时 MMIO 的地址了：</p>
<p><img alt="" src="/images/pcie_ecam.png" /></p>
<h4 id="_4"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_4">相关文档</a></h4>
<p>Linux 的文档 <a href="https://docs.kernel.org/PCI/acpi-info.html">ACPI considerations for PCI host bridges</a> 对 ACPI PCIe 描述的比较详细，摘录如下：</p>
<div class="language-text highlight"><pre><span></span><code>The general rule is that the ACPI namespace should describe everything the
OS might use unless there’s another way for the OS to find it [1, 2].

For example, there’s no standard hardware mechanism for enumerating PCI host
bridges, so the ACPI namespace must describe each host bridge, the method
for accessing PCI config space below it, the address space windows the host
bridge forwards to PCI (using _CRS), and the routing of legacy INTx
interrupts (using _PRT).

PCI devices, which are below the host bridge, generally do not need to be
described via ACPI. The OS can discover them via the standard PCI
enumeration mechanism, using config accesses to discover and identify
devices and read and size their BARs. However, ACPI may describe PCI devices
if it provides power management or hotplug functionality for them or if the
device has INTx interrupts connected by platform interrupt controllers and a
_PRT is needed to describe those connections.
</code></pre></div>
<p>文档和上面讲的是一致的，对于 PCIe 自己可以枚举出来的，ACPI 就不需要再重复；但是枚举需要首先知道有哪些 Root Bridge 以及 ECAM 的基地址，这个信息只能由 ACPI 来提供。</p>
<div class="language-text highlight"><pre><span></span><code>The PCIe spec requires the Enhanced Configuration Access Method (ECAM)
unless there’s a standard firmware interface for config access, e.g., the
ia64 SAL interface [7]. A host bridge consumes ECAM memory address space and
converts memory accesses into PCI configuration accesses. The spec defines
the ECAM address space layout and functionality; only the base of the
address space is device-specific. An ACPI OS learns the base address from
either the static MCFG table or a _CBA method in the PNP0A03 device.
</code></pre></div>
<p>这一段讲的其实就是 ECAM 与 MCFG 的关系。</p>
<h4 id="pcie_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pcie_1">PCIe 设备</a></h4>
<p>虽然有了 Root Bridge 以后，PCIe 总线下的设备都可以枚举出来，但是 ACPI 表中也可以记录 PCIe 设备，可以提供更多信息，例如 Power State 等等。具体来说，只需要在 Root Bridge 的结点下继续增加 Device 就可以了：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-1"></a><span class="n">Scope</span><span class="w"> </span><span class="p">(</span><span class="n">_SB</span><span class="p">)</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-2"></a><span class="p">{</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-3"></a><span class="w">    </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PC00</span><span class="p">)</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-5"></a><span class="w">        </span><span class="c1">// 00:00.0 DMI3 Registers</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-6"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DMI0</span><span class="p">)</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-7"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-8"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-10"></a>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-11"></a><span class="w">        </span><span class="c1">// 00:04.0 CBDMA Registers</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-12"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">CB0A</span><span class="p">)</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-13"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-14"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00040000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-16"></a>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-17"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">CB0B</span><span class="p">)</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-18"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-19"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00040001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-21"></a>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-22"></a><span class="w">        </span><span class="c1">// 00:05.0 MM/Vt-d Configuration Registers</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-23"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IIM0</span><span class="p">)</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-24"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-25"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00050000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-27"></a>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-28"></a><span class="w">        </span><span class="c1">// 00:08.0 Ubox Registers</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-29"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">UBX0</span><span class="p">)</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-30"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-31"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00080000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-33"></a>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-34"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">ALZA</span><span class="p">)</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-35"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-36"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000E0000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-37"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-38"></a>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-39"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DISP</span><span class="p">)</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-40"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-41"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000F0000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-42"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-43"></a>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-44"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IHC1</span><span class="p">)</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-45"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-46"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-47"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-48"></a>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-49"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IHC2</span><span class="p">)</span>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-50"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-51"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-52"><a id="__codelineno-22-52" name="__codelineno-22-52" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-52"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-53"><a id="__codelineno-22-53" name="__codelineno-22-53" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-53"></a>
</span><span id="__span-22-54"><a id="__codelineno-22-54" name="__codelineno-22-54" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-54"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IIDR</span><span class="p">)</span>
</span><span id="__span-22-55"><a id="__codelineno-22-55" name="__codelineno-22-55" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-55"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-56"><a id="__codelineno-22-56" name="__codelineno-22-56" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-56"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100002</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-57"><a id="__codelineno-22-57" name="__codelineno-22-57" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-57"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-58"><a id="__codelineno-22-58" name="__codelineno-22-58" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-58"></a>
</span><span id="__span-22-59"><a id="__codelineno-22-59" name="__codelineno-22-59" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-59"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IMKT</span><span class="p">)</span>
</span><span id="__span-22-60"><a id="__codelineno-22-60" name="__codelineno-22-60" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-60"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-61"><a id="__codelineno-22-61" name="__codelineno-22-61" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-61"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100003</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-62"><a id="__codelineno-22-62" name="__codelineno-22-62" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-62"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-63"><a id="__codelineno-22-63" name="__codelineno-22-63" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-63"></a>
</span><span id="__span-22-64"><a id="__codelineno-22-64" name="__codelineno-22-64" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-64"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IHC3</span><span class="p">)</span>
</span><span id="__span-22-65"><a id="__codelineno-22-65" name="__codelineno-22-65" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-65"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-66"><a id="__codelineno-22-66" name="__codelineno-22-66" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-66"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100004</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-67"><a id="__codelineno-22-67" name="__codelineno-22-67" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-67"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-68"><a id="__codelineno-22-68" name="__codelineno-22-68" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-68"></a>
</span><span id="__span-22-69"><a id="__codelineno-22-69" name="__codelineno-22-69" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-69"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">MRO0</span><span class="p">)</span>
</span><span id="__span-22-70"><a id="__codelineno-22-70" name="__codelineno-22-70" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-70"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-71"><a id="__codelineno-22-71" name="__codelineno-22-71" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-71"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00110000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-72"><a id="__codelineno-22-72" name="__codelineno-22-72" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-72"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-73"><a id="__codelineno-22-73" name="__codelineno-22-73" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-73"></a>
</span><span id="__span-22-74"><a id="__codelineno-22-74" name="__codelineno-22-74" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-74"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">MRO1</span><span class="p">)</span>
</span><span id="__span-22-75"><a id="__codelineno-22-75" name="__codelineno-22-75" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-75"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-76"><a id="__codelineno-22-76" name="__codelineno-22-76" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-76"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00110001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-77"><a id="__codelineno-22-77" name="__codelineno-22-77" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-77"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-78"><a id="__codelineno-22-78" name="__codelineno-22-78" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-78"></a>
</span><span id="__span-22-79"><a id="__codelineno-22-79" name="__codelineno-22-79" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-79"></a><span class="w">        </span><span class="c1">// 00:14.0 USB 3.0 xHCI Controller</span>
</span><span id="__span-22-80"><a id="__codelineno-22-80" name="__codelineno-22-80" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-80"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">XHCI</span><span class="p">)</span>
</span><span id="__span-22-81"><a id="__codelineno-22-81" name="__codelineno-22-81" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-81"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-82"><a id="__codelineno-22-82" name="__codelineno-22-82" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-82"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-83"><a id="__codelineno-22-83" name="__codelineno-22-83" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-83"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-84"><a id="__codelineno-22-84" name="__codelineno-22-84" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-84"></a>
</span><span id="__span-22-85"><a id="__codelineno-22-85" name="__codelineno-22-85" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-85"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">OTG0</span><span class="p">)</span>
</span><span id="__span-22-86"><a id="__codelineno-22-86" name="__codelineno-22-86" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-86"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-87"><a id="__codelineno-22-87" name="__codelineno-22-87" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-87"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-88"><a id="__codelineno-22-88" name="__codelineno-22-88" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-88"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-89"><a id="__codelineno-22-89" name="__codelineno-22-89" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-89"></a>
</span><span id="__span-22-90"><a id="__codelineno-22-90" name="__codelineno-22-90" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-90"></a><span class="w">        </span><span class="c1">// 00:14.2 PCH Thermal Subsystem</span>
</span><span id="__span-22-91"><a id="__codelineno-22-91" name="__codelineno-22-91" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-91"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">TERM</span><span class="p">)</span>
</span><span id="__span-22-92"><a id="__codelineno-22-92" name="__codelineno-22-92" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-92"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-93"><a id="__codelineno-22-93" name="__codelineno-22-93" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-93"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140002</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-94"><a id="__codelineno-22-94" name="__codelineno-22-94" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-94"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-95"><a id="__codelineno-22-95" name="__codelineno-22-95" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-95"></a>
</span><span id="__span-22-96"><a id="__codelineno-22-96" name="__codelineno-22-96" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-96"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">CAMR</span><span class="p">)</span>
</span><span id="__span-22-97"><a id="__codelineno-22-97" name="__codelineno-22-97" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-97"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-98"><a id="__codelineno-22-98" name="__codelineno-22-98" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-98"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140003</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-99"><a id="__codelineno-22-99" name="__codelineno-22-99" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-99"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-100"><a id="__codelineno-22-100" name="__codelineno-22-100" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-100"></a>
</span><span id="__span-22-101"><a id="__codelineno-22-101" name="__codelineno-22-101" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-101"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">NTHP</span><span class="p">)</span>
</span><span id="__span-22-102"><a id="__codelineno-22-102" name="__codelineno-22-102" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-102"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-103"><a id="__codelineno-22-103" name="__codelineno-22-103" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-103"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140004</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-104"><a id="__codelineno-22-104" name="__codelineno-22-104" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-104"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-105"><a id="__codelineno-22-105" name="__codelineno-22-105" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-105"></a>
</span><span id="__span-22-106"><a id="__codelineno-22-106" name="__codelineno-22-106" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-106"></a><span class="w">        </span><span class="c1">// 00:16.0 PCH CSME HECI #1</span>
</span><span id="__span-22-107"><a id="__codelineno-22-107" name="__codelineno-22-107" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-107"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HEC1</span><span class="p">)</span>
</span><span id="__span-22-108"><a id="__codelineno-22-108" name="__codelineno-22-108" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-108"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-109"><a id="__codelineno-22-109" name="__codelineno-22-109" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-109"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-110"><a id="__codelineno-22-110" name="__codelineno-22-110" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-110"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-111"><a id="__codelineno-22-111" name="__codelineno-22-111" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-111"></a>
</span><span id="__span-22-112"><a id="__codelineno-22-112" name="__codelineno-22-112" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-112"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HEC2</span><span class="p">)</span>
</span><span id="__span-22-113"><a id="__codelineno-22-113" name="__codelineno-22-113" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-113"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-114"><a id="__codelineno-22-114" name="__codelineno-22-114" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-114"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-115"><a id="__codelineno-22-115" name="__codelineno-22-115" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-115"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-116"><a id="__codelineno-22-116" name="__codelineno-22-116" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-116"></a>
</span><span id="__span-22-117"><a id="__codelineno-22-117" name="__codelineno-22-117" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-117"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IDER</span><span class="p">)</span>
</span><span id="__span-22-118"><a id="__codelineno-22-118" name="__codelineno-22-118" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-118"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-119"><a id="__codelineno-22-119" name="__codelineno-22-119" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-119"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160002</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-120"><a id="__codelineno-22-120" name="__codelineno-22-120" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-120"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-121"><a id="__codelineno-22-121" name="__codelineno-22-121" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-121"></a>
</span><span id="__span-22-122"><a id="__codelineno-22-122" name="__codelineno-22-122" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-122"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">MEKT</span><span class="p">)</span>
</span><span id="__span-22-123"><a id="__codelineno-22-123" name="__codelineno-22-123" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-123"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-124"><a id="__codelineno-22-124" name="__codelineno-22-124" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-124"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160003</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-125"><a id="__codelineno-22-125" name="__codelineno-22-125" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-125"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-126"><a id="__codelineno-22-126" name="__codelineno-22-126" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-126"></a>
</span><span id="__span-22-127"><a id="__codelineno-22-127" name="__codelineno-22-127" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-127"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HEC3</span><span class="p">)</span>
</span><span id="__span-22-128"><a id="__codelineno-22-128" name="__codelineno-22-128" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-128"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-129"><a id="__codelineno-22-129" name="__codelineno-22-129" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-129"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160004</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-130"><a id="__codelineno-22-130" name="__codelineno-22-130" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-130"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-131"><a id="__codelineno-22-131" name="__codelineno-22-131" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-131"></a>
</span><span id="__span-22-132"><a id="__codelineno-22-132" name="__codelineno-22-132" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-132"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">NAN1</span><span class="p">)</span>
</span><span id="__span-22-133"><a id="__codelineno-22-133" name="__codelineno-22-133" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-133"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-134"><a id="__codelineno-22-134" name="__codelineno-22-134" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-134"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00180000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-135"><a id="__codelineno-22-135" name="__codelineno-22-135" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-135"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-136"><a id="__codelineno-22-136" name="__codelineno-22-136" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-136"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-137"><a id="__codelineno-22-137" name="__codelineno-22-137" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-137"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 <code>_ADR</code> 编码了设备的 Device 和 Function，ACPI 标准 Table 6.2 定义：高 word 表示 Device，低 word 表示 Function。所以上面的 <code>DMI0</code> 就是 <code>Device=0, Function=0</code>，<code>CB0A</code> 就是 <code>Device=4, Function=0</code>，<code>CB0B</code> 就是 <code>Device=4, Function=1</code>。这些与 <code>lspci</code> 的输出基本是一致的，有一些设备没有出现，可能和具体的 CPU 型号有关：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-1"></a>00:00.0 Host bridge: Intel Corporation Sky Lake-E DMI3 Registers (rev 07)
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-2"></a>00:04.0 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-3"></a>00:04.1 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-4"></a>00:04.2 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-5"></a>00:04.3 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-6"></a>00:04.4 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-7"></a>00:04.5 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-8"></a>00:04.6 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-9"></a>00:04.7 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-10"></a>00:05.0 System peripheral: Intel Corporation Sky Lake-E MM/Vt-d Configuration Registers (rev 07)
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-11"></a>00:05.2 System peripheral: Intel Corporation Sky Lake-E RAS (rev 07)
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-12"></a>00:05.4 PIC: Intel Corporation Sky Lake-E IOAPIC (rev 07)
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-13"></a>00:08.0 System peripheral: Intel Corporation Sky Lake-E Ubox Registers (rev 07)
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-14"></a>00:08.1 Performance counters: Intel Corporation Sky Lake-E Ubox Registers (rev 07)
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-15"></a>00:08.2 System peripheral: Intel Corporation Sky Lake-E Ubox Registers (rev 07)
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-16"></a>00:14.0 USB controller: Intel Corporation 200 Series/Z370 Chipset Family USB 3.0 xHCI Controller
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-17"></a>00:14.2 Signal processing controller: Intel Corporation 200 Series PCH Thermal Subsystem
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-18"></a>00:16.0 Communication controller: Intel Corporation 200 Series PCH CSME HECI #1
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-19"></a>00:17.0 SATA controller: Intel Corporation 200 Series PCH SATA controller [AHCI mode]
</span></code></pre></div>
<p>前面提到的一些传统的设备，比如 DMA Controller，RTC 等，其实就是在 PCIe 下的 ISA bridge 下声明的：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-1"></a><span class="n">Scope</span><span class="w"> </span><span class="p">(</span><span class="n">_SB</span><span class="p">)</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-2"></a><span class="p">{</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-3"></a><span class="w">    </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PC00</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-5"></a><span class="w">        </span><span class="c1">// 00:1f.0 ISA bridge: Intel Corporation X299 Chipset LPC/eSPI Controller</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-6"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">LPC0</span><span class="p">)</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-7"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-8"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001F0000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-9"></a>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-10"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DMAC</span><span class="p">)</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-11"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-12"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0200&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PC-class DMA Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-13"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-14"></a>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-15"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">RTC</span><span class="p">)</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-16"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-17"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0B00&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* AT Real-Time Clock */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-18"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-19"></a>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-20"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PIC</span><span class="p">)</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-21"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-22"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0000&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* 8259-compatible Programmable Interrupt Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-23"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-24"></a>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-25"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">FPU</span><span class="p">)</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-26"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-27"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0C04&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* x87-compatible Floating Point Processing Unit */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-28"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-29"></a>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-30"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">TMR</span><span class="p">)</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-31"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-32"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0100&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PC-class System Timer */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-33"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-34"></a>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-35"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HPET</span><span class="p">)</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-36"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-37"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;PNP0103&quot;</span><span class="p">)</span><span class="w"> </span><span class="cm">/* HPET System Timer */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-38"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-39"></a>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-40"></a><span class="w">            </span><span class="c1">// omitted</span>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-41"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-43"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="acpi_2"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#acpi_2">修改 ACPI 表内容</a></h3>
<p>想要修改 ACPI 表内容，最根本的办法是修改固件，但是修改起来比较麻烦。Linux 提供了一些方法来运行时打补丁：</p>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/admin-guide/acpi/initrd_table_override.html">Upgrading ACPI tables via initrd</a>：覆盖 ACPI 表</li>
<li><a href="https://www.kernel.org/doc/html/latest/admin-guide/acpi/ssdt-overlays.html">SSDT Overlays</a>：添加额外的 SSDT 表，类似 DT Overlay</li>
</ul>
<p>在黑苹果中，一般则是在 Bootloader(Clover/OpenCore) 一步把 ACPI 表修改了，如 <a href="https://elitemacx86.com/threads/how-to-patch-laptop-dsdt-and-ssdts.178/">How to Patch Laptop DSDT and SSDTs</a>。</p>
<h3 id="acpi_3"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#acpi_3">ACPI 硬件规范</a></h3>
<p>除了用来描述系统中已有的设备，ACPI 还对硬件做出了一些要求，在标准的 Chapter 4 ACPI Hardware Specification 中定义。例如，电源按钮是如何通知操作系统的？操作系统的重启和关机是怎么实现的？</p>
<h4 id="_5"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_5">电源按钮</a></h4>
<p>首先来看电源按钮（Power Button）。在 ACPI 中，定义了两种 Power Button 的实现方法，第一种就是比较经典的硬件按钮 + 中断的模式，当按下按钮的时候，中断状态（<code>PWRBTN_STS</code>）拉高，如果此时中断使能（<code>PWRBTN_EN</code>）也为高，就触发中断。这时候操作系统就知道电源键被按下了，开始进行关机操作。</p>
<p>第二种实现方法则利用了 ACPI 的可编程性。具体来说，当按下电源键的时候，操作系统会收到一个 SCI（System Control Interrupt），此时操作系统会根据中断编号，去执行 ACPI 中的函数，函数去读取当前的电源键状态，然后调用 <code>Notify</code> 函数来通知操作系统，电源键被按下了。</p>
<p>在使用虚拟机的时候，会知道 ACPI Shutdown 的说法，其实就是模拟了按下电源键的行为。QEMU 的相关代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_pm1_evt_power_down</span><span class="p">(</span><span class="n">ACPIREGS</span><span class="w"> </span><span class="o">*</span><span class="n">ar</span><span class="p">)</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-2"></a><span class="p">{</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">evt</span><span class="p">.</span><span class="n">en</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ACPI_BITMASK_POWER_BUTTON_ENABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-4"></a><span class="w">        </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">evt</span><span class="p">.</span><span class="n">sts</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ACPI_BITMASK_POWER_BUTTON_STATUS</span><span class="p">;</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-5"></a><span class="w">        </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">.</span><span class="n">update_sci</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数模拟了电源按钮，如果 <code>PWRBTN_EN=1</code>，就设置 <code>PWRBTN_STS=1</code> 并发送 SCI 中断。</p>
<p>那么，操作系统如何访问 <code>PWRBTN_EN</code> 和 <code>PWRBTN_STS</code> 呢？在 FADP(Fixed ACPI Descrption Table) 表中，可以找到 PM1A/B Event Block Address 和 PM1A/B Control Block Address：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-1"></a>[038h 0056   4]     PM1A Event Block Address : 0000B000
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-2"></a>[03Ch 0060   4]     PM1B Event Block Address : 00000000
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-3"></a>[040h 0064   4]   PM1A Control Block Address : 0000B004
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-4"></a>[044h 0068   4]   PM1B Control Block Address : 00000000
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-5"></a>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-6"></a>[058h 0088   1]       PM1 Event Block Length : 04
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-7"></a>[059h 0089   1]     PM1 Control Block Length : 02
</span></code></pre></div>
<p>那么就可以通过 IO Port 来访问这些寄存器了。<code>PWNBTN_STS</code> 属于 PM1 Status Registers，地址是 <code>PM1A/B Event Block Address=0xB000</code>；<code>PWNBTN_EN</code> 属于 PM1 Enable Registers，地址是 <code>PM1A/B Event Block Register + PM1 Event Block Length / 2=0xB002</code>。</p>
<p>这里的 PM1A/B 是 Register Grouping，使得硬件上可以把寄存器实现在两个不同的芯片上，分别实现一部分功能。操作系统读取的时候，要读取 A 和 B 然后 OR 起来，写入的时候则是 A 和 B 都要写。像上面的情况，就是只有 A 没有 B，那就直接读写 A 就可以了。</p>
<h4 id="_6"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_6">关机</a></h4>
<p>另一方面，如果 OS 想要关机，那要怎么告诉硬件呢？还是通过 ACPI。在 PM1 Control Registers 中，可以通过写入 <code>SLP_TYPx</code> 和 <code>SLP_EN</code> 字段来进行休眠或者关机操作。</p>
<p>下面是 QEMU 针对 <code>SLP_EN</code> 写入的处理代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-1"></a><span class="cm">/* ACPI PM1aCNT */</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_pm1_cnt_write</span><span class="p">(</span><span class="n">ACPIREGS</span><span class="w"> </span><span class="o">*</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-3"></a><span class="p">{</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-4"></a><span class="w">    </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">cnt</span><span class="p">.</span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">ACPI_BITMASK_SLEEP_ENABLE</span><span class="p">);</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-5"></a>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ACPI_BITMASK_SLEEP_ENABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-7"></a><span class="w">        </span><span class="cm">/* change suspend type */</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-8"></a><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">sus_typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-9"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">sus_typ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-10"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="cm">/* soft power off */</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-11"></a><span class="w">            </span><span class="n">qemu_system_shutdown_request</span><span class="p">(</span><span class="n">SHUTDOWN_CAUSE_GUEST_SHUTDOWN</span><span class="p">);</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-12"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-13"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-14"></a><span class="w">            </span><span class="n">qemu_system_suspend_request</span><span class="p">();</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-15"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-16"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sus_typ</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">cnt</span><span class="p">.</span><span class="n">s4_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* S4 request */</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-18"></a><span class="w">                </span><span class="n">qapi_event_send_suspend_disk</span><span class="p">();</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-19"></a><span class="w">                </span><span class="n">qemu_system_shutdown_request</span><span class="p">(</span><span class="n">SHUTDOWN_CAUSE_GUEST_SHUTDOWN</span><span class="p">);</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-20"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-21"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-24"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="pm-timer"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pm-timer">PM Timer</a></h4>
<p>ACPI 还提供了一个 3.579545 MHz 的时钟 PM_TMR。QEMU 相关代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-1"></a><span class="cm">/* PM Timer ticks per second (HZ) */</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-2"></a><span class="cp">##define PM_TIMER_FREQUENCY  3579545</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-3"></a>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-4"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="nf">acpi_pm_tmr_get_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-5"></a><span class="p">{</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">muldiv64</span><span class="p">(</span><span class="n">qemu_clock_get_ns</span><span class="p">(</span><span class="n">QEMU_CLOCK_VIRTUAL</span><span class="p">),</span><span class="w"> </span><span class="n">PM_TIMER_FREQUENCY</span><span class="p">,</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-7"></a><span class="w">                    </span><span class="n">NANOSECONDS_PER_SECOND</span><span class="p">);</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>Linux 也可以把它当成一个时钟源：</p>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-29-1"></a><span class="err">clocksource: acpi_pm: mask: 0xffffff max_cycles: 0xffffff, max_idle_ns: 2085701024 ns</span>
</span></code></pre></div>
<p>相关代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-1"></a><span class="cm">/*</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-2"></a><span class="cm"> * The I/O port the PMTMR resides at.</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-3"></a><span class="cm"> * The location is detected during setup_arch(),</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-4"></a><span class="cm"> * in arch/i386/kernel/acpi/boot.c</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-5"></a><span class="cm"> */</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-6"></a><span class="n">u32</span><span class="w"> </span><span class="n">pmtmr_ioport</span><span class="w"> </span><span class="n">__read_mostly</span><span class="p">;</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-7"></a>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-8"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="nf">read_pmtmr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-9"></a><span class="p">{</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-10"></a><span class="w">    </span><span class="cm">/* mask the output to 24 bits */</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inl</span><span class="p">(</span><span class="n">pmtmr_ioport</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ACPI_PM_MASK</span><span class="p">;</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-12"></a><span class="p">}</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-13"></a>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-14"></a><span class="k">static</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="nf">acpi_pm_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clocksource</span><span class="w"> </span><span class="o">*</span><span class="n">cs</span><span class="p">)</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-15"></a><span class="p">{</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">read_pmtmr</span><span class="p">();</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-17"></a><span class="p">}</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-18"></a>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-19"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">clocksource</span><span class="w"> </span><span class="n">clocksource_acpi_pm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-20"></a><span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;acpi_pm&quot;</span><span class="p">,</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-21"></a><span class="w">    </span><span class="p">.</span><span class="n">rating</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-22"></a><span class="w">    </span><span class="p">.</span><span class="n">read</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_pm_read</span><span class="p">,</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-23"></a><span class="w">    </span><span class="p">.</span><span class="n">mask</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ACPI_PM_MASK</span><span class="p">,</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-24"></a><span class="w">    </span><span class="p">.</span><span class="n">flags</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">CLOCK_SOURCE_IS_CONTINUOUS</span><span class="p">,</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-25"></a><span class="p">};</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-26"></a>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-27"></a><span class="cm">/* Number of PMTMR ticks expected during calibration run */</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-28"></a><span class="cp">##define PMTMR_TICKS_PER_SEC 3579545</span>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-29"></a>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-30"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">init_acpi_pm_clocksource</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-31"></a><span class="p">{</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-32"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-33"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">clocksource_register_hz</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocksource_acpi_pm</span><span class="p">,</span>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-34"></a><span class="w">                        </span><span class="n">PMTMR_TICKS_PER_SEC</span><span class="p">);</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-35"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="gpe"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#gpe">GPE</a></h4>
<p>除了上面 PM1 中提到的一些中断来源，ACPI 还提供了通用的 General Purpose Event，硬件可以自定义一些中断编号，依然是通过 SCI 中断通知操作系统，操作系统根据 GPE 的 STS 寄存器来判断哪个 GPE 触发了中断，然后执行对应的 ACPI 函数。GPE 的地址也是在 FADT 中提供：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-31-1"></a>[050h 0080   4]           GPE0 Block Address : 0000AFE0
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-31-3"></a>[05Ch 0092   1]            GPE0 Block Length : 04
</span></code></pre></div>
<p>在 DSDT 的 <code>\_GPE</code> 下面，可以定义函数，在 GPE 到达的时候，会被操作系统执行。格式是 <code>\_GPE._Exx</code> 或 <code>\_GPE._Lxx</code>，E 表示 Edge sensitive，L 表示 Level sensitive。例如操作系统判断收到了 GPE 4，那可能会执行 <code>\_GPE._L04</code> 或 <code>\_GPE._E04</code> 函数。</p>
<h3 id="pcie-hot-plug"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pcie-hot-plug">PCIe Hot Plug</a></h3>
<p>在 QEMU 中，如果虚拟机要进行 PCIe Hot Plug 的时候，例如要增加 PCIe 设备，或者删除已有的 PCIe 设备，需要设法通知操作系统，告知操作系统哪个地方有新的设备，或者哪个已有的设备被弹出。QEMU 的实现文档是<a href="https://www.qemu.org/docs/master/specs/acpi_pci_hotplug.html">QEMU&lt;-&gt;ACPI BIOS PCI hotplug interface</a>，这里结合代码来解释一下。</p>
<p>在 QEMU 中，要插入一个新的 PCIe 设备的时候，按照设备的 bus 和 slot 设置位为 1，并且发送 GPE：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_pcihp_device_plug_cb</span><span class="p">(</span><span class="n">HotplugHandler</span><span class="w"> </span><span class="o">*</span><span class="n">hotplug_dev</span><span class="p">,</span><span class="w"> </span><span class="n">AcpiPciHpState</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-2"></a><span class="w">                               </span><span class="n">DeviceState</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">**</span><span class="n">errp</span><span class="p">)</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-3"></a><span class="p">{</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-4"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-5"></a>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-6"></a><span class="w">    </span><span class="n">bsel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_pcihp_get_bsel</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-7"></a><span class="w">    </span><span class="n">g_assert</span><span class="p">(</span><span class="n">bsel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-8"></a><span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">up</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slot</span><span class="p">);</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-9"></a><span class="w">    </span><span class="n">acpi_send_event</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">(</span><span class="n">hotplug_dev</span><span class="p">),</span><span class="w"> </span><span class="n">ACPI_PCI_HOTPLUG_STATUS</span><span class="p">);</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-10"></a><span class="p">}</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-11"></a>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-12"></a><span class="c1">// acpi_send_event eventually calls piix4_send_gpe</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-13"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">piix4_send_gpe</span><span class="p">(</span><span class="n">AcpiDeviceIf</span><span class="w"> </span><span class="o">*</span><span class="n">adev</span><span class="p">,</span><span class="w"> </span><span class="n">AcpiEventStatusBits</span><span class="w"> </span><span class="n">ev</span><span class="p">)</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-14"></a><span class="p">{</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-15"></a><span class="w">    </span><span class="n">PIIX4PMState</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PIIX4_PM</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-16"></a>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-17"></a><span class="w">    </span><span class="n">acpi_send_gpe_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">ev</span><span class="p">);</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-18"></a><span class="p">}</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-19"></a>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-20"></a><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_send_gpe_event</span><span class="p">(</span><span class="n">ACPIREGS</span><span class="w"> </span><span class="o">*</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="n">qemu_irq</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-21"></a><span class="w">                         </span><span class="n">AcpiEventStatusBits</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-22"></a><span class="p">{</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-23"></a><span class="w">    </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">gpe</span><span class="p">.</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-24"></a><span class="w">    </span><span class="n">acpi_update_sci</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="p">);</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>查看头文件，可知 <code>ACPI_PCI_HOTPLUG_STATUS=2</code>，根据上面的代码，可知这实际上就是发送了 GPE1。操作系统会执行 <code>\_GPE._E01</code> 函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-1"></a><span class="n">Scope</span><span class="w"> </span><span class="p">(</span><span class="n">_GPE</span><span class="p">)</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-2"></a><span class="p">{</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ACPI0006&quot;</span><span class="w"> </span><span class="cm">/* GPE Block Device */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-4"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_E01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _Exx: Edge-Triggered GPE, xx=0x00-0xFF</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-6"></a><span class="w">        </span><span class="n">Acquire</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PCI0</span><span class="p">.</span><span class="n">BLCK</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-7"></a><span class="w">        </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PCI0</span><span class="p">.</span><span class="n">PCNT</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="c1">// PCIe Notify</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-8"></a><span class="w">        </span><span class="n">Release</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PCI0</span><span class="p">.</span><span class="n">BLCK</span><span class="p">)</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个代码上了锁，然后调用 <code>\_SB.PCI0.PCNT</code> 函数，<code>PCNT</code> 函数定义如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-1"></a><span class="c1">// PCIe Status</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-2"></a><span class="n">OperationRegion</span><span class="w"> </span><span class="p">(</span><span class="n">PCST</span><span class="p">,</span><span class="w"> </span><span class="n">SystemIO</span><span class="p">,</span><span class="w"> </span><span class="mh">0xAE00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">)</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-3"></a><span class="n">Field</span><span class="w"> </span><span class="p">(</span><span class="n">PCST</span><span class="p">,</span><span class="w"> </span><span class="n">DWordAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">WriteAsZeros</span><span class="p">)</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-4"></a><span class="p">{</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-5"></a><span class="w">    </span><span class="n">PCIU</span><span class="p">,</span><span class="w">   </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="c1">// Up</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-6"></a><span class="w">    </span><span class="n">PCID</span><span class="p">,</span><span class="w">   </span><span class="mi">32</span><span class="w">  </span><span class="c1">// Down</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-7"></a><span class="p">}</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-8"></a>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-9"></a><span class="c1">// PCIe Notify</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-10"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">PCNT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-11"></a><span class="p">{</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-12"></a><span class="w">    </span><span class="n">BNUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zero</span><span class="w"> </span><span class="c1">// Bus Num = 0</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-13"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCIU</span><span class="p">,</span><span class="w"> </span><span class="n">One</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-14"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>上面的代码中，PCIU 的意思是 PCIe Up，就是新出现的设备；PCID 的意思是 PCIe Down，就是要删除的设备。PCIU 和 PCID 都要通过 IO Port 访问，根据上面的 <code>OperationRegion</code> 可知 <code>PCIU=0xAE00</code>，<code>PCID=0xAE04</code>。你可能已经猜到了 <code>PCIU</code> 和 <code>PCID</code> 的实现：当 CPU 读取这两个 IO Port 的时候，就会返回前面 <code>acpi_pcihp_device_plug_cb</code> 函数写入的 <code>acpi_pcihp_pci_status</code> 数组：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">pci_read</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">hwaddr</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-2"></a><span class="p">{</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-3"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-4"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-5"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PCI_UP_BASE</span><span class="p">:</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-6"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">up</span><span class="p">;</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">legacy_piix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-8"></a><span class="w">            </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-10"></a><span class="w">        </span><span class="n">trace_acpi_pci_up_read</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-11"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-12"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PCI_DOWN_BASE</span><span class="p">:</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-13"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">down</span><span class="p">;</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-14"></a><span class="w">        </span><span class="n">trace_acpi_pci_down_read</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-15"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-17"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>因此在 <code>PCNT</code> 函数中，读取 <code>PCIU</code> 和 <code>PCID</code> 就可以知道一个 Bitmap，记录了哪些设备出现了变化。最后一步就是通知操作系统了。在 ACPI 中，可以调用 <code>Notify</code> 函数，用于通知操作系统，通知的参数见 Table 5.187，这里列出来前面几种：</p>
<ul>
<li>0: Bus Check, This notification is performed on a device object to indicate to OSPM that it needs to perform a Plug and Play re-enumeration operation on the device tree starting from the point where it has been notified</li>
<li>1: Device Check, Used to notify OSPM that the device either appeared or disappeared. If the device has appeared, OSPM will re-enumerate from the parent.</li>
<li>2: Device Wake, Used to notify OSPM that the device has signaled its wake event, and that OSPM needs to notify OSPM native device driver for the device.</li>
<li>3: Eject Request, Used to notify OSPM that the device should be ejected, and that OSPM needs to perform the Plug and Play ejection operation.</li>
</ul>
<p><code>PCNT</code> 函数调用 <code>DVNT</code> 函数来进行最终的 <code>Notify</code>，对于 PCI Up，需要发送 1(Device Check) 让操作系统新的设备出现；对于 PCI Down，需要发送 3(Eject Request) 让操作系统弹出设备。这就解释了 <code>PCNT</code> 为什么要这样实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-1"></a><span class="c1">// PCIe Notify</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-2"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">PCNT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-3"></a><span class="p">{</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-4"></a><span class="w">    </span><span class="n">BNUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zero</span><span class="w"> </span><span class="c1">// Bus Num = 0</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-5"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCIU</span><span class="p">,</span><span class="w"> </span><span class="n">One</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify(1=Device Check)</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-6"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify(3=Eject Request)</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-7"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>DVNT</code> 的实现方法很粗暴，就是检查各个位，然后发送 <code>Notify</code> 到相应的 PCIe Slot 上：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-1"></a><span class="c1">// Device Notify</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-2"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">DVNT</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-3"></a><span class="p">{</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-4"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x08</span><span class="p">))</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-6"></a><span class="w">        </span><span class="n">Notify</span><span class="w"> </span><span class="p">(</span><span class="n">S18</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">)</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-8"></a>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-9"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">))</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-10"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-11"></a><span class="w">        </span><span class="n">Notify</span><span class="w"> </span><span class="p">(</span><span class="n">S20</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">)</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-13"></a>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-14"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">))</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-15"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-16"></a><span class="w">        </span><span class="n">Notify</span><span class="w"> </span><span class="p">(</span><span class="n">S28</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">)</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-18"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-19"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就完成了整个 PCIe Hot Plug 的过程。回顾一下：</p>
<ul>
<li>QEMU 要进行 PCIe Hot Plug</li>
<li>QEMU 记录要 Hot Plug 设备到数组中</li>
<li>QEMU 发送 GPE</li>
<li>OS 执行 GPE 1 Handler</li>
<li>Handler 读取 PCIU/PCID，根据 Bitmap 去 Notify</li>
<li>OS 根据 Notify 的设备进行对应的操作</li>
</ul>
<p>可以看到，大部分的工作其实是 QEMU 完成的，OS 只需要在收到 SCI 的时候，判断是 GPE 1 事件，执行对应的处理函数，等待 Notify 的到来。</p>
<h3 id="power-state"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#power-state">Power State</a></h3>
<p>ACPI 定义的 Power State：</p>
<p><img alt="" src="/images/acpi_power.png" /></p>
<ul>
<li>G0-G3: 全局状态，G0 表示正在工作</li>
<li>S0-S5：睡眠状态，S0 表示正在工作，S5 表示关机</li>
<li>D0-D3：设备状态</li>
<li>C0-Cn：CPU 状态</li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/12/10/acpi-notes/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-12-06 00:00:00">2022年12月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="infiniband"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/">InfiniBand 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/networking/infiniband.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#_1">参考文献</a></h3>
<ul>
<li><a href="https://www.snia.org/sites/default/files/files2/files2/SDC2013/presentations/Hardware/DavidDeming_Infiniband_Architectural_Overview.pdf">Infiniband Architecture Overview</a></li>
<li><a href="https://www.afs.enea.it/asantoro/V1r1_2_1.Release_12062007.pdf">InfiniBand Architecture Specification Volume 1 Release 1.2.1</a></li>
<li><a href="https://cw.infinibandta.org/document/dl/8566">InfiniBand Architecture Specification Volume 2 Release 1.4</a></li>
<li><a href="https://cali-doc.unilim.fr/_media/mpi/intel-mpi/infinibandchap42.pdf">An Introduction to the InfiniBand Architecture</a></li>
<li>InfiniBand Network Architecture - MindShare</li>
<li><a href="https://wiki.archlinux.org/title/InfiniBand">ArchWiki - InfiniBand</a></li>
</ul>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#_2">概览</a></h3>
<p>InfiniBand 的网络分为两层，第一层是由 End Node 和 Switch 组成的 Subnet，第二层是由 Router 连接起来的若干个 Subnet。有点类似以太网以及 IP 的关系，同一个二层内通过 MAC 地址转发，三层间通过 IP 地址转发。</p>
<p>在 IB 网络中，End Node 一般是插在结点上的 IB 卡（Host Channel Adapter，HCA）或者是存储结点上的 Target Channel Adapter。End Node 之间通过 Switch 连接成一个 Subnet，由 Subnet Manager 给每个 Node 和 Switch 分配 Local ID，同一个 Subnet 中通过 LID（Local ID）来路由。但是 LID 位数有限，为了进一步扩展，可以用 Router 连接多个 Subnet，此时要通过 GID（Global ID）来路由。</p>
<p><img alt="" src="/images/iba.png" /></p>
<p><img alt="" src="/images/ib_am.png" /></p>
<h3 id="queue-pair"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#queue-pair">Queue Pair</a></h3>
<p>回顾一下，以太网网卡在传输的时候，涉及到两类队列，分别用于发送和接收，由操作系统来负责维护。当要发送的时候，操作系统向发送队列上插入一项，并提供要发送的数据的指针，然后让网卡自己进行 DMA 并发送；同时，操作系统也会分配一些缓冲区，填入接收队列，当网卡接收到新的数据的时候，就会进行 DMA 把数据填入缓冲区，然后通过中断让操作系统去进行处理。</p>
<p>在 IB 中，也有类似的概念，就是 Queue Pair（QP），其实就是 Send Queue 和 Receive Queue 成对出现。另外还有 Completion Queue，当请求完成的时候，会在 CQ 上得到结果。</p>
<p><img alt="" src="/images/ib_qp.png" /></p>
<h3 id="transport-functions"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#transport-functions">Transport Functions</a></h3>
<p>有了 Queue Pair 以后，上层应用就可以进行一些操作了：</p>
<ul>
<li>SEND：发送数据</li>
<li>RESYNC：同步 PSN</li>
<li>RDMA WRITE：远程写入内存</li>
<li>RDMA READ：远程读取内存</li>
<li>ATOMIC：远程进行内存原子操作</li>
</ul>
<p>有发就有收，接收方需要在 Receive Queue 中准备好接受数据的缓冲区。</p>
<p>此外，为了在保证安全性以及正确性的前提下，允许 RDMA 操作，应用需要首先进行 Memory Binding 操作，标记哪些内存区域可以通过 RDMA 访问，并且生成一个 <code>R_KEY</code> 来标记这片内存区域。之后的 RDMA WRITE 和 RDMA READ 需要使用同样的 <code>R_KEY</code> 来进行访问。</p>
<h3 id="transport-services"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#transport-services">Transport Services</a></h3>
<p>IB 支持四种 Transport Service，当 QP 在创建的时候，就需要从以下的四种中选择：</p>
<ol>
<li>Reliable Connection(RC)</li>
<li>Reliable Datagram(RD)</li>
<li>Unreliable Datagram(UD)</li>
<li>Unreliable Connection(UC)</li>
</ol>
<p>对于 IPoIB 等传输其他协议的情况，也可以直接封装：</p>
<ol>
<li>Raw IPv6 Datagram</li>
<li>Raw Ethertype Datagram</li>
</ol>
<p>几种 Transport Service 的对比：</p>
<p><img alt="" src="/images/ib_comparison.png" /></p>
<p>在编程的时候，需要知道对端的 LID（Local ID）、QPN（Queue Pair Number）和 PSN（Packet Sequence Number），才能进行通信。如果要进行 RDMA，还需要知道 <code>R_Key</code> 和内存地址。这些信息一般是通过 TCP 来传输的。</p>
<h3 id="switches"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#switches">Switches</a></h3>
<p>在 IB 网络中，交换机用来连接同一个 IB Subnet 中的 End Node。在 Subnet 中，通过 Local ID 来路由，而 Local ID 是由 Subnet Manager 负责分配的。Subnet Manager 扫描网络中的交换机和节点，动态分配 LID，并且根据网络拓扑，计算出交换机的转发表。</p>
<p>交换机的转发表就是一个 LID 到端口号的映射，可以实现为线性表（数组，下标是 LID）或随机访问表（CAM，用 LID 查端口号）。</p>
<p>由于 LID 唯一确定了转发路径，所以如果网络有冗余，从一个 End Node 到另一个 End Node 有多条路径，那么为了利用上不同路径的带宽，每条路径都要分配一个 LID。为了简化，在分配的时候，Subnet Manager 会分配一段连续的 LID，具体来说，是 <code>2^{LMC}</code> 个，LMC 是 LID Mask Control，表示低多少位 Mask 掉属于同一个 Endpoint。例如 Base LID=4，LMC=2，那么实际上分配的 LID 是 <code>{4,5,6,7}</code>。</p>
<p>opensm 的 LID 分配算法可以在<a href="https://github.com/linux-rdma/opensm/blob/844ab3b7edaad983449b5d3a4a773088b8daa299/opensm/osm_lid_mgr.c#L290">代码</a>中找到。</p>
<p>LID 是一个 16 位的整数，所以同一个 Subnet 中可以连接的设备数量有限。更多的话就需要多个 Subnet。LID 定义：</p>
<ul>
<li>0x0000：Reserved</li>
<li>0xFFFF：Permissive，目标 QP0</li>
<li>0x0001-0xBFFF：Unicast</li>
<li>0xC000-0xFFFE：Multicast</li>
</ul>
<p>如果想要做隔离，可以创建一个 Partition，类似 VLAN 的概念，通过 <code>P_Key</code> 来判断是否属于同一个 Partition。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#_3">常用命令</a></h3>
<p>常用的可以用来调试 IB 的命令：</p>
<ul>
<li>ibstat</li>
<li>ibhosts</li>
<li>ibswitches</li>
<li>iblinkinfo</li>
<li>ibping</li>
<li>ibdiagnet</li>
<li>qperf</li>
</ul>
<p>使用 qperf/ib_send_lat 可以测量带宽和延迟。一个测试例子：</p>
<ul>
<li>以太网（udp_lat）：24.5 us</li>
<li>IPoIB (udp_lat): 8.7 us</li>
<li>IB (rc, ib_send_lat): 1.02 us</li>
<li>IB (rc_lat): 3.6 ~ 4.6 us</li>
<li>IB (uc_lat): 4.2 ~ 5.5 us</li>
<li>IB (ud_lat): 5.5 ~ 6.4 us</li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/12/06/infiniband-notes/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-11-23 00:00:00">2022年11月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="mellanox"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/">升级 Mellanox 网卡固件</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#_1">背景</a></h3>
<p>最近发现有一台机器，插上 ConnectX-4 IB 网卡后，内核模块可以识别到设备，但是无法使用，现象是 <code>ibstat</code> 等命令都看不到设备。降级 OFED 从 5.8 到 5.4 以后问题消失，所以认为可能是新的 OFED 与比较旧的固件版本有兼容性问题，所以尝试升级网卡固件。升级以后，问题就消失了。</p>
<h3 id="mft"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#mft">安装 MFT</a></h3>
<p>首先，在 https://network.nvidia.com/products/adapter-software/firmware-tools/ 下载 MFT，按照指示解压，安装后，启动 mst 服务，就可以使用 <code>mlxfwmanager</code> 得到网卡的型号以及固件版本：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-1"></a>Device Type: ConnectX4
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-2"></a>Description: Mellanox ConnectX-4 Single Port EDR PCIE Adapter LP
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-3"></a>PSID:        DEL2180110032
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-4"></a>Versions:    Current
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-5"></a>  FW         12.20.1820
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#_2">升级固件</a></h3>
<p>从 PSID 可以看到，这是 DELL OEM 版本的网卡，可以在 https://network.nvidia.com/support/firmware/dell/ 处寻找最新固件，注意需要保证 PSID 一致，可以找到这个 PSID 的 DELL 固件地址：https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_4512-06W1HY_0JJN39_Ax-FlexBoot-3.6.203.bin.zip。</p>
<p>下载以后，解压，然后就可以升级固件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-1-1"></a>mlxfwmanager<span class="w"> </span>-u<span class="w"> </span>-i<span class="w"> </span>fw-ConnectX4-rel-12_28_4512-06W1HY_0JJN39_Ax-FlexBoot-3.6.203.bin
</span></code></pre></div>
<p>升级以后重启就工作了。</p>
<p>考虑到类似的情况之后还可能发生，顺便还升级了其他几台机器的网卡，下面是一个例子：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-1"></a>Device Type: ConnectX4
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-2"></a>Description: ConnectX-4 VPI adapter card; FDR IB (56Gb/s) and 40GbE; dual-port QSFP28; PCIe3.0 x8; ROHS R6
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-3"></a>PSID:        MT_2170110021
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-4"></a>Versions:    Current
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-5"></a>  FW         12.25.1020
</span></code></pre></div>
<p>注意这里的 PSID 是 MT_ 开头，说明是官方版本。这个型号可以在 https://network.nvidia.com/support/firmware/connectx4ib/ 找到最新的固件，注意 PSID 要正确，可以找到固件下载地址 https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2006-MCX454A-FCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip。用同样的方法更新即可。</p>
<p>还有一个 ConnectX-3 的例子：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-1"></a>Device Type: ConnectX3
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-2"></a>Description: ConnectX-3 VPI adapter card; single-port QSFP; FDR IB (56Gb/s) and 40GigE; PCIe3.0 x8 8GT/s; RoHS R6
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-3"></a>PSID:        MT_1100120019
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-4"></a>Versions:    Current
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-5"></a>  FW         2.36.5150
</span></code></pre></div>
<p>ConnectX-3 系列的网卡固件可以在 https://network.nvidia.com/support/firmware/connectx3ib/ 找，根据 PSID，可以找到固件下载地址是 http://www.mellanox.com/downloads/firmware/fw-ConnectX3-rel-2_42_5000-MCX353A-FCB_A2-A5-FlexBoot-3.4.752.bin.zip。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#_3">小结</a></h3>
<p>如果遇到 Mellanox 网卡能识别 PCIe，但是不能使用，可以考虑降级 OFED 或者升级网卡固件。</p>
<p>可以用 mlxfwmanager 查看 PSID 和更新固件。根据 PSID，判断是 OEM（DELL）版本还是官方版本。如果是 OEM 版本，要到对应 OEM 的固件下载地址找，例如 https://network.nvidia.com/support/firmware/dell/；如果是官方版，在 https://network.nvidia.com/support/firmware/firmware-downloads/ 找。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-11-20 00:00:00">2022年11月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cxl"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/">CXL 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/pcie.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#_1">背景</a></h3>
<p>前段时间学习了 PCIe，趁此机会，进一步学习一下密切相关的 CXL。</p>
<p>CXL 的标准是公开下载的：https://www.computeexpresslink.org/download-the-specification，我目前参考的是 2022 年 8 月 1 日的 CXL 3.0 版本。</p>
<h3 id="cxl_1"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxl_1">CXL 设备类型</a></h3>
<p>CXL 对 PCIe 的重要的扩展，一是在于让设备可以和 CPU 实现缓存一致性（CXL.cache），二是可以做远程的内存（CXL.mem）。</p>
<p>具体下来，CXL 标准主要定义了三类设备：</p>
<ul>
<li>CXL Type 1: 设备带有与 CPU 一致的缓存，实现 CXL.io 和 CXL.cache</li>
<li>CXL Type 2: 设备带有自己的内存和与 CPU 一致的缓存，实现 CXL.io，CXL.cache 和 CXL.mem</li>
<li>CXL Type 3: 设备带有自己的内存，实现 CXL.io 和 CXL.mem</li>
</ul>
<h3 id="cxl_2"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxl_2">CXL 传输层</a></h3>
<h4 id="cxlio"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxlio">CXL.io</a></h4>
<p>CXL.io 基本上就是 PCIe 协议：</p>
<div class="language-text highlight"><pre><span></span><code>CXL.io provides a non-coherent load/store interface for I/O devices. Figure
3-1 shows where the CXL.io transaction layer exists in the Flex Bus layered
hierarchy. Transaction types, transaction packet formatting, credit-based
flow control, virtual channel management, and transaction ordering rules
follow the PCIe* definition; please refer to the “Transaction Layer
Specification” chapter of PCIe Base Specification for details. This chapter
highlights notable PCIe operational modes or features that are used for
CXL.io.
</code></pre></div>
<p>CXL 3.0 速度是 64.0 GT/s，使用 PAM4 编码，对应的是 PCIe 6.0。</p>
<h4 id="cxlcache"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxlcache">CXL.cache</a></h4>
<p>CXL.cache 每个方向上有三个 channel：请求，响应和数据。考虑到 Host 和 Device 的传输方向，就是六个 channel：D2H Req，D2H Resp，D2H Data，H2D Req，H2D Resp，H2D Data。在 Data channel 上传输的缓存行大小是 64 字节。</p>
<p>CXL.cache 的缓存行状态采用的是 MESI。</p>
<p>CXL.cache 传输有三种模式：68B Flit，256B Flit 和 PBR Flit。</p>
<p>H2D Request 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li><code>Address[51:6]</code>: 物理地址</li>
<li>UQID: Unique Queue ID</li>
<li>CacheID: Only in 256B Flit</li>
<li>SPID/DPID: Only in PBR Flit</li>
</ul>
<p>D2H Response 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li>UQID: Unique Queue ID</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<p>D2H Data 的字段：</p>
<ul>
<li>Valid</li>
<li>UQID: Unique Queue ID</li>
<li>ChunkValid: Only in 68B Flit</li>
<li>Bogus</li>
<li>Poison: data is corrupted</li>
<li>BEP: Only in 256B Flit &amp; PBR Flit</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<p>D2H Request 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li>CQID: Command Queue ID</li>
<li>NT: Non Temporal</li>
<li>CacheID: Only in 256B Flit</li>
<li>Address: 46 位物理地址</li>
<li>SPID/DPID: Only in PBR Flit</li>
</ul>
<p>H2D Response 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li>RspData</li>
<li>RSP_PRE</li>
<li>CQID: Command Queue ID</li>
<li>CacheID: Only in 256B Flit</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<p>H2D Data 的字段：</p>
<ul>
<li>Valid</li>
<li>CQID: Command Queue ID</li>
<li>ChunkValid: Only in 68B Flit</li>
<li>Bogus</li>
<li>GO-Err</li>
<li>CacheID: Only in 256B Flit</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<h5 id="_2"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#_2">请求类型</a></h5>
<p>首先考虑 Host 会发送的请求。</p>
<p>第一种是 SnpData，例如在 Host 在读取的时候出现缺失，此时需要向 Device 发送 Snoop，获取最新的 Dirty 的 Data，或者让 Device 的缓存行降级为 Shared 状态。</p>
<p>Device 收到 SnpData 后，如果发现缓存行不在缓存中（状态是 I），会回复一个 RspIHitI；如果缓存行在缓存中且数据没有修改（状态是 S 或者 E），降级到 S，会回复一个 RspSHitSE；如果缓存行是 dirty（状态是 M），可以选择降级到 S，然后回复 RspSFwdM 以及缓存行的数据，也可以选择变成 Invalid，回复 RspIFwdM 以及缓存行的数据。</p>
<p>可以看到，这些 D2H Response 的 Opcode 的名字格式很有规律，<code>Rsp+A+Hit/Fwd+B</code>，A 表示新的缓存行状态，B 是原来的缓存行状态，Hit 不附带数据，Fwd 附带数据。</p>
<p>第二种是 SnpInv，例如 Host 要写入缓存，就要 invalidate 其他缓存。Device 收到以后，可能返回 RspIHitI、RspIHitSE 和 RspIFwdM，分别对应不同的初始状态，最终都是 Invalid 态。</p>
<p>第三种是 SnpCur，获取当前的缓存行状态。Device 可以修改缓存行状态，但是不建议。可能的返回有 RspIHitI，RspVHitV，RspSHitSE，RspSFwdM，RspIFwdM 和 RspVFwdV。这里的 V 表示 Valid，对应 MESI 中的 MES 三种状态。所以如果缓存行状态不变的话，就是 RspIHitI，RspVHitV 和 RspVFwdV 三种响应。</p>
<p>再考虑 Device 会发送的请求。首先，请求可以分为四类：</p>
<ol>
<li>Read：发送 D2H Request，接收 H2D Response 和 H2D Data</li>
<li>Read0：发送 D2H Request，接收 H2D Response</li>
<li>Write：发送 D2H Request，接收 H2D Response，发送 D2H Data，可选接收 H2D Response</li>
<li>
<p>Read0-Write：发送 D2H Request，接收 H2D Response，发送 D2H Data</p>
</li>
<li>
<p>RdCurr(Read)，Device 读取 Host 的缓存行，不造成任何的缓存状态的修改。Device 缓存还是处于 Invalid 状态。</p>
</li>
<li>RdOwn(Read)，Device 读取 Host 的缓存行，可以进入 E 态或者 M 态。Host 响应 GO-Err/GO-I/GO-E/GO-M。</li>
<li>RdShared(Read)，Device 读取 Host 的缓存行，进入 S 态。Host 响应 GO-Err/GO-I/GO-S。</li>
<li>RdAny(Read)，Device 读取 Host 的缓存行，进入 M 态，E 态或 S 态。Host 响应 GO-Err/GO-I/GO-S/GO-E/GO-M。</li>
<li>RdOwnNoData(Read0)，Device 不读取现在缓存行的数据，进入 E 态。一般用于整个缓存行的数据都要更新的情况，所以不需要或许当前缓存行的数据。</li>
<li>ItoMWr(Read0-Write)，Device 写入新的完整缓存行到 Host 中，并且进入 M 态。Host 响应 GO_WritePull/GO_ERR_WritePull。</li>
<li>WrCur(Read0-Write)，和 ItoMWr 基本一样，区别在于，如果缓存行命中了，就写入到缓存中；如果缺失了，就写入到内存中。Host 响应 GO_WritePull/GO_ERR_WritePull。</li>
<li>CLFlush(Read0)，要求 Host Invalidate 一个缓存行。Host 响应 GO-Err/GO-I。</li>
<li>CleanEvict(Write)，Device 要 Evict 一个 Exclusive 的缓存行。Host 响应 GO_WritePull/GO_WritePull_Drop。</li>
<li>DirtyEvict(Write)，Device 要 Evict 一个 Modified 的缓存行。Host 响应 GO_WritePull/GO_ERR_WritePull。</li>
<li>CleanEvictNoData(Write)，Device 要 Evict 一个 Exclusive 的缓存行，但是不传输数据，只用于更新 Snoop Filter。Host 响应 GO-I。</li>
<li>WrInv(Write)，Write Invalidate Line，向 Host 写入 0-64 字节的数据，并且 Invalidate 缓存。Host 响应 WritePull/GO-Err/GO-I。</li>
<li>WOWrInv(Write)，Weakly Ordered 版本的 WrInV，写入 0-63 字节的数据。Host 响应 ExtCmp/FastGO_WritePull/GO_ERR_WritePull。</li>
<li>WOWrInvF(Write)，Weakly Ordered 版本的 WrInv，写入 64 字节的数据。Host 响应 ExtCmp/FastGO_WritePull/GO_ERR_WritePull。</li>
<li>CacheFlushed(Read0)，告诉 Host 自己的缓存都被清空了，所有缓存行都在 I 状态。Host 响应 GO-I。</li>
</ol>
<h5 id="_3"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#_3">和其他协议的对比</a></h5>
<p>之前在 <a href="tilelink.md/#tilelink-cached">TileLink 总线协议分析</a> 分析过 TileLink 的缓存一致性实现方法，如果某一个缓存（Master A）出现了缺失，需要经过如下的过程：</p>
<ul>
<li>Master A -&gt; Slave: Acquire</li>
<li>Slave -&gt; Master B: Probe</li>
<li>Master B -&gt; Slave: ProbeAck</li>
<li>Slave -&gt; Master A: Grant</li>
<li>Master A -&gt; Slave: GrantAck</li>
</ul>
<p>在 TileLink Cached 里面，所有的 Master 都是平等的。而在 CXL 中，需要维护缓存一致性的，有 CPU 内部的各个缓存之间，还有 CPU 和设备之间。而 CXL.cache 主要负责的是与设备的缓存一致性部分，维护缓存一致性的核心是在 CPU 一侧，Host 相当于 TileLink 的 Slave，Device 相当于 TileLink 的 Master A。可以说 CXL.cache 是不对称的缓存一致性协议。</p>
<p>另一个相关的协议是 <a href="../../hardware/2022/05/16/ace/">ACE 缓存一致性协议</a>，和 TileLink 类似。</p>
<p>例如 CXL 中设备读取缓存的时候，出现了缺失，那么需要经过如下的过程：</p>
<ul>
<li>Device -&gt; Host: RdShared/RdOwn</li>
<li>Host -&gt; CPU Caches: Custom Snoop Messages</li>
<li>Host -&gt; Other CXL Device: SnpData</li>
<li>Other CXL Device -&gt; Host: RspSHitSE/RspSFwdM</li>
<li>Host -&gt; Device: GO-S</li>
</ul>
<p>可以看到，整体的流程也是差不多的。</p>
<h4 id="cxlmem"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxlmem">CXL.mem</a></h4>
<p>CXL.mem 用于扩展内存，根据类型的不同，它可能单独使用，也可能和 CXL.cache 配合使用。具体来说，有三种一致性模型：</p>
<ol>
<li>HDM-H(Host-only Coherent)：仅 Type 3 设备，也就是无 CXL.cache</li>
<li>HDM-D(Device Coherent)：仅 Legacy Type 2 设备，也就是有 CXL.cache</li>
<li>HDM-DB(Device Coherent using Back-Invalidation)：Type 2 或 Type 3 设备</li>
</ol>
<p>在 CXL.cache 中，两端是 Host 和 Device；而 CXL.mem，两端是 Master 和 Subordinate。</p>
<p>从 Master 到 Subordinate 的消息（M2S）有三类：</p>
<ol>
<li>Request(Req)</li>
<li>Request with Data(RwD)</li>
<li>Back-Invalidation Response(BIRsp)</li>
</ol>
<p>从 Subordinate 到 Master 的消息（S2M）有三类：</p>
<ol>
<li>Response without data(NDR, No Data Response)</li>
<li>Response with Data(DRS, Data Response)</li>
<li>Back-Invalidation Snoop(BiSnp)</li>
</ol>
<p>其中比较特别的是 Back-Invalidation，这个的目的是让 Device 可以通过 Snoop 修改 Host 中缓存了 Device 内存中的数据的缓存行。</p>
<p>对于 Type 3 的设备（无 CXL.cache）来说，Device 就是一个扩展的内存，比较简单，只需要支持读写内存就可以了。Host 发送 <code>MemRd*</code>，Device 响应 MemData；Host 发送 <code>MemWr*</code>，Device 响应 Cmp。</p>
<p>对于 Type 2 的设备（有 CXL.cache）来说，Device 既有自己的缓存，又有自己的内存，所以这时候就比较复杂了。例如 Host 在读取数据的时候（MemRd，SnpData/SnpInv/SnpCur），还需要对 Device Cache 进行 Snoop（SnpData/SnpInv/SnpCur），保证缓存的一致性。Host 想要写入数据到 Device Memory 的时候，如果此时 Device Cache 中有 Dirty 数据，需要进行写合并，再把合并后的数据写入到 Device Memory。当 Device 想要从自己的缓存读取数据，又缺失的时候，首先需要判断数据在 Host 端的缓存中，还是在 Device Memory 中，不同的偏置（Bias）模式决定了数据应该放在 Host 还是 Device 的缓存上。Device 要写入数据的时候，如果 Host 中缓存了该缓存行，则需要 Back-Invalidation。为了支持这些场景，CXL.cache 和 CXL.mem 会比较复杂。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2022/11/20/cxl-notes/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-11-12 00:00:00">2022年11月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 20 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="pcie"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/">PCIe 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/pcie.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_1">背景</a></h3>
<p>最近在知乎上看到 <a href="https://www.zhihu.com/people/ljgibbs">LogicJitterGibbs</a> 的 <a href="https://zhuanlan.zhihu.com/p/447134701">资料整理：可以学习 1W 小时的 PCIe</a>，我跟着资料学习了一下，然后在这里记录一些我学习 PCIe 的笔记。</p>
<p>下面的图片主要来自 PCIe 3.0 标准以及 MindShare 的 PCIe 3.0 书本。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_2">分层</a></h3>
<p>PCIe 定义了三个层：Transaction Layer，Data Link Layer，Physical Layer，和 TCP/IP 四层模型很像。PCIe 也是基于 Packet 传输的。</p>
<p><img alt="" src="/images/pcie_layer.png" /></p>
<h4 id="transaction-layer"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#transaction-layer">Transaction Layer</a></h4>
<p>Transaction Layer 的核心是 Transaction Layer Packet(TLP)。TLP 格式：</p>
<p><img alt="" src="/images/pcie_tlp.png" /></p>
<p>即可选的若干个 Prefix，一个 Header，可选的 Data Payload，可选的 Digest。</p>
<p>Prefix 和 Header 开头的一个字节是 <code>Fmt[2:0]</code> 和 <code>Type[4:0]</code> 字段。Fmt 决定了 header 的长度，有无数据，或者这是一个 Prefix。</p>
<p>它支持几类 Packet：</p>
<ul>
<li>Memory: MMIO<ul>
<li>Read Request(MRd)/Completion(CplD)</li>
<li>Write Request(MWr): 注意只有 Request，没有 Completion</li>
<li>AtomicOp Request(FetchAdd/Swap/CAS)/Completion(CplD)</li>
<li>Locked Memory Read(MRdLk)/Completion(CplDLk): Legacy</li>
</ul>
</li>
<li>IO: Legacy<ul>
<li>Read Request(IORd)/Completion(CplD)</li>
<li>Write Request(IOWr)/Completion(Cpl)</li>
</ul>
</li>
<li>Configuration: 访问配置空间<ul>
<li>Read Request(CfgRd0/CfgRd1)/Completion(CplD)</li>
<li>Write Request(CfgWr0/CfgWr1)/Completion(Cpl)</li>
</ul>
</li>
<li>Message: 传输 event<ul>
<li>Request(Msg/MsgD)</li>
</ul>
</li>
</ul>
<p>括号里的是 TLP Type，对应了它 Fmt 和 Type 字段的取值。如果 Completion 失败了，原来应该是 CplD/CplDLk 的 Completion 会变成不带数据的 Cpl/CplLk。</p>
<p>在 PCIe 3.0 标准的表 2-3 中列出了 TLP Type 以及对应的 Fmt 和 Type 编码。</p>
<p>TLP 路由有三个方法，决定了这个 TLP 目的地是哪里：</p>
<ul>
<li>Address-based: 32 位或 64 位地址，用于 Memory 和 IO 请求</li>
<li>ID-based：lspci 看到的地址，也就是 Bus Device Function，用于 Configuration 请求</li>
<li>Implicit：用于 Message 请求，路由方法：<ul>
<li>Routed to Root Complex</li>
<li>Routed by Address: PCIe 3.0 标准中没有用这个路由方法的 Message</li>
<li>Routed by ID</li>
<li>Broadcast from Root Complex</li>
<li>Local - Terminate at Receiver</li>
<li>Gathered and router to Root Complex</li>
</ul>
</li>
</ul>
<h4 id="data-link-layer"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#data-link-layer">Data Link Layer</a></h4>
<p>Data Link Layer 的主要功能是进行 TLP 的可靠传输。它在传输 TLP 的时候，会在开头加上一个两字节的 Sequence Number，最后加上一个四字节的 LCRC（Link CRC）。</p>
<p><img alt="" src="/images/pcie_tlp_link.png" /></p>
<p>除了传输 TLP，Data Link Layer 还会传输 Data Link Layer Packet(DLLP)，类型包括：</p>
<ul>
<li>Ack DLLP: 告诉对方自己已经成功收到了 TLP</li>
<li>Nak DLLP：告诉对方自己接收 TLP 失败，请重试</li>
<li>InitFC1/InitFC2/UpdateFC DLLPs：流量控制</li>
<li>PM_Enter_L1/PM_Enter_L23/PM_Active_State_Request_L1/PM_Request_Ack：用于电源管理</li>
</ul>
<p>Data Link Layer 收到上层要发送 TLP 时候，首先拼接 Sequence Number 和 LCRC，然后会保存在 retry buffer 中，通过 Physical Layer 发送。从 Physical Layer 收到新的 TLP/DLLP 时，会检查它的完整性（CRC），如果正确，就向发送方发送一个 Ack DLLP，并把 TLP 提交给 Transaction Layer；如果不正确，就向发送方发送一个 Nak DLLP。如果收到了 Ack DLLP，就可以把相应的 TLP 从 retry buffer 中删掉；如果收到了 Nak DLLP，则要重传。这样就实现了 TLP 的可靠传输。</p>
<p>需要注意的是，TLP 和 DLLP 的区别：TLP 就像 IP，目的地址可能会跨越多跳；而 DLLP 是点对点地工作，所以一个 TLP 在转发的每一跳中，接受方都会发送一次 Ack DLLP。</p>
<p>Data Link Layer 的流量是 Credit-based 的：接受方会告诉发送方自己的 Buffer 还有多少空间（Credit），然后发送方根据 Credit 来控制是否继续发送 TLP。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_3">配置</a></h3>
<p>接触 PCIe 的时候可能会有一个疑惑，就是这些 Bus Device Function 都是怎么分配的，分配完之后，访问请求又是怎么路由的。</p>
<h4 id="_4"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_4">路由</a></h4>
<p>首先回顾一下，上面提到了 TLP 的 Memory 和 IO 是根据地址路由，Configuration 是根据 Bus Device Function 路由，而 PCIe 大概是一个树形的结构，叶子结点就是 PCIe 设备，非叶子结点是桥或者交换机。回想一下，IP 的路由是按照最长前缀匹配，如果在 PCIe 中还这样做的话，又太过于复杂了，毕竟 PCIe 可以人为地设定每个设备的地址，让地址满足一定的连续性和局部性，这样路由选择就非常简单了。</p>
<p>观察 PCIe 标准中 7.3.3 Configuration Request Routing Rules，结合 MindShare 的书，看 Root Ports，Switches 和 Bridges 的要求，就知道 Configuration 请求是如何路由的：</p>
<ul>
<li>Configuration 请求只能由 Host Bridge 发起</li>
<li>如果 Configuration 请求是 Type0，那么这个请求的目的设备就是当前设备</li>
<li>如果 Configuration 请求是 Type1，<ul>
<li>如果请求的 Bus Number 等于某一个 Downstream Port 的 Secondary Bus Number，则把 Configuration 请求转换为 Type0，然后发给该 Downstream Port</li>
<li>如果不等于，但是 Bus Number 属于某一个 Downstream Port 的 Secondary Bus Number 和 Subordinate Bus Number 之间，则不修改 Configuration 请求，发送给该 Downstream Port。</li>
</ul>
</li>
</ul>
<p>如果类比一下 IP，那么分组在中途路由器转发的时候就是 Type1，Type0 就是最后一跳。路由就是直接按照几个不重合的 Bus Number 区间进行判断，没有复杂的最长前缀匹配。但是又有一个问题，如果按照 Bus 路由，那同一个 Bus 下不同的 Device 咋办？这就像是以太网，最后一跳的时候，如果同一个链路上有多个设备，那么多个设备都能收到，每个设备根据自己的 Device 号判断是否是发给自己的。PCI（注意不是 PCIe）总线也类似。随着速度越来越高，通过交换机，以太网已经变成了点对点，所以很少见到一个链路上同时有多个设备的情况了。PCIe 也一样，所以根据 Bus 路由就足够了。至于 lspci 看到的那些 Device 不等于 0 的设备，要么是兼容 PCI 设备的，要么是虚拟的，在设备内部进行路由的，并不是真的有一个 PCIe link 连了多个物理设备。</p>
<p>所以简单理解一下，PCI 总线确实是一条总线，一条总线上很多设备。而 PCIe 实际上是一个网络，可以看作是很多个 PCI 总线连接在一起，可以把 Root Complex 或者 Switch 内部看成一个虚拟的有很多设备的 PCI 总线，而 PCIe Link 可以看成是只有一个设备的 PCI 总线。这样 PCIe 交换机可以看成若干个 PCI-PCI Bridge：</p>
<p><img alt="" src="/images/pcie_bridge.png" /></p>
<p>还有 MindShare 书中的图 3-5:</p>
<p><img alt="" src="/images/pcie_system.png" /></p>
<p>可以看到，这里的每一个 Bus 就是一个 PCI 总线，既有内部的虚拟 PCI 总线（Bus 0/2/6），也有 PCIe Link 充当的 PCI 总线（Bus 1/3/4/5/7/8/9）。在虚拟的 PCI 总线里，比如 PCIe Switch，一个 Device 对应一个 Downstream Port；而 PCIe Link 对应的 PCI 总线上就只有一个 Device。然后 PCIe Switch 的每个 Upstream Port 和 Downstream Port 里会记录三个 Bus Number：Primary(Pri)，Secondary(Sec) 和 Subordinate(Sub)。Primary 指的就是它上游直接连接的 PCI 总线编号，Sec 指的是下游直接连接的 PCI 总线编号，Sub 指的是它下游的最大 PCI 总线编号。</p>
<p>这样，收到 Type1 的时候，Switch 按照各个 Downstream Port 的 Sec 和 Sub 进行判断，如果目标 Bus Number 等于 Sec，就转换为 Type0 发出去；如果大于 Sec，但是小于或等于 Sub，就原样发出去。可以看到，从 Host Bridge 到每个设备都可以通过这样的方式一路转发。</p>
<p>既然 BDF 是把 Bus 划分为多个区间来路由的，那么 Memory 和 IO 请求也类似地可以对地址进行划分，变成多个区间，然后用类似的方法进行路由。</p>
<p>这些用于路由的区间上下界，可以在各个端口的 Type1 Configuration Space 中找到：</p>
<p><img alt="" src="/images/pcie_type1.png" /></p>
<ul>
<li>路由 Type1 Configuration Request：Primary Bus Number, Secondary Bus Number, Subordinate Bus Number<ul>
<li><code>Request Bus Number == Secondary Bus Number</code>: Type1 -&gt; Type0</li>
<li><code>Secondary Bus Number &lt; Request Bus Number &lt;= Subordinate Bus Number</code>: Type1 -&gt; Type1</li>
</ul>
</li>
<li>路由 IO Request：<code>I/O Base &lt;= IO Address &lt;= I/O Limit</code></li>
<li>路由 Prefetchable Memory Request：<code>Prefetchable Memory Base &lt;= Memory Address &lt;= Prefetchable Memory Limit</code></li>
<li>路由 Non-Prefetchable Memory Request：<code>Memory Base &lt;= Memory Address &lt;= Memory Limit</code></li>
</ul>
<p>而具体到每一个设备上，设备会提供若干个 BAR（Base Address Register），在枚举设备的时候，会给 BAR 分配地址，然后把设备的地址进行合并，记录到 Switch 上的 Base 和 Limit，然后一直递归，一路更新到 Root Complex。这样，就完成了地址分配，以及请求的路由。</p>
<h4 id="_5"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_5">分配</a></h4>
<p>既然知道了 BDF 是如何路由的，那么接下来的问题是，怎么枚举设备和交换机，分配 Bus Number。这个事情在系统启动的时候会做（例如 UEFI），Linux 中也有相关的代码。下面就来对着 <a href="https://github.com/tianocore/edk2">edk2</a> 的源代码来看看它是怎么做的。</p>
<p>在 edk2 中，分配 Bus Number 的核心代码是 <code>PciScanBus</code> 函数：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-1"></a><span class="cm">/**</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-2"></a><span class="cm">  Scan pci bus and assign bus number to the given PCI bus system.</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-4"></a><span class="cm">  @param  Bridge           Bridge device instance.</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-5"></a><span class="cm">  @param  StartBusNumber   start point.</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-6"></a><span class="cm">  @param  SubBusNumber     Point to sub bus number.</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-7"></a><span class="cm">  @param  PaddedBusRange   Customized bus number.</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-9"></a><span class="cm">  @retval EFI_SUCCESS      Successfully scanned and assigned bus number.</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-10"></a><span class="cm">  @retval other            Some error occurred when scanning pci bus.</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-12"></a><span class="cm">  @note   Feature flag PcdPciBusHotplugDeviceSupport determine whether need support hotplug.</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-14"></a><span class="cm">**/</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-15"></a><span class="n">EFI_STATUS</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-16"></a><span class="nf">PciScanBus</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-17"></a><span class="w">  </span><span class="n">IN</span><span class="w"> </span><span class="n">PCI_IO_DEVICE</span><span class="w">  </span><span class="o">*</span><span class="n">Bridge</span><span class="p">,</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-18"></a><span class="w">  </span><span class="n">IN</span><span class="w"> </span><span class="n">UINT8</span><span class="w">          </span><span class="n">StartBusNumber</span><span class="p">,</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-19"></a><span class="w">  </span><span class="n">OUT</span><span class="w"> </span><span class="n">UINT8</span><span class="w">         </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">,</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-20"></a><span class="w">  </span><span class="n">OUT</span><span class="w"> </span><span class="n">UINT8</span><span class="w">         </span><span class="o">*</span><span class="n">PaddedBusRange</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-21"></a><span class="w">  </span><span class="p">);</span>
</span></code></pre></div>
<p>输入一个桥设备和初始的 Bus Number，输出 Subordinate Bus Number，也就是分配的最大的 Bus Number，以及 Padded Bus Range，例如如果要考虑热插拔的话，就需要预留一些 Bus Number。它在 <code>PciRootBridgeEnumerator</code> 函数中被调用，传入的是 RootBridgeDev。你可能也猜到了，这个函数可以递归调用，从 Root Bridge 开始往下，遇到新的桥设备的时候，就继续递归，然后根据下一层分配的 Bus Number 来计算上一层的 Subordinate Bus Number。</p>
<p><code>PciScanBus</code> 首先枚举当前桥设备下的所有 Device 和 Function，因为当前的桥设备已经被分配了 Bus Number，所以是可以访问它下面的 Device 和 Function 的。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Device</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PCI_MAX_DEVICE</span><span class="p">;</span><span class="w"> </span><span class="n">Device</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-2"></a><span class="w">  </span><span class="n">TempReservedBusNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-3"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Func</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PCI_MAX_FUNC</span><span class="p">;</span><span class="w"> </span><span class="n">Func</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-4"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-5"></a><span class="w">    </span><span class="c1">// Check to see whether a pci device is present</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-6"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-7"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-8"></a><span class="w">        </span><span class="n">PciDevicePresent</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">,</span><span class="w"> </span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">);</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-11"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-12"></a><span class="w">      </span><span class="c1">// go to next device if there is no Function 0</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-13"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-14"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-18"></a><span class="w">      </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-20"></a>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-21"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-22"></a><span class="w">    </span><span class="c1">// Get the PCI device information</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-23"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-24"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-25"></a><span class="w">        </span><span class="n">PciSearchDevice</span><span class="p">(</span><span class="n">Bridge</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">,</span><span class="w"> </span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PciDevice</span><span class="p">);</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-28"></a><span class="w">      </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-30"></a>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-31"></a><span class="w">    </span><span class="n">PciAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-32"></a>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_PCI_BRIDGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">IS_CARDBUS_BRIDGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-34"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-35"></a><span class="w">      </span><span class="c1">// For PPB</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-36"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-37"></a>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-38"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciAllocateBusNumber</span><span class="p">(</span><span class="n">Bridge</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-39"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-40"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-41"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-42"></a>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-43"></a><span class="w">      </span><span class="n">SecondBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">;</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-44"></a>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-45"></a><span class="w">      </span><span class="n">Register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UINT16</span><span class="p">)((</span><span class="n">SecondBus</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">UINT16</span><span class="p">)</span><span class="n">StartBusNumber</span><span class="p">);</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-46"></a><span class="w">      </span><span class="n">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-47"></a><span class="w">                                </span><span class="n">PCI_BRIDGE_PRIMARY_BUS_REGISTER_OFFSET</span><span class="p">);</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-48"></a>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-49"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciRootBridgeIo</span><span class="o">-&gt;</span><span class="n">Pci</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="n">EfiPciWidthUint16</span><span class="p">,</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-50"></a><span class="w">                                          </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Register</span><span class="p">);</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-51"></a>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-52"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-53"></a><span class="w">      </span><span class="c1">// If it is PPB, recursively search down this bridge</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-54"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-55"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_PCI_BRIDGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-56"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-57"></a><span class="w">        </span><span class="c1">// Temporarily initialize SubBusNumber to maximum bus number to ensure</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-58"></a><span class="w">        </span><span class="c1">// the PCI configuration transaction to go through any PPB</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-59"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-60"></a><span class="w">        </span><span class="n">Register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciGetMaxBusNumber</span><span class="p">(</span><span class="n">Bridge</span><span class="p">);</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-61"></a><span class="w">        </span><span class="n">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-62"></a><span class="w">                                  </span><span class="n">PCI_BRIDGE_SUBORDINATE_BUS_REGISTER_OFFSET</span><span class="p">);</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-63"></a><span class="w">        </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciRootBridgeIo</span><span class="o">-&gt;</span><span class="n">Pci</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="n">EfiPciWidthUint8</span><span class="p">,</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-64"></a><span class="w">                                            </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Register</span><span class="p">);</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-65"></a>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-66"></a><span class="w">        </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciScanBus</span><span class="p">(</span><span class="n">PciDevice</span><span class="p">,</span><span class="w"> </span><span class="n">SecondBus</span><span class="p">,</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedBusRange</span><span class="p">);</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-67"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-68"></a><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-69"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-70"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-71"></a>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-72"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-73"></a><span class="w">      </span><span class="c1">// Set the current maximum bus number under the PPB</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-74"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-75"></a><span class="w">      </span><span class="n">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-76"></a><span class="w">                                </span><span class="n">PCI_BRIDGE_SUBORDINATE_BUS_REGISTER_OFFSET</span><span class="p">);</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-77"></a>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-78"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciRootBridgeIo</span><span class="o">-&gt;</span><span class="n">Pci</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="n">EfiPciWidthUint8</span><span class="p">,</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-79"></a><span class="w">                                          </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-80"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-81"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-82"></a><span class="w">      </span><span class="c1">// It is device. Check PCI IOV for Bus reservation</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-83"></a><span class="w">      </span><span class="c1">// Go through each function, just reserve the MAX ReservedBusNum for one</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-84"></a><span class="w">      </span><span class="c1">// device</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-85"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-86"></a>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-87"></a><span class="w">      </span><span class="c1">// OMITTED</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-88"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-89"></a>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-90"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">IS_PCI_MULTI_FUNC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-91"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-92"></a><span class="w">      </span><span class="c1">// Skip sub functions, this is not a multi function device</span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-93"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-94"></a>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-95"></a><span class="w">      </span><span class="n">Func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCI_MAX_FUNC</span><span class="p">;</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-96"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-97"><a id="__codelineno-1-97" name="__codelineno-1-97" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-97"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-98"><a id="__codelineno-1-98" name="__codelineno-1-98" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-98"></a><span class="p">}</span>
</span></code></pre></div>
<p>从代码中去掉了一些热插拔相关的代码，简单来说，它的思路如下：</p>
<ol>
<li>枚举当前设备下的 Device 和 Function</li>
<li>如果找到了一个桥设备，为它分配一个新的 Bus Number<ol>
<li>设置这个新的桥设备的 Primary Bus Number 为 Start Bus Number（也就是上一级的 Secondary Bus Number），Secondary Bus 是新分配的 Bus Number，Subordinate Bus Number 是最大值</li>
<li>这样设置完成后，相当于所有的在 <code>[Secondary Bus Number, Max Bus Number]</code> 范围中的 Bus 请求都会路由到新的桥设备上</li>
<li>递归调用 PciScanBus，参数是新的桥设备，Start Bus Number 为新的 Secondary Bus Number</li>
<li>递归调用返回以后，新的桥设备下面所有的设备都分配到了自己的 Bus Number，这时候就可以知道准确的 Subordinate Bus Number 了，不再是刚才临时设置的 Max Bus Number，因此这时候再把准确的 Subordinate Bus Number 写入桥设备的 Subordinate Bus Number 中</li>
</ol>
</li>
<li>枚举完所有设备以后，返回目前递归分配得到的最大的 Bus Number</li>
</ol>
<p>这样整理出来一看，其实很清楚，这就是一个 DFS 算法，在搜索过程中，为了保证当前的结点可达，保证从 Root Bridge 到当前的结点路径上的 Bus Number 范围都是 <code>[Secondary Bus Number, Max Bus Number]</code>；当结点搜索完以后，再回溯，回溯的时候就知道了实际分配到多大的 Bus Number，这时候再填回 Subordinate Bus Number，最后保证这个树上每一层的 <code>[Secondary Bus Number, Subordinate Bus Number]</code> 区间不重合，且每个子结点的区间都包含于父结点的区间。</p>
<p>最后的结果，类似 MindShare 书中的这个图：</p>
<p><img alt="" src="/images/pcie_enum.png" /></p>
<p>为了支持 PCIe 热插拔，或者可能会动态产生新设备的 SR-IOV，代码中做了相应的预留：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FeaturePcdGet</span><span class="p">(</span><span class="n">PcdPciBusHotplugDeviceSupport</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-2"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-3"></a><span class="w">  </span><span class="c1">// If Hot Plug is supported,</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-4"></a><span class="w">  </span><span class="c1">// Get the bridge information</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-5"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-6"></a><span class="w">  </span><span class="n">BusPadding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-7"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gPciHotPlugInit</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsPciHotPlugBus</span><span class="p">(</span><span class="n">PciDevice</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-9"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-10"></a><span class="w">      </span><span class="c1">// If it is initialized, get the padded bus range</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-11"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-12"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gPciHotPlugInit</span><span class="o">-&gt;</span><span class="n">GetResourcePadding</span><span class="p">(</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-13"></a><span class="w">          </span><span class="n">gPciHotPlugInit</span><span class="p">,</span><span class="w"> </span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">DevicePath</span><span class="p">,</span><span class="w"> </span><span class="n">PciAddress</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">State</span><span class="p">,</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-14"></a><span class="w">          </span><span class="p">(</span><span class="n">VOID</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Descriptors</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Attributes</span><span class="p">);</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-16"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-18"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-20"></a><span class="w">      </span><span class="n">BusRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-21"></a><span class="w">      </span><span class="n">NextDescriptors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Descriptors</span><span class="p">;</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-22"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciGetBusRange</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NextDescriptors</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BusRange</span><span class="p">);</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-23"></a>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-24"></a><span class="w">      </span><span class="n">FreePool</span><span class="p">(</span><span class="n">Descriptors</span><span class="p">);</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-26"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-27"></a><span class="w">        </span><span class="n">BusPadding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-28"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EFI_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-29"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-30"></a><span class="w">        </span><span class="c1">// EFI_NOT_FOUND is not a real error. It indicates no bus number padding</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-31"></a><span class="w">        </span><span class="c1">// requested.</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-32"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-34"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-36"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-37"></a><span class="p">}</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-38"></a>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-39"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FeaturePcdGet</span><span class="p">(</span><span class="n">PcdPciBusHotplugDeviceSupport</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">BusPadding</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-40"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-41"></a><span class="w">  </span><span class="c1">// Ensure the device is enabled and initialized</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-42"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-43"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Attributes</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EfiPaddingPciRootBridge</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-44"></a><span class="w">      </span><span class="p">((</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">EFI_HPC_STATE_ENABLED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-45"></a><span class="w">      </span><span class="p">((</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">EFI_HPC_STATE_INITIALIZED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-46"></a><span class="w">    </span><span class="o">*</span><span class="n">PaddedBusRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UINT8</span><span class="p">)((</span><span class="n">UINT8</span><span class="p">)(</span><span class="n">BusRange</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">PaddedBusRange</span><span class="p">);</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-47"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-48"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-49"></a><span class="w">    </span><span class="c1">// Reserve the larger one between the actual occupied bus number and padded</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-50"></a><span class="w">    </span><span class="c1">// bus number</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-51"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-52"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciAllocateBusNumber</span><span class="p">(</span><span class="n">PciDevice</span><span class="p">,</span><span class="w"> </span><span class="n">SecondBus</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UINT8</span><span class="p">)(</span><span class="n">BusRange</span><span class="p">),</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-53"></a><span class="w">                                  </span><span class="o">&amp;</span><span class="n">PaddedSubBus</span><span class="p">);</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-54"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-55"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-56"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-57"></a>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-58"></a><span class="w">    </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX</span><span class="p">(</span><span class="n">PaddedSubBus</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-59"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-60"></a><span class="p">}</span>
</span></code></pre></div>
<p>SR-IOV:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-1"></a><span class="c1">//</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-2"></a><span class="c1">// It is device. Check PCI IOV for Bus reservation</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-3"></a><span class="c1">// Go through each function, just reserve the MAX ReservedBusNum for one device</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-4"></a><span class="c1">//</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PcdGetBool</span><span class="p">(</span><span class="n">PcdSrIovSupport</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">SrIovCapabilityOffset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TempReservedBusNum</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">ReservedBusNum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-7"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciAllocateBusNumber</span><span class="p">(</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-8"></a><span class="w">        </span><span class="n">PciDevice</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">,</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-9"></a><span class="w">        </span><span class="p">(</span><span class="n">UINT8</span><span class="p">)(</span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">ReservedBusNum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TempReservedBusNum</span><span class="p">),</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-11"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-14"></a><span class="w">    </span><span class="n">TempReservedBusNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">ReservedBusNum</span><span class="p">;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-17"></a><span class="w">      </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">DEBUG_INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PCI-IOV ScanBus - SubBusNumber - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-18"></a><span class="w">             </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">));</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-19"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-20"></a><span class="w">      </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">DEBUG_INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PCI-IOV ScanBus - SubBusNumber - 0x%x (Update)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-21"></a><span class="w">             </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">));</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-23"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>分配好 Bus 以后，就可以对所有设备进行 Configuration Request 了，后续的 Memory 和 IO 地址的分配和路由，也是类似地递归地进行分配，然后回溯的时候合并地址区间即可。</p>
<h3 id="_6"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_6">物理层</a></h3>
<p>物理层编码上，PCIe 1.0 和 2.0 采用的是 NRZ 8b/10b，PCIe 3.0 到 5.0 用的是 NRZ 128b/130b，最新的 PCIe 6.0 和 7.0 则换成了 PAM4 FLIT。可以计算出每一代 x16 Lane 情况下的最大数据带宽：</p>
<ul>
<li>PCIe 1.0: <code>2.5 * 8 / 10 * 16 = 32 Gb/s</code></li>
<li>PCIe 2.0: <code>5.0 * 8 / 10 * 16 = 64 Gb/s</code></li>
<li>PCIe 3.0: <code>8.0 * 128 / 130 * 16 = 126 Gb/s</code></li>
<li>PCIe 4.0: <code>16.0 * 128 / 130 * 16 = 252 Gb/s</code></li>
<li>PCIe 5.0: <code>32.0 * 128 / 130 * 16 = 504 Gb/s</code></li>
<li>PCIe 6.0: <code>64.0 * 16 = 1024 Gb/s</code>，如果考虑 FLIT 引入的开销，则是 <code>64.0 * 242 / 256 * 16 = 968 Gb/s</code></li>
<li>PCIe 7.0: <code>128.0 * 16 = 2048 Gb/s</code>，如果考虑 FLIT 引入的开销，则是 <code>128.0 * 242 / 256 * 16 = 1936 Gb/s</code></li>
</ul>
<h3 id="pcie-60"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#pcie-60">PCIe 6.0</a></h3>
<p>PCIe 6.0 引入了 PAM4 来替代原来的 NRZ，实现了波特率不变的情况下速度翻倍，并且不再使用 128b/130b，为了解决 PAM4 带来的更高的错误率，引入了 FEC，CRC 还有格雷码，以及新的 FLIT。</p>
<p>网上可以搜到关于 PCIe 的 PPT：https://pcisig.com/sites/default/files/files/PCIe%206.0%20Webinar_Final_.pdf 和 https://www.openfabrics.org/wp-content/uploads/2022-workshop/2022-workshop-presentations/206_DDasSharma.pdf，以及关于 FLIT 的博客：https://pcisig.com/blog/pcie%C2%AE-60-specification-webinar-qa-deeper-dive-flit-mode-pam4-and-forward-error-correction-fec</p>
<p>总结 FLIT 的要点：</p>
<ol>
<li>每个 FLIT 固定长度 256 字节，其中 236 字节传输 TLP，6 字节传输 DLLP，8 字节传输 CRC，6 字节传输 FEC。</li>
<li>接受方接受到 FLIT 后，会尝试进行 FEC 解码，并且尝试修复错误，再进行 CRC 校验。如果中途出现了错误，则会发送一个 NAK 给发送方。</li>
<li>一个 TLP 可能跨越多个 FLIT，一个 FLIT 可能包括多个 TLP，根据 TLP 大小而定。TLP 不需要对齐到 FLIT 的开头或者结尾。</li>
</ol>
<p>可以发现，FLIT 的 CRC 用了 8 个字节，不再需要原来 TLP 和 DLLP 中的 ECRC 和 LCRC。在之前的 PCIe 版本，TLP 的可选 Digest 是 4 个字节的 ECRC，TLP+DLLP 的 LCRC 是 4 字节。具体采用多少字节的 CRC，和目标的错误率，以及传输的字节数相关。</p>
<h3 id="ats"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#ats">ATS</a></h3>
<p>ATS（Address Translation Service）是在 PCIe 上给外设提供查询页表的方式，从而可以使用虚拟地址。标准可以在 https://composter.com.ua/documents/ats_r1.1_26Jan09.pdf 处下载，以及关于 ATS 的 PPT：https://composter.com.ua/documents/Address_Translation_Services.pdf。</p>
<p>它的整体工作方式如图：</p>
<p><img alt="" src="/images/pcie_ats.png" /></p>
<p>就是在 Root Complex 和 Memory 之间设置一个 Translation Agent，负责查表，也就是 Page Table Walker。它会接收来自 PCIe 设备的地址翻译请求，然后它获取到页表地址后，根据虚拟地址去查内存中的页表。TLB（在标准中叫做 Address Translation Cache，ATC）是实现在 PCIe 设备侧的，而不是统一的 TLB，也不是 CPU 核心的 TLB。</p>
<p>为了支持 ATS，需要支持如下的操作：</p>
<ol>
<li>PCIe Device 向 Translation Agent 发送 Translation Request；Translation Agent 向 PCIe Device 回复 Translation Completion；</li>
<li>当页表出现变化的时候，需要通知 PCIe 设备端的 TLB，因此需要向 PCIe 设备发送 Invalidate Request Message；PCIe 设备完成 TLB 刷新后，回复一个 Invalidate Complete Message。</li>
</ol>
<p>ATS 标准还定义了一个可选功能，就是 Page Request Interface（PRI），其实就是缺页的时候，设备可以去发送 Page Request，要求操作系统去分配一个物理页。这就像用户程序里 mmap 一个匿名的页，一开始是没有分配的，直到第一次访问的时候，出现缺页异常，然后 OS 分配一个物理页，再更新页表。这样的好处是用于 DMA 的物理页也可以 Swap 或者延迟分配。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2022/11/12/pcie-notes/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-10-29 00:00:00">2022年10月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ppc64le-linux-nix"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/">在 ppc64le Linux 上运行 Nix</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_1">背景</a></h3>
<p>之前尝试过在 ppc64le 的机器上运行 Nix，当时的尝试是把代码克隆下来编译，我还写了一个 Docker 脚本：</p>
<div class="language-docker highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-1"></a><span class="c">## Based on https://github.com/NixOS/nix/issues/6048</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-2"></a><span class="c">## Build nixos/nix from source</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-3"></a><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:20.04</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-5"></a><span class="k">RUN</span><span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g&#39;</span><span class="w"> </span>/etc/apt/sources.list
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-6"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-7"></a><span class="k">RUN</span><span class="w"> </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-8"></a><span class="w">    </span>autoconf-archive<span class="w"> </span>autoconf<span class="w"> </span>automake<span class="w"> </span>pkg-config<span class="w"> </span>build-essential<span class="w"> </span>git<span class="w"> </span>gcc<span class="w"> </span>g++<span class="w"> </span>jq<span class="w"> </span>libboost-all-dev<span class="w"> </span>libcrypto++-dev<span class="w"> </span>libcurl4-openssl-dev<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-9"></a><span class="w">    </span>libssh-dev<span class="w"> </span>libarchive-dev<span class="w"> </span>libsqlite3-dev<span class="w"> </span>libbz2-dev<span class="w"> </span>wget<span class="w"> </span>liblzma-dev<span class="w"> </span>libbrotli-dev<span class="w"> </span>libseccomp-dev<span class="w"> </span>bison<span class="w"> </span>flex<span class="w"> </span>libsodium-dev<span class="w"> </span>libgc-dev<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-10"></a><span class="w">    </span>libgtest-dev<span class="w"> </span>libgmock-dev<span class="w"> </span>cmake<span class="w"> </span>unzip
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-12"></a><span class="c">## Install editline - newer version required</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-13"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-14"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/troglobit/editline/releases/download/1.17.1/editline-1.17.1.tar.xz
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-15"></a><span class="k">RUN</span><span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>editline-1.17.1.tar.xz
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-16"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/editline-1.17.1</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-17"></a><span class="k">RUN</span><span class="w"> </span>./configure<span class="w"> </span>--prefix<span class="o">=</span>/usr
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-18"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>all
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-19"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-21"></a><span class="c">## Install lowdown - not available via apt</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-22"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-23"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/kristapsdz/lowdown/archive/refs/tags/VERSION_0_10_0.tar.gz
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-24"></a><span class="k">RUN</span><span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>VERSION_0_10_0.tar.gz
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-25"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/lowdown-VERSION_0_10_0</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-26"></a><span class="k">RUN</span><span class="w"> </span>./configure
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-27"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>all
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-28"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install<span class="w">  </span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-30"></a><span class="c">## Install nlohmann_json - newer version required</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-31"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-32"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/nlohmann/json/archive/refs/tags/v3.10.5.tar.gz
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-33"></a><span class="k">RUN</span><span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>v3.10.5.tar.gz
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-34"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/json-3.10.5</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-35"></a><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>build
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-36"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/json-3.10.5/build</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-37"></a><span class="k">RUN</span><span class="w"> </span>cmake<span class="w"> </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-38"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-39"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-40"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/nlohmann/json/releases/download/v3.10.5/include.zip<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>unzip<span class="w"> </span>include.zip
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-41"></a><span class="k">RUN</span><span class="w"> </span>mv<span class="w"> </span>include/nlohmann/*<span class="w"> </span>/usr/local/include/nlohmann/
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-42"></a>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-43"></a><span class="c">## Compile &amp; build nix</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-44"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-45"></a><span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span><span class="m">2</span>.8.1<span class="w"> </span>https://github.com/NixOS/nix.git
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-46"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/nix</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-47"></a><span class="k">RUN</span><span class="w"> </span>./bootstrap.sh
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-48"></a><span class="k">RUN</span><span class="w"> </span>./configure
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-49"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-50"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install<span class="w"> </span>-k<span class="w"> </span><span class="o">||</span><span class="w"> </span>true
</span></code></pre></div>
<p>但是发现问题在于，离开了 nix install 脚本，我并不知道如何配置一个 multi-user install。但是官方的 nix install 脚本会报错，因为没有 ppc64le 的 prebuilt tarball。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_2">解决办法</a></h3>
<h4 id="binarytarballcross"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#binarytarballcross">binaryTarballCross 方法</a></h4>
<p>该方法学自 @NickCao，在 NixOS/nix 的 flake 中，有生成 tarball 的方法，如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-1-1"></a>nix<span class="w"> </span>build<span class="w"> </span><span class="s2">&quot;.#hydraJobs.binaryTarballCross.x86_64-linux.armv7l-linux&quot;</span>
</span></code></pre></div>
<p>这样就可以在 x86_64-linux 的 host 上，交叉编译生成一个用于 armv7l-linux 的安装 tarball。类似地，可以修改 flake.nix 来加入其他架构，如：</p>
<div class="language-diff highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-1"></a><span class="gh">diff --git a/flake.nix b/flake.nix</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-2"></a><span class="gh">index cc2a48d9c..c55a267e2 100644</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-3"></a><span class="gd">--- a/flake.nix</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-4"></a><span class="gi">+++ b/flake.nix</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-5"></a><span class="gu">@@ -21,7 +21,7 @@</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-6"></a><span class="w"> </span>      linuxSystems = linux64BitSystems ++ [ &quot;i686-linux&quot; ];
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-7"></a><span class="w"> </span>      systems = linuxSystems ++ [ &quot;x86_64-darwin&quot; &quot;aarch64-darwin&quot; ];
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-9"></a><span class="gd">-      crossSystems = [ &quot;armv6l-linux&quot; &quot;armv7l-linux&quot; ];</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-10"></a><span class="gi">+      crossSystems = [ &quot;armv6l-linux&quot; &quot;armv7l-linux&quot; &quot;powerpc64le-linux&quot; &quot;riscv64-linux&quot; ];</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-12"></a><span class="w"> </span>      stdenvs = [ &quot;gccStdenv&quot; &quot;clangStdenv&quot; &quot;clang11Stdenv&quot; &quot;stdenv&quot; &quot;libcxxStdenv&quot; &quot;ccacheStdenv&quot; ];
</span></code></pre></div>
<p>就可以用下面的命令来生成 riscv64-linux 和 powerpc64le-linux 架构的安装 tarball 了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-3-1"></a>nix<span class="w"> </span>build<span class="w"> </span><span class="s2">&quot;.#hydraJobs.binaryTarballCross.x86_64-linux.powerpc64le-linux&quot;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-3-2"></a>nix<span class="w"> </span>build<span class="w"> </span><span class="s2">&quot;.#hydraJobs.binaryTarballCross.x86_64-linux.riscv64-linux&quot;</span>
</span></code></pre></div>
<p>生成的 tarball 可以在 result 中找到。</p>
<h4 id="_3"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_3">手动替换法</a></h4>
<p>因此，我在网上进行搜索，发现 <a href="https://discourse.nixos.org/t/getting-started-with-nix-on-ppc64le/12712/8?u=jiegec">Getting started with Nix on ppc64le</a> 中有人提到，可以先在 x86 的机器上交叉编译出 ppc64le 的 nix，然后把 nix tarball 中的 x86 nix 替换成 ppc64le 版本，再复制到 ppc64le 上安装，其余的步骤就一样了。</p>
<p>我把脚本更新了一下，适配了最新的 nix 版本，最后得到了如下的脚本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-1"></a><span class="c1">##!/bin/sh</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-2"></a><span class="c1">## Based on https://discourse.nixos.org/t/getting-started-with-nix-on-ppc64le/12712/8?u=jiegec</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-3"></a>nix-build<span class="w"> </span><span class="s1">&#39;&lt;nixpkgs&gt;&#39;</span><span class="w"> </span>-A<span class="w"> </span>pkgsCross.powernv.nix
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-5"></a><span class="c1">## Get a donor copy of the installer</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-6"></a>wget<span class="w"> </span>-c<span class="w"> </span>https://releases.nixos.org/nix/nix-2.11.1/nix-2.11.1-x86_64-linux.tar.xz
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-7"></a>tar<span class="w"> </span>xf<span class="w"> </span>nix-2.11.1-x86_64-linux.tar.xz
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-9"></a><span class="c1">## Keep the cert package</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-10"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>nix-ppc64le-linux/store
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-11"></a>cp<span class="w"> </span>-r<span class="w"> </span>nix-2.11.1-x86_64-linux/store/*nss-cacert*<span class="w"> </span>nix-ppc64le-linux/store/
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-13"></a><span class="c1">## Toss other packages, keep the scripts</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-14"></a>rm<span class="w"> </span>-rf<span class="w"> </span>nix-2.11.1-x86_64-linux/store
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-15"></a>mv<span class="w"> </span>nix-2.11.1-x86_64-linux/*<span class="w"> </span>nix-ppc64le-linux/
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-17"></a><span class="c1">## Add ppc64le packages</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-18"></a>cp<span class="w"> </span>-r<span class="w"> </span><span class="k">$(</span>nix-store<span class="w"> </span>-qR<span class="w"> </span>result<span class="k">)</span><span class="w"> </span>nix-ppc64le-linux/store/
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-20"></a><span class="c1">## Generate a .reginfo for those ppc64le packages</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-21"></a>nix-store<span class="w"> </span>--dump-db<span class="w"> </span><span class="k">$(</span>nix-store<span class="w"> </span>-qR<span class="w"> </span>result<span class="k">)</span><span class="w"> </span>&gt;<span class="w"> </span>nix-ppc64le-linux/.reginfo
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-22"></a>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-23"></a><span class="c1">## Replace NIX_INSTALLED_NIX in install script</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-24"></a><span class="nb">export</span><span class="w"> </span><span class="nv">NIX_INSTALLED_NIX</span><span class="o">=</span><span class="k">$(</span>readlink<span class="w"> </span>result<span class="k">)</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-25"></a>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s#NIX_INSTALLED_NIX=\&quot;.*\&quot;#NIX_INSTALLED_NIX=\&quot;</span><span class="nv">$NIX_INSTALLED_NIX</span><span class="s2">\&quot;#&quot;</span><span class="w"> </span>nix-ppc64le-linux/install-multi-user
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-26"></a>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-27"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Done! Copy nix-ppc64le-linux to ppc64le machine and run ./install --daemon&quot;</span>
</span></code></pre></div>
<p>把生成的目录复制到 ppc64le 机器上就可以了。</p>
<h3 id="_4"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_4">编译问题</a></h3>
<p>当然了，既然 ppc64le 的 Nixpkgs 没有什么人测试，所以肯定会遇到一些问题。下面是遇到的几个比较主要的问题，以及相应的解决方法：</p>
<ul>
<li>boehm-gc checkPhase 会失败，见 <a href="https://github.com/ivmai/bdwgc/issues/376">ivmai/bdwgc#376</a>，一直没有修复。解决办法是添加 overlay，让它不要跑测试：</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-1"></a>custom-overlay = final: prev: {
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-2"></a>  # https://github.com/ivmai/bdwgc/issues/376
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-3"></a>  boehmgc = prev.boehmgc.overrideAttrs (_: { doCheck = false; });
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-4"></a>};
</span></code></pre></div>
<p>UPDATE: 向 nixpkgs 提交了 pr: https://github.com/NixOS/nixpkgs/pull/198591</p>
<p>另外根据 bdwgc 的 issue 提示，添加下列的选项可以让它测试通过：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-6-1"></a>makeFlags = [&quot;CFLAGS_EXTRA=\&quot;-DNO_SOFT_VDB\&quot;&quot;];
</span></code></pre></div>
<p>但是 issue 也说，这个方法对于 Power9 不工作。</p>
<ul>
<li>linux-headers 编译失败，报告 unknown type name __vector128，见 <a href="https://www.spinics.net/lists/netdev/msg694314.html">tools/bpf: Compilation issue on powerpc: unknown type name '__vector128'
</a> <a href="https://github.com/NixOS/nixpkgs/pull/192670">bpftools: add enableDebugger, set to false on Power64 (WIP)</a>。目前的解决办法是让 procps/tmux 等包不要依赖 systemd，进而不会依赖 linux-headers：</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-1"></a>custom-overlay = final: prev: {
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-2"></a>  # systemd cannot build due to linux-headers
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-3"></a>  procps = prev.procps.override { withSystemd = false; };
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-4"></a>  tmux = prev.tmux.override { withSystemd = false; };
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-5"></a>};
</span></code></pre></div>
<p>对于 home-manager，可以用下面的配置让它不要编译 systemd：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-8-1"></a>## systemd does not build
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-8-2"></a>systemd.user.systemctlPath = &quot;/bin/systemctl&quot;;
</span></code></pre></div>
<p>当然了，这个治标不治本，还是要等上游修复。</p>
<p>UPDATE: 向 nixpkgs 提交了 pr: https://github.com/NixOS/nixpkgs/pull/198587</p>

    <nav class="md-post__action">
      <a href="../../software/2022/10/29/nix-on-ppc64le/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-10-24 00:00:00">2022年10月24日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="gnuradio-companion-fm"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/">在 GNURadio Companion 中收听 FM 广播</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#_1">背景</a></h3>
<p>以前买过 RTL-SDR，用 Gqrx 做过收音机，当时还给 Homebrew 尝试提交过几个 sdr 相关的 <a href="https://github.com/Homebrew/legacy-homebrew/pulls?q=is%3Apr+author%3Ajiegec+">pr</a>，但是限于知识的缺乏，后来就没有再继续尝试了。</p>
<p>前两天，@OceanS2000 讲了一次 <a href="https://tuna.moe/event/2022/hacking-radio/">Tunight: 高级收音机使用入门</a>，又勾起了我的兴趣，所以我来尝试一下在 GNURadio Companion 中收听 FM 广播电台。</p>
<p>我没有上过无线电相关课程，所以下面有一些内容可能不正确或者不准确。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#_2">安装</a></h3>
<p>我的实验环境是 NixOS，所以是用下面的配置来安装 gnuradio 的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-1"></a>## SDR
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-2"></a>## https://github.com/NixOS/nixpkgs/pull/170253
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-3"></a>(gnuradio.override { extraMakeWrapperArgs = [ &quot;--prefix&quot; &quot;SOAPY_SDR_PLUGIN_PATH&quot; &quot;:&quot; (soapyrtlsdr + &quot;/lib/SoapySDR/modules0.8/&quot;) ]; })
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-4"></a>soapysdr-with-plugins
</span></code></pre></div>
<p>其中 gnuradio 的 override 是为了让它可以找到 soapyrtlsdr 的库，否则它会找不到设备；<code>soapysdr-with-plugins</code> 是为了提供 <code>SoapySDRUtil</code> 命令，来确认它可以找到 RTL-SDR 设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-1"></a>$<span class="w"> </span>SoapySDRUtil<span class="w"> </span>--probe
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-2"></a>----------------------------------------------------
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-3"></a>--<span class="w"> </span>Device<span class="w"> </span>identification
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-4"></a>----------------------------------------------------
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-5"></a><span class="w">  </span><span class="nv">driver</span><span class="o">=</span>RTLSDR
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-6"></a><span class="w">  </span><span class="nv">hardware</span><span class="o">=</span>R820T
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-7"></a><span class="w">  </span><span class="nv">origin</span><span class="o">=</span>https://github.com/pothosware/SoapyRTLSDR
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-8"></a><span class="w">  </span><span class="nv">rtl</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-10"></a>----------------------------------------------------
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-11"></a>--<span class="w"> </span>Peripheral<span class="w"> </span>summary
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-12"></a>----------------------------------------------------
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-13"></a><span class="w">  </span>Channels:<span class="w"> </span><span class="m">1</span><span class="w"> </span>Rx,<span class="w"> </span><span class="m">0</span><span class="w"> </span>Tx
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-14"></a><span class="w">  </span>Timestamps:<span class="w"> </span>NO
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-15"></a><span class="w">  </span>Other<span class="w"> </span>Settings:
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-16"></a><span class="w">     </span>*<span class="w"> </span>Direct<span class="w"> </span>Sampling<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>Direct<span class="w"> </span>Sampling<span class="w"> </span>Mode
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-17"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>direct_samp,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>string,<span class="w"> </span><span class="nv">options</span><span class="o">=(</span><span class="m">0</span>,<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="m">2</span><span class="o">)]</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-18"></a><span class="w">     </span>*<span class="w"> </span>Offset<span class="w"> </span>Tune<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>Offset<span class="w"> </span>Tuning<span class="w"> </span>Mode
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-19"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>offset_tune,<span class="w"> </span><span class="nv">default</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bool<span class="o">]</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-20"></a><span class="w">     </span>*<span class="w"> </span>I/Q<span class="w"> </span>Swap<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>I/Q<span class="w"> </span>Swap<span class="w"> </span>Mode
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-21"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>iq_swap,<span class="w"> </span><span class="nv">default</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bool<span class="o">]</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-22"></a><span class="w">     </span>*<span class="w"> </span>Digital<span class="w"> </span>AGC<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>digital<span class="w"> </span>AGC<span class="w"> </span>Mode
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-23"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>digital_agc,<span class="w"> </span><span class="nv">default</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bool<span class="o">]</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-24"></a>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-25"></a>----------------------------------------------------
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-26"></a>--<span class="w"> </span>RX<span class="w"> </span>Channel<span class="w"> </span><span class="m">0</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-27"></a>----------------------------------------------------
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-28"></a><span class="w">  </span>Full-duplex:<span class="w"> </span>NO
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-29"></a><span class="w">  </span>Supports<span class="w"> </span>AGC:<span class="w"> </span>YES
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-30"></a><span class="w">  </span>Stream<span class="w"> </span>formats:<span class="w"> </span>CS8,<span class="w"> </span>CS16,<span class="w"> </span>CF32
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-31"></a><span class="w">  </span>Native<span class="w"> </span>format:<span class="w"> </span>CS8<span class="w"> </span><span class="o">[</span>full-scale<span class="o">=</span><span class="m">128</span><span class="o">]</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-32"></a><span class="w">  </span>Stream<span class="w"> </span>args:
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-33"></a><span class="w">     </span>*<span class="w"> </span>Buffer<span class="w"> </span>Size<span class="w"> </span>-<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>buffer,<span class="w"> </span>multiples<span class="w"> </span>of<span class="w"> </span><span class="m">512</span><span class="w"> </span>only.
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-34"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>bufflen,<span class="w"> </span><span class="nv">units</span><span class="o">=</span>bytes,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">262144</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>int<span class="o">]</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-35"></a><span class="w">     </span>*<span class="w"> </span>Ring<span class="w"> </span>buffers<span class="w"> </span>-<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>buffers<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>ring.
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-36"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>buffers,<span class="w"> </span><span class="nv">units</span><span class="o">=</span>buffers,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">15</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>int<span class="o">]</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-37"></a><span class="w">     </span>*<span class="w"> </span>Async<span class="w"> </span>buffers<span class="w"> </span>-<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>async<span class="w"> </span>usb<span class="w"> </span>buffers<span class="w"> </span><span class="o">(</span>advanced<span class="o">)</span>.
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-38"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>asyncBuffs,<span class="w"> </span><span class="nv">units</span><span class="o">=</span>buffers,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>int<span class="o">]</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-39"></a><span class="w">  </span>Antennas:<span class="w"> </span>RX
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-40"></a><span class="w">  </span>Full<span class="w"> </span>gain<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">0</span>,<span class="w"> </span><span class="m">49</span>.6<span class="o">]</span><span class="w"> </span>dB
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-41"></a><span class="w">    </span>TUNER<span class="w"> </span>gain<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">0</span>,<span class="w"> </span><span class="m">49</span>.6<span class="o">]</span><span class="w"> </span>dB
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-42"></a><span class="w">  </span>Full<span class="w"> </span>freq<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">23</span>.999,<span class="w"> </span><span class="m">1764</span><span class="o">]</span><span class="w"> </span>MHz
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-43"></a><span class="w">    </span>RF<span class="w"> </span>freq<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">24</span>,<span class="w"> </span><span class="m">1764</span><span class="o">]</span><span class="w"> </span>MHz
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-44"></a><span class="w">    </span>CORR<span class="w"> </span>freq<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span>-0.001,<span class="w"> </span><span class="m">0</span>.001<span class="o">]</span><span class="w"> </span>MHz
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-45"></a><span class="w">  </span>Sample<span class="w"> </span>rates:<span class="w"> </span><span class="m">0</span>.25,<span class="w"> </span><span class="m">1</span>.024,<span class="w"> </span><span class="m">1</span>.536,<span class="w"> </span><span class="m">1</span>.792,<span class="w"> </span><span class="m">1</span>.92,<span class="w"> </span><span class="m">2</span>.048,<span class="w"> </span><span class="m">2</span>.16,<span class="w"> </span><span class="m">2</span>.56,<span class="w"> </span><span class="m">2</span>.88,<span class="w"> </span><span class="m">3</span>.2<span class="w"> </span>MSps
</span></code></pre></div>
<h3 id="fm"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#fm">寻找 FM 广播</a></h3>
<p>接着，就可以在 GRC(GNURadio Companion) 中从 RTL-SDR 读取数据了。首先，我按照 <a href="https://wiki.gnuradio.org/index.php/Guided_Tutorial_Hardware_Considerations">Guided Tutorial Hardware Considerations</a> 的方法进行分析，可以看到哪些频率上有信号：</p>
<p><img alt="" src="/images/rtlsdr-analyze.png" /></p>
<p>图中的参数：</p>
<ul>
<li>Sample Rate: 3.2MHz，这里要取比较大，如果太小可能找不到信号</li>
</ul>
<p><img alt="" src="/images/rtlsdr-analyze-waterfall.png" /></p>
<p>可以看到在 100.6MHz 附近有比较明显的信号，查询了一下，这对应了北京新闻广播 FM100.6，确实是一个 FM 广播电台。通过修改中心频率，还可以找到附近的 FM97.4 音乐广播和 FM 103.9 交通广播。</p>
<p><img alt="" src="/images/rtlsdr-analyze-waterfall-fm974.png" /></p>
<h3 id="fm_1"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#fm_1">收听 FM 广播</a></h3>
<p>找到频率以后，就可以进行 FM 解调了。我继续按照 <a href="https://wiki.gnuradio.org/index.php/FM_Demod">FM Demod</a> 的方法进行搭建，由于我用的是 RTL-SDR，考虑到它支持的采样率，我选取了 2.88MHz 采样率，经过一个 1/10 的 Rational Resampler 变成 288KHz 采样率，再进行 FM 解调，最后得到 <code>288KHz / 6 = 48KHz</code> 的音频，然后保存在 WAV 文件中：</p>
<p><img alt="" src="/images/rtlsdr-fm.png" /></p>
<p>图中的参数：</p>
<ul>
<li>Sample Rate: 2.88MHz，这里取了 48KHz 的整数倍数</li>
<li>Rational Resampler - Decimation: FM Demod 的 Decimation 不能太大，所以这里先进行 10 倍降采样，把采样率从 2.88MHz 降到 288KHz</li>
<li>FM Demod - Channel Rate: 输入的采样率是 288KHz</li>
<li>FM Demod - Audio Decimation: 6 倍降采样，这样输出就是 48KHz</li>
<li>FM Demod - Deviation: 75KHz，维基百科：<code>The maximum frequency deviation of the carrier is usually specified and regulated by the licensing authorities in each country. For a stereo broadcast, the maximum permitted carrier deviation is invariably ±75 kHz, although a little higher is permitted in the United States when SCA systems are used. For a monophonic broadcast, again the most common permitted maximum deviation is ±75 kHz. However, some countries specify a lower value for monophonic broadcasts, such as ±50 kHz.[5]</code></li>
<li>FM Demod - Audio Pass/Audio Stop: 低通滤波器参数，保留 0-16 KHz 的频率（Passband），到 20KHz 截止（Stopband）</li>
</ul>
<p>运行一段时间，收听保存下来的 wav 文件，发现可以清晰地听到广播电台的声音。</p>
<p>把输出改成 Audio Sink(Sample Rate = 48KHz)，然后就可以当成收音机应用来跑了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-2-1"></a>grcc<span class="w"> </span>-r<span class="w"> </span>rtlsdr_fm_play.grc
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../hardware/2022/10/24/gnuradio-fm-radio/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-09-24 00:00:00">2022年9月24日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="esxi-lacp"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/">ESXi 配置 LACP 链路聚合</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/#_1">背景</a></h3>
<p>给 ESXi 接了两路 10Gbps 的以太网，需要用 LACP 来聚合。ESXi 自己不能配置 LACP，需要配合 vCenter Server 的 Distributed Switch 来配置。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/#_2">步骤</a></h3>
<p>参考文档：<a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-0D1EF5B4-7581-480B-B99D-5714B42CD7A9.html">LACP Support on a vSphere Distributed Switch</a></p>
<p>第一步是创建一个 Distributed Switch。找到 Cluster，点击 ACTIONS，在 Distributed Switch 里面选择 New Distributed Switch。里面的选项都可以用默认的，按需修改。</p>
<p>第二步，找到刚刚创建的 Distributed Switch，点击 Configure，在 Settings 下点击 LACP，点击 NEW，选项可以用默认的，按需修改。</p>
<p>第三步，找到 Distributed Switch，点击 ACTIONS，点击 Add and Manage Hosts，找到要配置的主机，在 Manage physical adapters 这一步，找到要加入到链路聚合的 vmnic，每个要聚合的 vmnic 都在右边的 Assign uplink 处选择刚刚创建的 LAG 下的 Uplink，按顺序，一一对应。其余选项可以使用默认的。这一步配置好以后，在交换机上应该就可以看到 LACP 正常运转。</p>
<p>第四步，如果要把虚拟机连到链路聚合的网络上，找到虚拟机，点击 ACTIONS，点击 Edit Settings，新建一个网卡，Network adapter 处选择刚刚创建的 Distributed Port Group。这一步是让虚拟机多一个网卡，可以连接到 Distributed Switch 上。这一步配置好以后，虚拟机就可以收到来自其他物理机的网络流量，但是发送不出去。</p>
<p>注：Static Binding 和 Ephemeral Binding 的区别见 <a href="https://kb.vmware.com/s/article/1022312">Static (non-ephemeral) or ephemeral port binding on a vSphere Distributed Switch (1022312)</a>。在 vCenter 上可以给虚拟机分配到 Static binding 的 Distributed Port Group 上，而在 ESXi 上只可以分配到 Ephemeral Port Group。通常来讲，只需要 Static binding，而 Ephemeral binding 是在紧急情况下使用的。</p>
<p>第五步，如果要把 VMKernel 连到链路聚合的网络上，找到虚拟机，添加一个 VMKernel adapter，端口组为 Distributed Port Group，如默认创建的第一个 Distributed Port Group。类似地，此时 VMKernel 配置的 IP 地址还不能从外面访问，但是可以从同一个 Distributed Switch 的虚拟机中访问。</p>
<p>第六步，修改 Failover 配置，找到 Distributed Switch，点击 ACTIONS，在 Distributed Port Group 里点击 Manager Distributed Port Groups，勾选 Teaming and failover，勾上所有的 Distributed Port Group，修改下面的 Failover Order，默认状态是 Active uplinks 只有 Uplink，没有 LAG，需要修改为 Active uplinks 只有 LAG，而 Uplink 都在 Unused Uplinks 中。这样才可以让虚拟机和 VMKernel 出去的流量走链路聚合。</p>
<p>参考文档：<a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-9454ED41-6CFC-49F1-9982-34C1276F775A.html">LACP Teaming and Failover Configuration for Distributed Port Groups</a> 和 <a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-45DF45A6-DBDB-4386-85BF-400797683D05.html">Configure a Link Aggregation Group to Handle the Traffic for Distributed Port Groups</a></p>
<p>这样就配置完成了。</p>
<h3 id="lacp"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/#lacp">非 LACP 的链路聚合</a></h3>
<p>如果想要链路聚合，但是又不想用 Virtual Distributed Switch，可以在交换机上配置 Static Link Aggregation，然后在 ESXi 上添加多个 Uplink，配置 NIC teaming 为 <code>Route based on IP hash</code> 模式即可。</p>
<p>参考：<a href="https://kb.vmware.com/s/article/1004088">NIC teaming in ESXi and ESX</a></p>

    <nav class="md-post__action">
      <a href="../../devops/2022/09/24/vmware-esxi-lacp/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-09-19 00:00:00">2022年9月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="buildroot-202008-fakeroot"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/">Buildroot 2020.08 的 Fakeroot 版本过旧导致的兼容性问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#_1">背景</a></h3>
<p>最近在给之前的 Buildroot 2020.09 增加新的软件包，结果编译的时候报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-0-1"></a>mknod: ....../dev/console: Operation not permitted
</span></code></pre></div>
<p>还有一个背景是前段时间把系统升级到了 Ubuntu 22.04 LTS。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#_2">研究</a></h3>
<p>跑的时候没有用 root，而是用 fakeroot 跑的，按理说在 fakeroot 里跑 mknod 是不会报错的，我直接运行系统的 fakeroot 是正常的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-1-1"></a>fakeroot<span class="w"> </span>--<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span></code></pre></div>
<p>此时 fakeroot 会生成一个空文件，这是正常现象。那么为什么 Buildroot 里跑就不对了呢？</p>
<p>我仔细观察了一下，buildroot 用的是自己编译的 fakeroot，版本是 1.20.2，用这个版本跑就会报错：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-2-1"></a>$<span class="w"> </span>./output/host/bin/fakeroot<span class="w"> </span>--<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-2-2"></a>mknod:<span class="w"> </span>test:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
</span></code></pre></div>
<p>果然就出问题了。</p>
<p>用 strace 观察下区别：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-1"></a>$<span class="w"> </span>fakeroot<span class="w"> </span>--<span class="w"> </span>strace<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-2"></a>newfstatat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">&quot;test&quot;</span>,<span class="w"> </span><span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span><span class="m">0644</span>,<span class="w"> </span><span class="nv">st_size</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span>...<span class="o">}</span>,<span class="w"> </span>AT_SYMLINK_NOFOLLOW<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-3"></a>msgget<span class="o">(</span>0x4b33194b,<span class="w"> </span>IPC_CREAT<span class="p">|</span><span class="m">0600</span><span class="o">)</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">32771</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-4"></a>msgget<span class="o">(</span>0x4b33194c,<span class="w"> </span>IPC_CREAT<span class="p">|</span><span class="m">0600</span><span class="o">)</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">32772</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-5"></a>msgsnd<span class="o">(</span>...<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-6"></a>newfstatat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">&quot;test&quot;</span>,<span class="w"> </span><span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span><span class="m">0644</span>,<span class="w"> </span><span class="nv">st_size</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span>...<span class="o">}</span>,<span class="w"> </span>AT_SYMLINK_NOFOLLOW<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-7"></a>msgsnd<span class="o">(</span>...<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-8"></a>openat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">&quot;test&quot;</span>,<span class="w"> </span>O_RDONLY<span class="p">|</span>O_NOFOLLOW<span class="p">|</span>O_CLOEXEC<span class="p">|</span>O_PATH<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-9"></a>newfstatat<span class="o">(</span><span class="m">3</span>,<span class="w"> </span><span class="s2">&quot;&quot;</span>,<span class="w"> </span><span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span><span class="m">0644</span>,<span class="w"> </span><span class="nv">st_size</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span>...<span class="o">}</span>,<span class="w"> </span>AT_EMPTY_PATH<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-10"></a>fchmodat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">&quot;/proc/self/fd/3&quot;</span>,<span class="w"> </span><span class="m">0622</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-11"></a>$<span class="w"> </span>./output/host/bin/fakeroot<span class="w"> </span>--<span class="w"> </span>strace<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-12"></a>umask<span class="o">(</span><span class="m">000</span><span class="o">)</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="m">002</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-13"></a>umask<span class="o">(</span><span class="m">002</span><span class="o">)</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="m">000</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-14"></a>mknodat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">&quot;test&quot;</span>,<span class="w"> </span>S_IFCHR<span class="p">|</span><span class="m">0622</span>,<span class="w"> </span>makedev<span class="o">(</span>0x5,<span class="w"> </span>0x1<span class="o">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EPERM<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>not<span class="w"> </span>permitted<span class="o">)</span>
</span></code></pre></div>
<p>可以看到，正常情况下，mknodat 系统调用被拦截，由 fakeroot 来创建空文件；而错误的 fakeroot 版本下，没有拦截成功，就出现了 EPERM。</p>
<h3 id="_3"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#_3">解决</a></h3>
<p>一个粗暴的解决办法是，直接修改 buildroot 源代码，让它用系统的 fakeroot：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-4-1"></a><span class="w">        </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$$</span><span class="o">(</span>BR_PATH<span class="o">)</span><span class="w"> </span><span class="nv">FAKEROOTDONTTRYCHOWN</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>/usr/bin/fakeroot<span class="w"> </span>--<span class="w"> </span><span class="nv">$$</span><span class="o">(</span>FAKEROOT_SCRIPT<span class="o">)</span>
</span></code></pre></div>
<p>我还尝试重新编译 fakeroot 1.20.2，会出现编译错误，采用类似 <a href="https://bugs.archlinux.org/task/69572">bug 69572 fakeroot failes to build: _STAT_VER undeclared</a> 的方法可以解决编译的问题，但是还是出现 EPERM。<a href="https://github.com/buildroot/buildroot/commit/f45925a951318e9e53bead80b363e004301adc6f">Buildroot</a> 后来也引入了类似的修复。</p>
<p>于是在<a href="https://salsa.debian.org/clint/fakeroot">源代码</a>历史中搜寻了一番，发现了一个疑似的修复 commit：<a href="https://salsa.debian.org/clint/fakeroot/-/commit/c3eebec293e35b997bb46c22fb5a4e114afb5e7f">configure.ac: fix __xmknod{,at} pointer argument</a>，不过我并不能确定是不是这个问题。</p>
<p>进一步，我在 Docker 镜像中手动下载并编译 fakeroot 1.20.2、1.21 和 1.25.3，都可以复现这个问题，编译 1.29 版本则没有问题。用 git 克隆<a href="https://salsa.debian.org/clint/fakeroot">仓库</a>，进一步定位到 upstream/1.26 和 upstream/1.27 版本都是正常的。而 upstream/1.25.2 会出错。进一步二分，找到修复的 commit 是 <a href="https://salsa.debian.org/clint/fakeroot/-/commit/feda578ca3608b7fc9a28a3a91293611c0ef47b7">libfakeroot.c: add wrappers for new glibc 2.33+ symbols</a>，相关的代码如下：</p>
<div class="language-diff highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-1"></a><span class="gi">+  int mknod(const char *pathname, mode_t mode, dev_t dev) {</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-2"></a><span class="gi">+     return WRAP_MKNOD MKNOD_ARG(_STAT_VER, pathname, mode, &amp;dev);</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-3"></a><span class="gi">+  }</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-4"></a><span class="gi">+</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-5"></a><span class="gi">+  #if defined(HAVE_FSTATAT) &amp;&amp; defined(HAVE_MKNODAT)</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-6"></a><span class="gi">+    int mknodat(int dir_fd, const char *pathname, mode_t mode, dev_t dev) {</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-7"></a><span class="gi">+       return WRAP_MKNODAT MKNODAT_ARG(_STAT_VER, dir_fd, pathname, mode, &amp;dev);</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-8"></a><span class="gi">+    }</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-9"></a><span class="gi">+  #endif</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-10"></a><span class="gi">+#endif /* GLIBC_PREREQ */</span>
</span></code></pre></div>
<p>这说明在这个修复之前，不能正确地拦截 mknod 的调用。所以 glibc 2.33+ 要配合 fakeroot 1.26+ 版本才可以正确地运行 fakeroot。</p>
<p>结论：找个时间用新版的 Buildroot 重新构建一份。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/09/19/buildroot-fakeroot-incompat/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-08-05 00:00:00">2022年8月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tex-pdf"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/">从 TeX 到 PDF 的过程</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#_1">背景</a></h3>
<p>今天跑 <code>xdvipdfmx</code> 的时候出现了报错，忽然想研究一下，DVI 格式是什么，TeX 是如何一步步变成 PDF 的。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#_2">流程</a></h3>
<p>实际上从 TeX 到 PDF 有不同的工具，其中可能经历了不同的转化过程。</p>
<p>我们今天来看一种比较原始的转换方式：从 TeX 到 DVI，从 DVI 到 PS，再 PS 到 PDF，主要目的是看看这些格式内部都是什么样子的。</p>
<h3 id="tex-dvi"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#tex-dvi">从 TeX 到 DVI</a></h3>
<p>举一个很小的例子，例如 <code>test.tex</code> 有如下的内容：</p>
<div class="language-tex highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-0-1"></a>Hello, world!
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-0-2"></a><span class="k">\bye</span>
</span></code></pre></div>
<p>在命令行中运行 <code>tex test.tex</code>，可以看到它生成了 <code>test.dvi</code> 文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-1"></a>$<span class="w"> </span>tex<span class="w"> </span>test.tex
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-2"></a><span class="o">(</span>test.tex<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-3"></a>Output<span class="w"> </span>written<span class="w"> </span>on<span class="w"> </span>test.dvi<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>page,<span class="w"> </span><span class="m">228</span><span class="w"> </span>bytes<span class="o">)</span>.
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-4"></a>Transcript<span class="w"> </span>written<span class="w"> </span>on<span class="w"> </span>test.log.
</span></code></pre></div>
<p>那么 DVI 就是 TeX 引擎输出的默认格式了。我们可以用 dviinfox 和 dviasm 工具来看它的一些信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-1"></a>$<span class="w"> </span>dviinfox<span class="w"> </span>test.dvi
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-2"></a>test.dvi:<span class="w"> </span>DVI<span class="w"> </span>format<span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>page
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-3"></a><span class="w">  </span>Magnification:<span class="w"> </span><span class="m">1000</span>/1000
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-4"></a><span class="w">  </span>Size<span class="w"> </span>unit:<span class="w"> </span>1000x25400000/<span class="o">(</span>1000x473628672<span class="o">)</span><span class="nv">dum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.054dum<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>.000sp
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-5"></a><span class="w">  </span>Page<span class="w"> </span>size:<span class="w"> </span><span class="nv">469ptx667pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>.510cmx23.449cm
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-6"></a><span class="w">  </span>Stack<span class="w"> </span>size:<span class="w"> </span><span class="m">2</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-7"></a><span class="w">  </span>Comment:<span class="w"> </span><span class="s2">&quot; TeX output 2022.08.05:2055&quot;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-8"></a><span class="w">  </span>Font<span class="w">   </span><span class="m">0</span>:<span class="w">     </span>cmr10<span class="w"> </span>at<span class="w"> </span><span class="m">10</span>.000<span class="w"> </span><span class="o">(</span>design<span class="w"> </span>size<span class="w"> </span><span class="m">10</span>.000,<span class="w"> </span><span class="nv">checksum</span><span class="o">=</span><span class="m">1274110073</span><span class="o">)</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-9"></a>$<span class="w"> </span>dviasm<span class="w"> </span>test.dvi
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-10"></a><span class="o">[</span>preamble<span class="o">]</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-11"></a>id:<span class="w"> </span><span class="m">2</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-12"></a>numerator:<span class="w"> </span><span class="m">25400000</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-13"></a>denominator:<span class="w"> </span><span class="m">473628672</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-14"></a>magnification:<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-15"></a>comment:<span class="w"> </span><span class="s1">&#39; TeX output 2022.08.05:2058&#39;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-17"></a><span class="o">[</span>postamble<span class="o">]</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-18"></a>maxv:<span class="w"> </span><span class="m">667</span>.202545pt
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-19"></a>maxh:<span class="w"> </span><span class="m">469</span>.754990pt
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-20"></a>maxs:<span class="w"> </span><span class="m">2</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-21"></a>pages:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-22"></a>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-23"></a><span class="o">[</span>font<span class="w"> </span>definitions<span class="o">]</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-24"></a>fntdef:<span class="w"> </span>cmr10<span class="w"> </span>at<span class="w"> </span>10pt
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-26"></a><span class="o">[</span>page<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="o">]</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-27"></a>push:
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-28"></a><span class="w">  </span>down:<span class="w"> </span>-14pt
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-29"></a>pop:
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-30"></a>down:<span class="w"> </span><span class="m">643</span>.202545pt
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-31"></a>push:
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-32"></a><span class="w">  </span>down:<span class="w"> </span>-633.202545pt
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-33"></a><span class="w">  </span>push:
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-34"></a><span class="w">    </span>right:<span class="w"> </span>20pt
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-35"></a><span class="w">    </span>fnt:<span class="w"> </span>cmr10<span class="w"> </span>at<span class="w"> </span>10pt
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-36"></a><span class="w">    </span>set:<span class="w"> </span><span class="s1">&#39;Hello,&#39;</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-37"></a><span class="w">    </span>right:<span class="w"> </span><span class="m">3</span>.333328pt
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-38"></a><span class="w">    </span>set:<span class="w"> </span><span class="s1">&#39;w&#39;</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-39"></a><span class="w">    </span>right:<span class="w"> </span>-0.277786pt
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-40"></a><span class="w">    </span>set:<span class="w"> </span><span class="s1">&#39;orld!&#39;</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-41"></a><span class="w">  </span>pop:
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-42"></a>pop:
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-43"></a>down:<span class="w"> </span>24pt
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-44"></a>push:
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-45"></a><span class="w">  </span>right:<span class="w"> </span><span class="m">232</span>.377487pt
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-46"></a><span class="w">  </span>set:<span class="w"> </span><span class="s1">&#39;1&#39;</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-47"></a>pop:
</span></code></pre></div>
<p>可以看到，它定义了文档的一些尺寸和字体信息，然后主体部分就是每个页面上需要绘制的内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-1"></a>push:
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-2"></a>  down: -14pt
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-3"></a>pop:
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-4"></a>down: 643.202545pt
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-5"></a>push:
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-6"></a>  down: -633.202545pt
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-7"></a>  push:
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-8"></a>    right: 20pt
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-9"></a>    fnt: cmr10 at 10pt
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-10"></a>    set: &#39;Hello,&#39;
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-11"></a>    right: 3.333328pt
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-12"></a>    set: &#39;w&#39;
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-13"></a>    right: -0.277786pt
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-14"></a>    set: &#39;orld!&#39;
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-15"></a>  pop:
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-16"></a>pop:
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-17"></a>down: 24pt
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-18"></a>push:
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-19"></a>  right: 232.377487pt
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-20"></a>  set: &#39;1&#39;
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-21"></a>pop:
</span></code></pre></div>
<p>可以看到，它保存了一些命令，就像是在移动光标，然后输出文字：</p>
<ol>
<li>向下移动 643.20 pt</li>
<li>向上移动 633.20 pt</li>
<li>向右移动 20.00 pt</li>
<li>设置字体为 cmr10</li>
<li>输出 "Hello,"</li>
<li>向右移动 3.33 pt</li>
<li>输出 "w"</li>
<li>向左移动 0.28 pt</li>
<li>输出 "orld!"</li>
</ol>
<p>实际上，它的编码也比较简单，就是一个字节的命令加上若干字节的参数。DVI 二进制格式详细的文档可见 <a href="https://www.mn.uio.no/ifi/tjenester/it/hjelp/latex/dvi.pdf">https://www.mn.uio.no/ifi/tjenester/it/hjelp/latex/dvi.pdf</a>。</p>
<h3 id="dvi-ps"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#dvi-ps">从 DVI 到 PS</a></h3>
<p>有了 DVI 文件以后，下一步是用 <code>dvips</code> 工具来生成 PS 文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-1"></a>$<span class="w"> </span>dvips<span class="w"> </span>test.dvi
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-2"></a>This<span class="w"> </span>is<span class="w"> </span>dvips<span class="o">(</span>k<span class="o">)</span><span class="w"> </span><span class="m">2020</span>.1<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2020</span><span class="w"> </span>Radical<span class="w"> </span>Eye<span class="w"> </span>Software<span class="w"> </span><span class="o">(</span>www.radicaleye.com<span class="o">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-3"></a><span class="s1">&#39; TeX output 2022.08.05:2058&#39;</span><span class="w"> </span>-&gt;<span class="w"> </span>test.ps
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-4"></a>&lt;/usr/share/texlive/texmf-dist/dvips/base/tex.pro&gt;
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-5"></a>&lt;/usr/share/texlive/texmf-dist/dvips/base/texps.pro&gt;.
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-6"></a>&lt;/usr/share/texlive/texmf-dist/fonts/type1/public/amsfonts/cm/cmr10.pfb&gt;<span class="o">[</span><span class="m">1</span><span class="o">]</span>
</span></code></pre></div>
<p>DVI 是二进制格式，而 PS 是纯文本格式，我们可以用编辑器打开，看到里面大概有几部分内容：</p>
<ol>
<li>开头的元数据</li>
<li>tex.pro 文件的内容</li>
<li>texps.pro 文件的内容</li>
<li>定义 CMR10 字体</li>
<li>描述文档内容</li>
</ol>
<p>让我们直接来看最后一部分：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-1"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span><span class="w"> </span><span class="mf">39158280</span><span class="w"> </span><span class="mf">55380996</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="mf">600</span><span class="w"> </span><span class="mf">600</span><span class="w"> </span><span class="s">(test.dvi)</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-2"></a><span class="nf">@start</span><span class="w"> </span><span class="nv">/Fa</span><span class="w"> </span><span class="mf">136</span><span class="p">[</span><span class="mf">60</span><span class="w"> </span><span class="mf">4</span><span class="p">[</span><span class="mf">33</span><span class="w"> </span><span class="mf">2</span><span class="p">[</span><span class="mf">42</span><span class="w"> </span><span class="mf">2</span><span class="p">[</span><span class="mf">23</span><span class="w"> </span><span class="mf">6</span><span class="p">[</span><span class="mf">37</span><span class="w"> </span><span class="mf">46</span><span class="w"> </span><span class="mf">27</span><span class="p">[</span><span class="mf">62</span><span class="w"> </span><span class="mf">22</span><span class="p">[</span><span class="mf">42</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-3"></a><span class="mf">4</span><span class="p">[</span><span class="mf">23</span><span class="w"> </span><span class="mf">10</span><span class="p">[</span><span class="mf">23</span><span class="w"> </span><span class="mf">33</span><span class="p">[{}</span><span class="mf">10</span><span class="w"> </span><span class="mf">83.022</span><span class="w"> </span><span class="nv">/CMR10</span><span class="w"> </span><span class="nf">rf</span><span class="w"> </span><span class="nf">end</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-4"></a><span class="cs">%%EndProlog</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-5"></a><span class="cs">%%BeginSetup</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-6"></a><span class="cs">%%Feature: *Resolution 600dpi</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-7"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-8"></a><span class="cs">%%BeginPaperSize: a4</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-9"></a><span class="nv">/setpagedevice</span><span class="w"> </span><span class="nf">where</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-10"></a><span class="p">{</span><span class="w"> </span><span class="nf">pop</span><span class="w"> </span><span class="p">&lt;&lt;</span><span class="w"> </span><span class="nv">/PageSize</span><span class="w"> </span><span class="p">[</span><span class="mf">595</span><span class="w"> </span><span class="mf">842</span><span class="p">]</span><span class="w"> </span><span class="p">&gt;&gt;</span><span class="w"> </span><span class="nf">setpagedevice</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-11"></a><span class="p">{</span><span class="w"> </span><span class="nv">/a4</span><span class="w"> </span><span class="nf">where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">pop</span><span class="w"> </span><span class="nf">a4</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-12"></a><span class="nf">ifelse</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-13"></a><span class="cs">%%EndPaperSize</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-14"></a><span class="w"> </span><span class="nf">end</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-15"></a><span class="cs">%%EndSetup</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-16"></a><span class="cs">%%Page: 1 1</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-17"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">bop</span><span class="w"> </span><span class="mf">166</span><span class="w"> </span><span class="mf">83</span><span class="w"> </span><span class="nf">a</span><span class="w"> </span><span class="nf">Fa</span><span class="s">(Hello,)</span><span class="mf">28</span><span class="w"> </span><span class="nf">b</span><span class="s">(w)</span><span class="nf">n</span><span class="s">(orld!)</span><span class="mf">1929</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-18"></a><span class="mf">5539</span><span class="w"> </span><span class="nf">y</span><span class="s">(1)</span><span class="nf">p</span><span class="w"> </span><span class="nf">eop</span><span class="w"> </span><span class="nf">end</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-19"></a><span class="cs">%%Trailer</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-21"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span><span class="w"> </span><span class="nf">known</span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span><span class="nf">if</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-22"></a><span class="cs">%%EOF</span>
</span></code></pre></div>
<p>看到这个，肯定觉得很疑惑，这都是啥？除了隐约可以看到的 <code>Hello,</code> <code>w</code> <code>orld!</code> 字样以外，有很多不明含义的字母和代码。</p>
<p>为了读懂这些代码在做什么，首先来学习一下 PostScript。PostScript 是一个基于栈的语言，类似 Forth，所以很多运算都和我们平时看到的不一样。例如：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-6-1"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span><span class="w"> </span><span class="nf">known</span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span><span class="nf">if</span>
</span></code></pre></div>
<p>实际上做的事情是，判断 userdict 中是否存在 <code>/end-hook</code>，如果存在，则展开它。它的计算过程是：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-1"></a><span class="nf">userdict</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-2"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-3"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span><span class="w"> </span><span class="nf">known</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-4"></a><span class="nf">true</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-5"></a><span class="nf">true</span><span class="w"> </span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-6"></a><span class="nf">true</span><span class="w"> </span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span><span class="w"> </span><span class="nf">if</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-7"></a><span class="nf">end-hook</span>
</span></code></pre></div>
<p>那么回过头来看 <code>Hello, world!</code> 相关的代码：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-8-1"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">bop</span><span class="w"> </span><span class="mf">166</span><span class="w"> </span><span class="mf">83</span><span class="w"> </span><span class="nf">a</span><span class="w"> </span><span class="nf">Fa</span><span class="s">(Hello,)</span><span class="mf">28</span><span class="w"> </span><span class="nf">b</span><span class="s">(w)</span><span class="nf">n</span><span class="s">(orld!)</span><span class="mf">1929</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-8-2"></a><span class="mf">5539</span><span class="w"> </span><span class="nf">y</span><span class="s">(1)</span><span class="nf">p</span><span class="w"> </span><span class="nf">eop</span><span class="w"> </span><span class="nf">end</span>
</span></code></pre></div>
<p>这里出现的 <code>TeXDict</code> <code>bop</code> <code>a</code> 等等应该也是在前面定义的了。往回翻，发现正是 <code>tex.pro</code> 文件定义了这些对象。让我们一点点来看：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-9-1"></a><span class="nv">/TeXDict</span><span class="w"> </span><span class="mf">300</span><span class="w"> </span><span class="nf">dict</span><span class="w"> </span><span class="nf">def</span><span class="w">   </span><span class="c1">% define a working dictionary</span>
</span></code></pre></div>
<p>表示 <code>TexDict</code> 会展开为 <code>300 dict</code>，即创建一个最大容量为 300 的 dict。接下来的 begin 和 end 就是在这个 dict 的作用域中进行运算。</p>
<p>接下来是 <code>1 0 bop</code>，那么我们要看 <code>bop</code> 的定义，根据 DVI 中同名的命令，我们知道它的意思是 <code>begin of page</code>:</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-1"></a><span class="nv">/bop</span><span class="w">           </span><span class="c1">% %t %d bop -  -- begin a brand new page, %t=pageno %d=seqno</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-3"></a><span class="w">    </span><span class="nf">userdict</span><span class="w"> </span><span class="nv">/bop-hook</span><span class="w"> </span><span class="nf">known</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">bop-hook</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">if</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-4"></a><span class="w">    </span><span class="nv">/SI</span><span class="w"> </span><span class="nf">save</span><span class="w"> </span><span class="nf">N</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-5"></a><span class="w">    </span><span class="nf">@rigin</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-6"></a><span class="cm">%</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-7"></a><span class="cm">%   Now we check the resolution.  If it&#39;s correct, we use RV as V,</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-8"></a><span class="cm">%   otherwise we use QV.</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-9"></a><span class="cm">%</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-10"></a><span class="w">    </span><span class="mf">0</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">moveto</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-11"></a><span class="w">    </span><span class="nv">/V</span><span class="w"> </span><span class="nf">matrix</span><span class="w"> </span><span class="nf">currentmatrix</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-12"></a><span class="w">    </span><span class="nf">A</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="nf">get</span><span class="w"> </span><span class="nf">A</span><span class="w"> </span><span class="nf">mul</span><span class="w"> </span><span class="nf">exch</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">get</span><span class="w"> </span><span class="nf">A</span><span class="w"> </span><span class="nf">mul</span><span class="w"> </span><span class="nf">add</span><span class="w"> </span><span class="mf">.99</span><span class="w"> </span><span class="nf">lt</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-13"></a><span class="w">    </span><span class="p">{</span><span class="nv">/QV</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="nv">/RV</span><span class="p">}</span><span class="w"> </span><span class="nf">ifelse</span><span class="w"> </span><span class="nf">load</span><span class="w"> </span><span class="nf">def</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-14"></a><span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="nf">pop</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-15"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="nf">N</span>
</span></code></pre></div>
<p>这里有一些代码的含义我还不清楚，先跳过。</p>
<p>接下来的 <code>166 83 a</code>，根据定义就可以判断出来它是在移动位置：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-11-1"></a><span class="nv">/a</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">moveto</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span><span class="w">    </span><span class="c1">% absolute positioning</span>
</span></code></pre></div>
<p>紧随其后的 <code>Fa</code> 指的是字体。</p>
<p>接下来是 <code>(Hello,)</code>，即把 <code>Hello,</code> 这些文字压入栈。</p>
<p>接下来看到 <code>28 b</code>，它输出了栈顶的文本，进行了一个相对的水平移动，并且更新了 delta：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-1"></a><span class="nv">/delta</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">N</span><span class="w">         </span><span class="c1">% we need a variable to hold space moves</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-2"></a><span class="cm">%</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-3"></a><span class="cm">%   The next ten macros allow us to make horizontal motions that</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-4"></a><span class="cm">%   are within 4 of the previous horizontal motion with a single</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-5"></a><span class="cm">%   character.  These are typically used for spaces.</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-6"></a><span class="cm">%</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-7"></a><span class="nv">/tail</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">A</span><span class="w"> </span><span class="nv">/delta</span><span class="w"> </span><span class="nf">X</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">rmoveto</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-8"></a><span class="nv">/M</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">S</span><span class="w"> </span><span class="nf">p</span><span class="w"> </span><span class="nf">delta</span><span class="w"> </span><span class="nf">add</span><span class="w"> </span><span class="nf">tail</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-9"></a><span class="nv">/b</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">S</span><span class="w"> </span><span class="nf">p</span><span class="w"> </span><span class="nf">tail</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span><span class="w">      </span><span class="c1">% show and tail!</span>
</span></code></pre></div>
<p>后面的也都是类似的操作，让我们简单来总结一下 <code>TeXDict begin 1 0 bop 166 83 a Fa(Hello,)28 b(w)n(orld!)1929 5539 y(1)p eop end</code> 都做了什么：</p>
<ol>
<li><code>1 0 bop</code>: 创建了新页面</li>
<li><code>166 83 a</code>: 移动坐标到 <code>(166, 83)</code></li>
<li><code>Fa</code>: 设置字体</li>
<li><code>(Hello,)</code>: 压栈 "Hello,"</li>
<li><code>28 b</code>: 输出栈顶，移动坐标，对应 <code>dviasm</code> 输出中的 <code>right: 3.333328pt</code></li>
<li><code>(w)</code>: 压栈 "w"</li>
<li><code>n</code>: 输出栈顶，移动坐标，对应 <code>dviasm</code> 输出中的 <code>right: -0.277786pt</code></li>
<li><code>(orld!)</code>: 压栈 "orld!"</li>
<li><code>1929 5539 y</code>: 输出栈顶，移动坐标到页码的位置，对应 <code>dviasm</code> 输出中的 <code>down: 24pt</code> 和 <code>right: 232.377487.pt</code></li>
<li><code>(1)</code>: 压栈 "1"</li>
<li><code>p</code>: 输出栈顶</li>
<li><code>eop</code>: 结束页面</li>
</ol>
<p>由此我们基本明白了从 DVI 到 PS 是怎么一个流程：</p>
<ol>
<li>首先在 <code>tex.pro</code> 中定义了一些函数，来实现 DVI 中的命令</li>
<li>把 DVI 中的命令翻译成 PS 代码</li>
<li>把 <code>tex.pro</code>、字体等还有翻译出来的 PS 拼接起来作为最终的输出</li>
</ol>
<p>这算是一种元编程，在 PS 中定义了一个 DSL，可以很方便地执行 DVI 指令。</p>
<p>在 <a href="https://github.com/MiKTeX/miktex/blob/ab8ebca7c70fe8c9a1392dfb2393a0a7683e14cc/Programs/DviWare/dvips/source/tex.lpro">这里</a> 可以看到原始的带注释的 <code>tex.lpro</code> 实现，上面涉及 <code>tex.pro</code> 的代码内容也是从这里复制来的。</p>
<h3 id="ps-pdf"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#ps-pdf">从 PS 到 PDF</a></h3>
<p>最后一步，我们可以用 <code>ps2pdf</code> 把 PS 转换为 PDF。转换以后，就可以用常见的 PDF 浏览器来阅读了。让我们解压缩其中被压缩的部分，这样就方便阅读它的内容了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-13-1"></a>ps2pdf<span class="w"> </span>test.ps
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-13-2"></a>pdftk<span class="w"> </span>test.pdf<span class="w"> </span>output<span class="w"> </span>test.unc.pdf<span class="w"> </span>uncompress
</span></code></pre></div>
<p>在里面就可以找到我们的 <code>Hello, world!</code> 了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-1"></a>5 0 obj
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-3"></a>&lt;&lt;
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-4"></a>/Length 225
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-5"></a>&gt;&gt;
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-6"></a>stream
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-7"></a>q 0.1 0 0 0.1 0 0 cm
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-8"></a>0 g
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-9"></a>q
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-10"></a>10 0 0 10 0 0 cm BT
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-11"></a>/R7 9.96264 Tf
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-12"></a>1 0 0 1 91.9199 710.04 Tm
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-13"></a>[(H)3.21024(e)-1.66516(llo)-5.88993(,)-337.276(w)23.3747(o)-5.88993(r)-6.48419(ld)0.929988(!)]TJ
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-14"></a>211.56 -654.72 Td
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-15"></a>[(1)-5.8887]TJ
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-16"></a>ET
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-17"></a>Q
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-18"></a>Q
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-19"></a>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-20"></a>endstream
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-21"></a>endobj
</span></code></pre></div>
<p>阅读 <a href="https://opensource.adobe.com/dc-acrobat-sdk-docs/pdfstandards/PDF32000_2008.pdf">PDF 标准</a>，可以发现它的输出文本部分是这样的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-1"></a>BT
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-2"></a>    /R7 9.96264 Tf
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-3"></a>    1 0 0 1 91.9199 710.04 Tm
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-4"></a>    [(H)3.21024(e)-1.66516(llo)-5.88993(,)-337.276(w)23.3747(o)-5.88993(r)-6.48419(ld)0.929988(!)]TJ
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-5"></a>    211.56 -654.72 Td
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-6"></a>    [(1)-5.8887]TJ
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-7"></a>ET
</span></code></pre></div>
<p>其中：</p>
<ol>
<li><code>/R7 9.96264 Tf</code> 设置了字体 <code>/R7</code>，大小是 <code>9.96264</code></li>
<li><code>1 0 0 1 91.9199 710.04 Tm</code> 设置 Text matrix</li>
<li><code>[(H)3.21024(e)-1.66516(llo)-5.88993(,)-337.276(w)23.3747(o)-5.88993(r)-6.48419(ld)0.929988(!)]TJ</code> 输出一系列的 <code>Hello, world!</code>，中间的数字表示的是文字之间移动的坐标</li>
<li><code>211.56 -654.72 Td</code> 移动坐标到页码的位置</li>
<li><code>[(1)-5.8887]TJ</code> 输出页码</li>
</ol>
<p>可以看到，从 PS 到 PDF 这一步就不是简单的映射了，例如在 DVI 和 PS 中都是 <code>Hello,</code> <code>w</code> <code>orld!</code> 这样断开，而在 PDF 里面则是 <code>H</code> <code>e</code> <code>llo</code> <code>,</code> <code>w</code> <code>o</code> <code>r</code> <code>ld</code> <code>!</code>。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/08/05/from-tex-to-pdf/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-08-02 00:00:00">2022年8月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nix-rust"><a class="toclink" href="../../software/2022/08/02/rust-nix/">用 Nix 编译 Rust 项目</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_1">背景</a></h3>
<p>Rust 项目一般是用 Cargo 管理，但是它的缺点是每个项目都要重新编译一次所有依赖，硬盘空间占用较大，不能跨项目共享编译缓存。调研了一下，有若干基于 Nix 的 Rust 构建工具：</p>
<ul>
<li>cargo2nix: https://github.com/cargo2nix/cargo2nix</li>
<li>carnix: 不再更新</li>
<li>crane: https://github.com/ipetkov/crane</li>
<li>crate2nix: https://github.com/kolloch/crate2nix</li>
<li>naersk: https://github.com/nix-community/naersk</li>
<li>nocargo: https://github.com/oxalica/nocargo</li>
</ul>
<p>下面我分别来尝试一下这几个工具的使用。</p>
<p>下面出现的一些命令参考了对应项目的文档。</p>
<h3 id="cargo2nix"><a class="toclink" href="../../software/2022/08/02/rust-nix/#cargo2nix">cargo2nix</a></h3>
<h4 id="_2"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_2">卖点</a></h4>
<p>cargo2nix 的 README 提到了它的卖点：</p>
<ul>
<li>Development Shell - knowing all the dependencies means easy creation of complete shells. Run nix develop or direnv allow in this repo and see!</li>
<li>Caching - CI &amp; CD pipelines move faster when purity guarantees allow skipping more work!</li>
<li>Reproducibility - Pure builds. Access to all of nixpkgs for repeatable environment setup across multiple distributions and platforms</li>
</ul>
<h4 id="_3"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_3">安装</a></h4>
<p>cargo2nix 提供了 flakes 支持，不需要单独安装。</p>
<h4 id="_4"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_4">使用</a></h4>
<p>cargo2nix 的运行比较简单，利用 flakes 的特性，直接 <code>nix run</code> 即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/08/02/rust-nix/#__codelineno-0-1"></a>nix<span class="w"> </span>run<span class="w"> </span>github:cargo2nix/cargo2nix
</span></code></pre></div>
<p>它会生成一个 Cargo.nix 文件，还需要编写一个 <code>flake.nix</code> 配合使用，这里以 <code>jiegec/webhookd</code> 为例：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/08/02/rust-nix/#__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/08/02/rust-nix/#__codelineno-1-2"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/08/02/rust-nix/#__codelineno-1-3"></a>    cargo2nix<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:cargo2nix/cargo2nix/release-0.11.0&quot;</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2022/08/02/rust-nix/#__codelineno-1-4"></a>    flake-utils<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;cargo2nix/flake-utils&quot;</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2022/08/02/rust-nix/#__codelineno-1-5"></a>    nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;cargo2nix/nixpkgs&quot;</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../software/2022/08/02/rust-nix/#__codelineno-1-6"></a>  <span class="p">};</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../software/2022/08/02/rust-nix/#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../software/2022/08/02/rust-nix/#__codelineno-1-8"></a>  <span class="ss">outputs =</span> inputs<span class="p">:</span> <span class="k">with</span> inputs<span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../software/2022/08/02/rust-nix/#__codelineno-1-9"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../software/2022/08/02/rust-nix/#__codelineno-1-10"></a>      <span class="k">let</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../software/2022/08/02/rust-nix/#__codelineno-1-11"></a>        <span class="ss">pkgs =</span> <span class="nb">import</span> nixpkgs <span class="p">{</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../software/2022/08/02/rust-nix/#__codelineno-1-12"></a>          <span class="k">inherit</span> system<span class="p">;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../software/2022/08/02/rust-nix/#__codelineno-1-13"></a>          <span class="ss">overlays =</span> <span class="p">[</span>cargo2nix<span class="o">.</span>overlays<span class="o">.</span>default<span class="p">];</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../software/2022/08/02/rust-nix/#__codelineno-1-14"></a>        <span class="p">};</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../software/2022/08/02/rust-nix/#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../software/2022/08/02/rust-nix/#__codelineno-1-16"></a>        <span class="ss">rustPkgs =</span> pkgs<span class="o">.</span>rustBuilder<span class="o">.</span>makePackageSet <span class="p">{</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../software/2022/08/02/rust-nix/#__codelineno-1-17"></a>          <span class="ss">rustVersion =</span> <span class="s2">&quot;1.61.0&quot;</span><span class="p">;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../software/2022/08/02/rust-nix/#__codelineno-1-18"></a>          <span class="ss">packageFun =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/Cargo.nix</span><span class="p">;</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../software/2022/08/02/rust-nix/#__codelineno-1-19"></a>        <span class="p">};</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../software/2022/08/02/rust-nix/#__codelineno-1-20"></a>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../software/2022/08/02/rust-nix/#__codelineno-1-21"></a>      <span class="k">in</span> <span class="k">rec</span> <span class="p">{</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../software/2022/08/02/rust-nix/#__codelineno-1-22"></a>        <span class="ss">packages =</span> <span class="p">{</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../software/2022/08/02/rust-nix/#__codelineno-1-23"></a>          <span class="ss">webhookd =</span> <span class="p">(</span>rustPkgs<span class="o">.</span>workspace<span class="o">.</span>webhookd <span class="p">{})</span><span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../software/2022/08/02/rust-nix/#__codelineno-1-24"></a>          <span class="ss">default =</span> packages<span class="o">.</span>webhookd<span class="p">;</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../software/2022/08/02/rust-nix/#__codelineno-1-25"></a>        <span class="p">};</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../software/2022/08/02/rust-nix/#__codelineno-1-26"></a>      <span class="p">}</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../software/2022/08/02/rust-nix/#__codelineno-1-27"></a>    <span class="p">);</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../software/2022/08/02/rust-nix/#__codelineno-1-28"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后编译：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/08/02/rust-nix/#__codelineno-2-1"></a>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/08/02/rust-nix/#__codelineno-2-2"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2022/08/02/rust-nix/#__codelineno-2-3"></a>$<span class="w"> </span>./result-bin/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2022/08/02/rust-nix/#__codelineno-2-4"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h4 id="_5"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_5">原理</a></h4>
<p>cargo2nix 解析了 Cargo.lock，生成 Cargo.nix 文件，最后包装成 flake.nix。</p>
<h3 id="crane"><a class="toclink" href="../../software/2022/08/02/rust-nix/#crane">crane</a></h3>
<h4 id="_6"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_6">卖点</a></h4>
<p>crane 的 README 提到了它的卖点：</p>
<ul>
<li>Source fetching: automatically done using a Cargo.lock file</li>
<li>Incremental: build your workspace dependencies just once, then quickly lint, build, and test changes to your project without slowing down</li>
<li>Composable: split builds and tests into granular steps. Gate CI without burdening downstream consumers building from source.</li>
</ul>
<h4 id="_7"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_7">安装</a></h4>
<p>crane 不需要安装，直接用 flakes 即可。</p>
<h4 id="_8"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_8">使用</a></h4>
<p>crane 使用的时候，直接在项目中编写 <code>flake.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/08/02/rust-nix/#__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/08/02/rust-nix/#__codelineno-3-2"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2022/08/02/rust-nix/#__codelineno-3-3"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:NixOS/nixpkgs/nixpkgs-unstable&quot;</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2022/08/02/rust-nix/#__codelineno-3-4"></a>    crane<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:ipetkov/crane&quot;</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2022/08/02/rust-nix/#__codelineno-3-5"></a>    crane<span class="o">.</span>inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;nixpkgs&quot;</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2022/08/02/rust-nix/#__codelineno-3-6"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:numtide/flake-utils&quot;</span><span class="p">;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2022/08/02/rust-nix/#__codelineno-3-7"></a>  <span class="p">};</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2022/08/02/rust-nix/#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2022/08/02/rust-nix/#__codelineno-3-9"></a>  <span class="ss">outputs =</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> crane<span class="p">,</span> flake-utils<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2022/08/02/rust-nix/#__codelineno-3-10"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2022/08/02/rust-nix/#__codelineno-3-11"></a>      packages<span class="o">.</span><span class="ss">default =</span> crane<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>buildPackage <span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2022/08/02/rust-nix/#__codelineno-3-12"></a>        <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2022/08/02/rust-nix/#__codelineno-3-13"></a>      <span class="p">};</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2022/08/02/rust-nix/#__codelineno-3-14"></a>    <span class="p">});</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../software/2022/08/02/rust-nix/#__codelineno-3-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就可以了，不需要使用工具从 Cargo.lock 生成对应的 Cargo.nix。</p>
<p>但是由于 webhookd 依赖 native 库，所以还需要需要手动加入 native 依赖：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/08/02/rust-nix/#__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/08/02/rust-nix/#__codelineno-4-2"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2022/08/02/rust-nix/#__codelineno-4-3"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:NixOS/nixpkgs/nixpkgs-unstable&quot;</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2022/08/02/rust-nix/#__codelineno-4-4"></a>    crane<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:ipetkov/crane&quot;</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2022/08/02/rust-nix/#__codelineno-4-5"></a>    crane<span class="o">.</span>inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;nixpkgs&quot;</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2022/08/02/rust-nix/#__codelineno-4-6"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:numtide/flake-utils&quot;</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2022/08/02/rust-nix/#__codelineno-4-7"></a>  <span class="p">};</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2022/08/02/rust-nix/#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../software/2022/08/02/rust-nix/#__codelineno-4-9"></a>  <span class="ss">outputs =</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> crane<span class="p">,</span> flake-utils<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../software/2022/08/02/rust-nix/#__codelineno-4-10"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../software/2022/08/02/rust-nix/#__codelineno-4-11"></a>      <span class="k">let</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../software/2022/08/02/rust-nix/#__codelineno-4-12"></a>        <span class="ss">pkgs =</span> <span class="nb">import</span> nixpkgs <span class="p">{</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../software/2022/08/02/rust-nix/#__codelineno-4-13"></a>          <span class="k">inherit</span> system<span class="p">;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../software/2022/08/02/rust-nix/#__codelineno-4-14"></a>        <span class="p">};</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../software/2022/08/02/rust-nix/#__codelineno-4-15"></a>      <span class="k">in</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../software/2022/08/02/rust-nix/#__codelineno-4-16"></a>      <span class="p">{</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../software/2022/08/02/rust-nix/#__codelineno-4-17"></a>        packages<span class="o">.</span><span class="ss">default =</span> crane<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>buildPackage <span class="p">{</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../software/2022/08/02/rust-nix/#__codelineno-4-18"></a>          <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../software/2022/08/02/rust-nix/#__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../software/2022/08/02/rust-nix/#__codelineno-4-20"></a>          <span class="ss">buildInputs =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../software/2022/08/02/rust-nix/#__codelineno-4-21"></a>            libiconv
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../software/2022/08/02/rust-nix/#__codelineno-4-22"></a>            darwin<span class="o">.</span>apple_sdk<span class="o">.</span>frameworks<span class="o">.</span>Security
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../software/2022/08/02/rust-nix/#__codelineno-4-23"></a>          <span class="p">];</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../software/2022/08/02/rust-nix/#__codelineno-4-24"></a>        <span class="p">};</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../software/2022/08/02/rust-nix/#__codelineno-4-25"></a>      <span class="p">});</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../software/2022/08/02/rust-nix/#__codelineno-4-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/08/02/rust-nix/#__codelineno-5-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2022/08/02/rust-nix/#__codelineno-5-2"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2022/08/02/rust-nix/#__codelineno-5-3"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h4 id="_9"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_9">原理</a></h4>
<p>crane 会把所有的依赖下载起来用 cargo 进行一次构建，把生成的 target 目录打成 <code>target.tar.zst</code>，然后再加上项目的源代码再构建一次，这样来实现 incremental compilation。它还提供了一些 check lint 等实用的命令。但是，它的目的和其他项目不大一样，它并不考虑跨项目的依赖缓存。</p>
<h3 id="crate2nix"><a class="toclink" href="../../software/2022/08/02/rust-nix/#crate2nix">crate2nix</a></h3>
<h4 id="_10"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_10">卖点</a></h4>
<p>crate2nix 在 README 中写的卖点：</p>
<ul>
<li>Same dependency tree as cargo: It uses cargo_metadata to obtain the dependency tree from cargo. Therefore, it will use the exact same library versions as cargo and respect any locked down version in Cargo.lock.</li>
<li>Smart caching: It uses smart crate by crate caching so that nix rebuilds exactly the crates that need to be rebuilt. Compare that to docker layers...</li>
<li>Nix ecosystem goodness: You can use all things that make the nix/NixOS ecosystem great, e.g. distributed/remote builds, build minimal docker images, deploy your binary as a service to the cloud with NixOps, ...</li>
<li>Out of the box support for libraries with non-rust dependencies: It builds on top of the buildRustCrate function from NixOS so that native dependencies of many rust libraries are already correctly fetched when needed. If your library with native dependencies is not yet supported, you can customize defaultCrateOverrides / crateOverrides, see below.</li>
<li>Easy to understand nix template: The actual nix code is generated via templates/build.nix.tera so you can fix/improve the nix code without knowing rust if all the data is already there.</li>
</ul>
<h4 id="_11"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_11">安装</a></h4>
<p>首先要安装 crate2nix，由于它的稳定版本 0.10.0 已经是去年的版本了，我直接用了 master 分支。如果是直接安装，用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/08/02/rust-nix/#__codelineno-6-1"></a>nix-env<span class="w"> </span>-i<span class="w"> </span>-f<span class="w"> </span>https://github.com/kolloch/crate2nix/tarball/master
</span></code></pre></div>
<p>但我是用 flakes + home-manager 管理的，所以我实际的配置方法是：</p>
<ol>
<li>向 flake.nix 添加 crate2nix 到 inputs，并且设置 <code>crate2nix.flake = false</code></li>
<li>把 crate2nix 从 inputs 传到实际的 home manager 配置，然后在 <code>home.packages</code> 里加入 <code>callPackage crate2nix {}</code></li>
</ol>
<h4 id="_12"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_12">使用</a></h4>
<p>接下来，找到一个 Rust 项目，在其中运行 <code>crate2nix generate</code>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2022/08/02/rust-nix/#__codelineno-7-1"></a>$<span class="w"> </span>crate2nix<span class="w"> </span>generate
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../software/2022/08/02/rust-nix/#__codelineno-7-2"></a>Generated<span class="w"> </span>./Cargo.nix<span class="w"> </span>successfully.
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../software/2022/08/02/rust-nix/#__codelineno-8-1"></a>nix<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>Cargo.nix<span class="w"> </span>rootCrate.build
</span></code></pre></div>
<p>编译的结果可以在 <code>result/bin</code> 下看到。</p>
<p>我编译的是 <code>jiegec/webhookd</code>，编译过程中出现了报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../software/2022/08/02/rust-nix/#__codelineno-9-1"></a>&gt;   = note: ld: framework not found Security
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../software/2022/08/02/rust-nix/#__codelineno-9-2"></a>&gt;           clang-11: error: linker command failed with exit code 1 (use -v to see invocation)
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../software/2022/08/02/rust-nix/#__codelineno-9-3"></a>&gt;
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../software/2022/08/02/rust-nix/#__codelineno-9-4"></a>&gt;
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../software/2022/08/02/rust-nix/#__codelineno-9-5"></a>&gt; error: aborting due to previous error
</span></code></pre></div>
<p>前面的 cargo2nix 没有出现这样的问题，应该是因为 cargo2nix 帮我们引入了 Security 的依赖，见 <a href="https://github.com/cargo2nix/cargo2nix/blob/9c3b846c727300f8146f20f01c5387b398d1e0e4/overlay/overrides.nix">overrides.nix</a>。</p>
<p>根据 crate2nix 的文档，需要添加额外的 native 依赖：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../software/2022/08/02/rust-nix/#__codelineno-10-1"></a><span class="p">{</span> pkgs <span class="o">?</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../software/2022/08/02/rust-nix/#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../software/2022/08/02/rust-nix/#__codelineno-10-3"></a><span class="k">let</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../software/2022/08/02/rust-nix/#__codelineno-10-4"></a>  <span class="ss">generatedBuild =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/Cargo.nix</span> <span class="p">{</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../software/2022/08/02/rust-nix/#__codelineno-10-5"></a>    <span class="k">inherit</span> pkgs<span class="p">;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../software/2022/08/02/rust-nix/#__codelineno-10-6"></a>    <span class="ss">defaultCrateOverrides =</span> <span class="k">with</span> pkgs<span class="p">;</span> defaultCrateOverrides <span class="o">//</span> <span class="p">{</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="../../software/2022/08/02/rust-nix/#__codelineno-10-7"></a>      <span class="ss">webhookd =</span> attrs<span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="../../software/2022/08/02/rust-nix/#__codelineno-10-8"></a>        <span class="ss">buildInputs =</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="../../software/2022/08/02/rust-nix/#__codelineno-10-9"></a>          lib<span class="o">.</span>optionals
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="../../software/2022/08/02/rust-nix/#__codelineno-10-10"></a>            stdenv<span class="o">.</span>isDarwin
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="../../software/2022/08/02/rust-nix/#__codelineno-10-11"></a>            <span class="p">[</span> darwin<span class="o">.</span>apple_sdk<span class="o">.</span>frameworks<span class="o">.</span>Security <span class="p">];</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="../../software/2022/08/02/rust-nix/#__codelineno-10-12"></a>      <span class="p">};</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="../../software/2022/08/02/rust-nix/#__codelineno-10-13"></a>    <span class="p">};</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="../../software/2022/08/02/rust-nix/#__codelineno-10-14"></a>  <span class="p">};</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="../../software/2022/08/02/rust-nix/#__codelineno-10-15"></a><span class="k">in</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="../../software/2022/08/02/rust-nix/#__codelineno-10-16"></a>generatedBuild<span class="o">.</span>rootCrate<span class="o">.</span>build
</span></code></pre></div>
<p>然后构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../software/2022/08/02/rust-nix/#__codelineno-11-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>default.nix
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../software/2022/08/02/rust-nix/#__codelineno-11-2"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../software/2022/08/02/rust-nix/#__codelineno-11-3"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<p>这样就可以正常运行了。</p>
<h4 id="_13"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_13">原理</a></h4>
<p>它的原理是使用 <code>cargo_metadata</code> 库从 Cargo.lock 中获取各个 crate 的信息，然后翻译成 <code>Cargo.nix</code>，之后就是由 nix 来编译各个 crate 的内容。所以一开始还是需要先用 Cargo 创建项目，添加依赖，生成 <code>Cargo.lock</code>；之后再用 <code>crate2nix generate</code> 同步依赖信息到 <code>Cargo.nix</code> 文件，构建的时候就不需要 Cargo 参与了，直接 rustc。</p>
<h3 id="naersk"><a class="toclink" href="../../software/2022/08/02/rust-nix/#naersk">naersk</a></h3>
<h4 id="_14"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_14">安装</a></h4>
<p>需要安装 <a href="https://github.com/nmattia/niv">niv</a>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../software/2022/08/02/rust-nix/#__codelineno-12-1"></a>nix-env<span class="w"> </span>-iA<span class="w"> </span>nixpkgs.niv
</span></code></pre></div>
<h4 id="_15"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_15">使用</a></h4>
<p>在项目目录下，首先用 <code>niv</code> 导入 naersk：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../software/2022/08/02/rust-nix/#__codelineno-13-1"></a>niv<span class="w"> </span>init
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="../../software/2022/08/02/rust-nix/#__codelineno-13-2"></a>niv<span class="w"> </span>add<span class="w"> </span>nix-community/naersk
</span></code></pre></div>
<p>然后编写一个 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../software/2022/08/02/rust-nix/#__codelineno-14-1"></a><span class="k">let</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="../../software/2022/08/02/rust-nix/#__codelineno-14-2"></a>  <span class="ss">pkgs =</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{</span> <span class="p">};</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="../../software/2022/08/02/rust-nix/#__codelineno-14-3"></a>  <span class="ss">sources =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/nix/sources.nix</span><span class="p">;</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="../../software/2022/08/02/rust-nix/#__codelineno-14-4"></a>  <span class="ss">naersk =</span> pkgs<span class="o">.</span>callPackage sources<span class="o">.</span>naersk <span class="p">{</span> <span class="p">};</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="../../software/2022/08/02/rust-nix/#__codelineno-14-5"></a><span class="k">in</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="../../software/2022/08/02/rust-nix/#__codelineno-14-6"></a>naersk<span class="o">.</span>buildPackage <span class="o">.</span><span class="l">/.</span>
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../software/2022/08/02/rust-nix/#__codelineno-15-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>default.nix
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../software/2022/08/02/rust-nix/#__codelineno-15-2"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="../../software/2022/08/02/rust-nix/#__codelineno-15-3"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h4 id="_16"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_16">原理</a></h4>
<p>naersk 的原理和 crane 是类似的：把所有依赖下载下来，创建一个只有依赖的项目，然后用 cargo 预编译，编译完得到的 target 目录打成 <code>target.tar.zst</code>；然后基于预编译的结果再编译整个项目。</p>
<h3 id="nocargo"><a class="toclink" href="../../software/2022/08/02/rust-nix/#nocargo">nocargo</a></h3>
<h4 id="_17"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_17">卖点</a></h4>
<p>nocargo 的 README 提到了以下卖点：</p>
<ul>
<li>No IFDs (import-from-derivation). See meme.</li>
<li>No cargo dependency during building. Only rustc.</li>
<li>No need for hash prefetching or code generation1.</li>
<li>Crate level caching, globally shared.</li>
<li>nixpkgs integration for non-Rust dependencies.</li>
</ul>
<p>README 也提到了 nocargo, cargo2nix, naersk 和 buildRustPackage 的对比。</p>
<h4 id="_18"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_18">使用</a></h4>
<p>nocargo 目前<a href="https://github.com/oxalica/nocargo/blob/90a6d0e8dcfc2205fa69423d42bff6fd1b997121/flake.nix#L13">仅支持 x86_64-linux 平台</a>。</p>
<p>在一个 Cargo 项目中，运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../software/2022/08/02/rust-nix/#__codelineno-16-1"></a>nix<span class="w"> </span>run<span class="w"> </span>github:oxalica/nocargo<span class="w"> </span>init
</span></code></pre></div>
<p>它会生成 <code>flake.nix</code> 文件如下：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="../../software/2022/08/02/rust-nix/#__codelineno-17-1"></a><span class="c1">## See more usages of nocargo at https://github.com/oxalica/nocargo#readme</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="../../software/2022/08/02/rust-nix/#__codelineno-17-2"></a><span class="p">{</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="../../software/2022/08/02/rust-nix/#__codelineno-17-3"></a>  <span class="ss">description =</span> <span class="s2">&quot;Rust package webhookd&quot;</span><span class="p">;</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="../../software/2022/08/02/rust-nix/#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="../../software/2022/08/02/rust-nix/#__codelineno-17-5"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="../../software/2022/08/02/rust-nix/#__codelineno-17-6"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:NixOS/nixpkgs&quot;</span><span class="p">;</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="../../software/2022/08/02/rust-nix/#__codelineno-17-7"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:numtide/flake-utils&quot;</span><span class="p">;</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="../../software/2022/08/02/rust-nix/#__codelineno-17-8"></a>    <span class="ss">nocargo =</span> <span class="p">{</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="../../software/2022/08/02/rust-nix/#__codelineno-17-9"></a>      <span class="ss">url =</span> <span class="s2">&quot;github:oxalica/nocargo&quot;</span><span class="p">;</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="../../software/2022/08/02/rust-nix/#__codelineno-17-10"></a>      inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;nixpkgs&quot;</span><span class="p">;</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="../../software/2022/08/02/rust-nix/#__codelineno-17-11"></a>      <span class="c1"># inputs.registry-crates-io.follows = &quot;registry-crates-io&quot;;</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="../../software/2022/08/02/rust-nix/#__codelineno-17-12"></a>    <span class="p">};</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="../../software/2022/08/02/rust-nix/#__codelineno-17-13"></a>    <span class="c1"># Optionally, you can override crates.io index to get cutting-edge packages.</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="../../software/2022/08/02/rust-nix/#__codelineno-17-14"></a>    <span class="c1"># registry-crates-io = { url = &quot;github:rust-lang/crates.io-index&quot;; flake = false; };</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="../../software/2022/08/02/rust-nix/#__codelineno-17-15"></a>  <span class="p">};</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="../../software/2022/08/02/rust-nix/#__codelineno-17-16"></a>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="../../software/2022/08/02/rust-nix/#__codelineno-17-17"></a>  <span class="ss">outputs =</span> <span class="p">{</span> nixpkgs<span class="p">,</span> flake-utils<span class="p">,</span> nocargo<span class="p">,</span> <span class="o">...</span> <span class="p">}@</span>inputs<span class="p">:</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="../../software/2022/08/02/rust-nix/#__codelineno-17-18"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachSystem <span class="p">[</span> <span class="s2">&quot;x86_64-linux&quot;</span> <span class="p">]</span> <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="../../software/2022/08/02/rust-nix/#__codelineno-17-19"></a>      <span class="k">let</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="../../software/2022/08/02/rust-nix/#__codelineno-17-20"></a>        <span class="ss">ws =</span> nocargo<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>mkRustPackageOrWorkspace <span class="p">{</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="../../software/2022/08/02/rust-nix/#__codelineno-17-21"></a>          <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="../../software/2022/08/02/rust-nix/#__codelineno-17-22"></a>        <span class="p">};</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="../../software/2022/08/02/rust-nix/#__codelineno-17-23"></a>      <span class="k">in</span> <span class="k">rec</span> <span class="p">{</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="../../software/2022/08/02/rust-nix/#__codelineno-17-24"></a>        <span class="ss">packages =</span> <span class="p">{</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="../../software/2022/08/02/rust-nix/#__codelineno-17-25"></a>          <span class="ss">default =</span> packages<span class="o">.</span>webhookd<span class="p">;</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="../../software/2022/08/02/rust-nix/#__codelineno-17-26"></a>          <span class="ss">webhookd =</span> ws<span class="o">.</span>release<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="../../software/2022/08/02/rust-nix/#__codelineno-17-27"></a>          <span class="ss">webhookd-dev =</span> ws<span class="o">.</span>dev<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="../../software/2022/08/02/rust-nix/#__codelineno-17-28"></a>        <span class="p">};</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="../../software/2022/08/02/rust-nix/#__codelineno-17-29"></a>      <span class="p">});</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="../../software/2022/08/02/rust-nix/#__codelineno-17-30"></a><span class="p">}</span>
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="../../software/2022/08/02/rust-nix/#__codelineno-18-1"></a>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="../../software/2022/08/02/rust-nix/#__codelineno-18-2"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span></code></pre></div>
<p>出现了编译错误，说明 crates.io index 版本不是最新的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="../../software/2022/08/02/rust-nix/#__codelineno-19-1"></a>error: Package bytes doesn&#39;t have version 1.2.0 in index. Available versions: 0.0.1 0.1.0 0.1.1 0.1.2 0.2.0 0.2.1 0.2.10 0.2.11 0.2.2 0.2.3 0.2.4 0.2.5 0.2.6 0.2.7 0.2.8 0.2.9 0.3.0 0.4.0 0.4.1 0.4.10 0.4.11 0.4.12 0.4.2 0.4.3 0.4.4 0.4.5 0.4.6 0.4.7 0.4.8 0.4.9 0.5.0 0.5.1 0.5.2 0.5.3 0.5.4 0.5.5 0.5.6 0.6.0 1.0.0 1.0.1 1.1.0
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="../../software/2022/08/02/rust-nix/#__codelineno-19-2"></a>(use &#39;--show-trace&#39; to show detailed location information)
</span></code></pre></div>
<p>按照 <code>flake.nix</code> 中的提示，使用最新的 crates.io index：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="../../software/2022/08/02/rust-nix/#__codelineno-20-1"></a><span class="c1">## See more usages of nocargo at https://github.com/oxalica/nocargo#readme</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="../../software/2022/08/02/rust-nix/#__codelineno-20-2"></a><span class="p">{</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="../../software/2022/08/02/rust-nix/#__codelineno-20-3"></a>  <span class="ss">description =</span> <span class="s2">&quot;Rust package webhookd&quot;</span><span class="p">;</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="../../software/2022/08/02/rust-nix/#__codelineno-20-4"></a>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="../../software/2022/08/02/rust-nix/#__codelineno-20-5"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="../../software/2022/08/02/rust-nix/#__codelineno-20-6"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:NixOS/nixpkgs&quot;</span><span class="p">;</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="../../software/2022/08/02/rust-nix/#__codelineno-20-7"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:numtide/flake-utils&quot;</span><span class="p">;</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="../../software/2022/08/02/rust-nix/#__codelineno-20-8"></a>    <span class="ss">nocargo =</span> <span class="p">{</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="../../software/2022/08/02/rust-nix/#__codelineno-20-9"></a>      <span class="ss">url =</span> <span class="s2">&quot;github:oxalica/nocargo&quot;</span><span class="p">;</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="../../software/2022/08/02/rust-nix/#__codelineno-20-10"></a>      inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;nixpkgs&quot;</span><span class="p">;</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="../../software/2022/08/02/rust-nix/#__codelineno-20-11"></a>      inputs<span class="o">.</span>registry-crates-io<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;registry-crates-io&quot;</span><span class="p">;</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="../../software/2022/08/02/rust-nix/#__codelineno-20-12"></a>    <span class="p">};</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="../../software/2022/08/02/rust-nix/#__codelineno-20-13"></a>    <span class="c1"># Optionally, you can override crates.io index to get cutting-edge packages.</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="../../software/2022/08/02/rust-nix/#__codelineno-20-14"></a>    <span class="ss">registry-crates-io =</span> <span class="p">{</span> <span class="ss">url =</span> <span class="s2">&quot;github:rust-lang/crates.io-index&quot;</span><span class="p">;</span> <span class="ss">flake =</span> <span class="no">false</span><span class="p">;</span> <span class="p">};</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="../../software/2022/08/02/rust-nix/#__codelineno-20-15"></a>  <span class="p">};</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="../../software/2022/08/02/rust-nix/#__codelineno-20-16"></a>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="../../software/2022/08/02/rust-nix/#__codelineno-20-17"></a>  <span class="ss">outputs =</span> <span class="p">{</span> nixpkgs<span class="p">,</span> flake-utils<span class="p">,</span> nocargo<span class="p">,</span> <span class="o">...</span> <span class="p">}@</span>inputs<span class="p">:</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="../../software/2022/08/02/rust-nix/#__codelineno-20-18"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachSystem <span class="p">[</span> <span class="s2">&quot;x86_64-linux&quot;</span> <span class="p">]</span> <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="../../software/2022/08/02/rust-nix/#__codelineno-20-19"></a>      <span class="k">let</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="../../software/2022/08/02/rust-nix/#__codelineno-20-20"></a>        <span class="ss">ws =</span> nocargo<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>mkRustPackageOrWorkspace <span class="p">{</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="../../software/2022/08/02/rust-nix/#__codelineno-20-21"></a>          <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="../../software/2022/08/02/rust-nix/#__codelineno-20-22"></a>        <span class="p">};</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="../../software/2022/08/02/rust-nix/#__codelineno-20-23"></a>      <span class="k">in</span> <span class="k">rec</span> <span class="p">{</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="../../software/2022/08/02/rust-nix/#__codelineno-20-24"></a>        <span class="ss">packages =</span> <span class="p">{</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="../../software/2022/08/02/rust-nix/#__codelineno-20-25"></a>          <span class="ss">default =</span> packages<span class="o">.</span>webhookd<span class="p">;</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="../../software/2022/08/02/rust-nix/#__codelineno-20-26"></a>          <span class="ss">webhookd =</span> ws<span class="o">.</span>release<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="../../software/2022/08/02/rust-nix/#__codelineno-20-27"></a>          <span class="ss">webhookd-dev =</span> ws<span class="o">.</span>dev<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="../../software/2022/08/02/rust-nix/#__codelineno-20-28"></a>        <span class="p">};</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="../../software/2022/08/02/rust-nix/#__codelineno-20-29"></a>      <span class="p">});</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="../../software/2022/08/02/rust-nix/#__codelineno-20-30"></a><span class="p">}</span>
</span></code></pre></div>
<p>继续构建就成功了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="../../software/2022/08/02/rust-nix/#__codelineno-21-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="../../software/2022/08/02/rust-nix/#__codelineno-21-2"></a>•<span class="w"> </span>Updated<span class="w"> </span>input<span class="w"> </span><span class="s1">&#39;nocargo/registry-crates-io&#39;</span>:
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="../../software/2022/08/02/rust-nix/#__codelineno-21-3"></a><span class="w">    </span><span class="s1">&#39;github:rust-lang/crates.io-index/1ce12a7e3367a2a673f91f07ab7cc505a0b8f069&#39;</span><span class="w"> </span><span class="o">(</span><span class="m">2022</span>-07-17<span class="o">)</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="../../software/2022/08/02/rust-nix/#__codelineno-21-4"></a><span class="w">  </span>→<span class="w"> </span>follows<span class="w"> </span><span class="s1">&#39;registry-crates-io&#39;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="../../software/2022/08/02/rust-nix/#__codelineno-21-5"></a>•<span class="w"> </span>Added<span class="w"> </span>input<span class="w"> </span><span class="s1">&#39;registry-crates-io&#39;</span>:
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="../../software/2022/08/02/rust-nix/#__codelineno-21-6"></a><span class="w">    </span><span class="s1">&#39;github:rust-lang/crates.io-index/627caba32f416e706bf3f2ceac55230ec79710c5&#39;</span><span class="w"> </span><span class="o">(</span><span class="m">2022</span>-08-02<span class="o">)</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="../../software/2022/08/02/rust-nix/#__codelineno-21-7"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="../../software/2022/08/02/rust-nix/#__codelineno-21-8"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h3 id="_19"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_19">总结</a></h3>
<p>可以看到，上面的不同工具采用了不同的方法，如果要比较的话：</p>
<ul>
<li>Nix drv 粒度：每个依赖（cargo2nix，crate2nix，nocargo）、所有依赖（crane，naersk）。前者的好处是会跨项目共享依赖，进一步可以传到 binary cache。</li>
<li>是否生成包括完整依赖信息的 nix 文件：是（cargo2nix，crate2nix）、否（crane，naersk，nocargo）。生成的话，仓库里的 Cargo.lock 和 Cargo.nix 的信息是重复的，如果修改了 Cargo.lock，需要重新同步 Cargo.nix。</li>
</ul>

    <nav class="md-post__action">
      <a href="../../software/2022/08/02/rust-nix/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-26 00:00:00">2022年7月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="invalid-date"><a class="toclink" href="../../software/2022/07/26/invalid-date-timezone/">invalid date 报错与时区的关系</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/26/invalid-date-timezone/#_1">背景</a></h3>
<p>最近在验题的时候，@HarryChen 发现了一个现象：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-1"></a>$<span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;1919-04-13&quot;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-2"></a>date:<span class="w"> </span>invalid<span class="w"> </span>date<span class="w"> </span>‘1919-04-13’
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-3"></a>$<span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC<span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;1919-04-13&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-4"></a>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">00</span>:00:00<span class="w"> </span>UTC<span class="w"> </span><span class="m">1919</span>
</span></code></pre></div>
<p>也就是说，这个现象与时区有关，那么为啥 <code>1919-04-13</code> 是一个不合法的日期呢？</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/26/invalid-date-timezone/#_2">时区</a></h3>
<p>实际上，对于某一个时区来说，有的时间是不存在的，最常见的就是夏令时。在 <a href="https://timezonedb.com/time-zones/Asia/Shanghai">Timezone DB</a> 里可以看到，恰好在 1919 年 4 月 13 日发生了一次 UTC+8 到 UTC+9 的变化，因此零点变成了一点，就变成了不合法的日期。</p>
<p>这个数据，实际上保存在 tzdata 中，可以用 zdump 工具查看：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-1"></a>$<span class="w"> </span>tzdata<span class="w"> </span>-v<span class="w"> </span>Asia/Shanghai
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-2"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Dec<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">20</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Dec<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">04</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-3"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Dec<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">20</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Dec<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">04</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-4"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-5"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-6"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-7"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-8"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-9"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Jun<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-10"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-11"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-12"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-13"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Mar<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-14"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-15"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-16"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1942</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1942</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-17"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1942</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Jan<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1942</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-18"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1945</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1945</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-19"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1945</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1945</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-20"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-21"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Wed<span class="w"> </span>May<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-22"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-23"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-24"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-25"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-26"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-27"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-28"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-29"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-30"></a>Asia/Shanghai<span class="w">  </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-31"></a>Asia/Shanghai<span class="w">  </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-32"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-33"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-34"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-35"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-36"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-37"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-38"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-39"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-40"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-41"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-42"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-43"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-44"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-45"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-46"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-47"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-48"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-49"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-50"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-51"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-52"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-53"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-54"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-55"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-56"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-57"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-58"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-59"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-60"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Jan<span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">03</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Jan<span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">11</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-61"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Jan<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">03</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Jan<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">11</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div>
<p>可以看到，它列出来了历史上 Asia/Shanghai 时区的变化历史。具体的历史，可以查看 <a href="https://zh.wikipedia.org/zh-cn/%E4%B8%AD%E5%9C%8B%E6%99%82%E5%8D%80">中国时区</a>。</p>
<p>此外，历史上，从儒略历到格里高利历的演变过程，也出现了一段“不存在”的日期，如 <a href="https://stackoverflow.com/questions/35194544/setting-october-14-1582-fails-in-java-sql-date">Setting October 14 ,1582 fails in java.sql.Date</a>。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/07/26/invalid-date-timezone/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-16 00:00:00">2022年7月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 14 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ceph-cookbook"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/">Ceph Cookbook</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_1">概念</a></h3>
<ul>
<li>OSD：负责操作硬盘的程序，一个硬盘一个 OSD</li>
<li>MON：管理集群状态，比较重要，可以在多个节点上各跑一个</li>
<li>MGR：监测集群状态</li>
<li>RGW(optional)：提供对象存储 API</li>
<li>MDS(optional)：提供 CephFS</li>
</ul>
<p>使用 Ceph 做存储的方式：</p>
<ol>
<li>librados: 库</li>
<li>radosgw: 对象存储 HTTP API</li>
<li>rbd: 块存储</li>
<li>cephfs: 文件系统</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_2">认证</a></h3>
<p>Ceph 客户端认证需要用户名 + 密钥。默认情况下，用户名是 <code>client.admin</code>，密钥路径是 <code>/etc/ceph/ceph.用户名.keyring</code>。<code>ceph --user abc</code> 表示以用户 <code>client.abc</code> 的身份访问集群。</p>
<p>用户的权限是按照服务类型决定的。可以用 <code>ceph auth ls</code> 显示所有的用户以及权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-1"></a>$<span class="w"> </span>ceph<span class="w"> </span>auth<span class="w"> </span>ls
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-2"></a>osd.0
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-3"></a><span class="w">        </span>key:<span class="w"> </span>REDACTED
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-4"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mgr<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>profile<span class="w"> </span>osd
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-5"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mon<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>profile<span class="w"> </span>osd
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-6"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>osd<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-7"></a>client.admin
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-8"></a><span class="w">        </span>key:<span class="w"> </span>REDACTED
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-9"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mds<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-10"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mgr<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-11"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mon<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-12"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>osd<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span></code></pre></div>
<p>可以看到，<code>osd.0</code> 对 OSD 有所有权限，对 mgr 和 mon 都只有 osd 相关功能的权限；<code>client.admin</code> 有所有权限。<code>profile</code> 可以认为是预定义的一些权限集合。</p>
<p>新建用户并赋予权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-1-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>get-or-create<span class="w"> </span>client.abc<span class="w"> </span>mon<span class="w"> </span><span class="s1">&#39;allow r&#39;</span>
</span></code></pre></div>
<p>修改权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-2-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>caps<span class="w"> </span>client.abc<span class="w"> </span>mon<span class="w"> </span><span class="s1">&#39;allow rw&#39;</span>
</span></code></pre></div>
<p>获取权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-3-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>get<span class="w"> </span>client.abc
</span></code></pre></div>
<p>删除用户：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-4-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>print-key<span class="w"> </span>client.abc
</span></code></pre></div>
<h3 id="osd"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#osd">OSD</a></h3>
<p>管理 OSD 实际上就是管理存储数据的硬盘。</p>
<p>查看状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-5-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>stat
</span></code></pre></div>
<p>显示有多少个在线和离线的 OSD。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-6-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>tree
</span></code></pre></div>
<p>显示了存储的层级，其中 ID 非负数是实际的 OSD，负数是其他层级，例如存储池，机柜，主机等等。</p>
<h3 id="crush"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#crush">CRUSH</a></h3>
<p>CRUSH 是一个算法，指定了如何给 PG 分配 OSD，到什么类型的设备，确定它的 failure domain 等等。例如，如果指定 failure domain 为 host，那么它就会分配到不同 host 上的 osd，这样一个 host 挂了不至于全军覆没。类似地，还可以设定更多级别的 failure domain，例如 row，rack，chassis 等等。</p>
<p>OSD 可以设置它的 CRUSH Location，在 ceph.conf 中定义。</p>
<p>为了配置数据置放的规则，需要设置 CRUSH Rule。</p>
<p>列举 CRUSH Rule：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-7-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>ls
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-7-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>dump
</span></code></pre></div>
<p>查看 CRUSH 层级：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-8-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>tree<span class="w"> </span>--show-shadow
</span></code></pre></div>
<p>在里面可能会看到 <code>default~ssd</code>，它指的意思就是只保留 default 下面的 ssd 设备。</p>
<p>文本形式导出 CRUSH 配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-9-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>getcrushmap<span class="w"> </span><span class="p">|</span><span class="w"> </span>crushtool<span class="w"> </span>-d<span class="w"> </span>-<span class="w"> </span>-o<span class="w"> </span>crushmap
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-9-2"></a>cat<span class="w"> </span>crushmap
</span></code></pre></div>
<p>可以看到 Rule 的定义，如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-1"></a>## simple replicated
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-2"></a>rule replicated_rule {
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-3"></a>        id 0
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-4"></a>        # a replicated rule
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-5"></a>        type replicated
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-6"></a>        # iterate all devices of &quot;default&quot;
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-7"></a>        step take default
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-8"></a>        # select n osd with failure domain &quot;osd&quot;
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-9"></a>        # firstn: continuous
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-10"></a>        step chooseleaf firstn 0 type osd
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-11"></a>        step emit
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-12"></a>}
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-13"></a>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-14"></a>## erasure on hdd
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-15"></a>rule erasure-hdd {
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-16"></a>        id 4
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-17"></a>        # an erasure rule
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-18"></a>        type erasure
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-19"></a>        # try more times to find a good mapping
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-20"></a>        step set_chooseleaf_tries 5
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-21"></a>        step set_choose_tries 100
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-22"></a>        # iterate hdd devices of &quot;default&quot;, i.e. &quot;default~hdd&quot;
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-23"></a>        step take default class hdd
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-24"></a>        # select n osd with failure domain &quot;osd&quot;
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-25"></a>        # indep: replace failed osd with another
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-26"></a>        step choose indep 0 type osd
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-27"></a>        step emit
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-28"></a>}
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-29"></a>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-30"></a>## replicated on hdd
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-31"></a>rule replicated-hdd-osd {
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-32"></a>        id 5
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-33"></a>        # a replicated rule
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-34"></a>        type replicated
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-35"></a>        # iterate hdd devices of &quot;default&quot;, i.e. &quot;default~hdd&quot;
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-36"></a>        step take default class hdd
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-37"></a>        # select n osd with failure domain &quot;osd&quot;
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-38"></a>        # firstn: continuous
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-39"></a>        step choose firstn 0 type osd
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-40"></a>        step emit
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-41"></a>}
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-42"></a>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-43"></a>## replicated on different hosts
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-44"></a>rule replicated-host {
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-45"></a>        id 6
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-46"></a>        # a replicated rule
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-47"></a>        type replicated
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-48"></a>        # iterate all devices of &quot;default&quot;
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-49"></a>        step take default
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-50"></a>        # select n osd with failure domain &quot;host&quot;
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-51"></a>        # firstn: continuous
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-52"></a>        step chooseleaf firstn 0 type host
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-53"></a>        step emit
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-54"></a>}
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-55"></a>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-56"></a>## replicate one on ssd, two on hdd
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-57"></a>rule replicated-ssd-primary {
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-58"></a>        id 7
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-59"></a>        # a replicated rule
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-60"></a>        type replicated
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-61"></a>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-62"></a>        # iterate ssd devices of &quot;default&quot;
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-63"></a>        step take default class ssd
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-64"></a>        step chooseleaf firstn 1 type host
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-65"></a>        step emit
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-66"></a>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-67"></a>        # iterate hdd devices of &quot;default&quot;
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-68"></a>        step take default class hdd
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-69"></a>        step chooseleaf firstn 2 type host
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-70"></a>        step emit
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-71"></a>}
</span></code></pre></div>
<p>choose 和 chooseleaf 的区别是，前者可以 choose 到中间层级，例如先选择 host，再在 host 里面选 osd；而 chooseleaf 是直接找到 osd。所以 <code>choose type osd</code> 和 <code>chooseleaf type osd</code> 是等价的。</p>
<p>如果这个搜索条件比较复杂，例如找到了某一个 host，里面的 osd 个数不够，就需要重新搜。</p>
<p>新建一个 Replicated CRUSH Rule：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-1"></a><span class="c1">## root=default, failure domain=osd</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>create-replicated<span class="w"> </span>xxx<span class="w"> </span>default<span class="w"> </span>osd
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-3"></a><span class="c1">## root=default, failure domain=host, class=ssd</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-4"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>create-replicated<span class="w"> </span>yyy<span class="w"> </span>default<span class="w"> </span>host<span class="w"> </span>ssd
</span></code></pre></div>
<p>如果指定了 device class，它只会在对应类型的设备上存储。</p>
<h3 id="pool"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#pool">Pool</a></h3>
<p>Pool 是存储池，后续的 RBD/CephFS 功能都需要指定存储池来工作。</p>
<p>创建存储池：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-12-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>create<span class="w"> </span>xxx
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-12-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>create<span class="w"> </span>PG_NUM
</span></code></pre></div>
<p>为了性能考虑，可以设置 PG（Placement Group）数量。默认情况下，会创建 replicated 类型的存储池，也就是会存多份，类似 RAID1。也可以设置成 erasure 类型的存储池，类似 RAID5。</p>
<p>每个 Placement Group 里的数据会保存在同一组 OSD 中。数据通过 hash，会分布在不同的 PG 里。</p>
<p>列举所有的存储池：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-13-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>lspools
</span></code></pre></div>
<p>查看存储池的使用量：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-14-1"></a>rados<span class="w"> </span>df
</span></code></pre></div>
<p>存储池的 IO 状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-15-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>stats
</span></code></pre></div>
<p>对存储池做快照：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-16-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>mksnap<span class="w"> </span>xxx<span class="w"> </span>snap-xxx-123
</span></code></pre></div>
<h4 id="pg"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#pg">PG</a></h4>
<p>PG 是数据存放的组，每个对象都会放到一个 PG 里面，而 PG 会决定它保存到哪些 OSD 上（具体哪些 OSD 是由 CRUSH 决定的）。PG 数量只有一个的话，那么一个 pool 的所有数据都会存放在某几个 OSD 中，一旦这几个 OSD 都不工作了，那么整个 pool 的数据都不能访问了。PG 增多了以后，就会分布到不同的 OSD 上，并且各个 OSD 的占用也会比较均匀。</p>
<p>查看 PG 状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-17-1"></a>ceph<span class="w"> </span>pg<span class="w"> </span>dump
</span></code></pre></div>
<h5 id="auto-scale"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#auto-scale">Auto Scale</a></h5>
<p>PG 数量可以让集群自动调整：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-18-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span><span class="nb">set</span><span class="w"> </span>xxx<span class="w"> </span>pg_autoscale_mode<span class="w"> </span>on
</span></code></pre></div>
<p>设置 autoscale 目标为每个 OSD 平均 100 个 PG：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-19-1"></a>ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>global<span class="w"> </span>mon_target_pg_per_osd<span class="w"> </span><span class="m">100</span>
</span></code></pre></div>
<p>全局 autoscale 开关：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-1"></a><span class="c1">## Enable</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span><span class="nb">unset</span><span class="w"> </span>noautoscale
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-3"></a><span class="c1">## Disable</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-4"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span><span class="nb">set</span><span class="w"> </span>unautoscale
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-5"></a><span class="c1">## Read</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-6"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>get<span class="w"> </span>noautoscale
</span></code></pre></div>
<p>查看 autoscale 状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-21-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>autoscale-status
</span></code></pre></div>
<p>如果没有显示，说明 autoscale 没有工作，可能的原因是，部分 pool 采用了指定 osd class 的 crush rule，例如指定了 hdd 盘，但是也有部分 pool 没有指定盘的类型，例如默认的 replicated_rule。这时候，把这些盘也设置成一个指定 osd class 的 crush rule 即可。</p>
<h3 id="rbd"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#rbd">RBD</a></h3>
<p>RBD 把 Ceph 暴露为块设备。</p>
<h4 id="_3"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_3">创建</a></h4>
<p>初始化 Pool 用于 RBD：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-22-1"></a>rbd<span class="w"> </span>pool<span class="w"> </span>init<span class="w"> </span>xxx
</span></code></pre></div>
<p>为了安全性考虑，一般会为 RBD 用户创建单独的用户：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-23-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>get-or-create<span class="w"> </span>client.abc<span class="w"> </span>mon<span class="w"> </span><span class="s1">&#39;profile rbd&#39;</span><span class="w"> </span>osd<span class="w"> </span><span class="s1">&#39;profile rbd pool=xxx&#39;</span><span class="w"> </span>mgr<span class="w"> </span><span class="s1">&#39;profile rbd pool=xxx&#39;</span>
</span></code></pre></div>
<p>创建 RBD 镜像：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-24-1"></a>rbd<span class="w"> </span>create<span class="w"> </span>--size<span class="w"> </span><span class="m">1024</span><span class="w"> </span>xxx/yyy
</span></code></pre></div>
<p>表示在 Pool xxx 上面创建了一个名字为 yyy 大小为 1024MB 的镜像。</p>
<h4 id="_4"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_4">状态</a></h4>
<p>列举 Pool 里的镜像：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-25-1"></a>rbd<span class="w"> </span>ls
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-25-2"></a>rbd<span class="w"> </span>ls<span class="w"> </span>xxx
</span></code></pre></div>
<p>默认的 Pool 名字是 <code>rbd</code>。</p>
<p>查看镜像信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-26-1"></a>rbd<span class="w"> </span>info<span class="w"> </span>yyy
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-26-2"></a>rbd<span class="w"> </span>info<span class="w"> </span>xxx/yyy
</span></code></pre></div>
<h4 id="_5"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_5">扩容</a></h4>
<p>修改镜像的容量：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-27-1"></a>rbd<span class="w"> </span>resize<span class="w"> </span>--size<span class="w"> </span><span class="m">2048</span><span class="w"> </span>yyy
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-27-2"></a>rbd<span class="w"> </span>resize<span class="w"> </span>--size<span class="w"> </span><span class="m">512</span><span class="w"> </span>yyy<span class="w"> </span>--allow-shrink
</span></code></pre></div>
<h4 id="_6"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_6">挂载</a></h4>
<p>在其他机器挂载 RBD 的时候，首先要修改 <code>/etc/ceph</code> 下配置，确认有用户，密钥和 MON 的地址。</p>
<p>然后，用 rbd 挂载设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-28-1"></a>rbd<span class="w"> </span>device<span class="w"> </span>map<span class="w"> </span>xxx/yyy<span class="w"> </span>--id<span class="w"> </span>abc
</span></code></pre></div>
<p>以用户 abc 的身份挂载 Pool xxx 下面的 yyy 镜像。</p>
<p>这时候就可以在 <code>/dev/rbd*</code> 或者 <code>/dev/rbd/</code> 下面看到设备文件了。</p>
<p>显示已经挂载的设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-29-1"></a>rbd<span class="w"> </span>device<span class="w"> </span>list
</span></code></pre></div>
<h3 id="cephfs"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#cephfs">CephFS</a></h3>
<h4 id="_7"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_7">创建</a></h4>
<p>如果配置了编排器（Orchestrator），可以直接用命令：</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-30-1"></a>ceph<span class="w"> </span>fs<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>xxx
</span></code></pre></div>
创建一个名为 <code>xxx</code> 的 CephFS。</p>
<p>也可以手动创建：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-31-1"></a>ceph osd pool create xxx_data0
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-31-2"></a>ceph osd pool create xxx_metadata
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-31-3"></a>ceph fs new xxx xxx_metadata xxx_data0
</span></code></pre></div>
<p>这样就创建了两个 pool，分别用于存储元数据和文件数据。一个 CephFS 需要一个 pool 保存元数据，若干个 pool 保存文件数据。</p>
<p>创建了 CephFS 以后，相应的 MDS 也会启动。</p>
<h4 id="_8"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_8">状态</a></h4>
<p>查看 MDS 状态：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-32-1"></a>ceph mds stat
</span></code></pre></div>
<h4 id="_9"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_9">客户端配置</a></h4>
<p>在挂载 CephFS 之前，首先要配置客户端。</p>
<p>在集群里运行 <code>ceph config generate-minimal-conf</code>，它会生成一个配置文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-1"></a>$<span class="w"> </span>ceph<span class="w"> </span>config<span class="w"> </span>generate-minimal-conf
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-2"></a><span class="c1">## minimal ceph.conf for &lt;fsid&gt;</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-3"></a><span class="o">[</span>global<span class="o">]</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-4"></a><span class="w">        </span><span class="nv">fsid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;fsid&gt;
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-5"></a><span class="w">        </span><span class="nv">mon_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>v2:x.x.x.x:3300/0,v1:x.x.x.x:6789/0<span class="o">]</span>
</span></code></pre></div>
<p>把内容复制到客户端的 <code>/etc/ceph/ceph.conf</code>。这样客户端就能找到集群的 MON 地址和 FSID。</p>
<p>接着，我们在集群上给客户端创建一个用户：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-34-1"></a>ceph fs authorize xxx client.abc / rw
</span></code></pre></div>
<p>创建一个用户 abc，对 CephFS xxx 有读写的权限。把输出保存到客户端的 <code>/etc/ceph/ceph.client.abc.keyring</code> 即可。</p>
<h4 id="_10"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_10">挂载</a></h4>
<p>挂载：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-1"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@.xxx<span class="o">=</span>/<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-2"></a><span class="c1">## or</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-3"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@&lt;fsid&gt;.xxx<span class="o">=</span>/<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-4"></a><span class="c1">## or</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-5"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@&lt;fsid&gt;.xxx<span class="o">=</span>/<span class="w"> </span>-o<span class="w"> </span><span class="nv">mon_addr</span><span class="o">=</span>x.x.x.x:6789,secret<span class="o">=</span>REDACTED<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-6"></a><span class="c1">##or</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-7"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@.xxx<span class="o">=</span>/<span class="w"> </span>-o<span class="w"> </span><span class="nv">mon_addr</span><span class="o">=</span>x.x.x.x:6789/y.y.y.y:6789,secretfile<span class="o">=</span>/etc/ceph/xxx.secret<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-8"></a><span class="c1">## or</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-9"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>-o<span class="w"> </span><span class="nv">name</span><span class="o">=</span>client.abc,secret<span class="o">=</span>REDACTED,mds_namespace<span class="o">=</span>xxx<span class="w"> </span>MON_IP:/<span class="w"> </span>MOUNTPOINT
</span></code></pre></div>
<p>以用户 <code>client.abc</code> 的身份登录，挂载 CepFS <code>xxx</code> 下面的 <code>/</code> 目录到 <code>MOUNTPOINT</code>。它会读取 <code>/etc/ceph</code> 下面的配置，如果已经 <code>ceph.conf</code> 写了，命令行里就可以不写。</p>
<p>fsid 指的不是 CephFS 的 ID，实际上是集群的 ID：<code>ceph fsid</code>。</p>
<h4 id="_11"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_11">限额</a></h4>
<p>CephFS 可以对目录进行限额：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-1"></a>setfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_bytes<span class="w"> </span>-v<span class="w"> </span>LIMIT<span class="w"> </span>PATH
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-2"></a>setfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_files<span class="w"> </span>-v<span class="w"> </span>LIMIT<span class="w"> </span>PATH
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-3"></a>getfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_bytes<span class="w"> </span>PATH
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-4"></a>getfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_files<span class="w"> </span>PATH
</span></code></pre></div>
<p>限制目录大小和文件数量。LIMIT 是 0 的时候表示没有限制。</p>
<h4 id="nfs"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#nfs">NFS</a></h4>
<p>可以把 CephFS 或者 RGW 通过 NFS 的方式共享出去。</p>
<p>启动 NFS 服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-37-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>create<span class="w"> </span>xxx
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-37-2"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>create<span class="w"> </span>xxx<span class="w"> </span><span class="s2">&quot;host1,host2&quot;</span>
</span></code></pre></div>
<p>在主机上运行 NFS 服务器，NFS 集群的名字叫做 xxx。</p>
<p>查看 NFS 集群信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-38-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>info<span class="w"> </span>xxx
</span></code></pre></div>
<p>列举所有 NFS 集群：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-39-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>ls
</span></code></pre></div>
<p>NFS 导出 CephFS：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-40-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span><span class="nb">export</span><span class="w"> </span>create<span class="w"> </span>cephfs<span class="w"> </span>--cluster-id<span class="w"> </span>xxx<span class="w"> </span>--pseudo-path<span class="w"> </span>/a/b/c<span class="w"> </span>--fsname<span class="w"> </span>some-cephfs-name<span class="w"> </span><span class="o">[</span>--path<span class="o">=</span>/d/e/f<span class="o">]</span><span class="w"> </span><span class="o">[</span>--client_addr<span class="w"> </span>y.y.y.y<span class="o">]</span>
</span></code></pre></div>
<p>这样就导出了 CephFS 内的一个目录，客户端可以通过 NFS 挂载 /a/b/c 路径（pseudo path）来访问。可以设置客户端的 IP 访问权限。</p>
<p>这样在客户端就可以 mount：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-41-1"></a>mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span>x.x.x.x:/a/b/c<span class="w"> </span>/mnt
</span></code></pre></div>
<h3 id="radosgw"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#radosgw">RadosGW</a></h3>
<p>RGW 提供了 S3 或者 OpenStack Swift 兼容的对象存储 API。</p>
<p>TODO</p>
<h3 id="_12"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_12">编排器</a></h3>
<p>由于 Ceph 需要运行多个 daemon，并且都在不同的容器中运行，所以一般会跑一个系统级的编排器，用于新增和管理这些容器。</p>
<p>查看当前编排器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-1"></a>$<span class="w"> </span>ceph<span class="w"> </span>orch<span class="w"> </span>status
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-2"></a>Backend:<span class="w"> </span>cephadm
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-3"></a>Available:<span class="w"> </span>Yes
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-4"></a>Paused:<span class="w"> </span>No
</span></code></pre></div>
<p>比较常见的就是 cephadm，安装的时候如果用了 cephadm，那么编排器也是它。</p>
<p>被编排的服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-43-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ls
</span></code></pre></div>
<p>被编排的容器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-44-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ps
</span></code></pre></div>
<p>被编排的主机：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-45-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>host<span class="w"> </span>ls
</span></code></pre></div>
<h4 id="_13"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_13">添加新机器</a></h4>
<p>首先，复制 <code>/etc/ceph/ceph.pub</code> 到新机器的 <code>/root/.ssh/authorized_keys</code> 中</p>
<p>接着，添加机器到编排器中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-46-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>host<span class="w"> </span>add<span class="w"> </span>xxxx<span class="w"> </span>y.y.y.y
</span></code></pre></div>
<p>导出编排器配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-47-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ls<span class="w"> </span>--export<span class="w"> </span>&gt;<span class="w"> </span>cephadm.yaml
</span></code></pre></div>
<p>如果想让一些 daemon 只运行在部分主机上，可以修改：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-1"></a><span class="c1">## change</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-2"></a><span class="nt">placement</span><span class="p">:</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-3"></a><span class="w">  </span><span class="nt">host_pattern</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-4"></a><span class="c1">## to</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-5"></a><span class="nt">placement</span><span class="p">:</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-6"></a><span class="w">  </span><span class="nt">host_pattern</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
</span></code></pre></div>
<p>然后应用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-49-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>-i<span class="w"> </span>cephadm.yaml
</span></code></pre></div>
<h4 id="_14"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_14">配置监控</a></h4>
<p>添加监控相关的服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>node-exporter
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-2"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>alertmanager
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-3"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>prometheus
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-4"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>grafana
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-5"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ps
</span></code></pre></div>
<p>然后就可以访问 Grafana 看到集群的状态。</p>
<h3 id="_15"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_15">更新</a></h3>
<p>使用容器编排器来升级：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-51-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>upgrade<span class="w"> </span>start<span class="w"> </span>--ceph-version<span class="w"> </span>x.x.x
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-51-2"></a>ceph<span class="w"> </span>orch<span class="w"> </span>upgrade<span class="w"> </span>start<span class="w"> </span>--image<span class="w"> </span>quay.io/ceph/ceph:vx.x.x
</span></code></pre></div>
<p>如果 docker hub 上找不到 image，就从 quay.io 拉取。</p>
<p>查看升级状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-52-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>upgrade<span class="w"> </span>status
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-52-2"></a>ceph<span class="w"> </span>-s
</span></code></pre></div>
<p>查看 cephadm 日志：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-53-1"></a>ceph<span class="w"> </span>-W<span class="w"> </span>cephadm
</span></code></pre></div>
<h3 id="_16"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_16">参考文档</a></h3>
<ul>
<li><a href="https://docs.ceph.com/en/latest/architecture/">Ceph Architecture</a></li>
<li><a href="https://docs.ceph.com/en/latest/rados/operations/user-management/">Ceph User Management</a></li>
<li><a href="https://docs.ceph.com/en/latest/cephfs/createfs/">Ceph Create a Ceph File System</a></li>
<li><a href="https://docs.ceph.com/en/latest/man/8/mount.ceph/">mount.ceph</a></li>
<li><a href="https://docs.ceph.com/en/latest/cephfs/quota/">Ceph CephFS Quota</a></li>
<li><a href="https://docs.ceph.com/en/latest/rbd/rados-rbd-cmds/">Ceph Basic Block Device Commands</a></li>
<li><a href="https://docs.ceph.com/en/quincy/cephadm/upgrade/">Ceph Upgrade</a></li>
<li><a href="https://docs.ceph.com/en/latest/mgr/nfs/">Ceph CephFS &amp; RGW Exports Over NFS</a></li>
<li><a href="https://docs.ceph.com/en/quincy/rados/operations/crush-map/">CRUSH Maps</a></li>
<li><a href="https://docs.ceph.com/en/latest/rados/operations/crush-map-edits/">CRUSH Map Edits</a></li>
<li><a href="https://llussy.github.io/2019/08/17/ceph-architecture/">ceph 架构和概念</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/5/html/object_gateway_guide/the-ceph-object-gateway_rgw">RedHat Object Gateway Guide</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../devops/2022/07/16/ceph-cookbook/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-12 00:00:00">2022年7月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/programming/" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 19 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/">编程作业中的学术诚信</a></h2>
<p>本文是我自己对 <a href="https://integrity.mit.edu/handbook/writing-code">Academic Integrity at MIT: Writing Code</a> 的非官方中文翻译。本文已经得到了官方的邮件授权。</p>
<h3 id="writing-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#writing-code">编写代码 Writing Code</a></h3>
<p>与学术写作类似，当你在做课程项目的时候，如果使用了或者改编了其他人开发的代码，你必须要引用代码的来源。你可以在代码注释中引用代码来源。这些注释不仅保护了他人的劳动成果，也会帮助你理解代码和调试。</p>
<div class="language-text highlight"><pre><span></span><code>Writing code is similar to academic writing in that when you use or
adapt code developed by someone else as part of your project, you must
cite your source. However, instead of quoting or paraphrasing a source,
you include an inline comment in the code. These comments not only
ensure you are giving proper credit, but help with code understanding
and debugging.
</code></pre></div>
<h3 id="when-should-i-cite-a-source-in-my-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#when-should-i-cite-a-source-in-my-code">什么时候应该在代码中引用来源？When should I cite a source in my code?</a></h3>
<ol>
<li>
<p>当你从外部来源复制了代码。无论你是复制了代码片段，还是一整个模块，你都需要引用来源。</p>
<div class="language-text highlight"><pre><span></span><code>When you copy code from an external source. Whether you are copying a
snippet of code or an entire module, you should credit the source.
</code></pre></div>
</li>
<li>
<p>当你复制了代码并做了改动，你依然要引用来源。你并不是代码的原作者。</p>
<div class="language-text highlight"><pre><span></span><code>When you copy the code and adapt it, you should still credit the source.
You were not the original developer of the code.
</code></pre></div>
</li>
</ol>
<h3 id="how-should-i-cite-the-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#how-should-i-cite-the-code">我应该如何引用代码？How should I cite the code?</a></h3>
<ol>
<li>
<p>通常来说，代码的网址和下载时间就足够了。如果可以让读者更加清晰地了解到代码来源，可以增加更多的细节。</p>
<div class="language-text highlight"><pre><span></span><code>Generally, the URL and the date of retrieval are sufficient. Add
more details if it will help the reader get a clearer
understanding of the source.
</code></pre></div>
</li>
<li>
<p>如果你修改了代码，你需要注明：“Adapted from:”（修改自）或者“Based on”（基于）。这样读者就知道你修改了代码。</p>
<div class="language-text highlight"><pre><span></span><code>If you adapted the code, you should indicate “Adapted from:” or
“Based on” so it is understood that you modified the code.
</code></pre></div>
</li>
<li>
<p>你的老师可能会对你如何引用代码有具体的要求。如果你不能确认什么是可行的，请询问你的老师。</p>
<div class="language-text highlight"><pre><span></span><code>Your instructor may have specific instructions on how you should
or should not cite your sources. If you are not clear on what is
acceptable, ask your instructor.
</code></pre></div>
</li>
</ol>
<h3 id="use-of-open-source-software"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#use-of-open-source-software">开源软件的使用 Use of Open Source Software</a></h3>
<p>当你使用开源软件项目的代码的时候，你不仅要注明代码的来源，还需要遵循代码的开源软件许可证。请记住：</p>
<div class="language-text highlight"><pre><span></span><code>When you use code from an open source project, you need both to
attribute the source and follow the terms of any open source license
that applies to the code you are using. Keep in mind:
</code></pre></div>
<ol>
<li>
<p>当你下载源码的时候，它的开源软件许可证通常也在源码中。</p>
<div class="language-text highlight"><pre><span></span><code>When you download the source, the license is typically part of the
download.
</code></pre></div>
</li>
<li>
<p>同时，代码里也通常会包括它的版权和使用条款。</p>
<div class="language-text highlight"><pre><span></span><code>Also, the source code itself will typically contain the
copyright and terms of use.
</code></pre></div>
</li>
<li>
<p>当你引入了开源代码，并且它附带了开源软件许可证，你应该把它的版权声明复制到你的代码中，和/或把许可证复制到代码目录中的文件。</p>
<div class="language-text highlight"><pre><span></span><code>When you incorporate open-source-licensed code into a program,
it is good practice to duplicate the copyright in your code,
and/or store the license in a file with the code.
</code></pre></div>
</li>
<li>
<p>如果在下载的文件里没有找到开源软件许可证，你可以在开源项目的网站上找到全文，如 <a href="https://httpd.apache.org/">Apache HTTP Server 网站</a> 或者 <a href="https://opensource.org/">Open Source Initiative (OSI) 网站</a>。</p>
<div class="language-text highlight"><pre><span></span><code>If you don’t obtain the license with the download, you should be
able to find it on the site of the open source project, such as
Apache HTTP Server site, or on the Open Source Initiative (OSI)
site.
</code></pre></div>
</li>
</ol>
<h3 id="instructors-determine-the-specific-expectations-around-re-use-of-code-in-each-class"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#instructors-determine-the-specific-expectations-around-re-use-of-code-in-each-class">老师决定具体的代码复用程度 Instructors determine the specific expectations around re-use of code in each class.</a></h3>
<p>通常，老师会确定课程的协作规则。如果这个规则没有明确地给出来，或者你不确认什么是可行的，请询问你的老师。</p>
<div class="language-text highlight"><pre><span></span><code>Often, the requirements are described in the collaboration policy for
the class. If policy is not clearly described in the course materials
and you are not sure what is acceptable, ask your instructor.
</code></pre></div>
<h4 id="_2"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#_2">例子</a></h4>
<p>下面给出一个例子，是课程（Spring 2012 6.005 Elements of Software Construction）的协作规则：</p>
<div class="language-text highlight"><pre><span></span><code>Collaboration policy from Spring 2012 6.005 Elements of Software
Construction: (used with the permission of Professor Rob Miller, Dept of
Electrical Engineering &amp; Computer Science)
</code></pre></div>
<p>我们鼓励同学们互相帮助，但是为了保证每个人都有良好的独立学习体验，我们对你们做了如下的限制：</p>
<div class="language-text highlight"><pre><span></span><code>We encourage you to help each other with work in this class, but there
are limits to what you can do, to ensure that everybody has a good
individual learning experience.
</code></pre></div>
<h5 id="individual-work"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#individual-work">单人作业 Individual work</a></h5>
<p>课程里的习题都要单人完成。我们鼓励同学们讨论实现方法，但是你的代码和报告都需要自己完成。</p>
<div class="language-text highlight"><pre><span></span><code>Problem sets in this class are intended to be primarily individual
efforts. You are encouraged to discuss approaches with other students
but your code and your write-up must be your own.
</code></pre></div>
<p>你不能使用其他同学编写的资料，无论是这个学期还是以往学期的同学。你也不可以把你的成果提供给其他同学。</p>
<div class="language-text highlight"><pre><span></span><code>You may not use materials produced as course work by other students,
whether in this term or previous terms, nor may you provide work for
other students to use.
</code></pre></div>
<p>帮助其他同学是应该的。但要保证一个原则，当你在帮助其他同学的时候，你自己的答案或代码不应该可以看到，无论是自己还是其他同学。可以养成一个习惯，帮助他人的时候把笔记本电脑合上。</p>
<div class="language-text highlight"><pre><span></span><code>It’s good to help other students. But as a general rule, during the time
that you are helping another student, your own solution should not be
visible, either to you or to them. Make a habit of closing your laptop
while you’re helping.
</code></pre></div>
<p>在帮助其他同学，阅读同学的代码的时候，你会看到同学的解答。你可以从同学的方法里获得灵感，但是不能复制他们的成果。</p>
<div class="language-text highlight"><pre><span></span><code>During code review, you will see classmates’ solutions to a problem set.
While it is fine to take inspiration from their approach, do not copy
their work.
</code></pre></div>
<p>你可以用外部网站上的资料，比如 StackOverflow，但前提是加上引用，并且作业要求里允许这么做。特别地，如果作业要求里写了“实现 X 功能”，那么你必须自己实现 X 功能，而不能复用外部的代码。</p>
<div class="language-text highlight"><pre><span></span><code>It’s fine to use material from external sources like StackOverflow, but
only with proper attribution, and only if the assignment allows it. In
particular, if the assignment says “implement X,” then you must create
your own X, not reuse one from an external source.
</code></pre></div>
<p>你也可以用课程组提供的代码，不需要引用。老师提供的代码在未经允许的情况下，不能公开分享，我们后面会讨论这个问题。</p>
<div class="language-text highlight"><pre><span></span><code>It’s also fine to use any code provided by this semester’s 6.031 staff
(in class, readings, or problem sets), without need for attribution.
Staff-provided code may not be publicly shared without permission,
however, as discussed later in this document.
</code></pre></div>
<p>例子一 Example 1：</p>
<ul>
<li>
<p>A 和 B 做作业的时候坐在一起。他们简略地讨论实现的不同方法。他们在白板上画流程图。当 A 发现 Java 标准库中一个有用的类，她把这个发现告诉了 B。当 B 发现了 StackOverflow 上的一个回答，他给 A 发送了 URL。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Alyssa and Ben sit next to each other with their laptops while
working on a problem set. They talk in general terms about
different approaches to doing the problem set. They draw
diagrams on the whiteboard. When Alyssa discovers a useful class
in the Java library, she mentions it to Ben. When Ben finds a
StackOverflow answer that helps, he sends the URL to Alyssa. OK.
</code></pre></div>
</li>
<li>
<p>在他们编写代码的时候，他们把代码大声念出来，好让双方都可以编写正确的代码。错误！</p>
<div class="language-text highlight"><pre><span></span><code>As they type lines of code, they speak the code aloud to the
other person, to make sure both people have the right code.
INAPPROPRIATE.
</code></pre></div>
</li>
<li>
<p>在作业最困难的部分，A 和 B 互相看电脑屏幕，并对比代码，确认他们代码实现都是正确的。错误！</p>
<div class="language-text highlight"><pre><span></span><code>In a tricky part of the problem set, Alyssa and Ben look at each
other’s screens and compare them so that they can get their code
right. INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子二 Example 2：</p>
<ul>
<li>
<p>J 已经完成了作业，但是他的朋友 B 正在努力解决一个 bug。J 坐在 B 旁边，看他的代码，帮他调试出了问题。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Jerry already finished the problem set, but his friend Ben is
now struggling with a nasty bug. Jerry sits next to Ben, looks
at his code, and helps him debug. OK.
</code></pre></div>
</li>
<li>
<p>J 打开了自己的笔记本，找到自己的答案，然后指着自己的代码给 B 纠正错误。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Jerry opens his own laptop, finds his solution to the problem
set, and refers to it while he’s helping Ben correct his code.
INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子三 Example 3：</p>
<ul>
<li>
<p>L 这周有很多作业，但是因为时间和身体原因来不及做。他已经错过截止时间两天了，但基本没有什么进度。B 觉得 L 可怜，想要帮助 L。在 L 写作业的时候，B 告诉 L 他是怎么做作业的。B 已经提交了自己的答案，并且在帮助 L 的时候，不打开自己的笔记本电脑。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Louis had three problem sets and two quizzes this week, was away
from campus for several days for a track meet, and then got
sick. He’s already taken two slack days on the deadline and has
made almost no progress on the problem set. Ben feels sorry for
Louis and wants to help, so he sits down with Louis and talks
with him about how to do the problem set while Louis is working
on it. Ben already handed in his own solution, but he doesn’t
open his own laptop to look at it while he’s helping Louis. OK.
</code></pre></div>
</li>
<li>
<p>B 打开了自己的笔记本电脑，并且在帮助 L 的时候阅读自己的代码。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Ben opens his laptop and reads his own code while he’s helping
Louis. INAPPROPRIATE.
</code></pre></div>
</li>
<li>
<p>B 花了几个小时帮助 L，但是 L 还是没有完成。但是 B 需要去做自己的事情了。在 L 承诺只有在必要的时候才会看 B 的代码之后，B 把自己的代码上传到 Dropbox 并且分享给了 L。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Ben has by now spent a couple hours with Louis, and Louis still
needs help, but Ben really needs to get back to his own work. He
puts his code in a Dropbox and shares it with Louis, after Louis
promises only to look at it when he really has to.
INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子四 Example 4：</p>
<ul>
<li>J 和 E 独立完成作业。他们交换了自己的测例来检查作业。错误！测例是题目的一部分，也是学习体验的一部分。如果你使用了其他人的测例，就是在抄袭，即使只是临时的。<div class="language-text highlight"><pre><span></span><code>John and Ellen both worked on their problem sets separately.
They exchange their test cases with each other to check their
work. INAPPROPRIATE. Test cases are part of the material for the
problem set, and part of the learning experience of the course.
You are copying if you use somebody else’s test cases, even if
temporarily.
</code></pre></div>
</li>
</ul>
<p>注意，在上面的例子中，双方都负有学术不端的责任。抄袭作业，或者把自己的作业提供给他人，是一个很严重的事情，可能导致分数扣减，课程不及格甚至处分。抄袭作业，或者帮助他人抄袭，可能会给你的成绩单上添加一个不能消除的 F。</p>
<div class="language-text highlight"><pre><span></span><code>Note that in the examples marked inappropriate above, both people are
held responsible for the violation in academic honesty. Copying work, or
knowingly making work available for copying, in contravention of this
policy is a serious offense that may incur reduced grades, failing the
course, and disciplinary action. Copying, or helping somebody copy, may
result in an F on your transcript that you will not be able to drop.
</code></pre></div>
<p>上述的要求对课程所有的单人作业都使用。</p>
<div class="language-text highlight"><pre><span></span><code>This policy applies to all coursework that is handed in by an
individual: problem sets, reading exercises, nanoquiz makeups, etc.
</code></pre></div>
<h5 id="group-work"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#group-work">组队作业 Group work</a></h5>
<p>你应该和你的队友合作完成组队作业，并且每个人都应该有接近的任务量。</p>
<div class="language-text highlight"><pre><span></span><code>You should collaborate with your partners on all aspects of group
project work and in-class collaborative exercises, and each of you is
expected to contribute a roughly equal share to design and
implementation.
</code></pre></div>
<p>你可以复用自己在学期内早些时候编写的代码等（包括之前自己和其他队友完成的）。你也可以用课程提供的任何代码。</p>
<div class="language-text highlight"><pre><span></span><code>You may reuse designs, ideas and code from your own work earlier in the
semester (even if it was done with a different partner). You may also
use any code provided by this semester’s 6.031 staff.
</code></pre></div>
<p>你可以使用外部代码，只要：</p>
<ol>
<li>所有同学都可以访问这个资料</li>
<li>进行了合理的引用</li>
<li>作业允许你这么做</li>
</ol>
<p>特别地，如果作业要求你“实现 X 功能”，你就必须自己实现 X 功能，不能复用他人的。</p>
<p>你们组不能复用其他组的代码和思路，无论是其他组是当前学期还是以往学期的同学。</p>
<div class="language-text highlight"><pre><span></span><code>You may also use material from external sources, so long as: (1) the
material is available to all students in the class; (2) you give proper
attribution; and (3) the assignment itself allows it. In particular, if
the assignment says “implement X,” then you must create your own X, not
reuse someone else’s. Finally, your group may not reuse designs, ideas,
or code created by another group, in this semester or previous
semesters.
</code></pre></div>
<h3 id="although-it-is-common-practice-to-adapt-code-examples-found-on-the-web"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#although-it-is-common-practice-to-adapt-code-examples-found-on-the-web">即使修改网络上的代码很常见 Although it is common practice to adapt code examples found on the web,</a></h3>
<ul>
<li>
<p>你不能抄袭其他同学的代码。你的同学不是一个合法的代码来源。</p>
<div class="language-text highlight"><pre><span></span><code>You should never copy code from other students. Your peers are
not considered an authorized source.
</code></pre></div>
</li>
<li>
<p>你不能简单地复用网上的代码。就像学术写作，你可以采用别人的思路，但是你也要把自己的理解加进去。</p>
<div class="language-text highlight"><pre><span></span><code>You should not simply re-use code as the solution to an
assignment. Like academic writing, your code can incorporate the
ideas of others but should reflect your original approach to the
problem.
</code></pre></div>
</li>
</ul>
<h3 id="examples-of-citing-code-sources"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#examples-of-citing-code-sources">引用代码的例子 Examples of citing code sources</a></h3>
<p>例子一 Example 1：</p>
<p>在 Apache 项目的源码的 PluginProxyUtil 类中，开发者引用了论坛的 URL，作者和时间：</p>
<div class="language-text highlight"><pre><span></span><code>In describing the class PluginProxyUtil in the Apache Project source
code, the developer cites the source as a post in a forum and includes
the URL, author and date:
</code></pre></div>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-1"></a><span class="cm">/**</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-2"></a><span class="cm">* A utility class that gives applets the ability to detect proxy host settings.</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-3"></a><span class="cm">* This was adapted from a post from Chris Forster on 20030227 to a Sun Java</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-4"></a><span class="cm">* forum here:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-5"></a><span class="cm">* http://forum.java.sun.com/thread.jspa?threadID=364342&amp;tstart=120</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-6"></a><span class="cm">[…]</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-7"></a><span class="cm">*/</span>
</span></code></pre></div>
<p>（来源：Apache Project 源代码 http://svn.apache.org 于 2019 年 7 月获取）</p>
<div class="language-text highlight"><pre><span></span><code>(Source: Apache Project source code http://svn.apache.org retrieved in
July 2019.)
</code></pre></div>
<p>例子二 Example 2：</p>
<p>在 Google Chrome <code>stack_trace_win</code> 的 <code>OutputTraceToStream</code> 函数中，开发者引用了 Microsoft Developer Network 并且附带了 URL：</p>
<div class="language-text highlight"><pre><span></span><code>In the function OutputTraceToStream in the Google Chrome stack_trace_win
source code, the developer cites the source code as the Microsoft
Developer Network and includes a URL:
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-1-1"></a><span class="c1">// Code adapted from MSDN example:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-1-2"></a><span class="c1">// http://msdn.microsoft.com/en-us/library/ms680578(VS.85).aspx </span>
</span></code></pre></div>
<p>（来源：https://github.com/adobe/chromium/blob/master/base/debug/stack_trace_win.cc 于 2019 年 7 月获取） </p>
<div class="language-text highlight"><pre><span></span><code>(Source:
https://github.com/adobe/chromium/blob/master/base/debug/stack_trace_win.cc
retrieved in July 2019.)
</code></pre></div>
<h3 id="example-of-open-source-licensed-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#example-of-open-source-licensed-code">引用附有开源许可证的代码的例子 Example of open-source-licensed code:</a></h3>
<p>在 Google Chrome <code>stack_trace_win</code> 代码的开头，可以看到版权声明和开源许可证的引用：</p>
<div class="language-text highlight"><pre><span></span><code>At the top of the Google Chrome stack_trace_win source file, note the
copyright and reference to the open source license:
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-1"></a><span class="c1">// Copyright (c) 2011 The Chromium Authors. All rights reserved.</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-2"></a><span class="c1">// Use of this source code is governed by a BSD-style license that can be</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-3"></a><span class="c1">// found in the LICENSE file.</span>
</span></code></pre></div>
<p>如果你把这个代码加入到你的程序中，你需要遵守 Chromium 作者的开源许可证协议中的条款。虽然这个开源许可证只要求你在重分发的时候复制一份版权声明和许可证，一个好习惯是无论是否要求，你都要复制它的版权声明到代码中，和/或把它的许可证放到代码目录的文件中。这样的话，如果你在将来想要重分发你的代码，就很容易检查知识产权相关的问题。</p>
<div class="language-text highlight"><pre><span></span><code>If you incorporate this code into a program, you should follow the terms
outlined in The Chromium Authors&#39; open source license file, which is
shown below. While this license only requires that you duplicate the
copyright and license if you are redistributing the code, it is good
practice to always duplicate the copyright in your code, and/or store
the license in a file with the code. This way, if you want to
redistribute the code later, intellectual property reviewing becomes
much easier.
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-1"></a><span class="c1">// Copyright (c) 2014 The Chromium Authors. All rights reserved.</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-2"></a><span class="c1">//</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-3"></a><span class="c1">// Redistribution and use in source and binary forms, with or without</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-4"></a><span class="c1">// modification, are permitted provided that the following conditions are</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-5"></a><span class="c1">// met:</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-6"></a><span class="c1">//</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-7"></a><span class="c1">//* Redistributions of source code must retain the above copyright</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-8"></a><span class="c1">// notice, this list of conditions and the following disclaimer.</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-9"></a><span class="c1">//* Redistributions in binary form must reproduce the above</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-10"></a><span class="c1">// copyright notice, this list of conditions and the following disclaimer</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-11"></a><span class="c1">// in the documentation and/or other materials provided with the</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-12"></a><span class="c1">// distribution.</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-13"></a><span class="c1">//* Neither the name of Google Inc. nor the names of its</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-14"></a><span class="c1">// contributors may be used to endorse or promote products derived from</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-15"></a><span class="c1">// this software without specific prior written permission.</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-16"></a><span class="c1">//</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-17"></a><span class="c1">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-18"></a><span class="c1">// &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-19"></a><span class="c1">// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-20"></a><span class="c1">// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-21"></a><span class="c1">// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-22"></a><span class="c1">// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-23"></a><span class="c1">// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-24"></a><span class="c1">// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-25"></a><span class="c1">// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-26"></a><span class="c1">// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-27"></a><span class="c1">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-28"></a><span class="c1">//</span>
</span></code></pre></div>
<p>（来源：The Chromium Authors license file https://src.chromium.org/viewvc/chrome/trunk/src/LICENSE 于 2019 年 7 月获取）</p>
<div class="language-text highlight"><pre><span></span><code>(Source: The Chromium Authors license file
https://src.chromium.org/viewvc/chrome/trunk/src/LICENSE retrieved in
July 2019.)
</code></pre></div>

    <nav class="md-post__action">
      <a href="../../programming/2022/07/12/writing-code-cn/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-11 00:00:00">2022年7月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="archive-common"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/">Archive 中 COMMON 符号的链接问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#_1">背景</a></h3>
<p>最近看到一个 <a href="https://github.com/NixOS/nixpkgs/issues/180308">issue: irssi 1.4.1 fails to build on darwin arm64</a>，它的现象是，链接的时候会报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-1"></a>Undefined symbols for architecture arm64:
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-2"></a>  &quot;_current_theme&quot;, referenced from:
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-3"></a>      _format_get_text_theme in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-4"></a>      _format_get_text in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-5"></a>      _strip_codes in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-6"></a>      _format_send_as_gui_flags in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-7"></a>      _window_print_daychange in libfe_common_core.a(fe-windows.c.o)
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-8"></a>      _printformat_module_dest_charargs in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-9"></a>      _printformat_module_gui_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-10"></a>      ...
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-11"></a>  &quot;_default_formats&quot;, referenced from:
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-12"></a>      _format_find_tag in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-13"></a>      _format_get_text_theme_args in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-14"></a>      _printformat_module_dest_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-15"></a>      _printformat_module_gui_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-16"></a>ld: symbol(s) not found for architecture arm64
</span></code></pre></div>
<p>代码 <code>themes.c</code> 定义了这两个全局变量：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-1-1"></a><span class="n">THEME_REC</span><span class="w"> </span><span class="o">*</span><span class="n">current_theme</span><span class="p">;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-1-2"></a><span class="n">GHashTable</span><span class="w"> </span><span class="o">*</span><span class="n">default_formats</span><span class="p">;</span>
</span></code></pre></div>
<p>并且 <code>themes.c</code> 编译出来的 <code>themes.c.o</code> 也在 archive 文件中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-2-1"></a>$<span class="w"> </span>ar<span class="w"> </span>t<span class="w"> </span>src/fe-common/core/libfe_common_core.a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>themes.c.o
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-2-2"></a>themes.c.o
</span></code></pre></div>
<p>并且 <code>themes.c.o</code> 也定义了这两个符号：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>src/fe-common/core/libfe_common_core.a.p/themes.c.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>COM
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-2"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_current_theme
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-3"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_default_formats
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-4"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_themes
</span></code></pre></div>
<p>那么，问题在哪呢？看起来，链接的时候提供了 <code>libfe_common_core.a</code> 的参数，并且 <code>.a</code> 里面也有 <code>themes.c.o</code>，我们要找的符号也有定义，那么为什么会出现 <code>Undefined symbols</code> 的问题呢？</p>
<p>答案出在 COMMON 符号上。</p>
<h3 id="common"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#common">COMMON 符号</a></h3>
<p>COMMON 符号的原因和原理，详细可以见 <a href="https://maskray.me/blog/2022-02-06-all-about-common-symbols">MaskRay 的博客 All about COMMON symbols</a>，里面从链接器的角度很详细地讲述了这个问题。</p>
<p>简单来说，COMMON 符号的引入是为了和 Fortran 进行互操作。它在 C 中对应了没有初始化语句的全局变量。实际上到最后，还是会保存到 .bss 段中，默认清零。所以：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-4-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">common_symbol</span><span class="p">;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-4-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">not_common_symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<p>两个语句最终结果是类似的，只不过第一个是 COMMON Symbol，第二个就是普通的 GLOBAL Symbol。</p>
<p>这看起来和 <code>Undefined symbols</code> 错误还是没有关系。问题在哪？</p>
<h3 id="archive"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#archive">Archive</a></h3>
<p>静态库通常是以 Archive 的方式给出，后缀是 <code>.a</code>。它实际上是一堆 <code>.o</code> 打包的集合，外加一个索引，即单独保存一个表，保存了每个 <code>.o</code> 定义了哪些符号。这样的好处是找符号的时候，不用遍历 <code>.o</code>，而是直接在索引里面找相关的符号。</p>
<p>为了创建一个 Archive，Linux 上可以用 <code>ar</code> 命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-5-1"></a>ar<span class="w"> </span>cr<span class="w"> </span>libxxx.a<span class="w"> </span>a.o<span class="w"> </span>b.o<span class="w"> </span>c.o
</span></code></pre></div>
<p>其中 <code>c</code> 表示 create，<code>r</code> 表示插入（和覆盖）。</p>
<p>macOS 上要用 <code>libtool -static</code> 来创建 Archive：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-6-1"></a>libtool<span class="w"> </span>-static<span class="w"> </span>libxxx.a<span class="w"> </span>a.o<span class="w"> </span>b.o<span class="w"> </span>c.o
</span></code></pre></div>
<p>否则链接的时候会报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-7-1"></a>ld: warning: ignoring file libxxx.a, building for macOS-arm64 but attempting to link with file built for unknown-unsupported file format
</span></code></pre></div>
<p>然后用 <code>ar t</code> 命令就可以看 Archive 有哪些内容：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-1"></a>$<span class="w"> </span>ar<span class="w"> </span>t<span class="w"> </span>libxxx.a
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-2"></a>a.o
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-3"></a>b.o
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-4"></a>c.o
</span></code></pre></div>
<p>可以用 <code>nm --print-armap</code> 命令查看 Archive 的索引：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-1"></a>$<span class="w"> </span>nm<span class="w"> </span>--print-armap<span class="w"> </span>libxxx.a
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-2"></a>Archive<span class="w"> </span>index:
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-3"></a>symbol1<span class="w"> </span><span class="k">in</span><span class="w"> </span>a.o
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-4"></a>symbol2<span class="w"> </span><span class="k">in</span><span class="w"> </span>b.o
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-5"></a>symbol3<span class="w"> </span><span class="k">in</span><span class="w"> </span>c.o
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-7"></a>a.o:
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-8"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>symbol1
</span></code></pre></div>
<p>所以我们已经了解了 Archive 的情况：它是多个 <code>.o</code> 文件的集合，并且实现了索引。链接的时候，会通过索引来找 <code>.o</code>，而不是遍历所有的 <code>.o</code> 文件。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#_2">链接问题</a></h3>
<p>那么，回到一开始的链接问题，既然我们已经确认了，<code>.o</code> 文件中定义了符号，并且这个 <code>.o</code> 也确实在 <code>.a</code> 文件中，那就只剩下最后一个可能了：索引里面没有这个符号。</p>
<p>用 <code>nm --print-armap</code> 命令尝试，发现上面的 <code>_default_formats</code> 和 <code>_current_theme</code> 只在对应的 <code>.o</code> 中有定义，在 Archive index 部分是没有的。</p>
<p>网友 @ailin-nemui 指出了这个问题，并且提供了一个链接：<a href="https://stackoverflow.com/questions/19398742/os-x-linker-unable-to-find-symbols-from-a-c-file-which-only-contains-variables/26581710#26581710">OS X linker unable to find symbols from a C file which only contains variables</a>。它讲了很重要的一点，是 macOS 的 ar/ranlib/libtool 版本默认情况下不会为 COMMON 符号创建索引。所以，解决方案也很明确了：</p>
<ol>
<li>第一种 不要创建 COMMON 符号：添加编译选项 <code>-fno-common</code>，这个选项在比较新的编译器里都是默认了</li>
<li>第二种 为 COMMON 符号创建索引：用 <code>libtool -static -c</code> 命令，其中 <code>-c</code> 选项就是打开为 COMMON 符号创建索引</li>
<li>第三种 修改代码：给全局变量设置一个初始化值</li>
</ol>
<p>这样，这个问题就得到了妥善的解决。</p>
<h3 id="_3"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#_3">附录</a></h3>
<p>下面是 <a href="https://www.unix.com/man-page/osx/1/LIBTOOL/">macOS libtool manpage</a> 中写的相关文档：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../software/2022/07/11/archive-common-linking/#__codelineno-10-1"></a>-c     Include common symbols as definitions with respect to the table of contents.  This is seldom the intended behavior for linking  from
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../software/2022/07/11/archive-common-linking/#__codelineno-10-2"></a>          a library, as it forces the linking of a library member just because it uses an uninitialized global that is undefined at that point
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../software/2022/07/11/archive-common-linking/#__codelineno-10-3"></a>          in the linking.  This option is included only because this was the original behavior of ranlib.  This option is not the default.
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../software/2022/07/11/archive-common-linking/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-06 00:00:00">2022年7月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nvidia-cuda"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/">NVIDIA 驱动和 CUDA 安装速查</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#_1">背景</a></h3>
<p>最近在 Ubuntu 上配置 NVIDIA 驱动和 CUDA 环境的次数比较多，在此总结一下整个流程，作为教程供大家学习。</p>
<h3 id="nvidia-apt"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#nvidia-apt">配置 NVIDIA APT 源</a></h3>
<p>Ubuntu 源有自带的 NVIDIA 驱动版本，但这里我们要使用 NVIDIA 的 APT 源。首先，我们要访问 <a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network">https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network</a>，在网页中选择我们的系统，例如：</p>
<ol>
<li>Operating System: Linux</li>
<li>Architecture: x86_64</li>
<li>Distribution: Ubuntu</li>
<li>Version: 20.04</li>
<li>Installer Type: deb (network)</li>
</ol>
<p>此时，下面就会显示一些命令，复制下来执行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-0-1"></a>wget<span class="w"> </span>https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-0-2"></a>sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>cuda-keyring_1.0-1_all.deb
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-0-3"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span></code></pre></div>
<p>最后一步的 <code>sudo apt-get -y install cuda</code> 可以不着急安装，我们在后面再来讨论 CUDA 版本的问题。</p>
<h3 id="nvidia"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#nvidia">NVIDIA 驱动</a></h3>
<p>配置好源以后，接下来，我们就要安装 NVIDIA 驱动了。首先，我们要选取一个 NVIDIA 版本，选择的标准如下：</p>
<ol>
<li>驱动版本需要支持所使用的显卡</li>
<li>驱动版本需要支持所使用的 CUDA 版本</li>
</ol>
<p>这些信息在网络上都可以查到，也可以参考 <a href="../../software/2021/12/26/nvidia-cuda/">NVIDIA 驱动和 CUDA 版本信息速查</a>。</p>
<p>假如我们已经选择了要安装 470.129.06 版本，那么，我们接下来要确认一下 NVIDIA 的 APT 源的版本名称：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-1-1"></a>sudo apt show -a nvidia-driver-470
</span></code></pre></div>
<p>在输出的结果中搜索 <code>470.129.06</code>，找到 <code>Version: 470.129.06-0ubuntu1</code>，下面写了 <code>APT-Sources: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64 Packages</code>，这就说明这个版本是从 NVIDIA 的 APT 源来的。</p>
<p>所以，我们要用 <code>470.129.06-0ubuntu1</code>，而不是 <code>470.129.06-0ubuntu0.20.04.1</code>，后者是 Ubuntu 源自带的，我们要用前者。</p>
<p>接下来，指定版本安装驱动：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-2-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nvidia-driver-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1
</span></code></pre></div>
<p>如果系统里已经安装了其他版本的 nvidia 驱动，可能会出现冲突。这时候，只需要把冲突的包也写在要安装的包里即可，例如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-3-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nvidia-utils-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>cuda-drivers<span class="o">=</span><span class="m">470</span>.129.06-1<span class="w"> </span>cuda-drivers-470<span class="o">=</span><span class="m">470</span>.129.06-1<span class="w"> </span>nvidia-driver-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-gl-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-compute-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-decode-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-encode-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-ifr1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-fbc1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-common-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-kernel-source-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-dkms-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-kernel-common-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-extra-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-compute-utils-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>xserver-xorg-video-nvidia-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-cfg1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-settings<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span><span class="nv">libxnvctrl0</span><span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-modprobe<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1
</span></code></pre></div>
<p>最终，我们要保证，系统里面所有 nvidia 驱动相关的包都是同一个版本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>list<span class="w"> </span>--installed<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nvidia
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-2"></a>libnvidia-cfg1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-3"></a>libnvidia-common-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>all<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-4"></a>libnvidia-compute-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-5"></a>libnvidia-decode-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-6"></a>libnvidia-encode-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-7"></a>libnvidia-extra-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-8"></a>libnvidia-fbc1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-9"></a>libnvidia-gl-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-10"></a>libnvidia-ifr1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-11"></a>nvidia-compute-utils-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-12"></a>nvidia-dkms-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-13"></a>nvidia-driver-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-14"></a>nvidia-fabricmanager-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-15"></a>nvidia-kernel-common-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-16"></a>nvidia-kernel-source-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-17"></a>nvidia-modprobe/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,upgradable<span class="w"> </span>to:<span class="w"> </span><span class="m">515</span>.48.07-0ubuntu1<span class="o">]</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-18"></a>nvidia-settings/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,upgradable<span class="w"> </span>to:<span class="w"> </span><span class="m">515</span>.48.07-0ubuntu1<span class="o">]</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-19"></a>nvidia-utils-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-20"></a>xserver-xorg-video-nvidia-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span></code></pre></div>
<p>接下来，为了防止 apt 升级的时候顺手破坏了一致的版本，我们要把包固定在一个版本里：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-5-1"></a>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>cuda-drivers<span class="w"> </span>nvidia-modprobe<span class="w"> </span>nvidia-settings<span class="w"> </span>libxnvctrl0
</span></code></pre></div>
<p>如果有其他 nvidia 包说要自动升级，也可以类似地固定住。</p>
<h3 id="cuda"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#cuda">CUDA</a></h3>
<p>CUDA 实际上是绿色软件，把整个目录放在任意一个目录，都可以使用。</p>
<p>安装 CUDA 的方式有很多，我们可以用 APT 安装全局的，也可以用 Spack 或者 Anaconda 安装到本地目录。实际上这些安装过程都是把同样的文件复制到不同的地方而已。</p>
<p>如果要安装全局的话，还是推荐用 NVIDIA 的 APT 源，以安装 CUDA 11.1 为例：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-6-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>cuda-11-1
</span></code></pre></div>
<p>那么 CUDA 就会安装到 /usr/local/cuda-11.1 目录下。如果想要用 nvcc，我们可以手动把它加到 PATH 环境变量中。</p>
<p>CUDA 是可以多版本共存的，比如你可以把 CUDA 11.1 到 CUDA 11.7 一口气都装了。不过注意，CUDA 对 NVIDIA 驱动有版本要求，所以有一些可能会不满足 APT 的版本要求；同时，CUDA 对编译器版本有要求，所以如果系统还是 Ubuntu 16.04 或者 18.04，赶紧升级吧。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/07/06/install-nvidia-cuda/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-02 00:00:00">2022年7月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="connectx-4"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/">切换 ConnectX-4 为以太网模式</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#_1">背景</a></h3>
<p>最近在给机房配置网络，遇到一个需求，就是想要把 ConnectX-4 当成以太网卡用，它既支持 Infiniband，又支持 Ethernet，只不过默认是 Infiniband 模式，所以需要用 mlxconfig 工具来做这个切换。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#_2">切换方法</a></h3>
<p>在 <a href="https://docs.nvidia.com/networking/display/MFTv4110/Using+mlxconfig">Using mlxconfig</a> 文档中，写了如何切换网卡为 Infiniband 模式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-1"></a>$<span class="w"> </span>mlxconfig<span class="w"> </span>-d<span class="w"> </span>/dev/mst/mt4103_pci_cr0<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">LINK_TYPE_P1</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">LINK_TYPE_P2</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-3"></a>Device<span class="w"> </span><span class="c1">#1:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-4"></a>----------
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-5"></a>Device<span class="w"> </span>type:<span class="w">   </span>ConnectX3Pro
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-6"></a>PCI<span class="w"> </span>device:<span class="w">    </span>/dev/mst/mt4103_pci_cr0
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-7"></a>Configurations:<span class="w">        </span>Next<span class="w"> </span>Boot<span class="w">        </span>New
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-8"></a><span class="w">  </span>LINK_TYPE_P1<span class="w">         </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span><span class="w">           </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-9"></a><span class="w">  </span>LINK_TYPE_P2<span class="w">         </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span><span class="w">           </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-11"></a>Apply<span class="w"> </span>new<span class="w"> </span>Configuration?<span class="w"> </span>?<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span><span class="w"> </span><span class="o">[</span>n<span class="o">]</span><span class="w"> </span>:<span class="w"> </span>y
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-12"></a>Applying...<span class="w"> </span>Done!
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-13"></a>-I-<span class="w"> </span>Please<span class="w"> </span>reboot<span class="w"> </span>machine<span class="w"> </span>to<span class="w"> </span>load<span class="w"> </span>new<span class="w"> </span>configurations.
</span></code></pre></div>
<p>那么，我们只需要反其道而行之，设置模式为 <code>ETH(2)</code> 即可。</p>
<h3 id="mst"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#mst">MST 安装</a></h3>
<p>要使用 mlxconfig，就需要安装 <a href="https://network.nvidia.com/products/adapter-software/firmware-tools/">MFT(Mellanox Firmware Tools)</a>。我们用的是 Debian bookworm，于是要下载 DEB：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-1-1"></a>wget<span class="w"> </span>https://www.mellanox.com/downloads/MFT/mft-4.20.1-14-x86_64-deb.tgz
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-1-2"></a>unar<span class="w"> </span>mft-4.20.1-14-x86_64-deb.tgz
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-1-3"></a><span class="nb">cd</span><span class="w"> </span>mft-4.20.1-14-x86_64-deb
</span></code></pre></div>
<p>UPDATE 2022-10-28: 现在最新版本 mft-4.21.0-99 已经修复了下面出现的编译问题。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-2-1"></a>wget<span class="w"> </span>https://www.mellanox.com/downloads/MFT/mft-4.21.0-99-x86_64-deb.tgz
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-2-2"></a>unar<span class="w"> </span>mft-4.21.0-99-x86_64-deb.tgz
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-2-3"></a><span class="nb">cd</span><span class="w"> </span>mft-4.21.0-99-x86_64-deb
</span></code></pre></div>
<p>尝试用 <code>sudo ./install.sh</code> 安装，发现 dkms 报错。查看日志，发现是因为内核过高（5.18），有函数修改了用法，即要把 pci_unmap_single 的调用改为 dma_unmap_single，并且修改第一个参数，如 <a href="https://github.com/torvalds/linux/commit/a2e759612e5ff3858856fe97be5245eecb84e29b">linux commit a2e759612e5ff3858856fe97be5245eecb84e29b</a> 指出的那样：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-3-1"></a>-           pci_unmap_single(dev-&gt;pci_dev, dev-&gt;dma_props[i].dma_map, DMA_MBOX_SIZE, DMA_BIDIRECTIONAL);
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-3-2"></a>+           dma_unmap_single(&amp;dev-&gt;pci_dev-&gt;dev, dev-&gt;dma_props[i].dma_map, DMA_MBOX_SIZE, DMA_BIDIRECTIONAL);
</span></code></pre></div>
<p>修改完以后，手动 <code>sudo dkms install kernel-mft-dkms/4.20.1</code>，发现就编译成功了。再手动安装一下 mft 并启动服务：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-1"></a>$ sudo dpkg -i DEBS/mft_4.20.1-14_amd64.deb
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-2"></a>$ sudo mst start
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-3"></a>Starting MST (Mellanox Software Tools) driver set
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-4"></a>Loading MST PCI module - Success
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-5"></a>[warn] mst_pciconf is already loaded, skipping
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-6"></a>Create devices
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-7"></a>Unloading MST PCI module (unused) - Success
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-8"></a>$ sudo mst status
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-9"></a>MST modules:
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-10"></a>------------
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-11"></a>    MST PCI module is not loaded
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-12"></a>    MST PCI configuration module loaded
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-14"></a>MST devices:
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-15"></a>------------
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-16"></a>/dev/mst/mtxxxx_pciconf0         - PCI configuration cycles access.
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-17"></a>                                   domain:bus:dev.fn=0000:xx:xx.0 addr.reg=yy data.reg=zz cr_bar.gw_offset=-1
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-18"></a>                                   Chip revision is: 00
</span></code></pre></div>
<p>既然已经安装好了，最后执行 <code>mlxconfig</code> 即可切换为以太网：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mlxconfig<span class="w"> </span>-d<span class="w"> </span>/dev/mst/mtxxxx_pciconf0<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">LINK_TYPE_P1</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">LINK_TYPE_P2</span><span class="o">=</span><span class="m">2</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-3"></a>Device<span class="w"> </span><span class="c1">#1:</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-4"></a>----------
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-6"></a>Device<span class="w"> </span>type:<span class="w">    </span>ConnectX4
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-7"></a>Name:<span class="w">           </span>REDACTED
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-8"></a>Description:<span class="w">    </span>ConnectX-4<span class="w"> </span>VPI<span class="w"> </span>adapter<span class="w"> </span>card<span class="p">;</span><span class="w"> </span>FDR<span class="w"> </span>IB<span class="w"> </span><span class="o">(</span>56Gb/s<span class="o">)</span><span class="w"> </span>and<span class="w"> </span>40GbE<span class="p">;</span><span class="w"> </span>dual-port<span class="w"> </span>QSFP28<span class="p">;</span><span class="w"> </span>PCIe3.0<span class="w"> </span>x8<span class="p">;</span><span class="w"> </span>ROHS<span class="w"> </span>R6
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-9"></a>Device:<span class="w">         </span>/dev/mst/mtxxxx_pciconf0
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-11"></a>Configurations:<span class="w">                              </span>Next<span class="w"> </span>Boot<span class="w">       </span>New
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-12"></a><span class="w">         </span>LINK_TYPE_P1<span class="w">                        </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w">           </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-13"></a><span class="w">         </span>LINK_TYPE_P2<span class="w">                        </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w">           </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-14"></a>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-15"></a><span class="w"> </span>Apply<span class="w"> </span>new<span class="w"> </span>Configuration?<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span><span class="w"> </span><span class="o">[</span>n<span class="o">]</span><span class="w"> </span>:<span class="w"> </span>y
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-16"></a>Applying...<span class="w"> </span>Done!
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-17"></a>-I-<span class="w"> </span>Please<span class="w"> </span>reboot<span class="w"> </span>machine<span class="w"> </span>to<span class="w"> </span>load<span class="w"> </span>new<span class="w"> </span>configurations.
</span></code></pre></div>
<p>显示各个配置可能的选项和内容：<code>sudo mlxconfig -d /dev/mst/mtxxxx_pciconf0 show_confs</code></p>
<p>整个安装流程在仓库 <a href="https://github.com/jiegec/mft-debian-bookworm">https://github.com/jiegec/mft-debian-bookworm</a> 中用脚本实现。</p>
<h3 id="vmware-esxi"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#vmware-esxi">VMware ESXi</a></h3>
<p>如果要在 ESXi 上把网卡改成以太网模式，可以参考下面的文档：</p>
<ul>
<li>https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813</li>
<li>https://docs.nvidia.com/networking/plugins/servlet/mobile?contentId=15051769#content/view/15051769</li>
</ul>
<p>命令（ESXi 7.0U3）：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-1"></a>scp *.vib root@esxi:/some/path
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-2"></a>esxcli software vib install -v /some/path/MEL_bootbank_mft_4.21.0.703-0.vib
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-3"></a>esxcli software vib install -v /some/path/MEL_bootbank_nmst_4.21.0.703-1OEM.703.0.0.18434556.vib
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-4"></a>reboot
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-5"></a>/opt/mellanox/bin/mst start
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-6"></a>/opt/mellanox/bin/mst status -vv
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-7"></a>/opt/mellanox/bin/mlxfwmanager --query
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-8"></a>/opt/mellanox/bin/mlxconfig -d mt4115_pciconf0 set LINK_TYPE_P1=2 LINK_TYPE_P2=2
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-9"></a>reboot
</span></code></pre></div>
<p>然后就可以看到网卡了。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-07-01 00:00:00">2022年7月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rsyslog"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/">rsyslog 收集远程日志</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#_1">背景</a></h3>
<p>最近在运维的时候发现网络设备（如交换机）有一个远程发送日志的功能，即可以通过 syslog udp 协议发送日志到指定的服务器。为此，可以在服务器上运行 rsyslog 并收集日志。</p>
<h3 id="rsyslog_1"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#rsyslog_1">rsyslog 配置</a></h3>
<p>默认的 rsyslog 配置是收集系统本地的配置，因此我们需要编写一个 rsyslog 配置，用于收集远程的日志。</p>
<p>首先复制 <code>/etc/rsyslog.conf</code> 到 <code>/etc/rsyslog-remote.conf</code>，然后修改：</p>
<ol>
<li>注释掉 <code>imuxsock</code> 和 <code>imklog</code> 相关的 module 加载</li>
<li>去掉 <code>imudp</code> 和 <code>imtcp</code> 相关的注释，这样就会监听在相应的端口上</li>
<li>修改 <code>$WorkDirectory</code>，例如 <code>$WorkDirectory /var/spool/rsyslog-remote</code>，防止与已有的 rsyslog 冲突</li>
<li>注释 <code>$IncludeConfig</code>，防止引入了不必要的配置</li>
<li>注释所有已有的 <code>RULES</code> 下面的配置</li>
<li>添加如下配置：</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-0-1"></a>$template FromIp,&quot;/var/log/rsyslog-remote/%FROMHOST-IP%.log&quot;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-0-2"></a>*.* ?FromIp
</span></code></pre></div>
<p>这样，就会按照来源的 IP 地址进行分类，然后都写入到 <code>/var/log/rsyslog-remote/x.x.x.x.log</code> 文件里。</p>
<h3 id="systemd-service"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#systemd-service">systemd service</a></h3>
<p>最后，写一个 systemd service 让它自动启动：</p>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-1"></a><span class="k">[Unit]</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-2"></a><span class="n">ConditionPathExists</span><span class="o">=</span><span class="err">/</span><span class="n">etc</span><span class="err">/</span><span class="n">rsyslog-remote</span><span class="p">.</span><span class="n">conf</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-3"></a><span class="n">Description</span><span class="o">=</span><span class="n">Remote</span><span class="w"> </span><span class="n">Syslog</span><span class="w"> </span><span class="n">Service</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-5"></a><span class="k">[Service]</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-6"></a><span class="n">Type</span><span class="o">=</span><span class="n">simple</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-7"></a><span class="n">PIDFile</span><span class="o">=</span><span class="err">/</span><span class="n">var</span><span class="err">/</span><span class="n">run</span><span class="err">/</span><span class="n">rsyslogd-remote</span><span class="p">.</span><span class="n">pid</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-8"></a><span class="n">ExecStart</span><span class="o">=</span><span class="err">/</span><span class="n">usr</span><span class="err">/</span><span class="n">sbin</span><span class="err">/</span><span class="n">rsyslogd</span><span class="w"> </span><span class="err">-</span><span class="n">n</span><span class="w"> </span><span class="err">-</span><span class="n">f</span><span class="w"> </span><span class="err">/</span><span class="n">etc</span><span class="err">/</span><span class="n">rsyslog-remote</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span><span class="err">-</span><span class="n">i</span><span class="w"> </span><span class="err">/</span><span class="n">var</span><span class="err">/</span><span class="n">run</span><span class="err">/</span><span class="n">rsyslogd-remote</span><span class="p">.</span><span class="n">pid</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-9"></a><span class="n">ExecReload</span><span class="o">=</span><span class="err">/</span><span class="n">bin</span><span class="err">/</span><span class="n">kill</span><span class="w"> </span><span class="err">-</span><span class="n">HUP</span><span class="w"> </span><span class="err">$</span><span class="n">MAINPID</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-11"></a><span class="k">[Install]</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-12"></a><span class="n">WantedBy</span><span class="o">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-2-1"></a>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/07/01/rsyslog-remote/#__codelineno-2-2"></a>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>rsyslog-remote
</span></code></pre></div>
<p>这样就实现了远程日志的收集。</p>
<h3 id="logrotate"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#logrotate">logrotate 设置</a></h3>
<p>为了防止日志太多，还需要配置 logrotate。</p>
<p>复制 <code>/etc/logrotate.d/rsyslog</code> 到 <code>/etc/logrotate.d/rsyslog-remote</code>，然后修改开头为 <code>/var/log/rsyslog-remote/*.log</code> 即可，路径和上面对应。注意脚本 <code>/usr/lib/rsyslog/rsyslog-remote</code> 也需要复制一份，然后修改一下 systemd service 名字。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#_2">参考文档</a></h3>
<ul>
<li><a href="https://www.makeuseof.com/set-up-linux-remote-logging-using-rsyslog/">How to Set Up Remote Logging on Linux Using rsyslog</a></li>
<li><a href="https://www.thegeekdiary.com/configuring-remote-logging-using-rsyslog-in-centos-rhel/">Configuring Remote Logging using rsyslog in CentOS/RHEL</a></li>
<li><a href="https://www.tecmint.com/install-rsyslog-centralized-logging-in-centos-ubuntu/">How to Setup Central Logging Server with Rsyslog in Linux</a></li>
<li><a href="https://www.tecmint.com/setup-rsyslog-client-to-send-logs-to-rsyslog-server-in-centos-7/">How to Setup Rsyslog Client to Send Logs to Rsyslog Server in CentOS 7</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../software/2022/07/01/rsyslog-remote/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-06-19 00:00:00">2022年6月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="wishbone"><a class="toclink" href="../../hardware/2022/06/19/wishbone/">「教学」Wishbone 总线协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/bus_protocol.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#_1">背景</a></h3>
<p>最近在研究如何把 Wishbone 总线协议引入计算机组成原理课程，因此趁此机会学习了一下 Wishbone 的协议。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#_2">总线</a></h3>
<p>总线是什么？总线通常用于连接 CPU 和外设，为了更好的兼容性和可复用性，会想到能否设计一个统一的协议，其中 CPU 实现的是发起请求的一方（又称为 master），外设实现的是接收请求的一方（又称为 slave），那么如果要添加外设、或者替换 CPU 实现，都会变得比较简单，减少了许多适配的工作量。</p>
<p>那么，我们来思考一下，一个总线协议需要包括哪些内容？对于 CPU 来说，程序会读写内存，读写内存就需要以下几个信号传输到内存：</p>
<ol>
<li>地址（<code>addr</code>）：例如 32 位处理器就是 32 位地址，或者按照内存的大小计算地址线的宽度</li>
<li>数据（<code>w_data</code> 和 <code>r_data</code>）：分别是写数据和读数据，宽度通常为 32 位 或 64 位，也就是一个时钟周期可以传输的数据量</li>
<li>读还是写（<code>we</code>）：高表示写，低表示读</li>
<li>字节有效（<code>be</code>）：例如为了实现单字节写，虽然 <code>w_data</code> 可能是 32 位宽，但是实际写入的是其中的一个字节</li>
</ol>
<p>除了请求的内容以外，为了表示 CPU 想要发送请求，还需要添加 <code>valid</code> 信号：高表示发送请求，低表示不发送请求。很多时候，外设的速度比较慢，可能无法保证每个周期都可以处理请求，因此外设可以提供一个 <code>ready</code> 信号：当 <code>valid=1 &amp;&amp; ready=1</code> 的时候，发送并处理请求；当 <code>valid=1 &amp;&amp; ready=0</code> 的时候，表示外设还没有准备好，此时 CPU 需要一直保持 <code>valid=1</code> 不变，等到外设准备好后，<code>valid=1 &amp;&amp; ready=1</code> 请求生效。</p>
<p>简单总结一下上面的需求，可以得到 master 和 slave 端分别的信号列表。这次，我们在命名的时候用 <code>_o</code> 表示输出、<code>_i</code> 表示输入，可以得到 master 端（CPU 端）的信号：</p>
<ol>
<li><code>clock_i</code>：时钟输入</li>
<li><code>valid_o</code>：高表示 master 想要发送请求</li>
<li><code>ready_i</code>：高表示 slave 准备好处理请求</li>
<li><code>addr_o</code>：master 想要读写的地址</li>
<li><code>we_o</code>：master 想要读还是写</li>
<li><code>data_o</code>：master 想要写入的数据</li>
<li><code>be_o</code>：master 读写的字节使能，用于实现单字节写等</li>
<li><code>data_i</code>：slave 提供给 master 的读取的数据</li>
</ol>
<p>除了时钟都是输入以外，把上面其余的信号输入、输出对称一下，就可以得到 slave 端（外设端）的信号：</p>
<ol>
<li><code>clock_i</code>：时钟输入</li>
<li><code>valid_i</code>：高表示 master 想要发送请求</li>
<li><code>ready_o</code>：高表示 slave 准备好处理请求</li>
<li><code>addr_i</code>：master 想要读写的地址</li>
<li><code>we_i</code>：master 想要读还是写</li>
<li><code>data_i</code>：master 想要写入的数据</li>
<li><code>be_i</code>：master 读写的字节使能，用于实现单字节写等</li>
<li><code>data_o</code>：slave 提供给 master 的读取的数据</li>
</ol>
<p>根据我们上面设计的自研总线，可以绘制出下面的波形图（以 master 的信号为例）：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p.........", node: ".abcdefgh"},
      { name: "valid_o", wave: "0101.01..0"},
      { name: "ready_i", wave: "010.101..0"},
      { name: "addr_o", wave: "x=x=.x===x", data: ["0x01", "0x02", "0x03", "0x01", "0x02"]},
      { name: "we_o", wave: "x1x0.x101x"},
      { name: "data_o", wave: "x=xxxx=x=x", data: ["0x12", "0x56", "0x9a"]},
      { name: "be_o", wave: "x=x=.x=x=x", data: ["0x1", "0x1", "0x1", "0x1"]},
      { name: "data_i", wave: "xxxx=xx=xx", data: ["0x34", "0x12"]},
    ]
}</script>
<ul>
<li><code>a</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，此时 <code>we_o=1</code> 说明是一个写操作，并且写入地址是 <code>addr_o=0x01</code>，写入的数据是 <code>data_o=0x12</code></li>
<li><code>b</code> 周期：此时 <code>valid_o=0 &amp;&amp; ready_i=0</code> 说明无事发生</li>
<li><code>c</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=0</code> 说明 master 想要从地址 0x02（<code>addr_o=0x02</code>）读取数据（<code>we_o=0</code>），但是 slave 没有接受（<code>ready_i=0</code>）</li>
<li><code>d</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 从地址 0x02（<code>addr_o=0x02</code>）读取数据（<code>we_o=0</code>），读取的数据为 0x34（<code>data_i=0x34</code>）</li>
<li><code>e</code> 周期：此时 <code>valid_o=0 &amp;&amp; ready_i=0</code> 说明无事发生</li>
<li><code>f</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 向地址 0x03（<code>addr_o=0x03</code>）写入数据（<code>we_o=1</code>），写入的数据为 0x56（<code>data_i=0x56</code>）</li>
<li><code>g</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 从地址 0x01（<code>addr_o=0x01</code>）读取数据（<code>we_o=0</code>），读取的数据为 0x12（<code>data_i=0x12</code>）</li>
<li><code>h</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 向地址 0x02（<code>addr_o=0x02</code>）写入数据（<code>we_o=1</code>），写入的数据为 0x9a（<code>data_i=0x9a</code>）</li>
</ul>
<p>从上面的波形中，可以有几点观察：</p>
<ol>
<li>master 想要发起请求的时候，就设置 <code>valid_o=1</code>；当 slave 可以接受请求的时候，就设置 <code>ready_i=1</code>；在 <code>valid_o=1 &amp;&amp; ready_i=1</code> 时视为一次请求</li>
<li>如果 master 发起请求，同时 slave 不能接收请求，即 <code>valid_o=1 &amp;&amp; ready_i=0</code>，此时 master 要保持 <code>addr_o</code> <code>we_o</code> <code>data_o</code> 和 <code>be_o</code> 不变，直到请求结束</li>
<li>当 master 不发起请求的时候，即 <code>valid_o=0</code>，此时总线上的信号都视为无效数据，不应该进行处理；对于读操作，只有在 <code>valid_o=1 &amp;&amp; ready_i=1</code> 时 <code>data_i</code> 上的数据是有效的</li>
<li>可以连续多个周期发生请求，即 <code>valid_o=1 &amp;&amp; ready_i=1</code> 连续多个周期等于一，此时是理想情况，可以达到总线最高的传输速度</li>
</ol>
<h3 id="wishbone-classic-standard"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#wishbone-classic-standard">Wishbone Classic Standard</a></h3>
<p>首先我们来看最简单的 Wishbone 版本 Wishbone Classic Standard。其设计思路和上面的自研总线非常相似，让我们来看看它的信号，例如 master 端（CPU 端）的信号：</p>
<ol>
<li><code>CLK_I</code>: 时钟输入，即自研总线中的 <code>clock_i</code></li>
<li><code>STB_O</code>：高表示 master 要发送请求，即自研总线中的 <code>valid_o</code></li>
<li><code>ACK_I</code>：高表示 slave 处理请求，即自研总线中的 <code>ready_i</code></li>
<li><code>ADR_O</code>：master 想要读写的地址，即自研总线中的 <code>addr_o</code></li>
<li><code>WE_O</code>：master 想要读还是写，即自研总线中的 <code>we_o</code></li>
<li><code>DAT_O</code>：master 想要写入的数据，即自研总线中的 <code>data_o</code></li>
<li><code>SEL_O</code>：master 读写的字节使能，即自研总线中的 <code>be_o</code></li>
<li><code>DAT_I</code>：master 从 slave 读取的数据，即自研总线中的 <code>data_i</code></li>
<li><code>CYC_O</code>：总线的使能信号，无对应的自研总线信号</li>
</ol>
<p>还有一些可选信号，这里就不赘述了。可以看到，除了最后一个 <code>CYC_O</code>，其他的信号其实就是我们刚刚设计的自研总线。<code>CYC_O</code> 的可以认为是 master 想要占用 slave 的总线接口，在常见的使用场景下，直接认为 <code>CYC_O=STB_O</code>。它的用途是：</p>
<ol>
<li>占用 slave 的总线接口，不允许其他 master 访问</li>
<li>简化 interconnect 的实现</li>
</ol>
<p>把上面自研总线的波形图改成 Wishbone Classic Standard，就可以得到：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "CLK_I", wave: "p.........", node: ".abcdefgh"},
      { name: "CYC_O", wave: "0101.01..0"},
      { name: "STB_O", wave: "0101.01..0"},
      { name: "ACK_I", wave: "010.101..0"},
      { name: "ADR_O", wave: "x=x=.x===x", data: ["0x01", "0x02", "0x03", "0x01", "0x02"]},
      { name: "WE_O", wave: "x1x0.x101x"},
      { name: "DAT_O", wave: "x=xxxx=x=x", data: ["0x12", "0x56", "0x9a"]},
      { name: "SEL_O", wave: "x=x=.x=x=x", data: ["0x1", "0x1", "0x1", "0x1"]},
      { name: "DAT_I", wave: "xxxx=xx=xx", data: ["0x34", "0x12"]},
    ]
}</script>
<h3 id="wishbone-classic-pipelined"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#wishbone-classic-pipelined">Wishbone Classic Pipelined</a></h3>
<p>上面的 Wishbone Classic Standard 协议非常简单，但是会遇到一个问题：假设实现的是一个 SRAM 控制器，它的读操作有一个周期的延迟，也就是说，在这个周期给出地址，需要在下一个周期才可以得到结果。在 Wishbone Classic Standard 中，就会出现下面的波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "CLK_I", wave: "p.....", node: ".abcd"},
      { name: "CYC_O", wave: "01...0"},
      { name: "STB_O", wave: "01...0"},
      { name: "ACK_I", wave: "0.1010"},
      { name: "ADR_O", wave: "x=.=.x", data: ["0x01", "0x02"]},
      { name: "WE_O", wave: "x0...x"},
      { name: "DAT_O", wave: "xxxxxx"},
      { name: "SEL_O", wave: "x=...x", data: ["0x1"]},
      { name: "DAT_I", wave: "xx=x=x", data: ["0x12", "0x34"]},
    ]
}</script>
<ul>
<li><code>a</code> 周期：master 给出读地址 0x01，此时 SRAM 控制器开始读取，但是此时数据还没有读取回来，所以 <code>ACK_I=0</code></li>
<li><code>b</code> 周期：此时 SRAM 完成了读取，把读取的数据 0x12 放在 <code>DAT_I</code> 并设置 <code>ACK_I=1</code></li>
<li><code>c</code> 周期：master 给出下一个读地址 0x02，SRAM 要重新开始读取</li>
<li><code>d</code> 周期：此时 SRAM 完成了第二次读取，把读取的数据 0x34 放在 <code>DAT_I</code> 并设置 <code>ACK_I=1</code></li>
</ul>
<p>从波形来看，功能没有问题，但是每两个周期才能进行一次读操作，发挥不了最高的性能。那么怎么解决这个问题呢？我们在 <code>a</code> 周期给出第一个地址，在 <code>b</code> 周期得到第一个数据，那么如果能在 <code>b</code> 周期的时候给出第二个地址，就可以在 <code>c</code> 周期得到第二个数据。这样，就可以实现流水线式的每个周期进行一次读操作。但是，Wishbone Classic Standard 要求 <code>b</code> 周期时第一次请求还没有结束，因此我们需要修改协议，来实现流水线式的请求。</p>
<p>实现思路也很简单：既然 Wishbone Classic Standard 认为 <code>b</code> 周期时，第一次请求还没有结束，那就让第一次请求提前在 <code>a</code> 周期完成，只不过它的数据要等到 <code>b</code> 周期才能给出。实际上，这个时候的一次读操作，可以认为分成了两部分：首先是 master 向 slave 发送读请求，这个请求在 <code>a</code> 周期完成；然后是 slave 向 master 发送读的结果，这个结果在 <code>b</code> 周期完成。为了实现这个功能，我们进行如下修改：</p>
<ul>
<li>添加 <code>STALL_I</code> 信号：<code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; STALL_I=0</code> 表示进行一次读请求</li>
<li>修改 <code>ACK_I</code> 信号含义：<code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; ACK_I=1</code> 表示一次读响应</li>
</ul>
<p>进行如上修改以后，我们就得到了 Wishbone Classic Pipelined 总线协议。上面的两次连续读操作波形如下：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "CLK_I", wave: "p....", node: ".abcd"},
      { name: "CYC_O", wave: "01..0"},
      { name: "STB_O", wave: "01.0."},
      { name: "STALL_I", wave: "0...."},
      { name: "ACK_I", wave: "0.1.0"},
      { name: "ADR_O", wave: "x==xx", data: ["0x01", "0x02"]},
      { name: "WE_O", wave: "x0.xx"},
      { name: "DAT_O", wave: "xxxxx"},
      { name: "SEL_O", wave: "x=.xx", data: ["0x1"]},
      { name: "DAT_I", wave: "xx==x", data: ["0x12", "0x34"]},
    ]
}</script>
<ul>
<li><code>a</code> 周期：master 请求读地址 0x01，slave 接收读请求（<code>STALL_O=0</code>）</li>
<li><code>b</code> 周期：slave 返回读请求结果 0x12，并设置 <code>ACK_I=1</code>；同时 master 请求读地址 0x02，slave 接收读请求（<code>STALL_O=0</code>）</li>
<li><code>c</code> 周期：slave 返回读请求结果 0x34，并设置 <code>ACK_I=1</code>；master 不再发起请求，设置 <code>STB_O=0</code></li>
<li><code>d</code> 周期：所有请求完成，master 设置 <code>CYC_O=0</code></li>
</ul>
<p>这样我们就实现了一个每周期进行一次读操作的 slave。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#_3">参考文档</a></h3>
<ul>
<li><a href="https://cdn.opencores.org/downloads/wbspec_b4.pdf">Wishbone Spec B4</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/06/19/wishbone/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-06-07 00:00:00">2022年6月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nix-cookbook"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/">Nix Cookbook</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_1">背景</a></h3>
<p>最近在尝试 NixOS 和在 macOS 上跑 Nix，下面记录一些我在使用过程中遇到的一些小问题和解决思路。</p>
<h3 id="nixos"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixos">NixOS</a></h3>
<h4 id="_2"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_2">全局配置</a></h4>
<p>NixOS 的全局配置路径：<code>/etc/nixos/configuration.nix</code> 和 <code>/etc/nixos/hardware-configuration.nix</code></p>
<p>应用更新后的全局配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-0-1"></a>nixos-rebuild<span class="w"> </span>switch
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-0-2"></a><span class="c1">## or</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-0-3"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--upgrade
</span></code></pre></div>
<p>应用 Flakes 配置文件并显示变化：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-1"></a><span class="c1">##!/usr/bin/env python3</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-2"></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-4"></a><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-5"></a><span class="n">home</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/nix/var/nix/profiles/&quot;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-6"></a><span class="n">old</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">system&quot;</span><span class="p">)</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-7"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo nixos-rebuild switch --flake .&quot;</span><span class="p">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-8"></a><span class="n">new</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">system&quot;</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-9"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nix store diff-closures </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="_3"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_3">更新大版本</a></h4>
<p>如果要更新 NixOS 21.11 到 22.05:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-2-1"></a>nix-channel<span class="w"> </span>--list
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-2-2"></a>nix-channel<span class="w"> </span>--add<span class="w"> </span>https://nixos.org/channels/nixos-22.05<span class="w"> </span>nixos
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-2-3"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--upgrade
</span></code></pre></div>
<p>可以考虑改或者不改 <code>/etc/nixos/configuration.nix</code> 中的 <code>system.stateVersion</code>。</p>
<h4 id="_4"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_4">常用配置</a></h4>
<p>常用的 NixOS 配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-1"></a><span class="c1">## Enable XFCE</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-2"></a>services<span class="o">.</span>xserver<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-3"></a>services<span class="o">.</span>xserver<span class="o">.</span>desktopManager<span class="o">.</span>xfce<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-5"></a><span class="c1">## System wide packages</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-6"></a>environment<span class="o">.</span><span class="ss">systemPackages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-7"></a>  xxx
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-8"></a><span class="p">];</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-10"></a><span class="c1">## Fish shell</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-11"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-12"></a>users<span class="o">.</span>users<span class="o">.</span><span class="ss">xxx =</span> <span class="p">{</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-13"></a>  <span class="ss">shell =</span> pkgs<span class="o">.</span>fish<span class="p">;</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-14"></a><span class="p">}</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-16"></a><span class="c1">## Command not found</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-17"></a>programs<span class="o">.</span>command-not-found<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-18"></a>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-19"></a><span class="c1">## Steam gaming</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-20"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfree =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-21"></a>programs<span class="o">.</span>steam<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-22"></a>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-23"></a><span class="c1">## NOPASSWD for sudo</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-24"></a>security<span class="o">.</span>sudo<span class="o">.</span><span class="ss">wheelNeedsPassword =</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-25"></a>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-26"></a><span class="c1">## QEMU guest</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-27"></a>services<span class="o">.</span>qemuGuest<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-28"></a>services<span class="o">.</span>spice-vdagentd<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-29"></a>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-30"></a><span class="c1">## XRDP</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-31"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-32"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">defaultWindowManager =</span> <span class="s2">&quot;xfce4-session&quot;</span><span class="p">;</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-33"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">openFirewall =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-34"></a>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-35"></a><span class="c1">## OpenSSH server</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-36"></a>services<span class="o">.</span>openssh<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-37"></a>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-38"></a><span class="c1">## Udev rules for Altera USB Blaster</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-39"></a>services<span class="o">.</span>udev<span class="o">.</span><span class="ss">packages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-40"></a>  usb-blaster-udev-rules
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-41"></a><span class="p">];</span>
</span></code></pre></div>
<h4 id="vscode-remote"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#vscode-remote">VSCode Remote</a></h4>
<p>VSCode Remote 会在远程的机器上运行一个预编译的 nodejs，运行的时候会因为路径问题无法执行。</p>
<p>解决方法在 <a href="https://nixos.wiki/wiki/Visual_Studio_Code#Remote_SSH">NixOS Wiki</a> 上有，具体来说，首先，需要安装 <code>nodejs</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-4-1"></a>environment<span class="o">.</span><span class="ss">systemPackages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-4-2"></a>  nodejs-16_x <span class="c1"># vscode remote</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-4-3"></a><span class="p">];</span>
</span></code></pre></div>
<p>然后，用软链接来覆盖 nodejs：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-5-1"></a><span class="nb">cd</span><span class="w"> </span>~/.vscode-server/bin/HASH
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-5-2"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/run/current-system/sw/bin/node
</span></code></pre></div>
<p>这样就可以正常使用 VSCode Remote 了。</p>
<h3 id="home-manager"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#home-manager">Home Manager</a></h3>
<p><a href="https://github.com/nix-community/home-manager">Home Manager</a> 描述用户默认看到的程序，而 NixOS 的配置是所有用户的。</p>
<h4 id="_5"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_5">配置文件</a></h4>
<p>配置文件：<code>~/.config/nixpkgs/home.nix</code></p>
<p>应用配置文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-6-1"></a>home-manager<span class="w"> </span>switch
</span></code></pre></div>
<p>应用 Flakes 配置文件并显示变化：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-1"></a><span class="c1">##!/usr/bin/env python3</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-2"></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-4"></a><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-5"></a><span class="n">home</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/nix/var/nix/profiles/per-user/</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">/&quot;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-6"></a><span class="n">old</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">profile&quot;</span><span class="p">)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-7"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;home-manager switch --flake .&quot;</span><span class="p">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-8"></a><span class="n">new</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">profile&quot;</span><span class="p">)</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-9"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nix store diff-closures </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="_6"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_6">常用配置</a></h4>
<p>常用的 Home Manager 配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-1"></a><span class="c1">## Allow unfree</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-2"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfree =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-3"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfreePredicate =</span> <span class="p">(</span>pkg<span class="p">:</span> <span class="no">true</span><span class="p">);</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-5"></a><span class="c1">## User wide packages</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-6"></a>home<span class="o">.</span><span class="ss">packages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-7"></a>  xxx
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-8"></a><span class="p">];</span>
</span></code></pre></div>
<p>生成 Nix 配置 <code>~/.config/nix/nix.conf</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-1"></a><span class="c1">## Enable flakes &amp; setup TUNA mirror</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-2"></a>nix<span class="o">.</span><span class="ss">package =</span> pkgs<span class="o">.</span>nix<span class="p">;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-3"></a>nix<span class="o">.</span><span class="ss">settings =</span> <span class="p">{</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-4"></a>  <span class="ss">experimental-features =</span> <span class="p">[</span> <span class="s2">&quot;nix-command&quot;</span> <span class="s2">&quot;flakes&quot;</span> <span class="p">];</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-5"></a>  <span class="ss">substituters =</span> <span class="p">[</span> <span class="s2">&quot;https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store&quot;</span> <span class="s2">&quot;https://cache.nixos.org/&quot;</span><span class="p">];</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-6"></a><span class="p">};</span>
</span></code></pre></div>
<p>Shell 环境变量和 PATH：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-1"></a>home<span class="o">.</span><span class="ss">sessionVariables =</span> <span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-2"></a>  <span class="ss">A =</span> <span class="s2">&quot;B&quot;</span><span class="p">;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-3"></a><span class="p">};</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-4"></a>home<span class="o">.</span><span class="ss">sessionPath =</span> <span class="p">[</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-5"></a>  <span class="s2">&quot;$HOME/.local/bin&quot;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-6"></a><span class="p">];</span>
</span></code></pre></div>
<p>离线 Home Manager 文档（用 <code>home-manager-help</code> 命令打开）：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-11-1"></a>manual<span class="o">.</span>html<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="_7"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_7">覆盖依赖版本</a></h4>
<p>设置 JVM 程序依赖的 JDK 版本：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-1"></a><span class="c1">## Maven with java 11</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-2"></a>home<span class="o">.</span><span class="ss">packages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-3"></a>  <span class="p">(</span>maven<span class="o">.</span>override <span class="p">{</span> <span class="ss">jdk =</span> jdk11<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-4"></a><span class="p">];</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-6"></a><span class="c1">## Many packages with the same JDK</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-7"></a>home<span class="o">.</span><span class="ss">packages =</span> 
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-8"></a>  <span class="k">let</span> <span class="ss">java =</span> pkgs<span class="o">.</span>jdk11<span class="p">;</span> <span class="k">in</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-9"></a>  <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-10"></a>    <span class="p">(</span>maven<span class="o">.</span>override <span class="p">{</span> <span class="ss">jdk =</span> java<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-11"></a>    <span class="p">(</span>sbt<span class="o">.</span>override <span class="p">{</span> <span class="ss">jre =</span> java<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-12"></a>  <span class="p">];</span>
</span></code></pre></div>
<p>具体的参数命名要看 nixpkgs 上对应的包的开头。</p>
<h4 id="direnv"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#direnv">配置 direnv</a></h4>
<p>direnv 是一个 shell 插件，它的用途是进入目录的时候，会根据 .envrc 来执行命令，比如自动进入 nix-shell 等。配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-13-1"></a>programs<span class="o">.</span>direnv<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span></code></pre></div>
<p>然后在工程路径下，编写 <code>.envrc</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-14-1"></a>use_nix
</span></code></pre></div>
<p>那么，在 shell 进入目录的时候，就会自动获得 nix-shell 的环境变量。</p>
<h4 id="fish"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#fish">配置 fish</a></h4>
<p>可以在 home manager 配置中编写 fish 配置，这样它会自动生成 <code>~/.config/fish/config.fish</code> 文件：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-1"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-2"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">shellAliases =</span> <span class="p">{</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-3"></a>  <span class="ss">a =</span> <span class="s2">&quot;b&quot;</span><span class="p">;</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-4"></a><span class="p">};</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-5"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">shellInit =</span> <span class="s1">&#39;&#39;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-6"></a><span class="s1">  # Rust</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-7"></a><span class="s1">  set -x PATH ~/.cargo/bin $PATH</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-8"></a><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="git"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#git">配置 git</a></h4>
<p>同理，也可以在 home manager 中配置 git：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-1"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-2"></a>programs<span class="o">.</span>git<span class="o">.</span>lfs<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-3"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">userName =</span> <span class="s2">&quot;Someone&quot;</span><span class="p">;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-4"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">userEmail =</span> <span class="s2">&quot;mail@example.com&quot;</span><span class="p">;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-5"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">extraConfig =</span> <span class="p">{</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-6"></a>  <span class="ss">core =</span> <span class="p">{</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-7"></a>    <span class="ss">quotepath =</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-8"></a>  <span class="p">};</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-9"></a>  <span class="ss">pull =</span> <span class="p">{</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-10"></a>    <span class="ss">rebase =</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-11"></a>  <span class="p">};</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-12"></a><span class="p">};</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-13"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">ignores =</span> <span class="p">[</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-14"></a>  <span class="s2">&quot;.DS_Store&quot;</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-15"></a><span class="p">];</span>
</span></code></pre></div>
<p>生成的 <code>git</code> 配置在 <code>~/.config/git/config</code> 和 <code>~/.config/git/ignore</code>。</p>
<h3 id="flakes"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#flakes">Flakes</a></h3>
<p>Flakes 可以用来把多个系统的 nix 配置写在一个项目中。例如：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-1"></a><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-2"></a>  <span class="ss">description =</span> <span class="s2">&quot;Nix configuration&quot;</span><span class="p">;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-3"></a>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-4"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-5"></a>    home-manager<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:nix-community/home-manager/release-22.05&quot;</span><span class="p">;</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-6"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:nixos/nixpkgs/nixos-22.05&quot;</span><span class="p">;</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-7"></a>  <span class="p">};</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-8"></a>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-9"></a>  <span class="ss">outputs =</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> home-manager <span class="p">}:</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-10"></a>    <span class="p">{</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-11"></a>      nixosConfigurations<span class="o">.</span><span class="ss">xxxx =</span> nixpkgs<span class="o">.</span>lib<span class="o">.</span>nixosSystem <span class="p">{</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-12"></a>        <span class="ss">system =</span> <span class="s2">&quot;x86_64-linux&quot;</span><span class="p">;</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-13"></a>        <span class="ss">modules =</span> <span class="p">[</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-14"></a>          <span class="o">.</span><span class="l">/nixos/xxxx/configuration.nix</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-15"></a>          home-manager<span class="o">.</span>nixosModules<span class="o">.</span>home-manager
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-16"></a>          <span class="o">.</span><span class="l">/nixos/xxxx/home.nix</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-17"></a>        <span class="p">];</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-18"></a>      <span class="p">};</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-19"></a>      homeConfigurations<span class="o">.</span><span class="ss">yyyy =</span> home-manager<span class="o">.</span>lib<span class="o">.</span>homeManagerConfiguration <span class="p">{</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-20"></a>        <span class="ss">configuration =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/home-manager/yyyy/home.nix</span><span class="p">;</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-21"></a>        <span class="ss">system =</span> <span class="s2">&quot;aarch64-darwin&quot;</span><span class="p">;</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-22"></a>        <span class="ss">homeDirectory =</span> <span class="s2">&quot;/Users/yyyy&quot;</span><span class="p">;</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-23"></a>        <span class="ss">username =</span> <span class="s2">&quot;yyyy&quot;</span><span class="p">;</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-24"></a>        <span class="ss">stateVersion =</span> <span class="s2">&quot;22.05&quot;</span><span class="p">;</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-25"></a>      <span class="p">};</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-26"></a>    <span class="p">};</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后，要应用上面的配置，运行：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-1"></a><span class="c1">## NixOS</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-2"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-3"></a><span class="c1">## Home manager</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-4"></a>home-manager<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.
</span></code></pre></div>
<p>这样就可以把若干个系统上的 nix 配置管理在一个仓库中了。</p>
<h3 id="_8"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_8">实用工具</a></h3>
<h4 id="nixpkgs-fmt"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixpkgs-fmt">nixpkgs-fmt</a></h4>
<p><a href="https://github.com/nix-community/nixpkgs-fmt">nixpkgs-fmt</a> 用来格式化 Nix 代码。</p>
<h4 id="searchnixosorg"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#searchnixosorg">search.nixos.org</a></h4>
<p><a href="https://search.nixos.org/">search.nixos.org</a> 可以搜索 nixpkgs 上的各种包，也可以看到不同平台支持情况。缺点是看不出是否 unfree 和 broken，并且一些 darwin os-specific 的包不会显示。</p>
<h4 id="nix-tree"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nix-tree">nix-tree</a></h4>
<p>显示各个 nix derivation 的硬盘占用和依赖关系。</p>
<h3 id="_9"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_9">打包</a></h3>
<p>可以很容易地编写 <code>default.nix</code> 来给自己的项目打包。</p>
<h4 id="cmake"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#cmake">CMake</a></h4>
<p>对于一个简单的 cmake 程序，可以按照如下的格式编写 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-1"></a><span class="k">with</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{};</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-3"></a>stdenv<span class="o">.</span>mkDerivation <span class="p">{</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-4"></a>  <span class="ss">name =</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-5"></a>  <span class="ss">version =</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-7"></a>  <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-8"></a>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-9"></a>  <span class="ss">nativeBuildInputs =</span> <span class="p">[</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-10"></a>    cmake
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-11"></a>  <span class="p">];</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-12"></a>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-13"></a>  <span class="ss">buildInputs =</span> <span class="p">[</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-14"></a>    xxx
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-15"></a>    yyy
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-16"></a>  <span class="p">];</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以用 <code>nix-build</code> 命令来构建，生成结果会在当前目录下创建一个 <code>result</code> 的软链接，里面就是安装目录。</p>
<p>由于 <code>nix-build</code> 的时候也会创建 <code>build</code> 目录，为了防止冲突，建议开发的时候用其他的名字。</p>
<h4 id="qt"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#qt">Qt</a></h4>
<p>对于 Qt 项目来说，由于有不同的 Qt 大版本，所以实现的时候稍微复杂一些，要拆成两个文件，首先是 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-20-1"></a><span class="k">with</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{};</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-20-3"></a>libsForQt5<span class="o">.</span>callPackage <span class="o">.</span><span class="l">/xxx.nix</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></div>
<p>这里就表示用 <code>qt5</code> 来编译，那么编写 <code>xxx.nix</code> 的时候，传入的 <code>qtbase</code> 等库就是 <code>qt5</code> 的版本：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-1"></a><span class="p">{</span> stdenv<span class="p">,</span> qtbase<span class="p">,</span> wrapQtAppsHook<span class="p">,</span> cmake <span class="p">}:</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-3"></a>stdenv<span class="o">.</span>mkDerivation <span class="p">{</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-4"></a>  <span class="ss">name =</span> <span class="s2">&quot;xxx&quot;</span><span class="p">;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-5"></a>  <span class="ss">version =</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-6"></a>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-7"></a>  <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-8"></a>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-9"></a>  <span class="ss">nativeBuildInputs =</span> <span class="p">[</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-10"></a>    cmake
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-11"></a>    wrapQtAppsHook <span class="c1"># must-have for qt apps</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-12"></a>  <span class="p">];</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-13"></a>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-14"></a>  <span class="ss">buildInputs =</span> <span class="p">[</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-15"></a>    qtbase
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-16"></a>  <span class="p">];</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际测试中发现，运行的程序可能会报告 <code>Could not initialize GLX</code> 的错误，这个方法可以通过 <code>wrapProgram</code> 添加环境变量解决：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-1"></a>  # https://github.com/NixOS/nixpkgs/issues/66755#issuecomment-657305962
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-2"></a>  # Fix &quot;Could not initialize GLX&quot; error
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-3"></a>  postInstall = &#39;&#39;
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-4"></a>    wrapProgram &quot;$out/bin/xxx&quot; --set QT_XCB_GL_INTEGRATION none
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-5"></a>  &#39;&#39;;
</span></code></pre></div>
<h3 id="_10"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_10">开发环境</a></h3>
<p>除了打包以外，通常还会在 <code>shell.nix</code> 中定义开发环境需要的包：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-1"></a><span class="p">{</span> pkgs <span class="o">?</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{}</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-2"></a><span class="p">}:</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-4"></a>pkgs<span class="o">.</span>mkShell <span class="p">{</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-5"></a>  <span class="ss">buildInputs =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-6"></a>    cmake
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-7"></a>  <span class="p">];</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后可以用 <code>nix-shell</code> 来进入开发环境。如果不希望外面的环境变量传递进去，可以用 <code>nix-shell --pure</code>。</p>
<h3 id="_11"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_11">搜索</a></h3>
<p>按名字搜索一个包：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-24-1"></a>nix<span class="w"> </span>search<span class="w"> </span>nixpkgs<span class="w"> </span>xxx
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="../../software/2022/06/07/nix-cookbook/#__codelineno-24-2"></a>nix-env<span class="w"> </span>-qaP<span class="w"> </span>yyy
</span></code></pre></div>
<h3 id="nixpkgs"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixpkgs">Nixpkgs</a></h3>
<p>可以从 TUNA 镜像上先 clone 一份到本地，然后再添加 github 上游作为 remote。</p>
<p>从本地 nixpkgs 安装：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-25-1"></a>nix-env<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>-iA<span class="w"> </span>xxx
</span></code></pre></div>
<p>从本地 nixpkgs 编译：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-26-1"></a>nix-build<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>-A<span class="w"> </span>xxx
</span></code></pre></div>
<p>从本地 nixpkgs 开一个 shell：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="../../software/2022/06/07/nix-cookbook/#__codelineno-27-1"></a>nix-shell<span class="w"> </span>-I<span class="w"> </span><span class="nv">nixpkgs</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>-p<span class="w"> </span>xxx
</span></code></pre></div>
<h4 id="nixpkgs_1"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixpkgs_1">Nixpkgs 的分支</a></h4>
<p>Nixpkgs 开发分支主要有三个：</p>
<ol>
<li>master</li>
<li>staging-next</li>
<li>staging</li>
</ol>
<p>发 PR 的时候，如果需要重新编译的包比较多，就要往 staging 提交；比较少，就往 staging-next 提交。</p>
<p>CI 会自动把 master 合并到 staging-next，也会把 staging-next 合并到 staging。这样 master 上的改动也会同步到 staging 上。</p>
<p>维护者会定义把 staging 手动合并到 staging-next，然后手动合并 staging-next 到 staging。这个的周期一般是一周多，可以在 pr 里搜索 staging-next。</p>
<p>Hydra 会编译 master 分支和 staging-next 分支上的包，不会编译 staging 分支上的包。同理，binary cache 上前两个分支上有的，而 staging 上没有的。</p>
<p>参考：<a href="https://nixos.org/manual/nixpkgs/stable/#submitting-changes-commit-policy">https://nixos.org/manual/nixpkgs/stable/#submitting-changes-commit-policy</a></p>
<h4 id="_12"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_12">提交贡献</a></h4>
<p>注意事项：</p>
<ol>
<li>升级一些比较老的写法，例如 mkDerivation -&gt; stdenv.mkDerivation，Qt 的 hook</li>
<li>引入 patch 的时候，建议先向上游提 PR，如果合并了，就直接用上游的 commit；如果没有合并，退而求其次可以用 pr 的 patch；如果没有提 PR 的渠道，或者上游的 commit 无法应用到当前的版本，或者这个 patch 没有普适性，再写本地的 patch；注释里要写打 patch 的原因和相关的 issue 链接，什么时候不再需要这个 patch，并且起个名字</li>
<li>不知道 SHA256 的时候，可以注释掉或者随便写一个，这样 nix build 的时候会重新下载，然后把正确的显示出来</li>
<li>对于有命令的包，可以添加 testVersion 测试</li>
<li>长时间没有 review 的 pr，可以在 discourse 上回复帖子。</li>
<li>更新之前，可以搜索一下，有没有相关的 issue 或者 pr；如果有 issue，新建 pr 的时候要提一下</li>
</ol>
<p>一些常见的问题：</p>
<ol>
<li>编译器打开 <code>-fno-common</code> 后，可能会导致一些链接问题</li>
<li>Darwin 上的 clang 没有打开 LTO，也没有打开 Universal 支持</li>
<li>AArch64 Darwin 上的 gfortran 的 stack protector 不工作，需要把 hardening 关掉</li>
<li>当编译报错是 <code>-Werror</code> 导致的时候，按照 warning 类型在 NIX_CFLAGS_COMPILE 中添加 <code>-Wno-error=warning-type</code></li>
<li>configure 版本较老，需要引入 autoreconfHook</li>
</ol>
<p>阅读文档：<a href="https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/quick-start.chapter.md">https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/quick-start.chapter.md</a> 和 <a href="https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/coding-conventions.chapter.md">https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/coding-conventions.chapter.md</a></p>
<h3 id="vscode"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#vscode">VSCode</a></h3>
<p>可以安装 <a href="https://github.com/nix-community/vscode-nix-ide/">https://github.com/nix-community/vscode-nix-ide/</a> 插件，配合 <code>rnix-lsp</code> 来使用。</p>
<h3 id="_13"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_13">杂项</a></h3>
<p>可以用 <code>nix copy</code> 命令在不同机器的 store 之间复制文件，见 <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-copy.html">nix copy - copy paths between Nix stores</a>。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/06/07/nix-cookbook/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-31 00:00:00">2022年5月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="libvirt-risc-v"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/">在 libvirt 中运行 RISC-V 虚拟机</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#_1">背景</a></h3>
<p>我在 libvirt 中跑了几个 KVM 加速的虚拟机，然后突发奇想，既然 libvirt 背后是 qemu，然后 qemu 是支持跨指令集的，那是否可以让 libvirt 来运行 RISC-V 架构的虚拟机？经过一番搜索，发现可以跑 ARM：<a href="https://fedoraproject.org/wiki/Architectures/ARM/HowToQemu#Using_QEMU_with_libvirt">How To: Running Fedora-ARM under QEMU</a>，既然如此，我们也可以试试用 libvirt 来运行 RV64 虚拟机。</p>
<h3 id="rootfs"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#rootfs">准备 rootfs</a></h3>
<p>第一步是根据 Debian 的文档 <a href="https://wiki.debian.org/RISC-V#Creating_a_riscv64_chroot">Creating a riscv64 chroot</a> 来创建 rootfs，然后再用 virt-make-fs 来打包。</p>
<p>首先是用 mmdebstrap 来生成一个 chroot：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-0-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/riscv64-chroot
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-0-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>mmdebstrap<span class="w"> </span>qemu-user-static<span class="w"> </span>binfmt-support<span class="w"> </span>debian-ports-archive-keyring
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-0-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>mmdebstrap<span class="w"> </span>--architectures<span class="o">=</span>riscv64<span class="w"> </span>--include<span class="o">=</span><span class="s2">&quot;debian-ports-archive-keyring&quot;</span><span class="w"> </span>sid<span class="w"> </span>/tmp/riscv64-chroot<span class="w"> </span><span class="s2">&quot;deb http://deb.debian.org/debian-ports sid main&quot;</span><span class="w"> </span><span class="s2">&quot;deb http://deb.debian.org/debian-ports unreleased main&quot;</span>
</span></code></pre></div>
<p>进入 chroot 以后，进行一些配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>chroot<span class="w"> </span>/tmp/riscv64-chroot
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-2"></a>$<span class="w"> </span>apt<span class="w"> </span>update
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-3"></a>$<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>linux-image-riscv64<span class="w"> </span>u-boot-menu<span class="w"> </span>vim
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-4"></a><span class="c1">## set root password</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-5"></a>$<span class="w"> </span>passwd
</span></code></pre></div>
<p>然后修改 <code>/etc/default/u-boot</code> 文件，添加如下的配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-1"></a><span class="c1">## change ro to rw, set root device</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-2"></a><span class="nv">U_BOOT_PARAMETERS</span><span class="o">=</span><span class="s2">&quot;rw noquiet root=/dev/vda1&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-3"></a><span class="c1">## fdt is provided by qemu</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-4"></a><span class="nv">U_BOOT_FDT_DIR</span><span class="o">=</span><span class="s2">&quot;noexist&quot;</span>
</span></code></pre></div>
<p>然后运行 <code>u-boot-update</code> 生成配置文件 <code>/boot/extlinux/extlinux.conf</code>。</p>
<p>到这里，rootfs 已经准备完毕。</p>
<h3 id="qemu"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#qemu">尝试在 QEMU 中启动</a></h3>
<p>接下来，可以参考 <a href="https://wiki.debian.org/RISC-V#Setting_up_a_riscv64_virtual_machine">Setting up a riscv64 virtual machine</a> 先启动一个 qemu 来测试一下是否可以正常工作：</p>
<p>首先制作一个 qcow2 格式的镜像：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>virt-make-fs<span class="w"> </span>--partition<span class="o">=</span>gpt<span class="w"> </span>--type<span class="o">=</span>ext4<span class="w"> </span>--size<span class="o">=</span>+10G<span class="w"> </span>--format<span class="o">=</span>qcow2<span class="w"> </span>/tmp/riscv64-chroot<span class="w"> </span>rootfs.qcow2
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-2"></a>$<span class="w"> </span>qemu-img<span class="w"> </span>info<span class="w"> </span>rootfs.qcow2
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-3"></a>image:<span class="w"> </span>rootfs.qcow2
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-4"></a>file<span class="w"> </span>format:<span class="w"> </span>qcow2
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-5"></a>virtual<span class="w"> </span>size:<span class="w"> </span><span class="m">11</span>.4<span class="w"> </span>GiB<span class="w"> </span><span class="o">(</span><span class="m">12231971328</span><span class="w"> </span>bytes<span class="o">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-6"></a>disk<span class="w"> </span>size:<span class="w"> </span><span class="m">1</span>.33<span class="w"> </span>GiB
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-7"></a>cluster_size:<span class="w"> </span><span class="m">65536</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-8"></a>Format<span class="w"> </span>specific<span class="w"> </span>information:
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-9"></a><span class="w">    </span>compat:<span class="w"> </span><span class="m">1</span>.1
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-10"></a><span class="w">    </span>compression<span class="w"> </span>type:<span class="w"> </span>zlib
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-11"></a><span class="w">    </span>lazy<span class="w"> </span>refcounts:<span class="w"> </span><span class="nb">false</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-12"></a><span class="w">    </span>refcount<span class="w"> </span>bits:<span class="w"> </span><span class="m">16</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-13"></a><span class="w">    </span>corrupt:<span class="w"> </span><span class="nb">false</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-14"></a><span class="w">    </span>extended<span class="w"> </span>l2:<span class="w"> </span><span class="nb">false</span>
</span></code></pre></div>
<p>然后启动 qemu，配置好 OpenSBI 和 U-Boot 的路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>qemu-system-misc<span class="w"> </span>opensbi<span class="w"> </span>u-boot-qemu
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>qemu-system-riscv64<span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt<span class="w"> </span>-m<span class="w"> </span>8G<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-3"></a><span class="w">    </span>-bios<span class="w"> </span>/usr/lib/riscv64-linux-gnu/opensbi/generic/fw_jump.elf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-4"></a><span class="w">    </span>-kernel<span class="w"> </span>/usr/lib/u-boot/qemu-riscv64_smode/uboot.elf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-5"></a><span class="w">    </span>-object<span class="w"> </span>rng-random,filename<span class="o">=</span>/dev/urandom,id<span class="o">=</span>rng0<span class="w"> </span>-device<span class="w"> </span>virtio-rng-device,rng<span class="o">=</span>rng0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-6"></a><span class="w">    </span>-append<span class="w"> </span><span class="s2">&quot;console=ttyS0 rw root=/dev/vda1&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-7"></a><span class="w">    </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd0<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>rootfs.qcow2,format<span class="o">=</span>qcow2,id<span class="o">=</span>hd0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-8"></a><span class="w">    </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>usernet<span class="w"> </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>usernet,hostfwd<span class="o">=</span>tcp::22222-:22
</span></code></pre></div>
<p>如果系统可以正常工作，看到下面的输出，下一步就可以配置 libvirt 了。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-1"></a>[    6.285024] Run /init as init process
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-2"></a>Loading, please wait...
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-3"></a>Starting version 251.1-1
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-4"></a>[    7.743714] virtio_ring: module verification failed: signature and/or required key missing - tainting kernel
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-5"></a>[    8.071762] virtio_blk virtio1: [vda] 23838189 512-byte logical blocks (12.2 GB/11.4 GiB)
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-6"></a>[    8.181210]  vda: vda1
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-7"></a>Begin: Loading essential drivers ... done.
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-8"></a>Begin: Running /scripts/init-premount ... done.
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-9"></a>Begin: Mounting root file system ... Begin: Running /scripts/local-top ... done.
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-10"></a>Begin: Running /scripts/local-premount ... done.
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-11"></a>Warning: fsck not present, so skipping root file system
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-12"></a>[    9.003143] EXT4-fs (vda1): mounted filesystem with ordered data mode. Quota mode: none.
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-13"></a>done.
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-14"></a>Begin: Running /scripts/local-bottom ... done.
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-15"></a>Begin: Running /scripts/init-bottom ... done.
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-16"></a>[    9.754151] Not activating Mandatory Access Control as /sbin/tomoyo-init does not exist.
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-17"></a>[    9.808860] random: fast init done
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-18"></a>[   10.651361] systemd[1]: Inserted module &#39;autofs4&#39;
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-19"></a>[   10.735574] systemd[1]: systemd 251.1-1 running in system mode (+PAM +AUDIT +SELINUX +APPARMOR +IMA +SMACK +SECCOMP +GCRYPT -GNUTLS +OPENSSL +ACL +BLKID +CURL +ELFUTILS +FIDO2 +IDN2 -IDN +IPTC +KMOD +LIBCRYPTSETUP +LIBFDISK +PCRE2 -PWQUALITY -P11KIT -QRENCODE +TPM2 +BZIP2 +LZ4 +XZ +ZLIB +ZSTD -BPF_FRAMEWORK -XKBCOMMON +UTMP +SYSVINIT default-hierarchy=unified)
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-20"></a>[   10.736902] systemd[1]: Detected architecture riscv64.
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-21"></a>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-22"></a>Welcome to Debian GNU/Linux bookworm/sid!
</span></code></pre></div>
<h3 id="libvirt"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#libvirt">配置 libvirt</a></h3>
<p>首先，打开 virt-manager，在向导中，可以在下拉菜单选择自定义的架构，选择 riscv64 和 virt，然后选择 Import existing disk image，找到刚刚创建的 qcow2 文件。</p>
<p>创建好以后，我们还不能直接启动，因为此时还没有配置 OpenSBI 和 U-Boot。由于 virt-aa-helper 会<a href="https://github.com/wiedi/libvirt/blob/435b4ad22bf812d97f30e4d6b71e6b3a967f4f75/src/security/virt-aa-helper.c#L529">检查 OpenSBI 和 U-Boot 的路径，要求它们不能在 /usr/lib 路径下</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-1"></a><span class="cm">/*</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-2"></a><span class="cm"> * Don&#39;t allow access to special files or restricted paths such as /bin, /sbin,</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-3"></a><span class="cm"> * /usr/bin, /usr/sbin and /etc. This is in an effort to prevent read/write</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-4"></a><span class="cm"> * access to system files which could be used to elevate privileges. This is a</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-5"></a><span class="cm"> * safety measure in case libvirtd is under a restrictive profile and is</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-6"></a><span class="cm"> * subverted and trying to escape confinement.</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-7"></a><span class="cm"> *</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-8"></a><span class="cm"> * Note that we cannot exclude block devices because they are valid devices.</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-9"></a><span class="cm"> * The TEMPLATE file can be adjusted to explicitly disallow these if needed.</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-10"></a><span class="cm"> *</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-11"></a><span class="cm"> * RETURN: -1 on error, 0 if ok, 1 if blocked</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-12"></a><span class="cm"> */</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">restricted</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-14"></a><span class="w">        </span><span class="s">&quot;/bin/&quot;</span><span class="p">,</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-15"></a><span class="w">        </span><span class="s">&quot;/etc/&quot;</span><span class="p">,</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-16"></a><span class="w">        </span><span class="s">&quot;/lib&quot;</span><span class="p">,</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-17"></a><span class="w">        </span><span class="s">&quot;/lost+found/&quot;</span><span class="p">,</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-18"></a><span class="w">        </span><span class="s">&quot;/proc/&quot;</span><span class="p">,</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-19"></a><span class="w">        </span><span class="s">&quot;/sbin/&quot;</span><span class="p">,</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-20"></a><span class="w">        </span><span class="s">&quot;/selinux/&quot;</span><span class="p">,</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-21"></a><span class="w">        </span><span class="s">&quot;/sys/&quot;</span><span class="p">,</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-22"></a><span class="w">        </span><span class="s">&quot;/usr/bin/&quot;</span><span class="p">,</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-23"></a><span class="w">        </span><span class="s">&quot;/usr/lib&quot;</span><span class="p">,</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-24"></a><span class="w">        </span><span class="s">&quot;/usr/sbin/&quot;</span><span class="p">,</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-25"></a><span class="w">        </span><span class="s">&quot;/usr/share/&quot;</span><span class="p">,</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-26"></a><span class="w">        </span><span class="s">&quot;/usr/local/bin/&quot;</span><span class="p">,</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-27"></a><span class="w">        </span><span class="s">&quot;/usr/local/etc/&quot;</span><span class="p">,</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-28"></a><span class="w">        </span><span class="s">&quot;/usr/local/lib&quot;</span><span class="p">,</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-29"></a><span class="w">        </span><span class="s">&quot;/usr/local/sbin/&quot;</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-30"></a><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<p>所以，我手动把 U-Boot 和 OpenSBI 复制一份到 /var/lib 下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/lib/custom
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-2"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/var/lib/custom
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>/usr/lib/u-boot/qemu-riscv64_smode<span class="w"> </span>.
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-4"></a>$<span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>/usr/lib/riscv64-linux-gnu<span class="w"> </span>.
</span></code></pre></div>
<p>此时，再去配置 libvirt 的 XML 配置文件：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-1"></a><span class="w">  </span><span class="nt">&lt;os&gt;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-2"></a><span class="w">    </span><span class="nt">&lt;type</span><span class="w"> </span><span class="na">arch=</span><span class="s">&#39;riscv64&#39;</span><span class="w"> </span><span class="na">machine=</span><span class="s">&#39;virt&#39;</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-3"></a><span class="w">    </span><span class="nt">&lt;loader</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;rom&#39;</span><span class="nt">&gt;</span>/var/lib/custom/riscv64-linux-gnu/opensbi/generic/fw_jump.elf<span class="nt">&lt;/loader&gt;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-4"></a><span class="w">    </span><span class="nt">&lt;kernel&gt;</span>/var/lib/custom/qemu-riscv64_smode/uboot.elf<span class="nt">&lt;/kernel&gt;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-5"></a><span class="w">    </span><span class="nt">&lt;boot</span><span class="w"> </span><span class="na">dev=</span><span class="s">&#39;hd&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-6"></a><span class="w">  </span><span class="nt">&lt;/os&gt;</span>
</span></code></pre></div>
<p>其余部分不用修改。在下面可以看到 virt-manager 已经设置好了 qemu-system-riscv64:</p>
<div class="language-XML highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-1"></a><span class="nt">&lt;devices&gt;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-2"></a><span class="w">  </span><span class="nt">&lt;emulator&gt;</span>/usr/bin/qemu-system-riscv64<span class="nt">&lt;/emulator&gt;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-3"></a><span class="w">  </span><span class="nt">&lt;disk</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;file&#39;</span><span class="w"> </span><span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-4"></a><span class="w">    </span><span class="nt">&lt;driver</span><span class="w"> </span><span class="na">name=</span><span class="s">&#39;qemu&#39;</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;qcow2&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-5"></a><span class="w">    </span><span class="nt">&lt;source</span><span class="w"> </span><span class="na">file=</span><span class="s">&#39;/path/to/rootfs.qcow2&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-6"></a><span class="w">    </span><span class="nt">&lt;target</span><span class="w"> </span><span class="na">dev=</span><span class="s">&#39;vda&#39;</span><span class="w"> </span><span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-7"></a><span class="w">    </span><span class="nt">&lt;address</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;pci&#39;</span><span class="w"> </span><span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span><span class="w"> </span><span class="na">bus=</span><span class="s">&#39;0x04&#39;</span><span class="w"> </span><span class="na">slot=</span><span class="s">&#39;0x00&#39;</span><span class="w"> </span><span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-8"></a><span class="w">  </span><span class="nt">&lt;/disk&gt;</span>
</span></code></pre></div>
<p>保存以后直接启动，就完成了在 libvirt 中运行 Debian RV64 虚拟机的目的。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/05/31/qemu-rv64-in-libvirt/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-19 00:00:00">2022年5月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 16 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sram"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/">「教学」异步 SRAM 时序</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_1">背景</a></h3>
<p>在一些场合里，我们会使用异步的（即没有时钟信号的）外部 SRAM 来存储数据，而我们经常使用的很多外部接口都是同步接口（即有时钟信号的接口），比如 SPI 和 I2C 等等，UART 虽然是异步，但是它速度很低，不怎么需要考虑时序的问题。所以在 FPGA 上编写一个正确的异步 SRAM 控制器是具有一定的挑战的。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_2">寄存器时序</a></h3>
<p>考虑到读者可能已经不记得寄存器的时序了，这里首先来复习一下 setup 和 hold 的概念。如果你已经比较熟悉了，可以直接阅读下一节。</p>
<p>寄存器在时钟的上升沿（下图的 <code>a</code>）进行采样，为了保证采样的稳定性，输入引脚 <code>D</code> 需要在时钟上升沿之前 <span class="arithmatex">\(t_{su}\)</span> 的时刻（下图的 <code>b</code>）到时钟上升沿之后 <span class="arithmatex">\(t_h\)</span> 的时刻（下图的 <code>c</code>）保持稳定，输出引脚 <code>Q</code> 会在时钟上升沿之后 <span class="arithmatex">\(t_{cko}\)</span> 的时刻（下图的 <code>d</code>）变化：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "C", wave: "p.", period: 4, node: ".a"},
      { name: "D", wave: "x..3.x", phase: 0.2, node: "...b.c"},
      { name: "Q", wave: "x...3.", node: "....d"}
    ]
}</script>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_3">接口</a></h3>
<p>首先我们来看看异步 SRAM 的接口。下文中，采用 <a href="https://www.issi.com/WW/pdf/61WV102416ALL.pdf">IS61WV102416BLL-10TLI</a> 和 <a href="https://www.alliancememory.com/wp-content/uploads/pdf/sram/fa/Alliance%C2%A0Memory_4M%C2%A0Fast_SRAM_AS7C34098A_Sep2021_v2.3.pdf">AS7C34098A-10TCN</a> 作为例子：</p>
<p><img alt="" src="/images/sram.png" /></p>
<p>可以看到，它有 20 位的地址，16 位的数据，若干个控制信号，同时只能进行读或者写（简称 <code>1RW</code>）。它没有时钟信号，所以是异步 SRAM。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_4">时序</a></h3>
<p>对于一个同步接口，我们通常只需要给一个满足时钟周期的时钟，然后通过约束文件保证 setup 和 hold 条件满足即可。但是对于异步接口，由于输出的时候没有时钟，我们需要更小心地完成这件事情。</p>
<h4 id="_5"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_5">读时序</a></h4>
<p>首先来看一下比较简单的读时序：</p>
<p><img alt="" src="/images/sram_read.png" /></p>
<p>可以看到地址和数据的关系：首先是地址需要稳定 <span class="arithmatex">\(t_{RC}\)</span> 的时间，那么数据合法的范围是地址稳定的初始时刻加上 <span class="arithmatex">\(t_{AA}\)</span>，到地址稳定的结束时刻加上 <span class="arithmatex">\(t_{OH}\)</span>。我们再来看一下这几个时间的范围：</p>
<p><img alt="" src="/images/sram_read_param.png" /></p>
<p>首先可以看到读周期时间 <span class="arithmatex">\(t_{RC}\)</span> 至少是 10ns，这对应了型号中最后的数字，这表示了这个 SRAM 最快的读写速度。比较有意思的是 <span class="arithmatex">\(t_{AA}\)</span> 最多是 10ns，刚好和 <span class="arithmatex">\(t_{RC}\)</span> 的最小值相等。</p>
<p>接下来我们考虑一下如何为 SRAM 控制器时序读取的功能。看到上面的波形图，大概可以想到几条设计思路：</p>
<ol>
<li>首先输出要读取的地址，为了让它稳定（<span class="arithmatex">\(t_{RC}\)</span> 的时间内不能变化），要直接从 FPGA 内部寄存器的输出端口输出</li>
<li>等待若干个周期，确保数据已经稳定，在满足 FPGA 内部寄存器的 setup 和 hold 约束的情况下，把结果保存在内部寄存器中。</li>
</ol>
<p>简单起见，先设置一个非常快的 SRAM 控制器频率：500MHz，每个周期 2ns，假如在 <code>a</code> 时刻地址寄存器输出了当前要读取的地址，那么数据会在一段时间后变为合法。这里 <code>a-&gt;b</code> 是读取周期时间 <span class="arithmatex">\(t_{RC}\)</span>，<code>a-&gt;c</code> 是地址到数据的延迟 <span class="arithmatex">\(t_{AA}\)</span>，<code>b-&gt;d</code> 是地址改变后数据的保持时间 <span class="arithmatex">\(t_{OH}\)</span>。</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........", node: "......e"},
      { name: "addr", wave: "x3....xxx", node: ".a....b"},
      { name: "data", wave: "xxx4....x", node: "...c....d"},
    ]
}</script>
<p>那么根据这个图，很自然的想法是，我先给出地址，然后数周期，数了五个周期后，此时 <span class="arithmatex">\(t_{RC}=10\mathrm{ns}\)</span>，然后我就在 <code>e</code> 的上升沿上把输入数据锁存到寄存器中，例如下面的波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........", node: "......e"},
      { name: "addr", wave: "x3....xxx", node: ".a....b"},
      { name: "data", wave: "xxx4....x", node: "...c....d"},
      { name: "data_reg", wave: "x.....4..", node: "......f"},
    ]
}</script>
<p>这个时候 <code>data_reg</code> 的 setup 时间是 <code>c-&gt;e</code>，hold 时间是 <code>e-&gt;d</code>。从图中看起来还有很多的余量，但如果考虑最坏情况，<span class="arithmatex">\(t_{AA}=10\mathrm{ns}\)</span>，就会变成下面的波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........", node: "......e"},
      { name: "addr", wave: "x3....xxx", node: ".a....b"},
      { name: "data", wave: "x.....4.x", node: "......c.d"},
      { name: "data_reg", wave: "x.....x4.", node: "......."},
    ]
}</script>
<p>这个时候在 <code>e</code> 时刻不再满足 setup 约束。这个问题在仿真中，可能会“极限操作”表现为没有问题，但实际上，地址从 FPGA 到 SRAM 的延迟有：</p>
<ol>
<li>地址寄存器从时钟上升沿到输出变化的延迟：<span class="arithmatex">\(T_{CKO}=0.40\mathrm{ns}\)</span></li>
<li>寄存器输出到 FPGA 输出引脚的延迟：<span class="arithmatex">\(T_{IOOP} \in (2.56, 3.80)\mathrm{ns}\)</span></li>
<li>FPGA 输出的地址信号通过信号线到 SRAM 的延迟：<span class="arithmatex">\(T_{PD}\)</span></li>
</ol>
<p>数据从 SRAM 到 FPGA 的延迟有：</p>
<ol>
<li>SRAM 数据信号通过信号线到 FPGA 的延迟：<span class="arithmatex">\(T_{PD}\)</span></li>
<li>FPGA 的输入引脚到内部寄存器输入端的延迟：<span class="arithmatex">\(T_{IOPI}=1.26ns\)</span></li>
<li>FPGA 内部寄存器的 setup 时间：<span class="arithmatex">\(T_{AS}=0.07\mathrm{ns}\)</span></li>
</ol>
<p><img alt="" src="/images/sram_read_diagram.drawio.png" /></p>
<p>上面的一些数据可以从 <a href="https://docs.xilinx.com/v/u/en-US/ds181_Artix_7_Data_Sheet">Artix-7 FPGA Datasheet</a> 里查到，取的是速度等级 <code>-3</code> 的数据，IO 标准是 <code>LVCMOS33</code>。其中寄存器到 FPGA 输入输出引脚的延迟，实际上由两部分组成：从寄存器到 IOB（IO Block）的延迟，以及 IOB 到 FPGA 输入输出引脚的延迟。我们把地址寄存器的输出作为地址输出，这样 Vivado 就会把寄存器放到 IOB，于是可以忽略寄存器到 IOB 的延迟，详情可以阅读文档 <a href="https://support.xilinx.com/s/article/66668?language=en_US">Successfully packing a register into an IOB with Vivado</a>。</p>
<p>把上面一串加起来，已经有大概 4 到 5ns 了。考虑了延迟以后，上面的图可能实际上是这个样子：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p.........."},
      { name: "addr_fpga", wave: "x3....x...."},
      { name: "addr_sram", wave: "x.3....x....", phase: 0.3},
      { name: "data_sram", wave: "x......4.x..", phase: 0.3},
      { name: "data_fpga", wave: "x.......4.x"},
    ]
}</script>
<p>考虑了这么多实际的延迟因素以后，会发现这个事情并不简单，需要预先估计出数据在大概什么时候稳定，这时候才能保证数据寄存器上保存的数据是正确的。</p>
<p>转念一想，我们的 SRAM Controller 肯定不会跑在 500MHz 这么高的频率下。假如采用 100MHz，可以每两个周期进行一次读操作：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p...", period: 5, phase: 4.0, node: "..ab"},
      { name: "addr_fpga", wave: "x3.........5...."},
      { name: "addr_sram", wave: "x.3.........5...", phase: 0.3},
      { name: "data_sram", wave: "x......4.....x..", phase: 0.3},
      { name: "data_fpga", wave: "x.......4.....x."},
    ]
}</script>
<p>此时在 <code>b</code> 时钟上边沿对 <code>data_fpga</code> 采样就可以保证满足时序的要求。注意这里第二个周期（上图的 <code>a</code>）不能给出第二次读取的地址，否则稳定时间太短，不满足 hold 约束。</p>
<p>如果频率继续降低，使得一个时钟周期大于 <span class="arithmatex">\(t_{AA}\)</span> 加上各种延迟和 setup 时间，那就可以每个周期进行一次读操作：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p...", period: 8, phase: 7.0, node: "..a."},
      { name: "addr_fpga", wave: "x3.......5.......7..."},
      { name: "addr_sram", wave: "x.3.......5.......7..", phase: 0.3},
      { name: "data_sram", wave: "x......4....x..6...x.", phase: 0.3},
      { name: "data_fpga", wave: "x.......4....x..6...x"},
    ]
}</script>
<p>此时在 <code>a</code> 时钟上升沿上，对 <code>data_fpga</code> 进行采样，并且输出下一次读请求的地址。</p>
<h4 id="_6"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_6">写时序</a></h4>
<p>接下来再看看写时序。写时序涉及的信号更多，更加复杂一些，但好处是信号都是从 FPGA 到 SRAM，因此考虑延迟的时候会比较简单，比如上面读时序中需要考虑从 FPGA 到 SRAM 的地址，再从 SRAM 到 FPGA 的数据的路径。时序图如下：</p>
<p><img alt="" src="/images/sram_write.png" /></p>
<p>这个写的时序图，从时间顺序来看有这么几件事情按顺序发生：</p>
<ol>
<li>地址保持稳定</li>
<li>经过 <span class="arithmatex">\(t_{AS}\)</span> 时间后，写使能信号 <span class="arithmatex">\(\overline{WE}\)</span> 变为低电平，表示“开始写入操作”，此时地址是稳定的</li>
<li>经过 <span class="arithmatex">\(t_{WP}\)</span> 时间后，写使能信号<span class="arithmatex">\(\overline{WE}\)</span> 变为高电平，表示“结束写入操作”，此时地址和数据都是稳定的，并且数据满足 setup（<span class="arithmatex">\(t_{DW}\)</span>）和 hold（<span class="arithmatex">\(t_{DH}\)</span>）约束</li>
<li>继续保持地址稳定，直到已经稳定了 <span class="arithmatex">\(t_{WC}\)</span> 时间</li>
</ol>
<p>这些数据的范围如下：</p>
<p><img alt="" src="/images/sram_write_timing.png" /></p>
<p>根据上面的分析，还是先考虑一个 500MHz 的 SRAM 控制器。控制器要写入的话，可以按照如下的顺序操作：</p>
<ol>
<li>第一个周期（下图的 <code>a</code>）先输出要写入的地址和数据，并且设置好 <code>ce_n</code>, <code>oe_n</code>, <code>we_n</code>, <code>ub_n</code> 和 <code>lb_n</code>。</li>
<li>第二个周期（下图的 <code>c</code>）设置 <span class="arithmatex">\(\overline{WE}\)</span> 为低电平，这是为了满足 <span class="arithmatex">\(t_{AS}\)</span> （下图的 <code>a -&gt; c</code>）的条件</li>
<li>等待若干个周期（下图的 <code>c -&gt; d</code>），直到 <span class="arithmatex">\(t_{WP}\)</span> （下图的 <code>c -&gt; d</code>）和 <span class="arithmatex">\(t_{AW}\)</span> （下图的 <code>a -&gt; d</code>）时间满足条件</li>
<li>设置 <span class="arithmatex">\(\overline{WE}\)</span> 为高电平（下图的 <code>d</code>），等待若干个周期（下图的 <code>d -&gt; b</code>），直到满足图中的 <span class="arithmatex">\(t_{WC}\)</span> （下图的 <code>a -&gt; b</code>）时间满足条件</li>
</ol>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p........", node: ".a.....b"},
      { name: "addr", wave: "x3.....5."},
      { name: "data", wave: "x4.....6."},
      { name: "we_n", wave: "1.0...1.0", node: "..c...d"},
      { name: "oe_n", wave: "x1......."},
      { name: "ce_n", wave: "x0......."},
    ]
}</script>
<p>这时候你可能有点疑惑，之前分析读时序的时候，考虑了那么多延迟，为什么写的时候不考虑了？这是因为，写的时候所有的信号都是从 FPGA 输出到 SRAM 的，只要这些信号都是从寄存器直接输出，它们的延迟基本是一样的，所以在 FPGA 侧是什么波形，在 SRAM 侧也是什么波形（准确来说，数据信号因为输出是三态门，所以延迟会稍微高一点，但是由于数据信号的时序余量很大，这个额外的延迟可以忽略不计）。</p>
<p>这时候你可能又有一个疑惑了，在阅读 Datasheet 后发现，<span class="arithmatex">\(t_{AS}\)</span> 最小是 0ns，那能不能在上图的 <code>a</code> 时刻就输出 <code>we_n=0</code>？答案是不行，虽然从波形上来看，是在同一个时钟上升沿更新，但实际上会有一微小的延迟差距，可能导致 <code>we_n</code> 在 <code>addr</code> 之前变化，这时候就可能导致 SRAM 观察到的地址是不稳定的。</p>
<p>再考虑一个比较实际的 100MHz 主频 SRAM 控制器，按照如下的波形，则是每三个周期进行一次写操作：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...", period: 5, phase: 4.0},
      { name: "addr", wave: "x3..............5"},
      { name: "data", wave: "x4..............6"},
      { name: "we_n", wave: "1.....0....1....."},
      { name: "oe_n", wave: "x1..............."},
      { name: "ce_n", wave: "x0..............."},
    ]
}</script>
<p>如果觉得这样做太过保守，想要提升性能，有如下几个可能的思路：</p>
<ol>
<li>让 <code>we_n=0</code> 在时钟下降沿输出，但是编写的时候需要比较谨慎，比如先设置一个上升沿触发的寄存器，然后用另一个寄存器在下降沿对这个寄存器进行采样，再输出。</li>
<li>用一个更高频率的时钟驱动 <code>we_n</code> 的寄存器。</li>
<li>用 FPGA 提供的 <code>ODELAY</code> 自定义输出延迟原语，设置一个固定的输出延迟，比如 1ns。</li>
<li>用 <code>ODDR</code> 原语，人为地添加一个大约 0.50ns 的延迟。</li>
<li>对 <code>we_n</code> 设置一个最小的输出延迟（设置了一个很大的 hold），并且不允许输出 <code>we_n</code> 的寄存器放在 IOB 中（否则无法人为增加信号传播的路径长度）。约束：<code>set_output_delay -clock [get_clocks sram_clk] -min -5.00 [get_ports sram_we_n]</code> 和 <code>set_property IOB FALSE [get_cells top/sram_controller/we_n_reg]</code>。这里的信号和寄存器名称需要按照实际情况修改，第二个不允许放置在 IOB 的约束也可以在 Verilog 代码中用 <code>(* IOB = "FALSE" *)</code> 来实现。</li>
</ol>
<p>按照上面的思路实现，下面是可能达到的效果：</p>
<p>单周期：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...", period: 5, phase: 4.0},
      { name: "addr", wave: "x3....5....7...."},
      { name: "data", wave: "x4....6....8...."},
      { name: "we_n", wave: "1.0...10...10....", phase: 0.8},
      { name: "oe_n", wave: "x1.............."},
      { name: "ce_n", wave: "x0.............."},
    ]
}</script>
<p>双周期：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...", period: 5.0, phase: 4.0},
      { name: "addr", wave: "x3.........5...."},
      { name: "data", wave: "x4.........6...."},
      { name: "we_n", wave: "1.0....1....0....", phase: 0.8},
      { name: "oe_n", wave: "x1.............."},
      { name: "ce_n", wave: "x0.............."},
    ]
}</script>
<h3 id="pl241-sram"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#pl241-sram">PL241 SRAM 控制器</a></h3>
<p>刚刚我们已经设计好了我们的 SRAM 控制器，再让我们来看看 ARM 提供的 SRAM 控制器时序是怎么样的：ARM 文档提供了 <a href="https://developer.arm.com/documentation/ddi0389/b/functional-overview/smc-functional-operation/memory-interface-operation?lang=en">PrimeCell AHB SRAM/NOR Memory Controller (PL241)</a> 的时序图。</p>
<p>读时序：</p>
<p><img alt="" src="/images/pl241_async_read.svg" /></p>
<p>它第一个周期设置了 <code>ce_n=0</code> 和 <code>addr</code>，等待一个周期后，设置 <code>oe_n=0</code>，再等待两个周期，得到数据。</p>
<p>写时序：</p>
<p><img alt="" src="/images/pl241_async_write.svg" /></p>
<p>它第一个周期设置了 <code>ce_n=0</code> <code>addr</code> 和 <code>data</code>，等待一个周期后，设置 <code>we_n=0</code>，等待两个周期，再设置 <code>we_n=1</code>，这样就完成了写入。这和我们的实现是类似的：等待一个额外的周期，保证满足 <code>we_n</code> 下降时地址已经是稳定的。ARM 的文档里也写了如下的备注：</p>
<div class="language-text highlight"><pre><span></span><code>The timing parameter tWC is controlling the deassertion of smc_we_n_0. You can
use it to vary the hold time of smc_cs_n_0[3:0], smc_add_0[31:0] and
smc_data_out_0[31:0]. This differs from the read case where the timing
parameter tCEOE controls the delay in the assertion of smc_oe_n_0.
Additionally, smc_we_n_0 is always asserted one cycle after smc_cs_n_0[3:0] to
ensure the address bus is valid.
</code></pre></div>
<h3 id="_7"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_7">参考文档</a></h3>
<ul>
<li><a href="https://www.issi.com/WW/pdf/61WV102416ALL.pdf">1M x 16 HIGH-SPEED ASYNCHRONOUS CMOS STATIC RAM WITH 3.3V SUPPLY</a></li>
<li><a href="https://docs.xilinx.com/v/u/en-US/ds181_Artix_7_Data_Sheet">Artix-7 FPGAs Data Sheet: DC and AC Switching Characteristics</a></li>
<li><a href="https://support.xilinx.com/s/question/0D52E00006iHkeRSAS/timing-constraints-for-an-asynchronous-sram-interface?language=en_US">Timing constraints for an Asynchronous SRAM interface</a></li>
<li><a href="https://support.xilinx.com/s/article/66668?language=en_US">Successfully packing a register into an IOB with Vivado</a></li>
<li><a href="https://support.xilinx.com/s/article/62661?language=en_US">How to verify whether an I/O register is packed into IOB</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0389/b/functional-overview/smc-functional-operation/memory-interface-operation?lang=en">PrimeCell AHB SRAM/NOR Memory Controller (PL241) - Memory interface operation</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/05/19/async-sram-timing/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-16 00:00:00">2022年5月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ace"><a class="toclink" href="../../hardware/2022/05/16/ace/">「教学」ACE 缓存一致性协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/16/ace/#_1">背景</a></h3>
<p>最近几天分析了 TileLink 的缓存一致性协议部分内容，见<a href="../../hardware/2022/05/09/tilelink/">TileLink 总线协议分析</a>，趁此机会研究一下之前尝试过研究，但是因为缺少一些基础知识而弃坑的 ACE 协议分析。</p>
<p>下面主要参考了 IHI0022E 的版本，也就是 AXI4 对应的 ACE 版本。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/16/ace/#_2">回顾</a></h3>
<p>首先回顾一下一个缓存一致性协议需要支持哪些操作。对于较上一级 Cache 来说，它需要这么几件事情：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据，并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态，比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回，并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知，也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候，需要返回当前的缓存数据，并且更新状态。</li>
<li>需要一个方法来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<p>如果之前看过我的 TileLink 分析，那么上面的这些操作对应到 TileLink 就是：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据（发送 AcquireBlock，等待 GrantData），并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态（发送 AcquirePerm，等待 Grant），比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回（发送 ReleaseData，等待 ReleaseAck），并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知（发送 Release，等待 ReleaseAck），也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候（收到 Probe），需要返回当前的缓存数据（发送 ProbeAck/ProbeAckData），并且更新状态。</li>
<li>需要一个方法（发送 GrantAck）来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<p>秉承着这个思路，再往下看 ACE 的设计，就会觉得很自然了。</p>
<h3 id="cache-state-model"><a class="toclink" href="../../hardware/2022/05/16/ace/#cache-state-model">Cache state model</a></h3>
<p>首先来看一下 ACE 的缓存状态模型，我在之前的<a href="../../hardware/2021/12/17/cache-coherency-protocol/">缓存一致性协议分析</a>中也分析过，它有这么五种，就是 MOESI 的不同说法：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>文档中的定义如下：</p>
<ul>
<li>Valid, Invalid: When valid, the cache line is present in the cache. When invalid, the cache line is not present in the cache.</li>
<li>Unique, Shared: When unique, the cache line exists only in one cache. When shared, the cache line might exist in more than one cache, but this is not guaranteed.</li>
<li>Clean, Dirty: When clean, the cache does not have responsibility for updating main memory. When dirty, the cache line has been modified with respect to main memory, and this cache must ensure that main memory is eventually updated.</li>
</ul>
<p>大致理解的话，Unique 表示只有一个缓存有这个缓存行，Shared 表示有可能有多个缓存有这个缓存行；Clean 表示它不负责更新内存，Dirty 表示它负责更新内存。下面的很多操作都是围绕这些状态进行的。</p>
<p>文档中也说，它支持 MOESI 的不同子集：MESI, ESI, MEI, MOESI，所以也许在一个简化的系统里，一些状态可以不存在，实现会有所不同。</p>
<h3 id="channel-usage-examples"><a class="toclink" href="../../hardware/2022/05/16/ace/#channel-usage-examples">Channel usage examples</a></h3>
<p>到目前为止，我还没有介绍 ACE 的信号，但是我们可以尝试一下，如果我们是协议的设计者，我们要如何添加信号来完成这个事情。</p>
<p>首先考虑上面提到的第一件事情：读或写 miss 的时候，需要请求这个缓存行的数据，并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</p>
<p>我们知道，AXI 有 AR 和 R channel 用于读取数据，那么遇到读或者写 miss 的时候，可以在 AR channel 上捎带一些信息，让下一级的 Interconnect 知道自己的意图是读还是写，然后 Interconnect 就在 R channel 上返回数据。</p>
<p>那么，具体要捎带什么信息呢？我们“不妨”用这样一种命名方式：<code>操作 + 目的状态</code>，比如我读 miss 的时候，需要读取数据，进入 Shared 状态，那就叫 ReadShared；我写 miss 的时候，需要读取数据（通常写入缓存的只是一个缓存行的一部分，所以先要把完整的读进来），那就叫 ReadUnique。这个操作可以编码到一个信号中，传递给 Interconnect。</p>
<p>再来考虑上面提到的第二件事情：写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态，比如从 Shared 到 Modified。</p>
<p>这个操作，需要让 Interconnect 把其他缓存中的这个缓存行数据清空，并且把自己升级到 Unique。根据上面的 <code>操作 + 目的状态</code> 的命名方式，我们可以命名为 CleanUnique，即把其他缓存都 Clean 掉，然后自己变成 Unique。</p>
<p>接下来考虑上面提到的第三件事情：需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回，并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。</p>
<p>按照前面的 <code>操作 + 目的状态</code> 命名法，可以命名为 WriteBackInvalid。ACE 实际采用的命名是 WriteBack。</p>
<p>终于到了第四件事情：收到 snoop 请求的时候，需要返回当前的缓存数据，并且更新状态。</p>
<p>既然 snoop 是从 Interconnect 发给 Master，在已有的 AR R AW W B channel 里没办法做这个事情，不然会打破已有的逻辑。那不得不添加一对 channel，比如我规定一个 AC channel 发送 snoop 请求，规定一个 C channel 让 master 发送响应，这样就可以了。这就相当于 TileLink 里面的 B channel（Probe 请求）和 C channel（ProbeAck 响应）。实际 ACE 和刚才设计的实际有一些区别，把 C channel 拆成了两个：CR 用于返回所有响应，CD 用于返回那些需要数据的响应。这就像 AW 和 W 的关系，一个传地址，一个传数据；类似地，CR 传状态，CD 传数据。</p>
<p>那么，接下来考虑一下 AC channel 上要发送什么请求呢？我们回顾一下上面已经用到的请求类型：需要 snoop 的有 ReadShared，ReadUnique 和 CleanUnique，不需要 snoop 的有 WriteBack。那我们直接通过 AC channel 把 ReadShared，ReadUnique 和 CleanUnique 这三种请求原样发送给需要 snoop 的 cache 那里就可以了。</p>
<p>Cache 在 AC channel 收到这些请求的时候，可以做相应的动作。由于 MOESI 协议下同样的请求可以有不同的响应方法，这里就不细说了。</p>
<p>这时候我们已经基本把 ACE 协议的信号和大题的工作流程推导出来了。哦，我们还忘了第五件事情：需要一个方法来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。TileLink 添加了一个额外的 E channel 来做这个事情，ACE 更加粗暴：直接用一对 RACK 和 WACK 信号来分别表示最后一次读和写已经完成。</p>
<p>关于 WACK 和 RACK 详见 <a href="https://community.arm.com/support-forums/f/soc-design-and-simulation-forum/9888/what-s-the-purpose-for-wack-and-rack-for-ace-and-what-s-the-relationship-with-wvalid-and-rvalid">What's the purpose for WACK and RACK for ACE and what's the relationship with WVALID and RVALID?</a> 的讨论。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/16/ace/#_3">总结</a></h3>
<p>到这里就暂时不继续分析了，其他的很多请求类型是服务于更多场景，比如一次写整个 Cache Line 的话，就不需要读取已有的数据了；或者一次性读取完就不管了，或者这是一个不带缓存的加速器，DMA 等，有一些针对性的优化或者简化的处理，比如对于不带缓存的 master，可以简化为 ACE-Lite，比如 ARM 的 CCI-400 支持两个 ACE master 和 三个 ACE-Lite Master，这些 Master 可以用来接 GPU 等外设。再简化一下 ACE-Lite，就得到了 ACP（Accelerator Coherency Port）。</p>
<p>最后我们再把文章开头的五件事对应到 ACE 上，作为一个前后的呼应：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据（AR 上发送 ReadShared/ReadUnique），并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态（AR 上发送 CleanUnique），比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回（AW 上发送 WriteBack），并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知（AW 上发送 Evict），也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候（AC 上收到 snoop 请求），需要返回当前的缓存数据（通过 CR 和 CD），并且更新状态。</li>
<li>需要一个方法（读 RACK 写 WACK）来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/05/16/ace/#_4">参考文献</a></h3>
<ul>
<li><a href="https://developer.arm.com/documentation/ihi0022/e/">IHI0022E-AMBA AXI and ACE</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/05/16/ace/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-13 00:00:00">2022年5月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rocket-chip"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/">向 Rocket Chip 添加自定义调试信号</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#_1">背景</a></h3>
<p>最近在尝试把核心作为一个 Tile 加到 Rocket System 中，所以想要把核心之前自定义的调试信号接到顶层上去。Rocket System 自带的支持是 trace，也就是输出每个周期 retire 的指令信息，但和自定义的不大一样，所以研究了一下怎么添加自定义的调试信号，并且连接到顶层。</p>
<h3 id="trace"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#trace">分析 Trace 信号连接方式</a></h3>
<p>首先，观察 Rocket Chip 自己使用的 Trace 信号是如何连接到顶层的。在顶层上，可以找到使用的是 <code>testchipip.CanHaveTraceIO</code>:</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-1"></a><span class="k">trait</span><span class="w"> </span><span class="nc">CanHaveTraceIO</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">this</span><span class="p">:</span><span class="w"> </span><span class="nc">HasTiles</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-2"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="nc">CanHaveTraceIOModuleImp</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-4"></a><span class="w">  </span><span class="c1">// Bind all the trace nodes to a BB; we&#39;ll use this to generate the IO in the imp</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">traceNexus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BundleBridgeNexusNode</span><span class="p">[</span><span class="nc">Vec</span><span class="p">[</span><span class="nc">TracedInstruction</span><span class="p">]]()</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-6"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tileTraceNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiles</span><span class="p">.</span><span class="n">flatMap</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-7"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ext_tile</span><span class="p">:</span><span class="w"> </span><span class="nc">WithExtendedTraceport</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">None</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-9"></a><span class="w">  </span><span class="p">}.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">traceNode</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-11"></a><span class="w">  </span><span class="n">tileTraceNodes</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">traceNexus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它采用了 diplomacy 的 BundleBridgeNexusNode，把每个 tile 取出来，把它的 traceNode 接到 traceNexus 上。再看一下模块 <code>CanHaveTraceIOModuleImp</code> 是怎么实现的：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-1"></a><span class="k">trait</span><span class="w"> </span><span class="nc">CanHaveTraceIOModuleImp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">this</span><span class="p">:</span><span class="w"> </span><span class="nc">LazyModuleImpLike</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-2"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">outer</span><span class="p">:</span><span class="w"> </span><span class="nc">CanHaveTraceIO</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">HasTiles</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-3"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="nc">Parameters</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">traceIO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">TracePortKey</span><span class="p">)</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">traceParams</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-6"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">extTraceSeqVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">outer</span><span class="p">.</span><span class="n">traceNexus</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">_1</span><span class="p">)).</span><span class="n">map</span><span class="p">(</span><span class="nc">ExtendedTracedInstruction</span><span class="p">.</span><span class="n">fromVec</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-7"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="nc">Output</span><span class="p">(</span><span class="nc">TraceOutputTop</span><span class="p">(</span><span class="n">extTraceSeqVec</span><span class="p">)))</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-9"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tileInsts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">outer</span><span class="p">.</span><span class="n">traceNexus</span><span class="p">.</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">tileTrace</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">DeclockedTracedInstruction</span><span class="p">.</span><span class="n">fromVec</span><span class="p">(</span><span class="n">tileTrace</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-11"></a><span class="w">    </span><span class="c1">// Since clock &amp; reset are not included with the traced instruction, plumb that out manually</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-12"></a><span class="w">    </span><span class="p">(</span><span class="n">tio</span><span class="p">.</span><span class="n">traces</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="p">(</span><span class="n">outer</span><span class="p">.</span><span class="n">tile_prci_domains</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">tileInsts</span><span class="p">)).</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">prci</span><span class="p">,</span><span class="w"> </span><span class="n">insts</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-13"></a><span class="w">      </span><span class="n">port</span><span class="p">.</span><span class="n">clock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">prci</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clock</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-14"></a><span class="w">      </span><span class="n">port</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">prci</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">reset</span><span class="p">.</span><span class="n">asBool</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-15"></a><span class="w">      </span><span class="n">port</span><span class="p">.</span><span class="n">insns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">insts</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-17"></a>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-18"></a><span class="w">    </span><span class="n">tio</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-19"></a><span class="w">  </span><span class="p">})</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-20"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它从 traceNexus 上接了若干的 trace 信号，然后通过 <code>IO(TraceOutputTop())</code> 接到了顶层的输出信号。</p>
<p>再来看看 Rocket 是如何连接的，首先是 <code>traceNode</code> 的定义：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-1"></a><span class="cm">/** Node for the core to drive legacy &quot;raw&quot; instruction trace. */</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">traceSourceNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BundleBridgeSource</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="n">traceRetireWidth</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">TracedInstruction</span><span class="p">()))</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-3"></a><span class="cm">/** Node for external consumers to source a legacy instruction trace from the core. */</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-4"></a><span class="kd">val</span><span class="w"> </span><span class="n">traceNode</span><span class="p">:</span><span class="w"> </span><span class="nc">BundleBridgeOutwardNode</span><span class="p">[</span><span class="nc">Vec</span><span class="p">[</span><span class="nc">TracedInstruction</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traceNexus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">traceSourceNode</span>
</span></code></pre></div>
<p>然后 Rocket Tile 实现的时候，把自己的 trace 接到 traceSourceNode 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-3-1"></a><span class="n">outer</span><span class="p">.</span><span class="n">traceSourceNode</span><span class="p">.</span><span class="n">bundle</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">trace</span>
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#_2">添加自定义调试信号</a></h3>
<p>到这里，整个思路已经比较清晰了，我们只需要照猫画虎地做一个就行。比如要把自己的 Custom Debug 接口暴露出去，首先也是在 Tile 里面创建一个 SourceNode：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-1"></a><span class="c1">// expose debug</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugSourceNode</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-3"></a><span class="nc">BundleBridgeSource</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CustomDebug</span><span class="p">())</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-4"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugNode</span><span class="p">:</span><span class="w"> </span><span class="nc">BundleBridgeOutwardNode</span><span class="p">[</span><span class="nc">CustomDebug</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-5"></a><span class="n">customDebugSourceNode</span>
</span></code></pre></div>
<p>在 BaseTileModuleImp 里，进行信号的连接：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-5-1"></a><span class="c1">// expose debug</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-5-2"></a><span class="n">outer</span><span class="p">.</span><span class="n">customDebugSourceNode</span><span class="p">.</span><span class="n">bundle</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">debug</span>
</span></code></pre></div>
<p>为了暴露到顶层，我们可以类似地做。在 Subsystem 中：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-1"></a><span class="c1">// expose debug</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugNexus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BundleBridgeNexusNode</span><span class="p">[</span><span class="nc">CustomDebug</span><span class="p">]()</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">tileCustomDebugNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiles</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-4"></a><span class="w">  </span><span class="p">.</span><span class="n">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">tile</span><span class="p">:</span><span class="w"> </span><span class="nc">MeowV64Tile</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-5"></a><span class="w">    </span><span class="nc">Some</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-7"></a><span class="w">  </span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">customDebugNode</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-9"></a><span class="n">tileCustomDebugNodes</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">customDebugNexus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>最后在 SubsystemModule Imp 中连接到 IO：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-1"></a><span class="c1">// wire custom debug signals</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugIO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outer</span><span class="p">.</span><span class="n">customDebugNexus</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">_1</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-4"></a><span class="w">  </span><span class="nc">Output</span><span class="p">(</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-5"></a><span class="w">    </span><span class="nc">Vec</span><span class="p">(</span><span class="n">customDebugIO</span><span class="p">.</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">customDebugIO</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">cloneType</span><span class="p">)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-7"></a><span class="p">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-8"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">customDebug</span><span class="p">.</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-9"></a><span class="w">  </span><span class="n">customDebug</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">customDebugIO</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就搞定了。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#_3">总结</a></h3>
<p>找到这个实现方法，基本是对着自带的 trace 接口做的，比较重要的是理解 diplomacy 里面的两层，第一层是把不同的模块进行一些连接，然后第二层在 ModuleImp 中处理实际的信号和逻辑。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2022/05/13/rocket-chip-custom-debug/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-10 00:00:00">2022年5月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 13 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/">「教学」内存认证算法</a></h2>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#_2">背景</a></h3>
<p>之前 @松 给我讲过一些内存认证（Memory Authentication）算法的内容，受益匪浅，刚好今天某硬件群里又讨论到了这个话题，于是趁此机会再学习和整理一下相关的知识。</p>
<p>内存认证计算的背景是可信计算，比如要做一些涉及重要数据的处理，从软件上，希望即使系统被攻击非法进入了，也可以保证重要信息不会泄漏；从硬件上，希望即使系统可以被攻击者进行一些物理的操作（比如导出或者修改内存等等），也可以保证攻击者无法读取或者篡改数据。</p>
<p>下面的内容主要参考了 <a href="https://link.springer.com/chapter/10.1007/978-3-642-01004-0_1">Hardware Mechanisms for Memory Authentication: A Survey of Existing Techniques and Engines</a> 这篇 2009 年的文章。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#_3">威胁模型</a></h3>
<p>作为一个防御机制，首先要确定攻击方的能力。一个常见的威胁模型是认为，攻击者具有物理的控制，可以任意操控内存中的数据，但是无法读取或者修改 CPU 内部的数据。也就是说，只有 CPU 芯片内的数据是可信的，离开了芯片都是攻击者掌控的范围。一个简单的想法是让内存中保存的数据是加密的，那么怎样攻击者可以如何攻击加密的数据？下面是几个典型的攻击方法：</p>
<ul>
<li>Spoofing attack：把内存数据改成任意攻击者控制的数据；这种攻击可以通过签名来解决</li>
<li>Splicing or relocation attack：把某一段内存数据挪到另一部分，这样数据的签名依然是正确的；所以计算签名时需要把地址考虑进来，这样地址变了，验证签名就会失败</li>
<li>Replay attack：如果同一个地址的内存发生了改变，攻击者可以把旧的内存数据再写进去，这样签名和地址都是正确的；为了防止重放攻击，还需要引入计数器或者随机 nonce</li>
</ul>
<h3 id="authentication-primitives"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#authentication-primitives">Authentication Primitives</a></h3>
<p>为了防御上面几种攻击方法，上面提到的文章里提到了如下的思路：</p>
<p>一是 Hash Function，把内存分为很多个块，每一块计算一个密码学 Hash 保存在片内，那么读取数据的时候，把整块数据读取进来，计算一次 Hash，和片内保存的结果进行比对；写入数据的时候，重新计算一次修改后数据的 Hash，更新到片内的存储。这个方法的缺点是没有加密，攻击者可以看到内容，只不过一修改就会被 CPU 发现（除非 Hash 冲突），并且存储代价很大：比如 512-bit 的块，每一块计算一个 128-bit 的 Hash，那就浪费了 25% 的空间，而片内空间是十分宝贵的。</p>
<p>二是 MAC Function，也就是密码学的消息验证码，它需要一个 Key，保存在片内；由于攻击者不知道密码，根据 MAC 的性质，攻击者无法篡改数据，也无法伪造 MAC，所以可以直接把计算出来的 MAC 也保存到内存里。为了防御重放攻击，需要引入随机的 nonce，并且把 nonce 保存在片内，比如每 512-bit 的数据，保存 64-bit 的 nonce，这样片内需要保存 12.5% 的空间，依然不少。MAC 本身也不加密，所以如果不希望攻击者看到明文，还需要进行加密。</p>
<p>三是 Block-Level AREA，也就是在把明文和随机的 nonce 拼接起来，采用块加密算法，保存在内存中；解密的时候，验证最后的 nonce 和片内保存的一致。这个方法和 MAC 比较类似，同时做了加密的事情，也需要在片内保存每块数据对应的随机 nonce。</p>
<h3 id="integrity-tree"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#integrity-tree">Integrity Tree</a></h3>
<p>但是上面几种方法开销都比较大，比如要保护 1GB 的内存，那么片内就要保存几百 MB 的数据，这对于片内存储来说太大了。这时候，可以采用区块链里常用的 Merkle Tree 或者类似的方法来用时间换空间。</p>
<p>这种方法的主要思路是，首先把内存划分为很多个块，这些块对应一颗树的叶子结点；自底向上构建一颗树，每个结点可以验证它的子结点的完整性，那么经过 log(n) 层的树，最后只会得到一个很小的根结点，只需要把根结点保存在片内。</p>
<p>为了验证某一个块的完整性，就从这一块对应的叶子结点开始，不断计算出一个值，和父亲结点比较；再递归向上，最后计算出根结点的值，和片内保存的值进行对比。这样验证的复杂度是 O(logn)，但是片内保存的数据变成了 O(1)，所以是以时间换空间。更新数据的时候，也是类似地从叶子结点一步一步计算，最后更新根结点的值。</p>
<p>这个方法浪费的空间，考虑所有非叶子结点保存的数据，如果是二叉树，总的大小就是数据的一半，但是好处是大部分都可以保存在内存里，所以是比较容易实现的。缺点是每次读取和写入都要进行 O(logn) 次的内存访问和计算，开销比较大。</p>
<p>上面提到的父结点的值的计算方法，如果采用密码学 Hash 函数，这棵树就是 Merkle Tree。它的验证过程是只读的，可以并行的，但是更新过程是串行的，因为要从子结点一步一步计算 Hash，父结点依赖子结点的 Hash 结果。</p>
<p>另一种设计是 Parallelizable Authentication Tree（PAT），它采用 MAC 而不是 Hash，每个结点保存了一个随机的 nonce 和计算出来的 MAC 值，最底层的 MAC 输入是实际的数据，其他层的 MAC 输入是子结点的 nonce，最后在片内保存最后一次 MAC 使用的 nonce 值。这样的好处是更新的时候，每一层都可以并行算，因为 MAC 的输入是 nonce 值，不涉及到子结点的 MAC 计算结果。缺点是要保存更多数据，即 MAC 和 nonce。</p>
<p>还有一种设计是 Tamper-Evident Counter Tree（TEC-Tree），计算的方法则是上面提到的 Block-level AREA。类似地，最底层是用数据和随机 nonce 拼起来做加密，而其他层是用子节点的随机 nonce 拼起来，再拼接上这一层的 nonce 做加密。验证的时候，首先对最底层进行解密，然后判断数据是否匹配，然后再解密上一层，判断 nonce 是否匹配，一直递归，最后解密到根的 nonce，和片内保存的进行匹配。更新的时候，也可以类似地一次性生产一系列的 nonce，然后并行地加密每一层的结果。</p>
<p>最后引用文章里的一个对比：</p>
<p><img alt="" src="/images/memory_integrity.png" /></p>
<p>可以看到，后两种算法可以并行地更新树的节点，同时也需要保存更多的数据。</p>
<h3 id="cached-trees"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#cached-trees">Cached Trees</a></h3>
<p>从上面的 Integrity Tree 算法可以发现，每次读取或者写入都要访问内存 O(logn) 次，这个对性能影响是十分巨大的。一个简单的思路是，我把一些经常访问的树结点保存在片内的缓存，这样就可以减少一些内存访问次数；进一步地，如果认为攻击者无法篡改片内的缓存，那就可以直接认为片内的结点都是可信的，在验证和更新的时候，只需要从叶子结点遍历到缓存在片内的结点即可。</p>
<h3 id="the-bonsai-merkle-tree"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#the-bonsai-merkle-tree">The Bonsai Merkle Tree</a></h3>
<p>为了进一步减少空间的占用，Bonsai Merkle Tree（BMT）的思路是，既然对每个内存块都生成一个比较长的（比如 64 位）的 nonce 比较耗费空间，那是否可以减少一下 nonce 的位数，当 nonce 出现重复的时候，换一个密钥重新加密呢？具体的做法是，每个内存块做一次 MAC 计算，输入是数据，地址和 counter：<code>M=MAC(C, addr, ctr)</code>。此时，地址和 <code>ctr</code> 充当了原来的 nonce 的作用，所以类似地，此时的 Merkle Tree 保护的是这些 counter，由于 counter 位数比较少，就可以进一步地减少空间的开销，而且树的层数也更少了。缺点是既然位数少了，如果 counter 出现了重复，就需要更换密钥，重新进行一次加密，这个比较耗费时间，所以还要尽量减少重新加密的次数。</p>
<p>具体来说，为了避免重放攻击，每次更新数据的时候，就让 counter 加一，这和原来采用一个足够长（比如 64-bit）的随机 nonce 是类似的。重新加密是很耗费时间的，因此为了把重新加密的范围局限到一个小的局部，又设计了一个两级的 counter：7-bit 的 local counter，每次更新数据加一；64-bit 的 global counter，当某一个 local counter 溢出的时候加一。这时候实际传入 MAC 计算的 counter 则是 global counter 拼接上 local counter。这样相当于是做了一个 counter 的共同前缀，在内存访问比较均匀的时候，比如每个 local counter 轮流加一，那么每次 local counter 溢出只需要重新加密一个小范围的内存，减少了开销。</p>
<p>文章后续还提到了一些相关的算法，这里就不继续翻译和总结了。</p>
<h3 id="mountable-merkle-tree"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#mountable-merkle-tree">Mountable Merkle Tree</a></h3>
<p>再来看一下 <a href="https://www.usenix.org/system/files/osdi21-feng.pdf">Scalable Memory Protection in the Penglai Enclave</a> 中提到的 Mountable Merkle Tree 设计。它主要考虑的是动态可变的保护内存区域，比如提到的微服务场景，并且被保护内存区域的访问有时间局部性，因此它的思路是，不去构造一个对应完整内存的 Merkle Tree，而是允许一些子树不存在。具体来说，它设计了一个 Sub-root nodes 的概念，对应了 Merkle Tree 中间的一层。这一层往上是预先分配好的，并且大部分保存在内存中，根结点保存在片内，这一层往下是动态分配的。比如应用创建了一个新的 enclave，需要新的一个被保护的内存区域，再动态分配若干个 Merkle Tree，接到 Sub-root nodes 层，成为新的子树。</p>
<p><img alt="" src="/images/mountable_merkle_tree.png" /></p>
<p>由于片内空间是有限的，所以这里采取了缓存的方式，只把一部分常用的树结点保存在片内；如果某一个子树一直没有被访问，就可以换出到内存里。如果删除了一个已有的 enclave，那么相应的子树就可以删掉，减少内存空间的占用。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#_4">参考文献</a></h3>
<ul>
<li><a href="https://link.springer.com/chapter/10.1007/978-3-642-01004-0_1">Hardware Mechanisms for Memory Authentication: A Survey of Existing Techniques and Engines</a></li>
<li><a href="https://www.usenix.org/system/files/osdi21-feng.pdf">Scalable Memory Protection in the Penglai Enclave</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/05/10/memory-authentication/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-09 00:00:00">2022年5月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 16 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tilelink"><a class="toclink" href="../../hardware/2022/05/09/tilelink/">TileLink 总线协议分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#_1">背景</a></h3>
<p>最近在研究一些支持缓存一致性的缓存的实现，比如 rocket-chip 的实现和 sifive 的实现，因此需要研究一些 TileLink 协议。本文讨论的时候默认读者具有一定的 AXI 知识，因此很多内容会直接参考 AXI。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#_2">信号</a></h3>
<p>根据 <a href="https://github.com/chipsalliance/omnixtend/blob/master/OmniXtend-1.0.3/spec/TileLink-1.8.0.pdf">TileLink Spec 1.8.0</a>，TileLink 分为以下三种：</p>
<ul>
<li>TL-UL: 只支持读写，不支持 burst，类比 AXI-Lite</li>
<li>TL-UH：支持读写，原子指令，预取，支持 burst，类比 AXI+ATOP（AXI5 引入的原子操作）</li>
<li>TL-C：在 TL-UH 基础上支持缓存一致性协议，类比 AXI+ACE/CHI</li>
</ul>
<h3 id="tilelink-uncached"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#tilelink-uncached">TileLink Uncached</a></h3>
<p>TileLink Uncached(TL-UL 和 TL-UH) 包括了两个 channel：</p>
<ul>
<li>A channel: M-&gt;S 发送请求，类比 AXI 的 AR/AW/W</li>
<li>D channel: S-&gt;M 发送响应，类比 AXI 的 R/W</li>
</ul>
<p>因此 TileLink 每个周期只能发送读或者写的请求，而 AXI 可以同时在 AR 和 AW channel 上发送请求。</p>
<p>一些请求的例子：</p>
<ul>
<li>读：M-&gt;S 在 A channel 上发送 Get，S-&gt;M 在 D channel 上发送 AccessAckData</li>
<li>写：M-&gt;S 在 A channel 上发送 PutFullData/PutPartialData，S-&gt;M 在 D channel 是发送 AccessAck</li>
<li>原子操作：M-&gt;S 在 A channel 上发送 ArithmeticData/LogicalData，S-&gt;M 在 D channel 上发送 AccessAckData</li>
<li>预取操作：M-&gt;S 在 A channel 上发送 Intent，S-&gt;M 在 D channel 上发送 AccessAck</li>
</ul>
<h3 id="axi4totl"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#axi4totl">AXI4ToTL</a></h3>
<p>针对 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L59">AXI4ToTL</a> 模块的例子，来分析一下如何把一个 AXI4 Master 转换为 TileLink。</p>
<p>首先考虑一下 AXI4 和 TileLink 的区别：一个是读写 channel 合并了，所以这里需要一个 Arbiter；其次 AXI4 中 AW 和 W 是分开的，这里也需要进行合并。这个模块并不考虑 Burst 的情况，而是由 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/Fragmenter.scala#L14=">AXI4Fragmenter</a> 来进行拆分，即添加若干个 AW beat，和 W 进行配对。</p>
<p>具体到代码实现上，首先把 AR channel <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L86=">对应到</a> 到 A channel 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-0-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">r_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-0-2"></a><span class="n">r_out</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-0-3"></a><span class="n">r_out</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:&lt;=</span><span class="w"> </span><span class="n">edgeOut</span><span class="p">.</span><span class="nc">Get</span><span class="p">(</span><span class="n">r_id</span><span class="p">,</span><span class="w"> </span><span class="n">r_addr</span><span class="p">,</span><span class="w"> </span><span class="n">r_size</span><span class="p">).</span><span class="n">_2</span>
</span></code></pre></div>
<p>然后 AW+W channel 也<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L119=">连接</a> 到 A channel，由于不用考虑 burst 的情况，这里在 aw 和 w 同时 valid 的时候才认为有请求。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-1-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">w_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-1-2"></a><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">w_out</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-1-3"></a><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">ready</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">w_out</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/05/09/tilelink/#__codelineno-1-4"></a><span class="n">w_out</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/05/09/tilelink/#__codelineno-1-5"></a><span class="n">w_out</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:&lt;=</span><span class="w"> </span><span class="n">edgeOut</span><span class="p">.</span><span class="nc">Put</span><span class="p">(</span><span class="n">w_id</span><span class="p">,</span><span class="w"> </span><span class="n">w_addr</span><span class="p">,</span><span class="w"> </span><span class="n">w_size</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">strb</span><span class="p">).</span><span class="n">_2</span>
</span></code></pre></div>
<p>比较有意思的是读写的 id 增加了若干位，最低位 0 表示读，1 表示写，剩下几位是请求编号，这样发出去的是不同 id 的多个请求。</p>
<p>然后，把读和写的 A channel <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L155=">连接</a>到 Arbiter 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-2-1"></a><span class="nc">TLArbiter</span><span class="p">(</span><span class="nc">TLArbiter</span><span class="p">.</span><span class="n">roundRobin</span><span class="p">)(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">r_out</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">w_out</span><span class="p">))</span>
</span></code></pre></div>
<p>其余的部分则是对 D channel 进行判断，有数据的转给 R channel，没有数据的转给 B channel：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-3-1"></a><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">d_hasData</span><span class="p">,</span><span class="w"> </span><span class="n">ok_r</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">ok_b</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-3-2"></a><span class="n">ok_r</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">d_hasData</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-3-3"></a><span class="n">ok_b</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">d_hasData</span>
</span></code></pre></div>
<p>最后处理了一下 TileLink 和 AXI4 对写请求返回确认的区别：TileLink 中，可以在第一个 burst beat 就返回确认，而 AXI4 需要在最后一个 burst beat 之后返回确认。</p>
<h3 id="tltoaxi4"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#tltoaxi4">TLToAXI4</a></h3>
<p>再来看一下反过来的转换，从 TileLink Master 到 AXI。由于 TileLink 同时只能进行读或者写，所以它首先做了一个虚构的 arw channel，可以理解为合并了 ar 和 aw channel 的 AXI4，这个设计在 SpinalHDL 的代码中也能看到。然后再根据是否是写入，分别<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L153=">连接</a>到 ar 和 aw channel：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-4-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">queue_arw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Queue</span><span class="p">.</span><span class="n">irrevocable</span><span class="p">(</span><span class="n">out_arw</span><span class="p">,</span><span class="w"> </span><span class="n">entries</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="n">flow</span><span class="o">=</span><span class="n">combinational</span><span class="p">)</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-4-2"></a><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-4-3"></a><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/05/09/tilelink/#__codelineno-4-4"></a><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/05/09/tilelink/#__codelineno-4-5"></a><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2022/05/09/tilelink/#__codelineno-4-6"></a><span class="n">queue_arw</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span></code></pre></div>
<p><a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L197=">这里</a>处理了 aw 和 w 的 valid 信号：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-5-1"></a><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">a_isPut</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">doneAW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">out_w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-5-2"></a><span class="n">out_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">a_isPut</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">doneAW</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">out_w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="nc">Bool</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-5-3"></a><span class="n">out_w</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">a_isPut</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">doneAW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span></code></pre></div>
<p>这样做的原因是，在 TileLink 中，每个 burst 都是一个 a channel 上的请求，而 AXI4 中，只有第一个 burst 有 aw 请求，所有 burst 都有 w 请求，因此这里用 doneAW 信号来进行区分。</p>
<p>接着，要把 b 和 r channel 上的结果连接到 d channel，根据上面的经验，<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L205=">这里</a> 又是一个 arbitration：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-6-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">r_wins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">b_delay</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">r_holds_d</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-6-2"></a><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r_wins</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-6-3"></a><span class="n">out</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r_wins</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../hardware/2022/05/09/tilelink/#__codelineno-6-4"></a><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">r_wins</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
</span></code></pre></div>
<p>最后还处理了一下请求和结果顺序的问题。</p>
<h3 id="tilelink-cached"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#tilelink-cached">TileLink Cached</a></h3>
<p>上面说的两个模块都是 TileLink Uncached，那么它如何支持缓存一致性呢？首先，它引入了三个 channel：B、C 和 E，支持三种操作：</p>
<ul>
<li>Acquire：M-&gt;S 在 A channel 上发送 Acquire，S-&gt;M 在 D channel 上发送 Grant，然后 M-&gt;S 在 E channel 上发送 GrantAck；功能是获取一个 copy，可以看到这个和 Get 是类似的，都是在 A channel 上发送请求，在 D channel 上接受响应，只不过额外需要在 E channel 上发送 GrantAck。</li>
<li>Release：M-&gt;S 在 C channel 上发送 Release，S-&gt;M 在 D channel 上发送 ReleaseAck；功能是删除自己的 copy，一般是缓存行要被换出的时候，发送 ReleaseData 来写回 Dirty 数据</li>
<li>Probe：S-&gt;M 在 B channel 上发送 Probe，M-&gt;S 在 C channel 上发送 ProbeAck；功能是要求 M 删除自己的 copy，通常是有某一个缓存发送了 Acquire，导致其他缓存需要降低权限</li>
</ul>
<p>可以看到，A C E 三个 channel 是 M-&gt;S，B D 两个 channel 是 S-&gt;M。</p>
<p>假如一个缓存（Master A）要写入一块只读数据，或者读取一块 miss 的缓存行，如果是广播式的缓存一致性协议，那么需要经历如下的过程：</p>
<ul>
<li>Master A -&gt; Slave: Acquire</li>
<li>Slave -&gt; Master B: Probe</li>
<li>Master B -&gt; Slave: ProbeAck</li>
<li>Slave -&gt; Master A: Grant</li>
<li>Master A -&gt; Slave: GrantAck</li>
</ul>
<p>首先 Master A 发出 Acquire 请求，然后 Slave 向其他 Master 广播 Probe，等到其他 Master 返回 ProbeAck 后，再向 Master A 返回 Grant，最后 Master A 发送 GrantAck 给 Slave。这样 Master A 就获得了这个缓存行的一份拷贝，并且让 Master B 的缓存行失效或者状态变成只读。</p>
<p>TileLink 的缓存行有三个状态：None，Branch 和 Trunk(Tip)。基本对应 MSI 模型：None-&gt;Invalid，Branch-&gt;Shared 和 Trunk-&gt;Modified。Rocket Chip 代码中 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Metadata.scala#L10=">ClientStates</a> 还定义了 Dirty 状态，大致对应 MESI 模型：None-&gt;Invalid，Branch-&gt;Shared，Trunk-&gt;Exclusive，Dirty-&gt;Modified。</p>
<p>此外，标准还说可以在 B 和 C channel 上进行 TL-UH 的操作。标准这么设计的意图是可以让 Slave 转发操作到拥有缓存数据的 Master 上。比如 Master A 在 A channel 上发送 Put 请求，那么 Slave 向 Master B 的 B channel 上发送 Put 请求，Master B 在 C channel 上发送 AccessAck 响应，Slave 再把响应转回 Master A 的 D channel。这就像是一个片上的网络，Slave 负责在 Master 之间路由请求。</p>
<h3 id="broadcast"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#broadcast">Broadcast</a></h3>
<p>接下来看看 Rocket Chip 自带的基于广播的缓存一致性协议实现。核心实现是 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala">TLBroadcast</a>，核心的逻辑就是，如果一个 Master A 发送了 Acquire，那么 TLBroadcast 需要发送 Probe 到其他的 Master，当其他的 Master 都响应了 ProbeAck 后，再返回 Grant 到 Master A。</p>
<p>首先来看 B channel 上的 Probe <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L214=">逻辑</a>。它记录了一个 todo bitmask，表示哪些 Master 需要发送 Probe，这里采用了 Probe Filter 来减少发送 Probe 的次数，因为只需要向拥有这个缓存行的 Master 发送 Probe：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">())</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_perms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-4"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">leftOR</span><span class="p">(</span><span class="n">probe_todo</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-5"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_busy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_todo</span><span class="p">.</span><span class="n">orR</span><span class="p">()</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-6"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">Mux1H</span><span class="p">(</span><span class="n">probe_next</span><span class="p">,</span><span class="w"> </span><span class="n">cache_targets</span><span class="p">)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-8"></a><span class="c1">// Probe whatever the FSM wants to do next</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-9"></a><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">probe_busy</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-11"></a><span class="w">    </span><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">edgeIn</span><span class="p">.</span><span class="nc">Probe</span><span class="p">(</span><span class="n">probe_line</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">lineShift</span><span class="p">,</span><span class="w"> </span><span class="n">probe_target</span><span class="p">,</span><span class="w"> </span><span class="n">lineShift</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">probe_perms</span><span class="p">).</span><span class="n">_2</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-12"></a><span class="p">}</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../hardware/2022/05/09/tilelink/#__codelineno-7-13"></a><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">fire</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">probe_next</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>这里 <code>probe_next</code> 就是被 probe 的那个 Master 对应的 bitmask，<code>probe_target</code> 就是 Master 的 Id。这个 Probe FSM 的输入就是 Probe Filter，它会<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L256=">给出</a>哪些 Cache 拥有当前的缓存行的信息：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">leaveB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">needT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">gaveT</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">others</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cacheOH</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">allocOH</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">leaveB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">others</span><span class="p">)</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-4"></a><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">probe_busy</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-5"></a><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">fire</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-6"></a><span class="w">    </span><span class="n">probe_todo</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">todo</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-7"></a><span class="w">    </span><span class="n">probe_line</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">lineShift</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-8"></a><span class="w">    </span><span class="n">probe_perms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">needT</span><span class="p">,</span><span class="w"> </span><span class="nc">TLPermissions</span><span class="p">.</span><span class="n">toN</span><span class="p">,</span><span class="w"> </span><span class="nc">TLPermissions</span><span class="p">.</span><span class="n">toB</span><span class="p">)</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../hardware/2022/05/09/tilelink/#__codelineno-8-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里又区分两种情况：如果 Acquire 需要进入 Trunk 状态（比如是个写入操作），意味着其他 Master 需要进入 None 状态，所以这里要发送 toN；如果 Acquire 不需要进入 Trunk 状态（比如是个读取操作），那么只需要其他 Master 进入 Branch 状态，所以这里要发送 toB。</p>
<p>在 B channel 发送 Probe 的同时，也要<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L152=">处理</a> C channel 上的 ProbeAck 和 ProbeAckData：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../hardware/2022/05/09/tilelink/#__codelineno-9-1"></a><span class="c1">// Incoming C can be:</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../hardware/2022/05/09/tilelink/#__codelineno-9-2"></a><span class="c1">// ProbeAck     =&gt; decrement tracker, drop </span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../hardware/2022/05/09/tilelink/#__codelineno-9-3"></a><span class="c1">// ProbeAckData =&gt; decrement tracker, send out A as PutFull(DROP)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../hardware/2022/05/09/tilelink/#__codelineno-9-4"></a><span class="c1">// ReleaseData  =&gt;                    send out A as PutFull(TRANSFORM)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../hardware/2022/05/09/tilelink/#__codelineno-9-5"></a><span class="c1">// Release      =&gt; send out D as ReleaseAck</span>
</span></code></pre></div>
<p>由于这里采用的是 invalidation based，所以如果某个 Master 之前处于 Dirty 状态，那么它会发送 ProbeAckData，此时需要把数据写回，所以需要用 PutFull 把数据写出去。</p>
<h3 id="serialization"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#serialization">Serialization</a></h3>
<p>下面来讨论一下 TileLink 对各组信号的一些要求。</p>
<h4 id="flow-control-rules"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#flow-control-rules">Flow Control Rules</a></h4>
<p>首先是 Flow Control Rules，讨论的是 ready 和 valid 信号的关系，目的是防止死锁。首先是两个比较常规的要求：</p>
<ul>
<li>If ready is LOW, the receiver must not process the beat and the sender must not consider the beat processed.</li>
<li>If valid is LOW, the receiver must not expect the control or data signals to be a syntactically correct TileLink beat.</li>
</ul>
<p>第一个说的就是 valid &amp; ready 的时候才认为是一个 beat 处理了，第二个就是如果 valid=LOW，那么信号可能是随机的、不合法的。</p>
<ul>
<li>valid must never depend on ready. If a sender wishes to send a beat, it must assert valid independently of whether the receiver signals that it is ready.</li>
<li>As a consequence, there must be no combinational path from ready to valid or any of the control and data signals.</li>
</ul>
<p>这里是为了防止组合逻辑出现环路，如果 valid 依赖 ready，ready 依赖 valid，就会出现问题，所以这里规定，valid 不能依赖 ready，反过来只能 ready 依赖 valid。类似地，其他的数据和控制信号也不可以依赖 ready。简单理解就是 sender 要主动提供数据，而 receiver 决定了是否接受。</p>
<ul>
<li>A low priority valid may not combinationally depend on a high priority valid. In other words, the decision to send a request may not be based on receiving a response in the same cycle.</li>
<li>A high priority ready may not combinationally depend on a low priority ready. In other words, acceptance of a response may not be made contingent upon a request being accepted the same cycle.</li>
</ul>
<p>这两条的意思是，同一个周期内，我设置发送的请求的 valid，不能依赖于同一个周期内接受到的响应的 valid，比如 A 的 valid 不能组合依赖于 D 的 valid。另一方面，我设置的响应的 ready 不能依赖于同一个周期内的请求，比如 D 的 ready 不能组和依赖于 A 的 ready。</p>
<p>那么，有这么几种用法是可以的：</p>
<ul>
<li>It is acceptable for a receiver to drive ready in response to valid or any of the control and data signals. For example, an arbiter may lower ready if a valid request is made for an address which is busy. However, whenever possible, it is recommended that ready be driven independently so as to reduce the handshaking circuit depth. 接收方可以让 ready 依赖于 valid 或者其他的控制和数据信号，不过这样会让组合逻辑比较长。</li>
<li>A channel may change valid and all control and data signals based on the value of ready in the prior cycle. For example, after a request has been accepted (ready HIGH), a new request may be presented. Only a same-cycle dependency of valid on ready is forbidden. 可以让当前周期的 valid 依赖于上一个周期的 ready 信号，只是不能有同周期的 valid 对 ready 的依赖。</li>
<li>A device may legally drive valid for a response based on valid of a request in the same cycle. For example, a combinational ROM which answers immediately. In this case, presumably ready for the request will likewise be driven by ready for the response. The converse relationship is forbidden. 设备可以让响应的 valid 依赖请求的 valid，比如一个组合的 ROM，它的 D channel 的 valid 可以组合依赖于 A channel 的 valid，同时 A channel 的 ready 组合依赖于 D channel 的 ready。这样就简化了设备的设计，并且可以无延迟地进行访问。</li>
</ul>
<p>和 AXI 不同的一点在于，TileLink 不要求 irrevocable，也就是说如果一个周期内 valid=HIGH 但是 ready=LOW，那么下一个周期 Master 可以修改控制和数据信号，也可以让 valid=LOW。</p>
<div class="language-text highlight"><pre><span></span><code>Note that a sender may raise valid and then lower it on the following
cycle, even if the message was not accepted on the previous cycle. For example,
the sender might have some other higher priority task to perform on the
following cycle, instead of trying to send the rejected message again.
Furthermore, the sender may change the contents of the control and data signals
when a message was not accepted.
</code></pre></div>
<p>TileLink 的 burst 请求是通过比 bus 更宽的 size 的多个 beat 组成的。一旦第一个 beat fire 了，后续只能发送同一个 burst 的数据，不可以交错。</p>
<h4 id="request-response-message-ordering"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#request-response-message-ordering">Request-Response Message Ordering</a></h4>
<p>这里讨论的是请求和响应的顺序关系。TileLink 规定，响应的第一个 beat 不早于第一个请求的 beat，比如：</p>
<ul>
<li>对于 Get 请求，如果响应需要多个 beat，那么第一个 beat 不早于请求的那一个周期，这个比较常规，意思是可以组合返回响应。</li>
<li>对于 Put 请求，如果请求需要多个 beat，那么响应可以在第一个请求的 beat 的周期，这个比较特别，意思是对于多个 beat 的请求，可以立即返回响应，不需要等到所有请求的 beat 完成。</li>
<li>对于 ArithmeticData 请求，响应和请求都可能有多个 beat，那么响应的第一个 beat 不早于请求的第一个 beat 即可，其他没有顺序要求。</li>
</ul>
<h4 id="deadlock-freedom"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#deadlock-freedom">Deadlock Freedom</a></h4>
<p>那么多规则，一个很重要的目的是要防止死锁。为了防止死锁，有这样三条：</p>
<ol>
<li>The agent graph (Section 5.3) contains no cycles</li>
<li>Agents must eventually present all beats of a received message</li>
<li>Unless they have a higher priority message in flight or unanswered<ol>
<li>Agents must eventually accept a presented beat</li>
<li>Agents must eventually answer a received request message</li>
</ol>
</li>
</ol>
<p>大概意思是，beat 不能无限推迟，无论是发送方还是接受方。对于每个请求，它的响应不能无限推迟。</p>
<p>TileLink 定义了各个 channel 的优先级，从低到高是 <code>A&lt;B&lt;C&lt;D&lt;E</code>。对于同一个 channel，A C E 上是 master/sender 优先级更高，B D 上是 slave/receiver 优先级更高。</p>
<p>TileLink 的设计里保证了，每个请求的响应都比请求优先级更高。比如 A channel 的请求（Get/Put/AcquireBlock）的响应在 D channel（AccessAckData/AccessAck/Grant），B channel 的请求（Probe）的响应在 C channel（ProbeAck），C channel 的请求（Release）的响应在 D channel（ReleaseAck），D channel 的请求（Grant）的响应在 E channel（GrantAck）。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#_3">参考文档</a></h3>
<ul>
<li><a href="https://github.com/chipsalliance/omnixtend/blob/master/OmniXtend-1.0.3/spec/TileLink-1.8.0.pdf">TileLink spec</a></li>
<li><a href="https://github.com/chipsalliance/rocket-chip">rocket-chip</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/05/09/tilelink/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-05 00:00:00">2022年5月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nuc11-esxi-igpu"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/">NUC11 ESXi 中 iGPU 直通虚拟机</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/#_1">背景</a></h3>
<p>之前在 NUC11PAKi5 上装了 ESXI 加几个虚拟机系统，但是自带的 iGPU Intel Iris Xe Graphics(Tiger Lake GT-2) 没用上，感觉有些浪费。因此想要给 Windows 直通。在直通到 Windows 后发现会无限重启，最后直通到 Linux 中。</p>
<h3 id="_2"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/#_2">步骤</a></h3>
<p>第一步是到 esxi 的设备设置的地方，把 iGPU 的 Passthrough 打开，这时候会提示需要重启，但是如果重启，会发现还是处于 Needs reboot 状态。网上进行搜索，发现是 ESXi 自己占用了 iGPU 的输出，<a href="https://williamlam.com/2020/06/passthrough-of-integrated-gpu-igpu-for-standard-intel-nuc.html">解决方法</a>如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-0-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>system<span class="w"> </span>settings<span class="w"> </span>kernel<span class="w"> </span><span class="nb">set</span><span class="w"> </span>-s<span class="w"> </span>vga<span class="w"> </span>-v<span class="w"> </span>FALSE
</span></code></pre></div>
<p>这样设置以后就不会在显卡输出上显示 dcui 了，这是一个比较大的缺点，但是平时也不用自带的显示输出，就无所谓了。</p>
<p>第二步，重启以后，这时候看设备状态就是 Active。回到 Windows 虚拟机，添加 PCI device，然后启动。这时候，我遇到了这样的错误：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-1-1"></a>Module ‘DevicePowerOn’ power on failed
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-1-2"></a>Failed to register the device pciPassthru0
</span></code></pre></div>
<p>搜索了一番，<a href="https://shuttletitan.com/vsphere/pci-passthrough-module-devicepoweron-power-on-failed/">解决方法</a>是关掉 IOMMU。在虚拟机设计中关掉 IOMMU，就可以正常启动了。</p>
<p>第三步，进入 Windows，这时候就可以看到有一个新的未知设备了，VID=8086，PID=9a49；等待一段时间，Windows 自动安装好了驱动，就可以正常识别了。GPU-Z 中可以看到效果如下：</p>
<p><img alt="" src="/images/igpu-passthrough.png" /></p>
<p>不过关机重启的时候会蓝屏，可能还有一些问题，有人在<a href="https://community.intel.com/t5/Graphics/SR-IOV-support-for-intel-Iris-Xe-Graphics-on-i7-1165G7/td-p/1293264">论坛</a>上也说 passthrough 之后会蓝屏。这个问题一直没有解决。</p>
<p>再尝试 Passthrough 到 Linux：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>i915
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-2"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.173500<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>enabling<span class="w"> </span>device<span class="w"> </span><span class="o">(</span><span class="m">0000</span><span class="w"> </span>-&gt;<span class="w"> </span><span class="m">0003</span><span class="o">)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-3"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.180137<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>VT-d<span class="w"> </span>active<span class="w"> </span><span class="k">for</span><span class="w"> </span>gfx<span class="w"> </span>access
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-4"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182109<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>BAR<span class="w"> </span><span class="m">6</span>:<span class="w"> </span>can<span class="err">&#39;</span>t<span class="w"> </span>assign<span class="w"> </span><span class="o">[</span>???<span class="w"> </span>0x00000000<span class="w"> </span>flags<span class="w"> </span>0x20000000<span class="o">]</span><span class="w"> </span><span class="o">(</span>bogus<span class="w"> </span>alignment<span class="o">)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-5"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182110<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>VBIOS<span class="w"> </span>tables<span class="w"> </span><span class="o">(</span>VBT<span class="o">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-6"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182541<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>vgaarb:<span class="w"> </span>changed<span class="w"> </span>VGA<span class="w"> </span>decodes:<span class="w"> </span><span class="nv">olddecodes</span><span class="o">=</span>io+mem,decodes<span class="o">=</span>none:owns<span class="o">=</span>none
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-7"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.197374<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>firmware:<span class="w"> </span>direct-loading<span class="w"> </span>firmware<span class="w"> </span>i915/tgl_dmc_ver2_08.bin
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-8"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.198037<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Finished<span class="w"> </span>loading<span class="w"> </span>DMC<span class="w"> </span>firmware<span class="w"> </span>i915/tgl_dmc_ver2_08.bin<span class="w"> </span><span class="o">(</span>v2.8<span class="o">)</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-9"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.401676<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>retrieve<span class="w"> </span>link<span class="w"> </span>info,<span class="w"> </span>disabling<span class="w"> </span>eDP
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-10"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.515822<span class="o">]</span><span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Initialized<span class="w"> </span>i915<span class="w"> </span><span class="m">1</span>.6.0<span class="w"> </span><span class="m">20200917</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">0000</span>:13:00.0<span class="w"> </span>on<span class="w"> </span>minor<span class="w"> </span><span class="m">0</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-11"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.516054<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Cannot<span class="w"> </span>find<span class="w"> </span>any<span class="w"> </span>crtc<span class="w"> </span>or<span class="w"> </span>sizes
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-12"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.516144<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Cannot<span class="w"> </span>find<span class="w"> </span>any<span class="w"> </span>crtc<span class="w"> </span>or<span class="w"> </span>sizes
</span></code></pre></div>
<p>OpenCL 也可以检测到：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>intel-opencl-icd<span class="w"> </span>clinfo
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-2"></a>Number<span class="w"> </span>of<span class="w"> </span>devices<span class="w">                                 </span><span class="m">1</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-3"></a><span class="w">  </span>Device<span class="w"> </span>Name<span class="w">                                     </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Graphics<span class="w"> </span>Gen12LP<span class="w"> </span><span class="o">[</span>0x9a49<span class="o">]</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-4"></a><span class="w">  </span>Device<span class="w"> </span>Vendor<span class="w">                                   </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Corporation
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-5"></a><span class="w">  </span>Device<span class="w"> </span>Vendor<span class="w"> </span>ID<span class="w">                                </span>0x8086
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-6"></a><span class="w">  </span>Device<span class="w"> </span>Version<span class="w">                                  </span>OpenCL<span class="w"> </span><span class="m">3</span>.0<span class="w"> </span>NEO
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-7"></a><span class="w">  </span>Device<span class="w"> </span>Numeric<span class="w"> </span>Version<span class="w">                          </span>0xc00000<span class="w"> </span><span class="o">(</span><span class="m">3</span>.0.0<span class="o">)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-8"></a><span class="w">  </span>Driver<span class="w"> </span>Version<span class="w">                                  </span><span class="m">1</span>.0.0
</span></code></pre></div>
<p>Vulkan：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-1"></a>$<span class="w"> </span>vulkaninfo
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-2"></a>Group<span class="w"> </span><span class="m">1</span>:
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-3"></a><span class="w">        </span>Properties:
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-4"></a><span class="w">                </span>physicalDevices:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-5"></a><span class="w">                        </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-6"></a><span class="w">                </span><span class="nv">subsetAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-8"></a><span class="w">        </span>Present<span class="w"> </span>Capabilities:
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-9"></a><span class="w">                </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>:
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-10"></a><span class="w">                        </span>Can<span class="w"> </span>present<span class="w"> </span>images<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>devices:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-11"></a><span class="w">                                </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-12"></a><span class="w">                </span>Present<span class="w"> </span>modes:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-13"></a><span class="w">                        </span>DEVICE_GROUP_PRESENT_MODE_LOCAL_BIT_KHR
</span></code></pre></div>
<p>不过目前还没找到显示输出的方法，只能用 VMware SVGA 或者远程桌面。</p>
<h3 id="_3"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/#_3">吐槽</a></h3>
<p>需要吐槽的是，11 代的核显不再支持 Intel GVT-g，而是提供了 SR-IOV 的虚拟化。但是，Linux i915 驱动没有做相应的支持。</p>
<p>参考文档：</p>
<ul>
<li><a href="https://williamlam.com/2020/06/passthrough-of-integrated-gpu-igpu-for-standard-intel-nuc.html">Passthrough of Integrated GPU (iGPU) for standard Intel NUC</a></li>
<li><a href="https://shuttletitan.com/vsphere/pci-passthrough-module-devicepoweron-power-on-failed/">PCI Passthrough – “Module ‘DevicePowerOn’ power on failed”</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../system/2022/05/05/nuc11-igpu-passthrough/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-02 00:00:00">2022年5月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="loongarch64"><a class="toclink" href="../../software/2022/05/02/loongarch64-toolchain/">LoongArch64 工具链构建</a></h2>
<p>最近因为龙芯杯的原因，想自己搞个 LoongArch64 的交叉编译工具链试试，结果遇到了很多坑，最后终于算是搞出来了。</p>
<p>一开始是想搞一个 newlib 的工具链，比较简单，而且之前做过一个仓库：<a href="https://github.com/jiegec/riscv-toolchain">jiegec/riscv-toolchain</a>，就是构建的 riscv64-unknown-elf 工具链，照着 riscv-gnu-toolchain 就可以了。不过研究发现，newlib 还不支持 loongarch，目前只有 glibc 支持，只好硬着头皮上了。</p>
<p>于是我就在 riscv-toolchain 的基础上搞 loongarch64-unknown-linux-gnu，也就是带 glibc 的工具链，结果发现遇到很多坑。首先编译 libgcc 的时候就找不到头文件，于是先要从 glibc 和 linux 安装头文件到 sysroot 里面，对于 sysroot 里面的头文件路径到底是 include 还是 usr/include 也折腾了半天。然后编译 libgcc 又各种出问题，最后折腾了半天，结果是 gcc stage1 和 glibc 都没问题，gcc stage2 会报链接错误，但是不管它也能用，可以编译出正常的程序，毕竟 libc 是好的。</p>
<p>于是转念一想，要不要试试 crosstool-ng。克隆了一份上游的版本，照着 riscv 的部分抄了一份变成了 loongarch，然后把 config 里面的 linux/glibc/gcc/binutils-gdb 都替换为 custom location，这样我就可以用上游的最新版本了。中途还遇到了 <a href="https://github.com/crosstool-ng/crosstool-ng/issues/1564">crosstool-ng 对 gcc 12/13 不兼容的 bug</a>，还好下面有人提出了解决方法。这些都搞定以后，终于构建出了一个完整的 loongarch64-unknown-linux-gnu 工具链。仓库地址是 <a href="https://github.com/jiegec/ct-ng-loongarch64">jiegec/ct-ng-loongarch64</a>，需要配合添加了 LoongArch 的 <a href="https://github.com/jiegec/crosstool-ng/tree/loongarch">jiegec/crosstool-ng loongarch 分支</a> 使用。</p>
<p>最后得到的工具链各组件版本如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-1"></a>loongarch64-unknown-linux-gnu-gcc (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.0 20220502 (experimental)
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-2"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-3"></a>This is free software; see the source for copying conditions.  There is NO
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-4"></a>warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-6"></a>GNU ld (crosstool-NG 1.25.0_rc2.1_7e21141) 2.38.50.20220502
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-7"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-8"></a>This program is free software; you may redistribute it under the terms of
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-9"></a>the GNU General Public License version 3 or (at your option) a later version.
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-10"></a>This program has absolutely no warranty.
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-11"></a>GNU gdb (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.50.20220502-git
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-12"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-13"></a>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-14"></a>This is free software: you are free to change and redistribute it.
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-15"></a>There is NO WARRANTY, to the extent permitted by law.
</span></code></pre></div>
<p>之后有时间的话，再把 qemu 和系统搞起来跑跑。</p>
<p>UPDATE: GCC 12.1 发布了，试了一下这个正式版本可以正确地编译。目前还需要使用 HEAD 版本的 binutils 和龙芯的 glibc 和 linux。</p>
<p>参考文档：</p>
<ul>
<li><a href="https://github.com/sunhaiyong1978/CLFS-for-LoongArch/blob/main/CLFS_For_LoongArch64-20220108.md">手把手教你构建基于 LoongArch64 架构的 Linux 系统</a></li>
<li><a href="https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/">How to Build a GCC Cross-Compiler</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../software/2022/05/02/loongarch64-toolchain/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-19 00:00:00">2022年4月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ch32v307"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/">试用沁恒 CH32V307 评估板</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_1">背景</a></h3>
<p>之前有一天看到朋友在捣鼓 CH32V307，因此自己也萌生了试用 CH32V307 评估板的兴趣，于是在<a href="http://www.wch.cn/services/request_sample.html">沁恒官网申请样品</a>，很快就接到电话了解情况，几天后就顺丰送到了，不过因为疫情原因直到现在才拿到手上，只能说疫情期间说不定货比人还快。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_2">开箱</a></h3>
<p>收到的盒子里有一个 <a href="http://special.wch.cn/zh_cn/RISCV_MCU_Index/">CH32V307 评估板</a>，和一个 <a href="http://www.wch.cn/products/WCH-Link.html">WCH-Link</a>，相关资料可以在 <a href="http://www.wch.cn/products/CH32V307.html">官网</a> 或者 <a href="https://github.com/openwch/ch32v307">openwch/ch32v307</a> 下载。在说明书中有如下的图示：</p>
<p><img alt="" src="/images/ch32v307.png" /></p>
<p>板子自带的跳线帽不是很多，建议自备一些，或者用杜邦线替代。比较重要的是 WCH-Link 子板上 CH549 和 CH2V307 连接的几个信号，和下面 BOOT0/1 的选择。</p>
<h3 id="wch-link"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#wch-link">WCH-Link</a></h3>
<p>可以看到评估板自带了一个 WCH-Link，所以不需要附赠的那一个，直接把 11 号 Type-C 连接到电脑上即可。这里还遇到一个小插曲，用 Type-C to Type-C 的线连电脑上不工作，连 PWR LED 都点不亮，换一根 Type-A to Type-C 的就可以，没有继续研究是什么原因。电脑上可以看到 WCH-Link 的设备：VID=1a86, PID=8010。比较有意思的是，在 RISC-V 模式（CON 灯不亮）的时候 PID 是 8010，ARM 模式（CON 灯亮）的时候 PID 是 8011，从 RISC-V 模式切换到 ARM 模式的方法是连接 TX 和 GND 后上电，反过来要用 MounRiver，详见 WCH-Link 使用说明 <a href="http://www.wch.cn/uploads/file/20210707/1625645582172366.pdf">V1.0</a> <a href="http://www.wch.cn/uploads/file/20210906/1630922260396691.pdf">V1.3</a> 和原理图 <a href="http://www.wch.cn/uploads/file/20210104/1609725144187113.pdf">V1.1</a>。</p>
<p>给沁恒开源 WCH-Link 原理图并开放固件点个赞，在淘宝上也可以看到不少 WCH-Link 的仿真器，挺有意思的。</p>
<p>在 ARM 模式下，它实现了类似 <a href="https://www.keil.com/support/man/docs/dapdebug/dapdebug_introduction.htm">CMSIS-DAP</a> 的协议，可以用 OpenOCD 调试：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-1"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>interface<span class="o">/</span>cmsis-dap.cfg<span class="k">]</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-2"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">1000</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-3"></a><span class="nv">cmsis_dap_vid_pid</span><span class="w"> </span><span class="mh">0x1a86</span><span class="w"> </span><span class="mh">0x8011</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-4"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>swd
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-5"></a><span class="nv">init</span>
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-1"></a>$<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>openocd.cfg
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-6"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>SWD<span class="w">  </span>Supported
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-7"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>FW<span class="w"> </span><span class="nv">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>.0.0
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-8"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>Interface<span class="w"> </span>Initialised<span class="w"> </span><span class="o">(</span>SWD<span class="o">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-9"></a>Info<span class="w"> </span>:<span class="w"> </span>SWCLK/TCK<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>SWDIO/TMS<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">TDI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">TDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">nTRST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">nRESET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-10"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>Interface<span class="w"> </span>ready
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-11"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">1000</span><span class="w"> </span>kHz
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-12"></a>Warn<span class="w"> </span>:<span class="w"> </span>gdb<span class="w"> </span>services<span class="w"> </span>need<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>targets<span class="w"> </span>defined
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-14"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span></code></pre></div>
<p>不过这里我们要用的是 RISC-V 处理器 CH32V307，上面的就当是 WCH-LINK 使用的小贴士。</p>
<p>给评估板插上 USB Type-C 以后，首先上面的 WCH-Link 部分中红色的 PWR 和绿色的 RUN 亮，CON 不亮，说明 WCH-LINK 的 CH549 已经启动，并且处在 RISC-V 模式（CON 不亮）。CH549 是一个 8051 指令集的处理器，上面的跑的 WCH-LINK 固件在网上可以找到，在下面提到的 MounRiver Studio 目录中也有一份。</p>
<h3 id="openocd"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#openocd">OpenOCD</a></h3>
<p>目前开源工具上游还不支持 CH32V307 的开发，需要用 <a href="http://www.mounriver.com/download">MounRiver</a>，支持 Windows 和 Linux，有两部分：</p>
<ul>
<li><a href="http://file.mounriver.com/tools/MRS_Toolchain_Linux_x64_V1.40.tar.xz">MRS_Toolchain_Linux_x64_V1.40.tar.xz</a>: RISC-V GNU Toolchain 和 OpenOCD</li>
<li><a href="http://file.mounriver.com/upgrade/MounRiver_Studio_Community_Linux_x64_V110.tar.xz">MounRiver_Studio_Community_Linux_V110</a>：基于 Eclipse 做的 IDE</li>
</ul>
<p>解压缩后，可以看到它的 OpenOCD 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-1"></a><span class="c">### wch-arm.cfg</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-2"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>cmsis-dap
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-3"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>swd
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-4"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>..<span class="o">/</span>share<span class="o">/</span>openocd<span class="o">/</span>scripts<span class="o">/</span>target<span class="o">/</span>ch32f1x.cfg<span class="k">]</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-5"></a><span class="c">### wch-riscv.cfg</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-6"></a><span class="c">##interface wlink</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-7"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>wlink
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-8"></a><span class="nv">wlink_set</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-9"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-10"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x00001</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-12"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-14"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-15"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w">  </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-16"></a><span class="k">set</span><span class="w"> </span>_FLASHNAME<span class="w"> </span><span class="nv">$_CHIPNAME.flash</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-17"></a>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-18"></a><span class="nv">flash</span><span class="w"> </span>bank<span class="w"> </span><span class="nv">$_FLASHNAME</span><span class="w"> </span>wch_riscv<span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">$_TARGETNAME.0</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-20"></a><span class="nv">echo</span><span class="w"> </span><span class="s2">&quot;Ready for Remote Connections&quot;</span>
</span></code></pre></div>
<p>其中 ch32f1x.cfg 就是 stm32f1x.cfg 改了一下名字，可以看到 WCH OpenOCD 把它的 RISC-V 调试协议称为 wlink，估计是取 wch-link 的简称吧。除了 wlink 部分，其他就是正常的 RISC-V CPU 调试的 OpenOCD 配置，比较有意思的就是 IDCODE 设为了 0x00001，比较有个性。</p>
<p>在网上一番搜索，找到了 WCH OpenOCD 的源码 <a href="https://git.minori.work/Embedded_Projects/riscv-openocd-wch">Embedded_Projects/riscv-openocd-wch</a>，是网友向沁恒获取的源代码，毕竟 OpenOCD 是 GPL 软件。简单看了一下代码，是直接把 RISC-V Debug 中的 DMI 操作封装了一下，然后通过 USB Bulk 和 WCH-Link 通信。我从 riscv-openocd 找到了一个比较接近的 <a href="https://github.com/jiegec/riscv-openocd/commit/cc0ecfb6d5b939bd109ea84b07b5eab3cdf80316">commit</a>，然后把 WCH 的代码提交上去，得到了 <a href="https://github.com/jiegec/riscv-openocd/commit/bfa3bc7f98d22fa60ef6d3b2f5d98859fa963f85">diff</a>，有兴趣的可以看看具体实现，甚至把这个支持提交到上游。</p>
<p>有源码以后，就可以在 macOS 上编译了（需要修复三处 clang 报告的编译错误，<a href="https://github.com/jiegec/riscv-openocd/tree/wch">最终代码</a>）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-3-1"></a>$<span class="w"> </span>./bootstrap
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-3-2"></a>$<span class="w"> </span>./configure<span class="w"> </span>--prefix<span class="o">=</span>/path/to/prefix/openocd<span class="w"> </span>--enable-wlink<span class="w"> </span>--disable-werror<span class="w"> </span><span class="nv">CAPSTONE_CFLAGS</span><span class="o">=</span>-I/opt/homebrew/opt/capstone/include/
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-3-3"></a>$<span class="w"> </span>make<span class="w"> </span>-j4<span class="w"> </span>install
</span></code></pre></div>
<p>如果遇到 makeinfo 报错，把 homebrew 的 texinfo 加到 PATH 即可。</p>
<p>编译完成后，就可以用前面提到的 wch-riscv.cfg 进行调试了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-1"></a>$<span class="w"> </span>/path/to/prefix/openocd<span class="w"> </span>-f<span class="w"> </span>wch-riscv.cfg
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0+dev-01623-gbfa3bc7f9<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-04-20-09:55<span class="o">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-6"></a>Info<span class="w"> </span>:<span class="w"> </span>only<span class="w"> </span>one<span class="w"> </span>transport<span class="w"> </span>option<span class="p">;</span><span class="w"> </span>autoselect<span class="w"> </span><span class="s1">&#39;jtag&#39;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-7"></a>Ready<span class="w"> </span><span class="k">for</span><span class="w"> </span>Remote<span class="w"> </span>Connections
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-8"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-9"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-10"></a>Info<span class="w"> </span>:<span class="w"> </span>WCH-Link<span class="w"> </span>version<span class="w"> </span><span class="m">2</span>.3<span class="w"> </span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-11"></a>Info<span class="w"> </span>:<span class="w"> </span>wlink_init<span class="w"> </span>ok
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-12"></a>Info<span class="w"> </span>:<span class="w"> </span>This<span class="w"> </span>adapter<span class="w"> </span>doesn<span class="err">&#39;</span>t<span class="w"> </span>support<span class="w"> </span>configurable<span class="w"> </span>speed
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-13"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-14"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-15"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-16"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-17"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">32</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x40901125
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-18"></a><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span>Target<span class="w"> </span>successfully<span class="w"> </span>examined.
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-19"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-20"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span></code></pre></div>
<p>这也验证了上面的发现：因为绕过了 jtag，直接发送 dmi，所以 idcode 是假的：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-5-1"></a><span class="k">if</span><span class="p">(</span><span class="n">wchwlink</span><span class="p">){</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-5-2"></a><span class="w">        </span><span class="n">buf_set_u32</span><span class="p">(</span><span class="n">idcode_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00001</span><span class="p">);</span><span class="w">  </span><span class="c1">//Default value,for reuse risc-v jtag debug</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-5-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>接下来就可以用 GDB 调试了。里面跑了一个样例的程序，就是向串口打印：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-1"></a>$<span class="w"> </span>screen<span class="w"> </span>/dev/tty.usbmodem*<span class="w"> </span><span class="m">115200</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-2"></a>SystemClk:72000000
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-3"></a><span class="m">111</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-4"></a><span class="w">   </span><span class="m">111</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-5"></a><span class="w">      </span><span class="m">111</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-6"></a><span class="w">         </span><span class="m">111</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-7"></a><span class="w">            </span><span class="m">111</span>
</span></code></pre></div>
<p>之后则是针对各个外设，基于沁恒提供的示例代码进行相应的开发了。</p>
<h3 id="baremetal"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#baremetal">Baremetal 代码</a></h3>
<p>接下来看看沁恒提供的代码是如何配置的。在 EVT/EXAM/SRC/Startup/startup_ch32v30x_D8C.S 可以看到初始化的汇编代码。比较有意思的是，这个核心扩展了 mtvec，支持 ARM 的 vector table 模式，即放一个指针数组，而不是指令：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-1"></a><span class="w">    </span><span class="na">.section</span><span class="w">    </span><span class="no">.vector</span><span class="p">,</span><span class="s">&quot;ax&quot;</span><span class="p">,</span><span class="na">@progbits</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-2"></a><span class="w">    </span><span class="na">.align</span><span class="w">  </span><span class="mi">1</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-3"></a><span class="nl">_vector_base:</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-4"></a><span class="w">    </span><span class="na">.option</span><span class="w"> </span><span class="no">norvc</span><span class="c1">;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-5"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">_start</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-6"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="mi">0</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-7"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">NMI_Handler</span><span class="w">                </span><span class="cm">/* NMI */</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-8"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">HardFault_Handler</span><span class="w">          </span><span class="cm">/* Hard Fault */</span>
</span></code></pre></div>
<p>这些名字如此熟悉，只能说这是 ARVM 了（ARM + RV）。后面的部分比较常规，把 data 段复制到 sram，然后清空 bss：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-1"></a><span class="nl">handle_reset:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-2"></a><span class="na">.option</span><span class="w"> </span><span class="no">push</span><span class="w"> </span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-3"></a><span class="no">.option</span><span class="w"> </span><span class="no">norelax</span><span class="w"> </span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-4"></a><span class="w">        </span><span class="no">la</span><span class="w"> </span><span class="no">gp</span><span class="p">,</span><span class="w"> </span><span class="no">__global_pointer$</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-5"></a><span class="na">.option</span><span class="w"> </span><span class="no">pop</span><span class="w"> </span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-6"></a><span class="mi">1</span><span class="p">:</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-7"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">_eusrstack</span><span class="w"> </span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-8"></a><span class="mi">2</span><span class="p">:</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-9"></a><span class="w">        </span><span class="cm">/* Load data section from flash to RAM */</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-10"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">_data_lma</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-11"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">_data_vma</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-12"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="no">_edata</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-13"></a><span class="w">        </span><span class="nf">bgeu</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="no">f</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-14"></a><span class="err">1:</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-15"></a><span class="w">        </span><span class="nf">lw</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-16"></a><span class="w">        </span><span class="nf">sw</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-17"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-18"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-19"></a><span class="w">        </span><span class="nf">bltu</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-20"></a><span class="err">2:</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-21"></a><span class="w">        </span><span class="cm">/* Clear bss section */</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-22"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">_sbss</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-23"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">_ebss</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-24"></a><span class="w">        </span><span class="nf">bgeu</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="no">f</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-25"></a><span class="err">1:</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-26"></a><span class="w">        </span><span class="nf">sw</span><span class="w"> </span><span class="no">zero</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-27"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-28"></a><span class="w">        </span><span class="nf">bltu</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-29"></a><span class="err">2:</span>
</span></code></pre></div>
<p>最后是进行一些 csr 的配置，然后进入 C 代码：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-1"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1f</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-2"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="mi">0xbc0</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-4"></a><span class="w">    </span><span class="cm">/* Enable nested and hardware stack */</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-5"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1f</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-6"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="mi">0x804</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-7"></a>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-8"></a><span class="w">    </span><span class="cm">/* Enable floating point and interrupt */</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-9"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x6088</span><span class="w">           </span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-10"></a><span class="w">    </span><span class="no">csrs</span><span class="w"> </span><span class="no">mstatus</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-11"></a>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-12"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">_vector_base</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-13"></a><span class="w">    </span><span class="nf">ori</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w">           </span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-14"></a><span class="w">    </span><span class="no">csrw</span><span class="w"> </span><span class="no">mtvec</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-15"></a>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-16"></a><span class="w">    </span><span class="nf">lui</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1ffff</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-17"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x300</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-18"></a><span class="w">    </span><span class="nf">sh</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1b0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-19"></a><span class="err">1:</span><span class="w">  </span><span class="nf">lui</span><span class="w"> </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40022</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-20"></a><span class="w">    </span><span class="nf">lw</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0xc</span><span class="p">(</span><span class="no">s2</span><span class="p">)</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-21"></a><span class="w">    </span><span class="nf">andi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-22"></a><span class="w">    </span><span class="nf">bnez</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-23"></a>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-24"></a><span class="w">    </span><span class="nf">jal</span><span class="w">  </span><span class="no">SystemInit</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-25"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">main</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-26"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="no">mepc</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-27"></a><span class="w">    </span><span class="nf">mret</span>
</span></code></pre></div>
<p>这里有一些自定义的 csr，比如 corecfgr(0xbc0)，intsyscr(0x804，设置了 HWSTKEN=1, INESTEN=1, PMTCFG=0b11, HWSTKOVEN=1)，具体参考 <a href="http://www.wch.cn/downloads/QingKeV4_Processor_Manual_PDF.html">QingKeV4_Processor_Manual</a>。接着代码往 0x1ffff1b0 写入 0x300，然后不断读取 FLASH Interface (0x40022000) 的 STATR 字段，没有找到代码中相关的定义，简单猜测与 Flash 的零等待/非零等待区有关，因为后续代码要提高频率，因此 Flash 控制器需要增加 wait state。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_3">编译</a></h3>
<p>可以用 MounRiver 编译，也可以用 SiFive 的 riscv64-unknown-elf 工具链进行编译，参考 <a href="https://git.minori.work/Embedded_Projects/CH32V307_Template">Embedded_Projects/CH32V307_Template</a> 项目中的编译方式，修改 <code>riscv64-elf.cmake</code> 为：</p>
<div class="language-cmake highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-1"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_SYSTEM_NAME</span><span class="w"> </span><span class="s">Generic</span><span class="p">)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-2"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_COMPILER</span><span class="w"> </span><span class="s">riscv64-unknown-elf-gcc</span><span class="p">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-3"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_COMPILER</span><span class="w"> </span><span class="s">riscv64-unknown-elf-g++</span><span class="p">)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-4"></a><span class="c">## Make CMake happy about those compilers</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-5"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_TRY_COMPILE_TARGET_TYPE</span><span class="w"> </span><span class="s2">&quot;STATIC_LIBRARY&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>然后交叉编译就可以了。需要注意的是对 libnosys 的处理，如果没有正确链接，就会出现 syscall，然后在 ecall handler 里面死循环。</p>
<p>如果不想用 CMake，也可以用下面的精简版 Makefile：</p>
<div class="language-make highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-1"></a><span class="nv">USER</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>User/main.c<span class="w"> </span>User/ch32v30x_it.c<span class="w"> </span>User/system_ch32v30x.c
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-2"></a><span class="nv">LIBRARY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>../../SRC/Peripheral/src/ch32v30x_misc.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-3"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_usart.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-4"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_gpio.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-5"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_rcc.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-6"></a><span class="w">    </span>../../SRC/Debug/debug.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-7"></a><span class="w">    </span>../../SRC/Startup/startup_ch32v30x_D8C.S
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-8"></a><span class="nv">LDSCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>../../SRC/Ld/Link.ld
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-9"></a><span class="c">## disable libc first</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-10"></a><span class="nv">CFLAGS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>-march<span class="o">=</span>rv32imafc<span class="w"> </span>-mabi<span class="o">=</span>ilp32f<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-11"></a><span class="w">    </span>-flto<span class="w"> </span>-ffunction-sections<span class="w"> </span>-fdata-sections<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-12"></a><span class="w">    </span>-nostartfiles<span class="w"> </span>-nostdlib<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-13"></a><span class="w">    </span>-T<span class="w"> </span><span class="k">$(</span>LDSCRIPT<span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-14"></a><span class="w">    </span>-I../../SRC/Debug<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-15"></a><span class="w">    </span>-I../../SRC/Core<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-16"></a><span class="w">    </span>-I../../SRC/Peripheral/inc<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-17"></a><span class="w">    </span>-I./User<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-18"></a><span class="w">    </span>-O2<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-19"></a><span class="w">    </span>-Wl,--print-memory-usage
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-20"></a><span class="c">## link libc &amp; libnosys in the end</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-21"></a><span class="nv">CFLAGS_END</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-22"></a><span class="w">    </span>-lc<span class="w"> </span>-lgcc<span class="w"> </span>-lnosys
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-23"></a><span class="nv">PREFIX</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>riscv64-unknown-elf-
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-25"></a><span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">obj</span>/<span class="n">build</span>.<span class="n">bin</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-26"></a>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-27"></a><span class="nf">obj/build.bin</span><span class="o">:</span><span class="w"> </span><span class="n">obj</span>/<span class="n">build</span>.<span class="n">elf</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-28"></a><span class="w">    </span><span class="k">$(</span>PREFIX<span class="k">)</span>objcopy<span class="w"> </span>-O<span class="w"> </span>binary<span class="w"> </span>$^<span class="w"> </span><span class="nv">$@</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-29"></a>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-30"></a><span class="nf">obj/build.elf</span><span class="o">:</span><span class="w"> </span><span class="k">$(</span><span class="nv">USER</span><span class="k">)</span> <span class="k">$(</span><span class="nv">LIBRARY</span><span class="k">)</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-31"></a><span class="w">    </span><span class="k">$(</span>PREFIX<span class="k">)</span>gcc<span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>$^<span class="w"> </span><span class="k">$(</span>CFLAGS_END<span class="k">)</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-32"></a>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-33"></a><span class="nf">clean</span><span class="o">:</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-34"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>obj/*
</span></code></pre></div>
<h3 id="flash"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#flash">烧写 Flash</a></h3>
<p>编译好以后，根据 WCH OpenOCD 的文档，可以用下面的配置来进行烧写：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-1"></a><span class="c">##interface wlink</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-2"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>wlink
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-3"></a><span class="nv">wlink_set</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-4"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-5"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x00001</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-7"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-9"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-10"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w">  </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-11"></a><span class="k">set</span><span class="w"> </span>_FLASHNAME<span class="w"> </span><span class="nv">$_CHIPNAME.flash</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-13"></a><span class="nv">flash</span><span class="w"> </span>bank<span class="w"> </span><span class="nv">$_FLASHNAME</span><span class="w"> </span>wch_riscv<span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">$_TARGETNAME.0</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-14"></a>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-15"></a><span class="nv">init</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-16"></a><span class="nv">halt</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-18"></a><span class="nv">flash</span><span class="w"> </span>erase_sector<span class="w"> </span>wch_riscv<span class="w"> </span><span class="mi">0</span><span class="w"> </span>last
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-19"></a><span class="nv">program</span><span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>firmware
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-20"></a><span class="nv">verify_image</span><span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>firmware
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-21"></a><span class="nv">wlink_reset_resume</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-22"></a><span class="nb">exit</span>
</span></code></pre></div>
<p>输出：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-1"></a>$<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>program.cfg
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0+dev-01623-gbfa3bc7f9<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-04-20-09:55<span class="o">)</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-6"></a>Info<span class="w"> </span>:<span class="w"> </span>only<span class="w"> </span>one<span class="w"> </span>transport<span class="w"> </span>option<span class="p">;</span><span class="w"> </span>autoselect<span class="w"> </span><span class="s1">&#39;jtag&#39;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-7"></a>Ready<span class="w"> </span><span class="k">for</span><span class="w"> </span>Remote<span class="w"> </span>Connections
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-8"></a>Info<span class="w"> </span>:<span class="w"> </span>WCH-Link<span class="w"> </span>version<span class="w"> </span><span class="m">2</span>.3
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-9"></a>Info<span class="w"> </span>:<span class="w"> </span>wlink_init<span class="w"> </span>ok
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-10"></a>Info<span class="w"> </span>:<span class="w"> </span>This<span class="w"> </span>adapter<span class="w"> </span>doesn<span class="err">&#39;</span>t<span class="w"> </span>support<span class="w"> </span>configurable<span class="w"> </span>speed
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-11"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-12"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-13"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-14"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-15"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">32</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x40901125
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-16"></a><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span>Target<span class="w"> </span>successfully<span class="w"> </span>examined.
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-17"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-18"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-19"></a>Info<span class="w"> </span>:<span class="w"> </span>device<span class="w"> </span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>REDACTED
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-20"></a>Info<span class="w"> </span>:<span class="w"> </span>flash<span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>256kbytes
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-21"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-22"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-23"></a>**<span class="w"> </span>Programming<span class="w"> </span>Started<span class="w"> </span>**
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-24"></a>**<span class="w"> </span>Programming<span class="w"> </span>Finished<span class="w"> </span>**
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-25"></a>Info<span class="w"> </span>:<span class="w"> </span>Verify<span class="w"> </span>Success
</span></code></pre></div>
<p>访问串口 <code>screen /dev/tty.usbmodem* 115200</code>，可以看到正确地输出了内容。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_4">转发</a></h3>
<p>本文已授权转发到以下的地址：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/wJ0X8qdIWRxavGo9N37QSg">公众号 物联网小生 试用沁恒 CH32V307 评估板</a></li>
<li><a href="https://www.yuque.com/zsafly/lfxyfc/zseeyx">语雀 硬件知识库 试用沁恒 CH32V307 评估板</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/04/19/wch-ch32v307-eval/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-10 00:00:00">2022年4月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="vivado-bitstream-svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/">导出 Vivado 下载 Bitstream 的 SVF 文件</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#_1">背景</a></h3>
<p>最近在研究如何实现一个远程 JTAG 的功能，目前实现在 <a href="https://github.com/jiegec/jtag-remote-server">jiegec/jtag-remote-server</a>，实现了简单的 XVC 协议，底层用的是 libftdi 的 MPSSE 协议来操作 JTAG。但是，在用 Vivado 尝试的时候，SysMon 可以正常使用，但是下载 Bitstream 会失败，所以要研究一下 Vivado 都做了什么（目前已经修好，是最后一个字节的部分位读取的处理问题）。</p>
<h3 id="svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#svf">SVF</a></h3>
<p>SVF 格式其实是一系列的 JTAG 上的操作。想到这个，也是因为在网上搜到了一个 <a href="https://www.asc.ohio-state.edu/physics/cms/firmwares/dcfeb_v45.svf">dcfeb_v45.svf</a>，里面描述的就是一段 JTAG 操作：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-1"></a>// Created using Xilinx Cse Software [ISE - 12.4]
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-2"></a>// Date: Mon May 09 11:00:32 2011
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-4"></a>TRST OFF;
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-5"></a>ENDIR IDLE;
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-6"></a>ENDDR IDLE;
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-7"></a>STATE RESET;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-8"></a>STATE IDLE;
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-9"></a>FREQUENCY 1E6 HZ;
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-10"></a>//Operation: Program -p 0 -dataWidth 16 -rs1 NONE -rs0 NONE -bpionly -e -loadfpga 
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-11"></a>TIR 0 ;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-12"></a>HIR 0 ;
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-13"></a>TDR 0 ;
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-14"></a>HDR 0 ;
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-15"></a>TIR 0 ;
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-16"></a>HIR 0 ;
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-17"></a>HDR 0 ;
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-18"></a>TDR 0 ;
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-19"></a>//Loading device with &#39;idcode&#39; instruction.
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-20"></a>SIR 10 TDI (03c9) SMASK (03ff) ;
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-21"></a>SDR 32 TDI (00000000) SMASK (ffffffff) TDO (f424a093) MASK (0fffffff) ;
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-22"></a>//Boundary Scan Chain Contents
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-23"></a>//Position 1: xc6vlx130t
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-24"></a>TIR 0 ;
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-25"></a>HIR 0 ;
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-26"></a>TDR 0 ;
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-27"></a>HDR 0 ;
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-28"></a>TIR 0 ;
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-29"></a>HIR 0 ;
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-30"></a>TDR 0 ;
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-31"></a>HDR 0 ;
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-32"></a>TIR 0 ;
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-33"></a>HIR 0 ;
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-34"></a>HDR 0 ;
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-35"></a>TDR 0 ;
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-36"></a>//Loading device with &#39;idcode&#39; instruction.
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-37"></a>SIR 10 TDI (03c9) ;
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-38"></a>SDR 32 TDI (00000000) TDO (f424a093) ;
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-39"></a>//Loading device with &#39;bypass&#39; instruction.
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-40"></a>SIR 10 TDI (03ff) ;
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-41"></a>//Loading device with &#39;idcode&#39; instruction.
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-42"></a>SIR 10 TDI (03c9) ;
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-43"></a>SDR 32 TDI (00000000) TDO (f424a093) ;
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-44"></a>// Loading device with a `jprogram` instruction. 
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-45"></a>SIR 10 TDI (03cb) ;
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-46"></a>// Loading device with a `isc_noop` instruction. 
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-47"></a>SIR 10 TDI (03d4) ;
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-48"></a>RUNTEST 100000 TCK;
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-49"></a>// Check init_complete in ircapture.
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-50"></a>//IR Capture using specified instruction.
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-51"></a>SIR 10 TDI (03d4) TDO (0010) MASK (0010) ;
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-52"></a>// Loading device with a `isc_enable` instruction. 
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-53"></a>SIR 10 TDI (03d0) ;
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-54"></a>SDR 5 TDI (00) SMASK (1f) ;
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-55"></a>RUNTEST 100 TCK;
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-56"></a>// Loading device with a `isc_program` instruction. 
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-57"></a>SIR 10 TDI (03d1) ;
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-58"></a>SDR 32 TDI (ffffffff) SMASK (ffffffff) ;
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-59"></a>SDR 32 TDI (ffffffff) ;
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-60"></a>SDR 32 TDI (ffffffff) ;
</span></code></pre></div>
<p>它的语法比较简单，大概就是 <code>SIR</code> 就是向 IR 输入，<code>SDR</code> 就是向 DR 输入，后面跟着的 TDO 和 MASK 表示对输出数据进行判断。比较核心的是下面这几步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-1"></a>SIR JPROGRAM
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-2"></a>SIR ISC_NOOP
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-3"></a>RUNTEST 10000 TCK
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-4"></a>SIR ISC_NOOP UNTIL ISC_DONE
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-5"></a>SIR ISC_ENABLE
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-6"></a>SIR ISC_PROGRAM
</span></code></pre></div>
<p>之后就是 bitstream 的内容了。</p>
<h4 id="openocd-svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#openocd-svf">OpenOCD 烧写 SVF</a></h4>
<p>有了 SVF 以后，就可以用其他的一些支持 SVF 语法的工具来烧写 FPGA，而不需要 Vivado。比如采用如下的 OpenOCD 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-1"></a><span class="c">## openocd config</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-2"></a><span class="c">## use ftdi channel 0</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-3"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">100000</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-4"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>ftdi
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-5"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>jtag
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-6"></a><span class="nv">ftdi_vid_pid</span><span class="w"> </span><span class="mh">0x0403</span><span class="w"> </span><span class="mh">0x6011</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-7"></a><span class="nv">ftdi_layout_init</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="mh">0x000b</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-8"></a><span class="nv">ftdi_tdo_sample_edge</span><span class="w"> </span>falling
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-9"></a><span class="nv">ftdi_channel</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-10"></a><span class="nv">reset_config</span><span class="w"> </span>none
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-12"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span>xcvu37p<span class="w"> </span>tap<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x14b79093</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-14"></a><span class="nv">init</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-16"></a><span class="nv">svf</span><span class="w"> </span><span class="o">-</span>tap<span class="w"> </span>xcvu37p.tap<span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>program.svf<span class="w"> </span>progress
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-17"></a>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-18"></a><span class="nb">exit</span>
</span></code></pre></div>
<h4 id="vivado-svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#vivado-svf">从 Vivado 中导出 SVF</a></h4>
<p>从文件头可以推测，这个功能是 Xilinx 官方提供的，一番搜索，果然找到了命令：<a href="https://blog.xjtag.com/2016/07/creating-svf-files-using-xilinx-vivado/">Creating SVF files using Xilinx Vivado</a></p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-3-1"></a><span class="nv">program_hw_devices</span><span class="w"> </span><span class="o">-</span>force<span class="w"> </span><span class="o">-</span>svf_file<span class="w"> </span><span class="k">{</span><span class="nv">program.svf</span><span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_hw_devices</span><span class="w"> </span>xxx<span class="k">]</span>
</span></code></pre></div>
<p>添加一个 <code>-svf_file</code> 参数后，就会生成一个 svf 文件。下面摘录一段：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-1"></a>// config/idcode
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-2"></a>SIR 18 TDI (009249) ;
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-3"></a>SDR 32 TDI (00000000) TDO (04b79093) MASK (0fffffff) ;
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-4"></a>// config/jprog
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-5"></a>STATE RESET;
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-6"></a>STATE IDLE;
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-7"></a>SIR 18 TDI (00b2cb) ;
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-8"></a>SIR 18 TDI (014514) ;
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-9"></a>// Modify the below delay for config_init operation (0.100000 sec typical, 0.100000 sec maximum)
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-10"></a>RUNTEST 0.100000 SEC;
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-11"></a>// config/jprog/poll
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-12"></a>RUNTEST 15000 TCK;
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-13"></a>SIR 18 TDI (014514) TDO (011000) MASK (031000) ;
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-14"></a>// config/slr
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-15"></a>SIR 18 TDI (005924) ;
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-16"></a>SDR 226633216 TDI (0000000400000004e00000008001000c00000004d00000008001000c0000000466aa99550000000400000004000000040000000400000004000000040000
</span></code></pre></div>
<p>结合 Xilinx 官网可以下载的 BSDL 文件，可以找到每个 IR 对应的是什么：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-1"></a>// config/idcode
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-2"></a>SIR 18 TDI (009249) ;
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-3"></a>SDR 32 TDI (00000000) TDO (04b79093) MASK (0fffffff) ;
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-4"></a>// BSDL:
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-5"></a>&quot;IDCODE           (001001001001001001),&quot; &amp; --   DEVICE_ID reg
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-6"></a>attribute IDCODE_REGISTER of XCVU37P_FSVH2892 : entity is
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-7"></a>        &quot;XXXX&quot; &amp;        -- version
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-8"></a>        &quot;0100101&quot; &amp;     -- family
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-9"></a>        &quot;101111001&quot; &amp;   -- array size
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-10"></a>        &quot;00001001001&quot; &amp; -- manufacturer
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-11"></a>        &quot;1&quot;;            -- required by 1149.1
</span></code></pre></div>
<p>这一段是检查 IDCODE 是否是目标 FPGA 型号。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-1"></a>// config/jprog
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-2"></a>STATE RESET;
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-3"></a>STATE IDLE;
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-4"></a>SIR 18 TDI (00b2cb) ;
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-5"></a>SIR 18 TDI (014514) ;
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-6"></a>// BSDL
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-7"></a>&quot;JPROGRAM         (001011001011001011),&quot; &amp; --   PRIVATE
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-8"></a>&quot;ISC_NOOP         (010100010100010100),&quot; &amp; --   PRIVATE, ISC_DEFAULT
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-9"></a>// Modify the below delay for config_init operation (0.100000 sec typical, 0.100000 sec maximum)
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-10"></a>RUNTEST 0.100000 SEC;
</span></code></pre></div>
<p>这一段发送了 JPROGRAM 和 ISC_NOOP 的 IR，然后进入 RUNTEST 状态一段时间。</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-1"></a>// config/jprog/poll
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-2"></a>RUNTEST 15000 TCK;
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-3"></a>SIR 18 TDI (014514) TDO (011000) MASK (031000) ;
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-4"></a>// BSDL
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-5"></a>&quot;ISC_NOOP         (010100010100010100),&quot; &amp; --   PRIVATE, ISC_DEFAULT
</span></code></pre></div>
这里再次设置 ISC_NOOP，检查了 TDO 中的数据，意义不明。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-1"></a>// config/slr
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-2"></a>SIR 18 TDI (005924) ;
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-3"></a>SDR 226633216 TDI (0000000400000004e00000008001000c00000004d00000008001000c0000000466aa99550000000400000004000000040000000400000004000000040000
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-4"></a>// BSDL
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-5"></a>&quot;CFG_IN_SLR0      (000101100100100100),&quot; &amp; --   PRIVATE
</span></code></pre></div>
<p>从这里就是开始往里面写入 bitstream，可以看到熟悉的 66aa9955 的同步字符，对比 Bitstream 文件内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-1"></a>000000c0: ffff ffff ffff ffff aa99 5566 2000 0000  ..........Uf ...
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-2"></a>000000d0: 2000 0000 3002 2001 0000 0000 3002 0001   ...0. .....0...
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-3"></a>000000e0: 0000 0000 3000 8001 0000 0000 2000 0000  ....0....... ...
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-4"></a>000000f0: 3000 8001 0000 0007 2000 0000 2000 0000  0....... ... ...
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-5"></a>00000100: 3000 2001 0000 0000 3002 6001 0000 0000  0. .....0.`.....
</span></code></pre></div>
<p>可以发现是每 32 字节按位颠倒：<code>aa995566(10101010 10011001 01010101 01100110) -&gt; 66aa9955(01100110 10101010 10011001 01010101)</code>，后面的 <code>20000000 -&gt; 00000004</code> 也是类似的。</p>
<p>Xilinx UG570 的 Table 6-5 也印证了上面的过程：</p>
<ul>
<li>Start loading the JPROGRAM instruction, LSB first:</li>
<li>Load the MSB of the JPROGRAM instruction when exiting SHIFT-IR, as defined in the IEEE standard.</li>
<li>Start loading the CFG_IN instruction, LSB first:</li>
<li>Load the MSB of the CFG_IN instruction when exiting SHIFT-IR.</li>
<li>Shift in the FPGA bitstream. Bit n (MSB) is the first bit in the bitstream.(3)(4)</li>
<li>Shift in the last bit of the bitstream. Bit 0 (LSB) shifts on the transition to EXIT1-DR.</li>
</ul>
<p>完成 CFG_IN 之后，再进行 JSTART:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-1"></a>// config/start
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-2"></a>STATE IDLE;
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-3"></a>RUNTEST 100000 TCK;
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-4"></a>SIR 18 TDI (00c30c) ;
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-5"></a>HIR 0 ;
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-6"></a>TIR 0 ;
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-7"></a>HDR 0 ;
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-8"></a>TDR 0 ;
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-9"></a>STATE IDLE;
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-10"></a>RUNTEST 2000 TCK;
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-11"></a>SIR 18 TDI (009249) TDO (031000) MASK (011000) ;
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-12"></a>HIR 0 ;
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-13"></a>TIR 0 ;
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-14"></a>HDR 0 ;
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-15"></a>TDR 0 ;
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-16"></a>// BSDL
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-17"></a>&quot;JSTART           (001100001100001100),&quot; &amp; --   PRIVATE
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-18"></a>&quot;IDCODE           (001001001001001001),&quot; &amp; --   DEVICE_ID reg
</span></code></pre></div>
<p>然后再次进行 CFG_IN_SLR0, CFG_OUT_SLR0，验证是否真的写进去了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-1"></a>// config/status
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-2"></a>STATE RESET;
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-3"></a>RUNTEST 5 TCK;
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-4"></a>SIR 18 TDI (005924) ;
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-5"></a>SDR 160 TDI (0000000400000004800700140000000466aa9955) ;
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-6"></a>SIR 18 TDI (004924) ;
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-7"></a>SDR 32 TDI (00000000) TDO (3f5e0d40) MASK (08000000) ;
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-8"></a>STATE RESET;
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-9"></a>RUNTEST 5 TCK;
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-10"></a>// BSDL
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-11"></a>&quot;CFG_IN_SLR0      (000101100100100100),&quot; &amp; --   PRIVATE
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-12"></a>&quot;CFG_OUT_SLR0     (000100100100100100),&quot; &amp; --   PRIVATE
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-13"></a>// config/status
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-14"></a>STATE RESET;
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-15"></a>RUNTEST 5 TCK;
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-16"></a>SIR 18 TDI (005924) ;
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-17"></a>SDR 160 TDI (0000000400000004800700140000000466aa9955) ;
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-18"></a>SIR 18 TDI (004924) ;
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-19"></a>SDR 32 TDI (00000000) TDO (3f5e0d40) MASK (08000000) ;
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-20"></a>STATE RESET;
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-21"></a>RUNTEST 5 TCK;
</span></code></pre></div>
<p>这段操作是进行 Status Register Readback，见 UG570 的 Table 10-4。MASK 设为 <code>08000000</code> 应该是判断它的第 4 位：END_OF_STARTUP_STATUS（Table 9-25）。</p>
<p>如果是 Quartus 用户，也可以 <a href="https://www.intel.com/content/www/us/en/support/programmable/articles/000085709.html">生成 SVF</a>，具体操作是：在 Programmer 中，点击 <code>File-&gt;Create JAM, JBC, SVF or ISC file</code>，然后在弹出的窗口中选择 svf 格式，导出即可。得到的 svf 文件一样可以用 openocd 来下载。</p>
<p>也可以<a href="https://www.intel.com/content/www/us/en/support/programmable/articles/000074062.html">用 <code>quartus_cpf</code> 在命令行</a>中进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-12-1"></a>quartus_cpf<span class="w"> </span>-q<span class="w"> </span>18MHz<span class="w"> </span>-g<span class="w"> </span><span class="m">3</span>.3<span class="w"> </span>-c<span class="w"> </span>-n<span class="w"> </span>p<span class="w"> </span>input.sof/pof<span class="w"> </span>output.svf
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-31 00:00:00">2022年3月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 21 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cpu"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/">浅谈乱序执行 CPU（二）</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/ooo_cpu.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_1">背景</a></h3>
<p>之前写过一个<a href="../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU</a>，随着学习的深入，内容越来越多，页面太长，因此把后面的一部分内容独立出来，变成了这篇博客文章。之后也许会有（三）（四）等等。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_2">内存访问</a></h3>
<p>内存访问是一个比较复杂的操作，它涉及到缓存、页表、内存序等问题。在乱序执行中，要尽量优化内存访问对其他指令的延迟的影响，同时也要保证正确性。这里参考的是 <a href="https://docs.boom-core.org/en/latest/sections/load-store-unit.html">BOOM 的 LSU 设计</a>。</p>
<p>首先是正确性。一般来说可以认为，Load 是没有副作用的（实际上，Load 会导致 Cache 加载数据，这也引发了以 Meltdown 为首的一系列漏洞），因此可以很激进地预测执行 Load。但是，Store 是有副作用的，写出去的数据就没法还原了。因此，Store 指令只有在 ROB Head 被 Commit 的时候，才会写入到 Cache 中。</p>
<p>其次是性能，我们希望 Load 指令可以尽快地完成，这样可以使得后续的计算指令可以尽快地开始进行。当 Load 指令的地址已经计算好的时候，就可以去取数据，这时候，首先要去 Store Queue 里面找，如果有 Store 指令要写入的地址等于 Load 的地址，说明后面的 Load 依赖于前面的 Store，如果 Store 的数据已经准备好了，就可以直接把数据转发过来，就不需要从 Cache 中获取，如果数据还没准备好，就需要等待这一条 Store 完成；如果没有找到匹配的 Store 指令，再从内存中取。不过，有一种情况就是，当 Store 指令的地址迟迟没有计算出来，而后面的 Load 已经提前从 Cache 中获取数据了，这时候就会出现错误，所以当 Store 计算出地址的时候，需要检查后面的 Load 指令是否出现地址重合，如果出现了，就要把这条 Load 以及依赖这条 Load 指令的其余指令重新执行。<a href="http://ieeexplore.ieee.org/abstract/document/7029183/">POWER8 处理器微架构论文</a>中对此也有类似的表述：</p>
<div class="language-text highlight"><pre><span></span><code>The POWER8 IFU also implements mechanisms to mitigate performance
degradation associated with pipeline hazards. A Store-Hit-Load (SHL) is
an out-of-order pipeline hazard condition, where an older store executes
after a younger overlapping load, thus signaling that the load received
stale data. The POWER8 IFU has logic to detect when this condition
exists and provide control to avoid the hazard by flushing the load
instruction which received stale data (and any following instructions).
When a load is flushed due to detection of a SHL, the fetch address of
the load is saved and the load is marked on subsequent fetches allowing
the downstream logic to prevent the hazard. When a marked load
instruction is observed, the downstream logic introduces an explicit
register dependency for the load to ensure that it is issued after the
store operation.
</code></pre></div>
<p>下面再详细讨论一下 LSU 的设计。</p>
<h3 id="load-store-unit"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#load-store-unit">Load Store Unit</a></h3>
<p>LSU 是很重要的一个执行单元，负责 Load/Store/Atomic 等指令的实现。最简单的实现方法是按顺序执行，但由于 pipeline 会被清空，Store/Atomic/Uncached Load 这类有副作用（当然了，如果考虑 Meltdown 类攻击的话，Cached Load 也有副作用，这里就忽略了），需要等到 commit 的时候再执行。这样 LSU 很容易成为瓶颈，特别是在访存指令比较多的时候。</p>
<p>为了解决这个问题，很重要的是让读写也乱序起来，具体怎么乱序，受到实现的影响和 Memory Order/Program Order 的要求。从性能的角度上来看，我们肯定希望 Load 可以尽快执行，因为可能有很多指令在等待 Load 的结果。那么，需要提前执行 Load，但是怎么保证正确性呢？在 Load 更早的时候，可能还有若干个 Store 指令尚未执行，一个思路是等待所有的 Store 执行完毕，但是这样性能不好；另一个思路是用地址来搜索 Store 指令，看看是否出现对同一个地址的 Store 和 Load，如果有，直接转发数据，就不需要从 Cache 获取了，不过这种方法相当于做了一个全相连的 Buffer，面积大，延迟高，不好扩展等问题接踵而至。</p>
<p>为了解决 Store Queue 需要相连搜索的问题，<a href="https://repository.upenn.edu/cgi/viewcontent.cgi?article=1001&amp;context=cis_reports">A high-bandwidth load-store unit for single-and multi-threaded processors</a> 的解决思路是，把 Store 指令分为两类，一类是需要转发的，一类是不需要的，那么可以设计一个小的相连存储器，只保存这些需要转发的 Store 指令；同时还有一个比较大的，保存所有 Store 指令的队列，因为不需要相连搜索，所以可以做的比较大。</p>
<p>仔细想想，这里还有一个问题：Load 在执行前，更早的 Store 的地址可能还没有就绪，这时候去搜索 Store Queue 得到的结果可能是错的，这时候要么等待所有的 Store 地址都就绪，要么就先执行，再用一些机制来修复这个问题，显然后者 IPC 要更好。</p>
<p>修复 Load Store 指令相关性问题，一个方法是当一个 Store 提交的时候，检查是否有地址冲突的 Load 指令（那么 Load Queue 也要做成相连搜索的），是否转发了错误的 Store 数据，这也是 <a href="https://docs.boom-core.org/en/latest/sections/load-store-unit.html#memory-ordering-failures">Boom LSU</a> 采用的方法。另一个办法是 Commit 的时候（或者按顺序）重新执行 Load 指令，如果 Load 结果和之前不同，要把后面依赖的刷新掉，这种方式的缺点是每条 Load 指令都要至少访问两次 Cache。<a href="https://repository.upenn.edu/cgi/viewcontent.cgi?article=1228&amp;context=cis_papers">Store Vulnerability Window (SVW): Re-Execution Filtering for Enhanced Load Optimization</a> 属于重新执行 Load 指令的方法，通过 Bloom filter 来减少一些没有必要重复执行的 Load。还有一种办法，就是预测 Load 指令和哪一条 Store 指令有依赖关系，然后直接去访问那一项，如果不匹配，就认为没有依赖。<a href="https://ieeexplore.ieee.org/document/1540957">Scalable Store-Load Forwarding via Store Queue Index Prediction</a> 把 Load 指令分为三类，一类是不确定依赖哪条 Store 指令（Difficult Loads），一类是基本确定依赖哪一条 Store 指令，一类是不依赖 Store 指令。这个有点像 Cache 里面的 Way Prediction 机制。</p>
<p>分析完了上述一些优化方法，我们也来看一些 CPU 设计采用了哪种方案。首先来分析一下 <a href="https://ieeexplore.ieee.org/abstract/document/7029183">IBM POWER8</a> 的 LSU，首先，可以看到它设计了比较多项目的 virtual STAG/LTAG，然后再转换成比较少项目的 physical STAG/LTAG，这样 LSQ 可以做的比较小，原文：</p>
<div class="language-text highlight"><pre><span></span><code>A virtual STAG/LTAG scheme is used to minimize dispatch holds due to
running out of physical SRQ/LRQ entries. When a physical entry in the
LRQ is freed up, a virtual LTAG will be converted to a real LTAG. When a
physical entry in the SRQ is freed up, a virtual STAG will be converted
to a real STAG. Virtual STAG/LTAGs are not issued to the LSU until they
are subsequently marked as being real in the UniQueue. The ISU can
assign up to 128 virtual LTAGs and 128 virtual STAGs to each thread.
</code></pre></div>
<p>这个思路在 2007 年的论文 <a href="https://people.csail.mit.edu/emer/papers/2007.06.isca.late_binding.pdf">Late-Binding: Enabling Unordered Load-Store Queues</a> 里也可以看到，也许 POWER8 参考了这篇论文的设计。可以看到，POWER8 没有采用那些免除 CAM 的方案：</p>
<div class="language-text highlight"><pre><span></span><code>The SRQ is a 40-entry, real address based CAM structure. Similar to the
SRQ, the LRQ is a 44-entry, real address based, CAM structure. The LRQ
keeps track of out-of-order loads, watching for hazards. Hazards
generally exist when a younger load instruction executes out-of-order
before an older load or store instruction to the same address (in part
or in whole). When such a hazard is detected, the LRQ initiates a flush
of the younger load instruction and all its subsequent instructions from
the thread, without impacting the instructions from other threads. The
load is then re-fetched from the I-cache and re-executed, ensuring
proper load/store ordering.
</code></pre></div>
<p>而是在传统的两个 CAM 设计的基础上，做了减少物理 LSQ 项目的优化。比较有意思的是，POWER7 和 POWER8 的 L1 Cache 都是 8 路组相连，并且采用了 set-prediction 的方式（应该是通常说的 way-prediction）。</p>
<p>此外还有一个实现上的小细节，就是在判断 Load 和 Store 指令是否有相关性的时候，由于地址位数比较多，完整比较的延迟比较大，可以牺牲精度的前提下，选取地址的一部分进行比较。<a href="https://ieeexplore.ieee.org/document/8409955">POWER9 论文</a> 提到了这一点：</p>
<div class="language-text highlight"><pre><span></span><code>POWER8 and prior designs matched the effective address (EA) bits 48:63
between the younger load and the older store queue entry. In POWER9,
through a combination of outright matches for EA bits 32:63 and hashed
EA matches for bits 0:31, false positive avoidance is greatly improved.
This reduces the number of flushes, which are compulsory for false
positives.
</code></pre></div>
<p>这里又是一个精确度和时序上的一个 tradeoff。</p>
<p>具体到 Load/Store Queue 的大小，其实都不大：</p>
<ol>
<li><a href="https://ieeexplore.ieee.org/document/9000513">Zen 2</a> Store Queue 48</li>
<li><a href="https://en.wikichip.org/wiki/intel/microarchitectures/skylake_(client)#Memory_subsystem">Intel Skylake</a> Store Buffer 56 Load Buffer 72</li>
<li><a href="https://ieeexplore.ieee.org/document/7029183?arnumber=7029183">POWER 8</a> Store Queue 40 Load Queue 44 (Virtual 128+128)</li>
<li><a href="http://ieeexplore.ieee.org/document/755465/">Alpha 21264</a> Store Queue 32 Load Queue 32</li>
</ol>
<h3 id="vs"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#vs">精确异常 vs 非精确异常</a></h3>
<p>精确异常是指发生异常的指令之前的指令都完成，之后的没有执行。一般来说，实现方式是完成异常指令之前的所有指令，并撤销异常指令之后的指令的作用。非精确异常则是不保证这个性质，<a href="http://bwrcs.eecs.berkeley.edu/Classes/cs152/lectures/lec12-exceptions.pdf">网上资料</a> 说，这种情况下硬件实现更简单，但是软件上处理比较困难。</p>
<p>一个非精确异常的例子是 <a href="https://courses.cs.washington.edu/courses/cse548/99wi/other/alphahb2.pdf">Alpha</a>，在章节 4.7.6.1 中提到，一些浮点计算异常可能是非精确的，并且说了一句：<code>In general, it is not feasible to fix up the result value or to continue from the trap.</code>。同时给出了一些条件，只有当指令序列满足这些条件的时候，异常才是可以恢复的。还有一段描述，摘录在这里：</p>
<div class="language-text highlight"><pre><span></span><code>Alpha lets the software implementor determine the precision of
arithmetic traps.  With the Alpha architecture, arithmetic traps (such
as overflow and underflow) are imprecise—they can be delivered an
arbitrary number of instructions after the instruction that triggered
the trap. Also, traps from many different instructions can be reported
at once. That makes implementations that use pipelining and multiple
issue substantially easier to build.  However, if precise arithmetic
exceptions are desired, trap barrier instructions can be explicitly
inserted in the program to force traps to be delivered at specific
points.
</code></pre></div>
<p>具体来说，在 <a href="http://www.bitsavers.org/pdf/dec/alpha/Sites_AlphaAXPArchitectureReferenceManual_2ed_1995.pdf">Reference Manual</a> 中第 5.4.1 章节，可以看到当触发 Arithmetic Trap 的时候，会进入 Kernel 的 entArith 函数，并提供参数：a0 表示 exception summary，a1 表示 register write mask。exception summary 可以用来判断发生了什么类型的 exception，比如 integer overflow，inexact result 等等。一个比较特别的 exception 类型是 software completion。第二个参数表示的是触发异常的指令（一个或多个）会写入哪些寄存器（64 位，低 32 位对应整数寄存器，高 32 位对应浮点寄存器），然后保存下来的 PC 值为最后一条执行的指令的下一个地址，从触发异常的第一条指令到最后一条指令就是 trap shadow，这部分指令可能执行了一部分，没有执行一部分，一部分执行结果是错误的。</p>
<p>Linux 处理代码在 <code>arch/alpha/kernel/traps.c</code> 的 <code>do_entArith</code> 函数中。首先判断，如果是 software completion，那就要进行处理；否则直接 SIGFPE 让程序自己处理或者退出。如果是精确异常，那就对 PC-4 进行浮点模拟；如果是非精确异常，就从 trap shadow 的最后一条指令开始往前搜索，并同时记录遇到的指令写入的寄存器，如果发现指令的写入的寄存器已经覆盖了 register write mask，就说明找到了 trap shadow 的开头，则模拟这条指令，然后从下一条开始重新执行。具体代码如下：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-1"></a><span class="kt">long</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-2"></a><span class="nf">alpha_fp_emul_imprecise</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">write_mask</span><span class="p">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-3"></a><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-4"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">trigger_pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-5"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">insn</span><span class="p">,</span><span class="w"> </span><span class="n">opcode</span><span class="p">,</span><span class="w"> </span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">si_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-7"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-8"></a><span class="cm">     * Turn off the bits corresponding to registers that are the</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-9"></a><span class="cm">     * target of instructions that set bits in the exception</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-10"></a><span class="cm">     * summary register.  We have some slack doing this because a</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-11"></a><span class="cm">     * register that is the target of a trapping instruction can</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-12"></a><span class="cm">     * be written at most once in the trap shadow.</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-13"></a><span class="cm">     *</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-14"></a><span class="cm">     * Branches, jumps, TRAPBs, EXCBs and calls to PALcode all</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-15"></a><span class="cm">     * bound the trap shadow, so we need not look any further than</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-16"></a><span class="cm">     * up to the first occurrence of such an instruction.</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-17"></a><span class="cm">     */</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-18"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">write_mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-19"></a><span class="w">        </span><span class="n">get_user</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">trigger_pc</span><span class="p">));</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-20"></a><span class="w">        </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insn</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-21"></a><span class="w">        </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insn</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-22"></a>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-23"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-24"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_PAL</span><span class="p">:</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-25"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_JSR</span><span class="p">:</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-26"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="mh">0x30</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">:</span><span class="w">   </span><span class="cm">/* branches */</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-27"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">egress</span><span class="p">;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-28"></a>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-29"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_MISC</span><span class="p">:</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-30"></a><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">insn</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-31"></a><span class="w">                  </span><span class="k">case</span><span class="w"> </span><span class="no">MISC_TRAPB</span><span class="p">:</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-32"></a><span class="w">                  </span><span class="k">case</span><span class="w"> </span><span class="no">MISC_EXCB</span><span class="p">:</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-33"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">egress</span><span class="p">;</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-35"></a><span class="w">                  </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-36"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-37"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-38"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-39"></a>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-40"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTA</span><span class="p">:</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-41"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTL</span><span class="p">:</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-42"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTS</span><span class="p">:</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-43"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTM</span><span class="p">:</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-44"></a><span class="w">            </span><span class="n">write_mask</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rc</span><span class="p">);</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-45"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-46"></a>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-47"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTC</span><span class="p">:</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-48"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTV</span><span class="p">:</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-49"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTI</span><span class="p">:</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-50"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTL</span><span class="p">:</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-51"></a><span class="w">            </span><span class="n">write_mask</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span><span class="p">));</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-52"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-53"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">write_mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-55"></a><span class="w">            </span><span class="cm">/* Re-execute insns in the trap-shadow.  */</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-56"></a><span class="w">            </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trigger_pc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-57"></a><span class="w">            </span><span class="n">si_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha_fp_emul</span><span class="p">(</span><span class="n">trigger_pc</span><span class="p">);</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-58"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">egress</span><span class="p">;</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-59"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-60"></a><span class="w">        </span><span class="n">trigger_pc</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-61"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-62"></a>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-63"></a><span class="nl">egress</span><span class="p">:</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-64"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">si_code</span><span class="p">;</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-65"></a><span class="p">}</span>
</span></code></pre></div>
<p>ARM 架构也有 imprecise asynchronous external abort：</p>
<div class="language-text highlight"><pre><span></span><code>Normally, external aborts are rare. An imprecise asynchronous external
abort is likely to be fatal to the process that is running. An example
of an event that might cause an external abort is an uncorrectable
parity or ECC failure on a Level 2 Memory structure.

Because imprecise asynchronous external aborts are normally fatal to the
process that caused them, ARM recommends that implementations make
external aborts precise wherever possible.
</code></pre></div>
<p>不过这更多是因为内存的无法预知的错误，这种时候机器直接可以拿去维修了。</p>
<p><a href="https://community.arm.com/developer/ip-products/processors/f/cortex-a-forum/5056/can-anyone-provide-an-example-of-asynchronous-exceptions">文章</a> 提到了两个 precise/imprecise async/sync的例子：</p>
<ol>
<li>外部中断是异步的，同时也是 precise 的。</li>
<li>对于一个 Write-allocate 的缓存，如果程序写入一个不存在的物理地址，那么写入缓存的时候不会出现错误，但当这个 cache line 被写入到总线上的时候，就会触发异常，这个异常是异步并且非精确的，因为之前触发这个异常的指令可能已经完成很久了。这种时候这个进程也大概率没救了，直接 SIGBUS 退出。</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_3">处理器前端</a></h3>
<p>再来分析一下乱序执行 CPU 的前端部分。以 RISC-V 为例，指令长度有 4 字节或者 2 字节两种，其中 2 字节属于压缩指令集。如何正确并高效地进行取指令译码？</p>
<p>首先，我们希望前端能够尽可能快地取指令，前端的取指能力要和后端匹配，比如对于一个四发射的 CPU，前端对应地需要一个周期取 <code>4*4=16</code> 字节的指令。但是，这 16 字节可能是 4 条非压缩指令，也可能是 8 条压缩指令，也可能是混合的情况。所以，这里会出现一个可能出现指令条数不匹配的情况，所以中间可以添加一个 Fetch Buffer，比如 <a href="https://github.com/riscv-boom/riscv-boom">BOOM</a> 的实现中，L1 ICache 每周期读取 16 字节，然后进行预译码，出来 8 条指令，保存到 Fetch Buffer 中。这里需要考虑以下几点：首先从 ICache 读取的数据是对齐的，但是 PC 可能不是，比如中间的地址。其次，可能一个 4 字节的非压缩指令跨越了两次 Fetch，比如前 2 个字节在前一个 Fetch Bundle，后 2 个字节在后一个 Fetch Bundle；此外，每个 2 字节的边界都需要判断一下是压缩指令还是非压缩指令。一个非常特殊的情况就是，一个 4 字节的指令跨越了两个页，所以两个页都需要查询页表；如果恰好在第二个页处发生了页缺失，此时 epc 是指令的起始地址，但 tval 是第二个页的地址，这样内核才知道是哪个页发生了缺失。</p>
<p>其次，需要配合分支预测。如果需要保证分支预测正确的情况下，能够在循环中达到接近 100% 的性能，那么，在 Fetch 分支结尾的分支指令的同时，需要保证下一次 Fetch 已经得到了分支预测的目的地址。这个就是 BOOM 里面的 L0 BTB (1-cycle redirect)。但是，一个周期内完成的分支预测，它的面积肯定不能大，否则时序无法满足，所以 BOOM 里面还设计了 2-cycle 和 3-cycle 的比较高级的分支预测器，还有针对函数调用的 RAS（Return Address Stack）。</p>
<p>分支预测也有很多方法。比较简单的方法是实现一个 BHT，每个项是一个 2 位的饱和计数器，超过一半的时候增加，少于一半时减少。但是，如果遇到了跳转/不跳转/跳转/不跳转这种来回切换的情况，准确率就很低。一个复杂一些的设计，就是用 BHR，记录这个分支指令最近几次的历史，对于每种可能的历史，都对应一个 2 位的饱和计数器。这样，遇到刚才所说的情况就会很好地预测。但实践中会遇到问题：如果在写回之前，又进行了一次预测，因为预测是在取指的时候做的，但是更新 BPU 是在写回的时候完成的，这时候预测就是基于旧的状态进行预测，这时候 BHR 就会出现不准确的问题；而且写回 BPU 的时候，会按照原来的状态进行更新，这个状态可能也是错误的，导致丢失一次更新，识别的模式从跳转/不跳转/跳转/不跳转变成了跳转/跳转/跳转/不跳转，这样又会预测错误。一个解决办法是，在取指阶段，BPU 预测完就立即按照预测的结果更新 BHR，之后写回阶段会恢复到实际的 BHR 取值。论文 <a href="https://dl.acm.org/doi/10.1145/192724.192756">The effect of speculatively updating branch history on branch prediction accuracy, revisited</a> 和 <a href="https://jilp.org/vol2/v2paper1.pdf">Speculative Updates of Local and Global Branch History: A Quantitative Analysis</a> 讨论了这个实现方式对性能的影响。</p>
<p>比较容易做预测更新和恢复的是全局分支历史，可以维护两个 GHR（Global History Register），一个是目前取指令最新的，一个是提交的最新的。在预测的时候，用 GHR 去找对应的 2-bit 状态，然后把预测结果更新到 GHR 上。在预测失败的时候，把 GHR 恢复为提交的状态。如果要支持一个 Fetch Packet 中有多个分支，可以让 GHR 对应若干个 2-bit 状态，分别对应相应位置上的分支的状态，当然这样面积也会增加很多。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_4">处理器/内存仿真模型</a></h3>
<p>最后列举一下科研里常用的一些处理器/内存仿真模型：</p>
<ul>
<li>gem5: <a href="https://arxiv.org/abs/2007.03152">论文 The gem5 Simulator: Version 20.0+</a> <a href="https://gem5.googlesource.com/public/gem5">代码</a></li>
<li>DRAMSim2: <a href="https://user.eng.umd.edu/~blj/papers/cal10-1.pdf">论文 DRAMSim2: A Cycle Accurate Memory System Simulator</a> <a href="https://github.com/umd-memsys/DRAMSim2">代码</a></li>
<li>DRAMsim3: <a href="https://ieeexplore.ieee.org/document/8999595">论文 DRAMsim3: A Cycle-Accurate, Thermal-Capable DRAM Simulator</a> <a href="https://github.com/umd-memsys/DRAMsim3">代码</a></li>
<li>DRAMSys4.0：<a href="https://link.springer.com/chapter/10.1007/978-3-030-60939-9_8">论文 DRAMSys4.0: A Fast and Cycle-Accurate SystemC/TLM-Based DRAM Simulator</a> <a href="https://github.com/tukl-msd/DRAMSys">代码</a></li>
<li>CACTI: <a href="https://www.hpl.hp.com/research/cacti/cacti2.pdf">论文 CACTI 2.0: An Integrated Cache Timing and Power Model</a> <a href="https://github.com/HewlettPackard/cacti">代码</a></li>
<li>McPAT: <a href="https://ieeexplore.ieee.org/document/5375438">论文 McPAT: An integrated power, area, and timing modeling framework for multicore and manycore architectures</a> <a href="https://github.com/HewlettPackard/mcpat">代码</a></li>
<li>Multi2Sim: <a href="https://ieeexplore.ieee.org/document/7842946">论文 Multi2Sim: A simulation framework for CPU-GPU computing</a> <a href="https://github.com/Multi2Sim/multi2sim">代码</a></li>
<li>Ramulator: <a href="https://users.ece.cmu.edu/~omutlu/pub/ramulator_dram_simulator-ieee-cal15.pdf">论文 Ramulator: A Fast and Extensible DRAM Simulator</a> <a href="https://github.com/CMU-SAFARI/ramulator">代码</a></li>
<li>Scarab: <a href="https://github.com/hpsresearchgroup/scarab">代码</a></li>
<li>Sniper: <a href="https://dl.acm.org/doi/abs/10.1145/2063384.2063454">论文 Sniper: exploring the level of abstraction for scalable and accurate parallel multi-core simulation</a> <a href="https://snipersim.org/w/The_Sniper_Multi-Core_Simulator">官网</a> <a href="https://github.com/snipersim/snipersim">仓库</a></li>
<li>ZSim: <a href="https://people.csail.mit.edu/sanchez/papers/2013.zsim.isca.pdf">论文 ZSim: fast and accurate microarchitectural simulation of thousand-core systems</a> <a href="https://github.com/s5z/zsim">代码</a></li>
<li>PTLsim: <a href="https://ieeexplore.ieee.org/document/4211019">论文 PTLsim: A Cycle Accurate Full System x86-64 Microarchitectural Simulator</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/03/31/brief-into-ooo-2/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-30 00:00:00">2022年3月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sv2vyosys-fpnew-verilog"><a class="toclink" href="../../hardware/2022/03/30/sv2v-fpnew/">用 sv2v+yosys 把 fpnew 转为 verilog 网表</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/30/sv2v-fpnew/#_1">背景</a></h3>
<p>FPnew 是一个比较好用的浮点计算单元，但它是 SystemVerilog 编写的，并且用了很多高级特性，虽然闭源软件是支持的，但是开源拖拉机经常会遇到这样那样的问题。所以一直想用 sv2v 把它翻译成 Verilog，但此时的 Verilog 还有很多复杂的结构，再用 yosys 转换为一个通用可综合的网表。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/30/sv2v-fpnew/#_2">步骤</a></h3>
<p>经过一系列踩坑，一个很重要的点是要用最新的 sv2v(v0.0.9-24-gf868f06) 和 yosys(0.15+70)。Debian 打包的 yosys 版本比较老，不能满足需求。</p>
<p>首先，用 verilator 进行预处理，把一堆 sv 文件合成一个：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-0-1"></a>$<span class="w"> </span>cat<span class="w"> </span>a.sv<span class="w"> </span>b.sv<span class="w"> </span>c.sv<span class="w"> </span>&gt;<span class="w"> </span>test.sv
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-0-2"></a>$<span class="w"> </span>verilator<span class="w"> </span>-E<span class="w"> </span>test.sv<span class="w"> </span>&gt;<span class="w"> </span>merged.sv
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-0-3"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/^`line/d&#39;</span><span class="w"> </span>merged.sv
</span></code></pre></div>
<p>注意这里用 sed 去掉了无用的行号信息。然后，用 sv2v 进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-1-1"></a>$<span class="w"> </span>sv2v<span class="w"> </span>merged.sv<span class="w"> </span>&gt;<span class="w"> </span>merge.v
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-1-2"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/\$$fatal/d&#39;</span><span class="w"> </span>merge.v
</span></code></pre></div>
<p>这里又用 sed 把不支持的 $fatal 去掉。最后，用 yosys 进行处理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-2-1"></a>$<span class="w"> </span>yosys<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;read_verilog -defer merge.v&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;hierarchy -p fpnew_top&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;proc&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;opt&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;write_verilog -noattr output.v&#39;</span>
</span></code></pre></div>
<p>注意这里要用 <code>read_verilog -defer</code>，否则 yosys 会遇到 TAG_WIDTH=0 默认参数就直接例化，然后就出现 <code>[0:-1]</code> 这样的下标。<code>read_verilog</code> 的文档告诉了我们可以分两步做：</p>
<div class="language-text highlight"><pre><span></span><code>-defer
    only read the abstract syntax tree and defer actual compilation
    to a later &#39;hierarchy&#39; command. Useful in cases where the default
    parameters of modules yield invalid or not synthesizable code.
</code></pre></div>
<p>这样就得到了简化后的 verilog 代码：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-1"></a><span class="k">module</span><span class="w"> </span><span class="n">\$paramod$011e4d7ee08c34f246a38322dc9967d23ecc8081\fpnew_opgroup_block_A94B6_B7406</span><span class="w"> </span><span class="p">(</span><span class="n">clk_i</span><span class="p">,</span><span class="w"> </span><span class="n">rst_ni</span><span class="p">,</span><span class="w"> </span><span class="n">operands_i</span><span class="p">,</span><span class="w"> </span><span class="n">is_boxed_i</span><span class="p">,</span><span class="w"> </span><span class="n">rnd_mode_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_mod_i</span><span class="p">,</span><span class="w"> </span><span class="n">src_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">int_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">vectorial_op_i</span><span class="p">,</span><span class="w"> </span><span class="n">tag_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_valid_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_ready_o</span><span class="p">,</span><span class="w"> </span><span class="n">flush_i</span><span class="p">,</span><span class="w"> </span><span class="n">result_o</span><span class="p">,</span><span class="w"> </span><span class="n">status_o</span><span class="p">,</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">,</span><span class="w"> </span><span class="n">tag_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_valid_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_ready_i</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-2"></a><span class="p">,</span><span class="w"> </span><span class="n">busy_o</span><span class="p">);</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-3"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_0_</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-4"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_1_</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-5"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">71</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">arbiter_output</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-6"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-7"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-8"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-9"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-10"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-11"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-12"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-13"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-14"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">flush_i</span><span class="p">;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-15"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-16"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>这样虽然比较丑陋，但是解决了 SystemVerilog 的问题。诚然，这样也失去了修改参数的能力，因为参数已经在 yosys 综合途中确定下来了。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2022/03/30/sv2v-fpnew/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-14 00:00:00">2022年3月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="synopsys-design-compiler"><a class="toclink" href="../../hardware/2022/03/14/design-compiler-synthesis/">Synopsys Design Compiler 综合实践</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/14/design-compiler-synthesis/#_1">工艺库</a></h3>
<p>综合很重要的一步是把 HDL 的逻辑变成一个个单元，这些单元加上连接方式就成为了网表。那么，基本单元有哪些，怎么决定用哪些基本单元？</p>
<p>这个就需要工艺库了，工艺库定义了一个个单元，单元的引脚、功能，还有各种参数，这样 Design Compiler 就可以按照这些信息去找到一个优化的网表。</p>
<h4 id="liberty"><a class="toclink" href="../../hardware/2022/03/14/design-compiler-synthesis/#liberty">Liberty 格式</a></h4>
<p>网上可以找到一些 Liberty 格式的工艺库，比如 <a href="https://raw.githubusercontent.com/The-OpenROAD-Project/OpenROAD-flow-scripts/master/flow/platforms/nangate45/lib/NangateOpenCellLibrary_typical.lib">Nangate45</a>，它的设定是 25 摄氏度，1.10 伏，属于 TT（Typical/Typical）的 Process Corner。</p>
<p>在里面可以看到一些基本单元的定理，比如 <code>AND2_X1</code>，就是一个 drive strength 是 1 的二输入与门：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-1"></a>cell (AND2_X1) {
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-2"></a>    drive_strength : 1;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-3"></a>    pin (A1) {
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-4"></a>        direction : input;
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-5"></a>    }
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-6"></a>    pin (A2) {
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-7"></a>        direction : input;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-8"></a>    }
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-9"></a>    pin (ZN) {
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-10"></a>        direction : output;
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-11"></a>        function : &quot;(A1 &amp; A2)&quot;;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-12"></a>    }
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-13"></a>    /* ... */
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-0-14"></a>}
</span></code></pre></div>
<p>这样就定义了两个输入 pin，一个输出 pin，还有它实现的功能。还有很重要的一点是保存了时序信息，比如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-1"></a>lu_table_template (Timing_7_7) {
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-2"></a>    variable_1 : input_net_transition;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-3"></a>    variable_2 : total_output_net_capacitance;
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-4"></a>    index_1 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-5"></a>    index_2 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-6"></a>}
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-7"></a>cell (AND2_X1) {
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-8"></a>    pin (ZN) {
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-9"></a>        timing () {
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-10"></a>            related_pin : &quot;A1&quot;;
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-11"></a>            timing_sense : positive_unate;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-12"></a>            cell_fall(Timing_7_7) {
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-13"></a>                index_1 (&quot;0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535&quot;);
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-14"></a>                index_2 (&quot;0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400&quot;);
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-15"></a>                values (&quot;0.0217822,0.0253224,0.0288237,0.0346827,0.0448323,0.0636086,0.100366&quot;, \
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-16"></a>                        &quot;0.0233179,0.0268545,0.0303556,0.0362159,0.0463659,0.0651426,0.101902&quot;, \
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-17"></a>                        &quot;0.0296429,0.0331470,0.0366371,0.0425000,0.0526603,0.0714467,0.108208&quot;, \
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-18"></a>                        &quot;0.0402311,0.0440292,0.0477457,0.0538394,0.0641187,0.0829203,0.119654&quot;, \
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-19"></a>                        &quot;0.0511250,0.0554077,0.0595859,0.0662932,0.0771901,0.0963434,0.133061&quot;, \
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-20"></a>                        &quot;0.0625876,0.0673198,0.0719785,0.0794046,0.0910973,0.110757,0.147656&quot;, \
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-21"></a>                        &quot;0.0748282,0.0800098,0.0851434,0.0933663,0.106111,0.126669,0.163872&quot;);
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-22"></a>            }
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-23"></a>    }
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-1-24"></a>}
</span></code></pre></div>
<p>首先要看 cell_fall 后面的 template 是 Timing_7_7，可以看到 variable_1 和 variable_2 对应的是 input_net_transition 和 total_output_net_capacitance。这里 cell_fall 指的是输出 pin ZN 从 1 变成 0 的时候，这个变化从 A1 的变化传播到 ZN 的时间，这个时间和输入的 transition 时间（大概是从 0 到 1、从 1 到 0 的时间，具体从多少百分比到多少百分比见设置）和输出的 capacitance 有关，所以是一个查找表，查找的时候找最近的点进行插值。输出的 capacitance 取决于 wire load 和连接了这个输出的其他单元的输入。</p>
<p>除了 cell_fall/cell_rise 两种类型，还有 fall_transition 和 rise_transition，这就是输出引脚的变化时间，又作为后继单元的输入 transition 时间。</p>
<p>接下来，还能看到功耗的数据：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-1"></a>power_lut_template (Power_7_7) {
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-2"></a>    variable_1 : input_transition_time;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-3"></a>    variable_2 : total_output_net_capacitance;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-4"></a>    index_1 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-5"></a>    index_2 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-6"></a>}
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-7"></a>internal_power () {
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-8"></a>    related_pin          : &quot;A1&quot;;
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-9"></a>    fall_power(Power_7_7) {
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-10"></a>        index_1 (&quot;0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535&quot;);
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-11"></a>        index_2 (&quot;0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400&quot;);
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-12"></a>        values (&quot;2.707163,2.939134,3.111270,3.271119,3.366153,3.407657,3.420511&quot;, \
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-13"></a>                &quot;2.676697,2.905713,3.073189,3.236823,3.334156,3.373344,3.387400&quot;, \
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-14"></a>                &quot;2.680855,2.891263,3.047784,3.212948,3.315296,3.360694,3.377614&quot;, \
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-15"></a>                &quot;2.821141,3.032707,3.182020,3.338567,3.444608,3.488752,3.508229&quot;, \
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-16"></a>                &quot;3.129641,3.235525,3.357993,3.567372,3.743682,3.792092,3.808289&quot;, \
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-17"></a>                &quot;3.724304,3.738737,3.808381,3.980825,4.147999,4.278043,4.311323&quot;, \
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-18"></a>                &quot;4.526175,4.492292,4.510220,4.634217,4.814899,4.934862,5.047389&quot;);
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-19"></a>    }
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-20"></a>    rise_power(Power_7_7) {
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-21"></a>        index_1 (&quot;0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535&quot;);
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-22"></a>        index_2 (&quot;0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400&quot;);
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-23"></a>        values (&quot;1.823439,1.926997,1.963153,2.028865,1.957837,2.123314,2.075262&quot;, \
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-24"></a>                &quot;1.796317,1.896145,1.960625,2.014112,2.050786,2.046472,1.972327&quot;, \
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-25"></a>                &quot;1.811604,1.886741,1.955658,1.978263,1.965671,1.963736,2.071227&quot;, \
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-26"></a>                &quot;1.997387,2.045930,2.092357,2.063643,2.099127,1.932089,2.131341&quot;, \
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-27"></a>                &quot;2.367285,2.439718,2.440043,2.403446,2.305848,2.351146,2.195145&quot;, \
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-28"></a>                &quot;2.916140,2.994325,3.044451,2.962881,2.836259,2.781564,2.633645&quot;, \
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-29"></a>                &quot;3.687718,3.756085,3.789394,3.792984,3.773583,3.593022,3.405552&quot;);
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-30"></a>    }
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-2-31"></a>}
</span></code></pre></div>
<p>可以看到，这也是一个查找表，也是按照输出的 rise/fall 有不同的功耗。巧合的是，功耗的查找表的 index_1/index_2 和上面的时序查找表是一样的。除了 internal power，还有 leakage power，定义如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-1"></a>leakage_power_unit : &quot;1nW&quot;;
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-2"></a>/* ... */
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-3"></a>cell_leakage_power  : 50.353160;
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-5"></a>leakage_power () {
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-6"></a>    when           : &quot;!A1 &amp; !A2&quot;;
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-7"></a>    value          : 40.690980;
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-8"></a>}
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-9"></a>leakage_power () {
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-10"></a>    when           : &quot;!A1 &amp; A2&quot;;
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-11"></a>    value          : 62.007550;
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-12"></a>}
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-13"></a>leakage_power () {
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-14"></a>    when           : &quot;A1 &amp; !A2&quot;;
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-15"></a>    value          : 41.294331;
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-16"></a>}
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-17"></a>leakage_power () {
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-18"></a>    when           : &quot;A1 &amp; A2&quot;;
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-19"></a>    value          : 57.419780;
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-3-20"></a>}
</span></code></pre></div>
<p>可以看到，它的 leakage power 取决于输入的状态，单位是 1nW。</p>
<p>再来看 Flip Flop 的定义：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-1"></a>cell (DFFRS_X1) {
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-2"></a>    ff (&quot;IQ&quot; , &quot;IQN&quot;) {
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-3"></a>        next_state          : &quot;D&quot;;
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-4"></a>        clocked_on          : &quot;CK&quot;;
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-5"></a>        preset              : &quot;!SN&quot;;
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-6"></a>        clear               : &quot;!RN&quot;;
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-7"></a>        clear_preset_var1   : L;
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-8"></a>        clear_preset_var2   : L;
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-9"></a>    }
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-10"></a>    pin (D) {
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-11"></a>        direction       : input;
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-12"></a>        capacitance     : 1.148034;
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-13"></a>        fall_capacitance    : 1.081549;
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-14"></a>        rise_capacitance    : 1.148034;
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-15"></a>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-16"></a>        timing () {
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-18"></a>            related_pin    : &quot;CK&quot;;
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-19"></a>            timing_type    : hold_rising;
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-20"></a>            when               : &quot;RN &amp; SN&quot;;
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-21"></a>            sdf_cond       : &quot;RN_AND_SN === 1&#39;b1&quot;;
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-22"></a>            fall_constraint(Hold_3_3) {
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-23"></a>                index_1 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-24"></a>                index_2 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-25"></a>                values (&quot;0.002921,0.012421,0.011913&quot;, \
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-26"></a>                        &quot;0.002707,0.008886,0.005388&quot;, \
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-27"></a>                        &quot;0.139993,0.148595,0.137370&quot;);
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-28"></a>            }
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-29"></a>            rise_constraint(Hold_3_3) {
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-30"></a>                index_1 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-31"></a>                index_2 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-32"></a>                values (&quot;0.004193,0.015978,0.019836&quot;, \
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-33"></a>                        &quot;0.020266,0.031864,0.035343&quot;, \
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-34"></a>                        &quot;0.099118,0.113075,0.120979&quot;);
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-35"></a>            }
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-36"></a>        }
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-37"></a>    }
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-4-38"></a>}
</span></code></pre></div>
<p>可以看到，这里的属性变成了 setup/hold 时间。</p>
<p>SRAM 也有类似的定义，通常是写在单独的 lib 文件中，根据 width 和 depth 生成，比如 <a href="https://github.com/The-OpenROAD-Project/OpenROAD-flow-scripts/blob/master/flow/platforms/nangate45/lib/fakeram45_32x64.lib">fakeram45_32x64.lib</a>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-1"></a>cell(fakeram45_32x64) {
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-2"></a>    area : 1754.536;
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-3"></a>    interface_timing : true;
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-4"></a>    memory() {
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-5"></a>        type : ram;
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-6"></a>        address_width : 5;
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-7"></a>        word_width : 64;
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-8"></a>    }
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-9"></a>    pin(clk)   {
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-10"></a>        direction : input;
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-11"></a>        min_period : 0.174 ;
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-12"></a>        internal_power(){
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-13"></a>            rise_power(scalar) {
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-14"></a>                values (&quot;1498.650&quot;)
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-15"></a>            }
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-16"></a>            fall_power(scalar) {
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-17"></a>                values (&quot;1498.650&quot;)
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-18"></a>            }
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-19"></a>        }
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-20"></a>    }
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-21"></a>    bus(wd_in)   {
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-22"></a>        bus_type : fakeram45_32x64_DATA;
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-23"></a>        direction : input;
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-24"></a>        timing() {
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-25"></a>            related_pin     : clk;
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-26"></a>            timing_type     : setup_rising ;
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-27"></a>            rise_constraint(scalar) {
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-28"></a>                values (&quot;0.050&quot;);
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-29"></a>            }
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-30"></a>            fall_constraint(scalar) {
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-31"></a>                values (&quot;0.050&quot;);
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-32"></a>            }
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-33"></a>        } 
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-34"></a>        internal_power(){
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-35"></a>            when : &quot;(we_in)&quot;;
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-36"></a>            rise_power(scalar) {
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-37"></a>                values (&quot;14.987&quot;);
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-38"></a>            }
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-39"></a>            fall_power(scalar) {
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-40"></a>                values (&quot;14.987&quot;);
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-41"></a>            }
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-42"></a>        }
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-43"></a>    }
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-5-44"></a>}
</span></code></pre></div>
<p>也可以类似地看到，它的输入 setup/hold，功耗，面积等等信息。</p>
<h4 id="db"><a class="toclink" href="../../hardware/2022/03/14/design-compiler-synthesis/#db">DB 格式</a></h4>
<p>在给 Design Compiler 配置工艺库前，需要用 Library Compiler 先把 lib 格式转换为更紧凑的二进制 db 格式：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-6-1"></a><span class="nv">read_lib</span><span class="w"> </span>xxx.lib
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-6-2"></a><span class="nv">write_lib</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>db<span class="w"> </span>xxx
</span></code></pre></div>
<p>实测部分 Liberty 文件会报错，不知道有没有修复的办法。另外，不同版本的 Library Compiler 生成的格式也不大一样，但都是兼容的。</p>
<p>在 Design Compiler 中，设置当前工艺库命令：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-7-1"></a><span class="nv">set_app_var</span><span class="w"> </span>target_library<span class="w"> </span>xxx.db
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-7-2"></a><span class="nv">set_link_var</span><span class="w"> </span>target_library<span class="w"> </span>xxx.db
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-7-3"></a><span class="c">## or</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-7-4"></a><span class="nv">set_app_var</span><span class="w"> </span>target_library<span class="w"> </span><span class="k">{</span><span class="nv">xxx.db</span><span class="w"> </span>yyy.db<span class="k">}</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-7-5"></a><span class="nv">set_link_var</span><span class="w"> </span>target_library<span class="w"> </span><span class="k">{</span><span class="nv">xxx.db</span><span class="w"> </span>yyy.db<span class="k">}</span>
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/14/design-compiler-synthesis/#_2">综合脚本</a></h3>
<p>准备好工艺库以后，就可以开始编写综合脚本了，通常有这么些步骤：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-1"></a><span class="c">## step 1: read source code &amp; set top level module name</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-2"></a><span class="nv">read_file</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>verilog<span class="w"> </span>xxx.v
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-3"></a><span class="nv">read_file</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>vhdl<span class="w"> </span>yyy.vhdl
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-4"></a><span class="nv">current_design</span><span class="w"> </span>xxx
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-6"></a><span class="c">## step 2: setup timing constraints</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-7"></a><span class="nv">create_clock</span><span class="w"> </span>clock<span class="w"> </span><span class="o">-</span>period<span class="w"> </span><span class="mf">1.0000</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mi">1</span>GHz<span class="w"> </span>for<span class="w"> </span>example
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-8"></a><span class="c">## other timing constraints:</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-9"></a><span class="c">## e.g. set_input_delay/set_output_delay</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-11"></a><span class="c">## step 3: synthesis</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-12"></a><span class="nv">link</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-13"></a><span class="nv">uniquify</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-14"></a><span class="c">## use this if you want to ungroup all hierarchy</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-15"></a><span class="c">## ungroup -flatten -all</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-16"></a><span class="c">## use this to retime design</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-17"></a><span class="c">## set_optimize_registers</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-18"></a><span class="nv">compile_ultra</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-19"></a>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-20"></a><span class="c">## step 4: check &amp; report</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-21"></a><span class="nv">check_timing</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-22"></a><span class="nv">check_design</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-23"></a><span class="nv">report_design</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-24"></a><span class="nv">report_area</span><span class="w"> </span><span class="o">-</span>hierarchy
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-25"></a><span class="nv">report_power</span><span class="w"> </span><span class="o">-</span>hierarchy
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-26"></a><span class="nv">report_cell</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-27"></a><span class="nv">report_timing</span><span class="w"> </span><span class="o">-</span>delay_type<span class="w"> </span>max
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-28"></a><span class="nv">report_timing</span><span class="w"> </span><span class="o">-</span>delay_type<span class="w"> </span>min
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-29"></a><span class="nv">report_constraint</span><span class="w"> </span><span class="o">-</span>all_violators
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-30"></a><span class="nv">report_qor</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-31"></a>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-32"></a><span class="c">## step 5: export</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-33"></a><span class="nv">write</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>ddc<span class="w"> </span><span class="o">-</span>hierarchy<span class="w"> </span><span class="o">-</span>output<span class="w"> </span>xxx.ddc
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-34"></a><span class="nv">write_sdc</span><span class="w"> </span><span class="o">-</span>version<span class="w"> </span><span class="mf">1.0</span><span class="w"> </span>xxx.sdf
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-35"></a><span class="nv">write</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>verilog<span class="w"> </span><span class="o">-</span>hierarchy<span class="w"> </span><span class="o">-</span>output<span class="w"> </span>xxx.syn.v
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-8-36"></a><span class="nv">write_sdc</span><span class="w"> </span>xxx.sdc
</span></code></pre></div>
<p>根据需求，进行自定义的修改。综合完成后，可以看到生成的 <code>xxx.syn.v</code> 文件里都是一个个的 cell，比如：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-9-1"></a><span class="n">AND2X2</span><span class="w"> </span><span class="n">U3912</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">n4416</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">n2168</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">n3469</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-9-2"></a><span class="n">OAI21X1</span><span class="w"> </span><span class="n">U3913</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">n2872</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">n4589</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">C</span><span class="p">(</span><span class="n">n2461</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">n3471</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../hardware/2022/03/14/design-compiler-synthesis/#__codelineno-9-3"></a><span class="n">DFFPOSX1</span><span class="w"> </span><span class="n">clock_r_REG147_S1</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">n7634</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CLK</span><span class="p">(</span><span class="n">clock</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">n7773</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
<p>还有一些比较特殊的 cell，比如 TIEHI/TIELO 就是恒定输出 1/0，用于门控时钟的 CLKGATE/ICG 等，还有一些综合阶段不会出现的 cell，在后续阶段会使用。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/03/14/design-compiler-synthesis/#_3">参考文档</a></h3>
<ul>
<li><a href="https://vlsiuniverse.blogspot.com/2016/12/liberty-format-introduction.html">Liberty format: an introduction</a></li>
<li><a href="https://www.eng.biu.ac.il/temanad/files/2017/02/Lecture-4-Standard-Cell-Libraries.pdf">Digital VLSI Design Lecture 4: Standard Cell Libraries</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/03/14/design-compiler-synthesis/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-12 00:00:00">2022年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openroad-flow"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/">OpenROAD Flow 初尝试</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_1">背景</a></h3>
<p>最近在尝试接触一些芯片前后端的知识。正好有现成的开源工具链 OpenROAD 来做这个事情，借此机会来学习一下整个流程。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_2">尝试过程</a></h3>
<p>首先 clone 仓库 OpenROAD-flow-scripts，然后运行：<code>./build_openroad.sh</code>，脚本会克隆一些仓库，自动进行编译。</p>
<p>编译中会找不到一些库，比如可能需要安装这些依赖：<code>liblemon-dev libeigen3-dev libreadline-dev swig</code>，此外运行的时候还需要 <code>klayout</code> 依赖。</p>
<p>如果遇到解决 cmake 找不到 LEMON 的问题，这是一个 <a href="https://lemon.cs.elte.hu/trac/lemon/ticket/628">BUG</a>，可以运行下面的命令解决：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-0-1"></a><span class="nb">cd</span><span class="w"> </span>/usr/lib/x86_64-linux-gnu/cmake/lemon
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-0-2"></a>cp<span class="w"> </span>lemonConfig.cmake<span class="w"> </span>LEMONConfig.cmake
</span></code></pre></div>
<p>编译后整个目录大概有 4.8G，输出的二进制目录是 133M。</p>
<p>如果要跑一下样例里的 nangate45 工艺的 gcd 例子，运行：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-1-1"></a>cd flow
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-1-2"></a>make DESIGN_CONFIG=./designs/nangate45/gcd/config.mk
</span></code></pre></div>
<h3 id="gcd"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#gcd">分析 GCD 测例</a></h3>
<p>这个测例的代码提供了这样一个接口：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-1"></a><span class="k">module</span><span class="w"> </span><span class="n">gcd</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-2"></a><span class="p">(</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-3"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-4"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">req_msg</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-5"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_rdy</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-6"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_val</span><span class="p">,</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-7"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">reset</span><span class="p">,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-8"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">resp_msg</span><span class="p">,</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-9"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_rdy</span><span class="p">,</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-10"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_val</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-11"></a><span class="p">);</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-12"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>从名字可以推断出，外部通过 req 发送请求到 GCD 模块，然后模块计算出 GCD 后再返回结果。</p>
<p>根据日志可以看到，从 verilog 到最终的 gds 文件，经过了这些步骤：</p>
<ol>
<li>第一步用 yosys 综合（1_1_yosys），把 verilog 代码转化为网表，网表中的单元就是形如 <code>NAND2_X1</code> <code>DFF_X1</code> 等这样由工艺库定义的一些单元。</li>
<li>第二步进行 floorplan（2_1_floorplan），规划出芯片的大小，逻辑放在哪个位置，输入输出引脚放在什么位置（2_2_floorplan_io），还要考虑 SRAM 等宏或者 IP（2_4_mplace），电源网络 PDN（2_6_floorplan_pdn）</li>
<li>第三步是 Placement，就是把前面得到的一些 cell 放到芯片上的 (x,y) 坐标上</li>
<li>第四步是 Clock Tree Synthesis（4_1_cts），简称 CTS，生成时钟树</li>
<li>第五步是进行路由连线，OpenROAD 有两个路由：FastRoute（5_1_fastroute）和 TritonRoute（5_2_TritonRoute）</li>
<li>第六步输出结果到 gds 文件（6_1_merge）。</li>
</ol>
<p>这些步骤可以在仓库的 <code>flow/Makefile</code> 里面看得比较清晰，英文版摘抄如下：</p>
<ol>
<li>SYNTHESIS<ol>
<li>Run Synthesis using yosys</li>
</ol>
</li>
<li>FLOORPLAN<ol>
<li>Translate verilog to def</li>
<li>IO Placement (random)</li>
<li>Timing Driven Mixed Size Placement (tdms)</li>
<li>Macro Placement</li>
<li>Tapcell and Welltie insertion</li>
<li>PDN generation</li>
</ol>
</li>
<li>PLACE<ol>
<li>Global placement without placed IOs, timing-driven, and routability-driven</li>
<li>IO placement (non-random)</li>
<li>Global placement with placed IOs, timing-driven, and routability-driven</li>
<li>Resizing &amp; Buffering</li>
<li>Detail placement</li>
</ol>
</li>
<li>CTS(Clock Tree Synthesis)<ol>
<li>Run TritonCTS</li>
<li>Filler cell insertion</li>
</ol>
</li>
<li>ROUTING<ol>
<li>Run global route (FastRoute)</li>
<li>Run detailed route (TritonRoute)</li>
</ol>
</li>
</ol>
<p>最后生成的 gds，用 KLayout 打开，可以看到这个样子：</p>
<p><img alt="" src="/images/gcd_gds.png" /></p>
<p>日志里可以看到，预测的总功耗是 1.71 mW，面积占用是 703 um^2。</p>
<p>还跑了一下其他样例设计的 gds，比如 ibex：</p>
<p><img alt="" src="/images/ibex_gds.png" /></p>
<p>日志里可以看到，预测的总功耗是 10.1 mW，面积占用是 32176 um^2。</p>
<p>还有 tiny rocket：</p>
<p><img alt="" src="/images/tiny_rocket_gds.png" /></p>
<p>日志里可以看到，预测的总功耗是 36.8 mW，面积占用是 52786 um^2。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_3">工艺库常见术语</a></h3>
<ul>
<li>slvt/lvt/rvt/hvt: super-low/low/regular/high V threshold 前者速度快：阈值电压低，同时漏电流大</li>
<li>ss/tt/ff: slow-slow/typical-typical/fast-fast 后者速度快：电压高，温度低，比如 SS（0.99V 125C）TT（1.10V 25C）FF（1.21V -40C）；有时候还会看到 ssg，可以理解为 ss 的比较精确的版本，因此没有那么悲观，延迟比 SS 低一些，详见 <a href="https://cloud.tencent.com/developer/article/1598417">STA | ssg 跟 ss corner 的区别——谬误更正版</a></li>
<li>c+数字：表示的是 channel length，c40 表示 40nm，数字越大速度越慢，能耗越低</li>
<li>数字+track：表示的是 track height，sc12 表示 12-track，数字越大速度越快</li>
</ul>
<p>ARM 的文档 <a href="https://developer.arm.com/documentation/102738/0100/Choosing-the-physical-IP-libraries">Choosing the physical IP libraries</a> 描述了 Channel length, Track height, Voltage threshold 等不同的选择。</p>
<p>综合来说，如果要更低的延迟，选择低 vt，小 c 和大 track，反之如果要更低的能耗，选择高 vt，大 c 和 小 track。</p>
<h3 id="ccs-vs-nldm"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#ccs-vs-nldm">CCS v.s. NLDM</a></h3>
<p>由于物理的特性比较复杂，工艺库里描述的也只是一个大致的模型，刻画了这些 cell 的特性，那么自然可以选取不同的模型。NLDM（上面举的例子就是 NLDM），CCS 就是常见的两个模型，相比之下，CCS 更精确，同时参数更多。更精确的还有直接用 SPICE 描述的电路。详细的对比可以看下面的参考文档。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_4">参考文档</a></h3>
<ul>
<li><a href="https://theopenroadproject.org/2019/12/11/getting-started-with-openroad-app-part-1/">GETTING STARTED WITH OPENROAD APP – PART 1</a></li>
<li><a href="https://link.springer.com/book/10.1007/b117024">Advanced ASIC Chip Synthesis Using Synopsys® Design Compiler™ Physical Compiler™ and PrimeTime®</a></li>
<li><a href="https://www.paripath.com/blog/characterization-blog/comparing-nldm-and-ccs-delay-models">Comparing NLDM And CCS delay models</a></li>
<li><a href="https://chitlesh.ch/wordpress/liberty-ccs-ecsm-or-ndlm/">Introduction to Liberty : CCS, ECSM and NDLM</a></li>
<li><a href="https://blog.csdn.net/graymount/article/details/106010388">STA 概念：一文了解 NLDM 与 CCS</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/03/12/try-openroad-flow/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-09 00:00:00">2022年3月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="jtag-vcu128-rocket-chip"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/">通过 JTAG 对 VCU128 上的 Rocket Chip 进行调试</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#_1">前言</a></h3>
<p>两年前，我尝试过用 BSCAN JTAG 来配置 Rocket Chip 的调试，但是这个方法不是很好用，具体来说，如果有独立的一组 JTAG 信号，配置起来会更方便，而且不用和 Vivado 去抢，OpenOCD 可以和 Vivado hw_server 同时运行和工作。但是，苦于 VCU128 上没有 PMOD 接口，之前一直没考虑过在 VCU128 上配置独立的 JTAG。然后最近研究了一下，终于解决了这个问题。</p>
<h3 id="jtag"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#jtag">寻找 JTAG 接口</a></h3>
<p>前几天在研究别的问题的时候，看到 VCU128 文档中的这段话：</p>
<div class="language-text highlight"><pre><span></span><code>The FT4232HL U8 multi-function USB-UART on the VCU128 board provides three level-shifted
UART connections through the single micro-AB USB connector J2.
• Channel A is configured in JTAG mode to support the JTAG chain
• Channel B implements 4-wire UART0 (level-shifted) FPGA U1 bank 67 connections
• Channel C implements 4-wire UART1 (level-shifted) FPGA U1 bank 67 connections
• Channel D implements 2-wire (level-shifted) SYSCTLR U42 bank 501 connections
</code></pre></div>
<p>其中 Channel A 是到 FPGA 本身的 JTAG 接口，是给 Vivado 用的，如果是通过 BSCAN 的方式，也是在这个 Channel 上，但是需要经过 FPGA 自己的 TAP 再隧道到 BSCAN 上，比较麻烦。Channel B 和 C 是串口，Channel D 是连接 VCU128 上的 System Controller 的。之前的时候，都是直接用 Channel B 做串口，然后突发奇想：注意到这里是 4-wire UART，说明连接到 FPGA 是四条线，那是不是也可以拿来当 JTAG 用？</p>
<p>查询了一下 FT4232H 的文档，发现它的 Channel A 和 Channel B 是支持 MPSSE 模式的，在 MPSSE 模式下，可以当成 JTAG 使用：</p>
<table>
<thead>
<tr>
<th>Signal</th>
<th>Channel A</th>
<th>Channel B</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCK</td>
<td>12</td>
<td>22</td>
</tr>
<tr>
<td>TDI</td>
<td>13</td>
<td>23</td>
</tr>
<tr>
<td>TDO</td>
<td>14</td>
<td>24</td>
</tr>
<tr>
<td>TMS</td>
<td>15</td>
<td>25</td>
</tr>
</tbody>
</table>
<p>对照 VCU128 的 Schematic 看，虽然引脚的编号不大一样，可以发现，Channel A 和 B 分别对应了 ADBUS0-4 和 BDBUS 0-4，对应到 schematic 上的名字是：</p>
<ul>
<li>ADBUS0 - FT4232_TCK</li>
<li>ADBUS1 - FT4232_TDI</li>
<li>ADBUS2 - FMCP_HSPC_TDO</li>
<li>ADBUS3 - FT4232_TMS</li>
</ul>
<p>这一组是直接连到 FPGA 上专用的 JTAG 引脚，其中 TDO 是连接了额外的逻辑，可以把 FMC 接口上的 JTAG 连接成 daisy chain。</p>
<ul>
<li>ADBUS0 - FTDI_UART0_TXD_LS - UART0_RXD - BP26 -&gt; TCK</li>
<li>ADBUS1 - FTDI_UART0_RXD_LS - UART0_TXD - BN26 -&gt; TDI</li>
<li>ADBUS2 - FTDI_UART0_RTS_B_LS - UART0_RTS_B - BP22 -&gt; TDO</li>
<li>ADBUS3 - FTDI_UART0_CTS_B_LS - UART0_CTS_B - BP23 -&gt; TMS</li>
</ul>
<p>这里的 RXD/TXD 名字交换也是很容易看错，要小心，只要记住 FT4232H 要求的顺序一定是 TCK-TDI-TDO-TMS 即可。对应到 vivado 内的 xdc 就是这么写：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-1"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-2"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BN26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-3"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP22<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-4"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP23<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span></code></pre></div>
<p>接下来，我们要把 Rocket Chip 的 JTAG 信号接出来。</p>
<h3 id="rocket-chip-jtag"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#rocket-chip-jtag">配置 Rocket Chip 的 JTAG</a></h3>
<p>配置 Rocket Chip 的 JTAG，大概需要如下几步：</p>
<ol>
<li>给 Config 加上 WithJtagDTM，以 JTAG 作为 DTM 模块</li>
<li>给 Subsystem 加上 HasPeripheryDebug</li>
<li>给 SubsystemModuleImp 加上 HasPeripheryDebugModuleImp</li>
<li>把 JTAG 信号连到自己的顶层模块上</li>
</ol>
<p>最后一步的相关代码，首先，按照 spec 要求，把 DM 输出的 ndreset 信号连到整个 Rocket 的 reset 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-1-1"></a><span class="c1">// ndreset can reset all harts</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-1-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asBool</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">ndreset</span><span class="p">).</span><span class="n">getOrElse</span><span class="p">(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-1-3"></a><span class="n">target</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span>
</span></code></pre></div>
<p>接着，把 JTAG 的信号连到顶层：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">systemJtag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">systemjtag</span><span class="p">.</span><span class="n">get</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-5"></a><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span>
</span></code></pre></div>
<p>除了 JTAG 信号以外，还需要配置 IDCODE 相关的变量：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-3-1"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">mfr_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeManufId</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">11</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-3-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">part_number</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodePartNum</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-3-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeVersion</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span></code></pre></div>
<p>最后这一部分比较关键：首先，JTAG 部分的 reset 是独立于其余部分的，这里简单期间就连到了外部的 reset，其实可以改成 FPGA program 的时候进行 reset，然后等时钟来了就释放，实现方法可以参考文末的链接。resetctrl 是给 DM 知道哪些核心被 reset 了，最后是调用 rocket chip 自带的函数。这里踩的一个坑是，传给 systemJtag.reset 一定得是异步的，因为这个时钟域的时钟都是 jtag 的 TCK 信号，所以很可能错过一开始的 reset 信号，所以这里要用异步的 reset。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-1"></a><span class="c1">// MUST use async reset here</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-2"></a><span class="c1">// otherwise the internal logic(e.g. TLXbar) might not function</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-3"></a><span class="c1">// if reset deasserted before TCK rises</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asAsyncReset</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-5"></a><span class="n">target</span><span class="p">.</span><span class="n">resetctrl</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-6"></a><span class="w">  </span><span class="n">rc</span><span class="p">.</span><span class="n">hartIsInReset</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-7"></a><span class="p">}</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-8"></a><span class="nc">Debug</span><span class="p">.</span><span class="n">connectDebugClockAndReset</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="jtag_1"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#jtag_1">配置 JTAG 相关的约束</a></h3>
<p>这部分是参考了 pulp 的 VCU118 中 jtag 信号的约束文件。照着抄就行：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-1"></a><span class="nv">create_clock</span><span class="w"> </span><span class="o">-</span>period<span class="w"> </span><span class="mf">100.000</span><span class="w"> </span><span class="o">-</span>name<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-2"></a><span class="nv">set_input_jitter</span><span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">1.000</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-3"></a><span class="nv">set_property</span><span class="w"> </span>CLOCK_DEDICATED_ROUTE<span class="w"> </span>FALSE<span class="w"> </span><span class="k">[</span><span class="nv">get_nets</span><span class="w"> </span>jtag_TCK_IBUF_inst<span class="o">/</span>O<span class="k">]</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-4"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-5"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-6"></a><span class="nv">set_output_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-7"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>to<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-8"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-9"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-10"></a><span class="nv">set_clock_groups</span><span class="w"> </span><span class="o">-</span>asynchronous<span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span>jtag_TCK<span class="k">]</span><span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span><span class="o">-</span>of_objects<span class="w"> </span><span class="k">[</span><span class="nv">get_pins</span><span class="w"> </span>system_i<span class="o">/</span>clk_wiz_0<span class="o">/</span>inst<span class="o">/</span>mmcme4_adv_inst<span class="o">/</span>CLKOUT1<span class="k">]]</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-11"></a><span class="nv">set_property</span><span class="w"> </span>ASYNC_REG<span class="w"> </span>TRUE<span class="w"> </span><span class="k">[</span><span class="nv">get_cells</span><span class="w"> </span><span class="o">-</span>hier<span class="w"> </span><span class="o">-</span>regexp<span class="w"> </span><span class="s2">&quot;system_i/rocketchip_wrapper_0/.*/cdc_reg_reg.*&quot;</span><span class="k">]</span>
</span></code></pre></div>
<p>和原版本稍微改了一下，一个区别是 <code>set_clock_groups</code> 的时候，第二个时钟参数用的是 Clocking Wizard 的输出，同时也是 Rocket Chip 自己的时钟输入；另一个区别是用的 ASYNC_REG 查询语句不大一样。我没有具体分析过这些约束为什么这么写，不确定这些约束是否都合理，是否都是需要的，没有测试过不带这些约束会不会出问题。</p>
<h3 id="openocd-gdb"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#openocd-gdb">运行 OpenOCD 和 GDB</a></h3>
<p>最后，采用如下的 OpenOCD 配置来连接：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-1"></a><span class="c">## openocd config</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-2"></a><span class="c">## use ftdi channel 1</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-3"></a><span class="c">## vcu128 uart0 as jtag</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-4"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">10000</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-5"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>ftdi
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-6"></a><span class="nv">ftdi_vid_pid</span><span class="w"> </span><span class="mh">0x0403</span><span class="w"> </span><span class="mh">0x6011</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>FT4232H
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-7"></a><span class="nv">ftdi_layout_init</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="mh">0x000b</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>Output:<span class="w"> </span>TCK<span class="w"> </span>TDI<span class="w"> </span>TMS
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-8"></a><span class="nv">ftdi_tdo_sample_edge</span><span class="w"> </span>falling
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-9"></a><span class="nv">ftdi_channel</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>channel<span class="w"> </span>B
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-10"></a><span class="nv">reset_config</span><span class="w"> </span>none
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-12"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-13"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-15"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-16"></a>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-17"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-18"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w"> </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
<p>然后就可以连接到 Rocket Chip 上：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-1"></a>&gt;<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>openocd.cfg
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0-rc2
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">&quot;jtag&quot;</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">&#39;transport select &lt;transport&gt;&#39;</span>.
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-7"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-8"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-9"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">10000</span><span class="w"> </span>kHz
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-10"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x10000913<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x489<span class="w"> </span><span class="o">(</span>SiFive<span class="w"> </span>Inc<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x1<span class="o">)</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-11"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">16</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Disabling<span class="w"> </span>abstract<span class="w"> </span><span class="nb">command</span><span class="w"> </span>reads<span class="w"> </span>from<span class="w"> </span>CSRs.
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-14"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">64</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x800000000094112d
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-15"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-16"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-17"></a>&gt;<span class="w"> </span>riscv64-unknown-elf-gdb
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-18"></a><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>target<span class="w"> </span>remote<span class="w"> </span>localhost:3333
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-19"></a>Remote<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>localhost:3333
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-20"></a>0x00000000800001a4<span class="w"> </span><span class="k">in</span><span class="w"> </span>??<span class="w"> </span><span class="o">()</span>
</span></code></pre></div>
<p>可以看到调试功能都正常了。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#_2">总结</a></h3>
<p>调试这个功能大概花了一天的时间，主要遇到了下面这些问题：</p>
<ol>
<li>调试模块的 reset 信号需要是异步的，这个是通过仿真（Remote Bitbang 连接 OpenOCD）调试出来的</li>
<li>看 schematic 的时候 rxd/txd 搞反了，后来仔细对比才找到了正确的对应关系</li>
<li>OpenOCD 配置的 irlen 一开始写的不对，dmcontrol 读出来是 0，一直以为是有别的问题，结果改了 irlen 后立马就成功了，这个问题可以让 OpenOCD 自动推断 irlen 来发现</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#_3">参考</a></h3>
<ul>
<li><a href="https://www.xilinx.com/support/documentation/boards_and_kits/vcu128/ug1302-vcu128-eval-bd.pdf">VCU128 User Guide</a></li>
<li><a href="https://ftdichip.com/wp-content/uploads/2020/08/DS_FT4232H.pdf">FT4232H</a></li>
<li><a href="https://github.com/sequencer/rocket-doc/blob/e55f7af549c5859b3c8f5a52c81c4c802153ed60/sanitytests/vcu118/src/DesignKeyWrapper.scala">DesignKeyWrapper from 中国 Chisel 之父 @sequencer</a></li>
<li><a href="https://github.com/pulp-platform/pulp/blob/770b4e1d69baf7daceaadcb301ba7212a4310577/fpga/pulp-vcu118/constraints/vcu118.xdc">pulp VCU118 constraints</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-02-22 00:00:00">2022年2月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="k3s-traefik-x-forwarded-for"><a class="toclink" href="../../devops/2022/02/22/k3s-traefik-client-ip/">解决 k3s 中 traefik 不会转发 X-Forwarded-For 等头部的问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2022/02/22/k3s-traefik-client-ip/#_1">背景</a></h3>
<p>把应用迁移到 k3s 中，然后用了 traefik 作为 Ingress Controller，发现无法获得真实的用户 IP 地址，而是 cni 内部的地址。搜索了一番，找到了靠谱的解决方案：</p>
<p><a href="https://medium.com/@_jonas/traefik-kubernetes-ingresse-x-forwarded-headers-82194d319b0e">Traefik Kubernetes Ingress and X-Forwarded-Headers</a></p>
<p>具体来说，需要给 traefik 传额外的参数，方法是在 k3s 的配置目录下，添加一个 HelmChartConfig：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-1"></a><span class="c1">## edit /var/lib/rancher/k3s/server/manifests/traefik-config.yaml</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-2"></a><span class="c1">## content:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-3"></a>apiVersion:<span class="w"> </span>helm.cattle.io/v1
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-4"></a>kind:<span class="w"> </span>HelmChartConfig
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-5"></a>metadata:
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-6"></a><span class="w">  </span>name:<span class="w"> </span>traefik
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-7"></a><span class="w">  </span>namespace:<span class="w"> </span>kube-system
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-8"></a>spec:
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-9"></a><span class="w">  </span>valuesContent:<span class="w"> </span><span class="p">|</span>-
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-10"></a><span class="w">    </span>additionalArguments:
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-11"></a><span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;--entryPoints.web.proxyProtocol.insecure&quot;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-12"></a><span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;--entryPoints.web.forwardedHeaders.insecure&quot;</span>
</span></code></pre></div>
<p>这样相当于让 traefik 信任前一级代理传过来的这些头部。更精细的话，还可以设置信任的 IP 地址范围，不过如果 traefik 不会直接暴露出去，就不用考虑这个问题了。</p>

    <nav class="md-post__action">
      <a href="../../devops/2022/02/22/k3s-traefik-client-ip/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-30 00:00:00">2022年1月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/os/" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="m1-windows-arm"><a class="toclink" href="../../os/2022/01/30/windows-on-arm-on-m1/">在 M1 上运行 Windows ARM 虚拟机</a></h2>
<p>目前 Windows ARM 出了预览版，可以从 <a href="https://www.microsoft.com/en-us/software-download/windowsinsiderpreviewARM64">Windows Insider Preview Downloads</a> 下载，得到一个 9.5GB 的 vhdx 文件。</p>
<p>接着，用 qemu-img 转换为 vmdk 格式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-0-1"></a>$<span class="w"> </span>qemu-img<span class="w"> </span>convert<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vhdx<span class="w"> </span>-O<span class="w"> </span>vmdk<span class="w"> </span>-o<span class="w"> </span><span class="nv">adapter_type</span><span class="o">=</span>lsilogic<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vmdk
</span></code></pre></div>
<p>转换后，在 VMWare Fusion for Apple Silicon Tech Preview 中，选择从已有的 vmdk 中创建虚拟机，启动前修改一些设置，特别是内存，默认 256MB 肯定不够，默认单核 CPU 也太少了一些。内存不足可能导致安装失败，记住要第一次启动前设置。</p>
<p>启动以后会无法访问网络，按照下面网页里的方法设置网络：</p>
<p>https://www.gerjon.com/vmware/vmware-fusion-on-apple-silicion-m1/</p>
<p>需要注意的是，bcdedit 选项填的 IP 地址一般是 bridge 上的地址，比如 bridge101 的地址。</p>
<p>然后就可以正常工作了！</p>
<p>在 <a href="https://communities.vmware.com/t5/Fusion-for-Apple-Silicon-Tech/Vmware-Fusion-Apple-Silicon-Support-Windows/m-p/2868331">VMWare 论坛里</a>，还谈到了下面几个问题的解决方法：</p>
<p>为了让声音工作，可以修改 vmx 文件，设置 guestOS：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-1-1"></a>guestOS = &quot;arm-windows11-64&quot;
</span></code></pre></div>
<p>这样声音就可以正常播放了。</p>
<p>分辨率的问题，可以用 RDP 来解决：首先在虚拟机里打开 Remote Desktop，然后用 macOS 的 Microsoft Remote Desktop Beta 访问即可。</p>
<p>系统里没有 Microsoft Store，要安装的话，用命令行的 Powershell 执行下面的命令：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-2-1"></a>wsreset.exe -i
</span></code></pre></div>
<p>这个方法见 <a href="https://kb.parallels.com/128520">Parallels Desktop KB128520</a>。</p>
<p>UPDATE:</p>
<p>VMware Fusion 发布了新版本 <a href="https://blogs.vmware.com/teamfusion/2022/07/just-released-vmware-fusion-22h2-tech-preview.html">22H2</a>，有官方的 Windows 11 on ARM 支持了：</p>
<ul>
<li>Windows 11 on Intel and Apple Silicon with 2D GFX and Networking</li>
<li>VMtools installation for Windows 11 GOS on M1</li>
<li>Improved Linux support on M1</li>
<li>3D Graphics HW Acceleration and OpenGL 4.3 in Linux VMs* (Requires Linux 5.19+ &amp; Mesa 22.1.3+)</li>
<li>Virtual TPM Device</li>
<li>Fast Encryption</li>
<li>Universal Binary</li>
</ul>
<p>并且不需要上面写的网卡的 workaround 了：</p>
<div class="language-text highlight"><pre><span></span><code>vmxnet3 Networking Drivers for Windows on ARM

While Windows does not yet ship with our vmxnet3 networking driver for
Windows on ARM as it now does for Intel, the VMware Tools ISO on ARM
contains the 2 currently supported drivers for graphics and networking.
</code></pre></div>
<p>实测安装 VMware Tools 以后，就可以成功用 vmxnet3 网卡上网了，不需要之前的 bcdedit 方案。</p>
<p>但是目前测试 Linux 虚拟机有一些问题，一些内核版本在启动的时候 vmwgfx 驱动会报错，不能正常显示，但是系统是正常启动的，可以通过 SSH 访问。我测试的情况见下：</p>
<p>Linux 5.19.6(5.19.0-1-arm64): 可以正常启动和显示，但是没有 3D 加速（按照 VMware 的说法是需要 5.19 内核 + Mesa 22.1.1 以上，但是我的环境版本已经符合了这个要求，可能是 Debian 打包缺了什么东西）；</p>
<p>UPDATE（2022-09-27）：更新了一下系统，现在 <code>glxinfo</code> 可以看到 SVGA 了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-1"></a>Device: SVGA3D; build: RELEASE; LLVM; (0x406)
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-2"></a>Version: 22.2.0
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-3"></a>Accelerated: no
</span></code></pre></div>
<p>但是显示有一些 BUG，刷新不正常。</p>
<p>Linux 5.18(5.18.0-0.bpo.1-arm64): <code>VMware Fusion has encountered an error and has shut down the virtual machine</code></p>
<p>Linux 5.16(5.16.0-0.bpo.4-arm64): SSH 也没启动，看不到内核日志</p>
<p>Linux 5.15.15(5.15.0-0.bpo.3-arm64):</p>
<p>图形界面起不来，可以通过 SSH 访问。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-1"></a>[   10.765945] kernel BUG at drivers/gpu/drm/vmwgfx/vmwgfx_drv.h:1627!
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-2"></a>[   10.766206] Call trace:
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-3"></a>[   10.766207]  vmw_event_fence_action_queue+0x328/0x330 [vmwgfx]
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-4"></a>[   10.766210]  vmw_stdu_primary_plane_atomic_update+0xd8/0x220 [vmwgfx]
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-5"></a>[   10.766214]  drm_atomic_helper_commit_planes+0xf8/0x21c [drm_kms_helper]
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-6"></a>[   10.766222]  drm_atomic_helper_commit_tail+0x5c/0xb0 [drm_kms_helper]
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-7"></a>[   10.766225]  commit_tail+0x160/0x190 [drm_kms_helper]
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-8"></a>[   10.766227]  drm_atomic_helper_commit+0x16c/0x400 [drm_kms_helper]
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-9"></a>[   10.766230]  drm_atomic_commit+0x58/0x6c [drm]
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-10"></a>[   10.766242]  drm_atomic_helper_set_config+0xe0/0x120 [drm_kms_helper]
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-11"></a>[   10.766245]  drm_mode_setcrtc+0x1ac/0x680 [drm]
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-12"></a>[   10.766249]  drm_ioctl_kernel+0xd0/0x120 [drm]
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-13"></a>[   10.766253]  drm_ioctl+0x250/0x460 [drm]
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-14"></a>[   10.766257]  vmw_generic_ioctl+0xbc/0x160 [vmwgfx]
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-15"></a>[   10.766261]  vmw_unlocked_ioctl+0x24/0x30 [vmwgfx]
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-16"></a>[   10.766264]  __arm64_sys_ioctl+0xb4/0x100
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-17"></a>[   10.766287]  invoke_syscall+0x50/0x120
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-18"></a>[   10.766300]  el0_svc_common.constprop.0+0x4c/0xf4
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-19"></a>[   10.766302]  do_el0_svc+0x30/0x9c
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-20"></a>[   10.766303]  el0_svc+0x28/0xb0
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-21"></a>[   10.766327]  el0t_64_sync_handler+0x1a4/0x1b0
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-22"></a>[   10.766328]  el0t_64_sync+0x1a0/0x1a4
</span></code></pre></div>
<p>回收硬盘空间：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-5-1"></a>sudo<span class="w"> </span>vmware-toolbox-cmd<span class="w"> </span>disk<span class="w"> </span>shrink<span class="w"> </span>/
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../os/2022/01/30/windows-on-arm-on-m1/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-25 00:00:00">2022年1月25日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="risc-v-vector-10"><a class="toclink" href="../../software/2022/01/25/rvv-1.0-toolchain/">RISC-V Vector 1.0 工具链构建</a></h2>
<p>不久前 RVV 1.0 标准终于是出来了，但是工具链的支持目前基本还处于刚 upstream 还没有 release 的状态。而目前 RVV 1.0 的支持主要在 LLVM 上比较活跃，因此也是采用 LLVM Clang + GCC Newlib Toolchain 的方式进行配合，前者做 RVV 1.0 的编译，后者提供 libc 等基础库。</p>
<p>UPDATE: LLVM 14 已经发布，这个版本已经支持 RVV 1.0，直接从 https://apt.llvm.org 等地安装 LLVM 14 即可。</p>
<p>LLVM Clang 直接采用 upstream 即可。编译选项：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-1"></a>$<span class="w"> </span>cmake<span class="w"> </span>-G<span class="w"> </span>Ninja<span class="w"> </span>../llvm<span class="w"> </span>-DCMAKE_C_COMPILER<span class="o">=</span>clang<span class="w"> </span>-DCMAKE_CXX_COMPILER<span class="o">=</span>clang++<span class="w"> </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span>/prefix/llvm<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>-DLLVM_ENABLE_PROJECTS<span class="o">=</span><span class="s2">&quot;clang&quot;</span><span class="w"> </span>-DLLVM_TARGETS_TO_BUILD<span class="o">=</span><span class="s2">&quot;RISCV&quot;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-2"></a>$<span class="w"> </span>ninja
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-3"></a>$<span class="w"> </span>ninja<span class="w"> </span>install
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-4"></a>$<span class="w"> </span>/prefix/llvm/bin/clang<span class="w"> </span>--version
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-5"></a>clang<span class="w"> </span>version<span class="w"> </span><span class="m">14</span>.0.0<span class="w"> </span><span class="o">(</span>https://github.com/llvm/llvm-project.git<span class="w"> </span>8d298355ca3778a47fd6b3110aeee03ea5e8e02b<span class="o">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-6"></a>Target:<span class="w"> </span>x86_64-unknown-linux-gnu
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-7"></a>Thread<span class="w"> </span>model:<span class="w"> </span>posix
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-8"></a>InstalledDir:<span class="w"> </span>/data/llvm/bin
</span></code></pre></div>
<p>还需要配合一个 GCC 工具链才可以完整地工作。可以直接采用 riscv-gnu-toolchain nightly 版本，比如 <a href="https://github.com/riscv-collab/riscv-gnu-toolchain/releases/download/2022.01.17/riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz">riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz</a>。下载以后解压，得到 riscv 目录，GCC 版本是比较新的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-1"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-gcc<span class="w"> </span>--version
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-2"></a>riscv64-unknown-elf-gcc<span class="w"> </span><span class="o">(</span>GCC<span class="o">)</span><span class="w"> </span><span class="m">11</span>.1.0
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-3"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2021</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-4"></a>This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>see<span class="w"> </span>the<span class="w"> </span><span class="nb">source</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>copying<span class="w"> </span>conditions.<span class="w">  </span>There<span class="w"> </span>is<span class="w"> </span>NO
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-5"></a>warranty<span class="p">;</span><span class="w"> </span>not<span class="w"> </span>even<span class="w"> </span><span class="k">for</span><span class="w"> </span>MERCHANTABILITY<span class="w"> </span>or<span class="w"> </span>FITNESS<span class="w"> </span>FOR<span class="w"> </span>A<span class="w"> </span>PARTICULAR<span class="w"> </span>PURPOSE.
</span></code></pre></div>
<p>但是如果编译 C++ 程序，链接的时候就会报错：<code>prefixed ISA extension must separate with _</code>，这是因为 riscv-gnu-toolchain 仓库的 binutils 版本不够新，在 upstream 的 binutils 里面已经修复了这个问题。所以 clone 下来，然后编译，覆盖掉 riscv-gnu-toolchain 里面的 binutils：</p>
<p>UPDATE: binutils 2.38 已经发布，用这个版本即可。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-1"></a>$<span class="w"> </span>../configure<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>--disable-gdb<span class="w"> </span>--disable-sim<span class="w"> </span>--disable-libdecnumber<span class="w"> </span>--disable-readline
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-2"></a>$<span class="w"> </span>make
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-3"></a>$<span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-4"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-ld<span class="w"> </span>--version
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-5"></a>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>GNU<span class="w"> </span>Binutils<span class="o">)</span><span class="w"> </span><span class="m">2</span>.38.50.20220125
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-6"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2022</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-7"></a>This<span class="w"> </span>program<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>you<span class="w"> </span>may<span class="w"> </span>redistribute<span class="w"> </span>it<span class="w"> </span>under<span class="w"> </span>the<span class="w"> </span>terms<span class="w"> </span>of
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-8"></a>the<span class="w"> </span>GNU<span class="w"> </span>General<span class="w"> </span>Public<span class="w"> </span>License<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span><span class="o">(</span>at<span class="w"> </span>your<span class="w"> </span>option<span class="o">)</span><span class="w"> </span>a<span class="w"> </span>later<span class="w"> </span>version.
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-9"></a>This<span class="w"> </span>program<span class="w"> </span>has<span class="w"> </span>absolutely<span class="w"> </span>no<span class="w"> </span>warranty.
</span></code></pre></div>
<p>然后编译程序的时候，使用 clang，配置参数 <code>--gcc-toolchain=~/riscv</code> 即可让 clang 找到 GNU 工具链。这样就可以编译出来 RVV 1.0 的程序了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-1"></a>$<span class="w"> </span>/llvm/bin/clang<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>-O2<span class="w"> </span>-march<span class="o">=</span>rv64gcv1p0<span class="w"> </span>-menable-experimental-extensions<span class="w"> </span>-mllvm<span class="w"> </span>--riscv-v-vector-bits-min<span class="o">=</span><span class="m">256</span><span class="w"> </span>--gcc-toolchain<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>add.cpp<span class="w"> </span>-o<span class="w"> </span>add
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-2"></a>$<span class="w"> </span>/data/llvm/bin/llvm-objdump<span class="w"> </span>--mattr<span class="o">=</span>+v<span class="w"> </span>-S<span class="w"> </span>add
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-3"></a><span class="w">   </span>1020e:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">70</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>c5<span class="w">   </span>vsetivli<span class="w">        </span>zero,<span class="w"> </span><span class="m">8</span>,<span class="w"> </span>e32,<span class="w"> </span>m1,<span class="w"> </span>ta,<span class="w"> </span>mu
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-4"></a><span class="w">   </span><span class="m">10212</span>:<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>t1<span class="o">)</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-5"></a><span class="w">   </span><span class="m">10216</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span>e4<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>t2<span class="o">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-6"></a><span class="w">   </span>1021a:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">07</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a4,<span class="w"> </span>-32
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-7"></a><span class="w">   </span>1021e:<span class="w"> </span><span class="m">07</span><span class="w"> </span>e5<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v10,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-8"></a><span class="w">   </span><span class="m">10222</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v11,<span class="w"> </span><span class="o">(</span>a4<span class="o">)</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-9"></a><span class="w">   </span><span class="m">10226</span>:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">85</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v8,<span class="w"> </span>v8,<span class="w"> </span>v10
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-10"></a><span class="w">   </span>1022a:<span class="w"> </span>d7<span class="w"> </span><span class="m">94</span><span class="w"> </span><span class="m">95</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v9,<span class="w"> </span>v9,<span class="w"> </span>v11
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-11"></a><span class="w">   </span>1022e:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">05</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a0,<span class="w"> </span>-32
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-12"></a><span class="w">   </span><span class="m">10232</span>:<span class="w"> </span><span class="m">27</span><span class="w"> </span>e4<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-13"></a><span class="w">   </span><span class="m">10236</span>:<span class="w"> </span>a7<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">05</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>a0<span class="o">)</span>
</span></code></pre></div>
<p>可以看到 llvm 的自动向量化是工作的。此外，也可以编写 rvv intrinsic。</p>

    <nav class="md-post__action">
      <a href="../../software/2022/01/25/rvv-1.0-toolchain/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-12 00:00:00">2022年1月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="jiegech"><a class="toclink" href="../../misc/2022/01/12/deprecating-jiege-ch/">jiege.ch 停用</a></h2>
<p>jiege.ch 域名不再续费，之后一直继续用 jia.je 这个域名。</p>

    <nav class="md-post__action">
      <a href="../../misc/2022/01/12/deprecating-jiege-ch/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-05 00:00:00">2022年1月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rocket-chip-diplomacy"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/">分析 Rocket Chip 中 Diplomacy 系统</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/#_1">概念</a></h3>
<p>Diplomacy 主要实现了两个功能：</p>
<ol>
<li>把整个总线结构在代码中表现出来</li>
<li>自动配置总线中各个端口的参数</li>
</ol>
<p>具体来说，第一点实现了类似 Vivado Board Design 中连线的功能，第二点则是保证总线两端的参数一致，可以连接起来。</p>
<p>Diplomacy 为了表示总线的结构，每个模块可以对应一个 Node，Node 和 Node 之间连接形成一个图。Node 的类型主要有以下几个：</p>
<ol>
<li>Client：对应 AXI 里面的 Master，发起请求</li>
<li>Manager：对应 AXI 里面的 Slave，处理请求</li>
<li>Adapter：对应 AXI Width Converter/Clock Converter/AXI4 to AXI3/AXI4 to AHB bridge 等，会修改 AXI 的参数，然后每个输入对应一个输出</li>
<li>Nexus：对应 AXI Crossbar，多个输入和多个输出</li>
</ol>
<p>每个 Node 可能作为 Manager 连接上游的 Client，这个叫做入边（Inward Edge）；同样地，也可以作为 Client 连接下游的 Manager，这个是出边（Outward Edge）。想象成一个 DAG，从若干个 Client 流向 Manager。</p>
<p>连接方式采用的是 <code>:=</code> <code>:=*</code> <code>:*=</code> <code>:*=*</code> 操作符，左侧是 Client，右侧是 Manager。</p>
<h3 id="rocket-chip"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/#rocket-chip">Rocket Chip 总线结构</a></h3>
<p>Rocket Chip 主要有以下几个总线：</p>
<ol>
<li>sbus: System Bus</li>
<li>mbus: Memory Bus</li>
<li>cbus: Control Bus</li>
<li>pbus: Periphery Bus</li>
<li>fbus: Frontend Bus</li>
</ol>
<p>图示可以见参考文档中的链接，不过链接中的结构和实际的有一些区别。目前的 Rocket Chip 内存结构大致是这样：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/01/05/diplomacy/#__codelineno-0-1"></a>fbus -&gt; sbus -&gt; mbus
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/01/05/diplomacy/#__codelineno-0-2"></a>tile --/    \-&gt; cbus -&gt; pbus
</span></code></pre></div>
<p>主要是 pbus 的位置从连接 sbus 移动到了连接 cbus。</p>
<p>相关代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-1"></a><span class="cm">/** Parameterization of a topology containing three additional, optional buses for attaching MMIO devices. */</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-2"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">HierarchicalBusTopologyParams</span><span class="p">(</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-3"></a><span class="w">  </span><span class="n">pbus</span><span class="p">:</span><span class="w"> </span><span class="nc">PeripheryBusParams</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-4"></a><span class="w">  </span><span class="n">fbus</span><span class="p">:</span><span class="w"> </span><span class="nc">FrontBusParams</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-5"></a><span class="w">  </span><span class="n">cbus</span><span class="p">:</span><span class="w"> </span><span class="nc">PeripheryBusParams</span><span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-6"></a><span class="w">  </span><span class="n">xTypes</span><span class="p">:</span><span class="w"> </span><span class="nc">SubsystemCrossingParams</span><span class="p">,</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-7"></a><span class="w">  </span><span class="n">driveClocksFromSBus</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-8"></a><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">TLBusWrapperTopology</span><span class="p">(</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-9"></a><span class="w">  </span><span class="n">instantiations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-10"></a><span class="w">    </span><span class="p">(</span><span class="nc">PBUS</span><span class="p">,</span><span class="w"> </span><span class="n">pbus</span><span class="p">),</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-11"></a><span class="w">    </span><span class="p">(</span><span class="nc">FBUS</span><span class="p">,</span><span class="w"> </span><span class="n">fbus</span><span class="p">),</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-12"></a><span class="w">    </span><span class="p">(</span><span class="nc">CBUS</span><span class="p">,</span><span class="w"> </span><span class="n">cbus</span><span class="p">)),</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-13"></a><span class="w">  </span><span class="n">connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-14"></a><span class="w">    </span><span class="p">(</span><span class="nc">SBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">CBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">TLBusWrapperConnection</span><span class="w">  </span><span class="p">.</span><span class="n">crossTo</span><span class="p">(</span><span class="n">xTypes</span><span class="p">.</span><span class="n">sbusToCbusXType</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveClocksFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">)),</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-15"></a><span class="w">    </span><span class="p">(</span><span class="nc">CBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">PBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">TLBusWrapperConnection</span><span class="w">  </span><span class="p">.</span><span class="n">crossTo</span><span class="p">(</span><span class="n">xTypes</span><span class="p">.</span><span class="n">cbusToPbusXType</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveClocksFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">)),</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-16"></a><span class="w">    </span><span class="p">(</span><span class="nc">FBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">SBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">TLBusWrapperConnection</span><span class="p">.</span><span class="n">crossFrom</span><span class="p">(</span><span class="n">xTypes</span><span class="p">.</span><span class="n">fbusToSbusXType</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveClocksFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">)))</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-17"></a><span class="p">)</span>
</span></code></pre></div>
<p>当然了，也有简化版的 JustOneBusTopology，那就只有 SystemBus 了。如果再配置了 CoherentBusTopology，那么 SBUS 和 MBUS 之间还有一层 L2:</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-1"></a><span class="cm">/** Parameterization of a topology containing a banked coherence manager and a bus for attaching memory devices. */</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-2"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">CoherentBusTopologyParams</span><span class="p">(</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-3"></a><span class="w">  </span><span class="n">sbus</span><span class="p">:</span><span class="w"> </span><span class="nc">SystemBusParams</span><span class="p">,</span><span class="w"> </span><span class="c1">// TODO remove this after better width propagation</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-4"></a><span class="w">  </span><span class="n">mbus</span><span class="p">:</span><span class="w"> </span><span class="nc">MemoryBusParams</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-5"></a><span class="w">  </span><span class="n">l2</span><span class="p">:</span><span class="w"> </span><span class="nc">BankedL2Params</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-6"></a><span class="w">  </span><span class="n">sbusToMbusXType</span><span class="p">:</span><span class="w"> </span><span class="nc">ClockCrossingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">NoCrossing</span><span class="p">,</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-7"></a><span class="w">  </span><span class="n">driveMBusClockFromSBus</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-8"></a><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">TLBusWrapperTopology</span><span class="p">(</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-9"></a><span class="w">  </span><span class="n">instantiations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l2</span><span class="p">.</span><span class="n">nBanks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nc">Nil</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-10"></a><span class="w">    </span><span class="p">(</span><span class="nc">MBUS</span><span class="p">,</span><span class="w"> </span><span class="n">mbus</span><span class="p">),</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-11"></a><span class="w">    </span><span class="p">(</span><span class="nc">L2</span><span class="p">,</span><span class="w"> </span><span class="nc">CoherenceManagerWrapperParams</span><span class="p">(</span><span class="n">mbus</span><span class="p">.</span><span class="n">blockBytes</span><span class="p">,</span><span class="w"> </span><span class="n">mbus</span><span class="p">.</span><span class="n">beatBytes</span><span class="p">,</span><span class="w"> </span><span class="n">l2</span><span class="p">.</span><span class="n">nBanks</span><span class="p">,</span><span class="w"> </span><span class="nc">L2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">sbus</span><span class="p">.</span><span class="n">dtsFrequency</span><span class="p">)(</span><span class="n">l2</span><span class="p">.</span><span class="n">coherenceManager</span><span class="p">)))),</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-12"></a><span class="w">  </span><span class="n">connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l2</span><span class="p">.</span><span class="n">nBanks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nc">Nil</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-13"></a><span class="w">    </span><span class="p">(</span><span class="nc">SBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">L2</span><span class="p">,</span><span class="w">   </span><span class="nc">TLBusWrapperConnection</span><span class="p">(</span><span class="n">driveClockFromMaster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="n">nodeBinding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BIND_STAR</span><span class="p">)()),</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-14"></a><span class="w">    </span><span class="p">(</span><span class="nc">L2</span><span class="p">,</span><span class="w">  </span><span class="nc">MBUS</span><span class="p">,</span><span class="w">  </span><span class="nc">TLBusWrapperConnection</span><span class="p">.</span><span class="n">crossTo</span><span class="p">(</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-15"></a><span class="w">      </span><span class="n">xType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbusToMbusXType</span><span class="p">,</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-16"></a><span class="w">      </span><span class="n">driveClockFromMaster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveMBusClockFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">,</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-17"></a><span class="w">      </span><span class="n">nodeBinding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BIND_QUERY</span><span class="p">))</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-18"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-19"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/#_2">参考文档</a></h3>
<ul>
<li><a href="https://chipyard.readthedocs.io/en/latest/TileLink-Diplomacy-Reference/index.html">TileLink and Diplomacy Reference</a></li>
<li><a href="https://chipyard.readthedocs.io/en/latest/Generators/Rocket-Chip.html#memory-system">Rocket Chip - Memory System</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2022/01/05/diplomacy/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-03 00:00:00">2022年1月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="chisel3-cookbook"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/">Chisel3 Cookbook</a></h2>
<h3 id="chisel"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#chisel">Chisel 版本选择</a></h3>
<p>尽量选择较新版本的 Chisel。Chisel v3.5 完善了编译器插件，使得生成的代码中会包括更多变量名信息。</p>
<h3 id="verilog"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#verilog">去掉输出 Verilog 文件中的寄存器随机初始化</a></h3>
<p>版本：FIRRTL &gt;= 1.5.0-RC2</p>
<p>代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">&quot;-X&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;verilog&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">s&quot;</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v&quot;</span><span class="p">),</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-5"></a><span class="w">    </span><span class="nc">CustomDefaultRegisterEmission</span><span class="p">(</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-6"></a><span class="w">      </span><span class="n">useInitAsPreset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-7"></a><span class="w">      </span><span class="n">disableRandomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-10"></a><span class="p">)</span>
</span></code></pre></div>
<p>设置 disableRandomization=true 即可。useInitAsPreset 不建议开启。</p>
<h3 id="firrtl-verilog"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#firrtl-verilog">关闭 FIRRTL 优化，输出尽可能与源代码一致的 Verilog</a></h3>
<p>设置 Chisel 生成 MinimumVerilog：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">&quot;-X&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mverilog&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">s&quot;</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v&quot;</span><span class="p">),</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-6"></a><span class="p">)</span>
</span></code></pre></div>
<p>此时代码中会保留更多原始 Chisel 代码的元素。</p>
<h3 id="axi4"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#axi4">重命名 AXI4 为标准命名</a></h3>
<p>Rocket Chip 中 AXI4Bundle 直接生成的名字和标准写法不同，可以利用 Chisel3 3.5.0 的 DataView 功能进行重命名：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-1"></a><span class="c1">// https://www.chisel-lang.org/chisel3/docs/explanations/dataview.html</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-2"></a><span class="c1">// use standard names</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">addrBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">dataBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">idBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-4"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-6"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-7"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-8"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-9"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-10"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-11"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-12"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-13"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-14"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-15"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-17"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-18"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-19"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-20"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">((</span><span class="n">dataBits</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-21"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-22"></a>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-23"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-24"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-25"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-26"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-27"></a>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-28"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-29"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-30"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-31"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-32"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-33"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-34"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-35"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-36"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-37"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-38"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-39"></a>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-40"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-41"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-42"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-43"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-44"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-45"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-46"></a><span class="p">}</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-47"></a>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-48"></a><span class="k">object</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-49"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataView</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">,</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">](</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-50"></a><span class="w">    </span><span class="n">vab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-51"></a><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">(</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-52"></a><span class="w">        </span><span class="nc">AXI4BundleParameters</span><span class="p">(</span><span class="n">vab</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">idBits</span><span class="p">)</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-53"></a><span class="w">      </span><span class="p">),</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-54"></a><span class="w">    </span><span class="c1">// AW</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-55"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-56"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-57"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-58"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-59"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-60"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-61"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-62"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-63"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-64"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-65"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-66"></a><span class="w">    </span><span class="c1">// W</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-67"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-68"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-69"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-70"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">strb</span><span class="p">,</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-71"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span><span class="p">,</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-72"></a><span class="w">    </span><span class="c1">// B</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-73"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-74"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-75"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-76"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-77"></a><span class="w">    </span><span class="c1">// AR</span>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-78"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-79"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-80"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-81"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-82"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-83"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-2-84"><a id="__codelineno-2-84" name="__codelineno-2-84" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-84"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-2-85"><a id="__codelineno-2-85" name="__codelineno-2-85" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-85"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-2-86"><a id="__codelineno-2-86" name="__codelineno-2-86" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-86"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-2-87"><a id="__codelineno-2-87" name="__codelineno-2-87" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-87"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-2-88"><a id="__codelineno-2-88" name="__codelineno-2-88" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-88"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-2-89"><a id="__codelineno-2-89" name="__codelineno-2-89" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-89"></a><span class="w">    </span><span class="c1">// R</span>
</span><span id="__span-2-90"><a id="__codelineno-2-90" name="__codelineno-2-90" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-90"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-91"><a id="__codelineno-2-91" name="__codelineno-2-91" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-91"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-92"><a id="__codelineno-2-92" name="__codelineno-2-92" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-92"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-93"><a id="__codelineno-2-93" name="__codelineno-2-93" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-93"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-2-94"><a id="__codelineno-2-94" name="__codelineno-2-94" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-94"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-2-95"><a id="__codelineno-2-95" name="__codelineno-2-95" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-95"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span>
</span><span id="__span-2-96"><a id="__codelineno-2-96" name="__codelineno-2-96" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-96"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-2-97"><a id="__codelineno-2-97" name="__codelineno-2-97" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-97"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">.</span><span class="n">axiView</span><span class="p">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-2-98"><a id="__codelineno-2-98" name="__codelineno-2-98" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-98"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span>
</span><span id="__span-2-99"><a id="__codelineno-2-99" name="__codelineno-2-99" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-99"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span>
</span><span id="__span-2-100"><a id="__codelineno-2-100" name="__codelineno-2-100" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-100"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span>
</span><span id="__span-2-101"><a id="__codelineno-2-101" name="__codelineno-2-101" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-101"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">idBits</span>
</span><span id="__span-2-102"><a id="__codelineno-2-102" name="__codelineno-2-102" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-102"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-2-103"><a id="__codelineno-2-103" name="__codelineno-2-103" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-103"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-2-104"><a id="__codelineno-2-104" name="__codelineno-2-104" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-104"></a><span class="p">}</span>
</span><span id="__span-2-105"><a id="__codelineno-2-105" name="__codelineno-2-105" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-105"></a>
</span><span id="__span-2-106"><a id="__codelineno-2-106" name="__codelineno-2-106" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-106"></a><span class="c1">// usage</span>
</span><span id="__span-2-107"><a id="__codelineno-2-107" name="__codelineno-2-107" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-107"></a><span class="kd">val</span><span class="w"> </span><span class="nc">MEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
</span><span id="__span-2-108"><a id="__codelineno-2-108" name="__codelineno-2-108" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-108"></a><span class="nc">MEM</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mem_axi4</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">viewAs</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">]</span>
</span></code></pre></div>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#_1">给所有模块添加名称前缀</a></h3>
<p>有些时候，我们希望给所有模块添加一个名称前缀，防止可能出现的冲突。</p>
<p>在 Chisel 3 中，可以使用自定义 FIRRTL Transform 来实现这个功能。这一部分的实现参考了 <a href="https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578">chisel issue #1059</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-3"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">options</span><span class="p">.</span><span class="nc">Dependency</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-4"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">passes</span><span class="p">.</span><span class="nc">PassException</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-5"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">transforms</span><span class="p">.</span><span class="nc">DedupModules</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-7"></a><span class="c1">// adapted from https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-9"></a><span class="cm">/** Specifies a global prefix for all module names. */</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-10"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-12"></a><span class="cm">/** FIRRTL pass to add prefix to module names</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-13"></a><span class="cm">  */</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-14"></a><span class="k">object</span><span class="w"> </span><span class="nc">PrefixModulesPass</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Transform</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">DependencyAPIMigration</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-15"></a><span class="w">  </span><span class="c1">// we run after deduplication to save some work</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-16"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">prerequisites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">[</span><span class="nc">DedupModules</span><span class="p">])</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-18"></a><span class="w">  </span><span class="c1">// we do not invalidate the results of any prior passes</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-19"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">invalidates</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Transform</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-20"></a>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-21"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">protected</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nc">CircuitState</span><span class="p">):</span><span class="w"> </span><span class="nc">CircuitState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-22"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">prefixes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-23"></a><span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">prefix</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-24"></a><span class="w">    </span><span class="p">}.</span><span class="n">distinct</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-25"></a><span class="w">    </span><span class="n">prefixes</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-26"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-27"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;[PrefixModulesPass] No ModulePrefix annotation found.&quot;</span><span class="p">)</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-28"></a><span class="w">        </span><span class="n">state</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-29"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">state</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-30"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-31"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">circuit</span><span class="p">.</span><span class="n">mapModule</span><span class="p">(</span><span class="n">onModule</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-32"></a><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">main</span><span class="p">))</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-33"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-34"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PassException</span><span class="p">(</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-35"></a><span class="w">          </span><span class="s">s&quot;[PrefixModulesPass] found more than one prefix annotation: </span><span class="si">$</span><span class="n">other</span><span class="s">&quot;</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-36"></a><span class="w">        </span><span class="p">)</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-38"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-39"></a>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-40"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onModule</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-41"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-42"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">ExtModule</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-43"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">mod</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Module</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-44"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">name</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-45"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onStmt</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-46"></a><span class="w">        </span><span class="n">mod</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-48"></a>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-49"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onStmt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-50"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefInstance</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">module</span><span class="p">)</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-51"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w">             </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">mapStmt</span><span class="p">(</span><span class="n">onStmt</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-52"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-53"></a><span class="p">}</span>
</span></code></pre></div>
<p>实现思路就是遍历 IR，找到所有的 Module 并改名，再把所有模块例化也做一次替换。最后在生成 Verilog 的时候添加 Annotation 即可：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">s&quot;</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v&quot;</span><span class="p">),</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-5"></a><span class="w">    </span><span class="nc">RunFirrtlTransformAnnotation</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">(</span><span class="nc">PrefixModulesPass</span><span class="p">)),</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-6"></a><span class="w">    </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-7"></a><span class="w">  </span><span class="p">)</span>
</span></code></pre></div>
<p>如果使用新的 MLIR FIRRTL Compiler，则可以利用 <code>sifive.enterprise.firrtl.NestedPrefixModulesAnnotation</code> annotation，让 firtool 来进行 <a href="https://github.com/llvm/circt/blob/fc6b00fd20d8a50f17a908cc681c8cf3a4d1c000/lib/Dialect/FIRRTL/Transforms/PrefixModules.cpp">prefix 操作</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-1"></a><span class="k">package</span><span class="w"> </span><span class="n">sifive</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-2"></a><span class="w">  </span><span class="k">package</span><span class="w"> </span><span class="n">enterprise</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-3"></a><span class="w">    </span><span class="k">package</span><span class="w"> </span><span class="n">firrtl</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-4"></a><span class="w">      </span><span class="k">import</span><span class="w"> </span><span class="nn">_root_</span><span class="p">.</span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-6"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-7"></a><span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">target</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">,</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-8"></a><span class="w">          </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-9"></a><span class="w">          </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-10"></a><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SingleTargetAnnotation</span><span class="p">[</span><span class="nc">Target</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-11"></a>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-12"></a><span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">duplicate</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">):</span><span class="w"> </span><span class="nc">Annotation</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-13"></a><span class="w">          </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-14"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-17"></a><span class="p">}</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-19"></a><span class="k">object</span><span class="w"> </span><span class="nc">AddPrefix</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-20"></a><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="nc">Module</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-21"></a><span class="w">    </span><span class="n">annotate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">ChiselAnnotation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-22"></a><span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">toFirrtl</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-23"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">toTarget</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-24"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-25"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个方法的灵感来自 @sequencer。唯一的缺点就是比较 Hack，建议 SiFive 把相关的类也开源出来用。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2022/01/03/chisel3-cookbook/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-03 00:00:00">2022年1月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linksys-e8450-openwrt-ubi"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/">升级 Linksys E8450 的 OpenWRT 系统到 UBI</a></h2>
<h3 id="_1"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#_1">背景</a></h3>
<p>在 <a href="https://openwrt.org/toh/linksys/e8450">OpenWRT Linksys E8450 页面</a> 中，如果要用新版的固件，需要转换到 UBI 格式的文件系统。之前用的是 non-UBI 格式的文件系统，直接在官方的分区下，覆盖掉其中一个启动分区。但是经常会报告 flash 出错，然后系统也不稳定，决定要按照文档更新到 UBI。</p>
<h3 id="_2"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#_2">步骤</a></h3>
<p>请注意：更换文件系统操作比较危险，请先备份好数据，并做好变砖的心理准备。本文仅记录了作者编写时可行的更新操作，不代表读者在阅读时，依然可以按照这个顺序进行，请按照 <a href="https://github.com/dangowrt/owrt-ubi-installer">https://github.com/dangowrt/owrt-ubi-installer</a> 的文档进行操作。</p>
<p>基本按照文档一步一步走。初始状态是一个 non-UBI 版本的 OpenWRT 固件：</p>
<ol>
<li>下载官方的 1.0 固件：https://downloads.linksys.com/support/assets/firmware/FW_E8450_1.0.01.101415_prod.img</li>
<li>在 luci 中，刷入官方 1.0 固件，这时候进入了官方固件的系统</li>
<li>登录官方固件网页，恢复出厂设置</li>
<li>下载 openwrt ubi recovery <a href="https://github.com/dangowrt/linksys-e8450-openwrt-installer/releases/download/v0.6.1/openwrt-mediatek-mt7622-linksys_e8450-ubi-initramfs-recovery-installer.itb">固件</a> 然后在官方固件里刷入</li>
<li>这时候进入了 recovery 固件，下载 <a href="https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">ubi 固件</a>，继续在网页里刷入</li>
<li>这时候固件就更新完成了。ssh root@192.168.1.1，然后进去安装 luci 等软件，恢复配置即可。</li>
</ol>

    <nav class="md-post__action">
      <a href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../2023/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2023" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                2023
              </div>
            </div>
          </a>
        
        
          
          <a href="../2021/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2021" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2021
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
        
      
    
  <script>window.addEventListener('load', function() {WaveDrom.ProcessAll();});</script></body>
</html>