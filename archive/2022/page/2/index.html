
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维，编程，调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/archive/2022/page/2/">
      
      
        <link rel="prev" href="../../../2023/">
      
      
        <link rel="next" href="../../../2021/">
      
      
        
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>2022 - 杰哥的{运维，编程，调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/main.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3109FRSVTT');
</script>

<script
    src="https://analytics.jiege.pro/api/script.js"
    data-site-id="1"
    defer
></script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="2022 - 杰哥的{运维，编程，调板子}小笔记" />
<meta property="og:description" content="杰哥的{运维，编程，调板子}小笔记" />
<meta property="og:image" content="https://jia.je/assets/images/social/archive/2022/page/2.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://jia.je/archive/2022/page/2/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="2022 - 杰哥的{运维，编程，调板子}小笔记" />
<meta property="twitter:description" content="杰哥的{运维，编程，调板子}小笔记" />
<meta property="twitter:image" content="https://jia.je/assets/images/social/archive/2022/page/2.png" />
</head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2022" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维，编程，调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2022
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../about/" class="md-tabs__link">
        
  
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../open-source-contributions/" class="md-tabs__link">
        
  
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tags/" class="md-tabs__link">
        
  
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="/cpu/" class="md-tabs__link">
        
  
  
    
  
  CPU

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="/ctf-writeups/" class="md-tabs__link">
        
  
  
    
  
  CTF

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../series/" class="md-tabs__link">
        
  
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../projects/" class="md-tabs__link">
        
  
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tools/" class="md-tabs__link">
        
  
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../benchmark/" class="md-tabs__link">
        
  
  
    
  
  SPEC

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../2026/" class="md-tabs__link">
          
  
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../category/crypto/" class="md-tabs__link">
          
  
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    杰哥的{运维，编程，调板子}小笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    博客
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    关于
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../open-source-contributions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    开源
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    标签
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    知识库
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/cpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CPU
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/ctf-writeups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CTF
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    系列
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    工具
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    订阅
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SPEC
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" checked>
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    归档
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    归档
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2026/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2026
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2024
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tilelink-总线协议分析" class="md-nav__link">
    <span class="md-ellipsis">
      
        TileLink 总线协议分析
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nuc11-esxi-中-igpu-直通虚拟机" class="md-nav__link">
    <span class="md-ellipsis">
      
        NUC11 ESXi 中 iGPU 直通虚拟机
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loongarch64-工具链构建" class="md-nav__link">
    <span class="md-ellipsis">
      
        LoongArch64 工具链构建
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#试用沁恒-ch32v307-评估板" class="md-nav__link">
    <span class="md-ellipsis">
      
        试用沁恒 CH32V307 评估板
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#导出-vivado-下载-bitstream-的-svf-文件" class="md-nav__link">
    <span class="md-ellipsis">
      
        导出 Vivado 下载 Bitstream 的 SVF 文件
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#浅谈乱序执行-cpu二访存" class="md-nav__link">
    <span class="md-ellipsis">
      
        浅谈乱序执行 CPU（二：访存）
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#用-sv2vyosys-把-fpnew-转为-verilog-网表" class="md-nav__link">
    <span class="md-ellipsis">
      
        用 sv2v+yosys 把 fpnew 转为 verilog 网表
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synopsys-design-compiler-综合实践" class="md-nav__link">
    <span class="md-ellipsis">
      
        Synopsys Design Compiler 综合实践
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openroad-flow-初尝试" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenROAD Flow 初尝试
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#通过-jtag-对-vcu128-上的-rocket-chip-进行调试" class="md-nav__link">
    <span class="md-ellipsis">
      
        通过 JTAG 对 VCU128 上的 Rocket Chip 进行调试
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#解决-k3s-中-traefik-不会转发-x-forwarded-for-等头部的问题" class="md-nav__link">
    <span class="md-ellipsis">
      
        解决 k3s 中 traefik 不会转发 X-Forwarded-For 等头部的问题
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-m1-上运行-windows-arm-虚拟机" class="md-nav__link">
    <span class="md-ellipsis">
      
        在 M1 上运行 Windows ARM 虚拟机
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-vector-10-工具链构建" class="md-nav__link">
    <span class="md-ellipsis">
      
        RISC-V Vector 1.0 工具链构建
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jiegech-停用" class="md-nav__link">
    <span class="md-ellipsis">
      
        jiege.ch 停用
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#分析-diplomacy-系统" class="md-nav__link">
    <span class="md-ellipsis">
      
        分析 Diplomacy 系统
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chisel3-cookbook" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chisel3 Cookbook
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#升级-linksys-e8450-的-openwrt-系统到-ubi" class="md-nav__link">
    <span class="md-ellipsis">
      
        升级 Linksys E8450 的 OpenWRT 系统到 UBI
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2018/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2018
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2017/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2017
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2016/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2016
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2014/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2014
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    分类
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            
  
    分类
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/crypto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    crypto
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/csdn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    csdn
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/ctf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ctf
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    devops
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/hardware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    hardware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/meta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    meta
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/networking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/os/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    os
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/others/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    others
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/programming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    software
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    system
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2022">2022<a class="headerlink" href="#2022" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-09 00:00:00+00:00">2022年5月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tilelink-总线协议分析"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/">TileLink 总线协议分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#背景">背景</a></h3>
<p>最近在研究一些支持缓存一致性的缓存的实现，比如 rocket-chip 的实现和 sifive 的实现，因此需要研究一些 TileLink 协议。本文讨论的时候默认读者具有一定的 AXI 知识，因此很多内容会直接参考 AXI。</p>
<h3 id="信号"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#信号">信号</a></h3>
<p>根据 <a href="https://github.com/chipsalliance/omnixtend/blob/master/OmniXtend-1.0.3/spec/TileLink-1.8.0.pdf">TileLink Spec 1.8.0</a>，TileLink 分为以下三种：</p>
<ul>
<li>TL-UL: 只支持读写，不支持 burst，类比 AXI-Lite</li>
<li>TL-UH：支持读写，原子指令，预取，支持 burst，类比 AXI+ATOP（AXI5 引入的原子操作）</li>
<li>TL-C：在 TL-UH 基础上支持缓存一致性协议，类比 AXI+ACE/CHI</li>
</ul>
<h3 id="tilelink-uncached"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#tilelink-uncached">TileLink Uncached</a></h3>
<p>TileLink Uncached(TL-UL 和 TL-UH) 包括了两个 channel：</p>
<ul>
<li>A channel: M-&gt;S 发送请求，类比 AXI 的 AR/AW/W</li>
<li>D channel: S-&gt;M 发送响应，类比 AXI 的 R/B</li>
</ul>
<p>因此 TileLink 每个周期只能发送读或者写的请求，而 AXI 可以同时在 AR 和 AW channel 上发送请求。</p>
<p>一些请求的例子：</p>
<ul>
<li>读：M-&gt;S 在 A channel 上发送 Get，S-&gt;M 在 D channel 上发送 AccessAckData</li>
<li>写：M-&gt;S 在 A channel 上发送 PutFullData/PutPartialData，S-&gt;M 在 D channel 是发送 AccessAck</li>
<li>原子操作：M-&gt;S 在 A channel 上发送 ArithmeticData/LogicalData，S-&gt;M 在 D channel 上发送 AccessAckData</li>
<li>预取操作：M-&gt;S 在 A channel 上发送 Intent，S-&gt;M 在 D channel 上发送 AccessAck</li>
</ul>
<h3 id="axi4totl"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#axi4totl">AXI4ToTL</a></h3>
<p>针对 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L59">AXI4ToTL</a> 模块的例子，来分析一下如何把一个 AXI4 Master 转换为 TileLink。</p>
<p>首先考虑一下 AXI4 和 TileLink 的区别：一个是读写 channel 合并了，所以这里需要一个 Arbiter；其次 AXI4 中 AW 和 W 是分开的，这里也需要进行合并。这个模块并不考虑 Burst 的情况，而是由 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/Fragmenter.scala#L14=">AXI4Fragmenter</a> 来进行拆分，即添加若干个 AW beat，和 W 进行配对。</p>
<p>具体到代码实现上，首先把 AR channel <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L86=">对应到</a> 到 A channel 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">r_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">r_out</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">r_out</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:&lt;=</span><span class="w"> </span><span class="n">edgeOut</span><span class="p">.</span><span class="nc">Get</span><span class="p">(</span><span class="n">r_id</span><span class="p">,</span><span class="w"> </span><span class="n">r_addr</span><span class="p">,</span><span class="w"> </span><span class="n">r_size</span><span class="p">).</span><span class="n">_2</span>
</span></code></pre></div>
<p>然后 AW+W channel 也<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L119=">连接</a> 到 A channel，由于不用考虑 burst 的情况，这里在 aw 和 w 同时 valid 的时候才认为有请求。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">w_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">w_out</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">ready</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">w_out</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">w_out</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">w_out</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:&lt;=</span><span class="w"> </span><span class="n">edgeOut</span><span class="p">.</span><span class="nc">Put</span><span class="p">(</span><span class="n">w_id</span><span class="p">,</span><span class="w"> </span><span class="n">w_addr</span><span class="p">,</span><span class="w"> </span><span class="n">w_size</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">strb</span><span class="p">).</span><span class="n">_2</span>
</span></code></pre></div>
<p>比较有意思的是读写的 id 增加了若干位，最低位 0 表示读，1 表示写，剩下几位是请求编号，这样发出去的是不同 id 的多个请求。</p>
<p>然后，把读和写的 A channel <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L155=">连接</a>到 Arbiter 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nc">TLArbiter</span><span class="p">(</span><span class="nc">TLArbiter</span><span class="p">.</span><span class="n">roundRobin</span><span class="p">)(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">r_out</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">w_out</span><span class="p">))</span>
</span></code></pre></div>
<p>其余的部分则是对 D channel 进行判断，有数据的转给 R channel，没有数据的转给 B channel：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">d_hasData</span><span class="p">,</span><span class="w"> </span><span class="n">ok_r</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">ok_b</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">ok_r</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">d_hasData</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">ok_b</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">d_hasData</span>
</span></code></pre></div>
<p>最后处理了一下 TileLink 和 AXI4 对写请求返回确认的区别：TileLink 中，可以在第一个 burst beat 就返回确认，而 AXI4 需要在最后一个 burst beat 之后返回确认。</p>
<h3 id="tltoaxi4"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#tltoaxi4">TLToAXI4</a></h3>
<p>再来看一下反过来的转换，从 TileLink Master 到 AXI。由于 TileLink 同时只能进行读或者写，所以它首先做了一个虚构的 arw channel，可以理解为合并了 ar 和 aw channel 的 AXI4，这个设计在 SpinalHDL 的代码中也能看到。然后再根据是否是写入，分别<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L153=">连接</a>到 ar 和 aw channel：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">queue_arw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Queue</span><span class="p">.</span><span class="n">irrevocable</span><span class="p">(</span><span class="n">out_arw</span><span class="p">,</span><span class="w"> </span><span class="n">entries</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="n">flow</span><span class="o">=</span><span class="n">combinational</span><span class="p">)</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">queue_arw</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span></code></pre></div>
<p><a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L197=">这里</a>处理了 aw 和 w 的 valid 信号：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">a_isPut</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">doneAW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">out_w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">out_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">a_isPut</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">doneAW</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">out_w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="nc">Bool</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">out_w</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">a_isPut</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">doneAW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span></code></pre></div>
<p>这样做的原因是，在 TileLink 中，每个 burst 都是一个 a channel 上的请求，而 AXI4 中，只有第一个 burst 有 aw 请求，所有 burst 都有 w 请求，因此这里用 doneAW 信号来进行区分。</p>
<p>接着，要把 b 和 r channel 上的结果连接到 d channel，根据上面的经验，<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L205=">这里</a> 又是一个 arbitration：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">r_wins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">b_delay</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">r_holds_d</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r_wins</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">out</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r_wins</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">r_wins</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
</span></code></pre></div>
<p>最后还处理了一下请求和结果顺序的问题。</p>
<h3 id="tilelink-cached"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#tilelink-cached">TileLink Cached</a></h3>
<p>上面说的两个模块都是 TileLink Uncached，那么它如何支持缓存一致性呢？首先，它引入了三个 channel：B、C 和 E，支持三种操作：</p>
<ul>
<li>Acquire：M-&gt;S 在 A channel 上发送 Acquire，S-&gt;M 在 D channel 上发送 Grant，然后 M-&gt;S 在 E channel 上发送 GrantAck；功能是获取一个 copy，可以看到这个和 Get 是类似的，都是在 A channel 上发送请求，在 D channel 上接受响应，只不过额外需要在 E channel 上发送 GrantAck。</li>
<li>Release：M-&gt;S 在 C channel 上发送 Release/ReleaseData，S-&gt;M 在 D channel 上发送 ReleaseAck；功能是删除自己的 copy，一般是缓存行要被换出的时候，如果要写回 Dirty 数据，就用 ReleaseData，否则用 Release</li>
<li>Probe：S-&gt;M 在 B channel 上发送 Probe，M-&gt;S 在 C channel 上发送 ProbeAck；功能是要求 M 删除自己的 copy，通常是有某一个缓存发送了 Acquire，导致其他缓存需要降低权限</li>
</ul>
<p>可以看到，A C E 三个 channel 是 M-&gt;S，B D 两个 channel 是 S-&gt;M。</p>
<p>假如一个缓存（Master A）要写入一块只读数据，或者读取一块 miss 的缓存行，如果是广播式的缓存一致性协议，那么需要经历如下的过程：</p>
<ul>
<li>Master A -&gt; Slave: Acquire</li>
<li>Slave -&gt; Master B: Probe</li>
<li>Master B -&gt; Slave: ProbeAck</li>
<li>Slave -&gt; Master A: Grant</li>
<li>Master A -&gt; Slave: GrantAck</li>
</ul>
<p>首先 Master A 发出 Acquire 请求，然后 Slave 向其他 Master 广播 Probe，等到其他 Master 返回 ProbeAck 后，再向 Master A 返回 Grant，最后 Master A 发送 GrantAck 给 Slave。这样 Master A 就获得了这个缓存行的一份拷贝，并且让 Master B 的缓存行失效或者状态变成只读。</p>
<p>TileLink 的缓存行有三个状态：None，Branch 和 Trunk(Tip)。基本对应 MSI 模型：None-&gt;Invalid，Branch-&gt;Shared 和 Trunk-&gt;Modified。Rocket Chip 代码中 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Metadata.scala#L10=">ClientStates</a> 还定义了 Dirty 状态，大致对应 MESI 模型：None-&gt;Invalid，Branch-&gt;Shared，Trunk-&gt;Exclusive，Dirty-&gt;Modified。</p>
<p>此外，标准还说可以在 B 和 C channel 上进行 TL-UH 的操作。标准这么设计的意图是可以让 Slave 转发操作到拥有缓存数据的 Master 上。比如 Master A 在 A channel 上发送 Put 请求，那么 Slave 向 Master B 的 B channel 上发送 Put 请求，Master B 在 C channel 上发送 AccessAck 响应，Slave 再把响应转回 Master A 的 D channel。这就像是一个片上的网络，Slave 负责在 Master 之间路由请求。</p>
<h3 id="broadcast"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#broadcast">Broadcast</a></h3>
<p>接下来看看 Rocket Chip 自带的基于广播的缓存一致性协议实现。核心实现是 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala">TLBroadcast</a>，核心的逻辑就是，如果一个 Master A 发送了 Acquire，那么 TLBroadcast 需要发送 Probe 到其他的 Master，当其他的 Master 都响应了 ProbeAck 后，再返回 Grant 到 Master A。</p>
<p>首先来看 B channel 上的 Probe <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L214=">逻辑</a>。它记录了一个 todo bitmask，表示哪些 Master 需要发送 Probe，这里采用了 Probe Filter 来减少发送 Probe 的次数，因为只需要向拥有这个缓存行的 Master 发送 Probe：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">())</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_perms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">leftOR</span><span class="p">(</span><span class="n">probe_todo</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_busy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_todo</span><span class="p">.</span><span class="n">orR</span><span class="p">()</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">Mux1H</span><span class="p">(</span><span class="n">probe_next</span><span class="p">,</span><span class="w"> </span><span class="n">cache_targets</span><span class="p">)</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1">// Probe whatever the FSM wants to do next</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">probe_busy</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">edgeIn</span><span class="p">.</span><span class="nc">Probe</span><span class="p">(</span><span class="n">probe_line</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">lineShift</span><span class="p">,</span><span class="w"> </span><span class="n">probe_target</span><span class="p">,</span><span class="w"> </span><span class="n">lineShift</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">probe_perms</span><span class="p">).</span><span class="n">_2</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="p">}</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">fire</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">probe_next</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>这里 <code>probe_next</code> 就是被 probe 的那个 Master 对应的 bitmask，<code>probe_target</code> 就是 Master 的 Id。这个 Probe FSM 的输入就是 Probe Filter，它会<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L256=">给出</a>哪些 Cache 拥有当前的缓存行的信息：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">leaveB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">needT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">gaveT</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">others</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cacheOH</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">allocOH</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">leaveB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">others</span><span class="p">)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">probe_busy</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">fire</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="n">probe_todo</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">todo</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="n">probe_line</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">lineShift</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="n">probe_perms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">needT</span><span class="p">,</span><span class="w"> </span><span class="nc">TLPermissions</span><span class="p">.</span><span class="n">toN</span><span class="p">,</span><span class="w"> </span><span class="nc">TLPermissions</span><span class="p">.</span><span class="n">toB</span><span class="p">)</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里又区分两种情况：如果 Acquire 需要进入 Trunk 状态（比如是个写入操作），意味着其他 Master 需要进入 None 状态，所以这里要发送 toN；如果 Acquire 不需要进入 Trunk 状态（比如是个读取操作），那么只需要其他 Master 进入 Branch 状态，所以这里要发送 toB。</p>
<p>在 B channel 发送 Probe 的同时，也要<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L152=">处理</a> C channel 上的 ProbeAck 和 ProbeAckData：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">// Incoming C can be:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="c1">// ProbeAck     =&gt; decrement tracker, drop </span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c1">// ProbeAckData =&gt; decrement tracker, send out A as PutFull(DROP)</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1">// ReleaseData  =&gt;                    send out A as PutFull(TRANSFORM)</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1">// Release      =&gt; send out D as ReleaseAck</span>
</span></code></pre></div>
<p>由于这里采用的是 invalidation based，所以如果某个 Master 之前处于 Dirty 状态，那么它会发送 ProbeAckData，此时需要把数据写回，所以需要用 PutFull 把数据写出去。</p>
<h3 id="serialization"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#serialization">Serialization</a></h3>
<p>下面来讨论一下 TileLink 对各组信号的一些要求。</p>
<h4 id="flow-control-rules"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#flow-control-rules">Flow Control Rules</a></h4>
<p>首先是 Flow Control Rules，讨论的是 ready 和 valid 信号的关系，目的是防止死锁。首先是两个比较常规的要求：</p>
<ul>
<li>If ready is LOW, the receiver must not process the beat and the sender must not consider the beat processed.</li>
<li>If valid is LOW, the receiver must not expect the control or data signals to be a syntactically correct TileLink beat.</li>
</ul>
<p>第一个说的就是 valid &amp; ready 的时候才认为是一个 beat 处理了，第二个就是如果 valid=LOW，那么信号可能是随机的、不合法的。</p>
<ul>
<li>valid must never depend on ready. If a sender wishes to send a beat, it must assert valid independently of whether the receiver signals that it is ready.</li>
<li>As a consequence, there must be no combinational path from ready to valid or any of the control and data signals.</li>
</ul>
<p>这里是为了防止组合逻辑出现环路，如果 valid 依赖 ready，ready 依赖 valid，就会出现问题，所以这里规定，valid 不能依赖 ready，反过来只能 ready 依赖 valid。类似地，其他的数据和控制信号也不可以依赖 ready。简单理解就是 sender 要主动提供数据，而 receiver 决定了是否接受。</p>
<ul>
<li>A low priority valid may not combinationally depend on a high priority valid. In other words, the decision to send a request may not be based on receiving a response in the same cycle.</li>
<li>A high priority ready may not combinationally depend on a low priority ready. In other words, acceptance of a response may not be made contingent upon a request being accepted the same cycle.</li>
</ul>
<p>这两条的意思是，同一个周期内，我设置发送的请求的 valid，不能依赖于同一个周期内接受到的响应的 valid，比如 A 的 valid 不能组合依赖于 D 的 valid。另一方面，我设置的响应的 ready 不能依赖于同一个周期内的请求，比如 D 的 ready 不能组和依赖于 A 的 ready。</p>
<p>那么，有这么几种用法是可以的：</p>
<ul>
<li>It is acceptable for a receiver to drive ready in response to valid or any of the control and data signals. For example, an arbiter may lower ready if a valid request is made for an address which is busy. However, whenever possible, it is recommended that ready be driven independently so as to reduce the handshaking circuit depth. 接收方可以让 ready 依赖于 valid 或者其他的控制和数据信号，不过这样会让组合逻辑比较长。</li>
<li>A channel may change valid and all control and data signals based on the value of ready in the prior cycle. For example, after a request has been accepted (ready HIGH), a new request may be presented. Only a same-cycle dependency of valid on ready is forbidden. 可以让当前周期的 valid 依赖于上一个周期的 ready 信号，只是不能有同周期的 valid 对 ready 的依赖。</li>
<li>A device may legally drive valid for a response based on valid of a request in the same cycle. For example, a combinational ROM which answers immediately. In this case, presumably ready for the request will likewise be driven by ready for the response. The converse relationship is forbidden. 设备可以让响应的 valid 依赖请求的 valid，比如一个组合的 ROM，它的 D channel 的 valid 可以组合依赖于 A channel 的 valid，同时 A channel 的 ready 组合依赖于 D channel 的 ready。这样就简化了设备的设计，并且可以无延迟地进行访问。</li>
</ul>
<p>和 AXI 不同的一点在于，TileLink 不要求 irrevocable，也就是说如果一个周期内 valid=HIGH 但是 ready=LOW，那么下一个周期 Master 可以修改控制和数据信号，也可以让 valid=LOW。</p>
<div class="language-text highlight"><pre><span></span><code>Note that a sender may raise valid and then lower it on the following
cycle, even if the message was not accepted on the previous cycle. For example,
the sender might have some other higher priority task to perform on the
following cycle, instead of trying to send the rejected message again.
Furthermore, the sender may change the contents of the control and data signals
when a message was not accepted.
</code></pre></div>
<p>TileLink 的 burst 请求是通过比 bus 更宽的 size 的多个 beat 组成的。一旦第一个 beat fire 了，后续只能发送同一个 burst 的数据，不可以交错。</p>
<h4 id="request-response-message-ordering"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#request-response-message-ordering">Request-Response Message Ordering</a></h4>
<p>这里讨论的是请求和响应的顺序关系。TileLink 规定，响应的第一个 beat 不早于第一个请求的 beat，比如：</p>
<ul>
<li>对于 Get 请求，如果响应需要多个 beat，那么第一个 beat 不早于请求的那一个周期，这个比较常规，意思是可以组合返回响应。</li>
<li>对于 Put 请求，如果请求需要多个 beat，那么响应可以在第一个请求的 beat 的周期，这个比较特别，意思是对于多个 beat 的请求，可以立即返回响应，不需要等到所有请求的 beat 完成。</li>
<li>对于 ArithmeticData 请求，响应和请求都可能有多个 beat，那么响应的第一个 beat 不早于请求的第一个 beat 即可，其他没有顺序要求。</li>
</ul>
<h4 id="deadlock-freedom"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#deadlock-freedom">Deadlock Freedom</a></h4>
<p>那么多规则，一个很重要的目的是要防止死锁。为了防止死锁，有这样三条：</p>
<ol>
<li>The agent graph (Section 5.3) contains no cycles</li>
<li>Agents must eventually present all beats of a received message</li>
<li>Unless they have a higher priority message in flight or unanswered<ol>
<li>Agents must eventually accept a presented beat</li>
<li>Agents must eventually answer a received request message</li>
</ol>
</li>
</ol>
<p>大概意思是，beat 不能无限推迟，无论是发送方还是接受方。对于每个请求，它的响应不能无限推迟。</p>
<p>TileLink 定义了各个 channel 的优先级，从低到高是 <code>A&lt;B&lt;C&lt;D&lt;E</code>。对于同一个 channel，A C E 上是 master/sender 优先级更高，B D 上是 slave/receiver 优先级更高。</p>
<p>TileLink 的设计里保证了，每个请求的响应都比请求优先级更高。比如 A channel 的请求（Get/Put/AcquireBlock）的响应在 D channel（AccessAckData/AccessAck/Grant），B channel 的请求（Probe）的响应在 C channel（ProbeAck），C channel 的请求（Release）的响应在 D channel（ReleaseAck），D channel 的请求（Grant）的响应在 E channel（GrantAck）。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2022/05/09/tilelink/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://github.com/chipsalliance/omnixtend/blob/master/OmniXtend-1.0.3/spec/TileLink-1.8.0.pdf">TileLink spec</a></li>
<li><a href="https://github.com/chipsalliance/rocket-chip">rocket-chip</a></li>
</ul>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-05 00:00:00+00:00">2022年5月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nuc11-esxi-中-igpu-直通虚拟机"><a class="toclink" href="../../../../system/2022/05/05/nuc11-igpu-passthrough/">NUC11 ESXi 中 iGPU 直通虚拟机</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../system/2022/05/05/nuc11-igpu-passthrough/#背景">背景</a></h3>
<p>之前在 NUC11PAKi5 上装了 ESXI 加几个虚拟机系统，但是自带的 iGPU Intel Iris Xe Graphics(Tiger Lake GT-2) 没用上，感觉有些浪费。因此想要给 Windows 直通。在直通到 Windows 后发现会无限重启，最后直通到 Linux 中。</p>
<h3 id="步骤"><a class="toclink" href="../../../../system/2022/05/05/nuc11-igpu-passthrough/#步骤">步骤</a></h3>
<p>第一步是到 esxi 的设备设置的地方，把 iGPU 的 Passthrough 打开，这时候会提示需要重启，但是如果重启，会发现还是处于 Needs reboot 状态。网上进行搜索，发现是 ESXi 自己占用了 iGPU 的输出，<a href="https://williamlam.com/2020/06/passthrough-of-integrated-gpu-igpu-for-standard-intel-nuc.html">解决方法</a>如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>system<span class="w"> </span>settings<span class="w"> </span>kernel<span class="w"> </span><span class="nb">set</span><span class="w"> </span>-s<span class="w"> </span>vga<span class="w"> </span>-v<span class="w"> </span>FALSE
</span></code></pre></div>
<p>这样设置以后就不会在显卡输出上显示 dcui 了，这是一个比较大的缺点，但是平时也不用自带的显示输出，就无所谓了。</p>
<p>第二步，重启以后，这时候看设备状态就是 Active。回到 Windows 虚拟机，添加 PCI device，然后启动。这时候，我遇到了这样的错误：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>Module ‘DevicePowerOn’ power on failed
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Failed to register the device pciPassthru0
</span></code></pre></div>
<p>搜索了一番，<a href="https://shuttletitan.com/vsphere/pci-passthrough-module-devicepoweron-power-on-failed/">解决方法</a>是关掉 IOMMU。在虚拟机设计中关掉 IOMMU，就可以正常启动了。</p>
<p>第三步，进入 Windows，这时候就可以看到有一个新的未知设备了，VID=8086，PID=9a49；等待一段时间，Windows 自动安装好了驱动，就可以正常识别了。GPU-Z 中可以看到效果如下：</p>
<p><img alt="" src="../../../../system/igpu-passthrough.png" /></p>
<p>不过关机重启的时候会蓝屏，可能还有一些问题，有人在<a href="https://community.intel.com/t5/Graphics/SR-IOV-support-for-intel-Iris-Xe-Graphics-on-i7-1165G7/td-p/1293264">论坛</a>上也说 passthrough 之后会蓝屏。这个问题一直没有解决。</p>
<p>再尝试 Passthrough 到 Linux：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>i915
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.173500<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>enabling<span class="w"> </span>device<span class="w"> </span><span class="o">(</span><span class="m">0000</span><span class="w"> </span>-&gt;<span class="w"> </span><span class="m">0003</span><span class="o">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.180137<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>VT-d<span class="w"> </span>active<span class="w"> </span><span class="k">for</span><span class="w"> </span>gfx<span class="w"> </span>access
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182109<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>BAR<span class="w"> </span><span class="m">6</span>:<span class="w"> </span>can<span class="err">&#39;</span>t<span class="w"> </span>assign<span class="w"> </span><span class="o">[</span>???<span class="w"> </span>0x00000000<span class="w"> </span>flags<span class="w"> </span>0x20000000<span class="o">]</span><span class="w"> </span><span class="o">(</span>bogus<span class="w"> </span>alignment<span class="o">)</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182110<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>VBIOS<span class="w"> </span>tables<span class="w"> </span><span class="o">(</span>VBT<span class="o">)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182541<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>vgaarb:<span class="w"> </span>changed<span class="w"> </span>VGA<span class="w"> </span>decodes:<span class="w"> </span><span class="nv">olddecodes</span><span class="o">=</span>io+mem,decodes<span class="o">=</span>none:owns<span class="o">=</span>none
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.197374<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>firmware:<span class="w"> </span>direct-loading<span class="w"> </span>firmware<span class="w"> </span>i915/tgl_dmc_ver2_08.bin
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.198037<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Finished<span class="w"> </span>loading<span class="w"> </span>DMC<span class="w"> </span>firmware<span class="w"> </span>i915/tgl_dmc_ver2_08.bin<span class="w"> </span><span class="o">(</span>v2.8<span class="o">)</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.401676<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>retrieve<span class="w"> </span>link<span class="w"> </span>info,<span class="w"> </span>disabling<span class="w"> </span>eDP
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.515822<span class="o">]</span><span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Initialized<span class="w"> </span>i915<span class="w"> </span><span class="m">1</span>.6.0<span class="w"> </span><span class="m">20200917</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">0000</span>:13:00.0<span class="w"> </span>on<span class="w"> </span>minor<span class="w"> </span><span class="m">0</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.516054<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Cannot<span class="w"> </span>find<span class="w"> </span>any<span class="w"> </span>crtc<span class="w"> </span>or<span class="w"> </span>sizes
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.516144<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Cannot<span class="w"> </span>find<span class="w"> </span>any<span class="w"> </span>crtc<span class="w"> </span>or<span class="w"> </span>sizes
</span></code></pre></div>
<p>OpenCL 也可以检测到：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>intel-opencl-icd<span class="w"> </span>clinfo
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>Number<span class="w"> </span>of<span class="w"> </span>devices<span class="w">                                 </span><span class="m">1</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span>Device<span class="w"> </span>Name<span class="w">                                     </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Graphics<span class="w"> </span>Gen12LP<span class="w"> </span><span class="o">[</span>0x9a49<span class="o">]</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span>Device<span class="w"> </span>Vendor<span class="w">                                   </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Corporation
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span>Device<span class="w"> </span>Vendor<span class="w"> </span>ID<span class="w">                                </span>0x8086
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span>Device<span class="w"> </span>Version<span class="w">                                  </span>OpenCL<span class="w"> </span><span class="m">3</span>.0<span class="w"> </span>NEO
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span>Device<span class="w"> </span>Numeric<span class="w"> </span>Version<span class="w">                          </span>0xc00000<span class="w"> </span><span class="o">(</span><span class="m">3</span>.0.0<span class="o">)</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span>Driver<span class="w"> </span>Version<span class="w">                                  </span><span class="m">1</span>.0.0
</span></code></pre></div>
<p>Vulkan：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>vulkaninfo
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>Group<span class="w"> </span><span class="m">1</span>:
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">        </span>Properties:
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">                </span>physicalDevices:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">                        </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">                </span><span class="nv">subsetAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">        </span>Present<span class="w"> </span>Capabilities:
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">                </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>:
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">                        </span>Can<span class="w"> </span>present<span class="w"> </span>images<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>devices:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">                                </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">                </span>Present<span class="w"> </span>modes:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">                        </span>DEVICE_GROUP_PRESENT_MODE_LOCAL_BIT_KHR
</span></code></pre></div>
<p>不过目前还没找到显示输出的方法，只能用 VMware SVGA 或者远程桌面。</p>
<h3 id="吐槽"><a class="toclink" href="../../../../system/2022/05/05/nuc11-igpu-passthrough/#吐槽">吐槽</a></h3>
<p>需要吐槽的是，11 代的核显不再支持 Intel GVT-g，而是提供了 SR-IOV 的虚拟化。但是，Linux i915 驱动没有做相应的支持。</p>
<p>参考文档：</p>
<ul>
<li><a href="https://williamlam.com/2020/06/passthrough-of-integrated-gpu-igpu-for-standard-intel-nuc.html">Passthrough of Integrated GPU (iGPU) for standard Intel NUC</a></li>
<li><a href="https://shuttletitan.com/vsphere/pci-passthrough-module-devicepoweron-power-on-failed/">PCI Passthrough – “Module ‘DevicePowerOn’ power on failed”</a></li>
</ul>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-05-02 00:00:00+00:00">2022年5月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="loongarch64-工具链构建"><a class="toclink" href="../../../../software/2022/05/02/loongarch64-toolchain/">LoongArch64 工具链构建</a></h2>
<p>最近因为龙芯杯的原因，想自己搞个 LoongArch64 的交叉编译工具链试试，结果遇到了很多坑，最后终于算是搞出来了。</p>
<p>一开始是想搞一个 newlib 的工具链，比较简单，而且之前做过一个仓库：<a href="https://github.com/jiegec/riscv-toolchain">jiegec/riscv-toolchain</a>，就是构建的 riscv64-unknown-elf 工具链，照着 riscv-gnu-toolchain 就可以了。不过研究发现，newlib 还不支持 loongarch，目前只有 glibc 支持，只好硬着头皮上了。</p>
<p>于是我就在 riscv-toolchain 的基础上搞 loongarch64-unknown-linux-gnu，也就是带 glibc 的工具链，结果发现遇到很多坑。首先编译 libgcc 的时候就找不到头文件，于是先要从 glibc 和 linux 安装头文件到 sysroot 里面，对于 sysroot 里面的头文件路径到底是 include 还是 usr/include 也折腾了半天。然后编译 libgcc 又各种出问题，最后折腾了半天，结果是 gcc stage1 和 glibc 都没问题，gcc stage2 会报链接错误，但是不管它也能用，可以编译出正常的程序，毕竟 libc 是好的。</p>
<p>于是转念一想，要不要试试 crosstool-ng。克隆了一份上游的版本，照着 riscv 的部分抄了一份变成了 loongarch，然后把 config 里面的 linux/glibc/gcc/binutils-gdb 都替换为 custom location，这样我就可以用上游的最新版本了。中途还遇到了 <a href="https://github.com/crosstool-ng/crosstool-ng/issues/1564">crosstool-ng 对 gcc 12/13 不兼容的 bug</a>，还好下面有人提出了解决方法。这些都搞定以后，终于构建出了一个完整的 loongarch64-unknown-linux-gnu 工具链。仓库地址是 <a href="https://github.com/jiegec/ct-ng-loongarch64">jiegec/ct-ng-loongarch64</a>，需要配合添加了 LoongArch 的 <a href="https://github.com/jiegec/crosstool-ng/tree/loongarch">jiegec/crosstool-ng loongarch 分支</a> 使用。</p>
<p>最后得到的工具链各组件版本如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>loongarch64-unknown-linux-gnu-gcc (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.0 20220502 (experimental)
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>This is free software; see the source for copying conditions.  There is NO
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>GNU ld (crosstool-NG 1.25.0_rc2.1_7e21141) 2.38.50.20220502
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>This program is free software; you may redistribute it under the terms of
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>the GNU General Public License version 3 or (at your option) a later version.
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>This program has absolutely no warranty.
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>GNU gdb (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.50.20220502-git
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>This is free software: you are free to change and redistribute it.
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>There is NO WARRANTY, to the extent permitted by law.
</span></code></pre></div>
<p>之后有时间的话，再把 qemu 和系统搞起来跑跑。</p>
<p>UPDATE: GCC 12.1 发布了，试了一下这个正式版本可以正确地编译。目前还需要使用 HEAD 版本的 binutils 和龙芯的 glibc 和 linux。</p>
<p>参考文档：</p>
<ul>
<li><a href="https://github.com/sunhaiyong1978/CLFS-for-LoongArch/blob/main/CLFS_For_LoongArch64-20220108.md">手把手教你构建基于 LoongArch64 架构的 Linux 系统</a></li>
<li><a href="https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/">How to Build a GCC Cross-Compiler</a></li>
</ul>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-19 00:00:00+00:00">2022年4月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="试用沁恒-ch32v307-评估板"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/">试用沁恒 CH32V307 评估板</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#背景">背景</a></h3>
<p>之前有一天看到朋友在捣鼓 CH32V307，因此自己也萌生了试用 CH32V307 评估板的兴趣，于是在<a href="http://www.wch.cn/services/request_sample.html">沁恒官网申请样品</a>，很快就接到电话了解情况，几天后就顺丰送到了，不过因为疫情原因直到现在才拿到手上，只能说疫情期间说不定货比人还快。</p>
<h3 id="开箱"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#开箱">开箱</a></h3>
<p>收到的盒子里有一个 <a href="http://special.wch.cn/zh_cn/RISCV_MCU_Index/">CH32V307 评估板</a>，和一个 <a href="http://www.wch.cn/products/WCH-Link.html">WCH-Link</a>，相关资料可以在 <a href="http://www.wch.cn/products/CH32V307.html">官网</a> 或者 <a href="https://github.com/openwch/ch32v307">openwch/ch32v307</a> 下载。在说明书中有如下的图示：</p>
<p><img alt="" src="../../../../hardware/ch32v307.png" /></p>
<p>板子自带的跳线帽不是很多，建议自备一些，或者用杜邦线替代。比较重要的是 WCH-Link 子板上 CH549 和 CH2V307 连接的几个信号，和下面 BOOT0/1 的选择。</p>
<h3 id="wch-link"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#wch-link">WCH-Link</a></h3>
<p>可以看到评估板自带了一个 WCH-Link，所以不需要附赠的那一个，直接把 11 号 Type-C 连接到电脑上即可。这里还遇到一个小插曲，用 Type-C to Type-C 的线连电脑上不工作，连 PWR LED 都点不亮，换一根 Type-A to Type-C 的就可以，没有继续研究是什么原因。电脑上可以看到 WCH-Link 的设备：VID=1a86, PID=8010。比较有意思的是，在 RISC-V 模式（CON 灯不亮）的时候 PID 是 8010，ARM 模式（CON 灯亮）的时候 PID 是 8011，从 RISC-V 模式切换到 ARM 模式的方法是连接 TX 和 GND 后上电，反过来要用 MounRiver，详见 WCH-Link 使用说明 <a href="http://www.wch.cn/uploads/file/20210707/1625645582172366.pdf">V1.0</a> <a href="http://www.wch.cn/uploads/file/20210906/1630922260396691.pdf">V1.3</a> 和原理图 <a href="http://www.wch.cn/uploads/file/20210104/1609725144187113.pdf">V1.1</a>。</p>
<p>给沁恒开源 WCH-Link 原理图并开放固件点个赞，在淘宝上也可以看到不少 WCH-Link 的仿真器，挺有意思的。</p>
<p>在 ARM 模式下，它实现了类似 <a href="https://www.keil.com/support/man/docs/dapdebug/dapdebug_introduction.htm">CMSIS-DAP</a> 的协议，可以用 OpenOCD 调试：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>interface<span class="o">/</span>cmsis-dap.cfg<span class="k">]</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">1000</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nv">cmsis_dap_vid_pid</span><span class="w"> </span><span class="mh">0x1a86</span><span class="w"> </span><span class="mh">0x8011</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>swd
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="nv">init</span>
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>openocd.cfg
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>SWD<span class="w">  </span>Supported
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>FW<span class="w"> </span><span class="nv">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>.0.0
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>Interface<span class="w"> </span>Initialised<span class="w"> </span><span class="o">(</span>SWD<span class="o">)</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>Info<span class="w"> </span>:<span class="w"> </span>SWCLK/TCK<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>SWDIO/TMS<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">TDI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">TDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">nTRST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">nRESET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>Interface<span class="w"> </span>ready
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">1000</span><span class="w"> </span>kHz
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>Warn<span class="w"> </span>:<span class="w"> </span>gdb<span class="w"> </span>services<span class="w"> </span>need<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>targets<span class="w"> </span>defined
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span></code></pre></div>
<p>不过这里我们要用的是 RISC-V 处理器 CH32V307，上面的就当是 WCH-LINK 使用的小贴士。</p>
<p>给评估板插上 USB Type-C 以后，首先上面的 WCH-Link 部分中红色的 PWR 和绿色的 RUN 亮，CON 不亮，说明 WCH-LINK 的 CH549 已经启动，并且处在 RISC-V 模式（CON 不亮）。CH549 是一个 8051 指令集的处理器，上面的跑的 WCH-LINK 固件在网上可以找到，在下面提到的 MounRiver Studio 目录中也有一份。</p>
<h3 id="openocd"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#openocd">OpenOCD</a></h3>
<p>目前开源工具上游还不支持 CH32V307 的开发，需要用 <a href="http://www.mounriver.com/download">MounRiver</a>，支持 Windows 和 Linux，有两部分：</p>
<ul>
<li><a href="http://file.mounriver.com/tools/MRS_Toolchain_Linux_x64_V1.40.tar.xz">MRS_Toolchain_Linux_x64_V1.40.tar.xz</a>: RISC-V GNU Toolchain 和 OpenOCD</li>
<li><a href="http://file.mounriver.com/upgrade/MounRiver_Studio_Community_Linux_x64_V110.tar.xz">MounRiver_Studio_Community_Linux_V110</a>：基于 Eclipse 做的 IDE</li>
</ul>
<p>解压缩后，可以看到它的 OpenOCD 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c">## wch-arm.cfg</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>cmsis-dap
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>swd
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>..<span class="o">/</span>share<span class="o">/</span>openocd<span class="o">/</span>scripts<span class="o">/</span>target<span class="o">/</span>ch32f1x.cfg<span class="k">]</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="c">## wch-riscv.cfg</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c">#interface wlink</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>wlink
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="nv">wlink_set</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x00001</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w">  </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="k">set</span><span class="w"> </span>_FLASHNAME<span class="w"> </span><span class="nv">$_CHIPNAME.flash</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="nv">flash</span><span class="w"> </span>bank<span class="w"> </span><span class="nv">$_FLASHNAME</span><span class="w"> </span>wch_riscv<span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">$_TARGETNAME.0</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="nv">echo</span><span class="w"> </span><span class="s2">&quot;Ready for Remote Connections&quot;</span>
</span></code></pre></div>
<p>其中 ch32f1x.cfg 就是 stm32f1x.cfg 改了一下名字，可以看到 WCH OpenOCD 把它的 RISC-V 调试协议称为 wlink，估计是取 wch-link 的简称吧。除了 wlink 部分，其他就是正常的 RISC-V CPU 调试的 OpenOCD 配置，比较有意思的就是 IDCODE 设为了 0x00001，比较有个性。</p>
<p>在网上一番搜索，找到了 WCH OpenOCD 的源码 <a href="https://git.minori.work/Embedded_Projects/riscv-openocd-wch">Embedded_Projects/riscv-openocd-wch</a>，是网友向沁恒获取的源代码，毕竟 OpenOCD 是 GPL 软件。简单看了一下代码，是直接把 RISC-V Debug 中的 DMI 操作封装了一下，然后通过 USB Bulk 和 WCH-Link 通信。我从 riscv-openocd 找到了一个比较接近的 <a href="https://github.com/jiegec/riscv-openocd/commit/cc0ecfb6d5b939bd109ea84b07b5eab3cdf80316">commit</a>，然后把 WCH 的代码提交上去，得到了 <a href="https://github.com/jiegec/riscv-openocd/commit/bfa3bc7f98d22fa60ef6d3b2f5d98859fa963f85">diff</a>，有兴趣的可以看看具体实现，甚至把这个支持提交到上游。</p>
<p>有源码以后，就可以在 macOS 上编译了（需要修复三处 clang 报告的编译错误，<a href="https://github.com/jiegec/riscv-openocd/tree/wch">最终代码</a>）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>$<span class="w"> </span>./bootstrap
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>$<span class="w"> </span>./configure<span class="w"> </span>--prefix<span class="o">=</span>/path/to/prefix/openocd<span class="w"> </span>--enable-wlink<span class="w"> </span>--disable-werror<span class="w"> </span><span class="nv">CAPSTONE_CFLAGS</span><span class="o">=</span>-I/opt/homebrew/opt/capstone/include/
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>$<span class="w"> </span>make<span class="w"> </span>-j4<span class="w"> </span>install
</span></code></pre></div>
<p>如果遇到 makeinfo 报错，把 homebrew 的 texinfo 加到 PATH 即可。</p>
<p>编译完成后，就可以用前面提到的 wch-riscv.cfg 进行调试了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>$<span class="w"> </span>/path/to/prefix/openocd<span class="w"> </span>-f<span class="w"> </span>wch-riscv.cfg
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0+dev-01623-gbfa3bc7f9<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-04-20-09:55<span class="o">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>Info<span class="w"> </span>:<span class="w"> </span>only<span class="w"> </span>one<span class="w"> </span>transport<span class="w"> </span>option<span class="p">;</span><span class="w"> </span>autoselect<span class="w"> </span><span class="s1">&#39;jtag&#39;</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>Ready<span class="w"> </span><span class="k">for</span><span class="w"> </span>Remote<span class="w"> </span>Connections
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>Info<span class="w"> </span>:<span class="w"> </span>WCH-Link<span class="w"> </span>version<span class="w"> </span><span class="m">2</span>.3<span class="w"> </span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>Info<span class="w"> </span>:<span class="w"> </span>wlink_init<span class="w"> </span>ok
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>Info<span class="w"> </span>:<span class="w"> </span>This<span class="w"> </span>adapter<span class="w"> </span>doesn<span class="err">&#39;</span>t<span class="w"> </span>support<span class="w"> </span>configurable<span class="w"> </span>speed
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">32</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x40901125
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span>Target<span class="w"> </span>successfully<span class="w"> </span>examined.
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span></code></pre></div>
<p>这也验证了上面的发现：因为绕过了 jtag，直接发送 dmi，所以 idcode 是假的：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">if</span><span class="p">(</span><span class="n">wchwlink</span><span class="p">){</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">        </span><span class="n">buf_set_u32</span><span class="p">(</span><span class="n">idcode_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00001</span><span class="p">);</span><span class="w">  </span><span class="c1">//Default value,for reuse risc-v jtag debug</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>接下来就可以用 GDB 调试了。里面跑了一个样例的程序，就是向串口打印：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$<span class="w"> </span>screen<span class="w"> </span>/dev/tty.usbmodem*<span class="w"> </span><span class="m">115200</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>SystemClk:72000000
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="m">111</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">   </span><span class="m">111</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">      </span><span class="m">111</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">         </span><span class="m">111</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">            </span><span class="m">111</span>
</span></code></pre></div>
<p>之后则是针对各个外设，基于沁恒提供的示例代码进行相应的开发了。</p>
<h3 id="baremetal-代码"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#baremetal-代码">Baremetal 代码</a></h3>
<p>接下来看看沁恒提供的代码是如何配置的。在 EVT/EXAM/SRC/Startup/startup_ch32v30x_D8C.S 可以看到初始化的汇编代码。比较有意思的是，这个核心扩展了 mtvec，支持 ARM 的 vector table 模式，即放一个指针数组，而不是指令：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="w">    </span><span class="na">.section</span><span class="w">    </span><span class="no">.vector</span><span class="p">,</span><span class="s">&quot;ax&quot;</span><span class="p">,</span><span class="na">@progbits</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="na">.align</span><span class="w">  </span><span class="mi">1</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nl">_vector_base:</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="na">.option</span><span class="w"> </span><span class="no">norvc</span><span class="c1">;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">_start</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="mi">0</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">NMI_Handler</span><span class="w">                </span><span class="cm">/* NMI */</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">HardFault_Handler</span><span class="w">          </span><span class="cm">/* Hard Fault */</span>
</span></code></pre></div>
<p>这些名字如此熟悉，只能说这是 ARVM 了（ARM + RV）。后面的部分比较常规，把 data 段复制到 sram，然后清空 bss：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nl">handle_reset:</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="na">.option</span><span class="w"> </span><span class="no">push</span><span class="w"> </span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="no">.option</span><span class="w"> </span><span class="no">norelax</span><span class="w"> </span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">        </span><span class="no">la</span><span class="w"> </span><span class="no">gp</span><span class="p">,</span><span class="w"> </span><span class="no">__global_pointer$</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="na">.option</span><span class="w"> </span><span class="no">pop</span><span class="w"> </span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="mi">1</span><span class="p">:</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">_eusrstack</span><span class="w"> </span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="mi">2</span><span class="p">:</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">        </span><span class="cm">/* Load data section from flash to RAM */</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">_data_lma</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">_data_vma</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="no">_edata</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">        </span><span class="nf">bgeu</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="no">f</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="err">1:</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">        </span><span class="nf">lw</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">        </span><span class="nf">sw</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">        </span><span class="nf">bltu</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="err">2:</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">        </span><span class="cm">/* Clear bss section */</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">_sbss</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">_ebss</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">        </span><span class="nf">bgeu</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="no">f</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="err">1:</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">        </span><span class="nf">sw</span><span class="w"> </span><span class="no">zero</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">        </span><span class="nf">bltu</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="err">2:</span>
</span></code></pre></div>
<p>最后是进行一些 csr 的配置，然后进入 C 代码：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1f</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="mi">0xbc0</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="cm">/* Enable nested and hardware stack */</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1f</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="mi">0x804</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">    </span><span class="cm">/* Enable floating point and interrupt */</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x6088</span><span class="w">           </span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="no">csrs</span><span class="w"> </span><span class="no">mstatus</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">_vector_base</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="nf">ori</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w">           </span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">    </span><span class="no">csrw</span><span class="w"> </span><span class="no">mtvec</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">    </span><span class="nf">lui</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1ffff</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x300</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">    </span><span class="nf">sh</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1b0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="err">1:</span><span class="w">  </span><span class="nf">lui</span><span class="w"> </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40022</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">    </span><span class="nf">lw</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0xc</span><span class="p">(</span><span class="no">s2</span><span class="p">)</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">    </span><span class="nf">andi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">    </span><span class="nf">bnez</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">    </span><span class="nf">jal</span><span class="w">  </span><span class="no">SystemInit</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">main</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="no">mepc</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="w">    </span><span class="nf">mret</span>
</span></code></pre></div>
<p>这里有一些自定义的 csr，比如 corecfgr(0xbc0)，intsyscr(0x804，设置了 HWSTKEN=1, INESTEN=1, PMTCFG=0b11, HWSTKOVEN=1)，具体参考 <a href="http://www.wch.cn/downloads/QingKeV4_Processor_Manual_PDF.html">QingKeV4_Processor_Manual</a>。接着代码往 0x1ffff1b0 写入 0x300，然后不断读取 FLASH Interface (0x40022000) 的 STATR 字段，没有找到代码中相关的定义，简单猜测与 Flash 的零等待/非零等待区有关，因为后续代码要提高频率，因此 Flash 控制器需要增加 wait state。</p>
<h3 id="编译"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#编译">编译</a></h3>
<p>可以用 MounRiver 编译，也可以用 SiFive 的 riscv64-unknown-elf 工具链进行编译，参考 <a href="https://git.minori.work/Embedded_Projects/CH32V307_Template">Embedded_Projects/CH32V307_Template</a> 项目中的编译方式，修改 <code>riscv64-elf.cmake</code> 为：</p>
<div class="language-cmake highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_SYSTEM_NAME</span><span class="w"> </span><span class="s">Generic</span><span class="p">)</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_COMPILER</span><span class="w"> </span><span class="s">riscv64-unknown-elf-gcc</span><span class="p">)</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_COMPILER</span><span class="w"> </span><span class="s">riscv64-unknown-elf-g++</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c"># Make CMake happy about those compilers</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_TRY_COMPILE_TARGET_TYPE</span><span class="w"> </span><span class="s2">&quot;STATIC_LIBRARY&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>然后交叉编译就可以了。需要注意的是对 libnosys 的处理，如果没有正确链接，就会出现 syscall，然后在 ecall handler 里面死循环。</p>
<p>如果不想用 CMake，也可以用下面的精简版 Makefile：</p>
<div class="language-make highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nv">USER</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>User/main.c<span class="w"> </span>User/ch32v30x_it.c<span class="w"> </span>User/system_ch32v30x.c
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nv">LIBRARY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>../../SRC/Peripheral/src/ch32v30x_misc.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_usart.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_gpio.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_rcc.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span>../../SRC/Debug/debug.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span>../../SRC/Startup/startup_ch32v30x_D8C.S
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="nv">LDSCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>../../SRC/Ld/Link.ld
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="c"># disable libc first</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="nv">CFLAGS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>-march<span class="o">=</span>rv32imafc<span class="w"> </span>-mabi<span class="o">=</span>ilp32f<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">    </span>-flto<span class="w"> </span>-ffunction-sections<span class="w"> </span>-fdata-sections<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">    </span>-nostartfiles<span class="w"> </span>-nostdlib<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">    </span>-T<span class="w"> </span><span class="k">$(</span>LDSCRIPT<span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">    </span>-I../../SRC/Debug<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">    </span>-I../../SRC/Core<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">    </span>-I../../SRC/Peripheral/inc<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">    </span>-I./User<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">    </span>-O2<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">    </span>-Wl,--print-memory-usage
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="c"># link libc &amp; libnosys in the end</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="nv">CFLAGS_END</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">    </span>-lc<span class="w"> </span>-lgcc<span class="w"> </span>-lnosys
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="nv">PREFIX</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>riscv64-unknown-elf-
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">obj</span>/<span class="n">build</span>.<span class="n">bin</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="nf">obj/build.bin</span><span class="o">:</span><span class="w"> </span><span class="n">obj</span>/<span class="n">build</span>.<span class="n">elf</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">    </span><span class="k">$(</span>PREFIX<span class="k">)</span>objcopy<span class="w"> </span>-O<span class="w"> </span>binary<span class="w"> </span>$^<span class="w"> </span><span class="nv">$@</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="nf">obj/build.elf</span><span class="o">:</span><span class="w"> </span><span class="k">$(</span><span class="nv">USER</span><span class="k">)</span> <span class="k">$(</span><span class="nv">LIBRARY</span><span class="k">)</span>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">    </span><span class="k">$(</span>PREFIX<span class="k">)</span>gcc<span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>$^<span class="w"> </span><span class="k">$(</span>CFLAGS_END<span class="k">)</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="nf">clean</span><span class="o">:</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>obj/*
</span></code></pre></div>
<h3 id="烧写-flash"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#烧写-flash">烧写 Flash</a></h3>
<p>编译好以后，根据 WCH OpenOCD 的文档，可以用下面的配置来进行烧写：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c">#interface wlink</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>wlink
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="nv">wlink_set</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x00001</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w">  </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="k">set</span><span class="w"> </span>_FLASHNAME<span class="w"> </span><span class="nv">$_CHIPNAME.flash</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="nv">flash</span><span class="w"> </span>bank<span class="w"> </span><span class="nv">$_FLASHNAME</span><span class="w"> </span>wch_riscv<span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">$_TARGETNAME.0</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="nv">init</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="nv">halt</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="nv">flash</span><span class="w"> </span>erase_sector<span class="w"> </span>wch_riscv<span class="w"> </span><span class="mi">0</span><span class="w"> </span>last
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="nv">program</span><span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>firmware
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="nv">verify_image</span><span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>firmware
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="nv">wlink_reset_resume</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="nb">exit</span>
</span></code></pre></div>
<p>输出：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>$<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>program.cfg
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0+dev-01623-gbfa3bc7f9<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-04-20-09:55<span class="o">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>Info<span class="w"> </span>:<span class="w"> </span>only<span class="w"> </span>one<span class="w"> </span>transport<span class="w"> </span>option<span class="p">;</span><span class="w"> </span>autoselect<span class="w"> </span><span class="s1">&#39;jtag&#39;</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>Ready<span class="w"> </span><span class="k">for</span><span class="w"> </span>Remote<span class="w"> </span>Connections
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>Info<span class="w"> </span>:<span class="w"> </span>WCH-Link<span class="w"> </span>version<span class="w"> </span><span class="m">2</span>.3
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>Info<span class="w"> </span>:<span class="w"> </span>wlink_init<span class="w"> </span>ok
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>Info<span class="w"> </span>:<span class="w"> </span>This<span class="w"> </span>adapter<span class="w"> </span>doesn<span class="err">&#39;</span>t<span class="w"> </span>support<span class="w"> </span>configurable<span class="w"> </span>speed
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">32</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x40901125
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span>Target<span class="w"> </span>successfully<span class="w"> </span>examined.
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>Info<span class="w"> </span>:<span class="w"> </span>device<span class="w"> </span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>REDACTED
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>Info<span class="w"> </span>:<span class="w"> </span>flash<span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>256kbytes
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>**<span class="w"> </span>Programming<span class="w"> </span>Started<span class="w"> </span>**
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>**<span class="w"> </span>Programming<span class="w"> </span>Finished<span class="w"> </span>**
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>Info<span class="w"> </span>:<span class="w"> </span>Verify<span class="w"> </span>Success
</span></code></pre></div>
<p>访问串口 <code>screen /dev/tty.usbmodem* 115200</code>，可以看到正确地输出了内容。</p>
<h3 id="转发"><a class="toclink" href="../../../../hardware/2022/04/19/wch-ch32v307-eval/#转发">转发</a></h3>
<p>本文已授权转发到以下的地址：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/wJ0X8qdIWRxavGo9N37QSg">公众号 物联网小生 试用沁恒 CH32V307 评估板</a></li>
<li><a href="https://www.yuque.com/zsafly/lfxyfc/zseeyx">语雀 硬件知识库 试用沁恒 CH32V307 评估板</a></li>
</ul>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-04-10 00:00:00+00:00">2022年4月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="导出-vivado-下载-bitstream-的-svf-文件"><a class="toclink" href="../../../../hardware/2022/04/10/vivado-program-bitstream-svf/">导出 Vivado 下载 Bitstream 的 SVF 文件</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/04/10/vivado-program-bitstream-svf/#背景">背景</a></h3>
<p>最近在研究如何实现一个远程 JTAG 的功能，目前实现在 <a href="https://github.com/jiegec/jtag-remote-server">jiegec/jtag-remote-server</a>，实现了简单的 XVC 协议，底层用的是 libftdi 的 MPSSE 协议来操作 JTAG。但是，在用 Vivado 尝试的时候，SysMon 可以正常使用，但是下载 Bitstream 会失败，所以要研究一下 Vivado 都做了什么（目前已经修好，是最后一个字节的部分位读取的处理问题）。</p>
<h3 id="svf"><a class="toclink" href="../../../../hardware/2022/04/10/vivado-program-bitstream-svf/#svf">SVF</a></h3>
<p>SVF 格式其实是一系列的 JTAG 上的操作。想到这个，也是因为在网上搜到了一个 <a href="https://www.asc.ohio-state.edu/physics/cms/firmwares/dcfeb_v45.svf">dcfeb_v45.svf</a>，里面描述的就是一段 JTAG 操作：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>// Created using Xilinx Cse Software [ISE - 12.4]
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>// Date: Mon May 09 11:00:32 2011
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>TRST OFF;
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>ENDIR IDLE;
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>ENDDR IDLE;
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>STATE RESET;
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>STATE IDLE;
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>FREQUENCY 1E6 HZ;
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>//Operation: Program -p 0 -dataWidth 16 -rs1 NONE -rs0 NONE -bpionly -e -loadfpga 
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>TIR 0 ;
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>HIR 0 ;
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>TDR 0 ;
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>HDR 0 ;
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>TIR 0 ;
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>HIR 0 ;
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>HDR 0 ;
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>TDR 0 ;
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>//Loading device with &#39;idcode&#39; instruction.
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>SIR 10 TDI (03c9) SMASK (03ff) ;
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>SDR 32 TDI (00000000) SMASK (ffffffff) TDO (f424a093) MASK (0fffffff) ;
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>//Boundary Scan Chain Contents
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>//Position 1: xc6vlx130t
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>TIR 0 ;
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>HIR 0 ;
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>TDR 0 ;
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>HDR 0 ;
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>TIR 0 ;
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>HIR 0 ;
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>TDR 0 ;
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>HDR 0 ;
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>TIR 0 ;
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>HIR 0 ;
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>HDR 0 ;
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>TDR 0 ;
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>//Loading device with &#39;idcode&#39; instruction.
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>SIR 10 TDI (03c9) ;
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>SDR 32 TDI (00000000) TDO (f424a093) ;
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>//Loading device with &#39;bypass&#39; instruction.
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>SIR 10 TDI (03ff) ;
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>//Loading device with &#39;idcode&#39; instruction.
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>SIR 10 TDI (03c9) ;
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>SDR 32 TDI (00000000) TDO (f424a093) ;
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>// Loading device with a `jprogram` instruction. 
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>SIR 10 TDI (03cb) ;
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>// Loading device with a `isc_noop` instruction. 
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>SIR 10 TDI (03d4) ;
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>RUNTEST 100000 TCK;
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>// Check init_complete in ircapture.
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>//IR Capture using specified instruction.
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>SIR 10 TDI (03d4) TDO (0010) MASK (0010) ;
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>// Loading device with a `isc_enable` instruction. 
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>SIR 10 TDI (03d0) ;
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a>SDR 5 TDI (00) SMASK (1f) ;
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>RUNTEST 100 TCK;
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>// Loading device with a `isc_program` instruction. 
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>SIR 10 TDI (03d1) ;
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>SDR 32 TDI (ffffffff) SMASK (ffffffff) ;
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>SDR 32 TDI (ffffffff) ;
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>SDR 32 TDI (ffffffff) ;
</span></code></pre></div>
<p>它的语法比较简单，大概就是 <code>SIR</code> 就是向 IR 输入，<code>SDR</code> 就是向 DR 输入，后面跟着的 TDO 和 MASK 表示对输出数据进行判断。比较核心的是下面这几步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>SIR JPROGRAM
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>SIR ISC_NOOP
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>RUNTEST 10000 TCK
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>SIR ISC_NOOP UNTIL ISC_DONE
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>SIR ISC_ENABLE
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>SIR ISC_PROGRAM
</span></code></pre></div>
<p>之后就是 bitstream 的内容了。</p>
<h4 id="openocd-烧写-svf"><a class="toclink" href="../../../../hardware/2022/04/10/vivado-program-bitstream-svf/#openocd-烧写-svf">OpenOCD 烧写 SVF</a></h4>
<p>有了 SVF 以后，就可以用其他的一些支持 SVF 语法的工具来烧写 FPGA，而不需要 Vivado。比如采用如下的 OpenOCD 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c"># openocd config</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c"># use ftdi channel 0</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">100000</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>ftdi
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>jtag
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="nv">ftdi_vid_pid</span><span class="w"> </span><span class="mh">0x0403</span><span class="w"> </span><span class="mh">0x6011</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="nv">ftdi_layout_init</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="mh">0x000b</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="nv">ftdi_tdo_sample_edge</span><span class="w"> </span>falling
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="nv">ftdi_channel</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="nv">reset_config</span><span class="w"> </span>none
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span>xcvu37p<span class="w"> </span>tap<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x14b79093</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="nv">init</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="nv">svf</span><span class="w"> </span><span class="o">-</span>tap<span class="w"> </span>xcvu37p.tap<span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>program.svf<span class="w"> </span>progress
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="nb">exit</span>
</span></code></pre></div>
<h4 id="从-vivado-中导出-svf"><a class="toclink" href="../../../../hardware/2022/04/10/vivado-program-bitstream-svf/#从-vivado-中导出-svf">从 Vivado 中导出 SVF</a></h4>
<p>从文件头可以推测，这个功能是 Xilinx 官方提供的，一番搜索，果然找到了命令：<a href="https://blog.xjtag.com/2016/07/creating-svf-files-using-xilinx-vivado/">Creating SVF files using Xilinx Vivado</a></p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nv">program_hw_devices</span><span class="w"> </span><span class="o">-</span>force<span class="w"> </span><span class="o">-</span>svf_file<span class="w"> </span><span class="k">{</span><span class="nv">program.svf</span><span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_hw_devices</span><span class="w"> </span>xxx<span class="k">]</span>
</span></code></pre></div>
<p>添加一个 <code>-svf_file</code> 参数后，就会生成一个 svf 文件。下面摘录一段：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>// config/idcode
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>SIR 18 TDI (009249) ;
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>SDR 32 TDI (00000000) TDO (04b79093) MASK (0fffffff) ;
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>// config/jprog
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>STATE RESET;
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>STATE IDLE;
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>SIR 18 TDI (00b2cb) ;
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>SIR 18 TDI (014514) ;
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>// Modify the below delay for config_init operation (0.100000 sec typical, 0.100000 sec maximum)
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>RUNTEST 0.100000 SEC;
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>// config/jprog/poll
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>RUNTEST 15000 TCK;
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>SIR 18 TDI (014514) TDO (011000) MASK (031000) ;
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>// config/slr
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>SIR 18 TDI (005924) ;
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>SDR 226633216 TDI (0000000400000004e00000008001000c00000004d00000008001000c0000000466aa99550000000400000004000000040000000400000004000000040000
</span></code></pre></div>
<p>结合 Xilinx 官网可以下载的 BSDL 文件，可以找到每个 IR 对应的是什么：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>// config/idcode
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>SIR 18 TDI (009249) ;
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>SDR 32 TDI (00000000) TDO (04b79093) MASK (0fffffff) ;
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>// BSDL:
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>&quot;IDCODE           (001001001001001001),&quot; &amp; --   DEVICE_ID reg
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>attribute IDCODE_REGISTER of XCVU37P_FSVH2892 : entity is
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>        &quot;XXXX&quot; &amp;        -- version
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>        &quot;0100101&quot; &amp;     -- family
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>        &quot;101111001&quot; &amp;   -- array size
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>        &quot;00001001001&quot; &amp; -- manufacturer
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>        &quot;1&quot;;            -- required by 1149.1
</span></code></pre></div>
<p>这一段是检查 IDCODE 是否是目标 FPGA 型号。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>// config/jprog
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>STATE RESET;
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>STATE IDLE;
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>SIR 18 TDI (00b2cb) ;
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>SIR 18 TDI (014514) ;
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>// BSDL
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>&quot;JPROGRAM         (001011001011001011),&quot; &amp; --   PRIVATE
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>&quot;ISC_NOOP         (010100010100010100),&quot; &amp; --   PRIVATE, ISC_DEFAULT
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>// Modify the below delay for config_init operation (0.100000 sec typical, 0.100000 sec maximum)
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>RUNTEST 0.100000 SEC;
</span></code></pre></div>
<p>这一段发送了 JPROGRAM 和 ISC_NOOP 的 IR，然后进入 RUNTEST 状态一段时间。</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>// config/jprog/poll
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>RUNTEST 15000 TCK;
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>SIR 18 TDI (014514) TDO (011000) MASK (031000) ;
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>// BSDL
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>&quot;ISC_NOOP         (010100010100010100),&quot; &amp; --   PRIVATE, ISC_DEFAULT
</span></code></pre></div>
这里再次设置 ISC_NOOP，检查了 TDO 中的数据，意义不明。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>// config/slr
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>SIR 18 TDI (005924) ;
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>SDR 226633216 TDI (0000000400000004e00000008001000c00000004d00000008001000c0000000466aa99550000000400000004000000040000000400000004000000040000
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>// BSDL
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>&quot;CFG_IN_SLR0      (000101100100100100),&quot; &amp; --   PRIVATE
</span></code></pre></div>
<p>从这里就是开始往里面写入 bitstream，可以看到熟悉的 66aa9955 的同步字符，对比 Bitstream 文件内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>000000c0: ffff ffff ffff ffff aa99 5566 2000 0000  ..........Uf ...
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>000000d0: 2000 0000 3002 2001 0000 0000 3002 0001   ...0. .....0...
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>000000e0: 0000 0000 3000 8001 0000 0000 2000 0000  ....0....... ...
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>000000f0: 3000 8001 0000 0007 2000 0000 2000 0000  0....... ... ...
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>00000100: 3000 2001 0000 0000 3002 6001 0000 0000  0. .....0.`.....
</span></code></pre></div>
<p>可以发现是每 32 字节按位颠倒：<code>aa995566(10101010 10011001 01010101 01100110) -&gt; 66aa9955(01100110 10101010 10011001 01010101)</code>，后面的 <code>20000000 -&gt; 00000004</code> 也是类似的。</p>
<p>Xilinx UG570 的 Table 6-5 也印证了上面的过程：</p>
<ul>
<li>Start loading the JPROGRAM instruction, LSB first:</li>
<li>Load the MSB of the JPROGRAM instruction when exiting SHIFT-IR, as defined in the IEEE standard.</li>
<li>Start loading the CFG_IN instruction, LSB first:</li>
<li>Load the MSB of the CFG_IN instruction when exiting SHIFT-IR.</li>
<li>Shift in the FPGA bitstream. Bit n (MSB) is the first bit in the bitstream.(3)(4)</li>
<li>Shift in the last bit of the bitstream. Bit 0 (LSB) shifts on the transition to EXIT1-DR.</li>
</ul>
<p>完成 CFG_IN 之后，再进行 JSTART:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>// config/start
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>STATE IDLE;
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>RUNTEST 100000 TCK;
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>SIR 18 TDI (00c30c) ;
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>HIR 0 ;
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>TIR 0 ;
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>HDR 0 ;
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>TDR 0 ;
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>STATE IDLE;
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>RUNTEST 2000 TCK;
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>SIR 18 TDI (009249) TDO (031000) MASK (011000) ;
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>HIR 0 ;
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>TIR 0 ;
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>HDR 0 ;
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>TDR 0 ;
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>// BSDL
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>&quot;JSTART           (001100001100001100),&quot; &amp; --   PRIVATE
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>&quot;IDCODE           (001001001001001001),&quot; &amp; --   DEVICE_ID reg
</span></code></pre></div>
<p>然后再次进行 CFG_IN_SLR0, CFG_OUT_SLR0，验证是否真的写进去了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>// config/status
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>STATE RESET;
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>RUNTEST 5 TCK;
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>SIR 18 TDI (005924) ;
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>SDR 160 TDI (0000000400000004800700140000000466aa9955) ;
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>SIR 18 TDI (004924) ;
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>SDR 32 TDI (00000000) TDO (3f5e0d40) MASK (08000000) ;
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>STATE RESET;
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>RUNTEST 5 TCK;
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>// BSDL
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>&quot;CFG_IN_SLR0      (000101100100100100),&quot; &amp; --   PRIVATE
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>&quot;CFG_OUT_SLR0     (000100100100100100),&quot; &amp; --   PRIVATE
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>// config/status
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>STATE RESET;
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>RUNTEST 5 TCK;
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>SIR 18 TDI (005924) ;
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>SDR 160 TDI (0000000400000004800700140000000466aa9955) ;
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>SIR 18 TDI (004924) ;
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>SDR 32 TDI (00000000) TDO (3f5e0d40) MASK (08000000) ;
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>STATE RESET;
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>RUNTEST 5 TCK;
</span></code></pre></div>
<p>这段操作是进行 Status Register Readback，见 UG570 的 Table 10-4。MASK 设为 <code>08000000</code> 应该是判断它的第 4 位：END_OF_STARTUP_STATUS（Table 9-25）。</p>
<p>如果是 Quartus 用户，也可以 <a href="https://www.intel.com/content/www/us/en/support/programmable/articles/000085709.html">生成 SVF</a>，具体操作是：在 Programmer 中，点击 <code>File-&gt;Create JAM, JBC, SVF or ISC file</code>，然后在弹出的窗口中选择 svf 格式，导出即可。得到的 svf 文件一样可以用 openocd 来下载。</p>
<p>也可以<a href="https://www.intel.com/content/www/us/en/support/programmable/articles/000074062.html">用 <code>quartus_cpf</code> 在命令行</a>中进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>quartus_cpf<span class="w"> </span>-q<span class="w"> </span>18MHz<span class="w"> </span>-g<span class="w"> </span><span class="m">3</span>.3<span class="w"> </span>-c<span class="w"> </span>-n<span class="w"> </span>p<span class="w"> </span>input.sof/pof<span class="w"> </span>output.svf
</span></code></pre></div>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-31 00:00:00+00:00">2022年3月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 19 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="浅谈乱序执行-cpu二访存"><a class="toclink" href="../../../../hardware/2022/03/31/brief-into-ooo-2/">浅谈乱序执行 CPU（二：访存）</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/ooo_cpu.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/03/31/brief-into-ooo-2/#背景">背景</a></h3>
<p>之前写过一个<a href="../../../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU</a>，随着学习的深入，内容越来越多，页面太长，因此把后面的一部分内容独立出来，变成了这篇博客文章。</p>
<p>本文主要讨论访存的部分。</p>
<p>本系列的所有文章：</p>
<ul>
<li><a href="../../../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU（一：乱序）</a></li>
<li><a href="../../../../hardware/2022/03/31/brief-into-ooo-2/">浅谈乱序执行 CPU（二：访存）</a></li>
<li><a href="../../../../hardware/2024/09/12/brief-into-ooo-3/">浅谈乱序执行 CPU（三：前端）</a></li>
</ul>

    
      <nav class="md-post__action">
        <a href="../../../../hardware/2022/03/31/brief-into-ooo-2/">
          继续阅读
        </a>
      </nav>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-30 00:00:00+00:00">2022年3月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-sv2vyosys-把-fpnew-转为-verilog-网表"><a class="toclink" href="../../../../hardware/2022/03/30/sv2v-fpnew/">用 sv2v+yosys 把 fpnew 转为 verilog 网表</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/03/30/sv2v-fpnew/#背景">背景</a></h3>
<p>FPnew 是一个比较好用的浮点计算单元，但它是 SystemVerilog 编写的，并且用了很多高级特性，虽然闭源软件是支持的，但是开源拖拉机经常会遇到这样那样的问题。所以一直想用 sv2v 把它翻译成 Verilog，但此时的 Verilog 还有很多复杂的结构，再用 yosys 转换为一个通用可综合的网表。</p>
<h3 id="步骤"><a class="toclink" href="../../../../hardware/2022/03/30/sv2v-fpnew/#步骤">步骤</a></h3>
<p>经过一系列踩坑，一个很重要的点是要用最新的 sv2v(v0.0.9-24-gf868f06) 和 yosys(0.15+70)。Debian 打包的 yosys 版本比较老，不能满足需求。</p>
<p>首先，用 verilator 进行预处理，把一堆 sv 文件合成一个：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>cat<span class="w"> </span>a.sv<span class="w"> </span>b.sv<span class="w"> </span>c.sv<span class="w"> </span>&gt;<span class="w"> </span>test.sv
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>$<span class="w"> </span>verilator<span class="w"> </span>-E<span class="w"> </span>test.sv<span class="w"> </span>&gt;<span class="w"> </span>merged.sv
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/^`line/d&#39;</span><span class="w"> </span>merged.sv
</span></code></pre></div>
<p>注意这里用 sed 去掉了无用的行号信息。然后，用 sv2v 进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>sv2v<span class="w"> </span>merged.sv<span class="w"> </span>&gt;<span class="w"> </span>merge.v
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/\$$fatal/d&#39;</span><span class="w"> </span>merge.v
</span></code></pre></div>
<p>这里又用 sed 把不支持的 $fatal 去掉。最后，用 yosys 进行处理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>yosys<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;read_verilog -defer merge.v&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;hierarchy -p fpnew_top&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;proc&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;opt&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;write_verilog -noattr output.v&#39;</span>
</span></code></pre></div>
<p>注意这里要用 <code>read_verilog -defer</code>，否则 yosys 会遇到 TAG_WIDTH=0 默认参数就直接例化，然后就出现 <code>[0:-1]</code> 这样的下标。<code>read_verilog</code> 的文档告诉了我们可以分两步做：</p>
<div class="language-text highlight"><pre><span></span><code>-defer
    only read the abstract syntax tree and defer actual compilation
    to a later &#39;hierarchy&#39; command. Useful in cases where the default
    parameters of modules yield invalid or not synthesizable code.
</code></pre></div>
<p>这样就得到了简化后的 verilog 代码：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">module</span><span class="w"> </span><span class="n">\$paramod$011e4d7ee08c34f246a38322dc9967d23ecc8081\fpnew_opgroup_block_A94B6_B7406</span><span class="w"> </span><span class="p">(</span><span class="n">clk_i</span><span class="p">,</span><span class="w"> </span><span class="n">rst_ni</span><span class="p">,</span><span class="w"> </span><span class="n">operands_i</span><span class="p">,</span><span class="w"> </span><span class="n">is_boxed_i</span><span class="p">,</span><span class="w"> </span><span class="n">rnd_mode_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_mod_i</span><span class="p">,</span><span class="w"> </span><span class="n">src_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">int_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">vectorial_op_i</span><span class="p">,</span><span class="w"> </span><span class="n">tag_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_valid_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_ready_o</span><span class="p">,</span><span class="w"> </span><span class="n">flush_i</span><span class="p">,</span><span class="w"> </span><span class="n">result_o</span><span class="p">,</span><span class="w"> </span><span class="n">status_o</span><span class="p">,</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">,</span><span class="w"> </span><span class="n">tag_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_valid_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_ready_i</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="p">,</span><span class="w"> </span><span class="n">busy_o</span><span class="p">);</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_0_</span><span class="p">;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_1_</span><span class="p">;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">71</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">arbiter_output</span><span class="p">;</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">flush_i</span><span class="p">;</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>这样虽然比较丑陋，但是解决了 SystemVerilog 的问题。诚然，这样也失去了修改参数的能力，因为参数已经在 yosys 综合途中确定下来了。</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-14 00:00:00+00:00">2022年3月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="synopsys-design-compiler-综合实践"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/">Synopsys Design Compiler 综合实践</a></h2>
<h3 id="工艺库"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#工艺库">工艺库</a></h3>
<p>综合很重要的一步是把 HDL 的逻辑变成一个个单元，这些单元加上连接方式就成为了网表。那么，基本单元有哪些，怎么决定用哪些基本单元？</p>
<p>这个就需要工艺库了，工艺库定义了一个个单元，单元的引脚、功能，还有各种参数，这样 Design Compiler 就可以按照这些信息去找到一个优化的网表。</p>
<h4 id="liberty-格式"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#liberty-格式">Liberty 格式</a></h4>
<p>网上可以找到一些 Liberty 格式的工艺库，比如 <a href="https://raw.githubusercontent.com/The-OpenROAD-Project/OpenROAD-flow-scripts/master/flow/platforms/nangate45/lib/NangateOpenCellLibrary_typical.lib">Nangate45</a>，它的设定是 25 摄氏度，1.10 伏，属于 TT（Typical/Typical）的 Process Corner。</p>
<p>在里面可以看到一些基本单元的定理，比如 <code>AND2_X1</code>，就是一个 drive strength 是 1 的二输入与门：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>cell (AND2_X1) {
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    drive_strength : 1;
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    pin (A1) {
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>        direction : input;
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    }
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    pin (A2) {
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        direction : input;
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    }
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    pin (ZN) {
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        direction : output;
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        function : &quot;(A1 &amp; A2)&quot;;
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    }
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    /* ... */
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>}
</span></code></pre></div>
<p>这样就定义了两个输入 pin，一个输出 pin，还有它实现的功能。还有很重要的一点是保存了时序信息，比如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>lu_table_template (Timing_7_7) {
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    variable_1 : input_net_transition;
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    variable_2 : total_output_net_capacitance;
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    index_1 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    index_2 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>}
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>cell (AND2_X1) {
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    pin (ZN) {
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>        timing () {
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>            related_pin : &quot;A1&quot;;
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>            timing_sense : positive_unate;
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>            cell_fall(Timing_7_7) {
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>                index_1 (&quot;0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535&quot;);
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>                index_2 (&quot;0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400&quot;);
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>                values (&quot;0.0217822,0.0253224,0.0288237,0.0346827,0.0448323,0.0636086,0.100366&quot;, \
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>                        &quot;0.0233179,0.0268545,0.0303556,0.0362159,0.0463659,0.0651426,0.101902&quot;, \
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                        &quot;0.0296429,0.0331470,0.0366371,0.0425000,0.0526603,0.0714467,0.108208&quot;, \
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>                        &quot;0.0402311,0.0440292,0.0477457,0.0538394,0.0641187,0.0829203,0.119654&quot;, \
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>                        &quot;0.0511250,0.0554077,0.0595859,0.0662932,0.0771901,0.0963434,0.133061&quot;, \
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>                        &quot;0.0625876,0.0673198,0.0719785,0.0794046,0.0910973,0.110757,0.147656&quot;, \
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>                        &quot;0.0748282,0.0800098,0.0851434,0.0933663,0.106111,0.126669,0.163872&quot;);
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>            }
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    }
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>}
</span></code></pre></div>
<p>首先要看 cell_fall 后面的 template 是 Timing_7_7，可以看到 variable_1 和 variable_2 对应的是 input_net_transition 和 total_output_net_capacitance。这里 cell_fall 指的是输出 pin ZN 从 1 变成 0 的时候，这个变化从 A1 的变化传播到 ZN 的时间，这个时间和输入的 transition 时间（大概是从 0 到 1、从 1 到 0 的时间，具体从多少百分比到多少百分比见设置）和输出的 capacitance 有关，所以是一个查找表，查找的时候找最近的点进行插值。输出的 capacitance 取决于 wire load 和连接了这个输出的其他单元的输入。</p>
<p>除了 cell_fall/cell_rise 两种类型，还有 fall_transition 和 rise_transition，这就是输出引脚的变化时间，又作为后继单元的输入 transition 时间。</p>
<p>接下来，还能看到功耗的数据：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>power_lut_template (Power_7_7) {
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    variable_1 : input_transition_time;
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    variable_2 : total_output_net_capacitance;
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    index_1 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    index_2 (&quot;0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070&quot;);
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>}
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>internal_power () {
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    related_pin          : &quot;A1&quot;;
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    fall_power(Power_7_7) {
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        index_1 (&quot;0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535&quot;);
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        index_2 (&quot;0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400&quot;);
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>        values (&quot;2.707163,2.939134,3.111270,3.271119,3.366153,3.407657,3.420511&quot;, \
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>                &quot;2.676697,2.905713,3.073189,3.236823,3.334156,3.373344,3.387400&quot;, \
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>                &quot;2.680855,2.891263,3.047784,3.212948,3.315296,3.360694,3.377614&quot;, \
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>                &quot;2.821141,3.032707,3.182020,3.338567,3.444608,3.488752,3.508229&quot;, \
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>                &quot;3.129641,3.235525,3.357993,3.567372,3.743682,3.792092,3.808289&quot;, \
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>                &quot;3.724304,3.738737,3.808381,3.980825,4.147999,4.278043,4.311323&quot;, \
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>                &quot;4.526175,4.492292,4.510220,4.634217,4.814899,4.934862,5.047389&quot;);
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    }
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>    rise_power(Power_7_7) {
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        index_1 (&quot;0.00117378,0.00472397,0.0171859,0.0409838,0.0780596,0.130081,0.198535&quot;);
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        index_2 (&quot;0.365616,1.893040,3.786090,7.572170,15.144300,30.288700,60.577400&quot;);
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>        values (&quot;1.823439,1.926997,1.963153,2.028865,1.957837,2.123314,2.075262&quot;, \
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>                &quot;1.796317,1.896145,1.960625,2.014112,2.050786,2.046472,1.972327&quot;, \
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>                &quot;1.811604,1.886741,1.955658,1.978263,1.965671,1.963736,2.071227&quot;, \
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>                &quot;1.997387,2.045930,2.092357,2.063643,2.099127,1.932089,2.131341&quot;, \
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>                &quot;2.367285,2.439718,2.440043,2.403446,2.305848,2.351146,2.195145&quot;, \
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>                &quot;2.916140,2.994325,3.044451,2.962881,2.836259,2.781564,2.633645&quot;, \
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>                &quot;3.687718,3.756085,3.789394,3.792984,3.773583,3.593022,3.405552&quot;);
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>    }
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>}
</span></code></pre></div>
<p>可以看到，这也是一个查找表，也是按照输出的 rise/fall 有不同的功耗。巧合的是，功耗的查找表的 index_1/index_2 和上面的时序查找表是一样的。除了 internal power，还有 leakage power，定义如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>leakage_power_unit : &quot;1nW&quot;;
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>/* ... */
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>cell_leakage_power  : 50.353160;
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>leakage_power () {
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    when           : &quot;!A1 &amp; !A2&quot;;
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    value          : 40.690980;
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>}
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>leakage_power () {
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    when           : &quot;!A1 &amp; A2&quot;;
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    value          : 62.007550;
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>}
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>leakage_power () {
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>    when           : &quot;A1 &amp; !A2&quot;;
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    value          : 41.294331;
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>}
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>leakage_power () {
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    when           : &quot;A1 &amp; A2&quot;;
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>    value          : 57.419780;
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>}
</span></code></pre></div>
<p>可以看到，它的 leakage power 取决于输入的状态，单位是 1nW。</p>
<p>再来看 Flip Flop 的定义：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>cell (DFFRS_X1) {
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    ff (&quot;IQ&quot; , &quot;IQN&quot;) {
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>        next_state          : &quot;D&quot;;
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        clocked_on          : &quot;CK&quot;;
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>        preset              : &quot;!SN&quot;;
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>        clear               : &quot;!RN&quot;;
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        clear_preset_var1   : L;
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        clear_preset_var2   : L;
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    }
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    pin (D) {
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        direction       : input;
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        capacitance     : 1.148034;
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        fall_capacitance    : 1.081549;
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        rise_capacitance    : 1.148034;
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        timing () {
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>            related_pin    : &quot;CK&quot;;
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>            timing_type    : hold_rising;
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>            when               : &quot;RN &amp; SN&quot;;
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>            sdf_cond       : &quot;RN_AND_SN === 1&#39;b1&quot;;
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>            fall_constraint(Hold_3_3) {
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>                index_1 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>                index_2 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>                values (&quot;0.002921,0.012421,0.011913&quot;, \
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>                        &quot;0.002707,0.008886,0.005388&quot;, \
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>                        &quot;0.139993,0.148595,0.137370&quot;);
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>            }
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>            rise_constraint(Hold_3_3) {
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>                index_1 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>                index_2 (&quot;0.00117378,0.0449324,0.198535&quot;);
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>                values (&quot;0.004193,0.015978,0.019836&quot;, \
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>                        &quot;0.020266,0.031864,0.035343&quot;, \
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>                        &quot;0.099118,0.113075,0.120979&quot;);
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>            }
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>        }
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>    }
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>}
</span></code></pre></div>
<p>可以看到，这里的属性变成了 setup/hold 时间。</p>
<p>SRAM 也有类似的定义，通常是写在单独的 lib 文件中，根据 width 和 depth 生成，比如 <a href="https://github.com/The-OpenROAD-Project/OpenROAD-flow-scripts/blob/master/flow/platforms/nangate45/lib/fakeram45_32x64.lib">fakeram45_32x64.lib</a>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>cell(fakeram45_32x64) {
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    area : 1754.536;
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    interface_timing : true;
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    memory() {
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        type : ram;
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        address_width : 5;
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        word_width : 64;
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    }
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    pin(clk)   {
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        direction : input;
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>        min_period : 0.174 ;
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        internal_power(){
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>            rise_power(scalar) {
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>                values (&quot;1498.650&quot;)
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>            }
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            fall_power(scalar) {
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>                values (&quot;1498.650&quot;)
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>            }
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>        }
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    }
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>    bus(wd_in)   {
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>        bus_type : fakeram45_32x64_DATA;
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>        direction : input;
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        timing() {
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>            related_pin     : clk;
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>            timing_type     : setup_rising ;
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>            rise_constraint(scalar) {
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>                values (&quot;0.050&quot;);
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>            }
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>            fall_constraint(scalar) {
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>                values (&quot;0.050&quot;);
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>            }
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>        } 
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>        internal_power(){
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>            when : &quot;(we_in)&quot;;
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>            rise_power(scalar) {
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>                values (&quot;14.987&quot;);
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>            }
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>            fall_power(scalar) {
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>                values (&quot;14.987&quot;);
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>            }
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>        }
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>    }
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>}
</span></code></pre></div>
<p>也可以类似地看到，它的输入 setup/hold，功耗，面积等等信息。</p>
<h4 id="db-格式"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#db-格式">DB 格式</a></h4>
<p>在给 Design Compiler 配置工艺库前，需要用 Library Compiler 先把 lib 格式转换为更紧凑的二进制 db 格式：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nv">read_lib</span><span class="w"> </span>xxx.lib
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nv">write_lib</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>db<span class="w"> </span>xxx
</span></code></pre></div>
<p>实测部分 Liberty 文件会报错，不知道有没有修复的办法。另外，不同版本的 Library Compiler 生成的格式也不大一样，但都是兼容的。</p>
<p>在 Design Compiler 中，设置当前工艺库命令：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nv">set_app_var</span><span class="w"> </span>target_library<span class="w"> </span>xxx.db
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nv">set_link_var</span><span class="w"> </span>target_library<span class="w"> </span>xxx.db
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="c"># or</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="nv">set_app_var</span><span class="w"> </span>target_library<span class="w"> </span><span class="k">{</span><span class="nv">xxx.db</span><span class="w"> </span>yyy.db<span class="k">}</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="nv">set_link_var</span><span class="w"> </span>target_library<span class="w"> </span><span class="k">{</span><span class="nv">xxx.db</span><span class="w"> </span>yyy.db<span class="k">}</span>
</span></code></pre></div>
<h3 id="综合脚本"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#综合脚本">综合脚本</a></h3>
<p>准备好工艺库以后，就可以开始编写综合脚本了，通常有这么些步骤：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c"># step 1: read source code &amp; set top level module name</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nv">read_file</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>verilog<span class="w"> </span>xxx.v
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nv">read_file</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>vhdl<span class="w"> </span>yyy.vhdl
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="nv">current_design</span><span class="w"> </span>xxx
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="c"># step 2: setup timing constraints</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="nv">create_clock</span><span class="w"> </span>clock<span class="w"> </span><span class="o">-</span>period<span class="w"> </span><span class="mf">1.0000</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="mi">1</span>GHz<span class="w"> </span>for<span class="w"> </span>example
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c"># other timing constraints:</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="c"># e.g. set_input_delay/set_output_delay</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="c"># step 3: synthesis</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="nv">link</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="nv">uniquify</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="c"># use this if you want to ungroup all hierarchy</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="c"># ungroup -flatten -all</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="c"># use this to retime design</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="c"># set_optimize_registers</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="nv">compile_ultra</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="c"># step 4: check &amp; report</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="nv">check_timing</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="nv">check_design</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="nv">report_design</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="nv">report_area</span><span class="w"> </span><span class="o">-</span>hierarchy
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="nv">report_power</span><span class="w"> </span><span class="o">-</span>hierarchy
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="nv">report_cell</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="nv">report_timing</span><span class="w"> </span><span class="o">-</span>delay_type<span class="w"> </span>max
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="nv">report_timing</span><span class="w"> </span><span class="o">-</span>delay_type<span class="w"> </span>min
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="nv">report_constraint</span><span class="w"> </span><span class="o">-</span>all_violators
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="nv">report_qor</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="c"># step 5: export</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="nv">write</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>ddc<span class="w"> </span><span class="o">-</span>hierarchy<span class="w"> </span><span class="o">-</span>output<span class="w"> </span>xxx.ddc
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="nv">write_sdc</span><span class="w"> </span><span class="o">-</span>version<span class="w"> </span><span class="mf">1.0</span><span class="w"> </span>xxx.sdf
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="nv">write</span><span class="w"> </span><span class="o">-</span>format<span class="w"> </span>verilog<span class="w"> </span><span class="o">-</span>hierarchy<span class="w"> </span><span class="o">-</span>output<span class="w"> </span>xxx.syn.v
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="nv">write_sdc</span><span class="w"> </span>xxx.sdc
</span></code></pre></div>
<p>根据需求，进行自定义的修改。综合完成后，可以看到生成的 <code>xxx.syn.v</code> 文件里都是一个个的 cell，比如：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">AND2X2</span><span class="w"> </span><span class="n">U3912</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">n4416</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">n2168</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">n3469</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">OAI21X1</span><span class="w"> </span><span class="n">U3913</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">n2872</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">n4589</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">C</span><span class="p">(</span><span class="n">n2461</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">n3471</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="n">DFFPOSX1</span><span class="w"> </span><span class="n">clock_r_REG147_S1</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">n7634</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CLK</span><span class="p">(</span><span class="n">clock</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">n7773</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
<p>还有一些比较特殊的 cell，比如 TIEHI/TIELO 就是恒定输出 1/0，用于门控时钟的 CLKGATE/ICG 等，还有一些综合阶段不会出现的 cell，在后续阶段会使用。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2022/03/14/design-compiler-synthesis/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://vlsiuniverse.blogspot.com/2016/12/liberty-format-introduction.html">Liberty format: an introduction</a></li>
<li><a href="https://www.eng.biu.ac.il/temanad/files/2017/02/Lecture-4-Standard-Cell-Libraries.pdf">Digital VLSI Design Lecture 4: Standard Cell Libraries</a></li>
</ul>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-12 00:00:00+00:00">2022年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openroad-flow-初尝试"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/">OpenROAD Flow 初尝试</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#背景">背景</a></h3>
<p>最近在尝试接触一些芯片前后端的知识。正好有现成的开源工具链 OpenROAD 来做这个事情，借此机会来学习一下整个流程。</p>
<h3 id="尝试过程"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#尝试过程">尝试过程</a></h3>
<p>首先 clone 仓库 OpenROAD-flow-scripts，然后运行：<code>./build_openroad.sh</code>，脚本会克隆一些仓库，自动进行编译。</p>
<p>编译中会找不到一些库，比如可能需要安装这些依赖：<code>liblemon-dev libeigen3-dev libreadline-dev swig</code>，此外运行的时候还需要 <code>klayout</code> 依赖。</p>
<p>如果遇到解决 cmake 找不到 LEMON 的问题，这是一个 <a href="https://lemon.cs.elte.hu/trac/lemon/ticket/628">BUG</a>，可以运行下面的命令解决：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nb">cd</span><span class="w"> </span>/usr/lib/x86_64-linux-gnu/cmake/lemon
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>cp<span class="w"> </span>lemonConfig.cmake<span class="w"> </span>LEMONConfig.cmake
</span></code></pre></div>
<p>编译后整个目录大概有 4.8G，输出的二进制目录是 133M。</p>
<p>如果要跑一下样例里的 nangate45 工艺的 gcd 例子，运行：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>cd flow
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>make DESIGN_CONFIG=./designs/nangate45/gcd/config.mk
</span></code></pre></div>
<h3 id="分析-gcd-测例"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#分析-gcd-测例">分析 GCD 测例</a></h3>
<p>这个测例的代码提供了这样一个接口：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">module</span><span class="w"> </span><span class="n">gcd</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="p">(</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">req_msg</span><span class="p">,</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_rdy</span><span class="p">,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_val</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">reset</span><span class="p">,</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">resp_msg</span><span class="p">,</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_rdy</span><span class="p">,</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_val</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="p">);</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>从名字可以推断出，外部通过 req 发送请求到 GCD 模块，然后模块计算出 GCD 后再返回结果。</p>
<p>根据日志可以看到，从 verilog 到最终的 gds 文件，经过了这些步骤：</p>
<ol>
<li>第一步用 yosys 综合（1_1_yosys），把 verilog 代码转化为网表，网表中的单元就是形如 <code>NAND2_X1</code> <code>DFF_X1</code> 等这样由工艺库定义的一些单元。</li>
<li>第二步进行 floorplan（2_1_floorplan），规划出芯片的大小，逻辑放在哪个位置，输入输出引脚放在什么位置（2_2_floorplan_io），还要考虑 SRAM 等宏或者 IP（2_4_mplace），电源网络 PDN（2_6_floorplan_pdn）</li>
<li>第三步是 Placement，就是把前面得到的一些 cell 放到芯片上的 (x,y) 坐标上</li>
<li>第四步是 Clock Tree Synthesis（4_1_cts），简称 CTS，生成时钟树</li>
<li>第五步是进行路由连线，OpenROAD 有两个路由：FastRoute（5_1_fastroute）和 TritonRoute（5_2_TritonRoute）</li>
<li>第六步输出结果到 gds 文件（6_1_merge）。</li>
</ol>
<p>这些步骤可以在仓库的 <code>flow/Makefile</code> 里面看得比较清晰，英文版摘抄如下：</p>
<ol>
<li>SYNTHESIS<ol>
<li>Run Synthesis using yosys</li>
</ol>
</li>
<li>FLOORPLAN<ol>
<li>Translate verilog to def</li>
<li>IO Placement (random)</li>
<li>Timing Driven Mixed Size Placement (tdms)</li>
<li>Macro Placement</li>
<li>Tapcell and Welltie insertion</li>
<li>PDN generation</li>
</ol>
</li>
<li>PLACE<ol>
<li>Global placement without placed IOs, timing-driven, and routability-driven</li>
<li>IO placement (non-random)</li>
<li>Global placement with placed IOs, timing-driven, and routability-driven</li>
<li>Resizing &amp; Buffering</li>
<li>Detail placement</li>
</ol>
</li>
<li>CTS(Clock Tree Synthesis)<ol>
<li>Run TritonCTS</li>
<li>Filler cell insertion</li>
</ol>
</li>
<li>ROUTING<ol>
<li>Run global route (FastRoute)</li>
<li>Run detailed route (TritonRoute)</li>
</ol>
</li>
</ol>
<p>最后生成的 gds，用 KLayout 打开，可以看到这个样子：</p>
<p><img alt="" src="../../../../hardware/gcd-gds.png" /></p>
<p>日志里可以看到，预测的总功耗是 1.71 mW，面积占用是 703 um^2。</p>
<p>还跑了一下其他样例设计的 gds，比如 ibex：</p>
<p><img alt="" src="../../../../hardware/ibex-gds.png" /></p>
<p>日志里可以看到，预测的总功耗是 10.1 mW，面积占用是 32176 um^2。</p>
<p>还有 tiny rocket：</p>
<p><img alt="" src="../../../../hardware/tiny-rocket-gds.png" /></p>
<p>日志里可以看到，预测的总功耗是 36.8 mW，面积占用是 52786 um^2。</p>
<h3 id="工艺库常见术语"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#工艺库常见术语">工艺库常见术语</a></h3>
<ul>
<li>slvt/lvt/rvt/hvt: super-low/low/regular/high V threshold 前者速度快：阈值电压低，同时漏电流大</li>
<li>ss/tt/ff: slow-slow/typical-typical/fast-fast 后者速度快：电压高，温度低，比如 SS（0.99V 125C）TT（1.10V 25C）FF（1.21V -40C）；有时候还会看到 ssg，可以理解为 ss 的比较精确的版本，因此没有那么悲观，延迟比 SS 低一些，详见 <a href="https://cloud.tencent.com/developer/article/1598417">STA | ssg 跟 ss corner 的区别——谬误更正版</a></li>
<li>c + 数字：表示的是 channel length，c40 表示 40nm，数字越大速度越慢，能耗越低</li>
<li>数字+track：表示的是 track height，sc12 表示 12-track，数字越大速度越快</li>
</ul>
<p>ARM 的文档 <a href="https://developer.arm.com/documentation/102738/0100/Choosing-the-physical-IP-libraries">Choosing the physical IP libraries</a> 描述了 Channel length, Track height, Voltage threshold 等不同的选择。</p>
<p>综合来说，如果要更低的延迟，选择低 vt，小 c 和大 track，反之如果要更低的能耗，选择高 vt，大 c 和 小 track。</p>
<h3 id="ccs-vs-nldm"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#ccs-vs-nldm">CCS v.s. NLDM</a></h3>
<p>由于物理的特性比较复杂，工艺库里描述的也只是一个大致的模型，刻画了这些 cell 的特性，那么自然可以选取不同的模型。NLDM（上面举的例子就是 NLDM），CCS 就是常见的两个模型，相比之下，CCS 更精确，同时参数更多。更精确的还有直接用 SPICE 描述的电路。详细的对比可以看下面的参考文档。</p>
<h3 id="参考文档"><a class="toclink" href="../../../../hardware/2022/03/12/try-openroad-flow/#参考文档">参考文档</a></h3>
<ul>
<li><a href="https://theopenroadproject.org/2019/12/11/getting-started-with-openroad-app-part-1/">GETTING STARTED WITH OPENROAD APP – PART 1</a></li>
<li><a href="https://link.springer.com/book/10.1007/b117024">Advanced ASIC Chip Synthesis Using Synopsys® Design Compiler™ Physical Compiler™ and PrimeTime®</a></li>
<li><a href="https://www.paripath.com/blog/characterization-blog/comparing-nldm-and-ccs-delay-models">Comparing NLDM And CCS delay models</a></li>
<li><a href="https://chitlesh.ch/wordpress/liberty-ccs-ecsm-or-ndlm/">Introduction to Liberty : CCS, ECSM and NDLM</a></li>
<li><a href="https://blog.csdn.net/graymount/article/details/106010388">STA 概念：一文了解 NLDM 与 CCS</a></li>
</ul>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-03-09 00:00:00+00:00">2022年3月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="通过-jtag-对-vcu128-上的-rocket-chip-进行调试"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/">通过 JTAG 对 VCU128 上的 Rocket Chip 进行调试</a></h2>
<h3 id="前言"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#前言">前言</a></h3>
<p>两年前，我尝试过用 BSCAN JTAG 来配置 Rocket Chip 的调试，但是这个方法不是很好用，具体来说，如果有独立的一组 JTAG 信号，配置起来会更方便，而且不用和 Vivado 去抢，OpenOCD 可以和 Vivado hw_server 同时运行和工作。但是，苦于 VCU128 上没有 PMOD 接口，之前一直没考虑过在 VCU128 上配置独立的 JTAG。然后最近研究了一下，终于解决了这个问题。</p>
<h3 id="寻找-jtag-接口"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#寻找-jtag-接口">寻找 JTAG 接口</a></h3>
<p>前几天在研究别的问题的时候，看到 VCU128 文档中的这段话：</p>
<div class="language-text highlight"><pre><span></span><code>The FT4232HL U8 multi-function USB-UART on the VCU128 board provides three level-shifted
UART connections through the single micro-AB USB connector J2.
• Channel A is configured in JTAG mode to support the JTAG chain
• Channel B implements 4-wire UART0 (level-shifted) FPGA U1 bank 67 connections
• Channel C implements 4-wire UART1 (level-shifted) FPGA U1 bank 67 connections
• Channel D implements 2-wire (level-shifted) SYSCTLR U42 bank 501 connections
</code></pre></div>
<p>其中 Channel A 是到 FPGA 本身的 JTAG 接口，是给 Vivado 用的，如果是通过 BSCAN 的方式，也是在这个 Channel 上，但是需要经过 FPGA 自己的 TAP 再隧道到 BSCAN 上，比较麻烦。Channel B 和 C 是串口，Channel D 是连接 VCU128 上的 System Controller 的。之前的时候，都是直接用 Channel B 做串口，然后突发奇想：注意到这里是 4-wire UART，说明连接到 FPGA 是四条线，那是不是也可以拿来当 JTAG 用？</p>
<p>查询了一下 FT4232H 的文档，发现它的 Channel A 和 Channel B 是支持 MPSSE 模式的，在 MPSSE 模式下，可以当成 JTAG 使用：</p>
<table>
<thead>
<tr>
<th>Signal</th>
<th>Channel A</th>
<th>Channel B</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCK</td>
<td>12</td>
<td>22</td>
</tr>
<tr>
<td>TDI</td>
<td>13</td>
<td>23</td>
</tr>
<tr>
<td>TDO</td>
<td>14</td>
<td>24</td>
</tr>
<tr>
<td>TMS</td>
<td>15</td>
<td>25</td>
</tr>
</tbody>
</table>
<p>对照 VCU128 的 Schematic 看，虽然引脚的编号不大一样，可以发现，Channel A 和 B 分别对应了 ADBUS0-4 和 BDBUS 0-4，对应到 schematic 上的名字是：</p>
<ul>
<li>ADBUS0 - FT4232_TCK</li>
<li>ADBUS1 - FT4232_TDI</li>
<li>ADBUS2 - FMCP_HSPC_TDO</li>
<li>ADBUS3 - FT4232_TMS</li>
</ul>
<p>这一组是直接连到 FPGA 上专用的 JTAG 引脚，其中 TDO 是连接了额外的逻辑，可以把 FMC 接口上的 JTAG 连接成 daisy chain。</p>
<ul>
<li>ADBUS0 - FTDI_UART0_TXD_LS - UART0_RXD - BP26 -&gt; TCK</li>
<li>ADBUS1 - FTDI_UART0_RXD_LS - UART0_TXD - BN26 -&gt; TDI</li>
<li>ADBUS2 - FTDI_UART0_RTS_B_LS - UART0_RTS_B - BP22 -&gt; TDO</li>
<li>ADBUS3 - FTDI_UART0_CTS_B_LS - UART0_CTS_B - BP23 -&gt; TMS</li>
</ul>
<p>这里的 RXD/TXD 名字交换也是很容易看错，要小心，只要记住 FT4232H 要求的顺序一定是 TCK-TDI-TDO-TMS 即可。对应到 vivado 内的 xdc 就是这么写：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BN26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP22<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP23<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span></code></pre></div>
<p>接下来，我们要把 Rocket Chip 的 JTAG 信号接出来。</p>
<h3 id="配置-rocket-chip-的-jtag"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#配置-rocket-chip-的-jtag">配置 Rocket Chip 的 JTAG</a></h3>
<p>配置 Rocket Chip 的 JTAG，大概需要如下几步：</p>
<ol>
<li>给 Config 加上 WithJtagDTM，以 JTAG 作为 DTM 模块</li>
<li>给 Subsystem 加上 HasPeripheryDebug</li>
<li>给 SubsystemModuleImp 加上 HasPeripheryDebugModuleImp</li>
<li>把 JTAG 信号连到自己的顶层模块上</li>
</ol>
<p>最后一步的相关代码，首先，按照 spec 要求，把 DM 输出的 ndreset 信号连到整个 Rocket 的 reset 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">// ndreset can reset all harts</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asBool</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">ndreset</span><span class="p">).</span><span class="n">getOrElse</span><span class="p">(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">target</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span>
</span></code></pre></div>
<p>接着，把 JTAG 的信号连到顶层：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">systemJtag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">systemjtag</span><span class="p">.</span><span class="n">get</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span>
</span></code></pre></div>
<p>除了 JTAG 信号以外，还需要配置 IDCODE 相关的变量：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">mfr_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeManufId</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">11</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">part_number</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodePartNum</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeVersion</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span></code></pre></div>
<p>最后这一部分比较关键：首先，JTAG 部分的 reset 是独立于其余部分的，这里简单期间就连到了外部的 reset，其实可以改成 FPGA program 的时候进行 reset，然后等时钟来了就释放，实现方法可以参考文末的链接。resetctrl 是给 DM 知道哪些核心被 reset 了，最后是调用 rocket chip 自带的函数。这里踩的一个坑是，传给 systemJtag.reset 一定得是异步的，因为这个时钟域的时钟都是 jtag 的 TCK 信号，所以很可能错过一开始的 reset 信号，所以这里要用异步的 reset。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">// MUST use async reset here</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1">// otherwise the internal logic(e.g. TLXbar) might not function</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1">// if reset deasserted before TCK rises</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asAsyncReset</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">target</span><span class="p">.</span><span class="n">resetctrl</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span><span class="n">rc</span><span class="p">.</span><span class="n">hartIsInReset</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="p">}</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="nc">Debug</span><span class="p">.</span><span class="n">connectDebugClockAndReset</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="配置-jtag-相关的约束"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#配置-jtag-相关的约束">配置 JTAG 相关的约束</a></h3>
<p>这部分是参考了 pulp 的 VCU118 中 jtag 信号的约束文件。照着抄就行：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nv">create_clock</span><span class="w"> </span><span class="o">-</span>period<span class="w"> </span><span class="mf">100.000</span><span class="w"> </span><span class="o">-</span>name<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nv">set_input_jitter</span><span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">1.000</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nv">set_property</span><span class="w"> </span>CLOCK_DEDICATED_ROUTE<span class="w"> </span>FALSE<span class="w"> </span><span class="k">[</span><span class="nv">get_nets</span><span class="w"> </span>jtag_TCK_IBUF_inst<span class="o">/</span>O<span class="k">]</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="nv">set_output_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>to<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="nv">set_clock_groups</span><span class="w"> </span><span class="o">-</span>asynchronous<span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span>jtag_TCK<span class="k">]</span><span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span><span class="o">-</span>of_objects<span class="w"> </span><span class="k">[</span><span class="nv">get_pins</span><span class="w"> </span>system_i<span class="o">/</span>clk_wiz_0<span class="o">/</span>inst<span class="o">/</span>mmcme4_adv_inst<span class="o">/</span>CLKOUT1<span class="k">]]</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="nv">set_property</span><span class="w"> </span>ASYNC_REG<span class="w"> </span>TRUE<span class="w"> </span><span class="k">[</span><span class="nv">get_cells</span><span class="w"> </span><span class="o">-</span>hier<span class="w"> </span><span class="o">-</span>regexp<span class="w"> </span><span class="s2">&quot;system_i/rocketchip_wrapper_0/.*/cdc_reg_reg.*&quot;</span><span class="k">]</span>
</span></code></pre></div>
<p>和原版本稍微改了一下，一个区别是 <code>set_clock_groups</code> 的时候，第二个时钟参数用的是 Clocking Wizard 的输出，同时也是 Rocket Chip 自己的时钟输入；另一个区别是用的 ASYNC_REG 查询语句不大一样。我没有具体分析过这些约束为什么这么写，不确定这些约束是否都合理，是否都是需要的，没有测试过不带这些约束会不会出问题。</p>
<h3 id="运行-openocd-和-gdb"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#运行-openocd-和-gdb">运行 OpenOCD 和 GDB</a></h3>
<p>最后，采用如下的 OpenOCD 配置来连接：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c"># openocd config</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c"># use ftdi channel 1</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c"># vcu128 uart0 as jtag</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">10000</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>ftdi
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="nv">ftdi_vid_pid</span><span class="w"> </span><span class="mh">0x0403</span><span class="w"> </span><span class="mh">0x6011</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>FT4232H
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="nv">ftdi_layout_init</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="mh">0x000b</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>Output:<span class="w"> </span>TCK<span class="w"> </span>TDI<span class="w"> </span>TMS
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="nv">ftdi_tdo_sample_edge</span><span class="w"> </span>falling
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="nv">ftdi_channel</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>channel<span class="w"> </span>B
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="nv">reset_config</span><span class="w"> </span>none
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w"> </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
<p>然后就可以连接到 Rocket Chip 上：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>&gt;<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>openocd.cfg
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0-rc2
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">&quot;jtag&quot;</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">&#39;transport select &lt;transport&gt;&#39;</span>.
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">10000</span><span class="w"> </span>kHz
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x10000913<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x489<span class="w"> </span><span class="o">(</span>SiFive<span class="w"> </span>Inc<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x1<span class="o">)</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">16</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Disabling<span class="w"> </span>abstract<span class="w"> </span><span class="nb">command</span><span class="w"> </span>reads<span class="w"> </span>from<span class="w"> </span>CSRs.
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">64</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x800000000094112d
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>&gt;<span class="w"> </span>riscv64-unknown-elf-gdb
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>target<span class="w"> </span>remote<span class="w"> </span>localhost:3333
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>Remote<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>localhost:3333
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>0x00000000800001a4<span class="w"> </span><span class="k">in</span><span class="w"> </span>??<span class="w"> </span><span class="o">()</span>
</span></code></pre></div>
<p>可以看到调试功能都正常了。</p>
<h3 id="总结"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#总结">总结</a></h3>
<p>调试这个功能大概花了一天的时间，主要遇到了下面这些问题：</p>
<ol>
<li>调试模块的 reset 信号需要是异步的，这个是通过仿真（Remote Bitbang 连接 OpenOCD）调试出来的</li>
<li>看 schematic 的时候 rxd/txd 搞反了，后来仔细对比才找到了正确的对应关系</li>
<li>OpenOCD 配置的 irlen 一开始写的不对，dmcontrol 读出来是 0，一直以为是有别的问题，结果改了 irlen 后立马就成功了，这个问题可以让 OpenOCD 自动推断 irlen 来发现</li>
</ol>
<h3 id="参考"><a class="toclink" href="../../../../hardware/2022/03/09/rocket-chip-jtag-debug/#参考">参考</a></h3>
<ul>
<li><a href="https://www.xilinx.com/support/documentation/boards_and_kits/vcu128/ug1302-vcu128-eval-bd.pdf">VCU128 User Guide</a></li>
<li><a href="https://ftdichip.com/wp-content/uploads/2020/08/DS_FT4232H.pdf">FT4232H</a></li>
<li><a href="https://github.com/sequencer/rocket-doc/blob/e55f7af549c5859b3c8f5a52c81c4c802153ed60/sanitytests/vcu118/src/DesignKeyWrapper.scala">DesignKeyWrapper from 中国 Chisel 之父 @sequencer</a></li>
<li><a href="https://github.com/pulp-platform/pulp/blob/770b4e1d69baf7daceaadcb301ba7212a4310577/fpga/pulp-vcu118/constraints/vcu118.xdc">pulp VCU118 constraints</a></li>
</ul>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-02-22 00:00:00+00:00">2022年2月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="解决-k3s-中-traefik-不会转发-x-forwarded-for-等头部的问题"><a class="toclink" href="../../../../devops/2022/02/22/k3s-traefik-client-ip/">解决 k3s 中 traefik 不会转发 X-Forwarded-For 等头部的问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../devops/2022/02/22/k3s-traefik-client-ip/#背景">背景</a></h3>
<p>把应用迁移到 k3s 中，然后用了 traefik 作为 Ingress Controller，发现无法获得真实的用户 IP 地址，而是 cni 内部的地址。搜索了一番，找到了靠谱的解决方案：</p>
<p><a href="https://medium.com/@_jonas/traefik-kubernetes-ingresse-x-forwarded-headers-82194d319b0e">Traefik Kubernetes Ingress and X-Forwarded-Headers</a></p>
<p>具体来说，需要给 traefik 传额外的参数，方法是在 k3s 的配置目录下，添加一个 HelmChartConfig：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># edit /var/lib/rancher/k3s/server/manifests/traefik-config.yaml</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1"># content:</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>apiVersion:<span class="w"> </span>helm.cattle.io/v1
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>kind:<span class="w"> </span>HelmChartConfig
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>metadata:
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span>name:<span class="w"> </span>traefik
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span>namespace:<span class="w"> </span>kube-system
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>spec:
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">  </span>valuesContent:<span class="w"> </span><span class="p">|</span>-
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span>additionalArguments:
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;--entryPoints.web.proxyProtocol.insecure&quot;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;--entryPoints.web.forwardedHeaders.insecure&quot;</span>
</span></code></pre></div>
<p>这样相当于让 traefik 信任前一级代理传过来的这些头部。更精细的话，还可以设置信任的 IP 地址范围，不过如果 traefik 不会直接暴露出去，就不用考虑这个问题了。</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-30 00:00:00+00:00">2022年1月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/os/" class="md-meta__link">os</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-m1-上运行-windows-arm-虚拟机"><a class="toclink" href="../../../../os/2022/01/30/windows-on-arm-on-m1/">在 M1 上运行 Windows ARM 虚拟机</a></h2>
<p>目前 Windows ARM 出了预览版，可以从 <a href="https://www.microsoft.com/en-us/software-download/windowsinsiderpreviewARM64">Windows Insider Preview Downloads</a> 下载，得到一个 9.5GB 的 vhdx 文件。</p>
<p>接着，用 qemu-img 转换为 vmdk 格式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>qemu-img<span class="w"> </span>convert<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vhdx<span class="w"> </span>-O<span class="w"> </span>vmdk<span class="w"> </span>-o<span class="w"> </span><span class="nv">adapter_type</span><span class="o">=</span>lsilogic<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vmdk
</span></code></pre></div>
<p>转换后，在 VMWare Fusion for Apple Silicon Tech Preview 中，选择从已有的 vmdk 中创建虚拟机，启动前修改一些设置，特别是内存，默认 256MB 肯定不够，默认单核 CPU 也太少了一些。内存不足可能导致安装失败，记住要第一次启动前设置。</p>
<p>启动以后会无法访问网络，按照下面网页里的方法设置网络：</p>
<p>https://www.gerjon.com/vmware/vmware-fusion-on-apple-silicion-m1/</p>
<p>需要注意的是，bcdedit 选项填的 IP 地址一般是 bridge 上的地址，比如 bridge101 的地址。</p>
<p>然后就可以正常工作了！</p>
<p>在 <a href="https://communities.vmware.com/t5/Fusion-for-Apple-Silicon-Tech/Vmware-Fusion-Apple-Silicon-Support-Windows/m-p/2868331">VMWare 论坛里</a>，还谈到了下面几个问题的解决方法：</p>
<p>为了让声音工作，可以修改 vmx 文件，设置 guestOS：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>guestOS = &quot;arm-windows11-64&quot;
</span></code></pre></div>
<p>这样声音就可以正常播放了。</p>
<p>分辨率的问题，可以用 RDP 来解决：首先在虚拟机里打开 Remote Desktop，然后用 macOS 的 Microsoft Remote Desktop Beta 访问即可。</p>
<p>系统里没有 Microsoft Store，要安装的话，用命令行的 Powershell 执行下面的命令：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>wsreset.exe -i
</span></code></pre></div>
<p>这个方法见 <a href="https://kb.parallels.com/128520">Parallels Desktop KB128520</a>。</p>
<p>UPDATE:</p>
<p>VMware Fusion 发布了新版本 <a href="https://blogs.vmware.com/teamfusion/2022/07/just-released-vmware-fusion-22h2-tech-preview.html">22H2</a>，有官方的 Windows 11 on ARM 支持了：</p>
<ul>
<li>Windows 11 on Intel and Apple Silicon with 2D GFX and Networking</li>
<li>VMtools installation for Windows 11 GOS on M1</li>
<li>Improved Linux support on M1</li>
<li>3D Graphics HW Acceleration and OpenGL 4.3 in Linux VMs* (Requires Linux 5.19+ &amp; Mesa 22.1.3+)</li>
<li>Virtual TPM Device</li>
<li>Fast Encryption</li>
<li>Universal Binary</li>
</ul>
<p>并且不需要上面写的网卡的 workaround 了：</p>
<div class="language-text highlight"><pre><span></span><code>vmxnet3 Networking Drivers for Windows on ARM

While Windows does not yet ship with our vmxnet3 networking driver for
Windows on ARM as it now does for Intel, the VMware Tools ISO on ARM
contains the 2 currently supported drivers for graphics and networking.
</code></pre></div>
<p>实测安装 VMware Tools 以后，就可以成功用 vmxnet3 网卡上网了，不需要之前的 bcdedit 方案。</p>
<p>但是目前测试 Linux 虚拟机有一些问题，一些内核版本在启动的时候 vmwgfx 驱动会报错，不能正常显示，但是系统是正常启动的，可以通过 SSH 访问。我测试的情况见下：</p>
<p>Linux 5.19.6(5.19.0-1-arm64): 可以正常启动和显示，但是没有 3D 加速（按照 VMware 的说法是需要 5.19 内核 + Mesa 22.1.1 以上，但是我的环境版本已经符合了这个要求，可能是 Debian 打包缺了什么东西）；</p>
<p>UPDATE（2022-09-27）：更新了一下系统，现在 <code>glxinfo</code> 可以看到 SVGA 了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>Device: SVGA3D; build: RELEASE; LLVM; (0x406)
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>Version: 22.2.0
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>Accelerated: no
</span></code></pre></div>
<p>但是显示有一些 BUG，刷新不正常。</p>
<p>Linux 5.18(5.18.0-0.bpo.1-arm64): <code>VMware Fusion has encountered an error and has shut down the virtual machine</code></p>
<p>Linux 5.16(5.16.0-0.bpo.4-arm64): SSH 也没启动，看不到内核日志</p>
<p>Linux 5.15.15(5.15.0-0.bpo.3-arm64):</p>
<p>图形界面起不来，可以通过 SSH 访问。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>[   10.765945] kernel BUG at drivers/gpu/drm/vmwgfx/vmwgfx_drv.h:1627!
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>[   10.766206] Call trace:
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>[   10.766207]  vmw_event_fence_action_queue+0x328/0x330 [vmwgfx]
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>[   10.766210]  vmw_stdu_primary_plane_atomic_update+0xd8/0x220 [vmwgfx]
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>[   10.766214]  drm_atomic_helper_commit_planes+0xf8/0x21c [drm_kms_helper]
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>[   10.766222]  drm_atomic_helper_commit_tail+0x5c/0xb0 [drm_kms_helper]
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>[   10.766225]  commit_tail+0x160/0x190 [drm_kms_helper]
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>[   10.766227]  drm_atomic_helper_commit+0x16c/0x400 [drm_kms_helper]
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>[   10.766230]  drm_atomic_commit+0x58/0x6c [drm]
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>[   10.766242]  drm_atomic_helper_set_config+0xe0/0x120 [drm_kms_helper]
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>[   10.766245]  drm_mode_setcrtc+0x1ac/0x680 [drm]
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>[   10.766249]  drm_ioctl_kernel+0xd0/0x120 [drm]
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>[   10.766253]  drm_ioctl+0x250/0x460 [drm]
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>[   10.766257]  vmw_generic_ioctl+0xbc/0x160 [vmwgfx]
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>[   10.766261]  vmw_unlocked_ioctl+0x24/0x30 [vmwgfx]
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>[   10.766264]  __arm64_sys_ioctl+0xb4/0x100
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>[   10.766287]  invoke_syscall+0x50/0x120
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>[   10.766300]  el0_svc_common.constprop.0+0x4c/0xf4
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>[   10.766302]  do_el0_svc+0x30/0x9c
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>[   10.766303]  el0_svc+0x28/0xb0
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>[   10.766327]  el0t_64_sync_handler+0x1a4/0x1b0
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>[   10.766328]  el0t_64_sync+0x1a0/0x1a4
</span></code></pre></div>
<p>回收硬盘空间：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>sudo<span class="w"> </span>vmware-toolbox-cmd<span class="w"> </span>disk<span class="w"> </span>shrink<span class="w"> </span>/
</span></code></pre></div>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-25 00:00:00+00:00">2022年1月25日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="risc-v-vector-10-工具链构建"><a class="toclink" href="../../../../software/2022/01/25/rvv-1.0-toolchain/">RISC-V Vector 1.0 工具链构建</a></h2>
<p>不久前 RVV 1.0 标准终于是出来了，但是工具链的支持目前基本还处于刚 upstream 还没有 release 的状态。而目前 RVV 1.0 的支持主要在 LLVM 上比较活跃，因此也是采用 LLVM Clang + GCC Newlib Toolchain 的方式进行配合，前者做 RVV 1.0 的编译，后者提供 libc 等基础库。</p>
<p>UPDATE: LLVM 14 已经发布，这个版本已经支持 RVV 1.0，直接从 https://apt.llvm.org 等地安装 LLVM 14 即可。</p>
<p>LLVM Clang 直接采用 upstream 即可。编译选项：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>cmake<span class="w"> </span>-G<span class="w"> </span>Ninja<span class="w"> </span>../llvm<span class="w"> </span>-DCMAKE_C_COMPILER<span class="o">=</span>clang<span class="w"> </span>-DCMAKE_CXX_COMPILER<span class="o">=</span>clang++<span class="w"> </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span>/prefix/llvm<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>-DLLVM_ENABLE_PROJECTS<span class="o">=</span><span class="s2">&quot;clang&quot;</span><span class="w"> </span>-DLLVM_TARGETS_TO_BUILD<span class="o">=</span><span class="s2">&quot;RISCV&quot;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>$<span class="w"> </span>ninja
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>$<span class="w"> </span>ninja<span class="w"> </span>install
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>$<span class="w"> </span>/prefix/llvm/bin/clang<span class="w"> </span>--version
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>clang<span class="w"> </span>version<span class="w"> </span><span class="m">14</span>.0.0<span class="w"> </span><span class="o">(</span>https://github.com/llvm/llvm-project.git<span class="w"> </span>8d298355ca3778a47fd6b3110aeee03ea5e8e02b<span class="o">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>Target:<span class="w"> </span>x86_64-unknown-linux-gnu
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>Thread<span class="w"> </span>model:<span class="w"> </span>posix
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>InstalledDir:<span class="w"> </span>/data/llvm/bin
</span></code></pre></div>
<p>还需要配合一个 GCC 工具链才可以完整地工作。可以直接采用 riscv-gnu-toolchain nightly 版本，比如 <a href="https://github.com/riscv-collab/riscv-gnu-toolchain/releases/download/2022.01.17/riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz">riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz</a>。下载以后解压，得到 riscv 目录，GCC 版本是比较新的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-gcc<span class="w"> </span>--version
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>riscv64-unknown-elf-gcc<span class="w"> </span><span class="o">(</span>GCC<span class="o">)</span><span class="w"> </span><span class="m">11</span>.1.0
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2021</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>see<span class="w"> </span>the<span class="w"> </span><span class="nb">source</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>copying<span class="w"> </span>conditions.<span class="w">  </span>There<span class="w"> </span>is<span class="w"> </span>NO
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>warranty<span class="p">;</span><span class="w"> </span>not<span class="w"> </span>even<span class="w"> </span><span class="k">for</span><span class="w"> </span>MERCHANTABILITY<span class="w"> </span>or<span class="w"> </span>FITNESS<span class="w"> </span>FOR<span class="w"> </span>A<span class="w"> </span>PARTICULAR<span class="w"> </span>PURPOSE.
</span></code></pre></div>
<p>但是如果编译 C++ 程序，链接的时候就会报错：<code>prefixed ISA extension must separate with _</code>，这是因为 riscv-gnu-toolchain 仓库的 binutils 版本不够新，在 upstream 的 binutils 里面已经修复了这个问题。所以 clone 下来，然后编译，覆盖掉 riscv-gnu-toolchain 里面的 binutils：</p>
<p>UPDATE: binutils 2.38 已经发布，用这个版本即可。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>../configure<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>--disable-gdb<span class="w"> </span>--disable-sim<span class="w"> </span>--disable-libdecnumber<span class="w"> </span>--disable-readline
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>$<span class="w"> </span>make
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>$<span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-ld<span class="w"> </span>--version
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>GNU<span class="w"> </span>Binutils<span class="o">)</span><span class="w"> </span><span class="m">2</span>.38.50.20220125
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2022</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>This<span class="w"> </span>program<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>you<span class="w"> </span>may<span class="w"> </span>redistribute<span class="w"> </span>it<span class="w"> </span>under<span class="w"> </span>the<span class="w"> </span>terms<span class="w"> </span>of
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>the<span class="w"> </span>GNU<span class="w"> </span>General<span class="w"> </span>Public<span class="w"> </span>License<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span><span class="o">(</span>at<span class="w"> </span>your<span class="w"> </span>option<span class="o">)</span><span class="w"> </span>a<span class="w"> </span>later<span class="w"> </span>version.
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>This<span class="w"> </span>program<span class="w"> </span>has<span class="w"> </span>absolutely<span class="w"> </span>no<span class="w"> </span>warranty.
</span></code></pre></div>
<p>然后编译程序的时候，使用 clang，配置参数 <code>--gcc-toolchain=~/riscv</code> 即可让 clang 找到 GNU 工具链。这样就可以编译出来 RVV 1.0 的程序了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>/llvm/bin/clang<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>-O2<span class="w"> </span>-march<span class="o">=</span>rv64gcv1p0<span class="w"> </span>-menable-experimental-extensions<span class="w"> </span>-mllvm<span class="w"> </span>--riscv-v-vector-bits-min<span class="o">=</span><span class="m">256</span><span class="w"> </span>--gcc-toolchain<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>add.cpp<span class="w"> </span>-o<span class="w"> </span>add
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>$<span class="w"> </span>/data/llvm/bin/llvm-objdump<span class="w"> </span>--mattr<span class="o">=</span>+v<span class="w"> </span>-S<span class="w"> </span>add
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">   </span>1020e:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">70</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>c5<span class="w">   </span>vsetivli<span class="w">        </span>zero,<span class="w"> </span><span class="m">8</span>,<span class="w"> </span>e32,<span class="w"> </span>m1,<span class="w"> </span>ta,<span class="w"> </span>mu
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">   </span><span class="m">10212</span>:<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>t1<span class="o">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">   </span><span class="m">10216</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span>e4<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>t2<span class="o">)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">   </span>1021a:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">07</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a4,<span class="w"> </span>-32
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">   </span>1021e:<span class="w"> </span><span class="m">07</span><span class="w"> </span>e5<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v10,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">   </span><span class="m">10222</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v11,<span class="w"> </span><span class="o">(</span>a4<span class="o">)</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">   </span><span class="m">10226</span>:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">85</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v8,<span class="w"> </span>v8,<span class="w"> </span>v10
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">   </span>1022a:<span class="w"> </span>d7<span class="w"> </span><span class="m">94</span><span class="w"> </span><span class="m">95</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v9,<span class="w"> </span>v9,<span class="w"> </span>v11
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">   </span>1022e:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">05</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a0,<span class="w"> </span>-32
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">   </span><span class="m">10232</span>:<span class="w"> </span><span class="m">27</span><span class="w"> </span>e4<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">   </span><span class="m">10236</span>:<span class="w"> </span>a7<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">05</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>a0<span class="o">)</span>
</span></code></pre></div>
<p>可以看到 llvm 的自动向量化是工作的。此外，也可以编写 rvv intrinsic。</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-12 00:00:00+00:00">2022年1月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="jiegech-停用"><a class="toclink" href="../../../../misc/2022/01/12/deprecating-jiege-ch/">jiege.ch 停用</a></h2>
<p>jiege.ch 域名不再续费，之后一直继续用 jia.je 这个域名。</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-05 00:00:00+00:00">2022年1月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="分析-diplomacy-系统"><a class="toclink" href="../../../../hardware/2022/01/05/diplomacy/">分析 Diplomacy 系统</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2022/01/05/diplomacy/#背景">背景</a></h3>
<p>在使用 Rocket Chip 的时候，难免要和 Diplomacy 打交道，那么它比较特别的语法和使用方式会带来一些学习上的困难，并且文档也比较少。本人在学习 Diplomacy 源码的时候，记录了这个笔记，希望对读者有所启发。</p>

    
      <nav class="md-post__action">
        <a href="../../../../hardware/2022/01/05/diplomacy/">
          继续阅读
        </a>
      </nav>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-03 00:00:00+00:00">2022年1月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="chisel3-cookbook"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/">Chisel3 Cookbook</a></h2>
<h3 id="chisel-版本选择"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#chisel-版本选择">Chisel 版本选择</a></h3>
<p>尽量选择较新版本的 Chisel。Chisel v3.5 完善了编译器插件，使得生成的代码中会包括更多变量名信息。</p>
<h3 id="去掉输出-verilog-文件中的寄存器随机初始化"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#去掉输出-verilog-文件中的寄存器随机初始化">去掉输出 Verilog 文件中的寄存器随机初始化</a></h3>
<p>版本：FIRRTL &gt;= 1.5.0-RC2</p>
<p>代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">&quot;-X&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;verilog&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">s&quot;</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v&quot;</span><span class="p">),</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="nc">CustomDefaultRegisterEmission</span><span class="p">(</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">      </span><span class="n">useInitAsPreset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">      </span><span class="n">disableRandomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="p">)</span>
</span></code></pre></div>
<p>设置 disableRandomization=true 即可。useInitAsPreset 不建议开启。</p>
<h3 id="关闭-firrtl-优化输出尽可能与源代码一致的-verilog"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#关闭-firrtl-优化输出尽可能与源代码一致的-verilog">关闭 FIRRTL 优化，输出尽可能与源代码一致的 Verilog</a></h3>
<p>设置 Chisel 生成 MinimumVerilog：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">&quot;-X&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mverilog&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">s&quot;</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v&quot;</span><span class="p">),</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">)</span>
</span></code></pre></div>
<p>此时代码中会保留更多原始 Chisel 代码的元素。</p>
<h3 id="重命名-axi4-为标准命名"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#重命名-axi4-为标准命名">重命名 AXI4 为标准命名</a></h3>
<p>Rocket Chip 中 AXI4Bundle 直接生成的名字和标准写法不同，可以利用 Chisel3 3.5.0 的 DataView 功能进行重命名：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// https://www.chisel-lang.org/chisel3/docs/explanations/dataview.html</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1">// use standard names</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">addrBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">dataBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">idBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">((</span><span class="n">dataBits</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="p">}</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="k">object</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataView</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">,</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">](</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="w">    </span><span class="n">vab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">(</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="w">        </span><span class="nc">AXI4BundleParameters</span><span class="p">(</span><span class="n">vab</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">idBits</span><span class="p">)</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="w">      </span><span class="p">),</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="w">    </span><span class="c1">// AW</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-8-62"><a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-8-63"><a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-8-64"><a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-8-65"><a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-8-66"><a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="w">    </span><span class="c1">// W</span>
</span><span id="__span-8-67"><a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-8-68"><a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-8-69"><a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-8-70"><a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">strb</span><span class="p">,</span>
</span><span id="__span-8-71"><a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span><span class="p">,</span>
</span><span id="__span-8-72"><a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a><span class="w">    </span><span class="c1">// B</span>
</span><span id="__span-8-73"><a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-8-74"><a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-8-75"><a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-8-76"><a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-8-77"><a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a><span class="w">    </span><span class="c1">// AR</span>
</span><span id="__span-8-78"><a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-8-79"><a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-8-80"><a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-8-81"><a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-8-82"><a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-8-83"><a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-8-84"><a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-8-85"><a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-8-86"><a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-8-87"><a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-8-88"><a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-8-89"><a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a><span class="w">    </span><span class="c1">// R</span>
</span><span id="__span-8-90"><a id="__codelineno-8-90" name="__codelineno-8-90" href="#__codelineno-8-90"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-8-91"><a id="__codelineno-8-91" name="__codelineno-8-91" href="#__codelineno-8-91"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-8-92"><a id="__codelineno-8-92" name="__codelineno-8-92" href="#__codelineno-8-92"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-8-93"><a id="__codelineno-8-93" name="__codelineno-8-93" href="#__codelineno-8-93"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-8-94"><a id="__codelineno-8-94" name="__codelineno-8-94" href="#__codelineno-8-94"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-8-95"><a id="__codelineno-8-95" name="__codelineno-8-95" href="#__codelineno-8-95"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span>
</span><span id="__span-8-96"><a id="__codelineno-8-96" name="__codelineno-8-96" href="#__codelineno-8-96"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-8-97"><a id="__codelineno-8-97" name="__codelineno-8-97" href="#__codelineno-8-97"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">.</span><span class="n">axiView</span><span class="p">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-8-98"><a id="__codelineno-8-98" name="__codelineno-8-98" href="#__codelineno-8-98"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span>
</span><span id="__span-8-99"><a id="__codelineno-8-99" name="__codelineno-8-99" href="#__codelineno-8-99"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span>
</span><span id="__span-8-100"><a id="__codelineno-8-100" name="__codelineno-8-100" href="#__codelineno-8-100"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span>
</span><span id="__span-8-101"><a id="__codelineno-8-101" name="__codelineno-8-101" href="#__codelineno-8-101"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">idBits</span>
</span><span id="__span-8-102"><a id="__codelineno-8-102" name="__codelineno-8-102" href="#__codelineno-8-102"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-8-103"><a id="__codelineno-8-103" name="__codelineno-8-103" href="#__codelineno-8-103"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-8-104"><a id="__codelineno-8-104" name="__codelineno-8-104" href="#__codelineno-8-104"></a><span class="p">}</span>
</span><span id="__span-8-105"><a id="__codelineno-8-105" name="__codelineno-8-105" href="#__codelineno-8-105"></a>
</span><span id="__span-8-106"><a id="__codelineno-8-106" name="__codelineno-8-106" href="#__codelineno-8-106"></a><span class="c1">// usage</span>
</span><span id="__span-8-107"><a id="__codelineno-8-107" name="__codelineno-8-107" href="#__codelineno-8-107"></a><span class="kd">val</span><span class="w"> </span><span class="nc">MEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
</span><span id="__span-8-108"><a id="__codelineno-8-108" name="__codelineno-8-108" href="#__codelineno-8-108"></a><span class="nc">MEM</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mem_axi4</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">viewAs</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">]</span>
</span></code></pre></div>
<h3 id="给所有模块添加名称前缀"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#给所有模块添加名称前缀">给所有模块添加名称前缀</a></h3>
<p>有些时候，我们希望给所有模块添加一个名称前缀，防止可能出现的冲突。</p>
<p>在 Chisel 3 中，可以使用自定义 FIRRTL Transform 来实现这个功能。这一部分的实现参考了 <a href="https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578">chisel issue #1059</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">options</span><span class="p">.</span><span class="nc">Dependency</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">passes</span><span class="p">.</span><span class="nc">PassException</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">transforms</span><span class="p">.</span><span class="nc">DedupModules</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="c1">// adapted from https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="cm">/** Specifies a global prefix for all module names. */</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="cm">/** FIRRTL pass to add prefix to module names</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="cm">  */</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="k">object</span><span class="w"> </span><span class="nc">PrefixModulesPass</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Transform</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">DependencyAPIMigration</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">  </span><span class="c1">// we run after deduplication to save some work</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">prerequisites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">[</span><span class="nc">DedupModules</span><span class="p">])</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">  </span><span class="c1">// we do not invalidate the results of any prior passes</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">invalidates</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Transform</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">protected</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nc">CircuitState</span><span class="p">):</span><span class="w"> </span><span class="nc">CircuitState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">prefixes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">prefix</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">    </span><span class="p">}.</span><span class="n">distinct</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">    </span><span class="n">prefixes</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;[PrefixModulesPass] No ModulePrefix annotation found.&quot;</span><span class="p">)</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">        </span><span class="n">state</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">state</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">circuit</span><span class="p">.</span><span class="n">mapModule</span><span class="p">(</span><span class="n">onModule</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">main</span><span class="p">))</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PassException</span><span class="p">(</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">          </span><span class="s">s&quot;[PrefixModulesPass] found more than one prefix annotation: </span><span class="si">$</span><span class="n">other</span><span class="s">&quot;</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">        </span><span class="p">)</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onModule</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">ExtModule</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">mod</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Module</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">name</span>
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onStmt</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">        </span><span class="n">mod</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onStmt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-50"><a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefInstance</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">module</span><span class="p">)</span>
</span><span id="__span-9-51"><a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w">             </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">mapStmt</span><span class="p">(</span><span class="n">onStmt</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-9-52"><a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-9-53"><a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a><span class="p">}</span>
</span></code></pre></div>
<p>实现思路就是遍历 IR，找到所有的 Module 并改名，再把所有模块例化也做一次替换。最后在生成 Verilog 的时候添加 Annotation 即可：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">s&quot;</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v&quot;</span><span class="p">),</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="nc">RunFirrtlTransformAnnotation</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">(</span><span class="nc">PrefixModulesPass</span><span class="p">)),</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">  </span><span class="p">)</span>
</span></code></pre></div>
<p>如果使用新的 MLIR FIRRTL Compiler，则可以利用 <code>sifive.enterprise.firrtl.NestedPrefixModulesAnnotation</code> annotation，让 firtool 来进行 <a href="https://github.com/llvm/circt/blob/fc6b00fd20d8a50f17a908cc681c8cf3a4d1c000/lib/Dialect/FIRRTL/Transforms/PrefixModules.cpp">prefix 操作</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">package</span><span class="w"> </span><span class="n">sifive</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span><span class="k">package</span><span class="w"> </span><span class="n">enterprise</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="k">package</span><span class="w"> </span><span class="n">firrtl</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">      </span><span class="k">import</span><span class="w"> </span><span class="nn">_root_</span><span class="p">.</span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">target</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">,</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">          </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">          </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SingleTargetAnnotation</span><span class="p">[</span><span class="nc">Target</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">duplicate</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">):</span><span class="w"> </span><span class="nc">Annotation</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">          </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="p">}</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="k">object</span><span class="w"> </span><span class="nc">AddPrefix</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="nc">Module</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">    </span><span class="n">annotate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">ChiselAnnotation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">toFirrtl</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">toTarget</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个方法的灵感来自 @sequencer。唯一的缺点就是比较 Hack，建议 SiFive 把相关的类也开源出来用。</p>
<p>到了 Chisel 7.0，模块名称前缀的功能已经内置：<a href="https://www.chisel-lang.org/docs/explanations/moduleprefix">Module Prefixing</a>。</p>
<h3 id="关闭-rtl-级别的优化"><a class="toclink" href="../../../../hardware/2022/01/03/chisel3-cookbook/#关闭-rtl-级别的优化">关闭 RTL 级别的优化</a></h3>
<p>Chisel3 生成 Verilog/System Verilog 的时候会进行一些优化。如果想要关闭这些优化，可以使用：</p>
<ol>
<li><a href="https://www.chisel-lang.org/docs/cookbooks/naming">dontTouch annotation</a></li>
<li>添加命令行参数：<code>--preserve-values=[none/named/all]</code>，见 <a href="https://circt.llvm.org/docs/Dialects/FIRRTL/RationaleFIRRTL/">FIRRTL Dialect Rationale</a></li>
</ol>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-01-03 00:00:00+00:00">2022年1月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="升级-linksys-e8450-的-openwrt-系统到-ubi"><a class="toclink" href="../../../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/">升级 Linksys E8450 的 OpenWRT 系统到 UBI</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#背景">背景</a></h3>
<p>在 <a href="https://openwrt.org/toh/linksys/e8450">OpenWRT Linksys E8450 页面</a> 中，如果要用新版的固件，需要转换到 UBI 格式的文件系统。之前用的是 non-UBI 格式的文件系统，直接在官方的分区下，覆盖掉其中一个启动分区。但是经常会报告 flash 出错，然后系统也不稳定，决定要按照文档更新到 UBI。</p>
<h3 id="步骤"><a class="toclink" href="../../../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#步骤">步骤</a></h3>
<p>请注意：更换文件系统操作比较危险，请先备份好数据，并做好变砖的心理准备。本文仅记录了作者编写时可行的更新操作，不代表读者在阅读时，依然可以按照这个顺序进行，请按照 <a href="https://github.com/dangowrt/owrt-ubi-installer">https://github.com/dangowrt/owrt-ubi-installer</a> 的文档进行操作。</p>
<p>基本按照文档一步一步走。初始状态是一个 non-UBI 版本的 OpenWRT 固件：</p>
<ol>
<li>下载官方的 1.0 固件：https://downloads.linksys.com/support/assets/firmware/FW_E8450_1.0.01.101415_prod.img</li>
<li>在 luci 中，刷入官方 1.0 固件，这时候进入了官方固件的系统</li>
<li>登录官方固件网页，恢复出厂设置</li>
<li>下载 openwrt ubi recovery <a href="https://github.com/dangowrt/linksys-e8450-openwrt-installer/releases/download/v0.6.1/openwrt-mediatek-mt7622-linksys_e8450-ubi-initramfs-recovery-installer.itb">固件</a> 然后在官方固件里刷入</li>
<li>这时候进入了 recovery 固件，下载 <a href="https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">ubi 固件</a>，继续在网页里刷入</li>
<li>这时候固件就更新完成了。ssh root@192.168.1.1，然后进去安装 luci 等软件，恢复配置即可。</li>
</ol>
    
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <span class="md-pagination__current">2</span>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../2023/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2023">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                2023
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../2021/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2021">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2021
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016-2025 Jiajie Chen
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>