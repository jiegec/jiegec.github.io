
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维,编程,调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/archive/2021/">
      
      
        <link rel="prev" href="../2022/">
      
      
        <link rel="next" href="../2020/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0">
    
    
      
        <title>2021 - 杰哥的{运维,编程,调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0c456da8.min.css">
      
      

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-3109FRSVTT",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2021" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2021
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../2023/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../category/crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2021
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#xrdp-nvidia" class="md-nav__link">
    XRDP 和 NVIDIA 显卡兼容性问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nvidia-cuda" class="md-nav__link">
    NVIDIA 驱动和 CUDA 版本信息速查
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    「教学」缓存一致性协议分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dram-kintex-7-fpga-vref" class="md-nav__link">
    DRAM 在 Kintex 7 FPGA 上内部 Vref 的性能问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dram" class="md-nav__link">
    「教学」DRAM 结构和特性
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-debug" class="md-nav__link">
    「教学」RISC-V Debug 协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    教学随想
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manycore" class="md-nav__link">
    Manycore 处理器架构分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sunway" class="md-nav__link">
    Sunway 处理器架构分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rocket-chip-on-vcu128" class="md-nav__link">
    移植系统到 Rocket Chip on VCU128
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esxi" class="md-nav__link">
    ESXi 常用信息
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#axi-quad-spi" class="md-nav__link">
    「教学」AXI Quad SPI 时序分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k8s" class="md-nav__link">
    研究 k8s 网络工作原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu" class="md-nav__link">
    浅谈乱序执行 CPU
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locale" class="md-nav__link">
    Locale 影响排序的特殊副作用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rhel-6-centos-7" class="md-nav__link">
    一次从 RHEL 6 到 CentOS 7 的更新
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    轶事一则
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#homebridge-broadlink-rm-pro" class="md-nav__link">
    配置 homebridge-broadlink-rm-pro
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    轶事一则
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-post-internal-server-error" class="md-nav__link">
    Nginx 处理 POST 请求出现 Internal Server Error 排查一则
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k8s-rook-ceph-cephadm" class="md-nav__link">
    将 k8s rook ceph 集群迁移到 cephadm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-11-abi" class="md-nav__link">
    C++ 11 的 ABI 问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    硬盘相关的概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esxi-perccli-raid" class="md-nav__link">
    在 ESXi 中用 PERCCli 换 RAID 中的盘
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fluentd-k8s" class="md-nav__link">
    用 fluentd 收集 k8s 中容器的日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ipmitool-ilo-4" class="md-nav__link">
    通过 ipmitool 配置 iLO 4 管理端口
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ipmitool" class="md-nav__link">
    静态编译 ipmitool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esxi" class="md-nav__link">
    ESXi 网络配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linksys-e8450-openwrt-w-80211ax" class="md-nav__link">
    Linksys E8450 OpenWRT 配置 w/ 802.11ax
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gitlab-ci-k8s" class="md-nav__link">
    用 gitlab ci 构建并部署应用到 k8s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gnome-fractional-scaling" class="md-nav__link">
    Gnome 的 Fractional Scaling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rook-k8s-ceph" class="md-nav__link">
    通过 rook 在 k8s 上部署 ceph 集群
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k3s-k8s" class="md-nav__link">
    用 k3s 部署 k8s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    常用交换机命令
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pcb" class="md-nav__link">
    PCB 笔记
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#idrac" class="md-nav__link">
    iDRAC 各版本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sssd-ldap" class="md-nav__link">
    使用 SSSD 的 LDAP 认证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#big-surm1-latex" class="md-nav__link">
    在 Big Sur(M1) 上解决 LaTeX 找不到楷体字体的问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common" class="md-nav__link">
    COMMON 符号
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skid-buffer" class="md-nav__link">
    Skid Buffer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m1-qemu-debian" class="md-nav__link">
    在 M1 上用 QEMU 运行 Debian 虚拟机
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2021">2021<a class="headerlink" href="#2021" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-29 00:00:00">2021年12月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="xrdp-nvidia"><a class="toclink" href="../../software/2021/12/29/xrdp-nvidia/">XRDP 和 NVIDIA 显卡兼容性问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/12/29/xrdp-nvidia/#_1">背景</a></h3>
<p>最近在尝试配置 XRDP，发现它在有 NVIDIA 的机器上启动远程桌面后会黑屏，查看错误信息可以看到：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/12/29/xrdp-nvidia/#__codelineno-0-1"></a>xf86OpenConsole: Cannot open virtual console 1 (Permission denied)
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../software/2021/12/29/xrdp-nvidia/#_2">解决方法</a></h3>
<p>XRDP 作者在 <a href="https://github.com/neutrinolabs/xrdp/issues/2010#issuecomment-942561105">issue #2010</a> 中提到了解决方法：</p>
<p>修改 /etc/xrdp/sesman.ini，在 <code>[Xorg]</code> 部分里加上下面的配置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2021/12/29/xrdp-nvidia/#__codelineno-1-1"></a>param=-configdir
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2021/12/29/xrdp-nvidia/#__codelineno-1-2"></a>param=/
</span></code></pre></div>
<p>实际上就是不让 Xorg 加载 nvidia xorg 驱动，这样就绕过了问题。</p>

    <nav class="md-post__action">
      <a href="../../software/2021/12/29/xrdp-nvidia/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-26 00:00:00">2021年12月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nvidia-cuda"><a class="toclink" href="../../software/2021/12/26/nvidia-cuda/">NVIDIA 驱动和 CUDA 版本信息速查</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/12/26/nvidia-cuda/#_1">背景</a></h3>
<p>之前和 NVIDIA 驱动和 CUDA 搏斗比较多，因此记录一下一些常用信息，方便查询。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/12/26/nvidia-cuda/#_2">常用地址</a></h3>
<ul>
<li><a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux">CUDA Toolkit Downloads</a></li>
<li><a href="https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html">NVIDIA Driver Installation Quickstart Guide</a></li>
<li><a href="https://www.nvidia.com/Download/index.aspx">NVIDIA Driver Downloads</a></li>
<li><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html">NVIDIA Docker Installation Guide</a></li>
</ul>
<h3 id="cuda-nvidia"><a class="toclink" href="../../software/2021/12/26/nvidia-cuda/#cuda-nvidia">CUDA 版本与 NVIDIA 驱动兼容性</a></h3>
<p>可以通过 apt show cuda-runtime-x-x 找到：</p>
<ul>
<li>cuda 12.1 &gt;= 530</li>
<li>cuda 12.0 &gt;= 525</li>
<li>cuda 11.7 &gt;= 515</li>
<li>cuda 11.6 &gt;= 510</li>
<li>cuda 11.5 &gt;= 495</li>
<li>cuda 11.4 &gt;= 470</li>
<li>cuda 11.3 &gt;= 465</li>
<li>cuda 11.2 &gt;= 460</li>
<li>cuda 11.1 &gt;= 455</li>
<li>cuda 11.0 &gt;= 450</li>
<li>cuda 10.2 &gt;= 440</li>
<li>cuda 10.1 &gt;= 418</li>
<li>cuda 10.0 &gt;= 410</li>
<li>cuda 9.2 &gt;= 396</li>
<li>cuda 9.1 &gt;= 387</li>
<li>cuda 9.0 &gt;= 384</li>
</ul>
<p>使用 nvidia-smi 看到的 CUDA 版本，通常就是这个驱动在上表里对应的 CUDA 版本，例如内核驱动版本是 470 的话，看到的 CUDA 版本就是 11.4。</p>
<p>不过，实际上兼容的版本会更多一些：<a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html">官方文档</a> 里面写了 CUDA 11.x 可以兼容 NVIDIA &gt;= 450。</p>
<h3 id="cuda-gccclang"><a class="toclink" href="../../software/2021/12/26/nvidia-cuda/#cuda-gccclang">CUDA 版本和 GCC/Clang 版本兼容性</a></h3>
<p>可以在 cuda/include/crt/host_config.h 文件里找到：</p>
<ul>
<li>cuda 12.1: gcc &lt;= 12, 3.2 &lt; clang &lt; 16</li>
<li>cuda 12.0: gcc &lt;= 12, 3.2 &lt; clang &lt; 15</li>
<li>cuda 11.5: gcc &lt;= 11</li>
<li>cuda 11.4: gcc &lt;= 10</li>
<li>cuda 11.3: gcc &lt;= 10, 3.2 &lt; clang &lt; 12</li>
<li>cuda 11.1: gcc &lt;= 10, 3.2 &lt; clang &lt; 11</li>
<li>cuda 11.0: gcc &lt;= 9, 3.2 &lt; clang &lt; 10</li>
<li>cuda 10.2: gcc &lt;= 8, 3.2 &lt; clang &lt; 9</li>
<li>cuda 10.1: gcc &lt;= 8, 3.2 &lt; clang &lt; 9</li>
<li>cuda 10.0: gcc &lt;= 7</li>
<li>cuda 9.1: gcc &lt;= 6</li>
</ul>
<h3 id="cuda"><a class="toclink" href="../../software/2021/12/26/nvidia-cuda/#cuda">CUDA 版本与显卡兼容性</a></h3>
<p>编译选项与显卡对应关系 https://arnon.dk/matching-sm-architectures-arch-and-gencode-for-various-nvidia-cards/</p>
<p>可以在 <code>nvcc --help</code> 搜索 gpu-architecture 找到：</p>
<ul>
<li>cuda 12.0 sm_50 to sm_90a</li>
<li>cuda 11.4 sm_35 to sm_87</li>
<li>cuda 11.3 sm_35 to sm_86</li>
<li>cuda 11.1 sm_35 to sm_86</li>
<li>cuda 11.0 sm_35 to sm_80</li>
<li>cuda 10.2 sm_30 to sm_75</li>
<li>cuda 10.0 sm_30 to sm_75</li>
<li>cuda 9.1 sm_30 to sm_72</li>
<li>cuda 9.0 sm_30 to sm_70</li>
</ul>
<p>显卡的 Compute Capability 可以在 https://developer.nvidia.com/cuda-gpus 找到：</p>
<ul>
<li>H100: 90</li>
<li>A100: 80</li>
<li>V100: 70</li>
<li>P100: 60</li>
</ul>
<h3 id="nvidia"><a class="toclink" href="../../software/2021/12/26/nvidia-cuda/#nvidia">升级 NVIDIA 驱动</a></h3>
<p>升级后，需要 rmmod 已有的，再 modprobe 新的：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/12/26/nvidia-cuda/#__codelineno-0-1"></a>sudo<span class="w"> </span>rmmod<span class="w"> </span>nvidia_uvm<span class="w"> </span>nvidia_drm<span class="w"> </span>nvidia_modeset<span class="w"> </span>nvidia<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>modprobe<span class="w"> </span>nvidia
</span></code></pre></div>
<p>如果发现 rmmod 失败，可以 <code>lsof /dev/nvidiactl</code> 查看谁在占用。DGX 上需要停止：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2021/12/26/nvidia-cuda/#__codelineno-1-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>nvsm.service
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2021/12/26/nvidia-cuda/#__codelineno-1-2"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>nvidia-dcgm.service<span class="w"> </span>
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../software/2021/12/26/nvidia-cuda/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-17 00:00:00">2021年12月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 15 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/">「教学」缓存一致性协议分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#_2">背景</a></h3>
<p>最近在《高等计算机系统结构》课程中学习缓存一致性协议算法，这里用自己的语言来组织一下相关知识的讲解。</p>
<h3 id="write-invalidate-write-update"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#write-invalidate-write-update">Write-invalidate 和 Write-update</a></h3>
<p>最基础的缓存一致性思想有两种：</p>
<ol>
<li>Write-invalidate：写入数据的时候，将其他 Cache 中这条 Cache Line 设为 Invalid</li>
<li>Write-update：写入数据的时候，把新的结果写入到有这条 Cache Line 的其他 Cache</li>
</ol>
<h3 id="write-once"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#write-once">Write-once 协议</a></h3>
<p>Write-once 协议定义了四个状态：</p>
<ol>
<li>Invalid：表示这个块不合法</li>
<li>Valid：表示这个块合法，并可能是共享的，同时数据没有修改</li>
<li>Reserved：表示这个块合法，不是共享的，同时数据没有更改</li>
<li>Dirty：表示这个块合法，不是共享的，数据做了修改，和内存不同。</li>
</ol>
<p>可见，当一个缓存状态在 R 或者 D，其他缓存只能是 I；而缓存状态是 V 的时候，可以有多个缓存在 V 状态。</p>
<p>Write-once 协议的特点是，第一次写的时候，会写入到内存（类似 Write-through），连续写入则只写到缓存中，类似 Write-back。</p>
<p>当 Read hit 的时候，状态不变。</p>
<div class="language-text highlight"><pre><span></span><code>Read hit: The information is supplied by the current cache. No state change.
</code></pre></div>
<p>当 Read miss 的时候，会查看所有缓存，如果有其他缓存处于 Valid/Reserved/Dirty 状态，就从其他缓存处读取数据，然后设为 Valid，其他缓存也设为 Valid。如果其他缓存处于 Dirty 状态，还要把数据写入内存。</p>
<div class="language-text highlight"><pre><span></span><code>Read miss: The data is read from main memory. The read is snooped by other caches; if any of them have the line in the Dirty state, the read is interrupted long enough to write the data back to memory before it is allowed to continue. Any copies in the Dirty or Reserved states are set to the Valid state.
</code></pre></div>
<p>当 Write hit 的时候，如果是 Valid 状态，首先写入内存，把其他 Cache 都设为 Invalid，进入 Reserved 状态，这意味着第一次写是 Write-through。如果是 Reserved/Dirty 状态，则不修改内存，进入 Dirty 状态，这表示后续的写入都是 Write-back。</p>
<div class="language-text highlight"><pre><span></span><code>Write hit: If the information in the cache is in Dirty or Reserved state, the cache line is updated in place and its state is set to Dirty without updating memory. If the information is in Valid state, a write-through operation is executed updating the block and the memory and the block state is changed to Reserved. Other caches snoop the write and set their copies to Invalid.
</code></pre></div>
<p>当 Write miss 的时候，这个行为 Wikipedia 上和上课讲的不一样。按照 Wikipedia 的说法，首先按照 Read miss 处理，再按照 Write hit 处理，类似于 Write Allocate 的思路。如果是这样的话，那么首先从其他缓存或者内存读取数据，然后把其他缓存都设为 Invalid，把更新后的数据写入内存，进入 Reserved 状态。相当于 Write miss 的时候，也是按照 Write-through 实现。</p>
<div class="language-text highlight"><pre><span></span><code>Write miss: A partial cache line write is handled as a read miss (if necessary to fetch the unwritten portion of the cache line) followed by a write hit. This leaves all other caches in the Invalid state, and the current cache in the Reserved state.
</code></pre></div>
<p>教材上则是 Write miss 的时候按照 Write-back 处理。如果其他缓存都是 Invalid 时，从内存里读取数据，然后写入到缓存中，进入 Dirty 状态。如果其他缓存是 Valid/Reserved/Dirty 状态，就从其他缓存里读取数据，让其他缓存都进入 Invalid 状态，然后更新自己的数据，进入 Dirty 状态。</p>
<h3 id="msi"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#msi">MSI 协议</a></h3>
<p>MSI 协议比较简单，它定义了三个状态：</p>
<ol>
<li>Modified：表示数据已经修改，和内存里不一致</li>
<li>Shared：数据和内存一致，可以有一到多个缓存同时处在 Shared 状态</li>
<li>Invalid：不在缓存中</li>
</ol>
<p>当 Read hit 的时候，状态不变。</p>
<p>当 Read miss 的时候，检查其他缓存的状态，如果都是 Invalid，就从内存里读取，然后进入 Shared 状态。如果有 Shared，就从其他缓存处读取。如果有 Dirty，那就要把其他缓存的数据写入内存和本地缓存，然后进入 Shared 状态。</p>
<p>当 Write hit 的时候，如果现在是 Shared 状态，则要让其他的 Shared 缓存进入 Invalid 状态，然后更新数据，进入 Modified 状态。如果是 Modified 状态，那就修改数据，状态保持不变。</p>
<p>当 Write miss 的时候，如果有其他缓存处于 Modified/Shared 状态，那就从其他缓存处读取数据，并让其他缓存进入 Invalid 状态，然后修改本地数据，进入 Modified 状态。如果所有缓存都是 Invalid 状态，那就从内存读入，然后修改缓存数据，进入 Modified 状态。</p>
<h3 id="mesi"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#mesi">MESI 协议</a></h3>
<p>MESI 协议定义了四种状态：</p>
<ol>
<li>Modified：数据与内存不一致，并且只有一个缓存有数据</li>
<li>Exclusive：数据与内存一致，并且只有一个缓存有数据</li>
<li>Shared：数据与内存一致，可以有多个缓存同时有数据</li>
<li>Invalid：不在缓存中</li>
</ol>
<p>当 Read hit 的时候，状态不变。</p>
<p>当 Read miss 的时候，首先会检查其他缓存的状态，如果有数据，就从其他缓存读取数据，并且都进入 Shared 状态，如果其他缓存处于 Modified 状态，还需要把数据写入内存；如果其他缓存都没有数据，就从内存里读取，然后进入 Exclusive 状态。</p>
<p>当 Write hit 的时候，进入 Modified 状态，同时让其他缓存进入 Invalid 状态。</p>
<p>当 Write miss 的时候，检查其他缓存的状态，如果有数据，就从其他缓存读取，否则从内存读取。然后，其他缓存都进入 Invalid 状态，本地缓存更新数据，进入 Modified 状态。</p>
<p>值得一提的是，Shared 状态不一定表示只有一个缓存有数据：比如本来有两个缓存都是 Shared 状态，然后其中一个因为缓存替换变成了 Invalid，那么另一个是不会受到通知变成 Exclusive 的。Exclusive 的设置是为了减少一些总线请求，比如当数据只有一个核心访问的时候，只有第一次 Read miss 会发送总线请求，之后一直在 Exclusive/Modified 状态中，不需要发送总线请求。</p>
<h3 id="moesi"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#moesi">MOESI 协议</a></h3>
<p>MOESI 定义了五个状态：</p>
<ol>
<li>Modified：数据经过修改，并且只有一个缓存有这个数据</li>
<li>Owned：同时有多个缓存有这个数据，但是只有这个缓存可以修改数据</li>
<li>Exclusive：数据没有修改，并且只有一个缓存有这个数据</li>
<li>Shared：同时有多个缓存有这个数据，但是不能修改数据</li>
<li>Invalid：不在缓存中</li>
</ol>
<p>状态中，M 和 E 是独占的，所有缓存里只能有一个。此外，可以同时有多个 S，或者多个 S 加一个 O，但是不能同时有多个 O。</p>
<p>它的状态转移与 MESI 类似，区别在于：当核心写入 Owned 状态的缓存时，有两种方式：1）通知其他 Shared 的缓存更新数据；2）把其他 Shared 缓存设为 Invalid，然后本地缓存进入 Modified 状态。在 Read miss 的时候，则可以从 Owned 缓存读取数据，进入 Shared 状态，而不用写入内存。它相比 MESI 的好处是，减少了写回内存的次数。</p>
<p>AMD64 文档里采用的就是 MOESI 协议。AMBA ACE 协议其实也是 MOESI 协议，只不过换了一些名称，表示可以兼容 MEI/MESI/MOESI 中的一个协议。ACE 对应关系如下：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>需要注意的是，SharedClean 并不代表它的数据和内存一致，比如说和 SharedDirty 缓存一致，它只是说缓存替换的时候，不需要写回内存。</p>
<h3 id="dragon"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#dragon">Dragon 协议</a></h3>
<p>Dragon 协议是一个基于更新的协议，意味着写入缓存的时候，会把更新的数据同步到拥有这个缓存行的其他核心。它定义了四个状态：</p>
<ol>
<li>Exclusive clean(E)：独占，并且数据和内存一致</li>
<li>Shared clean(Sc)：数据同时存在多个缓存中，并且自己不是最后一个写入该缓存数据的</li>
<li>Shared modified(Sm)：数据同时存在多个缓存中，并且自己设最后一个写入该缓存数据的，类似于前面 MOESI 协议的 Owner 状态</li>
<li>Modify(M)：独占，并且数据和内存不一致</li>
</ol>
<p>可以看到，E 和 M 都是独占的，如果出现了多个缓存有同一个缓存行，那就是若干个 Sc 和一个 Sm。</p>
<p>当 Read miss 的时候，在总线上检查是否有缓存已经有这个缓存行的数据，如果没有，则从内存读取并转到 Exclusive clean 状态；如果已经在其他缓存中，则从其他缓存读取，将其他缓存转移到 Shared clean/Shared modified 状态，然后该缓存转移到 Shared clean 状态。</p>
<p>当 Write miss 的时候，同样检查其他缓存的状态，如果是第一个访问的，就从内存读取，更新数据，然后转到 Modify 状态；如果不是第一个访问的，就进入 Shared modified 状态，并且让原来 Shared modified 的缓存进入 Shared clean 状态。</p>
<p>当 Write hit 的时候，如果状态是 Shared modified，这时候需要通知其他缓存更新数据；如果状态是 Shared clean，则要通知其他缓存更新数据的同时，让原来 Shared modified 的缓存进入 Shared clean 状态；如果状态是 Exclusive clean，则进入 Modify 状态。</p>
<p>在这里，Shared modified 的缓存负责在换出的时候，写入数据到内存中。</p>
<h3 id="ace"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#ace">ACE 协议</a></h3>
<p>ACE 协议在 AXI 的基础上，添加了三个 channel：</p>
<ol>
<li>AC: Coherent address channel, Input to master: ACADDR, ACSNOOP, ACPROT</li>
<li>CR: Coherent response channel, Output from master: CRRESP</li>
<li>CD: Coherent data channel, Output from master: CDDATA, CDLAST</li>
</ol>
<p>此外，已有的 Channel 也添加了信号：</p>
<ol>
<li>ARSNOOP[3:0]/ARBAR[1:0]/ARDOMAIN[1:0]</li>
<li>AWSNOOP[3:0]/AWBAR[1:0]/AWDOMAIN[1:0]/AWUNIQUE</li>
<li>RRESP[3:2]</li>
<li>RACK/WACK</li>
</ol>
<p>ACE-lite 只在已有 Channel 上添加了新信号，没有添加新的 Channel。因此它内部不能有 Cache，但是可以访问一致的缓存内容。</p>
<p>当 Read miss 的时候，首先 AXI master 发送 read transaction 给 Interconnect，Interconnect 向保存了这个缓存行的缓存发送 AC 请求，如果有其他 master 提供了数据，就向请求的 master 返回数据；如果没有其他 master 提供数据，则向内存发起读请求，并把结果返回给 master，最后 master 提供 RACK 信号。</p>
<p>当 Write miss 的时候，也是类似地，AXI master 发送 MakeUnique 请求给 Interconnect，Interconnect 向保存了该缓存行的缓存发送请求，要求其他 master 状态改为 Invalid；当所有 master 都已经 invalidate 成功，就向原 AXI master 返回结果。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#_3">基于目录的缓存一致性</a></h3>
<p>上面的缓存一致性协议中，经常有这么一个操作：向所有有这个缓存行的缓存发送/接受消息。简单的方法是直接广播，然后接受端自己判断是否处理。但是这个方法在核心很多的时候会导致广播流量太大，因此需要先保存下来哪些缓存会有这个缓存的信息，然后对这些缓存点对点地发送。这样就可以节省一些网络流量。</p>
<p>那么，怎么记录这个信息呢？一个简单的办法（Full bit vector format）是，有一个全局的表，对每个缓存行，都记录一个大小为 N（N 为核心数）的位向量，1 表示对应的核心中有这个缓存行。但这个方法保存数据量太大：缓存行数正比于 N，还要再乘以一次 N，总容量是 O(N^2) 的。</p>
<p>一个稍微好一些的方法（Coarse bit vector format）是，我把核心分组，比如按照 NUMA 节点进行划分，此时每个缓存行都保存一个大小为 M（M 为 NUMA 数量）的位向量，只要这个 NUMA 节点里有这个缓存行，对应位就取 1。这样相当于是以牺牲一部分流量为代价（NUMA 节点内部广播），来节省一些目录的存储空间。</p>
<p>但实际上，通常情况下，一个缓存行通常只会在很少的核心中保存，所以这里有很大的优化空间。比如说，可以设置一个缓存行同时出现的缓存数量上限 (Limited pointer format)，然后保存核心的下标而不是位向量，这样的存储空间就是 O(Nlog2N)。但是呢，这样限制了缓存行同时出现的次数，如果超过了上限，需要替换掉已有的缓存，可能在一些场景下性能会降低。</p>
<p>还有一种方式，就是链表 (Chained directory format)。目录中保存最后一次访问的核心编号，然后每个核心的缓存里，保存了下一个保存了这个缓存行的核心编号，或者表示链表终止。这样存储空间也是 O(Nlog2N)，不过发送消息的延迟更长，因为要串行遍历一遍，而不能同时发送。类似地，可以用二叉树 (Number-balanced binary tree format) 来组织：每个缓存保存两个指针，指向左子树和右子树，然后分别遍历，目的还是加快遍历的速度，可以同时发送消息给多个核心。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2021/12/17/cache-coherency-protocol/#_4">参考文档</a></h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Cache_coherence">Cache coherence</a></li>
<li><a href="https://en.wikipedia.org/wiki/MSI_protocol">MSI protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/Write-once_(cache_coherence)">Write-once (cache coherence)</a></li>
<li><a href="https://en.wikipedia.org/wiki/MESI_protocol">MESI protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/MOESI_protocol">MOESI protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/Dragon_protocol">Dragon protocol</a></li>
<li><a href="https://blogs.synopsys.com/vip-central/2014/12/23/a-strategy-to-verify-an-axi-ace-compliant-interconnect-part-2-of-4/">A Strategy to Verify an AXI/ACE Compliant Interconnect (2 of 4)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Directory-based_cache_coherence">Directory-based cache coherence</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2021/12/17/cache-coherency-protocol/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-13 00:00:00">2021年12月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="dram-kintex-7-fpga-vref"><a class="toclink" href="../../hardware/2021/12/13/dram-fpga-vref-problem/">DRAM 在 Kintex 7 FPGA 上内部 Vref 的性能问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/12/13/dram-fpga-vref-problem/#_1">背景</a></h3>
<p>最近我们设计的 Kintex 7 FPGA 开发板在测试 DDR SDRAM 的时候遇到了一个问题，因为采用了 Internel VREF，MIG 在配置的时候限制了频率只能是 400 MHz，对应 800 MT/s，这样无法达到 DDR 的最好性能。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/12/13/dram-fpga-vref-problem/#_2">原理</a></h3>
<p>首先，VREF 在 DDR 中是用来区分低电平和高电平的。在 JESD79-4B 标准中，可以看到，对于直流信号，电压不小于 VREF+0.075V 时表示高电平，而电压不高于 VREF-0.075V 时表示低电平。VREF 本身应该介于 VDD 的 0.49 倍到 0.51 倍之间。</p>
<p>在连接 FPGA 的时候，有两种选择：</p>
<ul>
<li>Internal VREF: 从 FPGA 输出 VREF 信号到 DRAM</li>
<li>External VREF：接入 FPGA 以外的 VREF</li>
</ul>
<p>对于 7 Series 的 FPGA，Xilinx 要求如下：</p>
<div class="language-text highlight"><pre><span></span><code>For DDR3 SDRAM interfaces running at or below 800 Mb/s (400 MHz),
users have the option of selecting Internal VREF to save two I/O
pins or using external VREF. VREF is required for banks containing
DDR3 interface input pins (DQ/DQS).
</code></pre></div>
<p>进一步，Xilinx 在 UltraScale 文档下解释了背后的原因：</p>
<div class="language-text highlight"><pre><span></span><code>The UltraScale internal VREF circuit includes enhancements compared
to the 7 Series internal VREF circuit. Whereas 7 Series MIG had datarate
limitations on internal VREF usage (see (Xilinx Answer 42036)), internal
VREF is recommended in UltraScale. The VREF for 7 Series had coarse steps
of VREF value that were based on VCCAUX. This saved pins but limited the
performance because VCCAUX did not track with VCCO as voltage went up and
down. Not being able to track with VCCO enforced the performance
limitations of internal VREF in MIG 7 Series. UltraScale includes several
changes to internal VREF including a much finer resolution of VREF for DDR4
read VREF training. Additionally, internal VREF is based on the VCCO supply
enabling it to track with VCCO. Internal VREF is not subject to PCB and
Package inductance and capacitance. These changes in design now give internal
VREF the highest performance.
</code></pre></div>
<p>用中文简单来说：</p>
<ol>
<li>7 Series FPGA 中，Internal VREF 可以节省引脚，代价是 VREF 不会随着 VCCO 变化而变化（而是随着 VCCAUX 变化而变化），当 DRAM 频率提高的时候，可能无法满足 VREF 约等于 VDD 一半的要求</li>
<li>UltraScale FPGA 中，Internal VREF 是随着 VCCO 变化而变化的，并且会比 External VREF 性能更好；因此 UltraScale FPGA 的 DDR4 只支持 Internal VREF。</li>
</ol>
<p>以 MA703FA-35T 开发板为例，它使用的 FPGA 是 Artix7 35T，内存是 DDR3，采用的是 External VREF。它采用了 <a href="https://www.ti.com/lit/ds/symlink/tps51200.pdf">TPS51200 Sink and Source DDR Termination Regulator</a> 芯片，将芯片的 REFOUT 芯片接到 DRAM 的 VREFDQ 和 VREFCA 引脚上。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2021/12/13/dram-fpga-vref-problem/#_3">参考文档</a></h3>
<ul>
<li><a href="https://support.xilinx.com/s/article/42036?language=en_US">MIG 7 Series - Internal/External VREF Guidelines</a></li>
<li><a href="https://support.xilinx.com/s/article/64410?language=en_US">UltraScale/UltraScale+ Memory IP - Can either external or internal VREF be used?</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2021/12/13/dram-fpga-vref-problem/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-12 00:00:00">2021年12月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="dram"><a class="toclink" href="../../hardware/2021/12/12/dram/">「教学」DRAM 结构和特性</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/sdram.html">知识库</a>中。</p>
<h3 id="dram_1"><a class="toclink" href="../../hardware/2021/12/12/dram/#dram_1">DRAM 是如何组织的</a></h3>
<p>DRAM 分成很多层次：Bank Group，Bank，Row，Column，从大到小，容量也是各级别的乘积。</p>
<p>举例子：</p>
<ul>
<li>4 Bank Group</li>
<li>4 Bank per Bank Group</li>
<li>32,768 Row per Bank</li>
<li>1024 Column per Row</li>
<li>4 Bits per Column</li>
</ul>
<p>那么总大小就是 <code>4*4*32768*1024*4=2 Gb</code>。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/12/12/dram/#_1">访问模式</a></h3>
<p>DRAM 的访问模式决定了访问内存的实际带宽。对于每次访问，需要这样的操作：</p>
<ol>
<li>用 ACT(Bank Activate) 命令打开某个 Bank Group 下面的某个 Bank 的某个 Row，此时整个 Row 的数据都会复制到 Sense Amplifier 中。这一步叫做 RAS（Row Address Strobe）</li>
<li>用 RD(Read)/WR(Write) 命令按照 Column 访问数据。这一步叫做 CAS（Column Address Strobe）。</li>
<li>在访问其他 Row 之前，需要用 PRE(Single Bank Precharge) 命令将 Sense Amplifier 中整个 Row 的数据写回 Row 中。</li>
</ol>
<p>可以看到，如果访问连续的地址，就可以省下 ACT 命令的时间，可以连续的进行 RD/WR 命令操作。</p>
<p>除了显式 PRE 以外，还可以在某次读写之后自动进行 PRE：WRA(Write with Auto-Precharge) 和 RDA(Read with Auto-Precharge)。</p>
<p>总结一下上面提到的六种命令：</p>
<ol>
<li>ACT: Bank Activate，激活一个 Row，用于接下来的访问</li>
<li>PRE: Single Bank Precharge，与 ACT 是逆操作，解除 Row 的激活状态</li>
<li>RD: Read，读取当前 Row 的某个 Column 数据</li>
<li>RDA: Read with Auto-Precharge，读取后执行 Precharge</li>
<li>WR: Write，写入当前 Row 的某个 Column 数据</li>
<li>WRA: Write with Auto-Precharge，写入后执行 Precharge</li>
</ol>
<p>除此之外，还有一些常用命令：</p>
<ol>
<li>REF: Refresh，需要定期执行，保证 DRAM 数据不会丢失。</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/12/12/dram/#_2">参数</a></h3>
<p>DRAM 有很多参数，以服务器上的内存 <a href="https://in.micron.com/products/dram-modules/rdimm/part-catalog/mta36asf2g72pz-2g3">MTA36ASF2G72PZ-2G3A3</a> 为例子：</p>
<ul>
<li>16GB 容量，DDR4 SDRAM RDIMM</li>
<li>PC4-2400</li>
<li>Row address: 64K A[15:0]</li>
<li>Column address: 1K A[9:0]</li>
<li>Device bank group address: 4 BG[1:0]</li>
<li>Device bank address per group: 4 BA[1:0]</li>
<li>Device configuration: 4Gb (1Gig x 4), 16 banks</li>
<li>Module rank address: 2 CS_n[1:0]</li>
<li>Configuration: 2Gig x 72</li>
<li>Module Bandwidth: 19.2 GB/s=2400 MT/s * 8B/T</li>
<li>Memory Clock: 0.83ns(1200 MHz)</li>
<li>Data Rate: 2400 MT/s</li>
<li>Clock Cycles: CL-nRCD-nRP = 17-17-17</li>
</ul>
<p>容量：每个 DRAM 颗粒 <code>64K*1K*4*4*4=4Gb</code>，不考虑 ECC，一共有 <code>16*2=32</code> 个这样的颗粒，实际容量是 16 GB。32 个颗粒分为两组，每组 16 个颗粒，两组之间通过 CS_n 片选信号区分。每组 16 个颗粒，每个颗粒 4 位 DQ 数据信号，合并起来就是 64 位，如果考虑 ECC 就是 72 位。</p>
<p>再举一个 FPGA 开发板上内存的例子：<a href="https://www.micron.com/products/dram/ddr4-sdram/part-catalog/mt40a512m16ly-075">MT40A512M16LY-075E</a>，参数如下：</p>
<ol>
<li>Data Rate: 2666 MT/s, Clock Frequency: 1333 MHz, tCK=0.750ns=750ps</li>
<li>Target CL-nRCD-nRP: 18-18-18</li>
<li>tAA(Internal READ command to first data)=<code>13.50ns(=18*0.750)</code></li>
<li>tRCD(ACTIVATE to internal READ or WRITE delay time)=<code>13.50ns(=18*0.750)</code></li>
<li>tRP(PRECHARGE command period)=<code>13.50ns(=18*0.750)</code></li>
<li>tRAS(ACTIVATE-to-PRECHARGE command period)=32ns</li>
<li>512 Meg x 16</li>
<li>Number of bank groups: 2</li>
<li>Bank count per group: 4</li>
<li>Row addressing: 64K</li>
<li>Column addressing: 1K</li>
<li>Page size: 2KB=2K*16b</li>
</ol>
<p>总大小：<code>2*4*64K*1K*16=1GB</code>。这个开发板用了 5 个 DRAM 芯片，只采用了其中的 4.5 个芯片：最后一个芯片只用了 8 位数据，这样就是 <code>4.5*16=72</code> 位的数据线，对应 64 位+ECC。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2021/12/12/dram/#_3">时序</a></h3>
<p>可以看到，上面的 DRAM Datasheet 里提到了三个时序参数：</p>
<ol>
<li>CL=17: CAS Latency，从发送读请求到第一个数据的延迟周期数</li>
<li>RCD=17: ACT to internal read or write delay time，表示从 ACT 到读/写需要的延迟周期数</li>
<li>RP=17: Row Precharge Time，表示 Precharge 后需要延迟周期数</li>
</ol>
<p>如果第一次访问一个 Row 中的数据，并且之前没有已经打开的 Row，那么要执行 ACT 和 RD 命令，需要的周期数是 RCD+CL；如果之前已经有打开了的 Row，那么要执行 PRE，ACT 和 RD 命令，需要的周期数是 RP+RCD+CL。但如果是连续访问，虽然还需要 CL 的延迟，但是可以流水线起来，充分利用 DDR 的带宽。</p>
<p>如果把这个换算到 CPU 角度的内存访问延迟的话，如果每次访问都是最坏情况，那么需要 17+17+17=51 个 DRAM 时钟周期，考虑 DRAM 时钟是 1200MHz，那就是 42.5ns，这个相当于是 DRAM 内部的延迟，实际上测得的是 100ns 左右。</p>
<p>更严格来说，读延迟 READ Latency = AL + CL + PL，其中 AL 和 PL 是可以配置的，CL 是固有的，所以简单可以认为 READ Latency = CL。同理 WRITE Latency = AL + CWL + PL，可以简单认为 WRITE Latency = CWL。CWL 也是可以配置的，不同的 DDR 速率对应不同的 CWL，范围从 1600 MT/s 的 CWL=9 到 3200 MT/s 的 CWL=20，具体见 JESD79-4B 标准的 Table 7 CWL (CAS Write Latency)。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2021/12/12/dram/#_4">波形</a></h3>
<p>用 Micron 提供的 <a href="https://media-www.micron.com/-/media/client/global/documents/products/sim-model/dram/ddr4/ddr4_verilog_models.zip?rev=caf27a5eaf6b4a9f81eb894a874a4492">Verilog Model</a> 进行仿真，可以看到如下的波形图：</p>
<p><img alt="" src="/images/ddr4_waveform.png" /></p>
<p>首先看第一个命令，ACT_n=0, ADDR=0x009C, CAS_n_A15=0, CKE=1-&gt;1, CS_n=0, RAS_n_A16=0, WE_n_A14=1，查阅标准可知这是 ACT(Bank Activate) 命令。接着第二个命令，ACT_n=1, ADDR=0x0400, CAS_n_A15=0, CKE=1-&gt;1, CS_n=0, RAS_n_A16=1, WE_n_A14=1, A10=1, 这是 RDA(Read with Auto Precharge) 命令。若干个周期后，读取的数据从 DQ 上输出，一共 8 个字节的数据。</p>
<h3 id="_5"><a class="toclink" href="../../hardware/2021/12/12/dram/#_5">刷新</a></h3>
<p>DRAM 的一个特点是需要定期刷新。有一个参数 tREFI，表示刷新的时间周期，这个值通常是 7.8us，在温度大于 85 摄氏度时是 3.9 us（见 JESD79-4B Table 131）。在刷新之前，所有的 bank 都需要 Precharge 完成并等待 RP 的时间，这时候所有的 Bank 都是空闲的，再执行 REF(Refresh) 命令。等待 tRFC(Refresh Cycle) 时间后，可以继续正常使用。</p>
<p>为了更好的性能，DDR4 标准允许推迟一定次数的刷新，但是要在之后补充，保证平均下来依然满足每过 tREFI 时间至少一次刷新。</p>
<h3 id="_6"><a class="toclink" href="../../hardware/2021/12/12/dram/#_6">地址映射</a></h3>
<p>如果研究 DRAM 内存控制器，比如 <a href="https://www.xilinx.com/support/documentation/ip_documentation/ultrascale_memory_ip/v1_4/pg150-ultrascale-memory-ip.pdf">FPGA 上的 MIG</a>，可以发现它可以配置不同的地址映射方式，例如：</p>
<ul>
<li>ROW_COLUMN_BANK</li>
<li>ROW_BANK_COLUMN</li>
<li>BANK_ROW_COLUMN</li>
<li>ROW_COLUMN_LRANK_BANK</li>
<li>ROW_LRANK_COLUMN_BANK</li>
<li>ROW_COLUMN_BANK_INTLV</li>
</ul>
<p>就是将地址的不同部分映射到 DRAM 的几个地址：Row，Column，Bank。可以想象，不同的地址映射方式针对不同的访存模式会有不同的性能。对于连续的内存访问，ROW_COLUMN_BANK 方式是比较适合的，因为连续的访问会分布到不同的 Bank 上，这样性能就会更好。</p>
<p>此外，如果访问会连续命中同一个 Page，那么直接读写即可；反之如果每次读写几乎都不会命中同一个 Page，那么可以设置 Auto Precharge，即读写以后自动 Precharge，减少了下一次访问前因为 Row 不同导致的 PRE 命令。一个思路是在对每个 Page 的最后一次访问采用 Auto Precharge。</p>
<h3 id="_7"><a class="toclink" href="../../hardware/2021/12/12/dram/#_7">传输速率</a></h3>
<p>DDR SDRAM 的传输速率计算方式如下：</p>
<div class="language-text highlight"><pre><span></span><code>Memory Speed (MT/s) * 64 (bits/transfer)
</code></pre></div>
<p>例如一个 DDR4-3200 的内存，带宽就是 <code>3200 * 64 = 204.8 Gb/s = 25.6 GB/s</code>。但前面已经看到，除了传输数据，还需要进行很多命令，实际上很难达到 100% 的带宽。然后 CPU 可以连接多个 channel 的 DRAM，再考虑多个 CPU Socket，系统的总带宽就是</p>
<div class="language-text highlight"><pre><span></span><code>Memory Speed (MT/s) * 64 (bits/transfer) * Channels * Sockets
</code></pre></div>
<p>使用 MLC 等工具进行测试，计算实际与理论的比值，我测试得到的大概在 70%-90% 之间。</p>
<h3 id="hbm"><a class="toclink" href="../../hardware/2021/12/12/dram/#hbm">HBM</a></h3>
<p>HBM 相比前面的 DDR SDRAM，它堆叠了多个 DRAM，提供多个 channel 并且提高了位宽。例如 <a href="https://media-www.micron.com/-/media/client/global/documents/products/data-sheet/dram/hbm2e/8gb_and_16gb_hbm2e_dram.pdf">Micron HBM with ECC</a>，堆叠了 4/8 层 DRAM，提供 8 个 channel，每个 channel 的数据宽度是 128 位，以 3200 MT/s 计算，一个 HBM 芯片的传输速率最大是：</p>
<div class="language-text highlight"><pre><span></span><code>3200 (MT/s) * 128 (bits/transfer) * 8 (Channels) = 3276.8 Gb/s = 409.6 GB/s
</code></pre></div>
<p>所以一片 HBM 的传输速率就相当于 16 个传统的 DDR SDRAM：8 个 Channel 加双倍的位宽。128 位实际上就是把两片 64-bit DDR SDRAM 并起来了，可以当成一个 128 位的用，也可以在 Pseudo Channel 模式下，当成共享地址和命令信号的两个 DDR SDRAM 用。</p>
<p>Xilinx 的 Virtex Ultrascale Plus HBM FPGA 提供了 <code>1800 (MT/s) * 128 (bits/transfer) * 8 (Channels) = 230.4 GB/s</code> 的带宽，如果用了两片 HBM 就是 460.8 GB/s。暴露给 FPGA 逻辑的是 16 个 256 位的 AXI3 端口，AXI 频率 450 MHz，内存频率 900 MHz。可以看到，每个 AXI3 就对应了一个 HBM 的 pseudo channel。每个 pseudo channel 是 64 位，但是 AXI 端口是 256 位：在速率不变的情况下，从 450MHz 到 900MHz，再加上 DDR，相当于频率翻了四倍，所以位宽要从 64 位翻四倍到 256 位。</p>
<p>当然了，HBM 的高带宽的代价就是引脚数量很多。根据 <a href="https://www.jedec.org/system/files/docs/JESD238A.pdf">HBM3 JESD238A</a>，每个 Channel 要 120 个 pin，一共 16 个 channel（HBM2 是 8 channel，每个 channel 128 位；HBM3 是 16 channel，每个 channel 64 位），然后还有其他的 52 个 pin，这些加起来就 1972 个 pin 了。所以一般在 Silicon Interposer 上连接，而不是传统的在 PCB 上走线（图源 <a href="https://picture.iczhiku.com/resource/ieee/WYifSuFTZuHLFcMV.pdf">A 1.2V 20nm 307GB/s HBM DRAM with At-Speed Wafer-Level I/O Test Scheme and Adaptive Refresh Considering Temperature Distribution</a>）：</p>
<p><img alt="" src="/images/hbm_stack.png" /></p>
<p>所以在 HBM3 标准里，用 Microbump 来描述 HBM 的 pin。</p>
<p>可以理解为把原来插在主板上的内存条，通过堆叠，变成一个 HBM Die，然后紧密地连接到 CPU 中。但是另一方面，密度上去了，价格也更贵了。</p>
<p>A100 显卡 40GB PCIe 版本提供了 1555 GB/s 的内存带宽。根据倍数关系，可以猜测是 5 个 8GB 的 HBM，每个提供 <code>1555 / 5 = 311 GB/s</code> 的带宽，那么时钟频率就是 <code>311 (GB/s) * 8 (bits/byte) / 128 (bits/transfer) / 8 (channels) / 2 (DDR) = 1215 MHz</code>，这与 <code>nvidia-smi -q</code> 看到的结果是一致的。</p>
<p>进一步，A100 80GB PCIe 版本提供了 1935 GB/s 的带宽，按照同样的方法计算，可得时钟频率是 <code>1935 (GB/s) / 5 * 8 (bits/byte) / 128 (bits/transfer) / 8 (channels) / 2(DDR) = 1512 MHz</code>，与 <a href="https://www.nvidia.com/content/dam/en-zz/Solutions/Data-Center/a100/pdf/PB-10577-001_v02.pdf">Product Brief</a> 一致。频率的提高是因为从 HBM2 升级到了 HBM2e。</p>
<p>A100 文档中的 Memory bus width 5120 的计算方式也就清楚了：<code>128 (bits/transfer) * 8 (channels) * 5 (stacks) = 5120 (bits)</code>。</p>
<p>H100 SXM5 升级到了 HBM3，内存容量依然是 80GB，但是时钟频率提高，内存带宽是 <code>2619 (MHz) * 2 (DDR) * 128 (bits/transfer) * 8 (channels) * 5 (stacks) / 8 (bits/byte) = 3352 GB/s</code>。</p>
<h3 id="_8"><a class="toclink" href="../../hardware/2021/12/12/dram/#_8">参考文档</a></h3>
<ul>
<li>Memory systems: Cache, DRAM &amp; Disk</li>
<li><a href="https://zhuanlan.zhihu.com/p/262052220">译文：DDR4 SDRAM - Understanding the Basics（上）</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/263080272">译文：DDR4 SDRAM - Understanding the Basics（下）</a></li>
<li><a href="https://github.com/RAMGuide/TheRamGuide-WIP-/raw/main/DDR5%20Spec%20JESD79-5.pdf">JEDEC STANDARD DDR5 SDRAM JESD79-5</a></li>
<li><a href="http://www.softnology.biz/pdf/JESD79-4B.pdf">JEDEC STANDARD DDR4 SDRAM JESD79-4B</a></li>
<li><a href="https://documents.pub/document/jesd79-3e-ddr3-sdram-specification.html">JEDEC STANDARD DDR3 SDRAM JESD79-3E</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2021/12/12/dram/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-12 00:00:00">2021年12月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 14 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="risc-v-debug"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/">「教学」RISC-V Debug 协议</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#_1">背景</a></h3>
<p>之前用过一些 RISC-V 核心，但是遇到调试相关的内容的时候就两眼一抹黑，不知道原理，出了问题也不知道如何排查，趁此机会研究一下工作原理。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#_2">架构</a></h3>
<p>为了调试 RISC-V 核心，需要很多部件一起工作。按 RISC-V Debug Spec 所述，有这么几部分：</p>
<ol>
<li>Debugger: GDB，连接到 OpenOCD 启动的 GDB Server</li>
<li>Debug Translator: OpenOCD，向 GDB 提供 Server 实现，同时会通过 FTDI 等芯片控制 JTAG</li>
<li>Debug Transport Hardware: 比如 FTDI 的芯片，可以提供 USB 接口，让 OpenOCD 控制 JTAG 信号 TMS/TDI/TCK 的变化，并读取 TDO</li>
<li>Debug Transport Module: 在芯片内部的 JTAG 控制器（TAP），符合 JTAG 标准</li>
<li>Debug Module Interface：RISC-V 自定义的一系列寄存器，通过这些寄存器来控制 Debug Module 的行为</li>
<li>Debug Module：调试器，控制 RISC-V 核心，同时也支持直接访问总线，也有内部的 Program Buffer</li>
</ol>
<p>可以看到，DMI 是实际的调试接口，而 JTAG 可以认为是一个传输协议。</p>
<h3 id="jtag"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#jtag">JTAG</a></h3>
<p>首先什么是 JTAG？简单来说，它工作流程是这样的：</p>
<ol>
<li>JTAG TAP 维护了一个状态机，由 TMS 信号控制</li>
<li>当状态机进入 CaptureDR/CaptureIR 状态的时候，加载数据到 DR/IR 中</li>
<li>在 ShiftDR/ShiftIR 状态下，寄存器从 TDI 移入，从 TDO 移出</li>
<li>当进入 UpdateDR/UpdateIR 状态的时候，把 DR/IR 的结果输出到其他单元</li>
</ol>
<p>具体来说，JTAG 定义了两类寄存器：IR 和 DR。可以把 JTAG 理解成一个小的总线，我通过 IR 选择总线上的设备，通过 DR 向指定的设备上进行数据传输。比如在 RISC-V Debug Spec 里面，规定了以下的 5 位 IR 地址定义：</p>
<ol>
<li>0x00/0x1f: BYPASS</li>
<li>0x01: IDCODE</li>
<li>0x10: dtmcs</li>
<li>0x11: dmi</li>
</ol>
<p>可以类比为有四个设备：BYPASS，IDCODE，dtmcs，dmi，对应了一些地址。如果要选择 dtmcs 这个设备，就在 ShiftIR 阶段向 TDI 输入二进制的 00001 即可。选择地址以后，再向 DR 写入时，操作的就是 dtmcs 设备。</p>
<p>那么，每个设备是怎么操作的呢？假如我已经通过 IR 设置了当前设备是 dtmcs，然后进入 ShiftDR 模式时，JTAG 会同时输入和输出。输入的就是当前要输入的数据，输出的就是原来寄存器里的结果，这个结果可能是固定的，也可能是表示上一次输入对应的结果。</p>
<p>举个例子：IDCODE 设备，在 CaptureDR 阶段的时候，DR 总会被设为一个固定的 IDCODE，表示设备的 ID；在 Shift 的时候，这个 IDCODE 就会一位一位从 TDO 中输出，而 TDI 输入的数据都会被忽略掉。BYPASS 设备则是一个 1 位的寄存器，直接从 TDI 到寄存器，寄存器到 TDO，数据就这么流过去了。</p>
<p>那么，在 RISC-V Debug 里面，JTAG 是怎么用的呢？我们可以这么类比一下：CaptureDR 相当于读取寄存器到缓冲区，然后 ShiftDR 在读取缓冲区的同时写入缓冲区，最后 UpdateDR 则是把缓冲区中的数据写入到寄存器中。这和 MMIO 有点类似，只不过每次操作不是单独的写和读，而是一次操作等于先读后写。</p>
<p>还是来看例子。dtmcs 这个设备表示的是 DTM 当前的状态，它有 32 位，读取的时候可以得到 DMI 的状态和配置，写入的时候可以 reset DMI。以 OpenOCD 代码 <code>dtmcontrol_scan</code> 为例子，它做了这么几个事情：</p>
<ol>
<li>首先设置 IR 为 0x10，对应 dtmcs。</li>
<li>向 DR 中写入数据，同时读取数据。</li>
<li>设置 IR 为 0x11，对应 dmi，因为 dmi 操作是比较多的，所以它默认恢复到 dmi。</li>
</ol>
<p>如果我只想读取 dtmcs 寄存器，那么只要设置写入数据为 0 即可，因为寄存器的设计里考虑到，如果写入全 0 是没有副作用的。同理，如果只想写入 dtmcs 寄存器，直接写入即可，因为设计的时候也保证读入寄存器的值是没有副作用的。这样，就在一个一读一写的操作中，实现了读或者写的功能。</p>
<p>那么，dmi 寄存器的用途是什么呢？我们前面提到过，JTAG 其实是一个传输层，而 DMI 又定义了一系列的寄存器，这会让人有点混乱，为啥到处都是寄存器？又是 JTAG 的 IR/DR，又是 dmi，dmi 又有一堆寄存器，这是什么关系？</p>
<p>首先我们来看 dmi 寄存器的定义。它由三部分组成：地址、数据和操作。由于 JTAG 每次操作是一读一写，虽然寄存器定义差不多，但是读和写的含义是不同的。</p>
<p>比如读的时候，它表示的是上一次 dmi 请求的结果。地址还是上一次请求的地址，数据则是上一次请求的结果，操作字段 0 表示成功，2 表示失败，3 表示还没执行完。而写的时候，地址和数据表示了对哪个寄存器写入什么数据，操作字段 0 表示无操作，1 表示读，2 表示写。</p>
<p>可以看到，如果想操作 dmi 定义的寄存器，需要如下几个步骤，这也是 OpenOCD <code>dmi_op_timeout</code> 要做的事情：</p>
<ol>
<li>设置 IR 为 0x11，对应 DMI。</li>
<li>向 DR 写入请求的地址 + 数据 + 操作，丢弃读取的结果。</li>
<li>等待若干个周期。</li>
<li>向 DR 写入全 0，对应无操作，同时读取结果，这个结果就对应上面的请求。</li>
</ol>
<p>可以预期，如果首先写入了一个写操作，那么第二次 DR scan 得到的结果就是是否成功写入；如果首先写入了一个读操作，那么第二次 DR scan 得到的结果就是目标寄存器的值。</p>
<p>可能看起来还是很绕，确实很绕，因为这里有一个封装的过程。首先，DMI 本身定义了一些寄存器，这些寄存器读/写都有一定的含义，比如控制某一个 RISC-V 核心暂停等等。接着，JTAG 需要传输 DMI 的读取和写入操作，同时还要考虑读写尚未完成的情况，怎么办？结论就是通过 DR 来实现，写入 DR 时，按照 DR 中的操作数，对应到 DMI 的写入/读取；然后读取 DR 的时候，按照 DMI 的状态，告诉 OpenOCD 目前是否已经完成了上一次 DMI 操作，和操作的结果。</p>
<h3 id="dmi"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#dmi">DMI</a></h3>
<p>讲完 JTAG 以后，终于来到了 DMI。其实 DMI 就是一系列的寄存器，类似于 MMIO 设备，只不过访问方式不是我们通常的内存读写，而是通过 JTAG 的方式进行。它有很多个寄存器，摘录如下：</p>
<ol>
<li>dmcontrol 0x10: Debug Module Control</li>
<li>dmstatus 0x11: Debug Module Status</li>
<li>hartinfo 0x12: Hart Info</li>
<li>hartsum 0x13: Hart Summary</li>
<li>command 0x16: Abstract Control and Status</li>
<li>data0 0x04: Abstract Data 0</li>
<li>progbuf0 0x20: Program Buffer 0</li>
<li>sbcs 0x38: System Bus Access Control and Status</li>
<li>sbaddress0 0x39: System Bus Address 31:0</li>
<li>sbdata0 0x3c: System Bus Data 31:0</li>
</ol>
<p>OpenOCD 的 <code>examine</code> 函数对 DMI 初始化并进行一些参数的获取。它的操作如下：</p>
<ol>
<li>调用 dtmcontrol_scan，读取 JTAG 里的 dtmcs，可以得到 JTAG-DMI 的配置信息</li>
<li>向 dmcontrol 写入，进行复位</li>
<li>向 dmcontrol 写入，启用调试模块</li>
<li>从 hartinfo 读取 hart 信息</li>
<li>检查各个 hart 的状态</li>
</ol>
<p>类似地，其他各种调试操作都是对这些 DMI 寄存器的读和写进行。RISC-V Debug Spec 附录里还提到了如何实现调试器的一些功能。</p>
<p>比如要读取 CPU 的寄存器（比如通用寄存器，CSR 等等）的话，有如下的方式：</p>
<p>第一种是 Abstract Command，直接向 DMI 写入要寄存器编号，就可以实现读/写。</p>
<p>第二种是 Program Buffer。它是一块小的代码存储，可以通过 DMI 向其中写入指令，比如 <code>csrw s0, mstatus; ebreak</code>，然后设置 s0 寄存器的值，再执行 Program Buffer 里的代码。</p>
<p>以 OpenOCD 代码为例，<code>register_read_abstract</code> 做了以下操作：</p>
<ol>
<li>找到要读取的寄存器对应的 Abstract Register Number</li>
<li>进行 transfer 命令，DM 会读取对应寄存器到 data0 中</li>
<li>从 data0 中读取寄存器内容</li>
</ol>
<p>如果要读取内存的话，也有两种方法。一种是直接向 DMI 写入要读取的总线地址，然后再向指定的寄存器中读取数据。第二种还是利用 Program Buffer，写入一条 <code>lw s0, 0(s0)</code> 指令，然后先向 s0 写入地址，执行 Program Buffer 后，再把 s0 寄存器的值读出来。</p>
<h3 id="abstract-command"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#abstract-command">Abstract Command 实现</a></h3>
<p>那么，如何实现上面提到的 Abstract Command（比如读写寄存器，读写内存等）呢？Debug Spec 里面提到一种 Execution-Based 的方式，即在 Debug mode 下，核心依然在执行代码，只不过执行的是调试用的特殊代码。它做的就是轮询 Debug Module 等待命令，接受到命令以后，就去读写寄存器/内存，然后通过 data0-12 来传输数据。</p>
<p>这里还有一个比较特别的点，就是读取寄存器的时候，寄存器的编号是直接记录在指令中的，所以可以让 Debug Module 动态生成指令，然后让核心刷新 ICache 然后跳转过去。另外，还可以利用 dscratch0/dscratch1 寄存器来保存 gpr，然后用 dret 退出的时候再恢复，这样就有两个 gpr 可以用来实现功能了，实际上这已经够用了（一个技巧是，把地址设为 0 附近，然后直接用 zero 寄存器加偏移来寻址）。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#_3">单步调试实现</a></h3>
<p>在 dcsr 中，有一个值 step 表示是否在单步调试状态。设 step 为 1 的时候，如果不在 debug mode 中，只需要记录以及执行的指令数，当执行了一条指令后，视为下一个指令发生了进入 debug mode 的异常，这样就实现了单步调试。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#_4">软件断点实现</a></h3>
<p>调试器为了打断点，一种简单的方式是，往断点处写入 ebreak 指令，然后设置 dcsr 的 ebreakm/s/u，表示在这些特权集里，ebreak 是进入 debug mode，而不是原来的处理过程。然后，程序运行到 ebreak 指令的时候，进入 debug mode，openocd 发现核心进入 halted 状态后，让 gdb 继续进行调试。</p>
<p>硬件方面的实现方法就是，在遇到 ebreak 的时候，判断一下当前的特权集，结合 ebreakm/s/u 判断跳转到什么状态。此外，由于它会写入指令到内存，所以还需要执行 fence.i 指令，而 OpenOCD 需要依赖 progbuf 来执行 fence.i 指令，所以为了让这个方案工作，还得实现 Program Buffer。</p>
<p>当然了，软件断点也有局限性，比如内存不可写，比如 ROM，不能覆盖里面的指令，这样就有可能出问题。而且硬件断点性能也更好，不需要来回这样写指令。</p>
<h3 id="semihosting"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#semihosting">Semihosting</a></h3>
<p>ARM 有一种 semihosting 机制，就是处理器执行一种特定的指令序列，然后调试器看到整个序列的时候，不是进入 GDB 调试状态，而是去进行一些操作，比如输出信息，读写文件等等，然后结果通过 JTAG 写回去。OpenOCD 给 RISC-V 也做了类似的 semihosting 机制，只不过触发的指令序列不大一样，但是机制是类似的。</p>
<p>如果用过 Rocket Chip 仿真的或者以前的 ucb-bar/fpga-zynq 项目的话，会知道还有一个目的有些类似的东西：HTIF + fesvr，它是通过 fromhost/tohost 两组地址来进行通信，但是这个方法缺点是需要 poll tohost/fromhost 地址的内容，相对来说比较麻烦。</p>
<h3 id="program-buffer"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#program-buffer">Program Buffer</a></h3>
<p>此外，debug spec 还有一个可选的功能，就是 Program Buffer，调试器可以往里面插入自定义的指令，然后结合 abstract command 进行操作。这样就可以做一些比较高效的操作，比如 OpenOCD 实现的批量写入内存：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2021/12/12/riscv-debug/#__codelineno-0-1"></a><span class="nf">sw</span><span class="w"> </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2021/12/12/riscv-debug/#__codelineno-0-2"></a><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2021/12/12/riscv-debug/#__codelineno-0-3"></a><span class="nf">ebreak</span>
</span></code></pre></div>
<p>并且设置 abstractauto，然后重复的操作是往 s1 里面写入新的数据，然后跳转到 program buffer，进行上面的 sw 操作，这样就可以一次 dmi 请求完成一次内存的写入，比较高效。</p>
<h3 id="_5"><a class="toclink" href="../../hardware/2021/12/12/riscv-debug/#_5">参考文档</a></h3>
<ol>
<li>RISC-V Debug Spec 0.13</li>
<li>IEEE Standard for JTAG 1149.1-2013</li>
<li>OpenOCD 相关代码</li>
</ol>

    <nav class="md-post__action">
      <a href="../../hardware/2021/12/12/riscv-debug/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-09 00:00:00">2021年12月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../misc/2021/12/09/education/">教学随想</a></h2>
<h3 id="_2"><a class="toclink" href="../../misc/2021/12/09/education/#_2">背景</a></h3>
<p>最近关于课程改革的讨论比较多，我也来谈谈我的看法。</p>
<h3 id="_3"><a class="toclink" href="../../misc/2021/12/09/education/#_3">动机</a></h3>
<p>一位高中毕业的同学，选择计算机系的动机是什么？我想了想，可能有下面几种：</p>
<ol>
<li>计算机行业就业好，我选了计算机系，毕业以后可以赚到很多钱</li>
<li>喜欢计算机，希望从事计算机方面的工作</li>
<li>计算机系分高，大家都说好，那我就选择去这里吧</li>
<li>我是竞赛保送的，所以来到了这里</li>
</ol>
<p>学校希望计算机系培养出来的学生：</p>
<ol>
<li>有很好的能力</li>
<li>有很好的毕业去向（保研/工作/留校等等）</li>
</ol>
<p>学校为希望计算机系：</p>
<ol>
<li>有更多重大科研成果</li>
<li>能够培养多且精的计算机人才</li>
</ol>
<p>计算机系为了实现上面的目标：</p>
<ol>
<li>教学的专业课程要全面，并且能够支撑后续的科研</li>
<li>吸引更多学生进入实验室科研</li>
</ol>
<p>同时还要与其他院系（软件学院，交叉信息学院，集成电路学院等）有区分（分工）。</p>
<h3 id="_4"><a class="toclink" href="../../misc/2021/12/09/education/#_4">路径</a></h3>
<p>可以看到，上面的这一系列诉求是有矛盾的，可以假想这么几条路径：</p>
<ol>
<li>想赚钱-&gt;读研毕业薪资更高-&gt;读研需要高 GPA-&gt;每门课都要 4.0-&gt;每个课程的可选部分都要做-&gt;工作量太大</li>
<li>想科研-&gt;找好老师-&gt;需要高 GPA 和或论文-&gt;每门课都要 4.0 同时还要在实验室科研-&gt;工作量特别大</li>
<li>不想科研直接工作-&gt;工作不需要高的 GPA-&gt;放弃一些课程的可选部分-&gt;空余时间学习实用技术-&gt;面试轻松过关</li>
<li>对未来没有想法-&gt;从众心理卷 GPA-&gt;每个课程都做可选部分-&gt;花费很多时间-&gt;没有时间做自己喜欢的事情</li>
</ol>
<p>这对于七字班（2017）或者更早同学来说，这可能是难以理解的。当时，保研不需要很高的 GPA，老师会看重科研潜力，想科研的同学可能选择在实验室科研的同时，放弃一些课程。</p>
<p>但是从八字班（2018）开始，多重因素下，问题就凸显了。一是总人数更多，保研难度本身就更大，竞争激烈；二是保研名额严格按照 GPA 排序，导致保研的同学必须科研学习两手抓；三是 GPA 改革以后，4.0 难度变低，以前会想 A B C 课程比较难，大部分人都拿不到 4.0，我 A 课程 3.7，B 课程 3.3 和你 A 课程 3.3，B 课程 3.7 是一样的，精力有限，只做三个里面最简单的一个，但现在会发现，比 GPA 实际上就是比谁 4.0 更多，虽然 A B C 课程也比较难，但是此时只能把三个都做了，不然就会排名下降明显。</p>
<p>这还会带来其他的问题：为了拿到更多 4.0，但精力有限，按照自己的时间，三个课里只能拿到一个 4.0，比不过拿到三个 4.0 的同学，咋办？抄袭。让老师放水，人人 4.0。</p>
<h3 id="_5"><a class="toclink" href="../../misc/2021/12/09/education/#_5">解决</a></h3>
<p>那么，怎么解决这个问题？</p>
<p>从个人的角度出发：尽早想好自己要什么。我要做什么，就在我要做的方向上做好，其他方向可以选择性放弃，不要随大流。</p>
<p>从院系的角度出发：难。</p>

    <nav class="md-post__action">
      <a href="../../misc/2021/12/09/education/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-06 00:00:00">2021年12月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="manycore"><a class="toclink" href="../../hardware/2021/12/06/manycore/">Manycore 处理器架构分析</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/12/06/manycore/#_1">参考文档</a></h3>
<ul>
<li><a href="https://www.intel.com/content/www/us/en/architecture-and-technology/many-integrated-core/intel-many-integrated-core-architecture.html">Intel® Many Integrated Core Architecture (Intel® MIC Architecture) - Advanced</a></li>
<li><a href="https://ieeexplore.ieee.org/abstract/document/7476487">Intel® Xeon Phi coprocessor (codename Knights Corner)</a></li>
<li><a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=7453080">https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=7453080</a></li>
<li><a href="https://www.alcf.anl.gov/files/HC27.25.710-Knights-Landing-Sodani-Intel.pdf">Knights Landing (KNL): 2nd Generation Intel® Xeon Phi™ Processor</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fujitsu_A64FX">Fujitsu A64FX</a></li>
<li><a href="https://www.fujitsu.com/global/about/resources/news/press-releases/2018/0822-02.html">Fujitsu Presents Post-K CPU Specifications</a></li>
<li><a href="https://web.archive.org/web/20201205202434/https://hotchips.org/hc30/2conf/2.13_Fujitsu_HC30.Fujitsu.Yoshida.rev1.2.pdf">Fujitsu High Performance CPU for the Post-K Computer</a></li>
<li><a href="https://www.top500.org/system/179807/">SUPERCOMPUTER FUGAKU - SUPERCOMPUTER FUGAKU, A64FX 48C 2.2GHZ, TOFU INTERCONNECT D</a></li>
<li><a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=9229635">Preliminary Performance Evaluation of the Fujitsu A64FX Using HPC Applications</a></li>
<li><a href="https://www.fujitsu.com/downloads/SUPER/a64fx/a64fx_datasheet.pdf">FUJITSU Processor A64FX</a></li>
<li><a href="https://images.nvidia.cn/aem-dam/en-zz/Solutions/data-center/nvidia-ampere-architecture-whitepaper.pdf">NVIDIA A100 Tensor Core GPU Architecture</a></li>
<li><a href="https://images.nvidia.cn/content/volta-architecture/pdf/volta-architecture-whitepaper.pdf">NVIDIA TESLA V100 GPU ARCHITECTURE</a></li>
<li><a href="https://www.nvidia.com/content/dam/en-zz/Solutions/Data-Center/a100/pdf/nvidia-a100-datasheet-us-nvidia-1758950-r4-web.pdf">NVIDIA A100 TENSOR CORE GPU</a></li>
</ul>
<h3 id="xeon-phi-intel-mic"><a class="toclink" href="../../hardware/2021/12/06/manycore/#xeon-phi-intel-mic">Xeon Phi - Intel MIC</a></h3>
<p>MIC: Many Integrated Core Architecture</p>
<p>Knights Corner:</p>
<p>4 路 SMT，AVX512 指令，32 KB L1I，32 KB L1D，每核心 512KB L2，乱序执行，一条 512 位计算流水线，每个周期双精度性能 <code>512 / 64 * 2 = 16 FLOP/cycle</code>。61 核 1.053GHz 双精度性能是 <code>16 * 61 * 1.053 = 1028 GFLOPS</code>。</p>
<p>向量寄存器分为四组，每组 128 位，两个 DP/四个 SP。SP 和 DP 计算共享乘法器，来优化面积。</p>
<p>Knights Landing:</p>
<p>核心：4 路 SMT，AVX512 指令，乱序执行，两条 512 位计算流水线，每个周期双精度性能 <code>512 / 64 * 2 * 2 = 32 FLOP/cycle</code>，如果是 64 核 1.3 GHz，总双精度性能是 <code>32 * 64 * 1.3 = 2662 GFLOPS</code>。一共 36 个 Tile，每个 Tile 有 2 Core + 2 VPU/core + 1MB 16-way L2，最大 72 个核心。</p>
<p>内存：6-channel 384GB DDR4 2400 RAM（理论 <code>2400 * 6 * 8 = 115.2 GB/s</code>），8-16GB 3D MCDRAM（400+ GB/s）。</p>
<h3 id="fujitsu-a64fx"><a class="toclink" href="../../hardware/2021/12/06/manycore/#fujitsu-a64fx">Fujitsu A64FX</a></h3>
<p>内存：4 组，每组 8GB HBM2，带宽 256 GB/s（<code>1024 bit * 2G</code>），总共 32GB HBM2，带宽 1TB/s。Cache Line 大小 256 B。</p>
<p>核心：4 个 NUMA Node（Core Memory Group），每个 NUMA Node 包括 12 计算核，有 8MB 16 路的 L2 Cache。总共 48 计算核，4 辅助核。</p>
<p>指令集：ARMv8.2+SVE，512 位向量宽度，乱序执行，两个浮点流水线和两个整数流水线，每个周期双精度性能 <code>512 / 64 * 2 * 2 = 32 FLOP/cycle</code>，主频 2.2 GHz，按主频算理论双精度浮点性能 <code>32 * 2.2 * 48 = 3.4 TFLOPS</code>。文档里写的是双精度浮点性能 2.7 TFLOPS，单精度 5.4 TFLOPS，半精度 10.8 TFLOPS，8 位整数 21.6 TOPS，应该是按照实际测出来的算。TOP 500 配置是 7630848 核，对应 <code>7630848 / 48 = 158976</code> 个节点，Rpeak 是 <code>537212 TFLOPS</code>，那么每个节点是 <code>537212 / 158976 = 3.38 TFLOPS</code>，和上面的 3.4 接近。Linpack 跑出来的 Rmax 是 442010 TFLOPS，每个节点是 <code>442010 / 158976 = 2.78 TFLOPS</code>，和文档里说的比较接近。</p>
<p>部分主要特性：</p>
<ul>
<li>Four-operand FMA: ARM FMA 指令只能是 <code>R0=R0+R1*R2</code>，A64FX 可以合并 <code>R0=R3,R0=R0+R1*R2</code> 两条为一条 <code>R0=R3+R1*R2</code> 指令</li>
<li>Gather/Scatter: 非连续访存，同一个 128B 内连续的 lane 可以合并访问，如果数据有局部性的话，可以得到两倍带宽</li>
</ul>
<h3 id="nvidia-gpu"><a class="toclink" href="../../hardware/2021/12/06/manycore/#nvidia-gpu">NVIDIA GPU</a></h3>
<table>
<thead>
<tr>
<th>型号</th>
<th>工艺</th>
<th>Peak DP(TFLOPS)</th>
<th>功耗 (W)</th>
<th>性能功耗比 (TFLOPS/W)</th>
</tr>
</thead>
<tbody>
<tr>
<td>P100</td>
<td>16 nm FinFET+</td>
<td>4.7</td>
<td>250</td>
<td>0.019</td>
</tr>
<tr>
<td>V100</td>
<td>12 nm FFN</td>
<td>7</td>
<td>250-300</td>
<td>0.023-0.028</td>
</tr>
<tr>
<td>A100</td>
<td>7 nm N7</td>
<td>9.7</td>
<td>250-400</td>
<td>0.024-0.039</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>型号</th>
<th>内存容量 (GB)</th>
<th>内存带宽 (GB/s)</th>
<th>内存类型</th>
<th>L2 缓存大小</th>
<th>寄存器堆大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>P100</td>
<td>12-16</td>
<td>549-732</td>
<td>4096 bit HBM2</td>
<td>4096 KB</td>
<td>14336 KB</td>
</tr>
<tr>
<td>V100</td>
<td>16-32</td>
<td>900</td>
<td>4096 bit HBM2</td>
<td>6144 KB</td>
<td>20480 KB</td>
</tr>
<tr>
<td>A100</td>
<td>40-80</td>
<td>1555-2039</td>
<td>5120 bit HBM2</td>
<td>40960 KB</td>
<td>27648 KB</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>型号</th>
<th>SM 数量</th>
<th>CUDA 核心数</th>
<th>FP64 核心数</th>
<th>SM 频率 (MHz)</th>
</tr>
</thead>
<tbody>
<tr>
<td>P100</td>
<td>56</td>
<td>3584</td>
<td>1792</td>
<td>1328</td>
</tr>
<tr>
<td>V100</td>
<td>80</td>
<td>5120</td>
<td>2560</td>
<td>1380</td>
</tr>
<tr>
<td>A100</td>
<td>108</td>
<td>6912</td>
<td>3456</td>
<td>1410</td>
</tr>
</tbody>
</table>
<ul>
<li>CUDA 核心数 = SM 数量 * 64</li>
<li>FP64 核心数 = SM 数量 * 32</li>
<li>Peak DP = FP64 核心数 * SM 频率 * 2</li>
<li>寄存器堆大小 = SM 数量 * 256 KB</li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2021/12/06/manycore/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-04 00:00:00">2021年12月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sunway"><a class="toclink" href="../../hardware/2021/12/04/sunway/">Sunway 处理器架构分析</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/12/04/sunway/#_1">参考文档</a></h3>
<ul>
<li><a href="https://crad.ict.ac.cn/CN/10.7544/issn1000-1239.2021.20201041">高性能众核处理器申威 26010</a></li>
<li><a href="https://cjc.ict.ac.cn/online/onlinepaper/lyy-202065163512.pdf">稀疏矩阵向量乘法在申威众核架构上的性能优化</a></li>
<li><a href="https://en.wikipedia.org/wiki/Sunway_SW26010">Sunway SW26010</a></li>
<li><a href="https://link.springer.com/content/pdf/10.1007/s11432-016-5588-7.pdf">The Sunway TaihuLight supercomputer: system and applications</a></li>
<li><a href="https://www.netlib.org/utk/people/JackDongarra/PAPERS/sunway-report-2016.pdf">Report on the Sunway TaihuLight System</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/3458817.3487399">Closing the “Quantum Supremacy” Gap: Achieving Real-Time Simulation of a Random Quantum Circuit Using a New Sunway Supercomputer</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/3458817.3476161">SW_Qsim: A Minimize-Memory Quantum Simulator with High-Performance on a New Sunway Supercomputer</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/3126908.3126910">18.9-Pflops Nonlinear Earthquake Simulation on Sunway TaihuLight: Enabling Depiction of 18-Hz and 8-Meter Scenarios</a></li>
<li><a href="https://www.nextplatform.com/2021/02/10/a-sneak-peek-at-chinas-sunway-exascale-supercomputer/">A FIRST PEEK AT CHINA’S SUNWAY EXASCALE SUPERCOMPUTER</a></li>
<li><a href="https://www.nextplatform.com/2021/03/10/the-nitty-gritty-of-the-sunway-exascale-system-network-and-storage/">THE NITTY GRITTY OF THE SUNWAY EXASCALE SYSTEM NETWORK AND STORAGE</a></li>
<li><a href="https://www.sciengine.com/publisher/scp/journal/SCIS/64/4/10.1007/s11432-020-3104-7?slug=fulltext">Sunway supercomputer architecture towards exascale computing: analysis and practice</a></li>
</ul>
<h3 id="sw26010"><a class="toclink" href="../../hardware/2021/12/04/sunway/#sw26010">SW26010</a></h3>
<p>Sunway TaihuLight 的层次：</p>
<ol>
<li>1 Sunway TaihuLight = 40 Cabinet</li>
<li>1 Cabinet = 4 Super nodes</li>
<li>1 Super node = 256 nodes</li>
<li>1 node = 4 core groups</li>
<li>1 core group = 1 MPE(management processing element) + 8*8 CPE(computer processing element)</li>
</ol>
<p>MPE 双精度性能：<code>16 FLOP/cycle * 1.45 GHz = 23.2 GFlops</code>
CPE 双精度性能：<code>8 FLOP/cycle * 1.45 GHz = 11.6 GFlops</code>
CPE 单精度性能：<code>8 FLOP/cycle * 1.45 GHz = 11.6 GFlops</code>
单节点双精度性能：<code>4 * 8 * 8 * 11.6 + 4 * 23.2 = 3.0624 TFlops</code>
Sunway TaihuLight 双精度性能：<code>40 * 4 * 256 * 3.0624 = 125.435904 PFlops</code></p>
<p>MPE: 32KB L1I, 32 KB L1D, 256 KB L2(中文文献里写的是 512 KB)。乱序执行，4 译码，7 发射（5 整数 2 浮点）。指令预取，分支预测，寄存器重命名，预测执行。5 条整数流水线，2 条 256 位 SIMD 浮点流水线。</p>
<p>CPE：16KB L1I，无 DCache，有 64KB 可重构局部数据存储器（SPM scratch pad memory/LDM local data memory）。2 译码 2 发射，乱序执行，1 条 256 位 SIMD 流水线，1 条整数流水线。不同精度的 SIMD 宽度不同，单精度浮点运算 128 位（4 个单精度），双精度浮点运算 256 位（4 个双精度）。从 SPM 每个周期可以读取 32 字节的数据（正好一个 SIMD 寄存器）。</p>
<p>每个 core group 中还有一个 MC（Memory Controller），连接 8GB DDR3 memory，每个 MC 内存带宽 <code>128 bit * 2133 MT/s = 34.128 GB/s</code>，单节点内存带宽 <code>4 * 34.128 = 136.512 GB/s</code>。在 Stream Triad 测试，每个 core group 用 DMA 从内存到 SPM 传输数据带宽为 22.6 GB/s，而全局读写 gload/gstore 带宽只有 1.5 GB/s。访问全局内存需要 120+ 个周期。</p>
<p>8x8 矩阵中的从核可以在同行和同列方向上进行低延迟和高带宽的数据传递：2 个从核点对点通信延迟不超过 11 个周期，单个 core group 寄存器通信集合带宽达到 637 GB/s。</p>
<p>28nm 工艺流片，芯片 die 面积超过 500 mm^2，峰值功耗 292.7W，峰值能效比达 10.559 GFLOPS∕W（HPL 6.05 GFLOPS/W）。</p>
<h3 id="sw26010psw26016pro"><a class="toclink" href="../../hardware/2021/12/04/sunway/#sw26010psw26016pro">SW26010P(SW26016pro)</a></h3>
<p>SW26010P 是升级版 SW26010，目前信息还比较少，从上面的论文里可以推断出的区别：</p>
<ol>
<li>每个 node 从 4 个 core group 升级到 6 个，一共有 <code>6 * (8 * 8 + 1) = 390</code> 个核心。峰值双精度浮点性能 <code>6 * 8 * 8 * 11.6 + 6 * 23.2 = 4.5936 TFlops</code>。SIMD 宽度扩展到 512 位，但可能没有增加双精度浮点计算部件：单精度浮点性能 14 TFlops，半精度浮点性能 53 TFlops。</li>
<li>每个 MC 连接了 16 GB DDR4 内存，带宽是 <code>128 bit * 3200 MT/s = 51.2 GB/s</code>；单节点总内存 96 GB，总内存带宽 <code>51.2 * 6 = 307.2 GB/s</code>。</li>
<li>每个 CPE 的局部存储（LDM）从 64KB 升级到 256KB。</li>
<li>CPE 之间的通信可以通过 RMA 进行，而之前的 SW26010 只能在同一行/列之间进行寄存器通信。</li>
</ol>
<h3 id="sw52020"><a class="toclink" href="../../hardware/2021/12/04/sunway/#sw52020">SW52020</a></h3>
<p>在新闻稿和 Sunway supercomputer architecture towards exascale computing: analysis and practice 文章中出现，没有在今年发出来的论文里实际采用，名称可能是新闻稿自己编的，我猜可能没有实际采用，而是做了 SW26010P。和 SW26010 区别：</p>
<ol>
<li>Core Group 从 4 个提升到了 8 个，所以每个 node 有 <code>8 * (8 * 8 + 1) = 520</code> 个核心。</li>
<li>MPE 和 CPE 向量宽度从 256 位扩展到了 512 位。添加了 16 位半精度浮点支持。</li>
<li>每个 node 提供超过 12 TFlops 的双精度浮点性能。应该是靠两倍的 Core Group，乘上两倍的向量计算宽度，达到四倍的性能。</li>
</ol>

    <nav class="md-post__action">
      <a href="../../hardware/2021/12/04/sunway/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-10-18 00:00:00">2021年10月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rocket-chip-on-vcu128"><a class="toclink" href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/">移植系统到 Rocket Chip on VCU128</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#_1">背景</a></h3>
<p>最近需要在 VCU128 上搭建一个 SOC，然后想到可以把 OpenSBI、U-Boot 和 Linux 移植到这个平台上方便测试，于是又开始折腾这些东西。代码仓库都已经开源：</p>
<ul>
<li><a href="https://github.com/jiegec/rocket-chip-vcu128">rocket-chip-vcu128</a></li>
<li><a href="https://github.com/jiegec/opensbi/tree/rocket-chip-vcu128">opensbi</a></li>
<li><a href="https://github.com/jiegec/u-boot/tree/rocket-chip-vcu128">u-boot</a></li>
<li><a href="https://github.com/jiegec/linux/tree/rocket-chip-vcu128">linux</a></li>
</ul>
<h3 id="rocket-chip-on-vcu128_1"><a class="toclink" href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#rocket-chip-on-vcu128_1">Rocket Chip on VCU128</a></h3>
<p>第一部分是基于之前 <a href="https://github.com/jiegec/rocket2thinpad">rocket2thinpad</a> 在 Thinpad 上移植 Rocket Chip 的经验，做了一些更新，主要是因为 VCU128 的外设不大一样，同时我也要运行更复杂的程序，主要做了这些事情：</p>
<ol>
<li>添加了 VCU128 的内存和外设：HBM、SPI、I2C、UART、ETH</li>
<li>打开了更多核心选项：S-mode 和 U-mode</li>
</ol>
<p>主要踩过的坑：</p>
<ol>
<li>BSCAN 不工作，估计是因为一些参数不对，@jsteward 之前在 zcu 平台上做了一些测试，估计要用类似的办法进行修改；我最后直接去掉了这部分逻辑</li>
<li>这个板子的 PHY RESET 信号要通过 I2C 接口访问 TI 的 Port Expander，所以没法直接连，要通过 gpio 输出来手动 reset</li>
<li>SPI Startup Flash 的时序配置，见我之前的<a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/">博客</a></li>
<li>Xilinx PCS/PMA IP 也会自己挂一个设备到 MDIO bus 上，应该有自己的 PHY 地址，而不要和物理的 PHY 冲突</li>
</ol>
<h3 id="u-boot"><a class="toclink" href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#u-boot">U-Boot</a></h3>
<p>在 U-Boot 上花了比较多的时间，用它的目的主要是：</p>
<ol>
<li>BootROM 中的代码只支持从串口加载程序，如果后续要加载 Linux 内核等软件，性能太差。</li>
<li>U-Boot 驱动比较完善，而且 dts 也可以很容易地迁移到 Linux 中</li>
<li>有一些可以参考的资料</li>
</ol>
<p>移植的时候，首先新建一个自定义的 board，然后自己写 defconfig 和 dts，其中 dts 可以参考 rocket chip 生成的 dts 文件。然后，按照各个外设的 device tree binding 去写，然后打开/关闭各个 CONFIG 开关。</p>
<p>对代码主要的改动是，实现了 DCache 的 flush 功能，因为以太网部分用了 DMA，所以要让外设看到内存的更改，这里采用的是 SiFive 的扩展指令 <code>cflush.d.l1</code>。由于编译器还不支持这个指令，就按照网上的方式去构造了汇编指令。实现完成以后，就可以用网络了。</p>
<p>一开始的时候，为了简单，直接在 M-mode 中运行 U-Boot，这样不需要 OpenSBI，同时 DTB 也是内置的。但后续为了运行 Linux，还是需要一个 SBI 实现：OpenSBI，然后在 S-mode 中运行 U-Boot，再引导到 Linux。</p>
<p>此外还花了很多努力来缩小 binary 大小，首先可以用 <code>nm --size -r u-boot | head -20</code> 来找到比较大的一些符号，不考虑其中 BSS 的部分（type=b），主要看哪些代码/数据比较占空间。</p>
<p>UPDATE: U-Boot 在 v2022.01 版本<a href="https://github.com/u-boot/u-boot/commit/eeaa3fe65270758ab0bdb1515e14f9bf936d3a25">修复了一个 BUG</a>，之前的版本在 riscv 架构下没有 reserve lmb region，使得加载 initrd 的时候，会覆盖掉自己的栈空间，这解释了之前的诸多玄学内存问题，升级到 v2022.01 后就好了。</p>
<h3 id="opensbi"><a class="toclink" href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#opensbi">OpenSBI</a></h3>
<p>OpenSBI 移植比较简单，直接参考 template 修改即可，主要就是串口的配置，其他基本不用改。然后，我把 U-Boot 作为 OpenSBI 的 Payload 放到 OpenSBI 的后面，此时要把 U-Boot 配置为 S-mode 模式。接着，遇到了新的问题：<code>cflush.d.l1</code> 指令只能在 M-mode 用，因此我在 OpenSBI 代码中处理了 trap，转而在 M-mode 里面运行这条指令。这样，就可以在 S-mode 里刷新 Cache 了。</p>
<h3 id="linux"><a class="toclink" href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#linux">Linux</a></h3>
<p>Linux 目前可以 boot 到寻找 init，还没有碰文件系统，之后计划用 buildroot 打一个 initramfs 出来。为了在 U-Boot 中启动 Linux，用 U-Boot 的 mkimage 工具生成了 FIT 格式的 uImage，里面打包了 kernel image 和 dtb，就可以用 bootm 命令启动了，注意地址不要和加载地址重复。</p>
<p>此外还遇到一个坑：RV64 里面 Linux dts 的 address cell 得是 2（对应 64 位），否则会有错误。但 U-Boot 对这个没有做要求。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/#_2">缓存一致性</a></h3>
<p>一开始的时候，AXI DMA 直接接到内存上，所以与 CPU 缓存是不一致的，网卡驱动需要经常地刷缓存。在 Rocket Chip 上，可以用 sifive 自己的 cflush 指令来刷缓存，但是它只能在 M 态执行，同时又支持虚拟地址，这种奇怪的设计就使得要在 OpenSBI，U-Boot 和 Linux 三处都添加逻辑：OpenSBI 处理 illegal instruction，如果发现是 cflush 指令，就再次 cflush；U-Boot 和 Linux 修改驱动，在合适的地方添加 cflush 指令。U-Boot 驱动比较简单，工作得比较好，但是 Linux 的网卡驱动怎么都改不好。</p>
<p>最后决定，打开 Rocket Chip 的 Frontend Bus，添加一个 AXI Slave 接口，然后让 AXI DMA 通过 AXI Slave 接入到 Rocket Chip 中，然后通过 TLBroadcast 实现缓存一致性。这样软件实现会比较简单，但是硬件就更复杂了。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-10-05 00:00:00">2021年10月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="esxi"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/">ESXi 常用信息</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_1">常用链接</a></h3>
<ul>
<li><a href="http://blog.erben.sk/2020/02/04/how-to-check-cpu-microcode-revision-in-esxi/">检查 CPU microcode 版本</a>：</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-0-1"></a>vsish<span class="w"> </span>-e<span class="w"> </span>cat<span class="w"> </span>/hardware/cpu/cpuList/0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;family|model|stepping|microcode|revision&#39;</span>
</span></code></pre></div>
<ul>
<li><a href="https://kb.vmware.com/s/article/56145">ESXi 从 6.7 到 6.7U1 升级时出现版本问题</a></li>
<li><a href="https://customerconnect.vmware.com/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/6_7#custom_iso">ESXi 6.7 OEM 版本下载</a></li>
<li><a href="https://customerconnect.vmware.com/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0#custom_iso">ESXi 7.0 OEM 版本下载</a></li>
<li><a href="https://customerconnect.vmware.com/en/web/vmware/evalcenter?p=free-esxi7">ESXi 7.0 标准版下载</a></li>
<li><a href="https://flings.vmware.com/community-networking-driver-for-esxi/comments">NUC 11 ESXi 7.0 网卡支持</a></li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-1-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>software<span class="w"> </span>vib<span class="w"> </span>install<span class="w"> </span>-d<span class="w"> </span><span class="nv">$PWD</span>/Net-Community-Driver_1.2.0.0-1vmw.700.1.0.15843807_18028830.zip
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_2">离线升级方法</a></h3>
<ol>
<li>下载 Offline Bundle 文件</li>
<li>上传到 ESXi datastore 中</li>
<li>在 <code>/vmfs/volumes/</code> 里找到更新文件</li>
<li>查询 profile 列表 <code>esxcli software sources profile list -d &lt;zip&gt;</code></li>
<li>更新到 profile <code>esxcli software profile update -p &lt;profile&gt; -d &lt;zip&gt;</code></li>
</ol>
<p>ref: <a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.upgrade.doc/GUID-E51C5DB6-F28E-42E8-ACA4-0EBDD11DF55D.html">Upgrade or Update a Host with Image Profiles</a></p>
<p>如果 CPU 比较旧，可能会有警告：<a href="https://kb.vmware.com/s/article/82794">Updated Plan for CPU Support Discontinuation In Future Major vSphere Releases</a>，按照信息添加参数忽略即可，ESXi 7.0 系列都是支持的，如果之后出了新的版本可能不支持。</p>
<h3 id="_3"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_3">在线升级方法</a></h3>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span><span class="nb">set</span><span class="w"> </span>-e<span class="w"> </span><span class="nb">true</span><span class="w"> </span>-r<span class="w"> </span>httpClient
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-2"></a><span class="c1">## find profile name</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-3"></a>$<span class="w"> </span>esxcli<span class="w"> </span>software<span class="w"> </span>sources<span class="w"> </span>profile<span class="w"> </span>list<span class="w"> </span>-d<span class="w"> </span>https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-4"></a><span class="c1">## upgrade to 7.0u3 for example</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-5"></a>$<span class="w"> </span>esxcli<span class="w"> </span>software<span class="w"> </span>profile<span class="w"> </span>update<span class="w"> </span>-p<span class="w"> </span>ESXi-7.0U3-18644231-standard<span class="w"> </span>-d<span class="w"> </span>https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml
</span></code></pre></div>
<p>ref: <a href="https://docs.macstadium.com/docs/update-standalone-esxi-host-via-online-bundle">Update Standalone ESXi Host</a></p>
<h3 id="_4"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_4">防火墙</a></h3>
<p>列出所有防火墙规则：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-3-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span>list
</span></code></pre></div>
<p>允许出站 SSH：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-4-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--ruleset-id<span class="o">=</span>sshClient
</span></code></pre></div>
<p>关闭出站 SSH：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-5-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--enabled<span class="o">=</span><span class="nb">false</span><span class="w"> </span>--ruleset-id<span class="o">=</span>sshClient
</span></code></pre></div>
<h3 id="nuc11i5-esxi-70"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#nuc11i5-esxi-70">NUC11i5 ESXi 7.0 安装过程</a></h3>
<ol>
<li>下载 ESXi ISO 文件，用 UNetbootin 制作安装盘</li>
<li>插入 U 盘，在 NUC 上安装 ESXi，在 81% 的时候卡住了，不管直接重启</li>
<li>用 root 无密码登录进去，然后重置网络设置</li>
<li>配置 usb 网卡，然后通过网页访问 ESXi，打开 SSH</li>
<li>下载 Fling 上面的社区网卡支持，用 esxcli 安装</li>
<li>重启以后，就可以看到 vmnic0 网卡了</li>
</ol>
<p>参考：<a href="https://www.virten.net/2020/07/solution-esxi-installation-with-usb-nic-only-fails-at-81/">Solution: ESXi Installation with USB NIC only fails at 81%</a></p>
<h3 id="_5"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_5">推荐博客</a></h3>
<p>发现以下博客有很多关于 ESXi 的内容：</p>
<ul>
<li>https://williamlam.com/</li>
<li>https://www.virten.net/</li>
</ul>
<h3 id="_6"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_6">重要版本更新</a></h3>
<p>参考 ESXi/vCSA Release Notes：</p>
<ul>
<li>Performance improvements for AMD Zen CPUs: With ESXi 7.0 Update 2, out-of-the-box optimizations can increase AMD Zen CPU performance by up to 30% in various benchmarks. The updated ESXi scheduler takes full advantage of the AMD NUMA architecture to make the most appropriate placement decisions for virtual machines and containers. AMD Zen CPU optimizations allow a higher number of VMs or container deployments with better performance.</li>
<li>Reduced compute and I/O latency, and jitter for latency sensitive workloads: Latency sensitive workloads, such as in financial and telecom applications, can see significant performance benefit from I/O latency and jitter optimizations in ESXi 7.0 Update 2. The optimizations reduce interference and jitter sources to provide a consistent runtime environment. With ESXi 7.0 Update 2, you can also see higher speed in interrupt delivery for passthrough devices.</li>
<li>vSphere Lifecycle Manager fast upgrades: Starting with vSphere 7.0 Update 2, you can configure vSphere Lifecycle Manager to suspend virtual machines to memory instead of migrating them, powering them off, or suspending them to disk. For more information, see Configuring vSphere Lifecycle Manager for Fast Upgrades.</li>
<li>Zero downtime, zero data loss for mission critical VMs in case of Machine Check Exception (MCE) hardware failure: With vSphere 7.0 Update 3, mission critical VMs protected by VMware vSphere Fault Tolerance can achieve zero downtime, zero data loss in case of Machine Check Exception (MCE) hardware failure, because VMs fallback to the secondary VM, instead of failing. For more information, see How Fault Tolerance Works.</li>
</ul>
<h3 id="vcsa"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#vcsa">vCSA 相关常见错误</a></h3>
<ul>
<li>https://kb.vmware.com/s/article/85468 vCSA 日志分区 <code>/storage/log</code> 满，原因是访问 vmware 网站失败打印的日志太大：<code>/storage/log/vmware/analytics/analytics-runtime.log*</code>；解决方法：<code>vmon-cli -r analytics</code> 重启服务，然后删掉旧的日志。</li>
<li>https://kb.vmware.com/s/article/83070 vCSA 日志分区 <code>/storage/log</code> 满，原因是 tomcat 日志太大。</li>
<li><code>XXX Service Health Alarm</code>：尝试重启对应服务，比如 <code>vmon-cli -r perfcharts</code> 对应 <code>Performance Charts</code>，<code>vmon-cli -r vapi-endpoint</code> 对应 <code>VMWare vAPI Endpoint</code></li>
</ul>
<p>查看更新状态：<code>cat /storage/core/software-update/stage_operation</code>；更新文件下载路径：<code>/storage/updatemgr/software-update*/stage</code>。有一个包特别大：<code>wcpovf</code> 需要两个多 G。</p>
<p>CLI 更新方法：https://earlruby.org/2021/01/upgrading-vcenter-7-via-the-command-line/</p>
<h3 id="vm"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#vm">迁移虚拟机到不同 VM</a></h3>
<p>首先，unregister 原来的 VM，然后把文件移动到新的路径下。对于 Thin Provisioned Disk，需要特殊处理，否则直接复制的话，会变成 Thick Provisioned Disk，正确方法是采用 <code>vmkfstool</code>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-6-1"></a>vmkfstool<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;old.vmdk&quot;</span><span class="w"> </span>-d<span class="w"> </span>thin<span class="w"> </span><span class="s2">&quot;new.vmdk&quot;</span>
</span></code></pre></div>
<p>需要注意的是，这里的路径用的是不带 <code>-flat</code> 的 vmdk，因为这个文件记录了 metadata，而 <code>-flat.vmdk</code> 保存了实际的数据。可以用 <code>du</code> 命令看实际的硬盘占用，从而确认它确实是 Thin Provisioned。</p>
<p>如果已经在 Web UI 上复制了，你会发现无法停止复制，解决办法是：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-7-1"></a>/etc/init.d/hostd<span class="w"> </span>restart
</span></code></pre></div>
<p>这样就会重启 Web UI，不过等它恢复需要很长的时间，还要删掉 cookie。</p>

    <nav class="md-post__action">
      <a href="../../devops/2021/10/05/vmware-esxi-notes/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-09-27 00:00:00">2021年9月27日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 14 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="axi-quad-spi"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/">「教学」AXI Quad SPI 时序分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/spi.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#_1">背景</a></h3>
<p>之前一直没搞懂 Vivado 中 xdc 需要怎么编写，遇到一些必须要写 xdc 的时候就很头疼，不知道怎么写才可以得到正确的结果。今天分析了一下 AXI Quad SPI 的时序 xdc，终于理解了其中的含义。</p>
<h3 id="axi-quad-spi_1"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#axi-quad-spi_1">AXI Quad SPI</a></h3>
<p>AXI Quad SPI 是一个 SPI 的控制器，它支持 XIP（eXecute In Place）模式，即可以暴露一个只读 AXI Slave 接口，当接收到读请求的时候，就按照标准的 SPI Flash 命令去对应的地址进行读取，然后返回结果。由于不同厂家的 SPI Flash 支持有所不同，所以 IP 上的设置可以看到厂家的选择。</p>
<p>特别地，一个常见的需求是希望访问 Cfg（Configuration）Flash，亦即用来保存 Bitstream 的 Flash。当 FPGA 上电的时候，如果启动模式设置为 SPI Flash，FPGA 就会向 Cfg Flash 读取 Bitstream，Cfg Flash 需要连接到 FPGA 的指定引脚上，当 FPGA 初始化的时候由内部逻辑驱动，初始化完成后又要转交给用户逻辑。转交的方式就是通过 STARTUP 系列的 primitive。</p>
<p>通常，如果要连接外部的 SPI Flash，需要连接几条信号线到顶层，然后通过 xdc 把信号绑定到引脚上，然后引脚连接了一个外部的 SPI Flash。但由于 Cfg Flash 比较特殊，所以信号从 AXI Quad SPI 直接连到 STARTUP 系列的 primitive 上。如果是采用 STARTUPE2 原语的 7 系列的 FPGA，那么只有时钟会通过 STARTUPE2 pritimive 连接到 SPI Flash 上，其他数据信号还是正常通过顶层绑定；如果是采用 STARTUPE3 原语的 UltraScale 系列的 FPGA，那么时钟和数据都通过 STARTUPE3 primitive 连接到 SPI Flash。</p>
<h3 id="virtex-ultrascale"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#virtex-ultrascale">Virtex UltraScale+ 时序</a></h3>
<p>把信号连好了只是第一步，因为外设对时序要求比较复杂，如果用一个比较高直接跑，很大可能就读取到错误的数据了。很贴心的是，AXI Quad SPI 已经在生成的文件里提供了一个样例的 xdc，在文档里也有体现。在这里，我使用的设备是 Virtex Ultrascale+ 的 FPGA，其他系列的 FPGA 会有所不一样。它内容如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-1"></a>##### All the delay numbers have to be provided by the user
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-3"></a>##### Following are the SPI device parameters
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-4"></a>##### Max Tco
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-5"></a>set tco_max 7
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-6"></a>##### Min Tco
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-7"></a>set tco_min 1
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-8"></a>##### Setup time requirement
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-9"></a>set tsu 2
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-10"></a>##### Hold time requirement
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-11"></a>set th 3
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-12"></a>######################################################################################################
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-13"></a>## STARTUPE3 primitive included inside IP for US+                                                             #
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-14"></a>######################################################################################################
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-15"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-16"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-17"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-18"></a>set tclk_trace_delay_min 0.2
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-19"></a>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-20"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical *axi_quad_spi_0/ext_spi_clk] [get_pins -hierarchical */CCLK] -edges {3 5 7}
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-21"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max + $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-22"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min + $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-23"></a>set_multicycle_path 2 -setup -from clk_sck -to [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]]
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-24"></a>set_multicycle_path 1 -hold -end -from clk_sck -to [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]]
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-25"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max - $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-26"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th - $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-27"></a>set_multicycle_path 2 -setup -start -from [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]] -to clk_sck
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-28"></a>set_multicycle_path 1 -hold -from [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]] -to clk_sck
</span></code></pre></div>
<p>我们分段来看这个 xdc 都做了什么：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-1-1"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical *axi_quad_spi_0/ext_spi_clk] [get_pins -hierarchical */CCLK] -edges {3 5 7}
</span></code></pre></div>
<p>首先，它创建了一个时钟 <code>clk_sck</code>。CCLK 是 STARTUP 输出的实际时钟，会连接到 Cfg Flash 的时钟信号上。而 AXI Quad SPI 的 ext_spi_clk 会输出到 CCLK 上，因此这里是一个生成的时钟，并且指定上下边沿的位置。<code>edges</code> 参数有三个，分别表示上升、下降和上升沿分别的位置。1 表示源时钟的第一个上升沿，2 表示源时钟的第一个下降沿，以此类推，所以 {3, 5, 7} 的意思就是频率减半，相位差半个周期。</p>
<p>接着，最主要的就是，怎么设置延迟。可以看到，代码中首先定义了一些参数：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-1"></a>##### Max Tco
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-2"></a>set tco_max 7
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-3"></a>##### Min Tco
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-4"></a>set tco_min 1
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-5"></a>##### Setup time requirement
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-6"></a>set tsu 2
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-7"></a>##### Hold time requirement
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-8"></a>set th 3
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-10"></a>##### Trace delay
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-11"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-12"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-13"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-14"></a>set tclk_trace_delay_min 0.2
</span></code></pre></div>
<p>首先是 <span class="arithmatex">\(t_{co}\)</span>，应该表示的是 SPI Flash 的时钟到输出的延迟。本文用的 SPI Flash 型号是 Micron MT25QU02GCBB8E12-0SIT，可以从它的 <a href="https://media-www.micron.com/-/media/client/global/documents/products/data-sheet/nor-flash/serial-nor/mt25q/die-rev-b/mt25q_qlkt_u_02g_cbb_0.pdf">Datasheet</a> 看到，时钟到输出的延迟应该是 Max 7ns：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-3-1"></a>Clock LOW to output valid under 30pF Max 7ns
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-3-2"></a>Clock LOW to output valid under 10pF Max 6ns
</span></code></pre></div>
<p>因此 <code>tco_max</code> 设为 7，<code>tco_min</code> 默认即可，因为 Datasheet 中没有做要求。</p>
<p>然后 <span class="arithmatex">\(t_{su}\)</span> 和 <span class="arithmatex">\(t_h\)</span> 则是输入的 setup 和 hold time。类似的，可以查到 SPI Flash 的参数：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-4-1"></a>Data in setup time Min 2.5ns
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-4-2"></a>Data in hold time Min 2ns
</span></code></pre></div>
<p>所以 <code>tsu</code> 设为 2.5，<code>th</code> 设为 2。</p>
<p>接下来则是 tdata 和 tclk 的 trace delay。这指的是从 FPGA 引脚到 SPI Flash 引脚的信号传输延迟。从严谨的角度来说，可以从板子的布线上测量长度来计算出来，不过这里就先用默认值了。一个简单的估算方法：光速 <span class="arithmatex">\(3*10^8 \text{m/s}\)</span>，考虑电信号传播速度是光速的一半，可以得到延迟和长度的比值： <span class="arithmatex">\(0.06 \text{ns/cm} = 0.15 \text{ns/inch}\)</span>。</p>
<p>那么，这些变量怎么参与到 input/output delay 的计算呢？</p>
<p>首先考虑 input delay。它指的是，从 SPI Flash 到 FPGA 的数据，相对于时钟的延迟。这个延迟由三部分组成：</p>
<ol>
<li>从 FPGA 输出的时钟 CCLK 到 SPI Flash 的时钟有延迟 <span class="arithmatex">\(t_{clk}\)</span>，下图 <code>a -&gt; b</code></li>
<li>从 SPI Flash 的时钟到数据输出有延迟 <span class="arithmatex">\(t_{co}\)</span>，下图 <code>b -&gt; c</code></li>
<li>从 SPI Flash 的数据到 FPGA 的数据输入有延迟 <span class="arithmatex">\(t_{data}\)</span>，下图 <code>c -&gt; d</code></li>
</ol>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p..", node: ".a" },
      { name: "clk_flash", wave: "p...", node: "..b", phase: 2.7 },
      { name: "data_flash", wave: "3456", node: "..c", phase: 2.5 },
      { name: "data_fpga", wave: "3456", node: "..d", phase: 2.3 },
    ],
  config: { hscale: 3 },
}</script>
<p>因此总延迟就是 <span class="arithmatex">\(t_{clk}+t_{co}+t_{data}\)</span>，就可以得到对应的设置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-5-1"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max + $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-5-2"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min + $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span></code></pre></div>
<p>接下来要考虑 output delay。虽然 output delay 也有 min 和 max，但其含义有所区别，需要分别考虑。</p>
<p>首先是 max，它对应的是 setup time。如果定义时间 0 为时钟的上升沿，沿更早的时间为正的时间轴，沿更晚的时间为负的时间轴。那么，我们希望的是，数据到达寄存器输入的时间大于 setup time，此时可以满足 setup 条件。那么，具体怎么算呢？注意，我们要考虑的是从 FPGA 数据输出到 SPI Flash 上时钟的延迟。</p>
<p>假设 FPGA CCLK 时钟上升沿在 <span class="arithmatex">\(0\)</span> 时刻（下图的 <code>a</code>），那么 SPI Flash 时钟上升沿在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻（下图的 <code>b</code>）。假设 FPGA 数据输出时刻为 <span class="arithmatex">\(t_0\)</span>（通常为正，下图的 <code>c</code>），那么 FPGA 数据输出到达 SPI Flash 在 <span class="arithmatex">\(t_0-t_{data}\)</span> 时刻（下图的 <code>d</code>），我们期望 <span class="arithmatex">\(t_0-t_{data}\)</span> 在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻之前（下图的 <code>d -&gt; b</code>）至少 <span class="arithmatex">\(t_{su}\)</span> 时间到达，可以得到表达式：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p..", node: ".a" },
      { name: "clk_flash", wave: "p...", node: "..b", phase: 2.7 },
      { name: "data_fpga", wave: "3456", node: "..c", phase: 3.6 },
      { name: "data_flash", wave: "3456", node: "..d", phase: 3.4 }
    ],
  config: { hscale: 3 },
}</script>
<div class="arithmatex">\[
t_0 - t_{data} &gt; -t_{clk} + t_{su}
\]</div>
<p>化简一下，就可以得到 <span class="arithmatex">\(t_0 &gt; t_{data} + t_{su} - t_{clk}\)</span>，如果考虑极端情况，右侧 <span class="arithmatex">\(t_{data}\)</span> 取最大值，<span class="arithmatex">\(t_{clk}\)</span> 取最小值，我们就可以得到约束：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-6-1"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max - $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span></code></pre></div>
<p>接下来考虑 output delay 的 min，这对应的是 hold time。我们希望数据到达 SPI Flash 寄存器的时候，距离上升沿时间超过了 <span class="arithmatex">\(t_h\)</span>。还是一样的假设，如果 FPGA CCLK 时钟上升沿在 0 时刻（下图的 <code>a</code>），那么 SPI Flash 时钟上升沿在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻（下图的 <code>b</code>）。假设 FPGA 数据输出时刻为 <span class="arithmatex">\(t_0\)</span>（下图的 <code>c</code>），那么 FPGA 数据输出到达 SPI Flash 在 <span class="arithmatex">\(t_0-t_{data}\)</span> 时刻（下图的 <code>d</code>），要求满足 hold 条件，可以得到：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p..", node: ".a" },
      { name: "data_fpga", wave: "3456", node: "..c", phase: 2.6 },
      { name: "clk_flash", wave: "p...", node: "..b", phase: 2.3 },
      { name: "data_flash", wave: "3456", node: "..d", phase: 2.2 },
    ],
  config: { hscale: 3 },
}</script>
<div class="arithmatex">\[
t_0 - t_{data} &lt; -t_{clk} - t_h
\]</div>
<p>化简以后，可以得到 <span class="arithmatex">\(t_0 &lt; t_{data} - t_{clk} - t_h\)</span>，按照极限来取，<span class="arithmatex">\(t_{data}\)</span> 取最小值，<span class="arithmatex">\(t_{clk}\)</span> 取最大值，可以得到最终的时序约束：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-7-1"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th - $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span></code></pre></div>
<p>这样就可以实现 FPGA 和 SPI Flash 之间的正常通讯了。我觉得，这里比较绕的就是时间轴的定义，和我们平常思考的是反过来的。而且，这里的 min 和 max 并不是指 <span class="arithmatex">\([\min, \max]\)</span>，而是 <span class="arithmatex">\((-\inf, \min] \cup [\max, \inf)\)</span>。代入上面的数据，可以得到 <span class="arithmatex">\(\max=2.05, \min=-2.95, t_0 \in (\inf, -2.95] \cup [2.05, \inf)\)</span>。如果变化的时刻距离时钟上升沿太接近，就会导致在 SPI Flash 侧出现不满足 setup 或者 hold 约束的情况。</p>
<p>也可以换个角度来理解 min 和 max：对于同一个周期的时钟和数据来说，数据相对时钟有一个延迟，这个延迟不能太小，至少要满足 hold，所以这是一个最小的延迟；同时这个延迟不能太大，最多需要满足下一个时钟上升沿的 setup，所以这是一个最大的延迟。如果从这个角度来看，那就是延迟在一个 <span class="arithmatex">\([\min, \max]\)</span> 的范围内。但是，这样在计算的时候就需要把时钟周期纳入到 <span class="arithmatex">\(\max\)</span> 的计算中，比如 <span class="arithmatex">\(\max=t_c-t_{su}\)</span>。如果我们把坐标轴修改一下，原点变成原来的下一个时钟周期的上升沿，x 的正方向变成反向，就可以得到上面的形式了。</p>
<h3 id="artix-7"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#artix-7">Artix 7 时序</a></h3>
<p>那么，更常见的 FPGA 是 7 系列的，比如 Artix 7，它采用的是 STARTUPE2 原语，只有时钟是通过 STARTUPE2 原语的 USRCCLKO 信号传递到 CCLK 引脚上的，其他数据信号都是需要在顶层信号绑定对应的引脚。在 AXI Quad SPI 文档中，描述了 STARTUPE2 所需要的时序约束，我们分段来分析一下。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-1"></a>## You must provide all the delay numbers
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-2"></a>## CCLK delay is 0.5, 6.7 ns min/max for K7-2; refer Data sheet
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-3"></a>## Consider the max delay for worst case analysis
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-4"></a>set cclk_delay 6.7
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-5"></a>## Following are the SPI device parameters
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-6"></a>## Max Tco
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-7"></a>set tco_max 7
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-8"></a>## Min Tco
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-9"></a>set tco_min 1
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-10"></a>## Setup time requirement
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-11"></a>set tsu 2
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-12"></a>## Hold time requirement
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-13"></a>set th 3
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-14"></a>## Following are the board/trace delay numbers
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-15"></a>## Assumption is that all Data lines are matched
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-16"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-17"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-18"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-19"></a>set tclk_trace_delay_min 0.2
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-20"></a>#### End of user provided delay numbers
</span></code></pre></div>
<p>可以看到，这一部分和上面 UltraScale+ 部分差不多，只是多一个 <code>cclk_delay</code> 变量，这是因为 Artix 7 中，时钟只能创建到 USRCCLKO 引脚上，但是实际 SPI Flash 接收到的时钟等于 USRCCLKO 到 CCLK 引脚，然后再通过 PCB 上的线传播到 SPI Flash，所以需要手动添加一个偏移，这个偏移就是 USRCCLKO 到 CCLK 的延迟，可以在 <a href="https://www.xilinx.com/support/documentation/data_sheets/ds181_Artix_7_Data_Sheet.pdf">Artix 7 Data Sheet</a> 里面看到：对于 1.0V，-2 速度的 FPGA，这个延迟最小值为 0.50ns，最大值为 6.70ns，这里采用了最大值。</p>
<p>所以，下面的约束，除了时钟部分以外，和上面分析的 UltraScale+ 时序约束计算方法是相同的。不同点在于，首先约束了从 AXI Quad SPI 到 STARTUPE2 的路由时延，从 0.1ns 到 1.5ns，然后又从 USRCCLKO 创建了一个分频 + 延迟 <code>cclk_delay</code> 纳秒的时钟，作为 SPI Flash 上 SCK 引脚的时钟。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-1"></a>## this is to ensure min routing delay from SCK generation to STARTUP input
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-2"></a>## User should change this value based on the results
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-3"></a>## having more delay on this net reduces the Fmax
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-4"></a>set_max_delay 1.5 -from [get_pins -hier *SCK_O_reg_reg/C] -to [get_pins -hier
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-5"></a>*USRCCLKO] -datapath_only
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-6"></a>set_min_delay 0.1 -from [get_pins -hier *SCK_O_reg_reg/C] -to [get_pins -hier
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-7"></a>*USRCCLKO]
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-8"></a>## Following command creates a divide by 2 clock
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-9"></a>## It also takes into account the delay added by STARTUP block to route the CCLK
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-10"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-11"></a>*axi_quad_spi_1/ext_spi_clk] [get_pins -hierarchical *USRCCLKO] -edges {3 5 7}
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-12"></a>-edge_shift [list $cclk_delay $cclk_delay $cclk_delay]
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-13"></a>## Data is captured into FPGA on the second rising edge of ext_spi_clk after the SCK
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-14"></a>falling edge
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-15"></a>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-16"></a>## Data is driven by the FPGA on every alternate rising_edge of ext_spi_clk
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-17"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max +
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-18"></a>$tclk_trace_delay_max] [get_ports IO*_IO] -clock_fall;
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-19"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min +
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-20"></a>$tclk_trace_delay_min] [get_ports IO*_IO] -clock_fall;
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-21"></a>set_multicycle_path 2 -setup -from clk_sck -to [get_clocks -of_objects [get_pins
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-22"></a>-hierarchical */ext_spi_clk]]
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-23"></a>set_multicycle_path 1 -hold -end -from clk_sck -to [get_clocks -of_objects [get_pins
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-24"></a>-hierarchical */ext_spi_clk]]
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-25"></a>## Data is captured into SPI on the following rising edge of SCK
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-26"></a>## Data is driven by the IP on alternate rising_edge of the ext_spi_clk
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-27"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max -
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-28"></a>$tclk_trace_delay_min] [get_ports IO*_IO];
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-29"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th -
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-30"></a>$tclk_trace_delay_max] [get_ports IO*_IO];
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-31"></a>set_multicycle_path 2 -setup -start -from [get_clocks -of_objects [get_pins
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-32"></a>-hierarchical */ext_spi_clk]] -to clk_sck
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-33"></a>set_multicycle_path 1 -hold -from [get_clocks -of_objects [get_pins -hierarchical */
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-34"></a>ext_spi_clk]] -to clk_sck
</span></code></pre></div>
<p>一个 Artix 7 上配置 STARTUP SPI Flash 的例子 <a href="https://github.com/trivialmips/nontrivial-mips/blob/master/vivado/NonTrivialMIPS.srcs/constrs_1/new/io_timings.xdc">io_timings.xdc</a> 可供参考。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-09-18 00:00:00">2021年9月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="k8s"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/">研究 k8s 网络工作原理</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#_1">背景</a></h3>
<p>用 k8s 也有一段时间了，之前遇到过 iptables 等出现问题，导致 k8s 节点间网络出现问题，于是想研究一下 k8s 的网络工作原理。</p>
<h3 id="docker"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#docker">Docker 网络</a></h3>
<p>首先研究一下 Docker 网络连接是如何实现的。Docker 首先会创建一个 bridge，名为 bridge0:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-1"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>docker0
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-2"></a><span class="m">3</span>:<span class="w"> </span>docker0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-3"></a><span class="w">    </span>link/ether<span class="w"> </span><span class="m">02</span>:42:c4:87:73:bf<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-4"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">172</span>.17.0.1/16<span class="w"> </span>brd<span class="w"> </span><span class="m">172</span>.17.255.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>docker0
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-5"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-6"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::42:c4ff:fe87:73bf/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-7"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span></code></pre></div>
<p>默认情况下，每个容器都会有单独的一个 netns，然后创建一对 veth pair，一端留在 global netns，另一端放到容器中。在 global netns 中的 veth 端口会加入到 docker0 中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-1"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>veth3db9316
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-2"></a><span class="m">21</span>:<span class="w"> </span>veth3db9316@if20:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>master<span class="w"> </span>docker0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-3"></a><span class="w">    </span>link/ether<span class="w"> </span>e2:49:a6:2d:5a:bd<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff<span class="w"> </span>link-netnsid<span class="w"> </span><span class="m">0</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-4"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::e049:a6ff:fe2d:5abd/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-5"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-6"></a>$<span class="w"> </span>brctl<span class="w"> </span>show<span class="w"> </span>docker0
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-7"></a>bridge<span class="w"> </span>name<span class="w">     </span>bridge<span class="w"> </span>id<span class="w">               </span>STP<span class="w"> </span>enabled<span class="w">     </span>interfaces
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-8"></a>docker0<span class="w">         </span><span class="m">8000</span>.0242c48773bf<span class="w">       </span>no<span class="w">              </span>veth3db9316
</span></code></pre></div>
<p>容器中的网络，在 veth 上 docker 会分配并配置一个地址（比如 172.17.0.2），然后设置默认路由 via 172.17.0.1。一方面，可以通过默认路由到 172.17.0.1 再通过 iptables NAT 访问外面的网络：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-1"></a>$<span class="w"> </span>iptables-save<span class="w"> </span>-t<span class="w"> </span>nat
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-2"></a><span class="c1">## Generated by xtables-save v1.8.2 on Sat Sep 18 10:44:49 2021</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-3"></a>*nat
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-4"></a>:PREROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-5"></a>:INPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-6"></a>:POSTROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-7"></a>:OUTPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-8"></a>:DOCKER<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-9"></a>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-m<span class="w"> </span>addrtype<span class="w"> </span>--dst-type<span class="w"> </span>LOCAL<span class="w"> </span>-j<span class="w"> </span>DOCKER
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-10"></a>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.17.0.0/16<span class="w"> </span>!<span class="w"> </span>-o<span class="w"> </span>docker0<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-11"></a>-A<span class="w"> </span>OUTPUT<span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="m">127</span>.0.0.0/8<span class="w"> </span>-m<span class="w"> </span>addrtype<span class="w"> </span>--dst-type<span class="w"> </span>LOCAL<span class="w"> </span>-j<span class="w"> </span>DOCKER
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-12"></a>-A<span class="w"> </span>DOCKER<span class="w"> </span>-i<span class="w"> </span>docker0<span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-13"></a>COMMIT
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-14"></a><span class="c1">## Completed on Sat Sep 18 10:44:49 2021</span>
</span></code></pre></div>
<p>另一方面，因为连接不同容器的 veth 在同一个 bridge 下面，所以不同容器的可以认为在同一个二层网络中，自然可以互相访问。</p>
<h3 id="k8s_1"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#k8s_1">K8s 网络</a></h3>
<p>在 k8s 中，所有的 pod 都希望可以通过 IP 地址互联。一个思路是把各个节点上的 pod 通过类似 docker 的方法实现，即每个 netns 通过 veth 连接到一个 bridge 上，然后再想办法去路由在其它节点上的 pod。</p>
<p>因为我用 k3s 搭建 k8s 集群，它用的 cni 是 flannel。flannel 采用的是 vxlan 的方式来实现节点间的网络通信。</p>
<p>首先还是看看节点内的 pod 如何组网。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-1"></a><span class="m">5</span>:<span class="w"> </span>cni0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1450</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-2"></a><span class="w">    </span>link/ether<span class="w"> </span>6a:4f:ff:8b:b1:b3<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-3"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">10</span>.42.0.1/24<span class="w"> </span>brd<span class="w"> </span><span class="m">10</span>.42.0.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>cni0
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-4"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-5"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::7cf6:57ff:fed7:c49b/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-6"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-7"></a><span class="m">6</span>:<span class="w"> </span>vethc47d6140@if3:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1450</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>master<span class="w"> </span>cni0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-8"></a><span class="w">    </span>link/ether<span class="w"> </span>da:19:f8:48:f6:49<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff<span class="w"> </span>link-netns<span class="w"> </span>cni-9d2a5120-16a3-453e-bf64-c4006c06c93b
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-9"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::d819:f8ff:fe48:f649/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-10"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span></code></pre></div>
<p>首先，flannel 给每个节点分配了一个 /24 的网段，比如第一个节点是 10.42.0.0/24，第二个是 10.42.1.0/24，依次类推。然后，节点内的 pod 就从这个网段里分配地址，比如 10.42.0.50/24，它的默认网关是 10.42.0.1。这些 veth 都会加入到 cni0 的 bridge 中。这一部分原理和 docker 是一样的，只不过名字不同了。也有相应的 iptables 规则：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-4-1"></a>$<span class="w"> </span>iptables-save<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>MASQUERADE
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-4-2"></a>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.42.0.0/16<span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="m">224</span>.0.0.0/4<span class="w"> </span>-j<span class="w"> </span>MASQUERADE<span class="w"> </span>--random-fully
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../devops/2021/09/18/k8s-networking/#__codelineno-4-3"></a>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.42.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.42.0.0/16<span class="w"> </span>-j<span class="w"> </span>MASQUERADE<span class="w"> </span>--random-fully
</span></code></pre></div>
<p>那么，节点间网络如何实现呢？假如，我们要从第一个节点 pod 10.42.0.50/24 访问第二个节点的 pod 10.42.1.51/24，首先，pod 根据默认路由会发给 10.42.0.1/24，到达第一个节点的 cni0，然后查路由表：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-5-1"></a>$<span class="w"> </span>ip<span class="w"> </span>r
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-5-2"></a><span class="m">10</span>.42.0.0/24<span class="w"> </span>dev<span class="w"> </span>cni0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.42.0.1
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../devops/2021/09/18/k8s-networking/#__codelineno-5-3"></a><span class="m">10</span>.42.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.42.1.0<span class="w"> </span>dev<span class="w"> </span>flannel.1<span class="w"> </span>onlink
</span></code></pre></div>
<p>可以看到，它会匹配 10.42.1.0/24 via 10.42.1.0 dev flannel.1 的路由。flannel.1 是一个 vxlan 的 interface：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-1"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>flannel.1
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-2"></a><span class="m">4</span>:<span class="w"> </span>flannel.1:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1450</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UNKNOWN<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-3"></a><span class="w">    </span>link/ether<span class="w"> </span>b6:2f:39:4a:02:c0<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-4"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">10</span>.42.0.0/32<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>flannel.1
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-5"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-6"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::b42f:39ff:fe4a:2c0/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-7"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span></code></pre></div>
<p>当这个 interface 接收到一个 packet 的时候，会查询 fdb：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../devops/2021/09/18/k8s-networking/#__codelineno-7-1"></a>$<span class="w"> </span>bridge<span class="w"> </span>fdb<span class="w"> </span>show<span class="w"> </span>brport<span class="w"> </span>flannel.1
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../devops/2021/09/18/k8s-networking/#__codelineno-7-2"></a>...
</span></code></pre></div>
<p>这个 fdb 中包括了 (MAC 地址，IP 地址) 的 tuple。当 flannel.1 收到一个 Ethernet Frame 的时候，如果目的地址匹配这里的 MAC 地址，就会直接把 Eth Frame 封装到 UDP 里面发给目的 IP 地址；否则，就会在这个表里面 broadcast。这样，第二个节点就会收到 packet 并且转给实际的 pod。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#_2">总结</a></h3>
<p>总结一下 k8s 的网络互联的实现方法：节点内通过 bridge 实现，把链接各个 netns 的 veth 桥接起来；节点间划分为多个子网，子网间通过 flannel 的网关进行路由，flannel 网关间通过 vxlan 进行互联。</p>
<h3 id="_3"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#_3">参考文档</a></h3>
<p><a href="https://zhuanlan.zhihu.com/p/34749675">技术干货 | 深入理解 flannel</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/140711132">一文看懂 k8s 的 Flannel 网络</a></p>

    <nav class="md-post__action">
      <a href="../../devops/2021/09/18/k8s-networking/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-09-14 00:00:00">2021年9月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 14 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cpu"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/ooo_cpu.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#_1">背景</a></h3>
<p>最早学习乱序执行 CPU 的时候，是在 Wikipedia 上自学的，后来在计算机系统结构课上又学了一遍，但发现学的和现在实际采用的乱序执行 CPU 又有很大区别，后来又仔细研究了一下，觉得理解更多了，就想总结一下。</p>
<h3 id="tomasulo"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#tomasulo">经典 Tomasulo</a></h3>
<p>参考 <a href="https://people.eecs.berkeley.edu/~pattrsn/252F96/Lecture04.pdf">Stanford 教材</a></p>
<p>经典 Tomasulo，也是 Wikipedia 上描述的 Tomasulo 算法，它的核心是保留站。指令在 Decode 之后，会被分配到一个保留站中。保留站有以下的这些属性：</p>
<ol>
<li>Op：需要执行的操作</li>
<li>Qj，Qk：操作数依赖的指令目前所在的保留站 ID</li>
<li>Vj，Qk：操作数的值</li>
<li>Rj，Rk：操作数是否 ready（或者用特殊的 Qj，Qk 值表示是否 ready）</li>
<li>Busy：这个保留站被占用</li>
</ol>
<p>此外还有一个 mapping（Wikipedia 上叫做 RegisterStat），记录了寄存器是否会被某个保留站中的指令写入。</p>
<p>指令分配到保留站的时候，会查询 RegisterStat，得知操作数寄存器是否 ready，如果不 ready，说明有一个先前的指令要写入这个寄存器，那就记录下对应的保留站 ID。当操作数都 ready 了，就可以进入计算单元计算。当一条指令在执行单元中完成的时候，未出现 WAW 时会把结果写入寄存器堆，并且通过 Common Data Bus 进行广播，目前在保留站中的指令如果发现，它所需要的操作数刚好计算出来了，就会把取值保存下来。</p>
<p>这里有一些细节：因为保留站中的指令可能要等待其他指令的完成，为了保证计算单元利用率更高，对于同一个计算类型（比如 ALU），需要有若干个同类的保留站（比如 Add1，Add2，Add3）。在 Wikipedia 的表述中，每个保留站对应了一个计算单元，这样性能比较好，但自然面积也就更大。如果节省面积，也可以减少计算单元的数量，然后每个计算单元从多个保留站中获取计算的指令。</p>
<p>可以思考一下，这种方法的瓶颈在什么地方。首先，每条指令都放在一个保留站中，当保留站满的时候就不能发射新的指令。其次，如果计算单元的吞吐跟不上保留站的填充速度，也会导致阻塞。</p>
<p>这种方法的一个比较麻烦的点在于难以实现精确异常。精确异常的关键在于，异常之前的指令都生效，异常和异常之后的指令不生效，但这种方法无法进行区分。</p>
<p>从寄存器重命名的角度来看，可以认为这种方法属于 Implicit Register Renaming，也就是说，把 Register 重命名为保留站的 ID。</p>
<p>再分析一下寄存器堆需要哪些读写口。有一条规律是，寄存器堆的面积与读写口个数的平方成正比。对于每条发射的指令，都需要从寄存器堆读操作数，所以读口是操作数 x 指令发射数。当执行单元完成计算的时候，需要写入寄存器堆，所以每个执行单元都对应一个寄存器堆的写口。</p>
<p>硬件实现的时候，为了性能，希望保留站可以做的比较多，这样可以容纳更多的指令。但是，保留站里面至少要保存操作数的值，会比较占用面积，并且时延也比较大。</p>
<h3 id="rob-reorder-buffer"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#rob-reorder-buffer">ROB (ReOrder Buffer)</a></h3>
<p><a href="https://web.stanford.edu/class/cs349g/cs349g-speculation.pdf">参考教材</a></p>
<p>为了实现精确异常，我们需要引入 ROB。在上面的 Tomasulo 算法中，计算单元计算完成的时候，就会把结果写入到寄存器堆中，因此精确异常时难以得到正确的寄存器堆取值。既然我们希望寄存器堆的状态与顺序执行的结果一致，我们需要引入 ROB。</p>
<p>ROB 实际上就是一个循环队列，队列头尾指针之间就是正在执行的指令，每个 ROB 表项记录了指令的状态、目的寄存器和目的寄存器将要写入的值。ROB 会检查队列头的指令，如果已经执行完成，并且没有异常，就可以让结果生效，并把指令从队列头中删去，继续检查后面的。Decode 出来的指令则会插入到 ROB 的尾部，并且随着指令的执行过程更新状态。遇到异常的指令，就把队列中的指令、保留站和执行单元清空，从异常处理地址开始重新执行。</p>
<p>为了保证寄存器堆的正确性，运算单元的运算结果会写入 ROB 项中，当这一项在 ROB 队列头部被删去时，就会写入寄存器堆。在经典 Tomasulo 中，寄存器重命名为保留站的 ID，但在这种设计中，应该重命名为 ROB 的 ID，也就是说，需要维护一个寄存器到 ROB ID 的映射，当指令进入保留站的时候，需要从寄存器堆或者 ROB 中去读取操作数的值。在 CDB 上广播的也是 ROB 的 ID，而不是保留站的 ID。</p>
<p>这种方法中，ROB 的大小成为了一个新的瓶颈，因为每条在正在执行的指令都需要在 ROB 中记录一份。不过好处是实现了精确异常。</p>
<h3 id="explicit-register-renaming"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#explicit-register-renaming">Explicit Register Renaming</a></h3>
<p>上面两种设计都是采用的 Implicit Register Renaming 的方法，第一种方法重命名到了保留站，第二种方法重命名到了 ROB。还有一种设计，把寄存器编号映射到物理的寄存器。把 ISA 中的寄存器称为架构寄存器（比如 32 个通用寄存器），CPU 中实际的寄存器称为物理寄存器，物理寄存器一般会比架构寄存器多很多（一两百个甚至更多）。</p>
<p>Explicit Register Renaming 和 ReOrder Buffer 这两个设计方向可以同时使用，也可以单独使用。</p>
<p>映射的方法和前面的类似，也是维护一个 mapping，从架构寄存器到物理寄存器。当一条指令 Dispatch 的时候，操作数在 mapping 中找到实际的物理寄存器编号。如果这条指令要写入新的架构寄存器，则从未分配的物理寄存器中分配一个新的物理寄存器，并且更新 mapping，即把写入的架构寄存器映射到新的物理寄存器上。然后，放到 Issue Queue 中。</p>
<p>Issue Queue 可以理解为保留站的简化版，它不再保存操作数的取值，而仅仅维护操作数是否 ready。后面解释为什么不需要保存操作数的取值。在 Issue Queue 中的指令在所有操作数都 ready 的时候，则会 Issue 到不同的端口中。每个端口对应着一个执行单元，比如两个 ALU 端口分别对应两个 ALU 执行单元。指令首先通过寄存器堆，以物理寄存器为编号去读取数据，然后这个值直接传给执行单元，不会存下来。当执行单元执行完毕的时候，结果也是写到物理寄存器堆中，ROB 不保存数据。</p>
<p>可以发现，这种设计中，值仅保存在寄存器堆中，Issue Queue 和 ROB 都只保存一些状态位，因此它们可以做的很大，典型的 Issue Queue 有几十项，ROB 则有几百项。</p>
<p>接下来讨论一些细节。首先是，物理寄存器何时释放。当一条指令写入一个架构寄存器的时候，在下一次这个架构寄存器被写入之前，这个寄存器的值都有可能被读取，因此这个架构寄存器到物理寄存器的映射要保留。如果我们能保证读取这个值的指令都已经完成，我们就可以释放这个物理寄存器了。一个方法是，我在覆盖架构寄存器到物理寄存器的映射时，我还要记录原来的物理寄存器，当该指令在 ROB 中提交了（从队头出去了），说明之前可能依赖这个物理寄存器的所有指令都完成了，这时候就可以把原来的物理寄存器放到未映射的列表中。</p>
<p>还有一个问题，就是在遇到异常的时候，如何恢复在异常指令处的架构寄存器到物理寄存器的映射呢？一个办法是，利用我在 ROB 中记录的被覆盖的物理寄存器编号，从 ROB 队尾往前回滚，当发现一条指令覆盖了一个架构寄存器映射的时候，就恢复为覆盖之前的值。这样，当回滚到异常指令的时候，就会得到正确的映射。<a href="https://ieeexplore.ieee.org/document/491460">MIPS R10K 的论文</a>中是这么描述的：</p>
<div class="language-text highlight"><pre><span></span><code>The active list contains the logical-destination register number and its
old physical-register number for each instruction. An instruction&#39;s
graduation commits its new mapping, so the old physical register can
return to the free list for reuse. When an exception occurs, however,
subsequent instructions never graduate. Instead, the processor restores
old mappings from the active list. The R1OOOO unmaps four instructions
per cycle--in reverse order, in case it renamed the same logical
register twice. Although this is slower than restoring a branch,
exceptions are much rarer than mispredicted branches. The processor
returns new physical registers to the free lists by restoring their read
pointers.
</code></pre></div>
<p>和 @CircuitCoder 讨论并参考 <a href="https://docs.boom-core.org/en/latest/sections/reorder-buffer.html#parameterization-rollback-versus-single-cycle-reset">BOOM 文档</a> 后发现，另一种办法是记录一个 Committed Map Table，也就是，只有当 ROB Head 的指令被 Commit 的时候，才更新 Committed Map Table，可以认为是顺序执行的寄存器映射表。当发生异常的时候，把 Committed Map Table 覆盖到 Register Map Table 上。这样需要的周期比较少，但是时序可能比较差。</p>
<h3 id="implicit-renamingrob-explicit-renaming"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#implicit-renamingrob-explicit-renaming">Implicit Renaming(ROB) 和 Explicit Renaming 的比较</a></h3>
<p>这两种方法主要区别：</p>
<ol>
<li>Implicit Renaming 在分发的时候，就会从寄存器堆读取数据，保存到保留站中；而 Explicit Renaming 是指令从 Issue Queue 到执行单元时候从寄存器堆读取数据</li>
<li>Implicit Renaming 的寄存器堆读取口较少，只需要考虑发射数乘以操作数个数，但所有类型的寄存器堆（整数、浮点）都需要读取；Explicit Renaming 的寄存器堆读取口更多，对于每个 Issue Queue，都需要操作数个数个读取口，但好处是可以屏蔽掉不需要访问的读取口，比如浮点 FMA 流水不需要读取整数寄存器堆。写和读是类似的：Implicit Renaming 中，寄存器堆的写入是从 ROB 上提交；而 Explicit Renaming 则是执行单元计算完后写入寄存器堆。</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#_2">其他优化的手段</a></h3>
<p>在第一和第二种设计中，当一条指令计算完成时，结果会直接通过 CDB 转发到其他指令的输入，这样可以提高运行效率。在第三种设计中，为了提高效率，也可以做类似的事情，但因为中间多了一级寄存器堆读取的流水线级，处理会更加复杂一点。比如，有一条 ALU 指令，可以确定它在一个周期后一定会得到计算结果，那么我就可以提前把依赖这条指令的其他指令 Dispatch 出去，然后在 ALU 之间连接一个 bypass 网络，这样就可以减少一些周期。</p>
<p>此外，为了提高吞吐率，一般计算单元都被设计为每个周期可以接受一条指令，在内部实现流水线执行，每个周期完成一条指令的计算。当然了，很多时候由于数据依赖问题，可能并不能达到每个周期每个计算单元都满载的情况。</p>
<p>有些时候，一些指令不方便后端实现，就会加一层转换，从指令转换为 uop，再由后端执行。这在 x86 处理器上很普遍，因为指令集太复杂了。像 AArch64 指令集，它在 Load/Store 的时候可以对地址进行计算，这种时候也是拆分为两条 uop 来执行。一些实用的指令需要三个操作数，比如 <code>D = A ? B : C</code>，在 Alpha 21264 中，这条指令会转换为两条 uop，这两条 uop 的操作数就只有两个，便于后端实现，否则在各个地方都允许三个操作数会导致一定的浪费。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2021/09/14/brief-into-ooo/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-09-02 00:00:00">2021年9月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="locale"><a class="toclink" href="../../software/2021/09/02/locale/">Locale 影响排序的特殊副作用</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/09/02/locale/#_1">背景</a></h3>
<p>最近在答疑的时候，发现同一条命令在不同系统上行为不同，一开始以为是 bash 版本问题，排查后最后发现是 locale 的问题。一个例子如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/09/02/locale/#__codelineno-0-1"></a>$<span class="w"> </span>cat<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/09/02/locale/#__codelineno-0-2"></a><span class="m">1</span><span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>*<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span>a<span class="w"> </span>b<span class="w"> </span>A<span class="w"> </span>B<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试<span class="w"> </span>α
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/09/02/locale/#__codelineno-0-3"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2021/09/02/locale/#__codelineno-0-4"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="m">1</span><span class="w"> </span>A<span class="w"> </span>B<span class="w"> </span><span class="se">\ </span>a<span class="w"> </span>b<span class="w"> </span>α<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2021/09/02/locale/#__codelineno-0-5"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;zh_CN.UTF-8&quot;</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2021/09/02/locale/#__codelineno-0-6"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span><span class="m">1</span><span class="w"> </span>测<span class="w"> </span>二<span class="w"> </span>试<span class="w"> </span>一<span class="w"> </span>a<span class="w"> </span>A<span class="w"> </span>b<span class="w"> </span>B<span class="w"> </span>α
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2021/09/02/locale/#__codelineno-0-7"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;en_US.UTF-8&quot;</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2021/09/02/locale/#__codelineno-0-8"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span><span class="m">1</span><span class="w"> </span>a<span class="w"> </span>A<span class="w"> </span>b<span class="w"> </span>B<span class="w"> </span>α<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试
</span></code></pre></div>
<p>注意 \ 1 a A 的顺序，在不同的 locale 下结果不同。</p>
<p>网上也有关于这个问题的讨论：</p>
<ol>
<li>https://unix.stackexchange.com/questions/75341/specify-the-sort-order-with-lc-collate-so-lowercase-is-before-uppercase</li>
<li>https://stackoverflow.com/questions/43448655/weird-behavior-of-bash-glob-regex-ranges</li>
</ol>

    <nav class="md-post__action">
      <a href="../../software/2021/09/02/locale/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-08-30 00:00:00">2021年8月30日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rhel-6-centos-7"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/">一次从 RHEL 6 到 CentOS 7 的更新</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#_1">背景</a></h3>
<p>有一台 RHEL 6 的服务器，各种软件版本太老了，用起来很难受，因此想升级。一开始想升级到 RHEL 7，但是发现必须要从 RedHat 下载 ISO，比较慢，所以我就先切换到 CentOS 6，再升级到 CentOS 7</p>
<h3 id="_2"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#_2">过程</a></h3>
<h4 id="rhel-6-pre-upgrade"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#rhel-6-pre-upgrade">RHEL 6 Pre upgrade</a></h4>
<p>一开始还是打算升级到 RHEL 7，所以跟随 RedHat 的文档去做 pre upgrade check，发现有一步要跑好久，网上搜了一下，发现这个步骤会扫描已有的各种程序，检查升级以后会不会出现不能运行的问题。但是如果有很多小文件，这一个过程就会进行很久，好在可以设置 exclusion 目录。最后检查出来的结果就是 GNOME 没法升级，建议卸载。</p>
<p>倒腾了一下升级工具，发现需要离线安装，比较麻烦，我就干脆换 CentOS 了。</p>
<h4 id="rhel-6-centos-6"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#rhel-6-centos-6">RHEL 6 -&gt; CentOS 6</a></h4>
<p>首先，把软件源都切换到 CentOS，这一步很简单，因为包都是一样的。只不过，因为 CentOS 6 在 centos-vault 里面，所以用起来比较麻烦。</p>
<h4 id="centos-6-centos-7"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#centos-6-centos-7">CentOS 6 -&gt; CentOS 7</a></h4>
<p>由于 CentOS 6 到 CentOS 7 升级涉及的改动比较多，官方提供了一个升级工具。一开始，我想直接升级到 CentOS 7 最新版本，但是报错，看到网上说可以升级到 CentOS 7 的早期版本，试了一下，确实没问题。</p>
<p>一通升级以后，重启，进入更新过程，发现很多包都安装失败了。重启以后，因为找不到 rootfs，挂在了 dracut 的 initramfs 里面。</p>
<h4 id="_3"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#_3">漫长的修复过程</a></h4>
<p>简单试了一下，发现 dracut 的 initramfs 里程序太少了，调试起来很痛苦。所以，我在 BMC 里通过 Virtual Media 挂了一个 Arch Linux 的 Live CD。因为通过 Web 访问延迟太高，我设了一个 root 密码，然后直接 ssh 到 live cd 系统中。</p>
<p>接着，我发现，可以正常找到盘和里面的各个分区，所以怀疑是之前 initramfs 里缺了什么东西，导致找不到硬盘。我 arch-chroot 到 root 分区里，然后手动更新各个包，特别麻烦：我首先升级了 yum repos 到最新的 CentOS 7，然后手动删掉/升级 el6 的各个软件包。最后好不容易把 kernel 终于升级好了，又重新生成 grub2 的配置，因为 CentOS 6 是 grub1。这时候，重启进入系统，发现可以找到 rootfs 了，但是经过 selinux relabel 以后，仍然会遇到 systemd-logind 起不来的问题，伴随着一系列的 audit 报警。</p>
<p>最后，使出了暴力的解决办法：在 cmdline 中设置 selinux=0 audit=0，然后终于进入系统了。再继续删掉一些 el6 的包，然后升级各种包，最后终于是恢复了正常。</p>

    <nav class="md-post__action">
      <a href="../../system/2021/08/30/rhel6-upgrade-centos7/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-08-06 00:00:00">2021年8月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../misc/2021/08/06/intel-intrinsics-guide/">轶事一则</a></h2>
<p>7.31 号周六的时候，发现 Intel Intrinsics Guide(https://software.intel.com/sites/landingpage/IntrinsicsGuide/) 出现错误，加载数据失败，于是在 Intel 的网站上提交了一个 bug。</p>
<p>8.2 号的时候，Intel 发邮件过来，说已经复现了问题，已经汇报给了后端团队。邮件原文：</p>
<div class="language-text highlight"><pre><span></span><code>Thank you for bringing this to our attention. We have verified and
encountered the same issue. Please know that we have escalated this
issue to our backend technical team.

We will get back to you as soon as we have an update. Have a nice day
ahead!
</code></pre></div>
<p>8.4 号的时候，Intel 再次发邮件过来，说后端团队正在处理这个问题，会尽快完成修复，请我耐心等待。这个时候我去网站上看，还是有问题。邮件原文：</p>
<div class="language-text highlight"><pre><span></span><code>Our backend team is still working on this issue. We are trying our level
best to get back to you with an update soon.

Have a nice day ahead!
</code></pre></div>
<p>8.6 号 19:27 的时候，Intel 又发了一次邮件，说后端团队依然在处理这个问题，并且正在进行一个永久性的修复（言下之意是现在提供了一个临时性的修复）。这个时候去网站上看，终于是修好了。邮件原文：</p>
<div class="language-text highlight"><pre><span></span><code>We have received an update from our backend team is that they are
working on this issue and, a more permanent fix is in the works.
Hopefully, it will resolve soon.

We appreciate your patience and understanding on this matter. Have a
nice day!
</code></pre></div>
<p>我回复了一下邮件，告诉 Intel 我这边看到已经是修复好的版本，紧接着又收到了一封邮件，告诉我可以从网站上下载离线版的 Intrinsics Guide：</p>
<div class="language-text highlight"><pre><span></span><code>Thank you for your prompt response. We are glad that your issue has been
resolved and we would like to thank you for your co operation.  Please
be informed that the offline version of the Intrinsic Guide is now
available for download from the site. The offline version of the guide
has the same content as the site, but is viewable offline by the user. A
link to the download is now added in the left column of the site:
https://software.intel.com/sites/landingpage/IntrinsicsGuide/

That said, we are closing this ticket and if you have further issues
please open another ticket and we will be happy to help you.

After case closure, you will receive a survey email. We appreciate it if
you can complete this survey regarding the support you received.  Your
feedback will help us improve our support.

For any concerns related to Intel® Developer Zone account, login or
website, please feel free to open a new ticket:
https://software.intel.com/en-us/support
</code></pre></div>
<p>这次 Intel Support 的反应挺快的，给个好评。就是希望 Intel 能够不挤牙膏，能拿出和 AMD 相当水平的 CPU。</p>

    <nav class="md-post__action">
      <a href="../../misc/2021/08/06/intel-intrinsics-guide/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-07-24 00:00:00">2021年7月24日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="homebridge-broadlink-rm-pro"><a class="toclink" href="../../software/2021/07/24/homebridge-rm-mini-3/">配置 homebridge-broadlink-rm-pro</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/07/24/homebridge-rm-mini-3/#_1">背景</a></h3>
<p>最近发现空调遥控器电池有点不足，有时候会自动关机，于是拿出以前买的 Broadlink RM mini 3 充当远程的空调遥控器使用。为了方便手机上配置，分别采用了官方的 App 智慧星和 homebridge 进行配置。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/07/24/homebridge-rm-mini-3/#_2">步骤</a></h3>
<p>首先用官方的智慧星配置好 Broadlink RM mini 3 的网络，然后配置 homebridge-broadlink-rm-pro。最早的插件作者不怎么更新了，这个版本是目前用的比较多的一个 fork。</p>
<p>安装好以后，在 Home 里面可以看到 Scan Code 的开关。打开以后，用遥控器在 Broadlink RM mini 3 附近按按键，就可以在 Homebridge 日志里看到 hex code 了。然后，就按照插件教程里的方法写配置，例子如下：</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-2"></a><span class="w">        </span><span class="nt">&quot;platform&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BroadlinkRM&quot;</span><span class="p">,</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-3"></a><span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Broadlink RM&quot;</span><span class="p">,</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-4"></a><span class="w">        </span><span class="nt">&quot;accessories&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-5"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-6"></a><span class="w">                </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Air Conditioner&quot;</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-7"></a><span class="w">                </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;air-conditioner&quot;</span><span class="p">,</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-8"></a><span class="w">                </span><span class="nt">&quot;noHumidity&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-9"></a><span class="w">                </span><span class="nt">&quot;minTemperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-10"></a><span class="w">                </span><span class="nt">&quot;maxTemperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-11"></a><span class="w">                </span><span class="nt">&quot;defaultCoolTemperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-12"></a><span class="w">                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-13"></a><span class="w">                        </span><span class="nt">&quot;off&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span><span class="p">,</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-14"></a><span class="w">                        </span><span class="nt">&quot;cool28&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-15"></a><span class="w">                                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-16"></a><span class="w">                        </span><span class="p">},</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-17"></a><span class="w">                        </span><span class="nt">&quot;cool27&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-18"></a><span class="w">                                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-19"></a><span class="w">                        </span><span class="p">},</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-20"></a><span class="w">                        </span><span class="nt">&quot;cool26&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-21"></a><span class="w">                                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2600...&quot;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-22"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-24"></a><span class="w">        </span><span class="p">}]</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就可以在手机上方便地控制空调温度了。测试了一下，可以用 Siri 说“设置空调为 XX 度”，也是完全可以工作的。</p>
<p>P.S. 小米的空气净化器现在可以用插件 https://github.com/torifat/xiaomi-mi-air-purifier#readme，之前博客里写的那一个已经不更新了。</p>

    <nav class="md-post__action">
      <a href="../../software/2021/07/24/homebridge-rm-mini-3/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-07-19 00:00:00">2021年7月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../misc/2021/07/19/sigs/">轶事一则</a></h2>
<p>7.17 号周六的时候，一位朋友 <a href="https://github.com/elenacliu">@elenacliu</a> 发现<a href="https://www.sigs.tsinghua.edu.cn/2020/0923/c118a21164/page.htm">深研院网站</a>的一个<a href="https://www.sigs.tsinghua.edu.cn/_upload/article/files/81/7c/a5c0421f4e418de32ef13701da95/448b40b3-87e2-4026-832e-28b113a01f4a.pdf">文档链接</a>，文档中标题写的是 2021，但是网页的标题显示的是 2006 年。于是我发邮件给深研院的招生办，抄送本部的研招办，提交了这个 issue。</p>
<p>7.19 号周一上午的时候，本部的研招办回复了一封邮件，没有理解我想表达的意思，可能以为我是要报考的学生，让我关注明年发布的文档。</p>
<p>7.19 号周一下午的时候，深研院招生办回复了邮件，说“谢谢你的反馈”，不过没有提到是否进行了修复。我晚上再查看页面的时候，发现<a href="https://www.sigs.tsinghua.edu.cn/_upload/article/files/81/7c/a5c0421f4e418de32ef13701da95/7917dd50-ad49-4664-a275-821fab3bfd87.pdf">新的文档链接</a>已经修复了问题。</p>

    <nav class="md-post__action">
      <a href="../../misc/2021/07/19/sigs/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-07-16 00:00:00">2021年7月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="nginx-post-internal-server-error"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/">Nginx 处理 POST 请求出现 Internal Server Error 排查一则</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/#_1">前言</a></h3>
<p>最近一个服务忽然出现问题，用户反馈，HTTP POST 一个小的 body 不会出错，POST 一个大的 body 就会 500 Internal Server Error。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/#_2">排查</a></h3>
<p>观察后端日志，发现没有出错的那一个请求。观察 Nginx 日志，发现最后一次日志是几个小时前。最后几条 Nginx 日志写的是 <code>a client request body is buffered to a temporary file</code>。</p>
<h3 id="_3"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/#_3">结论</a></h3>
<p>继续研究后，发现是硬盘满了。Nginx 在处理 POST body 的时候，如果 body 超过阈值，会写入到临时文件中：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-1"></a>Syntax: client_body_buffer_size size;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-2"></a>Default: client_body_buffer_size 8k|16k;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-3"></a>Context: http, server, location
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-4"></a>Sets buffer size for reading client request body. In case the request body is larger than the buffer, the whole body or only its part is written to a temporary file. By default, buffer size is equal to two memory pages. This is 8K on x86, other 32-bit platforms, and x86-64. It is usually 16K on other 64-bit platforms.
</span></code></pre></div>
<p>详见 https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size</p>
<p>这就可以解释为什么 Nginx 返回 500 而且没有转发到后端，也可以解释为什么 Nginx 没有输出新的错误日志。</p>

    <nav class="md-post__action">
      <a href="../../software/2021/07/16/nginx-post-internal-server-error/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-06-25 00:00:00">2021年6月25日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="k8s-rook-ceph-cephadm"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/">将 k8s rook ceph 集群迁移到 cephadm</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#_1">背景</a></h3>
<p>前段时间用 rook 搭建了一个 k8s 内部的 ceph 集群，但是使用过程中遇到了一些稳定性问题，所以想要用 cephadm 重建一个 ceph 集群。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#_2">重建过程</a></h3>
<p>重建的时候，我首先用 cephadm 搭建了一个 ceph 集群，再把原来的 MON 数据导入，再恢复各个 OSD。理论上，可能有更优雅的办法，但我还是慢慢通过比较复杂的办法解决了。</p>
<h4 id="cephadm-ceph"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#cephadm-ceph">cephadm 搭建 ceph 集群</a></h4>
<p>首先，配置 <a href="https://mirrors.tuna.tsinghua.edu.cn/help/ceph/">TUNA 源</a>，在各个节点上安装 <code>docker-ce</code> 和 <code>cephadm</code>。接着，在主节点上 bootstrap：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-0-1"></a>cephadm<span class="w"> </span>bootstrap<span class="w"> </span>--mon-ip<span class="w"> </span>HOST1_IP
</span></code></pre></div>
<p>此时，在主节点上会运行最基础的 ceph 集群，不过此时还没有任何数据。寻找 ceph 分区，会发现因为 FSID 不匹配而无法导入。所以，首先要恢复 MON 数据。</p>
<p>参考文档：<a href="https://docs.ceph.com/en/latest/cephadm/install/">cephadm install</a>。</p>
<h4 id="mon"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#mon">恢复 MON 数据</a></h4>
<p>首先，关掉 rook ceph 集群，找到留存下来的 MON 数据目录，默认路径是 <code>/var/lib/rook</code> 下的 <code>mon-[a-z]</code> 目录，找到最新的一个即可。我把目录下的路径覆盖到 cephadm 生成的 MON 目录下，然后跑起来，发现有几个问题：</p>
<ol>
<li>cephadm 生成的 /etc/ceph/ceph.client.admin.keyring 与 MON 中保存的 auth 信息不匹配，导致无法访问</li>
<li>FSID 不一致，而 cephadm 会将各个设置目录放到 <code>/var/lib/ceph/$FSID</code> 下</li>
</ol>
<p>第一个问题的解决办法就是临时用 MON 目录下的 keyring 进行认证，再创建一个新的 client.admin 认证。第二个问题的解决办法就是将遇到的各种 cephadm 生成的 FSID 替换为 MON 中的 FSID，包括目录名、各个目录下 unit.run 中的路径和 systemd unit 的名称。</p>
<p>进行一系列替换以后，原来的 MON 已经起来了，可以看到原来保留的各个 pool 和 cephfs 信息。</p>
<h4 id="_3"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#_3">扩展到多节点</a></h4>
<p>接下来，由于 MON 中保存的数据更新了，所以要重新生成 cephadm 的 SSH 密钥。将 SSH 密钥复制到各节点后，再用 cephadm 的 orch 功能部署到其他节点上。此时 FSID 都已经是 MON 中的 FSID，不需要替换。此时可以在 <code>ceph orch ps</code> 命令中看到在各个节点上运行的程序。接下来，还需要恢复各个 OSD。</p>
<h4 id="osd"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#osd">导入 OSD</a></h4>
<p>为了从 ceph 分区从导出 OSD 的配置文件，需要用 <code>ceph-volume</code> 工具。这个工具会生成一个 <code>/var/lib/ceph/osd-ID</code> 目录，在 cephadm 的概念里属于 legacy，因此我们首先要把路径 mount 到 shell 里面：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-1-1"></a>$<span class="w"> </span>cephadm<span class="w"> </span>shell<span class="w"> </span>--mount<span class="w"> </span>/var/lib/ceph:/var/lib/ceph
</span></code></pre></div>
<p>接着，生成 osd 目录配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-2-1"></a>$<span class="w"> </span>ceph-volume<span class="w"> </span>lvm<span class="w"> </span>activate<span class="w"> </span>--all<span class="w"> </span>--no-systemd
</span></code></pre></div>
<p>然后，可以看到创建了对应的 osd 路径，再用 cephadm 进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-3-1"></a>$<span class="w"> </span>cephadm<span class="w"> </span>adopt<span class="w"> </span>--style<span class="w"> </span>legacy<span class="w"> </span>--name<span class="w"> </span>osd.ID
</span></code></pre></div>
<p>这样就可以用 cephadm 管理了。</p>
<h3 id="k8s"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#k8s">配置 k8s</a></h3>
<p>配置好外部 ceph 集群后，还需要配置 k8s rook。</p>
<p>参考 <a href="https://rook.github.io/docs/rook/v1.8/ceph-cluster-crd.html#external-cluster">https://rook.github.io/docs/rook/v1.8/ceph-cluster-crd.html#external-cluster</a>，大概有这么几步：</p>
<ol>
<li>在 ceph 集群上运行 create-external-cluster-resources.sh，创建用户，并且导出 key</li>
<li>在 k8s 集群上应用第一步生成的环境变量，然后运行 import-external-cluster.sh</li>
<li>复制一份 cluster-external.yaml 然后应用</li>
<li>复制 storageclass.yaml，把里面的 namespace 改成 rook-ceph-external</li>
</ol>

    <nav class="md-post__action">
      <a href="../../devops/2021/06/25/ceph-k8s-to-external/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-06-23 00:00:00">2021年6月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/programming/" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="c-11-abi"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/">C++ 11 的 ABI 问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/#_1">背景</a></h3>
<p>有同学遇到这样的一个问题，代码中链接了一个第三方的动态库，在链接的时候出现了不一致的问题，比如有一个函数签名如下：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-0-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">foobar</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</span></code></pre></div>
<p>使用 GCC 11.1.0 编译上面的代码，可以发现它需要的符号是 <code>_Z6foobarNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE</code>，但是第三方库里面却是 <code>_Z6foobarSs</code>，因此找不到对应的符号，链接失败。</p>
<h3 id="_2"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/#_2">问题</a></h3>
<p>经过一番研究，发现 <code>Ss</code> 在 <a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html">Itanium ABI</a> 中表示的是缩写：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-1"></a>In addition, the following catalog of abbreviations of the form &quot;Sx&quot; are used:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-4"></a>   &lt;substitution&gt; ::= St # ::std::
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-5"></a>   &lt;substitution&gt; ::= Sa # ::std::allocator
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-6"></a>   &lt;substitution&gt; ::= Sb # ::std::basic_string
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-7"></a>   &lt;substitution&gt; ::= Ss # ::std::basic_string &lt; char,
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-8"></a>                         ::std::char_traits&lt;char&gt;,
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-9"></a>                         ::std::allocator&lt;char&gt; &gt;
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-10"></a>   &lt;substitution&gt; ::= Si # ::std::basic_istream&lt;char,  std::char_traits&lt;char&gt; &gt;
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-11"></a>   &lt;substitution&gt; ::= So # ::std::basic_ostream&lt;char,  std::char_traits&lt;char&gt; &gt;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-12"></a>   &lt;substitution&gt; ::= Sd # ::std::basic_iostream&lt;char, std::char_traits&lt;char&gt; &gt;
</span></code></pre></div>
<p>这看起来很正常，<code>_Z6foobarSs</code> 表示的是 <code>foobar(std::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;)</code>，但是 GCC 11.1.0 编译出来的上面的代码却没有用这个符号，而是 <code>foobar(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;)</code>。差别就在于 <code>__cxx11</code> 中。</p>
<p>经过一番搜索，找到了 GCC <a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html">关于这个问题的文档</a>和<a href="https://developers.redhat.com/blog/2015/02/05/gcc5-and-the-c11-abi">网上的文章</a>，找到了原因：从 GCC5 开始，为了兼容 C++11 标准的改变，做了这个变动。如果要恢复原来的行为，需要添加一个定义：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-1"></a>$<span class="w"> </span>g++<span class="w"> </span>-D_GLIBCXX_USE_CXX11_ABI<span class="o">=</span><span class="m">0</span><span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-2"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarSs
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-3"></a>$<span class="w"> </span>g++<span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-4"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-5"></a><span class="c1">## install g++-4.9 in ubuntu 16.04</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-6"></a>$<span class="w"> </span>g++-4.9<span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-7"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarSs
</span></code></pre></div>
<p>这样就可以正常链接到第三方的动态库了。</p>

    <nav class="md-post__action">
      <a href="../../programming/2021/06/23/cpp-11-abi-problem/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-05-06 00:00:00">2021年5月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../hardware/2021/05/06/disk/">硬盘相关的概念</a></h2>
<h3 id="ata"><a class="toclink" href="../../hardware/2021/05/06/disk/#ata">ATA</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Parallel_ATA">ATA</a> 定义了发送给硬盘的命令，<a href="https://people.freebsd.org/~imp/asiabsdcon2015/works/d2161r5-ATAATAPI_Command_Set_-_3.pdf">标准</a>定义了命令：</p>
<ul>
<li>ech IDENTIFY DEVICE: 获取设备信息</li>
<li>25h READ DMA EXT: 读取扇区</li>
<li>35h WRITE DMA EXT: 写入扇区</li>
</ul>
<p>ATA 同时也是接口，图片如下。ATA 前身是 IDE，现在 ATA 叫做 PATA。</p>
<p><img alt="PATA Pin" src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/ATA_Plug.svg/600px-ATA_Plug.svg.png" /></p>
<h3 id="ahci"><a class="toclink" href="../../hardware/2021/05/06/disk/#ahci">AHCI</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Advanced_Host_Controller_Interface">AHCI</a> 可以简单理解为 PCIe &lt;-&gt; SATA 的转换器。AHCI 暴露为一个 PCIe 设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2021/05/06/disk/#__codelineno-0-1"></a>$<span class="w"> </span>lspci<span class="w"> </span>-vv
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2021/05/06/disk/#__codelineno-0-2"></a><span class="m">00</span>:1f.2<span class="w"> </span>SATA<span class="w"> </span>controller:<span class="w"> </span>Intel<span class="w"> </span>Corporation<span class="w"> </span>C600/X79<span class="w"> </span>series<span class="w"> </span>chipset<span class="w"> </span><span class="m">6</span>-Port<span class="w"> </span>SATA<span class="w"> </span>AHCI<span class="w"> </span>Controller<span class="w"> </span><span class="o">(</span>rev<span class="w"> </span><span class="m">05</span><span class="o">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2021/05/06/disk/#__codelineno-0-3"></a><span class="w">        </span>Kernel<span class="w"> </span>modules:<span class="w"> </span>ahci
</span></code></pre></div>
<p>处理器通过 IO port/MMIO 访问 AHCI，然后 AHCI HBA 连接到 SATA 设备。</p>
<h3 id="sata"><a class="toclink" href="../../hardware/2021/05/06/disk/#sata">SATA</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Serial_ATA">SATA</a> 一般说的是接口。它一般分为两个部分，数据和电源。数据部分只有 7 个 pin，三个 GND 和两对差分线（A+A- B+B-），图片如下：</p>
<p><img alt="SATA Data" src="https://upload.wikimedia.org/wikipedia/commons/e/ef/SATA_Data_Cable.jpg" /></p>
<p>电源部分有 15 个 pin，有 GND 3.3V 5V 和 12V，图片如下：</p>
<p><img alt="SATA Power" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/SATA_power_cable.jpg/400px-SATA_power_cable.jpg" /></p>
<p>常见的 SATA 盘有 2.5 英寸（small form factor, SFF）和 3.5 英寸（large form factor，LFF）两种规格。</p>
<h3 id="m2"><a class="toclink" href="../../hardware/2021/05/06/disk/#m2">M.2</a></h3>
<p><a href="https://en.wikipedia.org/wiki/M.2">M.2</a> 又称 NGFF，有不同的 key 类型。常见的是 B 和 M：</p>
<ul>
<li>B key: 12-19 notched, PCIe x2, SATA</li>
<li>M key: 59-66 notched, PCIe x4, SATA</li>
</ul>
<p>都有部分引脚的位置是空的：</p>
<p><img alt="M.2" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ed/M2_Edge_Connector_Keying.svg/620px-M2_Edge_Connector_Keying.svg.png" /></p>
<p>在<a href="https://pinoutguide.com/HD/M.2_NGFF_connector_pinout.shtml">这里</a>可以看到两种 key 的 pinout。</p>
<ul>
<li>B key: SATA pin B(41,43) A(47,49), PCIe x2 pin R1(29,31) T1(35,37) R0(41,43) T0(47,49), USB 3.0 pin TX(29, 31) RX(35,37)</li>
<li>M key: SATA 同上，PCIe x4 pin R3(5,7) T3(11,13) R2(17,19) T2(23,25) Lane 0,1 同上</li>
</ul>
<p>可以看到，SATA pin 和 PCIe 的两个 lane 在 B 和 M key 中是一样的，物理上也是可以兼容的。</p>
<p>因为支持 SATA 和 PCIe，就有下面三种可能的使用方式：</p>
<ul>
<li>PCIe -- AHCI HBA(Board) -- SATA(M.2) -- Disk: 传统方式，只不过物理接口从 SATA 变成了 M.2</li>
<li>PCIe -- PCIe Device(M.2) -- Disk(AHCI)：硬盘实现了 AHCI 的接口，通过 PCIe 连接到 CPU</li>
<li>PCIe -- PCIe Device(M.2) -- Disk(NVMe)：硬盘实现了 NVMe 的接口，通过 PCIe 连接到 CPU</li>
</ul>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/SATA_Express_interface.svg/620px-SATA_Express_interface.svg.png" /></p>
<h3 id="sata-express"><a class="toclink" href="../../hardware/2021/05/06/disk/#sata-express">SATA express</a></h3>
<p><a href="https://en.wikipedia.org/wiki/SATA_Express">SATA express</a> 在 SATA 3.2 引入，它用的很少，被 U.2 取代。提供了 PCIe x2 或者 SATA x2。</p>
<h3 id="u2"><a class="toclink" href="../../hardware/2021/05/06/disk/#u2">U.2</a></h3>
<p><a href="https://en.wikipedia.org/wiki/U.2">U.2</a> 也叫 <a href="https://members.snia.org/document/dl/26489">SFF-8639</a>。它和 <a href="https://en.wikipedia.org/wiki/SATA_Express">SATA express</a> 接口一样，但提供了 PCIe x4 或者 SATA x2。详见 <a href="https://pinoutguide.com/HD/U.2_SATA_connector_pinout.shtml">pinout</a>。</p>
<p><img alt="U.2" src="https://www.delock.com/infothek/U.2-NVMe/images/teaser.jpg" /></p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/05/06/disk/#_2">速度比较</a></h3>
<p>不同的协议的速度如下：</p>
<ul>
<li>SATA 3.0: 6Gb/s(8b/10b, 4Gb/s uncoded)</li>
<li>SAS-1: 3Gb/s</li>
<li>SAS-2: 6Gb/s</li>
<li>SAS-3: 12Gb/s</li>
<li>SAS-4: 22.5Gb/s</li>
<li>PCIe 3.0 x4: 32Gb/s(8GT/s, 128b/130b, 31.5 Gb/s uncoded)</li>
</ul>
<p>更完整的可以看<a href="https://en.wikipedia.org/wiki/List_of_interface_bit_rates">List of interface bit rates</a>。</p>
<p><a href="https://ark.intel.com/content/www/us/en/ark/products/192574/intel-ssd-dc-p4618-series-6-4tb-1-2-height-pcie-3-1-x8-3d2-tlc.html">Intel SSD DC P4618 Series</a> 读写速度可以达到 40~50 Gb/s，它采用的是 PCIe 3.0 x8(64Gb/s) NVMe。</p>
<p><a href="https://ark.intel.com/content/www/us/en/ark/products/125024/intel-ssd-545s-series-1-024tb-2-5in-sata-6gb-s-3d2-tlc.html">Intel SSD 545s Series</a> 读写速度约 4Gb/s，采用的是 SATA 3.0 6Gb/s。</p>
<p><a href="https://www.samsung.com/semiconductor/minisite/ssd/product/consumer/970evo/">SAMSUNG 970 EVO</a> 读写速度 20~30 Gb/s，它采用的是 PCIe 3.0 x4(32Gb/s) NVMe。</p>
<h3 id="sas"><a class="toclink" href="../../hardware/2021/05/06/disk/#sas">SAS</a></h3>
<p>SAS 涉及的物理接口比较多，下面举一个具体的例子：DELL SCv2000</p>
<p>文档：https://dl.dell.com/topicspdf/storage-sc2000_owners-manual_en-us.pdf</p>
<p>它的背面：</p>
<p><img alt="" src="/images/scv2000.png" /></p>
<p>它有四个前端接口 Mini-SAS High Density (HD)，即 SFF-8644；两个后端接口 Mini-SAS，即 SFF-8088。</p>
<p>RAID 卡例子：MegaRAID SAS 9361-8i</p>
<p>文档：https://docs.broadcom.com/doc/12351995</p>
<p>它的接口有：</p>
<ol>
<li>两个 mini-SAS SFF-8643(Mini Multilane 4/8X 12 Gb/s Unshielded Connector (HD12un)) 内部连接器，连接到硬盘</li>
<li>PCIe 3.0 8x 连接主板</li>
</ol>
<p>SAS 标准：</p>
<ul>
<li>INCITS 417 Serial Attached SCSI 1.1 (SAS-1.1)</li>
<li>INCITS 457 Serial Attached SCSI 2 (SAS-2)</li>
<li>INCITS 478 Serial Attached SCSI 2.1 (SAS-2.1)</li>
<li>INCITS 519 Serial Attached SCSI - 3 (SAS-3)</li>
<li>INCITS 534 Serial Attached SCSI - 4 (SAS-4)</li>
</ul>
<p>可以从 https://www.t10.org/drafts.htm#SCSI3_SAS 免费下载尚未成为标准的 SAS-4.1 Working Draft。</p>
<h3 id="sas_1"><a class="toclink" href="../../hardware/2021/05/06/disk/#sas_1">SAS 相关的物理接口</a></h3>
<p>查找 SFF 标准：https://www.snia.org/technology-communities/sff/specifications</p>
<p>中文介绍：https://www.163.com/dy/article/H8TGPEUA0532B75P.html</p>
<h4 id="sff-8087"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8087">SFF-8087</a></h4>
<p>Mini Multilane 4X Unshielded Connector Shell and Plug</p>
<p><img alt="" src="/images/sff8087.png" /></p>
<p>介绍：https://cs-electronics.com/sff-8087/</p>
<p>Mini SAS 4i 连接器就是 36 pin 的 SFF-8087，支持四路 SAS。i 表示用于 internal 连接。对应的 external 接口是 SFF-8088。</p>
<p>标准下载地址：https://members.snia.org/document/dl/25823</p>
<p>它的引脚定义可以在 <a href="https://members.snia.org/document/dl/27380">SFF-9402</a> 看到，它的引脚分为 A 面和 B 面，每面有 18 个 PIN，用途如下：</p>
<ul>
<li>A2(Rx0+), A3(Rx0-), B2(Tx0+), B3(Tx0-)：第一组差分对</li>
<li>A4(Rx1+), A5(Rx1-), B4(Tx1+), B5(Tx1-)：第二组差分对</li>
<li>A13(Rx2+), A14(Rx2-), B13(Tx2+), B14(Tx2-)：第三组差分对</li>
<li>A16(Rx3+), A17(Rx3-), B16(Tx3+), B17(Tx3-)：第四组差分对</li>
<li>B8(Sclock), B9(Sload), A10(SDataOut), A11(SDataIn)：SGPIO 协议</li>
<li>B8(2W-CLK), B9(2W-DATA)：用于 SES 的 I2C 协议</li>
</ul>
<p>这四组差分对对应四路 SAS 或者 SATA。SGPIO 协议的标准是 <a href="https://members.snia.org/document/dl/25923">SFF-8485</a>，主要用途是控制硬盘状态灯，以及判断盘是否插入。</p>
<p>相关标准：</p>
<ul>
<li>SFF-8086: Mini Multilane 10 Gb/s 4X Common Elements Connector</li>
</ul>
<h4 id="sff-8088"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8088">SFF-8088</a></h4>
<p>Mini Multilane 4X Shielded Connector Shell and Plug</p>
<p><img alt="" src="/images/sff8088.png" /></p>
<p>标准下载地址：https://members.snia.org/document/dl/25824</p>
<p>Mini SAS 4x 连接器就是 26 pin 的 SFF-8088，支持四路 SAS。用于 external 连接。对应的 internal 接口是 SFF-8087。</p>
<h4 id="sff-8482sff-8678sff-8680sff-8681"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8482sff-8678sff-8680sff-8681">SFF-8482/SFF-8678/SFF-8680/SFF-8681</a></h4>
<p>SFF-8482: Serial Attachment 2X Unshielded Connector (EIA-966)</p>
<p><img alt="" src="/images/sff8482.png" /></p>
<p>介绍：https://cs-electronics.com/sff-8482/</p>
<p>支持两路 SAS，29 个引脚。和 SATA 的接口大小一样，目的是为了可以兼容 SATA 和 SAS 盘，比较常见。</p>
<p>标准下载地址：https://members.snia.org/document/dl/25920</p>
<p>不同速率的版本：</p>
<ul>
<li>SFF-8678: Serial Attachment 2X 6Gb/s Unshielded Connector</li>
<li>SFF-8680: Serial Attachment 2X 12Gb/s Unshielded Connector, 支持 SAS-2.x 和 SAS-3</li>
<li>SFF-8681: Serial Attachment 2X 24Gb/s Unshielded Connector, 支持 SAS-4</li>
</ul>
<h4 id="sff-86148644"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-86148644">SFF-8614/8644</a></h4>
<p>SFF-8614: Mini Multilane 4/8X Shielded Cage/Connector (HDsh)</p>
<p><img alt="" src="/images/sff8614.png" /></p>
<p>标准下载地址：https://members.snia.org/document/dl/25939</p>
<p>对应的 internal 版本是 SFF-8643: Mini Multilane 4/8X 12 Gb/s Unshielded Connector</p>
<p>名称：External Mini-SAS HD(High Density)</p>
<p>升级版本：</p>
<p>SFF-8644: Mini Multilane 4/8X 12 Gb/s Shielded Cage/Connector (HD12sh)</p>
<p>标准下载地址：https://members.snia.org/document/dl/25952</p>
<p>支持 SAS-3 和 PCIe 3.0</p>
<h4 id="sff-8639"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8639">SFF-8639</a></h4>
<p>Multifunction 6X Unshielded Connector</p>
<p>又称 U.2</p>
<p><img alt="" src="/images/sff8639.png" /></p>
<p>标准下载地址：https://members.snia.org/document/dl/26489</p>
<p>用途：</p>
<ul>
<li>Single port SATA (as defined by Serial ATA revision 3.1)</li>
<li>Two port SATA Express (as defined in Serial ATA Technical Proposal #TPR_C109, currently under development)</li>
<li>Dual port SAS (as defined by SFF-8482)</li>
<li>MultiLink SAS (as defined by SFF-8630)</li>
<li>Up to 4 lanes of PCIe (as defined in this specification)</li>
</ul>
<h4 id="sff-8611"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8611">SFF-8611</a></h4>
<p>MiniLink 4/8X I/O Cable Assemblies</p>
<p>又称 OCuLink 1.0</p>
<p><img alt="" src="/images/sff8611.png" /></p>
<p>标准下载地址：https://members.snia.org/document/dl/27937</p>
<p>用途：</p>
<ul>
<li>PCIe</li>
<li>SAS</li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2021/05/06/disk/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-04-15 00:00:00">2021年4月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="esxi-perccli-raid"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/">在 ESXi 中用 PERCCli 换 RAID 中的盘</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/#_1">背景</a></h3>
<p>最近有一台机器的盘出现了报警，需要换掉，然后重建 RAID5 阵列。iDRAC 出现报错：</p>
<ol>
<li>Disk 2 in Backplane 1 of Integrated RAID Controller 1 is not functioning correctly.</li>
<li>Virtual Disk 1 on Integrated RAID Controller 1 has become degraded.</li>
<li>Error occurred on Disk2 in Backplane 1 of Integrated RAID Controller 1 : (Error 2)</li>
</ol>
<h3 id="perccli"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/#perccli">安装 PERCCli</a></h3>
<p>首先，因为系统是 VMware ESXi 6.7，所以在<a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=5v7xx">DELL 官网</a>下载对应的文件。按照里面的 README 安装 vib：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-0-1"></a>esxcli<span class="w"> </span>software<span class="w"> </span>vib<span class="w"> </span>install<span class="w"> </span>-v<span class="w"> </span>/vmware-perccli-007.1420.vib
</span></code></pre></div>
<p>如果要升级系统，需要先卸载 vib：<code>esxcli software vib remove -n vmware-perccli</code>，因为升级的时候会发现缺少新版系统的 perccli，建议先卸载，升级后再安装新的。</p>
<p>需要注意的是，如果复制上去 Linux 版本的 PERCCli，虽然也可以运行，但是找不到控制器。安装好以后，就可以运行 <code>/opt/lsi/perccli/perccli</code> 。接着，运行 <code>perccli show all</code>，可以看到类似下面的信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>show<span class="w"> </span>all
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-2"></a>--------------------------------------------------------------------------------
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-3"></a>EID:Slt<span class="w"> </span>DID<span class="w"> </span>State<span class="w">  </span>DG<span class="w">     </span>Size<span class="w"> </span>Intf<span class="w"> </span>Med<span class="w"> </span>SED<span class="w"> </span>PI<span class="w"> </span>SeSz<span class="w"> </span>Model<span class="w">               </span>Sp<span class="w"> </span>Type
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-4"></a>--------------------------------------------------------------------------------
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-5"></a><span class="m">32</span>:2<span class="w">      </span><span class="m">2</span><span class="w"> </span>Failed<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>SATA<span class="w"> </span>HDD<span class="w"> </span>N<span class="w">   </span>N<span class="w">  </span>512B<span class="w"> </span>ST4000NM0033-9ZM170<span class="w"> </span>U<span class="w">  </span>-
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-6"></a><span class="m">32</span>:4<span class="w">      </span><span class="m">4</span><span class="w"> </span>UGood<span class="w">   </span>F<span class="w"> </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>SATA<span class="w"> </span>HDD<span class="w"> </span>N<span class="w">   </span>N<span class="w">  </span>512B<span class="w"> </span>ST4000NM0033-9ZM170<span class="w"> </span>U<span class="w">  </span>-
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-7"></a>--------------------------------------------------------------------------------
</span></code></pre></div>
<p>其中 E32S2 是 Failed 的盘，属于 Disk Group 1；E32S4 是新插入的盘，准备替换掉 E32S2，目前不属于任何的 Disk Group。查看一下 Disk Group：<code>perccli /c0/dall show</code></p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/dall<span class="w"> </span>show
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-2"></a>-----------------------------------------------------------------------------
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-3"></a>DG<span class="w"> </span>Arr<span class="w"> </span>Row<span class="w"> </span>EID:Slot<span class="w"> </span>DID<span class="w"> </span>Type<span class="w">  </span>State<span class="w"> </span>BT<span class="w">       </span>Size<span class="w"> </span>PDC<span class="w">  </span>PI<span class="w"> </span>SED<span class="w"> </span>DS3<span class="w">  </span>FSpace<span class="w"> </span>TR
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-4"></a>-----------------------------------------------------------------------------
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-5"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">   </span>N<span class="w">    </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-6"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">   </span>N<span class="w">    </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-7"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">32</span>:1<span class="w">     </span><span class="m">1</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">   </span>N<span class="w">    </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-8"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">32</span>:2<span class="w">     </span><span class="m">2</span><span class="w">   </span>DRIVE<span class="w"> </span>Failed<span class="w"> </span>N<span class="w">    </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-9"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">32</span>:3<span class="w">     </span><span class="m">3</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">   </span>N<span class="w">    </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span></code></pre></div>
<p>可以看到 DG1 处于 Degraded 状态，然后 E32S4 处于 Failed 状态。参考了一下 <a href="https://dl.dell.com/topicspdf/cli_guide_en-us.pdf">PERCCli 文档</a>，它告诉我们要这么做：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-1"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span><span class="nb">set</span><span class="w"> </span>offline
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-2"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span><span class="nb">set</span><span class="w"> </span>missing
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-3"></a>perccli<span class="w"> </span>/cx<span class="w"> </span>/dall<span class="w"> </span>show
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-4"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span>insert<span class="w"> </span><span class="nv">dg</span><span class="o">=</span>a<span class="w"> </span><span class="nv">array</span><span class="o">=</span>b<span class="w"> </span><span class="nv">row</span><span class="o">=</span>c
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-5"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span>start<span class="w"> </span>rebuild
</span></code></pre></div>
<p>具体到我们这个情景，就是把 E32S2 设为 offline，然后用 E32S4 来替换它：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-1"></a>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span><span class="nb">set</span><span class="w"> </span>offline
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-2"></a>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span><span class="nb">set</span><span class="w"> </span>missing
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-3"></a>perccli<span class="w"> </span>/cx<span class="w"> </span>/dall<span class="w"> </span>show
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-4"></a>perccli<span class="w"> </span>/cx/e32/s4<span class="w"> </span>insert<span class="w"> </span><span class="nv">dg</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">array</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">row</span><span class="o">=</span><span class="m">2</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-5"></a>perccli<span class="w"> </span>/cx/e32/s4<span class="w"> </span>start<span class="w"> </span>rebuild
</span></code></pre></div>
<p>完成以后的状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-1"></a>TOPOLOGY<span class="w"> </span>:
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-2"></a><span class="o">========</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-4"></a>---------------------------------------------------------------------------
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-5"></a>DG<span class="w"> </span>Arr<span class="w"> </span>Row<span class="w"> </span>EID:Slot<span class="w"> </span>DID<span class="w"> </span>Type<span class="w">  </span>State<span class="w"> </span>BT<span class="w">     </span>Size<span class="w"> </span>PDC<span class="w">  </span>PI<span class="w"> </span>SED<span class="w"> </span>DS3<span class="w">  </span>FSpace<span class="w"> </span>TR
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-6"></a>---------------------------------------------------------------------------
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-7"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-8"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-9"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">32</span>:1<span class="w">     </span><span class="m">1</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-10"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">32</span>:4<span class="w">     </span><span class="m">4</span><span class="w">   </span>DRIVE<span class="w"> </span>Rbld<span class="w">  </span>Y<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-11"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">32</span>:3<span class="w">     </span><span class="m">3</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-12"></a>---------------------------------------------------------------------------
</span></code></pre></div>
<p>可以看到 E32S4 替换了原来 E32S2 的位置，并且开始重建。查看重建进度：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/32/s4<span class="w"> </span>show<span class="w"> </span>rebuild
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-2"></a>-----------------------------------------------------
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-3"></a>Drive-ID<span class="w">   </span>Progress%<span class="w"> </span>Status<span class="w">      </span>Estimated<span class="w"> </span>Time<span class="w"> </span>Left
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-4"></a>-----------------------------------------------------
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-5"></a>/c0/e32/s4<span class="w">         </span><span class="m">3</span><span class="w"> </span>In<span class="w"> </span>progress<span class="w"> </span>-
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-6"></a>-----------------------------------------------------
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-7"></a>$<span class="w"> </span>perccli<span class="w"> </span>show<span class="w"> </span>all
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-8"></a>Need<span class="w"> </span>Attention<span class="w"> </span>:
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-9"></a><span class="o">==============</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-10"></a>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-11"></a>Controller<span class="w"> </span><span class="m">0</span><span class="w"> </span>:
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-12"></a><span class="o">============</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-14"></a>-------------------------------------------------------------------------------
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-15"></a>EID:Slt<span class="w"> </span>DID<span class="w"> </span>State<span class="w"> </span>DG<span class="w">     </span>Size<span class="w"> </span>Intf<span class="w"> </span>Med<span class="w"> </span>SED<span class="w"> </span>PI<span class="w"> </span>SeSz<span class="w"> </span>Model<span class="w">               </span>Sp<span class="w"> </span>Type
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-16"></a>-------------------------------------------------------------------------------
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-17"></a><span class="m">32</span>:4<span class="w">      </span><span class="m">4</span><span class="w"> </span>Rbld<span class="w">   </span><span class="m">1</span><span class="w"> </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>SATA<span class="w"> </span>HDD<span class="w"> </span>N<span class="w">   </span>N<span class="w">  </span>512B<span class="w"> </span>ST4000NM0033-9ZM170<span class="w"> </span>U<span class="w">  </span>-
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-18"></a>-------------------------------------------------------------------------------
</span></code></pre></div>
<p>然后，查看一下出错的盘：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span>show<span class="w"> </span>all
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-2"></a>Drive<span class="w"> </span>/c0/e32/s2<span class="w"> </span>State<span class="w"> </span>:
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-3"></a><span class="o">======================</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-4"></a>Shield<span class="w"> </span><span class="nv">Counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-5"></a>Media<span class="w"> </span>Error<span class="w"> </span><span class="nv">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-6"></a>Other<span class="w"> </span>Error<span class="w"> </span><span class="nv">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-7"></a>Drive<span class="w"> </span><span class="nv">Temperature</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>36C<span class="w"> </span><span class="o">(</span><span class="m">96</span>.80<span class="w"> </span>F<span class="o">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-8"></a>Predictive<span class="w"> </span>Failure<span class="w"> </span><span class="nv">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-9"></a>S.M.A.R.T<span class="w"> </span>alert<span class="w"> </span>flagged<span class="w"> </span>by<span class="w"> </span><span class="nv">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>No
</span></code></pre></div>
<p>果然有错误，但是也看不到更多信息了。</p>
<p>坏块统计：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0<span class="w"> </span>show<span class="w"> </span>badblocks
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-2"></a>Detailed<span class="w"> </span>Status<span class="w"> </span>:
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-3"></a><span class="o">===============</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-5"></a>-------------------------------------------------------------
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-6"></a>Ctrl<span class="w"> </span>Status<span class="w"> </span>Ctrl_Prop<span class="w">       </span>Value<span class="w"> </span>ErrMsg<span class="w">               </span>ErrCd
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-7"></a>-------------------------------------------------------------
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-8"></a><span class="w">   </span><span class="m">0</span><span class="w"> </span>Failed<span class="w"> </span>Bad<span class="w"> </span>Block<span class="w"> </span>Count<span class="w"> </span>-<span class="w">     </span>BadBlockCount<span class="w"> </span>failed<span class="w">     </span><span class="m">2</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-9"></a>-------------------------------------------------------------
</span></code></pre></div>
<p>经过检查以后，发现 E32S2 盘的 SMART 并没有报告什么问题，所以也没有把盘取走，而是作为 hot spare 当备用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span>add<span class="w"> </span>hotsparedrive<span class="w"> </span><span class="nv">DG</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-2"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/d1<span class="w"> </span>show
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-3"></a>TOPOLOGY<span class="w"> </span>:
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-4"></a><span class="o">========</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-6"></a>---------------------------------------------------------------------------
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-7"></a>DG<span class="w"> </span>Arr<span class="w"> </span>Row<span class="w"> </span>EID:Slot<span class="w"> </span>DID<span class="w"> </span>Type<span class="w">  </span>State<span class="w"> </span>BT<span class="w">     </span>Size<span class="w"> </span>PDC<span class="w">  </span>PI<span class="w"> </span>SED<span class="w"> </span>DS3<span class="w">  </span>FSpace<span class="w"> </span>TR
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-8"></a>---------------------------------------------------------------------------
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-9"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-10"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-11"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">32</span>:1<span class="w">     </span><span class="m">1</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-12"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">32</span>:4<span class="w">     </span><span class="m">4</span><span class="w">   </span>DRIVE<span class="w"> </span>Rbld<span class="w">  </span>Y<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-13"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">32</span>:3<span class="w">     </span><span class="m">3</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-14"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span><span class="m">32</span>:2<span class="w">     </span><span class="m">2</span><span class="w">   </span>DRIVE<span class="w"> </span>DHS<span class="w">   </span>-<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>-<span class="w">    </span>-<span class="w">  </span>-<span class="w">   </span>-<span class="w">    </span>-<span class="w">      </span>N
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-15"></a>---------------------------------------------------------------------------
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-16"></a>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-17"></a><span class="nv">DG</span><span class="o">=</span>Disk<span class="w"> </span>Group<span class="w"> </span>Index<span class="p">|</span><span class="nv">Arr</span><span class="o">=</span>Array<span class="w"> </span>Index<span class="p">|</span><span class="nv">Row</span><span class="o">=</span>Row<span class="w"> </span>Index<span class="p">|</span><span class="nv">EID</span><span class="o">=</span>Enclosure<span class="w"> </span>Device<span class="w"> </span>ID
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-18"></a><span class="nv">DID</span><span class="o">=</span>Device<span class="w"> </span>ID<span class="p">|</span><span class="nv">Type</span><span class="o">=</span>Drive<span class="w"> </span>Type<span class="p">|</span><span class="nv">Onln</span><span class="o">=</span>Online<span class="p">|</span><span class="nv">Rbld</span><span class="o">=</span>Rebuild<span class="p">|</span><span class="nv">Optl</span><span class="o">=</span>Optimal<span class="p">|</span><span class="nv">Dgrd</span><span class="o">=</span>Degraded
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-19"></a><span class="nv">Pdgd</span><span class="o">=</span>Partially<span class="w"> </span>degraded<span class="p">|</span><span class="nv">Offln</span><span class="o">=</span>Offline<span class="p">|</span><span class="nv">BT</span><span class="o">=</span>Background<span class="w"> </span>Task<span class="w"> </span>Active
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-20"></a><span class="nv">PDC</span><span class="o">=</span>PD<span class="w"> </span>Cache<span class="p">|</span><span class="nv">PI</span><span class="o">=</span>Protection<span class="w"> </span>Info<span class="p">|</span><span class="nv">SED</span><span class="o">=</span>Self<span class="w"> </span>Encrypting<span class="w"> </span>Drive<span class="p">|</span><span class="nv">Frgn</span><span class="o">=</span>Foreign
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-21"></a><span class="nv">DS3</span><span class="o">=</span>Dimmer<span class="w"> </span>Switch<span class="w"> </span><span class="m">3</span><span class="p">|</span><span class="nv">dflt</span><span class="o">=</span>Default<span class="p">|</span><span class="nv">Msng</span><span class="o">=</span>Missing<span class="p">|</span><span class="nv">FSpace</span><span class="o">=</span>Free<span class="w"> </span>Space<span class="w"> </span>Present
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-22"></a><span class="nv">TR</span><span class="o">=</span>Transport<span class="w"> </span>Ready
</span></code></pre></div>
<p>这样就可以做后备盘，当别的盘坏的时候，作为备用。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/#_2">相关软件下载</a></h3>
<p>可以在<a href="https://www.broadcom.com/products/storage/raid-controllers/megaraid-sas-9361-8i#downloads">这里</a>寻找 StorCLI 版本。</p>
<p>StorCLI：</p>
<ul>
<li>007.1613.0000.0000 Oct 29, 2020 <a href="https://docs.broadcom.com/docs/007.1613.0000.0000_Unified_StorCLI.zip">007.1613.0000.0000_Unified_StorCLI.zip</a></li>
<li>007.1506.0000.0000 Aug 11, 2020 <a href="https://downloadcenter.intel.com/download/30286/StorCLI-Standalone-Utility">StorCLI_MR7.15.zip</a> </li>
<li>1.15.12 Apr 23, 2015 <a href="https://docs.broadcom.com/docs/12354905">MR_SAS_StorCLI_6-7-1-15-12-SCGCQ00852539.zip</a></li>
<li>1.15.05 Jan 22, 2015 <a href="https://docs.broadcom.com/docs/12354804">1-15-05_StorCLI.zip</a></li>
</ul>
<p>MegaCLI:</p>
<ul>
<li>8.07.07 Dec 19, 2012 <a href="https://docs.broadcom.com/docs/12351585">8-07-07_MegaCLI.zip</a></li>
</ul>
<p>PercCLI:</p>
<ul>
<li>007.1420.0000.0000 Dec 10, 2020 <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=n65f1">PERCCLI_N65F1_7.1420.00_A10_Linux.tar.gz</a> <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=5v7xx">PERCCLI_5V7XX_7.1420.0_A10_VMware.tar.gz</a></li>
<li>007.1327.0000.0000 July 27, 2020 <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=d6ywp">PERCCLI_D6YWP_7.1327.00_A09_Linux.tar.gz</a></li>
<li>007.0127.0000.0000 July 13, 2017 <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=f48c2">perccli_7.1-007.0127_linux.tar.gz</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../devops/2021/04/15/vmware-esxi-perccli/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-04-02 00:00:00">2021年4月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="fluentd-k8s"><a class="toclink" href="../../devops/2021/04/02/k8s-fluentd-log-collect/">用 fluentd 收集 k8s 中容器的日志</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#_1">背景</a></h3>
<p>在维护一个 k8s 集群的时候，一个很常见的需求就是把日志持久化存下来，一方面是方便日后回溯，一方面也是聚合 replicate 出来的同一个服务的日志。</p>
<p>在我目前的需求下，只需要把日志持久下来，还不需要做额外的分析。所以我并没有部署类似 ElasticSearch 的服务来对日志进行索引。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#_2">实现</a></h3>
<p>实现主要参考官方的仓库：https://github.com/fluent/fluentd-kubernetes-daemonset。它把一些常用的插件打包到 docker 镜像中，然后提供了一些默认的设置，比如获取 k8s 日志和 pod 日志等等。为了达到我的需求，我希望：</p>
<ol>
<li>每个结点上有一个 fluentd 收集日志，forward 到单独的 log server 上的 fluentd</li>
<li>log server 上的 fluentd 把收到的日志保存到文件</li>
</ol>
<p>由于 log server 不由 k8s 管理，所以按照<a href="https://docs.fluentd.org/installation/install-by-deb">官网</a>的方式手动安装：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-0-1"></a>$<span class="w"> </span>curl<span class="w"> </span>-L<span class="w"> </span>https://toolbelt.treasuredata.com/sh/install-debian-buster-td-agent4.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
</span></code></pre></div>
<p>然后，编辑配置 <code>/etc/td-agent/td-agent.conf</code>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-1"></a>&lt;source&gt;
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-2"></a><span class="w">  </span>@type<span class="w"> </span>forward
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-3"></a><span class="w">  </span>@id<span class="w"> </span>input_forward
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-4"></a><span class="w">  </span><span class="nb">bind</span><span class="w"> </span>x.x.x.x
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-5"></a>&lt;/source&gt;
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-7"></a>&lt;match<span class="w"> </span>**&gt;
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-8"></a><span class="w">  </span>@type<span class="w"> </span>file
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-9"></a><span class="w">  </span>path<span class="w"> </span>/var/log/fluentd/k8s
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-10"></a><span class="w">  </span>compress<span class="w"> </span>gzip
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-11"></a><span class="w">  </span>&lt;buffer&gt;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-12"></a><span class="w">    </span>timekey<span class="w"> </span>1d
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-13"></a><span class="w">    </span>timekey_use_utc<span class="w"> </span><span class="nb">true</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-14"></a><span class="w">    </span>timekey_wait<span class="w"> </span>10m
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-15"></a><span class="w">  </span>&lt;/buffer&gt;
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-16"></a>&lt;/match&gt;
</span></code></pre></div>
<p>分别设置输入：监听 fluentd forward 协议；输出：设置输出文件，和 buffer 配置。如有需要，可以加鉴权。</p>
<p>接着，按照 https://github.com/fluent/fluentd-kubernetes-daemonset/blob/master/fluentd-daemonset-forward.yaml，我做了一些修改，得到了下面的配置：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-1"></a><span class="nn">---</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-8"></a><span class="nn">---</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-9"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-10"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-11"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-13"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-14"></a><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-15"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-16"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-17"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-18"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pods</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">namespaces</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-20"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-22"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">list</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">watch</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-25"></a><span class="nn">---</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-26"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-27"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-28"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-29"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-30"></a><span class="nt">roleRef</span><span class="p">:</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-31"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-32"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-33"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-34"></a><span class="nt">subjects</span><span class="p">:</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-35"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-36"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-37"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-38"></a>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-39"></a><span class="nn">---</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-40"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-41"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-42"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-43"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-44"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-45"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-46"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-logging</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-47"></a><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-48"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-49"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-50"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-51"></a><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-logging</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-52"></a><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-53"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-54"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-55"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-56"></a><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-logging</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-57"></a><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-58"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-59"></a><span class="w">      </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-60"></a><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-61"></a><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-62"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/master</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-63"></a><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-64"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-65"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-66"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluent/fluentd-kubernetes-daemonset:v1-debian-forward</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-67"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-68"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLUENT_FOWARD_HOST</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-69"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;x.x.x.x&quot;</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-70"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLUENT_FOWARD_PORT</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-71"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;24224&quot;</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-72"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLUENTD_SYSTEMD_CONF</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-73"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;disable&quot;</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-74"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-75"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-76"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200Mi</span>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-77"></a><span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-78"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-79"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200Mi</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-80"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-81"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-82"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/fluentd/etc/tail_container_parse.conf</span>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-83"></a><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tail_container_parse.conf</span>
</span><span id="__span-2-84"><a id="__codelineno-2-84" name="__codelineno-2-84" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-84"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
</span><span id="__span-2-85"><a id="__codelineno-2-85" name="__codelineno-2-85" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-85"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
</span><span id="__span-2-86"><a id="__codelineno-2-86" name="__codelineno-2-86" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-86"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlibdockercontainers</span>
</span><span id="__span-2-87"><a id="__codelineno-2-87" name="__codelineno-2-87" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-87"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker/containers</span>
</span><span id="__span-2-88"><a id="__codelineno-2-88" name="__codelineno-2-88" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-88"></a><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-2-89"><a id="__codelineno-2-89" name="__codelineno-2-89" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-89"></a><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</span><span id="__span-2-90"><a id="__codelineno-2-90" name="__codelineno-2-90" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-90"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-2-91"><a id="__codelineno-2-91" name="__codelineno-2-91" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-91"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
</span><span id="__span-2-92"><a id="__codelineno-2-92" name="__codelineno-2-92" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-92"></a><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-2-93"><a id="__codelineno-2-93" name="__codelineno-2-93" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-93"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-config</span>
</span><span id="__span-2-94"><a id="__codelineno-2-94" name="__codelineno-2-94" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-94"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
</span><span id="__span-2-95"><a id="__codelineno-2-95" name="__codelineno-2-95" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-95"></a><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-2-96"><a id="__codelineno-2-96" name="__codelineno-2-96" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-96"></a><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
</span><span id="__span-2-97"><a id="__codelineno-2-97" name="__codelineno-2-97" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-97"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlibdockercontainers</span>
</span><span id="__span-2-98"><a id="__codelineno-2-98" name="__codelineno-2-98" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-98"></a><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-2-99"><a id="__codelineno-2-99" name="__codelineno-2-99" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-99"></a><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker/containers</span>
</span><span id="__span-2-100"><a id="__codelineno-2-100" name="__codelineno-2-100" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-100"></a>
</span><span id="__span-2-101"><a id="__codelineno-2-101" name="__codelineno-2-101" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-101"></a><span class="nn">---</span>
</span><span id="__span-2-102"><a id="__codelineno-2-102" name="__codelineno-2-102" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-102"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-103"><a id="__codelineno-2-103" name="__codelineno-2-103" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-103"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-2-104"><a id="__codelineno-2-104" name="__codelineno-2-104" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-104"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-105"><a id="__codelineno-2-105" name="__codelineno-2-105" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-105"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-config</span>
</span><span id="__span-2-106"><a id="__codelineno-2-106" name="__codelineno-2-106" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-106"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-107"><a id="__codelineno-2-107" name="__codelineno-2-107" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-107"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-2-108"><a id="__codelineno-2-108" name="__codelineno-2-108" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-108"></a><span class="w">  </span><span class="nt">tail_container_parse.conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-2-109"><a id="__codelineno-2-109" name="__codelineno-2-109" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-109"></a><span class="w">    </span><span class="no">&lt;parse&gt;</span>
</span><span id="__span-2-110"><a id="__codelineno-2-110" name="__codelineno-2-110" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-110"></a><span class="w">      </span><span class="no">@type cri</span>
</span><span id="__span-2-111"><a id="__codelineno-2-111" name="__codelineno-2-111" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-111"></a><span class="w">    </span><span class="no">&lt;/parse&gt;</span>
</span></code></pre></div>
<p>和原版有几点细节上的不同：</p>
<ol>
<li>k8s 启用了 rbac，所以需要对应的配置；照着仓库里其他带 rbac 配置的文件抄一下即可。</li>
<li>禁用了 SYSTEMD 日志的抓取，因为我用的是 k3s，而不是 kubeadm，自然找不到 kubelet 的 systemd service。</li>
<li>覆盖了 container 日志的读取，因为使用的 container runtime 日志格式和默认的不同，这部分设置在仓库的 README 中也有提到。</li>
</ol>
<p>部署到 k8s 中即可。为了保证日志的准确性，建议各个结点都保持 NTP 的同步。</p>

    <nav class="md-post__action">
      <a href="../../devops/2021/04/02/k8s-fluentd-log-collect/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-29 00:00:00">2021年3月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ipmitool-ilo-4"><a class="toclink" href="../../system/2021/03/29/ilo-nic-selection-ipmitool/">通过 ipmitool 配置 iLO 4 管理端口</a></h2>
<p>ipmitool 自带了对 iDRAC 的支持，可以通过 <code>ipmitool delloem</code> 设置 iDRAC 的管理端口。但是对 iLO 的支持并没有实现。研究了一番，找到了通过 raw command 配置 iLO 4 管理端口的方法。</p>
<p><a href="https://computercheese.blogspot.com/2013/05/ipmi-lan-commands.html">这篇文章</a> 讲述了 <code>ipmitool lan</code> 命令实际会发送的命令：</p>
<p>读取配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-0-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x02<span class="w"> </span>CHANNEL<span class="w"> </span>KEY<span class="w"> </span>SET<span class="w"> </span>BLOCK
</span></code></pre></div>
<p>一般来说 SET 和 BLOCK 都是 0。KEY 的常见取值：</p>
<ul>
<li>3: IP 地址</li>
<li>4: IP 地址来源</li>
<li>5: MAC 地址</li>
<li>6: 子网掩码</li>
<li>12: 默认网关</li>
</ul>
<p>返回的数据中，第一个字节忽略，剩下的就是数据了。</p>
<p>写入配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-1-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x01<span class="w"> </span>CHANNEL<span class="w"> </span>KEY<span class="w"> </span>DATA...
</span></code></pre></div>
<p>知道如何读取配置后，接下来就是找到 iLO 4 配置 NIC 的地方了。一番搜索，找到了 <a href="https://support.hpe.com/hpesc/public/docDisplay?docId=c04530505&amp;docLocale=en_US">HPE iLO IPMI User Guide</a>。在第 101 页，可以找到一个用于配置 iLO NIC 选择的设置：</p>
<div class="language-text highlight"><pre><span></span><code>Index: 224
iLO Dedicated/Shared NIC Selection.
data 3:
• Selected iLO NIC.
◦ 0h = iLO Dedicated NIC is selected.
◦ 1h = iLO Shared NIC is selected.
◦ All others = reserved
• To switch to another iLO NIC:
1. Write this (and possibly parameter 197) to the desired NIC selection
2. Configure all other relevant network parameters for the desin
3. Reset iLO. The desired NIC will be in use after iLO reset.
• When writing changes to data 3, NIC selection:
◦ data 1 must be AAh
◦ data 2 must be 55h
◦ data 4 must be FFh
</code></pre></div>
<p>有这样的信息以后，可以通过下面的命令来设置 Shared NIC：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-2-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x01<span class="w"> </span>0x01<span class="w"> </span><span class="m">224</span><span class="w"> </span>0xAA<span class="w"> </span>0x55<span class="w"> </span>0x01<span class="w"> </span>0xFF
</span></code></pre></div>
<p>再读出来 224，发现它的 data 4 表示 <code>iLO reset needed for some settings changes that have been made</code>。于是，执行 <code>ipmitool mc reset warm</code> 之后，就可以看到 NIC 选择已经更新：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-3-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x02<span class="w"> </span>0x01<span class="w"> </span><span class="m">197</span><span class="w"> </span>0x00<span class="w"> </span>0x00
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-3-2"></a><span class="m">11</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">02</span>
</span></code></pre></div>
<p>数据分别表示：</p>
<ul>
<li>0x02: Shared NIC Selection = ALOM</li>
<li>0x01: Shared NIC Port Number = Port 1</li>
<li>0x02: Platform supports ALOM shared NIC</li>
</ul>
<p>如果想要的端口和默认选择不一样，可以写入 197 来更新。详见上面的文档链接。</p>
<p>超微的机器也有类似的办法：https://www.supermicro.org.cn/support/faqs/faq.cfm?faq=15868，可以用 <code>ipmiutil smcoem lanport</code> 命令来读取/修改。</p>
<p>Update：我给 IPMITOOL 提交了 <a href="https://github.com/ipmitool/ipmitool/pull/278">PR</a>，来简化这个过程</p>

    <nav class="md-post__action">
      <a href="../../system/2021/03/29/ilo-nic-selection-ipmitool/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-29 00:00:00">2021年3月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ipmitool"><a class="toclink" href="../../system/2021/03/29/static-ipmitool/">静态编译 ipmitool</a></h2>
<p>为了在 ESXi 上运行 ipmitool，需要静态编译 ipmitool。网上已经有一些解决方案：</p>
<p>https://github.com/ryanbarrie/ESXI-ipmitool
https://github.com/hobbsh/static-ipmitool
https://github.com/ewenmcneill/docker-build-static-ipmitool</p>
<p>我稍微修改了一下，用来编译最新 ipmitool：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-1"></a><span class="c1">##!/bin/bash</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-2"></a><span class="nb">set</span><span class="w"> </span>-x
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VERSION</span><span class="o">=</span><span class="m">1</span>.8.18
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-4"></a>rm<span class="w"> </span>-rf<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-5"></a>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>.tar.bz2<span class="w"> </span>http://deb.debian.org/debian/pool/main/i/ipmitool/ipmitool_<span class="nv">$VERSION</span>.orig.tar.bz2
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-6"></a>tar<span class="w"> </span>xvf<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>.tar.bz2
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-7"></a><span class="nb">cd</span><span class="w"> </span>ipmitool-<span class="nv">$VERSION</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-8"></a><span class="nv">CC</span><span class="o">=</span>gcc<span class="w"> </span><span class="nv">CFLAGS</span><span class="o">=</span>-m64<span class="w"> </span><span class="nv">LDFLAGS</span><span class="o">=</span>-static<span class="w"> </span>./configure
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-9"></a>make<span class="w"> </span>-j24
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-10"></a><span class="nb">cd</span><span class="w"> </span>src
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-11"></a>../libtool<span class="w"> </span>--silent<span class="w"> </span>--tag<span class="o">=</span>CC<span class="w"> </span>--mode<span class="o">=</span>link<span class="w"> </span>gcc<span class="w"> </span>-m64<span class="w"> </span>-fno-strict-aliasing<span class="w"> </span>-Wreturn-type<span class="w"> </span>-all-static<span class="w"> </span>-o<span class="w"> </span>ipmitool.static<span class="w"> </span>ipmitool.o<span class="w"> </span>ipmishell.o<span class="w"> </span>../lib/libipmitool.la<span class="w"> </span>plugins/libintf.la
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-12"></a>file<span class="w"> </span><span class="nv">$PWD</span>/ipmitool.static
</span></code></pre></div>
<p>复制下来，编译完成后 scp 到 esxi 中即可使用。</p>

    <nav class="md-post__action">
      <a href="../../system/2021/03/29/static-ipmitool/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-27 00:00:00">2021年3月27日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="esxi"><a class="toclink" href="../../networking/2021/03/27/esxi-network-config/">ESXi 网络配置</a></h2>
<p>用过 ESXi 的大家都知道，它网页版对网络的配置功能有限，特别是 IPv6 的部分，有的事情无法实现。更好的办法是 SSH 到 ESXi 上直接用命令行进行配置。</p>
<p>可能会用到的一些命令：</p>
<ol>
<li>esxcfg-vmknic: 用来给 vmkernel 配置地址</li>
<li>esxcfg-route: 设置系统路由表</li>
<li>esxcli: 大杂烩，很多功能都在里面</li>
<li>tcpdump-uw：魔改版 tcpdump</li>
</ol>
<p>一些例子：</p>
<p>设置 IPv6 默认路由：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2021/03/27/esxi-network-config/#__codelineno-0-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcfg-route<span class="w"> </span>-f<span class="w"> </span>V6<span class="w"> </span>-a<span class="w"> </span>default<span class="w"> </span><span class="nv">$IPV6</span>
</span></code></pre></div>
<p>删除 vmkernel 的 IPv6 地址：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2021/03/27/esxi-network-config/#__codelineno-1-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcli<span class="w"> </span>network<span class="w"> </span>ip<span class="w"> </span>interface<span class="w"> </span>ipv6<span class="w"> </span>address<span class="w"> </span>remove<span class="w"> </span>-i<span class="w"> </span><span class="nv">$VMKERNEL</span><span class="w"> </span>-I<span class="w"> </span><span class="nv">$IPV6</span>/<span class="nv">$PREFIX</span>
</span></code></pre></div>
<p>参考：https://kb.vmware.com/s/article/1002662</p>

    <nav class="md-post__action">
      <a href="../../networking/2021/03/27/esxi-network-config/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-18 00:00:00">2021年3月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linksys-e8450-openwrt-w-80211ax"><a class="toclink" href="../../hardware/2021/03/18/linksys-e8450-openwrt/">Linksys E8450 OpenWRT 配置 w/ 802.11ax</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#_1">背景</a></h3>
<p>之前用的 newifi 路由器（Lenovo y1s）无线网总是出问题，于是换了一个新的支持 802.11ax 的路由器 Linksys E8450，目前在 openwrt snapshot 支持。Openwrt 的支持页面：<a href="https://openwrt.org/toh/linksys/linksys_e8450">Linksys E8450</a>。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#_2">过程</a></h3>
<p>按照支持页面，下载固件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-0-1"></a>$<span class="w"> </span>wget<span class="w"> </span>https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin
</span></code></pre></div>
<p>更新（2023-02-27）：固件已经从 snapshot 进入正式版，下载链接为 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin</a>。如果已经替换为 UBI，则使用 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb</a> 固件。</p>
<p>然后访问固件升级页面：http://192.168.1.1/config-admin-firmware.html#firmware，选择下载的 bin 文件。点击“开始升级”，然后等待。一段时间后，ssh 到路由器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>root@192.168.1.1
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-2"></a>The<span class="w"> </span>authenticity<span class="w"> </span>of<span class="w"> </span>host<span class="w"> </span><span class="s1">&#39;192.168.1.1 (192.168.1.1)&#39;</span><span class="w"> </span>can<span class="s1">&#39;t be established.</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-3"></a><span class="s1">ED25519 key fingerprint is SHA256:REDACTED.</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-4"></a><span class="s1">No matching host key fingerprint found in DNS.</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-5"></a><span class="s1">This key is not known by any other names</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-6"></a><span class="s1">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-7"></a><span class="s1">Warning: Permanently added &#39;</span><span class="m">192</span>.168.1.1<span class="err">&#39;</span><span class="w"> </span><span class="o">(</span>ED25519<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>known<span class="w"> </span>hosts.
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-10"></a>BusyBox<span class="w"> </span>v1.33.0<span class="w"> </span><span class="o">()</span><span class="w"> </span>built-in<span class="w"> </span>shell<span class="w"> </span><span class="o">(</span>ash<span class="o">)</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-12"></a><span class="w">  </span>_______<span class="w">                     </span>________<span class="w">        </span>__
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-13"></a><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>.-----.-----.-----.<span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span>.----.<span class="p">|</span><span class="w">  </span><span class="p">|</span>_
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-14"></a><span class="w"> </span><span class="p">|</span><span class="w">   </span>-<span class="w">   </span><span class="o">||</span><span class="w">  </span>_<span class="w">  </span><span class="p">|</span><span class="w">  </span>-__<span class="p">|</span><span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="o">||</span><span class="w">   </span>_<span class="o">||</span><span class="w">   </span>_<span class="p">|</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-15"></a><span class="w"> </span><span class="p">|</span>_______<span class="o">||</span><span class="w">   </span>__<span class="p">|</span>_____<span class="p">|</span>__<span class="p">|</span>__<span class="o">||</span>________<span class="o">||</span>__<span class="p">|</span><span class="w">  </span><span class="p">|</span>____<span class="p">|</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-16"></a><span class="w">          </span><span class="p">|</span>__<span class="p">|</span><span class="w"> </span>W<span class="w"> </span>I<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>L<span class="w"> </span>E<span class="w"> </span>S<span class="w"> </span>S<span class="w">   </span>F<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>E<span class="w"> </span>D<span class="w"> </span>O<span class="w"> </span>M
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-17"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-18"></a><span class="w"> </span>OpenWrt<span class="w"> </span>SNAPSHOT,<span class="w"> </span>r16242-41af8735d4
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-19"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-20"></a><span class="o">===</span><span class="w"> </span>WARNING!<span class="w"> </span><span class="o">=====================================</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-21"></a>There<span class="w"> </span>is<span class="w"> </span>no<span class="w"> </span>root<span class="w"> </span>password<span class="w"> </span>defined<span class="w"> </span>on<span class="w"> </span>this<span class="w"> </span>device!
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-22"></a>Use<span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;passwd&quot;</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>to<span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>password
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-23"></a><span class="k">in</span><span class="w"> </span>order<span class="w"> </span>to<span class="w"> </span>prevent<span class="w"> </span>unauthorized<span class="w"> </span>SSH<span class="w"> </span>logins.
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-24"></a>--------------------------------------------------
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-25"></a>root@OpenWrt:~#<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-26"></a>Linux<span class="w"> </span>OpenWrt<span class="w"> </span><span class="m">5</span>.10.23<span class="w"> </span><span class="c1">#0 SMP Wed Mar 17 19:55:38 2021 aarch64 GNU/Linux</span>
</span></code></pre></div>
<p>配置 luci:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-2-1"></a>$<span class="w"> </span>opkg<span class="w"> </span>update
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-2-2"></a>$<span class="w"> </span>opkg<span class="w"> </span>install<span class="w"> </span>luci
</span></code></pre></div>
<p>然后就可以网页访问看到 luci 了：Powered by LuCI Master (git-21.060.51374-cd06e70) / OpenWrt SNAPSHOT r16242-41af8735d4。</p>
<p>由于目前 luci 不支持 802.11ax 的配置，可以直接修改 uci 配置来达到效果：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-1"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span>show<span class="w"> </span>wireless
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-2"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wireless.radio1.htmode<span class="o">=</span><span class="s1">&#39;HE80&#39;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-3"></a>root@OpenWrt:/#<span class="w"> </span>/etc/init.d/network<span class="w"> </span>restart
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-4"></a><span class="s1">&#39;radio0&#39;</span><span class="w"> </span>is<span class="w"> </span>disabled
</span></code></pre></div>
<p>注：实际上设置为 HE 开头的字符串即可，见 <a href="https://github.com/openwrt/openwrt/blob/8019c54d8a191cfb90c3bf06ff367f601f872fd1/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh#L334">mac80211.sh</a>。</p>
<p>再连接上 Wi-Fi 的时候就可以看到是 802.11ax 模式了。也在 <a href="https://forum.openwrt.org/t/got-802-11ax-working-in-linksys-e8450/91533">OpenWRT 论坛</a> 上分享了一下这个方案。</p>
<p>更新（2021-07-31）：目前最新的 luci 版本已经可以在网页上配置 802.11ax 模式了。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2021/03/18/linksys-e8450-openwrt/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-16 00:00:00">2021年3月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="gitlab-ci-k8s"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/">用 gitlab ci 构建并部署应用到 k8s</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#_1">背景</a></h3>
<p>在 k8s 集群中部署了 gitlab-runner，并且希望在 gitlab ci 构建完成后，把新的 docker image push 到 private repo，然后更新应用。</p>
<p>参考文档：<a href="https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/">Gitlab CI 与 Kubernetes 的结合</a>，<a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">Using Docker to build Docker images</a>。</p>
<h3 id="gitlab-ci-docker"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#gitlab-ci-docker">在 gitlab ci 中构建 docker 镜像</a></h3>
<p>这一步需要 DinD 来实现在容器中构建容器。为了达到这个目的，首先要在 gitlab-runner 的配置中添加一个 volume 来共享 DinD 的证书路径：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-1"></a><span class="nt">gitlabUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-2"></a><span class="nt">rbac</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-3"></a><span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-4"></a><span class="nt">runnerRegistrationToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-5"></a><span class="nt">runners</span><span class="p">:</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-6"></a><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-7"></a><span class="w">    </span><span class="no">[[runners]]</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-8"></a><span class="w">      </span><span class="no">[runners.kubernetes]</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-9"></a><span class="w">        </span><span class="no">image = &quot;ubuntu:20.04&quot;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-10"></a><span class="w">        </span><span class="no">privileged = true</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-11"></a><span class="w">      </span><span class="no">[[runners.kubernetes.volumes.empty_dir]]</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-12"></a><span class="w">        </span><span class="no">name = &quot;docker-certs&quot;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-13"></a><span class="w">        </span><span class="no">mount_path = &quot;/certs/client&quot;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-14"></a><span class="w">        </span><span class="no">medium = &quot;Memory&quot;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-15"></a><span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<p>注意两点：1. privileged 2. 多出来的 volume</p>
<p>用 helm 部署 gitlab runner 之后，按照下面的方式配置 gitlab-ci：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-1"></a>image: docker:19.03.12
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-3"></a>variables:
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-4"></a>  DOCKER_HOST: tcp://docker:2376
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-5"></a>  #
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-6"></a>  # The &#39;docker&#39; hostname is the alias of the service container as described at
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-7"></a>  # https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#accessing-the-services.
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-8"></a>  # If you&#39;re using GitLab Runner 12.7 or earlier with the Kubernetes executor and Kubernetes 1.6 or earlier,
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-9"></a>  # the variable must be set to tcp://localhost:2376 because of how the
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-10"></a>  # Kubernetes executor connects services to the job container
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-11"></a>  # DOCKER_HOST: tcp://localhost:2376
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-12"></a>  #
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-13"></a>  # Specify to Docker where to create the certificates, Docker will
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-14"></a>  # create them automatically on boot, and will create
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-15"></a>  # `/certs/client` that will be shared between the service and job
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-16"></a>  # container, thanks to volume mount from config.toml
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-17"></a>  DOCKER_TLS_CERTDIR: &quot;/certs&quot;
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-18"></a>  # These are usually specified by the entrypoint, however the
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-19"></a>  # Kubernetes executor doesn&#39;t run entrypoints
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-20"></a>  # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4125
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-21"></a>  DOCKER_TLS_VERIFY: 1
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-22"></a>  DOCKER_CERT_PATH: &quot;$DOCKER_TLS_CERTDIR/client&quot;
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-23"></a>  DOCKER_DAEMON_OPTIONS: &quot;--insecure-registry=${REGISTRY}&quot;
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-24"></a>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-25"></a>services:
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-26"></a>  - name: docker:19.03.12-dind
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-27"></a>    entrypoint: [&quot;sh&quot;, &quot;-c&quot;, &quot;dockerd-entrypoint.sh $DOCKER_DAEMON_OPTIONS&quot;]
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-28"></a>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-29"></a>before_script:
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-30"></a>  # Wait until client certs are generated
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-31"></a>  # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/27384
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-32"></a>  - until docker info; do sleep 1; done
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-33"></a>  - echo &quot;$REGISTRY_PASS&quot; | docker login $REGISTRY --username $REGISTRY_USER --password-stdin
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-34"></a>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-35"></a>build:
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-36"></a>  stage: build
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-37"></a>  script: ./build.sh
</span></code></pre></div>
<p>这里有很多细节，包括 DinD 的访问方式，等待 client cert，设置 docker 的 insecure registry 和 login 等等。经过 <a href="https://github.com/CircuitCoder">@CircuitCoder</a> 的不断摸索，终于写出了可以用的配置。</p>
<p>如此配置以后，就可以在 gitlab ci 的构建脚本里用 docker 来 build 并且 push 到自己的 registry 了。为了防止泄露密钥，建议把这些变量放到 gitlab ci 设置的 secrets 中。</p>
<h3 id="k8s"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#k8s">自动部署到 k8s</a></h3>
<p>为了让 k8s 重启一个 deployment，一般的做法是：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-2-1"></a>kubectl -n NAMESPACE rollout restart deployment/NAME
</span></code></pre></div>
<p>我们希望 gitlab ci 在 build 之后，去执行这一个命令，但又不希望提供太多的权限给 gitlab。所以，我们创建 Service Account 并设置最小权限：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-1"></a>---
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-2"></a>apiVersion: v1
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-3"></a>kind: ServiceAccount
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-4"></a>metadata:
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-5"></a>  name: gitlab
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-6"></a>  namespace: default
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-8"></a>---
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-9"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-10"></a>kind: Role
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-11"></a>metadata:
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-12"></a>  name: gitlab-test
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-13"></a>  namespace: test
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-14"></a>rules:
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-15"></a>- verbs:
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-16"></a>    - get
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-17"></a>    - patch
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-18"></a>  apiGroups:
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-19"></a>    - &#39;apps&#39;
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-20"></a>  resources:
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-21"></a>    - &#39;deployments&#39;
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-22"></a>  resourceNames:
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-23"></a>    - &#39;test-deployment&#39;
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-25"></a>---
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-26"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-27"></a>kind: RoleBinding
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-28"></a>metadata:
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-29"></a>  name: gitlab
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-30"></a>  namespace: test
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-31"></a>subjects:
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-32"></a>  - kind: ServiceAccount
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-33"></a>    name: gitlab
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-34"></a>    namespace: default
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-35"></a>roleRef:
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-36"></a>  apiGroup: rbac.authorization.k8s.io
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-37"></a>  kind: Role
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-38"></a>  name: gitlab-test
</span></code></pre></div>
<p>要特别注意这几个配置的 namespace 的对应关系：Role 和 RoleBinding 需要放在同一个 ns 下。</p>
<p>接着，到 GitLab 的 Operations-&gt;Kubernetes 创建 cluster，把 service account 的 token 和 ca.crt 从 secret 里找到并贴到网页上。GitLab 会按照 Environment scope 匹配到 environment，如果某个 stage 的 environment 匹配上了，就会把 kube credentials 配置好。修改 gitlab-ci.yml：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-1"></a>deploy:
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-2"></a>  stage: deploy
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-3"></a>  image: bitnami/kubectl:1.20
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-4"></a>  environment:
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-5"></a>    name: production
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-6"></a>  only:
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-7"></a>    - master
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-8"></a>  script:
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-9"></a>    - kubectl -n test rollout restart deployment/test
</span></code></pre></div>
<p>这样就完成配置了。</p>

    <nav class="md-post__action">
      <a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-13 00:00:00">2021年3月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="gnome-fractional-scaling"><a class="toclink" href="../../software/2021/03/13/gnome-fractional-scaling/">Gnome 的 Fractional Scaling</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/03/13/gnome-fractional-scaling/#_1">背景</a></h3>
<p>最近发现部分软件（包括 Google Chrome，Firefox 和 Visual Studio Code）在 125% 的 Fractional Scaling 模式下会很卡。找到了一些临时解决方法，但是很不优雅，也很麻烦。所以深入研究了一下 Fractional Scaling 的工作方式。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/03/13/gnome-fractional-scaling/#_2">临时解决方法</a></h3>
<p>根据关键字，找到了 <a href="https://askubuntu.com/questions/1274719/chrome-menus-too-slow-after-enabling-fractional-scaling-in-ubuntu-20-04">Chrome menus too slow after enabling fractional scaling in Ubuntu 20.04</a>。按它的方法，关闭 Google Chrome 的硬件加速，发现卡顿问题确实解决了。</p>
<p>类似地，也可以<a href="https://gist.github.com/andriyudatama/fe5d00deb36feeea30ef35a5ea0f7eff">关闭 VSCode 的硬件加速</a>，在 Firefox 里也可以找到相应的设置。这样操作确实可以解决问题。但是，对于每一个出问题的应用都这样搞一遍，还是挺麻烦的。</p>
<p>另一个思路是，<a href="https://askubuntu.com/questions/1230208/fractional-scaling-does-not-work-properly-ubuntu-20-04/1272794#1272794">不使用 Fractional Scaling，而只是把字体变大</a>。但毕竟和我们想要的效果不大一样。</p>
<h3 id="_3"><a class="toclink" href="../../software/2021/03/13/gnome-fractional-scaling/#_3">一些发现</a></h3>
<p>在物理机进行了一些实验以后，发现一个现象：125% 的时候卡顿，而其他比例（100%，150%，175%，200%）都不卡顿。</p>
<p>网上一顿搜到，找到了 xrandr 工具。下面是观察到的一些现象（GNOME 设置分辨率一直是 1920x1080）：</p>
<table>
<thead>
<tr>
<th>放缩比例</th>
<th>xrandr 显示的分辨率</th>
<th>xrandr 显示的 transform</th>
</tr>
</thead>
<tbody>
<tr>
<td>100%</td>
<td>1920x1080</td>
<td>diag(1.0, 1.0, 1.0)</td>
</tr>
<tr>
<td>125%</td>
<td>3072x1728</td>
<td>diag(1.6, 1.6, 1.0)</td>
</tr>
<tr>
<td>150%</td>
<td>2560x1440</td>
<td>diag(1.33, 1.33, 1.0)</td>
</tr>
<tr>
<td>175%</td>
<td>2208x1242</td>
<td>diag(1.15, 1.15, 1.0)</td>
</tr>
<tr>
<td>200%</td>
<td>1920x1080</td>
<td>diag(1.0, 1.0, 1.0)</td>
</tr>
</tbody>
</table>
<p>在 <a href="https://www.x.org/releases/X11R7.5/doc/man/man1/xrandr.1.html">xrandr 文档</a> 中，写了：transform 是一个 3x3 矩阵，矩阵乘以输出的点的坐标得到图形缓存里面的坐标。</p>
<p>由此可以猜想：fractional scaling 的工作方式是，把绘制的 buffer 调大，然后再用 transform 把最终输出分辨率调成 1920x1080。可以看到，xrandr 显示的分辨率除以 transform 对应的值，就是 1920x1080。但这并不能解释 100% 和 200% 的区别，所以肯定还漏了什么信息。</p>
<p>翻了翻 <a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#989734a4aea877b0c1d80fa73cbe2ee59de79fba_376_422">mutter 实现 fractional scaling 的 pr</a>，找到了实现 scale 的一部分：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-0-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clutter_actor_get_resource_scale</span><span class="w"> </span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resource_scale</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-0-2"></a><span class="w">    </span><span class="n">resource_scale</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-0-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-0-4"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">paint_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resource_scale</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-0-5"></a><span class="w">    </span><span class="n">cogl_matrix_scale</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">modelview</span><span class="p">,</span><span class="w"> </span><span class="n">paint_scale</span><span class="p">,</span><span class="w"> </span><span class="n">paint_scale</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-0-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>然后找到了一段对 scale 做 ceiling 的<a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#989734a4aea877b0c1d80fa73cbe2ee59de79fba_238_265">代码</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-1-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_clutter_actor_get_real_resource_scale</span><span class="w"> </span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resource_scale</span><span class="p">))</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-1-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-1-3"></a><span class="w">    </span><span class="n">ceiled_resource_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceilf</span><span class="w"> </span><span class="p">(</span><span class="n">resource_scale</span><span class="p">);</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-1-4"></a><span class="w">    </span><span class="n">stage_width</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">ceiled_resource_scale</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-1-5"></a><span class="w">    </span><span class="n">stage_height</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">ceiled_resource_scale</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-1-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>这样，100% 和其他比例就区分开了。</p>
<p>另外，也在<a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#d66a28cda989fbb17c8a7302b3f6360640c3c152_33_33">代码</a> 中发现：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-2-1"></a><span class="cp">##define SCALE_FACTORS_PER_INTEGER 4</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-2-2"></a><span class="cp">##define SCALE_FACTORS_STEPS (1.0 / (float) SCALE_FACTORS_PER_INTEGER)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-2-3"></a><span class="cp">##define MINIMUM_SCALE_FACTOR 1.0f</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-2-4"></a><span class="cp">##define MAXIMUM_SCALE_FACTOR 4.0f</span>
</span></code></pre></div>
<p>这段代码规定了比例只能是 25% 的倍数。</p>
<p>我也试了一下用 xrandr --scale 1.5x1.5：效果就是窗口看起来都更小了，分辨率变成了 2880x1620，transform 是 diag(1.5, 1.5, 1.0)。</p>
<h3 id="_4"><a class="toclink" href="../../software/2021/03/13/gnome-fractional-scaling/#_4">虚拟机测试</a></h3>
<p>接着，用虚拟机做了一些测试。为了在 GNOME over Wayland 上使用 fractional scaling，需要运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-3-1"></a>$<span class="w"> </span>gsettings<span class="w"> </span><span class="nb">set</span><span class="w"> </span>org.gnome.mutter<span class="w"> </span>experimental-features<span class="w"> </span><span class="s2">&quot;[&#39;scale-monitor-framebuffer&#39;]&quot;</span>
</span></code></pre></div>
<p>接着又做了类似上面的测试（GNOME 设置分辨率一直是 2560x1600）：</p>
<table>
<thead>
<tr>
<th>放缩比例</th>
<th>xrandr 显示的分辨率</th>
</tr>
</thead>
<tbody>
<tr>
<td>100%</td>
<td>2560x1600</td>
</tr>
<tr>
<td>125%</td>
<td>2048x1280</td>
</tr>
<tr>
<td>150%</td>
<td>1704x1065</td>
</tr>
<tr>
<td>175%</td>
<td>1464x915</td>
</tr>
<tr>
<td>200%</td>
<td>1280x800</td>
</tr>
</tbody>
</table>
<p>在这个测试中，xrandr 显示的 transform 一直都是单位矩阵；还用了来自 <a href="https://github.com/xyproto/wallutils">xyproto/wallutils</a> 的 <code>wayinfo</code> 命令查看输出的分辨率，一直是 2560x1600，DPI 一直是 96。用 wallutils 的 xinfo 看到的结果和 xrandr 一致（通过 XWayland）。但是和物理机有一点不同：物理机有一个选项问要不要打开 fractional scaling，下面还会提示性能下降的问题；但是虚拟机上并没有这个提示，而是直接给了一些 Scale 比例的选项。</p>
<p>尝试了一下，在 GNOME over X11 上是找不到 fractional scaling 的（没有出现设置 scale 的选项）。找到一个实现这个功能的 fork：https://github.com/puxplaying/mutter-x11-scaling，不过没有尝试过。</p>
<p>我也尝试在虚拟机中用 xrandr --scale，结果就是输出黑屏，需要重启 gdm 来恢复到登录界面。</p>
<p>更新：由于物理机使用的是 Ubuntu，想到是不是 Ubuntu 采用了上面那个 fork 的 patch，然后就在 <a href="https://changelogs.ubuntu.com/changelogs/pool/main/m/mutter/mutter_3.38.1-1ubuntu1/changelog">changelog</a> 中看到：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-1"></a>mutter (3.38.1-1ubuntu1) groovy; urgency=medium
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-3"></a>  * Merge with debian, including new upstream version, remaining changes:
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-4"></a>    - debian/gbp.conf: update upstream branch to point to ubuntu/master
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-5"></a>    - debian/patches/x11-Add-support-for-fractional-scaling-using-Randr.patch:
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-6"></a>      + X11: Add support for fractional scaling using Randr
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-7"></a>  * d/p/clutter-backend-x11-Don-t-set-the-font-dpi-computed-on-X1.patch:
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-4-8"></a>    - Dropped, applied upstream
</span></code></pre></div>
<p>也找到了对应的 <a href="https://git.launchpad.net/ubuntu/+source/mutter/tree/debian/patches/x11-Add-support-for-fractional-scaling-using-Randr.patch?h=applied/ubuntu/groovy">patch 文件</a>。这也就解释了，为什么网上会说 GNOME over X11 支持 fractional scaling，并且需要用 gsettings 打开，而我在 Debian 和 Arch Linux 上设置这个选项也没有用了。原来是 Ubuntu 加的私货啊。</p>
<p>在 patch 中，找到了这么一段配置的解释：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-1"></a>+    &lt;key name=&quot;fractional-scale-mode&quot; enum=&quot;org.gnome.mutter.X11.scale-mode&quot;&gt;
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-2"></a>+      &lt;default&gt;&quot;scale-ui-down&quot;&lt;/default&gt;
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-3"></a>+      &lt;description&gt;
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-4"></a>+        Choose the scaling mode to be used under X11 via Randr extension.
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-5"></a>+
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-6"></a>+        Supported methods are:
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-7"></a>+
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-8"></a>+        • “scale-up”     — Scale everything up to the requested scale, shrinking
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-9"></a>+                           the UI. The applications will look blurry when scaling
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-10"></a>+                           at higher values and the resolution will be lowered.
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-11"></a>+        • “scale-ui-down — Scale up the UI toolkits to the closest integer
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-12"></a>+                           scaling value upwards, while scale down the display
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-13"></a>+                           to match the requested scaling level.
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-14"></a>+                           It increases the resolution of the logical display.
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-15"></a>+      &lt;/description&gt;
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../software/2021/03/13/gnome-fractional-scaling/#__codelineno-5-16"></a>+    &lt;/key&gt;
</span></code></pre></div>
<p>这样就可以解释前面看到的现象了：默认是 <code>scale-ui-down</code>，也就是先放大到两倍（closest integer scaling value upwards），再缩小（scale down the display to match the requested scaling level）。</p>

    <nav class="md-post__action">
      <a href="../../software/2021/03/13/gnome-fractional-scaling/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-12 00:00:00">2021年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rook-k8s-ceph"><a class="toclink" href="../../devops/2021/03/12/ceph-on-k8s/">通过 rook 在 k8s 上部署 ceph 集群</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/03/12/ceph-on-k8s/#_1">背景</a></h3>
<p>为了方便集群的使用，想在 k8s 集群里部署一个 ceph 集群。</p>
<p><a href="https://docs.ceph.com/en/latest/start/intro/">Ceph 介绍</a></p>
<p>Ceph 有这些组成部分：</p>
<ol>
<li>mon：monitor</li>
<li>mgr：manager</li>
<li>osd：storage</li>
<li>mds(optional)：用于 CephFS</li>
<li>radosgw(optional：用于 Ceph Object Storage</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../devops/2021/03/12/ceph-on-k8s/#_2">配置</a></h3>
<p>我们采用的是 <a href="https://rook.io/">rook</a> 来部署 ceph 集群。</p>
<p>参考文档：https://rook.github.io/docs/rook/v1.5/ceph-examples.html</p>
<p>首先，克隆 rook 的仓库。建议选择一个 release 版本。</p>
<p>接着，运行下面的命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>lvm2
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-2"></a><span class="c1">## required</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/crds.yaml
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-4"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/common.yaml
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-5"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/operator.yaml
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-6"></a><span class="c1">## debugging only</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-7"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/toolbox.yaml
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-8"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/direct-mount.yaml
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-9"></a><span class="c1">## CephFS</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-10"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/filesystem.yaml
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-0-11"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/csi/cephfs/storageclass.yaml
</span></code></pre></div>
<p>前面三个 yaml 是必须的，toolbox 是用来查看 ceph 状态的，direct mount 是用来 mount cephfs 的，后两个是为了用 cephfs 的。</p>
<p>接着，按照自己的需求编辑 <code>rook/cluster/exmaples/kuberenetes/ceph/cluster.yaml</code> 然后应用。此时你的集群应该就已经起来了。</p>
<p>然后，可以<a href="https://rook.github.io/docs/rook/v1.5/ceph-toolbox.html">进 toolbox 查看 ceph 状态</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-1-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>rook-ceph<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>deploy/rook-ceph-tools<span class="w"> </span>--<span class="w"> </span>bash
</span></code></pre></div>
<p>也可以<a href="https://rook.github.io/docs/rook/v1.5/direct-tools.html">进 direct-mount 容器查看 pv 路径</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-1"></a><span class="c1">## get volume path of pvc</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pv<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span>NAME:.metadata.name,NAMSEPACE:.spec.claimRef.namespace,CLAIM:.spec.claimRef.name,PATH:.spec.csi.volumeAttributes.subvolumeName
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-4"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>rook-ceph<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>deploy/rook-direct-mount<span class="w"> </span>--<span class="w"> </span>bash
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-5"></a><span class="c1">## in the pod</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-6"></a>mkdir<span class="w"> </span>/tmp/registry
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-7"></a><span class="nv">mon_endpoints</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>mon_host<span class="w"> </span>/etc/ceph/ceph.conf<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-8"></a><span class="nv">my_secret</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>key<span class="w"> </span>/etc/ceph/keyring<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-9"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>-o<span class="w"> </span><span class="nv">mds_namespace</span><span class="o">=</span>myfs,name<span class="o">=</span>admin,secret<span class="o">=</span><span class="nv">$my_secret</span><span class="w"> </span><span class="nv">$mon_endpoints</span>:/<span class="w"> </span>/tmp/registry
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-10"></a>df<span class="w"> </span>-h
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../devops/2021/03/12/ceph-on-k8s/#__codelineno-2-12"></a><span class="nb">cd</span><span class="w"> </span>/tmp/registry/volumes/csi/PATH
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../devops/2021/03/12/ceph-on-k8s/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-12 00:00:00">2021年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="k3s-k8s"><a class="toclink" href="../../devops/2021/03/12/k3s-deploy/">用 k3s 部署 k8s</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/03/12/k3s-deploy/#_1">背景</a></h3>
<p>最近需要部署一个 k8s 集群，觉得之前配置 kubeadm 太繁琐了，想要找一个简单的。比较了一下 k0s 和 k3s，最后选择了 k3s。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/03/12/k3s-deploy/#_2">配置</a></h3>
<p>k3s 的好处就是配置十分简单：https://rancher.com/docs/k3s/latest/en/quick-start/。不需要装 docker，也不需要装 kubeadm。</p>
<ol>
<li>在第一个 node 上跑：<code>curl -sfL https://get.k3s.io | sh -</code></li>
<li>在第一个 node 上获取 token：<code>cat /var/lib/rancher/k3s/server/node-token</code></li>
<li>在其他 node 上跑：<code>curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken sh -</code></li>
</ol>
<p>然后就搞定了。从第一个 node 的 <code>/etc/rancher/k3s/k3s.yaml</code>获取 <code>kubectl</code> 配置。</p>

    <nav class="md-post__action">
      <a href="../../devops/2021/03/12/k3s-deploy/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-12 00:00:00">2021年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/">常用交换机命令</a></h2>
<h3 id="_2"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_2">背景</a></h3>
<p>最近接触了 Cisco，DELL，Huawei，H3C，Ruijie 的网络设备，发现配置方式各有不同，故记录一下各个厂家的命令。</p>
<h3 id="huawei"><a class="toclink" href="../../devops/2021/03/12/switch-config/#huawei">Huawei</a></h3>
<p>测试型号：S5320</p>
<h4 id="_3"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_3">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2021/03/12/switch-config/#__codelineno-0-1"></a>&lt;HUAWEI&gt;save
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2021/03/12/switch-config/#__codelineno-0-2"></a>The current configuration will be written to flash:/vrpcfg.zip.
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2021/03/12/switch-config/#__codelineno-0-3"></a>Are you sure to continue?[Y/N]y
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2021/03/12/switch-config/#__codelineno-0-4"></a>Now saving the current configuration to the slot 0....
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../devops/2021/03/12/switch-config/#__codelineno-0-5"></a>Save the configuration successfully.
</span></code></pre></div>
<h4 id="_4"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_4">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2021/03/12/switch-config/#__codelineno-1-1"></a>&lt;HUAWEI&gt; system-view
</span></code></pre></div>
<h4 id="_5"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_5">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2021/03/12/switch-config/#__codelineno-2-1"></a>[HUAWEI] display current-configuration
</span></code></pre></div>
<h4 id="lldp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#lldp">查看 LLDP 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2021/03/12/switch-config/#__codelineno-3-1"></a>[HUAWEI]display lldp neighbor brief
</span></code></pre></div>
<h4 id="cdp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#cdp">查看 CDP 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../devops/2021/03/12/switch-config/#__codelineno-4-1"></a>[HUAWEI]display cdp neighbor brief
</span></code></pre></div>
<h4 id="lldp_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#lldp_1">启用 LLDP</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../devops/2021/03/12/switch-config/#__codelineno-5-1"></a>[HUAWEI]lldp enable
</span></code></pre></div>
<h4 id="cdp_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#cdp_1">启用 CDP</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../devops/2021/03/12/switch-config/#__codelineno-6-1"></a>[HUAWEI-XGigabitEthernet0/0/1]lldp compliance cdp txrx
</span></code></pre></div>
<h4 id="snmpv1-community"><a class="toclink" href="../../devops/2021/03/12/switch-config/#snmpv1-community">启用只读 SNMPv1 community</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../devops/2021/03/12/switch-config/#__codelineno-7-1"></a>[HUAWEI]snmp-agent sys-info version all
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../devops/2021/03/12/switch-config/#__codelineno-7-2"></a>Warning: This command may cause confliction in netconf status. Continue? [Y/N]:y
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../devops/2021/03/12/switch-config/#__codelineno-7-3"></a>Warning: SNMPv1/SNMPv2c is not secure, and it is recommended to use SNMPv3.
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../devops/2021/03/12/switch-config/#__codelineno-7-4"></a>[HUAWEI]snmp-agent community read [COMMUNITY NAME]
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../devops/2021/03/12/switch-config/#__codelineno-7-5"></a>Warning: This command may cause confliction in netconf status. Continue? [Y/N]:y
</span></code></pre></div>
<h4 id="snmp-iso-view"><a class="toclink" href="../../devops/2021/03/12/switch-config/#snmp-iso-view">启用 SNMP iso view</a></h4>
<p>默认情况下 SNMP 会缺少一些标准的 MIB（比如 LLDP），可以打开 iso view：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../devops/2021/03/12/switch-config/#__codelineno-8-1"></a>[HUAWEI]snmp-agent mib-view included iso-view iso
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../devops/2021/03/12/switch-config/#__codelineno-8-2"></a>Warning: This command may cause confliction in netconf status. Continue? [Y/N]:y
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../devops/2021/03/12/switch-config/#__codelineno-8-3"></a>[HUAWEI]snmp-agent community read [COMMUNITY NAME] mib-view iso-view
</span></code></pre></div>
<h4 id="arp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#arp">查看 ARP 表</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../devops/2021/03/12/switch-config/#__codelineno-9-1"></a>[HUAWEI]display arp
</span></code></pre></div>
<h4 id="arping"><a class="toclink" href="../../devops/2021/03/12/switch-config/#arping">ARPING</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../devops/2021/03/12/switch-config/#__codelineno-10-1"></a>[HUAWEI]arp send-packet X.X.X.X ffff-ffff-ffff interface Vlanif VLAN
</span></code></pre></div>
<h4 id="stp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#stp">启用 STP 协议</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../devops/2021/03/12/switch-config/#__codelineno-11-1"></a>[HUAWEI]stp enable
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../devops/2021/03/12/switch-config/#__codelineno-11-2"></a>[HUAWEI]stp mode vbst
</span></code></pre></div>
<h4 id="ntp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#ntp">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../devops/2021/03/12/switch-config/#__codelineno-12-1"></a>[HUAWEI]ntp-service unicast-server x.x.x.x
</span></code></pre></div>
<h4 id="syslog"><a class="toclink" href="../../devops/2021/03/12/switch-config/#syslog">设置远程 syslog 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../devops/2021/03/12/switch-config/#__codelineno-13-1"></a>[HUAWEI]info-center loghost x.x.x.x
</span></code></pre></div>
<h4 id="lacp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#lacp">设置 LACP 链路聚合</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../devops/2021/03/12/switch-config/#__codelineno-14-1"></a>[HUAWEI-XGigabitEthernet0/0/1]eth-trunk 1
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="../../devops/2021/03/12/switch-config/#__codelineno-14-2"></a>[HUAWEI-XGigabitEthernet0/0/2]eth-trunk 1
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="../../devops/2021/03/12/switch-config/#__codelineno-14-3"></a>[HUAWEI]interface Eth-Trunk 1
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="../../devops/2021/03/12/switch-config/#__codelineno-14-4"></a>[HUAWEI-Eth-Trunk1]mode lacp
</span></code></pre></div>
<h3 id="dell"><a class="toclink" href="../../devops/2021/03/12/switch-config/#dell">DELL</a></h3>
<p>测试型号：N3048</p>
<h4 id="_6"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_6">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../devops/2021/03/12/switch-config/#__codelineno-15-1"></a>console#copy running-config startup-config
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../devops/2021/03/12/switch-config/#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="../../devops/2021/03/12/switch-config/#__codelineno-15-3"></a>This operation may take few minutes.
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="../../devops/2021/03/12/switch-config/#__codelineno-15-4"></a>Management interfaces will not be available during this time.
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="../../devops/2021/03/12/switch-config/#__codelineno-15-5"></a>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="../../devops/2021/03/12/switch-config/#__codelineno-15-6"></a>Are you sure you want to save? (y/n) y
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="../../devops/2021/03/12/switch-config/#__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="../../devops/2021/03/12/switch-config/#__codelineno-15-8"></a>Configuration Saved!
</span></code></pre></div>
<h4 id="_7"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_7">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../devops/2021/03/12/switch-config/#__codelineno-16-1"></a>console&gt;enable
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="../../devops/2021/03/12/switch-config/#__codelineno-16-2"></a>console# configure
</span></code></pre></div>
<h4 id="_8"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_8">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="../../devops/2021/03/12/switch-config/#__codelineno-17-1"></a>console# show running-config
</span></code></pre></div>
<h4 id="lldp_2"><a class="toclink" href="../../devops/2021/03/12/switch-config/#lldp_2">查看 LLDP 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="../../devops/2021/03/12/switch-config/#__codelineno-18-1"></a>console#show lldp remote-device all
</span></code></pre></div>
<h4 id="vlan-trunk"><a class="toclink" href="../../devops/2021/03/12/switch-config/#vlan-trunk">VLAN Trunk 配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="../../devops/2021/03/12/switch-config/#__codelineno-19-1"></a>console(config)#interface Gi1/0/1
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="../../devops/2021/03/12/switch-config/#__codelineno-19-2"></a>console(config-if-Gi1/0/1)#switchport mode trunk
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="../../devops/2021/03/12/switch-config/#__codelineno-19-3"></a>console(config-if-Gi1/0/1)#switchport trunk allowed vlan xxx,xxx-xxx
</span></code></pre></div>
<h4 id="vlan-access"><a class="toclink" href="../../devops/2021/03/12/switch-config/#vlan-access">VLAN Access 配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="../../devops/2021/03/12/switch-config/#__codelineno-20-1"></a>console(config)#interface Gi1/0/1
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="../../devops/2021/03/12/switch-config/#__codelineno-20-2"></a>console(config-if-Gi1/0/1)#switchport mode access
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="../../devops/2021/03/12/switch-config/#__codelineno-20-3"></a>console(config-if-Gi1/0/1)#switchport access vlan xxx
</span></code></pre></div>
<h4 id="vlan"><a class="toclink" href="../../devops/2021/03/12/switch-config/#vlan">查看 VLAN 配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="../../devops/2021/03/12/switch-config/#__codelineno-21-1"></a>console#show vlan
</span></code></pre></div>
<h4 id="interface"><a class="toclink" href="../../devops/2021/03/12/switch-config/#interface">批量配置 interface</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="../../devops/2021/03/12/switch-config/#__codelineno-22-1"></a>console(config)#interface range Gi1/0/1-4
</span></code></pre></div>
<h4 id="ssh"><a class="toclink" href="../../devops/2021/03/12/switch-config/#ssh">启用 SSH 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="../../devops/2021/03/12/switch-config/#__codelineno-23-1"></a>console(config)#crypto key generate rsa
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="../../devops/2021/03/12/switch-config/#__codelineno-23-2"></a>console(config)#crypto key generate dsa
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="../../devops/2021/03/12/switch-config/#__codelineno-23-3"></a>console(config)#ip ssh server
</span></code></pre></div>
<h4 id="cdpdell-isdp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#cdpdell-isdp">启用 CDP(DELL 称之为 ISDP)</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="../../devops/2021/03/12/switch-config/#__codelineno-24-1"></a>console(config)#isdp enable
</span></code></pre></div>
<h4 id="snmpv1-community_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#snmpv1-community_1">启用只读 SNMPv1 community</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="../../devops/2021/03/12/switch-config/#__codelineno-25-1"></a>console(config)#snmp-server community [COMMUNITY NAME] ro
</span></code></pre></div>
<h4 id="ntp_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#ntp_1">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="../../devops/2021/03/12/switch-config/#__codelineno-26-1"></a>console(config)#sntp unicast client enable
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="../../devops/2021/03/12/switch-config/#__codelineno-26-2"></a>console(config)#sntp server x.x.x.x
</span></code></pre></div>
<h4 id="ntp_2"><a class="toclink" href="../../devops/2021/03/12/switch-config/#ntp_2">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="../../devops/2021/03/12/switch-config/#__codelineno-27-1"></a>console(config)#sntp unicast client enable
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="../../devops/2021/03/12/switch-config/#__codelineno-27-2"></a>console(config)#sntp server x.x.x.x
</span></code></pre></div>
<h4 id="stp_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#stp_1">设置 STP 协议</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="../../devops/2021/03/12/switch-config/#__codelineno-28-1"></a>console(config)#spanning-tree mode rapid-pvst
</span></code></pre></div>
<h3 id="h3c"><a class="toclink" href="../../devops/2021/03/12/switch-config/#h3c">H3C</a></h3>
<h4 id="_9"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_9">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="../../devops/2021/03/12/switch-config/#__codelineno-29-1"></a>&lt;switch&gt;system-view
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="../../devops/2021/03/12/switch-config/#__codelineno-29-2"></a>System View: return to User View with Ctrl+Z.
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="../../devops/2021/03/12/switch-config/#__codelineno-29-3"></a>[switch]
</span></code></pre></div>
<h4 id="_10"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_10">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="../../devops/2021/03/12/switch-config/#__codelineno-30-1"></a>[switch]display current-configuration
</span></code></pre></div>
<h4 id="lldp_3"><a class="toclink" href="../../devops/2021/03/12/switch-config/#lldp_3">查看 lldp 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="../../devops/2021/03/12/switch-config/#__codelineno-31-1"></a>[switch]display lldp neighbor-information
</span></code></pre></div>
<h4 id="_11"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_11">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="../../devops/2021/03/12/switch-config/#__codelineno-32-1"></a>[switch]save
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="../../devops/2021/03/12/switch-config/#__codelineno-32-2"></a>The current configuration will be written to the device. Are you sure? [Y/N]:y
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="../../devops/2021/03/12/switch-config/#__codelineno-32-3"></a>Please input the file name(*.cfg)[flash:/startup.cfg]
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="../../devops/2021/03/12/switch-config/#__codelineno-32-4"></a>(To leave the existing filename unchanged, press the enter key):y
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="../../devops/2021/03/12/switch-config/#__codelineno-32-5"></a>The file name is invalid(does not end with .cfg).
</span></code></pre></div>
<h4 id="interface_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#interface_1">批量配置 interface</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="../../devops/2021/03/12/switch-config/#__codelineno-33-1"></a>[switch]interface range GigabitEthernet 1/0/1 to GigabitEthernet 1/0/24
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="../../devops/2021/03/12/switch-config/#__codelineno-33-2"></a>[switch-if-range]
</span></code></pre></div>
<h4 id="mac"><a class="toclink" href="../../devops/2021/03/12/switch-config/#mac">查看 MAC 地址表</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="../../devops/2021/03/12/switch-config/#__codelineno-34-1"></a>[switch]show mac-address
</span></code></pre></div>
<h4 id="lldp-cdp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#lldp-cdp">打开 LLDP 和 CDP</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="../../devops/2021/03/12/switch-config/#__codelineno-35-1"></a>[switch]lldp global enable
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="../../devops/2021/03/12/switch-config/#__codelineno-35-2"></a>[switch]lldp compliance cdp
</span></code></pre></div>
<h3 id="mellanox"><a class="toclink" href="../../devops/2021/03/12/switch-config/#mellanox">Mellanox</a></h3>
<h4 id="_12"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_12">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="../../devops/2021/03/12/switch-config/#__codelineno-36-1"></a>switch &gt; enable
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="../../devops/2021/03/12/switch-config/#__codelineno-36-2"></a>switch # configure terminal
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="../../devops/2021/03/12/switch-config/#__codelineno-36-3"></a>switch (config) #
</span></code></pre></div>
<h4 id="_13"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_13">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="../../devops/2021/03/12/switch-config/#__codelineno-37-1"></a>switch (config) # show running-config
</span></code></pre></div>
<h4 id="interface_2"><a class="toclink" href="../../devops/2021/03/12/switch-config/#interface_2">查看 interface 状态</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="../../devops/2021/03/12/switch-config/#__codelineno-38-1"></a>switch (config) # show interfaces brief
</span></code></pre></div>
<h4 id="_14"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_14">查看以太网端口状态</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="../../devops/2021/03/12/switch-config/#__codelineno-39-1"></a>switch (config) # show interfaces ethernet status
</span></code></pre></div>
<h4 id="lldp_4"><a class="toclink" href="../../devops/2021/03/12/switch-config/#lldp_4">查看 lldp 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="../../devops/2021/03/12/switch-config/#__codelineno-40-1"></a>switch (config) # show lldp remote
</span></code></pre></div>
<h4 id="_15"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_15">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="../../devops/2021/03/12/switch-config/#__codelineno-41-1"></a>switch (config) # configuration write
</span></code></pre></div>
<h4 id="interface_3"><a class="toclink" href="../../devops/2021/03/12/switch-config/#interface_3">批量配置 interface</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="../../devops/2021/03/12/switch-config/#__codelineno-42-1"></a>switch (config) # interface ethernet 1/1/1-1/1/4
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="../../devops/2021/03/12/switch-config/#__codelineno-42-2"></a>switch (config interface ethernet 1/1/1-1/1/4) #
</span></code></pre></div>
<h4 id="mac_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#mac_1">查看 MAC 地址表</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="../../devops/2021/03/12/switch-config/#__codelineno-43-1"></a>switch (config) # show mac-address-table
</span></code></pre></div>
<h4 id="_16"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_16">查看链路聚合状态</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="../../devops/2021/03/12/switch-config/#__codelineno-44-1"></a>switch (config) # show interfaces port-channel summary
</span></code></pre></div>
<h4 id="sfp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#sfp">把拆分的四个 SFP 口恢复成一个</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="../../devops/2021/03/12/switch-config/#__codelineno-45-1"></a>switch (config interface ethernet 1/1/1) # module-type qsfp 
</span></code></pre></div>
<h4 id="qsfp"><a class="toclink" href="../../devops/2021/03/12/switch-config/#qsfp">把一个 QSFP 口拆分成四个</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="../../devops/2021/03/12/switch-config/#__codelineno-46-1"></a>switch (config interface ethernet 1/1) # shutdown
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="../../devops/2021/03/12/switch-config/#__codelineno-46-2"></a>switch (config interface ethernet 1/1) # module-type qsfp-split-4
</span></code></pre></div>
<h4 id="_17"><a class="toclink" href="../../devops/2021/03/12/switch-config/#_17">设置链路聚合</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="../../devops/2021/03/12/switch-config/#__codelineno-47-1"></a>switch (config interface ethernet 1/1) # channel-group 1 mode active
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="../../devops/2021/03/12/switch-config/#__codelineno-47-2"></a>switch (config interface ethernet 1/2) # channel-group 1 mode active
</span></code></pre></div>
<p>模式可以选择：active(LACP)/passive(LACP)/on(Static)</p>
<h4 id="stp_2"><a class="toclink" href="../../devops/2021/03/12/switch-config/#stp_2">设置 STP 协议</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="../../devops/2021/03/12/switch-config/#__codelineno-48-1"></a>switch (config) # spanning-tree mode rpvst
</span></code></pre></div>
<h4 id="syslog_1"><a class="toclink" href="../../devops/2021/03/12/switch-config/#syslog_1">设置远程 syslog 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="../../devops/2021/03/12/switch-config/#__codelineno-49-1"></a>switch (config) # logging x.x.x.x
</span></code></pre></div>
<h4 id="ntp_3"><a class="toclink" href="../../devops/2021/03/12/switch-config/#ntp_3">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="../../devops/2021/03/12/switch-config/#__codelineno-50-1"></a>switch (config) # ntp server x.x.x.x
</span></code></pre></div>
<h3 id="cisco"><a class="toclink" href="../../devops/2021/03/12/switch-config/#cisco">Cisco</a></h3>
<h4 id="ntp_4"><a class="toclink" href="../../devops/2021/03/12/switch-config/#ntp_4">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="../../devops/2021/03/12/switch-config/#__codelineno-51-1"></a>## ntp server x.x.x.x
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../devops/2021/03/12/switch-config/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-08 00:00:00">2021年3月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="pcb"><a class="toclink" href="../../hardware/2021/03/08/pcb-notes/">PCB 笔记</a></h2>
<p>记录一下在学习画板子过程中学到的心得。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/03/08/pcb-notes/#_1">工具</a></h3>
<p>目前使用过 <a href="https://kicad.org/">KiCad</a> 和 <a href="https://lceda.cn/">lceda</a>：</p>
<ul>
<li>KiCad: 开源软件，跨平台。</li>
<li>lceda：在线编辑，不需要安装，和 lcsc 有深度集成。</li>
</ul>
<p>项目 <a href="https://github.com/jiegec/HT42B534USB2UART">jiegec/HT42B534USB2UART</a> 采用的是 KiCad 5 编写的。目前正在做的另一个项目采用 lceda</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/03/08/pcb-notes/#_2">流程</a></h3>
<ol>
<li>选择所需要使用的芯片，查找芯片的 datasheet。</li>
<li>寻找采用了芯片的一些设计，特别是看 schematic。</li>
<li>按照 datasheet 里面推荐的电路，或者是其他人的设计，画自己需要的 schematic。</li>
<li>设置好各个元件的 footprint，然后转到 PCB 设计。</li>
<li>在 PCB 里面布线，生成 Gerber 等文件。</li>
<li>把 Gerber 给到生产商（比如 jlc），交付生产。</li>
<li>如果是自己焊接，则需要购买元件，比如从 lcsc 购买。</li>
<li>收到 PCB 和元件后，自己按照 BOM 和 schematic 焊接各个元件。</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../hardware/2021/03/08/pcb-notes/#_3">笔记</a></h3>
<ol>
<li>对于一些连接很多元件的信号，比如 GND，可以留作铺铜解决。也就是说，先不管 GND，把其他所有的信号都接好以后，再在顶层铺铜；如果还是有没有连接上的 GND，可以通过过孔（Via）走到底层，在底层再铺一层铜。</li>
<li>对于外部供电的 VCC 和 GND，在 KiCad 中需要用 PWR_FLAG 标记一下。</li>
<li>在 KiCad 中设计 PCB 前，要把生产商的工艺参数设置好，不然画了也要重画。</li>
<li>lceda 在选择元件的时候，可以直接从 lcsc 里选择，这样可以保证封装和商品可以对得上，不需要手动进行匹配。</li>
<li>如果要用 jlc 的 SMT 贴片，先在 <a href="https://www.jlc.com/portal/smtComponentList.html">SMT 元件列表</a> 里搜索所需要的元件；推荐用基本库，如果用其他库，则要加钱；选好元件以后，用元件编号去 lceda 里搜索并添加到 schematic。</li>
<li>对于涉及模拟信号的设计，比如音频，需要特别注意模拟信号的电和地都是单独的：<code>AVCC</code> 和 <code>AGND</code>。所以要特别注意 datasheet 里面不同的地的表示方法。最后，再用磁珠把 <code>VCC</code> 和 <code>AVCC</code>、<code>GND</code> 和 <code>AGND</code> 分别连接起来就可以了。可以参考 <a href="https://wiki.bu.ost.ch/infoportal/_media/fpga/cyclone_iv/de2_115_schematic.pdf">DE2 板子中第 19 页的音频部分设计</a> 和 <a href="https://www.analog.com/en/analog-dialogue/articles/staying-well-grounded.html">Staying well grounded</a>。</li>
<li>在 schematic 里经常会出现在电源附近的电容，那么，在 PCB 中，也尽量把这些电容放在对应的电源的旁边。</li>
<li>耳机插座里面，一般分三种组成部件：Tip，Ring，Sleeve。只有两段的是 TS，三段的是 TRS，四段的是 TRRS。TS 是单声道，T 是声音，S 是地。TRS 是双声道，T 是左声道（或者单声道），R 是右声道，S 是地。TRRS 则是双声道加录音。一般来说，LINE IN 是双声道，MIC IN 是单声道，它们的阻抗也不同；LINE OUT 和 HEADPHONE OUT 都是双声道，但 HEADPHONE OUT 经过了额外的放大器。</li>
<li>遇到一个 SPI 协议没有 <code>SPI_MISO</code> 引脚的芯片，可能说明它是 write-only 的。</li>
<li>手焊的基本元件，一般用 0603 加一些 Padding 的封装；SMT 的话，则建议用 0402 封装。</li>
<li>I2C 的信号线一般需要加一个几 K 欧姆的上拉电阻到 VCC。</li>
</ol>
<p>JLC SMT 的基础库不需要换料费，如何寻找<a href="https://www.jlcsmt.com/lcsc/basic">基础库</a>中的元件：</p>
<ol>
<li>电阻品牌是 UNI-ROYAL，型号命名规则是：<ol>
<li>封装：0603/0402</li>
<li>功率：WA/WG/W8</li>
<li>误差：F(1%)</li>
<li>阻值：三位整数 + 一位 exp（J 表示 -1，K 表示 -2，L 表示 -3），例如 2002 表示 <code>200*10^2=20k</code>，1003 表示 <code>100*10^3=100k</code>，3300 表示 <code>330*10^0=330</code>，330J 表示 <code>330*10^-1=33</code>，330K 表示 <code>330*10^-2=3.3</code>
例子：要找 0402 封装的 10k 欧电阻，搜索 0402WGF1003；要找 0603 封装的 33 欧电阻，搜索 0603WAF330。</li>
</ol>
</li>
<li>电容品牌有风华/三星/国巨，三星的电容型号命名规则是：<ol>
<li>封装：05(0402)/10(0603)</li>
<li>字母：A/B/C</li>
<li>电容：两位整数 + 一位 exp，单位是 pF，例如 105 表示 <code>10*10^5pF=10^6pF=1uF</code>，104 表示 <code>10*10^4pF=10^5pF=0.1uF</code>
例子：要找 0402 封装的 100nF 电容，搜索 CL05B104；要找 0603 封装的 1uF 电容，搜索 CL10A105。也可以只搜电容的数字部分，可以找到更多品牌。</li>
</ol>
</li>
</ol>
<h3 id="_4"><a class="toclink" href="../../hardware/2021/03/08/pcb-notes/#_4">阻抗匹配</a></h3>
<p>在传输线上，如果出现阻抗变化，就会导致信号出现反射，质量变差。因此，需要保证传输线的两端和传输线整个过程的阻抗一致。</p>
<p>阻抗设置为多少，一般要看协议的规定。确定好协议定义的阻抗以后，需要查看信号两端的芯片内部的阻抗，如果和协议不一致，需要额外添加电阻，并且电阻要尽量放在接近芯片的位置上。由于传输线在 PCB 上，所以和 PCB 厂商的工艺有关，需要去厂商的阻抗计算器上进行计算，例如 <a href="https://tools.jlc.com/jlcTools/index.html#/impedanceCalculatenew">jlc 阻抗计算器</a>。涉及到的参数有：</p>
<ol>
<li>板子层数：PCB 层数，最简单的正反面就是 2 层</li>
<li>成品厚度：整个 PCB 加起来的厚度，例如 1.6mm</li>
<li>内层铜厚：夹在内部的 PCB 的铜的厚度，例如 0.5 oz，就是 1.37/2=0.685 mil</li>
<li>外层铜厚：PCB 上下暴露在外面的两层的铜的厚度，常见 1 oz=1.37 mil</li>
<li>需求阻抗：协议所要求的阻抗，例如单端 50 欧姆（SDIO），差分 90 欧姆（USB）</li>
<li>阻抗模式：传输线的连接方式，见下（图源 KiCad）<ol>
<li>单端阻抗（Microstrip Line）：一根线传输信号，地线在另一个平面，图中上面的长方形就是传输线，底部就是地平面
<img alt="" src="/images/microstrip_line.png" /></li>
<li>差分阻抗（Coupled Microstrip Line）：差分线传输信号，地线在另一个平面，图中上方两个长方形就是差分传输线，底部是地平面
<img alt="" src="/images/couple_microstrip_line.png" /></li>
<li>共面单端：一根线传输信号，周围就是地平面
<img alt="" src="/images/coplanar_wave_guide.png" />
<img alt="" src="/images/coplanar_wave_guide_ground_plane.png" /></li>
<li>共面差分：差分线传输信号，周围就是地平面</li>
</ol>
</li>
<li>阻抗层：传输线所在的层</li>
<li>参考层：地线所在的层</li>
</ol>
<p>由于双层 PCB 的两层铜之间距离比较远（例如 57.68 mil），如果采用单端阻抗，那么需要比较大的线宽，例如用 jlc 阻抗计算器，50 欧姆阻抗需要 106.68 mil 的线宽。如果采用四层 PCB，最上面两层之间距离缩小了很多（例如 7.99 mil），此时即使用单端阻抗，用 jlc 计算得出只需要 13.2 mil 的线宽。所以双层 PCB 更适合使用共面单端的方式，此时传输线和地线放在了同一个平面，距离比较小，就不需要那么大的线宽。</p>
<p>这里的单位：1 mil = 0.0254 mm，1 inch = 1000 mil = 0.0254 m，1 oz = 1.37 mil = 0.0348 mm</p>

    <nav class="md-post__action">
      <a href="../../hardware/2021/03/08/pcb-notes/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-03 00:00:00">2021年3月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="idrac"><a class="toclink" href="../../system/2021/03/03/idrac-versions/">iDRAC 各版本</a></h2>
<h3 id="idrac_1"><a class="toclink" href="../../system/2021/03/03/idrac-versions/#idrac_1">iDRAC 版本</a></h3>
<p>目前接触到的 iDRAC 版本有：7 8 9。一些常见的服务器型号和 iDRAC 版本对应关系：</p>
<ul>
<li>7: PowerEdge R320, PowerEdge R720</li>
<li>8: <a href="https://www.dell.com/support/home/en-us/product-support/product/poweredge-r730xd/drivers">PowerEdge R730xd</a>，PowerEdge R630，PowerEdge R730，PowerEdge C4130</li>
<li>9: <a href="https://www.dell.com/support/home/en-us/product-support/product/poweredge-r7425/drivers">PowerEdge R7425</a></li>
</ul>
<p>基本上，如果是 PowerEdge R 什么的，就看第二位数字，就可以推断出版本号了。</p>
<p>下面列举了一下可能会用到的版本。</p>
<h3 id="idrac-7"><a class="toclink" href="../../system/2021/03/03/idrac-versions/#idrac-7">iDRAC 7</a></h3>
<p><a href="https://www.dell.com/support/kbdoc/en-us/000175831/support-for-integrated-dell-remote-access-controller-7-idrac7">iDRAC 7 在 2020 年 2 月停止更新了</a>，最新版本是 2.65.65.65。</p>
<p>升级路线参考：<a href="https://www.reddit.com/r/homelab/comments/abuc09/psa_read_this_before_you_upgrade_your_firmware_on/">Reddit</a>。</p>
<ul>
<li>1.66.65 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=3f4wv">下载页面</a>，2014 年 12 月版本。</li>
<li>2.10.10.10 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverId=Y5K20">下载页面</a>，2015 年 4 月版本。</li>
<li>2.65.65.65 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=0ghf4">下载页面</a>，2020 年 3 月版本，添加了 HSTS。</li>
</ul>
<h3 id="idrac-8"><a class="toclink" href="../../system/2021/03/03/idrac-versions/#idrac-8">iDRAC 8</a></h3>
<ul>
<li>2.10.10.10 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=fm1pc">下载页面</a>，2015 年 3 月版本。</li>
<li>2.30.30.30: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=5gchc">下载页面</a>，2016 年 2 月版本，添加了 HTML5 virtual console 支持。</li>
<li>2.60.60.60: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=cx8n2">下载页面</a>，2018 年 6 月版本，添加了 virtual media over HTTP 支持。</li>
<li>2.70.70.70: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dnh17">下载页面</a>，2019 年 10 月版本。</li>
<li>2.75.75.75: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=krcxx">下载页面</a>，2020 年 6 月版本。</li>
<li>2.75.100.75: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dpv0r">下载页面</a>，2021 年 1 月版本。</li>
</ul>
<h3 id="idrac-9"><a class="toclink" href="../../system/2021/03/03/idrac-versions/#idrac-9">iDRAC 9</a></h3>
<ul>
<li>4.00.00.00: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=4jcpk">下载页面</a>，2019 年 12 月版本。LLDP 连接视图。</li>
<li>4.22.00.00: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=9f2tg">下载页面</a>，2020 年 7 月版本。</li>
<li>4.40.00.00: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=62gw1">下载页面</a>，2020 年 12 月版本，下一代的 iDRAC virtual console 和 virtual media，支持 Infiniband。</li>
</ul>

    <nav class="md-post__action">
      <a href="../../system/2021/03/03/idrac-versions/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-15 00:00:00">2021年2月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sssd-ldap"><a class="toclink" href="../../software/2021/02/15/sssd-ldap/">使用 SSSD 的 LDAP 认证</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/02/15/sssd-ldap/#_1">前言</a></h3>
<p>最近在研究替换一个老的用户系统，于是顺便学习了一下 LDAP，还有 SSSD。LDAP 是一个目录协议，顺带的，因为用户信息也可以存在里面，所以也就成了一个常见的用户认证协议。SSSD 就是一个 daemon，把系统的 NSS PAM 的机制和 LDAP 连接起来。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/02/15/sssd-ldap/#_2">配置</a></h3>
<p>其实很简单，安装 sssd 并且配置即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>sssd
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>/etc/sssd/sssd.conf
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-3"></a><span class="c1">## file content:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-4"></a><span class="o">[</span>sssd<span class="o">]</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-5"></a><span class="nv">config_file_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-6"></a><span class="nv">services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nss,pam
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-7"></a><span class="nv">domains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LDAP
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-9"></a><span class="o">[</span>domain/LDAP<span class="o">]</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-10"></a><span class="nv">cache_credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-11"></a><span class="nv">enumerate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-12"></a><span class="nv">entry_cache_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-13"></a><span class="nv">ldap_network_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-15"></a><span class="nv">id_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-16"></a><span class="nv">auth_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-17"></a><span class="nv">chpass_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-19"></a><span class="nv">ldap_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap://127.0.0.1/
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-20"></a><span class="nv">ldap_chpass_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap://127.0.0.1/
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-21"></a><span class="nv">ldap_search_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-22"></a><span class="nv">ldap_default_bind_dn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cn</span><span class="o">=</span>localhost,ou<span class="o">=</span>machines,dc<span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-23"></a><span class="nv">ldap_default_authtok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>REDACTED
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../software/2021/02/15/sssd-ldap/#__codelineno-0-24"></a>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>sssd
</span></code></pre></div>
<p>一些字段需要按照实际情况编写，请参考<a href="https://manpages.debian.org/testing/sssd-common/sssd.conf.5.en.html">sssd.conf</a> 和 <a href="https://manpages.debian.org/testing/sssd-ldap/sssd-ldap.5.en.html">sssd-ldap</a>。</p>
<h3 id="_3"><a class="toclink" href="../../software/2021/02/15/sssd-ldap/#_3">协议</a></h3>
<p>那么，LDAP 里面的用户是如何和 Linux 里的用户对应起来的呢？可以看到，SSSD 会查询 posixAccount：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2021/02/15/sssd-ldap/#__codelineno-1-1"></a>(&amp;(objectclass=posixAccount)(uid=*)(uidNumber=*)(gidNumber=*))
</span></code></pre></div>
<p>然后，可以查到 <a href="https://ldapwiki.com/wiki/PosixAccount">posixAccount 的 schema</a>，里面可以见到对应 <code>/etc/passwd</code> 的各个字段。相应的，也有 <code>shadowAccount</code> 对应 <code>/etc/shadow</code>。</p>
<p>按照要求配好以后（建议用 ldapvi 工具），就可以用 <code>getent passwd</code> 看到新增的用户了。</p>
<p>上面的部分是通过 NSS 接口来查询的，除了用户以外，还有其他的一些 NIS 信息可以通过 LDAP 查询。此外，如果要登录的话，则是用 PAM 认证，SSSD 则会把 PAM 认证转换成 LDAP 的 Bind：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2021/02/15/sssd-ldap/#__codelineno-2-1"></a>$<span class="w"> </span>su<span class="w"> </span><span class="nb">test</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2021/02/15/sssd-ldap/#__codelineno-2-2"></a>Password:
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2021/02/15/sssd-ldap/#__codelineno-2-3"></a><span class="c1">## sssd: bind to dn of test user with password</span>
</span></code></pre></div>
<p>如果 Bind 成功，则认为登录成功；否则就是登录失败。</p>
<p>如果用户要修改密码，SSSD 默认用的是 <a href="https://tools.ietf.org/html/rfc3062">RFC3062 LDAP Password Modify Extended Operation</a> 的方式；如果服务器不支持的话，可以按照 <a href="https://sssd.io/docs/design_pages/chpass_without_exop.html">文档</a> 使用 ldap modify 方式来修改密码。</p>
<p>SSD 还可以<a href="https://linux.die.net/man/5/sssd-sudo">配置 sudo 支持</a>，也是用类似的方法，添加 objectClass=sudoRole 的目录项即可。可以参考 <a href="https://linux.die.net/man/5/sudoers.ldap">man sudoers.ldap</a> 编写对应的目录项。</p>
<p>对于 SSH 配置，可以参考 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/openssh-sssd">RedHat 的文档</a>，和参考 <a href="https://www.systutorials.com/docs/linux/man/1-sss_ssh_authorizedkeys/">man sss_ssh_authorizedkeys</a> 配置 authorized keys 命令。然后，给用户添加 <code>sshPublicKey</code> 属性即可，内容与 <code>~/.ssh/id_*.pub</code> 一致。</p>
<h3 id="rfc"><a class="toclink" href="../../software/2021/02/15/sssd-ldap/#rfc">相关 RFC</a></h3>
<p><a href="https://ldap.com/ldap-related-rfcs/">LDAP-Related RFCs</a></p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc2307">RFC2307 An Approach for Using LDAP as a Network Information Service</a></li>
<li><a href="https://tools.ietf.org/html/rfc3062">RFC3062 LDAP Password Modify Extended Operation</a></li>
<li><a href="https://tools.ietf.org/html/rfc4511">RFC4511 Lightweight Directory Access Protocol (LDAP): The Protocol</a></li>
<li><a href="https://tools.ietf.org/html/rfc4512">RFC4512 Lightweight Directory Access Protocol (LDAP): Directory Information Models</a></li>
<li><a href="https://tools.ietf.org/html/rfc4513">RFC4513 Lightweight Directory Access Protocol (LDAP): Authentication Methods and Security Mechanisms</a></li>
<li><a href="https://tools.ietf.org/html/rfc4517">RFC4517 Lightweight Directory Access Protocol (LDAP): Syntaxes and Matching Rules</a></li>
<li><a href="https://tools.ietf.org/html/rfc4519">RFC4519 Lightweight Directory Access Protocol (LDAP): Schema for User Applications</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../software/2021/02/15/sssd-ldap/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-09 00:00:00">2021年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="big-surm1-latex"><a class="toclink" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/">在 Big Sur(M1) 上解决 LaTeX 找不到楷体字体的问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#_1">背景</a></h3>
<p>最近在尝试移植 <a href="https://github.com/MiKTeX/miktex/pull/710">MiKTeX 到 Apple Silicon 上</a>，添加了一些 patch 以后就可以工作了，但遇到了新的问题，即找不到 KaiTi</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-0-1"></a>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/tex/latex/ctex/fontset/ctex-fontset-macnew.def:99:
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-0-2"></a><span class="w">   </span>Package<span class="w"> </span>fontspec<span class="w"> </span>Error:
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-0-3"></a><span class="w">      </span>The<span class="w"> </span>font<span class="w"> </span><span class="s2">&quot;Kaiti SC&quot;</span><span class="w"> </span>cannot<span class="w"> </span>be<span class="w"> </span>found.
</span></code></pre></div>
<p>用 <code>miktex-fc-list</code> 命令找了一下，确实没有找到：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-1-1"></a>$<span class="w"> </span>/Applications/MiKTeX<span class="se">\ </span>Console.app/Contents/bin/miktex-fc-list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Kaiti
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-1-2"></a><span class="c1">## Nothing</span>
</span></code></pre></div>
<p>上网搜了一下，找到了一个<a href="https://www.jianshu.com/p/8f35c57901e3">解决方案</a>：字体在目录 <code>/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ATS.framework/Versions/A/Support/FontSubsets/Kaiti.ttc</code> 里，所以手动安装一下，就可以让 LaTeX 找到了。但我觉得，与其安装多一份在文件系统里，不如让 LaTeX 去找它。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#_2">解决方法</a></h3>
<p>按照上面的线索，找到了 <code>Kaiti.ttc</code> 所在的路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-2-1"></a>$<span class="w"> </span>fd<span class="w"> </span>Kaiti.ttc
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-2-2"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc
</span></code></pre></div>
<p>可以看到，和上面的路径又不大一样。研究了一下 fontconfig，发现可以用 <code>miktex-fc-conflist</code> 找到配置文件的目录：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-3-1"></a>$<span class="w"> </span>/Applications/MiKTeX<span class="se">\ </span>Console.app/Contents/bin/miktex-fc-conflist
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-3-2"></a>+<span class="w"> </span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/config/fontconfig/config/localfonts2.conf:<span class="w"> </span>No<span class="w"> </span>description
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-3-3"></a>+<span class="w"> </span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/config/fontconfig/config/localfonts.conf:<span class="w"> </span>No<span class="w"> </span>description
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-3-4"></a>...
</span></code></pre></div>
<p>看了下第一个文件（localfonts.conf）：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-3"></a><span class="cm">&lt;!--</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-4"></a><span class="cm">  DO NOT EDIT THIS FILE! It will be replaced when MiKTeX is updated.</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-5"></a><span class="cm">  Instead, edit the configuration file localfonts2.conf.</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-6"></a><span class="cm">--&gt;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-8"></a><span class="nt">&lt;fontconfig&gt;</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-9"></a><span class="nt">&lt;include&gt;</span>localfonts2.conf<span class="nt">&lt;/include&gt;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-10"></a><span class="nt">&lt;dir&gt;</span>/Library/Fonts/<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-11"></a><span class="nt">&lt;dir&gt;</span>/System/Library/Fonts/<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-12"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/type1<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-13"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/opentype<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-14"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/truetype<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-4-15"></a><span class="nt">&lt;/fontconfig&gt;</span>
</span></code></pre></div>
<p>可以看到，我们可以添加路径，不过建议修改的是 <code>localfonts2.conf</code>。按照类似的格式，修改成：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-2"></a><span class="nt">&lt;fontconfig&gt;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-3"></a><span class="nt">&lt;dir&gt;</span>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-4"></a><span class="cm">&lt;!-- REMOVE THIS LINE</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-5"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-6"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-7"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-8"></a><span class="cm">     REMOVE THIS LINE --&gt;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-5-9"></a><span class="nt">&lt;/fontconfig&gt;</span>
</span></code></pre></div>
<p>UPDATE: 新版本 macOS 中，路径建议加上 <code>/System/Library/AssetsV2/com_apple_MobileAsset_Font7</code>：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-6-1"></a><span class="nt">&lt;dir&gt;</span>/System/Library/AssetsV2/com_apple_MobileAsset_Font7<span class="nt">&lt;/dir&gt;</span>
</span></code></pre></div>
<p>这样，就可以找到 Kaiti SC 了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-1"></a>$<span class="w"> </span>miktex-fc-list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Kaiti
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-2"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Regular,標準體,常规体
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-3"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Regular,標準體,常规体
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-4"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Bold,粗體,粗体
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-5"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Bold,粗體,粗体
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-6"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Black,黑體,黑体
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-7"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Black,黑體,黑体
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#__codelineno-7-8"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>STKaiti:style<span class="o">=</span>Regular,標準體,Ordinær,Normal,Normaali,Regolare,レギュラー,일반체,Regulier,Обычный,常规体
</span></code></pre></div>
<p>这样就搞定了，用 LaTeX 找字体的时候也没有出现问题了。</p>
<p>如果你用的是 TeX Live，那么直接把上面的 Kaiti.ttc 路径复制到 <code>~/Library/Fonts</code> 下即可。</p>

    <nav class="md-post__action">
      <a href="../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-09 00:00:00">2021年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="common"><a class="toclink" href="../../software/2021/02/09/common-symbols-linking/">COMMON 符号</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/02/09/common-symbols-linking/#_1">背景</a></h3>
<p>在编译一个程序的时候，遇到了 undefined symbol 的问题。具体情况是这样的：</p>
<ol>
<li>一开始的时候，直接把所有的源代码编译成 <code>.o</code>，再一次性链接，这样不会报错</li>
<li>后来，把一些代码编译成静态库，即把其中一部分源代码编译成 <code>.o</code> 后，用 <code>ar</code> 合并到一个 <code>.a</code> 中，再和其余的 <code>.o</code> 链接在一起，这时候就报错了：</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-0-1"></a>Undefined symbols for architecture arm64:
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-0-2"></a>  &quot;_abcd&quot;, referenced from:
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-0-3"></a>    ...
</span></code></pre></div>
<p>如果换台机器，编译（使用的是 gcc 10.2.0）就没有问题。</p>
<p>而如果去找这个符号存在的 <code>.o</code> 里，是可以找到的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-1-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/path/to/abcd.o
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-1-2"></a><span class="m">0000000000000028</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000008</span><span class="w"> </span>_abcd
</span></code></pre></div>
<p>在合成的静态库 <code>.a</code> 里，也是存在的（一个定义 + 若干个引用）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-2-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/path/to/libabc.a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>abcd
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-2-2"></a><span class="m">0000000000000028</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000008</span><span class="w"> </span>_abcd
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-2-3"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-2-4"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-2-5"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-2-6"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-2-7"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span></code></pre></div>
<p>于是觉得很奇怪，就上网搜了一下，找到了一篇 <a href="https://stackoverflow.com/questions/63665653/different-behavior-between-clang-and-gcc-10-when-linking-to-static-library-conta">StackOverflow</a> 讲了这个问题。解决方案很简单，就是：</p>
<p><strong>编译的时候打开 <code>-fno-common</code> 设置</strong></p>
<p>而 gcc 10 不会出错的原因是，它默认从 <code>-fcommon</code> 改成了 <code>-fno-common</code> 。</p>
<h3 id="common_1"><a class="toclink" href="../../software/2021/02/09/common-symbols-linking/#common_1">COMMON 是什么</a></h3>
<p>这时候，肯定不满足于找到一个解决方案，肯定还是会去找背后的原理。</p>
<p>首先，搜索了一下 COMMON 是什么，找到了 <a href="https://binarydodo.wordpress.com/2016/05/09/investigating-linking-with-common-symbols-in-elf/">Investigating linking with COMMON symbols in ELF</a> 这篇文章。</p>
<p>文章里讲了 COMMON 是做什么的：</p>
<blockquote>
<p>Common symbols are a feature that allow a programmer to 'define' several variables of the same name in different source files.  This is in contrast with the more popular way of doing, where you define a variable once in a source file, and reference it everywhere else in other source files, using extern.  When common symbols are used, the linker will merge all symbols of the same name into a single memory location, the size of which is the largest type of the individual common symbol definitions.  For example, if fileA.c defines an uninitialized 32-bit integer myint, and fileB.c defines an 8-bit char myint, then in the final executable, references to myint from both files will point to the same memory location (common location), and the linker will reserve 32 bits for that location.</p>
</blockquote>
<p>文章里还讲了具体的实现方法：一个没有初始化的全局变量，在 <code>-fcommon</code> 的情况下，会设为 COMMON；如果有初始化，就按照初始化的值预分配到 .bss 或者 .data。链接的时候，如果有多个同名的 symbol，会有一个规则决定最后的 symbol 放到哪里；如果有冲突的话，就是我们熟悉的 <code>multiple definition</code> 错误了。</p>
<p>为啥会有这种需求，多个 variable 同名，不会冲突而且共享内存？又在别的地方看到说法，COMMON 是给 <code>ancient</code> 代码使用的，还有的提到了 FORTRAN。于是去搜了一下，果然，FORTRAN 是问题的关键</p>
<h3 id="fortran-common"><a class="toclink" href="../../software/2021/02/09/common-symbols-linking/#fortran-common">FORTRAN 里面的 COMMON</a></h3>
<p>用关键词很容易可以搜索到讲 <a href="https://www.obliquity.com/computer/fortran/common.html">COMMON BLOCK in FORTRAN 的文章</a>，FORTRAN 里面的 COMMON 是一种通过全局存储隐式传递参数的方法。拿文章里的例子：</p>
<div class="language-fortran highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-1"></a><span class="w">      </span><span class="k">PROGRAM </span><span class="n">MAIN</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-2"></a><span class="w">      </span><span class="kt">INTEGER </span><span class="n">A</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-3"></a><span class="w">      </span><span class="kt">REAL    </span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-4"></a><span class="w">      </span><span class="k">COMMON  </span><span class="n">R</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">F</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-5"></a><span class="w">      </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">14</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-6"></a><span class="w">      </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="mf">9.9</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-7"></a><span class="w">      </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-8"></a><span class="w">      </span><span class="k">CALL </span><span class="n">SUB</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-9"></a><span class="w">      </span><span class="k">END</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-11"></a><span class="k">      SUBROUTINE </span><span class="n">SUB</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-12"></a><span class="w">      </span><span class="kt">INTEGER </span><span class="n">I</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-13"></a><span class="w">      </span><span class="kt">REAL    </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-14"></a><span class="w">      </span><span class="k">COMMON  </span><span class="n">A</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">B</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-3-15"></a><span class="w">      </span><span class="k">END</span>
</span></code></pre></div>
<p>在函数 MAIN 和 SUB 中，都有 COMMON 语句，而 COMMON 后面的变量，就是存储在一个 COMMON 的 symbol 之中，按照顺序映射到 symbol 的内存地址。尝试编译一下上面的代码，然后看一下 symbol：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-1"></a>$<span class="w"> </span>gfortran<span class="w"> </span>-g<span class="w"> </span>-c<span class="w"> </span>test.f<span class="w"> </span>-o<span class="w"> </span>test.o
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-2"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>test.o
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-4"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-6"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-7"></a><span class="m">0000000000000078</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_main
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-8"></a><span class="m">0000000000000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_sub_
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-4-9"></a>000000000000000c<span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>___BLNK__
</span></code></pre></div>
<p>可以看到，出现了一个叫做 <code>___BLNK__</code> 的 COMMON symbol，大小是 16 字节。看一下代码中是如何引用的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-S<span class="w"> </span>--reloc<span class="w"> </span>test.o
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-3"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-5"></a>Disassembly<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>__TEXT,__text:
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-7"></a><span class="m">0000000000000018</span><span class="w"> </span>_MAIN__:
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-8"></a><span class="p">;</span><span class="w">         </span>PROGRAM<span class="w"> </span>MAIN
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-9"></a><span class="w">      </span><span class="m">18</span>:<span class="w"> </span>fd<span class="w"> </span>7b<span class="w"> </span>be<span class="w"> </span>a9<span class="w">                   </span>stp<span class="w"> </span>x29,<span class="w"> </span>x30,<span class="w"> </span><span class="o">[</span>sp,<span class="w"> </span><span class="c1">#-32]!</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-10"></a><span class="w">      </span>1c:<span class="w"> </span>fd<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>mov<span class="w"> </span>x29,<span class="w"> </span>sp
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-11"></a><span class="p">;</span><span class="w">         </span><span class="nv">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-14
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-12"></a><span class="w">      </span><span class="m">20</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-13"></a><span class="w">        </span><span class="m">0000000000000020</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-14"></a><span class="w">      </span><span class="m">24</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-15"></a><span class="w">        </span><span class="m">0000000000000024</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-16"></a><span class="w">      </span><span class="m">28</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">12</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#-14</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-17"></a><span class="w">      </span>2c:<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>b9<span class="w">                   </span>str<span class="w"> </span>w1,<span class="w"> </span><span class="o">[</span>x0,<span class="w"> </span><span class="c1">#4]</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-18"></a><span class="p">;</span><span class="w">         </span><span class="nv">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">99</span>.9
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-19"></a><span class="w">      </span><span class="m">30</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-20"></a><span class="w">        </span><span class="m">0000000000000030</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-21"></a><span class="w">      </span><span class="m">34</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-22"></a><span class="w">        </span><span class="m">0000000000000034</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-23"></a><span class="w">      </span><span class="m">38</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">52</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#52429</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-24"></a><span class="w">      </span>3c:<span class="w"> </span>e1<span class="w"> </span><span class="m">58</span><span class="w"> </span>a8<span class="w"> </span><span class="m">72</span><span class="w">                   </span>movk<span class="w">    </span>w1,<span class="w"> </span><span class="c1">#17095, lsl #16</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-25"></a><span class="w">      </span><span class="m">40</span>:<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">27</span><span class="w"> </span>1e<span class="w">                   </span>fmov<span class="w">    </span>s0,<span class="w"> </span>w1
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-26"></a><span class="w">      </span><span class="m">44</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>bd<span class="w">                   </span>str<span class="w"> </span>s0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-27"></a><span class="p">;</span><span class="w">         </span><span class="nv">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.2
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-28"></a><span class="w">      </span><span class="m">48</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-29"></a><span class="w">        </span><span class="m">0000000000000048</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-30"></a><span class="w">      </span>4c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-31"></a><span class="w">        </span>000000000000004c:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-32"></a><span class="w">      </span><span class="m">50</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">52</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#52429</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-33"></a><span class="w">      </span><span class="m">54</span>:<span class="w"> </span><span class="m">81</span><span class="w"> </span>c9<span class="w"> </span>a7<span class="w"> </span><span class="m">72</span><span class="w">                   </span>movk<span class="w">    </span>w1,<span class="w"> </span><span class="c1">#15948, lsl #16</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-34"></a><span class="w">      </span><span class="m">58</span>:<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">27</span><span class="w"> </span>1e<span class="w">                   </span>fmov<span class="w">    </span>s0,<span class="w"> </span>w1
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-35"></a><span class="w">      </span>5c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">08</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>bd<span class="w">                   </span>str<span class="w"> </span>s0,<span class="w"> </span><span class="o">[</span>x0,<span class="w"> </span><span class="c1">#8]</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-36"></a><span class="p">;</span><span class="w">         </span>CALL<span class="w"> </span>SUB<span class="o">(</span>X,Y<span class="o">)</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-37"></a><span class="w">      </span><span class="m">60</span>:<span class="w"> </span>e1<span class="w"> </span><span class="m">63</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w"> </span>x1,<span class="w"> </span>sp,<span class="w"> </span><span class="c1">#24</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-38"></a><span class="w">      </span><span class="m">64</span>:<span class="w"> </span>e0<span class="w"> </span><span class="m">73</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w"> </span>x0,<span class="w"> </span>sp,<span class="w"> </span><span class="c1">#28</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-39"></a><span class="w">      </span><span class="m">68</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">94</span><span class="w">                   </span>bl<span class="w">  </span><span class="c1">#0 &lt;_MAIN__+0x50&gt;</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-40"></a><span class="w">        </span><span class="m">0000000000000068</span>:<span class="w">  </span>ARM64_RELOC_BRANCH26<span class="w"> </span>_sub_
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-41"></a><span class="p">;</span><span class="w">         </span>END
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-42"></a><span class="w">      </span>6c:<span class="w"> </span>1f<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">03</span><span class="w"> </span>d5<span class="w">                   </span>nop
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-43"></a><span class="w">      </span><span class="m">70</span>:<span class="w"> </span>fd<span class="w"> </span>7b<span class="w"> </span>c2<span class="w"> </span>a8<span class="w">                   </span>ldp<span class="w"> </span>x29,<span class="w"> </span>x30,<span class="w"> </span><span class="o">[</span>sp<span class="o">]</span>,<span class="w"> </span><span class="c1">#32</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-5-44"></a><span class="w">      </span><span class="m">74</span>:<span class="w"> </span>c0<span class="w"> </span><span class="m">03</span><span class="w"> </span>5f<span class="w"> </span>d6<span class="w">                   </span>ret
</span></code></pre></div>
<p>可以看到，在 MAIN 中引用 <code>A</code> 的时候，取的地址是 <code>___BLNK__+4</code>，<code>R</code> 是 <code>___BLNK__+0</code>，<code>F</code> 是 <code>___BLNK__+8</code>。这和代码里的顺序也是一致的。所以在 SUB 中读 A I B 的时候，对应了 MAIN 中的 A R F。通过这种方式，可以在 MAIN 函数里面隐式地给所有函数传递参数。</p>
<p>此外，COMMON 还可以命名，这样就可以区分不同的参数用途：</p>
<div class="language-fortran highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-1"></a><span class="w">        </span><span class="k">PROGRAM </span><span class="n">MAIN</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-2"></a><span class="w">        </span><span class="kt">INTEGER </span><span class="n">A</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-3"></a><span class="w">        </span><span class="kt">REAL    </span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-4"></a><span class="w">        </span><span class="k">COMMON  </span><span class="n">R</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">F</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-5"></a><span class="w">        </span><span class="k">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-6"></a><span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">14</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-7"></a><span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="mf">9.9</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-8"></a><span class="w">        </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-9"></a><span class="w">        </span><span class="k">CALL </span><span class="n">SUB</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-10"></a><span class="w">        </span><span class="k">END</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-12"></a><span class="k">        SUBROUTINE </span><span class="n">SUB</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-13"></a><span class="w">        </span><span class="kt">INTEGER </span><span class="n">I</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-14"></a><span class="w">        </span><span class="kt">REAL    </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-15"></a><span class="w">        </span><span class="k">COMMON  </span><span class="n">A</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">B</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-6-16"></a><span class="w">        </span><span class="k">END</span>
</span></code></pre></div>
<p>代码添加了一行 <code>COMMON /test/</code>，观察一下 symbol：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>test.o
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-3"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-5"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-6"></a><span class="m">0000000000000088</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_main
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-7"></a><span class="m">0000000000000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_sub_
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-8"></a>000000000000000c<span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>___BLNK__
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-7-9"></a><span class="m">0000000000000008</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>_test_
</span></code></pre></div>
<p>和预期的一致：出现了新的 COMMON symbol，对应了 named COMMON Block 里面的变量 X 和 Y。</p>
<p>再看一下汇编里怎么引用的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-1"></a><span class="p">;</span><span class="w">         </span>CALL<span class="w"> </span>SUB<span class="o">(</span>X,Y<span class="o">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-2"></a><span class="w">      </span><span class="m">60</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-3"></a><span class="w">                </span><span class="m">0000000000000060</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>_test_
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-4"></a><span class="w">      </span><span class="m">64</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w">     </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-5"></a><span class="w">                </span><span class="m">0000000000000064</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">       </span>_test_
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-6"></a><span class="w">      </span><span class="m">68</span>:<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w">     </span>x1,<span class="w"> </span>x0,<span class="w"> </span><span class="c1">#4</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-7"></a><span class="w">      </span>6c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-8"></a><span class="w">                </span>000000000000006c:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>_test_
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-9"></a><span class="w">      </span><span class="m">70</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w">     </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-10"></a><span class="w">                </span><span class="m">0000000000000070</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">       </span>_test_
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-11"></a><span class="w">      </span><span class="m">74</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">94</span><span class="w">                   </span>bl<span class="w">      </span><span class="c1">#0 &lt;_MAIN__+0x5c&gt;</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="../../software/2021/02/09/common-symbols-linking/#__codelineno-8-12"></a><span class="w">                </span><span class="m">0000000000000074</span>:<span class="w">  </span>ARM64_RELOC_BRANCH26<span class="w"> </span>_sub_
</span></code></pre></div>
<p>可以看到，第一个参数（x0）为 <code>_test_</code>，第二个参数（x1）为 <code>_test_+4</code>，和预期也是一样的。</p>
<p>读到这里，就可以理解为啥有 COMMON symbol 了。可能是为了让 C 代码和 FORTRAN 代码可以互操作 COMMON symbol，就有了这么一出。也可能有的 C 库确实用了类似的方法来实现某些功能。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/02/09/common-symbols-linking/#_2">解决方案</a></h3>
<p>但是，这种用法在现在来看是不推荐的，建议还是该 extern 就 extern，另外，在编译静态库的时候，记得加上 <code>-fno-common</code>。</p>

    <nav class="md-post__action">
      <a href="../../software/2021/02/09/common-symbols-linking/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-01-26 00:00:00">2021年1月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="skid-buffer"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/">Skid Buffer</a></h2>
<h3 id="skid-buffer_1"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#skid-buffer_1">Skid buffer</a></h3>
<p>Skid buffer 指的就是，对于 valid + ready 的握手信号，用空间（更多的逻辑）来换取时间（更好的时序）的一个硬件模块。</p>
<p>简单来说，背景就是，为了解决 valid 和 ready 信号在数据流水线上一路经过组合逻辑导致的时序问题，在中途加上一些寄存器来阻隔。当然了，代价就是延迟和面积，不过吞吐量还是需要保持的。</p>
<p>由于需求的不同，Skid buffer 也有不同的实现。目前，找到了四个实现，实现上有所不同，特性也不大一样。</p>
<h4 id="_1"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#_1">统一约定</a></h4>
<p>由于我在 SpinalHDL 语言中重新实现了下面的这些 Skid buffer，所以按照 SpinalHDL 的 Stream 定义接口：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SkidBufferCommon</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-2"></a><span class="w">    </span><span class="n">gen</span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">T</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-3"></a><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-4"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-5"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-6"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-7"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-0-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>在这里，<code>io.s</code> 表示从上游取的数据，<code>io.m</code> 表示传递给下游的数据。</p>
<p>输出信号共有：<code>io.s.ready</code>、<code>io.m.valid</code> 和 <code>io.m.payload</code>。</p>
<h4 id="zipcpu"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#zipcpu">ZipCPU 版本</a></h4>
<p>第一个版本来自 ZipCPU：</p>
<p>博客地址：<a href="https://zipcpu.com/blog/2019/05/22/skidbuffer.html">Building a Skid Buffer for AXI processing</a>
代码地址：<a href="https://github.com/ZipCPU/wb2axip/blob/master/rtl/skidbuffer.v">skidbuffer.v</a></p>
<p>它有两个参数，一个表示是否有额外的输出寄存器（outputReg），一个表示是否低功耗（lowPower）。</p>
<h4 id="fpgacpu"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#fpgacpu">FPGACPU 版本</a></h4>
<p>第二个版本来自 FPGACPU：</p>
<p>文章地址：<a href="http://fpgacpu.ca/fpga/Pipeline_Skid_Buffer.html">Pipeline Skid Buffer</a></p>
<h4 id="spinalhdl-s2m"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#spinalhdl-s2m">SpinalHDL S2M 版本</a></h4>
<p>第三个版本来自 SpinalHDL Library 的 s2mPipe：</p>
<p>代码地址：<a href="https://github.com/SpinalHDL/SpinalHDL/blob/f9eda46bb5968659fe4e97cad8b69c8c0cb2bf89/lib/src/main/scala/spinal/lib/Stream.scala#L348">Stream.scala L348</a></p>
<h4 id="spinalhdl-m2s"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#spinalhdl-m2s">SpinalHDL M2S 版本</a></h4>
<p>第四个版本来自 SpinalHDL Library 的 m2sPipe：</p>
<p>代码地址：<a href="https://github.com/SpinalHDL/SpinalHDL/blob/f9eda46bb5968659fe4e97cad8b69c8c0cb2bf89/lib/src/main/scala/spinal/lib/Stream.scala#L327">Stream.scala L327</a></p>
<h4 id="_2"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#_2">四个版本的对比</a></h4>
<p>在研究了代码以后，可以看到这四个版本的区别：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>ZipCPU w/ outputReg</th>
<th>ZipCPU w/o outputReg</th>
<th>FPGACPU</th>
<th>S2M</th>
<th>M2S</th>
</tr>
</thead>
<tbody>
<tr>
<td>io.s.ready</td>
<td>Reg</td>
<td>Reg</td>
<td>Reg</td>
<td>Reg</td>
<td>Comb</td>
</tr>
<tr>
<td>io.m.valid</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
</tr>
<tr>
<td>io.m.payload</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
</tr>
<tr>
<td>latency</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>buffer 数量</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>注：</p>
<ol>
<li>Reg 表示从寄存器输出，Comb 表示从组合逻辑输出</li>
<li>Latency 表示从 <code>io.s.fire</code> 到 <code>io.m.fire</code> 的延迟</li>
<li>Buffer 表示缓冲的 payload 个数</li>
<li>ZipCPU w/o outputReg 和 S2M 实现的逻辑是一样的</li>
</ol>
<h4 id="_3"><a class="toclink" href="../../hardware/2021/01/26/skid-buffer/#_3">形式化验证</a></h4>
<p>为了确认上面这些类型的 Skid Buffer 都可以正常工作，按照 ZipCPU Skid Buffer 的文章，也照着写了几个 property：</p>
<p>1: 在 valid &amp;&amp; ~ready 的时候，valid 需要继续保持为高，并且 payload 不变：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-1-1"></a><span class="c1">// When valid goes high, data is stable and valid stays high before ready</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-1-2"></a><span class="n">when</span><span class="p">(</span><span class="n">past</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">stream</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">outerReset</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-1-3"></a><span class="w">    </span><span class="n">slaveAssume</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="p">);</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-1-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dataStable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-1-5"></a><span class="w">        </span><span class="n">slaveAssume</span><span class="p">(</span><span class="n">stable</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">asBits</span><span class="p">));</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-1-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-1-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>2: 在 reset 释放的第一个周期里，valid 不能为高：</p>
<p>参考 AXI 标准 (IHI0022E Page 38 A3.1.2) 原文：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-2-1"></a>The earliest point after reset that a master is permitted to begin driving ARVALID, AWVALID, or WVALID HIGH is at a rising ACLK edge after ARESETn is HIGH.
</span></code></pre></div>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-3-1"></a><span class="c1">// Valid is low in the first cycle after reset falls</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-3-2"></a><span class="n">when</span><span class="p">(</span><span class="n">pastValid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">past</span><span class="p">(</span><span class="n">outerReset</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">outerReset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-3-3"></a><span class="w">    </span><span class="n">slaveAssume</span><span class="p">(</span><span class="o">~</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="p">);</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-3-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>3: 添加 cover property，要求 <code>io.s</code> 和 <code>io.m</code> 可以连续若干个周期 valid &amp;&amp; ready，保证吞吐率：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-4-1"></a><span class="n">cover</span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-4-2"></a><span class="w">    </span><span class="n">pastValid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span><span class="n">pastValid</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-4-3"></a><span class="w">        </span><span class="o">~</span><span class="n">outerReset</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-4-4"></a><span class="w">        </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-4-5"></a><span class="w">        </span><span class="n">cycles</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-4-6"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">fire</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2021/01/26/skid-buffer/#__codelineno-4-7"></a><span class="p">)</span>
</span></code></pre></div>
<p>采用 <code>yosys-smtbmc</code> 工具验证了以上四种 Skid buffer 都满足这些属性。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2021/01/26/skid-buffer/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-01-02 00:00:00">2021年1月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="m1-qemu-debian"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/">在 M1 上用 QEMU 运行 Debian 虚拟机</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#_1">背景</a></h3>
<p>看到 @jsteward 在 M1 的 QEMU 中运行了 Windows on ARM，所以我先来试试 Debian on AArch64，这样会简单一些。</p>
<p>参考：https://gist.github.com/niw/e4313b9c14e968764a52375da41b4278#file-readme-md</p>
<p>大约需要 3G 的硬盘空间。</p>
<h3 id="qemu-w-m1-patches"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#qemu-w-m1-patches">安装 QEMU w/ M1 patches</a></h3>
<p>目前上游的 QEMU 还不支持 M1 的 Hypervisor framework，需要打 patch：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/git/qemu.git
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-2"></a><span class="nb">cd</span><span class="w"> </span>qemu
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-3"></a>git<span class="w"> </span>checkout<span class="w"> </span>master<span class="w"> </span>-b<span class="w"> </span>wip/hvf
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-4"></a>curl<span class="w"> </span><span class="s1">&#39;https://patchwork.kernel.org/series/400619/mbox/&#39;</span><span class="p">|</span>git<span class="w"> </span>am<span class="w"> </span>--3way
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-5"></a>mkdir<span class="w"> </span>build
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-6"></a><span class="nb">cd</span><span class="w"> </span>build
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-7"></a>../configure<span class="w"> </span>--target-list<span class="o">=</span>aarch64-softmmu<span class="w"> </span>--enable-cocoa<span class="w"> </span>--disable-gnutls
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-0-8"></a>make<span class="w"> </span>-j4
</span></code></pre></div>
<p>编译后，得到 <code>qemu-system-aarch64</code> 的二进制</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#_2">准备好文件系统</a></h3>
<p>需要下载 <a href="https://gist.github.com/niw/4f1f9bb572f40d406866f23b3127919b/raw/f546faea68f4149c06cca88fa67ace07a3758268/QEMU_EFI-cb438b9-edk2-stable202011-with-extra-resolutions.tar.gz">EFI 固件</a> 和 <a href="https://mirrors.tuna.tsinghua.edu.cn/debian-cd/current/arm64/iso-cd/debian-10.7.0-arm64-xfce-CD-1.iso">Debian 安装镜像</a>，解压前者以后把文件放同一个目录中，并且创建需要的文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-1-1"></a>$<span class="w"> </span>ls<span class="w"> </span>*.fd
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-1-2"></a>QEMU_EFI.fd<span class="w">   </span>QEMU_VARS.fd
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-1-3"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash0.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1m<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">64</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-1-4"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash1.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1m<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">64</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-1-5"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>QEMU_EFI.fd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash0.img<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>notrunc
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-1-6"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>QEMU_VARS.fd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash1.img<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>notrunc
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-1-7"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-img<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>qcow2<span class="w"> </span>disk.qcow2<span class="w"> </span>40G
</span></code></pre></div>
<h3 id="debian"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#debian">安装 Debian 系统</a></h3>
<p>接着，执行以下的命令，然后按照提示安装系统：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-1"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-2"></a><span class="w">  </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-3"></a><span class="w">  </span>-M<span class="w"> </span>virt,highmem<span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-4"></a><span class="w">  </span>-accel<span class="w"> </span>hvf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-5"></a><span class="w">  </span>-cpu<span class="w"> </span>cortex-a72<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-6"></a><span class="w">  </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-7"></a><span class="w">  </span>-m<span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-8"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash0.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash,readonly<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-9"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash1.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-10"></a><span class="w">  </span>-device<span class="w"> </span>virtio-scsi-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-11"></a><span class="w">  </span>-device<span class="w"> </span>virtio-gpu-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-12"></a><span class="w">  </span>-device<span class="w"> </span>qemu-xhci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-13"></a><span class="w">  </span>-device<span class="w"> </span>usb-kbd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-14"></a><span class="w">  </span>-device<span class="w"> </span>usb-tablet<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-15"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./disk.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>boot,cache<span class="o">=</span>writethrough<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-16"></a><span class="w">  </span>-device<span class="w"> </span>nvme,drive<span class="o">=</span>boot,serial<span class="o">=</span>boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-17"></a><span class="w">  </span>-drive<span class="w"> </span><span class="k">if</span><span class="o">=</span>none,id<span class="o">=</span>cd,file<span class="o">=</span>debian-10.7.0-arm64-xfce-CD-1.iso,media<span class="o">=</span>cdrom<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-18"></a><span class="w">  </span>-device<span class="w"> </span>scsi-cd,drive<span class="o">=</span><span class="nb">cd</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-2-19"></a><span class="w">  </span>-display<span class="w"> </span>default,show-cursor<span class="o">=</span>on
</span></code></pre></div>
<p>需要注意的是，如果用 <code>-cdrom</code> 选项，Debian 会无法识别，所以需要走 SCSI。安装完成后，第一次重启可能会显示失败，不用管。另外，安装界面只在串口处显示，但不会显示在 GUI 中，估计是因为 <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=977466">BUG</a>（感谢 @Harry-Chen 指出）。</p>
<h3 id="_3"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#_3">启动系统</a></h3>
<p>安装好后，运行下面的命令来启动 Debian 系统：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-1"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-2"></a><span class="w">  </span>-monitor<span class="w"> </span>stdio<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-3"></a><span class="w">  </span>-M<span class="w"> </span>virt,highmem<span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-4"></a><span class="w">  </span>-accel<span class="w"> </span>hvf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-5"></a><span class="w">  </span>-cpu<span class="w"> </span>cortex-a72<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-6"></a><span class="w">  </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-7"></a><span class="w">  </span>-m<span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-8"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash0.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash,readonly<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-9"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash1.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-10"></a><span class="w">  </span>-device<span class="w"> </span>virtio-gpu-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-11"></a><span class="w">  </span>-device<span class="w"> </span>virtio-scsi-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-12"></a><span class="w">  </span>-device<span class="w"> </span>qemu-xhci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-13"></a><span class="w">  </span>-device<span class="w"> </span>usb-kbd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-14"></a><span class="w">  </span>-device<span class="w"> </span>usb-tablet<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-15"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./disk.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>boot,cache<span class="o">=</span>writethrough<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-16"></a><span class="w">  </span>-device<span class="w"> </span>nvme,drive<span class="o">=</span>boot,serial<span class="o">=</span>boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-17"></a><span class="w">  </span>-display<span class="w"> </span>default,show-cursor<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-3-18"></a><span class="w">  </span>-nic<span class="w"> </span>user,model<span class="o">=</span>virtio
</span></code></pre></div>
<p>注意参数和上面有所不同。启动后就可以在 GUI 上看到 Debian 登录的界面了。</p>
<h3 id="_4"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#_4">网络</a></h3>
<p>起来以后，可以看到一个网卡 <code>enp0s1</code> 启动并获取 IP 地址：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-4-1"></a>$<span class="w"> </span>ip<span class="w"> </span>l<span class="w"> </span><span class="nb">set</span><span class="w"> </span>enp0s1<span class="w"> </span>up
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#__codelineno-4-2"></a>$<span class="w"> </span>dhclient<span class="w"> </span>enp0s1
</span></code></pre></div>
<p>获取到一个 IP 地址后，就可以上网了。</p>
<h3 id="_5"><a class="toclink" href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/#_5">已知问题</a></h3>
<p>在虚拟机内重启以后，可能会启动失败。退出 QEMU 进程重新启动即可。</p>

    <nav class="md-post__action">
      <a href="../../software/2021/01/02/aarch64-debian-in-qemu-m1/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../2022/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2022" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                2022
              </div>
            </div>
          </a>
        
        
          
          <a href="../2020/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2020" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2020
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
        
      
    
  <script>window.addEventListener('load', function() {WaveDrom.ProcessAll();});</script></body>
</html>