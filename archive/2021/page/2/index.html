
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维，编程，调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/archive/2021/page/2/">
      
      
        <link rel="prev" href="../../../2022/">
      
      
        <link rel="next" href="../../../2020/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>2021 - 杰哥的{运维，编程，调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-3109FRSVTT",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2021" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维，编程，调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2021
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/cpu/" class="md-tabs__link">
        
  
    
  
  CPU

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../benchmark/" class="md-tabs__link">
        
  
    
  
  SPEC

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../2025/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../category/crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    杰哥的{运维，编程，调板子}小笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/cpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../benchmark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SPEC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" checked>
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="">
            
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#通过-ipmitool-配置-ilo-4-管理端口" class="md-nav__link">
    <span class="md-ellipsis">
      通过 ipmitool 配置 iLO 4 管理端口
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#静态编译-ipmitool" class="md-nav__link">
    <span class="md-ellipsis">
      静态编译 ipmitool
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esxi-网络配置" class="md-nav__link">
    <span class="md-ellipsis">
      ESXi 网络配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linksys-e8450-openwrt-配置-w-80211ax" class="md-nav__link">
    <span class="md-ellipsis">
      Linksys E8450 OpenWRT 配置 w/ 802.11ax
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#用-gitlab-ci-构建并部署应用到-k8s" class="md-nav__link">
    <span class="md-ellipsis">
      用 gitlab ci 构建并部署应用到 k8s
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gnome-的-fractional-scaling" class="md-nav__link">
    <span class="md-ellipsis">
      Gnome 的 Fractional Scaling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#通过-rook-在-k8s-上部署-ceph-集群" class="md-nav__link">
    <span class="md-ellipsis">
      通过 rook 在 k8s 上部署 ceph 集群
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#用-k3s-部署-k8s" class="md-nav__link">
    <span class="md-ellipsis">
      用 k3s 部署 k8s
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#常用交换机命令" class="md-nav__link">
    <span class="md-ellipsis">
      常用交换机命令
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pcb-笔记" class="md-nav__link">
    <span class="md-ellipsis">
      PCB 笔记
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#idrac-各版本" class="md-nav__link">
    <span class="md-ellipsis">
      iDRAC 各版本
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#使用-sssd-的-ldap-认证" class="md-nav__link">
    <span class="md-ellipsis">
      使用 SSSD 的 LDAP 认证
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-big-surm1-上解决-latex-找不到楷体字体的问题" class="md-nav__link">
    <span class="md-ellipsis">
      在 Big Sur(M1) 上解决 LaTeX 找不到楷体字体的问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-符号" class="md-nav__link">
    <span class="md-ellipsis">
      COMMON 符号
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skid-buffer" class="md-nav__link">
    <span class="md-ellipsis">
      Skid Buffer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-m1-上用-qemu-运行-debian-虚拟机" class="md-nav__link">
    <span class="md-ellipsis">
      在 M1 上用 QEMU 运行 Debian 虚拟机
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2021">2021<a class="headerlink" href="#2021" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-29 00:00:00+00:00">2021年3月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="通过-ipmitool-配置-ilo-4-管理端口"><a class="toclink" href="../../../../system/2021/03/29/ilo-nic-selection-ipmitool/">通过 ipmitool 配置 iLO 4 管理端口</a></h2>
<p>ipmitool 自带了对 iDRAC 的支持，可以通过 <code>ipmitool delloem</code> 设置 iDRAC 的管理端口。但是对 iLO 的支持并没有实现。研究了一番，找到了通过 raw command 配置 iLO 4 管理端口的方法。</p>
<p><a href="https://computercheese.blogspot.com/2013/05/ipmi-lan-commands.html">这篇文章</a> 讲述了 <code>ipmitool lan</code> 命令实际会发送的命令：</p>
<p>读取配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x02<span class="w"> </span>CHANNEL<span class="w"> </span>KEY<span class="w"> </span>SET<span class="w"> </span>BLOCK
</span></code></pre></div>
<p>一般来说 SET 和 BLOCK 都是 0。KEY 的常见取值：</p>
<ul>
<li>3: IP 地址</li>
<li>4: IP 地址来源</li>
<li>5: MAC 地址</li>
<li>6: 子网掩码</li>
<li>12: 默认网关</li>
</ul>
<p>返回的数据中，第一个字节忽略，剩下的就是数据了。</p>
<p>写入配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x01<span class="w"> </span>CHANNEL<span class="w"> </span>KEY<span class="w"> </span>DATA...
</span></code></pre></div>
<p>知道如何读取配置后，接下来就是找到 iLO 4 配置 NIC 的地方了。一番搜索，找到了 <a href="https://support.hpe.com/hpesc/public/docDisplay?docId=c04530505&amp;docLocale=en_US">HPE iLO IPMI User Guide</a>。在第 101 页，可以找到一个用于配置 iLO NIC 选择的设置：</p>
<div class="language-text highlight"><pre><span></span><code>Index: 224
iLO Dedicated/Shared NIC Selection.
data 3:
• Selected iLO NIC.
◦ 0h = iLO Dedicated NIC is selected.
◦ 1h = iLO Shared NIC is selected.
◦ All others = reserved
• To switch to another iLO NIC:
1. Write this (and possibly parameter 197) to the desired NIC selection
2. Configure all other relevant network parameters for the desin
3. Reset iLO. The desired NIC will be in use after iLO reset.
• When writing changes to data 3, NIC selection:
◦ data 1 must be AAh
◦ data 2 must be 55h
◦ data 4 must be FFh
</code></pre></div>
<p>有这样的信息以后，可以通过下面的命令来设置 Shared NIC：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x01<span class="w"> </span>0x01<span class="w"> </span><span class="m">224</span><span class="w"> </span>0xAA<span class="w"> </span>0x55<span class="w"> </span>0x01<span class="w"> </span>0xFF
</span></code></pre></div>
<p>再读出来 224，发现它的 data 4 表示 <code>iLO reset needed for some settings changes that have been made</code>。于是，执行 <code>ipmitool mc reset warm</code> 之后，就可以看到 NIC 选择已经更新：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x02<span class="w"> </span>0x01<span class="w"> </span><span class="m">197</span><span class="w"> </span>0x00<span class="w"> </span>0x00
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="m">11</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">02</span>
</span></code></pre></div>
<p>数据分别表示：</p>
<ul>
<li>0x02: Shared NIC Selection = ALOM</li>
<li>0x01: Shared NIC Port Number = Port 1</li>
<li>0x02: Platform supports ALOM shared NIC</li>
</ul>
<p>如果想要的端口和默认选择不一样，可以写入 197 来更新。详见上面的文档链接。</p>
<p>超微的机器也有类似的办法：https://www.supermicro.org.cn/support/faqs/faq.cfm?faq=15868，可以用 <code>ipmiutil smcoem lanport</code> 命令来读取/修改。</p>
<p>Update：我给 IPMITOOL 提交了 <a href="https://github.com/ipmitool/ipmitool/pull/278">PR</a>，来简化这个过程</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-29 00:00:00+00:00">2021年3月29日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="静态编译-ipmitool"><a class="toclink" href="../../../../system/2021/03/29/static-ipmitool/">静态编译 ipmitool</a></h2>
<p>为了在 ESXi 上运行 ipmitool，需要静态编译 ipmitool。网上已经有一些解决方案：</p>
<p>https://github.com/ryanbarrie/ESXI-ipmitool
https://github.com/hobbsh/static-ipmitool
https://github.com/ewenmcneill/docker-build-static-ipmitool</p>
<p>我稍微修改了一下，用来编译最新 ipmitool：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nb">set</span><span class="w"> </span>-x
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VERSION</span><span class="o">=</span><span class="m">1</span>.8.19
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>rm<span class="w"> </span>-rf<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>.tar.gz<span class="w"> </span>http://deb.debian.org/debian/pool/main/i/ipmitool/ipmitool_<span class="nv">$VERSION</span>.orig.tar.gz
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>tar<span class="w"> </span>xvf<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>.tar.gz
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="nb">cd</span><span class="w"> </span>ipmitool-IPMITOOL_<span class="si">${</span><span class="nv">VERSION</span><span class="p">//./_</span><span class="si">}</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>./bootstrap
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="nv">CC</span><span class="o">=</span>gcc<span class="w"> </span><span class="nv">CFLAGS</span><span class="o">=</span>-m64<span class="w"> </span><span class="nv">LDFLAGS</span><span class="o">=</span>-static<span class="w"> </span>./configure<span class="w"> </span>--disable-ipmishell
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>make<span class="w"> </span>-j24
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="nb">cd</span><span class="w"> </span>src
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>../libtool<span class="w"> </span>--silent<span class="w"> </span>--tag<span class="o">=</span>CC<span class="w"> </span>--mode<span class="o">=</span>link<span class="w"> </span>gcc<span class="w"> </span>-m64<span class="w"> </span>-fno-strict-aliasing<span class="w"> </span>-Wreturn-type<span class="w"> </span>-all-static<span class="w"> </span>-o<span class="w"> </span>ipmitool.static<span class="w"> </span>ipmitool.o<span class="w"> </span>ipmishell.o<span class="w"> </span>../lib/libipmitool.la<span class="w"> </span>plugins/libintf.la
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>file<span class="w"> </span><span class="nv">$PWD</span>/ipmitool.static
</span></code></pre></div>
<p>复制下来，编译完成后 scp 到 esxi 中即可使用。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-27 00:00:00+00:00">2021年3月27日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="esxi-网络配置"><a class="toclink" href="../../../../networking/2021/03/27/esxi-network-config/">ESXi 网络配置</a></h2>
<p>用过 ESXi 的大家都知道，它网页版对网络的配置功能有限，特别是 IPv6 的部分，有的事情无法实现。更好的办法是 SSH 到 ESXi 上直接用命令行进行配置。</p>
<p>可能会用到的一些命令：</p>
<ol>
<li>esxcfg-vmknic: 用来给 vmkernel 配置地址</li>
<li>esxcfg-route: 设置系统路由表</li>
<li>esxcli: 大杂烩，很多功能都在里面</li>
<li>tcpdump-uw：魔改版 tcpdump</li>
</ol>
<p>一些例子：</p>
<p>设置 IPv6 默认路由：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcfg-route<span class="w"> </span>-f<span class="w"> </span>V6<span class="w"> </span>-a<span class="w"> </span>default<span class="w"> </span><span class="nv">$IPV6</span>
</span></code></pre></div>
<p>删除 vmkernel 的 IPv6 地址：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcli<span class="w"> </span>network<span class="w"> </span>ip<span class="w"> </span>interface<span class="w"> </span>ipv6<span class="w"> </span>address<span class="w"> </span>remove<span class="w"> </span>-i<span class="w"> </span><span class="nv">$VMKERNEL</span><span class="w"> </span>-I<span class="w"> </span><span class="nv">$IPV6</span>/<span class="nv">$PREFIX</span>
</span></code></pre></div>
<p>参考：https://kb.vmware.com/s/article/1002662</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-18 00:00:00+00:00">2021年3月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linksys-e8450-openwrt-配置-w-80211ax"><a class="toclink" href="../../../../hardware/2021/03/18/linksys-e8450-openwrt/">Linksys E8450 OpenWRT 配置 w/ 802.11ax</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../hardware/2021/03/18/linksys-e8450-openwrt/#背景">背景</a></h3>
<p>之前用的 newifi 路由器（Lenovo y1s）无线网总是出问题，于是换了一个新的支持 802.11ax 的路由器 Linksys E8450，目前在 openwrt snapshot 支持。Openwrt 的支持页面：<a href="https://openwrt.org/toh/linksys/linksys_e8450">Linksys E8450</a>。</p>
<h3 id="过程"><a class="toclink" href="../../../../hardware/2021/03/18/linksys-e8450-openwrt/#过程">过程</a></h3>
<p>按照支持页面，下载固件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>wget<span class="w"> </span>https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin
</span></code></pre></div>
<p>更新（2023-02-27）：固件已经从 snapshot 进入正式版，下载链接为 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin</a>。如果已经替换为 UBI，则使用 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb</a> 固件。</p>
<p>然后访问固件升级页面：http://192.168.1.1/config-admin-firmware.html#firmware，选择下载的 bin 文件。点击“开始升级”，然后等待。一段时间后，ssh 到路由器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>root@192.168.1.1
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>The<span class="w"> </span>authenticity<span class="w"> </span>of<span class="w"> </span>host<span class="w"> </span><span class="s1">&#39;192.168.1.1 (192.168.1.1)&#39;</span><span class="w"> </span>can<span class="s1">&#39;t be established.</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="s1">ED25519 key fingerprint is SHA256:REDACTED.</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="s1">No matching host key fingerprint found in DNS.</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="s1">This key is not known by any other names</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="s1">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="s1">Warning: Permanently added &#39;</span><span class="m">192</span>.168.1.1<span class="err">&#39;</span><span class="w"> </span><span class="o">(</span>ED25519<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>known<span class="w"> </span>hosts.
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>BusyBox<span class="w"> </span>v1.33.0<span class="w"> </span><span class="o">()</span><span class="w"> </span>built-in<span class="w"> </span>shell<span class="w"> </span><span class="o">(</span>ash<span class="o">)</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">  </span>_______<span class="w">                     </span>________<span class="w">        </span>__
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>.-----.-----.-----.<span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span>.----.<span class="p">|</span><span class="w">  </span><span class="p">|</span>_
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w"> </span><span class="p">|</span><span class="w">   </span>-<span class="w">   </span><span class="o">||</span><span class="w">  </span>_<span class="w">  </span><span class="p">|</span><span class="w">  </span>-__<span class="p">|</span><span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="o">||</span><span class="w">   </span>_<span class="o">||</span><span class="w">   </span>_<span class="p">|</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w"> </span><span class="p">|</span>_______<span class="o">||</span><span class="w">   </span>__<span class="p">|</span>_____<span class="p">|</span>__<span class="p">|</span>__<span class="o">||</span>________<span class="o">||</span>__<span class="p">|</span><span class="w">  </span><span class="p">|</span>____<span class="p">|</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">          </span><span class="p">|</span>__<span class="p">|</span><span class="w"> </span>W<span class="w"> </span>I<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>L<span class="w"> </span>E<span class="w"> </span>S<span class="w"> </span>S<span class="w">   </span>F<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>E<span class="w"> </span>D<span class="w"> </span>O<span class="w"> </span>M
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w"> </span>OpenWrt<span class="w"> </span>SNAPSHOT,<span class="w"> </span>r16242-41af8735d4
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="o">===</span><span class="w"> </span>WARNING!<span class="w"> </span><span class="o">=====================================</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>There<span class="w"> </span>is<span class="w"> </span>no<span class="w"> </span>root<span class="w"> </span>password<span class="w"> </span>defined<span class="w"> </span>on<span class="w"> </span>this<span class="w"> </span>device!
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>Use<span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;passwd&quot;</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>to<span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>password
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="k">in</span><span class="w"> </span>order<span class="w"> </span>to<span class="w"> </span>prevent<span class="w"> </span>unauthorized<span class="w"> </span>SSH<span class="w"> </span>logins.
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>--------------------------------------------------
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>root@OpenWrt:~#<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>Linux<span class="w"> </span>OpenWrt<span class="w"> </span><span class="m">5</span>.10.23<span class="w"> </span><span class="c1">#0 SMP Wed Mar 17 19:55:38 2021 aarch64 GNU/Linux</span>
</span></code></pre></div>
<p>配置 luci:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>opkg<span class="w"> </span>update
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>$<span class="w"> </span>opkg<span class="w"> </span>install<span class="w"> </span>luci
</span></code></pre></div>
<p>然后就可以网页访问看到 luci 了：Powered by LuCI Master (git-21.060.51374-cd06e70) / OpenWrt SNAPSHOT r16242-41af8735d4。</p>
<p>由于目前 luci 不支持 802.11ax 的配置，可以直接修改 uci 配置来达到效果：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span>show<span class="w"> </span>wireless
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wireless.radio1.htmode<span class="o">=</span><span class="s1">&#39;HE80&#39;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>root@OpenWrt:/#<span class="w"> </span>/etc/init.d/network<span class="w"> </span>restart
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="s1">&#39;radio0&#39;</span><span class="w"> </span>is<span class="w"> </span>disabled
</span></code></pre></div>
<p>注：实际上设置为 HE 开头的字符串即可，见 <a href="https://github.com/openwrt/openwrt/blob/8019c54d8a191cfb90c3bf06ff367f601f872fd1/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh#L334">mac80211.sh</a>。</p>
<p>再连接上 Wi-Fi 的时候就可以看到是 802.11ax 模式了。也在 <a href="https://forum.openwrt.org/t/got-802-11ax-working-in-linksys-e8450/91533">OpenWRT 论坛</a> 上分享了一下这个方案。</p>
<p>更新（2021-07-31）：目前最新的 luci 版本已经可以在网页上配置 802.11ax 模式了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-16 00:00:00+00:00">2021年3月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-gitlab-ci-构建并部署应用到-k8s"><a class="toclink" href="../../../../devops/2021/03/16/gitlab-ci-k8s-integration/">用 gitlab ci 构建并部署应用到 k8s</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../devops/2021/03/16/gitlab-ci-k8s-integration/#背景">背景</a></h3>
<p>在 k8s 集群中部署了 gitlab-runner，并且希望在 gitlab ci 构建完成后，把新的 docker image push 到 private repo，然后更新应用。</p>
<p>参考文档：<a href="https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/">Gitlab CI 与 Kubernetes 的结合</a>，<a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">Using Docker to build Docker images</a>。</p>
<h3 id="在-gitlab-ci-中构建-docker-镜像"><a class="toclink" href="../../../../devops/2021/03/16/gitlab-ci-k8s-integration/#在-gitlab-ci-中构建-docker-镜像">在 gitlab ci 中构建 docker 镜像</a></h3>
<p>这一步需要 DinD 来实现在容器中构建容器。为了达到这个目的，首先要在 gitlab-runner 的配置中添加一个 volume 来共享 DinD 的证书路径：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nt">gitlabUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nt">rbac</span><span class="p">:</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="nt">runnerRegistrationToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="nt">runners</span><span class="p">:</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="no">[[runners]]</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">      </span><span class="no">[runners.kubernetes]</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">        </span><span class="no">image = &quot;ubuntu:20.04&quot;</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">        </span><span class="no">privileged = true</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">      </span><span class="no">[[runners.kubernetes.volumes.empty_dir]]</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">        </span><span class="no">name = &quot;docker-certs&quot;</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">        </span><span class="no">mount_path = &quot;/certs/client&quot;</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">        </span><span class="no">medium = &quot;Memory&quot;</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<p>注意两点：1. privileged 2. 多出来的 volume</p>
<p>用 helm 部署 gitlab runner 之后，按照下面的方式配置 gitlab-ci：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>image: docker:19.03.12
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>variables:
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>  DOCKER_HOST: tcp://docker:2376
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>  #
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>  # The &#39;docker&#39; hostname is the alias of the service container as described at
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>  # https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#accessing-the-services.
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>  # If you&#39;re using GitLab Runner 12.7 or earlier with the Kubernetes executor and Kubernetes 1.6 or earlier,
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>  # the variable must be set to tcp://localhost:2376 because of how the
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>  # Kubernetes executor connects services to the job container
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>  # DOCKER_HOST: tcp://localhost:2376
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>  #
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>  # Specify to Docker where to create the certificates, Docker will
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>  # create them automatically on boot, and will create
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>  # `/certs/client` that will be shared between the service and job
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>  # container, thanks to volume mount from config.toml
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>  DOCKER_TLS_CERTDIR: &quot;/certs&quot;
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>  # These are usually specified by the entrypoint, however the
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>  # Kubernetes executor doesn&#39;t run entrypoints
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>  # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4125
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>  DOCKER_TLS_VERIFY: 1
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>  DOCKER_CERT_PATH: &quot;$DOCKER_TLS_CERTDIR/client&quot;
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>  DOCKER_DAEMON_OPTIONS: &quot;--insecure-registry=${REGISTRY}&quot;
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>services:
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>  - name: docker:19.03.12-dind
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    entrypoint: [&quot;sh&quot;, &quot;-c&quot;, &quot;dockerd-entrypoint.sh $DOCKER_DAEMON_OPTIONS&quot;]
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>before_script:
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>  # Wait until client certs are generated
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>  # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/27384
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>  - until docker info; do sleep 1; done
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>  - echo &quot;$REGISTRY_PASS&quot; | docker login $REGISTRY --username $REGISTRY_USER --password-stdin
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>build:
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>  stage: build
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>  script: ./build.sh
</span></code></pre></div>
<p>这里有很多细节，包括 DinD 的访问方式，等待 client cert，设置 docker 的 insecure registry 和 login 等等。经过 <a href="https://github.com/CircuitCoder">@CircuitCoder</a> 的不断摸索，终于写出了可以用的配置。</p>
<p>如此配置以后，就可以在 gitlab ci 的构建脚本里用 docker 来 build 并且 push 到自己的 registry 了。为了防止泄露密钥，建议把这些变量放到 gitlab ci 设置的 secrets 中。</p>
<h3 id="自动部署到-k8s"><a class="toclink" href="../../../../devops/2021/03/16/gitlab-ci-k8s-integration/#自动部署到-k8s">自动部署到 k8s</a></h3>
<p>为了让 k8s 重启一个 deployment，一般的做法是：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>kubectl -n NAMESPACE rollout restart deployment/NAME
</span></code></pre></div>
<p>我们希望 gitlab ci 在 build 之后，去执行这一个命令，但又不希望提供太多的权限给 gitlab。所以，我们创建 Service Account 并设置最小权限：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>---
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>apiVersion: v1
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>kind: ServiceAccount
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>metadata:
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>  name: gitlab
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>  namespace: default
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>---
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>kind: Role
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>metadata:
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>  name: gitlab-test
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>  namespace: test
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>rules:
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>- verbs:
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>    - get
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>    - patch
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>  apiGroups:
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>    - &#39;apps&#39;
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>  resources:
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>    - &#39;deployments&#39;
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>  resourceNames:
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>    - &#39;test-deployment&#39;
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>---
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>kind: RoleBinding
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>metadata:
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>  name: gitlab
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>  namespace: test
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>subjects:
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>  - kind: ServiceAccount
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>    name: gitlab
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>    namespace: default
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>roleRef:
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>  apiGroup: rbac.authorization.k8s.io
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>  kind: Role
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>  name: gitlab-test
</span></code></pre></div>
<p>要特别注意这几个配置的 namespace 的对应关系：Role 和 RoleBinding 需要放在同一个 ns 下。</p>
<p>接着，到 GitLab 的 Operations-&gt;Kubernetes 创建 cluster，把 service account 的 token 和 ca.crt 从 secret 里找到并贴到网页上。GitLab 会按照 Environment scope 匹配到 environment，如果某个 stage 的 environment 匹配上了，就会把 kube credentials 配置好。修改 gitlab-ci.yml：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>deploy:
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  stage: deploy
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>  image: bitnami/kubectl:1.20
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>  environment:
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    name: production
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>  only:
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    - master
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>  script:
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    - kubectl -n test rollout restart deployment/test
</span></code></pre></div>
<p>这样就完成配置了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-13 00:00:00+00:00">2021年3月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="gnome-的-fractional-scaling"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/">Gnome 的 Fractional Scaling</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#背景">背景</a></h3>
<p>最近发现部分软件（包括 Google Chrome，Firefox 和 Visual Studio Code）在 125% 的 Fractional Scaling 模式下会很卡。找到了一些临时解决方法，但是很不优雅，也很麻烦。所以深入研究了一下 Fractional Scaling 的工作方式。</p>
<h3 id="临时解决方法"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#临时解决方法">临时解决方法</a></h3>
<p>根据关键字，找到了 <a href="https://askubuntu.com/questions/1274719/chrome-menus-too-slow-after-enabling-fractional-scaling-in-ubuntu-20-04">Chrome menus too slow after enabling fractional scaling in Ubuntu 20.04</a>。按它的方法，关闭 Google Chrome 的硬件加速，发现卡顿问题确实解决了。</p>
<p>类似地，也可以<a href="https://gist.github.com/andriyudatama/fe5d00deb36feeea30ef35a5ea0f7eff">关闭 VSCode 的硬件加速</a>，在 Firefox 里也可以找到相应的设置。这样操作确实可以解决问题。但是，对于每一个出问题的应用都这样搞一遍，还是挺麻烦的。</p>
<p>另一个思路是，<a href="https://askubuntu.com/questions/1230208/fractional-scaling-does-not-work-properly-ubuntu-20-04/1272794#1272794">不使用 Fractional Scaling，而只是把字体变大</a>。但毕竟和我们想要的效果不大一样。</p>
<h3 id="一些发现"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#一些发现">一些发现</a></h3>
<p>在物理机进行了一些实验以后，发现一个现象：125% 的时候卡顿，而其他比例（100%，150%，175%，200%）都不卡顿。</p>
<p>网上一顿搜到，找到了 xrandr 工具。下面是观察到的一些现象（GNOME 设置分辨率一直是 1920x1080）：</p>
<table>
<thead>
<tr>
<th>放缩比例</th>
<th>xrandr 显示的分辨率</th>
<th>xrandr 显示的 transform</th>
</tr>
</thead>
<tbody>
<tr>
<td>100%</td>
<td>1920x1080</td>
<td>diag(1.0, 1.0, 1.0)</td>
</tr>
<tr>
<td>125%</td>
<td>3072x1728</td>
<td>diag(1.6, 1.6, 1.0)</td>
</tr>
<tr>
<td>150%</td>
<td>2560x1440</td>
<td>diag(1.33, 1.33, 1.0)</td>
</tr>
<tr>
<td>175%</td>
<td>2208x1242</td>
<td>diag(1.15, 1.15, 1.0)</td>
</tr>
<tr>
<td>200%</td>
<td>1920x1080</td>
<td>diag(1.0, 1.0, 1.0)</td>
</tr>
</tbody>
</table>
<p>在 <a href="https://www.x.org/releases/X11R7.5/doc/man/man1/xrandr.1.html">xrandr 文档</a> 中，写了：transform 是一个 3x3 矩阵，矩阵乘以输出的点的坐标得到图形缓存里面的坐标。</p>
<p>由此可以猜想：fractional scaling 的工作方式是，把绘制的 buffer 调大，然后再用 transform 把最终输出分辨率调成 1920x1080。可以看到，xrandr 显示的分辨率除以 transform 对应的值，就是 1920x1080。但这并不能解释 100% 和 200% 的区别，所以肯定还漏了什么信息。</p>
<p>翻了翻 <a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#989734a4aea877b0c1d80fa73cbe2ee59de79fba_376_422">mutter 实现 fractional scaling 的 pr</a>，找到了实现 scale 的一部分：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clutter_actor_get_resource_scale</span><span class="w"> </span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resource_scale</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="n">resource_scale</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">paint_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resource_scale</span><span class="p">;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="n">cogl_matrix_scale</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">modelview</span><span class="p">,</span><span class="w"> </span><span class="n">paint_scale</span><span class="p">,</span><span class="w"> </span><span class="n">paint_scale</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>然后找到了一段对 scale 做 ceiling 的<a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#989734a4aea877b0c1d80fa73cbe2ee59de79fba_238_265">代码</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_clutter_actor_get_real_resource_scale</span><span class="w"> </span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resource_scale</span><span class="p">))</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="n">ceiled_resource_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceilf</span><span class="w"> </span><span class="p">(</span><span class="n">resource_scale</span><span class="p">);</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="n">stage_width</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">ceiled_resource_scale</span><span class="p">;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="n">stage_height</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">ceiled_resource_scale</span><span class="p">;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>这样，100% 和其他比例就区分开了。</p>
<p>另外，也在<a href="https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/3/diffs#d66a28cda989fbb17c8a7302b3f6360640c3c152_33_33">代码</a> 中发现：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cp">#define SCALE_FACTORS_PER_INTEGER 4</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="cp">#define SCALE_FACTORS_STEPS (1.0 / (float) SCALE_FACTORS_PER_INTEGER)</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="cp">#define MINIMUM_SCALE_FACTOR 1.0f</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="cp">#define MAXIMUM_SCALE_FACTOR 4.0f</span>
</span></code></pre></div>
<p>这段代码规定了比例只能是 25% 的倍数。</p>
<p>我也试了一下用 xrandr --scale 1.5x1.5：效果就是窗口看起来都更小了，分辨率变成了 2880x1620，transform 是 diag(1.5, 1.5, 1.0)。</p>
<h3 id="虚拟机测试"><a class="toclink" href="../../../../software/2021/03/13/gnome-fractional-scaling/#虚拟机测试">虚拟机测试</a></h3>
<p>接着，用虚拟机做了一些测试。为了在 GNOME over Wayland 上使用 fractional scaling，需要运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>gsettings<span class="w"> </span><span class="nb">set</span><span class="w"> </span>org.gnome.mutter<span class="w"> </span>experimental-features<span class="w"> </span><span class="s2">&quot;[&#39;scale-monitor-framebuffer&#39;]&quot;</span>
</span></code></pre></div>
<p>接着又做了类似上面的测试（GNOME 设置分辨率一直是 2560x1600）：</p>
<table>
<thead>
<tr>
<th>放缩比例</th>
<th>xrandr 显示的分辨率</th>
</tr>
</thead>
<tbody>
<tr>
<td>100%</td>
<td>2560x1600</td>
</tr>
<tr>
<td>125%</td>
<td>2048x1280</td>
</tr>
<tr>
<td>150%</td>
<td>1704x1065</td>
</tr>
<tr>
<td>175%</td>
<td>1464x915</td>
</tr>
<tr>
<td>200%</td>
<td>1280x800</td>
</tr>
</tbody>
</table>
<p>在这个测试中，xrandr 显示的 transform 一直都是单位矩阵；还用了来自 <a href="https://github.com/xyproto/wallutils">xyproto/wallutils</a> 的 <code>wayinfo</code> 命令查看输出的分辨率，一直是 2560x1600，DPI 一直是 96。用 wallutils 的 xinfo 看到的结果和 xrandr 一致（通过 XWayland）。但是和物理机有一点不同：物理机有一个选项问要不要打开 fractional scaling，下面还会提示性能下降的问题；但是虚拟机上并没有这个提示，而是直接给了一些 Scale 比例的选项。</p>
<p>尝试了一下，在 GNOME over X11 上是找不到 fractional scaling 的（没有出现设置 scale 的选项）。找到一个实现这个功能的 fork：https://github.com/puxplaying/mutter-x11-scaling，不过没有尝试过。</p>
<p>我也尝试在虚拟机中用 xrandr --scale，结果就是输出黑屏，需要重启 gdm 来恢复到登录界面。</p>
<p>更新：由于物理机使用的是 Ubuntu，想到是不是 Ubuntu 采用了上面那个 fork 的 patch，然后就在 <a href="https://changelogs.ubuntu.com/changelogs/pool/main/m/mutter/mutter_3.38.1-1ubuntu1/changelog">changelog</a> 中看到：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>mutter (3.38.1-1ubuntu1) groovy; urgency=medium
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>  * Merge with debian, including new upstream version, remaining changes:
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    - debian/gbp.conf: update upstream branch to point to ubuntu/master
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    - debian/patches/x11-Add-support-for-fractional-scaling-using-Randr.patch:
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>      + X11: Add support for fractional scaling using Randr
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>  * d/p/clutter-backend-x11-Don-t-set-the-font-dpi-computed-on-X1.patch:
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    - Dropped, applied upstream
</span></code></pre></div>
<p>也找到了对应的 <a href="https://git.launchpad.net/ubuntu/+source/mutter/tree/debian/patches/x11-Add-support-for-fractional-scaling-using-Randr.patch?h=applied/ubuntu/groovy">patch 文件</a>。这也就解释了，为什么网上会说 GNOME over X11 支持 fractional scaling，并且需要用 gsettings 打开，而我在 Debian 和 Arch Linux 上设置这个选项也没有用了。原来是 Ubuntu 加的私货啊。</p>
<p>在 patch 中，找到了这么一段配置的解释：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>+    &lt;key name=&quot;fractional-scale-mode&quot; enum=&quot;org.gnome.mutter.X11.scale-mode&quot;&gt;
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>+      &lt;default&gt;&quot;scale-ui-down&quot;&lt;/default&gt;
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>+      &lt;description&gt;
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>+        Choose the scaling mode to be used under X11 via Randr extension.
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>+
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>+        Supported methods are:
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>+
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>+        • “scale-up”     — Scale everything up to the requested scale, shrinking
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>+                           the UI. The applications will look blurry when scaling
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>+                           at higher values and the resolution will be lowered.
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>+        • “scale-ui-down — Scale up the UI toolkits to the closest integer
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>+                           scaling value upwards, while scale down the display
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>+                           to match the requested scaling level.
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>+                           It increases the resolution of the logical display.
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>+      &lt;/description&gt;
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>+    &lt;/key&gt;
</span></code></pre></div>
<p>这样就可以解释前面看到的现象了：默认是 <code>scale-ui-down</code>，也就是先放大到两倍（closest integer scaling value upwards），再缩小（scale down the display to match the requested scaling level）。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-12 00:00:00+00:00">2021年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="通过-rook-在-k8s-上部署-ceph-集群"><a class="toclink" href="../../../../devops/2021/03/12/ceph-on-k8s/">通过 rook 在 k8s 上部署 ceph 集群</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../devops/2021/03/12/ceph-on-k8s/#背景">背景</a></h3>
<p>为了方便集群的使用，想在 k8s 集群里部署一个 ceph 集群。</p>
<p><a href="https://docs.ceph.com/en/latest/start/intro/">Ceph 介绍</a></p>
<p>Ceph 有这些组成部分：</p>
<ol>
<li>mon：monitor</li>
<li>mgr：manager</li>
<li>osd：storage</li>
<li>mds(optional)：用于 CephFS</li>
<li>radosgw(optional：用于 Ceph Object Storage</li>
</ol>
<h3 id="配置"><a class="toclink" href="../../../../devops/2021/03/12/ceph-on-k8s/#配置">配置</a></h3>
<p>我们采用的是 <a href="https://rook.io/">rook</a> 来部署 ceph 集群。</p>
<p>参考文档：https://rook.github.io/docs/rook/v1.5/ceph-examples.html</p>
<p>首先，克隆 rook 的仓库。建议选择一个 release 版本。</p>
<p>接着，运行下面的命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>lvm2
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c1"># required</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/crds.yaml
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/common.yaml
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/operator.yaml
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="c1"># debugging only</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/toolbox.yaml
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/direct-mount.yaml
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="c1"># CephFS</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/filesystem.yaml
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rook/cluster/examples/kubernetes/ceph/csi/cephfs/storageclass.yaml
</span></code></pre></div>
<p>前面三个 yaml 是必须的，toolbox 是用来查看 ceph 状态的，direct mount 是用来 mount cephfs 的，后两个是为了用 cephfs 的。</p>
<p>接着，按照自己的需求编辑 <code>rook/cluster/exmaples/kuberenetes/ceph/cluster.yaml</code> 然后应用。此时你的集群应该就已经起来了。</p>
<p>然后，可以<a href="https://rook.github.io/docs/rook/v1.5/ceph-toolbox.html">进 toolbox 查看 ceph 状态</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>rook-ceph<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>deploy/rook-ceph-tools<span class="w"> </span>--<span class="w"> </span>bash
</span></code></pre></div>
<p>也可以<a href="https://rook.github.io/docs/rook/v1.5/direct-tools.html">进 direct-mount 容器查看 pv 路径</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># get volume path of pvc</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pv<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span>NAME:.metadata.name,NAMSEPACE:.spec.claimRef.namespace,CLAIM:.spec.claimRef.name,PATH:.spec.csi.volumeAttributes.subvolumeName
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>rook-ceph<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>deploy/rook-direct-mount<span class="w"> </span>--<span class="w"> </span>bash
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="c1"># in the pod</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>mkdir<span class="w"> </span>/tmp/registry
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="nv">mon_endpoints</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>mon_host<span class="w"> </span>/etc/ceph/ceph.conf<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="nv">my_secret</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>key<span class="w"> </span>/etc/ceph/keyring<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>-o<span class="w"> </span><span class="nv">mds_namespace</span><span class="o">=</span>myfs,name<span class="o">=</span>admin,secret<span class="o">=</span><span class="nv">$my_secret</span><span class="w"> </span><span class="nv">$mon_endpoints</span>:/<span class="w"> </span>/tmp/registry
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>df<span class="w"> </span>-h
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="nb">cd</span><span class="w"> </span>/tmp/registry/volumes/csi/PATH
</span></code></pre></div>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-12 00:00:00+00:00">2021年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-k3s-部署-k8s"><a class="toclink" href="../../../../devops/2021/03/12/k3s-deploy/">用 k3s 部署 k8s</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../devops/2021/03/12/k3s-deploy/#背景">背景</a></h3>
<p>最近需要部署一个 k8s 集群，觉得之前配置 kubeadm 太繁琐了，想要找一个简单的。比较了一下 k0s 和 k3s，最后选择了 k3s。</p>
<h3 id="配置"><a class="toclink" href="../../../../devops/2021/03/12/k3s-deploy/#配置">配置</a></h3>
<p>k3s 的好处就是配置十分简单：https://rancher.com/docs/k3s/latest/en/quick-start/。不需要装 docker，也不需要装 kubeadm。</p>
<ol>
<li>在第一个 node 上跑：<code>curl -sfL https://get.k3s.io | sh -</code></li>
<li>在第一个 node 上获取 token：<code>cat /var/lib/rancher/k3s/server/node-token</code></li>
<li>在其他 node 上跑：<code>curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken sh -</code></li>
</ol>
<p>然后就搞定了。从第一个 node 的 <code>/etc/rancher/k3s/k3s.yaml</code> 获取 <code>kubectl</code> 配置。</p>
<h3 id="给-api-server-添加额外的-tls-san"><a class="toclink" href="../../../../devops/2021/03/12/k3s-deploy/#给-api-server-添加额外的-tls-san">给 api server 添加额外的 TLS SAN</a></h3>
<p>默认情况下，k3s 的 api server 的 TLS 证书的 SAN 比较有限，如果在外面套了一层端口转发，那么就会导致 IP 地址和 TLS 证书对不上的情况。解决办法：</p>
<ol>
<li>运行 <code>kubectl edit secrets -n kube-system k3s-serving</code>，在 <code>metadata.annotations</code> 下创建条目：<code>listener.cattle.io/cn-x.x.x.x: x.x.x.x</code>，意思是把 <code>x.x.x.x</code> 地址添加到 TLS SAN 当中</li>
<li>运行 <code>k3s certificate rotate</code>，重新生成 TLS 证书</li>
<li>运行 <code>systemctl restart k3s</code>，重启 k3s</li>
</ol>
<p>这样就可以了。</p>
<p>参考：</p>
<ul>
<li><a href="https://serverfault.com/questions/1152961/how-to-add-a-domain-to-k3s-certificate">How to add a domain to k3s certificate</a></li>
<li><a href="https://docs.k3s.io/cli/certificate">k3s certificate</a></li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-12 00:00:00+00:00">2021年3月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="常用交换机命令"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/">常用交换机命令</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#背景">背景</a></h3>
<p>最近接触了 Cisco，DELL，Huawei，H3C，Ruijie 的网络设备，发现配置方式各有不同，故记录一下各个厂家的命令。</p>
<h3 id="huawei"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#huawei">Huawei</a></h3>
<p>测试型号：S5320</p>
<h4 id="保存配置"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#保存配置">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a>&lt;HUAWEI&gt;save
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a>The current configuration will be written to flash:/vrpcfg.zip.
</span><span id="__span-114-3"><a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a>Are you sure to continue?[Y/N]y
</span><span id="__span-114-4"><a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a>Now saving the current configuration to the slot 0....
</span><span id="__span-114-5"><a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a>Save the configuration successfully.
</span></code></pre></div>
<h4 id="进入配置模式"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#进入配置模式">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>&lt;HUAWEI&gt; system-view
</span></code></pre></div>
<h4 id="查看当前配置"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看当前配置">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a>[HUAWEI] display current-configuration
</span></code></pre></div>
<h4 id="查看-lldp-邻居"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-lldp-邻居">查看 LLDP 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a>[HUAWEI]display lldp neighbor brief
</span></code></pre></div>
<h4 id="查看-cdp-邻居"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-cdp-邻居">查看 CDP 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a>[HUAWEI]display cdp neighbor brief
</span></code></pre></div>
<h4 id="启用-lldp"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用-lldp">启用 LLDP</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a>[HUAWEI]lldp enable
</span></code></pre></div>
<h4 id="启用-cdp"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用-cdp">启用 CDP</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a>[HUAWEI-XGigabitEthernet0/0/1]lldp compliance cdp txrx
</span></code></pre></div>
<h4 id="启用只读-snmpv1-community"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用只读-snmpv1-community">启用只读 SNMPv1 community</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a>[HUAWEI]snmp-agent sys-info version all
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>Warning: This command may cause confliction in netconf status. Continue? [Y/N]:y
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>Warning: SNMPv1/SNMPv2c is not secure, and it is recommended to use SNMPv3.
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>[HUAWEI]snmp-agent community read [COMMUNITY NAME]
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a>Warning: This command may cause confliction in netconf status. Continue? [Y/N]:y
</span></code></pre></div>
<h4 id="启用-snmp-iso-view"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用-snmp-iso-view">启用 SNMP iso view</a></h4>
<p>默认情况下 SNMP 会缺少一些标准的 MIB（比如 LLDP），可以打开 iso view：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a>[HUAWEI]snmp-agent mib-view included iso-view iso
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a>Warning: This command may cause confliction in netconf status. Continue? [Y/N]:y
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>[HUAWEI]snmp-agent community read [COMMUNITY NAME] mib-view iso-view
</span></code></pre></div>
<h4 id="查看-arp-表"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-arp-表">查看 ARP 表</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a>[HUAWEI]display arp
</span></code></pre></div>
<h4 id="arping"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#arping">ARPING</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a>[HUAWEI]arp send-packet X.X.X.X ffff-ffff-ffff interface Vlanif VLAN
</span></code></pre></div>
<h4 id="启用-stp-协议"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用-stp-协议">启用 STP 协议</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a>[HUAWEI]stp enable
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>[HUAWEI]stp mode vbst
</span></code></pre></div>
<h4 id="设置-ntp-服务器"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-ntp-服务器">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a>[HUAWEI]ntp-service unicast-server x.x.x.x
</span></code></pre></div>
<h4 id="设置远程-syslog-服务器"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置远程-syslog-服务器">设置远程 syslog 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a>[HUAWEI]info-center loghost x.x.x.x
</span></code></pre></div>
<h4 id="设置-lacp-链路聚合"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-lacp-链路聚合">设置 LACP 链路聚合</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a>[HUAWEI-XGigabitEthernet0/0/1]eth-trunk 1
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a>[HUAWEI-XGigabitEthernet0/0/2]eth-trunk 1
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a>[HUAWEI]interface Eth-Trunk 1
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a>[HUAWEI-Eth-Trunk1]mode lacp
</span></code></pre></div>
<h3 id="dell"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#dell">DELL</a></h3>
<p>测试型号：N3048</p>
<h4 id="保存配置_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#保存配置_1">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a>console#copy running-config startup-config
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a>
</span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a>This operation may take few minutes.
</span><span id="__span-129-4"><a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>Management interfaces will not be available during this time.
</span><span id="__span-129-5"><a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a>
</span><span id="__span-129-6"><a id="__codelineno-129-6" name="__codelineno-129-6" href="#__codelineno-129-6"></a>Are you sure you want to save? (y/n) y
</span><span id="__span-129-7"><a id="__codelineno-129-7" name="__codelineno-129-7" href="#__codelineno-129-7"></a>
</span><span id="__span-129-8"><a id="__codelineno-129-8" name="__codelineno-129-8" href="#__codelineno-129-8"></a>Configuration Saved!
</span></code></pre></div>
<h4 id="进入配置模式_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#进入配置模式_1">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a>console&gt;enable
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a>console# configure
</span></code></pre></div>
<h4 id="查看当前配置_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看当前配置_1">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a>console# show running-config
</span></code></pre></div>
<h4 id="查看-lldp-邻居_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-lldp-邻居_1">查看 LLDP 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a>console#show lldp remote-device all
</span></code></pre></div>
<h4 id="vlan-trunk-配置"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#vlan-trunk-配置">VLAN Trunk 配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a>console(config)#interface Gi1/0/1
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a>console(config-if-Gi1/0/1)#switchport mode trunk
</span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a>console(config-if-Gi1/0/1)#switchport trunk allowed vlan xxx,xxx-xxx
</span></code></pre></div>
<h4 id="vlan-access-配置"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#vlan-access-配置">VLAN Access 配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a>console(config)#interface Gi1/0/1
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a>console(config-if-Gi1/0/1)#switchport mode access
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a>console(config-if-Gi1/0/1)#switchport access vlan xxx
</span></code></pre></div>
<h4 id="查看-vlan-配置"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-vlan-配置">查看 VLAN 配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a>console#show vlan
</span></code></pre></div>
<h4 id="批量配置-interface"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#批量配置-interface">批量配置 interface</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a>console(config)#interface range Gi1/0/1-4
</span></code></pre></div>
<h4 id="启用-ssh-服务器"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用-ssh-服务器">启用 SSH 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a>console(config)#crypto key generate rsa
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a>console(config)#crypto key generate dsa
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a>console(config)#ip ssh server
</span></code></pre></div>
<h4 id="启用-cdpdell-称之为-isdp"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用-cdpdell-称之为-isdp">启用 CDP(DELL 称之为 ISDP)</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a>console(config)#isdp enable
</span></code></pre></div>
<h4 id="启用只读-snmpv1-community_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#启用只读-snmpv1-community_1">启用只读 SNMPv1 community</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a>console(config)#snmp-server community [COMMUNITY NAME] ro
</span></code></pre></div>
<h4 id="设置-ntp-服务器_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-ntp-服务器_1">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a>console(config)#sntp unicast client enable
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a>console(config)#sntp server x.x.x.x
</span></code></pre></div>
<h4 id="设置-ntp-服务器_2"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-ntp-服务器_2">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a>console(config)#sntp unicast client enable
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a>console(config)#sntp server x.x.x.x
</span></code></pre></div>
<h4 id="设置-stp-协议"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-stp-协议">设置 STP 协议</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a>console(config)#spanning-tree mode rapid-pvst
</span></code></pre></div>
<h3 id="h3c"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#h3c">H3C</a></h3>
<h4 id="进入配置模式_2"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#进入配置模式_2">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a>&lt;switch&gt;system-view
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a>System View: return to User View with Ctrl+Z.
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a>[switch]
</span></code></pre></div>
<h4 id="查看当前配置_2"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看当前配置_2">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a>[switch]display current-configuration
</span></code></pre></div>
<h4 id="查看-lldp-邻居_2"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-lldp-邻居_2">查看 lldp 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a>[switch]display lldp neighbor-information
</span></code></pre></div>
<h4 id="保存配置_2"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#保存配置_2">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a>[switch]save
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a>The current configuration will be written to the device. Are you sure? [Y/N]:y
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a>Please input the file name(*.cfg)[flash:/startup.cfg]
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a>(To leave the existing filename unchanged, press the enter key):y
</span><span id="__span-146-5"><a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a>The file name is invalid(does not end with .cfg).
</span></code></pre></div>
<h4 id="批量配置-interface_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#批量配置-interface_1">批量配置 interface</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a>[switch]interface range GigabitEthernet 1/0/1 to GigabitEthernet 1/0/24
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a>[switch-if-range]
</span></code></pre></div>
<h4 id="查看-mac-地址表"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-mac-地址表">查看 MAC 地址表</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a>[switch]show mac-address
</span></code></pre></div>
<h4 id="打开-lldp-和-cdp"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#打开-lldp-和-cdp">打开 LLDP 和 CDP</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a>[switch]lldp global enable
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a>[switch]lldp compliance cdp
</span></code></pre></div>
<h4 id="升级固件"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#升级固件">升级固件</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a>&lt;switch&gt; tftp 1.2.3.4 get SWITCH_FIRMWARE.ipe
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a>&lt;switch&gt; boot-loader file flash:/SWITCH_FIRMWARE.ipe all main
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a>&lt;switch&gt; show boot
</span><span id="__span-150-4"><a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a>&lt;switch&gt; save
</span><span id="__span-150-5"><a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a>&lt;switch&gt; reboot
</span></code></pre></div>
<h4 id="配置-ntp"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#配置-ntp">配置 NTP</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a>[switch] ntp enable
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a>[switch] ntp unicast-server 1.2.3.4
</span></code></pre></div>
<h4 id="配置远程日志"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#配置远程日志">配置远程日志</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a>[switch] logging loghost 1.2.3.4
</span></code></pre></div>
<h3 id="mellanox"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#mellanox">Mellanox</a></h3>
<h4 id="进入配置模式_3"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#进入配置模式_3">进入配置模式</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a>switch &gt; enable
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a>switch # configure terminal
</span><span id="__span-153-3"><a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a>switch (config) #
</span></code></pre></div>
<h4 id="查看当前配置_3"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看当前配置_3">查看当前配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a>switch (config) # show running-config
</span></code></pre></div>
<h4 id="查看-interface-状态"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-interface-状态">查看 interface 状态</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a>switch (config) # show interfaces brief
</span></code></pre></div>
<h4 id="查看以太网端口状态"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看以太网端口状态">查看以太网端口状态</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a>switch (config) # show interfaces ethernet status
</span></code></pre></div>
<h4 id="查看-lldp-邻居_3"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-lldp-邻居_3">查看 lldp 邻居</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a>switch (config) # show lldp remote
</span></code></pre></div>
<h4 id="保存配置_3"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#保存配置_3">保存配置</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a>switch (config) # configuration write
</span></code></pre></div>
<h4 id="批量配置-interface_2"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#批量配置-interface_2">批量配置 interface</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a>switch (config) # interface ethernet 1/1/1-1/1/4
</span><span id="__span-159-2"><a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a>switch (config interface ethernet 1/1/1-1/1/4) #
</span></code></pre></div>
<h4 id="查看-mac-地址表_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看-mac-地址表_1">查看 MAC 地址表</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a>switch (config) # show mac-address-table
</span></code></pre></div>
<h4 id="查看链路聚合状态"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#查看链路聚合状态">查看链路聚合状态</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a>switch (config) # show interfaces port-channel summary
</span></code></pre></div>
<h4 id="把拆分的四个-sfp-口恢复成一个"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#把拆分的四个-sfp-口恢复成一个">把拆分的四个 SFP 口恢复成一个</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a>switch (config interface ethernet 1/1/1) # module-type qsfp 
</span></code></pre></div>
<h4 id="把一个-qsfp-口拆分成四个"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#把一个-qsfp-口拆分成四个">把一个 QSFP 口拆分成四个</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a>switch (config interface ethernet 1/1) # shutdown
</span><span id="__span-163-2"><a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a>switch (config interface ethernet 1/1) # module-type qsfp-split-4
</span></code></pre></div>
<h4 id="设置链路聚合"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置链路聚合">设置链路聚合</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a>switch (config interface ethernet 1/1) # channel-group 1 mode active
</span><span id="__span-164-2"><a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a>switch (config interface ethernet 1/2) # channel-group 1 mode active
</span></code></pre></div>
<p>模式可以选择：active(LACP)/passive(LACP)/on(Static)</p>
<h4 id="设置-stp-协议_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-stp-协议_1">设置 STP 协议</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a>switch (config) # spanning-tree mode rpvst
</span></code></pre></div>
<h4 id="设置远程-syslog-服务器_1"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置远程-syslog-服务器_1">设置远程 syslog 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a>switch (config) # logging x.x.x.x
</span></code></pre></div>
<h4 id="设置-ntp-服务器_3"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-ntp-服务器_3">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a>switch (config) # ntp server x.x.x.x
</span></code></pre></div>
<h3 id="cisco"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#cisco">Cisco</a></h3>
<h4 id="设置-ntp-服务器_4"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#设置-ntp-服务器_4">设置 NTP 服务器</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a># ntp server x.x.x.x
</span></code></pre></div>
<h4 id="配置-trunk"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#配置-trunk">配置 Trunk</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a># config terminal
</span><span id="__span-169-2"><a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a>(config)# interface ethernet 1/1
</span><span id="__span-169-3"><a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a>(config-if)# switchport mode trunk
</span><span id="__span-169-4"><a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a>(config-if)# switchport trunk allowed vlan 12-34
</span></code></pre></div>
<h4 id="配置-access"><a class="toclink" href="../../../../devops/2021/03/12/switch-config/#配置-access">配置 Access</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-170-1"><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a># config terminal
</span><span id="__span-170-2"><a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a>(config)# interface ethernet 1/1
</span><span id="__span-170-3"><a id="__codelineno-170-3" name="__codelineno-170-3" href="#__codelineno-170-3"></a>(config-if)# switchport mode access
</span><span id="__span-170-4"><a id="__codelineno-170-4" name="__codelineno-170-4" href="#__codelineno-170-4"></a>(config-if)# switchport access vlan 1234
</span></code></pre></div>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-08 00:00:00+00:00">2021年3月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="pcb-笔记"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/">PCB 笔记</a></h2>
<p>记录一下在学习画板子过程中学到的心得。</p>
<h3 id="工具"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#工具">工具</a></h3>
<p>目前使用过 <a href="https://kicad.org/">KiCad</a> 和 <a href="https://lceda.cn/">lceda</a>：</p>
<ul>
<li>KiCad: 开源软件，跨平台。</li>
<li>lceda：在线编辑，不需要安装，和 lcsc 有深度集成。</li>
</ul>
<p>项目 <a href="https://github.com/jiegec/HT42B534USB2UART">jiegec/HT42B534USB2UART</a> 采用的是 KiCad 5 编写的。目前正在做的另一个项目采用 lceda</p>
<h3 id="流程"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#流程">流程</a></h3>
<ol>
<li>选择所需要使用的芯片，查找芯片的 datasheet。</li>
<li>寻找采用了芯片的一些设计，特别是看 schematic。</li>
<li>按照 datasheet 里面推荐的电路，或者是其他人的设计，画自己需要的 schematic。</li>
<li>设置好各个元件的 footprint，然后转到 PCB 设计。</li>
<li>在 PCB 里面布线，生成 Gerber 等文件。</li>
<li>把 Gerber 给到生产商（比如 jlc），交付生产。</li>
<li>如果是自己焊接，则需要购买元件，比如从 lcsc 购买。</li>
<li>收到 PCB 和元件后，自己按照 BOM 和 schematic 焊接各个元件。</li>
</ol>
<h3 id="笔记"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#笔记">笔记</a></h3>
<ol>
<li>对于一些连接很多元件的信号，比如 GND，可以留作铺铜解决。也就是说，先不管 GND，把其他所有的信号都接好以后，再在顶层铺铜；如果还是有没有连接上的 GND，可以通过过孔（Via）走到底层，在底层再铺一层铜。</li>
<li>对于外部供电的 VCC 和 GND，在 KiCad 中需要用 PWR_FLAG 标记一下。</li>
<li>在 KiCad 中设计 PCB 前，要把生产商的工艺参数设置好，不然画了也要重画。</li>
<li>lceda 在选择元件的时候，可以直接从 lcsc 里选择，这样可以保证封装和商品可以对得上，不需要手动进行匹配。</li>
<li>如果要用 jlc 的 SMT 贴片，先在 <a href="https://www.jlc.com/portal/smtComponentList.html">SMT 元件列表</a> 里搜索所需要的元件；推荐用基本库，如果用其他库，则要加钱；选好元件以后，用元件编号去 lceda 里搜索并添加到 schematic。</li>
<li>对于涉及模拟信号的设计，比如音频，需要特别注意模拟信号的电和地都是单独的：<code>AVCC</code> 和 <code>AGND</code>。所以要特别注意 datasheet 里面不同的地的表示方法。最后，再用磁珠把 <code>VCC</code> 和 <code>AVCC</code>、<code>GND</code> 和 <code>AGND</code> 分别连接起来就可以了。可以参考 <a href="https://wiki.bu.ost.ch/infoportal/_media/fpga/cyclone_iv/de2_115_schematic.pdf">DE2 板子中第 19 页的音频部分设计</a> 和 <a href="https://www.analog.com/en/analog-dialogue/articles/staying-well-grounded.html">Staying well grounded</a>。</li>
<li>在 schematic 里经常会出现在电源附近的电容，那么，在 PCB 中，也尽量把这些电容放在对应的电源的旁边。</li>
<li>耳机插座里面，一般分三种组成部件：Tip，Ring，Sleeve。只有两段的是 TS，三段的是 TRS，四段的是 TRRS。TS 是单声道，T 是声音，S 是地。TRS 是双声道，T 是左声道（或者单声道），R 是右声道，S 是地。TRRS 则是双声道加录音。一般来说，LINE IN 是双声道，MIC IN 是单声道，它们的阻抗也不同；LINE OUT 和 HEADPHONE OUT 都是双声道，但 HEADPHONE OUT 经过了额外的放大器。</li>
<li>遇到一个 SPI 协议没有 <code>SPI_MISO</code> 引脚的芯片，可能说明它是 write-only 的。</li>
<li>手焊的基本元件，一般用 0603 加一些 Padding 的封装；SMT 的话，则建议用 0402 封装。</li>
<li>I2C 的信号线一般需要加一个几 K 欧姆的上拉电阻到 VCC。</li>
</ol>
<p>JLC SMT 的基础库不需要换料费，如何寻找<a href="https://www.jlcsmt.com/lcsc/basic">基础库</a>中的元件：</p>
<ol>
<li>电阻品牌是 UNI-ROYAL，型号命名规则是：<ol>
<li>封装：0603/0402</li>
<li>功率：WA/WG/W8</li>
<li>误差：F(1%)</li>
<li>阻值：三位整数 + 一位 exp（J 表示 -1，K 表示 -2，L 表示 -3），例如 2002 表示 <code>200*10^2=20k</code>，1003 表示 <code>100*10^3=100k</code>，3300 表示 <code>330*10^0=330</code>，330J 表示 <code>330*10^-1=33</code>，330K 表示 <code>330*10^-2=3.3</code>
例子：要找 0402 封装的 10k 欧电阻，搜索 0402WGF1003；要找 0603 封装的 33 欧电阻，搜索 0603WAF330。</li>
</ol>
</li>
<li>电容品牌有风华/三星/国巨，三星的电容型号命名规则是：<ol>
<li>封装：05(0402)/10(0603)</li>
<li>字母：A/B/C</li>
<li>电容：两位整数 + 一位 exp，单位是 pF，例如 105 表示 <code>10*10^5pF=10^6pF=1uF</code>，104 表示 <code>10*10^4pF=10^5pF=0.1uF</code>
例子：要找 0402 封装的 100nF 电容，搜索 CL05B104；要找 0603 封装的 1uF 电容，搜索 CL10A105。也可以只搜电容的数字部分，可以找到更多品牌。</li>
</ol>
</li>
</ol>
<h3 id="阻抗匹配"><a class="toclink" href="../../../../hardware/2021/03/08/pcb-notes/#阻抗匹配">阻抗匹配</a></h3>
<p>在传输线上，如果出现阻抗变化，就会导致信号出现反射，质量变差。因此，需要保证传输线的两端和传输线整个过程的阻抗一致。</p>
<p>阻抗设置为多少，一般要看协议的规定。确定好协议定义的阻抗以后，需要查看信号两端的芯片内部的阻抗，如果和协议不一致，需要额外添加电阻，并且电阻要尽量放在接近芯片的位置上。由于传输线在 PCB 上，所以和 PCB 厂商的工艺有关，需要去厂商的阻抗计算器上进行计算，例如 <a href="https://tools.jlc.com/jlcTools/index.html#/impedanceCalculatenew">jlc 阻抗计算器</a>。涉及到的参数有：</p>
<ol>
<li>板子层数：PCB 层数，最简单的正反面就是 2 层</li>
<li>成品厚度：整个 PCB 加起来的厚度，例如 1.6mm</li>
<li>内层铜厚：夹在内部的 PCB 的铜的厚度，例如 0.5 oz，就是 1.37/2=0.685 mil</li>
<li>外层铜厚：PCB 上下暴露在外面的两层的铜的厚度，常见 1 oz=1.37 mil</li>
<li>需求阻抗：协议所要求的阻抗，例如单端 50 欧姆（SDIO），差分 90 欧姆（USB）</li>
<li>阻抗模式：传输线的连接方式，见下（图源 KiCad）<ol>
<li>单端阻抗（Microstrip Line）：一根线传输信号，地线在另一个平面，图中上面的长方形就是传输线，底部就是地平面
<img alt="" src="../../../../hardware/microstrip_line.png" /></li>
<li>差分阻抗（Coupled Microstrip Line）：差分线传输信号，地线在另一个平面，图中上方两个长方形就是差分传输线，底部是地平面
<img alt="" src="../../../../hardware/couple_microstrip_line.png" /></li>
<li>共面单端：一根线传输信号，周围就是地平面
<img alt="" src="../../../../hardware/coplanar_wave_guide.png" />
<img alt="" src="../../../../hardware/coplanar_wave_guide_ground_plane.png" /></li>
<li>共面差分：差分线传输信号，周围就是地平面</li>
</ol>
</li>
<li>阻抗层：传输线所在的层</li>
<li>参考层：地线所在的层</li>
</ol>
<p>由于双层 PCB 的两层铜之间距离比较远（例如 57.68 mil），如果采用单端阻抗，那么需要比较大的线宽，例如用 jlc 阻抗计算器，50 欧姆阻抗需要 106.68 mil 的线宽。如果采用四层 PCB，最上面两层之间距离缩小了很多（例如 7.99 mil），此时即使用单端阻抗，用 jlc 计算得出只需要 13.2 mil 的线宽。所以双层 PCB 更适合使用共面单端的方式，此时传输线和地线放在了同一个平面，距离比较小，就不需要那么大的线宽。</p>
<p>这里的单位：1 mil = 0.0254 mm，1 inch = 1000 mil = 0.0254 m，1 oz = 1.37 mil = 0.0348 mm</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-03-03 00:00:00+00:00">2021年3月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="idrac-各版本"><a class="toclink" href="../../../../system/2021/03/03/idrac-versions/">iDRAC 各版本</a></h2>
<h3 id="idrac-版本"><a class="toclink" href="../../../../system/2021/03/03/idrac-versions/#idrac-版本">iDRAC 版本</a></h3>
<p>目前接触到的 iDRAC 版本有：7 8 9。一些常见的服务器型号和 iDRAC 版本对应关系：</p>
<ul>
<li>7: PowerEdge R320, PowerEdge R720</li>
<li>8: <a href="https://www.dell.com/support/home/en-us/product-support/product/poweredge-r730xd/drivers">PowerEdge R730xd</a>，PowerEdge R630，PowerEdge R730，PowerEdge C4130</li>
<li>9: <a href="https://www.dell.com/support/home/en-us/product-support/product/poweredge-r7425/drivers">PowerEdge R7425</a></li>
</ul>
<p>基本上，如果是 PowerEdge R 什么的，就看第二位数字，就可以推断出版本号了。</p>
<p>下面列举了一下可能会用到的版本。</p>
<h3 id="idrac-7"><a class="toclink" href="../../../../system/2021/03/03/idrac-versions/#idrac-7">iDRAC 7</a></h3>
<p><a href="https://www.dell.com/support/kbdoc/en-us/000175831/support-for-integrated-dell-remote-access-controller-7-idrac7">iDRAC 7 在 2020 年 2 月停止更新了</a>，最新版本是 2.65.65.65。</p>
<p>升级路线参考：<a href="https://www.reddit.com/r/homelab/comments/abuc09/psa_read_this_before_you_upgrade_your_firmware_on/">Reddit</a>。</p>
<ul>
<li>1.66.65 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=3f4wv">下载页面</a>，2014 年 12 月版本。</li>
<li>2.10.10.10 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverId=Y5K20">下载页面</a>，2015 年 4 月版本。</li>
<li>2.65.65.65 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=0ghf4">下载页面</a>，2020 年 3 月版本，添加了 HSTS。</li>
</ul>
<h3 id="idrac-8"><a class="toclink" href="../../../../system/2021/03/03/idrac-versions/#idrac-8">iDRAC 8</a></h3>
<ul>
<li>2.10.10.10 <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=fm1pc">下载页面</a>，2015 年 3 月版本。</li>
<li>2.30.30.30: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=5gchc">下载页面</a>，2016 年 2 月版本，添加了 HTML5 virtual console 支持。</li>
<li>2.60.60.60: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=cx8n2">下载页面</a>，2018 年 6 月版本，添加了 virtual media over HTTP 支持。</li>
<li>2.63.60.61: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=40t1c">下载页面</a>，2019 年 5 月版本。</li>
<li>2.70.70.70: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dnh17">下载页面</a>，2019 年 10 月版本。</li>
<li>2.75.75.75: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=krcxx">下载页面</a>，2020 年 6 月版本。</li>
<li>2.75.100.75: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dpv0r">下载页面</a>，2021 年 1 月版本。</li>
<li>2.80.80.80: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=vdd4r">下载页面</a>，2021 年 5 月版本。</li>
<li>2.81.81.81: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=5hn4r">下载页面</a>，2021 年 7 月版本。</li>
<li>2.82.82.82: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=wgnhp">下载页面</a>，2021 年 12 月版本。</li>
<li>2.83.83.83: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=ddk5r">下载页面</a>，2022 年 4 月版本。</li>
<li>2.84.84.84: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=g79dw">下载页面</a>，2023 年 3 月版本。</li>
<li>2.85.85.85: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=j3jtj">下载页面</a>，2023 年 10 月版本。</li>
<li>2.86.86.86: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=vwf72">下载页面</a>，2024 年 04 月版本。</li>
</ul>
<h3 id="idrac-9"><a class="toclink" href="../../../../system/2021/03/03/idrac-versions/#idrac-9">iDRAC 9</a></h3>
<ul>
<li>4.00.00.00: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=4jcpk">下载页面</a>，2019 年 12 月版本。LLDP 连接视图。</li>
<li>4.22.00.00: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=9f2tg">下载页面</a>，2020 年 7 月版本。</li>
<li>4.40.00.00: <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=62gw1">下载页面</a>，2020 年 12 月版本，下一代的 iDRAC virtual console 和 virtual media，支持 Infiniband。</li>
<li>5.00.00.00: <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=f87rp">下载页面</a>，2021 年 6 月版本。</li>
<li>7.00.00.00: <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=kh4xx">下载页面</a>，2023 年 6 月版本。</li>
<li>7.00.00.174: <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=c2vdg">下载页面</a>，2024 年 11 月版本。</li>
</ul>
<h3 id="在线升级"><a class="toclink" href="../../../../system/2021/03/03/idrac-versions/#在线升级">在线升级</a></h3>
<p>iDRAC 可以在线从 Dell 官网下载新版本升级，在网页上选择通过 HTTPS 升级，域名写 <downloads.dell.com> ，具体见<a href="https://www.dell.com/support/kbdoc/zh-cn/000130533/dell-poweredge-how-to-update-the-firmware-via-https-connection-to-idrac?lang=en">文档</a>。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-15 00:00:00+00:00">2021年2月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="使用-sssd-的-ldap-认证"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/">使用 SSSD 的 LDAP 认证</a></h2>
<h3 id="前言"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#前言">前言</a></h3>
<p>最近在研究替换一个老的用户系统，于是顺便学习了一下 LDAP，还有 SSSD。LDAP 是一个目录协议，顺带的，因为用户信息也可以存在里面，所以也就成了一个常见的用户认证协议。SSSD 就是一个 daemon，把系统的 NSS PAM 的机制和 LDAP 连接起来。</p>
<h3 id="配置"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#配置">配置</a></h3>
<p>其实很简单，安装 sssd 并且配置即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>sssd
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>/etc/sssd/sssd.conf
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># file content:</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="o">[</span>sssd<span class="o">]</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nv">config_file_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="nv">services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nss,pam
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="nv">domains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LDAP
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="o">[</span>domain/LDAP<span class="o">]</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="nv">cache_credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="nv">enumerate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="nv">entry_cache_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="nv">ldap_network_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="nv">id_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="nv">auth_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="nv">chpass_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="nv">ldap_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap://127.0.0.1/
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="nv">ldap_chpass_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ldap://127.0.0.1/
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="nv">ldap_search_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="nv">ldap_default_bind_dn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cn</span><span class="o">=</span>localhost,ou<span class="o">=</span>machines,dc<span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="nv">ldap_default_authtok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>REDACTED
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>sssd
</span></code></pre></div>
<p>一些字段需要按照实际情况编写，请参考<a href="https://manpages.debian.org/testing/sssd-common/sssd.conf.5.en.html">sssd.conf</a> 和 <a href="https://manpages.debian.org/testing/sssd-ldap/sssd-ldap.5.en.html">sssd-ldap</a>。</p>
<h3 id="协议"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#协议">协议</a></h3>
<p>那么，LDAP 里面的用户是如何和 Linux 里的用户对应起来的呢？可以看到，SSSD 会查询 posixAccount：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>(&amp;(objectclass=posixAccount)(uid=*)(uidNumber=*)(gidNumber=*))
</span></code></pre></div>
<p>然后，可以查到 <a href="https://ldapwiki.com/wiki/PosixAccount">posixAccount 的 schema</a>，里面可以见到对应 <code>/etc/passwd</code> 的各个字段。相应的，也有 <code>shadowAccount</code> 对应 <code>/etc/shadow</code>。</p>
<p>按照要求配好以后（建议用 ldapvi 工具），就可以用 <code>getent passwd</code> 看到新增的用户了。</p>
<p>上面的部分是通过 NSS 接口来查询的，除了用户以外，还有其他的一些 NIS 信息可以通过 LDAP 查询。此外，如果要登录的话，则是用 PAM 认证，SSSD 则会把 PAM 认证转换成 LDAP 的 Bind：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>su<span class="w"> </span><span class="nb">test</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>Password:
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="c1"># sssd: bind to dn of test user with password</span>
</span></code></pre></div>
<p>如果 Bind 成功，则认为登录成功；否则就是登录失败。</p>
<p>如果用户要修改密码，SSSD 默认用的是 <a href="https://tools.ietf.org/html/rfc3062">RFC3062 LDAP Password Modify Extended Operation</a> 的方式；如果服务器不支持的话，可以按照 <a href="https://sssd.io/docs/design_pages/chpass_without_exop.html">文档</a> 使用 ldap modify 方式来修改密码。</p>
<p>SSD 还可以<a href="https://linux.die.net/man/5/sssd-sudo">配置 sudo 支持</a>，也是用类似的方法，添加 objectClass=sudoRole 的目录项即可。可以参考 <a href="https://linux.die.net/man/5/sudoers.ldap">man sudoers.ldap</a> 编写对应的目录项。</p>
<p>对于 SSH 配置，可以参考 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/openssh-sssd">RedHat 的文档</a>，和参考 <a href="https://www.systutorials.com/docs/linux/man/1-sss_ssh_authorizedkeys/">man sss_ssh_authorizedkeys</a> 配置 authorized keys 命令。然后，给用户添加 <code>sshPublicKey</code> 属性即可，内容与 <code>~/.ssh/id_*.pub</code> 一致。</p>
<h3 id="相关-rfc"><a class="toclink" href="../../../../software/2021/02/15/sssd-ldap/#相关-rfc">相关 RFC</a></h3>
<p><a href="https://ldap.com/ldap-related-rfcs/">LDAP-Related RFCs</a></p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc2307">RFC2307 An Approach for Using LDAP as a Network Information Service</a></li>
<li><a href="https://tools.ietf.org/html/rfc3062">RFC3062 LDAP Password Modify Extended Operation</a></li>
<li><a href="https://tools.ietf.org/html/rfc4511">RFC4511 Lightweight Directory Access Protocol (LDAP): The Protocol</a></li>
<li><a href="https://tools.ietf.org/html/rfc4512">RFC4512 Lightweight Directory Access Protocol (LDAP): Directory Information Models</a></li>
<li><a href="https://tools.ietf.org/html/rfc4513">RFC4513 Lightweight Directory Access Protocol (LDAP): Authentication Methods and Security Mechanisms</a></li>
<li><a href="https://tools.ietf.org/html/rfc4517">RFC4517 Lightweight Directory Access Protocol (LDAP): Syntaxes and Matching Rules</a></li>
<li><a href="https://tools.ietf.org/html/rfc4519">RFC4519 Lightweight Directory Access Protocol (LDAP): Schema for User Applications</a></li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-09 00:00:00+00:00">2021年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-big-surm1-上解决-latex-找不到楷体字体的问题"><a class="toclink" href="../../../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/">在 Big Sur(M1) 上解决 LaTeX 找不到楷体字体的问题</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#背景">背景</a></h3>
<p>最近在尝试移植 <a href="https://github.com/MiKTeX/miktex/pull/710">MiKTeX 到 Apple Silicon 上</a>，添加了一些 patch 以后就可以工作了，但遇到了新的问题，即找不到 KaiTi</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/tex/latex/ctex/fontset/ctex-fontset-macnew.def:99:
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">   </span>Package<span class="w"> </span>fontspec<span class="w"> </span>Error:
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">      </span>The<span class="w"> </span>font<span class="w"> </span><span class="s2">&quot;Kaiti SC&quot;</span><span class="w"> </span>cannot<span class="w"> </span>be<span class="w"> </span>found.
</span></code></pre></div>
<p>用 <code>miktex-fc-list</code> 命令找了一下，确实没有找到：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>/Applications/MiKTeX<span class="se">\ </span>Console.app/Contents/bin/miktex-fc-list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Kaiti
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="c1"># Nothing</span>
</span></code></pre></div>
<p>上网搜了一下，找到了一个<a href="https://www.jianshu.com/p/8f35c57901e3">解决方案</a>：字体在目录 <code>/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ATS.framework/Versions/A/Support/FontSubsets/Kaiti.ttc</code> 里，所以手动安装一下，就可以让 LaTeX 找到了。但我觉得，与其安装多一份在文件系统里，不如让 LaTeX 去找它。</p>
<h3 id="解决方法"><a class="toclink" href="../../../../software/2021/02/09/big-sur-m1-latex-kaiti-fonts/#解决方法">解决方法</a></h3>
<p>按照上面的线索，找到了 <code>Kaiti.ttc</code> 所在的路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>fd<span class="w"> </span>Kaiti.ttc
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc
</span></code></pre></div>
<p>可以看到，和上面的路径又不大一样。研究了一下 fontconfig，发现可以用 <code>miktex-fc-conflist</code> 找到配置文件的目录：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$<span class="w"> </span>/Applications/MiKTeX<span class="se">\ </span>Console.app/Contents/bin/miktex-fc-conflist
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>+<span class="w"> </span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/config/fontconfig/config/localfonts2.conf:<span class="w"> </span>No<span class="w"> </span>description
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>+<span class="w"> </span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/config/fontconfig/config/localfonts.conf:<span class="w"> </span>No<span class="w"> </span>description
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>...
</span></code></pre></div>
<p>看了下第一个文件（localfonts.conf）：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="cm">&lt;!--</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="cm">  DO NOT EDIT THIS FILE! It will be replaced when MiKTeX is updated.</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="cm">  Instead, edit the configuration file localfonts2.conf.</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="cm">--&gt;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="nt">&lt;fontconfig&gt;</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="nt">&lt;include&gt;</span>localfonts2.conf<span class="nt">&lt;/include&gt;</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="nt">&lt;dir&gt;</span>/Library/Fonts/<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="nt">&lt;dir&gt;</span>/System/Library/Fonts/<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/type1<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/opentype<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="nt">&lt;dir&gt;</span>~/Library/Application<span class="w"> </span>Support/MiKTeX/texmfs/install/fonts/truetype<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="nt">&lt;/fontconfig&gt;</span>
</span></code></pre></div>
<p>可以看到，我们可以添加路径，不过建议修改的是 <code>localfonts2.conf</code>。按照类似的格式，修改成：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">&lt;fontconfig&gt;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nt">&lt;dir&gt;</span>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets<span class="nt">&lt;/dir&gt;</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="cm">&lt;!-- REMOVE THIS LINE</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="cm">&lt;dir&gt;Your font directory here&lt;/dir&gt;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="cm">     REMOVE THIS LINE --&gt;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="nt">&lt;/fontconfig&gt;</span>
</span></code></pre></div>
<p>UPDATE: 新版本 macOS 中，路径建议加上 <code>/System/Library/AssetsV2/com_apple_MobileAsset_Font7</code>：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nt">&lt;dir&gt;</span>/System/Library/AssetsV2/com_apple_MobileAsset_Font7<span class="nt">&lt;/dir&gt;</span>
</span></code></pre></div>
<p>这样，就可以找到 Kaiti SC 了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>$<span class="w"> </span>miktex-fc-list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Kaiti
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Regular,標準體,常规体
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Regular,標準體,常规体
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Bold,粗體,粗体
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Bold,粗體,粗体
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>SC,楷體<span class="se">\-</span>簡,楷体<span class="se">\-</span>简:style<span class="o">=</span>Black,黑體,黑体
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>Kaiti<span class="w"> </span>TC,楷體<span class="se">\-</span>繁,楷体<span class="se">\-</span>繁:style<span class="o">=</span>Black,黑體,黑体
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc:<span class="w"> </span>STKaiti:style<span class="o">=</span>Regular,標準體,Ordinær,Normal,Normaali,Regolare,レギュラー,일반체,Regulier,Обычный,常规体
</span></code></pre></div>
<p>这样就搞定了，用 LaTeX 找字体的时候也没有出现问题了。</p>
<p>如果你用的是 TeX Live，那么直接把上面的 Kaiti.ttc 路径复制到 <code>~/Library/Fonts</code> 下即可。</p>
<p>如果是用 Nixpkgs 装的 Tex Live，则建议用符号链接的方法，把相关的字体添加到 <code>~/Library/Fonts</code> 下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nb">cd</span><span class="w"> </span>~/Library/Fonts
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>ln<span class="w"> </span>-s<span class="w"> </span>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/华文细黑.ttf<span class="w"> </span><span class="c1"># STHeiti</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>ln<span class="w"> </span>-s<span class="w"> </span>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/华文仿宋.ttf<span class="w"> </span><span class="c1"># STFangsong</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>ln<span class="w"> </span>-s<span class="w"> </span>/System/Library/PrivateFrameworks/FontServices.framework/Versions/A/Resources/Fonts/Subsets/Kaiti.ttc<span class="w"> </span><span class="c1"># STKaiti</span>
</span></code></pre></div>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-09 00:00:00+00:00">2021年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="common-符号"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/">COMMON 符号</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#背景">背景</a></h3>
<p>在编译一个程序的时候，遇到了 undefined symbol 的问题。具体情况是这样的：</p>
<ol>
<li>一开始的时候，直接把所有的源代码编译成 <code>.o</code>，再一次性链接，这样不会报错</li>
<li>后来，把一些代码编译成静态库，即把其中一部分源代码编译成 <code>.o</code> 后，用 <code>ar</code> 合并到一个 <code>.a</code> 中，再和其余的 <code>.o</code> 链接在一起，这时候就报错了：</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>Undefined symbols for architecture arm64:
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>  &quot;_abcd&quot;, referenced from:
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    ...
</span></code></pre></div>
<p>如果换台机器，编译（使用的是 gcc 10.2.0）就没有问题。</p>
<p>而如果去找这个符号存在的 <code>.o</code> 里，是可以找到的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/path/to/abcd.o
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="m">0000000000000028</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000008</span><span class="w"> </span>_abcd
</span></code></pre></div>
<p>在合成的静态库 <code>.a</code> 里，也是存在的（一个定义 + 若干个引用）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/path/to/libabc.a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>abcd
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="m">0000000000000028</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000008</span><span class="w"> </span>_abcd
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_abcd
</span></code></pre></div>
<p>于是觉得很奇怪，就上网搜了一下，找到了一篇 <a href="https://stackoverflow.com/questions/63665653/different-behavior-between-clang-and-gcc-10-when-linking-to-static-library-conta">StackOverflow</a> 讲了这个问题。解决方案很简单，就是：</p>
<p><strong>编译的时候打开 <code>-fno-common</code> 设置</strong></p>
<p>而 gcc 10 不会出错的原因是，它默认从 <code>-fcommon</code> 改成了 <code>-fno-common</code> 。</p>
<h3 id="common-是什么"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#common-是什么">COMMON 是什么</a></h3>
<p>这时候，肯定不满足于找到一个解决方案，肯定还是会去找背后的原理。</p>
<p>首先，搜索了一下 COMMON 是什么，找到了 <a href="https://binarydodo.wordpress.com/2016/05/09/investigating-linking-with-common-symbols-in-elf/">Investigating linking with COMMON symbols in ELF</a> 这篇文章。</p>
<p>文章里讲了 COMMON 是做什么的：</p>
<blockquote>
<p>Common symbols are a feature that allow a programmer to 'define' several variables of the same name in different source files.  This is in contrast with the more popular way of doing, where you define a variable once in a source file, and reference it everywhere else in other source files, using extern.  When common symbols are used, the linker will merge all symbols of the same name into a single memory location, the size of which is the largest type of the individual common symbol definitions.  For example, if fileA.c defines an uninitialized 32-bit integer myint, and fileB.c defines an 8-bit char myint, then in the final executable, references to myint from both files will point to the same memory location (common location), and the linker will reserve 32 bits for that location.</p>
</blockquote>
<p>文章里还讲了具体的实现方法：一个没有初始化的全局变量，在 <code>-fcommon</code> 的情况下，会设为 COMMON；如果有初始化，就按照初始化的值预分配到 .bss 或者 .data。链接的时候，如果有多个同名的 symbol，会有一个规则决定最后的 symbol 放到哪里；如果有冲突的话，就是我们熟悉的 <code>multiple definition</code> 错误了。</p>
<p>为啥会有这种需求，多个 variable 同名，不会冲突而且共享内存？又在别的地方看到说法，COMMON 是给 <code>ancient</code> 代码使用的，还有的提到了 FORTRAN。于是去搜了一下，果然，FORTRAN 是问题的关键</p>
<h3 id="fortran-里面的-common"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#fortran-里面的-common">FORTRAN 里面的 COMMON</a></h3>
<p>用关键词很容易可以搜索到讲 <a href="https://www.obliquity.com/computer/fortran/common.html">COMMON BLOCK in FORTRAN 的文章</a>，FORTRAN 里面的 COMMON 是一种通过全局存储隐式传递参数的方法。拿文章里的例子：</p>
<div class="language-fortran highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="w">      </span><span class="k">PROGRAM </span><span class="n">MAIN</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">      </span><span class="kt">INTEGER </span><span class="n">A</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">      </span><span class="kt">REAL    </span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">      </span><span class="k">COMMON  </span><span class="n">R</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">F</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">      </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">14</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">      </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="mf">9.9</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">      </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">      </span><span class="k">CALL </span><span class="n">SUB</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">      </span><span class="k">END</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="k">      SUBROUTINE </span><span class="n">SUB</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">      </span><span class="kt">INTEGER </span><span class="n">I</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">      </span><span class="kt">REAL    </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">      </span><span class="k">COMMON  </span><span class="n">A</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">B</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">      </span><span class="k">END</span>
</span></code></pre></div>
<p>在函数 MAIN 和 SUB 中，都有 COMMON 语句，而 COMMON 后面的变量，就是存储在一个 COMMON 的 symbol 之中，按照顺序映射到 symbol 的内存地址。尝试编译一下上面的代码，然后看一下 symbol：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$<span class="w"> </span>gfortran<span class="w"> </span>-g<span class="w"> </span>-c<span class="w"> </span>test.f<span class="w"> </span>-o<span class="w"> </span>test.o
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>test.o
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="m">0000000000000078</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_main
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="m">0000000000000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_sub_
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>000000000000000c<span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>___BLNK__
</span></code></pre></div>
<p>可以看到，出现了一个叫做 <code>___BLNK__</code> 的 COMMON symbol，大小是 16 字节。看一下代码中是如何引用的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-S<span class="w"> </span>--reloc<span class="w"> </span>test.o
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>Disassembly<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>__TEXT,__text:
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="m">0000000000000018</span><span class="w"> </span>_MAIN__:
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="p">;</span><span class="w">         </span>PROGRAM<span class="w"> </span>MAIN
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">      </span><span class="m">18</span>:<span class="w"> </span>fd<span class="w"> </span>7b<span class="w"> </span>be<span class="w"> </span>a9<span class="w">                   </span>stp<span class="w"> </span>x29,<span class="w"> </span>x30,<span class="w"> </span><span class="o">[</span>sp,<span class="w"> </span><span class="c1">#-32]!</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">      </span>1c:<span class="w"> </span>fd<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>mov<span class="w"> </span>x29,<span class="w"> </span>sp
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="p">;</span><span class="w">         </span><span class="nv">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-14
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">      </span><span class="m">20</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">        </span><span class="m">0000000000000020</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">      </span><span class="m">24</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">        </span><span class="m">0000000000000024</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">      </span><span class="m">28</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">12</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#-14</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">      </span>2c:<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>b9<span class="w">                   </span>str<span class="w"> </span>w1,<span class="w"> </span><span class="o">[</span>x0,<span class="w"> </span><span class="c1">#4]</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="p">;</span><span class="w">         </span><span class="nv">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">99</span>.9
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">      </span><span class="m">30</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">        </span><span class="m">0000000000000030</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">      </span><span class="m">34</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">        </span><span class="m">0000000000000034</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">      </span><span class="m">38</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">52</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#52429</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">      </span>3c:<span class="w"> </span>e1<span class="w"> </span><span class="m">58</span><span class="w"> </span>a8<span class="w"> </span><span class="m">72</span><span class="w">                   </span>movk<span class="w">    </span>w1,<span class="w"> </span><span class="c1">#17095, lsl #16</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">      </span><span class="m">40</span>:<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">27</span><span class="w"> </span>1e<span class="w">                   </span>fmov<span class="w">    </span>s0,<span class="w"> </span>w1
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">      </span><span class="m">44</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>bd<span class="w">                   </span>str<span class="w"> </span>s0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="p">;</span><span class="w">         </span><span class="nv">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.2
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">      </span><span class="m">48</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">        </span><span class="m">0000000000000048</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>___BLNK__
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="w">      </span>4c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w"> </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="w">        </span>000000000000004c:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">   </span>___BLNK__
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="w">      </span><span class="m">50</span>:<span class="w"> </span>a1<span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">99</span><span class="w"> </span><span class="m">52</span><span class="w">                   </span>mov<span class="w"> </span>w1,<span class="w"> </span><span class="c1">#52429</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="w">      </span><span class="m">54</span>:<span class="w"> </span><span class="m">81</span><span class="w"> </span>c9<span class="w"> </span>a7<span class="w"> </span><span class="m">72</span><span class="w">                   </span>movk<span class="w">    </span>w1,<span class="w"> </span><span class="c1">#15948, lsl #16</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="w">      </span><span class="m">58</span>:<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">27</span><span class="w"> </span>1e<span class="w">                   </span>fmov<span class="w">    </span>s0,<span class="w"> </span>w1
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="w">      </span>5c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">08</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>bd<span class="w">                   </span>str<span class="w"> </span>s0,<span class="w"> </span><span class="o">[</span>x0,<span class="w"> </span><span class="c1">#8]</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="p">;</span><span class="w">         </span>CALL<span class="w"> </span>SUB<span class="o">(</span>X,Y<span class="o">)</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a><span class="w">      </span><span class="m">60</span>:<span class="w"> </span>e1<span class="w"> </span><span class="m">63</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w"> </span>x1,<span class="w"> </span>sp,<span class="w"> </span><span class="c1">#24</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="w">      </span><span class="m">64</span>:<span class="w"> </span>e0<span class="w"> </span><span class="m">73</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w"> </span>x0,<span class="w"> </span>sp,<span class="w"> </span><span class="c1">#28</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a><span class="w">      </span><span class="m">68</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">94</span><span class="w">                   </span>bl<span class="w">  </span><span class="c1">#0 &lt;_MAIN__+0x50&gt;</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a><span class="w">        </span><span class="m">0000000000000068</span>:<span class="w">  </span>ARM64_RELOC_BRANCH26<span class="w"> </span>_sub_
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a><span class="p">;</span><span class="w">         </span>END
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a><span class="w">      </span>6c:<span class="w"> </span>1f<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">03</span><span class="w"> </span>d5<span class="w">                   </span>nop
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a><span class="w">      </span><span class="m">70</span>:<span class="w"> </span>fd<span class="w"> </span>7b<span class="w"> </span>c2<span class="w"> </span>a8<span class="w">                   </span>ldp<span class="w"> </span>x29,<span class="w"> </span>x30,<span class="w"> </span><span class="o">[</span>sp<span class="o">]</span>,<span class="w"> </span><span class="c1">#32</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a><span class="w">      </span><span class="m">74</span>:<span class="w"> </span>c0<span class="w"> </span><span class="m">03</span><span class="w"> </span>5f<span class="w"> </span>d6<span class="w">                   </span>ret
</span></code></pre></div>
<p>可以看到，在 MAIN 中引用 <code>A</code> 的时候，取的地址是 <code>___BLNK__+4</code>，<code>R</code> 是 <code>___BLNK__+0</code>，<code>F</code> 是 <code>___BLNK__+8</code>。这和代码里的顺序也是一致的。所以在 SUB 中读 A I B 的时候，对应了 MAIN 中的 A R F。通过这种方式，可以在 MAIN 函数里面隐式地给所有函数传递参数。</p>
<p>此外，COMMON 还可以命名，这样就可以区分不同的参数用途：</p>
<div class="language-fortran highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="w">        </span><span class="k">PROGRAM </span><span class="n">MAIN</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">        </span><span class="kt">INTEGER </span><span class="n">A</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">        </span><span class="kt">REAL    </span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">        </span><span class="k">COMMON  </span><span class="n">R</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">F</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">        </span><span class="k">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">14</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">        </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="mf">9.9</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">        </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">        </span><span class="k">CALL </span><span class="n">SUB</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">        </span><span class="k">END</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="k">        SUBROUTINE </span><span class="n">SUB</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="kt">INTEGER </span><span class="n">I</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">        </span><span class="kt">REAL    </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">Q</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">        </span><span class="k">COMMON  </span><span class="n">A</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">B</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">        </span><span class="k">END</span>
</span></code></pre></div>
<p>代码添加了一行 <code>COMMON /test/</code>，观察一下 symbol：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>test.o
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>test.o:<span class="w"> </span>file<span class="w"> </span>format<span class="w"> </span>Mach-O<span class="w"> </span>arm64
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="m">0000000000000088</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_main
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="m">0000000000000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_sub_
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>000000000000000c<span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>___BLNK__
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="m">0000000000000008</span><span class="w">         </span>*COM*<span class="w">  </span><span class="m">00000010</span><span class="w"> </span>_test_
</span></code></pre></div>
<p>和预期的一致：出现了新的 COMMON symbol，对应了 named COMMON Block 里面的变量 X 和 Y。</p>
<p>再看一下汇编里怎么引用的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="p">;</span><span class="w">         </span>CALL<span class="w"> </span>SUB<span class="o">(</span>X,Y<span class="o">)</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">      </span><span class="m">60</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">                </span><span class="m">0000000000000060</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>_test_
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">      </span><span class="m">64</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w">     </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">                </span><span class="m">0000000000000064</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">       </span>_test_
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">      </span><span class="m">68</span>:<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">91</span><span class="w">                   </span>add<span class="w">     </span>x1,<span class="w"> </span>x0,<span class="w"> </span><span class="c1">#4</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">      </span>6c:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">90</span><span class="w">                   </span>adrp<span class="w">    </span>x0,<span class="w"> </span><span class="c1">#0</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">                </span>000000000000006c:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGE21<span class="w">  </span>_test_
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">      </span><span class="m">70</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span>f9<span class="w">                   </span>ldr<span class="w">     </span>x0,<span class="w"> </span><span class="o">[</span>x0<span class="o">]</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">                </span><span class="m">0000000000000070</span>:<span class="w">  </span>ARM64_RELOC_GOT_LOAD_PAGEOFF12<span class="w">       </span>_test_
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">      </span><span class="m">74</span>:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">94</span><span class="w">                   </span>bl<span class="w">      </span><span class="c1">#0 &lt;_MAIN__+0x5c&gt;</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">                </span><span class="m">0000000000000074</span>:<span class="w">  </span>ARM64_RELOC_BRANCH26<span class="w"> </span>_sub_
</span></code></pre></div>
<p>可以看到，第一个参数（x0）为 <code>_test_</code>，第二个参数（x1）为 <code>_test_+4</code>，和预期也是一样的。</p>
<p>读到这里，就可以理解为啥有 COMMON symbol 了。可能是为了让 C 代码和 FORTRAN 代码可以互操作 COMMON symbol，就有了这么一出。也可能有的 C 库确实用了类似的方法来实现某些功能。</p>
<h3 id="解决方案"><a class="toclink" href="../../../../software/2021/02/09/common-symbols-linking/#解决方案">解决方案</a></h3>
<p>但是，这种用法在现在来看是不推荐的，建议还是该 extern 就 extern，另外，在编译静态库的时候，记得加上 <code>-fno-common</code>。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-01-26 00:00:00+00:00">2021年1月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="skid-buffer"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/">Skid Buffer</a></h2>
<h3 id="skid-buffer_1"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#skid-buffer_1">Skid buffer</a></h3>
<p>Skid buffer 指的就是，对于 valid + ready 的握手信号，用空间（更多的逻辑）来换取时间（更好的时序）的一个硬件模块。</p>
<p>简单来说，背景就是，为了解决 valid 和 ready 信号在数据流水线上一路经过组合逻辑导致的时序问题，在中途加上一些寄存器来阻隔。当然了，代价就是延迟和面积，不过吞吐量还是需要保持的。</p>
<p>由于需求的不同，Skid buffer 也有不同的实现。目前，找到了四个实现，实现上有所不同，特性也不大一样。</p>
<h4 id="统一约定"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#统一约定">统一约定</a></h4>
<p>由于我在 SpinalHDL 语言中重新实现了下面的这些 Skid buffer，所以按照 SpinalHDL 的 Stream 定义接口：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SkidBufferCommon</span><span class="p">[</span><span class="nc">T</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="nc">Data</span><span class="p">](</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="n">gen</span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">T</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">(</span><span class="nc">Stream</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>在这里，<code>io.s</code> 表示从上游取的数据，<code>io.m</code> 表示传递给下游的数据。</p>
<p>输出信号共有：<code>io.s.ready</code>、<code>io.m.valid</code> 和 <code>io.m.payload</code>。</p>
<h4 id="zipcpu-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#zipcpu-版本">ZipCPU 版本</a></h4>
<p>第一个版本来自 ZipCPU：</p>
<p>博客地址：<a href="https://zipcpu.com/blog/2019/05/22/skidbuffer.html">Building a Skid Buffer for AXI processing</a>
代码地址：<a href="https://github.com/ZipCPU/wb2axip/blob/master/rtl/skidbuffer.v">skidbuffer.v</a></p>
<p>它有两个参数，一个表示是否有额外的输出寄存器（outputReg），一个表示是否低功耗（lowPower）。</p>
<h4 id="fpgacpu-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#fpgacpu-版本">FPGACPU 版本</a></h4>
<p>第二个版本来自 FPGACPU：</p>
<p>文章地址：<a href="http://fpgacpu.ca/fpga/Pipeline_Skid_Buffer.html">Pipeline Skid Buffer</a></p>
<h4 id="spinalhdl-s2m-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#spinalhdl-s2m-版本">SpinalHDL S2M 版本</a></h4>
<p>第三个版本来自 SpinalHDL Library 的 s2mPipe：</p>
<p>代码地址：<a href="https://github.com/SpinalHDL/SpinalHDL/blob/f9eda46bb5968659fe4e97cad8b69c8c0cb2bf89/lib/src/main/scala/spinal/lib/Stream.scala#L348">Stream.scala L348</a></p>
<h4 id="spinalhdl-m2s-版本"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#spinalhdl-m2s-版本">SpinalHDL M2S 版本</a></h4>
<p>第四个版本来自 SpinalHDL Library 的 m2sPipe：</p>
<p>代码地址：<a href="https://github.com/SpinalHDL/SpinalHDL/blob/f9eda46bb5968659fe4e97cad8b69c8c0cb2bf89/lib/src/main/scala/spinal/lib/Stream.scala#L327">Stream.scala L327</a></p>
<h4 id="四个版本的对比"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#四个版本的对比">四个版本的对比</a></h4>
<p>在研究了代码以后，可以看到这四个版本的区别：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>ZipCPU w/ outputReg</th>
<th>ZipCPU w/o outputReg</th>
<th>FPGACPU</th>
<th>S2M</th>
<th>M2S</th>
</tr>
</thead>
<tbody>
<tr>
<td>io.s.ready</td>
<td>Reg</td>
<td>Reg</td>
<td>Reg</td>
<td>Reg</td>
<td>Comb</td>
</tr>
<tr>
<td>io.m.valid</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
</tr>
<tr>
<td>io.m.payload</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
<td>Comb</td>
<td>Reg</td>
</tr>
<tr>
<td>latency</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>buffer 数量</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>注：</p>
<ol>
<li>Reg 表示从寄存器输出，Comb 表示从组合逻辑输出</li>
<li>Latency 表示从 <code>io.s.fire</code> 到 <code>io.m.fire</code> 的延迟</li>
<li>Buffer 表示缓冲的 payload 个数</li>
<li>ZipCPU w/o outputReg 和 S2M 实现的逻辑是一样的</li>
</ol>
<h4 id="形式化验证"><a class="toclink" href="../../../../hardware/2021/01/26/skid-buffer/#形式化验证">形式化验证</a></h4>
<p>为了确认上面这些类型的 Skid Buffer 都可以正常工作，按照 ZipCPU Skid Buffer 的文章，也照着写了几个 property：</p>
<p>1: 在 valid &amp;&amp; ~ready 的时候，valid 需要继续保持为高，并且 payload 不变：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">// When valid goes high, data is stable and valid stays high before ready</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">when</span><span class="p">(</span><span class="n">past</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">stream</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">outerReset</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="n">slaveAssume</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="p">);</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dataStable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="n">slaveAssume</span><span class="p">(</span><span class="n">stable</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">asBits</span><span class="p">));</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>2: 在 reset 释放的第一个周期里，valid 不能为高：</p>
<p>参考 AXI 标准 (IHI0022E Page 38 A3.1.2) 原文：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>The earliest point after reset that a master is permitted to begin driving ARVALID, AWVALID, or WVALID HIGH is at a rising ACLK edge after ARESETn is HIGH.
</span></code></pre></div>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// Valid is low in the first cycle after reset falls</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">when</span><span class="p">(</span><span class="n">pastValid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">past</span><span class="p">(</span><span class="n">outerReset</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">outerReset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">slaveAssume</span><span class="p">(</span><span class="o">~</span><span class="n">stream</span><span class="p">.</span><span class="n">valid</span><span class="p">);</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>3: 添加 cover property，要求 <code>io.s</code> 和 <code>io.m</code> 可以连续若干个周期 valid &amp;&amp; ready，保证吞吐率：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">cover</span><span class="p">(</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="n">pastValid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span><span class="n">pastValid</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">        </span><span class="o">~</span><span class="n">outerReset</span><span class="p">,</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="n">cycles</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">genPast</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">fire</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">cycles</span><span class="p">)</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="p">)</span>
</span></code></pre></div>
<p>采用 <code>yosys-smtbmc</code> 工具验证了以上四种 Skid buffer 都满足这些属性。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-01-02 00:00:00+00:00">2021年1月2日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-m1-上用-qemu-运行-debian-虚拟机"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/">在 M1 上用 QEMU 运行 Debian 虚拟机</a></h2>
<h3 id="背景"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#背景">背景</a></h3>
<p>看到 @jsteward 在 M1 的 QEMU 中运行了 Windows on ARM，所以我先来试试 Debian on AArch64，这样会简单一些。</p>
<p>参考：https://gist.github.com/niw/e4313b9c14e968764a52375da41b4278#file-readme-md</p>
<p>大约需要 3G 的硬盘空间。</p>
<h3 id="安装-qemu-w-m1-patches"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#安装-qemu-w-m1-patches">安装 QEMU w/ M1 patches</a></h3>
<p>目前上游的 QEMU 还不支持 M1 的 Hypervisor framework，需要打 patch：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/git/qemu.git
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nb">cd</span><span class="w"> </span>qemu
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>git<span class="w"> </span>checkout<span class="w"> </span>master<span class="w"> </span>-b<span class="w"> </span>wip/hvf
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>curl<span class="w"> </span><span class="s1">&#39;https://patchwork.kernel.org/series/400619/mbox/&#39;</span><span class="p">|</span>git<span class="w"> </span>am<span class="w"> </span>--3way
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>mkdir<span class="w"> </span>build
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nb">cd</span><span class="w"> </span>build
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>../configure<span class="w"> </span>--target-list<span class="o">=</span>aarch64-softmmu<span class="w"> </span>--enable-cocoa<span class="w"> </span>--disable-gnutls
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>make<span class="w"> </span>-j4
</span></code></pre></div>
<p>编译后，得到 <code>qemu-system-aarch64</code> 的二进制</p>
<h3 id="准备好文件系统"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#准备好文件系统">准备好文件系统</a></h3>
<p>需要下载 <a href="https://gist.github.com/niw/4f1f9bb572f40d406866f23b3127919b/raw/f546faea68f4149c06cca88fa67ace07a3758268/QEMU_EFI-cb438b9-edk2-stable202011-with-extra-resolutions.tar.gz">EFI 固件</a> 和 <a href="https://mirrors.tuna.tsinghua.edu.cn/debian-cd/current/arm64/iso-cd/debian-10.7.0-arm64-xfce-CD-1.iso">Debian 安装镜像</a>，解压前者以后把文件放同一个目录中，并且创建需要的文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>ls<span class="w"> </span>*.fd
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>QEMU_EFI.fd<span class="w">   </span>QEMU_VARS.fd
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash0.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1m<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">64</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash1.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1m<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">64</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>QEMU_EFI.fd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash0.img<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>notrunc
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>QEMU_VARS.fd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>pflash1.img<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>notrunc
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-img<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>qcow2<span class="w"> </span>disk.qcow2<span class="w"> </span>40G
</span></code></pre></div>
<h3 id="安装-debian-系统"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#安装-debian-系统">安装 Debian 系统</a></h3>
<p>接着，执行以下的命令，然后按照提示安装系统：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span>-M<span class="w"> </span>virt,highmem<span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span>-accel<span class="w"> </span>hvf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span>-cpu<span class="w"> </span>cortex-a72<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span>-m<span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash0.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash,readonly<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash1.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">  </span>-device<span class="w"> </span>virtio-scsi-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">  </span>-device<span class="w"> </span>virtio-gpu-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span>-device<span class="w"> </span>qemu-xhci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">  </span>-device<span class="w"> </span>usb-kbd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">  </span>-device<span class="w"> </span>usb-tablet<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./disk.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>boot,cache<span class="o">=</span>writethrough<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">  </span>-device<span class="w"> </span>nvme,drive<span class="o">=</span>boot,serial<span class="o">=</span>boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">  </span>-drive<span class="w"> </span><span class="k">if</span><span class="o">=</span>none,id<span class="o">=</span>cd,file<span class="o">=</span>debian-10.7.0-arm64-xfce-CD-1.iso,media<span class="o">=</span>cdrom<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">  </span>-device<span class="w"> </span>scsi-cd,drive<span class="o">=</span><span class="nb">cd</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">  </span>-display<span class="w"> </span>default,show-cursor<span class="o">=</span>on
</span></code></pre></div>
<p>需要注意的是，如果用 <code>-cdrom</code> 选项，Debian 会无法识别，所以需要走 SCSI。安装完成后，第一次重启可能会显示失败，不用管。另外，安装界面只在串口处显示，但不会显示在 GUI 中，估计是因为 <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=977466">BUG</a>（感谢 @Harry-Chen 指出）。</p>
<h3 id="启动系统"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#启动系统">启动系统</a></h3>
<p>安装好后，运行下面的命令来启动 Debian 系统：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>$<span class="w"> </span><span class="nv">$QEMU</span>/qemu-system-aarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span>-monitor<span class="w"> </span>stdio<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span>-M<span class="w"> </span>virt,highmem<span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span>-accel<span class="w"> </span>hvf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span>-cpu<span class="w"> </span>cortex-a72<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span>-m<span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash0.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash,readonly<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./pflash1.img,format<span class="o">=</span>raw,if<span class="o">=</span>pflash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">  </span>-device<span class="w"> </span>virtio-gpu-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">  </span>-device<span class="w"> </span>virtio-scsi-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span>-device<span class="w"> </span>qemu-xhci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">  </span>-device<span class="w"> </span>usb-kbd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span>-device<span class="w"> </span>usb-tablet<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./disk.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>boot,cache<span class="o">=</span>writethrough<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">  </span>-device<span class="w"> </span>nvme,drive<span class="o">=</span>boot,serial<span class="o">=</span>boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">  </span>-display<span class="w"> </span>default,show-cursor<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">  </span>-nic<span class="w"> </span>user,model<span class="o">=</span>virtio
</span></code></pre></div>
<p>注意参数和上面有所不同。启动后就可以在 GUI 上看到 Debian 登录的界面了。</p>
<h3 id="网络"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#网络">网络</a></h3>
<p>起来以后，可以看到一个网卡 <code>enp0s1</code> 启动并获取 IP 地址：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>ip<span class="w"> </span>l<span class="w"> </span><span class="nb">set</span><span class="w"> </span>enp0s1<span class="w"> </span>up
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>$<span class="w"> </span>dhclient<span class="w"> </span>enp0s1
</span></code></pre></div>
<p>获取到一个 IP 地址后，就可以上网了。</p>
<h3 id="已知问题"><a class="toclink" href="../../../../software/2021/01/02/aarch64-debian-in-qemu-m1/#已知问题">已知问题</a></h3>
<p>在虚拟机内重启以后，可能会启动失败。退出 QEMU 进程重新启动即可。</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <span class="md-pagination__current">2</span>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../2022/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2022">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                2022
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../2020/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2020">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2020
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>