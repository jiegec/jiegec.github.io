
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维，编程，调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/archive/2020/">
      
      
        <link rel="prev" href="../2021/">
      
      
        <link rel="next" href="../2019/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.2">
    
    
      
        <title>2020 - 杰哥的{运维，编程，调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.d7758b05.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-3109FRSVTT",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2020" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维，编程，调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2020
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/cpu/" class="md-tabs__link">
        
  
    
  
  CPU

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../benchmark/" class="md-tabs__link">
        
  
    
  
  SPEC

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../2025/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../category/crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维，编程，调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维，编程，调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    杰哥的{运维，编程，调板子}小笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jiegec/blog-source" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/cpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SPEC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" checked>
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="">
            
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#以太网的物理接口" class="md-nav__link">
    <span class="md-ellipsis">
      以太网的物理接口
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rust-在-m1-上的-code-signing-问题和临时解决方法" class="md-nav__link">
    <span class="md-ellipsis">
      Rust 在 M1 上的 Code Signing 问题和临时解决方法
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arm-m1-macbook-air-开箱" class="md-nav__link">
    <span class="md-ellipsis">
      ARM M1 MacBook Air 开箱
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-spack-中用-external-的-slurm-依赖编译-openmpi" class="md-nav__link">
    <span class="md-ellipsis">
      在 Spack 中用 external 的 Slurm 依赖编译 OpenMPI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在裸机上部署-esxi-和-vcsa-7" class="md-nav__link">
    <span class="md-ellipsis">
      在裸机上部署 ESXi 和 vCSA 7
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ibm-power-s822lc8335-gtb-bmc-升级" class="md-nav__link">
    <span class="md-ellipsis">
      IBM Power S822LC(8335-GTB) BMC 升级
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-arm64-上使用-rust-analyzer" class="md-nav__link">
    <span class="md-ellipsis">
      在 arm64 上使用 rust-analyzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-rpi4-上运行-buildroot" class="md-nav__link">
    <span class="md-ellipsis">
      在 Rpi4 上运行 buildroot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-rpi4-上用-pxe-运行-alpine-linux" class="md-nav__link">
    <span class="md-ellipsis">
      在 rpi4 上用 PXE 运行 Alpine Linux
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#用-certbot-申请-route53-上的域名的-letsencrypt-证书并上传到-iam" class="md-nav__link">
    <span class="md-ellipsis">
      用 certbot 申请 route53 上的域名的 LetsEncrypt 证书并上传到 IAM
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-k8s-中部署-prometheus" class="md-nav__link">
    <span class="md-ellipsis">
      在 k8s 中部署 Prometheus
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#各种-ecc-曲线" class="md-nav__link">
    <span class="md-ellipsis">
      各种 ecc 曲线
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fido-u2ffido2-和-ctap-的关系" class="md-nav__link">
    <span class="md-ellipsis">
      FIDO U2F、FIDO2 和 CTAP 的关系
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usbip-模拟-usb-设备" class="md-nav__link">
    <span class="md-ellipsis">
      USB/IP 模拟 USB 设备
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mifare-classic-上配置-ndef" class="md-nav__link">
    <span class="md-ellipsis">
      MIFARE Classic 上配置 NDEF
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#解释-bb84-协议" class="md-nav__link">
    <span class="md-ellipsis">
      解释 BB84 协议
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-k8s-中部署-code-server" class="md-nav__link">
    <span class="md-ellipsis">
      在 k8s 中部署 code-server
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-k8s-中部署-drone-用于-ci" class="md-nav__link">
    <span class="md-ellipsis">
      在 k8s 中部署 Drone 用于 CI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-k8s-内用-cert-manager-配合-nginx-ingress-controller-配置-lets-encrypt-https-证书" class="md-nav__link">
    <span class="md-ellipsis">
      在 k8s 内用 Cert Manager 配合 Nginx Ingress Controller 配置 Let's Encrypt HTTPS 证书
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-tke-上配置不使用-lb-的-nginx-ingress-controller" class="md-nav__link">
    <span class="md-ellipsis">
      在 TKE 上配置不使用 LB 的 Nginx Ingress Controller
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-sbt-中-fork-并且并行运行测试" class="md-nav__link">
    <span class="md-ellipsis">
      在 sbt 中 fork 并且并行运行测试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在命令行中进行-vivado-仿真" class="md-nav__link">
    <span class="md-ellipsis">
      在命令行中进行 Vivado 仿真
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#体验-tencent-kubernetes-engine" class="md-nav__link">
    <span class="md-ellipsis">
      体验 Tencent Kubernetes Engine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-rocket-chip-上挂接-tlram" class="md-nav__link">
    <span class="md-ellipsis">
      在 Rocket Chip 上挂接 TLRAM
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-kubernetes-集群上部署-gitlabrunner" class="md-nav__link">
    <span class="md-ellipsis">
      在 Kubernetes 集群上部署 gitlab—runner
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2020">2020<a class="headerlink" href="#2020" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-12-27 00:00:00+00:00">2020年12月27日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="以太网的物理接口"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/">以太网的物理接口</a></h2>
<p>本文的内容已经整合到<a href="/kb/networking/ethernet.html">知识库</a>中。</p>
<h3 id="背景"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#背景">背景</a></h3>
<p>最近逐渐接触到了一些高速的以太网的接口，被一大堆的名字搞得有点懵，所以特意学习了一下并整理成这篇博客。</p>
<p>更新：经 <a href="https://github.com/z4yx">@z4yx</a> 指出，还可以看<a href="https://support.huawei.com/hedex/hdx.do?docid=EDOC1100156553&amp;id=ZH-CN_TOPIC_0250303640&amp;lang=zh">华为的介绍文档</a></p>
<h3 id="几几-base-杠什么是什么意思"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#几几-base-杠什么是什么意思">几几 BASE 杠什么是什么意思</a></h3>
<p>在下文里，经常可以看到类似 100BASE-TX 这种写法，它表示的意思是：</p>
<ol>
<li>BASE 前面的数字表示速率，比如 10，100，1000，10G 等等</li>
<li>BASE 之后的第一个字母，常见的 T 表示双绞线，S 表示 850nm 光纤，L 表示 1310nm 光纤，C 表示同轴电缆</li>
<li>之后可能还有别的字母，比如 X 表示 8b/10b 或者 4b/5b（FE）的编码，R 表示 64b/66b 的编码</li>
<li>之后可能还有别的数字，如果是 LAN PHY 表示的是所使用的 lane 数量；如果是 WAN PHY 表示的是传输的公里数</li>
</ol>
<p>详见 <a href="https://en.wikipedia.org/wiki/Ethernet_physical_layer#Naming_conventions">Wikipedia - Ethernet Physical Layer # Naming Conventions</a> 和 IEEE 802.3 1.2.3 节 Physical Layer and media notation：</p>
<div class="language-text highlight"><pre><span></span><code>The data rate, if only a number, is in Mb/s, and if suffixed by a “G”, is in
Gb/s. The modulation type (e.g., BASE) indicates how encoded data is
transmitted on the medium. The additional distinction may identify
characteristics of transmission or medium and, in some cases, the type of PCS
encoding used (examples of additional distinctions are “T” for twisted pair,
“B” for bidirectional optics, and “X” for a block PCS coding used for that
speed of operation). Expansions for defined Physical Layer types are included
in 1.4.
</code></pre></div>
<p>和 IEEE 802.3 1.4 节 Definitions 中的几个例子：</p>
<ul>
<li>100BASE-T: IEEE 802.3 Physical Layer specification for a 100 Mb/s CSMA/CD local area network. (See IEEE Std 802.3, Clause 22 and Clause 28.)</li>
<li>100BASE-TX: IEEE 802.3 Physical Layer specification for a 100 Mb/s CSMA/CD local area network over two pairs of Category 5 twisted-pair cabling. (See IEEE Std 802.3, Clause 24 and Clause 25.)</li>
<li>1000BASE-T: IEEE 802.3 Physical Layer specification for a 1000 Mb/s CSMA/CD LAN using four pairs of Category 5 balanced copper cabling. (See IEEE Std 802.3, Clause 40.)</li>
<li>1000BASE-X: IEEE 802.3 Physical Layer specification for a 1000 Mb/s CSMA/CD LAN that uses a Physical Layer derived from ANSI X3.230-1994 (FC-PH) [B21]23. (See IEEE Std 802.3, Clause 36.)</li>
<li>2.5GBASE-T: IEEE 802.3 Physical Layer specification for a 2.5 Gb/s LAN using four pairs of Category 5e/Class D balanced copper cabling. (See IEEE Std 802.3, Clause 126.)</li>
<li>5GBASE-T: IEEE 802.3 Physical Layer specification for a 5 Gb/s LAN using four pairs of Category 5e/Class D balanced copper cabling. (See IEEE Std 802.3, Clause 126.)</li>
<li>10GBASE-T: IEEE 802.3 Physical Layer specification for a 10 Gb/s LAN using four pairs of Class E or Class F balanced copper cabling. (See IEEE Std 802.3, Clause 55.)</li>
</ul>
<h3 id="各个速率对应的英文单词是什么"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#各个速率对应的英文单词是什么">各个速率对应的英文单词是什么</a></h3>
<ul>
<li>Fast Ethernet: 100Mbps</li>
<li>Gigabit Ethernet: 1Gbps</li>
<li>Multi Gigabit Ethernet: 2.5Gbps</li>
<li>Ten Gigabit Ethernet: 10Gbps</li>
<li>Forty Gigabit Ethernet: 40Gbps</li>
<li>Hundred Gigabit Ethernet: 100Gbps</li>
</ul>
<h3 id="常见的连接器"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#常见的连接器">常见的连接器</a></h3>
<p>连接器（connector）一般来说指的就是线缆和网络设备之间的物理接口了。常见的有：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Modular_connector#8P8C">8P8C</a>：一般我们会称之为 RJ45，关于它们俩的关系，可以看 Wikipedia 上面的说明，不过在日常生活中，这两个混用其实也没有什么大问题</li>
<li><a href="https://en.wikipedia.org/wiki/Optical_fiber_connector#LC">LC</a>：一种光纤的接口，有两个突出来的插到 SFP 光模块中的突起，比较常见</li>
<li><a href="https://en.wikipedia.org/wiki/Twinaxial_cabling#SFP+_Direct-Attach_Copper_(10GSFP+Cu)">SFP+ DAC</a>：一般是 DAC（Direct Attatched Cable）线，线的两端直接就是 SFP+ 的接口，直接插到 SFP+ 笼子中，不需要光模块；更高速率的也有 DAC 线</li>
</ul>
<p>对于光纤的接口，注意购买的时候要和光模块对应，不然可能插不进去。常见的有 LC-LC，SC-LC，SC-SC 等等，表示线的两端分别是什么接口。</p>
<h3 id="mdi-和-mdi-x"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#mdi-和-mdi-x">MDI 和 MDI-X</a></h3>
<p>这其实就是大家常见的 RJ45 里面 8 根线对应的信号，在十兆和百兆的时候，需要区分 MDI 和 MDI-X，在同种类型的端口之间用交叉线，在不同类型的端口之间用直通线。在后来，有了 Auto MDI-X，也就是会按照实际情况自动检测并且匹配。从千兆开始，设备都支持 Auto MDI-X 了，所以线本身是交叉还是直通就无所谓了。</p>
<h3 id="各种-sfp"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#各种-sfp">各种 SFP</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Small_form-factor_pluggable_transceiver">SFP</a> 是很常见的，特别是在高速的网络之中。而它又分为几种，对应不同的速率：</p>
<ul>
<li>SFP: 1Gbps/100Mbps</li>
<li>SFP+: 10Gbps</li>
<li>SFP28: 25Gbps</li>
<li>SFP56: 50Gbps</li>
<li>QSFP: 4Gbps</li>
<li>QSFP+: 40Gbps</li>
<li>QSFP28: 100Gbps/50Gbps</li>
<li>QSFP56: 200Gbps</li>
<li>QSFP-DD: 400Gbps/200Gbps</li>
<li>QSFP-DD112: 800Gbps</li>
<li>OSFP: 800Gbps/400Gbps</li>
</ul>
<p>可以看到，名字前面加了个 Q（Quad），速率就翻了 4 倍，因为有 4 个 lane，同时物理接口的尺寸也变大了。所以，不带 Q 的 SFP 的物理尺寸都一样，带 Q 的 SFP 物理尺寸都一样大，但后者比前者大一些（SFP 是 113.9 mm^2，QSFP 是 156 mm^2）。OSFP 又比 QSFP 更大一些，O 表示 Octal，就是 8 个 lane 的意思。</p>
<p>可以在 <a href="https://community.fs.com/blog/400g-qsfp-dd-transceiver-types-overview.html">400G QSFP Transceiver Types and Fiber Connections</a> 和 <a href="https://community.fs.com/blog/400g-osfp-transceiver-types-overview.html">400G OSFP Transceiver Types Overview</a> 看到 QSFP-DD 和 OSFP 的对比。</p>
<p>通常，网络设备也会支持把一个 QSFP 接口拆成多个 SFP 接口来使用，比如有的线，一边是 QSFP28，另一边是 4xSFP28，只要设备支持即可，目的是节省空间。</p>
<p><a href="https://members.snia.org/document/dl/26184">SFP 标准 SFF INF-8074</a> 规定了 <a href="https://en.wikipedia.org/wiki/Small_form-factor_pluggable_transceiver#Signals">20 根信号线</a>，正反面各 10 根，重要的是下面的这些（括号里写得是 Pin 的编号）：</p>
<ol>
<li>Mod_ABS（6）：模块是否插入</li>
<li>RD+（13）、RD-（12）：接收数据的差分对</li>
<li>TD+（18）、TD-（19）：传输数据的差分对</li>
<li>SDA（4）、SCL（5）：模块的 I2C</li>
<li>Tx_Fault（2）、Tx_Disable（3）、Rx_LOS（8）：一些状态信号</li>
</ol>
<p>可以看到，收和发各有一个差分对共 4 条数据线。相对应的，QSFP 收和发各有四对差分对共 16 条数据线，一共 38 根线。并且有一些信号是复用了同样的 pin，这样的设计可以节省一些 pin，是很常见的。</p>
<h3 id="mii"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#mii">MII</a></h3>
<p>有时候，还会遇到各种 <a href="https://en.wikipedia.org/wiki/Media-independent_interface">MII</a> 接口，也就是 MAC 和 PHY 之间的接口。有时候，还会伴随着 MDIO 接口，来进行控制信息的传输。它又分不同的类型：</p>
<ul>
<li>Standard MII：速率是 100Mbps（25MHz*4）或者 10Mbps（2.5Mhz*4），TX 7 根线（4 DATA+CLK+EN+ER），RX 7+2 根线（4 DATA+CLK+DV+ER+CRS+COL），加上 MDIO 2 根线共 18 根线</li>
<li>RMII：速率是 100Mbps 或者 10Mbps，频率都是 50MHz，一共 10 根线（4 DATA+CLK+TX_EN+CRS_DV+RX_ER+MDIO+MDC），数据线是 TX 和 RX 各 2 根</li>
<li>GMII：速率是 1000Mbps（125MHz*8），数据线是 TX 和 RX 各 8 根；也支持速率 100Mbps（25MHz）和 10Mbps（2.5MHz）</li>
<li>RGMII：速率是 1000Mbps（125MHz*4*2，DDR），数据线是 TX 和 RX 各 4 根；也支持速率 100Mbps（25MHz*4）和 10Mbps（2.5MHz*4），一共是 5+5+2 根线</li>
<li>SGMII：速率是 1000Mbps（625MHz*2*8/10），采用 625MHz DDR 差分对 SerDes，采用 8b/10b 的编码</li>
<li>XGMII：支持 2500Mbps/5000Mbps/10000Mbps（156.25 MHz*32*2，DDR）速率，数据线是 TX 和 RX 各 32 根</li>
</ul>
<p>有的时候，MAC 和 PHY 是独立的，比如很多常见的 FPGA 开发板，在使用千兆网的时候，在板子上是 PHY 芯片，从 FPGA 到 PHY 通过 RGMII 连接，然后 PHY 再连接到 8P8C（RJ45）的连接器上。一般还会把 MDIO 也接到 FPGA 上面。如果有多个 PHY，就会吧 MDIO 通过总线的方式合并起来，给每个 PHY 配置不同的地址（一般是在指定的 PIN 上设置上拉/下拉电阻实现），就可以保证不冲突的访问。</p>
<p>扩展阅读：<a href="https://ww1.microchip.com/downloads/en/DeviceDoc/00002117F.pdf">KXZ9031RNX Datasheet</a></p>
<h3 id="sgmii"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#sgmii">SGMII</a></h3>
<p>上面比较常见的是 GMII/RGMII/SGMII。其中比较特殊的是 <a href="https://archive.org/details/sgmii/mode/2up">SGMII</a>，首先可以发现它信号很少，只有两对差分线 TX_P TX_N RX_P RX_N，其中时钟是可选的，因为可以从数据中恢复。你可能感到很奇怪，那么其他的信号，比如 DV/ER/CRS 等都去哪里了呢？其实是因为，SGMII 采用了 <a href="https://zh.wikipedia.org/wiki/8b/10b">8b/10b</a> 的编码的同时，把这些控制信号通过一定的方式顺便编码进去了。具体来说，就是从 8 位的数据信号编码为 10 位的时候，有一些特殊的 10 位符号是没有对应 8 位的数据的，因此可以用这些特殊符号来表示一些信号，比如用 SPD（Start_of_Packet Delimiter，对应 /S/）和 EPD（End_of_Packet Delimiter，对应 /T/R/ 等）表示传输数据的开始和结尾，对应 TX_EN/RX_DV 信号；用 Error_Propagation（/V/）表示错误，对应 RX_ER 信号等等。所以，SGMII 其实还是一个 GMII 的变种，只不过采用 SerDes 的方式减少了引脚，MAC 内部或者 PHY 内部也是经过一个 GMII-SGMII 的转换，而其余部分是一样的。</p>
<p>关于 8b/10b 的编码方式，可以阅读 IEEE 802.3 标准中的 <code>Table 36–1a—Valid data code-groups</code>，里面提到了两类的 Code Group：D 打头的，表示数据，有 256 种，从 8b 映射到 10b 的表达方式，并且为了保持直流平衡，有一种到两种表示方法。此外还有 12 个特殊的 Code Group：K 打头，它们的 10b 表达方式不会和数据冲突。表 <code>Table 36–3—Defined ordered sets</code> 中定义了 K 打头的 Code Group 含义：</p>
<ul>
<li>/C/ Configuration:</li>
<li>/C1/ Configuration 1: /K28.5/D21.5/Config_Reg</li>
<li>/C2/ Configuration 2: /K28.5/D2.2/Config_Reg</li>
<li>/I/ IDLE:</li>
<li>/I1/ IDLE 1: /K28.5/D5.6/</li>
<li>/I2/ IDLE 2: /K28.5/D16.2/</li>
<li>Encapsulation:</li>
<li>/R/ Carrier_Extend: /K23.7/</li>
<li>/S/ Start_of_Packet: /K27.7/</li>
<li>/T/ End_of_Packet: /K29.7/</li>
<li>/V/ Error_Propagation: /K30.7/</li>
<li>/LI/ LPI (Low Power Idle):</li>
<li>/LI1/ LPI 1: /K28.5/D6.5/</li>
<li>/LI2/ LPI 2: /K28.5/D26.4/</li>
</ul>
<p>IEEE 802.3 Figure 36-4 中给了一个例子，就是在发送一段数据的时候，首先是 /I/，然后 /S/，接着一系列的 /D/，最后结束的时候 /T/R/I/。</p>
<p>扩展阅读：</p>
<ul>
<li><a href="https://www.intel.com/content/www/us/en/programmable/solutions/technology/transceiver/protocols/pro-sgmii.html">Serial Gigabit Media Independent Interface</a></li>
<li><a href="https://www.xilinx.com/support/documentation/ip_documentation/gig_ethernet_pcs_pma/v16_0/pg047-gig-eth-pcs-pma.pdf">1G/2.5G Ethernet PCS/PMA or SGMII v16.0</a></li>
<li><a href="https://en.wikipedia.org/wiki/Physical_coding_sublayer">https://en.wikipedia.org/wiki/Physical_coding_sublayer</a></li>
</ul>
<h3 id="1000base-x-与-sfp-的关系"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#1000base-x-与-sfp-的关系">1000BASE-X 与 SFP 的关系</a></h3>
<p>1000BASE-X 在 802.3 Clause 36 中定义，它的层级是这样的：</p>
<p><img alt="" src="../../hardware/1000basex.png" /></p>
<p>它支持三种不同的介质，对应了三个 PMD 层，也就是 LX、SX 和 CX。这些体现在设备上，其实就是不同的 SFP 模块。SFP 模块实际上就是图中的 PMD 层，SFP 接口上连接的是 1000BASE-X 的 PCS/PMA，这也就是为什么说在带有 SFP 的 FPGA 上，Xilinx 的 IP 叫做 1G/2.5G Ethernet PCS/PMA。在这里，PCS 和 PMA 层在 FPGA 内部通过 IP 实现，通过 PCB 连接到 SFP 上，光模块就是 PMD 层。见下图：</p>
<p><img alt="" src="../../hardware/xilinx_pcs_pma.png" /></p>
<p>左边通过 GMII 连接到内部的 MAC，右边连接到 SFP 上，通过光模块，连接到光纤。这里光模块只需要负责光电转换。另一种比较常见的形式，就是 MAC 在 FPGA 内部，PHY（包括 PCS/PMA/PMD）都在 FPGA 外部，此时 FPGA IO 上就是各种 MII。</p>
<p>那么 SFP 电口模块是怎么工作的呢？我们知道，电口采用的是 1000BASE-T 标准。实际上，它里面有一个 PHY 芯片，发送的时候，首先解码 1000BASE-X 变回原始数据，再按照 1000BASE-T 的方式编码再发出去；接收的时候，按照 1000BASE-T 进行解码，再重新编码为 1000BASE-X 发送给 PMA 层。</p>
<p>还有一类电口模块，与上面不同的地方在于，SFP 上走的是 SGMII，而不是 1000BASE-X。这两种模式没有太大的区别，都是两对差分线，一收一发，所以很多时候二者是同时支持，可以切换的。例如 <a href="https://www.fs.com/products/177936.html?attribute=44906&amp;id=1109184">Cisco Compatible 10/100/1000BASE-T SFP SGMII Copper RJ-45 100m Industrial Transceiver Module (LOS)</a> 就是在 SFP 上走 SGMII 协议。</p>
<p>推荐阅读 <a href="https://ww1.microchip.com/downloads/en/Appnotes/VPPD-01080.pdf">Designing a Copper SFP using the VSC8221 10/100/1000BASE-T PHY</a>，它里面讲了如何将 VSC8221 芯片用于电口模块：VSC8221 芯片一头是 1000BASEX（又称 802.3z SerDes，802.3z 就是 1000BASE-X）或者 SGMII，另一头是 1000BASE-T MDI。</p>
<h3 id="物理层"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#物理层">物理层</a></h3>
<h4 id="100base-tx"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#100base-tx">100BASE-TX</a></h4>
<p>在 IEEE 802.3 的 Clause 24 和 25 中定义。</p>
<p>100BASE-TX 的物理层分为 PCS，PMA，PMD。与 MAC 的连接是 MII 接口，MII 频率是 25MHz，每周期传输 4 bit 的数据。然后 PCS 负责把 4 bit 的数据通过 4B/5B 转换为 5 bit 的 code group；PMA 使用 NRZI 进行编码；PMD 层借用了 FDDI 协议的 PMD 层，只使用 MDI 的 1-3 和 6 四根线传输，两对差分对，一收一发。</p>
<h4 id="1000base-t"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#1000base-t">1000BASE-T</a></h4>
<p>在 IEEE 802.3ab-1999 中定义，具体位置是 Clause 40。</p>
<p><img alt="" src="../../hardware/1000baset.png" /></p>
<p>物理层往上通过 GMII 连接 MAC，往下通过 MDI 连接其他网络设备。物理层又包括 PCS 和 PMA。</p>
<p>1000BASE-T 使用四对差分线，每对差分线上都是全双工传输，波特率 125Mbaud，symbol 的范围是 <code>{2, 1, 0, -1, -2}</code>，通过 PAM5 传输。</p>
<p>具体来讲，PCS 从 MAC 的 GMII 接口接收要发送的数据，GMII 是 125MHz，每个周期 8 位数据。这些数据与 scrambler 一起，生成 9 位的 <code>Sd_n[8:0]</code>，然后再编码为 <code>(TA_n, TB_n, TC_n, TD_n)</code>，也就是在四对差分线上传输的 symbol，取值范围是 <code>[-2, 2]</code>。简单总结一下，就是每个周期 8 位数据，先变成 9 位数据，再变成 4 个 symbol，每个 symbol 取值范围是 -2 到 2，这就叫做 8B1Q4，<code>converting GMII data (8B-8 bits) to four quinary symbols (Q4) that are transmitted during one clock (1Q4)</code>，把 8 位的数据转换为四个 symbol，每个 symbol 有五种取值（Quinary 表示 5）。</p>
<h3 id="mdio"><a class="toclink" href="../../hardware/2020/12/27/ethernet-physical-interfaces/#mdio">MDIO</a></h3>
<p>MDIO 是 MAC 和 PHY 之间一个低速的通信接口，定义在 IEEE 802.3 Clause 45，可以用来配置一些寄存器。它支持读和写，多个 PHY 可以共享一个 MDIO 总线，通过 5 位的地址区分。为了让 PHY 分配到不同的地址，PHY 通常会通过某些引脚的上下拉来决定它自己的 MDIO 地址，这样可以避免冲突。以 RTL8201F 为例，它的 PHY 的 MDIO 地址配置与 LED 输出引脚是共享的，根据外部电路的上下拉不同，配置 MDIO 地址的最低两位：</p>
<p><img alt="" src="../../hardware/rtl8201f_phyad.png" /></p>
<p>也就是说，这款芯片的 MDIO 地址可以在二进制的 00000 到 00011 之间取。但不建议用 00000 地址，这是因为一些芯片会把 00000 重定义为广播，此时总线上的所有 PHY 芯片都要响应目标地址为自己的地址（非 00000）或者 00000 地址的请求（见 <a href="https://docs.amd.com/r/en-US/pg047-gig-eth-pcs-pma/MDIO-Addressing">MDIO Addressing</a>）。RTL8211 在它的文档里描述了这个行为：</p>
<p><img alt="" src="../../hardware/rtl8211_phyad_0.png" /></p>
<p>这样的好处是可以同时往多个 PHY 芯片写入寄存器，但如果要从 00000 地址读寄存器的话，一旦多个 PHY 同时响应，MDIO 总线上就会出现冲突。不过如果只有一个 PHY 芯片连接到 MDIO 总线上，那么让 MAC 通过 00000 地址访问 PHY 也是可以的。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-12-04 00:00:00+00:00">2020年12月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/programming/" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rust-在-m1-上的-code-signing-问题和临时解决方法"><a class="toclink" href="../../programming/2020/12/04/workaround-rust-on-m1/">Rust 在 M1 上的 Code Signing 问题和临时解决方法</a></h2>
<p>不久前，rust 添加了 Tier2 的 aarch64-apple-darwin 的支持，试了一下，确实可以运行，不过当我编译的时候，出现：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>error: failed to run custom build command for `xxxx v1.0 (/path/to/xxxx)`
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>Caused by:
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  process didn&#39;t exit successfully: `/path/to/xxx/target/debug/build/xxx-xxxx/build-script-build` (signal: 9, SIGKILL: kill)
</span></code></pre></div>
<p>看了一下 Console.app 里面的 crash 日志，发现是 codesigning 问题。解决方法是，用 codesign 命令来签名：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># for build.rs</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>codesign<span class="w"> </span>-s<span class="w"> </span>-<span class="w"> </span>target/debug/build/*/build-script-build
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># for dylib of some crates</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>codesign<span class="w"> </span>-s<span class="w"> </span>-<span class="w"> </span>target/debug/deps/*.dylib
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1"># for final executable</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>codesign<span class="w"> </span>-s<span class="w"> </span>-<span class="w"> </span>target/debug/xxx
</span></code></pre></div>
<p>多次编译并签名后，就可以正常运行最后的二进制了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>target/debug/xxxx:<span class="w"> </span>Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>arm64
</span></code></pre></div>
<p>然后就可以了。等待上游添加 code signing 支持吧。</p>
<p>2020-12-07 更新：找了找 cargo 的 issues，找到了<a href="https://github.com/rust-lang/cargo/issues/8913">同样的问题</a>，看来并不是 code signing 支持的问题，而是在 Intel 的 Alacritty 下面，运行 Apple 的 rustc 工具链的时候，才会出现的 BUG。我也自己试了一下，在 Apple 的 Terminal 下跑编译就没有问题。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-11-19 00:00:00+00:00">2020年11月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="arm-m1-macbook-air-开箱"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/">ARM M1 MacBook Air 开箱</a></h2>
<h3 id="购买"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#购买">购买</a></h3>
<p>我是 11.12 的时候在 Apple Store 上下单的，选的是 MacBookAir，带 M1 芯片，8 核 CPU + 8 核 GPU，加了一些内存和硬盘。今天（11.19）的时候顺丰到货，比 Apple Store 上显示的预计到达时间 21-28 号要更早。另外，我也听朋友说现在一些线下的店也有货，也有朋友直接在京东上买到了 Mac mini，总之第一波 M1 的用户最近应该都可以拿到设备了。</p>
<p>现在这篇博客，就是在 ARM MBA 上编写的，使用的是 Intel 的 VSCode，毕竟 VSCode 的 ARM64 版不久后才正式发布。</p>
<h3 id="开箱"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#开箱">开箱</a></h3>
<p>从外观来看，一切都和 Intel MBA 一样，包装上也看不出区别，模具也是一样的。</p>
<p><img alt="" src="../../hardware/arm_mac_1.png" /></p>
<p>进了系统才能看得出区别。预装的系统是 macOS Big Sur 11.0，之后手动更新到了目前最新的 11.0.1。</p>
<p>顺带 <a href="https://github.com/FactorialN">@FactorialN</a> 同学提醒我在这里提一句：包装里有电源适配器，不太环保。</p>
<h3 id="体验"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#体验">体验</a></h3>
<h4 id="arm64"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#arm64">ARM64</a></h4>
<p>首先自然是传统艺能，证明一下确实是 Apple Silicon：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>Darwin<span class="w"> </span>macbookair.lan<span class="w"> </span><span class="m">20</span>.1.0<span class="w"> </span>Darwin<span class="w"> </span>Kernel<span class="w"> </span>Version<span class="w"> </span><span class="m">20</span>.1.0:<span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">00</span>:07:10<span class="w"> </span>PDT<span class="w"> </span><span class="m">2020</span><span class="p">;</span><span class="w"> </span>root:xnu-7195.50.7~2/RELEASE_ARM64_T8101<span class="w"> </span>x86_64
</span></code></pre></div>
<p>啊对不起我用错了，上面是在 Rosetta 里面跑的 shell 看到的结果。实际是这样子的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Darwin<span class="w"> </span>macbookair.lan<span class="w"> </span><span class="m">20</span>.1.0<span class="w"> </span>Darwin<span class="w"> </span>Kernel<span class="w"> </span>Version<span class="w"> </span><span class="m">20</span>.1.0:<span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">00</span>:07:10<span class="w"> </span>PDT<span class="w"> </span><span class="m">2020</span><span class="p">;</span><span class="w"> </span>root:xnu-7195.50.7~2/RELEASE_ARM64_T8101<span class="w"> </span>arm64
</span></code></pre></div>
<p>货真价实的 ARM64 内核，系统的很多 binary 也都是 Universal 的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>$<span class="w"> </span>file<span class="w"> </span>/bin/bash
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>/bin/bash:<span class="w"> </span>Mach-O<span class="w"> </span>universal<span class="w"> </span>binary<span class="w"> </span>with<span class="w"> </span><span class="m">2</span><span class="w"> </span>architectures:<span class="w"> </span><span class="o">[</span>x86_64:Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>x86_64<span class="o">]</span><span class="w"> </span><span class="o">[</span>arm64e:Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>arm64e<span class="o">]</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>/bin/bash<span class="w"> </span><span class="o">(</span><span class="k">for</span><span class="w"> </span>architecture<span class="w"> </span>x86_64<span class="o">)</span>:<span class="w">    </span>Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>x86_64
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>/bin/bash<span class="w"> </span><span class="o">(</span><span class="k">for</span><span class="w"> </span>architecture<span class="w"> </span>arm64e<span class="o">)</span>:<span class="w">    </span>Mach-O<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>executable<span class="w"> </span>arm64e
</span></code></pre></div>
<h4 id="rosetta"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#rosetta">Rosetta</a></h4>
<p>接着，就是重头戏 Rosetta 了。第一次打开 Intel 的程序的时候，会弹出窗口安装 Rosetta，确定以后立马就装好了。接着常用的各种软件啥的，都没有什么问题。</p>
<p>唯一能看出区别的，就是在 Activity Monitor 可以看到架构的区别：</p>
<p><img alt="" src="../../hardware/arm_mac_2.png" /></p>
<p>实际体验的时候，其实没有什么感觉。默认情况下，在 Terminal 下打开的是 ARM64 架构的，如果要切换的话，只需要：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$<span class="w"> </span>uname<span class="w"> </span>-m
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>arm64
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>$<span class="w"> </span>arch<span class="w"> </span>-arch<span class="w"> </span>x86_64<span class="w"> </span>uname<span class="w"> </span>-m
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>x86_64
</span></code></pre></div>
<p>这样就可以了。如果开了一个 x86_64 的 shell，在 shell 里面执行的命令就都是 x86_64 架构的了。</p>
<h4 id="homebrew"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#homebrew">Homebrew</a></h4>
<p>目前，Homebrew 的支持是这样子的，Intel 的 Homebrew 工作很正常，没有遇到任何问题。。ARM 的 Homebrew 目前还在进行移植，由于官方的 build farm 还没有支持 ARM，所以各种包都需要自己编译，试了几个常用的软件都没问题。</p>
<p>目前 Homebrew 推荐的方法是，在老地方 <code>/usr/local/Homebrew</code> 下面放 Intel 的 Homebrew，在 <code>/opt/homebrew</code> 下面放 ARM 的 Homebrew。虽然还是有很多警告，但目前来看基本使用都没有什么问题。Homebrew cask 也正常，毕竟基本就是一个下载器。</p>
<p>另外，试了一下用 ARM Homebrew 从源码编译 GCC，编译中途失败了。</p>
<h4 id="其他软件"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#其他软件">其他软件</a></h4>
<p>换到 ARM 上自然会想到，之前的那些软件还能不能跑。答案是，大多都可以，只是很多还是 Intel 版走翻译而已。</p>
<p>目前已经测试过正常使用的：VSCode、Google Chrome、Alacrity、iStat Menus、Alfred、Rectangle、Typora、Microsoft Office、Karabiner Elements、Jetbrains Toolbox、WeChat、CineBench、Dozer、Squirrel、Zoom、Tencent Meeting、Seafile、Skim、Mendeley、1 Password、Wireshark、Slack、iMazing、Office for Mac。</p>
<p>这些里面已经移植到 ARM64 的有 Alfred、iStat Menus、Karabiner Elements、Rectangle、Google Chrome、Slack、Typora、iMazing、Office for Mac、Zoom、VSCode Insiders。</p>
<p>这里有一部分是已经移植到 ARM64 的，有一些也很快就会移植过来。其中 iStat Menus 的电池健康显示有点 BUG，其他没发现问题（更新：已修复）。</p>
<p>另外，大家也知道 ARM Mac 很重要的一点是可以跑 iOS Apps，我们也确实跑了一些，不过都有一些问题：</p>
<ul>
<li>Doodle Jump：跑起来很正常，就是卡关了，别问为什么，没有加速度计，再怎么晃电脑也不会动</li>
<li>Bilibili：部分内容可以加载出来，部分不可以，估计是什么组件没有配置好</li>
<li>QQ Music：可以跑起来，但是在启动之后的引导页面，期望用户点一下屏幕，但怎么用鼠标点都没反应</li>
<li>Weibo：毕竟正常，可以正常浏览啥都，就是 UI 有点错位，估计是因为显示窗口和实际都不大一样，小问题。</li>
<li>Network Tools：很正常，各种网络信息都可以正常取出来。</li>
<li>NFSee：没有 NFC 读卡功能，自然没法用。</li>
<li>彩云天气（ColorfulClouds Weather）：正常使用。</li>
</ul>
<p>其他还有很多 App 还没有测试。</p>
<h4 id="发热"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#发热">发热</a></h4>
<p>大家也知道，这款 MBA 是没有风扇的。但我实际测试的过程中发现，确实不大需要。拿 stress 跑了一段时间 CPU 满载运行，也没感觉到电脑发热，只是在更新 macOS Big Sur 11.0.1 的时候稍微热了一点点，也只是一点点，距离烫手还有很长的距离。</p>
<p>续航方面目前来看也挺好的，捣鼓了一个下午，也没耗多少电。</p>
<h4 id="性能测试"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#性能测试">性能测试</a></h4>
<p>在不同平台上进行 OpenSSL 测试：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>openssl<span class="w"> </span>speed<span class="w"> </span>-evp<span class="w"> </span>aes-128-cbc<span class="w"> </span>aes-256-cbc<span class="w"> </span>des-ede3<span class="w"> </span>rsa2048<span class="w"> </span>sha256
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1"># M1 MacBookAir</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1j<span class="w">  </span><span class="m">16</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">2021</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>built<span class="w"> </span>on:<span class="w"> </span>Wed<span class="w"> </span>Feb<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">12</span>:34:00<span class="w"> </span><span class="m">2021</span><span class="w"> </span>UTC
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>idea<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span><span class="w"> </span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>compiler:<span class="w"> </span>clang<span class="w"> </span>-fPIC<span class="w"> </span>-arch<span class="w"> </span>arm64<span class="w"> </span>-O3<span class="w"> </span>-Wall<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-D_REENTRANT<span class="w"> </span>-DNDEBUG
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>The<span class="w"> </span><span class="s1">&#39;numbers&#39;</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">30466</span>.76k<span class="w">    </span><span class="m">30644</span>.63k<span class="w">    </span><span class="m">30592</span>.26k<span class="w">    </span><span class="m">30106</span>.97k<span class="w">    </span><span class="m">29961</span>.69k<span class="w">    </span><span class="m">29951</span>.49k
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">229863</span>.42k<span class="w">   </span><span class="m">238671</span>.82k<span class="w">   </span><span class="m">232654</span>.34k<span class="w">   </span><span class="m">237194</span>.70k<span class="w">   </span><span class="m">238092</span>.29k<span class="w">   </span><span class="m">237791</span>.91k
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>aes-128-cbc<span class="w">    </span><span class="m">1020384</span>.58k<span class="w">  </span><span class="m">1427866</span>.73k<span class="w">  </span><span class="m">1521123</span>.84k<span class="w">  </span><span class="m">1558199</span>.30k<span class="w">  </span><span class="m">1569978</span>.99k<span class="w">  </span><span class="m">1566288</span>.55k
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>sha256<span class="w">          </span><span class="m">378646</span>.12k<span class="w">  </span><span class="m">1140355</span>.52k<span class="w">  </span><span class="m">1894169</span>.69k<span class="w">  </span><span class="m">2287211</span>.18k<span class="w">  </span><span class="m">2445602</span>.42k<span class="w">  </span><span class="m">2453209</span>.09k
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000561s<span class="w"> </span><span class="m">0</span>.000014s<span class="w">   </span><span class="m">1782</span>.0<span class="w">  </span><span class="m">69645</span>.9
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="c1"># AMD EPYC 7742</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1d<span class="w">  </span><span class="m">10</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>built<span class="w"> </span>on:<span class="w"> </span>Mon<span class="w"> </span>Dec<span class="w">  </span><span class="m">7</span><span class="w"> </span><span class="m">20</span>:44:45<span class="w"> </span><span class="m">2020</span><span class="w"> </span>UTC
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>8x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-CKx7Fo/openssl-1.1.1d<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAESNI_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>The<span class="w"> </span><span class="s1">&#39;numbers&#39;</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">28734</span>.07k<span class="w">    </span><span class="m">28942</span>.08k<span class="w">    </span><span class="m">28982</span>.78k<span class="w">    </span><span class="m">29217</span>.91k<span class="w">    </span><span class="m">29136</span>.21k<span class="w">    </span><span class="m">29103</span>.45k
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">176843</span>.84k<span class="w">   </span><span class="m">183040</span>.83k<span class="w">   </span><span class="m">183156</span>.82k<span class="w">   </span><span class="m">184132</span>.61k<span class="w">   </span><span class="m">184464</span>.73k<span class="w">   </span><span class="m">184642</span>.22k
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>aes-128-cbc<span class="w">     </span><span class="m">602680</span>.15k<span class="w">  </span><span class="m">1178207</span>.32k<span class="w">  </span><span class="m">1239931</span>.82k<span class="w">  </span><span class="m">1251810</span>.30k<span class="w">  </span><span class="m">1258359</span>.47k<span class="w">  </span><span class="m">1261316</span>.78k
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>sha256<span class="w">          </span><span class="m">201482</span>.20k<span class="w">   </span><span class="m">513504</span>.00k<span class="w">  </span><span class="m">1075572</span>.14k<span class="w">  </span><span class="m">1474850</span>.82k<span class="w">  </span><span class="m">1648746</span>.50k<span class="w">  </span><span class="m">1663030</span>.61k
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000620s<span class="w"> </span><span class="m">0</span>.000018s<span class="w">   </span><span class="m">1613</span>.7<span class="w">  </span><span class="m">54756</span>.4
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="c1"># AMD EPYC 7282</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1d<span class="w">  </span><span class="m">10</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>built<span class="w"> </span>on:<span class="w"> </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">20</span>:23:01<span class="w"> </span><span class="m">2020</span><span class="w"> </span>UTC
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>8x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-8Ocme2/openssl-1.1.1d<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAESNI_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>The<span class="w"> </span><span class="s1">&#39;numbers&#39;</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">27052</span>.31k<span class="w">    </span><span class="m">27392</span>.85k<span class="w">    </span><span class="m">27455</span>.57k<span class="w">    </span><span class="m">27569</span>.49k<span class="w">    </span><span class="m">27503</span>.27k<span class="w">    </span><span class="m">27514</span>.20k
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">158578</span>.10k<span class="w">   </span><span class="m">168502</span>.21k<span class="w">   </span><span class="m">172365</span>.91k<span class="w">   </span><span class="m">173904</span>.90k<span class="w">   </span><span class="m">174391</span>.30k<span class="w">   </span><span class="m">174429</span>.53k
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>aes-128-cbc<span class="w">     </span><span class="m">594506</span>.35k<span class="w">  </span><span class="m">1111762</span>.07k<span class="w">  </span><span class="m">1169014</span>.02k<span class="w">  </span><span class="m">1184384</span>.00k<span class="w">  </span><span class="m">1192793</span>.56k<span class="w">  </span><span class="m">1189167</span>.10k
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>sha256<span class="w">          </span><span class="m">194382</span>.61k<span class="w">   </span><span class="m">487875</span>.93k<span class="w">  </span><span class="m">1017121</span>.56k<span class="w">  </span><span class="m">1390122</span>.33k<span class="w">  </span><span class="m">1558735</span>.53k<span class="w">  </span><span class="m">1572274</span>.18k
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000655s<span class="w"> </span><span class="m">0</span>.000019s<span class="w">   </span><span class="m">1526</span>.8<span class="w">  </span><span class="m">52089</span>.2
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="c1"># AMD EPYC 7551</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1d<span class="w">  </span><span class="m">10</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>built<span class="w"> </span>on:<span class="w"> </span>Tue<span class="w"> </span>Feb<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">22</span>:08:43<span class="w"> </span><span class="m">2021</span><span class="w"> </span>UTC
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>8x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-m9Qnvk/openssl-1.1.1d<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAESNI_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>The<span class="w"> </span><span class="s1">&#39;numbers&#39;</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">20850</span>.88k<span class="w">    </span><span class="m">21260</span>.78k<span class="w">    </span><span class="m">21315</span>.84k<span class="w">    </span><span class="m">21368</span>.49k<span class="w">    </span><span class="m">21321</span>.05k<span class="w">    </span><span class="m">21392</span>.04k
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">122059</span>.94k<span class="w">   </span><span class="m">125701</span>.42k<span class="w">   </span><span class="m">126591</span>.06k<span class="w">   </span><span class="m">126770</span>.52k<span class="w">   </span><span class="m">127049</span>.73k<span class="w">   </span><span class="m">126937</span>.77k
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>aes-128-cbc<span class="w">     </span><span class="m">441625</span>.34k<span class="w">   </span><span class="m">883733</span>.48k<span class="w">   </span><span class="m">928208</span>.21k<span class="w">   </span><span class="m">941480</span>.96k<span class="w">   </span><span class="m">944889</span>.86k<span class="w">   </span><span class="m">945307</span>.65k
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>sha256<span class="w">          </span><span class="m">151161</span>.13k<span class="w">   </span><span class="m">388304</span>.60k<span class="w">   </span><span class="m">809272</span>.15k<span class="w">  </span><span class="m">1106645</span>.33k<span class="w">  </span><span class="m">1238966</span>.27k<span class="w">  </span><span class="m">1249219</span>.93k
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.001096s<span class="w"> </span><span class="m">0</span>.000033s<span class="w">    </span><span class="m">912</span>.8<span class="w">  </span><span class="m">30284</span>.7
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="c1"># Intel Xeon E5-2699 v4 (Broadwell)</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.0.2u<span class="w">  </span><span class="m">20</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">2019</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>built<span class="w"> </span>on:<span class="w"> </span>reproducible<span class="w"> </span>build,<span class="w"> </span>date<span class="w"> </span>unspecified
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>16x,int<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>idx,cisc,16,int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>idea<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>idx<span class="o">)</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-I.<span class="w"> </span>-I..<span class="w"> </span>-I../include<span class="w">  </span>-fPIC<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_THREADS<span class="w"> </span>-D_REENTRANT<span class="w"> </span>-DDSO_DLFCN<span class="w"> </span>-DHAVE_DLFCN_H<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-m64<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-O3<span class="w"> </span>-Wall<span class="w"> </span>-DOPENSSL_IA32_SSE2<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DOPENSSL_BN_ASM_MONT5<span class="w"> </span>-DOPENSSL_BN_ASM_GF2m<span class="w"> </span>-DRC4_ASM<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DMD5_ASM<span class="w"> </span>-DAES_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DBSAES_ASM<span class="w"> </span>-DWHIRLPOOL_ASM<span class="w"> </span>-DGHASH_ASM<span class="w"> </span>-DECP_NISTZ256_ASM
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>The<span class="w"> </span><span class="s1">&#39;numbers&#39;</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">29863</span>.80k<span class="w">    </span><span class="m">30156</span>.69k<span class="w">    </span><span class="m">30243</span>.07k<span class="w">    </span><span class="m">30237</span>.70k<span class="w">    </span><span class="m">30302</span>.21k
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>aes-256<span class="w"> </span>cbc<span class="w">     </span><span class="m">103491</span>.45k<span class="w">   </span><span class="m">110240</span>.94k<span class="w">   </span><span class="m">112029</span>.95k<span class="w">   </span><span class="m">112400</span>.38k<span class="w">   </span><span class="m">112833</span>.88k
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>aes-128-cbc<span class="w">     </span><span class="m">734225</span>.68k<span class="w">   </span><span class="m">788483</span>.88k<span class="w">   </span><span class="m">802857</span>.39k<span class="w">   </span><span class="m">805860</span>.69k<span class="w">   </span><span class="m">807848</span>.62k
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>sha256<span class="w">           </span><span class="m">82720</span>.89k<span class="w">   </span><span class="m">184528</span>.45k<span class="w">   </span><span class="m">342888</span>.28k<span class="w">   </span><span class="m">425826</span>.30k<span class="w">   </span><span class="m">457149</span>.10k
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.000573s<span class="w"> </span><span class="m">0</span>.000017s<span class="w">   </span><span class="m">1745</span>.5<span class="w">  </span><span class="m">60236</span>.3
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a><span class="c1"># Intel Xeon E5-2680 v4 (Broadwell) TODO</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a><span class="c1"># Intel Xeon Gold 5218 (Cascade Lake) TODO</span>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a><span class="c1"># IBM POWER8NVL</span>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>OpenSSL<span class="w"> </span><span class="m">1</span>.1.1<span class="w">  </span><span class="m">11</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2018</span>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>built<span class="w"> </span>on:<span class="w"> </span>Wed<span class="w"> </span>Feb<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">12</span>:35:54<span class="w"> </span><span class="m">2021</span><span class="w"> </span>UTC
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>options:bn<span class="o">(</span><span class="m">64</span>,64<span class="o">)</span><span class="w"> </span>rc4<span class="o">(</span>char<span class="o">)</span><span class="w"> </span>des<span class="o">(</span>int<span class="o">)</span><span class="w"> </span>aes<span class="o">(</span>partial<span class="o">)</span><span class="w"> </span>blowfish<span class="o">(</span>ptr<span class="o">)</span>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>compiler:<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-pthread<span class="w"> </span>-m64<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-Wall<span class="w"> </span>-Wa,--noexecstack<span class="w"> </span>-g<span class="w"> </span>-O3<span class="w"> </span>-fdebug-prefix-map<span class="o">=</span>/build/openssl-avwOZX/openssl-1.1.1<span class="o">=</span>.<span class="w"> </span>-fstack-protector-strong<span class="w"> </span>-Wformat<span class="w"> </span>-Werror<span class="o">=</span>format-security<span class="w"> </span>-DOPENSSL_USE_NODELETE<span class="w"> </span>-DL_ENDIAN<span class="w"> </span>-DOPENSSL_PIC<span class="w"> </span>-DOPENSSL_CPUID_OBJ<span class="w"> </span>-DOPENSSL_BN_ASM_MONT<span class="w"> </span>-DSHA1_ASM<span class="w"> </span>-DSHA256_ASM<span class="w"> </span>-DSHA512_ASM<span class="w"> </span>-DKECCAK1600_ASM<span class="w"> </span>-DAES_ASM<span class="w"> </span>-DVPAES_ASM<span class="w"> </span>-DECP_NISTZ256_ASM<span class="w"> </span>-DX25519_ASM<span class="w"> </span>-DPOLY1305_ASM<span class="w"> </span>-DNDEBUG<span class="w"> </span>-Wdate-time<span class="w"> </span>-D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>The<span class="w"> </span><span class="s1">&#39;numbers&#39;</span><span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span>1000s<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>second<span class="w"> </span>processed.
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="nb">type</span><span class="w">             </span><span class="m">16</span><span class="w"> </span>bytes<span class="w">     </span><span class="m">64</span><span class="w"> </span>bytes<span class="w">    </span><span class="m">256</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w">   </span><span class="m">8192</span><span class="w"> </span>bytes<span class="w">  </span><span class="m">16384</span><span class="w"> </span>bytes
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>des<span class="w"> </span>ede3<span class="w">         </span><span class="m">25120</span>.65k<span class="w">    </span><span class="m">25479</span>.70k<span class="w">    </span><span class="m">25570</span>.13k<span class="w">    </span><span class="m">25604</span>.10k<span class="w">    </span><span class="m">25616</span>.38k<span class="w">    </span><span class="m">25613</span>.65k
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>aes-256<span class="w"> </span>cbc<span class="w">      </span><span class="m">79140</span>.44k<span class="w">    </span><span class="m">82350</span>.23k<span class="w">    </span><span class="m">83815</span>.94k<span class="w">    </span><span class="m">84183</span>.72k<span class="w">    </span><span class="m">84290</span>.22k<span class="w">    </span><span class="m">84306</span>.60k
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>aes-128-cbc<span class="w">     </span><span class="m">310027</span>.28k<span class="w">   </span><span class="m">647168</span>.64k<span class="w">   </span><span class="m">890896</span>.81k<span class="w">   </span><span class="m">984001</span>.19k<span class="w">  </span><span class="m">1014827</span>.69k<span class="w">  </span><span class="m">1017096</span>.87k
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>sha256<span class="w">           </span><span class="m">58347</span>.98k<span class="w">   </span><span class="m">151006</span>.68k<span class="w">   </span><span class="m">286465</span>.28k<span class="w">   </span><span class="m">373490</span>.69k<span class="w">   </span><span class="m">411044</span>.52k<span class="w">   </span><span class="m">414012</span>.76k
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a><span class="w">                  </span>sign<span class="w">    </span>verify<span class="w">    </span>sign/s<span class="w"> </span>verify/s
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>rsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>bits<span class="w"> </span><span class="m">0</span>.001442s<span class="w"> </span><span class="m">0</span>.000040s<span class="w">    </span><span class="m">693</span>.5<span class="w">  </span><span class="m">25212</span>.7
</span></code></pre></div>
<h3 id="总结"><a class="toclink" href="../../hardware/2020/11/19/arm-m1-macbookair/#总结">总结</a></h3>
<p>总的来说，还是挺香的。不错的性能，没有风扇的喧闹，没有烫手的键盘。可能有少部分软件还不能正常运行，然后很多程序还需要 Rosetta 翻译，但目前来看兼容性还是挺不错的，并且这些应该明年就都适配地差不多了吧。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-11-08 00:00:00+00:00">2020年11月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-spack-中用-external-的-slurm-依赖编译-openmpi"><a class="toclink" href="../../software/2020/11/08/spack-openmpi-slurm-external/">在 Spack 中用 external 的 Slurm 依赖编译 OpenMPI</a></h2>
<p>最近在一个集群上，需要用一个自己编译的 openmpi，但并没有 root 权限，所以需要自己搞一个 spack，在 spack 里面装 openmpi。但默认的安装选项下，它没有打开 slurm 支持，所以 srun 的话会出问题，只能 sbatch 然后指定 host 去做。于是我研究了一下怎么在 spack 里引入 external 的 slurm，然后用它来编译 openmpi</p>
<p>首先，编译 <code>~/.spack/packages.yaml</code>：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">packages</span><span class="p">:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">  </span><span class="nt">slurm</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="nt">buildable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">      </span><span class="s">&quot;slurm@15-08-7-1%gcc@8.3.0</span><span class="nv"> </span><span class="s">arch=linux-ubuntu16.04-haswell&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr</span>
</span></code></pre></div>
<p>这里 slurm 版本是 <code>15.08.7</code>，我就按照 spack 里面 slurm 的版本号来写了。可以用 <code>spack spec openmpi schedulers=slurm +pmi</code> 来确认一下外部的 slurm 确实出现在了依赖之中。</p>
<p>这一步配好的话，安装的时候就会直接跳过 spack 里面 slurm 的安装。但又出现了 configure 错误，找不到 pmi 的库。于是，先用 external 的 mpirun 看一下配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>openmpi-3.0.0
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>$<span class="w"> </span>ompi_info
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>...
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>--with-pmi<span class="o">=</span>/usr
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>--with-pmi-libdir<span class="o">=</span>/usr/lib/x86_64-linux-gnu
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>...
</span></code></pre></div>
<p>可以看到，需要两个 config 参数。然后，在 spack 的 openmpi package.py 中：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;schedulers=slurm&#39;</span><span class="p">):</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>  <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--with-pmi=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>  <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.1.3:&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.0.3&#39;</span><span class="p">):</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="k">if</span> <span class="s1">&#39;+static&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>      <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--enable-static&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p>所以，需要加一个小 patch：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;schedulers=slurm&#39;</span><span class="p">):</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>  <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--with-pmi=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>  <span class="c1"># patched here</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>  <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--with-pmi-libdir=</span><span class="si">{0}</span><span class="s1">/lib/x86_64-linux-gnu&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>  <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.1.3:&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s1">&#39;@3.0.3&#39;</span><span class="p">):</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="k">if</span> <span class="s1">&#39;+static&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>      <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--enable-static&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p>然后，就可以编译通过了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-18 00:00:00+00:00">2020年10月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在裸机上部署-esxi-和-vcsa-7"><a class="toclink" href="../../devops/2020/10/18/deploy-esxi-vcsa-7/">在裸机上部署 ESXi 和 vCSA 7</a></h2>
<p>之前在另一篇文章里提到过 vCSA 的安装，这次又在另一台机器上重新做了一遍，特此记录一下。</p>
<p>首先在官网上下载 <a href="https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7">ESXi+VCSA 7.0</a> ，应该得到两个文件：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>7.9G VMware-VCSA-all-7.0.1-16860138.iso
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>358M VMware-VMvisor-Installer-7.0U1-16850804.x86_64.iso
</span></code></pre></div>
<p>首先安装 ESXi，用 UNetBootin 制作 ESXi 的安装光盘。注意不能用 dd，因为它是 CDFS 格式的，不能直接 boot。启动以后，按照界面要求，一路安装即可。</p>
<p>接着，就可以用网页访问 ESXi 进行配置。比如安装一些 Linux 发行版，然后在 Linux 虚拟机里面 mount 上面的 VCSA 的 iso：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>sudo<span class="w"> </span>mount<span class="w"> </span>/dev/sr0<span class="w"> </span>/mnt
</span></code></pre></div>
<p>接着，复制并修改 <code>/mnt/vcsa-cli-installer/templates/install/embedded_vCSA_on_ESi.json</code>，按照代码注释进行修改。需要注意几点：</p>
<ol>
<li>密码都可以设为空，然后运行 cli 的时候输入</li>
<li>ESXi 的密码和 vCSA 的密码是不一样的</li>
<li>可以把 ceip 关掉，设置 ceip_enabled: false</li>
</ol>
<p>接着，进行安装：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>/mnt/vcsa-cli-installer/lin64/vcsa-deploy<span class="w"> </span>install<span class="w"> </span>--accept-eula<span class="w"> </span>/path/to/customized.json<span class="w"> </span>-v
</span></code></pre></div>
<p>慢慢等待它安装成功即可。</p>
<p>安装完成后，进入 vCSA，新建一个 Datacenter，然后选择新建的 Datacenter，选择 Add host，输入 ESXi 的地址和用户密码信息即可。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-09 00:00:00+00:00">2020年10月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ibm-power-s822lc8335-gtb-bmc-升级"><a class="toclink" href="../../system/2020/10/09/upgrade-power8-bmc/">IBM Power S822LC(8335-GTB) BMC 升级</a></h2>
<h3 id="背景"><a class="toclink" href="../../system/2020/10/09/upgrade-power8-bmc/#背景">背景</a></h3>
<p>最近拿到一台 IBM Power S822LC（8335-GTB）机器的访问权限，这也是我第一次碰 ppc64le 指令集的服务器。然后发现，它的 BMC 版本比较老，我想连接 Remote Control 失败了，原因是 JViewer 不支持 macOS，我就想着能不能升级一下。</p>
<h3 id="升级过程"><a class="toclink" href="../../system/2020/10/09/upgrade-power8-bmc/#升级过程">升级过程</a></h3>
<p>首先，在网上找了一下文档，首先用 ipmitool 找一下机器型号：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>ipmitool<span class="w"> </span>fru<span class="w"> </span>print<span class="w"> </span><span class="m">3</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w"> </span>Chassis<span class="w"> </span>Type<span class="w">          </span>:<span class="w"> </span>Unknown
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w"> </span>Chassis<span class="w"> </span>Part<span class="w"> </span>Number<span class="w">   </span>:<span class="w"> </span><span class="m">8335</span>-GTB
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w"> </span>Chassis<span class="w"> </span>Serial<span class="w">        </span>:<span class="w"> </span>REDACTED
</span></code></pre></div>
<p>可以看到，这台机器是 8335-GTB 型号，按照这个型号在 <a href="https://www.ibm.com/support/fixcentral">Fix Central</a> 上搜索，可以找到若干个版本的 firmware，其中最老的版本是 <code>OP8_v1.11_2.1</code>，对比了一下，和原来的版本一致：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>ipmitool<span class="w"> </span>fru<span class="w"> </span>print<span class="w"> </span><span class="m">47</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w"> </span>Product<span class="w"> </span>Name<span class="w">          </span>:<span class="w"> </span>OpenPOWER<span class="w"> </span>Firmware
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w"> </span>Product<span class="w"> </span>Version<span class="w">       </span>:<span class="w"> </span>IBM-garrison-ibm-OP8_v1.11_2.1
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>op-build-da02863
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>buildroot-81b8d98
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>skiboot-5.3.6
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>hostboot-1f6784d-3408af7
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>linux-4.4.16-openpower1-bc83f92
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>petitboot-v1.2.4-de6cda2
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>garrison-xml-3db7b6e
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>occ-69fb587
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>hostboot-binar
</span></code></pre></div>
<p>于是，我下载了比较新的版本，一个 hpm 文件，然后在 BMC 网页上进行升级。第一次升级比较保守，选择了 2017 年的版本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>ipmitool<span class="w"> </span>fru<span class="w"> </span>print<span class="w"> </span><span class="m">47</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Product<span class="w"> </span>Name<span class="w">          </span>:<span class="w"> </span>OpenPOWER<span class="w"> </span>Firmware
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w"> </span>Product<span class="w"> </span>Version<span class="w">       </span>:<span class="w"> </span>IBM-garrison-ibm-OP8_v1.12_2.72
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>op-build-14a75d0
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>buildroot-211bd05
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>skiboot-5.4.3
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>hostboot-2eb7706-69b1432
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>linux-4.4.30-openpower1-084eb48
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>petitboot-v1.3.2-d709207
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>garrison-xml-19a5164
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>occ-d7efe30-47b58cb
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>hostb
</span></code></pre></div>
<p>这次升级比较顺利，没有遇到什么障碍。但是我发现，BMC 里面显示的 BIOS 版本和 hpm 对不上，它总是认为 BIOS 版本是落后的，需要更新，而 Firmware 部分（BOOT 和 APP）是更新后的版本。但 BIOS 版本和原来的版本也不一样。于是我重新升级了几次，都没有效果，怀疑是升级出了问题。后来仔细读文档才发现，确实是 BMC 软件的问题（<a href="https://ak-delivery04-mul.dhe.ibm.com/sar/CMA/SFA/08cu1/0/8335GTB_820.1923.20190613n.xhtml">文档</a>）：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Note: BMC Dashboard shows an incorrect level for the BIOS caused by improper translation of the level subfields. The Bios number should reflect the PNOR level for the system of &quot;IBM-garrison-ibm-OP8_v1.11_2.19&quot;. In this case, the BIOS version should be 1.11_2.19 but shows as 1.17.19 instead with the &quot;11_2&quot; converted into the &quot;17&quot;.
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>The Firmware Revision for the BMC firmware shows correctly as &quot;2.13.58&quot;.
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>Here is an example output of the Dashboard with an errant BIOS Version:
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>Dashboard gives the overall information about the status of the device and remote server.
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>Device Information
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>Firmware Revision: 2.13.58
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>Firmware Build Time: Oct 26 2016 11:40:55 CDT
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>BIOS Version: 1.17.19
</span></code></pre></div>
<p>一番捣鼓之后，不知道怎么了，BMC 就挂了，怎么访问都不通。只好物理断电，重新来过。按照同样的方法，升级到了 2019 年的版本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w"> </span>Product<span class="w"> </span>Name<span class="w">          </span>:<span class="w"> </span>OpenPOWER<span class="w"> </span>Firmware
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w"> </span>Product<span class="w"> </span>Version<span class="w">       </span>:<span class="w"> </span>IBM-garrison-OP8_v1.12_2.96
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>op-build-v2.3-7-g99a6bc8
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>buildroot-2019.02.1-16-ge01dcd0
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>skiboot-v6.3.1
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>hostboot-p8-c893515-pd6f049d
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>occ-p8-a2856b7
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>linux-5.0.7-openpower1-p8e31f00
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>petitboot-v1.10.3
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w"> </span>Product<span class="w"> </span>Extra<span class="w">         </span>:<span class="w">        </span>machine-xml-c5c3
</span></code></pre></div>
<p>中途也遇到了几次奇怪的问题，多次通过 IPMI reset 之后就好了。</p>
<h3 id="远程访问"><a class="toclink" href="../../system/2020/10/09/upgrade-power8-bmc/#远程访问">远程访问</a></h3>
<p>但是，最新版的 BMC 固件中，JViewer 依然没有 macOS 支持。我也 SSH 进去确认了一下，确实没有对应的支持文件。只好在 Linux 机器上访问，安装 icedtea 以后，就可以打开 jnlp 文件，之后一切都很正常。</p>
<p>一个可能的替代方案：https://github.com/sciapp/nojava-ipmi-kvm</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-13 00:00:00+00:00">2020年9月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/programming/" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-arm64-上使用-rust-analyzer"><a class="toclink" href="../../programming/2020/09/13/aarch64-rust-analyzer/">在 arm64 上使用 rust-analyzer</a></h2>
<p>远程到 arm64 的机器上进行开发，发现没有 rust-analyzer 的支持。研究了一下，发现在 rustup 里面可以找到，不过要配置一下：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&gt;<span class="w"> </span>rustup<span class="w"> </span>toolchain<span class="w"> </span>add<span class="w"> </span>nightly
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>&gt;<span class="w"> </span>rustup<span class="w"> </span>component<span class="w"> </span>add<span class="w"> </span>--toolchain<span class="w"> </span>nightly<span class="w"> </span>rust-analyzer-preview
</span></code></pre></div>
<p>这个时候，应该可以找到 <code>~/.rustup/toolchains/nightly-aarch64-unknown-linux-gnu/bin/rust-analyzer</code> 文件，接下来，配置 VSCode 插件即可：</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="nt">&quot;rust-analyzer.serverPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~/.rustup/toolchains/nightly-aarch64-unknown-linux-gnu/bin/rust-analyzer&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>路径在 <code>~/.vscode-server/data/Machine/settings.json</code>。</p>
<p>参考：https://github.com/rust-analyzer/rust-analyzer/issues/5256</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-12 00:00:00+00:00">2020年9月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-rpi4-上运行-buildroot"><a class="toclink" href="../../devops/2020/09/12/buildroot-rpi-pxe/">在 Rpi4 上运行 buildroot</a></h2>
<h3 id="背景"><a class="toclink" href="../../devops/2020/09/12/buildroot-rpi-pxe/#背景">背景</a></h3>
<p>需要给 rpi 配置一个 pxe 的最小环境，在上一篇博文了提到可以用 alpine，但发现有一些不好用的地方，所以试了试 buildroot。</p>
<h3 id="pxe-设置和路由器设置"><a class="toclink" href="../../devops/2020/09/12/buildroot-rpi-pxe/#pxe-设置和路由器设置">PXE 设置和路由器设置</a></h3>
<p>见“在 Rpi4 上运行 Alpine Linux”文章。</p>
<h3 id="buildroot-配置"><a class="toclink" href="../../devops/2020/09/12/buildroot-rpi-pxe/#buildroot-配置">Buildroot 配置</a></h3>
<p>下载 buildroot：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&gt;<span class="w"> </span>wget<span class="w"> </span>https://buildroot.org/downloads/buildroot-2020.08.tar.gz
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>&gt;<span class="w"> </span>unar<span class="w"> </span>buildroot-2020.08.tar.gz
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>&gt;<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>buildroot-2020.08
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>&gt;<span class="w"> </span>make<span class="w"> </span>raspberrypi4_64_defconfig
</span></code></pre></div>
<p>然后运行 <code>make menuconfig</code> ，在 <code>Filesystem images</code> 中打开 initramfs，并设置 cpio 压缩为 gz。然后直接编译：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>&gt;<span class="w"> </span>make<span class="w"> </span>-j4
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>$<span class="w"> </span>ls<span class="w"> </span>-al<span class="w"> </span>target/images
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>bcm2711-rpi-4-b.dtb*<span class="w">  </span>boot.vfat<span class="w">  </span>Image<span class="w">  </span>rootfs.cpio<span class="w">  </span>rootfs.cpio.gz<span class="w">  </span>rootfs.ext2<span class="w">  </span>rootfs.ext4@<span class="w">  </span>rpi-firmware/<span class="w">  </span>sdcard.img
</span></code></pre></div>
<p>接着，在一个单独的目录里，把这些文件整理一下</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>&gt;<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/rpi-buildroot
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>&gt;<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>~/buildroot-2020.08/output/images/rpi-firmware/*<span class="w"> </span>.
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>&gt;<span class="w"> </span>cp<span class="w"> </span>~/buildroot-2020.08/output/images/bcm2711-rpi-4-b.dtb<span class="w"> </span>.
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>&gt;<span class="w"> </span>cp<span class="w"> </span>~/buildroot-2020.08/output/images/Image<span class="w"> </span>.
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>&gt;<span class="w"> </span>cp<span class="w"> </span>~/buildroot-2020.08/output/images/rootfs.cpio.gz<span class="w"> </span>.
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>&gt;<span class="w"> </span><span class="c1"># edit cmdline.txt: remove root= and rootwait</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>&gt;<span class="w"> </span><span class="c1"># edit config.txt: uncomment initramfs rootfs.cpio.gz line</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1"># ls</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>bcm2711-rpi-4-b.dtb*<span class="w">  </span>cmdline.txt<span class="w">  </span>config.txt<span class="w">  </span>fixup.dat<span class="w">  </span>Image<span class="w">  </span>overlays/<span class="w">  </span>rootfs.cpio.gz<span class="w">  </span>start.elf
</span></code></pre></div>
<p>最后开启 TFTP 服务器即可：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>&gt;<span class="w"> </span>sudo<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>py3tftp<span class="w"> </span>-p<span class="w"> </span><span class="m">69</span>
</span></code></pre></div>
<h3 id="树莓派启动"><a class="toclink" href="../../devops/2020/09/12/buildroot-rpi-pxe/#树莓派启动">树莓派启动</a></h3>
<p>连接树莓派的串口，用 115200 Baudrate 打开，可以看到启动信息：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>PM_RSTS: 0x00001000
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>RPi: BOOTLOADER release VERSION:a5e1b95f DATE: Apr 16 2020 TIME: 18:11:29 BOOTMODE: 0x00000006 part: 0 BUILD_TIMESTAMP=1587057086 0xa049cc2f 0x00c03111
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>uSD voltage 3.3V
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>... 
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>Welcome to Buildroot
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>buildroot login: root
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>#
</span></code></pre></div>
<p>默认用户是 root，没有密码。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-11 00:00:00+00:00">2020年9月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-rpi4-上用-pxe-运行-alpine-linux"><a class="toclink" href="../../devops/2020/09/11/alpine-rpi-pxe/">在 rpi4 上用 PXE 运行 Alpine Linux</a></h2>
<h3 id="背景"><a class="toclink" href="../../devops/2020/09/11/alpine-rpi-pxe/#背景">背景</a></h3>
<p>需要给 rpi 配置一个 pxe 的最小环境，然后看到 alpine 有 rpi 的支持，所以尝试给 rpi4 配置 alpine。</p>
<h3 id="pxe-设置"><a class="toclink" href="../../devops/2020/09/11/alpine-rpi-pxe/#pxe-设置">PXE 设置</a></h3>
<p>第一步是设置 rpi4 的启动模式，打开 BOOT UART 并且打开 网络启动：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&gt;<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/lib/firmware/raspberrypi/bootloader/critical
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>&gt;<span class="w"> </span>rpi-eeprom-config<span class="w"> </span>pieeprom-2021-04-29.bin<span class="w"> </span>&gt;<span class="w"> </span>config.txt
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>$<span class="w"> </span>cat<span class="w"> </span>config.txt
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="o">[</span>all<span class="o">]</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nv">BOOT_UART</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="nv">WAKE_ON_GPIO</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nv">POWER_OFF_ON_HALT</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="nv">DHCP_TIMEOUT</span><span class="o">=</span><span class="m">45000</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="nv">DHCP_REQ_TIMEOUT</span><span class="o">=</span><span class="m">4000</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="nv">TFTP_FILE_TIMEOUT</span><span class="o">=</span><span class="m">30000</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="nv">TFTP_IP</span><span class="o">=</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="nv">TFTP_PREFIX</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="nv">BOOT_ORDER</span><span class="o">=</span>0x1
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="nv">SD_BOOT_MAX_RETRIES</span><span class="o">=</span><span class="m">3</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="nv">NET_BOOT_MAX_RETRIES</span><span class="o">=</span><span class="m">5</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="o">[</span>none<span class="o">]</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="nv">FREEZE_VERSION</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>&gt;<span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/BOOT_UART=0/BOOT_UART=1/;s/BOOT_ORDER=0x1/BOOR_ORDER=0x12/&#39;</span><span class="w"> </span>config.txt<span class="w"> </span>&gt;<span class="w"> </span>config-pxe.txt
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>&gt;<span class="w"> </span>rpi-eeprom-config<span class="w"> </span>--out<span class="w"> </span>pieeprom-2021-04-29-pxe.bin<span class="w"> </span>--config<span class="w"> </span>config-pxe.txt<span class="w"> </span>pieeprom-2021-04-29.bin
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>&gt;<span class="w"> </span>rpi-eeprom-update<span class="w"> </span>-d<span class="w"> </span>-f<span class="w"> </span>pieeprom-2021-04-29-pxe.bin
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>&gt;<span class="w"> </span>reboot
</span></code></pre></div>
<p>重启以后，可以用 <code>vcgencmd bootloader_config</code> 查看当前的启动配置，看是否正确地更新了启动配置。比较重要的是 <a href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#BOOT_ORDER">BOOT_ORDER</a>，<code>0x12</code> 表示先尝试网络启动，再尝试 SD 卡启动。</p>
<h3 id="路由器配置"><a class="toclink" href="../../devops/2020/09/11/alpine-rpi-pxe/#路由器配置">路由器配置</a></h3>
<p>第二步，需要配置路由器，以 OpenWrt 为例：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>&gt;<span class="w"> </span>uci<span class="w"> </span>add_list<span class="w"> </span>dhcp.lan.dhcp_option<span class="o">=</span><span class="s2">&quot;66,ip_address_of_tftp_server&quot;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>&gt;<span class="w"> </span>uci<span class="w"> </span>commit<span class="w"> </span>dhcp
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>&gt;<span class="w"> </span>/etc/init.d/dnsmasq<span class="w"> </span>restart
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>$<span class="w"> </span>cat<span class="w"> </span>/etc/config/dhcp
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>...
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>config<span class="w"> </span>dhcp<span class="w"> </span><span class="s1">&#39;lan&#39;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span>...
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span>list<span class="w"> </span>dhcp_option<span class="w"> </span><span class="s1">&#39;66,ip_address_of_tftp_server&#39;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>...
</span></code></pre></div>
<p>这样就配置完毕了。如果是 isc-dhcp-server，修改 <code>/etc/dhcp/dhcpd.conf</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>subnet 10.0.1.0 netmask 255.255.255.0 {
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    range 10.0.1.100 10.0.1.199;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    option routers 10.0.1.1;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    option tftp-server-name &quot;10.0.1.1&quot;;
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>}
</span></code></pre></div>
<h3 id="tftp-服务器配置"><a class="toclink" href="../../devops/2020/09/11/alpine-rpi-pxe/#tftp-服务器配置">TFTP 服务器配置</a></h3>
<p>下载 alpine linux 的 rpi boot，解压到指定目录：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>&gt;<span class="w"> </span>wget<span class="w"> </span>http://mirrors.tuna.tsinghua.edu.cn/alpine/v3.12/releases/aarch64/alpine-rpi-3.12.0-aarch64.tar.gz
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>&gt;<span class="w"> </span>unar<span class="w"> </span>alpine-rpi-3.12.0-aarch64.tar.gz
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>&gt;<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>alpine-rpi-3.12.0-aarch64
</span></code></pre></div>
<p>修改 <code>cmdline.txt</code> ，把 <code>console=tty1</code> 改成 <code>console=ttyAMA0,115200</code>，并且去掉 <code>quiet</code>；修改 <code>usercfg.txt</code> 为：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>dtoverlay=disable-bt
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>enable_uart=1
</span></code></pre></div>
<p>接着，启动 TFTP 服务器：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>&gt;<span class="w"> </span>sudo<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>py3tftp<span class="w"> </span>-p<span class="w"> </span><span class="m">69</span>
</span></code></pre></div>
<h3 id="树莓派启动"><a class="toclink" href="../../devops/2020/09/11/alpine-rpi-pxe/#树莓派启动">树莓派启动</a></h3>
<p>连接树莓派的串口，用 115200 Baudrate 打开，可以看到启动信息：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>PM_RSTS: 0x00001000
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>RPi: BOOTLOADER release VERSION:a5e1b95f DATE: Apr 16 2020 TIME: 18:11:29 BOOTMODE: 0x00000006 part: 0 BUILD_TIMESTAMP=1587057086 0xa049cc2f 0x00c03111
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>uSD voltage 3.3V
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>... 
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>initramfs emergency recovery shell launched. Type &#39;exit&#39; to continue boot
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>sh: can&#39;t access tty; job control turned off
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>/ #
</span></code></pre></div>
<p>然后，按照需要自定义 initramfs 即可。解压后，修改文件，然后运行：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>&gt;<span class="w"> </span>find<span class="w"> </span>.<span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>--null<span class="w"> </span>-ov<span class="w"> </span>--format<span class="o">=</span>newc<span class="w"> </span><span class="p">|</span><span class="w"> </span>gzip<span class="w"> </span>&gt;<span class="w"> </span>../initramfs-rpi4
</span></code></pre></div>
<p>把自带的 initramfs 替换掉。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-12 00:00:00+00:00">2020年8月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-certbot-申请-route53-上的域名的-letsencrypt-证书并上传到-iam"><a class="toclink" href="../../devops/2020/08/12/certbot-route53-letsencrypt-iam/">用 certbot 申请 route53 上的域名的 LetsEncrypt 证书并上传到 IAM</a></h2>
<p>最近遇到了 AWS Certificate Manager 的一些限制，所以只能用 IAM 证书。于是上网找到了通过 certbot 申请 LE 证书，通过 route53 API 验证的方法。</p>
<p>首先配置 aws 的 credential。然后，按照 certbot：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>pip3<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>certbot<span class="w"> </span>certbot_dns_route53
</span></code></pre></div>
<p>然后，就可以申请证书了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>certbot<span class="w"> </span>certonly<span class="w"> </span>--dns-route53<span class="w"> </span>--config-dir<span class="w"> </span><span class="s2">&quot;./letsencrypt&quot;</span><span class="w"> </span>--work-dir<span class="w"> </span><span class="s2">&quot;./letsencrypt&quot;</span><span class="w"> </span>--logs-dir<span class="w"> </span><span class="s2">&quot;./letsencrypt&quot;</span><span class="w">  </span>-d<span class="w"> </span>example.com<span class="w"> </span>--email<span class="w"> </span>a@b.com<span class="w"> </span>--agree-tos
</span></code></pre></div>
<p>如果申请成功，在当前目录下可以找到证书。然后上传到 IAM：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>aws<span class="w"> </span>iam<span class="w"> </span>upload-server-certificate<span class="w"> </span>--server-certificate-name<span class="w"> </span>NameHere<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span>--certificate-body<span class="w"> </span>file://letsencrypt/live/example.com/cert.pem<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span>--private-key<span class="w"> </span>file://letsencrypt/live/example.com/privkey.pem<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span>--certificate-chain<span class="w"> </span>file://letsencrypt/live/example.com/chain.pem<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span>--path<span class="w"> </span>/cloudfront/
</span></code></pre></div>
<p>如果要用于 cloudfront，才需要最后的路径参数；否则可以去掉。这样就完成了 IAM 证书的上传。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-07-10 00:00:00+00:00">2020年7月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-k8s-中部署-prometheus"><a class="toclink" href="../../devops/2020/07/10/k8s-prometheus/">在 k8s 中部署 Prometheus</a></h2>
<p>实验了一下在 k8s 中部署 Prometheus，因为它和 k8s 有比较好的集成，很多 App 能在 k8s 里通过 service discovery 被 Prometheus 找到并且抓取数据。实践了一下，其实很简单。</p>
<p>用 helm 进行配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>prometheus<span class="w"> </span>stable/prometheus
</span></code></pre></div>
<p>这样就可以了，如果已经有 StorageClass（比如腾讯云的话，CBS 和 CFS），它就能自己起来了，然后在 Lens 里面也可以看到各种 metrics 的可视化。</p>
<p>如果是自建的单结点的 k8s 集群，那么还需要自己创造 PV，并且把 PVC 绑定上去。我采用的是 local 类型的 PV：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pv-volume-1</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/srv/k8s-data-1&quot;</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="nn">---</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pv-volume-2</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/srv/k8s-data-2&quot;</span>
</span></code></pre></div>
<p>这样，结点上的两个路径分别对应两个 PV，然后只要让 PVC 也用 manual 的 StorageClass 就可以了：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="nt">persistentVolume</span><span class="p">:</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">        </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nt">alertmanager</span><span class="p">:</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="nt">persistentVolume</span><span class="p">:</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">        </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span></code></pre></div>
<p>把这个文件保存为 values.yaml 然后：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>prometheus<span class="w"> </span>stable/prometheus<span class="w"> </span>-f<span class="w"> </span>values.yaml
</span></code></pre></div>
<p>这样就可以了。不过 PVC 不能在线改，可能需要删掉重来。</p>
<p>然后，由于权限问题，还需要在结点上修改一下两个目录的权限：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">65534</span>:65534<span class="w"> </span>/srv/k8s-data-1
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">65534</span>:65534<span class="w"> </span>/srv/k8s-data-2
</span></code></pre></div>
<p>这样容器内就可以正常访问了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-21 00:00:00+00:00">2020年5月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/crypto/" class="md-meta__link">crypto</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="各种-ecc-曲线"><a class="toclink" href="../../crypto/2020/05/21/ecc-curves/">各种 ecc 曲线</a></h2>
<h3 id="背景知识"><a class="toclink" href="../../crypto/2020/05/21/ecc-curves/#背景知识">背景知识</a></h3>
<p>椭圆曲线有如下的形式：</p>
<p>第一种：</p>
<div class="arithmatex">\[E: y^2 \equiv x^3 + ax + b \mod{p}\]</div>
<p>曲线的参数共有 <span class="arithmatex">\((p, a, b, G, n, h)\)</span>。<span class="arithmatex">\(G\)</span> 是一个点 <span class="arithmatex">\((G_x, G_y)\)</span>，<span class="arithmatex">\(n\)</span> 是 <span class="arithmatex">\(G\)</span> 的阶。</p>
<p>第二种：</p>
<div class="arithmatex">\[E: y^2+xy=x^3+ax^2+1\]</div>
<p>称为 Kbolitz curve。不同的曲线有不同的参数 <span class="arithmatex">\((m,f(x),a,b,G,n,h)\)</span>，对应不同的 <span class="arithmatex">\(GF(2^m)\)</span> 域。</p>
<h3 id="openssl"><a class="toclink" href="../../crypto/2020/05/21/ecc-curves/#openssl">OpenSSL</a></h3>
<p>看一下 openssl 支持的曲线参数（<code>openssl ecparam -list_curves</code>）：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>  secp112r1 : SECG/WTLS curve over a 112 bit prime field
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  secp112r2 : SECG curve over a 112 bit prime field
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  secp128r1 : SECG curve over a 128 bit prime field
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  secp128r2 : SECG curve over a 128 bit prime field
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  secp160k1 : SECG curve over a 160 bit prime field
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>  secp160r1 : SECG curve over a 160 bit prime field
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>  secp160r2 : SECG/WTLS curve over a 160 bit prime field
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>  secp192k1 : SECG curve over a 192 bit prime field
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  secp224k1 : SECG curve over a 224 bit prime field
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  secp224r1 : NIST/SECG curve over a 224 bit prime field
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>  secp256k1 : SECG curve over a 256 bit prime field
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>  secp384r1 : NIST/SECG curve over a 384 bit prime field
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>  secp521r1 : NIST/SECG curve over a 521 bit prime field
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>  prime192v1: NIST/X9.62/SECG curve over a 192 bit prime field
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>  prime192v2: X9.62 curve over a 192 bit prime field
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>  prime192v3: X9.62 curve over a 192 bit prime field
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>  prime239v1: X9.62 curve over a 239 bit prime field
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>  prime239v2: X9.62 curve over a 239 bit prime field
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>  prime239v3: X9.62 curve over a 239 bit prime field
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>  prime256v1: X9.62/SECG curve over a 256 bit prime field
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>  sect113r1 : SECG curve over a 113 bit binary field
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>  sect113r2 : SECG curve over a 113 bit binary field
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>  sect131r1 : SECG/WTLS curve over a 131 bit binary field
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>  sect131r2 : SECG curve over a 131 bit binary field
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>  sect163k1 : NIST/SECG/WTLS curve over a 163 bit binary field
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>  sect163r1 : SECG curve over a 163 bit binary field
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>  sect163r2 : NIST/SECG curve over a 163 bit binary field
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>  sect193r1 : SECG curve over a 193 bit binary field
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>  sect193r2 : SECG curve over a 193 bit binary field
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>  sect233k1 : NIST/SECG/WTLS curve over a 233 bit binary field
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>  sect233r1 : NIST/SECG/WTLS curve over a 233 bit binary field
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>  sect239k1 : SECG curve over a 239 bit binary field
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>  sect283k1 : NIST/SECG curve over a 283 bit binary field
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>  sect283r1 : NIST/SECG curve over a 283 bit binary field
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>  sect409k1 : NIST/SECG curve over a 409 bit binary field
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>  sect409r1 : NIST/SECG curve over a 409 bit binary field
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>  sect571k1 : NIST/SECG curve over a 571 bit binary field
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>  sect571r1 : NIST/SECG curve over a 571 bit binary field
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>  c2pnb163v1: X9.62 curve over a 163 bit binary field
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>  c2pnb163v2: X9.62 curve over a 163 bit binary field
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>  c2pnb163v3: X9.62 curve over a 163 bit binary field
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>  c2pnb176v1: X9.62 curve over a 176 bit binary field
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>  c2tnb191v1: X9.62 curve over a 191 bit binary field
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>  c2tnb191v2: X9.62 curve over a 191 bit binary field
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>  c2tnb191v3: X9.62 curve over a 191 bit binary field
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>  c2pnb208w1: X9.62 curve over a 208 bit binary field
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>  c2tnb239v1: X9.62 curve over a 239 bit binary field
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>  c2tnb239v2: X9.62 curve over a 239 bit binary field
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>  c2tnb239v3: X9.62 curve over a 239 bit binary field
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>  c2pnb272w1: X9.62 curve over a 272 bit binary field
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>  c2pnb304w1: X9.62 curve over a 304 bit binary field
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>  c2tnb359v1: X9.62 curve over a 359 bit binary field
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>  c2pnb368w1: X9.62 curve over a 368 bit binary field
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>  c2tnb431r1: X9.62 curve over a 431 bit binary field
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>  wap-wsg-idm-ecid-wtls1: WTLS curve over a 113 bit binary field
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>  wap-wsg-idm-ecid-wtls3: NIST/SECG/WTLS curve over a 163 bit binary field
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>  wap-wsg-idm-ecid-wtls4: SECG curve over a 113 bit binary field
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>  wap-wsg-idm-ecid-wtls5: X9.62 curve over a 163 bit binary field
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>  wap-wsg-idm-ecid-wtls6: SECG/WTLS curve over a 112 bit prime field
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>  wap-wsg-idm-ecid-wtls7: SECG/WTLS curve over a 160 bit prime field
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>  wap-wsg-idm-ecid-wtls8: WTLS curve over a 112 bit prime field
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>  wap-wsg-idm-ecid-wtls9: WTLS curve over a 160 bit prime field
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>  wap-wsg-idm-ecid-wtls10: NIST/SECG/WTLS curve over a 233 bit binary field
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>  wap-wsg-idm-ecid-wtls11: NIST/SECG/WTLS curve over a 233 bit binary field
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>  wap-wsg-idm-ecid-wtls12: WTLS curve over a 224 bit prime field
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>  Oakley-EC2N-3: 
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>    IPSec/IKE/Oakley curve #3 over a 155 bit binary field.
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>    Not suitable for ECDSA.
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>    Questionable extension field!
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>  Oakley-EC2N-4: 
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>    IPSec/IKE/Oakley curve #4 over a 185 bit binary field.
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>    Not suitable for ECDSA.
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>    Questionable extension field!
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>  brainpoolP160r1: RFC 5639 curve over a 160 bit prime field
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>  brainpoolP160t1: RFC 5639 curve over a 160 bit prime field
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>  brainpoolP192r1: RFC 5639 curve over a 192 bit prime field
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>  brainpoolP192t1: RFC 5639 curve over a 192 bit prime field
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>  brainpoolP224r1: RFC 5639 curve over a 224 bit prime field
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>  brainpoolP224t1: RFC 5639 curve over a 224 bit prime field
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>  brainpoolP256r1: RFC 5639 curve over a 256 bit prime field
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>  brainpoolP256t1: RFC 5639 curve over a 256 bit prime field
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>  brainpoolP320r1: RFC 5639 curve over a 320 bit prime field
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>  brainpoolP320t1: RFC 5639 curve over a 320 bit prime field
</span><span id="__span-0-84"><a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>  brainpoolP384r1: RFC 5639 curve over a 384 bit prime field
</span><span id="__span-0-85"><a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>  brainpoolP384t1: RFC 5639 curve over a 384 bit prime field
</span><span id="__span-0-86"><a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>  brainpoolP512r1: RFC 5639 curve over a 512 bit prime field
</span><span id="__span-0-87"><a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>  brainpoolP512t1: RFC 5639 curve over a 512 bit prime field
</span><span id="__span-0-88"><a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>  SM2       : SM2 curve over a 256 bit prime field
</span></code></pre></div>
<p>这个列表很长，主要有几个参数：</p>
<ol>
<li>什么域：素数域还是 <span class="arithmatex">\(GF(2^m)\)</span> 域</li>
<li>位数：域有多少位</li>
<li>标准：NIST/SECG/WTLS/X9.62/RFC 5639/SM2/Oakley 表示的是不同的标准</li>
</ol>
<h3 id="nist"><a class="toclink" href="../../crypto/2020/05/21/ecc-curves/#nist">NIST</a></h3>
<p>NIST 在 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf">FIPS 186-4</a> 中定义了基于素数域的 Curve P-192, Curve P-224, Curve P-256, Curve P-384 和 Curve P-521。在 <a href="https://tools.ietf.org/html/rfc5656">RFC5656</a> 中，这几条曲线又名 nistp192 nistp224 nistp256 nistp384 和 nistp521。</p>
<p>Curve P-192: </p>
<div class="arithmatex">\[p = 2^{192}-2^{64}-1\]</div>
<p>Curve P-224: </p>
<div class="arithmatex">\[p=2^{224}-2^{96}-1\]</div>
<p>Curve P-256: </p>
<div class="arithmatex">\[p=2^{256}-2^{224}+2^{192}+2^{96}-1\]</div>
<p>Curve P-384: </p>
<div class="arithmatex">\[p=2^{384}-2^{128}-2^{96}+2^{32}-1\]</div>
<p>Curve P-521: </p>
<div class="arithmatex">\[p=2^{521}-1\]</div>
<p>另一类是基于 Binary Field（<span class="arithmatex">\(GF(2^m)\)</span>）的曲线，有 Curve K-163，Curve B-163，Curve K-233，Curve B-233，Curve K-283，Curve B-283，Curve K-409，Curve B-409，Curve K-571，Curve B-571。相应地，RFC 5656 里又名 nistk163，nistk233，nistb233，nistk283，nistk409，nistb409，nistt571（我觉得是 nistb571/nistk571，不知道是不是写错了）</p>
<p>Degree 163 (K-163/B-163) :</p>
<div class="arithmatex">\[p(t)=t^{163}+t^7+t^6+t^3+1\]</div>
<p>Degree 233 (K-233/B-233) :</p>
<div class="arithmatex">\[p(t)=t^{233}+t^{74}+1\]</div>
<p>Degree 283 (K-283/B-283) :</p>
<div class="arithmatex">\[p(t)=t^{283}+t^{12}+t^7+t^5+1\]</div>
<p>Degree 409 (K-409/B-409) :</p>
<div class="arithmatex">\[p(t)=t^{409}+t^{87}+1\]</div>
<p>Degree 571 (K-571/B-571) :</p>
<div class="arithmatex">\[p(t)=t^{571}+t^{10}+t^5+t^2+1\]</div>
<h3 id="secg"><a class="toclink" href="../../crypto/2020/05/21/ecc-curves/#secg">SECG</a></h3>
<p>SECG 在 <a href="https://www.secg.org/sec2-v2.pdf">SEC2</a> 中定义了若干的曲线，其中一部分和上面的 NIST 是同一个曲线。首先是基于素数域的：</p>
<table>
<thead>
<tr>
<th>NIST</th>
<th>SEC</th>
<th>OID</th>
<th>ANSI</th>
</tr>
</thead>
<tbody>
<tr>
<td>nistp192</td>
<td>secp192r1</td>
<td>1.2.840.10045.3.1.1</td>
<td>prime192v1</td>
</tr>
<tr>
<td></td>
<td>secp192k1</td>
<td>1.3.132.0.31</td>
<td></td>
</tr>
<tr>
<td>nistp224</td>
<td>secp224r1</td>
<td>1.3.132.0.33</td>
<td></td>
</tr>
<tr>
<td></td>
<td>secp224k1</td>
<td>1.3.132.0.32</td>
<td></td>
</tr>
<tr>
<td>nistp256</td>
<td>secp256r1</td>
<td>1.2.840.10045.3.1.7</td>
<td>prime256v1</td>
</tr>
<tr>
<td></td>
<td>secp256k1</td>
<td>1.3.132.0.10</td>
<td></td>
</tr>
<tr>
<td>nistp384</td>
<td>secp384r1</td>
<td>1.3.132.0.34</td>
<td></td>
</tr>
<tr>
<td></td>
<td>secp384k1</td>
<td></td>
<td></td>
</tr>
<tr>
<td>nistp521</td>
<td>secp521r1</td>
<td>1.3.132.0.35</td>
<td></td>
</tr>
<tr>
<td></td>
<td>secp521k1</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>然后是基于 <span class="arithmatex">\(GF(2^m)\)</span> 域的：</p>
<table>
<thead>
<tr>
<th>NIST</th>
<th>SEC</th>
<th>OID</th>
</tr>
</thead>
<tbody>
<tr>
<td>nistk163</td>
<td>sect163k1</td>
<td>1.3.132.0.1</td>
</tr>
<tr>
<td></td>
<td>sect163r1</td>
<td>1.3.132.0.2</td>
</tr>
<tr>
<td>nistb163</td>
<td>sect163r2</td>
<td>1.3.132.0.15</td>
</tr>
<tr>
<td>nistk233</td>
<td>sect233k1</td>
<td>1.3.132.0.26</td>
</tr>
<tr>
<td>nistb233</td>
<td>sect233r1</td>
<td>1.3.132.0.27</td>
</tr>
<tr>
<td></td>
<td>sect239k1</td>
<td>1.3.132.0.3</td>
</tr>
<tr>
<td>nistk283</td>
<td>sect283k1</td>
<td>1.3.132.0.16</td>
</tr>
<tr>
<td>nistb283</td>
<td>sect283r1</td>
<td>1.3.132.0.17</td>
</tr>
<tr>
<td>nistk409</td>
<td>sect409k1</td>
<td>1.3.132.0.36</td>
</tr>
<tr>
<td>nistb409</td>
<td>sect409r1</td>
<td>1.3.132.0.37</td>
</tr>
<tr>
<td>nistk571 (RFC 5656 写的是 nistt571)</td>
<td>sect571k1</td>
<td>1.3.132.0.38</td>
</tr>
<tr>
<td>nistb571</td>
<td>sect571r1</td>
<td>1.3.132.0.39</td>
</tr>
</tbody>
</table>
<p>sec 命名里，第四个字符里 <span class="arithmatex">\(p\)</span> 表示是素数域，<span class="arithmatex">\(t\)</span> 表示是 <span class="arithmatex">\(GF(2^m)\)</span> 域。后面的字母表示的 <span class="arithmatex">\(k\)</span> 表示 Koblitz，<span class="arithmatex">\(r\)</span> 表示 random，是参数的选取方式。</p>
<p>OID 有两种前缀：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>1.3.132.0.x:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>iso(1) identified-organization(3) certicom(132) curve(0)
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>1.2.840.10045.3.1.x:
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>iso(1) member-body(2) us(840) 10045 curves(3) prime(1)
</span></code></pre></div>
<p>完整列表见 <a href="https://oidref.com/1.3.132.0">OID 1.3.132.0</a> 和 <a href="https://oidref.com/1.2.840.10045.3.1">OID 1.2.840.10045.3.1</a></p>
<h3 id="ansi"><a class="toclink" href="../../crypto/2020/05/21/ecc-curves/#ansi">ANSI</a></h3>
<p>ANSI 也有 <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.202.2977&amp;rep=rep1&amp;type=pdf">X9.62 标准</a>，在附录里面也定义了若干个曲线。附录 <code>J.5.1</code> 里面有三个例子，就是 prime192v1 prime192v2 和 prime192v3，之后则是 prime239v1 prime239v2 prime239v3 和 prime256v1。</p>
<table>
<thead>
<tr>
<th>ANSI</th>
<th>别名</th>
<th>OID</th>
</tr>
</thead>
<tbody>
<tr>
<td>prime192v1</td>
<td>nistp192/secp192r1</td>
<td>1.2.840.10045.3.1.1</td>
</tr>
<tr>
<td>prime192v2</td>
<td></td>
<td>1.2.840.10045.3.1.2</td>
</tr>
<tr>
<td>prime192v3</td>
<td></td>
<td>1.2.840.10045.3.1.3</td>
</tr>
<tr>
<td>prime239v1</td>
<td></td>
<td>1.2.840.10045.3.1.4</td>
</tr>
<tr>
<td>prime239v2</td>
<td></td>
<td>1.2.840.10045.3.1.5</td>
</tr>
<tr>
<td>prime239v3</td>
<td></td>
<td>1.2.840.10045.3.1.6</td>
</tr>
<tr>
<td>prime256v1</td>
<td>nistp256/secp256r1</td>
<td>1.2.840.10045.3.1.7</td>
</tr>
</tbody>
</table>
<h3 id="总结"><a class="toclink" href="../../crypto/2020/05/21/ecc-curves/#总结">总结</a></h3>
<p>对于同一个曲线，不同的组织给出了不同的名字，见下表：</p>
<table>
<thead>
<tr>
<th>OpenSSL</th>
<th>NIST</th>
<th>SECG</th>
<th>ANSI</th>
</tr>
</thead>
<tbody>
<tr>
<td>prime192v1</td>
<td>nistp192</td>
<td>secp192r1</td>
<td>prime192v1</td>
</tr>
<tr>
<td>secp224r1</td>
<td>nistp224</td>
<td>secp224r1</td>
<td></td>
</tr>
<tr>
<td>prime256v1</td>
<td>nistp256</td>
<td>secp256r1</td>
<td>prime256v1</td>
</tr>
<tr>
<td>secp384r1</td>
<td>nistp384</td>
<td>secp384r1</td>
<td></td>
</tr>
<tr>
<td>secp521r1</td>
<td>nistp521</td>
<td>secp521r1</td>
<td></td>
</tr>
<tr>
<td>sect163k1</td>
<td>nistk163</td>
<td>sect163k1</td>
<td></td>
</tr>
<tr>
<td>sect163r2</td>
<td>nistb163</td>
<td>sect163r2</td>
<td></td>
</tr>
<tr>
<td>sect233k1</td>
<td>nistk233</td>
<td>sect233k1</td>
<td></td>
</tr>
<tr>
<td>sect233r1</td>
<td>nistb233</td>
<td>sect233r1</td>
<td></td>
</tr>
<tr>
<td>sect283k1</td>
<td>nistk233</td>
<td>sect283k1</td>
<td></td>
</tr>
<tr>
<td>sect283r1</td>
<td>nistb283</td>
<td>sect283r1</td>
<td></td>
</tr>
<tr>
<td>sect409k1</td>
<td>nistk409</td>
<td>sect409k1</td>
<td></td>
</tr>
<tr>
<td>sect409r1</td>
<td>nistb409</td>
<td>sect409r1</td>
<td></td>
</tr>
<tr>
<td>sect571k1</td>
<td>nistk571</td>
<td>sect571k1</td>
<td></td>
</tr>
<tr>
<td>sect571r1</td>
<td>nistb571</td>
<td>sect571r1</td>
<td></td>
</tr>
</tbody>
</table>
<p>在 RFC4492 里也可以看到一个类似的表。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-18 00:00:00+00:00">2020年5月18日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="fido-u2ffido2-和-ctap-的关系"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/">FIDO U2F、FIDO2 和 CTAP 的关系</a></h2>
<h3 id="背景"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#背景">背景</a></h3>
<p>2012 年，Yubico 和 Google 设计了 U2F 协议，第二年 U2F 成为 FIDO 组织的标准，之后加入了 NFC 的支持。之后，FIDO2 作为替代 U2F 的新标准产生，原来的 U2F 以兼容的方式成为了 CTAP1，而采用 CBOR 封装格式的 CTAP(CTAP2) 则是 FIDO2 的主要协议。</p>
<h3 id="u2f"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#u2f">U2F</a></h3>
<h4 id="命令格式"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#命令格式">命令格式</a></h4>
<p>U2F 定义了它的<a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-raw-message-formats-v1.2-ps-20170411.pdf">命令格式</a>，基于 ISO7816-4 APDU（short APDU） ：</p>
<table>
<thead>
<tr>
<th>CLA</th>
<th>INS</th>
<th>P1</th>
<th>P2</th>
<th>Lc</th>
<th>data</th>
<th>Le</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>0-1 bytes</td>
<td>variable length</td>
<td>0-1 bytes</td>
</tr>
</tbody>
</table>
<p>比如 U2F_VERSION 就是：</p>
<table>
<thead>
<tr>
<th>CLA</th>
<th>INS</th>
<th>P1</th>
<th>P2</th>
<th>Lc</th>
<th>data</th>
<th>Le</th>
</tr>
</thead>
<tbody>
<tr>
<td>00</td>
<td>03</td>
<td>00</td>
<td>00</td>
<td>0</td>
<td>empty</td>
<td>00</td>
</tr>
</tbody>
</table>
<p>返回的数据就是 <code>U2F_V2</code> 的 ASCII 加上 <code>9000</code> 的状态。</p>
<p>除此之外，它还有一种 extended length 格式的 APDU，和上面的是等价的不同表示。</p>
<h4 id="传输方式"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#传输方式">传输方式</a></h4>
<p>实际使用 U2F 的时候，又有三种情况，分别是 USB、Bluetooth 和 NFC。</p>
<h5 id="usb"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#usb">USB</a></h5>
<p>在 <a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-hid-protocol-v1.2-ps-20170411.pdf">U2FHID</a> 里面，为了让 U2F 的命令通过 HID 接口传输，它规定了两个 endpoint，分别是 Interrupt IN 和 Interrupt OUT，还有一个固定的 HID Report Descriptor。为了发 U2F 命令，首先会进行一次封装：</p>
<table>
<thead>
<tr>
<th>CMD</th>
<th>BCNT</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>U2FHID_MSG</td>
<td>4..n</td>
<td>n bytes</td>
</tr>
</tbody>
</table>
<p>添加了一个头，表示载荷是一个 U2F 的 command（自然也是 APDU）。</p>
<p>在 cmd 之上，还会封装一层，为了解决 USB 的 packet size 限制等问题，定义了 init packet：</p>
<table>
<thead>
<tr>
<th>CID</th>
<th>CMD</th>
<th>BCNTH</th>
<th>BCNTL</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>4 bytes</td>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>variable length</td>
</tr>
</tbody>
</table>
<p>如果数据太长，就会拆分成一个 init 和 多个 continuation packet：</p>
<table>
<thead>
<tr>
<th>CID</th>
<th>SEQ</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>4 bytes</td>
<td>1 byte</td>
<td>variable length</td>
</tr>
</tbody>
</table>
<p>把 init 和 continuation 里面的 data 组合起来，就是 U2F 的 message，message 里面可能又有 U2F raw command，也就是 APDU。</p>
<p>发送的时候，先 Interrupt OUT 发送请求，再 Interrupt IN 读取回应。</p>
<h5 id="bluetooth"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#bluetooth">Bluetooth</a></h5>
<p>在 <a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-bt-protocol-v1.2-ps-20170411.pdf">U2F/Bluetooth</a> 里面，也用了一个类似的封装格式，请求：</p>
<table>
<thead>
<tr>
<th>CMD</th>
<th>HLEN</th>
<th>LLEN</th>
<th>DATA</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 byte</td>
<td>1 byte</td>
<td>1 byte</td>
<td>variable length</td>
</tr>
</tbody>
</table>
<p>这里的 DATA payload 就是 extended length 格式的 APDU</p>
<h5 id="nfc"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#nfc">NFC</a></h5>
<p>在 <a href="https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-nfc-protocol-v1.2-ps-20170411.pdf">U2F/NFC</a> 里面，既然 ISO 7816-4 本来就是 NFC-native 的格式，就不要额外的封装了。只需要规定一个 Applet 的 AID 即可：<code>A0000006472F0001</code></p>
<h4 id="总结"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#总结">总结</a></h4>
<p>总而言之，U2F raw commands 就是在 APDU 格式上定义了几个命令。在 USB 和 Bluetooth 上都加了几个小的 Header，而 NFC 上则是规定了一个 AID。这对应用程序来说很方便，核心的命令只有一套，需要的时候封装一下即可。</p>
<h3 id="fido2"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#fido2">FIDO2</a></h3>
<p>在之后，<a href="https://fidoalliance.org/specs/fido-v2.0-rd-20170927/fido-client-to-authenticator-protocol-v2.0-rd-20170927.html#message-encoding">FIDO2</a> 出现了，在保持 U2F 兼容的基础上添加了新的功能，并且出现了 WebAuthN 作为浏览器使用 FIDO2 的协议。U2F 就变成了第一代的 CTAP，称为 CTAP1，然后 CTAP 默认指的就是 CTAP2。</p>
<h4 id="命令格式_1"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#命令格式_1">命令格式</a></h4>
<p>FIDO2 里面，定义了一些 CTAP 命令，比如 authenticatorMakeCredential，对应 U2F 的 U2F_REGISTER 命令。然后，规定了一个 <a href="https://tools.ietf.org/html/rfc7049">CBOR</a> 的格式，来表示命令附带的数据。CBOR 是 RFC 7049，所以也是借用过来的格式。</p>
<h4 id="传输方式_1"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#传输方式_1">传输方式</a></h4>
<p>FIDO2 定义了在 USB 和 NFC 上的传输格式。</p>
<h5 id="usb_1"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#usb_1">USB</a></h5>
<p>在 USB 上传输的时候，定义了 CTAPHID 的协议，与 U2FHID 基本是一样的，规定了 init packet 和 continuation packet，packet 里面也是 CTAPHID 的消息，这部分是兼容 U2F 的。并且，额外添加了 CTAPHID_CBOR 消息：</p>
<table>
<thead>
<tr>
<th>CMD</th>
<th>BCNT</th>
<th>DATA</th>
<th>DATA + 1</th>
</tr>
</thead>
<tbody>
<tr>
<td>CTAPHID_CBOR</td>
<td>1..(n+1)</td>
<td>CTAP command</td>
<td>n bytes of CBOR data</td>
</tr>
</tbody>
</table>
<p>它的载荷就是 CBOR 格式的请求。</p>
<p>类似地，它也是通过 Interrupt OUT 发送请求，从 Interrupt IN 读取回应。</p>
<h5 id="nfc_1"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#nfc_1">NFC</a></h5>
<p>在 NFC 上传输的时候，因为内部的格式是 CBOR，不再是 APDU 了，所以需要一些封装。</p>
<p>首先，它也定义了一个 Applet ID：<code>A0000006472F0001</code>，和 U2F 一样。为了保持兼容，它都支持 U2F 定义的 APDU 命令。</p>
<p>那怎么区分设备是否支持 CTAP1/U2F 和 CTAP2 呢？使用前面提到的 U2F_VERSION 命令即可。如果得到 U2F_V2，说明是支持 CTAP1/U2F 的；如果得到是其他的，说明只支持 CTAP2，不支持 CTAP1/U2F。</p>
<p>如果要发 CTAP2 的命令，就要把 CTAP command 和 CBOR 格式的数据封装到 APDU 里面：</p>
<table>
<thead>
<tr>
<th>CLA</th>
<th>INS</th>
<th>P1</th>
<th>P2</th>
<th>Data</th>
<th>Le</th>
</tr>
</thead>
<tbody>
<tr>
<td>80</td>
<td>10</td>
<td>00</td>
<td>00</td>
<td>CTAP Command || CBOR Data</td>
<td>variable</td>
</tr>
</tbody>
</table>
<p>它规定，如果请求采用的是 extended length 的 APDU，那么响应也要是 extended length 的 APDU；如果请求是 short APDU，那么响应也要支持 short APDU 的 chaining。</p>
<h4 id="兼容性"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#兼容性">兼容性</a></h4>
<p>可以看到，CTAP2 设计的基本都考虑了兼容 U2F，允许用 U2F 的 API 操作 U2F 和 CTAP2 的设备；也允许用 CTAP2 的 API 操作 U2F（只支持部分命令）和  CTAP2 的设备。</p>
<h3 id="总结_1"><a class="toclink" href="../../hardware/2020/05/18/fido-u2f-fido2-ctap/#总结_1">总结</a></h3>
<p>可以看到，这里有一堆套娃的过程：</p>
<p>U2F：</p>
<table>
<thead>
<tr>
<th></th>
<th>USB HID</th>
<th>Bluetooth</th>
<th>NFC</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>APDU</td>
<td>APDU</td>
<td>APDU</td>
</tr>
<tr>
<td>3</td>
<td>U2F message</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>USB HID packet</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>USB</td>
<td>Bluetooth</td>
<td>ISO 14443-4/ISO 18092</td>
</tr>
</tbody>
</table>
<p>FIDO2:</p>
<table>
<thead>
<tr>
<th></th>
<th>USB HID</th>
<th>NFC</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>CTAP command + CBOR data</td>
<td>CTAP command + CBOR data</td>
</tr>
<tr>
<td>3</td>
<td>CTAP message</td>
<td>APDU</td>
</tr>
<tr>
<td>2</td>
<td>USB HID packet</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>USB</td>
<td>ISO 14443-4/ISO 18092</td>
</tr>
</tbody>
</table>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-15 00:00:00+00:00">2020年5月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="usbip-模拟-usb-设备"><a class="toclink" href="../../software/2020/05/15/usb-ip-simulation/">USB/IP 模拟 USB 设备</a></h2>
<h3 id="背景"><a class="toclink" href="../../software/2020/05/15/usb-ip-simulation/#背景">背景</a></h3>
<p>2018 年的时候发过一篇博客，讲如何用 USB/IP 协议在两台 Linux 电脑之间共享 USB 设备。最近刚好有一个需求，就是针对一个现成的 USB device 的代码，通过 USB/IP 模拟出一个 USB 设备，然后进行调试。</p>
<h3 id="usbip-协议"><a class="toclink" href="../../software/2020/05/15/usb-ip-simulation/#usbip-协议">USB/IP 协议</a></h3>
<p>USB/IP 只有一个简略的<a href="https://github.com/realthunder/usbip/blob/master/usbip_protocol.txt">文档</a>，为数不多的使用 USB/IP 的代码，所以有一些细节没有说的很清楚，只能一点点去尝试。</p>
<p>首先，USB/IP 基于 TCP，端口号 3240。客户端向服务端发送请求，服务端向客户端进行回应。</p>
<p>请求的类型：OP_REQ_DEVLIST OP_REQ_IMPORT USBIP_CMD_SUBMIT 和 USBIP_CMD_UNLINK</p>
<p>回应的类型：OP_REP_DEVLIST OP_REP_IMPORT USBIP_RET_SUBMIT USBIP_RET_UNLINK</p>
<p>工作的过程大概如下：</p>
<ol>
<li>OP_REQ_DEVLIST 请求获取设备列表</li>
<li>OP_REP_DEVLIST 返回设备列表</li>
<li>OP_REQ_IMPORT 请求 USB 设备</li>
<li>OP_REP_IMPORT 返回 USB 设备</li>
<li>USBIP_CMD_SUBMIT 发送 URB</li>
<li>USBIP_RET_SUBMIT 返回 URB</li>
</ol>
<p>（先不考虑 CMD_UNLINK 和 RET_UNLINK）</p>
<p>其中前面四个比较简单清晰，所需要的字段也都是 Descriptor 中对应的字段。后面两个就相对复杂一些：URB data 的长度需要根据 endpoint 类型和 direction 共同决定。URB 实际上是 Linux 内核里的一个数据结构。</p>
<h3 id="usb-协议"><a class="toclink" href="../../software/2020/05/15/usb-ip-simulation/#usb-协议">USB 协议</a></h3>
<p>那么，USB 协议的几种 transfer 怎么对应到 URB 的数据呢？首先看最常见的三种（[ref](https://www.beyondlogic.org/usbnutshell/usb4.shtml）：</p>
<ol>
<li>Control Transfer</li>
<li>第一种是 Control IN，一共有三个阶段，第一个阶段是 Setup，Host 发送给 Device 一个八字节的 Setup Packet；第二个阶段是 Data，Device 发送给 Host 一段数据；第三个阶段是 Status，Host 发送给 Device 一个 Zero Length Packet。此时 Setup Packet 对应 urb 中的 setup，Data 就对应 RET_SUBMIT 里面的 URB data 了，自然 CMD_SUBMIT 中是没有 URB data 的</li>
<li>第二种是 Control OUT，一共有三个阶段，第一个阶段是 Setup，Host 发送给 Device 一个吧字节的 Setup Packet；第二个阶段是 Data，Host 给 Device 发送一段数据；第三个阶段是 Status，Device 给 Host 发送一个 Zero Length Packet。此时 Setup Packet 对应 urb 中的 setup，Data 对应 CMD_SUBMIT 末尾的 URB data，长度由 transfer_buffer_length 指定。返回的 RET_SUBMIT 不带 URB data，但依然需要有 RET_SUBMIT。</li>
<li>Interrupt/Bulk Transfer</li>
<li>第一种是 Interrupt/Bulk IN，由 Device 给 Host 发送一段数据，附在 RET_SUBMIT 中。</li>
<li>第二种是 Interrupt/Bulk OUT，由 Host 给 Device 发送一段数据，中 CMD_SUBMIT 的 URB data 中。返回的 RET_SUBMIT 不带 URB data，但不能不发 RET_SUBMIT。</li>
</ol>
<p>可见，Interrupt 和 Bulk 是比较简单的，而 Control 和 Isochronous（没有提到）则比较复杂。</p>
<h3 id="回到-usbip-协议"><a class="toclink" href="../../software/2020/05/15/usb-ip-simulation/#回到-usbip-协议">回到 USB/IP 协议</a></h3>
<p>其实补充了这些信息以后，就可以实现一个 USB/IP 协议的服务器了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-10 00:00:00+00:00">2020年5月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="mifare-classic-上配置-ndef"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/">MIFARE Classic 上配置 NDEF</a></h2>
<h3 id="背景"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#背景">背景</a></h3>
<p>最近买了一堆 NFC 的智能卡拿来测试，其中一张 MIFARE Classic 的总是在 iOS 上读不出来，无论是以 Tag 模式还是 NDEF 模式。于是通过一系列的研究，终于知道上怎么一回事，然后成功地把一个 MIFARE Classic 卡配置成了 NDEF。</p>
<h3 id="背景知识"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#背景知识">背景知识</a></h3>
<p>NFC 有很多协议，其中 MIFARE Classic 基于 ISO 14443-3 Type A 标准，里面有一些 MIFARE 的命令。通过这些命令，就可以控制 MIFARE Classic 卡的内容。具体来说，以我使用的 <a href="https://www.nxp.com/docs/en/data-sheet/MF1S70YYX_V1.pdf">MIFARE Classic EV1 4K S70</a> 为例，这篇文章会涉及到如下的背景知识：</p>
<h4 id="mifare-classic-内存布局"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#mifare-classic-内存布局">MIFARE Classic 内存布局</a></h4>
<p>在 MIFARE Classic 中，有 Sector 和 Block 的概念，每个 Sector 有若干个 Block，其中最后一个 Block 是特殊的（称为 Sector Trailer），保存了这个 Sector 的一些信息：Key A、Access Bits、GPB 和 Key B。对于 Classic 4K，首先是 32 个有 4 blocks 的 sector，然后是 8 个 有 16 blocks 的 sector，整体的内存布局大概是：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Sector 0:
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    Block 0
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    Block 1
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    Block 2
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    Block 3(Sector Trailer)
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>Sector 1:
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    Block 4
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    Block 5
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    Block 6
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    Block 7(Sector Trailer)
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>...
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>Sector 32:
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    Block 128
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    Block 129
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    ...
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    Block 143(Sector Trailer)
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>...
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>Sector 39:
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    ...
</span></code></pre></div>
<p>每个 Block 有 16 字节，一共 256 个 block，所以是 4K 大小的存储空间。Block 0 比较特殊，保存的是生产商写入的信息，不可更改。</p>
<p>Sector Trailer 的布局如下：</p>
<table>
<thead>
<tr>
<th>Key A</th>
<th>Access Bits</th>
<th>GPB</th>
<th>Key B</th>
</tr>
</thead>
<tbody>
<tr>
<td>6 字节</td>
<td>3 字节</td>
<td>1 字节</td>
<td>6 字节</td>
</tr>
</tbody>
</table>
<p>其中 Key A 和 Key B 上用于当前 Sector 认证的两个 Key，用相应的 Key 认证以后就可以修改 Sector 里面 Block 的内容。既然有 Key，就会有细粒度的权限控制，就是 Access Bits。它的计算方式比较复杂，首先举个文档<a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305</a>出现过的例子 <code>0x7F 0x07 0x88</code>：</p>
<ol>
<li>按字节翻转：0x88 0x07 0x7F</li>
<li>改写成二进制：1000 1000 0000 0111 0111 1111</li>
<li>拆成前半部分：1000 1000 0000 和后半部分：0111 0111 1111</li>
<li>如果前后部分互补，说明这是个合法的 Access Bits（这种取反拼接做校验的方法挺常见的）</li>
<li>取出前半部分：1000 1000 0000</li>
<li>从后往前取三个字节的最高位：011</li>
<li>从后往前取第三个字节的次高位，依此类推：000 000 000</li>
</ol>
<p>这里的 011 表示的是 Sector Trailer 的访问权限，特别地，它表示，不能读出 Key A，只能用 Key B 认证后修改 Key A；用 Key A 或者 Key B 认证后都可以读 Access Bits，但只能在 Key B 认证后修改 Access Bits；不能读出 Key B，只能用 Key B 认证后修改 Key B。也就是说，Key A 认证只能读 Access Bits，而 Key B 认证有权限写入 Key A、Access Bits 和 Key B 字段。完整表格见<a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305 Table 7</a> 。</p>
<p>之后的三个 000 分别对应前三个 Blocks（又称 Data Blocks，先只考虑带 4 Blocks 的 Sector）的访问权限。000 表示的是，用 Key A 和 Key B 都有完整的读写权限。完整的表格见 <a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN 1305 Table 8</a> 。</p>
<p>这里可以给读者留一个练习：0x78 0x77 0x88 对应的权限上什么？</p>
<p>答案：对 Sector Trailer：011；对 Data Blocks：100；此时 Data Blocks 可以用 Key A 或者 Key B 认证读取，但只能用 Key B 认证写入。</p>
<p>如果查看完整的表格就可以发现，Key B 的权限一般是比 Key A 大的，所以 Key B 一般是保密的，而 Key A 可以是公开的。</p>
<h4 id="mifare-命令"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#mifare-命令">MIFARE 命令</a></h4>
<p>为了向 MIFARE Classic 卡发送命令，首先需要一个 ISO 14443-3 Type A 的接口，Android 的 NfcA 或者 libnfc 都提供了接口。这里发送的命令实际上会再经过一层解析、用 CRYPTO1 算法加密（猜测是读卡器做的？不是很确定），不过对应用程序来说是透明的。可以参考 <a href="https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf">MIFARE Classic EV1 1K</a> 和 <a href="https://link.springer.com/chapter/10.1007/978-3-540-85893-5_20">A Practical Attack on the MIFARE Classic</a> 中的描述。</p>
<h5 id="mifare-read"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#mifare-read">MIFARE Read</a></h5>
<p>读出一个 Block 的内容，每个 Block 有 16 字节。命令格式如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>30 XX
</span></code></pre></div>
<p>如果要读第一个 Block，就是 <code>30 00</code>，如果要读第二个 Block，就是 <code>30 01</code> 。</p>
<p>返回的数据里刚好是 16 个字节。</p>
<h5 id="mifare-write"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#mifare-write">MIFARE Write</a></h5>
<p>向一个 Block 写入数据，命令格式如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>A0 XX YY YY YY YY YY YY YY YY YY YY YY YY YY YY YY YY
</span></code></pre></div>
<p>这里的 XX 和上面一样，也是 Block 地址；之后是十六字节的数据。</p>
<h5 id="mifare-authentiate-with-ab"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#mifare-authentiate-with-ab">MIFARE Authentiate with A/B</a></h5>
<p>注：这里和 S70 datasheet 里写的不完全一样。</p>
<p>这个命令会进行 Key A 或者 Key B 的认证，如果是对 Key A 认证：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>60 XX YY YY YY YY ZZ ZZ ZZ ZZ ZZ ZZ
</span></code></pre></div>
<p>这里的 XX 也是 Block 地址，但实际上认证的粒度上 Sector，所以只要认证了 Sector 里面的一个 Block，其他 Block 也是同时认证，也是用同一个 Sector Trailer 中的信息进行认证。YY 则是 ISO 14443-3 Type A 中的 UID，如果用 Android 的 API 读取，就可以在 NfcA 中找到这个四字节的信息。ZZ 就是要认证的密钥，六个字节。</p>
<p>如果是对 Key B 认证，把第一个字节的 0x60 改成 0x61 即可。</p>
<p>认证成功后，返回一个 0x00；如果认证失败，则会断开 NFC。</p>
<h4 id="ndef-是什么"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#ndef-是什么">NDEF 是什么</a></h4>
<p>NDEF 实际上是比较高层次的数据，就像 HTML，表示了一个格式化的数组数据，数组的元素可能是文本、URI 等等。它是由若干个 Record 组成的。一个 Record 如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>03 0B 01 07 54 02 65 6E 61 62 63 64
</span></code></pre></div>
<p>首先是一个 03 表示类型，然后是长度 0x0B（11，从下一个字节开始数），接着是 0x01 0x07 表示这似乎一个 Well Known 类型的 Record，内容的长度为 7，0x54（ASCII T）表示这是文本格式，0x02 表示编码是 UTF-8，0x65 0x6E (ASCII "en") 表示语言是英语，之后的 0x61 0x62 0x63 0x64（ASCII "abcd"）就是文本内容。</p>
<p>很多个 record 连起来，最终一个 0xFE 表示结束，这就是完整的 NDEF 信息了。</p>
<h4 id="在-mifare-classic-上使用-ndef"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#在-mifare-classic-上使用-ndef">在 MIFARE Classic 上使用 NDEF</a></h4>
<p>NDEF 只定义了数据格式，但为了实际使用，还得看具体情况。就好像文件内容保存在硬盘上的时候，并不是直接保存，而是通过文件系统，人为定义一个路径，这样大家才知道要从 /etc/shadow 文件去读 Linux 的用户密码信息，NDEF 也需要人为定义一些规则，再作为数据存放在智能卡里的某个地方，这样大家去读取 metadata，发现上 NDEF Tag，然后才会去解析 NDEF 信息。</p>
<p>有些时候，这个定义很简单，比如直接把 NDEF 数据放在某个 block 里面；有的时候又很复杂，因为可能同时存在很多应用，NDEF 只是其中的一种，所以要有一种类似目录的东西去索引 NDEF“文件”。</p>
<p>MIFARE Classic 上采用的方法上，在特定的 Sector（比如 Sector 0）放一些元数据，元数据里注明了其他的 Sector（从 1 开始的其它 sector）分别用于什么用途，然后 NDEF 是其中一种用途。这个结构叫做 <a href="https://www.nxp.com/docs/en/application-note/AN10787.pdf">MIFARE Application Directory</a>。具体来说，在 MIFARE Classic 里面，它规定 Block 1 和 Block 2 的内容如下：</p>
<table>
<thead>
<tr>
<th>0-1</th>
<th>2-3</th>
<th>4-5</th>
<th>6-7</th>
<th>8-9</th>
<th>10-11</th>
<th>12-13</th>
<th>14-15</th>
</tr>
</thead>
<tbody>
<tr>
<td>Info &amp; CRC</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
</tr>
<tr>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
<td>AID</td>
</tr>
</tbody>
</table>
<p>第一个字节是 CRC 8，它的定义可以在<a href="http://reveng.sourceforge.net/crc-catalogue/1-15.htm">这里的 CRC-8/MIFARE-MAD</a> 里找到：初始值 0xC7，多项式上 0x1D。参与 CRC 计算的是按顺序从第二个字节开始的 31 个字节。</p>
<p>第二个字节是 Info Byte，用处不大，见 MAD 的文档。</p>
<p>之后每两个字节对应一个 Sector 的 AID（Application ID），比如 Block 1 的 2-3 字节对应 Sector 1 的 AID，Block 1 的 4-5 字节对应 Sector 2 的 AID，最后 Block 2 的 14-15 字节对应 Sector 15 的 AID。NDEF 的 AID 就是 0x03 0xE1。当软件发现这里的 AID 是 0x03E1 的时候，它就会去相应的 Sector 去读取 NDEF 信息。</p>
<p>一个用 TagInfo 读出来的例子如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Sector 0 (0x00)
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>[skipped]
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>[01]  F3 01 03 E1 03 E1 00 00
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a> rW-  00 00 00 00 00 00 00 00
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>[02]  00 00 00 00 00 00 00 00
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a> rW-  00 00 00 00 00 00 00 00
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>[03]  A0:A1:A2:A3:A4:A5  MAD access key
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a> WXW  78:77:88 C1
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>      XX:XX:XX:XX:XX:XX  (key unavailable)
</span></code></pre></div>
<p>可以看到，这里表示的是 Sector 1 和 Sector 2 是 03E1 NDEF。下面 [03] 行表示的是 Key A，下一行是 Access bits、GPD，最后一行是 Key B。TagInfo 会尝试从 well known 里的 Key A 和 Key B 一个个试，直到认证成功为止。常见的如下：</p>
<ol>
<li>A0 A1 A2 A3 A4 A5：MAD 的 Key A</li>
<li>D3 F7 D3 F7 D3 F7：NDEF 的 Key A</li>
<li>FF FF FF FF FF FF：出场默认的 Key A 和 Key B</li>
</ol>
<h3 id="如何在-mifare-classic-上配置-ndef"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#如何在-mifare-classic-上配置-ndef">如何在 MIFARE Classic 上配置 NDEF</a></h3>
<p>如果看了这么多背景知识，你还有心情看到这里，那要给个掌声。</p>
<p>为什么要在 MIFARE Classic 上配置 NDEF 呢？因为直接买到的 MIFARE Classic（比如我用的 EV1 4K S70）里面都是出厂状态，Key A 和 Key B 都是 FF FF FF FF FF FF，除了 Block 0 以外数据都是 0，所以它并不能用作 NDEF，Android 也只是认为它 NdefFormattable。所以我们要做的就是，Format as NDEF。为啥要自己搞呢，也是因为试了几个现成的工具 format 都失败了。</p>
<p>其实整个流程在 <a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305</a> 的 8.1 章节都写了，但看起来简单，实现起来还是有很多细节，在搞的时候也是来来回回做了很多尝试，同时也利用 TagInfo 强大的 Memory dump 配合调试。</p>
<p>首先复习一下我们可以用哪些命令：</p>
<ol>
<li>MIFARE Authenticate：对一个 sector 认证，认证成功了才能写操作</li>
<li>MIFARE Read：读取一个 Block</li>
<li>MIFARE Write：写入一个 Block</li>
</ol>
<p>仔细观察 <a href="https://www.nxp.com/docs/en/application-note/AN1305.pdf">AN1305</a> 的 Fig.10 和下面的文本描述，大概需要做这些事情：</p>
<ol>
<li>修改 Block 1 和 Block 2 中的信息，符合 MAD 的格式</li>
<li>修改 Sector 0 的 Sector Trailer</li>
<li>修改 Block 4，填入一个空白的 NDEF，或者直接前面背景知识里的例子。</li>
<li>修改 Sector 1 和 Sector 2 的 Sector Trailer</li>
</ol>
<p>但有一些细节：</p>
<ol>
<li>修改 Sector Trailer 的时候要谨慎，因为会修改 Key，如果改完又忘了，这卡就废了</li>
<li>注意用 Key A 还是 Key B 进行认证。上面这些流程结束后，Sector 0 被保护了，需要用 Key B 才能修改数据；而 Sector 1 和 Sector 2 是开放的；如果执行完第一步和第二步以后，发现第一步写错了，就要注意权限的问题，必要时还可以先修改 Access bits 再修改数据</li>
<li>在这里为了简单，Key B 都用 FF FF FF FF FF FF 了，实际情况下可以用别的自己的密钥，只要记住就行</li>
</ol>
<p>那么，按照前面的这些知识，就可以构造出每一步的 MIFARE 命令了：</p>
<p><strong>注意：下面的命令不一定能工作，在执行前请仔细理解每条命令的结果，本文作者对卡的损失概不负责</strong></p>
<p>第一步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>60 00 YY YY YY YY FF FF FF FF FF FF
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>A0 01 F3 01 03 E1 03 E1 00 00 00 00 00 00 00 00 00 00
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>A0 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span></code></pre></div>
<p>注意 YY 要填入 ID。这一步首先用 FF FF FF FF FF FF 认证了 Sector 0 的 Key A，然后写入了 Block 1 和 Block 2。Info Byte 用的是 0x01，然后用在线工具计算了一下 CRC=F3。</p>
<p>第二步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>A0 03 A0 A1 A2 A3 A4 A5 78 77 88 C1 FF FF FF FF FF FF
</span></code></pre></div>
<p>这一步设置了 Key A 为 MAD access key，权限是 78 77 88，GPB 是 C1，Key B 为 FF FF FF FF FF FF</p>
<p>第三步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>60 04 YY YY YY YY FF FF FF FF FF FF
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>A0 04 00 00 03 0B D1 01 07 54 02 65 6E 61 62 63 64 FE
</span></code></pre></div>
<p>这一步认证了 Sector 1，然后往 Block 4 写入了一个 abcd 的 NDEF 记录。</p>
<p>第四步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>A0 07 D3 F7 D3 F7 D3 F7 7F 07 88 40 FF FF FF FF FF FF
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>60 08 YY YY YY YY FF FF FF FF FF FF
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>A0 0B D3 F7 D3 F7 D3 F7 7F 07 88 40 FF FF FF FF FF FF
</span></code></pre></div>
<p>写入了 Sector 1 的 Sector Trailer，然后认证 Sector 2，再写入 Sector 2 的 Sector Trailer</p>
<p>这样就完成了，再用 TagInfo 等软件，就可以读取出来 NDEF 信息了。此时 iOS 也可以读出来。</p>
<p>上面这些过程，在实际情况下在不同 sector 的时候需要打断，每次重新认证一下。这里默认了一些卡的初始密钥，如果初始情况并不一致，可能并不会工作。</p>
<h3 id="踩的坑"><a class="toclink" href="../../hardware/2020/05/10/mifare-classic-ndef/#踩的坑">踩的坑</a></h3>
<p>在这个过程中踩过很多的坑：</p>
<ol>
<li>在空 NDEF 的时候，NFC Tools 能读出来是 Ndef，并且内容是空，但写入的时候表示 Write error，也读不出来；去 TagInfo 读内存，发现确实写进去了，但内容不对，有一个位置的长度写成了 0，可能是 BUG</li>
<li>上面也提到过的，就是在修改为只读以后，发现数据写错了，只好重新改成可写，把数据改好了以后再设为只读。</li>
<li>iOS 上用 NFCNDEFReaderSession 可以读出来这个 NDEF 的内容，但 NFCTagReaderSession 并不能 poll 出来。</li>
</ol>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-01 00:00:00+00:00">2020年5月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/others/" class="md-meta__link">others</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="解释-bb84-协议"><a class="toclink" href="../../others/2020/05/01/bb84-explained/">解释 BB84 协议</a></h2>
<h3 id="背景"><a class="toclink" href="../../others/2020/05/01/bb84-explained/#背景">背景</a></h3>
<p>这周密码学课程，来自 BUPT 的高飞老师讲了一下 qkd 里的 BB84 协议，老师讲得很好，我也想记录一下这个协议的流程和方法。我不是这方面的专业人士，如果有什么问题请指出。</p>
<h3 id="背景知识"><a class="toclink" href="../../others/2020/05/01/bb84-explained/#背景知识">背景知识</a></h3>
<p>QKD（Quantum Key Distribution）目的是让通信双方获得同一个密钥，它需要同时需要量子信道和经典信道。其中经典信道被认为是可信的，它可以被监听，但不能被中间人攻击。</p>
<p>在 BB84（Charles H. Bennett and Gilles Brassard (1984)）协议中，传输的是一个光子，它具有如下的特性：</p>
<p>可以用两个基去测量光子：➕️和✖️️，然后光子有四个偏振角度，分别是 ⬆️️ ⬇️️ ↘️️ ↗️️。定义一个二进制位和偏振角度的对应关系如下：</p>
<table>
<thead>
<tr>
<th>位</th>
<th>0</th>
<th>1</th>
<th>0</th>
<th>1</th>
</tr>
</thead>
<tbody>
<tr>
<td>基</td>
<td>➕️</td>
<td>➕️</td>
<td>✖️️</td>
<td>✖️️</td>
</tr>
<tr>
<td>偏振角度</td>
<td>⬆️️</td>
<td>⬇️️</td>
<td>↗️️</td>
<td>↘️️</td>
</tr>
</tbody>
</table>
<p>对于一个未知光子，可以用两种基进行测量，测量的结果：</p>
<table>
<thead>
<tr>
<th>偏振角度</th>
<th>⬆️️</th>
<th>⬇️️</th>
<th>↗️️</th>
<th>↘️️</th>
</tr>
</thead>
<tbody>
<tr>
<td>用➕️测量</td>
<td>0</td>
<td>1</td>
<td>0/1</td>
<td>0/1</td>
</tr>
<tr>
<td>用✖️️测量</td>
<td>0/1</td>
<td>0/1</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>这里的 <code>0/1</code> 表示有 50% 概率测得 0，有 50% 概率测得 1。</p>
<h3 id="协议流程"><a class="toclink" href="../../others/2020/05/01/bb84-explained/#协议流程">协议流程</a></h3>
<p>假如 Alice 要和 Bob 进行 BB84 协议。那么，Alice 首先随机生成一段二进制序列，并随机生成一个基的序列，以 Wikipedia 上的例子为例：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Alice's random bit</th>
<th>0</th>
<th>1</th>
<th>1</th>
<th>0</th>
<th>1</th>
<th>0</th>
<th>0</th>
<th>1</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Alice's random sending basis</td>
<td>➕️</td>
<td>➕️</td>
<td>✖️️</td>
<td>➕️</td>
<td>✖️️</td>
<td>✖️️</td>
<td>✖️️</td>
<td>➕️</td>
</tr>
<tr>
<td style="text-align: center;">Photon polarization Alice sends</td>
<td>⬆️️</td>
<td>➡️️</td>
<td>↘️️</td>
<td>⬆️️</td>
<td>↘️️</td>
<td>↗️️</td>
<td>↗️️</td>
<td>➡️️</td>
</tr>
<tr>
<td style="text-align: center;">Bob 生成随机的基</td>
<td>➕️</td>
<td>✖️️</td>
<td>✖️️</td>
<td>✖️️</td>
<td>➕️</td>
<td>✖️️</td>
<td>➕️</td>
<td>➕️</td>
</tr>
<tr>
<td style="text-align: center;">Photon polarization Bob measures</td>
<td>⬆️️</td>
<td>↗️️</td>
<td>↘️️</td>
<td>↗️️</td>
<td>➡️️</td>
<td>↗️️</td>
<td>➡️️</td>
<td>➡️️</td>
</tr>
<tr>
<td style="text-align: center;">Bob 认为的二进制信息</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td style="text-align: center;">通过经典信道交换信息</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: center;">Shared secret key</td>
<td>0</td>
<td>丢弃</td>
<td>1</td>
<td>丢弃</td>
<td>丢弃</td>
<td>0</td>
<td>丢弃</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>第一步，Alice 生成随机的二进制和随机的基，按照前面谈到过的对应关系，生成带有偏振角度的光子发给 Bob。</p>
<p>第二步，由于 Bob 只收到光子，不知道 Alice 选取的基底信息，而且只能用一个基测量一次，所以 Bob 随机从两种基选择一个来测量，得到了一串二进制。这些二进制里，如果 Alice 和 Bob 选取了同一个基，那么这一位的数据一定是对的；如果选取了不同的基，那么这一位有一半的可能是对的。总的来说，期望有四分之一的位是不正确的。</p>
<p>第三步，Alice 和 Bob 在 <strong>可信</strong> 的经典信道中把双方的基底进行对比，把基底相等的部分对应的二进制位提取出来，作为最终使用的密钥。</p>
<p>第四步，Alice 和 Bob 在最终使用的密钥中抽取若干位，然后对比，如果这些位都一致，则这个密码是有效的。如果错误率太高，那么很大概率是被攻击了。</p>
<h3 id="安全性"><a class="toclink" href="../../others/2020/05/01/bb84-explained/#安全性">安全性</a></h3>
<p>协议的安全性，主要是靠量子的特性：未知量子态不可克隆、对未知量子态的测量可能会改变量子态。</p>
<p>假如在量子信道中间有一个 Eve 想要做坏事，它如果在中间观测了一下光子，它就会影响光子的量子态，导致 Bob 的密钥和 Alice 密钥会不一致，从而在协议的第四步被发现。并且，因为 Eve 并不知道 Alice 所使用的基底（假设 Eve 只能控制量子信道、不能控制经典信道），所以得到的二进制数据也有四分之一是不正确的。即使 Eve 尝试截获并且重发光子给 Bob，Bob 得到的密钥仍然有很高的错误率。通过这个错误率，就可以判断是否被攻击了。</p>
<p>另外，它的安全性还依赖以下几个方面：</p>
<ol>
<li>Eve 不能控制 Alice 和 Bob 的量子密码设备</li>
<li>Alice 和 Bob 的随机数生成器需要足够安全</li>
<li>经典信道是可信的</li>
</ol>
<h3 id="引用"><a class="toclink" href="../../others/2020/05/01/bb84-explained/#引用">引用</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Quantum_key_distribution#BB84_protocol:_Charles_H._Bennett_and_Gilles_Brassard_(1984)">Quantum key distribution - Wikipedia</a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-22 00:00:00+00:00">2020年4月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-k8s-中部署-code-server"><a class="toclink" href="../../devops/2020/04/22/k8s-code-server/">在 k8s 中部署 code-server</a></h2>
<p>实验了一下在 k8s 中部署 <a href="https://github.com/cdr/code-server">code-server</a>，并不复杂，和之前几篇博客的配置是类似的：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code-volume</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">              </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code-pvc</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-init</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;chown</span><span class="nv"> </span><span class="s">-R</span><span class="nv"> </span><span class="s">1000:1000</span><span class="nv"> </span><span class="s">/home/coder&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/home/coder&quot;</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code-volume</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codercom/code-server:latest</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/home/coder&quot;</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code-volume</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.5&quot;</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500Mi&quot;</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PASSWORD</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="nn">---</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="nn">---</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1beta1</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress-code</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nginx&quot;</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;letsencrypt-prod&quot;</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a><span class="w">    </span><span class="nt">nginx.org/websocket-services</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;code&quot;</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example.com</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code-tls</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example.com</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a><span class="w">    </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code</span>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a><span class="nn">---</span>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-0-84"><a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-85"><a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code-pvc</span>
</span><span id="__span-0-86"><a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-87"><a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-0-88"><a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-0-89"><a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-0-90"><a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-0-91"><a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-0-92"><a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span></code></pre></div>
<p>需要注意的几个点：</p>
<ol>
<li>用了一个 pvc 用于 /home/coder 的持久化，所以你的集群里得有相应的 pv/storage class</li>
<li>我用的是 Nginx Inc. 的 ingress controller，它的 websocket 支持需要一句 nginx.org/websocket-services 设置</li>
<li>额外添加了一个 init container，为了处理 home 目录的权限</li>
</ol>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-21 00:00:00+00:00">2020年4月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-k8s-中部署-drone-用于-ci"><a class="toclink" href="../../devops/2020/04/21/k8s-drone-ci/">在 k8s 中部署 Drone 用于 CI</a></h2>
<p>实验了一下在 k8s 中部署 CI，在 drone gitlab-ci 和 jenkins 三者中选择了 drone，因为它比较轻量，并且基于 docker，可以用 GitHub 上的仓库，比较方便。</p>
<p>首先，配置 helm：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>drone<span class="w"> </span>https://charts.drone.io
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>kubectl<span class="w"> </span>create<span class="w"> </span>ns<span class="w"> </span>drone
</span></code></pre></div>
<p>参考 drone 的文档，编写 drone-values.yml:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nt">ingress</span><span class="p">:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nginx&quot;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;letsencrypt-prod&quot;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drone.example.com</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drone.example.com</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drone-tls</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">  </span><span class="nt">DRONE_SERVER_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drone.example.com</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">  </span><span class="nt">DRONE_SERVER_PROTO</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">  </span><span class="nt">DRONE_USER_CREATE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username:YOUR_GITHUB_USERNAME,admin:true</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">  </span><span class="nt">DRONE_USER_FILTER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">YOUR_GITHUB_USERNAME</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">  </span><span class="nt">DRONE_RPC_SECRET</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">  </span><span class="nt">DRONE_GITHUB_CLIENT_ID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">  </span><span class="nt">DRONE_GITHUB_CLIENT_SECRET</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span></code></pre></div>
<p>需要首先去 GitHub 上配置 OAuth application，具体参考 drone 的文档。然后，生成一个 secret，设置 admin 用户并只允许 admin 用户使用 drone，防止其他人使用。然后应用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span>drone<span class="w"> </span>drone<span class="w"> </span>drone/drone<span class="w"> </span>-f<span class="w"> </span>drone-values.yml
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1"># or, to upgrade</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>--namespace<span class="w"> </span>drone<span class="w"> </span>drone<span class="w"> </span>drone/drone<span class="w"> </span>--values<span class="w"> </span>drone-values.yml<span class="w"> </span>
</span></code></pre></div>
<p>然后就可以访问上面配好的域名了。遇到了 cert manager 最近的一个 bug，来回折腾几次就好了。</p>
<p>接着配 drone 的 k8s runnner，也是参考 drone 的文档，编写 drone-runner-kube-values.yml：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>rbac:
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>  buildNamespaces:
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    - drone
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>env:
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>  DRONE_RPC_SECRET: REDACTED
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>  DRONE_NAMESPACE_DEFAULT: drone
</span></code></pre></div>
<p>然后应用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span>drone<span class="w"> </span>drone-runner-kube<span class="w"> </span>drone/drone-runner-kube<span class="w"> </span>-f<span class="w"> </span>drone-runner-kube-values.yml
</span></code></pre></div>
<p>然后就可以去 drone 界面上操作了。</p>
<p>需要注意的是，drone 需要 pv，所以我先在腾讯云里面配置了 CFS 的 storage class，然后它就会自动 provision 一个新的 pv 和 pvc 出来。</p>
<p>接着尝试了一下在 drone 里面构建 docker 镜像并且 push 到 registry 上。以腾讯云为例：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>kind: pipeline
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>type: kubernetes
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>name: default
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>steps:
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>- name: build
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>  image: alpine
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>  commands:
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>  - make
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>- name: publish
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>  image: plugins/docker
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>  settings:
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    registry: ccr.ccs.tencentyun.com
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    repo: ccr.ccs.tencentyun.com/abc/def
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    tags: [&quot;${DRONE_COMMIT_SHA:0:7}&quot;,&quot;latest&quot;]
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    username:
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>      from_secret: docker_username
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    password:
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>      from_secret: docker_password
</span></code></pre></div>
<p>然后在网页里配置好 docker username 和 password，它就会自动构建 docker 镜像并且 push 到 registry 上，然后再 rollout 一下 deployment 就能部署最新的 image 了。实际上可以在 drone 里面把部署这一步也完成，但目前还没有去实践。</p>
<p>参考文档：</p>
<p><a href="https://docs.drone.io/server/provider/github/">Drone provider: GitHub</a></p>
<p><a href="https://github.com/drone/charts/blob/master/charts/drone/docs/install.md">Drone helm chart</a></p>
<p><a href="https://github.com/drone/charts/blob/master/charts/drone-runner-kube/docs/install.md">Drone runner kube helm chat</a></p>
<p><a href="https://www.magalix.com/blog/building-a-cd-pipeline-with-drone-ci-and-kubernetes">Building a CD pipeline with drone CI and kubernetes</a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-17 00:00:00+00:00">2020年4月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-k8s-内用-cert-manager-配合-nginx-ingress-controller-配置-lets-encrypt-https-证书"><a class="toclink" href="../../devops/2020/04/17/k8s-nginx-cert-manager-le/">在 k8s 内用 Cert Manager 配合 Nginx Ingress Controller 配置 Let's Encrypt HTTPS 证书</a></h2>
<p>上一篇博客讲了 nginx ingress 的配置，那自然第一步要配上 https。首先配置 cert-manager：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>cert-manager
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--validate<span class="o">=</span><span class="nb">false</span><span class="w"> </span>-f<span class="w"> </span>https://github.com/jetstack/cert-manager/releases/download/v0.14.1/cert-manager.crds.yaml
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>$<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>jetstack<span class="w"> </span>https://charts.jetstack.io
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>$<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>update
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>$<span class="w"> </span>helm<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span>cert-manager<span class="w"> </span>jetstack/cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span>--namespace<span class="w"> </span>cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span>--version<span class="w"> </span>v0.14.1
</span></code></pre></div>
<p>然后，配置 Cluster Issuer，应用以下的 yaml：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>apiVersion: cert-manager.io/v1alpha2
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>kind: ClusterIssuer
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>metadata:
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>  name: letsencrypt-prod
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>  namespace: cert-manager
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>spec:
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>  acme:
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    email: example@example.com
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    server: https://acme-v02.api.letsencrypt.org/directory
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    privateKeySecretRef:
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>      name: letsencrypt-prod
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    solvers:
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    - http01:
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        ingress:
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>          class: nginx
</span></code></pre></div>
<p>然后在 ingress 里面进行配置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>apiVersion: networking.k8s.io/v1beta1
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>kind: Ingress
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>metadata:
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>  name: ingress-example
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>  annotations:
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    kubernetes.io/ingress.class: &quot;nginx&quot;
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    cert-manager.io/cluster-issuer: &quot;letsencrypt-prod&quot;
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>spec:
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>  tls:
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>  - hosts:
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    - example.com
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    secretName: example-tls
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>  rules:
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>  - host: example.com
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    http:
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>      paths:
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>      - path: /
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        backend:
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>          serviceName: example-service
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>          servicePort: 80
</span></code></pre></div>
<p>应用以后，用 <code>kubectl describe certificate</code> 查看证书获取进度。成功后，访问改域名的 HTTP，就会自动跳转到 HTTPS，并且提供了正确的证书。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-17 00:00:00+00:00">2020年4月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-tke-上配置不使用-lb-的-nginx-ingress-controller"><a class="toclink" href="../../devops/2020/04/17/tke-nginx-ingress-without-lb/">在 TKE 上配置不使用 LB 的 Nginx Ingress Controller</a></h2>
<h3 id="背景"><a class="toclink" href="../../devops/2020/04/17/tke-nginx-ingress-without-lb/#背景">背景</a></h3>
<p>想要在 k8s 里面 host 一个网站，但又不想额外花钱用 LB，想直接用节点的 IP。</p>
<h3 id="方法"><a class="toclink" href="../../devops/2020/04/17/tke-nginx-ingress-without-lb/#方法">方法</a></h3>
<p>首先安装 nginx-ingress：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>nginx-stable<span class="w"> </span>https://helm.nginx.com/stable
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>$<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>update
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>$<span class="w"> </span>helm<span class="w"> </span>install<span class="w"> </span>ingress-controller<span class="w"> </span>nginx-stable/nginx-ingress<span class="w"> </span>--set<span class="w"> </span>controller.service.type<span class="o">=</span>NodePort<span class="w"> </span>--set<span class="w"> </span>controller.hostNetwork<span class="o">=</span><span class="nb">true</span>
</span></code></pre></div>
<p>这里给 ingress controller chart 传了两个参数：第一个指定 service 类型是 NodePort，替代默认的 LoadBalancer；第二个指定 ingress controller 直接在节点上监听，这样就可以用节点的公网 IP 访问了。</p>
<p>然后配一个 ingress：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>apiVersion: networking.k8s.io/v1beta1
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>kind: Ingress
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>metadata:
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>  name: ingress-example
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>  annotations:
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    kubernetes.io/ingress.class: &quot;nginx&quot;
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>spec:
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>  rules:
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>  - host: example.com
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    http:
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>      paths:
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>      - path: /
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        backend:
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>          serviceName: example-service
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>          servicePort: 80
</span></code></pre></div>
<p>然后就可以发现请求被正确路由到 example-service 的 80 端口了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-13 00:00:00+00:00">2020年4月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-sbt-中-fork-并且并行运行测试"><a class="toclink" href="../../software/2020/04/13/sbt-fork-parallel-test/">在 sbt 中 fork 并且并行运行测试</a></h2>
<h3 id="问题"><a class="toclink" href="../../software/2020/04/13/sbt-fork-parallel-test/#问题">问题</a></h3>
<p>最近在 sbt 使用遇到一个问题，有两个测试，分别用 testOnly 测试的时候没有问题，如果同时测试就会出问题，应该是全局的状态上出现了冲突。一个自然的解决思路是 fork，但是 sbt 默认 fork 之后 test 是顺序执行的，这会很慢。所以搜索了一下，找到了 fork 并且并行测试的方法。</p>
<h3 id="解决方法"><a class="toclink" href="../../software/2020/04/13/sbt-fork-parallel-test/#解决方法">解决方法</a></h3>
<p>解决方法在 sbt 文档中其实就有（<a href="https://www.scala-sbt.org/release/docs/Testing.html#Forking+testsl">原文</a>）。简单来说就是：把每个 test 放到单独的 TestGroup 中，每个 TestGroup 分别用一个 forked JVM 去运行；然后让 sbt 的并行限制设高一些：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">// move each test into a group and fork them to avoid race condition</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="nc">Tests</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">singleTests</span><span class="p">(</span><span class="n">tests</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">TestDefinition</span><span class="p">])</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="n">tests</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">Group</span><span class="p">(</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">      </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">      </span><span class="n">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="n">test</span><span class="p">),</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">      </span><span class="nc">SubProcess</span><span class="p">(</span><span class="nc">ForkOptions</span><span class="p">()))</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">testGrouping</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">singleTests</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">definedTests</span><span class="p">).</span><span class="n">value</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1">// allow multiple concurrent tests</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="n">concurrentRestrictions</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Global</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">Tags</span><span class="p">.</span><span class="n">limitAll</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></code></pre></div>
<p>这样就可以了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-04 00:00:00+00:00">2020年4月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在命令行中进行-vivado-仿真"><a class="toclink" href="../../hardware/2020/04/04/vivado-simulation-command/">在命令行中进行 Vivado 仿真</a></h2>
<h3 id="已有-vivado-项目"><a class="toclink" href="../../hardware/2020/04/04/vivado-simulation-command/#已有-vivado-项目">已有 Vivado 项目</a></h3>
<p>想要在命令行里进行 Vivado 仿真，所以查了下 Xilinx 的 UG900 文档，找到了命令行仿真的方法。首先是生成仿真所需的文件：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c"># assuming batch mode</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nv">open_project</span><span class="w"> </span>xxx.xpr
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nv">set_property</span><span class="w"> </span>top<span class="w"> </span>YOUR_SIM_TOP<span class="w"> </span><span class="k">[</span><span class="nv">current_fileset</span><span class="w"> </span><span class="o">-</span>simset<span class="k">]</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nv">export_ip_user_files</span><span class="w"> </span><span class="o">-</span>no_script<span class="w"> </span><span class="o">-</span>force
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nv">export_simulation</span><span class="w"> </span><span class="o">-</span>simulator<span class="w"> </span>xsim<span class="w"> </span><span class="o">-</span>force
</span></code></pre></div>
<p>可以把这些语句放到 tcl 文件里然后用 batch mode 执行。执行成功以后，会在 <code>export_sim/xsim</code> 目录下生成一些文件。里面会有生成的脚本以供仿真：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nb">cd</span><span class="w"> </span>export_sim/xsim<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./YOUR_SIM_TOP.sh
</span></code></pre></div>
<p>默认情况下它会执行 export_sim/xsim/cmd.tcl 里面的命令。如果想要记录 vcd 文件，修改内容为：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nv">open_vcd</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nv">log_vcd</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nv">run</span><span class="w"> </span><span class="mi">20</span>us
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="nv">close_vcd</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nv">quit</span>
</span></code></pre></div>
<p>这样就可以把仿真的波形输出到 dump.vcd 文件，拖到本地然后用 GTKWave 看。更多支持的命令可以到 UG900 里找。</p>
<h3 id="无项目模式"><a class="toclink" href="../../hardware/2020/04/04/vivado-simulation-command/#无项目模式">无项目模式</a></h3>
<p>如果没有创建 Vivado 项目，也可以单独进行仿真，具体分为三个步骤：</p>
<ol>
<li>第一步，对每个源 Verilog 文件，运行 <code>xvlog module.v</code> 命令</li>
<li>第二步，生成 snapshot，运行 <code>xelab -debug all --snapshot snapshot_name top_module_name</code></li>
<li>第三步，仿真，运行 <code>xsim snapshot_name</code></li>
</ol>
<p>如果想要生成波形文件，编辑 <code>xsim.tcl</code> 为以下内容：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nv">open_vcd</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nv">log_vcd</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nv">run</span><span class="w"> </span><span class="o">-</span>all
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nv">close_vcd</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nv">quit</span>
</span></code></pre></div>
<p>把第三步运行的命令改为：<code>xsim snapshot_name -tclbatch xsim.tcl</code> 即可。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-17 00:00:00+00:00">2020年3月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="体验-tencent-kubernetes-engine"><a class="toclink" href="../../devops/2020/03/17/setup-k8s-tencentcloud/">体验 Tencent Kubernetes Engine</a></h2>
<p>之前在机器上试验了一下 kubernetes，感觉挺不错的，所以就想把腾讯云上面的机器也交给 kubernetes 管理。找到容器服务，新建集群，选择模板里的标准托管集群就可以了。然后开启下面的公网访问，设置一个比较小的 IP 地址段，按照页面下面的要求合并一下 kube config（因为还有别的 k8s cluster）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>~/.kube/config:/path/to/new/config<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--merge<span class="w"> </span>--flatten<span class="w"> </span>&gt;<span class="w"> </span>new_config
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>$<span class="w"> </span>cp<span class="w"> </span>new_config<span class="w"> </span>~/.kube/config
</span></code></pre></div>
<p>覆盖之前先确认原来的配置还在，然后就可以用 kubectl 切换到新的 context：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>get-contexts
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>new-context-here
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>node
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>NAME<span class="w">          </span>STATUS<span class="w">   </span>ROLES<span class="w">    </span>AGE<span class="w">   </span>VERSION
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="m">172</span>.21.0.17<span class="w">   </span>Ready<span class="w">    </span>&lt;none&gt;<span class="w">   </span>75m<span class="w">   </span>v1.16.3-tke.3
</span></code></pre></div>
<p>可以看到我们的 k8s node 已经上线了。我一般习惯先配好 kubernetes-dashboard：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/cilium/cilium/v1.6/install/kubernetes/quick-install.yaml
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>proxy<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>describe<span class="w"> </span>secret<span class="w"> </span><span class="o">(</span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>admin-user<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print \$1}&#39;</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n1<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print \$2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>pbcopy
</span></code></pre></div>
<p>然后在浏览器里访问 http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/overview?namespace=default 然后把剪贴板里的 token 粘贴进去即可。</p>
<p>默认情况下 kubernetes-dashboard 的权限比较少，可以让它获得更多权限：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>edit<span class="w"> </span>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1"># use &#39;*&#39; for ultimate </span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># use `kubectl get clusterrole.rbac.authorization.k8s.io/cluster-admin -o yaml` to see full permissions</span>
</span></code></pre></div>
<p>接下来配置 metrics-server。下载 metrics-server 仓库，然后修改镜像地址：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>wget<span class="w"> </span>https://github.com/kubernetes-sigs/metrics-server/archive/v0.3.6.zip
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>$<span class="w"> </span>unar<span class="w"> </span>v0.3.6.zip
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>metrics-server-0.3.6/deploy/1.8+
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>$<span class="w"> </span>vim<span class="w"> </span>metrics-server-deployment
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1"># change: k8s.gcr.io/metrics-server-amd64:v0.3.6</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="c1"># to: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1"># add line below image: args: [&quot;--kubelet-insecure-tls&quot;]</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>.
</span></code></pre></div>
<p>等一段时间，就可以看到 metrics server 正常运行了。</p>
<p>参考：https://tencentcloudcontainerteam.github.io/tke-handbook/</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-17 00:00:00+00:00">2020年3月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-rocket-chip-上挂接-tlram"><a class="toclink" href="../../hardware/2020/03/17/rocket-chip-tlram-load/">在 Rocket Chip 上挂接 TLRAM</a></h2>
<p>最近遇到一个需求，需要在 Rocket Chip 里面开辟一块空间，通过 verilog 的 $readmemh 来进行初始化而不是用 BootROM，这样每次修改内容不需要重新跑一次 Chisel -&gt; Verilog 的流程。然后到处研究了一下，找到了解决的方案：</p>
<p>首先是新建一个 TLRAM 然后挂接到 cbus 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">tilelink</span><span class="p">.</span><span class="nc">TLRAM</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">tilelink</span><span class="p">.</span><span class="nc">TLFragmenter</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">diplomacy</span><span class="p">.</span><span class="nc">LazyModule</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">diplomacy</span><span class="p">.</span><span class="nc">AddressSet</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="k">trait</span><span class="w"> </span><span class="nc">HasTestRAM</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">this</span><span class="p">:</span><span class="w"> </span><span class="nc">BaseSubsystem</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">testRAM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LazyModule</span><span class="p">(</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">TLRAM</span><span class="p">(</span><span class="nc">AddressSet</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1FFF</span><span class="p">),</span><span class="w"> </span><span class="n">beatBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbus</span><span class="p">.</span><span class="n">beatBytes</span><span class="p">)</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">  </span><span class="n">testRAM</span><span class="p">.</span><span class="n">node</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cbus</span><span class="p">.</span><span class="n">coupleTo</span><span class="p">(</span><span class="s">&quot;bootrom&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nc">TLFragmenter</span><span class="p">(</span><span class="n">cbus</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的地址和大小都可以自由定义。然后添加到自己的 Top Module 中：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestTop</span><span class="p">(</span><span class="k">implicit</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="nc">Parameters</span><span class="p">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">RocketSystem</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="k">with</span><span class="w"> </span><span class="nc">HasTestRAM</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="c1">//...</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">lazy</span><span class="w"> </span><span class="p">...</span><span class="w">    </span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际上这时候 TLRAM 就已经加入到了 TileLink 总线中。接着，为了让 firrtl 生成 $readmemh 的代码，需要两个步骤：</p>
<p>首先是用 <code>chisel3.util.experimental.loadMemoryFromFile</code> 函数（文档在 https://github.com/freechipsproject/chisel3/wiki/Chisel-Memories）：</p>
<p>UPDATE：现在的文档在 <a href="https://www.chisel-lang.org/chisel3/docs/appendix/experimental-features#loading-memories-for-simulation-or-fpga-initialization-">Loading Memories for simulation or FPGA initialization</a> 处，并且可以用 loadMemoryFromFileInline。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestTopImp</span><span class="p">(</span><span class="n">outer</span><span class="p">:</span><span class="w"> </span><span class="nc">TestTop</span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">RocketSubsystemModuleImp</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">loadMemoryFromFile</span><span class="p">(</span><span class="n">outer</span><span class="p">.</span><span class="n">testRAM</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test.hex&quot;</span><span class="p">)</span><span class="w">    </span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数会生成一个 FIRRTL Annotation，记录了在这里需要对这个 mem 生成对应的 readmemh 调用。然后在 firrtl 的调用里传入 .anno.json 和 transform：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$<span class="w"> </span>runMain<span class="w"> </span>firrtl.stage.Main<span class="w"> </span>-i<span class="w"> </span>xxx<span class="w"> </span>-o<span class="w"> </span>xxx<span class="w"> </span>-X<span class="w"> </span>verilog<span class="w"> </span>-faf<span class="w"> </span>/path/to/xxx.anno.json<span class="w"> </span>-fct<span class="w"> </span>chisel3.util.experimental.LoadMemoryTransform
</span></code></pre></div>
<p>UPDATE: 现在不需要 <code>-fct chisel3.util.experimental.LoadMemoryTransform</code> 参数。目前这个功能和生成 blackbox memory 有冲突，不能同时使用，需要等 chisel3 后续修复。</p>
<p>这里的 chisel3.util.experimental.LoadMemoryTransform 会找到 anno.json 里面对应的 Annotation，然后生成类似下面这样的 verilog 代码：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">module</span><span class="w"> </span><span class="n">xxx</span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="p">);</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="nb">$readmemh</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">mem_xxx</span><span class="p">);</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">endmodule</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">bind</span><span class="w"> </span><span class="n">TLRAM</span><span class="w"> </span><span class="n">xxx</span><span class="w"> </span><span class="n">xxx</span><span class="p">(.</span><span class="o">*</span><span class="p">);</span>
</span></code></pre></div>
<p>这里采用了 Verilog 的 bind 功能，可以在不修改模块代码的时候注入，比如上面，就是注入了一个语句 $readmemh，从而达到目的。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-14 00:00:00+00:00">2020年3月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-kubernetes-集群上部署-gitlabrunner"><a class="toclink" href="../../devops/2020/03/14/k8s-gitlab-runner/">在 Kubernetes 集群上部署 gitlab—runner</a></h2>
<p>按照 GitLab 上的教程试着把 gitlab-runner 部署到 k8s 集群上，发现异常地简单，所以简单做个笔记：</p>
<p>编辑 <code>values.yaml</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>gitlabUrl: GITLAB_URL
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>runnerRegistrationToken: &quot;REDACTED&quot;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>rbac:
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    create: true
</span></code></pre></div>
<p>此处的信息按照 "Set up a specific Runner manually" 下面的提示填写。然后用 Helm 进行安装：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>gitlab<span class="w"> </span>https://charts.gitlab.io
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>gitlab-runner
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>$<span class="w"> </span>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span>gitlab-runner<span class="w"> </span>gitlab-runner<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>gitlab/gitlab-runner
</span></code></pre></div>
<p>然后去 Kubernetes Dashboard 就可以看到部署的情况，回到 GitLab 也可以看到出现了“Runners activated for this project” ，表示配置成功。</p>
<p>参考配置：https://docs.gitlab.com/runner/install/kubernetes.html</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../2021/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2021">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                2021
              </div>
            </div>
          </a>
        
        
          
          <a href="../2019/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2019">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2019
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f13b1293.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>