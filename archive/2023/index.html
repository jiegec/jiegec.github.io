
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维,编程,调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/archive/2023/">
      
      
        <link rel="prev" href="../../tools/">
      
      
        <link rel="next" href="../2022/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0">
    
    
      
        <title>2023 - 杰哥的{运维,编程,调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0c456da8.min.css">
      
      

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2023" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2023
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../category/crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2023
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hugo-mkdocs" class="md-nav__link">
    把博客生成器从 Hugo 迁移到 Mkdocs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ecdsa" class="md-nav__link">
    ECDSA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apple-m1-gentooprefix" class="md-nav__link">
    在 Apple M1 上试用 Gentoo/Prefix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    生成树协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libvirtd-proxmox-ve" class="md-nav__link">
    从 libvirtd 迁移到 Proxmox VE
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loongarch" class="md-nav__link">
    LoongArch 初尝试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tar" class="md-nav__link">
    Tar 文件格式
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-openldap" class="md-nav__link">
    使用 Docker 部署 OpenLDAP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jlink-spi-nor-flash" class="md-nav__link">
    使用 JLink 操作 SPI NOR Flash
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    链接器的工作原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-a-linux-6213-bug-stops-vivado-from-recognizing-fpga" class="md-nav__link">
    How a Linux 6.2.13 BUG stops Vivado from recognizing FPGA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux-6213-bug-vivado-fpga" class="md-nav__link">
    Linux 6.2.13 引入的 BUG 导致 Vivado 无法识别 FPGA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#i2c" class="md-nav__link">
    I2C 协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spi" class="md-nav__link">
    SPI 协议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#litex-uart-over-jtag" class="md-nav__link">
    在 LiteX 中使用 UART over JTAG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dram" class="md-nav__link">
    DRAM 的拓扑和训练
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arty-a7-litex-vexriscv-linux" class="md-nav__link">
    在 Arty A7 上用 LiteX 和 VexRiscv 跑 Linux
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cc" class="md-nav__link">
    C/C++ 数参数个数的特别方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sco-openserver-600" class="md-nav__link">
    SCO OpenServer 6.0.0 虚拟机安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unixware-714" class="md-nav__link">
    UnixWare 7.1.4 虚拟机安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aix-72" class="md-nav__link">
    AIX 7.2 虚拟机安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sco-openserver-507" class="md-nav__link">
    SCO OpenServer 5.0.7 虚拟机安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ram" class="md-nav__link">
    RAM 读写冲突
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firtool" class="md-nav__link">
    firtool 尝试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    单核处理器的协同仿真
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    软硬件队列接口
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#80211" class="md-nav__link">
    802.11 学习
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    数字调制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux-netgear-a6210-usb" class="md-nav__link">
    在 Linux 上使用 Netgear A6210 USB 无线网卡
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transport-layer-interface" class="md-nav__link">
    Transport Layer Interface 考古
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openbsd-xonly" class="md-nav__link">
    OpenBSD xonly 实现原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solaris-114" class="md-nav__link">
    Solaris 11.4 安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#freebsdnetbsdopenbsddragonflybsd-cookbook" class="md-nav__link">
    FreeBSD/NetBSD/OpenBSD/DragonFlyBSD Cookbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#freebsd-code-server" class="md-nav__link">
    在 FreeBSD 上运行 code-server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chi" class="md-nav__link">
    CHI 学习笔记
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#intel" class="md-nav__link">
    Intel 处理器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amd" class="md-nav__link">
    AMD 处理器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pcie-bifurcation" class="md-nav__link">
    PCIe Bifurcation
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2023">2023</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-15 00:00:00">2023年7月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/meta/" class="md-meta__link">meta</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="hugo-mkdocs"><a class="toclink" href="../../meta/2023/07/15/migrate-from-hugo-to-mkdocs/">把博客生成器从 Hugo 迁移到 Mkdocs</a></h2>
<p>距离上一次 <a href="../../meta/2019/05/02/migrate-from-jekyll-to-hugo/">Jekyll 迁移到 Hugo</a> 已经过去了四年，这次正好 mkdocs-material 发了新的 beta 版本，加入了对博客的支持，所以就当小白鼠，把博客迁移到了 Mkdocs + Mkdocs-Material。</p>
<p>这次迁移比较顺利，除了 tag 和 category 少了一些页面以外，原来的文章的链接都是正常的。为什么要迁移呢，主要是最近写各种文档，Mkdocs 用的比较多，但是 Mkdocs 的 Markdown 很多地方和 Hugo 不太一样，下面列一些最难以忍受的 Hugo 的问题：</p>
<ol>
<li>数学公式：Hugo 的 <code>\</code> 需要转义，导致很多地方写数学公式都很麻烦，然后因为我经常要在 Hugo 和 Mkdocs 之间复制 Markdown，此时就需要很多手动工作。</li>
<li>资源路径：Hugo 的资源路径默认都是绝对路径，要引用其他文章的话，要么用啰嗦的 relref，要么就写绝对路径，比较头疼。Mkdocs 就很好，自动检测，帮我计算出实际的地址。</li>
</ol>
<p>迁移的时候有很多细节上的不同，不过基本靠 VSCode 的正则表达式替换解决了。</p>
<p>不过，Mkdocs 又出现了 Jekyll 的老问题，就是性能比较差。当然了，不一定是 Mkdocs 本身的问题，也可能是 Mkdocs-Material 加各种插件的问题，目前还有待观察。无论如何，Python 调起来总归是比 Ruby 要容易。希望不要在未来的某一天，由从 Mkdocs 迁移回 Hugo。</p>

    <nav class="md-post__action">
      <a href="../../meta/2023/07/15/migrate-from-hugo-to-mkdocs/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-14 00:00:00">2023年7月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/crypto/" class="md-meta__link">crypto</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ecdsa"><a class="toclink" href="../../crypto/2023/07/14/ecdsa/">ECDSA</a></h2>
<p>ECDSA 是一个基于椭圆曲线的签名算法，使用时需要确定一个椭圆曲线，以及它的 base point <span class="arithmatex">\(G\)</span>，且 <span class="arithmatex">\(G\)</span> 的阶是素数 <span class="arithmatex">\(n\)</span>。ECDSA 支持如下的操作：</p>
<ol>
<li>生成签名</li>
<li>验证签名</li>
<li>从签名和明文推导出公钥</li>
</ol>

    <nav class="md-post__action">
      <a href="../../crypto/2023/07/14/ecdsa/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-08 00:00:00">2023年7月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="apple-m1-gentooprefix"><a class="toclink" href="../../devops/2023/07/08/gentoo-prefix-m1/">在 Apple M1 上试用 Gentoo/Prefix</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2023/07/08/gentoo-prefix-m1/#_1">背景</a></h3>
<p>上一次折腾 Gentoo/Prefix 是<a href="../../devops/2017/12/27/try-gentoo-prefix-on-macOS/">五年多以前</a>，当时还是用的 Intel Mac，最近需要探索一下在现在的 macOS 系统上用 Gentoo/Prefix 会遇到哪些问题，因此今天在 Apple M1 上重新尝试一次。</p>

    <nav class="md-post__action">
      <a href="../../devops/2023/07/08/gentoo-prefix-m1/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-20 00:00:00">2023年6月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../networking/2023/06/20/spanning-tree-protocol/">生成树协议</a></h2>
<h3 id="spanning-tree-protocol"><a class="toclink" href="../../networking/2023/06/20/spanning-tree-protocol/#spanning-tree-protocol">Spanning Tree Protocol</a></h3>
<p>STP（Spanning Tree Protocol）可以在 <a href="https://ieeexplore.ieee.org/document/1389253">802.1D-1998</a> 第 8 章中找到。STP 协议工作在交换机上，需要根据交换机连接的拓扑，自动计算出一个生成树，并且把不在生成树上的边禁用，这样即使连接的拓扑有环路，禁用以后就没有环了。有了 STP 以后，连接交换机的时候就可以刻意连成环，从而提供冗余。</p>

    <nav class="md-post__action">
      <a href="../../networking/2023/06/20/spanning-tree-protocol/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-15 00:00:00">2023年6月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="libvirtd-proxmox-ve"><a class="toclink" href="../../software/2023/06/15/libvirtd-migrate-proxmox-ve/">从 libvirtd 迁移到 Proxmox VE</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2023/06/15/libvirtd-migrate-proxmox-ve/#_1">背景</a></h3>
<p>之前用 libvirtd + virt-manager 做 Linux 上的虚拟化，好处是比较轻量级，但是远程控制起来比较麻烦，要么通过 RDP 访问 virt-manager 的 UI，要么就用 cockpit 在网页里去配置虚拟机。此时就会比较怀念 VMware ESXi 的网页，但是 ESXi 装完以后，宿主机就很不自由了，很多东西没法自定义。最后就想到在 Debian 上装一个 Proxmox VE，希望得到一个比较好的中间态。</p>

    <nav class="md-post__action">
      <a href="../../software/2023/06/15/libvirtd-migrate-proxmox-ve/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-12 00:00:00">2023年6月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="loongarch"><a class="toclink" href="../../hardware/2023/06/12/try-loongarch/">LoongArch 初尝试</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/06/12/try-loongarch/#_1">背景</a></h3>
<p>最近应龙芯要求把监控程序移植到了 LoongArch 32 Reduced 架构上，趁此机会体验了一下 LoongArch 相关的软件和系统。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/06/12/try-loongarch/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-23 00:00:00">2023年5月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tar"><a class="toclink" href="../../software/2023/05/23/tar-format/">Tar 文件格式</a></h2>
<p>本文的内容已经整合到<a href="/kb/software/tar.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../software/2023/05/23/tar-format/#_1">背景</a></h3>
<p>最近在解压 tar.gz 文件的时候，发现如果用 unar 解压，就会出现文件名截断到 100 个字节的问题，而如果用 gnu tar 解压，文件名就是正常的，因此深入研究了一下 Tar 的文件格式。实际上，这是因为早期 tar 格式设计的时候，就设定了路径最长 100 字节的限制，后来的扩展解决了这个问题，但是 unar 没能正确地识别扩展，导致解压路径出错。</p>

    <nav class="md-post__action">
      <a href="../../software/2023/05/23/tar-format/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-13 00:00:00">2023年5月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="docker-openldap"><a class="toclink" href="../../software/2023/05/13/openldap-in-docker/">使用 Docker 部署 OpenLDAP</a></h2>
<p>OpenLDAP 是一个开源的用户系统实现，主要支持 LDAP 协议，可以给其他系统提供用户认证。下面讨论了如何在 Docker 中部署 OpenLDAP。</p>

    <nav class="md-post__action">
      <a href="../../software/2023/05/13/openldap-in-docker/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-08 00:00:00">2023年5月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="jlink-spi-nor-flash"><a class="toclink" href="../../hardware/2023/05/08/jlink-spi-nor-flash/">使用 JLink 操作 SPI NOR Flash</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/05/08/jlink-spi-nor-flash/#_1">背景</a></h3>
<p>最近设计了一款 <a href="https://github.com/jiegec/PMOD-SPI-NOR-FLASH">PMOD SPI NOR Flash</a> 扩展板，搭载了 W25Q128 SPI NOR Flash 芯片。在 jlc 生产回来以后，通过 JLink 连接到电脑上进行测试，看看是否可以用 JLink 操作 SPI NOR Flash。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/05/08/jlink-spi-nor-flash/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-06 00:00:00">2023年5月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 28 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../software/2023/05/06/linker/">链接器的工作原理</a></h2>
<h3 id="_2"><a class="toclink" href="../../software/2023/05/06/linker/#_2">背景</a></h3>
<p>最近和同学讨论一些比较复杂的链接问题，遇到一些比较复杂的情况，因此复习一遍链接器的工作原理，在这里总结工作原理和常见的问题。</p>

    <nav class="md-post__action">
      <a href="../../software/2023/05/06/linker/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-06 00:00:00">2023年5月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="how-a-linux-6213-bug-stops-vivado-from-recognizing-fpga"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado-en/">How a Linux 6.2.13 BUG stops Vivado from recognizing FPGA</a></h2>
<p><a href="../../software/2023/05/06/linux-regression-vivado/">中文版本</a></p>
<h3 id="tldr"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado-en/#tldr">TLDR</a></h3>
<p>In short, the commit introduced by Linux 6.2.13:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-1"></a>commit 0d30989fe9a176565d360376d4bc2ea1c61cbbac
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-2"></a>Author: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-3"></a>Date:   Fri Apr 14 14:59:19 2023 -0400
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-5"></a>    mm/mmap: regression fix for unmapped_area{_topdown}
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-7"></a>    commit 58c5d0d6d522112577c7eeb71d382ea642ed7be4 upstream.
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-9"></a>    The maple tree limits the gap returned to a window that specifically fits
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-10"></a>    what was asked.  This may not be optimal in the case of switching search
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-11"></a>    directions or a gap that does not satisfy the requested space for other
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-12"></a>    reasons.  Fix the search by retrying the operation and limiting the search
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-13"></a>    window in the rare occasion that a conflict occurs.
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-15"></a>    Link: https://lkml.kernel.org/r/20230414185919.4175572-1-Liam.Howlett@oracle.com
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-16"></a>    Fixes: 3499a13168da (&quot;mm/mmap: use maple tree for unmapped_area{_topdown}&quot;)
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-17"></a>    Signed-off-by: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-18"></a>    Reported-by: Rick Edgecombe &lt;rick.p.edgecombe@intel.com&gt;
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-19"></a>    Cc: &lt;stable@vger.kernel.org&gt;
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-20"></a>    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../software/2023/05/06/linux-regression-vivado-en/#__codelineno-0-21"></a>    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</span></code></pre></div>
<p>While fixing a BUG, a new BUG is introduced, causing MAP_32BIT to fail to work sometimes, and Xilinx's Digilent driver uses this parameter, causing mmap to fail and unable to recognize the FPGA.</p>

    <nav class="md-post__action">
      <a href="../../software/2023/05/06/linux-regression-vivado-en/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-06 00:00:00">2023年5月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linux-6213-bug-vivado-fpga"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/">Linux 6.2.13 引入的 BUG 导致 Vivado 无法识别 FPGA</a></h2>
<p><a href="../../software/2023/05/06/linux-regression-vivado-en/">English version</a></p>
<h3 id="tldr"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/#tldr">TLDR</a></h3>
<p>简单来说，Linux 6.2.13 引入的 commit：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-1"></a>commit 0d30989fe9a176565d360376d4bc2ea1c61cbbac
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-2"></a>Author: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-3"></a>Date:   Fri Apr 14 14:59:19 2023 -0400
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-5"></a>    mm/mmap: regression fix for unmapped_area{_topdown}
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-7"></a>    commit 58c5d0d6d522112577c7eeb71d382ea642ed7be4 upstream.
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-9"></a>    The maple tree limits the gap returned to a window that specifically fits
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-10"></a>    what was asked.  This may not be optimal in the case of switching search
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-11"></a>    directions or a gap that does not satisfy the requested space for other
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-12"></a>    reasons.  Fix the search by retrying the operation and limiting the search
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-13"></a>    window in the rare occasion that a conflict occurs.
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-15"></a>    Link: https://lkml.kernel.org/r/20230414185919.4175572-1-Liam.Howlett@oracle.com
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-16"></a>    Fixes: 3499a13168da (&quot;mm/mmap: use maple tree for unmapped_area{_topdown}&quot;)
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-17"></a>    Signed-off-by: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-18"></a>    Reported-by: Rick Edgecombe &lt;rick.p.edgecombe@intel.com&gt;
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-19"></a>    Cc: &lt;stable@vger.kernel.org&gt;
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-20"></a>    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-21"></a>    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</span></code></pre></div>
<p>修复了 BUG 的同时，引入了新的 BUG，导致 MAP_32BIT 有时无法工作，而 Xilinx 的 Digilent 下载器代码使用了这个参数，导致 mmap 失败，无法识别 FPGA。</p>

    <nav class="md-post__action">
      <a href="../../software/2023/05/06/linux-regression-vivado/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-03 00:00:00">2023年5月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="i2c"><a class="toclink" href="../../hardware/2023/05/03/i2c/">I2C 协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/i2c.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/05/03/i2c/#_1">背景</a></h3>
<p>最近数设课上，同学们开始购买外设，其中就涉及到 I2C 协议，因此顺带写一下 I2C 协议的教程，帮助同学们进行理解。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/05/03/i2c/#_2">接口</a></h3>
<p>I2C 协议涉及到两个信号：</p>
<ul>
<li>SCL: 时钟信号，Master -&gt; Slave</li>
<li>SDA：数据信号，Master &lt;-&gt; Slave</li>
</ul>
<p>由于只有一个数据信号，所以 SDA 由 Master 和 Slave 轮流输出。一次请求的开始条件是，SDA 从 1 变成 0，之后 SCL 从 1 变成 0。开始请求以后，每次 SCL 上升沿采样一位的数据。请求结束时，SCL 从 0 变成 1，然后 SDA 从 0 变成 1。一次请求的波形如下：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "scl", wave: "1.0101010|.101..."},
      { name: "sda", wave: "10....1..|0....1."},
      { name: "i2c", wave: "34.5.....|6.7....", data: ["idle", "start", "data", "ack", "stop"]},
    ]
}</script>
<ol>
<li>idle 阶段，scl 和 sda 都是 1</li>
<li>start 阶段，首先是 sda 变成 0，之后是 scl 变成 0</li>
<li>data/ack 阶段，在 scl 上升沿采样数据，在 scl 下降沿（准确来说，负半周期）修改数据</li>
<li>stop 阶段，首先是 scl 变成 1，之后是 sda 变成 1</li>
</ol>
<p>传输数据的时候，需要保证 sda 在 scl 正半周期的时候保持不变。如果变了，那就是 start 或者 stop。因此，在 data/ack 阶段，建议 sda 的变化相比 scl 下降沿有一个延迟（Hold Time，一般的要求是 Min 0us）。实现方法可能是在分频的时候，延迟一个周期。</p>
<p>这里的 data/ack 指的则是传输的具体内容：例如 master 要传输 7 位的地址和 1 位的读使能，响应地址的 slave 要返回 ack；之后，无论是 master 还是 slave 发送数据，接收的一方都要返回 ack。ack 是低有效，意味着 0 表示成功，1 表示失败。</p>
<p>由于 sda 带有上拉电阻，所以如果没有 slave 响应，ack 阶段的 sda 就会变成 1，意味着失败。</p>
<h3 id="i2c_1"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c_1">I2C 控制器实现</a></h3>
<p>结合上面的 I2C 波形，可以设计一个状态机：</p>
<ol>
<li>INIT 状态：初始情况下，SCL 和 SDA 都为 1，要发送数据的时候，转移到 START1 状态</li>
<li>START1 状态：设置 SDA=0，当达到分频条件时，转移到 START2 状态</li>
<li>START2 状态：设置 SCL=0，当达到分频条件时，START 发送完成，转移到 SEND 状态</li>
<li>SEND 状态：当达到分频条件时，SCL 取反，如果 SCL 要从 1 变成 0，延迟一个周期，再输出 1 位的数据到 SDA 上，保证 SDA 的变化在 SCL 的负半周期；同时统计传输位数，每传输 8 位，就要等待一个周期让 Slave 响应 ACK，此时要设置 inout 输出为高阻态；如果要转换传输方向，即 Master 要读取数据，那么转移到 RECV 状态；如果传输结束，转移到 STOP1 状态</li>
<li>RECV 状态：当达到分频条件时，SCL 取反，如果 SCL 从 0 变成 1，对 SDA 进行采样并且保存下来；同时统计传输位数，每传输 8 位，就要在 SDA 输出一次 ACK；如果传输结束，转移到 STOP1 状态</li>
<li>STOP1 状态：设置 SCL=1，当达到分频条件时，转移到 STOP2 状态</li>
<li>STOP2 状态：设置 SDA=1，当达到分频条件时，转移到 INIT 状态</li>
</ol>
<p>分频是因为一般 I2C 的频率比较低，是 kHz 的量级。需要按照控制逻辑的主频，结合外设能接受的 I2C 频率范围，计算出分频的倍数。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/05/03/i2c/#_3">上层协议</a></h3>
<p>在此基础上，可以设计上层协议，例如 <a href="http://cdn.sparkfun.com/datasheets/Dev/Arduino/Shields/WolfsonWM8731.pdf">WM8731</a>，支持通过 I2C 写入内部寄存器，一次写操作分为以下步骤：</p>
<ol>
<li>start</li>
<li>master 发送 7 位的设备地址和 0（表示写），slave 发送 ack</li>
<li>master 发送 7 位的寄存器地址 和 1 位的寄存器数据，slave 发送 ack</li>
<li>master 发送 8 位的寄存器数据，slave 发送 ack</li>
<li>stop</li>
</ol>
<p>这里的第二步发送的 7 位地址 + 读/写位是标准的，I2C Slave 都会根据 7 位地址来决定是否由自己来响应。此后的数据的定义，则是各个芯片按照各自的协议来进行。</p>
<p>为了让多个同型号 I2C 芯片可以同时使用，通常芯片提供了一些引脚来配置它的地址，那么在设计的时候，给不同的芯片设置不同的地址，就解决了地址冲突的问题。</p>
<h3 id="i2c-eeprom"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c-eeprom">I2C EEPROM</a></h3>
<p>以 <a href="https://ww1.microchip.com/downloads/en/devicedoc/doc0336.pdf">AT24C32/AT24C64</a> 为例，它提供了一个 I2C 接口的 EEPROM，支持如下操作：</p>
<p>写入数据：start，7 位设备地址，W，ACK；写入地址的高 8 位，ack；写入地址的低 8 位，ack；数据的每个字节，ack；最终 stop。</p>
<p>读取数据：start，7 位设备地址，W，ack；读取地址的高 8 位，ack；读取地址的低 8 位，ack；start，7 位设备地址，R，ack；数据的每个字节，ack；最终不想读的时候 nack，stop。</p>
<p>可以看到，这里设计成写操作的时候，只有 Master 到 Slave 的数据传输，反过来读操作的时候，只有 Slave 到 Master 的数据传输。因此，为了传输读取的地址，要首先“写入”读取的地址，再进行一次读操作，把数据读出来。</p>
<h3 id="i2c-audio-codec"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c-audio-codec">I2C Audio Codec</a></h3>
<p>上面的例子中的 <a href="http://cdn.sparkfun.com/datasheets/Dev/Arduino/Shields/WolfsonWM8731.pdf">WM8731</a> 实际上就是一个 Audio Codec，可以通过 I2C 对其寄存器进行写入。WM8731 的寄存器地址有 9 位，每个寄存器有 8 位的数据，因此写入流程是：start，7 位设备地址，W，ack；7 位寄存器地址，1 位寄存器数据，ack；8 位寄存器数据，ack；stop。</p>
<h3 id="i2c-sensor"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c-sensor">I2C Sensor</a></h3>
<p>举一个传感器的例子：<a href="https://m5stack.oss-cn-shenzhen.aliyuncs.com/resource/docs/datasheet/unit/gesture/paj7620u2_datasheet.pdf">PAJ7620U2: Integrated Gesture Recognition Sensor </a>，它也提供了一个寄存器读写的接口，支持如下操作：</p>
<p>单次写入：start，7 位设备地址，W，ack；8 位地址，ack；8 位数据，ack；stop。</p>
<p>单次读取：start，7 位设备地址，W，ack；8 位地址，ack；stop；start，7 位设备地址，R，ack；8 位数据，nack；stop。这里的读取也拆成了两步：第一步“写入”读取的地址，第二步读取出数据。最后的 nack 表示 master 不需要读取更多的数据。</p>
<p>如果要批量读取的话，只要在单次读取的基础上，读取数据的时候发 ack，等到不需要继续读的时候再发 nack，就可以连续读取多个寄存器的数据。</p>
<p>这些命令格式和上面的 I2C EEPROM 基本是一样的。</p>
<p>颜色传感器 <a href="https://cdn-shop.adafruit.com/datasheets/TCS34725.pdf">TCS3472</a> 的命令格式也是类似的。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/05/03/i2c/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-26 00:00:00">2023年4月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="spi"><a class="toclink" href="../../hardware/2023/04/26/spi/">SPI 协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/spi.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/26/spi/#_1">背景</a></h3>
<p>最近数设课上，同学们开始购买外设，其中就涉及到 SPI 协议，因此顺带写一下 SPI 协议的教程，帮助同学们进行理解。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/04/26/spi/#_2">接口</a></h3>
<p>SPI 协议涉及到四个信号：</p>
<ul>
<li>SCLK: 时钟信号，Master -&gt; Slave</li>
<li>MOSI：数据信号，Master -&gt; Slave</li>
<li>MISO：数据信号，Slave -&gt; Master</li>
<li>CS：芯片使能，一般是低有效</li>
</ul>
<p>要通过 SPI 协议发送命令的时候，通常需要先拉低 CS，然后启动 SCLK 时钟，同时收发数据。注意 SPI 是全双工的，也就是发送的同时也在接收，只不过通常来说，外设等到主机发送了命令本身，才知道要回复什么，所以很多时候命令设计成了事实上的半双工：前半部分主机在发命令，外设发送无用的数据；后半部分外设在发送响应，主机发送无用的数据。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/04/26/spi/#_3">波形</a></h3>
<p>SPI 有不同的类型，下面讲一种比较常见的配置（即 CPOL=0，CPHA=0），在这种模式下，Master 和 Slave 都是在时钟的下降沿修改输出的数据，然后在时钟（<code>sclk</code>）的上升沿对接收到的数据进行采样：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........"},
      { name: "sclk", wave: "0.101010."},
      { name: "mosi", wave: "03.4.5.x."},
      { name: "miso", wave: "06.7.8.x."},
      { name: "cs_n", wave: "10......1"},
    ]
}</script>
<p>波形图中，时钟（<code>sclk</code>）上升沿时，数据处于稳定的状态，所以此时 Master 对 MISO 采样，Slave 对 MOSI 采样，可以得到稳定的数据；时钟下降沿时，Master 和 Slave 修改输出的数据。</p>
<p>实际在 RTL 中实现的时候，Master 可以不写 negedge 逻辑，而是写一个分频器，在分频出来的负半周期里，实现数据的修改，如上图中的 <code>clk</code> 分频到 <code>sclk</code>。一般使用一个状态机来实现 SPI Master，记录当前传输到哪一个 bit，以及记录当前是 <code>sclk</code> 的正半周期还是负半周期。</p>
<p>SPI 本身很简单，所以核心不在 SPI，而是在 SPI 之上定义的各种协议。</p>
<h3 id="spi-flash"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-flash">SPI Flash</a></h3>
<p>SPI Flash 是一种很常见的 SPI 外设，可以用来访问 NAND/NOR Flash。</p>
<p>为了提升性能，很多 SPI Flash 还会提供 Dual SPI 和 Quad SPI 模式。标准的 SPI 中，Master 到 Slave 和 Slave 到 Master 分别是一根信号线，如果要继续提高性能，那就要引入更多的信号线来进行数据传输，所以 Dual SPI 就是让原来的 MISO 和 MOSI 都可以同时发送数据；Quad SPI 则是又额外添加了两个信号线来进行数据传输。</p>
<p>常见的 SPI Flash 厂家：</p>
<ul>
<li>Spansion -&gt; Cypress -&gt; Infineon</li>
<li>Numonyx -&gt; Micron</li>
<li>Winbond</li>
<li>GigaDevice</li>
<li>Macronix</li>
</ul>
<h4 id="spi-nand-flash"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-nand-flash">SPI NAND Flash</a></h4>
<p>下面以 <a href="https://www.alliancememory.com/wp-content/uploads/pdf/flash/AllianceMemory_SPI_NAND_Flash_July2020_Rev1.0.pdf">Alliance Memory SPI NAND Flash Datasheet</a> 为例子，看看通常 SPI Flash 都支持哪些命令，都是如何传输数据的。</p>
<p>这款 SPI NAND Flash 的内部存储分为三层：</p>
<ol>
<li>Block：数量不定</li>
<li>Page：每个 Block 包括 64 个 Page</li>
<li>Byte：每个 Page 包括一定数量的 Byte，常见的有 2112(2048+64)、2176(2048+128)、4352(4096+256)</li>
</ol>
<p>NAND Flash 的读取粒度是 Page，这就是为什么 NAND Flash 更像块设备。一次读取过程分为三个步骤：</p>
<ol>
<li>发送 13H(Page Read to Cache) 命令，把一个 Page 的数据读取到 NAND Flash 内部的 Cache 中</li>
<li>不断发送 0FH(Get Feature) 命令，直到 NAND Flash 表示 Page Read to Cache 命令完成</li>
<li>发送 Read from Cache 命令，考虑到传输的方式不同，有以下几种：<ol>
<li>Read from Cache x1 IO(03H/0BH): Master 给出 1 字节命令，2 字节地址和 1 字节 dummy 数据，共 8(COMMAND)+16(ADDR)+8(DUMMY) 个周期，之后 Slave 从 MISO 给出数据</li>
<li>Read from Cache x2 IO(3BH): Slave 同时通过 MISO 和 MOSI 给出数据</li>
<li>Read from Cache x4 IO(6BH): Slave 同时通过 MISO、MOSI、WP# 和 HOLD# 给出数据</li>
<li>Read from Cache Dual IO(BBH): 在 3BH 的基础上，Master 也同时通过 MISO 和 MOSI 给出地址和 dummy 字节，所以 Master 只占用 8(COMMAND)+8(ADDR)+4(DUMMY) 个周期的时间发送</li>
<li>Read from Cache Quad IO(EBH): 在 6BH 的基础上，Master 也同时通过四个数据信号给出地址和 dummy 字节，所以 Master 只占用 8(COMMAND)+4(ADDR)+2(DUMMY) 个周期的时间发送</li>
</ol>
</li>
</ol>
<p>写入的时候，由于 NAND Flash 的特性，首先需要擦除，把一个 Block 的内容全部擦除，需要注意每个 Block 包括多个 Page，所以擦除的粒度是很粗的。擦除过的 Page 才可以进行写入，具体步骤是：</p>
<ol>
<li>发送 06H(Write Enable) 允许写入</li>
<li>发送 02H(Program Load) 或 32H(Program Load x4) 把要写入的数据传输给 NAND Flash 中的 Cache；02H 和 32H 的区别就是后者同时在四个信号线上传输数据</li>
<li>发送 10H(Program Execute) 进行实际的写入操作，从 Cache 到 Flash 存储</li>
<li>不断发送 0FH(Get Feature) 命令，直到 Program Execute 操作完成</li>
</ol>
<h4 id="spi-nor-flash"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-nor-flash">SPI NOR Flash</a></h4>
<p>NOR Flash 和 NAND Flash 的区别在于，NOR Flash 可以随机访问，可以提供 XIP 支持。下面以 <a href="https://www.micron.com/-/media/client/global/documents/products/data-sheet/nor-flash/serial-nor/n25q/n25q_128mb_3v_65nm.pdf">128Mb, 3V, Multiple I/O Serial Flash Memory</a> 为例子看看它是如何读写的。</p>
<p>SPI NOR Flash 读取的时候，只需要一条命令就可以了：READ/FAST READ。其中 READ 命令比较简单：发送 Command，发送地址，然后 Slave 紧接着就会发送数据；FAST READ 可以达到更高的频率，但是为了让 NOR Flash 有时间读取数据，在 Master 发送 Command 和地址后，还需要发送 Dummy cycles，然后 Slave 才会发送数据。和前面一样，FAST READ 也支持不同的 IO 类型，例如 Dual Output，Dual Input/Output，Quad Output，Quad Input/Output。一些比较高端的 SPI NOR Flash 还支持 DTR（Double Transfer Rate），实际上就是 DDR，在时钟上升沿和下降沿都采样数据。</p>
<p>写入的时候，和 NAND Flash 一样，也需要先擦除，再写入。SPI Flash 的存储层级是：</p>
<ol>
<li>Sector</li>
<li>Subsector</li>
<li>Page</li>
<li>Byte</li>
</ol>
<p>擦除的粒度是 Sector 或者 Subsector，写入的粒度是 Page。写入的时候，也需要首先发送 WRITE ENABLE 命令，再发送 PAGE PROGRAM 命令。NOR Flash 在 Program 上也比较简化，直接 Program 即可，不需要先写入到 Cache，再进行 Program。</p>
<p>NOR Flash 还提供了 XIP Mode 来加快随机访问：启用 XIP 模式后，给出一个地址，等待 Dummy cycles 后，就可以读出数据，不需要像前面那样发送 COMMAND，减少了延迟。当然了，即使不打开 NOR Flash 的 XIP Mode，也可以在 SPI 控制器里实现 XIP，只不过每次读取都要发一次 READ 命令。</p>
<h3 id="spi-eeprom"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-eeprom">SPI EEPROM</a></h3>
<p>SPI EEPROM 和 SPI NOR Flash 比较类似，但是 EEPROM 更小，也更加简单，例如写入的时候，不需要擦除。感兴趣的可以在 <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/22040c_cn.pdf">SPI 串行 EEPROM 系列数据手册</a> 中查看命令列表，这里就不赘述了。</p>
<h3 id="sd"><a class="toclink" href="../../hardware/2023/04/26/spi/#sd">SD 卡</a></h3>
<p>SD 卡除了 SD Bus 以外，还支持 SPI 模式（最新的 SDUC 不支持 SPI 模式），所以也可以用 SPI 来读写 SD 卡。</p>
<p>SD 卡比较特别的一点是，它需要比较复杂的初始化流程：</p>
<ol>
<li>首先要发送 CMD0 命令，同时 CS 拉低，使得 SD 卡进入 SPI 模式</li>
<li>对于 SDHC SD 卡，需要发送 CMD8 来协商工作电压范围</li>
<li>重复发送 ACMD41 命令（CMD55 + CMD41 = ACMD41）进行初始化，直到 SD 卡回复初始化完成</li>
<li>发送 CMD58 命令以读取 OCR 寄存器的值</li>
</ol>
<p>比较有意思的是命令的传输方式。每个命令有一个 6 位的命令编号，例如 CMD0 的编号就是 0，CMD55 的编号就是 55；还带有四字节的参数。每个命令会组装成一个 48 位的分组：</p>
<ol>
<li>bit[47]=0: Start Bit</li>
<li>bit[46]=1: Transmission Bit</li>
<li>bit[45:40]: Command Index</li>
<li>bit[39:8]: Argument</li>
<li>bit[7:1]: CRC7</li>
<li>bit[0]=1: End Bit</li>
</ol>
<p>可见额外多了一个 CRC7 的校验和。</p>
<p>SD 卡规定，SPI 模式下，所有的数据传输都是对齐到 8 位，也就是从 CS 拉低开始算，每 8 个时钟上升沿是一个字节，无论命令还是响应，都在 8 位的边界上传输。</p>
<p>想要读取数据的话，就要发送 READ_SINGLE_BLOCK 命令，参数就是要读取的 Block 地址。SD 卡回先回复一个字节的响应，然后开始发数据，数据从 Start Block Token 开始，然后是一个 Block 的数据（通常是 512 字节），最后再两个字节的 CRC16。</p>
<p>写数据则是发送 WRITE_BLOCK 命令，SD 卡回复一个字节的响应，然后控制器开始传输数据，数据从 Start Block Token 开始，接着是要写入的数据，最后是两个字节的 CRC16，然后 SD 卡回复一个字节的响应，标志着写入成功。</p>
<h3 id="spi_1"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi_1">SPI 以太网控制器</a></h3>
<p>有一些以太网产品提供了 SPI 接口，例如 <a href="https://ww1.microchip.com/downloads/aemDocuments/documents/UNG/ProductDocuments/DataSheets/KSZ8851SNL-Single-Port-Ethernet-Controller-with-SPI-DS00002381C.pdf">KSZ8851SNL/SNLI</a>，集成了 MAC 和 PHY，直接连接 MDI/MDI-X 接口，虽然最高只支持百兆网，但是接口上确实非常简单。</p>
<p>SPI 上发送的命令就两类：一类是读写寄存器，一类是读写 RX/TX FIFO。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2023/04/26/spi/#_4">键盘和触摸板</a></h3>
<p>一些型号的苹果电脑的键盘和触摸板是通过 SPI 接口访问的，在 Linux 中有相应的 applespi 驱动。</p>
<h3 id="spi-vs-i2c"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-vs-i2c">SPI vs I2C</a></h3>
<p>SPI 和 I2C 的区别在于，前者信号更多，全双工传输；后者信号更少，半双工传输。SPI 通过 CS 信号选择 Slave 芯片，I2C 通过地址进行区分。此外 I2C 还需要 Pull up resistor，这样如果没有设备响应，就会 NACK。</p>
<p>一些芯片提供了 SPI 或 I2C 的选项：共用两个信号，允许用户选择用 I2C 还是 SPI。例如 <a href="http://cdn.sparkfun.com/datasheets/Dev/Arduino/Shields/WolfsonWM8731.pdf">WM8731</a>，既支持 I2C（记为 2-wire mode），又支持 SPI（记为 3-wire mode）。一般这种时候，SPI 和 I2C 就是用来配置一些寄存器的，另外可能还有一些接口，例如 WM8731 负责声音数据传输的实际上是 I2S。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/04/26/spi/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-24 00:00:00">2023年4月24日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="litex-uart-over-jtag"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/">在 LiteX 中使用 UART over JTAG</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/#_1">背景</a></h3>
<p>在给 Alinx AX7021 适配 LiteX 的时候，遇到一个问题：PL 上没有连接串口，只有 PS 连接了串口，如果用 RISC-V 软核的话，就会面临无串口可用的情况，除非在扩展 IO 上自己定义一个串口。</p>
<p>因此研究了一下 LiteX 自带的 UART over JTAG 功能，在 Alinx AX7021 中调试出来了。</p>
<h3 id="litex"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/#litex">LiteX 配置</a></h3>
<p>启用很简单，直接在命令里添加 <code>--uart-name jtag_uart</code> 即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-0-1"></a>$<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>litex_boards.targets.alinx_ax7021<span class="w"> </span>--build<span class="w"> </span>--uart-name<span class="w"> </span>jtag_uart
</span></code></pre></div>
<p>如果要设置成默认的话，也可以在代码中添加：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-1-1"></a>        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uart_name&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;serial&quot;</span><span class="p">:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-1-2"></a>            <span class="c1"># Defaults to JTAG-UART since UART is connected to PS instead of PL</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-1-3"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;uart_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;jtag_uart&quot;</span>
</span></code></pre></div>
<p>那么 FPGA 部分的准备就完成了，把 bitstream 下载到 FPGA 即可进入下一步。</p>
<h3 id="openocd"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/#openocd">OpenOCD 配置</a></h3>
<p>下一步是使用 litex_term 来连接 UART over JTAG。它的启动方式是：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-2-1"></a>$<span class="w"> </span>litex_term<span class="w"> </span>--jtag-config<span class="w"> </span>alinx_ax7021.cfg<span class="w"> </span>jtag
</span></code></pre></div>
<p>实现的原理是，litex_term 会启动一个 OpenOCD，让 OpenOCD 监听 20000 端口，然后虚拟串口的收发都会在 TCP 上进行。那么，首先第一步是要让 OpenOCD 找到 Zynq 中的 PL。首先可以找到 Zynq 的 OpenOCD 配置模板：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-1"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>interface<span class="o">/</span>ftdi<span class="o">/</span>digilent_jtag_smt2.cfg<span class="k">]</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-3"></a><span class="nv">reset_config</span><span class="w"> </span>srst_only<span class="w"> </span>srst_push_pull
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-5"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>target<span class="o">/</span>zynq_7000.cfg<span class="k">]</span>
</span></code></pre></div>
<p>这个模板可以找到 ARM 核和 FPGA PL 部分，但是因为名字和 litex_term 期望的不同，所以无法工作。去掉那些不需要的，只保留想要的 PL 部分的 JTAG 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-1"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>interface<span class="o">/</span>ftdi<span class="o">/</span>digilent_jtag_smt2.cfg<span class="k">]</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-3"></a><span class="nv">reset_config</span><span class="w"> </span>srst_only<span class="w"> </span>srst_push_pull
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-5"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">15000</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-6"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span>zynq_pl<span class="w"> </span>bs<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">-</span>ignore-version<span class="w"> </span><span class="o">-</span>ircapture<span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="o">-</span>irmask<span class="w"> </span><span class="mh">0x03</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-7"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03723093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-8"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03722093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-9"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x0373c093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-10"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03728093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-11"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x0373B093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-12"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03732093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-13"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03727093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-14"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x0372C093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-15"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03731093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-16"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03736093</span>
</span></code></pre></div>
<p>接下来，就可以启动 OpenOCD：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-5-1"></a>openocd<span class="w"> </span>-f<span class="w"> </span>alinx_ax7021.cfg<span class="w"> </span>-f<span class="w"> </span>stream.cfg<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;init; irscan zynq_pl.bs 2; jtagstream_serve zynq_pl.bs 20000&quot;</span>
</span></code></pre></div>
<p>这里的 stream.cfg 是 litex_term 生成的，没有用 litex_term 启动是因为它写死了 tap 的名字，需要适配，不如直接绕过它去启动 OpenOCD，然后用 nc 连接：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-6-1"></a>$<span class="w"> </span>nc<span class="w"> </span>localhost<span class="w"> </span><span class="m">20000</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-6-2"></a>litex&gt;
</span></code></pre></div>
<p>就可以看到熟悉的串口了。但是跑命令的时候，经常出现重复字幕的输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-1"></a>LiteX BIOS, available commands:
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-3"></a>flush_cpu_dcache         -FFlush CPU data cache
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-4"></a>crc                      - Compute CRC32 ff a part of the address space
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-5"></a>ident                    - Identffier of the system
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-6"></a>help                     - Print this help
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-9"></a>serialboot               - Boot from Serial (SFL)
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-10"></a>reboot                   - Reboot
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-11"></a>boot                     - Boot from Meoory
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-13"></a>mem_cmp                  - Compare memory content
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-14"></a>mem_seeed                - Test memory speed
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-15"></a>mem_test                 - Test memory access
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-16"></a>mem_copy                 - Copy address ppace
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-17"></a>mem_write                - Write address space
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-18"></a>mem_read                 - Read address space
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-19"></a>mem_list                 -LList available memory regions
</span></code></pre></div>
<p>怀疑是哪里速率不匹配，导致同一份数据被读出来两次。之后用一个更低的 CPU 主频再试一次。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/04/24/litex-uart-over-jtag/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-20 00:00:00">2023年4月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 13 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="dram"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/">DRAM 的拓扑和训练</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/sdram.html">知识库</a>中。</p>
<h3 id="dram-training"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#dram-training">DRAM Training</a></h3>
<p>DRAM 一直有一个比较麻烦的初始化过程，就是 DRAM Training，其中很重要的一步就是计算出各个数据线相对于时钟的偏移（skew）。这个偏移是怎么来的呢？</p>
<p>我们知道，对于 SRAM，如果想要更多的位宽，只需要把地址线和控制信号连接到多个 SRAM 上，然后把 SRAM 的数据信号并行连接到 FPGA 上就可以了，但是前提是要尽量保证等长，否则一样有偏移的问题。DRAM 也是采用类似的方法进行扩展的，但是 DRAM 通常需要并行连接很多个芯片，例如 8 个 x8 的芯片的合并成一个 64 位的 DDR SDRAM。此时数据线依然是并行连接，但是地址线和控制信号就出现了走线困难：很难在那么小的空间里，等长地把地址和控制信号分布到各个芯片上，而且还有信号完整性的问题。</p>
<h3 id="fly-by-topology"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#fly-by-topology">Fly-by topology</a></h3>
<p>因此，实际上地址和控制信号是采用了串联的方式连接，也就是下图的右边的连接方式：</p>
<p><img alt="" src="/images/ddr_fly_by.png" /></p>
<p>图源 <a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Signals-and-Connections-for-DDR4-Interfaces">Versal ACAP PCB Design User Guide (UG863)</a>。</p>
<p>但是数据信号（DQ 和 DQS）依然是并行点对点连接到 DRAM 上的（上图左侧）。这就出现了问题：不同的 DRAM 芯片，数据和时钟的偏差不同，数据可能差不多时间到，但是时钟的延迟越来越大：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...."},
      { name: "data", wave: "01010"},
      { name: "clock_dram0", wave: "p....", phase: -0.1},
      { name: "clock_dram1", wave: "p....", phase: -0.2},
      { name: "clock_dram2", wave: "p....", phase: -0.3},
      { name: "clock_dram3", wave: "p....", phase: -0.4},
      { name: "clock_dram4", wave: "p....", phase: -0.5},
      { name: "clock_dram5", wave: "p....", phase: -0.6},
      { name: "clock_dram6", wave: "p....", phase: -0.7},
      { name: "clock_dram7", wave: "p....", phase: -0.8},
    ]
}</script>
<p>注：这里简化了，当成 SDR 来画。</p>
<p>不做任何处理的话，DRAM 采样得到的数据就不正确了。为了解决这个问题，就需要人为地在数据信号上也加上可变的延迟，保证时钟和数据同步，这样 DRAM 才可以实现正确的写入：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p.p.."},
      { name: "data", wave: "01010"},
      { name: "clock_dram0", wave: "p.p..", phase: -0.1},
      { name: "data_dram0", wave: "01010", phase: -0.1},
      { name: "clock_dram1", wave: "p.p..", phase: -0.2},
      { name: "data_dram1", wave: "01010", phase: -0.2},
      { name: "clock_dram2", wave: "p.p..", phase: -0.3},
      { name: "data_dram2", wave: "01010", phase: -0.3},
      { name: "clock_dram3", wave: "p.p..", phase: -0.4},
      { name: "data_dram3", wave: "01010", phase: -0.4},
    ]
}</script>
<h3 id="write-leveling"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#write-leveling">Write Leveling</a></h3>
<p>为了解决写入时，时钟和数据有偏移的问题，需要采用 Write Leveling 方法来解决。具体思路是这样的：如果 DRAM 以时钟信号去采样数据信号可以得到正确的结果，那反过来，如果认为数据信号是时钟信号，在数据信号的上升沿去采样时钟，应该也可以观测到稳定的结果。</p>
<p>所以 Write Leveling 的工作方式就是：</p>
<ol>
<li>设置 DRAM 进入 Write Leveling 模式，此时 DRAM 会使用 DQS 信号来采样 CK 信号，把结果输出到 DQ 上</li>
<li>DDR 控制器不断地修改 DQS 的输出延迟，然后统计 DQ 上的输出</li>
</ol>
<p>示意图如下：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "ck", wave: "p.p.."},
      { name: "dqs_0", wave: "010..", phase: -0.5},
      { name: "dq_0", wave: "0....", phase: -0.55},
      { name: "dqs_1", wave: "010..", phase: -0.7},
      { name: "dq_1", wave: "0....", phase: -0.75},
      { name: "dqs_2", wave: "010..", phase: -0.9},
      { name: "dq_2", wave: "01...", phase: -0.95},
      { name: "dqs_3", wave: "010..", phase: -1.1},
      { name: "dq_3", wave: "01...", phase: -1.15},
    ]
}</script>
<p>上图中，用不断增大的四种延迟的 <code>dqs</code> 对 <code>ck</code> 进行采样：用 <code>dqs_0</code> 和 <code>dqs_1</code> 采样得到了 0，用 <code>dqs_2</code> 和 <code>dqs_3</code> 采样得到了 1。把这些结果列出来，可能会得到类似下面的结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-0-1"></a>001111111111111111110000
</span></code></pre></div>
<p>也就是说，随着延迟增大，采样的数据从 0 变成 1，再从 1 变成 0。我们的目标是，让 <code>dqs</code> 和 <code>ck</code> 同步。在上图中，<code>dqs_2</code> 的上升沿和 <code>ck</code> 上升沿是最接近的，而刚好 <code>dqs_2</code> 也正好出现在采样 0 变成采样 1 的位置。这意味着，只要找到采样数据从 0 变成 1 的位置，就知道如何让 DQS 与 CK 同步了。</p>
<p>这样就完成了 Write Leveling 的步骤，实现了 DQS 与 CK 同步的目标，那么在写入数据的时候，DRAM 就可以得到正确的 DQS 信号了。</p>
<h3 id="read-leveling"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#read-leveling">Read Leveling</a></h3>
<p>在上一步的 Write Leveling 当中，通过修改内存控制器的输出延迟，保证了 DRAM 可以得到同步的 DQS 和 CK 信号，解决了 Fly by topology 引入的延迟不一致的问题。但是，对于读操作，数据从 DRAM 输出，输入到内存控制器，又会引入一定的延迟。所以对读操作，也需要进行校准。</p>
<p>回顾 SRAM，当想要测试读取功能的时候，会首先写入一些数据，再读出来，判断读取的数据和之前写入的数据是否一致。DRAM 也是类似的：先向 MPR 写入一些伪随机数据，然后要求 DRAM 从 MPR 中读取数据，而不是从 memory cell 中读取数据；然后内存控制器一侧不断进行读取操作，在不同的延迟下，比较读取的数据与预期的随机数据是否一致。最后也会得到一个延迟的区间，在这个区间内可以读取出正确的结果。最后，把延迟设定在区间的中央位置。</p>
<h3 id="clam-shell-topology"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#clam-shell-topology">Clam Shell Topology</a></h3>
<p>再回到拓扑的问题上来，实际上除了 Fly by topology，还有一种拓扑是 Clam shell topology：把 DRAM 分布在 PCB 的上面和下面，这样可以节省 PCB 的面积，但是走线就会比较困难：</p>
<p><img alt="" src="/images/ddr_clam_shell.png" /></p>
<p>图源 <a href="https://docs.xilinx.com/r/en-US/pg313-network-on-chip/Clamshell-Topology">Versal ACAP Programmable Network on Chip and Integrated Memory Controller LogiCORE IP Product Guide (PG313) </a>.</p>
<p>直观地讲，两个芯片都放在 PCB 的正面，如果要连线的话，如果保证引脚顺序接近一致，就可以比较容易地连接，不会有很多交叉的地方。但如果一个在正面，另一个在背面，引脚的顺序就倒转过来了，连线的时候就比较困难。解决的办法是，修改引脚的顺序，把一些引脚的功能进行对调，使得走线更加简单：</p>
<p><img alt="" src="/images/ddr_mirror.png" /></p>
<p>图源 <a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Utilizing-Address-Mirroring-to-Ease-Clamshell-Routing">Versal ACAP PCB Design User Guide (UG863)</a></p>
<p>这里特意挑选了一些不影响特殊功能的引脚来交换，使得大部分功能，即使交换了引脚，也可以正常工作。但是，对于 Mode Register Set 操作，必须要内存控制器自己先内部交换位的顺序，才能保证在 DRAM 一侧得到正确的结果。</p>
<p>此外，Clam Shell Topology 的正面和背面各有一个 cs_n 片选信号，但是这和 Dual Rank 不同：Dual Rank 是正面和背面都有同样数量的 DRAM 芯片，共享地址信号、数据信号和控制信号，总线上同一时间只有一侧的 DRAM 芯片在使用，好处是内存容量翻倍，并且两个 rank 可以互相掩盖延迟；而 Clam Shell Topology 的两个 cs_n 是为了给 Mode Register Set 操作指定正面或背面，而其余的大部分操作，可以正面和背面同时使用，因为它们的数据信号并没有共享。</p>
<p><img alt="" src="/images/ddr_rank.png" /></p>
<p>图源 <a href="https://blog.memory4less.com/2022/09/16/difference-between-dual-rank-and-single-rank-ram/">DIFFERENCE BETWEEN DUAL RANK AND SINGLE RANK RAM</a></p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#_1">背景</a></h3>
<p>实际上，前面的整个研究过程，来自于我对 VCU128 LiteX 移植的观察：<a href="https://github.com/litex-hub/litex-boards/issues/496">VCU128 DDR4 memory calibration failure</a>。我在配置 litedram 的时候，发现总是有一半的 DRAM 芯片无法使用，和 Datasheet 对照了以后，发现正好是 PCB 背面的那一半。接着，发现它是 Clam Shell Topology 方式来分布的，然后 Top 和 Bottom 各有一个 cs_n 信号，这一点在 UG1302 里是没有写的，在 xdc 里才可以找到：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-1"></a><span class="nv">set_property</span><span class="w"> </span>PACKAGE_PIN<span class="w"> </span>BK48<span class="w">       </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">&quot;PL_DDR4_BOT_CS_B&quot;</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L7P_T1L_N0_QBC_AD13P_66</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-2"></a><span class="nv">set_property</span><span class="w"> </span>IOSTANDARD<span class="w">  </span>SSTL12_DCI<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">&quot;PL_DDR4_BOT_CS_B&quot;</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L7P_T1L_N0_QBC_AD13P_66</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-3"></a><span class="nv">set_property</span><span class="w"> </span>PACKAGE_PIN<span class="w"> </span>BP49<span class="w">     </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">&quot;PL_DDR4_CS_B&quot;</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L1N_T0L_N1_DBC_66</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-4"></a><span class="nv">set_property</span><span class="w"> </span>IOSTANDARD<span class="w">  </span>SSTL12<span class="w">   </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">&quot;PL_DDR4_CS_B&quot;</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L1N_T0L_N1_DBC_66</span>
</span></code></pre></div>
<p>所以 Xilinx 文档也是可能出错的，需要结合多个信息源来判断。这里有 xdc 和 schematic 可以参考，都可以发现这个结论。</p>
<p>沿着这个思路，我给 litedram 添加了 clam shell topology 的支持：<a href="https://github.com/enjoy-digital/litedram/pull/332">https://github.com/enjoy-digital/litedram/pull/332</a> 和 <a href="https://github.com/enjoy-digital/litex/pull/1673">https://github.com/enjoy-digital/litex/pull/1673</a>，实现方法：</p>
<ol>
<li>在校准阶段，把 Top 和 Bottom 两个 cs_n 暴露给软件，软件在 MRS 的时候，分两次写入，第一次原样写到 Top，第二次交换地址顺序，再写入 Bottom。</li>
<li>正常工作阶段，把 Top 和 Bottom 的两个 cs_n 当成一个用，也就是当成 single rank dram。</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#_2">训练代码</a></h3>
<p>下面结合 litex 和 litedram 的代码，以及 DDR4 标准，来验证上面的观察。</p>
<h4 id="write-leveling_1"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#write-leveling_1">Write Leveling</a></h4>
<p>Write Leveling 的核心函数是 <code>sdram_write_leveling_scan</code>，它的核心思路是：</p>
<p>第一步调用 <code>sdram_write_leveling_on</code> 打开 DRAM 的 Write Leveling 模式：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-2-1"></a><span class="w">  </span><span class="n">sdram_write_leveling_on</span><span class="p">();</span>
</span></code></pre></div>
<p>循环每个 DRAM 芯片的每个 DQS 信号：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-1"></a><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SDRAM_PHY_MODULES</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-2"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dq_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">dq_line</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DQ_COUNT</span><span class="p">;</span><span class="w"> </span><span class="n">dq_line</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-3"></a><span class="w">    </span><span class="cm">/* 设置 DQS 初始延迟为 0 */</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-4"></a><span class="w">    </span><span class="n">sdram_leveling_action</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dq_line</span><span class="p">,</span><span class="w"> </span><span class="n">write_rst_delay</span><span class="p">);</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-6"></a><span class="w">    </span><span class="cm">/* 循环 DQS 延迟 */</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-7"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">err_ddrphy_wdly</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-8"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">zero_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-9"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">one_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-11"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;</span><span class="n">loops</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-12"></a><span class="w">        </span><span class="cm">/* 发送 DQS 序列：00000001 */</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-13"></a><span class="w">        </span><span class="n">ddrphy_wlevel_strobe_write</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-15"></a><span class="w">        </span><span class="cm">/* 统计 1 和 0 的个数 */</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">SDRAM_PHY_MODULES</span><span class="mi">-1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-17"></a><span class="w">          </span><span class="n">one_count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-18"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-19"></a><span class="w">          </span><span class="n">zero_count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-20"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-21"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">one_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">zero_count</span><span class="p">)</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-22"></a><span class="w">        </span><span class="cm">/* DQS 采样到了 CK 的正半周期 */</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-23"></a><span class="w">        </span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-24"></a><span class="w">      </span><span class="k">else</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-25"></a><span class="w">        </span><span class="cm">/* DQS 采样到了 CK 的负半周期 */</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-26"></a><span class="w">        </span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-27"></a>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-28"></a><span class="w">      </span><span class="cm">/* 每次循环增加一次 DQS 延迟 */</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-29"></a><span class="w">      </span><span class="n">sdram_leveling_action</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dq_line</span><span class="p">,</span><span class="w"> </span><span class="n">write_inc_delay</span><span class="p">);</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-31"></a>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-32"></a><span class="w">    </span><span class="cm">/* 找到一个最长的连续 1 的序列 */</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-33"></a><span class="w">    </span><span class="n">one_window_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-34"></a><span class="w">    </span><span class="n">one_window_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-35"></a><span class="w">    </span><span class="n">one_window_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-36"></a><span class="w">    </span><span class="n">one_window_best_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-37"></a><span class="w">    </span><span class="n">one_window_best_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-38"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">err_ddrphy_wdly</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-39"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">one_window_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">err_ddrphy_wdly</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-41"></a><span class="w">          </span><span class="cm">/* 结束了一段连续的 1 */</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-42"></a><span class="w">          </span><span class="n">one_window_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-43"></a><span class="w">          </span><span class="n">one_window_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one_window_start</span><span class="p">;</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-44"></a><span class="w">          </span><span class="cm">/* 记录最长的连续 1 的长度和位置 */</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-45"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">one_window_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">one_window_best_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-46"></a><span class="w">            </span><span class="n">one_window_best_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one_window_start</span><span class="p">;</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-47"></a><span class="w">            </span><span class="n">one_window_best_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one_window_count</span><span class="p">;</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-48"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-50"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-51"></a><span class="w">        </span><span class="cm">/* 找到连续的 1 的开头 */</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">err_ddrphy_wdly</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-53"></a><span class="w">          </span><span class="n">one_window_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-54"></a><span class="w">          </span><span class="n">one_window_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-55"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-56"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-57"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-58"></a>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-59"></a><span class="w">    </span><span class="cm">/* 要找的延迟就是连续的 1 序列的开始位置 */</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-60"></a><span class="w">    </span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one_window_best_start</span><span class="p">;</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-61"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-62"></a><span class="p">}</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-63"></a>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64" href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-64"></a><span class="n">sdram_write_leveling_off</span><span class="p">();</span>
</span></code></pre></div>
<p>这样就实现了 Write Leveling 的全流程：</p>
<ol>
<li>设置 DRAM 进入 Write Leveling 模式，DRAM 用 DQS 对 CK 采样，结果输出到 DQ</li>
<li>在不同的 DQS 延迟下，发送同样的 00000001 DQS 模式，观察 DQ 上的数据</li>
<li>统计 DQ 上的 1 和 0 的个数，如果 1 更多，就认为当前 DQS 延迟下，DQS 采样到了 CK 的正半周期；反之如果 0 更多，就认为当前 DQS 延迟下，DQS 采样到了 CK 的负半周期</li>
<li>在第三步的结果中，找到最长的连续的 1 序列，那么这个序列的开始，就对应了采样值从 0 到 1 的变化，此时 DQS 与 CK 基本同步</li>
<li>最后设置 DRAM 退出 Write Leveling 模式</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#_3">参考文档</a></h3>
<ul>
<li><a href="https://www.systemverilog.io/design/ddr4-initialization-and-calibration/">https://www.systemverilog.io/design/ddr4-initialization-and-calibration/</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Signals-and-Connections-for-DDR4-Interfaces">https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Signals-and-Connections-for-DDR4-Interfaces</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/pg353-versal-acap-soft-ddr4-mem-ip/Calibration-Overview">https://docs.xilinx.com/r/en-US/pg353-versal-acap-soft-ddr4-mem-ip/Calibration-Overview</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/pg313-network-on-chip/Clamshell-Topology">https://docs.xilinx.com/r/en-US/pg313-network-on-chip/Clamshell-Topology</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Utilizing-Address-Mirroring-to-Ease-Clamshell-Routing">https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Utilizing-Address-Mirroring-to-Ease-Clamshell-Routing</a></li>
<li><a href="https://blog.memory4less.com/2022/09/16/difference-between-dual-rank-and-single-rank-ram/">https://blog.memory4less.com/2022/09/16/difference-between-dual-rank-and-single-rank-ram/</a></li>
<li><a href="https://daffy1108.wordpress.com/2010/09/02/understanding-ddr3-write-leveling-and-read-leveling/">https://daffy1108.wordpress.com/2010/09/02/understanding-ddr3-write-leveling-and-read-leveling/</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2023/04/20/dram-topology-training/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-19 00:00:00">2023年4月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="arty-a7-litex-vexriscv-linux"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/">在 Arty A7 上用 LiteX 和 VexRiscv 跑 Linux</a></h2>
<h3 id="litex"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#litex">litex 安装</a></h3>
<p>litex 安装过程按照 <a href="https://github.com/enjoy-digital/litex/wiki/Installation">https://github.com/enjoy-digital/litex/wiki/Installation</a> 进行，由于需要 pip install，建议用 venv 来开一个干净的环境：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-1"></a>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-2"></a><span class="nb">source</span><span class="w"> </span>venv/bin/activate
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-3"></a><span class="nb">cd</span><span class="w"> </span>litex
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-4"></a>./litex_setup.py<span class="w"> </span>--init<span class="w"> </span>--install
</span></code></pre></div>
<h3 id="bitstream"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#bitstream">构建 bitstream</a></h3>
<p>litex-boards 已经内建了 Arty A7 的支持，直接运行下列命令，就可以得到 bitstream：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-1-1"></a>python3<span class="w"> </span>-m<span class="w"> </span>litex_boards.targets.digilent_arty<span class="w"> </span>--build<span class="w"> </span>--with-ethernet
</span></code></pre></div>
<p>这样就可以在 build/digilent_arty/gateware 目录下找到 bitstream。可以通过命令行参数来自定义需要的功能，详见 <a href="https://github.com/litex-hub/litex-boards/blob/f5e51d72bca6ed0325c1213791a78362326002f8/litex_boards/targets/digilent_arty.py#L162-L180">https://github.com/litex-hub/litex-boards/blob/f5e51d72bca6ed0325c1213791a78362326002f8/litex_boards/targets/digilent_arty.py#L162-L180</a>。</p>
<p>如果想切换 CPU 为 Rocket Chip 的话，克隆并安装 <a href="https://github.com/litex-hub/pythondata-cpu-rocket">https://github.com/litex-hub/pythondata-cpu-rocket</a>，添加 <code>--cpu-type rocket --cpu-variant small</code> 参数即可。</p>
<h3 id="bitstream_1"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#bitstream_1">下载 bitstream</a></h3>
<p>最后，连接 microUSB 和网线到电脑，然后下载 bitstream：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-2-1"></a>openFPGALoader<span class="w"> </span>-b<span class="w"> </span>arty<span class="w"> </span>digilent_arty.bit
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-2-2"></a>screen<span class="w"> </span>/dev/tty.usbserial-XXXXXXXXXXXXX<span class="w"> </span><span class="m">115200</span>
</span></code></pre></div>
<p>就可以看到 litex 的输出：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-1"></a>--<span class="o">===============</span><span class="w"> </span><span class="nv">SoC</span><span class="w"> </span><span class="o">==================</span>--
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-2"></a>CPU:<span class="w">            </span>VexRiscv<span class="w"> </span>@<span class="w"> </span>100MHz
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-3"></a>BUS:<span class="w">            </span>WISHBONE<span class="w"> </span><span class="m">32</span>-bit<span class="w"> </span>@<span class="w"> </span>4GiB
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-4"></a>CSR:<span class="w">            </span><span class="m">32</span>-bit<span class="w"> </span>data
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-5"></a>ROM:<span class="w">            </span><span class="m">128</span>.0KiB
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-6"></a>SRAM:<span class="w">           </span><span class="m">8</span>.0KiB
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-7"></a>L2:<span class="w">             </span><span class="m">8</span>.0KiB
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-8"></a>SDRAM:<span class="w">          </span><span class="m">256</span>.0MiB<span class="w"> </span><span class="m">16</span>-bit<span class="w"> </span>@<span class="w"> </span>800MT/s<span class="w"> </span><span class="o">(</span>CL-7<span class="w"> </span>CWL-5<span class="o">)</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-9"></a>MAIN-RAM:<span class="w">       </span><span class="m">256</span>.0MiB
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-11"></a>--<span class="o">==========</span><span class="w"> </span><span class="nv">Initialization</span><span class="w"> </span><span class="o">============</span>--
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-12"></a>Ethernet<span class="w"> </span>init...
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-13"></a>Initializing<span class="w"> </span>SDRAM<span class="w"> </span>@0x40000000...
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-14"></a>Switching<span class="w"> </span>SDRAM<span class="w"> </span>to<span class="w"> </span>software<span class="w"> </span>control.
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-15"></a>Read<span class="w"> </span>leveling:
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-16"></a><span class="w">  </span>m0,<span class="w"> </span>b00:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-17"></a><span class="w">  </span>m0,<span class="w"> </span>b01:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-18"></a><span class="w">  </span>m0,<span class="w"> </span>b02:<span class="w"> </span><span class="p">|</span><span class="m">11111111110000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">04</span>+-04
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-19"></a><span class="w">  </span>m0,<span class="w"> </span>b03:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000111111111111000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-20"></a><span class="w">  </span>m0,<span class="w"> </span>b04:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000011</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">30</span>+-00
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-21"></a><span class="w">  </span>m0,<span class="w"> </span>b05:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-22"></a><span class="w">  </span>m0,<span class="w"> </span>b06:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-23"></a><span class="w">  </span>m0,<span class="w"> </span>b07:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-24"></a><span class="w">  </span>best:<span class="w"> </span>m0,<span class="w"> </span>b03<span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-25"></a><span class="w">  </span>m1,<span class="w"> </span>b00:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-26"></a><span class="w">  </span>m1,<span class="w"> </span>b01:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-27"></a><span class="w">  </span>m1,<span class="w"> </span>b02:<span class="w"> </span><span class="p">|</span><span class="m">11111111110000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">04</span>+-04
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-28"></a><span class="w">  </span>m1,<span class="w"> </span>b03:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000111111111111000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-29"></a><span class="w">  </span>m1,<span class="w"> </span>b04:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000011</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">30</span>+-00
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-30"></a><span class="w">  </span>m1,<span class="w"> </span>b05:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-31"></a><span class="w">  </span>m1,<span class="w"> </span>b06:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-32"></a><span class="w">  </span>m1,<span class="w"> </span>b07:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-33"></a><span class="w">  </span>best:<span class="w"> </span>m1,<span class="w"> </span>b03<span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-34"></a>Switching<span class="w"> </span>SDRAM<span class="w"> </span>to<span class="w"> </span>hardware<span class="w"> </span>control.
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-35"></a>Memtest<span class="w"> </span>at<span class="w"> </span>0x40000000<span class="w"> </span><span class="o">(</span><span class="m">2</span>.0MiB<span class="o">)</span>...
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-36"></a><span class="w">  </span>Write:<span class="w"> </span>0x40000000-0x40200000<span class="w"> </span><span class="m">2</span>.0MiB
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-37"></a><span class="w">   </span>Read:<span class="w"> </span>0x40000000-0x40200000<span class="w"> </span><span class="m">2</span>.0MiB
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-38"></a>Memtest<span class="w"> </span>OK
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-39"></a>Memspeed<span class="w"> </span>at<span class="w"> </span>0x40000000<span class="w"> </span><span class="o">(</span>Sequential,<span class="w"> </span><span class="m">2</span>.0MiB<span class="o">)</span>...
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-40"></a><span class="w">  </span>Write<span class="w"> </span>speed:<span class="w"> </span><span class="m">37</span>.0MiB/s
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-41"></a><span class="w">   </span>Read<span class="w"> </span>speed:<span class="w"> </span><span class="m">48</span>.7MiB/s
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-42"></a>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-43"></a>--<span class="o">==============</span><span class="w"> </span><span class="nv">Boot</span><span class="w"> </span><span class="o">==================</span>--
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-44"></a>Booting<span class="w"> </span>from<span class="w"> </span>serial...
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-45"></a>Press<span class="w"> </span>Q<span class="w"> </span>or<span class="w"> </span>ESC<span class="w"> </span>to<span class="w"> </span>abort<span class="w"> </span>boot<span class="w"> </span>completely.
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-46"></a>sL5DdSMmkekro
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-47"></a>Timeout
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-48"></a>Booting<span class="w"> </span>from<span class="w"> </span>network...
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-49"></a>Local<span class="w"> </span>IP:<span class="w"> </span><span class="m">192</span>.168.1.50
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-50"></a>Remote<span class="w"> </span>IP:<span class="w"> </span><span class="m">192</span>.168.1.100
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-51"></a>Booting<span class="w"> </span>from<span class="w"> </span>boot.json...
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-52"></a>Booting<span class="w"> </span>from<span class="w"> </span>boot.bin...
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-53"></a>Copying<span class="w"> </span>boot.bin<span class="w"> </span>to<span class="w"> </span>0x40000000...
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-54"></a>Network<span class="w"> </span>boot<span class="w"> </span>failed.
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-55"></a>No<span class="w"> </span>boot<span class="w"> </span>medium<span class="w"> </span>found
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-56"></a>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-57"></a>--<span class="o">=============</span><span class="w"> </span><span class="nv">Console</span><span class="w"> </span><span class="o">================</span>--
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-58"></a>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-59"></a>litex&gt;<span class="w"> </span>
</span></code></pre></div>
<p>可见是非常方便的。之后可以用 litex_term 来往里面传程序，也可以直接通过 TFTP 来传。</p>
<h3 id="linux"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#linux">启动 Linux</a></h3>
<p>接下来，可以使用项目 <a href="https://github.com/litex-hub/linux-on-litex-vexriscv">https://github.com/litex-hub/linux-on-litex-vexriscv</a> 来启动 Linux。参考项目 README，编译 Linux 并启动。不想折腾的话，可以从 <a href="https://github.com/litex-hub/linux-on-litex-vexriscv/issues/164">https://github.com/litex-hub/linux-on-litex-vexriscv/issues/164</a> 下载编译好的结果。</p>
<p>首先克隆项目到本地，然后运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-4-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/litex-hub/linux-on-litex-vexriscv.git
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-4-2"></a><span class="nb">cd</span><span class="w"> </span>linux-on-litex-vexriscv
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-4-3"></a>./make.py<span class="w"> </span>--board<span class="o">=</span>arty
</span></code></pre></div>
<p>这样就生成了 bitstream，接下来构建 Linux 和 rootfs：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-1"></a>git<span class="w"> </span>clone<span class="w"> </span>http://github.com/buildroot/buildroot
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-2"></a><span class="nb">cd</span><span class="w"> </span>buildroot
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-3"></a>make<span class="w"> </span><span class="nv">BR2_EXTERNAL</span><span class="o">=</span>../linux-on-litex-vexriscv/buildroot/<span class="w"> </span>litex_vexriscv_defconfig
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-4"></a>make
</span></code></pre></div>
<p>再构建 OpenSBI：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/litex-hub/opensbi<span class="w"> </span>--branch<span class="w"> </span><span class="m">0</span>.8-linux-on-litex-vexriscv
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-2"></a><span class="nb">cd</span><span class="w"> </span>opensbi
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-3"></a><span class="c1">## riscv32-unknown-elf toolchain is built by ct-ng</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-4"></a>make<span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>riscv32-unknown-elf-<span class="w"> </span><span class="nv">PLATFORM</span><span class="o">=</span>litex/vexriscv
</span></code></pre></div>
<p>但是实践过程中发现 ct-ng 编译的是 hardfloat 工具链，而默认配置下 vexriscv 不带 FPU，所以编译时用的是 rv32ima 作为 target，链接的时候报错，最后就直接用编译好的版本。</p>
<p>最后得到如下的几个文件：</p>
<ul>
<li>boot.json: linux-on-litex-vexriscv/images/boot.json</li>
<li>rv32.dtb: linux-on-litex-vexriscv/images/rv32.dtb</li>
<li>Image: buildroot/output/images/Image</li>
<li>rootfs.cpio: buildroot/output/images/rootfs.cpio</li>
<li>opensbi.bin</li>
</ul>
<p>把这些文件复制到 TFTP 服务的目录下，重新 Program linux-on-litex-vexriscv/build/arty/gateware/arty.bit，即可启动 Linux：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-1"></a>--============== Boot ==================--
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-2"></a>Booting from serial...
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-3"></a>Press Q or ESC to abort boot completely.
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-4"></a>sL5DdSMmkekro
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-5"></a>Timeout
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-6"></a>Booting from SDCard in SD-Mode...
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-7"></a>Booting from boot.json...
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-8"></a>Booting from boot.bin...
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-9"></a>SDCard boot failed.
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-10"></a>Booting from network...
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-11"></a>Local IP: 192.168.1.50
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-12"></a>Remote IP: 192.168.1.100
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-13"></a>Booting from boot.json...
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-14"></a>Copying Image to 0x40000000... (7726264 bytes)
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-15"></a>Copying rv32.dtb to 0x40ef0000... (5294 bytes)
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-16"></a>Copying rootfs.cpio to 0x41000000... (3566592 bytes)
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-17"></a>Copying opensbi.bin to 0x40f00000... (53640 bytes)
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-18"></a>Executing booted program at 0x40f00000
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-20"></a>--============= Liftoff! ===============--
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-21"></a>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-22"></a>OpenSBI v0.8-1-gecf7701
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-23"></a>   ____                    _____ ____ _____
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-24"></a>  / __ \                  / ____|  _ \_   _|
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-25"></a> | |  | |_ __   ___ _ __ | (___ | |_) || |
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-26"></a> | |  | | &#39;_ \ / _ \ &#39;_ \ \___ \|  _ &lt; | |
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-27"></a> | |__| | |_) |  __/ | | |____) | |_) || |_
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-28"></a>  \____/| .__/ \___|_| |_|_____/|____/_____|
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-29"></a>        | |
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-30"></a>        |_|
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-31"></a>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-32"></a>Platform Name       : LiteX / VexRiscv-SMP
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-33"></a>Platform Features   : timer,mfdeleg
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-34"></a>Platform HART Count : 8
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-35"></a>Boot HART ID        : 0
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-36"></a>Boot HART ISA       : rv32imas
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-37"></a>BOOT HART Features  : time
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-38"></a>BOOT HART PMP Count : 0
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-39"></a>Firmware Base       : 0x40f00000
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-40"></a>Firmware Size       : 124 KB
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-41"></a>Runtime SBI Version : 0.2
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-42"></a>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-43"></a>MIDELEG : 0x00000222
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-44"></a>MEDELEG : 0x0000b101
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-45"></a>[    0.000000] Linux version 6.1.0-rc2 (jiegec@linux) (riscv32-buildroot-linux-gnu-gcc.br_real (Buildroot 2023.02-270-gb100440bff) 11.3.0, GNU ld (GNU Binutils) 2.38) #1 SMP Wed Apr 19 16:21:39 CST 2023
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-46"></a>[    0.000000] earlycon: liteuart0 at I/O port 0x0 (options &#39;&#39;)
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-47"></a>[    0.000000] Malformed early option &#39;console&#39;
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-48"></a>[    0.000000] earlycon: liteuart0 at MMIO 0xf0001000 (options &#39;&#39;)
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-49"></a>[    0.000000] printk: bootconsole [liteuart0] enabled
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-50"></a>[    0.000000] Zone ranges:
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-51"></a>[    0.000000]   Normal   [mem 0x0000000040000000-0x000000004fffffff]
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-52"></a>[    0.000000] Movable zone start for each node
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-53"></a>[    0.000000] Early memory node ranges
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-54"></a>[    0.000000]   node   0: [mem 0x0000000040000000-0x000000004fffffff]
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-55"></a>[    0.000000] Initmem setup node 0 [mem 0x0000000040000000-0x000000004fffffff]
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-56"></a>[    0.000000] SBI specification v0.2 detected
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-57"></a>[    0.000000] SBI implementation ID=0x1 Version=0x8
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-58"></a>[    0.000000] SBI TIME extension detected
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-59"></a>[    0.000000] SBI IPI extension detected
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-60"></a>[    0.000000] SBI RFENCE extension detected
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-61"></a>[    0.000000] SBI HSM extension detected
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-62"></a>[    0.000000] riscv: base ISA extensions aim
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-63"></a>[    0.000000] riscv: ELF capabilities aim
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-64"></a>[    0.000000] percpu: Embedded 8 pages/cpu s11732 r0 d21036 u32768
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-65"></a>[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 65024
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-66"></a>[    0.000000] Kernel command line: console=liteuart earlycon=liteuart,0xf0001000 rootwait root=/dev/ram0
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-67"></a>[    0.000000] Dentry cache hash table entries: 32768 (order: 5, 131072 bytes, linear)
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-68"></a>[    0.000000] Inode-cache hash table entries: 16384 (order: 4, 65536 bytes, linear)
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-69"></a>[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-70"></a>[    0.000000] Memory: 243336K/262144K available (5848K kernel code, 571K rwdata, 906K rodata, 215K init, 254K bss, 18808K reserved, 0K cma-reserved)
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-71"></a>[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-72"></a>[    0.000000] rcu: Hierarchical RCU implementation.
</span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-73"></a>[    0.000000] rcu:     RCU restricting CPUs from NR_CPUS=32 to nr_cpu_ids=1.
</span><span id="__span-7-74"><a id="__codelineno-7-74" name="__codelineno-7-74" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-74"></a>[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 25 jiffies.
</span><span id="__span-7-75"><a id="__codelineno-7-75" name="__codelineno-7-75" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-75"></a>[    0.000000] rcu: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
</span><span id="__span-7-76"><a id="__codelineno-7-76" name="__codelineno-7-76" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-76"></a>[    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0
</span><span id="__span-7-77"><a id="__codelineno-7-77" name="__codelineno-7-77" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-77"></a>[    0.000000] riscv-intc: 32 local interrupts mapped
</span><span id="__span-7-78"><a id="__codelineno-7-78" name="__codelineno-7-78" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-78"></a>[    0.000000] plic: interrupt-controller@f0c00000: mapped 32 interrupts with 1 handlers for 2 contexts.
</span><span id="__span-7-79"><a id="__codelineno-7-79" name="__codelineno-7-79" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-79"></a>[    0.000000] rcu: srcu_init: Setting srcu_struct sizes based on contention.
</span><span id="__span-7-80"><a id="__codelineno-7-80" name="__codelineno-7-80" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-80"></a>[    0.000000] riscv-timer: riscv_timer_init_dt: Registering clocksource cpuid [0] hartid [0]
</span><span id="__span-7-81"><a id="__codelineno-7-81" name="__codelineno-7-81" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-81"></a>[    0.000000] clocksource: riscv_clocksource: mask: 0xffffffffffffffff max_cycles: 0x171024e7e0, max_idle_ns: 440795205315 ns
</span><span id="__span-7-82"><a id="__codelineno-7-82" name="__codelineno-7-82" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-82"></a>[    0.000018] sched_clock: 64 bits at 100MHz, resolution 10ns, wraps every 4398046511100ns
</span><span id="__span-7-83"><a id="__codelineno-7-83" name="__codelineno-7-83" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-83"></a>[    0.010246] Console: colour dummy device 80x25
</span><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-84"></a>[    0.014169] Calibrating delay loop (skipped), value calculated using timer frequency.. 200.00 BogoMIPS (lpj=400000)
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-85"></a>[    0.024255] pid_max: default: 32768 minimum: 301
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-86"></a>[    0.033262] Mount-cache hash table entries: 1024 (order: 0, 4096 bytes, linear)
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-87"></a>[    0.039790] Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes, linear)
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-88"></a>[    0.080128] ASID allocator using 9 bits (512 entries)
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-89"></a>[    0.086947] rcu: Hierarchical SRCU implementation.
</span><span id="__span-7-90"><a id="__codelineno-7-90" name="__codelineno-7-90" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-90"></a>[    0.090826] rcu:     Max phase no-delay instances is 1000.
</span><span id="__span-7-91"><a id="__codelineno-7-91" name="__codelineno-7-91" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-91"></a>[    0.103556] smp: Bringing up secondary CPUs ...
</span><span id="__span-7-92"><a id="__codelineno-7-92" name="__codelineno-7-92" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-92"></a>[    0.107186] smp: Brought up 1 node, 1 CPU
</span><span id="__span-7-93"><a id="__codelineno-7-93" name="__codelineno-7-93" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-93"></a>[    0.118798] devtmpfs: initialized
</span><span id="__span-7-94"><a id="__codelineno-7-94" name="__codelineno-7-94" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-94"></a>[    0.169571] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns
</span><span id="__span-7-95"><a id="__codelineno-7-95" name="__codelineno-7-95" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-95"></a>[    0.178637] futex hash table entries: 256 (order: 2, 16384 bytes, linear)
</span><span id="__span-7-96"><a id="__codelineno-7-96" name="__codelineno-7-96" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-96"></a>[    0.214981] NET: Registered PF_NETLINK/PF_ROUTE protocol family
</span><span id="__span-7-97"><a id="__codelineno-7-97" name="__codelineno-7-97" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-97"></a>[    0.455944] pps_core: LinuxPPS API ver. 1 registered
</span><span id="__span-7-98"><a id="__codelineno-7-98" name="__codelineno-7-98" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-98"></a>[    0.460007] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti &lt;giometti@linux.it&gt;
</span><span id="__span-7-99"><a id="__codelineno-7-99" name="__codelineno-7-99" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-99"></a>[    0.469508] PTP clock support registered
</span><span id="__span-7-100"><a id="__codelineno-7-100" name="__codelineno-7-100" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-100"></a>[    0.476324] FPGA manager framework
</span><span id="__span-7-101"><a id="__codelineno-7-101" name="__codelineno-7-101" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-101"></a>[    0.493464] clocksource: Switched to clocksource riscv_clocksource
</span><span id="__span-7-102"><a id="__codelineno-7-102" name="__codelineno-7-102" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-102"></a>[    0.722433] NET: Registered PF_INET protocol family
</span><span id="__span-7-103"><a id="__codelineno-7-103" name="__codelineno-7-103" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-103"></a>[    0.731210] IP idents hash table entries: 4096 (order: 3, 32768 bytes, linear)
</span><span id="__span-7-104"><a id="__codelineno-7-104" name="__codelineno-7-104" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-104"></a>[    0.752236] tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 4096 bytes, linear)
</span><span id="__span-7-105"><a id="__codelineno-7-105" name="__codelineno-7-105" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-105"></a>[    0.760269] Table-perturb hash table entries: 65536 (order: 6, 262144 bytes, linear)
</span><span id="__span-7-106"><a id="__codelineno-7-106" name="__codelineno-7-106" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-106"></a>[    0.767834] TCP established hash table entries: 2048 (order: 1, 8192 bytes, linear)
</span><span id="__span-7-107"><a id="__codelineno-7-107" name="__codelineno-7-107" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-107"></a>[    0.775654] TCP bind hash table entries: 2048 (order: 3, 32768 bytes, linear)
</span><span id="__span-7-108"><a id="__codelineno-7-108" name="__codelineno-7-108" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-108"></a>[    0.783026] TCP: Hash tables configured (established 2048 bind 2048)
</span><span id="__span-7-109"><a id="__codelineno-7-109" name="__codelineno-7-109" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-109"></a>[    0.789689] UDP hash table entries: 256 (order: 1, 8192 bytes, linear)
</span><span id="__span-7-110"><a id="__codelineno-7-110" name="__codelineno-7-110" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-110"></a>[    0.795620] UDP-Lite hash table entries: 256 (order: 1, 8192 bytes, linear)
</span><span id="__span-7-111"><a id="__codelineno-7-111" name="__codelineno-7-111" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-111"></a>[    0.816406] Unpacking initramfs...
</span><span id="__span-7-112"><a id="__codelineno-7-112" name="__codelineno-7-112" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-112"></a>[    0.926651] workingset: timestamp_bits=30 max_order=16 bucket_order=0
</span><span id="__span-7-113"><a id="__codelineno-7-113" name="__codelineno-7-113" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-113"></a>[    1.186672] io scheduler mq-deadline registered
</span><span id="__span-7-114"><a id="__codelineno-7-114" name="__codelineno-7-114" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-114"></a>[    1.190309] io scheduler kyber registered
</span><span id="__span-7-115"><a id="__codelineno-7-115" name="__codelineno-7-115" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-115"></a>[    1.570624] No litex,nclkout entry in the dts file
</span><span id="__span-7-116"><a id="__codelineno-7-116" name="__codelineno-7-116" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-116"></a>[    1.607895] LiteX SoC Controller driver initialized
</span><span id="__span-7-117"><a id="__codelineno-7-117" name="__codelineno-7-117" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-117"></a>[    2.358518] Initramfs unpacking failed: invalid magic at start of compressed archive
</span><span id="__span-7-118"><a id="__codelineno-7-118" name="__codelineno-7-118" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-118"></a>[    2.448554] Freeing initrd memory: 8192K
</span><span id="__span-7-119"><a id="__codelineno-7-119" name="__codelineno-7-119" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-119"></a>[    3.423827] f0001000.serial: ttyLXU0 at MMIO 0x0 (irq = 0, base_baud = 0) is a liteuart
</span><span id="__span-7-120"><a id="__codelineno-7-120" name="__codelineno-7-120" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-120"></a>[    3.431446] printk: console [liteuart0] enabled
</span><span id="__span-7-121"><a id="__codelineno-7-121" name="__codelineno-7-121" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-121"></a>[    3.431446] printk: console [liteuart0] enabled
</span><span id="__span-7-122"><a id="__codelineno-7-122" name="__codelineno-7-122" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-122"></a>[    3.440068] printk: bootconsole [liteuart0] disabled
</span><span id="__span-7-123"><a id="__codelineno-7-123" name="__codelineno-7-123" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-123"></a>[    3.440068] printk: bootconsole [liteuart0] disabled
</span><span id="__span-7-124"><a id="__codelineno-7-124" name="__codelineno-7-124" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-124"></a>[    3.499884] liteeth f0002000.mac eth0: irq 2 slots: tx 2 rx 2 size 2048
</span><span id="__span-7-125"><a id="__codelineno-7-125" name="__codelineno-7-125" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-125"></a>[    3.510055] i2c_dev: i2c /dev entries driver
</span><span id="__span-7-126"><a id="__codelineno-7-126" name="__codelineno-7-126" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-126"></a>[    3.520573] i2c i2c-0: Not I2C compliant: can&#39;t read SCL
</span><span id="__span-7-127"><a id="__codelineno-7-127" name="__codelineno-7-127" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-127"></a>[    3.525314] i2c i2c-0: Bus may be unreliable
</span><span id="__span-7-128"><a id="__codelineno-7-128" name="__codelineno-7-128" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-128"></a>[    3.577560] litex-mmc f0009000.mmc: LiteX MMC controller initialized.
</span><span id="__span-7-129"><a id="__codelineno-7-129" name="__codelineno-7-129" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-129"></a>[    3.623272] NET: Registered PF_INET6 protocol family
</span><span id="__span-7-130"><a id="__codelineno-7-130" name="__codelineno-7-130" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-130"></a>[    3.653652] Segment Routing with IPv6
</span><span id="__span-7-131"><a id="__codelineno-7-131" name="__codelineno-7-131" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-131"></a>[    3.657870] In-situ OAM (IOAM) with IPv6
</span><span id="__span-7-132"><a id="__codelineno-7-132" name="__codelineno-7-132" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-132"></a>[    3.662630] sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver
</span><span id="__span-7-133"><a id="__codelineno-7-133" name="__codelineno-7-133" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-133"></a>[    3.683817] NET: Registered PF_PACKET protocol family
</span><span id="__span-7-134"><a id="__codelineno-7-134" name="__codelineno-7-134" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-134"></a>[    3.699016] Freeing unused kernel image (initmem) memory: 208K
</span><span id="__span-7-135"><a id="__codelineno-7-135" name="__codelineno-7-135" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-135"></a>[    3.704055] Kernel memory protection not selected by kernel config.
</span><span id="__span-7-136"><a id="__codelineno-7-136" name="__codelineno-7-136" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-136"></a>[    3.710506] Run /init as init process
</span><span id="__span-7-137"><a id="__codelineno-7-137" name="__codelineno-7-137" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-137"></a>Starting syslogd: OK
</span><span id="__span-7-138"><a id="__codelineno-7-138" name="__codelineno-7-138" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-138"></a>Starting klogd: OK
</span><span id="__span-7-139"><a id="__codelineno-7-139" name="__codelineno-7-139" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-139"></a>Running sysctl: OK
</span><span id="__span-7-140"><a id="__codelineno-7-140" name="__codelineno-7-140" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-140"></a>Saving 256 bits of non-creditable seed for next boot
</span><span id="__span-7-141"><a id="__codelineno-7-141" name="__codelineno-7-141" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-141"></a>Starting network: OK
</span><span id="__span-7-142"><a id="__codelineno-7-142" name="__codelineno-7-142" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-142"></a>
</span><span id="__span-7-143"><a id="__codelineno-7-143" name="__codelineno-7-143" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-143"></a>Welcome to Buildroot
</span><span id="__span-7-144"><a id="__codelineno-7-144" name="__codelineno-7-144" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-144"></a>buildroot login: root
</span><span id="__span-7-145"><a id="__codelineno-7-145" name="__codelineno-7-145" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-145"></a>                   __   _
</span><span id="__span-7-146"><a id="__codelineno-7-146" name="__codelineno-7-146" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-146"></a>                  / /  (_)__  __ ____ __
</span><span id="__span-7-147"><a id="__codelineno-7-147" name="__codelineno-7-147" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-147"></a>                 / /__/ / _ \/ // /\ \ /
</span><span id="__span-7-148"><a id="__codelineno-7-148" name="__codelineno-7-148" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-148"></a>                /____/_/_//_/\_,_//_\_\
</span><span id="__span-7-149"><a id="__codelineno-7-149" name="__codelineno-7-149" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-149"></a>                      / _ \/ _ \
</span><span id="__span-7-150"><a id="__codelineno-7-150" name="__codelineno-7-150" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-150"></a>   __   _ __      _  _\___/_//_/         ___  _
</span><span id="__span-7-151"><a id="__codelineno-7-151" name="__codelineno-7-151" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-151"></a>  / /  (_) /____ | |/_/__| | / /____ __ / _ \(_)__ _____  __
</span><span id="__span-7-152"><a id="__codelineno-7-152" name="__codelineno-7-152" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-152"></a> / /__/ / __/ -_)&gt;  &lt;/___/ |/ / -_) \ // , _/ (_-&lt;/ __/ |/ /
</span><span id="__span-7-153"><a id="__codelineno-7-153" name="__codelineno-7-153" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-153"></a>/____/_/\__/\__/_/|_|____|___/\__/_\_\/_/|_/_/___/\__/|___/
</span><span id="__span-7-154"><a id="__codelineno-7-154" name="__codelineno-7-154" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-154"></a>                  / __/  |/  / _ \
</span><span id="__span-7-155"><a id="__codelineno-7-155" name="__codelineno-7-155" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-155"></a>                 _\ \/ /|_/ / ___/
</span><span id="__span-7-156"><a id="__codelineno-7-156" name="__codelineno-7-156" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-156"></a>                /___/_/  /_/_/
</span><span id="__span-7-157"><a id="__codelineno-7-157" name="__codelineno-7-157" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-157"></a>  32-bit RISC-V Linux running on LiteX / VexRiscv-SMP.
</span><span id="__span-7-158"><a id="__codelineno-7-158" name="__codelineno-7-158" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-158"></a>
</span><span id="__span-7-159"><a id="__codelineno-7-159" name="__codelineno-7-159" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-159"></a>login[70]: root login on &#39;console&#39;
</span><span id="__span-7-160"><a id="__codelineno-7-160" name="__codelineno-7-160" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-160"></a>root@buildroot:~# 
</span></code></pre></div>
<p>Linux 中也可以访问网络（通过主线内的 liteeth 驱动）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-1"></a>$<span class="w"> </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>liteeth
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-2"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.499861<span class="o">]</span><span class="w"> </span>liteeth<span class="w"> </span>f0002000.mac<span class="w"> </span>eth0:<span class="w"> </span>irq<span class="w"> </span><span class="m">2</span><span class="w"> </span>slots:<span class="w"> </span>tx<span class="w"> </span><span class="m">2</span><span class="w"> </span>rx<span class="w"> </span><span class="m">2</span><span class="w"> </span>size<span class="w"> </span><span class="m">2048</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-3"></a>$<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>eth0<span class="w"> </span>up
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-4"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.1.50/24<span class="w"> </span>dev<span class="w"> </span>eth0
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-5"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.1.100
</span></code></pre></div>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#_1">其他开发板</a></h3>
<p>除了 Digilent Arty A7，我还做了以下开发板的 LiteX 支持：</p>
<ul>
<li><a href="https://github.com/jiegec/litex-boards/tree/vcu128">VCU128</a>，支持 UART，SDRAM 和 HBM；以太网因为是 SGMII 暂时无法解决</li>
<li><a href="https://github.com/jiegec/litex-boards/tree/ma703fa-35t">MA703FA-35T</a>，支持 UART，SDRAM，ETH、SD 卡和 HDMI；MA703FA-35T 的文档中 TF_DAT3 引脚绑定有误，AB12 应该改为 AB20</li>
<li><a href="https://github.com/jiegec/litex-boards/tree/alinx_ax7021">Alinx AX7021</a>，支持 UART over JTAG 和 HDMI</li>
<li><a href="https://lab.cs.tsinghua.edu.cn/digital-design/doc/hardware/board/">THU Digital Design</a>，基于 @gaoyichuan 的实现，支持 UART，SDRAM，ETH，SD 卡和 VGA</li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2023/04/19/litex-digilent-arty-a7/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-14 00:00:00">2023年4月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/programming/" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="cc"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/">C/C++ 数参数个数的特别方法</a></h2>
<h3 id="_1"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#_1">背景</a></h3>
<p>群友上个月提了一个未知来源问题：</p>
<p>实现一个你自己的 <code>printf(int, ...)</code> 函数，该函数包含可变参数。为简便期间，假设所有参数均为 int 类型。</p>
<ol>
<li>第一个参数是一个普通参数，不表示后续可变参数的数目</li>
<li>在 printf 中逐个输出所有传入的整数值（可使用系统自带的 kprintf 实现输出）</li>
<li>思考如何判定参数结束，是否有副作用</li>
</ol>
<h3 id="va_args"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#va_args">va_args</a></h3>
<p>我们知道，传统的处理可变参数的方法是 va_args，但是它无法知道传入了多少参数，而要像 POSIX printf 那样，解析 format 参数，然后一个一个去取。</p>
<p>所以问题的关键是，如何获取参数的个数？一个思路是宏，尝试用宏的魔法来计算出参数个数，这个方法可能是可以的，但是没有深究。另一个思路是利用 ABI 的特点，例如 i386 上参数是通过栈传递的，那或许可以在栈上找到所有的 int，但是问题是无法确认参数在哪里结束。</p>
<h3 id="__builtin_va_arg_pack_len"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#__builtin_va_arg_pack_len">__builtin_va_arg_pack_len</a></h3>
<p>今天，另一位群友发了一个链接：<a href="https://gcc.gnu.org/onlinedocs/gcc/Constructing-Calls.html#Constructing-Calls">https://gcc.gnu.org/onlinedocs/gcc/Constructing-Calls.html#Constructing-Calls</a>，讲述了 GCC 中一些特别的 builtin 函数，用于函数调用相关的魔法，其中一段描述吸引了我的眼球：</p>
<div class="language-text highlight"><pre><span></span><code>Built-in Function: int __builtin_va_arg_pack_len ()

This built-in function returns the number of anonymous arguments of an
inline function. It can be used only in inline functions that are always
inlined, never compiled as a separate function, such as those using
__attribute__ ((__always_inline__)) or __attribute__ ((__gnu_inline__))
extern inline functions. For example following does link- or run-time
checking of open arguments for optimized code:
</code></pre></div>
<p>这正好实现了前面提到的获取参数个数，实现思路也可以想到，就是编译器在 inline 的时候，顺便做了一次替换。也因此，这个函数必须被 inline，不能正常调用。有了这个思路以后，经过一番尝试，写入了下面的代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-2"></a><span class="cp">##include &lt;stdarg.h&gt;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">my_printf_inner</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-5"></a><span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-6"></a><span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-9"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-11"></a><span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-12"></a><span class="p">}</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-14"></a><span class="n">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">__always_inline__</span><span class="p">))</span><span class="w"> </span><span class="kr">inline</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-15"></a><span class="kt">void</span><span class="w"> </span><span class="n">my_printf</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__builtin_va_arg_pack_len</span><span class="p">();</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-17"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-18"></a><span class="w">    </span><span class="n">my_printf_inner</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">__builtin_va_arg_pack</span><span class="p">());</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-19"></a><span class="p">}</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-21"></a><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-22"></a><span class="w">    </span><span class="n">my_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个代码在 GCC 中可以正确地输出 1-10 的十个数字。我一开始尝试的时候，把循环也写到 <code>my_printf</code> 函数中，但是 GCC 的 inline 就罢工了，最后只好拆成两个函数，把不知道参数个数的问题，转化成知道参数的问题，剩下就好解决了。</p>
<p>最后生成的汇编如下：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-1"></a><span class="nl">main:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-2"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-3"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-4"></a><span class="w">        </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-5"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-4</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-6"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-8</span><span class="p">],</span><span class="w"> </span><span class="mi">9</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-7"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-4</span><span class="p">]</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-8"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-9"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edi</span><span class="p">,</span><span class="w"> </span><span class="no">OFFSET</span><span class="w"> </span><span class="no">FLAT</span><span class="p">:.</span><span class="no">LC0</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-10"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-11"></a><span class="w">        </span><span class="nf">call</span><span class="w">    </span><span class="no">printf</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-12"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-8</span><span class="p">]</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-13"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">10</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-14"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">9</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-15"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">8</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-16"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">7</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-17"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">r9d</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-18"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">r8d</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-19"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-20"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-21"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-22"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edi</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-23"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-24"></a><span class="w">        </span><span class="nf">call</span><span class="w">    </span><span class="no">my_printf_inner</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-25"></a><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-26"></a><span class="w">        </span><span class="nf">nop</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-27"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-28"></a><span class="w">        </span><span class="nf">leave</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-29"></a><span class="w">        </span><span class="nf">ret</span>
</span></code></pre></div>
<p>可以看到，它 inline 了 <code>my_printf</code> 的实现，先调用了第一个 <code>printf</code>，然后把剩下的参数个数 <code>9</code> 赋值给了 <code>edi</code>，剩下就是正常的传参了。</p>
<p>以上实验都在 Godbolt Compiler Explorer 中进行：<a href="https://godbolt.org/z/KjYzETn5Y">https://godbolt.org/z/KjYzETn5Y</a>。</p>
<p>继续挖掘，会发现在 libc 中出现了 __builtin_va_arg_pack_len 的身影，在 fcntl2.h 中：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-1"></a><span class="n">__errordecl</span><span class="w"> </span><span class="p">(</span><span class="n">__open_too_many_args</span><span class="p">,</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-2"></a><span class="w">             </span><span class="s">&quot;open can be called either with 2 or 3 arguments, not more&quot;</span><span class="p">);</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-3"></a><span class="n">__errordecl</span><span class="w"> </span><span class="p">(</span><span class="n">__open_missing_mode</span><span class="p">,</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-4"></a><span class="w">             </span><span class="s">&quot;open with O_CREAT or O_TMPFILE in second argument needs 3 arguments&quot;</span><span class="p">);</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-6"></a><span class="n">__fortify_function</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-7"></a><span class="n">open</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__oflag</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-8"></a><span class="p">{</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-9"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__va_arg_pack_len</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-10"></a><span class="w">    </span><span class="n">__open_too_many_args</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-12"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_constant_p</span><span class="w"> </span><span class="p">(</span><span class="n">__oflag</span><span class="p">))</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-14"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__OPEN_NEEDS_MODE</span><span class="w"> </span><span class="p">(</span><span class="n">__oflag</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">__va_arg_pack_len</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-15"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-16"></a><span class="w">          </span><span class="n">__open_missing_mode</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-17"></a><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">__open_2</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">);</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-19"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">__open_alias</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">,</span><span class="w"> </span><span class="n">__va_arg_pack</span><span class="w"> </span><span class="p">());</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-22"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__va_arg_pack_len</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__open_2</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">);</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-25"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">__open_alias</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">,</span><span class="w"> </span><span class="n">__va_arg_pack</span><span class="w"> </span><span class="p">());</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它核心的思想就是根据 open 第三个参数的有无，调用相应的 <code>__open_2</code> 或者 <code>__open_alias</code> 函数，这样就不用再用 <code>va_args</code> 方法了，并且如果传入了过多的参数，可以直接在编译期指出错误。例子：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-1"></a><span class="cp">##include &lt;fcntl.h&gt;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-4"></a><span class="w">    </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>报错：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-1"></a><span class="n">In</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">301</span><span class="p">,</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-2"></a><span class="w">                 </span><span class="n">from</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">2</span><span class="o">:</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-3"></a><span class="n">In</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">&#39;</span><span class="n">open</span><span class="err">&#39;</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-4"></a><span class="w">    </span><span class="n">inlined</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">&#39;</span><span class="n">main</span><span class="err">&#39;</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">5</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-5"></a><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">bits</span><span class="o">/</span><span class="n">fcntl2</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">&#39;</span><span class="n">__open_too_many_args</span><span class="err">&#39;</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">more</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-6"></a><span class="w">   </span><span class="mi">44</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">__open_too_many_args</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-7"></a><span class="w">      </span><span class="o">|</span><span class="w">     </span><span class="o">^~~~~~~~~~~~~~~~~~~~~~~</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-8"></a><span class="n">ASM</span><span class="w"> </span><span class="n">generation</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">returned</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-9"></a><span class="n">In</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">301</span><span class="p">,</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-10"></a><span class="w">                 </span><span class="n">from</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">2</span><span class="o">:</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-11"></a><span class="n">In</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">&#39;</span><span class="n">open</span><span class="err">&#39;</span><span class="p">,</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-12"></a><span class="w">    </span><span class="n">inlined</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">&#39;</span><span class="n">main</span><span class="err">&#39;</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">5</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-13"></a><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">bits</span><span class="o">/</span><span class="n">fcntl2</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">&#39;</span><span class="n">__open_too_many_args</span><span class="err">&#39;</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">more</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-14"></a><span class="w">   </span><span class="mi">44</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">__open_too_many_args</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-15"></a><span class="w">      </span><span class="o">|</span><span class="w">     </span><span class="o">^~~~~~~~~~~~~~~~~~~~~~~</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-16"></a><span class="n">Execution</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">returned</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
<p>Compiler Explorer:<a href="https://godbolt.org/z/hebshz3P5">https://godbolt.org/z/hebshz3P5</a>.</p>
<h3 id="c"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#c">使用 C 宏</a></h3>
<p>和 Claude 聊了一下，是否能够用 C 宏来实现，它的回答是：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-1"></a><span class="cp">##define PRINTF(...) printf(__VA_ARGS__)</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-2"></a><span class="cp">##define NARG(...)  (sizeof((int[]){__VA_ARGS__})/sizeof(int))</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">printf</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-5"></a><span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-6"></a><span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">);</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-7"></a>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-8"></a><span class="w">    </span><span class="c1">// Access the variable arguments using va_arg based on </span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-9"></a><span class="w">    </span><span class="c1">// the number of arguments passed, obtained using NARG</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-11"></a><span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-12"></a><span class="p">}</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-13"></a>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-14"></a><span class="c1">// Usage:</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-15"></a><span class="n">PRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w">     </span><span class="c1">// Prints 1 2 3 </span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-16"></a><span class="n">PRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// Prints 1 2 3 4</span>
</span></code></pre></div>
<p>核心思路就是把参数列表放到数组里，然后让编译器去推断数组大小。沿着这个思路，实现出代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-2"></a><span class="cp">##include &lt;stdarg.h&gt;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">my_printf_inner</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-5"></a><span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-6"></a><span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-9"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-11"></a><span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-12"></a><span class="p">}</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-14"></a><span class="cp">##define MY_PRINTF(...) do {int len=(sizeof((int[]){__VA_ARGS__})/sizeof(int)); my_printf_inner(len, __VA_ARGS__); } while(0);</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-16"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-17"></a><span class="w">    </span><span class="n">MY_PRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-19"></a><span class="p">}</span>
</span></code></pre></div>
<p>也是可以工作的。Compiler Explorer 链接：<a href="https://godbolt.org/z/TxKb3YEcf">https://godbolt.org/z/TxKb3YEcf</a>。</p>
<h3 id="chatgpt"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#chatgpt">ChatGPT</a></h3>
<p>尝试询问了一下 ChatGPT：<a href="https://shareg.pt/IXUKjYK">https://shareg.pt/IXUKjYK</a>，它可以写出额外传入 int 个数的版本，可以写出哨兵（传入 <code>-1</code> 表示结束）的版本，提示了 builtin 以后，再提示 inline 和 always_inline，最后让它拆分成两个函数，得到的代码距离正确结果已经比较接近，但还是有一些问题。</p>

    <nav class="md-post__action">
      <a href="../../programming/2023/04/14/counting-arguments/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-10 00:00:00">2023年4月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sco-openserver-600"><a class="toclink" href="../../system/2023/04/10/sco6/">SCO OpenServer 6.0.0 虚拟机安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/04/10/sco6/#_1">安装过程</a></h3>
<p>首先从 <a href="https://www.sco.com/support/update/download/product.php?pfid=12&amp;prid=20">https://www.sco.com/support/update/download/product.php?pfid=12&amp;prid=20</a> 下载 SCO OpenServer 的安装 ISO。尝试过用 QEMU 启动，但是会卡在无法读取硬盘的错误上。</p>
<p>最后使用 VirtualBox 7.0.6 成功启动，注意创建虚拟机的时候不要给太多内存，例如 4GB 就起不来，2GB 可以。硬盘我也只给了 4GB 的空间。</p>
<p>安装过程中会询问 License number 和 License code，可以选择使用 Evaluation License，或者使用下面参考文档中提供的 License。按照流程一直走就可以了。如果重启出现无法 mount root 的问题，就 poweroff 再开机。</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/04/10/sco6/#_2">参考文档</a></h3>
<p>本博客参考了以下文档中的命令：</p>
<ul>
<li><a href="https://virtuallyfun.com/2020/11/21/fun-with-openserver-6-and-mergepro/">https://virtuallyfun.com/2020/11/21/fun-with-openserver-6-and-mergepro/</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../system/2023/04/10/sco6/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-10 00:00:00">2023年4月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="unixware-714"><a class="toclink" href="../../system/2023/04/10/unixware7/">UnixWare 7.1.4 虚拟机安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/04/10/unixware7/#_1">安装过程</a></h3>
<p>在 <a href="https://www.sco.com/support/update/download/product.php?pfid=1&amp;prid=6">https://www.sco.com/support/update/download/product.php?pfid=1&amp;prid=6</a> 可以看到 UnixWare 7.1.4 的相关下载，其中首先要下载 UnixWare 的安装 ISO：<a href="https://www.sco.com/support/update/download/release.php?rid=346">https://www.sco.com/support/update/download/release.php?rid=346</a>，尝试过用 QEMU 启动，会遇到找不到 CD-ROM 的问题，虽然通过设置 <code>ATAPI_DMA_DISABLE=YES</code> 解决了，但是又遇到了找不到硬盘的问题。</p>
<p>最后换成了 VirtualBox 7.0.6。用 VirtualBox 创建虚拟机的时候，不要给太多内存，4GB 就会无法启动，2GB 可以，硬盘也不要给太多，4GB 就足够。</p>
<p>剩下就是按照安装界面一路默认即可，License 可以选择 Defer，使用 Evaluation License。</p>
<p>关机以后，修改启动顺序，把硬盘放到 CD 前，然后启动，就可以进入系统了。如果重启出现无法 mount root 的问题，就 poweroff 再开机。</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/04/10/unixware7/#_2">参考文档</a></h3>
<p>本博客参考了以下文档中的命令：</p>
<ul>
<li><a href="https://virtuallyfun.com/2018/01/31/revisiting-a-unixware-7-1-1-install-on-qemu-kvm/">https://virtuallyfun.com/2018/01/31/revisiting-a-unixware-7-1-1-install-on-qemu-kvm/</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../system/2023/04/10/unixware7/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-09 00:00:00">2023年4月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="aix-72"><a class="toclink" href="../../system/2023/04/09/aix/">AIX 7.2 虚拟机安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/04/09/aix/#_1">安装过程</a></h3>
<p>宿主机环境是 Debian bookworm，不需要像其他教程那样自己编译 qemu，直接 apt install 即可。</p>
<p>通过 google 可以搜索到 AIX 7.2 的 ISO，下载第一个 ISO 到本地，然后在 QEMU 中启动安装镜像：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2023/04/09/aix/#__codelineno-0-1"></a>qemu-img<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>qcow2<span class="w"> </span>aix-hdd.qcow2<span class="w"> </span>20G
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../system/2023/04/09/aix/#__codelineno-0-2"></a>qemu-system-ppc64<span class="w"> </span>-cpu<span class="w"> </span>POWER8<span class="w"> </span>-machine<span class="w"> </span>pseries<span class="w"> </span>-m<span class="w"> </span><span class="m">16384</span><span class="w"> </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>aix-hdd.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-device<span class="w"> </span>virtio-scsi-pci,id<span class="o">=</span>scsi<span class="w"> </span>-device<span class="w"> </span>scsi-hd,drive<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-cdrom<span class="w"> </span>aix_7200-04-02-2027_1of2_072020.iso<span class="w"> </span>-prom-env<span class="w"> </span>boot-command<span class="o">=</span><span class="s1">&#39;boot cdrom:\ppc\chrp\bootfile.exe&#39;</span><span class="w"> </span>-display<span class="w"> </span>none
</span></code></pre></div>
<p>进去以后，耐心等待，直到进入安装界面，按照提示进行安装，建议安装上 SSH Server，关掉图形界面，这样安装会比较快。安装需要几十分钟，安装完成后会进入 bootloop，关掉 QEMU。接着，准备好网络：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../system/2023/04/09/aix/#__codelineno-1-1"></a>sudo<span class="w"> </span>ip<span class="w"> </span>tuntap<span class="w"> </span>add<span class="w"> </span>tap0<span class="w"> </span>mode<span class="w"> </span>tap
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../system/2023/04/09/aix/#__codelineno-1-2"></a>sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>tap0<span class="w"> </span>up
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../system/2023/04/09/aix/#__codelineno-1-3"></a>sudo<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.2.15/24<span class="w"> </span>dev<span class="w"> </span>tap0
</span></code></pre></div>
<p>再启动虚拟机，注意启动选项修改了，并且多了网络的配置：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../system/2023/04/09/aix/#__codelineno-2-1"></a>qemu-system-ppc64<span class="w"> </span>-cpu<span class="w"> </span>POWER8<span class="w"> </span>-machine<span class="w"> </span>pseries<span class="w"> </span>-m<span class="w"> </span><span class="m">16384</span><span class="w"> </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>aix-hdd.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-device<span class="w"> </span>virtio-scsi-pci,id<span class="o">=</span>scsi<span class="w"> </span>-device<span class="w"> </span>scsi-hd,drive<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-cdrom<span class="w"> </span>aix_7200-04-02-2027_1of2_072020.iso<span class="w"> </span>-prom-env<span class="w"> </span>boot-command<span class="o">=</span><span class="s1">&#39;boot disk:&#39;</span><span class="w"> </span>-display<span class="w"> </span>none<span class="w"> </span>-net<span class="w"> </span>nic<span class="w"> </span>-net<span class="w"> </span>tap,script<span class="o">=</span>no,ifname<span class="o">=</span>tap0
</span></code></pre></div>
<p>第一次启动系统时，会进入配置界面，修改好 root 密码，然后配置网络：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../system/2023/04/09/aix/#__codelineno-3-1"></a>chdev<span class="w"> </span>-l<span class="w"> </span>en0<span class="w"> </span>-a<span class="w"> </span><span class="nv">netaddr</span><span class="o">=</span><span class="m">10</span>.0.2.16<span class="w"> </span>-a<span class="w"> </span><span class="nv">netmask</span><span class="o">=</span><span class="m">255</span>.255.255.0<span class="w"> </span>-a<span class="w"> </span><span class="nv">state</span><span class="o">=</span>up
</span></code></pre></div>
<p>到这里了以后，就可以通过 ssh 访问虚拟机：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../system/2023/04/09/aix/#__codelineno-4-1"></a>ssh<span class="w"> </span>root@10.0.2.16
</span></code></pre></div>
<h3 id="kvm"><a class="toclink" href="../../system/2023/04/09/aix/#kvm">KVM</a></h3>
<p>另外测试了一下，在 powerpc64 机器上，可以开启 KVM 来加速 QEMU，但是需要首先关掉 SMT。另外在使用过程中出现了玄学问题，最后还是在 x86 上跑了虚拟机。</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/04/09/aix/#_2">安装软件</a></h3>
<p>接下来，可以从 <a href="https://www.ibm.com/support/pages/node/882892">AIX Toolbox for Open Source Software</a> 安装软件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../system/2023/04/09/aix/#__codelineno-5-1"></a><span class="c1">## in aix</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../system/2023/04/09/aix/#__codelineno-5-2"></a>chfs<span class="w"> </span>-a<span class="w"> </span><span class="nv">size</span><span class="o">=</span>+200M<span class="w"> </span>/home
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../system/2023/04/09/aix/#__codelineno-5-3"></a>chfs<span class="w"> </span>-a<span class="w"> </span><span class="nv">size</span><span class="o">=</span>+400M<span class="w"> </span>/opt
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../system/2023/04/09/aix/#__codelineno-5-4"></a>chfs<span class="w"> </span>-a<span class="w"> </span><span class="nv">size</span><span class="o">=</span>+400M<span class="w"> </span>/tmp
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../system/2023/04/09/aix/#__codelineno-5-5"></a><span class="c1">## setup default gateway</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../system/2023/04/09/aix/#__codelineno-5-6"></a>route<span class="w"> </span>add<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span>.0.2.15<span class="w"> </span>-if<span class="w"> </span>en0
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../system/2023/04/09/aix/#__codelineno-5-7"></a><span class="c1">## edit /etc/resolv.conf</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../system/2023/04/09/aix/#__codelineno-5-8"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;nameserver 1.1.1.1&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/resolv.conf
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../system/2023/04/09/aix/#__codelineno-5-9"></a><span class="c1">## in host</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../system/2023/04/09/aix/#__codelineno-5-10"></a>wget<span class="w"> </span>https://public.dhe.ibm.com/aix/freeSoftware/aixtoolbox/ezinstall/ppc/dnf_aixtoolbox.sh
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../system/2023/04/09/aix/#__codelineno-5-11"></a>scp<span class="w"> </span>dnf_aixtoolbox.sh<span class="w"> </span>root@10.0.2.16:/
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../system/2023/04/09/aix/#__codelineno-5-12"></a><span class="c1">## in aix</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../system/2023/04/09/aix/#__codelineno-5-13"></a>rpm<span class="w"> </span>--rebuilddb
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../system/2023/04/09/aix/#__codelineno-5-14"></a>ksh<span class="w"> </span>/dnf_aixtoolbox.sh<span class="w"> </span>-y
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../system/2023/04/09/aix/#__codelineno-5-15"></a>/opt/freeware/bin/dnf<span class="w"> </span>update
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../system/2023/04/09/aix/#__codelineno-5-16"></a>/opt/freeware/bin/dnf<span class="w"> </span>install<span class="w"> </span>gcc
</span></code></pre></div>
<p>安装好的包会放到 /opt/freeware 路径下。</p>
<p>安装过程中可能需要继续扩大各个 fs 的大小。</p>
<p>dnf 如果提示缺少 <code>libssl.a</code>，参考 <a href="https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors">https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors</a> 进行解决：</p>
<ol>
<li>
<p>访问 <a href="https://www.ibm.com/resources/mrs/assets?source=aixbp&amp;S_PKG=openssl">https://www.ibm.com/resources/mrs/assets?source=aixbp&amp;S_PKG=openssl</a> 下载安装包，例如 <code>openssl-1.1.2.2000.tar.Z</code>。</p>
</li>
<li>
<p>scp 到 AXI 上安装：</p>
</li>
</ol>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../system/2023/04/09/aix/#__codelineno-6-1"></a>uncompress<span class="w"> </span>openssl-1.1.2.2000.tar.Z
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../system/2023/04/09/aix/#__codelineno-6-2"></a>tar<span class="w"> </span>-xvf<span class="w"> </span>openssl-1.1.2.2000.tar
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../system/2023/04/09/aix/#__codelineno-6-3"></a><span class="c1">## install openssl.base using smitty</span>
</span></code></pre></div>
<p>为了方便，可以修改 <code>/etc/environment</code> 文件，把 <code>/opt/freeware/bin</code> 目录加到 PATH 目录中。</p>
<h3 id="_3"><a class="toclink" href="../../system/2023/04/09/aix/#_3">参考文档</a></h3>
<p>本博客参考了以下文档中的命令：</p>
<ul>
<li><a href="https://aix4admins.blogspot.com/2020/04/qemu-aix-on-x86-qemu-quick-emulator-is.html">https://aix4admins.blogspot.com/2020/04/qemu-aix-on-x86-qemu-quick-emulator-is.html</a></li>
<li><a href="https://virtuallyfun.com/2019/04/22/installing-aix-on-qemu/">https://virtuallyfun.com/2019/04/22/installing-aix-on-qemu/</a></li>
<li><a href="https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors">https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../system/2023/04/09/aix/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-09 00:00:00">2023年4月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sco-openserver-507"><a class="toclink" href="../../system/2023/04/09/sco5/">SCO OpenServer 5.0.7 虚拟机安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/04/09/sco5/#_1">安装过程</a></h3>
<p>首先从 <a href="https://www.sco.com/support/update/download/release.php?rid=218">https://www.sco.com/support/update/download/release.php?rid=218</a> 下载 SCO OpenServer 的安装 ISO 和从 <a href="https://www.sco.com/support/update/download/release.php?rid=187">https://www.sco.com/support/update/download/release.php?rid=187</a> 下载 Supplement CD 5 ISO，然后用 QEMU 启动，这次需要用图形界面：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2023/04/09/sco5/#__codelineno-0-1"></a>qemu-system-i386<span class="w"> </span>-accel<span class="w"> </span>kvm<span class="w"> </span>-m<span class="w"> </span><span class="m">16384</span><span class="w"> </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>sco-hdd.qcow2,if<span class="o">=</span>ide<span class="w"> </span>-cdrom<span class="w"> </span>../../ISOs/OpenServer-5.0.7Hw-10Jun05_1800.iso
</span></code></pre></div>
<p>安装过程中会询问 License number 和 License code，按照 <a href="https://virtuallyfun.com/2020/11/03/fun-with-openserver-and-merge/">https://virtuallyfun.com/2020/11/03/fun-with-openserver-and-merge/</a> 进行输入。</p>
<p>安装的时候，在 hard disk setup 那一步，记得关掉 bad tracking，否则会把整个盘扫一遍，我一开始建了 20GB 的 qcow2，结果这一步跑了一晚上，而且把 qcow2 撑满了。</p>
<p>安装后，重新启动，这次打开网络，同时挂载 Supplement CD 5 ISO：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../system/2023/04/09/sco5/#__codelineno-1-1"></a>qemu-system-i386<span class="w"> </span>-accel<span class="w"> </span>kvm<span class="w"> </span>-m<span class="w"> </span><span class="m">16384</span><span class="w"> </span>-serial<span class="w"> </span>chardev:mouse<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>sco-hdd.qcow2,if<span class="o">=</span>ide<span class="w"> </span>-cdrom<span class="w"> </span>osr507suppcd5.iso<span class="w"> </span>-net<span class="w"> </span>nic<span class="w"> </span>-net<span class="w"> </span>tap,script<span class="o">=</span>no,ifname<span class="o">=</span>tap0<span class="w"> </span>-chardev<span class="w"> </span>msmouse,id<span class="o">=</span>mouse
</span></code></pre></div>
<p>启动以后，运行 custom 命令，然后从 CD-ROM 安装 Graphics and NIC Drivers。我尝试了安装 Maintenance Pack 5，但是启动以后会找不到硬盘，只好恢复之前的 qcow2 备份。可能是缺少了运行 <code>/etc/conf/cf.d/link_unix</code> 命令。</p>
<p>为了让图形界面的鼠标工作，在命令行里运行 <code>mkdev mouse</code>，然后创建一个 Serial mouse -&gt; Microsoft Serial Mouse，Relink kernel 再重启。注意要和 QEMU 的 <code>-serial chardev:mouse -chardev msmouse,id=mouse</code> 配合。但是外面鼠标和里面鼠标移动的距离不一样。</p>
<p>然后运行 <code>netconfig</code> 命令，添加 LAN adapter，选择 Intel 网卡，然后退出，Relink kernel 然后重启，就可以访问网络了。可以用 <code>ifconfig net0 10.0.2.16</code> 设置 IP 地址， <code>route add default 10.0.2.15</code> 来设置默认路由。可以通过降低安全性，兼容老系统来 SSH：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../system/2023/04/09/sco5/#__codelineno-2-1"></a>ssh<span class="w"> </span>-oCiphers<span class="o">=</span>aes128-cbc<span class="w"> </span>-oHostKeyAlgorithms<span class="o">=</span>ssh-rsa<span class="w"> </span>-oKexAlgorithms<span class="o">=</span>+diffie-hellman-group1-sha1<span class="w"> </span>root@10.0.2.16
</span></code></pre></div>
<p>类似地，scp 也要带上上面的参数，再打开 <code>-O</code> 模式。</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/04/09/sco5/#_2">安装软件</a></h3>
<p>OpenServer 有自带的工具链：挂载安装 ISO，使用 custom 命令安装 OpenServer Development System 和 SCO OpenServer Linker and Application Development Libraries。但是需要 License 才能使用。</p>
<p>另一个方法是通过 FTP 访问 <a href="ftp://ftp2.sco.com/pub/skunkware/osr5/vols/">ftp://ftp2.sco.com/pub/skunkware/osr5/vols/</a>，可以看到一些软件的安装包，在里面下载软件并安装。例如，要安装 gcc：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../system/2023/04/09/sco5/#__codelineno-3-1"></a>wget<span class="w"> </span>ftp://ftp2.sco.com/pub/skunkware/osr5/vols/gcc-2.95.2-VOLS.tar
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../system/2023/04/09/sco5/#__codelineno-3-2"></a>scp<span class="w"> </span>-r<span class="w"> </span>-O<span class="w"> </span>-oCiphers<span class="o">=</span>aes128-cbc<span class="w"> </span>-oHostKeyAlgorithms<span class="o">=</span>ssh-rsa<span class="w"> </span>-oKexAlgorithms<span class="o">=</span>+diffie-hellman-group1-sha1<span class="w"> </span>gcc-2.95.2-VOLS.tar<span class="w"> </span>root@10.0.2.16:/
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../system/2023/04/09/sco5/#__codelineno-3-3"></a><span class="c1">## in sco5</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../system/2023/04/09/sco5/#__codelineno-3-4"></a>tar<span class="w"> </span>xf<span class="w"> </span>gcc-2.95.2-VOLS.tar
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../system/2023/04/09/sco5/#__codelineno-3-5"></a><span class="c1">## Install from Media Images</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../system/2023/04/09/sco5/#__codelineno-3-6"></a>custom
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../system/2023/04/09/sco5/#__codelineno-3-7"></a>/usr/local/bin/gcc<span class="w"> </span>--version
</span></code></pre></div>
<p>依法炮制，可以安装 gcc、bash、make、git 等常用软件，只不过版本都很老。</p>
<h3 id="virtualbox"><a class="toclink" href="../../system/2023/04/09/sco5/#virtualbox">VirtualBox</a></h3>
<p>测试了一下，在 VirtualBox 7.0.6 中，可以正常安装 SCO OpenServer 5，不需要额外的设置，按照上面一样的方法进行安装即可，鼠标选择 PS/2 Microsoft Mouse，和 QEMU 一样有移动距离不对的情况。安装完，把硬盘启动顺序调到前面，重启即可。</p>
<p>网卡的话，照常 <code>netconfig</code>，然后添加 AMD PCNet 网卡即可。</p>
<h3 id="_3"><a class="toclink" href="../../system/2023/04/09/sco5/#_3">参考文档</a></h3>
<p>本博客参考了以下文档中的命令：</p>
<ul>
<li><a href="https://virtuallyfun.com/2020/11/03/fun-with-openserver-and-merge/">https://virtuallyfun.com/2020/11/03/fun-with-openserver-and-merge/</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../system/2023/04/09/sco5/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-07 00:00:00">2023年4月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ram"><a class="toclink" href="../../hardware/2023/04/07/ram-read-write-collision/">RAM 读写冲突</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/07/ram-read-write-collision/#_1">背景</a></h3>
<p>在 FPGA 或者 ASIC 中，通常都需要使用 RAM，通过读口、写口或者读写口来进行访问。常见的配置有单读写口（1RW），一读一写（1R1W）等等，读口通常有 1 个周期的延时。那么，如果在同一个周期内，读口和写口访问了同一个地址，会发生什么呢？可能会想到几种情况：</p>
<ol>
<li>读和写都失败，读出的数据未定义，数据没写进去</li>
<li>数据写进去了，读出的数据未定义</li>
<li>数据写进去了，读出了写之前的旧数据</li>
<li>数据写进去了，读出了同一个周期写入的新数据</li>
</ol>
<p>下面以具体的例子来看看，实际情况是什么样子。</p>
<h3 id="xilinx-fpga"><a class="toclink" href="../../hardware/2023/04/07/ram-read-write-collision/#xilinx-fpga">Xilinx FPGA</a></h3>
<p>首先测试的是 Xilinx FPGA 上的 RAM，测试的对象是 XPM，统一设置读延迟为一个周期，使用 Vivado 仿真。</p>
<h4 id="_2"><a class="toclink" href="../../hardware/2023/04/07/ram-read-write-collision/#_2">一读一写</a></h4>
<p>首先测试一读一写，也就是 xpm_memory_sdpram 模块。模块支持三种模式：NO_CHANGE（默认值）、READ_FIRST 和 WRITE_FIRST，因此我例化了三份，输入一样的信号，设置为三种不同的模式，然后比较输出结果。为了简化，读写使用一个时钟。下面是测试的波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p...."},
      { name: "w_addr", wave: "2....", data: ["0000"]},
      { name: "w_data", wave: "2x2xx", data: ["1111", "2222"]},
      { name: "w_en", wave: "1010."},
      { name: "r_addr", wave: "2....", data: ["0000"]},
      { name: "r_en", wave: "0.1.0"},
      { name: "r_data_no_change", wave: "xxx22", data: ["xxxx", "2222"]},
      { name: "r_data_read_first", wave: "xxx22", data: ["1111", "2222"]},
      { name: "r_data_write_first", wave: "xxx22", data: ["xxxx", "2222"]},
    ]
}</script>
<p>图中第一个周期向地址 0 写入了 1111，然后第三个周期同时读写地址 0 的数据，此时 NO_CHANGE 和 WRITE_FIRST 两种模式中，写入成功，读取失败；READ_FIRST 模式读取成功，并且读取的是写入之前的数据。第四个周期时，读写没有出现冲突，三种模式都可以读出写入的新数据。</p>
<p>这有些出乎我的意料：之前在很多地方用过 XPM，但是都没考虑过读写地址相同的情况，而且默认设置（NO_CHANGE）下，输出结果是不确定的。实际上这个行为在 PG058 Block Memory Generator 里面提到了：</p>
<ul>
<li>Synchronous Write-Read Collisions: A synchronous Write-Read collision might occur if a port attempts to Write a memory location and the other port reads the same location. While memory contents are not corrupted in Write-Read collisions, the validity of the output data depends on the Write port operating mode.</li>
<li>If the Write port is in READ_FIRST mode, the other port can reliably read the old memory contents.</li>
<li>If the Write port is in WRITE_FIRST or NO_CHANGE mode, data on the output of the Read port is invalid.</li>
<li>In the case of byte-writes, only updated bytes are invalid on the Read port output.</li>
</ul>
<p>与上面观察到的结果基本吻合，另外这里提到了带 Mask 的情况：即使是 WRITE_FIRST 或者 NO_CHANGE，也可以读出没写入的那部分（即 WEA[i] = 0）旧的数据。</p>
<p>对此，Xilinx 的建议是：</p>
<div class="language-text highlight"><pre><span></span><code>For Synchronous Clocking and during a collision, the Write mode of port A
can be configured so that a Read operation on port B either produces data
(acting like READ_FIRST), or produces undefined data (Xs). For this reason,
it is always advised to use READ_FIRST when configured as a Simple Dual-port
RAM. For asynchronous clocking, Xilinx recommends setting the Write mode of
Port A to WRITE_FIRST for collision safety.
</code></pre></div>
<p>也就是说同步时钟用 READ_FIRST，异步时钟用 WRITE_FIRST。甚至 Vivado 还可以贴心地帮你设置：</p>
<div class="language-text highlight"><pre><span></span><code>For 7 series devices, the selected operating mode is passed to the block RAM
when the RAM_MODE is set to TDP. For the primitives with RAM_MODE set to
SDP, the write mode is READ_FIRST for synchronous clocking and WRITE_FIRST
for asynchronous clocking.
</code></pre></div>
<p>但是 XPM 似乎就没有这个设定了，而是由用户来传入。</p>
<p>而对于异步时钟，文档直接说不要让冲突发生：</p>
<div class="language-text highlight"><pre><span></span><code>Using asynchronous clocks, when one port writes data to a memory location,
the other port must not Read or Write that location for a specified amount
of time.
</code></pre></div>
<p>这点似乎经常被我们忽略。</p>
<p>那么，如果在 Verilog 中实现一个语义上 WRITE_FIRST 的 RAM，会发生什么呢：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-1"></a><span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ps</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-2"></a><span class="k">module</span><span class="w"> </span><span class="n">mem_1r1w</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-3"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-4"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">R0_addr</span><span class="p">,</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-5"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">R0_en</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-6"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">R0_data</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-7"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">W0_addr</span><span class="p">,</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-8"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">W0_en</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-9"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">W0_data</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-10"></a><span class="p">);</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-12"></a><span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_R0_addr</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-13"></a><span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-15"></a><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">W0_en</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-17"></a><span class="w">      </span><span class="n">mem</span><span class="p">[</span><span class="n">W0_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">W0_data</span><span class="p">;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-18"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-19"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-21"></a><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">R0_en</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-23"></a><span class="w">      </span><span class="n">reg_R0_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">R0_addr</span><span class="p">;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-24"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-25"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-26"></a>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-27"></a><span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">R0_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">reg_R0_addr</span><span class="p">];</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-28"></a>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-0-29"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>奇怪的是，综合出来会使用 BRAM 实现，并且采用 READ_FIRST 作为 RAMB36E1 的 WRITE_MODE_A 和 WRITE_MODE_B。如果写成语义 READ_FIRST：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-1"></a><span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ps</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-2"></a><span class="k">module</span><span class="w"> </span><span class="n">mem_1r1w</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-3"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-4"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">R0_addr</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-5"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">R0_en</span><span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-6"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">R0_data</span><span class="p">,</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-7"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">W0_addr</span><span class="p">,</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-8"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">W0_en</span><span class="p">,</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-9"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">W0_data</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-10"></a><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-12"></a><span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_R0_data</span><span class="p">;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-13"></a><span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-15"></a><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">W0_en</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-17"></a><span class="w">      </span><span class="n">mem</span><span class="p">[</span><span class="n">W0_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">W0_data</span><span class="p">;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-18"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-19"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-20"></a>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-21"></a><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">R0_en</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-23"></a><span class="w">      </span><span class="n">reg_R0_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">R0_addr</span><span class="p">];</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-24"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-25"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-27"></a><span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">R0_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg_R0_data</span><span class="p">;</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-28"></a>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../hardware/2023/04/07/ram-read-write-collision/#__codelineno-1-29"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>会发现生成的 RAMB36E1 原语的 WRITE_MODE 依然是 READ_FIRST。经过测试发现，如果综合的时候用两个时钟信号，就会用 WRITE_FIRST；如果用了一个，就会用 READ_FIRST，与语义无关。所以如果依赖 Vivado 的 infer RAM，得到的结果和预期可能不一致，和前面的文档一致：<code>For the primitives with RAM_MODE set to SDP, the write mode is READ_FIRST for synchronous clocking and WRITE_FIRST for asynchronous clocking.</code>。</p>
<p>又额外测试了一下 yosys：<code>yosys mem_1r1w.v -p "synth_xilinx"</code>，结果发现 yosys 会忠实地按照语义为 WRITE_FIRST 生成 bypass 逻辑。虽然 yosys 可以做的更好：把识别出来的 READ_FIRST 或 WRITE_FIRST 传给 RAMB36E1，但 yosys 至少尊重了代码。</p>
<h4 id="_3"><a class="toclink" href="../../hardware/2023/04/07/ram-read-write-collision/#_3">一读写</a></h4>
<p>接下来测试单读写口的场景。单读写口和上面不同，它的冲突点在于，写入的时候，读取的数据如何变化。下面用同样的方法，测试三种模式下 xpm_memory_spram 的行为，得到如下波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p......"},
      { name: "rw_addr", wave: "2...2..", data: ["0000", "0001"]},
      { name: "rw_wdata", wave: "2..22..", data: ["1111", "2222", "3333"]},
      { name: "rw_en", wave: "101...."},
      { name: "rw_we", wave: "10.1..."},
      { name: "ram[0]", wave: "x2..2..", data: ["1111", "2222"]},
      { name: "ram[1]", wave: "2....2.", data: ["0000", "3333"]},
      { name: "rw_rdata_no_change", wave: "xxx2...", data: ["1111"]},
      { name: "rw_rdata_read_first", wave: "xxx2.22", data: ["1111", "0000", "3333"]},
      { name: "rw_rdata_write_first", wave: "x2..22.", data: ["1111", "2222", "3333"]},
    ]
}</script>
<p>这个结果就比较有意思了，三种模式得到了三种不同的结果。第一个周期依然是写入 1111 到地址 0，然后 WRITE_FIRST 模式的输出结果第二个周期跟着变，就好像在写的时候同时也在读，只不过读取的结果就是最后一次写入的结果。第三个周期读取地址 0 的数据，然后第四个周期写入 2222 到地址 0，此时三种情况的读取都得到了写入前的值（也就是 1111）。第五个周期 WRITE_FIRST 模式的输出跟着变成了 2222，和预期一致。同时第五个周期写入 3333 到地址 1，接着第六个周期的时候，READ_FIRST 出现了 0000，实际上是读取了地址 1 的旧数据，也就是写入前的数据，而 WRITE_FIRST 更新为了 3333，也就是新写入的数据；NO_CHANGE 则是保持了最后一次读取的结果。</p>
<p>简单总结一下上面的现象，就是：</p>
<ul>
<li>NO_CHANGE：顾名思义，写的时候 rdata 不变，只有在读的下一个周期才会变</li>
<li>WRITE_FIRST：写的同时也在读，只不过读取的是写入的新数据</li>
<li>READ_FIRST：写的同时也在读，只不过读取的是写入前的旧数据</li>
</ul>
<p>关于这个行为，在 <a href="https://xilinx.eetrend.com/blog/2020/100055273.html">RAM IP Core 中 Write First Read First 和 No Change 的区别</a> 处可以看到比较清晰的解释。</p>
<h3 id="sram-ip"><a class="toclink" href="../../hardware/2023/04/07/ram-read-write-collision/#sram-ip">SRAM IP</a></h3>
<p>接下来在仿真中看看 SRAM IP 的行为是什么样子。SRAM IP 有一个引脚 COLLDISN，其语义为：</p>
<ul>
<li>如果 COLLDISN 为 1，那么如果出现读写冲突，那么写入是被保证的，但是读取会失败</li>
<li>如果 COLLDISN 为 0，那么如果出现读写冲突，读写都会失败</li>
</ul>
<p>仿真得到如下波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p......."},
      { name: "w_addr", wave: "2.......", data: ["0000"]},
      { name: "w_data", wave: "2x...2x.", data: ["1111", "2222"]},
      { name: "w_en", wave: "10...10."},
      { name: "r_addr", wave: "2.......", data: ["0000"]},
      { name: "r_en", wave: "0.10.1.0"},
      { name: "mem_colldisn_0[0]", wave: "x2....2.", data: ["1111", "xxxx"]},
      { name: "r_data_colldisn_0", wave: "xxx2..2.", data: ["1111", "xxxx"]},
      { name: "mem_colldisn_1[0]", wave: "x2....2.", data: ["1111", "2222"]},
      { name: "r_data_colldisn_1", wave: "xxx2..22", data: ["1111", "xxxx", "2222"]},
    ]
}</script>
<p>第一个周期没有读写冲突，所以成功写入，第三个周期也可以正确地都出来。第六个周期读写冲突，此时如果 COLLDISN 等于 0，那么读写都失败，下一个周期读取结果是 xxxx，并且之后继续读取依然是 xxxx，因为内存中的数据被破坏了；而如果 COLLDISN 等于 1，那么写入成功，内存中的值变为 2222，但读取失败，下一个周期读取结果是 xxxx，但是再下一个周期就可以正常读取，得到 2222。</p>
<p>这就与 Xilinx FPGA 不一样：这里如果 COLLDISN 等于 0，读写冲突的时候，可能写入会失效，内存中的值变为不确定的内容。所以为了保证正确性，要么在 SRAM IP 外部进行读写冲突检查，如果要冲突了，就关掉读口，然后从写口 bypass 数据到读口；要么在 SRAM IP 内部进行读写冲突检查（设置 COLLDISN 等于 1），然后不要使用冲突时读取的数据。</p>
<h3 id="chisel"><a class="toclink" href="../../hardware/2023/04/07/ram-read-write-collision/#chisel">Chisel</a></h3>
<p>Chisel 中 RAM 对应的是 SyncReadMem，它可以指定 Read under Write behavior：</p>
<ul>
<li><code>SyncReadMem()</code>: unspecified in FIRRTL, <code>WriteFirst</code> in behavior model</li>
<li><code>SyncReadMem(Undefined)</code>: unspecified in FIRRTL, <code>WriteFirst</code> in behavior model</li>
<li><code>SyncReadMem(ReadFirst)</code>: <code>old</code> in FIRRTL, <code>ReadFirst</code> in behavior model</li>
<li><code>SyncReadMem(WriteFirst)</code>: <code>new</code> in FIRRTL, <code>WriteFirst</code> in behavior model</li>
</ul>
<p>也就是说，在行为级模型中，只有 WriteFirst 和 ReadFirst 两种行为，并且默认是 <code>WriteFirst</code>。但是，前面也提到，实际上 XPM 只支持 <code>Undefined</code>（生成 <code>x</code>）和 <code>ReadFirst</code>（READ_FIRST）两种；上面的 SRAM IP 更是只支持 <code>Undefined</code>（生成 <code>x</code>）。</p>
<p>这就导致写 Chisel 代码的时候，如果不小心用了 1R1W，并且代码依赖了 Read Under Write 在行为级模型下的行为，那么在使用 XPM 或者 SRAM IP 进行替换的时候，就需要额外的逻辑来处理这个不同。例如，如果要模拟 <code>WriteFirst</code>，就比较地址，然后进行 bypass；但是 <code>ReadFirst</code> 就没办法模拟了。最好的解决方法还是，不要出现冲突，即使要冲突，也要在上层进行处理。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/04/07/ram-read-write-collision/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-04 00:00:00">2023年4月4日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="firtool"><a class="toclink" href="../../hardware/2023/04/04/firtool/">firtool 尝试</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/04/firtool/#_1">背景</a></h3>
<p>Chisel 3.6 很快就要发布了（目前最新版本是 3.6.0-RC2），这个大版本的主要更新内容就是引入了 CIRCT 的 firtool 作为 FIRRTL 到 Verilog 的转换流程：</p>
<div class="language-text highlight"><pre><span></span><code>The primary change in Chisel v3.6.0 is the transition from the Scala FIRRTL
Compiler to the new MLIR FIRRTL Compiler. This will have a minimal impact on
typical Chisel user APIs but a large impact on custom compiler flows. For
more information, please see the ROADMAP.
</code></pre></div>
<p>因此提前测试一下 firtool，看看其和 Scala FIRRTL Compiler 有哪些区别，是否有更好的输出。</p>
<h3 id="firtool_1"><a class="toclink" href="../../hardware/2023/04/04/firtool/#firtool_1">使用 firtool</a></h3>
<p>使用 firtool 有两种方法：</p>
<ol>
<li>使用 chisel3 3.6 的 <code>circt.stage.ChiselStage</code> 对象：</li>
</ol>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/04/04/firtool/#__codelineno-0-1"></a><span class="n">circt</span><span class="p">.</span><span class="n">stage</span><span class="p">.</span><span class="nc">ChiselStage</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2023/04/04/firtool/#__codelineno-0-2"></a><span class="w">  </span><span class="p">.</span><span class="n">emitSystemVerilogFile</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Top</span><span class="p">)</span>
</span></code></pre></div>
<p>代码中会生成 Chisel 模块对应的 FIRRTL 文件，然后喂给 firtool。也可以通过 <code>circt.stage.ChiselMain</code> 来运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2023/04/04/firtool/#__codelineno-1-1"></a>$<span class="w"> </span>sbt<span class="w"> </span><span class="s2">&quot;runMain circt.stage.ChiselMain --help&quot;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2023/04/04/firtool/#__codelineno-1-2"></a><span class="o">[</span>info<span class="o">]</span><span class="w"> </span>running<span class="w"> </span>circt.stage.ChiselMain<span class="w"> </span>--help
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2023/04/04/firtool/#__codelineno-1-3"></a>Usage:<span class="w"> </span>circt<span class="w"> </span><span class="o">[</span>options<span class="o">]</span><span class="w"> </span><span class="o">[</span>&lt;arg&gt;...<span class="o">]</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2023/04/04/firtool/#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2023/04/04/firtool/#__codelineno-1-5"></a>Shell<span class="w"> </span>Options
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2023/04/04/firtool/#__codelineno-1-6"></a><span class="w">  </span>&lt;arg&gt;...<span class="w">                 </span>optional<span class="w"> </span>unbounded<span class="w"> </span>args
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2023/04/04/firtool/#__codelineno-1-7"></a><span class="w">  </span>-td,<span class="w"> </span>--target-dir<span class="w"> </span>&lt;directory&gt;
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2023/04/04/firtool/#__codelineno-1-8"></a><span class="w">                           </span>Work<span class="w"> </span>directory<span class="w"> </span><span class="o">(</span>default:<span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="o">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2023/04/04/firtool/#__codelineno-1-9"></a><span class="w">  </span>-faf,<span class="w"> </span>--annotation-file<span class="w"> </span>&lt;file&gt;
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2023/04/04/firtool/#__codelineno-1-10"></a><span class="w">                           </span>An<span class="w"> </span>input<span class="w"> </span>annotation<span class="w"> </span>file
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2023/04/04/firtool/#__codelineno-1-11"></a><span class="w">  </span>-foaf,<span class="w"> </span>--output-annotation-file<span class="w"> </span>&lt;file&gt;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2023/04/04/firtool/#__codelineno-1-12"></a><span class="w">                           </span>An<span class="w"> </span>output<span class="w"> </span>annotation<span class="w"> </span>file
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2023/04/04/firtool/#__codelineno-1-13"></a><span class="w">  </span>--show-registrations<span class="w">     </span>print<span class="w"> </span>discovered<span class="w"> </span>registered<span class="w"> </span>libraries<span class="w"> </span>and<span class="w"> </span>transforms
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../hardware/2023/04/04/firtool/#__codelineno-1-14"></a><span class="w">  </span>--help<span class="w">                   </span>prints<span class="w"> </span>this<span class="w"> </span>usage<span class="w"> </span>text
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../hardware/2023/04/04/firtool/#__codelineno-1-15"></a>Logging<span class="w"> </span>Options
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../hardware/2023/04/04/firtool/#__codelineno-1-16"></a><span class="w">  </span>-ll,<span class="w"> </span>--log-level<span class="w"> </span><span class="o">{</span>error<span class="p">|</span>warn<span class="p">|</span>info<span class="p">|</span>debug<span class="p">|</span>trace<span class="o">}</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../hardware/2023/04/04/firtool/#__codelineno-1-17"></a><span class="w">                           </span>Set<span class="w"> </span>global<span class="w"> </span>logging<span class="w"> </span>verbosity<span class="w"> </span><span class="o">(</span>default:<span class="w"> </span>None
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../hardware/2023/04/04/firtool/#__codelineno-1-18"></a><span class="w">  </span>-cll,<span class="w"> </span>--class-log-level<span class="w"> </span>&lt;FullClassName:<span class="o">{</span>error<span class="p">|</span>warn<span class="p">|</span>info<span class="p">|</span>debug<span class="p">|</span>trace<span class="o">}</span>&gt;...
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../hardware/2023/04/04/firtool/#__codelineno-1-19"></a><span class="w">                           </span>Set<span class="w"> </span>per-class<span class="w"> </span>logging<span class="w"> </span>verbosity
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../hardware/2023/04/04/firtool/#__codelineno-1-20"></a><span class="w">  </span>--log-file<span class="w"> </span>&lt;file&gt;<span class="w">        </span>Log<span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span>file<span class="w"> </span>instead<span class="w"> </span>of<span class="w"> </span>STDOUT
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../hardware/2023/04/04/firtool/#__codelineno-1-21"></a><span class="w">  </span>-lcn,<span class="w"> </span>--log-class-names<span class="w">  </span>Show<span class="w"> </span>class<span class="w"> </span>names<span class="w"> </span>and<span class="w"> </span>log<span class="w"> </span>level<span class="w"> </span><span class="k">in</span><span class="w"> </span>logging<span class="w"> </span>output
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../hardware/2023/04/04/firtool/#__codelineno-1-22"></a>CIRCT<span class="w"> </span><span class="o">(</span>MLIR<span class="w"> </span>FIRRTL<span class="w"> </span>Compiler<span class="o">)</span><span class="w"> </span>options
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../hardware/2023/04/04/firtool/#__codelineno-1-23"></a><span class="w">  </span>--target<span class="w"> </span><span class="o">{</span>chirrtl<span class="p">|</span>firrtl<span class="p">|</span>hw<span class="p">|</span>verilog<span class="p">|</span>systemverilog<span class="o">}</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../hardware/2023/04/04/firtool/#__codelineno-1-24"></a><span class="w">                           </span>The<span class="w"> </span>CIRCT
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../hardware/2023/04/04/firtool/#__codelineno-1-25"></a><span class="w">  </span>--preserve-aggregate<span class="w"> </span>&lt;value&gt;
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../hardware/2023/04/04/firtool/#__codelineno-1-26"></a><span class="w">                           </span>Do<span class="w"> </span>not<span class="w"> </span>lower<span class="w"> </span>aggregate<span class="w"> </span>types<span class="w"> </span>to<span class="w"> </span>ground<span class="w"> </span>types
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../hardware/2023/04/04/firtool/#__codelineno-1-27"></a><span class="w">  </span>--module<span class="w"> </span>&lt;package&gt;.&lt;module&gt;
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../hardware/2023/04/04/firtool/#__codelineno-1-28"></a><span class="w">                           </span>The<span class="w"> </span>name<span class="w"> </span>of<span class="w"> </span>a<span class="w"> </span>Chisel<span class="w"> </span>module<span class="w"> </span>to<span class="w"> </span>elaborate<span class="w"> </span><span class="o">(</span>module<span class="w"> </span>must<span class="w"> </span>be<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>classpath<span class="o">)</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../hardware/2023/04/04/firtool/#__codelineno-1-29"></a><span class="w">  </span>--full-stacktrace<span class="w">        </span>Show<span class="w"> </span>full<span class="w"> </span>stack<span class="w"> </span>trace<span class="w"> </span>when<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span>is<span class="w"> </span>thrown
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../hardware/2023/04/04/firtool/#__codelineno-1-30"></a><span class="w">  </span>--throw-on-first-error<span class="w">   </span>Throw<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span>first<span class="w"> </span>error<span class="w"> </span>instead<span class="w"> </span>of<span class="w"> </span>continuing
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../hardware/2023/04/04/firtool/#__codelineno-1-31"></a><span class="w">  </span>--warnings-as-errors<span class="w">     </span>Treat<span class="w"> </span>warnings<span class="w"> </span>as<span class="w"> </span>errors
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../hardware/2023/04/04/firtool/#__codelineno-1-32"></a><span class="w">  </span>--source-root<span class="w"> </span>&lt;file&gt;<span class="w">     </span>Root<span class="w"> </span>directory<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>files,<span class="w"> </span>used<span class="w"> </span><span class="k">for</span><span class="w"> </span>enhanced<span class="w"> </span>error<span class="w"> </span>reporting
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../hardware/2023/04/04/firtool/#__codelineno-1-33"></a><span class="w">  </span>--split-verilog<span class="w">          </span>Indicates<span class="w"> </span>that<span class="w"> </span><span class="s2">&quot;firtool&quot;</span><span class="w"> </span>should<span class="w"> </span>emit<span class="w"> </span>one-file-per-module<span class="w"> </span>and<span class="w"> </span>write<span class="w"> </span>separate<span class="w"> </span>outputs<span class="w"> </span>to<span class="w"> </span>separate<span class="w"> </span>files
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../hardware/2023/04/04/firtool/#__codelineno-1-34"></a>FIRRTL<span class="w"> </span>Transform<span class="w"> </span>Options
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../hardware/2023/04/04/firtool/#__codelineno-1-35"></a><span class="w">  </span>--no-dce<span class="w">                 </span>Disable<span class="w"> </span>dead<span class="w"> </span>code<span class="w"> </span>elimination
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../hardware/2023/04/04/firtool/#__codelineno-1-36"></a><span class="w">  </span>--no-check-comb-loops<span class="w">    </span>Disable<span class="w"> </span>combinational<span class="w"> </span>loop<span class="w"> </span>checking
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../hardware/2023/04/04/firtool/#__codelineno-1-37"></a><span class="w">  </span>-fil,<span class="w"> </span>--inline<span class="w"> </span>&lt;circuit&gt;<span class="o">[</span>.&lt;module&gt;<span class="o">[</span>.&lt;instance&gt;<span class="o">]][</span>,...<span class="o">]</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../hardware/2023/04/04/firtool/#__codelineno-1-38"></a><span class="w">                           </span>Inline<span class="w"> </span>selected<span class="w"> </span>modules
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../hardware/2023/04/04/firtool/#__codelineno-1-39"></a><span class="w">  </span>-clks,<span class="w"> </span>--list-clocks<span class="w"> </span>-c:&lt;circuit&gt;:-m:&lt;module&gt;:-o:&lt;filename&gt;
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../hardware/2023/04/04/firtool/#__codelineno-1-40"></a><span class="w">                           </span>List<span class="w"> </span>which<span class="w"> </span>signal<span class="w"> </span>drives<span class="w"> </span>each<span class="w"> </span>clock<span class="w"> </span>of<span class="w"> </span>every<span class="w"> </span>descendent<span class="w"> </span>of<span class="w"> </span>specified<span class="w"> </span>modules
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../hardware/2023/04/04/firtool/#__codelineno-1-41"></a><span class="w">  </span>--no-asa<span class="w">                 </span>Disable<span class="w"> </span>assert<span class="w"> </span>submodule<span class="w"> </span>assumptions
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../hardware/2023/04/04/firtool/#__codelineno-1-42"></a><span class="w">  </span>--no-constant-propagation
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../hardware/2023/04/04/firtool/#__codelineno-1-43"></a><span class="w">                           </span>Disable<span class="w"> </span>constant<span class="w"> </span>propagation<span class="w"> </span>elimination
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../hardware/2023/04/04/firtool/#__codelineno-1-44"></a>AspectLibrary
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../hardware/2023/04/04/firtool/#__codelineno-1-45"></a><span class="w">  </span>--with-aspect<span class="w"> </span>&lt;package&gt;.&lt;aspect&gt;
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="../../hardware/2023/04/04/firtool/#__codelineno-1-46"></a><span class="w">                           </span>The<span class="w"> </span>name/class<span class="w"> </span>of<span class="w"> </span>an<span class="w"> </span>aspect<span class="w"> </span>to<span class="w"> </span>compile<span class="w"> </span>with<span class="w"> </span><span class="o">(</span>must<span class="w"> </span>be<span class="w"> </span>a<span class="w"> </span>class/object<span class="w"> </span>without<span class="w"> </span>arguments!<span class="o">)</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="../../hardware/2023/04/04/firtool/#__codelineno-1-47"></a>MemLib<span class="w"> </span>Options
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="../../hardware/2023/04/04/firtool/#__codelineno-1-48"></a><span class="w">  </span>-firw,<span class="w"> </span>--infer-rw<span class="w">        </span>Enable<span class="w"> </span>read/write<span class="w"> </span>port<span class="w"> </span>inference<span class="w"> </span><span class="k">for</span><span class="w"> </span>memories
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="../../hardware/2023/04/04/firtool/#__codelineno-1-49"></a><span class="w">  </span>-frsq,<span class="w"> </span>--repl-seq-mem<span class="w"> </span>-c:&lt;circuit&gt;:-i:&lt;file&gt;:-o:&lt;file&gt;
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="../../hardware/2023/04/04/firtool/#__codelineno-1-50"></a><span class="w">                           </span>Blackbox<span class="w"> </span>and<span class="w"> </span>emit<span class="w"> </span>a<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span><span class="k">for</span><span class="w"> </span>each<span class="w"> </span>sequential<span class="w"> </span>memory
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="../../hardware/2023/04/04/firtool/#__codelineno-1-51"></a><span class="w">  </span>-gmv,<span class="w"> </span>--gen-mem-verilog<span class="w"> </span>&lt;blackbox<span class="p">|</span>full&gt;
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="../../hardware/2023/04/04/firtool/#__codelineno-1-52"></a><span class="w">                           </span>Blackbox<span class="w"> </span>and<span class="w"> </span>emit<span class="w"> </span>a<span class="w"> </span>Verilog<span class="w"> </span>behavior<span class="w"> </span>model<span class="w"> </span><span class="k">for</span><span class="w"> </span>each<span class="w"> </span>sequential<span class="w"> </span>memory
</span></code></pre></div>
<ol>
<li>在 Scala 中生成 FIRRTL 文件，然后用 firtool 命令转换 <code>.fir</code> 为 <code>.sv</code>。由于 Rocket Chip 还没有迁移，所以需要通过 firtool 来转换。</li>
</ol>
<p>由于目前 chisel3 并没有打包 firtool，目前需要自己装 firtool，例如通过 nix 或下载 GitHub 上的 Release 文件。本文采用的是 firtool 1.34.0。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/04/04/firtool/#_2">对比</a></h3>
<p>把同一份源码，通过两种方式来生成 Verilog 然后进行观察，下面是一些生成的代码的区别。</p>
<h4 id="_3"><a class="toclink" href="../../hardware/2023/04/04/firtool/#_3">状态机</a></h4>
<p>首先是一个状态机的例子（取自 chisel3 的 DetectTwoOnes 样例）：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2023/04/04/firtool/#__codelineno-2-1"></a><span class="n">is</span><span class="p">(</span><span class="nc">State</span><span class="p">.</span><span class="n">sTwo1s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2023/04/04/firtool/#__codelineno-2-2"></a><span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">.</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2023/04/04/firtool/#__codelineno-2-3"></a><span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">State</span><span class="p">.</span><span class="n">sNone</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2023/04/04/firtool/#__codelineno-2-4"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2023/04/04/firtool/#__codelineno-2-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>Scala FIRRTL:</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2023/04/04/firtool/#__codelineno-3-1"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">_GEN_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">io_in</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">2&#39;h0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/DetectTwoOnes.scala 33:20 34:15 15:22]</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2023/04/04/firtool/#__codelineno-3-2"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2023/04/04/firtool/#__codelineno-3-3"></a><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mh">2&#39;h2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// @[src/main/scala/DetectTwoOnes.scala 19:17]</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2023/04/04/firtool/#__codelineno-3-4"></a><span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">_GEN_2</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2023/04/04/firtool/#__codelineno-3-5"></a><span class="w">    </span><span class="k">end</span>
</span></code></pre></div>
<p>CIRCT firtool:</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2023/04/04/firtool/#__codelineno-4-1"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">2&#39;h2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">io_in</span><span class="p">)</span><span class="w">    </span><span class="c1">// src/main/scala/DetectTwoOnes.scala:15:22, :17:20, :19:17, :33:{12,20}, :34:15</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2023/04/04/firtool/#__codelineno-4-2"></a><span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">2&#39;h0</span><span class="p">;</span><span class="w">    </span><span class="c1">// src/main/scala/DetectTwoOnes.scala:15:22, :29:15</span>
</span></code></pre></div>
<p>这个例子里，Scala FIRRTL Compiler 多生成了一个 <code>_GEN_2</code>，需要把前后一起看才知道是什么意思，而 CIRCT 生成的与源码比较接近，可读性较好。</p>
<h4 id="syncreadmem"><a class="toclink" href="../../hardware/2023/04/04/firtool/#syncreadmem">SyncReadMem</a></h4>
<p>接下来看 SyncReadMem。在 Scala FIRRTL Compiler 中，默认是直接在模块中嵌入代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../hardware/2023/04/04/firtool/#__codelineno-5-1"></a><span class="w">  </span><span class="n">reg</span><span class="w"> </span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">31</span><span class="p">];</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../hardware/2023/04/04/firtool/#__codelineno-5-2"></a><span class="w">  </span><span class="n">wire</span><span class="w">  </span><span class="n">mem_rdata_MPORT_en</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../hardware/2023/04/04/firtool/#__codelineno-5-3"></a><span class="w">  </span><span class="n">wire</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_rdata_MPORT_addr</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../hardware/2023/04/04/firtool/#__codelineno-5-4"></a><span class="w">  </span><span class="n">wire</span><span class="w"> </span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_rdata_MPORT_data</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../hardware/2023/04/04/firtool/#__codelineno-5-5"></a><span class="w">  </span><span class="n">wire</span><span class="w"> </span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_MPORT_data</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../hardware/2023/04/04/firtool/#__codelineno-5-6"></a><span class="w">  </span><span class="n">wire</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_MPORT_addr</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../hardware/2023/04/04/firtool/#__codelineno-5-7"></a><span class="w">  </span><span class="n">wire</span><span class="w">  </span><span class="n">mem_MPORT_mask</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../hardware/2023/04/04/firtool/#__codelineno-5-8"></a><span class="w">  </span><span class="n">wire</span><span class="w">  </span><span class="n">mem_MPORT_en</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../hardware/2023/04/04/firtool/#__codelineno-5-9"></a><span class="w">  </span><span class="n">reg</span><span class="w">  </span><span class="n">mem_rdata_MPORT_en_pipe_0</span><span class="p">;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../hardware/2023/04/04/firtool/#__codelineno-5-10"></a><span class="w">  </span><span class="n">reg</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_rdata_MPORT_addr_pipe_0</span><span class="p">;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../hardware/2023/04/04/firtool/#__codelineno-5-11"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">mem_rdata_MPORT_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_rdata_MPORT_en_pipe_0</span><span class="p">;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../hardware/2023/04/04/firtool/#__codelineno-5-12"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">mem_rdata_MPORT_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_rdata_MPORT_addr_pipe_0</span><span class="p">;</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../hardware/2023/04/04/firtool/#__codelineno-5-13"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">mem_rdata_MPORT_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">mem_rdata_MPORT_addr</span><span class="p">];</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../hardware/2023/04/04/firtool/#__codelineno-5-14"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">mem_MPORT_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../hardware/2023/04/04/firtool/#__codelineno-5-15"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">mem_MPORT_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waddr</span><span class="p">;</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../hardware/2023/04/04/firtool/#__codelineno-5-16"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">mem_MPORT_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="ss">&#39;h1</span><span class="p">;</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../hardware/2023/04/04/firtool/#__codelineno-5-17"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">mem_MPORT_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="ss">&#39;h1</span><span class="p">;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../hardware/2023/04/04/firtool/#__codelineno-5-18"></a><span class="w">  </span><span class="n">assign</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_rdata_MPORT_data</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 11:9]</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../hardware/2023/04/04/firtool/#__codelineno-5-19"></a><span class="w">  </span><span class="n">always</span><span class="w"> </span><span class="o">@</span><span class="p">(</span><span class="n">posedge</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span><span class="w"> </span><span class="n">begin</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../hardware/2023/04/04/firtool/#__codelineno-5-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mem_MPORT_en</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">mem_MPORT_mask</span><span class="p">)</span><span class="w"> </span><span class="n">begin</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../hardware/2023/04/04/firtool/#__codelineno-5-21"></a><span class="w">      </span><span class="n">mem</span><span class="p">[</span><span class="n">mem_MPORT_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mem_MPORT_data</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[src/main/scala/Memory.scala 10:24]</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../hardware/2023/04/04/firtool/#__codelineno-5-22"></a><span class="w">    </span><span class="n">end</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../hardware/2023/04/04/firtool/#__codelineno-5-23"></a><span class="w">    </span><span class="n">mem_rdata_MPORT_en_pipe_0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="ss">&#39;h1</span><span class="p">;</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../hardware/2023/04/04/firtool/#__codelineno-5-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="ss">&#39;h1</span><span class="p">)</span><span class="w"> </span><span class="n">begin</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../hardware/2023/04/04/firtool/#__codelineno-5-25"></a><span class="w">      </span><span class="n">mem_rdata_MPORT_addr_pipe_0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">raddr</span><span class="p">;</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../hardware/2023/04/04/firtool/#__codelineno-5-26"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="../../hardware/2023/04/04/firtool/#__codelineno-5-27"></a><span class="w">  </span><span class="nn">end</span>
</span></code></pre></div>
<p>当然了，它有 repl-seq-mem 的选项，可以生成 BlackBox 方便替换为实际的 SRAM IP：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../hardware/2023/04/04/firtool/#__codelineno-6-1"></a>$<span class="w"> </span>sbt<span class="w"> </span><span class="s2">&quot;runMain firrtl.stage.FirrtlMain -i Memory.fir --repl-seq-mem -c:Memory:-o:Memory.conf&quot;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../hardware/2023/04/04/firtool/#__codelineno-6-2"></a>$<span class="w"> </span>cat<span class="w"> </span>Memory.v
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../hardware/2023/04/04/firtool/#__codelineno-6-3"></a>module<span class="w"> </span>mem<span class="o">(</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../hardware/2023/04/04/firtool/#__codelineno-6-4"></a><span class="w">  </span>input<span class="w">  </span><span class="o">[</span><span class="m">4</span>:0<span class="o">]</span><span class="w">  </span>R0_addr,
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../hardware/2023/04/04/firtool/#__codelineno-6-5"></a><span class="w">  </span>input<span class="w">         </span>R0_clk,
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../hardware/2023/04/04/firtool/#__codelineno-6-6"></a><span class="w">  </span>output<span class="w"> </span><span class="o">[</span><span class="m">31</span>:0<span class="o">]</span><span class="w"> </span>R0_data,
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../hardware/2023/04/04/firtool/#__codelineno-6-7"></a><span class="w">  </span>input<span class="w">  </span><span class="o">[</span><span class="m">4</span>:0<span class="o">]</span><span class="w">  </span>W0_addr,
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../hardware/2023/04/04/firtool/#__codelineno-6-8"></a><span class="w">  </span>input<span class="w">         </span>W0_clk,
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../hardware/2023/04/04/firtool/#__codelineno-6-9"></a><span class="w">  </span>input<span class="w">  </span><span class="o">[</span><span class="m">31</span>:0<span class="o">]</span><span class="w"> </span>W0_data
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../hardware/2023/04/04/firtool/#__codelineno-6-10"></a><span class="o">)</span><span class="p">;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../hardware/2023/04/04/firtool/#__codelineno-6-11"></a><span class="w">  </span>wire<span class="w"> </span><span class="o">[</span><span class="m">4</span>:0<span class="o">]</span><span class="w"> </span>mem_ext_R0_addr<span class="p">;</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../hardware/2023/04/04/firtool/#__codelineno-6-12"></a><span class="w">  </span>wire<span class="w">  </span>mem_ext_R0_en<span class="p">;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="../../hardware/2023/04/04/firtool/#__codelineno-6-13"></a><span class="w">  </span>wire<span class="w">  </span>mem_ext_R0_clk<span class="p">;</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="../../hardware/2023/04/04/firtool/#__codelineno-6-14"></a><span class="w">  </span>wire<span class="w"> </span><span class="o">[</span><span class="m">31</span>:0<span class="o">]</span><span class="w"> </span>mem_ext_R0_data<span class="p">;</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="../../hardware/2023/04/04/firtool/#__codelineno-6-15"></a><span class="w">  </span>wire<span class="w"> </span><span class="o">[</span><span class="m">4</span>:0<span class="o">]</span><span class="w"> </span>mem_ext_W0_addr<span class="p">;</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="../../hardware/2023/04/04/firtool/#__codelineno-6-16"></a><span class="w">  </span>wire<span class="w">  </span>mem_ext_W0_en<span class="p">;</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="../../hardware/2023/04/04/firtool/#__codelineno-6-17"></a><span class="w">  </span>wire<span class="w">  </span>mem_ext_W0_clk<span class="p">;</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="../../hardware/2023/04/04/firtool/#__codelineno-6-18"></a><span class="w">  </span>wire<span class="w"> </span><span class="o">[</span><span class="m">31</span>:0<span class="o">]</span><span class="w"> </span>mem_ext_W0_data<span class="p">;</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="../../hardware/2023/04/04/firtool/#__codelineno-6-19"></a><span class="w">  </span>mem_ext<span class="w"> </span>mem_ext<span class="w"> </span><span class="o">(</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="../../hardware/2023/04/04/firtool/#__codelineno-6-20"></a><span class="w">    </span>.R0_addr<span class="o">(</span>mem_ext_R0_addr<span class="o">)</span>,
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="../../hardware/2023/04/04/firtool/#__codelineno-6-21"></a><span class="w">    </span>.R0_en<span class="o">(</span>mem_ext_R0_en<span class="o">)</span>,
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="../../hardware/2023/04/04/firtool/#__codelineno-6-22"></a><span class="w">    </span>.R0_clk<span class="o">(</span>mem_ext_R0_clk<span class="o">)</span>,
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="../../hardware/2023/04/04/firtool/#__codelineno-6-23"></a><span class="w">    </span>.R0_data<span class="o">(</span>mem_ext_R0_data<span class="o">)</span>,
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="../../hardware/2023/04/04/firtool/#__codelineno-6-24"></a><span class="w">    </span>.W0_addr<span class="o">(</span>mem_ext_W0_addr<span class="o">)</span>,
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="../../hardware/2023/04/04/firtool/#__codelineno-6-25"></a><span class="w">    </span>.W0_en<span class="o">(</span>mem_ext_W0_en<span class="o">)</span>,
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="../../hardware/2023/04/04/firtool/#__codelineno-6-26"></a><span class="w">    </span>.W0_clk<span class="o">(</span>mem_ext_W0_clk<span class="o">)</span>,
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="../../hardware/2023/04/04/firtool/#__codelineno-6-27"></a><span class="w">    </span>.W0_data<span class="o">(</span>mem_ext_W0_data<span class="o">)</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="../../hardware/2023/04/04/firtool/#__codelineno-6-28"></a><span class="w">  </span><span class="o">)</span><span class="p">;</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="../../hardware/2023/04/04/firtool/#__codelineno-6-29"></a><span class="w">  </span>assign<span class="w"> </span><span class="nv">mem_ext_R0_clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>R0_clk<span class="p">;</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="../../hardware/2023/04/04/firtool/#__codelineno-6-30"></a><span class="w">  </span>assign<span class="w"> </span><span class="nv">mem_ext_R0_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="s1">&#39;h1;</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="../../hardware/2023/04/04/firtool/#__codelineno-6-31"></a><span class="s1">  assign mem_ext_R0_addr = R0_addr;</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="../../hardware/2023/04/04/firtool/#__codelineno-6-32"></a><span class="s1">  assign R0_data = mem_ext_R0_data;</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="../../hardware/2023/04/04/firtool/#__codelineno-6-33"></a><span class="s1">  assign mem_ext_W0_clk = W0_clk;</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="../../hardware/2023/04/04/firtool/#__codelineno-6-34"></a><span class="s1">  assign mem_ext_W0_en = 1&#39;</span>h1<span class="p">;</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="../../hardware/2023/04/04/firtool/#__codelineno-6-35"></a><span class="w">  </span>assign<span class="w"> </span><span class="nv">mem_ext_W0_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>W0_addr<span class="p">;</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="../../hardware/2023/04/04/firtool/#__codelineno-6-36"></a><span class="w">  </span>assign<span class="w"> </span><span class="nv">mem_ext_W0_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>W0_data<span class="p">;</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="../../hardware/2023/04/04/firtool/#__codelineno-6-37"></a>endmodule
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="../../hardware/2023/04/04/firtool/#__codelineno-6-38"></a>$<span class="w"> </span>cat<span class="w"> </span>Memory.conf
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="../../hardware/2023/04/04/firtool/#__codelineno-6-39"></a>name<span class="w"> </span>mem_ext<span class="w"> </span>depth<span class="w"> </span><span class="m">32</span><span class="w"> </span>width<span class="w"> </span><span class="m">32</span><span class="w"> </span>ports<span class="w"> </span>write,read<span class="w">  </span>
</span></code></pre></div>
<p>下游工具读取 Memory.conf 去生成对应的 mem_ext 模块。这里只考虑了 Read Latency 为 1 的情况，如果是 Mem，就不会生成 BlackBox，毕竟参数名字是 sequential memory。</p>
<p>CIRCT firtool 也有类似的表现，只不过默认情况下就会用一个单独的模块：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../hardware/2023/04/04/firtool/#__codelineno-7-1"></a><span class="k">module</span><span class="w"> </span><span class="n">Memory</span><span class="p">(</span><span class="w">  </span><span class="c1">// &lt;stdin&gt;:3:10</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../hardware/2023/04/04/firtool/#__codelineno-7-2"></a><span class="w">  </span><span class="k">input</span><span class="w">         </span><span class="n">clock</span><span class="p">,</span><span class="w">  </span><span class="c1">// &lt;stdin&gt;:4:11</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../hardware/2023/04/04/firtool/#__codelineno-7-3"></a><span class="w">                </span><span class="n">reset</span><span class="p">,</span><span class="w">  </span><span class="c1">// &lt;stdin&gt;:5:11</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../hardware/2023/04/04/firtool/#__codelineno-7-4"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">raddr</span><span class="p">,</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:4:17</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../hardware/2023/04/04/firtool/#__codelineno-7-5"></a><span class="w">                </span><span class="n">waddr</span><span class="p">,</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:7:17</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../hardware/2023/04/04/firtool/#__codelineno-7-6"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wdata</span><span class="p">,</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:8:17</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../hardware/2023/04/04/firtool/#__codelineno-7-7"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rdata</span><span class="w">   </span><span class="c1">// src/main/scala/Memory.scala:5:17</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../hardware/2023/04/04/firtool/#__codelineno-7-8"></a><span class="p">);</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../hardware/2023/04/04/firtool/#__codelineno-7-9"></a>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../hardware/2023/04/04/firtool/#__codelineno-7-10"></a><span class="w">  </span><span class="n">mem_combMem</span><span class="w"> </span><span class="n">mem_ext</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../hardware/2023/04/04/firtool/#__codelineno-7-11"></a><span class="w">    </span><span class="p">.</span><span class="n">R0_addr</span><span class="w"> </span><span class="p">(</span><span class="n">raddr</span><span class="p">),</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../hardware/2023/04/04/firtool/#__codelineno-7-12"></a><span class="w">    </span><span class="p">.</span><span class="n">R0_en</span><span class="w">   </span><span class="p">(</span><span class="mh">1&#39;h1</span><span class="p">),</span><span class="w">    </span><span class="c1">// &lt;stdin&gt;:3:10</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../hardware/2023/04/04/firtool/#__codelineno-7-13"></a><span class="w">    </span><span class="p">.</span><span class="n">R0_clk</span><span class="w">  </span><span class="p">(</span><span class="n">clock</span><span class="p">),</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../hardware/2023/04/04/firtool/#__codelineno-7-14"></a><span class="w">    </span><span class="p">.</span><span class="n">W0_addr</span><span class="w"> </span><span class="p">(</span><span class="n">waddr</span><span class="p">),</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../hardware/2023/04/04/firtool/#__codelineno-7-15"></a><span class="w">    </span><span class="p">.</span><span class="n">W0_en</span><span class="w">   </span><span class="p">(</span><span class="mh">1&#39;h1</span><span class="p">),</span><span class="w">    </span><span class="c1">// &lt;stdin&gt;:3:10</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="../../hardware/2023/04/04/firtool/#__codelineno-7-16"></a><span class="w">    </span><span class="p">.</span><span class="n">W0_clk</span><span class="w">  </span><span class="p">(</span><span class="n">clock</span><span class="p">),</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="../../hardware/2023/04/04/firtool/#__codelineno-7-17"></a><span class="w">    </span><span class="p">.</span><span class="n">W0_data</span><span class="w"> </span><span class="p">(</span><span class="n">wdata</span><span class="p">),</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="../../hardware/2023/04/04/firtool/#__codelineno-7-18"></a><span class="w">    </span><span class="p">.</span><span class="n">R0_data</span><span class="w"> </span><span class="p">(</span><span class="n">rdata</span><span class="p">)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="../../hardware/2023/04/04/firtool/#__codelineno-7-19"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="../../hardware/2023/04/04/firtool/#__codelineno-7-20"></a><span class="k">endmodule</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="../../hardware/2023/04/04/firtool/#__codelineno-7-21"></a>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="../../hardware/2023/04/04/firtool/#__codelineno-7-22"></a><span class="k">module</span><span class="w"> </span><span class="n">mem_combMem</span><span class="p">(</span><span class="w"> </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="../../hardware/2023/04/04/firtool/#__codelineno-7-23"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">R0_addr</span><span class="p">,</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="../../hardware/2023/04/04/firtool/#__codelineno-7-24"></a><span class="w">  </span><span class="k">input</span><span class="w">         </span><span class="n">R0_en</span><span class="p">,</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="../../hardware/2023/04/04/firtool/#__codelineno-7-25"></a><span class="w">                </span><span class="n">R0_clk</span><span class="p">,</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="../../hardware/2023/04/04/firtool/#__codelineno-7-26"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">W0_addr</span><span class="p">,</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="../../hardware/2023/04/04/firtool/#__codelineno-7-27"></a><span class="w">  </span><span class="k">input</span><span class="w">         </span><span class="n">W0_en</span><span class="p">,</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="../../hardware/2023/04/04/firtool/#__codelineno-7-28"></a><span class="w">                </span><span class="n">W0_clk</span><span class="p">,</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="../../hardware/2023/04/04/firtool/#__codelineno-7-29"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">W0_data</span><span class="p">,</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="../../hardware/2023/04/04/firtool/#__codelineno-7-30"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">R0_data</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="../../hardware/2023/04/04/firtool/#__codelineno-7-31"></a><span class="p">);</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="../../hardware/2023/04/04/firtool/#__codelineno-7-32"></a>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="../../hardware/2023/04/04/firtool/#__codelineno-7-33"></a><span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Memory</span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">31</span><span class="p">];</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="../../hardware/2023/04/04/firtool/#__codelineno-7-34"></a><span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">_GEN</span><span class="p">;</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="../../hardware/2023/04/04/firtool/#__codelineno-7-35"></a><span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">_GEN_0</span><span class="p">;</span><span class="w">    </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="../../hardware/2023/04/04/firtool/#__codelineno-7-36"></a><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">R0_clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">    </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="../../hardware/2023/04/04/firtool/#__codelineno-7-37"></a><span class="w">    </span><span class="n">_GEN</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">R0_en</span><span class="p">;</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="../../hardware/2023/04/04/firtool/#__codelineno-7-38"></a><span class="w">    </span><span class="n">_GEN_0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">R0_addr</span><span class="p">;</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="../../hardware/2023/04/04/firtool/#__codelineno-7-39"></a><span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="c1">// always @(posedge)</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="../../hardware/2023/04/04/firtool/#__codelineno-7-40"></a><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">W0_clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">    </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="../../hardware/2023/04/04/firtool/#__codelineno-7-41"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">W0_en</span><span class="p">)</span><span class="w">  </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="../../hardware/2023/04/04/firtool/#__codelineno-7-42"></a><span class="w">      </span><span class="n">Memory</span><span class="p">[</span><span class="n">W0_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">W0_data</span><span class="p">;</span><span class="w">   </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="../../hardware/2023/04/04/firtool/#__codelineno-7-43"></a><span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="c1">// always @(posedge)</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="../../hardware/2023/04/04/firtool/#__codelineno-7-44"></a><span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">R0_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_GEN</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Memory</span><span class="p">[</span><span class="n">_GEN_0</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span><span class="w">   </span><span class="c1">// src/main/scala/Memory.scala:10:24</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="../../hardware/2023/04/04/firtool/#__codelineno-7-45"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>firtool 也支持 <code>-repl-seq-mem</code> 参数，用法和输出与 Scala FIRRTL Compiler 类似。</p>
<p>我最近也写了一个小工具：<a href="https://github.com/jiegec/chisel-memory-lower">chisel-memory-lower</a>来解析生成的 conf 文件，生成对应的 BlackBox。</p>
<h4 id="_4"><a class="toclink" href="../../hardware/2023/04/04/firtool/#_4">复杂组合逻辑</a></h4>
<p>再来看 Hardfloat 的例子。代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../hardware/2023/04/04/firtool/#__codelineno-8-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="n">expWidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sigWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sigWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../hardware/2023/04/04/firtool/#__codelineno-8-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">isZero</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="n">expWidth</span><span class="p">,</span><span class="w"> </span><span class="n">expWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../hardware/2023/04/04/firtool/#__codelineno-8-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">isSpecial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="n">expWidth</span><span class="p">,</span><span class="w"> </span><span class="n">expWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../hardware/2023/04/04/firtool/#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../hardware/2023/04/04/firtool/#__codelineno-8-5"></a><span class="kd">val</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">RawFloat</span><span class="p">(</span><span class="n">expWidth</span><span class="p">,</span><span class="w"> </span><span class="n">sigWidth</span><span class="p">))</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../hardware/2023/04/04/firtool/#__codelineno-8-6"></a><span class="n">out</span><span class="p">.</span><span class="n">isNaN</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">isSpecial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">   </span><span class="n">exp</span><span class="p">(</span><span class="n">expWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></div>
<p>Scala FIRRTL Compiler:</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../hardware/2023/04/04/firtool/#__codelineno-9-1"></a><span class="n">wire</span><span class="w"> </span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="n">rawA_exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">23</span><span class="p">];</span><span class="w"> </span><span class="c1">// @[submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala 51:21]</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../hardware/2023/04/04/firtool/#__codelineno-9-2"></a><span class="n">wire</span><span class="w">  </span><span class="n">rawA_isZero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawA_exp</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="ss">&#39;h0</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala 52:53]</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../hardware/2023/04/04/firtool/#__codelineno-9-3"></a><span class="n">wire</span><span class="w">  </span><span class="n">rawA_isSpecial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawA_exp</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="ss">&#39;h3</span><span class="p">;</span><span class="w"> </span><span class="c1">// @[submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala 53:53]</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../hardware/2023/04/04/firtool/#__codelineno-9-4"></a><span class="n">wire</span><span class="w">  </span><span class="n">rawA__isNaN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawA_isSpecial</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">rawA_exp</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span><span class="w"> </span><span class="c1">// @[submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala 56:33]</span>
</span></code></pre></div>
<p>基本是忠实的翻译。</p>
<p>CIRCT Firtool:</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../hardware/2023/04/04/firtool/#__codelineno-10-1"></a><span class="kt">wire</span><span class="w">        </span><span class="n">rawA_isNaN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">io_a</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">30</span><span class="p">]))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mh">29</span><span class="p">];</span><span class="w">   </span><span class="c1">// submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala:51:21, :53:{28,53}, :56:{33,41}</span>
</span></code></pre></div>
<p>可以看到，这里对代码进行了变换，把 <code>=== 3.U</code> 变成了 AND，不再忠实原来的代码，而是采取了更加间接的表达方式。</p>
<p>再看一个类似的例子，源码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../hardware/2023/04/04/firtool/#__codelineno-11-1"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">signProd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawA</span><span class="p">.</span><span class="n">sign</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">rawB</span><span class="p">.</span><span class="n">sign</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">op</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<p>Scala FIRRTL Compiler:</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../hardware/2023/04/04/firtool/#__codelineno-12-1"></a><span class="w">  </span><span class="kt">wire</span><span class="w">  </span><span class="n">rawA__sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mh">32</span><span class="p">];</span><span class="w"> </span><span class="c1">// @[submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala 59:25]</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../hardware/2023/04/04/firtool/#__codelineno-12-2"></a><span class="w">  </span><span class="kt">wire</span><span class="w">  </span><span class="n">rawB__sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_b</span><span class="p">[</span><span class="mh">32</span><span class="p">];</span><span class="w"> </span><span class="c1">// @[submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala 59:25]</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="../../hardware/2023/04/04/firtool/#__codelineno-12-3"></a><span class="w">  </span><span class="kt">wire</span><span class="w">  </span><span class="n">signProd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawA__sign</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">rawB__sign</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">io_op</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span><span class="w"> </span><span class="c1">// @[submodules/berkeley-hardfloat/src/main/scala/MulAddRecFN.scala 96:42]</span>
</span></code></pre></div>
<p>CIRCT firtool:</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../hardware/2023/04/04/firtool/#__codelineno-13-1"></a><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">signProd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">io_b</span><span class="p">[</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">io_op</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span><span class="w">    </span><span class="c1">// submodules/berkeley-hardfloat/src/main/scala/MulAddRecFN.scala:96:{42,49}, submodules/berkeley-hardfloat/src/main/scala/rawFloatFromRecFN.scala:59:25</span>
</span></code></pre></div>
<p>可以看到，CIRCT firtool 比较倾向于内联一些简单的连线。当然了，这个不是绝对的，通过修改命令行参数，可能得到不同的结果。</p>
<h4 id="rocket-chip"><a class="toclink" href="../../hardware/2023/04/04/firtool/#rocket-chip">Rocket Chip</a></h4>
<p>在 rocket-chip-vcu128 项目中测试了一下，迁移到 CIRCT firtool 比较简单，只需要把 FirrtlMain 的调用改成直接运行 firtool。但是，在综合的时候，发现 Vivado 无法推断出一个 SyncReadMem，导致 LUT 和 Register 占用特别多。解决思路有两个：</p>
<ol>
<li>利用上面所说的 <code>--repl-seq-mem</code> 生成 BlackBox，然后生成 XPM Macro 接起来</li>
<li>添加 <code>--lower-memories</code> 参数，简化 SRAM，然后 Vivado 就可以识别出来了。</li>
</ol>
<h4 id="_5"><a class="toclink" href="../../hardware/2023/04/04/firtool/#_5">速度</a></h4>
<p>运行大项目的时候，Scala FIRRTL Compiler 的速度明显比 CIRCT Firtool 慢，体验还是不错的。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/04/04/firtool/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-23 00:00:00">2023年3月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/">单核处理器的协同仿真</a></h2>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/#_2">背景</a></h3>
<p>今年的龙芯杯又开始报名了，我来写一篇关于协同仿真（cosim）的博客蹭蹭热度。下面的内容参考了一些已有的协同仿真的框架，例如 <a href="https://ibex-core.readthedocs.io/en/latest/03_reference/cosim.html">ibex co-sim</a> 和 <a href="https://github.com/OpenXiangShan/difftest">OpenXiangShan/difftest</a>。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/#_3">协同仿真</a></h3>
<p>RTL 层次的协同仿真可以做不同层次的，这里讨论的是指令提交层次，具体来讲，就是把 CPU 和一个模拟器放在一起协同仿真，检查每条指令执行完以后的状态是否一致。基于代码样例的测试虽然可以覆盖很多情况，但是如果出了错误，报错的地方不一定是出现问题的地方，有些时候就需要往回找很久，才能找到刚出现问题的地方。软件上，大家经常苦于内存错误，经常找不到刚出现溢出的地方，所以要用 valgrind 或者 asan 等工具来直接定位第一次出错的地方。硬件上也是类似，为了精确定位到出错的波形，可以用 cosim。</p>
<p>cosim 是怎么工作的呢？模拟器是软件实现的，它原子地执行一条条指令，同时记录下当前的状态，例如寄存器的取值、内存的状态等等。如果可以让 CPU 和模拟器锁步运行，也就是 CPU 执行一条指令，模拟器执行一条指令，然后比对状态，一旦出现不一致，就直接报错。但实际上 CPU 可能会更加复杂，因为它指令的执行拆分成了很多部分，需要针对流水线进行一些修改，使得它可以生成一个匹配模拟器的原子的执行流。</p>
<p>整体的工作流程如下：</p>
<ol>
<li>选择一个模拟器，自己写或者使用一个现成的。考虑到模拟器实现的功能和 CPU 不一定一致，有时候需要修改模拟器的源码，所以可以考虑使用一些现成的开源软件，如果是为了 cosim 设计的就更好了。</li>
<li>找到模拟器的单步执行接口，并且让模拟器可以把内部状态暴露出来。这一步可能需要修改源代码。</li>
<li>修改 RTL，把指令的提交信息、寄存器堆的内容通过一些方法传递出来。</li>
<li>修改仿真顶层，每当指令提交的时候，单步执行模拟器，然后比对双方的状态。</li>
</ol>
<h3 id="_4"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/#_4">模拟器</a></h3>
<p>选择模拟器，要根据你所实现的指令集来选择。下面以 Spike 为例，用来和 RISC-V CPU 进行协同仿真。spike 实现了比较完整的 RISC-V 指令集，并且以库的形式提供了它的 API，但还需要一些修改，让它更加适合协同仿真。这一部分参考了 <a href="https://ibex-core.readthedocs.io/en/latest/03_reference/cosim.html">ibex co-sim</a>的文档。</p>
<p>首先，spike 提供了 step 函数，就是我们想要的单步执行。但是，spike 的 step 在遇到异常或者中断的时候也会返回，但实际上在处理器一侧，通常异常是单独处理的，所以这时候就要修改 spike 的 step 函数，如果遇到异常了，继续执行，直到执行了一条指令为止。与此同时，spike 没有记录最后一次执行的指令的 pc，只记录了下一个 PC，那么在发生异常的时候，就不会记录异常处理的第一条指令的 PC，这里也要进行针对性的修改。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/03/23/core-cosim/#__codelineno-0-1"></a><span class="n">state</span><span class="p">.</span><span class="n">last_inst_pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2023/03/23/core-cosim/#__codelineno-0-2"></a><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute_insn_logged</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">fetch</span><span class="p">);</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2023/03/23/core-cosim/#__codelineno-0-3"></a><span class="n">advance_pc</span><span class="p">();</span>
</span></code></pre></div>
<p>做了这些修改以后，就足够在 cosim 中运行一些简单的程序了。</p>
<h3 id="_5"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/#_5">处理器</a></h3>
<p>接下来，需要修改处理器，让它可以汇报每个周期完成执行的指令情况，具体的格式因实现而异，最后都需要把这些信息暴露给仿真顶层，可能的方法有：</p>
<ol>
<li>通过多级的 module output 一路传到顶层，最终是顶层模块的输出信号。这种方法改动比较大，而且麻烦。</li>
<li>通过 DPI 函数，每个周期调用一次，把信息通过 DPI 的参数传递给 C 函数。这种方法比较推荐。</li>
<li>通过仿真器的功能，例如 verilator 可以通过添加注释的方法，把信号暴露出去。</li>
</ol>
<p>仿真顶层拿到信息以后，就可以进行 cosim 了：CPU 执行一条指令，就让模拟器也 step 一步，然后比较二者的状态。状态怎么比对呢？常见的有通用寄存器，RISC-V 的 CSR。既可以通过记录寄存器堆的写入来比对，又可以直接把整个寄存器堆的内容导出来比对。实际上这些部分的性能影响都是很小的。</p>
<p>那么，内存怎么比对呢？对于简单的顺序处理器，读写也是顺序的，那么可以把读写的日志放到一个队列 deque 中，然后让模拟器也记录下内存的读写，从 deque 进行 pop 和比对。但实际情况可能会比较复杂，例如更复杂的处理器里可能会出现乱序访存等情况，同时处理器还可能会进行写合并等操作，这时候就需要在仿真顶层做一些匹配和合并的操作。实在觉得麻烦，也可以先不管内存，直接比对寄存器，也足够定位很多内存问题，因为 RISC-V 读内存总是要加载到寄存器中的。</p>
<h3 id="_6"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/#_6">特殊情况</a></h3>
<p>实现了前面的部分，就可以跑很多程序了，但是对于一些复杂的程序，例如 Linux，还缺少一样东西：外设和中断。能想到的第一种方法就是，用 C 代码再写一个外设的模型，然后接到模拟器的虚拟总线上。但是中断就会比较麻烦，因为中断的时机比较难保证同步，所以通常的方法是，把模拟器的中断处理关掉，当 CPU 发送 trap 的时候，让模拟器也发生一次 trap。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2023/03/23/core-cosim/#__codelineno-1-1"></a><span class="c1">// handle trap</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2023/03/23/core-cosim/#__codelineno-1-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">interrupt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2023/03/23/core-cosim/#__codelineno-1-3"></a><span class="w">  </span><span class="n">trap_t</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x8000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">interrupt</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2023/03/23/core-cosim/#__codelineno-1-4"></a><span class="w">  </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">take_trap</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">get_state</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2023/03/23/core-cosim/#__codelineno-1-5"></a><span class="w">  </span><span class="n">interrupt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2023/03/23/core-cosim/#__codelineno-1-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>但有一些外设不容易保证完全一致，例如 mtime 读取时间，很难保证 CPU 里读取的时间值和模拟器里的 mtime 一致。这时候就可以采用另一个办法：记录所有对外设的 load 指令，因为有副作用的关系，一定是顺序的，这时候就可以像前面提到的队列的方式，CPU 进行 uncached load 的时候，就把 load 的地址、数据和长度记录到队列中，当模拟器也要进行 load 的时候，匹配上地址和长度，返回数据。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-1"></a><span class="c1">// match rtl uncached load event</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">uncached_load_events</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-3"></a><span class="w">  </span><span class="n">uncached_load_event</span><span class="w"> </span><span class="n">ev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uncached_load_events</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ev</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-5"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-6"></a><span class="w">    </span><span class="n">uncached_load_events</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2023/03/23/core-cosim/#__codelineno-2-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>但这样实际上就假设了外设实现是正确的。如果还需要验证外设实现是否正确，需要结合两种方法，对于不确定结果的 load（例如 mtime），就按照 CPU 的结果来，否则就用 C 实现的外设模型进行比对。</p>
<p>除了这些意外，处理器实现的 feature 可能会和模拟器有一些出入，这些都比较容易解决，直接修改代码，屏蔽掉没有实现的功能，保持一致即可。</p>
<h3 id="chatgptbard"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/#chatgptbard">ChatGPT/Bard 的回复</a></h3>
<p>提问：</p>
<p>How can I verify my RISC-V processor design via co-simulation with spike?</p>
<p>ChatGPT:</p>
<p>Co-simulation with Spike can be a great way to verify your RISC-V processor design. Here's a high-level overview of the process:</p>
<ol>
<li>
<p>Write a testbench: You'll need to create a testbench that can generate inputs to your processor and check the outputs. This testbench can be written in any language you prefer, but most people use a hardware description language like Verilog or VHDL.</p>
</li>
<li>
<p>Connect your processor to Spike: To run a co-simulation with Spike, you'll need to connect your processor design to Spike using a TLM (transaction-level modeling) interface. Spike has a built-in TLM interface called the "Spike External Debug Interface" (S-EDI) that you can use.</p>
</li>
</ol>
<p>注：查不到 Spike External Debug Interface</p>
<ol>
<li>
<p>Configure the co-simulation: You'll need to configure the co-simulation by specifying the parameters of your processor design and Spike, such as the clock frequency and the reset signal.</p>
</li>
<li>
<p>Run the simulation: Once your testbench is written, your processor is connected to Spike, and the co-simulation is configured, you can run the simulation. Your testbench will generate inputs to your processor, which will be processed by Spike and your processor design. The output of your processor will be checked by your testbench to verify that it's correct.</p>
</li>
<li>
<p>Debug any issues: If you encounter any issues during the simulation, you'll need to debug them. This can involve looking at waveforms or logs to understand where things went wrong.</p>
</li>
</ol>
<p>Here are some more detailed steps to follow:</p>
<ol>
<li>
<p>Write your testbench in Verilog or VHDL. Your testbench should be able to generate inputs to your processor design and check the outputs. You can use any verification methodology you prefer, such as directed tests or random tests.</p>
</li>
<li>
<p>Connect your processor design to Spike using the S-EDI interface. The S-EDI interface is a TLM interface that allows Spike to communicate with your processor design. You'll need to instantiate the S-EDI module in your testbench and connect it to your processor design. You can find more information about the S-EDI interface in the Spike documentation.</p>
</li>
<li>
<p>Configure the co-simulation. You'll need to specify the clock frequency and reset signal for your processor design and Spike. You may also need to specify other parameters, such as the memory map for your processor design.</p>
</li>
<li>
<p>Run the simulation. Once your testbench is written, your processor is connected to Spike, and the co-simulation is configured, you can run the simulation. You can use a simulator like ModelSim or QuestaSim to run the simulation.</p>
</li>
<li>
<p>Debug any issues. If you encounter any issues during the simulation, you'll need to debug them. You can use the waveform viewer in your simulator to understand what's happening in your design. You can also use the Spike debugger to debug your processor design. The Spike debugger allows you to step through your code and examine the processor state.</p>
</li>
</ol>
<p>By following these steps, you can use co-simulation with Spike to verify your RISC-V processor design.</p>
<p>Bard:</p>
<p>Co-simulation is a technique used in verification to run two or more models of a system in lockstep, with each model executing a different part of the system. This allows the models to be used together to verify that the system behaves as expected.</p>
<p>To co-simulate your RISC-V processor design with Spike, you will need to create a model of your processor in Spike and a model of the system that your processor will be embedded in. You will then need to configure the two models to run in lockstep, with each model communicating with the other through a shared memory buffer.</p>
<p>Once the co-simulation is running, you can use it to verify that your processor design behaves as expected. You can do this by running test cases on the system model and observing the behavior of your processor model. If the processor model behaves as expected, then you can be confident that your design is correct.</p>
<p>Here are some of the benefits of using co-simulation:</p>
<ul>
<li>It can help you to find errors in your design early in the development process.</li>
<li>It can help you to verify that your design meets the requirements of the system that it will be embedded in.</li>
<li>It can help you to optimize your design for performance and power consumption.</li>
</ul>
<p>Here are some of the challenges of using co-simulation:</p>
<ul>
<li>It can be difficult to create accurate models of both your processor and the system that it will be embedded in.</li>
<li>It can be difficult to configure the co-simulation to run in lockstep.</li>
<li>It can be difficult to interpret the results of the co-simulation.</li>
</ul>
<p>Overall, co-simulation is a powerful technique that can be used to verify your RISC-V processor design. However, it is important to be aware of the challenges involved in using co-simulation.</p>
<h3 id="_7"><a class="toclink" href="../../hardware/2023/03/23/core-cosim/#_7">多核</a></h3>
<p>以上的方法都是针对单核 CPU 进行协同仿真的，但多核会更加复杂，多核涉及到不同核心之间的同步、通信等等，很难把一个周期精确的 CPU 和一个不精确的模拟器匹配起来。香山提供了一个思路：<a href="https://github.com/OpenXiangShan/XiangShan-doc/blob/main/slides/20210624-RVWC-SMP-Difftest%20%E6%94%AF%E6%8C%81%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E5%B7%AE%E5%88%86%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.pdf">https://github.com/OpenXiangShan/XiangShan-doc/blob/main/slides/20210624-RVWC-SMP-Difftest%20%E6%94%AF%E6%8C%81%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E5%B7%AE%E5%88%86%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.pdf</a></p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/03/23/core-cosim/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-22 00:00:00">2023年3月22日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 27 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/">软硬件队列接口</a></h2>
<h3 id="_2"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_2">背景</a></h3>
<p>在网卡等场景下，经常会需要在软硬件之间传输大量的数据，通常的方法是建立循环队列，例如 H2C（Host to Chip）方向，是 Host 作为 Producer 增加数据到队尾，Chip 作为 Consumer 从队头读取数据。由于每次传输的数据不定长，为了方便，队列的项是一个定长的 Descriptor，Descriptor 指向了数据的地址。但具体的细节，不同的实现还不太一样。下面逐个案例进行分析。</p>
<h3 id="axi-dma"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#axi-dma">AXI DMA</a></h3>
<p>文档：<a href="https://docs.xilinx.com/r/en-US/pg021_axi_dma">https://docs.xilinx.com/r/en-US/pg021_axi_dma</a></p>
<p>如果在 Xilinx FPGA 上使用过以太网，那大概率会接触到 AXI DMA 这个 IP，它负责把以太网 MAC 的 AXI Stream 数据用 DMA 的形式通过内存来与操作系统交互。</p>
<h4 id="_3"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_3">发送队列</a></h4>
<p>它的收和发各是一个队列，首先来看发送队列：</p>
<p>发送队列由一个头指针（MM2S_CURDESC）和一个尾指针定义（MM2S_TAILDESC），指针指向的是一个 Scatter Gather Descriptor，Descriptor 的内容包括：</p>
<ul>
<li>NXTDESC：队列下一项的地址</li>
<li>BUFFER_ADDRESS：要传输的数据的地址</li>
<li>CONTROL：控制信息</li>
<li>STATUS：状态信息</li>
<li>APP0 to APP4：附带的信息</li>
</ul>
<p>可见这个发送队列实际上是一个链表：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">axi_dma_desc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-2"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">axi_dma_desc</span><span class="w"> </span><span class="o">*</span><span class="n">nxtdesc</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-3"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer_address</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-4"></a><span class="w">  </span><span class="c1">// omitted</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-0-5"></a><span class="p">};</span>
</span></code></pre></div>
<p>当 MM2S_TAILDESC 被更新的时候，硬件会从 CURDESC 开始逐个 Descriptor 处理，直到遇到 TAILDESC 为止：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-1"></a><span class="c1">// when taildesc is changed</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">taildesc_changed</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-3"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-4"></a><span class="w">    </span><span class="n">dma_send</span><span class="p">(</span><span class="n">curdesc</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curdesc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">taildesc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-6"></a><span class="w">      </span><span class="n">curdesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curdesc</span><span class="o">-&gt;</span><span class="n">nxtdesc</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-8"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">curdesc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">taildesc</span><span class="p">);</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-1-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>所以，实际上是驱动不断地提供一个链表给 AXI DMA 去发送，至于这个链表是只有一个元素的数组，还是用一个循环队列去实现，都是可能的。</p>
<h5 id="u-boot"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#u-boot">U-Boot</a></h5>
<p>下面来看 U-Boot 的例子，驱动是 <a href="https://github.com/u-boot/u-boot/blob/v2023.01/drivers/net/xilinx_axi_emac.c">xilinx_axi_emac.c</a>。这个驱动的实现很简单：每次需要发送的时候，只准备一个 Descriptor，发完就轮询直到发送成功。显然这个写法没有很好地利用 DMA 的异步特性，但胜在简单。下面是 <code>axiemac_send</code> 的部分源码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_send</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-2"></a><span class="w">  </span><span class="cm">/* Setup Tx BD */</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-3"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_bd</span><span class="p">));</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-4"></a><span class="w">  </span><span class="cm">/* At the end of the ring, link the last BD back to the top */</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-5"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">next_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">);</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-6"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">next_desc_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">);</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-7"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">buf_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-8"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">buf_addr_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-9"></a><span class="w">  </span><span class="cm">/* Save len */</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-10"></a><span class="w">  </span><span class="n">tx_bd</span><span class="p">.</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_TXSOF_MASK</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-11"></a><span class="w">            </span><span class="n">XAXIDMA_BD_CTRL_TXEOF_MASK</span><span class="p">;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-13"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">);</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-15"></a><span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-16"></a><span class="w">  </span><span class="cm">/* Start the hardware */</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-17"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-18"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-19"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-21"></a><span class="w">  </span><span class="cm">/* Start transfer */</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-22"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-23"></a>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-24"></a><span class="w">  </span><span class="cm">/* Wait for transmission to complete */</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-25"></a><span class="w">  </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;axiemac: Waiting for tx to be done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-26"></a><span class="w">  </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-27"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-28"></a><span class="w">      </span><span class="p">(</span><span class="n">XAXIDMA_IRQ_DELAY_MASK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">XAXIDMA_IRQ_IOC_MASK</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-29"></a><span class="w">    </span><span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-30"></a><span class="w">    </span><span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-31"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-2-32"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="linux"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#linux">Linux</a></h5>
<p>再来看 Linux 的 驱动：<a href="https://github.com/torvalds/linux/blob/v6.2/drivers/net/ethernet/xilinx/xilinx_axienet_main.c">xilinx_axienet_main.c</a>。它采取的方法是分配一个 Descriptor 数组，然后把数组的每一项都指向下一项（最后一项指向第一项），形成一个链表形式的循环队列，维护一个尾指针。下面是初始化代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_dma_bd_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">ndev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-2"></a><span class="w">  </span><span class="cm">/* Allocate the Tx and Rx buffer descriptors. */</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-3"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-4"></a><span class="w">           </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-5"></a><span class="w">           </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-7"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-8"></a><span class="w">    </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-9"></a><span class="w">          </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-10"></a><span class="w">          </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">);</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-12"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-13"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-14"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-16"></a><span class="w">  </span><span class="cm">/* Write to the RS (Run-stop) bit in the Tx channel control register.</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-17"></a><span class="cm">   * Tx channel is now ready to run. But only after we write to the</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-18"></a><span class="cm">   * tail pointer register that the Tx channel will start transmitting.</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-19"></a><span class="cm">   */</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-20"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_TX_CDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="p">);</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-21"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_cr</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-22"></a><span class="w">  </span><span class="n">axienet_dma_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_TX_CR_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_cr</span><span class="p">);</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-3-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>初始化好了以后，每当要发送数据的时候，就写入 tail 指针指向的 Descriptor，然后增加 tail 指针，同时告诉硬件开始 DMA：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="n">netdev_tx_t</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-2"></a><span class="nf">axienet_start_xmit</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">ndev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-3"></a><span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="n">num_frag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">axienet_check_tx_bd_space</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">num_frag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-8"></a><span class="w">  </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-9"></a><span class="w">            </span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span><span class="w"> </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-10"></a><span class="w">  </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-11"></a><span class="w">  </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_TXSOF_MASK</span><span class="p">;</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-13"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_frag</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">)</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-15"></a><span class="w">      </span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-16"></a><span class="w">    </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">new_tail_ptr</span><span class="p">];</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-17"></a><span class="w">    </span><span class="n">frag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-18"></a><span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-19"></a><span class="w">              </span><span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-20"></a><span class="w">              </span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-21"></a><span class="w">              </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-22"></a><span class="w">    </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-23"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-24"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-26"></a><span class="w">  </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_TXEOF_MASK</span><span class="p">;</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-27"></a><span class="w">  </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-29"></a><span class="w">  </span><span class="n">tail_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">new_tail_ptr</span><span class="p">;</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-30"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">)</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-31"></a><span class="w">    </span><span class="n">new_tail_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-32"></a><span class="w">  </span><span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="p">,</span><span class="w"> </span><span class="n">new_tail_ptr</span><span class="p">);</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-33"></a>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-34"></a><span class="w">  </span><span class="cm">/* Start the transfer */</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-35"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_TX_TDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">tail_p</span><span class="p">);</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-4-36"></a><span class="p">}</span>
</span></code></pre></div>
<p>实现思路：</p>
<ol>
<li>检查是否有足够的空闲 Descriptor</li>
<li>对于要发送的数据的每一段，都填入一个 Descriptor</li>
<li>写入新的 tail 指针，启动 DMA</li>
</ol>
<p>那么，又有一个问题：如何知道硬件完成了 DMA 传输，释放了 Descriptor 呢？答案是，AXI DMA 传输完成时，会通过中断通知 CPU，Linux 最终会调用 <code>axienet_free_tx_chain</code> 函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_free_tx_chain</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">axienet_local</span><span class="w"> </span><span class="o">*</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">first_bd</span><span class="p">,</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-2"></a><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_bds</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">sizep</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">axidma_bd</span><span class="w"> </span><span class="o">*</span><span class="n">cur_p</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-5"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-6"></a><span class="w">  </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-7"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-9"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_bds</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-10"></a><span class="w">    </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[(</span><span class="n">first_bd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_num</span><span class="p">];</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-11"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-13"></a><span class="w">    </span><span class="cm">/* If force is not specified, clean up only descriptors</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-14"></a><span class="cm">     * that have been completed by the MAC.</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-15"></a><span class="cm">     */</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_COMPLETE_MASK</span><span class="p">))</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-17"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-19"></a><span class="w">    </span><span class="cm">/* Ensure we see complete descriptor update */</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-20"></a><span class="w">    </span><span class="n">dma_rmb</span><span class="p">();</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-21"></a><span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc_get_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-22"></a><span class="w">    </span><span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-23"></a><span class="w">         </span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_CTRL_LENGTH_MASK</span><span class="p">),</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-24"></a><span class="w">         </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_COMPLETE_MASK</span><span class="p">))</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-27"></a><span class="w">      </span><span class="n">napi_consume_skb</span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">budget</span><span class="p">);</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-28"></a>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-29"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-30"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-31"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-32"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-33"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-34"></a><span class="w">    </span><span class="cm">/* ensure our transmit path and device don&#39;t prematurely see status cleared */</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-35"></a><span class="w">    </span><span class="n">wmb</span><span class="p">();</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-36"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-37"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-38"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-39"></a>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-40"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-5-41"></a><span class="p">}</span>
</span></code></pre></div>
<p>从代码来看，其实也很简单：AXI DMA 传输完成后，会设置 status 的内容，标记已经传输完成。这时候只要从最后一次完成传输的 Descriptor 开始扫描，把所有完成传输的 Descriptor 回收即可。</p>
<h4 id="_4"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_4">接收队列</a></h4>
<p>接收队列结构与发送队列相似，但不同的是，生产者和消费者的角色对调，驱动为了保证随时可以接收数据，需要预先准备好 Descriptor，当 AXI DMA 从以太网 MAC 收到数据的时候，随时有 Descriptor 可以使用，写入数据后，再通知 CPU。和发送队列一样，接收队列由一个头指针（S2MM_CURDESC）和一个尾指针定义（S2MM_TAILDESC），指针指向的 Descriptor 结构与发送队列一致。硬件的接收逻辑和发送逻辑类似，只不过方向相反。</p>
<h5 id="u-boot_1"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#u-boot_1">U-Boot</a></h5>
<p>首先还是来看 U-Boot 的实现。前面提到，为了简化，U-Boot 的网卡驱动每次同时只会发送一个帧，接收的时候其实也一样：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-1"></a><span class="p">(</span><span class="n">some</span><span class="w"> </span><span class="n">net</span><span class="w"> </span><span class="n">operation</span><span class="w"> </span><span class="p">(</span><span class="n">ping</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tftp</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">whatever</span><span class="p">...))</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-2"></a><span class="n">eth_init</span><span class="p">()</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-3"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">()</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-4"></a><span class="n">eth_send</span><span class="p">()</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-5"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">()</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-6"></a><span class="n">eth_rx</span><span class="p">()</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-7"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">()</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-8"></a><span class="w">  </span><span class="p">(</span><span class="n">process</span><span class="w"> </span><span class="n">packet</span><span class="p">)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-9"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_pkt</span><span class="p">)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-10"></a><span class="w">    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">free_pkt</span><span class="p">()</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-11"></a><span class="n">eth_halt</span><span class="p">()</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-6-12"></a><span class="w">  </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">()</span>
</span></code></pre></div>
<p>首先看 AXI EMAC 驱动如何初始化接收队列：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-1"></a><span class="k">static</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">rxframe</span><span class="p">[</span><span class="n">PKTSIZE_ALIGN</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">DMAALIGN</span><span class="p">)));</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_start</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-4"></a><span class="w">  </span><span class="cm">/* Start DMA RX channel. Now it&#39;s ready to receive data.*/</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-5"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-7"></a><span class="w">  </span><span class="cm">/* Setup the BD. */</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-8"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-9"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-10"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-11"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-12"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-13"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-14"></a><span class="w">  </span><span class="cm">/* Flush the last BD so DMA core could see the updates */</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-15"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-16"></a>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-17"></a><span class="w">  </span><span class="cm">/* It is necessary to flush rxframe because if you don&#39;t do it</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-18"></a><span class="cm">   * then cache can contain uninitialized data */</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-19"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">));</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-20"></a>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-21"></a><span class="w">  </span><span class="cm">/* Start the hardware */</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-22"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-23"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-24"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-25"></a>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-26"></a><span class="w">  </span><span class="cm">/* Rx BD is ready - start */</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-27"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-7-28"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到它只初始化了一个 Descriptor，并且把 CURDESC 和 TAILDESC 都指向它，并且提供了一个缓冲区 <code>rxframe</code>。当 AXI DMA 接收到数据的时候，就会把数据写入 <code>rxframe</code>，更新 <code>rx_bd</code> 并发送中断。U-Boot 处理中断的方法也很简单：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_recv</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">**</span><span class="n">packetp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-2"></a><span class="w">  </span><span class="cm">/* Disable IRQ for a moment till packet is handled */</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-3"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-4"></a><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">XAXIDMA_IRQ_ALL_MASK</span><span class="p">;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-5"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-7"></a><span class="w">  </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_ACTUAL_LEN_MASK</span><span class="p">;</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-8"></a><span class="w">  </span><span class="o">*</span><span class="n">packetp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rxframe</span><span class="p">;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-9"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-8-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>它关闭了 AXI DMA 的中断，然后直接读取长度，把 <code>rxframe</code> 作为数据指针传给网络栈处理的函数。网络栈处理完以后，就会调用 <code>free_pkt</code> 进行收尾：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axiemac_free_pkt</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-2"></a><span class="cp">##ifdef DEBUG</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-3"></a><span class="w">  </span><span class="cm">/* It is useful to clear buffer to be sure that it is consistent */</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-4"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">rxframe</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">));</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-5"></a><span class="cp">##endif</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-6"></a><span class="w">  </span><span class="cm">/* Setup RxBD */</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-7"></a><span class="w">  </span><span class="cm">/* Clear the whole buffer and setup it again - all flags are cleared */</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-8"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-9"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-10"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">next_desc_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">);</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-11"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-12"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">buf_addr_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-13"></a><span class="w">  </span><span class="n">rx_bd</span><span class="p">.</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">);</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-15"></a><span class="w">  </span><span class="cm">/* Write bd to HW */</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-16"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_bd</span><span class="p">));</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-18"></a><span class="w">  </span><span class="cm">/* It is necessary to flush rxframe because if you don&#39;t do it</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-19"></a><span class="cm">   * then cache will contain previous packet */</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-20"></a><span class="w">  </span><span class="n">flush_cache</span><span class="p">((</span><span class="n">phys_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxframe</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rxframe</span><span class="p">));</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-21"></a>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-22"></a><span class="w">  </span><span class="cm">/* Rx BD is ready - start again */</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-23"></a><span class="w">  </span><span class="n">axienet_dma_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_bd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmarx</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-9-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>收尾工作也很简单，把接收队列恢复到可以接收数据的状态即可，因为 <code>rxframe</code> 是全局变量，也不需要进行 <code>free</code>。</p>
<h5 id="linux_1"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#linux_1">Linux</a></h5>
<p>Linux 的驱动实现里，接收队列和发送队列类似，也是用一个数组来实现循环链表，只不过接收队列还需要提前准备好缓冲区，供 AXI DMA 写入：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_dma_bd_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">ndev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-2"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-3"></a><span class="w">           </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">,</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-4"></a><span class="w">           </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-5"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-6"></a><span class="w">    </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-8"></a><span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-9"></a><span class="w">      </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">);</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-10"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-11"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-12"></a>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-13"></a><span class="w">    </span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">);</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-14"></a>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-15"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-16"></a><span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-17"></a><span class="w">              </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">,</span><span class="w"> </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-18"></a><span class="w">    </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-19"></a>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-20"></a><span class="w">    </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">;</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-21"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-23"></a><span class="w">  </span><span class="cm">/* Populate the tail pointer and bring the Rx Axi DMA engine out of</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-24"></a><span class="cm">   * halted state. This will make the Rx side ready for reception.</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-25"></a><span class="cm">   */</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-26"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_CDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="p">);</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-27"></a><span class="w">  </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_cr</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">XAXIDMA_CR_RUNSTOP_MASK</span><span class="p">;</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-28"></a><span class="w">  </span><span class="n">axienet_dma_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_CR_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_cr</span><span class="p">);</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-29"></a><span class="w">  </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_TDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-30"></a><span class="w">           </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)));</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-10-31"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，数组的每一项的指针指向下一项，然后把头地址写入 CURDESC，尾地址写入 TAILDESC，这样硬件就可以开始接收数据。AXI DMA 收到数据以后，会把数据写入 Descriptor 指向的缓冲区地址，然后发送中断，Linux 执行下列代码处理中断：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">axienet_rx_poll</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">napi_struct</span><span class="w"> </span><span class="o">*</span><span class="n">napi</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-2"></a><span class="w">  </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">];</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-4"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">packets</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">budget</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">XAXIDMA_BD_STS_COMPLETE_MASK</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-5"></a><span class="w">    </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">phys</span><span class="p">;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-7"></a><span class="w">    </span><span class="cm">/* Ensure we see complete descriptor update */</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-8"></a><span class="w">    </span><span class="n">dma_rmb</span><span class="p">();</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-10"></a><span class="w">    </span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-11"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-12"></a>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-13"></a><span class="w">    </span><span class="cm">/* skb could be NULL if a previous pass already received the</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-14"></a><span class="cm">     * packet for this slot in the ring, but failed to refill it</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-15"></a><span class="cm">     * with a newly allocated buffer. In this case, don&#39;t try to</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-16"></a><span class="cm">     * receive it again.</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-17"></a><span class="cm">     */</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-19"></a><span class="w">      </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000FFFF</span><span class="p">;</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-20"></a>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-21"></a><span class="w">      </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc_get_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-22"></a><span class="w">      </span><span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">,</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-23"></a><span class="w">           </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-25"></a><span class="w">      </span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-26"></a><span class="w">      </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-27"></a>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-28"></a><span class="w">      </span><span class="n">napi_gro_receive</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">);</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-29"></a>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-30"></a><span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-31"></a><span class="w">      </span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-33"></a>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-34"></a><span class="w">    </span><span class="n">new_skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">napi_alloc_skb</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">);</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-35"></a>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-36"></a><span class="w">    </span><span class="n">phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-37"></a><span class="w">              </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">,</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-38"></a><span class="w">              </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-39"></a><span class="w">    </span><span class="n">desc_set_phys_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">phys</span><span class="p">,</span><span class="w"> </span><span class="n">cur_p</span><span class="p">);</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-40"></a>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-41"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_frm_size</span><span class="p">;</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-42"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-43"></a><span class="w">    </span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_skb</span><span class="p">;</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-44"></a>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-45"></a><span class="w">    </span><span class="cm">/* Only update tail_p to mark this slot as usable after it has</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-46"></a><span class="cm">     * been successfully refilled.</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-47"></a><span class="cm">     */</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-48"></a><span class="w">    </span><span class="n">tail_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">;</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-49"></a>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-50"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_num</span><span class="p">)</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-51"></a><span class="w">      </span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-52"></a><span class="w">    </span><span class="n">cur_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">];</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-53"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-54"></a>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-55"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tail_p</span><span class="p">)</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-56"></a><span class="w">    </span><span class="n">axienet_dma_out_addr</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="w"> </span><span class="n">XAXIDMA_RX_TDESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">tail_p</span><span class="p">);</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-11-57"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，接收逻辑顺序扫描了 Descriptor，找到那些传输完成的，把其中的数据交给网络栈处理，然后分配一个新的 skb，绑定到 Descriptor 上，把它恢复到可以接收数据的状态，最后更新 TAILDESC。</p>
<h4 id="_5"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_5">小结</a></h4>
<p>AXI DMA 提供了一个 Descriptor 链来异步地传输数据，U-Boot 为了简化，把链表退化成只有一个节点，串行地收和发；Linux 使用数组实现了一个循环的链表，通过 TAILDESC 提供新的 Descriptor，然后从 CURDESC 回收 Descriptor。Descriptor 不断在硬件和软件之间交替，CURDESC 到 TAILDESC 的部分归硬件，其余的归软件。这种设计模式在其他很多地方也可以看到。</p>
<h3 id="intel-82599"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#intel-82599">Intel 82599</a></h3>
<p>Intel 82599 是一个有线网卡，Linux 的驱动是 ixgbe。Intel 82599 为收和发都提供了多个队列，每个队列都对应了一个 Descriptor 数组，在内存中连续存放。Linux 驱动使用了 64 个接收队列和发送队列。</p>
<p>文档链接：<a href="https://cdrdv2-public.intel.com/331520/82599-datasheet-v3-4.pdf">https://cdrdv2-public.intel.com/331520/82599-datasheet-v3-4.pdf</a></p>
<h4 id="_6"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_6">接收队列</a></h4>
<p>和 AXI DMA 的链表形式不同。每个接收队列都由如下的寄存器定义：</p>
<ul>
<li>RDBAL/RDBAH[n]: Receive Descriptor Base Address Low/High</li>
<li>RDLEN[n]: Receive Descriptor Length</li>
<li>RDH[n]: Receive Descriptor Head</li>
<li>RDT[n]: Receive Descriptor Tail</li>
</ul>
<p>由基地址 + 长度定义了一个循环队列，然后从 Head 到 Tail 的部分是当前有效的队列，软件从 Tail 插入新的 Descriptor，硬件从 Head 取 Descriptor。当 Head 等于 Tail 的时候，队列是空的，也就是说 Tail 表示的是合法的下一个，这样队列满的时候 Tail + 1 == Head。</p>
<p>ixgbe 的实现代码在 <code>ixgbe_main.c</code> 中，首先看如何初始化接收队列：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ixgbe_configure_rx</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-2"></a><span class="w">  </span><span class="cm">/*</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-3"></a><span class="cm">   * Setup the HW Rx Head and Tail Descriptor Pointers and</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-4"></a><span class="cm">   * the Base and Length of the Rx Descriptor Ring</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-5"></a><span class="cm">   */</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-6"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-7"></a><span class="w">    </span><span class="n">ixgbe_configure_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-8"></a><span class="p">}</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ixgbe_configure_rx_ring</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-11"></a><span class="w">           </span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_ring</span><span class="w"> </span><span class="o">*</span><span class="n">ring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-12"></a><span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">rdba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-13"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDBAL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">rdba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-14"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDBAH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">rdba</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">));</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-15"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDLEN</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-16"></a><span class="w">      </span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span><span class="w"> </span><span class="nc">ixgbe_adv_rx_desc</span><span class="p">));</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-18"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDH</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-19"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-20"></a><span class="w">  </span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">IXGBE_RDT</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">);</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-21"></a>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-22"></a><span class="w">  </span><span class="cm">/* enable receive descriptor ring */</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-23"></a><span class="w">  </span><span class="n">rxdctl</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">IXGBE_RXDCTL_ENABLE</span><span class="p">;</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-24"></a><span class="w">  </span><span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">IXGBE_RXDCTL</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">),</span><span class="w"> </span><span class="n">rxdctl</span><span class="p">);</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-25"></a>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-26"></a><span class="w">  </span><span class="cm">/* in ixgbe_alloc_rx_buffers */</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-27"></a><span class="w">  </span><span class="n">bufsz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ixgbe_rx_bufsz</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-29"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ixgbe_alloc_mapped_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span><span class="w"> </span><span class="n">bi</span><span class="p">))</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-31"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-32"></a>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-33"></a><span class="w">    </span><span class="cm">/* sync the buffer for use by the device */</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-34"></a><span class="w">    </span><span class="n">dma_sync_single_range_for_device</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-35"></a><span class="w">             </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span><span class="w"> </span><span class="n">bufsz</span><span class="p">,</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-36"></a><span class="w">             </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-37"></a>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-38"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-39"></a><span class="cm">     * Refresh the desc even if buffer_addrs didn&#39;t change</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-40"></a><span class="cm">     * because each write-back erases this info.</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-41"></a><span class="cm">     */</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-42"></a><span class="w">    </span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">pkt_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">);</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-43"></a>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-44"></a><span class="w">    </span><span class="n">rx_desc</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-45"></a><span class="w">    </span><span class="cm">/* clear the length for the next_to_use descriptor */</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-46"></a><span class="w">    </span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">upper</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-47"></a>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-48"></a><span class="w">    </span><span class="n">cleaned_count</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-49"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cleaned_count</span><span class="p">);</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-50"></a>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-51"></a><span class="w">  </span><span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-12-52"></a><span class="p">}</span>
</span></code></pre></div>
<p>具体到实现上，可以看到和 AXI DMA 驱动基本是一样的：分配 Descriptor 数组空间，然后给每个 Descriptor 分配一个 Buffer，然后更新 tail 指针，让硬件可以开始进行接收。</p>
<h4 id="_7"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_7">发送队列</a></h4>
<p>发送队列和接收队列类似，也是先分配好 Descriptor 数组，只不过先不填内容，等到要发送数据的时候，再从 tail 取出一个 Descriptor，写入 buffer 地址，然后更新 tail 指针让硬件发送。代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-1"></a><span class="n">netdev_tx_t</span><span class="w"> </span><span class="nf">ixgbe_xmit_frame_ring</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-2"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-3"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_ring</span><span class="w"> </span><span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-4"></a><span class="w">  </span><span class="cm">/* record the location of the first descriptor for this packet */</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-5"></a><span class="w">  </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">];</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-6"></a><span class="w">  </span><span class="n">first</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="p">;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-7"></a><span class="w">  </span><span class="n">first</span><span class="o">-&gt;</span><span class="n">bytecount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-9"></a><span class="w">  </span><span class="cm">/* in ixgbe_tx_map */</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-10"></a><span class="w">  </span><span class="n">dma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-12"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">frag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];;</span><span class="w"> </span><span class="n">frag</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">dma</span><span class="p">))</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-14"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">dma_error</span><span class="p">;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-16"></a><span class="w">    </span><span class="cm">/* record length, and DMA address */</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-17"></a><span class="w">    </span><span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-18"></a><span class="w">    </span><span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">dma</span><span class="p">,</span><span class="w"> </span><span class="n">dma</span><span class="p">);</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-19"></a>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-20"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buffer_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-21"></a>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-22"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-23"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">cmd_type_len</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-24"></a><span class="w">        </span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_type</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">);</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-25"></a>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-26"></a><span class="w">      </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-27"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-28"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-29"></a><span class="w">        </span><span class="n">tx_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-30"></a><span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-31"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-32"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">olinfo_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-33"></a>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-34"></a><span class="w">      </span><span class="n">dma</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">;</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-35"></a><span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">IXGBE_MAX_DATA_PER_TXD</span><span class="p">;</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-36"></a>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-37"></a><span class="w">      </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buffer_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-39"></a>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-40"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">cmd_type_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_type</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-41"></a>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-42"></a><span class="w">    </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-43"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-45"></a><span class="w">      </span><span class="n">tx_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IXGBE_TX_DESC</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-46"></a><span class="w">      </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-48"></a><span class="w">    </span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">olinfo_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-49"></a>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-50"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-51"></a><span class="w">    </span><span class="n">data_len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-52"></a>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-53"></a><span class="w">    </span><span class="n">dma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">frag</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-54"></a><span class="w">               </span><span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-55"></a>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-56"></a><span class="w">    </span><span class="n">tx_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-57"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-58"></a>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-59"></a><span class="w">  </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-60"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-61"></a><span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-62"></a>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-63"></a><span class="w">  </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-64"></a>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-65"></a><span class="w">  </span><span class="n">ixgbe_maybe_stop_tx</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span><span class="w"> </span><span class="n">DESC_NEEDED</span><span class="p">);</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-66"></a>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-67"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">netif_xmit_stopped</span><span class="p">(</span><span class="n">txring_txq</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">netdev_xmit_more</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-68"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-69"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-13-70"></a><span class="p">}</span>
</span></code></pre></div>
<p>这一段代码的思路是，对于 skb 的每个 frag，尝试填入 Descriptor，如果发现填不下，就填多个，直到填完位置，最后更新 tail 指针，让硬件开始发送。</p>
<h4 id="_8"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#_8">小结</a></h4>
<p>在了解 AXI DMA 的工作原理的基础上，Intel 82599 的队列其实也不复杂，只不过直接采取了以 Descriptor 数组作为循环队列的方式，并且这里归属于硬件的 Descriptor 空间其实是 [Head, Tail) 左闭右开区间的形式（AXI DMA 是链表的头和尾，都属于硬件），这样就可以用 Head == Tail 来表示空队列，当然了，队列也永远会差一项才能满（除非额外记录队列中合法元素个数）。最后贴一张 Intel 82599 Datasheet 中的图片来帮助理解：</p>
<p><img alt="" src="/images/82599_queue.png" /></p>
<h3 id="connectx-4"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#connectx-4">ConnectX-4</a></h3>
<p>接下来看看 ConnectX-4 是如何设计它的各个队列的。首先，它有 Work Queue，用于发送数据（Send Queue）和准备接收数据的缓冲区（Receive Queue），然后硬件处理 Work Queue 中的 Entry 后，就会把结果写入到 Completion Queue，并且通过 Event Queue 通知 CPU。</p>
<p>文档：<a href="https://network.nvidia.com/files/doc-2020/ethernet-adapters-programming-manual.pdf">https://network.nvidia.com/files/doc-2020/ethernet-adapters-programming-manual.pdf</a></p>
<h4 id="work-queue"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#work-queue">Work Queue</a></h4>
<p>Work Queue 和前面 Intel 82599 的设计很像，也是一个 Descriptor 的数组的形式，只不过 Work Queue Entry 是不定长的，支持不同的 Entry Format，例如 Send WQE、Receive WQE 和 Shared Receive WQE。</p>
<p>驱动初始化的时候，创建好 Work Queue：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">mlx5e_open_queues</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5e_channel</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">,</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-2"></a><span class="w">           </span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5e_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">,</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-3"></a><span class="w">           </span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5e_channel_param</span><span class="w"> </span><span class="o">*</span><span class="n">cparam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-4"></a><span class="w">  </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mlx5e_open_sqs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">cparam</span><span class="p">);</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-6"></a><span class="w">  </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mlx5e_open_rxq_rq</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cparam</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-14-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>之后，和 Intel 82599 类似，发送的时候就向 Send Queue 插入 Entry，然后更新 Doorbell 让硬件开始发送；为了接收，先分配好缓冲区，初始化 Receive Queue，更新 Doorbell 让硬件开始接收数据。</p>
<h4 id="completion-queue"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#completion-queue">Completion Queue</a></h4>
<p>和 Intel 82599 不同的是，这里表示项目完成是通过 Completion Queue 完成的，也就是说，硬件会向 Completion Queue 插入一项，来表示对应的 Work Queue Entry 完成情况。这样的设计下，Work Queue 完全由软件写入，Completion Queue 完全由硬件写入，不像前面 AXI DMA 和 Intel 82599 那样硬件会更新 Descriptor 里面的状态位。Completion Queue 也有两个 Counter，相当于队列的头和尾指针：Producer Counter 记录了硬件写入的 Completion Queue Entry（CQE）数量，Consumer Counter 记录了软件已经处理了的 CQE 数量。在这里有一个比较有意思的设计：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-1"></a><span class="n">ownership</span><span class="w"> </span><span class="nf">cqe_ownership</span><span class="p">(</span><span class="n">cqe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">((</span><span class="n">consumer_counter</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">log2_cq_size</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SW</span><span class="w"> </span><span class="n">ownership</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-4"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HW</span><span class="w"> </span><span class="n">ownership</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-15-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它根据 consumer_counter 的当前值的高位（mask 掉 CQ 大小对应的 bits）与 CQE 的 owner 字段进行比对，如果相等，就认为是属于软件；否则则是属于硬件。软件在轮询的时候，只有遇到 SW ownership 的 CQE 才会处理，否则就忽略。乍一看，这个设计挺奇怪的，因为溢出的问题，<code>((consumer_counter &gt;&gt; log2_cq_size) &amp; 1)</code> 每次溢出就会取反，所以相应的 ownership 的对应关系也会取反。回想一下，之前 AXI DMA 的做法，接收的时候，软件设置一个状态位，硬件完成接收以后，也设置一个状态位，软件完成处理以后，再恢复状态位为可以接收的状态，这样来回操作比较麻烦。在 ConnectX-4 的这种设计下，硬件只需要在填 CQE 的时候，toggle 一下 owner 位即可，软件不需要修改内容，只需要修改 consumer_counter。</p>
<p>这样看可能比较迷糊，来拆解一下整个过程。首先是 AXI DMA 的接收队列的 Descriptor 的处理：</p>
<ol>
<li>软件设置 status = 0 表示这个 Descriptor 可以接收</li>
<li>硬件设置 status |= COMPLETED</li>
<li>软件读取 status 发现 COMPLETED，处理数据，然后重新设置 status = 0</li>
</ol>
<p>可以看到，Descriptor 的内容是软件和硬件来回修改。ConnectX-4 的设计下，软件不需要对 CQE 做任何修改：</p>
<ol>
<li>初始情况下，owner = 1 和 consumer_counter = 0，对应 HW owner，所以软件不会认为是合法的 CQE</li>
<li>硬件开始向 CQ 插入 CQE，此时 owner ^=1 变为 0，对应 SW owner，所以软件可以开始读取并处理 CQE</li>
<li>硬件不断插入，出现了第一次溢出，软件跟着处理，也第一次溢出了，此时 <code>((consumer_counter &gt;&gt; log2_cq_size) &amp; 1) = 1</code>，此时 1 对应 SW owner，0 对应 HW owner。当硬件插入 CQE 以后，owner 才从 0（HW owner）又变回 1（SW owner），软件就知道，可以继续读取并处理 CQE</li>
<li>这个过程继续下去，owner 的含义不断翻转</li>
</ol>
<p>可以看到，整个过程软件不需要写入 CQE 的内容，只需要不断轮询并更新 consumer_counter。硬件实现也很简单，不断地对 owner 进行异或，就实现了通知软件的功能。这就类似于，每当 counter 溢出的时候，就自动“清空”所有 CQE 的“valid”位，然后硬件再设置“valid = 1”。硬件只需要保证 producer_counter 不会追上 consumer_counter 就可以了，硬件也不需要去读取 CQE 的内容来判断软件是否处理完成。这个方式还是比较有意思的。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">get_sw_cqe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5_ib_cq</span><span class="w"> </span><span class="o">*</span><span class="n">cq</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-2"></a><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-3"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cqe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_cqe</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="p">);</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">mlx5_cqe64</span><span class="w"> </span><span class="o">*</span><span class="n">cqe64</span><span class="p">;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-6"></a><span class="w">  </span><span class="n">cqe64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">mcq</span><span class="p">.</span><span class="n">cqe_sz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">cqe</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cqe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-7"></a>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">get_cqe_opcode</span><span class="p">(</span><span class="n">cqe64</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MLX5_CQE_INVALID</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-9"></a><span class="w">      </span><span class="o">!</span><span class="p">((</span><span class="n">cqe64</span><span class="o">-&gt;</span><span class="n">op_own</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MLX5_CQE_OWNER_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ibcq</span><span class="p">.</span><span class="n">cqe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cqe</span><span class="p">;</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-11"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-13"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="../../networking/2023/03/22/hardware-queue-interface/#__codelineno-16-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际上，写这篇博客就是因为有同学看到了 CQE 的 owner 的奇怪设定，我才来研究的这个问题。我就是为了这点醋，才包的这顿饺子，前面做了一大堆的引入。</p>
<h3 id="chatgpt"><a class="toclink" href="../../networking/2023/03/22/hardware-queue-interface/#chatgpt">ChatGPT 时间</a></h3>
<p>问：What does network driver do to send/receive network packets to/from NIC?</p>
<p>答：A network driver is a software component that allows the operating system to communicate with the network interface card (NIC) and send and receive network packets. The NIC is a hardware device that connects a computer to a network and enables it to communicate with other devices on that network.</p>
<p>When the computer wants to send a network packet, the operating system hands the packet off to the network driver, which then converts it into a format that the NIC can understand. The network driver also sets the appropriate control bits and headers in the packet to ensure that it is correctly transmitted over the network.</p>
<p>When a network packet is received by the NIC, the network driver intercepts it and passes it on to the operating system. The network driver then verifies the packet's integrity, checks if it is destined for the local machine, and if so, hands it over to the appropriate application.</p>
<p>In summary, the network driver acts as a bridge between the operating system and the NIC, enabling the computer to send and receive network packets over the network.</p>
<p>问：Can you give me a detailed description? e.g. the ring buffer and notification mechanism</p>
<p>答：Sure, I can provide a more detailed description of how network drivers use ring buffers and notification mechanisms to send and receive network packets.</p>
<p>A ring buffer is a circular buffer that is used by the network driver to store incoming and outgoing network packets. The buffer is divided into multiple sections or "rings," each of which can hold one or more packets. The ring buffer is used to manage the flow of data between the network driver and the NIC.</p>
<p>When a packet is received by the NIC, it is stored in the receive ring buffer. The network driver then reads the packet from the ring buffer, processes it, and hands it over to the appropriate application.</p>
<p>When the computer wants to send a packet, the network driver first checks if there is space available in the transmit ring buffer. If there is, it writes the packet to the next available slot in the buffer and sets the appropriate control bits and headers.</p>
<p>The network driver then uses a notification mechanism to inform the NIC that there is data available in the transmit ring buffer. This notification mechanism can take different forms, depending on the specific hardware and driver implementation. For example, it might involve writing to a specific memory location or sending an interrupt signal to the NIC.</p>
<p>注：没听说过给 NIC 发送中断。</p>
<p>When the NIC receives the notification, it reads the packet from the transmit ring buffer and sends it over the network.</p>
<p>The ring buffer and notification mechanisms are critical components of network drivers because they enable efficient communication between the operating system and the NIC. By using a circular buffer, the driver can handle multiple packets at once and avoid the need for expensive memory allocations or deallocations. The notification mechanism allows the driver to inform the NIC of data availability without constantly polling the buffer, which would waste CPU cycles and reduce system performance.</p>
<p>注：这里说反了，应该是告诉网卡驱动有数据可用。</p>
<p>问：Can you take Xilinx AXI DMA for example?</p>
<p>答：Sure, let me provide an example of how the Xilinx AXI DMA uses a ring buffer and notification mechanism to send and receive network packets.</p>
<p>The Xilinx AXI DMA is a DMA controller that is commonly used in embedded systems to handle data transfers between a host processor and peripherals, including network interfaces. The AXI DMA uses a scatter-gather DMA engine, which means it can transfer data between non-contiguous memory regions.</p>
<p>In the context of network communication, the AXI DMA is typically used to transfer packets between the network interface card and the host memory. The AXI DMA driver sets up a ring buffer in host memory that is used to store incoming and outgoing packets.</p>
<p>When a packet is received by the NIC, it is stored in a receive ring buffer that is allocated in the host memory. The AXI DMA driver sets up the receive ring buffer and configures the AXI DMA to use it as the destination for incoming packets.</p>
<p>To enable the notification mechanism, the AXI DMA driver configures the AXI DMA to generate an interrupt when a packet is received and stored in the receive ring buffer. The interrupt is sent to the host processor, which then reads the packet from the receive ring buffer and processes it.</p>
<p>When the host processor wants to send a packet, it writes the packet data to a transmit ring buffer that is also allocated in host memory. The AXI DMA driver sets up the transmit ring buffer and configures the AXI DMA to use it as the source for outgoing packets.</p>
<p>To enable the notification mechanism for outgoing packets, the AXI DMA driver configures the AXI DMA to generate an interrupt when the transmit ring buffer is empty and ready to accept a new packet. This interrupt is sent to the host processor, which then writes the next packet to the transmit ring buffer.</p>
<p>The AXI DMA driver manages the ring buffers and interrupt handling to ensure that incoming and outgoing packets are processed efficiently and without data loss.</p>
<p>In summary, the Xilinx AXI DMA uses a ring buffer and notification mechanism to enable efficient transfer of network packets between the NIC and the host memory. The ring buffer is used to manage the flow of incoming and outgoing packets, while the notification mechanism enables the DMA engine to inform the host processor when new data is available or when the buffer is ready to accept new data.</p>
<p>问：How about Intel 82599? What's the difference between Intel 82599 and AXI DMA?</p>
<p>答：The Intel 82599 is a high-performance Ethernet controller that is commonly used in data center and cloud computing environments. Like the AXI DMA, the Intel 82599 also uses a ring buffer and notification mechanism to send and receive network packets.</p>
<p>However, there are some key differences between the Intel 82599 and the AXI DMA. The most significant difference is that the Intel 82599 is a hardware-based Ethernet controller, while the AXI DMA is a DMA controller that is typically used in embedded systems.</p>
<p>As a hardware-based Ethernet controller, the Intel 82599 is optimized for high-speed data transfer and advanced networking features. It includes hardware offloading capabilities that can offload tasks such as TCP/IP checksum calculation, packet segmentation, and packet filtering from the host CPU. This offloading reduces the CPU load and improves overall system performance.</p>
<p>The Intel 82599 uses multiple receive and transmit ring buffers to support parallel data processing and enable high-speed data transfer. The receive ring buffers are used to store incoming packets, while the transmit ring buffers are used to store outgoing packets.</p>
<p>The notification mechanism used by the Intel 82599 is called Interrupt Moderation. This mechanism is used to reduce the number of interrupts generated by the Ethernet controller and improve system efficiency. Interrupt Moderation groups multiple network packets together and generates a single interrupt to notify the host CPU that the packets are ready to be processed.</p>
<p>In summary, the Intel 82599 and the AXI DMA both use ring buffers and notification mechanisms to transfer network packets, but they differ in their design and application. The Intel 82599 is a high-performance Ethernet controller that is optimized for data center and cloud computing environments, while the AXI DMA is a DMA controller that is typically used in embedded systems. The Intel 82599 includes advanced networking features such as hardware offloading and Interrupt Moderation, which improve system performance and efficiency.</p>

    <nav class="md-post__action">
      <a href="../../networking/2023/03/22/hardware-queue-interface/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-20 00:00:00">2023年3月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="80211"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/">802.11 学习</a></h2>
<p>本文的内容已经整合到<a href="/kb/networking/wlan.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#_1">背景</a></h3>
<p>最近在学习 802.11，在博客上记录一下我的学习过程。</p>
<p>本文参考了 <a href="https://ieeexplore.ieee.org/document/654749">802.11-1997</a> 并使用了标准中的图片。</p>
<h3 id="mac"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#mac">MAC 层帧格式</a></h3>
<p>802.11 MAC 层的帧格式，如 802.11-1997 Figure 12：</p>
<p><img alt="" src="/images/80211_mac.png" /></p>
<p>前两个字节 Frame Control 的定义如 802.11-1997 Figure 13：</p>
<p><img alt="" src="/images/80211_frame_control.png" /></p>
<p>根据 Type 和 Subtype 字段决定了帧的类型，如管理（Management）帧，控制（Control）帧和数据（Data）帧。</p>
<p>无线路由器定期发送 Beacon frame，告诉客户端自己广播了哪些 SSID。客户端也可以主动发送 Probe Request frame 来询问有没有路由器有对应的 SSID，如果有，路由器回复一个 Probe Response frame。</p>
<h3 id="phy"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#phy">PHY</a></h3>
<p>802.11 支持很多种 PHY，常见的有 802.11 b/g/n/ac/ax。起名也很有意思：</p>
<ul>
<li>802.11b: High Rate，最高 11 Mbps</li>
<li>802.11g: Extended Rate，最高 54 Mbps</li>
<li>802.11n: High Throughput，最高 600 Mbps</li>
<li>802.11ac: Very High Throughput，最高 6933 Mbps</li>
<li>802.11ax: High Efficiency，最高 9608 Mbps</li>
</ul>
<h4 id="80211b"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#80211b">802.11b</a></h4>
<p>首先看 <a href="https://ieeexplore.ieee.org/document/972833">802.11b</a>，802.11b 是对 802.11 的补充，主要定义了第 18 章 <code>High Rate, direct sequence spread spectrum PHY specification</code>，缩写 HR-DSSS。</p>
<p>HR-DSSS 工作在 2.4 GHz 频段上，常用的是 13 个 channel，中心频率从 2412 MHz 到 2472 MHz 不等，呈等差数列，公差是 5 MHz。HR-DSSS 会占用 22MHz 的频谱，从中心频率减 11 MHz 到中心频率加 11 MHz，所以相邻 channel 会有干扰，见下图（取自 <a href="https://en.wikipedia.org/wiki/IEEE_802.11">Wikipedia</a>）</p>
<p><img alt="" src="/images/80211_channels.png" /></p>
<p>这就是为什么通常会把 2.4GHz 无线路由器的 channel 固定为 1、6 或 11。</p>
<p>那么，HR-DSSS 如何把数据调制为 2.4GHz 上的信号呢？HR-DSSS 支持不同的速率，例如 1、2、5.5 和 11 Mbps，这些二进制的数据需要按照一定的方法调制到 2.4 GHz 的载波上。</p>
<p>首先是最简单的情况，例如在 channel 1 上传输 1 Mbps 的数据，802.11 采用的是 DSSS 的方法。简单来说，对于输入的每个位，扩展成 11 个 bit，这样就得到了一个 11 MHz 的基带信号，然后再把基带信号通过 DBPSK 调制到 2412 MHz 的载波信号上。</p>
<p>这个扩展过程是这样的：如果数据位是 0，那就输出 10110111000（Barker 码）；如果数据位是 1，那就输出 01001000111。实际上就是把 1 位的信息重复了 11 次再发出去，看起来很浪费，但很好地解决了干扰的问题，即使传输中出现了错误，接受方也很容易从 11 位的数据中恢复出原来的数据。</p>
<p>2 Mbps 的传输方式类似，只不过每个 symbol 传输两位的数据，所以采用 DQPSK 的调制方法，频率保持不变，实现了两倍的数据传输速率。</p>
<p>5.5 Mbps 和 11 Mbps 则采用了其他方法。由于上面的 1 比 11 的转换比例太浪费了，所以为了提升速度，5.5 Mbps 和 11 Mbps 时采用的是 CCK 编码方式，具体来说，5.5 Mbps 的时候，输入的 4 个 bit 会映射为 8 个 chip，类似地 11 Mbps 的时候，输入的 8 个 bit 也映射到 8 个 chip。每个 chip 都是复数，采用 DQPSK 进行调制。</p>
<p>可以看到，整个过程都是在冗余：速率低的时候，就冗余很多份；速率高的时候，冗余就比较少。实际上，5.5 Mbps 和 11 Mbps 还可以采用可选的 PBCC 进行编码，下面摘抄了 <a href="https://rfmw.em.keysight.com/wireless/helpfiles/89600b/webhelp/subsystems/wlan-dsss/content/dsss_about_datamodfmt.htm">About Data Modulation Format (802.11b/g DSSS/CCK/PBCC)</a> 中 802.11b 不同速率和编码方式的表格：</p>
<table>
<thead>
<tr>
<th>Data Modulation Formats</th>
<th>Spread Sequence Code scheme</th>
<th>Data Rate(Mbps)</th>
<th>Symbol Rate(Msps)</th>
<th>Chip Rate (Mcps)</th>
<th>Bits per Symbol</th>
<th>Modulation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Barker 1</td>
<td>11 Chip Barker</td>
<td>1</td>
<td>1</td>
<td>11</td>
<td>1</td>
<td>DBPSK</td>
</tr>
<tr>
<td>Barker 2</td>
<td>11 Chip Barker</td>
<td>2</td>
<td>1</td>
<td>11</td>
<td>2</td>
<td>DQPSK</td>
</tr>
<tr>
<td>CCK 5.5</td>
<td>8 chip CCK</td>
<td>5.5</td>
<td>1.375</td>
<td>11</td>
<td>4</td>
<td>DQPSK</td>
</tr>
<tr>
<td>CCK 11</td>
<td>8 chip CCK</td>
<td>11</td>
<td>1.375</td>
<td>11</td>
<td>8</td>
<td>DQPSK</td>
</tr>
<tr>
<td>PBCC 5.5</td>
<td>PBCC</td>
<td>5.5</td>
<td>11</td>
<td>N/A</td>
<td>0.5</td>
<td>QPSK</td>
</tr>
<tr>
<td>PBCC 11</td>
<td>PBCC</td>
<td>11</td>
<td>11</td>
<td>N/A</td>
<td>1</td>
<td>QPSK</td>
</tr>
</tbody>
</table>
<h4 id="80211g"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#80211g">802.11g</a></h4>
<p><a href="https://ieeexplore.ieee.org/document/1210624">802.11g</a> 定义了第 19 章 <code>Extended Rate PHY specification</code>，也就是 ERP(Extended Rate PHY)，其主要采用的技术是 OFDM，连起来就是 ERP-OFDM，额外支持更多速率：6、9、12、18、24、36、48 和 54 Mbps。各种调制技术的速率对比：</p>
<ul>
<li>DSSS: 802.11 1/2 Mbps</li>
<li>CCK: 802.11b 5.5/11 Mbps</li>
<li>OFDM: 802.11g 6/9/12/18/24/36/48/54 Mbps</li>
<li>PBCC: 802.11b 5.5/11 Mbps, 802.11g 22/33 Mbps</li>
</ul>
<p>OFDM 的核心思想就是采用多个载波信号，这些载波信号的频率呈等差数列，同时保证各载波相互正交，这样就提高了数据传输速率。为了保证正交，相邻载波信号的频率的差要满足 <span class="arithmatex">\(\Delta{f} = k / T_U\)</span>，其中 k 是正整数，<span class="arithmatex">\(T_U\)</span> 是每个 symbol 的时间（引用 <a href="https://zh.wikipedia.org/zh-cn/%E6%AD%A3%E4%BA%A4%E9%A0%BB%E5%88%86%E5%A4%8D%E7%94%A8#%E6%AD%A3%E4%BA%A4">wikipedia</a>）。下面是 802.11 标准中的 OFDM PHY 的组成：</p>
<p><img alt="" src="/images/ofdm_circuit.png" /></p>
<p>图中的缩写：</p>
<ul>
<li>FEC: Forward Error Correction</li>
<li>IFFT/FFT: Inverse Fast Fourier Transform/Fast Fourier Transform</li>
<li>GI: Guard Interval</li>
<li>I/Q: In-phase/Quadrature</li>
<li>HPA: High Power Amplifier</li>
<li>LNA: Low Noise Amplifier</li>
<li>AGC: Automatic Gain Control</li>
<li>AFC: Automatic Frequency Control</li>
</ul>
<p>802.11g 的信号带宽是 20MHz，分成 52 个子载波，子载波的间距是 0.3125 MHz（20 MHz / 64，<span class="arithmatex">\(T_{FFT}=3.2 \mu s, \Delta{f} = 1 / T_{FFT}\)</span>），所以实际上只占了 <span class="arithmatex">\(0.3125 \textit{MHz} * 52 = 16.25 \textit{MHz}\)</span> 的频谱。其中 48 个用于传输数据，每个载波上可以采用不同的调制方法。54 Mbps 是怎么算的呢？802.11g 的 Symbol rate 是 250000 每秒（因为 <span class="arithmatex">\(T_{SYM} = 3.2 + 0.8 = 4 \mu s\)</span>），如果使用 64-QAM 调制，那么每个 symbol 对应 6 个 bit，然后使用纠错码，纠错的时候浪费了 1/4 的位，实际数据占 3/4，一共 48 个载波，那么数据速率就是 $ 48 * 250000 * 6 * 3/4 = 54 \textit{Mbps}$。</p>
<h4 id="80211n"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#80211n">802.11n</a></h4>
<p>802.11n 在 802.11g 的基础上添加了 MIMO，也就是可以用多个天线同时传输。</p>
<p>首先还是考虑单天线的情况，基本和 802.11g 相同，区别是采用了 52（<span class="arithmatex">\(N_{SD}\)</span>）个 OFDM 子载波用于传输数据，同时纠错码带来的浪费比例从 1/4 降到了 1/6，所以数据速率是 <span class="arithmatex">\(52 * 250000 * 6 * 5/6 = 65 \textit{Mbps}\)</span>。802.11n 还提供了 Short GI（Guard Interval）选项，把 GI 从 800 ns 降低到 400ns，使得每个 symbol 的时间可以从 <span class="arithmatex">\(3.2 + 0.8 = 4 \mu s\)</span> 降低到 <span class="arithmatex">\(3.2 + 0.4 = 3.6 \mu s\)</span>，此时的数据速率达到 <span class="arithmatex">\(52 * 1000000 / 3.6 * 6 * 5/6 = 72.2 \textit{Mbps}\)</span>。</p>
<p>除此之外，802.11n 还引入了 40 MHz 频宽的选项，以占用更多频谱为代价，换来可以用 108 个子载波来传输数据，此时数据速率可以达到 <span class="arithmatex">\(108 * 1000000 / 3.6 * 6 * 5 / 6 = 150 \textit{Mbps}\)</span>。</p>
<p>考虑多天线，如果同时两根天线传输数据，那么数据速率就是两倍，达到 <span class="arithmatex">\(300 \textit{Mbps}\)</span>；最高可以同时四根天线传输数据，所以数据速率最高理论值是 <span class="arithmatex">\(600 \textit{Mbps}\)</span>。</p>
<h4 id="80211ac"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#80211ac">802.11ac</a></h4>
<p>802.11ac 添加了 160 MHz 频宽的选项，可以提供 468 个子载波，调制方式从 64-QAM 提升到 256-QAM，同时最大可以有 8 根天线同时传输数据，最大数据速率是 <span class="arithmatex">\(468 * 1000000 / 3.6 * 8 * 5 / 6 * 8 = 6933.3 \textit{Mbps}\)</span>。</p>
<p>由此可见，提高无线网络的速率的方法就是提高上式的各个系数：</p>
<ul>
<li>子载波数量：增加频宽，或者在频宽一定的时候，留出更多的子载波用于数据，提升较大，但频率不能太宽</li>
<li>Symbol 时间：减少 Guard Interval，提升不大</li>
<li>QAM 位数：从 PSK 到 4-QAM 到 64-QAM 到 256-QAM，提升难度较大</li>
<li>纠错码开销：不会超过 1，难以提升</li>
<li>更多天线：从 1 到 4 到 8，未来到 16，逐步提升</li>
</ul>
<p>所以要进一步提升性能，主要从子载波数量、QAM 位数和 MIMO 数量上做文章。</p>
<h4 id="80211ax"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#80211ax">802.11ax</a></h4>
<p>802.11ax 可以提供 1960 个子载波（间距从 312.5 kHz 缩小到 78.125 kHz，<span class="arithmatex">\(\Delta{f} = 78.125 kHz, T_{FFT} = 1 / \Delta{f} = 12.8 \mu s\)</span>），调制方式从 256-QAM 提升到 1024-QAM，但是 <span class="arithmatex">\(T_{SYM}\)</span> 也提高到了 <span class="arithmatex">\(12.8 + 0.8 = 13.6 \mu s\)</span>，最大数据速率是 <span class="arithmatex">\(1960 * 1000000 / 13.6 * 10 * 5 / 6 * 8 = 9607.8 \textit{Mbps}\)</span>。</p>
<h4 id="ofdm"><a class="toclink" href="../../hardware/2023/03/20/wireless-network/#ofdm">OFDM 对比</a></h4>
<p>下面总结了使用 OFDM 的 PHY 的各项参数，其中 Data rate 的计算公式：<code>Subcarrier * 1000000 / T_{SYM} * Coding Rate * MIMO streams</code>。</p>
<table>
<thead>
<tr>
<th>Standard</th>
<th>Subcarrier</th>
<th>T_{SYM}</th>
<th>QAM bits</th>
<th>Coding Rate</th>
<th>MIMO streams</th>
<th>Data rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>802.11g</td>
<td>48</td>
<td>4 us</td>
<td>6</td>
<td>3/4</td>
<td>1</td>
<td>54 Mbps</td>
</tr>
<tr>
<td>802.11n</td>
<td>108</td>
<td>3.6 us</td>
<td>6</td>
<td>5/6</td>
<td>4</td>
<td>600 Mbps</td>
</tr>
<tr>
<td>802.11ac</td>
<td>468</td>
<td>3.6 us</td>
<td>8</td>
<td>5/6</td>
<td>8</td>
<td>6933.3 Mbps</td>
</tr>
<tr>
<td>802.11ax</td>
<td>1960</td>
<td>13.6 us</td>
<td>10</td>
<td>5/6</td>
<td>8</td>
<td>9607.8 Mbps</td>
</tr>
</tbody>
</table>

    <nav class="md-post__action">
      <a href="../../hardware/2023/03/20/wireless-network/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-19 00:00:00">2023年3月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/">数字调制</a></h2>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/#_2">背景</a></h3>
<p>最近在学习 802.11，需要学习很多数字调制相关的知识，因此自学了一下通信原理。</p>
<h3 id="ask"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/#ask">ASK</a></h3>
<p>Amplitude-Shift Keying 调整载波信号的幅度</p>
<p><img alt="" src="/images/ask.png" /></p>
<h3 id="fsk"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/#fsk">FSK</a></h3>
<p>Frequency-Shift Keying 调整载波信号的频率</p>
<p><img alt="" src="/images/bfsk.png" /></p>
<h3 id="psk"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/#psk">PSK</a></h3>
<p>Phase-Shift Keying 调整载波信号的相位</p>
<p><img alt="" src="/images/bpsk.png" /></p>
<p>DPSK(Differential Phase-Shift Keying) 是在 PSK 的基础上，把相位的绝对值变成相位的差。例如 BPSK 传输 0 对应 0 度相位，传输 1 对应 180 度相位，那么 DBPSK 传输 0 时保持相位和上一个 symbol 一样，传输 1 时相位相对上一个 symbol 增加 180 度。</p>
<h3 id="qam"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/#qam">QAM</a></h3>
<p>Quadrature Amplitude Modulation 两个正交载波信号之和，调整两个信号的相位和幅度</p>
<h4 id="4-qam"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/#4-qam">4-QAM</a></h4>
<p>4-QAM 也等价于 4-PSK（Phase-Shift Keying），相当于调整一个载波信号的相位。</p>
<p><img alt="" src="/images/4qam.png" /></p>
<h4 id="16-qam"><a class="toclink" href="../../hardware/2023/03/19/digital-modulation/#16-qam">16-QAM</a></h4>
<p><img alt="" src="/images/16qam.png" /></p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/03/19/digital-modulation/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-26 00:00:00">2023年2月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linux-netgear-a6210-usb"><a class="toclink" href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/">在 Linux 上使用 Netgear A6210 USB 无线网卡</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/#_1">背景</a></h3>
<p>最近要让一台 Linux 机器连接无线网，所以要买一个对 Linux 支持比较好的 USB 无线网卡。以前曾经用过一些 USB 无线网卡，但对 Linux 的支持大多不好，要么是需要 out of tree module，要么就忽然不能工作。因此前期的调研十分重要。</p>
<h3 id="usb"><a class="toclink" href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/#usb">挑选 USB 无线网卡</a></h3>
<p>在调研的时候，发现了 <a href="https://github.com/morrownr/USB-WiFi">morrownr/USB-WiFi</a> 仓库，里面总结了一些 Linux 支持比较好的 USB 无线网卡，由于是外国人写的，所以里面很多型号在国内都买不到，但实际上 USB 无线网卡的芯片组一般就是那些，所以需要先确定芯片组，再根据芯片组找对应的 USB 无线网卡。</p>
<p>开发用于 USB 无线网卡的厂商常见的是：Mediatek（2011 年 MediaTek 收购了 Ralink）和 Realtek。国内直接买到的 USB 无线网卡大部分是 Realtek，但是 Realtek 的 Linux 驱动很长一段时间都是 out of tree 的状态，只有比较新的一些芯片组有内核支持，而 Mediatek 系列的芯片内核支持较好，缺点是比较贵。下面从上面的仓库里摘录了一些芯片组的 Linux 内核支持情况：</p>
<table>
<thead>
<tr>
<th>Chipset</th>
<th>Linux</th>
<th>Commit</th>
<th>802.11</th>
<th>USB</th>
<th>Bluetooth</th>
<th>Package</th>
<th>Links</th>
</tr>
</thead>
<tbody>
<tr>
<td>MT7601u</td>
<td>4.2+</td>
<td><a href="https://github.com/torvalds/linux/commit/c869f77d6abb5d5f9f2f1a661d5c53862a9cad34">mt7601u</a></td>
<td>b/g/n</td>
<td>2.0</td>
<td>N/A</td>
<td></td>
<td><a href="https://www.mediatek.cn/products/broadband-wifi/mt7601u">Official</a></td>
</tr>
<tr>
<td>MT7610u</td>
<td>4.19+</td>
<td><a href="https://github.com/torvalds/linux/commit/ff69c75ee5392320ab3a8dd01db46d3cd097eb46">mt76x0u</a></td>
<td>b/g/n/ac</td>
<td>2.0</td>
<td>N/A</td>
<td></td>
<td><a href="https://www.mediatek.cn/products/broadband-wifi/mt7610u">Official</a></td>
</tr>
<tr>
<td>MT7612u</td>
<td>4.19+</td>
<td><a href="https://github.com/torvalds/linux/commit/ee676cd5017c5f71b8aac1f2d1016ba0f6e4f348">mt76x2u</a></td>
<td>b/g/n/ac</td>
<td>3.0</td>
<td>4.0</td>
<td></td>
<td><a href="https://www.mediatek.cn/products/broadband-wifi/mt7612u">Official</a></td>
</tr>
<tr>
<td>MT7662u</td>
<td></td>
<td></td>
<td>b/g/n/ac</td>
<td>3.0</td>
<td>4.0</td>
<td></td>
<td><a href="https://www.mediatek.cn/products/broadband-wifi/mt7662u">Official</a></td>
</tr>
<tr>
<td>MT7921au</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MT7922u</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>RTL8188eus</td>
<td>3.12+</td>
<td>rtl8188eu/r8188eu/<a href="https://github.com/torvalds/linux/commit/3dfb8e844fa30cceb4b810613e2c35f628eb3e70">rtl8xxxu</a> <a href="https://cateee.net/lkddb/web-lkddb/R8188EU.html">LKDDB</a></td>
<td>b/g/n</td>
<td>2.0</td>
<td>N/A</td>
<td>QFN-46</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8188eus">Official</a></td>
</tr>
<tr>
<td>RTL8188gu</td>
<td>N/A</td>
<td><a href="https://github.com/McMCCRU/rtl8188gu">3rd party</a> <a href="https://patchwork.kernel.org/project/linux-wireless/patch/5a9a264d-a59b-0d91-04f0-e5b38e6aaea0@gmail.com/">patch</a></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>RTL8723bu</td>
<td>4.6+</td>
<td><a href="https://github.com/torvalds/linux/commit/35a741febfae3cfc2a27d3b4935e255585ecfd81">rtl8xxxu</a> <a href="https://cateee.net/lkddb/web-lkddb/RTL8XXXU.html">LKDDB</a></td>
<td>b/g/n</td>
<td>2.0</td>
<td>4.0</td>
<td>QFN-56</td>
<td><a href="https://linux-hardware.org/?id=usb:0bda-b720">USB 0bda:b720</a>，<a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8723bu">Official</a></td>
</tr>
<tr>
<td>RTL8723du</td>
<td>6.2+</td>
<td><a href="https://github.com/torvalds/linux/commit/87caeef032fc3921bc866ad7becb6ed51aa8b27b">rtw88</a> <a href="https://cateee.net/lkddb/web-lkddb/RTW88_8723DU.html">LKDDB</a></td>
<td>b/g/n</td>
<td></td>
<td>4.2</td>
<td>QFN-48</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8723du">Official</a></td>
</tr>
<tr>
<td>RTL8811au</td>
<td>N/A</td>
<td><a href="https://docs.alfa.com.tw/Support/Linux/RTL8811AU/">3rd party</a></td>
<td>b/g/n/ac</td>
<td>2.0</td>
<td>N/A</td>
<td>QFN-56</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8811au">Official</a> <a href="https://datasheet.lcsc.com/lcsc/2205121200_Realtek-Semicon-RTL8811AU-CG_C3013607.pdf">Datasheet</a></td>
</tr>
<tr>
<td>RTL8821au</td>
<td>N/A</td>
<td></td>
<td>b/g/n/ac</td>
<td>2.0</td>
<td>4.0</td>
<td>QFN-56</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8821au">Official</a></td>
</tr>
<tr>
<td>RTL8811cu</td>
<td>6.2+</td>
<td><a href="https://github.com/torvalds/linux/commit/aff5ffd718de23cb8603f2e229204670e2644334">rtw88</a> <a href="https://cateee.net/lkddb/web-lkddb/RTW88_8821CU.html">LKDDB</a></td>
<td>b/g/n/ac</td>
<td>2.0</td>
<td>N/A</td>
<td>QFN-56</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8811cu">Official</a>，<a href="https://datasheet.lcsc.com/lcsc/2302141730_Realtek-Semicon-RTL8811CU-CG_C2687136.pdf">Datasheet</a></td>
</tr>
<tr>
<td>RTL8821cu</td>
<td>6.2+</td>
<td><a href="https://github.com/torvalds/linux/commit/aff5ffd718de23cb8603f2e229204670e2644334">rtw88</a> <a href="https://cateee.net/lkddb/web-lkddb/RTW88_8821CU.html">LKDDB</a></td>
<td>b/g/n/ac</td>
<td>2.0</td>
<td>4.2</td>
<td>QFN-56</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8821cu">Official</a>，<a href="https://datasheet.lcsc.com/lcsc/2202211630_Realtek-Semicon-RTL8821CU-CG_C2761145.pdf">Datasheet</a></td>
</tr>
<tr>
<td>RTL8812au</td>
<td>N/A</td>
<td><a href="https://docs.alfa.com.tw/Support/Linux/RTL8812AU/">3rd party</a></td>
<td>b/g/n/ac</td>
<td>3.0</td>
<td>N/A</td>
<td>QFN-76</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8812au">Official</a></td>
</tr>
<tr>
<td>RTL8812bu</td>
<td>6.2+</td>
<td><a href="https://github.com/torvalds/linux/commit/45794099f5e1d7abc5eb07e6eec7e1e5c6cb540d">rtw88</a> <a href="https://cateee.net/lkddb/web-lkddb/RTW88_8822BU.html">LKDDB</a></td>
<td>b/g/n/ac</td>
<td>3.0</td>
<td>N/A</td>
<td>TFBGA</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8812bu">Official</a></td>
</tr>
<tr>
<td>RTL8822bu</td>
<td>6.2+</td>
<td><a href="https://github.com/torvalds/linux/commit/45794099f5e1d7abc5eb07e6eec7e1e5c6cb540d">rtw88</a> <a href="https://cateee.net/lkddb/web-lkddb/RTW88_8822BU.html">LKDDB</a></td>
<td>b/g/n/ac</td>
<td>3.0</td>
<td>4.1</td>
<td>TFBGA</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8822bu">Official</a>，<a href="https://datasheet.lcsc.com/lcsc/2204071230_Realtek-Semicon-RTL8822BU-CG_C2803244.pdf">Datasheet</a></td>
</tr>
<tr>
<td>RTL8822cu</td>
<td>6.2+</td>
<td><a href="https://github.com/torvalds/linux/commit/07cef03b8d44dee7488de3d1585387e603c78676">rtw88</a> <a href="https://cateee.net/lkddb/web-lkddb/RTW88_8822CU.html">LKDDB</a></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>RTL8814au</td>
<td>N/A</td>
<td><a href="https://docs.alfa.com.tw/Support/Linux/RTL8814AU/">3rd party</a></td>
<td>b/g/n/ac</td>
<td>3.0</td>
<td>N/A</td>
<td>QFN-128</td>
<td><a href="https://www.realtek.com/en/products/communications-network-ics/item/rtl8814au">Official</a></td>
</tr>
</tbody>
</table>
<p>可以观察到规律：Realtek 的产品型号中，881x 和 882x 有对应的关系，前者不带蓝牙，后者带。最后一位数字越大，则越新。</p>
<p>在内核源码中可以找到一些使用这个芯片组的 USB 无线网卡型号，但需要注意的是，有时候同样的型号，有 v1v2v3 之分，可能用的是不同的芯片组，购买前需要问清楚。</p>
<p>购买的时候，考虑芯片组的支持情况，Linux 内核版本等等因素，我最后购买了 Netgeat A6210 认证翻新版，使用芯片组 MT7612u，价格是 138 人民币。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/#_2">使用</a></h3>
<p>使用的 Linux 内核版本是 5.10，插上 USB 无线网卡即可使用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/#__codelineno-0-1"></a>$<span class="w"> </span>lsusb
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/#__codelineno-0-2"></a>Bus<span class="w"> </span><span class="m">002</span><span class="w"> </span>Device<span class="w"> </span><span class="m">002</span>:<span class="w"> </span>ID<span class="w"> </span><span class="m">0846</span>:9053<span class="w"> </span>NetGear,<span class="w"> </span>Inc.<span class="w"> </span>A6210
</span></code></pre></div>
<p>在使用 iwd 的连接无线网的时候，还出现一个小插曲，就是 iwd 遇到很长的中文 SSID 时会崩溃，于是我进行了修复，并且发送给 iwd mailing list（<a href="https://lore.kernel.org/iwd/20230226062526.3115588-1-c@jia.je/T/#u">link</a>），并等待修复。原理很简单，一是打印十六进制字符的时候没有考虑符号，二是缺少了缓冲区溢出的检查。</p>
<h3 id="realtek-linux"><a class="toclink" href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/#realtek-linux">Realtek 上游 Linux 内核驱动支持</a></h3>
<p>归功于 Sascha Hauer <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#46;&#104;&#97;&#117;&#101;&#114;&#64;&#112;&#101;&#110;&#103;&#117;&#116;&#114;&#111;&#110;&#105;&#120;&#46;&#100;&#101;">&#115;&#46;&#104;&#97;&#117;&#101;&#114;&#64;&#112;&#101;&#110;&#103;&#117;&#116;&#114;&#111;&#110;&#105;&#120;&#46;&#100;&#101;</a> 老哥，最近 Linux 上游增加了不少对 realtek 网卡的支持，因此只要系统足够新，realtek 的网卡也值得考虑，如：</p>
<ul>
<li>RTL8723du: Linux 6.2+</li>
<li>RTL8811cu: Linux 6.2+</li>
<li>RTL8821cu: Linux 6.2+</li>
<li>RTL8812bu: Linux 6.2+</li>
<li>RTL8822bu: Linux 6.2+</li>
<li>RTL8822cu: Linux 6.2+</li>
</ul>
<p>RTL8188gu 也有正在 review 的 <a href="https://patchwork.kernel.org/project/linux-wireless/patch/5a9a264d-a59b-0d91-04f0-e5b38e6aaea0@gmail.com/">patch</a>。经过我的测试也是工作的。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/02/26/netgear-a6210-linux-wifi-dongle/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-12 00:00:00">2023年2月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="transport-layer-interface"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/">Transport Layer Interface 考古</a></h2>
<h3 id="transport-layer-interface_1"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#transport-layer-interface_1">Transport Layer Interface</a></h3>
<p>现在网络编程主要采用的是 BSD Sockets API，但实际上当年还有另一套 API，就是 TLI（Transport Layer Interface），后来 BSD Sockets 胜出，进入了 POSIX 标准，TLI 后面也标准化为了 XTI，现在可以在部分 Unix 系统中找到。TLI/XTI 的使用方法和 Sockets API 有些类似，但是比较特别的一点在于，Sockets API 第一步是 <code>socket</code> 调用，传的参数就决定了这是 TCP 还是 UDP 还是其他什么协议，而 TLI 是通过打开不同的设备文件来进行区分：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-0-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_open</span><span class="p">(</span><span class="s">&quot;/dev/udp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></div>
<p>比如 TCP 就是 <code>/dev/tcp</code>，UDP 就是 <code>/dev/udp</code>，同理还有 <code>/dev/icmp</code> 等等。这颇有 Unix 的哲学：everything is a file。而 BSD Sockets API 则是有对应的系统调用，libc 基本不需要做什么事情。</p>
<p>沿着这个思路，既然 TLI 第一步是打开一个文件，难道后面的一系列的 bind、connect、send、recv 等操作也是对文件读写吗？是的！如果我们查看 illumos 的<a href="https://github.com/illumos/illumos-gate/blob/46f52c84cb830d1636c093bd5c2d83074aeaf21c/usr/src/lib/libnsl/nsl/_conn_util.c#L76-L82">源码</a>，会发现 <code>t_connect</code> 函数的核心实现是：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-1"></a><span class="w">    </span><span class="n">creq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">T_conn_req</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ctlbufp</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-2"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">PRIM_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_CONN_REQ</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-3"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">DEST_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-4"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">DEST_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-5"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">OPT_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-6"></a><span class="w">    </span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">OPT_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">putmsg</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ctlbufp</span><span class="p">,</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-9"></a><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">strbuf</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">len</span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">udata</span><span class="o">:</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-10"></a><span class="w">        </span><span class="n">t_errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TSYSERR</span><span class="p">;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-1-12"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，这段在 libnsl 中的代码构造了一个结构体 <code>struct T_conn_req</code>，然后通过 <code>putmsg</code> 系统调用发送出去。可以预想，内核那边虚拟了一个 <code>/dev/tcp</code> 设备，这个设备注册了 putmsg 的回调函数。在回调函数中，解析结构体的字段，然后执行相应的操作。用户调用 TLI 函数，然后 libnsl 负责把函数的参数封装成一个结构体，然后向 <code>t_open</code> 打开的设备文件发送结构体的内容。内核和 libnsl 约定好了结构体，然后不同的操作根据结构体的 <code>PRIM_type</code> 字段来区分。实际上，这个约定也是一个标准，叫做 TPI(Transport Provider Interface)。</p>
<h3 id="transport-provider-interface"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#transport-provider-interface">Transport Provider Interface</a></h3>
<p>TPI(Transport Provider Interface) 约定了内核和 libnsl 之间的接口。内核和用户态之间互相发送消息，有点像 HTTP，一个请求过去，一个响应回来。只不过请求是“connect”或者“accept”等等。相比 Sockets API，确实绕了很多，首先要封装到 struct 里面，然后通过统一的读写 syscall 进入到内核，再解析一遍 struct，再做实际的操作。如果直接 syscall 的话，内核实现会比较简单，只不过不“Unix”了。实际上，如过你阅读 Illumos 源码，它在解析 struct 以后，也会转而执行相应的 Sockets 处理函数，然后把返回值再封装成 TLI 的响应，发送给用户程序。</p>
<p>比较有意思的是，TPI 本身也是有状态的：Idle，Unbound，Data Transfer，等待 ACK 等等。所以如果你在 Solaris 上跑 netstat，会发现 UDP 也有状态（Idle/Unbound），那实际上不是 UDP 的状态，而是 TPI 的状态。正因此，我在维护 lsof 的时候，经常看到 TCP/TPI state，不明所以，才会研究 TPI 的历史，然后找到 TLI，才知道除了 Sockets 以外，还有一套 Unix 上的网络 API。有趣的是，TLI 是 System V 提供的，以前经常听到 System V ABI 的说法，却不知道 System V 是一个 Unix 操作系统，现在依然还可以在很多地方看到它的身影。</p>
<h3 id="_1"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#_1">参考资料</a></h3>
<ul>
<li><a href="https://pubs.opengroup.org/onlinepubs/9647699/toc.pdf">Networking Services (XNS)</a></li>
<li><a href="http://www.openss7.org/docs/tpi.pdf">Transport Provider Interface</a></li>
</ul>
<h3 id="chatgpt"><a class="toclink" href="../../networking/2023/02/12/transport-layer-interface/#chatgpt">ChatGPT</a></h3>
<p>问：What is Transport Layer Interface?</p>
<p>答：The Transport Layer Interface (TLI) is an application programming interface (API) that provides a standard interface for communication between an application program and the transport layer protocols of a network. It was originally developed by AT&amp;T for the Unix operating system and is now used in many other operating systems.</p>
<p>The TLI provides a set of functions that allow applications to communicate with the transport layer protocols, such as TCP and UDP, in a network-independent manner. Applications can use TLI to establish connections, send and receive data, and manage network resources.</p>
<p>One of the advantages of TLI is that it provides a layer of abstraction between the application and the transport layer protocols, which allows the application to be independent of the underlying network. This means that an application can be developed using TLI on one operating system and run on another operating system with different transport layer protocols.</p>
<p>However, TLI is an older interface and has largely been replaced by newer interfaces such as the sockets API, which is now the de facto standard for network programming.</p>
<p>问：What's the relationship between Transport Layer Interface and Transport Provider Interface?</p>
<p>答：The Transport Layer Interface (TLI) and Transport Provider Interface (TPI) are both application programming interfaces (APIs) that provide a standard way for applications to communicate with the transport layer protocols of a network. However, they are different interfaces that serve different purposes.</p>
<p>TLI is an API that was developed by AT&amp;T for the Unix operating system to provide a network-independent interface for applications to communicate with transport layer protocols such as TCP and UDP. It provides a set of functions that allow applications to establish connections, send and receive data, and manage network resources.</p>
<p>On the other hand, TPI is an API that was developed by the X/Open consortium to provide a standard interface for communication between the transport layer protocols and network drivers or hardware. It provides a set of functions that allow transport providers to interact with network drivers or hardware and handle network-specific issues such as congestion control, flow control, and error handling.</p>
<p>In other words, TLI is an interface for applications to communicate with the transport layer protocols, while TPI is an interface for transport providers to communicate with network drivers or hardware. The two interfaces are related in that TLI can be implemented using TPI, but they are distinct and serve different purposes in the network architecture.</p>
<p>问：Please write a UDP echo server in Transport Layer Interface</p>
<p>答：Sure, here is an example of a UDP echo server using the Transport Layer Interface (TLI) in C language:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-2"></a><span class="cp">##include &lt;stdlib.h&gt;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-3"></a><span class="cp">##include &lt;unistd.h&gt;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-4"></a><span class="cp">##include &lt;string.h&gt;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-5"></a><span class="cp">##include &lt;sys/types.h&gt;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-6"></a><span class="cp">##include &lt;sys/socket.h&gt;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-7"></a><span class="cp">##include &lt;netinet/in.h&gt;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-8"></a><span class="cp">##include &lt;netdb.h&gt;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-9"></a><span class="cp">##include &lt;tiuser.h&gt;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-11"></a><span class="cp">##define BUFSIZE 1024</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-12"></a><span class="cp">##define SERVICE_NAME &quot;echo&quot;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-14"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-15"></a><span class="p">{</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-17"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">t_call</span><span class="w"> </span><span class="n">call</span><span class="p">;</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-18"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">t_unitdata</span><span class="w"> </span><span class="n">ud</span><span class="p">;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-19"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">t_uderr</span><span class="w"> </span><span class="n">uderr</span><span class="p">;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-20"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">netbuf</span><span class="w"> </span><span class="o">*</span><span class="n">recvbuf</span><span class="p">;</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-21"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-22"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="w"> </span><span class="n">servaddr</span><span class="p">,</span><span class="w"> </span><span class="n">cliaddr</span><span class="p">;</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-23"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hostent</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">;</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-24"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">portno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5001</span><span class="p">;</span><span class="w"> </span><span class="c1">// can be any available port number</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-26"></a><span class="w">    </span><span class="c1">// create socket</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">sockfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_open</span><span class="p">(</span><span class="s">&quot;/dev/udp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-28"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_open&quot;</span><span class="p">);</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-29"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-32"></a><span class="w">    </span><span class="c1">// bind socket to port</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-33"></a><span class="w">    </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-34"></a><span class="w">    </span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">;</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-35"></a><span class="w">    </span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INADDR_ANY</span><span class="p">;</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-36"></a><span class="w">    </span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="n">portno</span><span class="p">);</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-38"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_bind&quot;</span><span class="p">);</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-39"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-41"></a>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-42"></a><span class="w">    </span><span class="c1">// listen for incoming requests</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-43"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-44"></a><span class="w">        </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">call</span><span class="p">));</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-45"></a><span class="w">        </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">));</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-46"></a><span class="w">        </span><span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ud</span><span class="p">));</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-47"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">;</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-48"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">maxlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-49"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-50"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-51"></a><span class="w">        </span><span class="n">call</span><span class="p">.</span><span class="n">udata</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-52"></a>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-53"></a><span class="w">        </span><span class="c1">// receive message</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-54"></a><span class="w">        </span><span class="n">recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">netbuf</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">t_alloc</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="n">T_UNITDATA</span><span class="p">,</span><span class="w"> </span><span class="n">T_ALL</span><span class="p">);</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_rcvudata</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="n">recvbuf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uderr</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-56"></a><span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_rcvudata&quot;</span><span class="p">);</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-57"></a><span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-58"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-59"></a><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-60"></a><span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-61"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-62"></a>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-63"></a><span class="w">        </span><span class="c1">// send message back to client</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-64"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">udata</span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-65"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">udata</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-66"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">;</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-67"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-68"></a><span class="w">        </span><span class="n">ud</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">maxlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-69"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_sndudata</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ud</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-70"></a><span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;t_sndudata&quot;</span><span class="p">);</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-71"></a><span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-72"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-73"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-74"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="../../networking/2023/02/12/transport-layer-interface/#__codelineno-2-75"></a><span class="p">}</span>
</span></code></pre></div>
<p>This UDP echo server listens on a specific port and waits for incoming messages from clients. When it receives a message, it sends the same message back to the client as a response. Note that this example assumes that the TLI library is already installed on your system, and the program is compiled with the appropriate TLI library flags.</p>

    <nav class="md-post__action">
      <a href="../../networking/2023/02/12/transport-layer-interface/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-07 00:00:00">2023年2月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openbsd-xonly"><a class="toclink" href="../../system/2023/02/07/openbsd-xonly/">OpenBSD xonly 实现原理</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/02/07/openbsd-xonly/#_1">背景</a></h3>
<p>最近看到 <a href="https://marc.info/?l=openbsd-tech&amp;m=167501519712725&amp;w=2">xonly status</a>，看到 OpenBSD 最近在实现 xonly，也就是让一些页只能执行，不能读不能写。以往类似的做法是 <code>W^X</code>，也就是可以执行的时候不能写，可以写的时候不能执行。显然，xonly 是更加严格的，连读都不可以。查了一下历史，<code>W^X</code> 最早也是在 OpenBSD 中实现的，说不定以后 xonly 也会被各个操作系统实现。</p>
<h3 id="amd64"><a class="toclink" href="../../system/2023/02/07/openbsd-xonly/#amd64">amd64 上的实现</a></h3>
<p>在 amd64 的页表中，决定执行/读/写权限的是（见 Intel 文档 <code>Table 4-20. Format of a Page-Table Entry that Maps a 4-KByte Page</code>）：</p>
<ul>
<li>Bit 1(R/W): <code>Read/write; if 0, writes may not be allowed to the 4-KByte page referenced by this entry (see Section 4.6)</code></li>
<li>Bit 63(XD): <code>If IA32_EFER.NXE = 1, execute-disable (if 1, instruction fetches are not allowed from the 4-KByte page controlled by this entry; see Section 4.6); otherwise, reserved (must be 0)</code></li>
</ul>
<p>可以看到，在这个定义下，可能出现的权限组合：</p>
<table>
<thead>
<tr>
<th></th>
<th>R</th>
<th>W</th>
<th>X</th>
</tr>
</thead>
<tbody>
<tr>
<td>R/W=0, NXE=0</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>R/W=1, NXE=0</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>R/W=0, NXE=1, XD=0</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>R/W=1, NXE=1, XD=0</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>R/W=0, NXE=1, XD=1</td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>R/W=1, NXE=1, XD=1</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
</tbody>
</table>
<p>需要注意的是，<code>IA32_EFER.NXE</code> 是全局的，而 <code>R/W</code> 和 <code>XD</code> 的粒度是页。可以看到，上面的所有组合中，都是可以读的。</p>
<p>那么，怎么实现 x-only 呢？OpenBSD 的实现方法是 Protection Keys。在比较新的 CPU 中，页表的 4 个位用来表示使用的 Protection Key 下标，一共有 16 个：</p>
<ul>
<li>Bits 62:59: <code>Protection key; if CR4.PKE = 1 or CR4.PKS = 1, this may control the page's access rights (see Section 4.6.2); otherwise, it is ignored and not used to control access rights.</code></li>
</ul>
<p>那么 CPU 在查页表的时候，如果 <code>CR4.PKE=1 or CR4.PKS=1</code>，就会根据这四个位去查找 PKRU 寄存器的取值。PKRU 是一个 32 位的寄存器，每两位对应一个 Protection Key，这两位表示是否允许读写：</p>
<div class="language-text highlight"><pre><span></span><code>The PKRU register (protection-key rights for user pages) is a 32-bit
register with the following format: for each i (0 ≤ i ≤ 15), PKRU[2i] is
the access-disable bit for protection key i (ADi); PKRU[2i+1] is the
write-disable bit for protection key i (WDi). The IA32_PKRS MSR has the
same format (bits 63:32 of the MSR are reserved and must be zero).
</code></pre></div>
<p>有了这个机制以后，就可以构造出 xonly 的页表项：</p>
<ul>
<li>R/W=0：不允许写</li>
<li>NXE=1, XD=0：允许执行</li>
<li>设置 62:59 位为一个 Key 编号，将对应的 PKRU 的两个位设为 1：不允许读，不允许写</li>
</ul>
<p>接下来看 OpenBSD 的<a href="https://github.com/openbsd/src/commit/e9e0c464329db9b56e1f2db65b0f536e53aa7e5f#diff-ab04285d8fd81f41887d9c9de2eb231be5e44c2d465f5c479943a1e21cf977ce">代码</a>：</p>
<p>首先，检测 CPU 是否支持 PKU 机制：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-1"></a><span class="cm">/*</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-2"></a><span class="cm"> * If PKU is available, initialize PROT_EXEC entry correctly,</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-3"></a><span class="cm"> * and enable the feature before it gets used</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-4"></a><span class="cm"> * XXX Some Hypervisors forget to save/restore PKU</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-5"></a><span class="cm"> */</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpuid_level</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-7"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">dummy</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-8"></a><span class="w">    </span><span class="n">CPUID_LEAF</span><span class="p">(</span><span class="mh">0x7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">dummy</span><span class="p">);</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ecx</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SEFF0ECX_PKU</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-10"></a><span class="w">        </span><span class="p">(</span><span class="n">cpu_ecxfeature</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CPUIDECX_HV</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-11"></a><span class="w">        </span><span class="n">lcr4</span><span class="p">(</span><span class="n">rcr4</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CR4_PKE</span><span class="p">);</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-12"></a><span class="w">        </span><span class="n">pg_xo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_XO</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-0-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>其中 <code>PG_XO</code> 的值是 <code>0x0800000000000000UL</code>，也就是只有 bit 59 位 1，对应 Protection Key #1。OpenBSD 内核设置 PKRU 寄存器为 <code>0xfffffffc</code>，即只有 Protection Key #0 不修改权限，其他 Protection Key 都是禁止读写。剩下的代码就是维护 PKRU 寄存器的取值，然后把 xonly 的页的 Protection Key 都设为 1，否则设为 0。</p>
<p>但需要注意的是，PKRU 寄存器用户态也可以读写。Linux 把 PKRU 暴露给了<a href="https://www.kernel.org/doc/html/latest/core-api/protection-keys.html">用户态</a>，允许用户态来自己设置页表的 Protection Key。OpenBSD 的实现方法则是进内核以后，检查 PKRU 寄存器，如果值修改了，就 SIGABRT。这有一定的风险，如果攻击代码修改了 PKRU 寄存器的内容，是有可能读取本来 xonly 的页的内容的。</p>
<h3 id="powerpc64"><a class="toclink" href="../../system/2023/02/07/openbsd-xonly/#powerpc64">powerpc64 上的实现</a></h3>
<p>powerpc64 的实现方法和 amd64 类似，见 <a href="https://github.com/openbsd/src/commit/6bd9427e6879f79e0e2c1e03d8411439da5bb69">commit</a>。机制和 AMD64 很像，下面引用一段 PowerISA 文档：</p>
<div class="language-text highlight"><pre><span></span><code>The Virtual Page Class Key Protection mechanism provides the means to
assign virtual pages to one of 32 classes, and to modify data access
permissions for each class by modifying the Authority Mask Register
(AMR), shown in Figure 28, and to modify instruction access permissions
for each class by modifying the Instruction Authority Mask Register
(IAMR) shown in Figure 29.
</code></pre></div>
<p>对应如下代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-1"></a><span class="c1">// sys/arch/powerpc64/powerpc64/cpu.c</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-2"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-3"></a><span class="cm">     * Set AMR to inhibit loads and stores for all virtual page</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-4"></a><span class="cm">     * class keys, except for Key0 which is used for normal kernel</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-5"></a><span class="cm">     * access.  This means we can pick any other key to implement</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-6"></a><span class="cm">     * execute-only mappings.  But we pick Key1 since that allows</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-7"></a><span class="cm">     * us to use the same bit in the PTE as was used to enable the</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-8"></a><span class="cm">     * Data Access Compare mechanism on CPUs based on older</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-9"></a><span class="cm">     * versions of the architecture (such as the PowerPC 970).</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-10"></a><span class="cm">     *</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-11"></a><span class="cm">     * Set UAMOR (and AMOR just to be safe) to zero to prevent</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-12"></a><span class="cm">     * userland from modifying any bits in AMR.</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-13"></a><span class="cm">     */</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-14"></a><span class="w">    </span><span class="n">mtamr</span><span class="p">(</span><span class="mh">0x3fffffffffffffff</span><span class="p">);</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-15"></a><span class="w">    </span><span class="n">mtuamor</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-16"></a><span class="w">    </span><span class="n">mtamor</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-1-17"></a><span class="w">    </span><span class="n">isync</span><span class="p">();</span>
</span></code></pre></div>
<p>可以看到方法是一样的，Key0 正常，其他 Key 禁止读写。额外地，PowerISA 还可以设置 Protection Key 禁止执行。并且通过设置 UAMOR 寄存器，用户态不可以修改 AMR 寄存器，这让 xonly 比 AMD64 上更为完备。</p>
<p>最后一步，就是修改 PTE 属性，指定 Key 即可：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-2-1"></a><span class="c1">// sys/arch/powerpc64/include/pte.h</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-2-2"></a><span class="cp">##define PTE_AC         0x0000000000000200ULL</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-2-3"></a><span class="c1">// sys/arch/powerpc64/powerpc64/pmap.c</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-2-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">prot</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../system/2023/02/07/openbsd-xonly/#__codelineno-2-5"></a><span class="w">        </span><span class="n">pte</span><span class="o">-&gt;</span><span class="n">pte_lo</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_AC</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../system/2023/02/07/openbsd-xonly/#_2">其他指令集架构</a></h3>
<p>一些指令集架构的页表在设计的时候，就有独立的 R W X 权限位，于是不需要特殊的处理，直接把 mmap 的参数映射过去即可。</p>

    <nav class="md-post__action">
      <a href="../../system/2023/02/07/openbsd-xonly/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-03 00:00:00">2023年2月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="solaris-114"><a class="toclink" href="../../system/2023/02/03/solaris/">Solaris 11.4 安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/02/03/solaris/#_1">下载安装镜像</a></h3>
<p>访问 <a href="https://www.oracle.com/solaris/solaris11/downloads/solaris-downloads.html">https://www.oracle.com/solaris/solaris11/downloads/solaris-downloads.html</a>，点击下载，登录后跳转到一个新的页面。在 Platform 下拉框选择 x86，会出现一系列可以下载的文件。以 11.4.42.111.0 为例，需要下载的是：V1019840-01.iso Oracle Solaris 11.4.42.111.0 Interactive Text Install ISO (x86) for (Oracle Solaris on x86-64 (64-bit)), 890.5 MB。可以直接在浏览器中下载，也可以点击网页中的 WGET Options，用 wget 脚本下载。</p>
<p>下载以后，挂载 ISO 到虚拟机，正常按照指示进行安装</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/02/03/solaris/#_2">配置软件源</a></h3>
<p>Solaris 的在线软件源需要订阅，如果不想订阅，需要下载和 Solaris <strong>版本一致</strong> 的 IPS 仓库。下载的地址和上面一样，需要 7 个 zip 文件，如 V1019847-01_1of7.zip Oracle Solaris 11.4.42.111.0 IPS Repository (SPARC, x86) for (Oracle Solaris on x86-64 (64-bit)), 2.2 GB。建议用 wget 脚本批量下载。</p>
<p>UPDATE: 根据 <a href="https://blogs.oracle.com/solaris/post/building-open-source-software-on-oracle-solaris-114-cbe-release">https://blogs.oracle.com/solaris/post/building-open-source-software-on-oracle-solaris-114-cbe-release</a>，实际上可以不下载 IPS 仓库，而是用在线的仓库，内容和下载的一致：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2023/02/03/solaris/#__codelineno-0-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>set-publisher<span class="w"> </span>-G<span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w"> </span>-g<span class="w"> </span>http://pkg.oracle.com/solaris/release/<span class="w"> </span>solaris
</span></code></pre></div>
<p>下载好了以后，全部解压到一个目录中，如 <code>/export/home/user/solaris</code>，然后启动本地的软件源服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../system/2023/02/03/solaris/#__codelineno-1-1"></a>sudo<span class="w"> </span>svccfg<span class="w"> </span>-s<span class="w"> </span>application/pkg/server<span class="w"> </span>setprop<span class="w"> </span>pkg/inst_root<span class="o">=</span>/export/home/user/solaris
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../system/2023/02/03/solaris/#__codelineno-1-2"></a>sudo<span class="w"> </span>svccfg<span class="w"> </span>-s<span class="w"> </span>application/pkg/server<span class="w"> </span>setprop<span class="w"> </span>pkg/readonly<span class="o">=</span><span class="nb">true</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../system/2023/02/03/solaris/#__codelineno-1-3"></a>sudo<span class="w"> </span>svccfg<span class="w"> </span>-s<span class="w"> </span>application/pkg/server<span class="w"> </span>setprop<span class="w"> </span>pkg/port<span class="o">=</span><span class="m">8081</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../system/2023/02/03/solaris/#__codelineno-1-4"></a>sudo<span class="w"> </span>svcadm<span class="w"> </span>refresh<span class="w"> </span>application/pkg/server
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../system/2023/02/03/solaris/#__codelineno-1-5"></a>sudo<span class="w"> </span>svcadm<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>application/pkg/server
</span></code></pre></div>
<p>然后配置 <code>pkg</code> 使用本地软件源：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../system/2023/02/03/solaris/#__codelineno-2-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>set-publisher<span class="w"> </span>-G<span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w"> </span>-g<span class="w"> </span>http://localhost:8081<span class="w"> </span>solaris
</span></code></pre></div>
<p>之后就可以正常使用了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../system/2023/02/03/solaris/#__codelineno-3-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>gcc-11
</span></code></pre></div>
<p>命令参考：<a href="https://www.oracle.com/docs/tech/solaris-11-cheat-sheet.pdf">https://www.oracle.com/docs/tech/solaris-11-cheat-sheet.pdf</a></p>

    <nav class="md-post__action">
      <a href="../../system/2023/02/03/solaris/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-21 00:00:00">2023年1月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="freebsdnetbsdopenbsddragonflybsd-cookbook"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/">FreeBSD/NetBSD/OpenBSD/DragonFlyBSD Cookbook</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_1">背景</a></h3>
<p>最近在维护 lsof 的时候，需要在 FreeBSD/NetBSD/OpenBSD/DragonFlyBSD 上进行开发和测试，于是就装了虚拟机，特此记录我在使用过程中，与 Linux 不一样的一些常用 FreeBSD/NetBSD/OpenBSD/DragonFlyBSD 命令。</p>
<h3 id="freebsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#freebsd">FreeBSD</a></h3>
<p>文档参考：<a href="https://docs.freebsd.org/en/books/handbook">https://docs.freebsd.org/en/books/handbook</a></p>
<h4 id="_2"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_2">安装</a></h4>
<p>在 <a href="https://www.freebsd.org/where/">https://www.freebsd.org/where/</a> 找到最新版下载，对于虚拟机的需求，用 <code>-disk1.iso</code>，1 GB 左右。安装过程按照 UI 一步步走即可。</p>
<h4 id="root"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#root">root 权限</a></h4>
<p>FreeBSD 的 su 默认只有 wheel 组可以 su 到 root，所以安装的时候，建议给创建的帐号加上 wheel 组。也可以通过 pw 命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-0-1"></a>pw<span class="w"> </span>groupmod<span class="w"> </span>wheel<span class="w"> </span>-m<span class="w"> </span>freebsd
</span></code></pre></div>
<p>sudo 需要通过包管理器安装，用法和 Linux 一样。</p>
<h4 id="_3"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_3">包管理</a></h4>
<p>使用 <code>pkg</code> 命令进行包管理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-1-1"></a>pkg<span class="w"> </span>update
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-1-2"></a>pkg<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>fish
</span></code></pre></div>
<p><code>-U</code> 表示在 install 的时候不要再 update。</p>
<p>也可以从 Ports 源码编译，如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-2-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://git.FreeBSD.org/ports.git<span class="w"> </span>/usr/ports
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-2-2"></a><span class="nb">cd</span><span class="w"> </span>/usr/ports/sysutils/lsof
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-2-3"></a>make<span class="w"> </span>install
</span></code></pre></div>
<h4 id="_4"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_4">升级</a></h4>
<p>使用 <code>freebsd-update</code> 命令升级：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-3-1"></a>freebsd-update<span class="w"> </span>fetch
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-3-2"></a>freebsd-update<span class="w"> </span>install
</span></code></pre></div>
<h4 id="_5"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_5">网络配置</a></h4>
<p>显示路由表：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-4-1"></a>netstat<span class="w"> </span>-nr
</span></code></pre></div>
<p>修改路由：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-1"></a><span class="c1">## ip route add 1.2.3.0/24 via 4.5.6.7</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-2"></a>route<span class="w"> </span>add<span class="w"> </span>-net<span class="w"> </span><span class="m">1</span>.2.3.0/24<span class="w"> </span><span class="m">4</span>.5.6.7
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-3"></a><span class="c1">## ip route del 1.2.3.0/24</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-4"></a>route<span class="w"> </span>delete<span class="w"> </span>-net<span class="w"> </span><span class="m">1</span>.2.3.0/24
</span></code></pre></div>
<p>网络接口：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-1"></a><span class="c1">## ip a</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-2"></a>ifconfig
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-3"></a><span class="c1">## ip link set dev abc up</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-4"></a>ifconfig<span class="w"> </span>abc<span class="w"> </span>up
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-5"></a><span class="c1">## ip a add 1.2.3.4/24 dev abc</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-6"></a>iconfig<span class="w"> </span>abc<span class="w"> </span>inet<span class="w"> </span><span class="m">1</span>.2.3.4/24
</span></code></pre></div>
<p>网路配置在 <code>/etc/rc.conf</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-1"></a>## DHCP
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-2"></a>ifconfig_xxx=&quot;DHCP&quot;
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-3"></a>## Default Gateway
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-4"></a>defaultrouter=&quot;1.2.3.4&quot;
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-5"></a>## Static IP
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-6"></a>ifconfig_xxx=&quot;inet 1.2.3.4/24&quot;
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-7"></a>## Static route
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-8"></a>static_routes=&quot;name1 name2&quot;
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-9"></a>route_name1=&quot;-net 1.2.3.0/24 4.5.6.7&quot;
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-10"></a>route_name2=&quot;-net 3.2.1.0/24 7.6.5.4&quot;
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-11"></a>## Bridge
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-12"></a>cloned_interfaces=&quot;bridge0&quot;
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-13"></a>ifconfig_bridge0=&quot;addm net0 addm net1 up&quot;
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-14"></a>ifconfig_net0=&quot;up&quot;
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-15"></a>ifconfig_net1=&quot;up&quot;
</span></code></pre></div>
<h4 id="_6"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_6">换源</a></h4>
<p>USTC <a href="https://mirrors.ustc.edu.cn/help/freebsd-pkg.html">https://mirrors.ustc.edu.cn/help/freebsd-pkg.html</a>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/usr/local/etc/pkg/repos/
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;FreeBSD: { url: &quot;pkg+http://mirrors.ustc.edu.cn/freebsd-pkg/${ABI}/quarterly&quot; }&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-3"></a><span class="w">        </span>&gt;<span class="w"> </span>/usr/local/etc/pkg/repos/FreeBSD.conf
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-4"></a>pkg<span class="w"> </span>update
</span></code></pre></div>
<h4 id="truss"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#truss">truss</a></h4>
<p>truss 相当于 Linux 中的 strace。</p>
<h4 id="_7"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_7">编译内核</a></h4>
<p>文档：<a href="https://docs.freebsd.org/en/books/handbook/kernelconfig/">https://docs.freebsd.org/en/books/handbook/kernelconfig/</a></p>
<p>首先下载内核源码，然后创建内核配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-9-1"></a><span class="nb">cd</span><span class="w"> </span>/path/to/kernel/src
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-9-2"></a><span class="nb">cd</span><span class="w"> </span>sys/amd64/conf
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-9-3"></a>cp<span class="w"> </span>GENERIC<span class="w"> </span>MYKERNEL
</span></code></pre></div>
<p>编译和安装：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-10-1"></a>make<span class="w"> </span>buildkernel<span class="w"> </span><span class="nv">KERNCONF</span><span class="o">=</span>MYKERNEL
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-10-2"></a>make<span class="w"> </span>installkernel<span class="w"> </span><span class="nv">KERNCONF</span><span class="o">=</span>MYKERNEL
</span></code></pre></div>
<p>提交 patch：<a href="https://wiki.freebsd.org/Phabricator">https://wiki.freebsd.org/Phabricator</a></p>
<h4 id="_8"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_8">关机</a></h4>
<p>FreeBSD 的 shutdown 默认会停留在 halt 的状态，但是不会断电，需要添加 <code>-p</code> 选项。</p>
<h3 id="netbsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#netbsd">NetBSD</a></h3>
<h4 id="_9"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_9">包管理</a></h4>
<p>参考：<a href="https://www.netbsd.org/docs/pkgsrc/using.html">https://www.netbsd.org/docs/pkgsrc/using.html</a></p>
<p>使用 pkgin 做二进制包的包管理，首先安装 pkgin：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-1"></a><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/usr/pkg/sbin:/usr/pkg/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-2"></a><span class="nv">PKG_PATH</span><span class="o">=</span><span class="s2">&quot;https://cdn.NetBSD.org/pub/pkgsrc/packages&quot;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-3"></a><span class="nv">PKG_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PKG_PATH</span><span class="s2">/NetBSD/amd64/9.3/All/&quot;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-4"></a><span class="nb">export</span><span class="w"> </span>PATH<span class="w"> </span>PKG_PATH
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-5"></a>pkg_add<span class="w"> </span>pkgin
</span></code></pre></div>
<p>包管理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-12-1"></a>pkgin<span class="w"> </span>install<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>fish
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-12-2"></a>pkgin<span class="w"> </span>upgrade
</span></code></pre></div>
<p>和 FreeBSD 一样，NetBSD 的 su 默认只有 wheel 组可以 su 到 root，建议在安装创建新用户的时候就把自己的帐号加入到 wheel 组中。sudo 使用之前需要 visudo 修改配置。</p>
<p>也可以从源码 pkgsrc 进行编译，在 /usr/pkgsrc 路径下，编译好的程序会安装到 /usr/pkg/bin。</p>
<p>克隆并初始化 pkgsrc：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-13-1"></a><span class="nb">cd</span><span class="w"> </span>/usr<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>cvs<span class="w"> </span>-q<span class="w"> </span>-z2<span class="w"> </span>-d<span class="w"> </span>anoncvs@anoncvs.NetBSD.org:/cvsroot<span class="w"> </span>checkout<span class="w"> </span>-P<span class="w"> </span>pkgsrc
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-13-2"></a><span class="nb">cd</span><span class="w"> </span>/usr/pkgsrc/bootstrap
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-13-3"></a>./bootstrap
</span></code></pre></div>
<p>编译 pkgsrc 中的软件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-14-1"></a><span class="nb">cd</span><span class="w"> </span>/usr/pkgsrc/sysutils/lsof
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-14-2"></a>make
</span></code></pre></div>
<h4 id="_10"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_10">网络配置</a></h4>
<p>网络配置的命令和 FreeBSD 基本一样：</p>
<ul>
<li><code>netstat -nr</code>：查看路由表</li>
<li><code>route</code>：修改路由表</li>
<li><code>ifconfig</code>：配置网络接口</li>
</ul>
<p>但是 <code>/etc/rc.conf</code> 的配置语法不同，见 <code>man rc.conf</code> 和 <a href="https://www.netbsd.org/docs/network/#configuration_files">https://www.netbsd.org/docs/network/#configuration_files</a>。</p>
<h4 id="_11"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_11">升级</a></h4>
<p>参考 <a href="https://www.netbsd.org/docs/guide/en/chap-upgrading.html">https://www.netbsd.org/docs/guide/en/chap-upgrading.html</a></p>
<p>使用 sysupgrade 命令升级：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-15-1"></a>pkgin install sysupgrade
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-15-2"></a>sysupgrade auto https://cdn.NetBSD.org/pub/NetBSD/NetBSD-9.3/amd64
</span></code></pre></div>
<h4 id="_12"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_12">安装内核源码</a></h4>
<p>内核源码可以从 <a href="https://mirrors.tuna.tsinghua.edu.cn/NetBSD/NetBSD-9.3/source/sets/">https://mirrors.tuna.tsinghua.edu.cn/NetBSD/NetBSD-9.3/source/sets/</a> 下载。对于 lsof 只需要其中的 syssrc.tgz。</p>
<p>解压：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-16-1"></a>tar<span class="w"> </span>-xzf<span class="w"> </span>syssrc.tgz<span class="w"> </span>-C<span class="w"> </span>/
</span></code></pre></div>
<h3 id="openbsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#openbsd">OpenBSD</a></h3>
<h4 id="_13"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_13">安装</a></h4>
<p>文档：<a href="https://www.openbsd.org/faq/faq4.html">https://www.openbsd.org/faq/faq4.html</a></p>
<p>下载 <a href="https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/amd64/install72.iso">https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/amd64/install72.iso</a>，然后按照 UI 提示进行安装。使用 virt-manager 安装 OpenBSD 虚拟机的时候，在安装界面会遇到无法输入的问题，可以创建一个 USB Keyboard 来解决。</p>
<h4 id="_14"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_14">包管理</a></h4>
<p>文档：<a href="https://www.openbsdhandbook.com/package_management/">https://www.openbsdhandbook.com/package_management/</a></p>
<p>常用命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-1"></a><span class="c1">## Use TUNA Mirrors</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/installurl
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-3"></a><span class="c1">## Search</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-4"></a>pkg_info<span class="w"> </span>-Q<span class="w"> </span>fish
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-5"></a><span class="c1">## Install</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-6"></a>pkg_add<span class="w"> </span>sudo<span class="w"> </span>fish<span class="w"> </span>vim
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-7"></a><span class="c1">## Update packages</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-8"></a>pkg_add<span class="w"> </span>-u
</span></code></pre></div>
<p>另一个方法是从源码编译，首先下载 ports：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-18-1"></a>wget<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/ports.tar.gz
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-18-2"></a><span class="nb">cd</span><span class="w"> </span>/usr/src
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-18-3"></a>tar<span class="w"> </span>xzf<span class="w"> </span>/path/to/ports.tar.gz
</span></code></pre></div>
<h4 id="_15"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_15">系统升级</a></h4>
<p>参考：<a href="https://www.openbsdhandbook.com/system_management/updates/">https://www.openbsdhandbook.com/system_management/updates/</a></p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-19-1"></a>syspatch<span class="w"> </span>-c
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-19-2"></a>syspatch
</span></code></pre></div>
<h4 id="autotools"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#autotools">autotools</a></h4>
<p>OpenBSD 允许存在多个版本的 autoconf/automake，所以在运行的时候需要用环境变量指定版本，如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-20-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AUTOCONF_VERSION</span><span class="o">=</span><span class="m">2</span>.71
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-20-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AUTOMAKE_VERSION</span><span class="o">=</span><span class="m">1</span>.16
</span></code></pre></div>
<h4 id="_16"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_16">获取内核源码</a></h4>
<p>文档：<a href="https://www.openbsd.org/faq/faq5.html">https://www.openbsd.org/faq/faq5.html</a></p>
<p>命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-1"></a><span class="c1">## Add exampleuser to group wsrc</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-2"></a>user<span class="w"> </span>mod<span class="w"> </span>-G<span class="w"> </span>wsrc<span class="w"> </span>exampleuser
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-3"></a><span class="c1">## Download and extract</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-4"></a>wget<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/sys.tar.gz
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-5"></a><span class="nb">cd</span><span class="w"> </span>/usr/src
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-6"></a>tar<span class="w"> </span>xzf<span class="w"> </span>/path/to/sys.tar.gz
</span></code></pre></div>
<h4 id="ktrace"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#ktrace">ktrace</a></h4>
<p>ktrace 相当于 Linux 中的 strace。结果会保存在文件中，用 kdump 命令显示。</p>
<h3 id="dragonflybsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#dragonflybsd">DragonFlyBSD</a></h3>
<h4 id="_17"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_17">安装</a></h4>
<p>下载 ISO 文件：<a href="https://mirror-master.dragonflybsd.org/iso-images/dfly-x86_64-6.4.0_REL.iso">https://mirror-master.dragonflybsd.org/iso-images/dfly-x86_64-6.4.0_REL.iso</a></p>
<p>用 installer 用户登录开始安装。</p>
<h4 id="_18"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_18">用户管理</a></h4>
<p>和 FreeBSD 一样，su 需要 wheel 组，所以需要手动添加用户到 wheel 组中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-22-1"></a>pw<span class="w"> </span>groupmod<span class="w"> </span>wheel<span class="w"> </span>-m<span class="w"> </span>username
</span></code></pre></div>
<h4 id="sshd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#sshd">SSHD</a></h4>
<p>DragonFlyBSD 默认 sshd 配置不允许密码登录，如果要允许，需要修改 <code>/etc/ssh/sshd_config</code>，然后重启 ssh：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-23-1"></a>/etc/rc.d/sshd<span class="w"> </span>restart
</span></code></pre></div>
<h4 id="_19"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_19">包管理</a></h4>
<p>DragonFlyBSD 可以下载二进制包：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-24-1"></a>pkg<span class="w"> </span>update
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-24-2"></a>pkg<span class="w"> </span>upgrade
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="../../system/2023/01/21/bsd-cookbook/#__codelineno-24-3"></a>pkg<span class="w"> </span>install<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>fish
</span></code></pre></div>
<p>也可以从源码编译，见 <a href="https://www.dragonflybsd.org/docs/howtos/HowToDPorts/">https://www.dragonflybsd.org/docs/howtos/HowToDPorts/</a></p>

    <nav class="md-post__action">
      <a href="../../system/2023/01/21/bsd-cookbook/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-13 00:00:00">2023年1月13日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="freebsd-code-server"><a class="toclink" href="../../software/2023/01/13/vscode-server-on-freebsd/">在 FreeBSD 上运行 code-server</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2023/01/13/vscode-server-on-freebsd/#_1">背景</a></h3>
<p>最近在 FreeBSD 上移植开源软件，但是因为 vscode 官方不支持 FreeBSD，所以尝试使用 code-server</p>
<h3 id="_2"><a class="toclink" href="../../software/2023/01/13/vscode-server-on-freebsd/#_2">使用</a></h3>
<p>首先按照官方文档安装 code-server：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-0-1"></a>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://code-server.dev/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
</span></code></pre></div>
<p>启动 code-server：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-1-1"></a>code-server<span class="w"> </span>--bind-addr<span class="w"> </span><span class="m">0</span>.0.0.0:8080
</span></code></pre></div>
<p>但是很快你会发现，运行日志中会报告很多错误，缺少了一些包：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-2-1"></a>sudo<span class="w"> </span>npm<span class="w"> </span>i<span class="w"> </span>-g<span class="w"> </span>yazl<span class="w"> </span>yauzl<span class="w"> </span>@microsoft/1ds-core-js<span class="w"> </span>vscode-regexpp<span class="w"> </span>xterm-headless<span class="w"> </span>vscode-proxy-agent<span class="w"> </span>--unsafe-perm
</span></code></pre></div>
<p>到这里就能在网页里看到 UI 了，但是发现很多功能都不工作。例如搜索的时候，会告诉你找不到 rg，是因为 ripgrep 没有提供 FreeBSD 的 prebuilt binary，但是可以用 pkg 安装：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-3-1"></a>sudo pkg install ripgrep
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-3-2"></a>cd /usr/local/lib/node_modules/@vscode/ripgrep/bin &amp;&amp; ln -s /usr/local/bin/rg
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-3-3"></a>cd /usr/local/lib/node_modules/code-server/lib/vscode/node_modules/@vscode/ripgrep/bin &amp;&amp; ln -s /usr/local/bin/rg
</span></code></pre></div>
<p>然后，日志中会显示 @parcel/watcher 启动失败，显示 Undefined symbol，这是因为这个库没有做 FreeBSD 支持。需要使用 https://github.com/parcel-bundler/watcher/pull/128 版本，编译出 watcher.node 文件，替换：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-1"></a>cd watcher
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-2"></a>npm install
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-3"></a>sudo cp build/Release/watcher.node /usr/local/lib/node_modules/@parcel/watcher/build/Release/
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-4"></a>sudo cp build/Release/watcher.node /usr/local/lib/node_modules/code-server/lib/vscode/node_modules/@parcel/watcher/build/Release/watcher.node
</span></code></pre></div>
<p>这样就解决了 watcher 的问题。</p>
<p>最后一个问题是无法打开 Terminal，因为在 VSCode 代码中，检测到不支持的 Platform 的时候，会抛出异常：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-5-1"></a>[IPC Library: Pty Host] The factory function of &quot;vs/platform/terminal/node/ptyHostMain&quot; has thrown an exception
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-5-2"></a>[IPC Library: Pty Host] Error: Platform not supported
</span></code></pre></div>
<p>可以修改源码：<code>sudo vim /usr/local/lib/node_modules/code-server/lib/vscode/out/vs/platform/terminal/node/ptyHostMain.js</code> 把这个检查改掉，例如替换 linux 为 freebsd，当成 linux 来检测。</p>
<p>接下来的问题和 https://github.com/coder/code-server/issues/5760 一致，安装依赖，重新 <code>npm install</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-1"></a>sudo pkg install libsecret pkgconf
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-2"></a>cd /usr/local/lib/node_modules/code-server
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-3"></a>sudo npm install --unsafe-perm
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-4"></a>## go back to @parcel/watcher
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-5"></a>cd watcher
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-6"></a>sudo cp build/Release/watcher.node /usr/local/lib/node_modules/code-server/lib/vscode/node_modules/@parcel/watcher/build/Release
</span></code></pre></div>
<p>完成这些步骤以后，Terminal 也正常了。</p>

    <nav class="md-post__action">
      <a href="../../software/2023/01/13/vscode-server-on-freebsd/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-12 00:00:00">2023年1月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="chi"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/">CHI 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="chi_1"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#chi_1">CHI 介绍</a></h3>
<p>CHI 协议是 AMBA 5 标准中的缓存一致性协议，前身是 ACE 协议。最新的 CHI 标准可以从 <a href="https://developer.arm.com/documentation/ihi0050/latest">AMBA 5 CHI Architecture Specification</a> 处下载。</p>
<p>相比 AXI，CHI 更加复杂，进行了分层：协议层，物理层和链路层。因此，CHI 适用于片上网络，支持根据 Node ID 进行路由，而不像 AXI 那样只按照物理地址进行路由。CHI 的地位就相当于 Intel 的环形总线。CHI 也可以桥接到 CCIX 上，用 CCIX 连接 SMP 的的多个 Socket，或者连接支持 CCIX 的显卡等等。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#_1">缓存行状态</a></h3>
<p>首先回顾 ACE 的缓存行状态，共有五种，与 MOESI 相对应：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>在此基础上，CHI 考虑缓存行只有部分字节有效的情况，即 Full，Partial 或者 Empty。因此 CHI 的缓存行状态共有七种：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>UniqueDirtyPartial: 新增，可能有部分字节合法，在写回的时候，需要和下一级缓存或者内存中的合法缓存行内容进行合并</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>UniqueCleanEmpty: 新增，所有字节都不合法，但是本缓存占有该缓存行，如果要修改的话，不需要通知其他缓存</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>可以看到，比较特别的就是 UniqueDirtyPartial 和 UniqueCleanEmpty。CHI 标准在 4.1.1 章节给出了使用场景：如果一个 CPU 即将要写入一片内存，那么可以先转换到 UniqueCleanEmpty 状态中，把其他缓存中的数据都清空，这样后续写入的时候，不需要询问其他缓存，性能比较好。但此时因为数据还没写进去，所以就是 Empty，只更新状态，不占用缓存的空间。另一方面，如果 CPU 只写了缓存行的一部分字节，其他部分没有碰，那么引入 UniqueDirtyPartial 以后，可以把合并新旧缓存行数据这一步，下放到比较靠近内存的层级上，减少了数据搬运的次数。</p>
<h3 id="chi_2"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#chi_2">CHI 网络节点</a></h3>
<p>CHI 的节点组织成一个网络，可能是片上网络，也可能是片间的连接。CHI 的节点分成三种类型：</p>
<ol>
<li>Request Node：发起 CHI 请求的节点，对应 CPU 的缓存，或者是网卡等外设</li>
<li>Home Node：管理 Request Node 来的请求，对应最后一级缓存</li>
<li>Subordinate Node：处理 Home Node 来的请求，对应内存或者显存等有内存的外设</li>
</ol>
<p>在这种设计下，Node 之间可以互相通信，因此方便做一些新的优化。例如传统的缓存层次里，请求是一级一级下去，响应再一级一级上来。但是 CHI 可能是 Request Node 发给 Home Node 的请求，响应直接由 Subordinate Node 发送回 Request Node 了。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#_2">读请求</a></h3>
<p>CHI 提供了复杂性的同时，也带来了很多的灵活性，也意味着潜在的性能优化的可能。例如在 CHI 中实现一个读操作，可能有很多种过程（CHI 标准第 2.3.1 章节）：</p>
<p>第一种是 Home Node 直接提供了数据（Combined response from home）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Requester: CompData
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第二种是 Home Node 把响应拆成两份，一份表示读取结果，一份携带读取的数据（Separate data and response from Home）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Requester: RespSepData
    Home-&gt;&gt;Requester: DataSepResp
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第三种是 Home Node 没有数据，转而询问 Subordinate，Subordinate 把结果直接发回给了 Requester（Combined response from Subordinate）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Subordinate
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Subordinate: ReadNoSnp
    Subordinate-&gt;&gt;Requester: CompData
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第四种是 Home Node 没有数据，转而询问 Subordinate，但这次提前告诉 Requester 读取的结果，最后 Subordinate 把结果发回给了 Requester（Response from Home, Data from Subordinate）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Subordinate
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Requester: RespSepData
    Home-&gt;&gt;Subordinate: ReadNoSnpSep
    Subordinate-&gt;&gt;Home: ReadReceipt
    Subordinate-&gt;&gt;Requester: DataSepResp
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第五种是数据在其他的 Requester Node 中，此时 Home 负责 Snoop（Forwarding snoop）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Snoopee
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Snoopee: Snp*Fwd
    Snoopee-&gt;&gt;Requester: CompData
    Snoopee-&gt;&gt;Home: SnpRespFwded
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第六种是 MakeReadUnique，此时只更新权限，不涉及数据的传输（MakeReadUnique only）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: MakeReadUnique
    Home-&gt;&gt;Requester: Comp
    Requester-&gt;&gt;Home: CompAck</code></pre>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#_3">写请求</a></h3>
<p>CHI 标准第 2.3.2 描述了写请求的流程。和读请求一样，写请求也有很多类型，下面进行介绍。与读请求不同的点在于，写入的时候，并不是直接把写入的地址和数据等一次性发送过去，而是先发一个写消息，对方回复可以发送数据了（DBIDResp），再把实际的数据传输过去（NCBWrData）。当然了，也可以中途反悔（WriteDataCancel）。</p>
<p>第一种是 Direct Write-data Transfer，意思是数据要从 Requester 直接传到 Subordinate 上：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Subordinate
    Requester-&gt;&gt;Home: Write*
    Home-&gt;&gt;Subordinate: Write*
    Subordinate-&gt;&gt;Requester: DBIDResp
    Requester-&gt;&gt;Subordinate: NCBWrData/WriteDataCancel
    Subordinate-&gt;&gt;Home: Comp
    Home-&gt;&gt;Requester: Comp</code></pre>
<p>第二种比较常规，就是把数据写给 Home Node，其中 Comp 表示读取结果，DBIDResp 表示可以发写入的内容了：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Write*
    Home-&gt;&gt;Requester: DBIDResp/DBIDRespOrd
    Home-&gt;&gt;Requester: Comp
    Requester-&gt;&gt;Home: NCBWrData/WriteDataCancel</code></pre>
<p>第三种是把第二种的 DBIDResp 和 Comp 合并成一个响应：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Write*
    Home-&gt;&gt;Requester: CompDBIDResp
    Requester-&gt;&gt;Home: NCBWrData/WriteDataCancel</code></pre>

    <nav class="md-post__action">
      <a href="../../hardware/2023/01/12/chi-notes/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-11 00:00:00">2023年1月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="intel"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/">Intel 处理器</a></h2>
<h3 id="xeon"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#xeon">Xeon 系列</a></h3>
<p><a href="https://www.intel.com/content/www/us/en/support/articles/000059657/processors/intel-xeon-processors.html">命名方式</a>：</p>
<ul>
<li>第一位数字：8-9 对应 Platinum，5-6 对应 Gold，4 对应 Silver，3 对应 Bronze</li>
<li>第二位数字：对应代次，1 对应 1st Generation，2 对应 2nd Generation，依此类推</li>
<li>第三位第四位数字：一般越大性能越好</li>
<li>后缀：H/L/M/N/P/Q/S/T/U/V/Y/Y+/+</li>
<li>L：大内存</li>
<li>M：媒体/大内存</li>
<li>N：网络</li>
<li>P：虚拟化，IaaS</li>
<li>Q: 水冷</li>
<li>S：存储/搜索</li>
<li>T：长寿命</li>
<li>U：单插槽</li>
<li>V：虚拟化，SaaS</li>
<li>Y: Speed Select</li>
</ul>
<h4 id="4th-generation-intel-xeon-scalable-processorsxeon-cpu-max-series"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#4th-generation-intel-xeon-scalable-processorsxeon-cpu-max-series">4th Generation Intel® Xeon® Scalable Processors/Xeon CPU Max Series</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/228622/4th-generation-intel-xeon-scalable-processors.html">CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/232643/intel-xeon-cpu-max-series.html">Xeon CPU Max 型号列表</a></li>
<li>发布时间：Q1'23</li>
<li>代号：Sapphire Rapids/Sapphire Rapids HBM</li>
<li>用途：Server</li>
<li>旗舰：Xeon CPU Max 9480(56C112T，112.5 MB L3，HBM)/Xeon Platinum 8490H(60C120T，Golden Cove，112.5 MB L3)/Xeon Platinum 8480+(56C112T，105 MB L3)</li>
</ul>
<h4 id="3rd-generation-intel-xeon-scalable-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#3rd-generation-intel-xeon-scalable-processors">3rd Generation Intel® Xeon® Scalable Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/204098/3rd-generation-intel-xeon-scalable-processors.html">CPU 型号列表</a></li>
<li>发布时间：Q2'21(Ice Lake), Q2'20(Cooper Lake)</li>
<li>代号：Cooper Lake/Ice Lake</li>
<li>用途：Server</li>
<li>旗舰：Xeon Platinum 8380(40C80T，Sunny Cove，60 MB L3)</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/16594/intel-3rd-gen-xeon-scalable-review">Ice Lake</a></li>
</ul>
<h4 id="2nd-generation-intel-xeon-scalable-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#2nd-generation-intel-xeon-scalable-processors">2nd Generation Intel® Xeon® Scalable Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/192283/2nd-generation-intel-xeon-scalable-processors.html">CPU 型号列表</a></li>
<li>发布时间：Q1'20, Q2'19</li>
<li>代号：Cascade Lake</li>
<li>用途：Server</li>
<li>旗舰：Xeon Platinum 9282(56C112T)，Xeon Platinum 8280(28C56T，38.5 MB L3)</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/14146/intel-xeon-scalable-cascade-lake-deep-dive-now-with-optane">Cascade Lake</a></li>
</ul>
<h4 id="1st-generation-intel-xeon-scalable-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#1st-generation-intel-xeon-scalable-processors">1st Generation Intel® Xeon® Scalable Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/125191/intel-xeon-scalable-processors.html">CPU 型号列表</a></li>
<li>发布时间：Q2'18, Q3'17</li>
<li>代号：Skylake</li>
<li>用途：Server</li>
<li>旗舰：Xeon Platinum 8180(28C56T)</li>
</ul>
<h3 id="core"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#core">Core 系列</a></h3>
<p><a href="https://www.intel.com/content/www/us/en/processors/processor-numbers.html">命名方式</a></p>
<ul>
<li>i3/i5/i7/i9：数字越大越高端</li>
<li>万位 + 千位：对应代次，13 对应 13 代</li>
<li>百位 + 十位 + 千位：型号，一般越大越高端</li>
<li>后缀：F/H/HK/HX/K/P/U/X/XE/Y</li>
<li>F：桌面，无核显</li>
<li>H：笔记本，高性能</li>
<li>HK：笔记本，高性能，可超频</li>
<li>HX：笔记本，高高性能，可超频</li>
<li>K：桌面，高性能，可超频</li>
<li>P：笔记本，轻薄本</li>
<li>S：桌面，特别版</li>
<li>U：笔记本，节能</li>
<li>X/XE：桌面，高高性能，可超频</li>
<li>Y：特别节能</li>
</ul>
<h4 id="13th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#13th-generation-intel-coretm-processors">13th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/230485/13th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/230486/13th-generation-intel-core-i7-processors.html">i7 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/230487/13th-generation-intel-core-i5-processors.html">i5 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/230488/13th-generation-intel-core-i3-processors.html">i3 CPU 型号列表</a></li>
<li>发布时间：Q1'23，Q4'22</li>
<li>代号：Raptor Lake，大小核</li>
<li>用途：桌面，笔记本</li>
<li>旗舰：i9-13900K（8+16C32T）/i9-13900KF</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/17601/intel-core-i9-13900k-and-i5-13600k-review">Intel Core i9-13900K and i5-13600K Review: Raptor Lake Brings More Bite</a></li>
</ul>
<h4 id="12th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#12th-generation-intel-coretm-processors">12th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/217839/12th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a></li>
<li>发布时间：Q1'22，Q4'21</li>
<li>代号：Alder Lake，大小核</li>
<li>旗舰：i9-12900KS（8+8C24T）</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/17479/the-intel-core-i9-12900ks-review-the-best-of-intel-s-alder-lake-and-the-hottest">The Intel Core i9-12900KS Review: The Best of Intel's Alder Lake, and the Hottest</a></li>
</ul>
<h4 id="11th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#11th-generation-intel-coretm-processors">11th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/202984/11th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a></li>
<li>发布时间：Q2'21，Q1'21</li>
<li>代号：Rocket Lake</li>
<li>旗舰：i9-11900K（8C16T）</li>
</ul>
<h4 id="10th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#10th-generation-intel-coretm-processors">10th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/195735/10th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/123588/intel-core-x-series-processors.html">Intel® Core™ X-series Processors</a></li>
<li>发布时间：Q3'20，Q2'20，Q4'19</li>
<li>代号：Comet Lake</li>
<li>旗舰：i9-10900K（10C20T，Comet Lake）；特别地，在 X-series 系列中还有 i9-10980XE（18C36T，Cascade Lake）</li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2023/01/11/intel-cpu/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-09 00:00:00">2023年1月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="amd"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/">AMD 处理器</a></h2>
<h3 id="ryzen"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen">Ryzen 系列</a></h3>
<h4 id="ryzen-5000"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen-5000">Ryzen 5000</a></h4>
<table>
<thead>
<tr>
<th>代号</th>
<th>用途</th>
<th>核显</th>
<th>插槽</th>
<th>微架构</th>
<th>型号</th>
</tr>
</thead>
<tbody>
<tr>
<td>Vermeer</td>
<td>桌面</td>
<td>无</td>
<td>AM4</td>
<td>Zen 3</td>
<td>5950X/5900(X)/5800(X(3D))/5700X/5600(X)</td>
</tr>
<tr>
<td>Chagall</td>
<td>工作站</td>
<td>无</td>
<td>sWRX8</td>
<td>Zen 3</td>
<td>5995WX/5975WX/5965WX/5955WX/5945WX</td>
</tr>
<tr>
<td>Cezanne</td>
<td>桌面</td>
<td>GCN5</td>
<td>AM4</td>
<td>Zen 3</td>
<td>5750G/5700G(E)/5650G/5600G(E)/5500/5300G(E)</td>
</tr>
<tr>
<td>Cezanne</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 3</td>
<td>5980HX/5980HS/5900HX/5900HS/5800H(S)/5800U/5600H(S)/5600U/5560U/5400U</td>
</tr>
<tr>
<td>Barceló</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 3</td>
<td>5825U/5825C/5625U/5625C/5425U/5425C/5125C</td>
</tr>
<tr>
<td>Lucienne</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 2</td>
<td>5700U/5500U/5300U</td>
</tr>
</tbody>
</table>
<p>注：Ryzen 5 5500 虽然代号是 Cezanne，但是去掉了核显。</p>
<h4 id="ryzen-6000"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen-6000">Ryzen 6000</a></h4>
<table>
<thead>
<tr>
<th>代号</th>
<th>用途</th>
<th>核显</th>
<th>插槽</th>
<th>微架构</th>
<th>型号</th>
</tr>
</thead>
<tbody>
<tr>
<td>Rembrandt</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FP7</td>
<td>Zen 3+</td>
<td>6980HX/6980HS/6900HX/6900HS/6800H(S)/6800U/6600H(S)/6600U</td>
</tr>
</tbody>
</table>
<h4 id="ryzen-7000"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen-7000">Ryzen 7000</a></h4>
<table>
<thead>
<tr>
<th>代号</th>
<th>用途</th>
<th>核显</th>
<th>插槽</th>
<th>微架构</th>
<th>型号</th>
</tr>
</thead>
<tbody>
<tr>
<td>Raphael</td>
<td>桌面</td>
<td>RDNA2</td>
<td>AM5</td>
<td>Zen 4</td>
<td>7950X(3D)/7900(X(3D))/7800X3D/7700(X)/7600(X)</td>
</tr>
<tr>
<td>Dragon Range</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FL1</td>
<td>Zen 4</td>
<td>7945HX/7845HX/7745HX/7645HX</td>
</tr>
<tr>
<td>Phoenix</td>
<td>笔记本</td>
<td>RDNA3</td>
<td>FP7/FP7r2/FP8</td>
<td>Zen 4</td>
<td>7940H(S)/7840H(S)/7840U/7640H(S)/7640U/7540U/7440U</td>
</tr>
<tr>
<td>Rembrandt R</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FP7/FP7r2</td>
<td>Zen 3+</td>
<td>7735HS/7736U/7735U/7535HS/7535U/7335U</td>
</tr>
<tr>
<td>Barcelo R</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 3</td>
<td>7730U/7530U/7330U</td>
</tr>
<tr>
<td>Mendocino</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FT6</td>
<td>Zen 2</td>
<td>7520U/7320U</td>
</tr>
</tbody>
</table>
<p>AMD 笔记本处理器产品从 2023 年到 2025 年采用新的<a href="https://www.anandtech.com/show/18718/amd-2023-ryzen-mobile-7000-cpus-unveiled-zen-4-phoenix-takes-point">命名方式</a>：</p>
<ul>
<li>数字第一位：7 对应 2023，8 对应 2024，9 对应 2025，约等于 Intel 的代次</li>
<li>数字第二位：1 对应 Athlon Silver，2 对应 Athlon Gold，3-4 对应 Ryzen 3，5-6 对应 Ryzen 5，7-8 对应 Ryzen 7，8-9 对应 Ryzen 9，类似 Intel 的 i3/i5/i7/i9</li>
<li>数字第三位：1 对应 Zen/Zen+，2 对应 Zen 2，依次类推</li>
<li>数字第四位：0 表示低端，5 表示高端</li>
<li>后缀：性能从高到低 HX，HS，U/C</li>
</ul>
<p>因此代号和编号有直接的对应关系：</p>
<ul>
<li>Dragon Range: 7045, Extreme Gaming and Creator</li>
<li>Phoenix: 7040, Elite Ultrathin</li>
<li>Rembrandt R: 7035, Premium Thin &amp; Light</li>
<li>Bracelo R: 7030, Mainstream Thin &amp; Light</li>
<li>Mendocino: 7020, Everyday Computing</li>
</ul>
<h4 id="_1"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#_1">参考资料</a></h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/List_of_AMD_Ryzen_processors">List of AMD Ryzen processors</a></li>
<li>Vermeer: <a href="https://www.anandtech.com/show/16214/amd-zen-3-ryzen-deep-dive-review-5950x-5900x-5800x-and-5700x-tested">AMD Zen 3 Ryzen Deep Dive Review: 5950X, 5900X, 5800X and 5600X Tested</a></li>
<li>Chagall: <a href="https://www.anandtech.com/show/17296/amd-announces-ryzen-threadripper-pro-5000-wx-series-zen-3-core-for-oem-workstations">AMD Announces Ryzen Threadripper Pro 5000 WX-Series: Zen 3 For OEM Workstations</a></li>
<li>Cezanne: <a href="https://www.anandtech.com/show/16405/amd-launches-ryzen-5000-mobile-zen-3-and-cezanne-for-notebooks">AMD Launches Ryzen 5000 Mobile: Zen 3 and Cezanne for Notebooks</a></li>
<li>Cezanne: <a href="https://www.anandtech.com/show/16446/amd-ryzen-9-5980hs-cezanne-review-ryzen-5000-mobile-tested">AMD Ryzen 9 5980HS Cezanne Review: Ryzen 5000 Mobile Tested</a></li>
<li>Cezanne: <a href="https://www.anandtech.com/show/16824/amd-ryzen-7-5700g-and-ryzen-5-5600g-apu-review">The AMD Ryzen 7 5700G, Ryzen 5 5600G, and Ryzen 3 5300G Review</a></li>
<li>Barcelo: <a href="https://www.anandtech.com/show/17190/amds-barcelo-zen-3-apu-refresh-for-2022">AMD’s Barcelo: Zen 3 APU Refresh for 2022</a></li>
<li>Barcelo: <a href="https://www.anandtech.com/show/17373/amd-announces-ryzen-5000-cseries-for-highend-chromebooks">AMD Announces Ryzen 5000 C-Series For High-End Chromebooks</a></li>
<li>Lucienne: <a href="https://www.anandtech.com/show/16451/amds-ryzen-5000-lucienne-not-simply-rebranded-ryzen-4000-renoir-">AMD's Ryzen 5000 Lucienne: Not Simply Rebranded Ryzen 4000 Renoir</a></li>
<li>Rembrandt: <a href="https://www.anandtech.com/show/17276/amd-ryzen-9-6900hs-rembrandt-benchmark-zen3-plus-scaling">AMD's Ryzen 9 6900HS Rembrandt Benchmarked: Zen3+ Power and Performance Scaling</a></li>
<li>Raphael: <a href="https://www.anandtech.com/show/17585/amd-zen-4-ryzen-9-7950x-and-ryzen-5-7600x-review-retaking-the-high-end">AMD Zen 4 Ryzen 9 7950X and Ryzen 5 7600X Review: Retaking The High-End</a></li>
<li>Mendocino: <a href="https://www.anandtech.com/show/17584/amd-launches-mendocino-apus-zen-2-ryzen-and-athlon-7020-series-with-rdna-2-graphics">AMD Launches Mendocino APUs: Zen 2-based Ryzen and Athlon 7020 Series with RDNA 2 Graphics</a></li>
<li>Barcelo R: <a href="https://www.notebookcheck.net/Barcelo-R-Ryzen-5-7530U-brings-Zen-3-into-the-mix-for-the-messy-AMD-Ryzen-7000-mobile-APU-lineup.662046.0.html">Barcelo-R Ryzen 5 7530U brings Zen 3 into the mix for the messy AMD Ryzen 7000 mobile APU lineup</a></li>
<li>Dragon Range: <a href="https://www.anandtech.com/show/18716/amd-announces-ryzen-7045-hx-series-cpus-for-laptops-up-to-16-cores-and-5-4-ghz">AMD Announces Ryzen Mobile 7045 HX-Series CPUs, Up to 16-Cores and 5.4 GHz for Laptops</a></li>
<li>Phoenix/Rembrandt R: <a href="https://www.anandtech.com/show/18718/amd-2023-ryzen-mobile-7000-cpus-unveiled-zen-4-phoenix-takes-point">AMD Lays Out 2023 Ryzen Mobile 7000 CPUs: Top-to-Bottom Updates, New Zen 4 'Phoenix' CPU Takes Point</a></li>
</ul>
<h3 id="epyc"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#epyc">EPYC 系列</a></h3>
<table>
<thead>
<tr>
<th>代号</th>
<th>编号</th>
<th>最大核心数</th>
<th>微架构</th>
<th>插槽</th>
</tr>
</thead>
<tbody>
<tr>
<td>Naples</td>
<td>7001</td>
<td>32</td>
<td>Zen 1</td>
<td>SP3</td>
</tr>
<tr>
<td>Rome</td>
<td>7002</td>
<td>64</td>
<td>Zen 2</td>
<td>SP3</td>
</tr>
<tr>
<td>Milan</td>
<td>7003</td>
<td>64</td>
<td>Zen 3</td>
<td>SP3</td>
</tr>
<tr>
<td>Milan-X</td>
<td>7003</td>
<td>64</td>
<td>Zen 3</td>
<td>SP3</td>
</tr>
<tr>
<td>Genoa</td>
<td>9004</td>
<td>96</td>
<td>Zen 4</td>
<td>SP5</td>
</tr>
<tr>
<td>Bergamo</td>
<td>?</td>
<td>128</td>
<td>Zen 4c</td>
<td>SP5</td>
</tr>
</tbody>
</table>
<h4 id="_2"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#_2">参考资料</a></h4>
<ul>
<li><a href="https://www.anandtech.com/show/17055/amd-gives-details-on-epyc-zen4-genoa-and-bergamo-up-to-96-and-128-cores">AMD Gives Details on EPYC Zen4: Genoa and Bergamo, up to 96 and 128 Cores</a></li>
</ul>

    <nav class="md-post__action">
      <a href="../../hardware/2023/01/09/amd-cpu/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-01-05 00:00:00">2023年1月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="pcie-bifurcation"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/">PCIe Bifurcation</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/pcie.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_1">背景</a></h3>
<p>最近看到两篇关于 PCIe Bifurcation 的文章：</p>
<ul>
<li><a href="https://www.bilibili.com/read/cv15596863">intel 部分桌面级 CPU 的 pcie 通道拆分另类低成本实现</a></li>
<li><a href="https://www.bilibili.com/read/cv16530665">Intel Alder Lake 12 代酷睿 CPU PCIe 拆分实现方法</a></li>
</ul>
<p>文章讲的是如何在 CPU 上进行跳线，从而实现 PCIe Bifurcation 的配置。正好借此机会来研究一下 PCIe Bifurcation。</p>
<h3 id="pcie-bifurcation_1"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#pcie-bifurcation_1">PCIe Bifurcation</a></h3>
<p>PCIe Bifurcation 的目的是让 PCIe 有更好的灵活性。从 CPU 出来的几路 PCIe，它的宽度一般是确定的，比如有一个 x16，但是实际使用的时候，想要接多个设备，例如把 x16 当成两个 x8 来用，这就是 PCIe Bifurcation。这需要 PCIe 两端的支持，CPU 端需要可配置 PCIe Bifurcation，不然只能从一个 x16 降级到一个 x8，剩下的 8x 就没法利用了；设备端需要拆分卡，把 x16 的信号分成两路，然后提供两个 PCIe 插槽以及使用 Clock Buffer 来提供下游设备的时钟，有时则是主板设计时就做了拆分，不需要额外的拆分卡。</p>
<p>那么怎么配置 CPU 端的 PCIe Bifurcation 呢？其实就是上面两篇文章提到的办法：CPU 根据 CFG 信号来决定 PCIe Bifurcation 配置，例如要选择 1x16，2x8 还是 1x8+2x4 等等。简单总结一下实现思路都是：</p>
<ol>
<li>根据 CPU 型号（如 i7-12700K）找到 datasheet，如 <a href="https://cdrdv2.intel.com/v1/dl/getContent/655258">12th Generation Intel Core Processors Datasheet Volume 1</a></li>
<li>寻找 datasheet 中关于 PCIe Bifurcation 的配置，找到 CFG 信号的取值</li>
<li>找到 CPU 的引脚定义图（如 LGA1700），找到 CFG 引脚，然后找到附近的地或者电源</li>
<li>连接跳线</li>
</ol>
<p>具体细节这里就不赘述了，可以查看上面的两篇文章。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_2">可配置性</a></h3>
<p>这时候就有一个疑问了，如果 PCIe Bifurcation 配置是通过引脚输入的，一般电路是固定的，那是不是就不可以动态配置了？</p>
<h4 id="_3"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_3">桌面平台</a></h4>
<p>实际找一个主板来研究一下。型号是 ASRock Fatal1ty Z97X Killer，从主板的描述中，可以看到：<code>3 x PCI Express 3.0 x16 Slots (PCIE2/PCIE4/PCIE6: single at x16 (PCIE2); dual at x8 (PCIE2) / x8 (PCIE4); triple at x8 (PCIE2) / x4 (PCIE4) / x4 (PCIE6)</code>，说明它是支持 PCIe Bifurcation 的，涉及到三个 PCIe Slot，支持三种模式：</p>
<ul>
<li>PCIE2 Slot x16</li>
<li>PCIE2 Slot x8, PCIE4 Slot x8</li>
<li>PCIE2 Slot x8, PCIE4 Slot x4, PCIE6 Slot x4</li>
</ul>
<p>在 <a href="https://schematic-x.blogspot.com/2018/04/asus-pack-198-files.html">网上</a> 找到该主板的 <a href="https://drive.google.com/file/d/1j9tUFJ7n60OLIoboVuPIWZA9cNJtwsCt/view">原理图</a>，可以用 <a href="https://github.com/OpenBoardView/OpenBoardView">OpenBoardView</a> 软件打开。这个主板上的 CPU 插槽是 LGA1150，找到一个兼容的 CPU 版本 i7-4771，下载 <a href="https://cdrdv2.intel.com/v1/dl/getcontent/328897">Datasheet</a>，可以看到决定 PCIe Bifurcation 的引脚是 <code>CFG[6:5]</code>：</p>
<ul>
<li><code>CFG[6:5]=00</code>: 1x8, 2x4</li>
<li><code>CFG[6:5]=10</code>: 2x8</li>
<li><code>CFG[6:5]=11</code>: 1x16</li>
</ul>
<p>可以看到，这三种配置和主板网站上描述的是一致的。既然主板支持 Bifurcation，说明一定有办法设置 <code>CFG[6:5]</code> 为以上三种取值。</p>
<p>接下来，要找到主板上怎么连接 <code>CFG[6:5]</code>。在原理图中，可以找到 LGA1150 的 <code>U39 CPU_CFG5</code> 和 <code>U40 V_CFG6</code>，继续往下找，可以看到它们通过电阻连到了同一个 <a href="https://www.vishay.com/docs/85508/bat54.pdf">BAT54C</a> 芯片上，所以只需要看 BAT54C 第三个引脚 N105955695 的电平。N105955695 接到了一个 <a href="https://assets.nexperia.com/documents/data-sheet/2N7002BKS.pdf">2N7002BKS</a> 芯片上，根据电路图，最后是要看 <code>X4_PRSNT1#</code> 信号。</p>
<p><code>X4_PRSTN1#</code> 信号连接到了 PCIE6 上，如果 PCIE6 Slot 插入了设备，那么 <code>X4_PRSTN1#</code> 信号生效，根据分析出来的电路，它会使得 <code>CFG[6:0]</code> 变为 00，对应 1x8+2x4 的 Bifurcation 模式。回想一下，在主板支持的三种 PCIe Bifurcation 模式下，只有这一种涉及到了 PCIE6 Slot。所以如果用户在 PCIE6 Slot 插入了设备，那说明用户需要的是 1x8+2x4 的模式，自动配置 CPU 的 <code>CFG[6:5]</code> 信号为预期值。</p>
<p>另一方面，设置 <code>CFG[6:5]</code> 还不够，上面提到过，主板需要负责把 PCIE2/4/6 的信号连接到原来的完整的 x16 上，并且根据实际情况连接不同的线。具体的实现方式也可以在原理图中找到：信号 <code>X4_PRSTN1#</code> 连接到了 <a href="https://www.nxp.com.cn/docs/en/data-sheet/CBTL04083A_CBTL04083B.pdf">CBTL04083BBS</a>，这是一个 PCIe Mux/Demux 芯片，也就是把同样一组差分线连到不同 PCIe Slot 上所需要的芯片。</p>
<p>于是目前推断出了一部分的工作原理：用户在 PCIE6 Slot 插入设备，电路计算出 <code>CFG[6:5]=00</code>，同时配置好了 PCIe Mux/Demux 芯片，把 1x16 切分为 1x8+2x4。</p>
<p>继续往下看，主板如何实现剩下两种配置：<code>CFG[6:5]=10</code> 对应 2x8，<code>CFG[6:5]=11</code> 对应 1x16。这两种编码里，CFG6 都为 1，只需要考虑如何处理 CFG5。CFG5 除了连接上面提到的 BAT54C 以外，还通过另一个 2N7002BKS 芯片连接到了 <code>NB_X8_PRSENT#</code> 信号上。如果你想明白了前面的过程，应该可以推断出来，这里的 <code>NB_X8_PRSENT#</code> 连接到了 PCIE4 Slot 上。当 PCIE4 Slot 插入了设备，同时 PCIE6 Slot 没有插入设备，那么根据相应的 PRESENT 信号，可以得到 <code>CFG[6:5]=10</code>。如果 PCIE4 Slot 和 PCIE6 Slot 都没有插入设备，那就 <code>CFG[6:5]=11</code>。</p>
<p>总结一下，动态检测并计算出 <code>CFG[6:5]</code> 的逻辑：</p>
<ol>
<li>如果 PCIE6 Slot 插入了设备，说明要配置为 1x8+2x4，设置 <code>CFG[6:5]=00</code></li>
<li>否则，如果 PCIE4 Slot 插入了设备，说明要配置为 2x8，设置 <code>CFG[6:5]=10</code></li>
<li>否则，说明要配置为 1x16，设置 <code>CFG[6:5]=11</code></li>
</ol>
<p>而主板设计者就是要把这个逻辑转化为电路，用 BAT54C 和 CBTL04083BBS 芯片来实现逻辑运算。</p>
<p>顺便一提，这里的 PCIE2/4/6 物理尺寸都是 x16，只不过实际分配到的宽度不一定与物理尺寸一致。</p>
<h4 id="_4"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_4">服务器平台</a></h4>
<p>在服务器平台上，Intel CPU 的 Bifurcation 变成运行时可配置的，例如在 <a href="https://cdrdv2-public.intel.com/333810/xeon-e5-v4-datasheet-vol-2.pdf">Xeon E5 v4 Datasheet Volume 2</a> 中，可以找到寄存器 <code>pcie_iou_bif_ctrl</code> 寄存器的定义：</p>
<p><img alt="" src="/images/pcie_bifurcation.png" /></p>
<p>这个寄存器在 PCIe 配置空间中，可以通过 <code>setpci</code> 命令来读取或写入：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-1"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:00.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-2"></a><span class="m">00</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-3"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:01.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-4"></a><span class="m">01</span><span class="w"> </span><span class="c1"># x8</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-5"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:02.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-6"></a><span class="m">04</span><span class="w"> </span><span class="c1"># x16</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-7"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:03.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-8"></a><span class="m">03</span><span class="w"> </span><span class="c1"># x8x8</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-9"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">80</span>:02.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-10"></a><span class="m">04</span><span class="w"> </span><span class="c1"># x16</span>
</span></code></pre></div>
<p>通过 <code>lspci -bPP</code> 命令以及 <code>lspci -vvv</code>，可以看到在这几个 PCIe Root Port 下的设备以及速度：</p>
<ul>
<li>00:01.0(x8)/02:00.0 RAID 控制器 PCIe 3.0 x8</li>
<li>00:02.0(x16)/03:00.0 NVIDIA 显卡 PCIe 3.0 x16</li>
<li>00:03.0(x8x8)/01:00.0 BCM 2x10G+2x1G 网卡 PCIe 2.0 x8</li>
<li>80:02.0(x16)/82:00.0 NVIDIA 显卡 PCIe 3.0 x16</li>
</ul>
<p>其中前三个设备连接到 CPU1，后三个设备连接到 CPU2</p>
<p>在 BIOS 设置中，进入 Integrated Devices -&gt; Slot Bifurcation 可以看到设置，可选项有：</p>
<ul>
<li>Slot 1/2/3/5: Default Bifurcation, x4+x4 Bifurcation</li>
<li>Slot 4/6: Default Bifurcation, x4+x4+x4+x4 Bifurcation, x8+x8 Bifurcation</li>
</ul>
<p>阅读 R730 文档，可以发现它最多可以有 7 个 Slot，其中 Slot 1/2/3/5/7 是 PCIe 3.0x8，Slot 4 是 PCIe 3.0 x16，Slot 6 根据不同的 Riser 可以提供 PCIe 3.0 x8 或 x16，对应关系如下：</p>
<ul>
<li>PCIe Slot 1: x8, CPU2</li>
<li>PCIe Slot 2: x8, CPU2</li>
<li>PCIe Slot 3: x8, CPU2</li>
<li>PCIe Slot 4: x16, CPU2</li>
<li>PCIe Slot 5: x8, CPU1</li>
<li>PCIe Slot 6: x8/x16, CPU1</li>
<li>PCIe Slot 7: x8, CPU1</li>
</ul>
<p>阅读 E5 v4 CPU 文档，可以发现它有三个 PCIe Port，一共有 40 PCIe lanes（x8+x16+x16）。由此可知，其中一个 x16 连接到 Slot4/6 上，另一个 x16 拆分成 x8+x8，连接到其余的 Slot。有些奇怪的是 CPU1 少了一个 x8 不知去向，怀疑是连接到了 RAID 卡或者网卡上。缺少主板的原理图，无法继续深入研究。</p>
<p>遗憾的是，这个寄存器的 <code>iou_start_bifurcation</code> 字段只能写入一次 1 来初始化 Bifurcation，而这一般是由 BIOS 完成的。如果 BIOS 没有做，或许可以后面再写入一次；如果 BIOS 已经写入了，但是没有提供可选项，那么可以考虑逆向 BIOS，使用 UEFITool 查看是否有隐藏的配置，如果有，则可以尝试绕过 BIOS 设置去修改隐藏的配置，如果没有，可以考虑修改 BIOS 的指令。</p>
<h3 id="_5"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_5">总结</a></h3>
<p>简单总结一下，PCIe Bifurcation 的目的是保证总 lane 数不变的情况下，连接更多设备的较低成本的方法。它需要 CPU 一侧和设备一侧的支持。桌面级别的 CPU 通过 CFG 信号来配置，服务器端的 CPU 通过 PCIe 配置空间来配置。设备一侧，可以由主板进行拆分，此时主板上会有多余的 PCIe 接口，根据插在主板上的设备的情况，主板自适应出一个 PCIe Bifurcation 配置；主板也可以什么都不做，直接把 CPU 的 PCIe 接到 Slot 上，此时需要用户自己购买 PCIe 拆分卡。淘宝上可以搜到不少 <a href="https://www.taobao.com/list/product/pcie%E6%8B%86%E5%88%86%E5%8D%A1.htm">PCIe 拆分卡</a>，其中用于 NVMe 的较多，毕竟 M.2 接口面积小，而且只需要 PCIe x4。</p>
<p>另一种方案是 PCIe 交换机（如 <a href="https://docs.broadcom.com/doc/12351854">PEX 8747</a>），缺点是成本较高，增加了延迟，好处是灵活性很强，不需要 CPU 额外配置，可以外接更多设备，并且设备空闲时可以让出带宽。例如一个 x16 使用 Bifurcation 方法可以拆成两个 x8，也可以使用 PCIe 交换机连接两个 x16，类似网络，这两个 x16 共享带宽，下游的两个设备之间也可以直接通信，这个在 HPC 场景下会比较常见，例如使用 PCIe 交换机连接显卡和 IB 网卡。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2023/01/05/pcie-bifurcation/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../tools/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 工具" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                工具
              </div>
            </div>
          </a>
        
        
          
          <a href="../2022/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2022" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2022
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
        
      
    
  <script>window.addEventListener('load', function() {WaveDrom.ProcessAll();});</script></body>
</html>