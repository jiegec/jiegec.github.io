{"version": "https://jsonfeed.org/version/1.1", "title": "\u6770\u54e5\u7684{\u8fd0\u7ef4\uff0c\u7f16\u7a0b\uff0c\u8c03\u677f\u5b50}\u5c0f\u7b14\u8bb0", "home_page_url": "https://jia.je/", "feed_url": "https://jia.je/feed_json_updated.json", "description": "\u6770\u54e5\u7684{\u8fd0\u7ef4\uff0c\u7f16\u7a0b\uff0c\u8c03\u677f\u5b50}\u5c0f\u7b14\u8bb0", "icon": null, "authors": [], "language": "zh", "items": [{"id": "https://jia.je/software/2025/12/25/my-ai-usage-2025/", "url": "https://jia.je/software/2025/12/25/my-ai-usage-2025/", "title": "2025 \u5e74\u6211\u662f\u600e\u4e48\u4f7f\u7528 AI \u7684", "content_html": "<h1 id=\"2025-\u5e74\u6211\u662f\u600e\u4e48\u4f7f\u7528-ai-\u7684\">2025 \u5e74\u6211\u662f\u600e\u4e48\u4f7f\u7528 AI \u7684<a class=\"headerlink\" href=\"#2025-\u5e74\u6211\u662f\u600e\u4e48\u4f7f\u7528-ai-\u7684\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u524d\u8a00\">\u524d\u8a00<a class=\"headerlink\" href=\"#\u524d\u8a00\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7ecf\u5e38\u770b\u6211\u535a\u5ba2\u7684\u8bfb\u8005\u5e94\u8be5\u80fd\u770b\u51fa\u6765\uff0c\u6211\u7814\u7a76\u7684\u4e3b\u8981\u662f\u8ba1\u7b97\u673a\u7cfb\u7edf\u7ed3\u6784\u65b9\u5411\uff0c\u7279\u522b\u662f\u5904\u7406\u5668\u7684\u5fae\u67b6\u6784\uff0c\u51e0\u4e4e\u6ca1\u6709\u6d89\u53ca\u5230 AI \u7684\u5185\u5bb9\uff0c\u6211\u4e5f\u786e\u5b9e\u4e0d\u559c\u6b22 AI \u7814\u7a76\uff0c\u4ec5\u5173\u6ce8\u4f46\u4e0d\u53c2\u4e0e\u3002\u4f46\u4eca\u5e74\uff0c\u56e0\u4e3a\u5404\u79cd AI \u6280\u672f\u5c24\u5176\u662f LLM \u7684\u53d1\u5c55\uff0c\u6211\u786e\u5b9e\u6210\u4e3a\u4e86\u5f88\u591a AI \u6280\u672f\u7684\u7528\u6237\uff0c\u53ef\u4ee5\u8bf4 2025 \u5e74\u662f\u6211\u6b63\u7ecf\u5927\u89c4\u6a21\u7528 AI \u7684\u5143\u5e74\uff0c\u6240\u4ee5\u5728\u5e74\u672b\u505a\u4e00\u4e2a\u7b80\u5355\u7684\u603b\u7ed3\u3002</p>\n<!-- more -->\n\n<p>\u6211\u4e0d\u60f3\u5728\u8fd9\u91cc\u7ed9\u5927\u6a21\u578b\u5382\u5546\u6253\u5e7f\u544a\uff0c\u6240\u4ee5\u76f8\u5173\u7684\u540d\u5b57\u6211\u90fd\u4f1a\u6309\u7167\u67d0 PDF \u7684\u65b9\u6cd5\u8fdb\u884c\u6253\u7801\uff0c\u6709\u9700\u8981\u7684\u670b\u53cb\u53ef\u4ee5\u81ea\u884c\u67e5\u770b\u5b9e\u9645\u7684\u5185\u5bb9\u3002</p>\n<h2 id=\"vibe-coding\">Vibe Coding<a class=\"headerlink\" href=\"#vibe-coding\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u7684\u4e00\u4e2a\u51b2\u51fb\u6765\u81ea\u4e8e Vibe Coding\u3002\u6211\u5199\u4ee3\u7801\u4e5f\u6709\u5927\u6982\u5341\u4e94\u5e74\u4e86\uff0c\u4e00\u76f4\u90fd\u662f\u575a\u6301\u81ea\u5df1\u5199\u4ee3\u7801\uff0c\u4f46\u4eca\u5e74\u4ece\u4e00\u4e9b\u670b\u53cb\u90a3\u91cc\u4e86\u89e3\u5230\u4e00\u4e9b Vibe Coding \u7684\u6548\u679c\u4ee5\u540e\uff0c\u4e5f\u81ea\u5df1\u5c1d\u8bd5\u4e86\u4e00\u4e0b\uff0c\u786e\u5b9e\u80fd\u591f\u611f\u53d7\u5230 Vibe Coding \u5bf9\u5199\u4ee3\u7801\u7684\u5de8\u5927\u51b2\u51fb\uff0c\u6211\u7684\u5fc3\u6001\u4e5f\u51fa\u73b0\u4e86\u4e00\u5b9a\u7684\u53d8\u5316\u3002Vibe Coding \u5e76\u4e0d\u590d\u6742\uff0c\u5176\u5b9e\u5c31\u662f\u7528\u4e00\u4e9b Coding \u5ba2\u6237\u7aef\uff0c\u914d\u4e0a LLM \u52a0\u4e00\u4e9b Tool Call\uff0c\u4f7f\u5f97 LLM \u53ef\u4ee5\u81ea\u5df1\u7f16\u5199\u3001\u6d4b\u8bd5\u548c\u8fd0\u884c\u4ee3\u7801\u3002\u76ee\u524d\u968f\u7740 LLM \u80fd\u529b\u7684\u53d8\u5f3a\uff0cVibe Coding \u9010\u6e10\u6210\u4e3a\u4e86\u4e00\u4e2a\u53ef\u4ee5\u8d1f\u62c5\u5f97\u8d77\u4e14\u6548\u679c\u4e0d\u9519\u7684\u4e1c\u897f\u3002\u7ed3\u5408\u5b9e\u9645\u7684\u4f7f\u7528\uff0c\u4ee5\u53ca\u53d7\u670b\u53cb\u4eec\u7684\u4e00\u4e9b\u542f\u53d1\uff0c\u6211\u76ee\u524d\u5df2\u7ecf\u7528\u5b83\u8fdb\u884c\u4e86\u4e00\u4e9b Vibe Coding \u5c1d\u8bd5\uff0c\u4f8b\u5982\uff1a</p>\n<ol>\n<li>\u5199\u4e00\u4e9b\u7b80\u5355\u7684 MCP \u670d\u52a1\u5668\uff0c\u4f8b\u5982\u628a devdocs.io \u7684\u6587\u6863\u901a\u8fc7 MCP \u66b4\u9732\u7ed9 LLM\uff0c\u8ba9\u5b83\u53ef\u4ee5\u7cbe\u786e\u8bfb\u53d6\u6807\u51c6\u5e93\u7684\u6587\u6863\uff0c\u907f\u514d\u5e7b\u89c9\uff1b</li>\n<li>\u5199\u4e00\u4e2a API \u8def\u7531\u5668\uff0c\u53ef\u4ee5\u5728\u591a\u4e2a API \u63d0\u4f9b\u5546\u4e4b\u95f4\u81ea\u52a8 Fallback\uff0c\u7c7b\u4f3c\u4e8e\u672c\u5730\u7248\u7684 OpenRouter\uff0c\u4f46\u5728\u8fd9\u91cc\u4e3b\u8981\u662f\u4e3a\u4e86\u89e3\u51b3 Rate Limit \u95ee\u9898\uff1b</li>\n<li>\u5bf9\u5df2\u6709\u4ee3\u7801\u7684\u4e00\u4e9b\u6539\u8fdb\uff0c\u6bd4\u5982\u5b9e\u73b0 TODO\uff0c\u4fee\u590d\u4ee3\u7801 BUG \u7b49\u7b49\uff1b</li>\n<li>\u7ed9\u5b9a\u63d0\u793a\u8bcd\uff0c\u8ba9 LLM \u7528 Typst \u6216\u8005 SVG \u7ed8\u56fe\uff0c\u76f8\u6bd4\u76f4\u63a5 AI \u7ed8\u56fe\uff0c\u6211\u66f4\u5e0c\u671b\u662f\u53ef\u7f16\u8f91\u7684\u77e2\u91cf\u56fe\uff1b</li>\n<li>\u7ed9\u5b9a\u4e00\u5f20\u56fe\uff0c\u8ba9 LLM \u7528 Typst \u6216\u8005 SVG \u590d\u523b\u51fa\u6765\uff0c\u7136\u540e\u518d\u7528 Vision LLM \u8bc6\u522b\u7ed8\u5236\u51fa\u6765\u7684\u56fe\uff0c\u89c2\u5bdf\u5185\u5bb9\u662f\u5426\u548c\u8f93\u5165\u8db3\u591f\u76f8\u4f3c\uff1b</li>\n<li>\u5bf9\u4e8e\u95ed\u6e90\u7684\u8f6f\u4ef6\uff0c\u8ba9 LLM \u81ea\u52a8\u9006\u5411\u5de5\u7a0b\uff0c\u5f97\u5230\u4e00\u4efd\u5173\u4e8e\u5185\u90e8\u5b9e\u73b0\u7684\u4ee3\u7801\uff0c\u751a\u81f3\u8ba9\u5b83\u5b9e\u73b0\u4e00\u4efd\u5f00\u6e90\u7684\u7b49\u4ef7\u5b9e\u73b0\u3002</li>\n</ol>\n<p>\u76ee\u524d\u7ed9\u6211\u7684\u611f\u89c9\u662f\uff0cLLM \u501f\u52a9\u5404\u79cd MCP Tooling\uff0c\u5728\u5f88\u591a\u4e8b\u60c5\u4e0a\u53ef\u4ee5\u505a\u7684\u5f88\u597d\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u524d\u63d0\u6761\u4ef6\u3002\u7b2c\u4e00\u662f LLM \u9700\u8981\u6709\u9488\u5bf9\u8fd9\u4e2a\u4e8b\u60c5\u7684\u77e5\u8bc6\uff0c\u4f46\u5982\u679c\u5b83\u7684\u77e5\u8bc6\u505c\u7559\u5728\u51e0\u5e74\u524d\uff0c\u53c8\u505a\u4e00\u4e9b\u6bd4\u8f83\u65b0\u7684\u4e1c\u897f\uff08\u4f8b\u5982 Typst \u8bed\u6cd5\u5f88\u591a LLM \u5c31\u4e0d\u4f1a\u5199\uff09\uff0c\u5b83\u5c31\u6bd4\u8f83\u96be\u5199\u5bf9\uff1b\u7b2c\u4e8c\u662f\uff0c\u4e00\u5b9a\u8981\u7ed9 LLM \u53cd\u9988\u7684\u8def\u5f84\uff0c\u80fd\u591f\u8ba9\u5b83\u81ea\u4ea7\u81ea\u7ea0\u81ea\u67e5\uff0c\u4e0d\u7136\u5e7b\u89c9\u662f\u5f88\u96be\u907f\u514d\u7684\uff0c\u4e00\u6b21\u5199\u5bf9\u7684\u60c5\u51b5\u5f88\u5c11\uff0c\u6709\u53cd\u9988\u548c\u65e0\u53cd\u9988\u5b8c\u5168\u662f\u4e24\u4e2a\u8868\u73b0\uff1b\u7b2c\u4e09\u662f\uff0c\u76ee\u524d LLM \u505a\u590d\u6742\u4e8b\u60c5\u9700\u8981\u5927\u91cf\u7684 Token\uff0c\u8fd9\u5c31\u610f\u5473\u7740 API \u8c03\u7528\u65f6\u95f4\u548c\u5f00\u9500\u90fd\u662f\u4e0d\u53ef\u5ffd\u7565\u7684\u56e0\u7d20\uff0c\u5373\u4f7f\u6211\u7528\u4e86\u6bd4\u8f83\u4fbf\u5b9c\u7684 <span class=\"redacted\">DeepSeek</span> \u6a21\u578b\uff0c\u8ba9 LLM \u5728\u540e\u53f0\u8dd1\u51e0\u4e2a\u5c0f\u65f6\uff0c\u4ef7\u683c\u4e00\u6837\u53d7\u4e0d\u4e86\u3002</p>\n<p>\u4e3e\u4e00\u4e2a\u6570\u636e\uff0c\u6211\u8fd9\u4e2a\u6708\u5728 <span class=\"redacted\">DeepSeek</span> \u4e0a\u5df2\u7ecf\u82b1\u8d39\u4e86 200 \u591a\u5143\uff0c\u800c\u8fd9\u4e2a\u6708\u4e4b\u524d\u7684\u6240\u6709\u65f6\u95f4\u52a0\u8d77\u6765\uff0c\u4e5f\u5c31\u4e0d\u8fc7 10 \u5143\u3002\u5982\u679c\u76f8\u540c\u7684 Token \u6570\u7528\u5728 <span class=\"redacted\">Claude</span> \u4e0a\uff0c\u8fd9\u4e2a\u4ef7\u683c\u4e0d\u53ef\u60f3\u8c61\u3002\u6240\u4ee5\u6211\u4e5f\u7ec8\u4e8e\u80fd\u7406\u89e3\uff0c\u90a3\u4e9b\u51e0\u767e\u7f8e\u5200\u4e00\u4e2a\u6708\u7684\u8ba2\u9605\u670d\u52a1\u4e3a\u5565\u6709\u5e02\u573a\u4e86\u3002\u4e5f\u662f\u56e0\u4e3a\u8fd9\u4e2a\u539f\u56e0\uff0c\u6211\u624d\u4f1a\u964d\u672c\u589e\u6548\uff0c\u901a\u8fc7\u8ba2\u9605 <span class=\"redacted\">GLM Coding Plan</span> \u53bb\u89e3\u51b3\u4e00\u4e9b\u4f4e\u9891\u7684 Vibe Coding \u9700\u6c42\uff0c\u4f46\u5b83\u7684\u7528\u91cf\u9650\u5236\u548c\u5e76\u53d1\u9650\u5236\u90fd\u6bd4\u8f83\u5bb9\u6613\u89e6\u53d1\uff0c\u6240\u4ee5\u624d\u53bb Vibe Coding \u4e86\u4e00\u4e2a API \u8def\u7531\u5668\uff0c\u5bf9\u4e8e <span class=\"redacted\">GLM Coding Plan</span> \u7528\u91cf\u4ee5\u5916\u7684\u9700\u6c42\uff0c\u518d Fallback \u5230 <span class=\"redacted\">DeepSeek</span> \u4e0a\u3002</p>\n<p>\u5728\u4f7f\u7528 Vibe Coding \u7684\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4e5f\u6709\u4e00\u4e9b\u611f\u53d7\uff0c\u5c31\u611f\u89c9\u6211\u5e76\u4e0d\u662f\u5728 Vibe Coding\uff0c\u800c\u662f\u5728\u6307\u6325\u4e00\u4e2a\u6c34\u5e73\u98d8\u5ffd\u4e0d\u5b9a\u7684\u4eba\u5728\u5199\u4ee3\u7801\u3002\u5b83\u6709\u65f6\u5019\u80fd\u7cbe\u51c6\u5730\u627e\u5230\u95ee\u9898\u5e76\u5199\u51fa\u6b63\u786e\u7684\u4ee3\u7801\uff0c\u6709\u65f6\u5019\u53c8\u6ce8\u610f\u529b\u6da3\u6563\uff0c\u5fc5\u987b\u8981\u6211\u53ca\u65f6\u5730\u6253\u65ad\u5b83\uff0c\u8ba9\u5b83\u6309\u7167\u6211\u6307\u5b9a\u7684\u65b9\u6cd5\u53bb\u505a\u3002\u5bf9\u4e8e\u4e00\u4e9b\u7b80\u5355\u7684\u4ee3\u7801\uff0c\u53ef\u80fd\u53ef\u4ee5\u8ba9\u5b83\u5728\u540e\u53f0\u8dd1\uff0c\u6211\u53bb\u505a\u4e00\u4e9b\u522b\u7684\u4e8b\u60c5\uff0c\u7136\u540e\u9694\u4e00\u6bb5\u65f6\u95f4\u518d\u770b\u770b\u5b83\u505a\u5f97\u600e\u4e48\u6837\uff0c\u6709\u95ee\u9898\u4e86\uff0c\u518d\u63d0\u4f9b\u53ca\u65f6\u7684\u7ea0\u6b63\u3002\u7136\u540e\u6211\u5c31\u5728\u60f3\uff0c\u8fd9\u5176\u5b9e\u5c31\u662f\u5f53\u9886\u5bfc\u5427\uff0c\u7ed9\u94b1\u8ba9\u624b\u4e0b\u7684\u4eba\u5e72\u6d3b\uff0c\u4e0d\u4e00\u5b9a\u5e72\u7684\u5bf9\uff0c\u6240\u4ee5\u8fd8\u5f97\u65f6\u4e0d\u65f6\u5730\u53bb\u7ea0\u6b63\u4e00\u4e0b\u3002\u67d0\u79cd\u610f\u4e49\u6765\u8bf4\uff0cLLM \u8ba9\u6bcf\u4e2a\u4eba\u90fd\u6709\u4e86\u6210\u4e3a\u9886\u5bfc\uff0c\u9886\u5bfc\u4e00\u7fa4 LLM \u5e72\u6d3b\u7684\u80fd\u529b\u3002\u6211\u76ee\u524d\u7684\u5de5\u4f5c\u6d41\u5c31\u662f\u5728 tmux \u91cc\u6302\u51e0\u4e2a <span class=\"redacted\">Qwen Code</span>\uff0c\u8fde\u4e0a\u51e0\u4e2a\u914d\u597d\u7684 MCP \u670d\u52a1\u5668\u4ee5\u53ca API \u8def\u7531\u5668\uff0c\u7136\u540e\u65f6\u4e0d\u65f6\u5730\u770b\u770b\u5b83\u505a\u7684\u548b\u6837\uff0c\u505a\u5f97\u597d\u5c31\u9a8c\u6536\uff0c\u8ba9\u5b83 Git Commit\uff0c\u505a\u5f97\u4e0d\u597d\u5c31\u8ba9\u5b83\u6539\uff0c\u65f6\u4e0d\u65f6\u8fd8\u5f97\u7ffb\u7ffb\u4ee3\u7801\u770b\u770b\u600e\u4e48\u5e2e\u5b83\u4fee\u3002\u67d0\u79cd\u610f\u4e49\u4e0a\uff0c\u8fd9\u548c\u8bfe\u540e\u5e03\u7f6e\u4f5c\u4e1a\uff0c\u7ed9\u5b66\u751f\u7b54\u7591\u4e5f\u6ca1\u5565\u672c\u8d28\u4e0a\u7684\u533a\u522b\uff0c\u751a\u81f3 LLM \u8fd8\u66f4\u7231\u8bf4\u8bdd\u4e00\u70b9\u3002</p>\n<p>\u65e2\u7136\u63d0\u5230\u4e86\u7b54\u7591\uff0c\u4e5f\u6765\u8c08\u8c08\u6559\u5b66\u3002\u8fd9\u79cd Vibe Coding \u7684\u80fd\u529b\u5bf9\u4e8e\u8ba1\u7b97\u673a\u6559\u80b2\u7684\u51b2\u51fb\u65e0\u7591\u662f\u5de8\u5927\u7684\uff0c\u672c\u6765\u5f88\u591a\u4e0a\u8bfe\u6559\u7684\u5185\u5bb9\uff0cAI \u53ef\u4ee5\u6bd4\u8f83\u5bb9\u6613\u5730\u5b8c\u6210\uff0c\u90a3\u5b66\u751f\u53ef\u80fd\u5c31\u66f4\u503e\u5411\u4e8e\u8ba9 AI \u53bb\u5b8c\u6210\u4e86\uff0c\u6362\u4f4d\u601d\u8003\u4e00\u4e0b\uff0c\u5982\u679c\u8ba9\u6211\u5728 2025 \u5e74\u6210\u4e3a\u5927\u4e00\u4e0d\u4f1a\u7f16\u7a0b\u7684\u65b0\u751f\uff0c\u6211\u4e5f\u5f88\u96be\u62b5\u5fa1\u8fd9\u4e2a\u8bf1\u60d1\u3002\u4f46\u662f\uff0c\u953b\u70bc\u4ee3\u7801\u548c\u5de5\u7a0b\u80fd\u529b\u5c31\u6b20\u7f3a\u4e86\u3002\u8fd9\u5c31\u5bf9\u5e94\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u95ee\u9898\uff0c\u5c31\u662f AI \u5b83\u5230\u5e95\u662f\u4e0d\u662f\u4e00\u79cd\u7c7b\u4f3c\u7f16\u8bd1\u5668\u3001\u8c03\u8bd5\u5668\u6216\u8005\u7f16\u7a0b\u8bed\u8a00\u7684\u5de5\u5177\uff1f\u6211\u4eec\u8bf4\u5b66\u751f\u53ef\u4ee5\u4ece\u7f16\u7a0b\u8bed\u8a00\u800c\u4e0d\u662f\u6c47\u7f16\u5b66\u8d77\uff0c\u662f\u56e0\u4e3a\u5b83\u662f\u4e00\u4e2a\u5f88\u6210\u719f\u5f88\u53ef\u9760\u7684\u5de5\u5177\uff0c\u4f60\u5b66\u4f1a\u4e86\u9ad8\u5c42\u6b21\u7684\u5de5\u5177\u5c31\u662f\u4f1a\u4e86\uff0c\u5c31\u53ef\u4ee5\u7528\u5b83\u505a\u5f88\u591a\u4e8b\u60c5\u3002AI \u5c31\u5f88\u5947\u602a\uff0c\u5b83\u786e\u5b9e\u53ef\u4ee5\u505a\u5f88\u591a\u4e8b\u60c5\uff0c\u4f46\u53c8\u4e0d\u603b\u662f\u53ef\u4ee5\u5b8c\u6210\uff0c\u5b83\u597d\u50cf\u662f\u6982\u7387\u6027\u7684\u56fe\u7075\u5b8c\u5168\uff0c\u5168\u770b\u662f\u5426\u51fa\u73b0\u5e7b\u89c9\uff0c\u6240\u4ee5\u5b83\u4e0d\u662f\u4e00\u4e2a\u53ef\u9760\u7684\u5de5\u5177\uff0c\u4f46\u53c8\u662f\u4e00\u4e2a\u597d\u7528\u7684\u5de5\u5177\u3002\u90a3\u4e48\u7d27\u63a5\u7684\u95ee\u9898\u662f\uff0c\u8ba1\u7b97\u673a\u6559\u80b2\uff0c\u662f\u8981\u6559\u51fa\u6765\u771f\u7684\u4f1a\u5199\u4ee3\u7801\u7684\u4eba\uff0c\u8fd8\u662f\u4f1a\u7528 AI \u5199\u4ee3\u7801\u5c31\u884c\uff1f\u6211\u76ee\u524d\u6ca1\u6709\u7b54\u6848\uff0c\u4e5f\u4e0d\u77e5\u9053\u672a\u6765\u4f1a\u600e\u4e48\u53d1\u5c55\uff0c\u53ea\u80fd\u6162\u6162\u8d70\u4e00\u6b65\u770b\u4e00\u6b65\u4e86\u3002\u4f46\u629b\u5f00\u8ba1\u7b97\u673a\u4e13\u4e1a\u7684\u6559\u80b2\uff0c\u5982\u679c\u662f\u5bf9\u4e8e\u8ba1\u7b97\u673a\u7684\u901a\u8bc6\u6559\u80b2\uff0c\u6211\u89c9\u5f97\u7528 AI \u5199\u4ee3\u7801\u5b8c\u5168\u6ca1\u6709\u95ee\u9898\uff0c\u6bd5\u7adf\u5bf9\u4e8e\u66f4\u591a\u4eba\u6765\u8bf4\uff0c\u80fd\u89e3\u51b3\u95ee\u9898\u5c31\u53ef\u4ee5\uff0c\u53ef\u4e0d\u53ef\u9760\uff0c\u5176\u5b9e\u5f88\u591a\u65f6\u5019\u5e76\u4e0d\u5728\u8003\u8651\u8303\u56f4\u5185\u3002</p>\n<p>\u6211\u77e5\u9053\u4e0a\u9762\u8fd9\u6bb5\u8bdd\u53ef\u80fd\u4f1a\u8ba9\u8bfb\u8005\u6709\u4e00\u4e9b\u7126\u8651\uff0c\u4f46\u6211\u89c9\u5f97\uff0c\u5b83\u90fd\u8fd9\u6837\u4e86\uff0c\u5c31\u5171\u5b58\u5427\uff0c\u53cd\u6b63\u7126\u8651\u4e5f\u6ca1\u6709\u7528\uff0c\u4e0d\u5982\u62e5\u62b1\u5b83\u3002\u81f3\u4e8e\u662f\u5426\u62c5\u5fc3\u81ea\u5df1\u4f1a\u88ab\u66ff\u4ee3\uff0c\u6211\u786e\u5b9e\u662f\u4e0d\u62c5\u5fc3\uff0c\u76ee\u524d\u5b83\u8fd8\u4e0d\u591f\u4e13\u4e1a\uff0c\u5c31\u7b97\u5b83\u518d\u4e13\u4e1a\uff0c\u5b83\u4e5f\u6ca1\u6709\u8eab\u4efd\u8bc1\u662f\u5427\u3002\u5e0c\u671b\u65e9\u65e5\u5b9e\u73b0\u751f\u4ea7\u529b\u6781\u5927\u5bcc\u8db3\uff0c\u5b9e\u73b0\u5171\u540c\u5bcc\u88d5\uff0c\u90a3\u5c31\u4e0d\u7528\u601d\u8003\u4eba\u662f\u4e0d\u662f\u4f1a\u88ab AI \u66ff\u4ee3\u4e86\u3002\u53e6\u5916\uff0c\u9ad8\u7ea7\u7f16\u7a0b\u8bed\u8a00\u51fa\u73b0\u4e86\uff0c\u90a3\u4e9b\u5199\u6c47\u7f16\u7684\u4eba\u53bb\u5199\u9ad8\u7ea7\u8bed\u8a00\uff0c\u73b0\u5728 Vibe Coding \u6765\u4e86\uff0c\u53ea\u662f\u540c\u4e00\u62e8\u4eba\u53c8\u8dd1\u53bb\u505a Vibe Coding \u7f62\u4e86\u3002\u6301\u7eed\u5b66\u4e60\u624d\u662f\u6700\u91cd\u8981\u7684\u3002\u4eca\u5e74\u5f00\u59cb\u5c1d\u8bd5 Vibe Coding \u4e5f\u662f\u8ba9\u6211\u610f\u8bc6\u5230\uff0c\u968f\u7740\u5e74\u9f84\u589e\u5927\uff0c\u786e\u5b9e\u662f\u6ca1\u6709\u5f53\u5e74\u5bf9\u65b0\u4e8b\u7269\u63a5\u53d7\u5f97\u90a3\u4e48\u5feb\u4e86\uff0c\u8fd9\u4e5f\u8ba9\u6211\u6709\u4e86\u4e00\u4e9b\u53cd\u601d\uff0c\u4ee5\u540e\u8fd8\u662f\u8981\u591a\u591a\u63a5\u89e6\u65b0\u6280\u672f\uff0c\u4e00\u4e9b\u8fc7\u53bb\u7684\u601d\u7ef4\u53ef\u80fd\u4e5f\u8981\u91cd\u65b0\u5ba1\u89c6\u3002</p>\n<p>\u76ee\u524d\u6211\u5bf9 Vibe Coding \u7684\u6001\u5ea6\u662f\uff0c\u5b83\u4e0d\u80fd\u66ff\u4ee3\u6211\u7684\u601d\u8003\uff0c\u76f8\u53cd\uff0c\u6211\u53ef\u4ee5\u66f4\u591a\u5730\u601d\u8003\u4e00\u4e9b\u66f4\u9ad8\u5c42\u6b21\u7684\u4e1c\u897f\uff0c\u800c\u53ef\u4ee5\u9002\u5f53\u5730\u628a\u4e00\u4e9b\u7ec6\u8282\u4ea4\u7ed9 AI\u3002\u6211\u4e5f\u6301\u7eed\u5728\u81ea\u5df1\u5199\u4ee3\u7801\uff0c\u7279\u522b\u662f\u4e00\u4e9b\u5173\u952e\u7684\u90e8\u5206\uff0c\u6211\u8fd8\u662f\u65e0\u6cd5\u4fe1\u4efb\u5b8c\u5168\u7531 AI \u7f16\u5199\uff0c\u6bd5\u7adf\u5b83\u6bd4\u4eba\u8fd8\u61c2\u5f97\u5077\u61d2\uff0c\u7ecf\u5e38\u5199\u51fa\u6765\u4e00\u4e9b\u6ca1\u6709\u6d4b\u8bd5\u6548\u679c\u7684\u6d4b\u4f8b\uff0c\u4e00\u770b\u6d4b\u4f8b\u90fd\u8fc7\uff0c\u4e00\u6d4b\u5168\u662f BUG\u3002</p>\n<p>\u6211\u8fd8\u4f1a\u7ee7\u7eed\u5c1d\u8bd5\u548c LLM \u534f\u4f5c\uff0c\u5c3d\u91cf\u4fdd\u6301\u9ad8\u8d28\u91cf\u7684\u4ee3\u7801\u4ea7\u51fa\uff0c\u6211\u8ba4\u4e3a\u8fd9\u662f\u7528 Vibe Coding \u7684\u5e95\u7ebf\uff1a\u7528 AI \u5e76\u4e0d\u662f\u5199\u51fa\u70c2\u4ee3\u7801\u7684\u7406\u7531\u3002\u4ee5\u524d\u6211\u4eec\u6709\u6240\u8c13\u7684\u4e2d\u6587\u7f9e\u803b\uff0c\u89c9\u5f97\u5199\u4e86\u5f88\u591a\u4e2d\u6587\u7684\u9879\u76ee\u7684\u4ee3\u7801\u53ef\u80fd\u4e0d\u9760\u8c31\uff0c\u73b0\u5728\u662f\u6240\u8c13\u7684 AI \u7f9e\u803b\uff0c\u770b\u5230 README \u91cc\u4e00\u5806 AI \u751f\u6210\u7684\u8f9e\u85fb\u5c31\u89c9\u5f97\u4e0d\u9760\u8c31\u4e00\u6837\u3002\u6211\u4eec\u4f5c\u4e3a\u4e1a\u5185\u4eba\u58eb\uff0c\u8fd8\u662f\u8981\u628a\u4e8b\u60c5\u505a\u5f97\u6f02\u4eae\uff0c\u800c\u4e0d\u662f\u8ba9 AI \u751f\u6210\u4e00\u4e2a\u52c9\u5f3a\u80fd\u7528\u7684\u7ec4\u88c5\u62d6\u62c9\u673a\u5c31\u5b8c\u4e8b\u3002</p>\n<h2 id=\"\u5199\u4f5c\u548c\u8bed\u97f3\u8f93\u5165\">\u5199\u4f5c\u548c\u8bed\u97f3\u8f93\u5165<a class=\"headerlink\" href=\"#\u5199\u4f5c\u548c\u8bed\u97f3\u8f93\u5165\" title=\"Permanent link\">&para;</a></h2>\n<p>\u53e6\u4e00\u65b9\u9762 AI \u5f71\u54cd\u6bd4\u8f83\u5927\u7684\uff0c\u5176\u5b9e\u662f\u5199\u4f5c\uff0c\u5305\u62ec\u65e5\u5e38\u7684\u5404\u79cd\u6587\u5b57\uff0c\u6bd4\u8f83\u6b63\u5f0f\u7684\u6587\u6863\u3001\u8bba\u6587\u751a\u81f3\u6559\u6750\uff0c\u4e0d\u5f97\u4e0d\u627f\u8ba4\uff0cAI \u5728\u5199\u4f5c\u65b9\u9762\u786e\u5b9e\u662f\u6bd4\u6211\u8fd9\u79cd\u8bed\u6587\u662f\u8003\u8bd5\u5f31\u9879\u7684\u504f\u79d1\u751f\u8981\u505a\u5f97\u66f4\u597d\u3002\u6211\u901a\u5e38\u4f1a\u81ea\u5df1\u7f16\u5199\u4e00\u904d\uff0c\u7136\u540e\u4ea4\u7ed9 <span class=\"redacted\">DeepSeek</span> \u6765\u6da6\u8272\u4e00\u904d\uff0c\u518d\u5728\u6da6\u8272\u7684\u57fa\u7840\u4e0a\u4fee\u6539\uff0c\u4fdd\u8bc1\u6211\u8981\u8868\u8fbe\u7684\u610f\u601d\u80fd\u591f\u5b8c\u5168\u5730\u88ab\u4fdd\u7559\u4e0b\u6765\u3002\u4e00\u4e9b\u5c0f\u7684\u4eba\u60c5\u4e16\u6545\uff0c\u6bd4\u5982\u5fae\u4fe1\u4e0a\u548c\u5404\u79cd\u4eba\u6253\u4ea4\u9053\u7684\u63aa\u8f9e\uff0c\u7f51\u7edc\u4e0a\u53d1\u9001\u7684\u90ae\u4ef6\u6216\u8005\u662f GitHub Issue \u7b49\u7b49\u573a\u5408\u7684\u5ba2\u5957\u8bdd\uff0cAI \u786e\u5b9e\u4e5f\u662f\u505a\u5f97\u6bd4\u81ea\u5df1\u597d\u3002\u4f46\u662f\uff0c\u66f4\u5b8c\u6574\u7684\u5185\u5bb9\uff0c\u6216\u8005\u6574\u4f53\u67b6\u6784\u4e0a\u7684\u628a\u63e1\uff0c\u8fd8\u662f\u4e0d\u4f1a\u8ba9 AI \u5b8c\u5168\u53bb\u5b8c\u6210\uff0c\u56e0\u4e3a\u80fd\u611f\u89c9\u5230 AI \u8bad\u7ec3\u6240\u4f7f\u7528\u7684\u8bed\u6599\u548c\u81ea\u5df1\u7684\u601d\u7ef4\u65b9\u5f0f\u6216\u8005\u5199\u4f5c\u7684\u4e60\u60ef\u8fd8\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u6211\u8fd8\u662f\u5e0c\u671b\u6211\u5199\u7684\u4e1c\u897f\u80fd\u66f4\u52a0\u5f97\u6709\u6211\u7684\u601d\u8003\u548c\u52b3\u52a8\u5728\u91cc\u9762\uff0cAI \u53ea\u662f\u4e00\u4e2a\u8ba9\u6587\u5b57\u770b\u8d77\u6765\u66f4\u52a0\u901a\u987a\u7684\u5de5\u5177\uff0c\u5e2e\u6211\u7ea0\u6b63\u4e00\u4e9b\u8bed\u6cd5\u9519\u8bef\u4e4b\u7c7b\u7684\u3002\u4f8b\u5982\uff0c\u6211\u5e73\u65f6\u53ef\u80fd\u66f4\u4e60\u60ef\u4e00\u4e9b\u53e3\u8bed\u5316\u7684\u8868\u8fbe\uff0c\u80fd\u591f\u8ba9\u6211\u5f88\u5feb\u5730\u901a\u8fc7\u6253\u5b57\u6216\u8005\u8bed\u97f3\u8f93\u5165\u628a\u6211\u7684\u8111\u5b50\u91cc\u7684\u60f3\u6cd5\u53d8\u6210\u6587\u5b57\uff0c\u7136\u540e\u518d\u8ba9 AI \u6539\u5199\u6210\u66f4\u52a0\u4e25\u8083\u7684\u6587\u5b57\uff0c\u50cf\u6559\u6750\u6216\u8005\u8bba\u6587\uff0c\u8fd9\u65f6 AI \u5c31\u6ca6\u4e3a\u4e86\u7eaf\u7cb9\u7684\u6587\u5b57\u98ce\u683c\u6539\u5199\u6216\u8005\u8bed\u8a00\u7ffb\u8bd1\u5668\u3002</p>\n<p>\u65e2\u7136\u63d0\u5230\u4e86\u8bed\u97f3\u8f93\u5165\u6cd5\uff0c\u5c31\u4e0d\u5f97\u4e0d\u63d0\uff0c\u4eca\u5e74\u6211\u7528\u8bed\u97f3\u8f93\u5165\u7684\u6bd4\u4f8b\u5927\u5927\u63d0\u5347\u4e86\u3002\u5176\u5b9e\u8bed\u97f3\u8f93\u5165\u6cd5\u5386\u53f2\u5df2\u7ecf\u5f88\u4e45\u4e86\uff0c\u4f46\u662f\u4ee5\u524d\u6bcf\u6b21\u4f53\u9a8c\uff0c\u90fd\u89c9\u5f97\u6548\u679c\u4e0d\u884c\uff0c\u6bcf\u6b21\u8f93\u5165\u7684\u6709\u9519\u8bef\u8fd8\u5f97\u6539\uff0c\u81ea\u5df1\u6539\u6b63\u7684\u65f6\u95f4\uff0c\u8fd8\u4e0d\u5982\u81ea\u5df1\u6253\u5b57\u6765\u5f97\u5feb\u3002\u6240\u4ee5\u4e00\u76f4\u4ee5\u6765\u6211\u90fd\u662f\u575a\u6301\u5728\u6240\u6709\u8bbe\u5907\u4e0a\u90fd\u662f 26 \u952e\u6253\u5b57\u7528\u62fc\u97f3\u8f93\u5165\u7684\uff0c\u5f53\u7136\u5305\u62ec\u624b\u673a\uff0c\u7ecf\u8fc7\u591a\u5e74\u7684\u7ec3\u4e60\uff0c\u786e\u5b9e\u901f\u5ea6\u8fd8\u4e0d\u9519\uff0c\u5305\u62ec\u6211\u4e5f\u4e0d\u559c\u6b22\u9ebb\u70e6\u522b\u4eba\u5728\u5fae\u4fe1\u4e0a\u542c\u8bed\u97f3\uff0c\u6240\u4ee5\u6211\u5c3d\u91cf\u90fd\u662f\u7528\u6587\u5b57\u7684\u3002\u4f46\u4eca\u5e74\u611f\u53d7\u4e0b\u6765\uff0c\u786e\u5b9e\u662f\u4e0d\u4e00\u6837\uff0c\u611f\u89c9\u8bed\u97f3\u8f93\u5165\u7684\u51c6\u786e\u7387\u6709\u4e86\u8d28\u7684\u98de\u8dc3\uff0c\u80fd\u770b\u5230\u5b83\u5148\u8bc6\u522b\u51fa\u4e00\u4e2a\u97f3\u5bf9\u5b57\u4e0d\u5bf9\u7684\u72b6\u6001\uff0c\u518d\u7ea0\u6b63\u6210\u6b63\u786e\u7684\u8868\u8fbe\uff0c\u8fd8\u4f1a\u63d0\u793a\u4f60\uff0c\u8fd9\u91cc\u53ef\u80fd\u662f\u53e6\u4e00\u4e2a\u8bcd\uff0c\u5982\u679c\u4f60\u8981\u4fee\u6539\u7684\u8bdd\uff0c\u5c31\u76f4\u63a5\u70b9\u4e00\u4e0b\u5c31\u884c\u3002\u6709\u8fd9\u4e2a\u529f\u80fd\u4ee5\u540e\uff0c\u6211\u5728\u624b\u673a\u4e0a\u771f\u7684\u5f88\u591a\u65f6\u5019\u5c31\u76f4\u63a5\u7528\u8bed\u97f3\u8f93\u5165\u4e86\uff0c\u5c24\u5176\u662f\u5728\u4e00\u4e9b\u4e0d\u592a\u6b63\u5f0f\u7684\u573a\u5408\uff0c\u5bf9\u65b9\u4e5f\u80fd\u591f\u5bf9\u90a3\u4e9b\u5c11\u6570\u7684\u8bc6\u522b\u9519\u8bef\u8111\u8865\u7684\u65f6\u5019\uff0c\u8bed\u97f3\u8f93\u5165\u786e\u786e\u5b9e\u5b9e\u66ff\u4ee3\u4e86\u624b\u673a\u4e0a\u6253\u5b57\u3002\u5728\u7535\u8111\u4e0a\uff0c\u8fd8\u662f\u6253\u5b57\u901a\u5e38\u66f4\u5feb\u4e00\u4e9b\uff0c\u4f46\u6700\u8fd1\u4e5f\u5c1d\u8bd5\u4e86\u4e00\u4e0b <span class=\"redacted\">\u667a\u8c31 AutoGLM</span> \u7684\u8f93\u5165\u6cd5\uff0c\u611f\u89c9\u8fd9\u79cd\u8bed\u97f3\u8f93\u5165\u548c LLM \u7ed3\u5408\u8fd8\u633a\u6709\u610f\u601d\u7684\uff0c\u5c31\u662f\u5b83\u4eec\u5bb6\u7684\u8bed\u97f3\u8f93\u5165\u51c6\u786e\u7387\u8fd8\u6bd4\u4e0d\u4e0a <span class=\"redacted\">\u9e3f\u8499 6 \u4e0a\u7684\u5c0f\u827a\u8f93\u5165\u6cd5</span>\uff0c\u8981\u662f\u4e8c\u8005\u7684\u4f18\u70b9\u80fd\u591f\u7ed3\u5408\u5728\u4e00\u8d77\u5c31\u66f4\u597d\u4e86\uff0c\u76f8\u4fe1\u8fd9\u4e00\u5929\u5e76\u4e0d\u9065\u8fdc\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u76ee\u524d\u60f3\u5230\u7684\u5c31\u8fd9\u4e48\u591a\uff0c\u5176\u5b9e AI \u8fd8\u6709\u5f88\u591a\u573a\u666f\u53ef\u4ee5\u7528\u5230\uff0c\u6bd4\u5982\u751f\u6210\u56fe\u7247\u3001\u89c6\u9891\u548c\u97f3\u4e50\u7b49\u7b49\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u592a\u591a\u7684\u5c1d\u8bd5\uff0c\u76f8\u4fe1\u660e\u5e74\u5f00\u59cb\u4f1a\u9010\u6e10\u63a5\u89e6\uff0c\u5230\u65f6\u5019\u518d\u5728\u5e74\u5e95\u5199\u4e00\u4e2a AI \u4f7f\u7528\u603b\u7ed3\u3002\u603b\u7684\u4e0b\u6765\uff0c\u5c31\u662f\u611f\u53f9\u81ea\u5df1\u4e5f\u5230\u4e86\u611f\u6168\u79d1\u6280\u8fdb\u6b65\u7684\u5e74\u7eaa\u4e86\uff0c\u5341\u51e0\u5e74\u524d\u5b66\u6280\u672f\uff0c\u867d\u7136\u4e5f\u80fd\u611f\u89c9\u5230\u79d1\u6280\u8fdb\u6b65\uff0c\u4f46\u56e0\u4e3a\u81ea\u5df1\u662f\u4ece\u96f6\u5f00\u59cb\uff0c\u5b66\u7684\u5c31\u662f\u6700\u65b0\u7684\u79d1\u6280\uff0c\u6240\u4ee5\u6ca1\u6709\u5565\u611f\u89c9\u3002\u4f46\u8fd9\u51e0\u5e74\uff0c\u4e0d\u65ad\u5730\u628a\u65b0\u7684\u8f93\u5165\u548c\u5df2\u6709\u7684\u79ef\u7d2f\u8fdb\u884c\u5bf9\u6bd4\uff0c\u5c31\u80fd\u611f\u89c9\u660e\u663e\u5230\u6280\u672f\u6f6e\u6d41\u548c\u6280\u672f\u6808\u7684\u79fb\u52a8\uff0c\u4e5f\u80fd\u611f\u89c9\u5230\u81ea\u5df1\u5bf9\u65b0\u6280\u672f\u7684\u63a5\u53d7\u5ea6\u5f00\u59cb\u6709\u4e86\u7565\u5fae\u7684\u4e0b\u964d\uff0c\u8fd9\u503c\u5f97\u8ba9\u6211\u8b66\u9192\u3002\u4ee5\u524d\uff0c\u6211\u4eec\u603b\u662f\u5632\u7b11\u5927\u4eba\u4e0d\u8ffd\u6c42\u6f6e\u6d41\uff0c\u4e0d\u53bb\u5b66\u4e60\u624b\u673a\u7b49\u65b0\u6280\u672f\uff0c\u6211\u4eec\u5728\u8fd9\u4e2a\u65f6\u4ee3\u957f\u5927\u7684\u4eba\uff0c\u53ef\u4e5f\u4e0d\u80fd\u72af\u8fd9\u6837\u7684\u9519\u8bef\u5440\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/software/my-ai-usage-2025.png", "date_modified": "2025-12-25T00:00:00+00:00", "date_published": "2025-12-25T00:00:00+00:00", "authors": [], "tags": ["ai", "llm", "software", "vibe"]}, {"id": "https://jia.je/hardware/2025/10/28/cbp-reverse-engineer/", "url": "https://jia.je/hardware/2025/10/28/cbp-reverse-engineer/", "title": "\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u9006\u5411\u5de5\u7a0b\uff08\u4ee5 Apple M1 Firestorm \u4e3a\u4f8b\uff09", "content_html": "<h1 id=\"\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u9006\u5411\u5de5\u7a0b\u4ee5-apple-m1-firestorm-\u4e3a\u4f8b\">\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u9006\u5411\u5de5\u7a0b\uff08\u4ee5 Apple M1 Firestorm \u4e3a\u4f8b\uff09<a class=\"headerlink\" href=\"#\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u9006\u5411\u5de5\u7a0b\u4ee5-apple-m1-firestorm-\u4e3a\u4f8b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u53bb\u5e74\u6211\u5b8c\u6210\u4e86\u9488\u5bf9 Apple \u548c Qualcomm \u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff08Conditional Branch Predictor\uff09\u7684\u9006\u5411\u5de5\u7a0b\u7814\u7a76\uff0c\u76f8\u5173\u8bba\u6587\u5df2\u53d1\u8868\u5728 <a href=\"https://arxiv.org/abs/2411.13900\">arXiv</a> \u4e0a\uff0c\u5e76\u516c\u5f00\u4e86<a href=\"https://github.com/jiegec/cpu-micro-benchmarks\">\u6e90\u4ee3\u7801</a>\u3002\u8003\u8651\u5230\u8bb8\u591a\u8bfb\u8005\u5bf9\u5904\u7406\u5668\u9006\u5411\u5de5\u7a0b\u611f\u5174\u8da3\uff0c\u4f46\u53ef\u80fd\u56e0\u5176\u590d\u6742\u6027\u800c\u671b\u800c\u5374\u6b65\uff0c\u672c\u6587\u5c06\u4ee5 Apple M1 Firestorm \u4e3a\u4f8b\uff0c\u8be6\u7ec6\u4ecb\u7ecd\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u9006\u5411\u5de5\u7a0b\u65b9\u6cd5\uff0c\u4f5c\u4e3a\u5bf9\u539f\u8bba\u6587\u7684\u8865\u5145\u8bf4\u660e\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u80cc\u666f\u77e5\u8bc6\">\u80cc\u666f\u77e5\u8bc6<a class=\"headerlink\" href=\"#\u80cc\u666f\u77e5\u8bc6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u4ecb\u7ecd\u4e00\u4e9b\u80cc\u666f\u77e5\u8bc6\u3002\u8981\u9006\u5411\u5de5\u7a0b\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u9700\u8981\u5148\u4e86\u89e3\u5176\u5de5\u4f5c\u539f\u7406\u3002\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u57fa\u672c\u601d\u8def\u662f\uff1a</p>\n<ul>\n<li>\u6761\u4ef6\u5206\u652f\u7684\u8df3\u8f6c\u884c\u4e3a\uff08\u8df3\u8f6c\u6216\u4e0d\u8df3\u8f6c\uff09\u901a\u5e38\u662f\u9ad8\u5ea6\u53ef\u9884\u6d4b\u7684</li>\n<li>\u9884\u6d4b\u5668\u7684\u8f93\u5165\u5305\u62ec\u6761\u4ef6\u5206\u652f\u7684\u5730\u5740\uff0c\u4ee5\u53ca\u8fd1\u671f\u6267\u884c\u7684\u82e5\u5e72\u6761\u5206\u652f\u7684\u5386\u53f2\u8bb0\u5f55\uff1b\u8f93\u51fa\u5219\u662f\u9884\u6d4b\u8be5\u6761\u4ef6\u5206\u652f\u662f\u5426\u8df3\u8f6c</li>\n</ul>\n<p>\u4e3a\u4e86\u5728\u786c\u4ef6\u4e0a\u5b9e\u73b0\u8fd9\u4e00\u7b97\u6cd5\uff0c\u5904\u7406\u5668\u4f1a\u7ef4\u62a4\u4e00\u4e2a\u9884\u6d4b\u8868\uff0c\u8868\u4e2d\u6bcf\u4e00\u9879\u5305\u542b\u4e00\u4e2a 2 \u4f4d\u9971\u548c\u8ba1\u6570\u5668\uff0c\u7528\u4e8e\u9884\u6d4b\u8df3\u8f6c\u65b9\u5411\u3002\u67e5\u8868\u65f6\uff0c\u7cfb\u7edf\u4f1a\u5bf9\u6761\u4ef6\u5206\u652f\u5730\u5740\u4ee5\u53ca\u8fd1\u671f\u6267\u884c\u7684\u5206\u652f\u5386\u53f2\u8fdb\u884c\u54c8\u5e0c\u8fd0\u7b97\uff0c\u4f7f\u7528\u54c8\u5e0c\u7ed3\u679c\u4f5c\u4e3a\u7d22\u5f15\u8bfb\u53d6\u8868\u9879\uff0c\u7136\u540e\u6839\u636e\u8ba1\u6570\u5668\u7684\u503c\u6765\u9884\u6d4b\u5206\u652f\u7684\u8df3\u8f6c\u65b9\u5411\u3002</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-basic.png\" /></p>\n<p>\uff08\u56fe\u6e90\uff1aCMU ECE740 Computer Architecture: Branch Prediction\uff09</p>\n<p>\u76ee\u524d\u4e3b\u6d41\u5904\u7406\u5668\u666e\u904d\u91c7\u7528 <a href=\"https://inria.hal.science/hal-03408381/document\">TAGE</a> \u9884\u6d4b\u5668\uff0c\u5b83\u5728\u4e0a\u8ff0\u57fa\u7840\u67e5\u8868\u65b9\u6cd5\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u4e86\u91cd\u8981\u6539\u8fdb\uff1a</p>\n<ol>\n<li>\u89c2\u5bdf\u5230\u4e0d\u540c\u5206\u652f\u7684\u9884\u6d4b\u6240\u9700\u7684\u5386\u53f2\u957f\u5ea6\u5404\u4e0d\u76f8\u540c\uff1a\u6709\u4e9b\u5206\u652f\u65e0\u9700\u5386\u53f2\u4fe1\u606f\u5373\u53ef\u51c6\u786e\u9884\u6d4b\uff0c\u6709\u4e9b\u4f9d\u8d56\u8fd1\u671f\u5206\u652f\u7684\u8df3\u8f6c\u7ed3\u679c\uff0c\u800c\u6709\u4e9b\u5219\u9700\u8981\u66f4\u4e45\u8fdc\u7684\u5386\u53f2\u4fe1\u606f\uff1b</li>\n<li>\u5206\u652f\u5386\u53f2\u8d8a\u957f\uff0c\u53ef\u80fd\u7684\u8def\u5f84\u7ec4\u5408\u5c31\u8d8a\u591a\uff0c\u5bfc\u81f4\u9884\u6d4b\u5668\u8bad\u7ec3\u8fc7\u7a0b\u53d8\u6162\uff0c\u8bad\u7ec3\u671f\u95f4\u7684\u9884\u6d4b\u9519\u8bef\u7387\u8f83\u9ad8\uff0c\u56e0\u6b64\u5e0c\u671b\u5c3d\u5feb\u6536\u655b\uff1b</li>\n<li>\u4e3a\u6ee1\u8db3\u4e0d\u540c\u5206\u652f\u5bf9\u5386\u53f2\u957f\u5ea6\u7684\u9700\u6c42\uff0cTAGE \u8bbe\u8ba1\u4e86\u591a\u4e2a\u9884\u6d4b\u8868\uff0c\u6bcf\u4e2a\u8868\u4f7f\u7528\u4e0d\u540c\u957f\u5ea6\u7684\u5206\u652f\u5386\u53f2\u3002\u591a\u4e2a\u8868\u540c\u65f6\u8fdb\u884c\u9884\u6d4b\uff0c\u5f53\u591a\u4e2a\u8868\u90fd\u63d0\u4f9b\u9884\u6d4b\u7ed3\u679c\u65f6\uff08\u4ec5\u5728 tag \u5339\u914d\u65f6\u63d0\u4f9b\u9884\u6d4b\uff09\uff0c\u9009\u62e9\u4f7f\u7528\u6700\u957f\u5386\u53f2\u957f\u5ea6\u7684\u9884\u6d4b\u7ed3\u679c\u3002</li>\n</ol>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-tage.png\" /></p>\n<p>\uff08\u56fe\u6e90\uff1a<a href=\"https://cseweb.ucsd.edu/~tullsen/halfandhalf.pdf\">Half&amp;Half: Demystifying Intel's Directional Branch Predictors for Fast, Secure Partitioned Execution</a>\uff09</p>\n<p>\u56e0\u6b64\uff0c\u8981\u9006\u5411\u5de5\u7a0b\u5904\u7406\u5668\u7684\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u9700\u8981\u5b8c\u6210\u4ee5\u4e0b\u5de5\u4f5c\uff1a</p>\n<ol>\n<li>\u786e\u5b9a\u5206\u652f\u5386\u53f2\u7684\u8bb0\u5f55\u65b9\u5f0f\uff1a\u901a\u5e38\u6d89\u53ca\u5206\u652f\u5730\u5740\u548c\u76ee\u7684\u5730\u5740\uff0c\u901a\u8fc7\u4e00\u7cfb\u5217\u79fb\u4f4d\u548c\u5f02\u6216\u64cd\u4f5c\uff0c\u5c06\u7ed3\u679c\u5b58\u50a8\u5728\u5bc4\u5b58\u5668\u4e2d\uff1b</li>\n<li>\u786e\u5b9a TAGE \u7b97\u6cd5\u7684\u5177\u4f53\u5b9e\u73b0\uff1a\u5305\u62ec\u8868\u7684\u6570\u91cf\u3001\u6bcf\u4e2a\u8868\u7684\u5927\u5c0f\u3001\u7d22\u5f15\u65b9\u5f0f\u4ee5\u53ca\u4f7f\u7528\u7684\u5206\u652f\u5386\u53f2\u957f\u5ea6\u3002</li>\n</ol>\n<h2 id=\"\u5206\u652f\u5386\u53f2\u7684\u9006\u5411\">\u5206\u652f\u5386\u53f2\u7684\u9006\u5411<a class=\"headerlink\" href=\"#\u5206\u652f\u5386\u53f2\u7684\u9006\u5411\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7b2c\u4e00\u6b65\u662f\u9006\u5411\u5de5\u7a0b\u5904\u7406\u5668\u8bb0\u5f55\u5206\u652f\u5386\u53f2\u7684\u65b9\u5f0f\u3002\u4f20\u7edf\u6559\u79d1\u4e66\u65b9\u6cd5\u4f7f\u7528\u4e00\u4e2a\u5bc4\u5b58\u5668\uff0c\u6bcf\u5f53\u9047\u5230\u6761\u4ef6\u5206\u652f\u65f6\u8bb0\u5f55\u5176\u8df3\u8f6c\u65b9\u5411\uff08\u8df3\u8f6c\u8bb0\u4e3a 1\uff0c\u4e0d\u8df3\u8f6c\u8bb0\u4e3a 0\uff09\uff0c\u6bcf\u4e2a\u5206\u652f\u5360\u7528 1 bit\u3002\u7136\u800c\uff0c\u73b0\u4ee3\u5904\u7406\u5668\uff08\u5305\u62ec Intel\u3001Apple\u3001Qualcomm\u3001ARM \u548c\u90e8\u5206 AMD\uff09\u666e\u904d\u91c7\u7528 <a href=\"https://ieeexplore.ieee.org/document/476809/\">Path History Register</a> \u65b9\u6cd5\u3002\u8fd9\u79cd\u65b9\u6cd5\u8bbe\u8ba1\u4e00\u4e2a\u957f\u5ea6\u4e3a <span class=\"arithmatex\">\\(n\\)</span> \u7684\u5bc4\u5b58\u5668 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span>\uff0c\u6bcf\u5f53\u9047\u5230\u8df3\u8f6c\u5206\u652f\uff08\u5305\u62ec\u6761\u4ef6\u5206\u652f\u548c\u65e0\u6761\u4ef6\u5206\u652f\uff09\u65f6\uff0c\u5c06\u5bc4\u5b58\u5668\u5de6\u79fb\uff0c\u7136\u540e\u5c06\u5f53\u524d\u8df3\u8f6c\u5206\u652f\u7684\u5730\u5740\u548c\u76ee\u7684\u5730\u5740\u901a\u8fc7\u54c8\u5e0c\u51fd\u6570\u6620\u5c04\uff0c\u5c06\u54c8\u5e0c\u7ed3\u679c\u5f02\u6216\u5230\u79fb\u4f4d\u5bc4\u5b58\u5668\u4e2d\u3002\u7528\u6570\u5b66\u516c\u5f0f\u8868\u793a\u4e3a\uff1a</p>\n<p><span class=\"arithmatex\">\\(\\mathrm{PHR}_{\\mathrm{new}} = (\\mathrm{PHR}_{\\mathrm{old}} \\ll \\mathrm{shamt}) \\oplus \\mathrm{footprint}\\)</span></p>\n<p>\u5176\u4e2d <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u662f\u901a\u8fc7\u5206\u652f\u5730\u5740\u548c\u76ee\u7684\u5730\u5740\u8ba1\u7b97\u5f97\u5230\u7684\u54c8\u5e0c\u503c\u3002\u63a5\u4e0b\u6765\u7684\u4efb\u52a1\u662f\u786e\u5b9a <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u4f4d\u5bbd\u3001\u6bcf\u6b21\u5de6\u79fb\u7684\u4f4d\u6570\uff0c\u4ee5\u53ca <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u7684\u8ba1\u7b97\u65b9\u6cd5\u3002</p>\n<h3 id=\"\u5386\u53f2\u957f\u5ea6\">\u5386\u53f2\u957f\u5ea6<a class=\"headerlink\" href=\"#\u5386\u53f2\u957f\u5ea6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u5206\u6790\u8fd9\u4e2a\u66f4\u65b0\u516c\u5f0f\uff1a\u5b83\u5c06\u6700\u8fd1\u7684 <span class=\"arithmatex\">\\(\\lceil n / \\mathrm{shamt} \\rceil\\)</span> \u6761\u8df3\u8f6c\u5206\u652f\u7684\u4fe1\u606f\u538b\u7f29\u5b58\u50a8\u5728 <span class=\"arithmatex\">\\(n\\)</span> \u4f4d\u7684 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u5bc4\u5b58\u5668\u4e2d\u3002\u968f\u7740\u79fb\u4f4d\u64cd\u4f5c\u7684\u7d2f\u79ef\uff0c\u66f4\u65e9\u7684\u5206\u652f\u5386\u53f2\u4fe1\u606f\u5bf9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u8d21\u732e\u6700\u7ec8\u4f1a\u53d8\u4e3a\u96f6\u3002</p>\n<p>\u7b2c\u4e00\u4e2a\u5b9e\u9a8c\u7684\u76ee\u6807\u662f\u786e\u5b9a <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u80fd\u591f\u8bb0\u5f55\u591a\u5c11\u6761\u6700\u8fd1\u5206\u652f\u7684\u5386\u53f2\u3002\u5177\u4f53\u65b9\u6cd5\u662f\u6784\u5efa\u4e00\u4e2a\u5206\u652f\u5386\u53f2\u5e8f\u5217\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\uff1a\u4ee5 50% \u7684\u6982\u7387\u968f\u673a\u8df3\u8f6c\u6216\u4e0d\u8df3\u8f6c\uff1b</li>\n<li>\u4e2d\u95f4\u63d2\u5165\u82e5\u5e72\u6761\u65e0\u6761\u4ef6\u5206\u652f\uff1b</li>\n<li>\u6700\u540e\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\uff1a\u8df3\u8f6c\u65b9\u5411\u4e0e\u7b2c\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u76f8\u540c\u3002</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u5206\u6790\u4e24\u79cd\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u5982\u679c\u5728\u9884\u6d4b\u6700\u540e\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u65f6\uff0c\u5206\u652f\u5386\u53f2 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u4ecd\u7136\u5305\u542b\u7b2c\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u7684\u4fe1\u606f\uff0c\u9884\u6d4b\u5668\u5e94\u8be5\u80fd\u591f\u51c6\u786e\u9884\u6d4b\u6700\u540e\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u7684\u65b9\u5411\uff1b</li>\n<li>\u5982\u679c\u4e2d\u95f4\u7684\u65e0\u6761\u4ef6\u5206\u652f\u6570\u91cf\u8db3\u591f\u591a\uff0c\u4f7f\u5f97\u7b2c\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u7684\u8df3\u8f6c\u4fe1\u606f\u5bf9\u9884\u6d4b\u6700\u540e\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u65f6\u7684 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u6ca1\u6709\u5f71\u54cd\uff0c\u9884\u6d4b\u5668\u53ea\u80fd\u4ee5 50% \u7684\u6982\u7387\u8fdb\u884c\u6b63\u786e\u9884\u6d4b\u3002</li>\n</ol>\n<p>\u901a\u8fc7\u6784\u9020\u4e0a\u8ff0\u7a0b\u5e8f\uff0c\u8c03\u6574\u4e2d\u95f4\u65e0\u6761\u4ef6\u5206\u652f\u7684\u6570\u91cf\uff0c\u5e76\u4f7f\u7528\u6027\u80fd\u8ba1\u6570\u5668\u7edf\u8ba1\u5206\u652f\u9884\u6d4b\u9519\u8bef\u7387\uff0c\u53ef\u4ee5\u627e\u5230\u4e00\u4e2a\u4e34\u754c\u70b9\u3002\u5f53\u65e0\u6761\u4ef6\u5206\u652f\u6570\u91cf\u8d85\u8fc7\u8fd9\u4e2a\u9608\u503c\u65f6\uff0c\u7b2c\u4e8c\u4e2a\u6761\u4ef6\u5206\u652f\u7684\u9519\u8bef\u9884\u6d4b\u7387\u4f1a\u4ece 0% \u4e0a\u5347\u5230 50%\u3002\u8fd9\u4e2a\u4e34\u754c\u70b9\u5bf9\u5e94 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u80fd\u591f\u8bb0\u5f55\u7684\u5206\u652f\u5386\u53f2\u6570\u91cf\uff0c\u5373 <span class=\"arithmatex\">\\(\\lceil n / \\mathrm{shamt} \\rceil\\)</span>\u3002</p>\n<p>\u7ecf\u8fc7<a href=\"https://github.com/jiegec/cpu-micro-benchmarks/blob/master/src/phr_size_gen.cpp\">\u6d4b\u8bd5</a>\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-phr-len.png\" /></p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a># \u7b2c\u4e00\u5217\uff1a\u7b2c\u4e8c\u6b65\u63d2\u5165\u7684\u65e0\u6761\u4ef6\u5206\u652f\u6570\u91cf\u52a0\u4e00\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a># \u7b2c\u4e8c\u5217\u5230\u7b2c\u56db\u5217\uff1a\u5206\u652f\u9884\u6d4b\u9519\u8bef\u6982\u7387\u7684 min/avg/max\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a># \u7b2c\u4e94\u5217\uff1a\u6bcf\u6b21\u5faa\u73af\u7684\u5468\u671f\u6570\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>size,min,avg,max,cycles\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>97,0.00,0.00,0.01,216.87\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a>98,0.00,0.00,0.01,221.02\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>99,0.00,0.00,0.01,225.18\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a>100,0.00,0.00,0.01,229.17\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>101,0.45,0.50,0.53,331.97\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a>102,0.47,0.50,0.54,336.27\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>103,0.46,0.50,0.54,339.85\n</span></code></pre></div>\n<p>\u6d4b\u8bd5\u7ed3\u679c\u8868\u660e\u9608\u503c\u4e3a 100\uff1a\u5728 Apple M1 Firestorm \u4e0a\uff0c\u6700\u591a\u53ef\u4ee5\u8bb0\u5f55\u6700\u8fd1 100 \u6761\u5206\u652f\u7684\u5386\u53f2\u4fe1\u606f\u3002</p>\n<details class=\"question\">\n<summary>\u5206\u652f\u9884\u6d4b\u9519\u8bef\u7387\u662f\u600e\u4e48\u6d4b\u91cf\u7684\uff1f</summary>\n<p>\u5904\u7406\u5668\u5185\u7f6e\u4e86\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u4f1a\u8bb0\u5f55\u5206\u652f\u9884\u6d4b\u9519\u8bef\u6b21\u6570\u3002\u5728 Linux \u4e0a\uff0c\u53ef\u4ee5\u7528 perf \u5b50\u7cfb\u7edf\u6765\u8bfb\u53d6\uff1b\u5728 macOS \u4e0a\uff0c\u53ef\u4ee5\u7528 kpep \u79c1\u6709 API \u6765\u83b7\u53d6\u3002\u6211\u5f00\u6e90\u7684\u4ee3\u7801\u4e2d\u5bf9\u8fd9\u4e9b API \u8fdb\u884c\u4e86<a href=\"https://github.com/jiegec/cpu-micro-benchmarks/blob/master/src/utils.cpp\">\u5c01\u88c5</a>\uff0c\u53ef\u4ee5\u5b9e\u73b0\u8de8\u5e73\u53f0\u7684\u6027\u80fd\u8ba1\u6570\u5668\u8bfb\u53d6\u3002\u66f4\u8fdb\u4e00\u6b65\uff0c\u6211\u4eec\u8fd8\u9006\u5411\u4e86 Qualcomm Oryon \u7684\u9488\u5bf9\u6761\u4ef6\u5206\u652f\u7684\u9884\u6d4b\u9519\u8bef\u6b21\u6570\u7684\u9690\u85cf\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u7528\u4e8e\u540e\u7eed\u7684\u5b9e\u9a8c\u3002</p>\n</details>\n<h3 id=\"\u5206\u652f\u5730\u5740-b-\u7684\u8d21\u732e\">\u5206\u652f\u5730\u5740 B \u7684\u8d21\u732e<a class=\"headerlink\" href=\"#\u5206\u652f\u5730\u5740-b-\u7684\u8d21\u732e\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u9700\u8981\u63a8\u6d4b <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u7684\u8ba1\u7b97\u65b9\u6cd5\uff0c\u5373\u5206\u652f\u5730\u5740\u548c\u76ee\u7684\u5730\u5740\u5982\u4f55\u53c2\u4e0e <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u66f4\u65b0\u8fc7\u7a0b\u3002\u7ea6\u5b9a\u5206\u652f\u5730\u5740\u8bb0\u4e3a <span class=\"arithmatex\">\\(B\\)</span>\uff08Branch \u7684\u9996\u5b57\u6bcd\uff09\uff0c\u76ee\u7684\u5730\u5740\u8bb0\u4e3a <span class=\"arithmatex\">\\(T\\)</span>\uff08Target \u7684\u9996\u5b57\u6bcd\uff09\uff0c\u7528 <span class=\"arithmatex\">\\(B[i]\\)</span> \u8868\u793a\u5206\u652f\u5730\u5740\u4ece\u4f4e\u5230\u9ad8\u7b2c <span class=\"arithmatex\">\\(i\\)</span> \u4f4d\uff08\u4e0b\u6807\u4ece 0 \u5f00\u59cb\uff09\u7684\u503c\uff0c<span class=\"arithmatex\">\\(T[i]\\)</span> \u540c\u7406\u3002\u5047\u8bbe <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u7684\u6bcf\u4e00\u4f4d\u90fd\u7531\u82e5\u5e72\u4e2a <span class=\"arithmatex\">\\(B[i]\\)</span> \u548c <span class=\"arithmatex\">\\(T[i]\\)</span> \u901a\u8fc7\u5f02\u6216\u8fd0\u7b97\u5f97\u5230\u3002</p>\n<details class=\"question\">\n<summary>\u5206\u652f\u6307\u4ee4\u672c\u8eab\u5360\u7528\u4e86\u591a\u4e2a\u5b57\u8282\uff0c\u90a3\u4e48\u5206\u652f\u5730\u5740\u6307\u7684\u662f\u54ea\u4e00\u4e2a\u5b57\u8282\u7684\u5730\u5740\u5462\uff1f</summary>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0cAMD64 \u67b6\u6784\u4e0b\uff0c\u5206\u652f\u5730\u5740\u7528\u7684\u662f\u5206\u652f\u6307\u4ee4\u6700\u540e\u4e00\u4e2a\u5b57\u8282\u7684\u5730\u5740\uff0c\u800c ARM64 \u67b6\u6784\u4e0b\uff0c\u5206\u652f\u5730\u5740\u7528\u7684\u662f\u5206\u652f\u6307\u4ee4\u7b2c\u4e00\u4e2a\u5b57\u8282\u7684\u5730\u5740\u3002\u8fd9\u5927\u6982\u662f\u56e0\u4e3a AMD64 \u67b6\u6784\u4e0b\u5206\u652f\u6307\u4ee4\u662f\u53d8\u957f\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u8de8\u8d8a\u9875\u7684\u8fb9\u754c\uff1bARM64 \u5219\u662f\u5b9a\u957f\u7684\uff0c\u5e76\u4e14\u4e0d\u4f1a\u8de8\u8d8a\u9875\u7684\u8fb9\u754c\u3002</p>\n</details>\n<p>\u8bbe\u8ba1\u4ee5\u4e0b\u7a0b\u5e8f\u6765\u63a8\u6d4b\u67d0\u4e2a <span class=\"arithmatex\">\\(B[i]\\)</span> \u5982\u4f55\u53c2\u4e0e <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u7684\u8ba1\u7b97\uff1a</p>\n<ol>\n<li>\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0cApple M1 Firestorm \u6700\u591a\u53ef\u4ee5\u8bb0\u5f55\u6700\u8fd1 100 \u6761\u5206\u652f\u7684\u5386\u53f2\u4fe1\u606f\uff0c\u4e3a\u4e86\u8ba9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u8fdb\u5165\u4e00\u4e2a\u7a33\u5b9a\u7684\u521d\u59cb\u503c\uff0c\u6267\u884c 100 \u4e2a\u65e0\u6761\u4ef6\u5206\u652f\uff1b</li>\n<li>\u8bbe\u8ba1\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7b2c\u4e00\u6761\u662f\u6761\u4ef6\u5206\u652f\uff0c\u6309 50% \u7684\u6982\u7387\u8df3\u6216\u4e0d\u8df3\uff1b\u7b2c\u4e8c\u6761\u662f\u65e0\u6761\u4ef6\u5206\u652f\uff1b\u8fd9\u4e24\u6761\u5206\u652f\u7684\u5206\u652f\u5730\u5740\u53ea\u5728 <span class=\"arithmatex\">\\(B[i]\\)</span> \u4e0a\u4e0d\u540c\uff0c\u5176\u4f59\u7684\u4f4d\u90fd\u76f8\u540c\uff0c\u76ee\u7684\u5730\u5740\u76f8\u540c\uff1b</li>\n<li>\u6267\u884c\u82e5\u5e72\u6761\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u76ee\u7684\u662f\u628a <span class=\"arithmatex\">\\(B[i]\\)</span> \u5bf9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u8d21\u732e\u5411\u524d\u79fb\u52a8\uff1b</li>\n<li>\u6267\u884c\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5176\u8df3\u8f6c\u65b9\u5411\u4e0e\u7b2c\u4e8c\u6b65\u4e2d\u6761\u4ef6\u5206\u652f\u7684\u65b9\u5411\u4e00\u81f4\u3002</li>\n</ol>\n<p>\u5bf9\u5e94\u7684\u4ee3\u7801\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\">// step 1.</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"c1\">// 100 jumps forward</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"nl\">jump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"nl\">jump_98</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_99</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"nl\">jump_99</span><span class=\"p\">:</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"c1\">// step 2.</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">();</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a><span class=\"c1\">// the follow two branches differ in B[i]</span>\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a><span class=\"c1\">// first conditional branch, 50% taken or not taken</span>\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a><span class=\"c1\">// second unconditional branch</span>\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a><span class=\"nl\">target</span><span class=\"p\">:</span>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a>\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a><span class=\"c1\">// step 3.</span>\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a><span class=\"c1\">// variable number of jumps forward</span>\n</span><span id=\"__span-1-20\"><a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\" href=\"#__codelineno-1-20\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-21\"><a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\" href=\"#__codelineno-1-21\"></a><span class=\"nl\">varjump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-22\"><a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\" href=\"#__codelineno-1-22\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-1-23\"><a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\" href=\"#__codelineno-1-23\"></a><span class=\"nl\">varjump_k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-24\"><a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\" href=\"#__codelineno-1-24\"></a>\n</span><span id=\"__span-1-25\"><a id=\"__codelineno-1-25\" name=\"__codelineno-1-25\" href=\"#__codelineno-1-25\"></a><span class=\"c1\">// step 4.</span>\n</span><span id=\"__span-1-26\"><a id=\"__codelineno-1-26\" name=\"__codelineno-1-26\" href=\"#__codelineno-1-26\"></a><span class=\"c1\">// conditional branch</span>\n</span><span id=\"__span-1-27\"><a id=\"__codelineno-1-27\" name=\"__codelineno-1-27\" href=\"#__codelineno-1-27\"></a><span class=\"nl\">last</span><span class=\"p\">:</span>\n</span><span id=\"__span-1-28\"><a id=\"__codelineno-1-28\" name=\"__codelineno-1-28\" href=\"#__codelineno-1-28\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-29\"><a id=\"__codelineno-1-29\" name=\"__codelineno-1-29\" href=\"#__codelineno-1-29\"></a><span class=\"nl\">end</span><span class=\"p\">:</span>\n</span></code></pre></div>\n<p>\u7b2c\u4e8c\u6b65\u4e2d\u6761\u4ef6\u5206\u652f\u8df3\u8f6c\u4e0e\u5426\uff0c\u4f1a\u5f71\u54cd\u5206\u652f\u5386\u53f2\u4e2d <span class=\"arithmatex\">\\(B[i]\\)</span> \u4e00\u4e2a\u4f4d\u7684\u53d8\u5316\uff0c\u5b83\u4f1a\u7ecf\u8fc7\u54c8\u5e0c\u51fd\u6570\uff0c\u5f71\u54cd <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span>\uff0c\u8fdb\u800c\u5f02\u6216\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u4e2d\u3002\u901a\u8fc7\u8c03\u6574\u7b2c\u4e09\u6b65\u6267\u884c\u7684\u65e0\u6761\u4ef6\u5206\u652f\u4e2a\u6570\uff0c\u53ef\u4ee5\u628a <span class=\"arithmatex\">\\(B[i]\\)</span> \u5bf9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u5f71\u54cd\u5de6\u79fb\u5230\u4e0d\u540c\u7684\u4f4d\u7f6e\u3002\u5982\u679c <span class=\"arithmatex\">\\(B[i]\\)</span> \u5bf9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u9020\u6210\u4e86\u5f71\u54cd\uff0c\u5c31\u53ef\u4ee5\u6b63\u786e\u9884\u6d4b\u6700\u540e\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u7684\u65b9\u5411\u3002\u5f53\u5de6\u79fb\u6b21\u6570\u8db3\u591f\u591a\u65f6\uff0c<span class=\"arithmatex\">\\(B[i]\\)</span> \u5bf9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u8d21\u732e\u4f1a\u53d8\u4e3a\u96f6\uff0c\u6b64\u65f6\u5bf9\u6700\u540e\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u7684\u65b9\u5411\u9884\u6d4b\u53ea\u6709 50% \u7684\u6b63\u786e\u7387\u3002\u5728 Apple M1 Firestorm \u4e0a<a href=\"https://github.com/jiegec/cpu-micro-benchmarks/blob/master/src/phr_branch_bits_location_gen.cpp\">\u6d4b\u8bd5</a>\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-phrb.png\" /></p>\n<p>\u6a2a\u5750\u6807 <code>Dummy branches</code> \u6307\u7684\u662f\u4e0a\u9762\u7b2c\u4e09\u6b65\u63d2\u5165\u7684\u65e0\u6761\u4ef6\u5206\u652f\u7684\u4e2a\u6570\uff0c\u7eb5\u5750\u6807 <code>Branch toggle bit</code> \u4ee3\u8868\u4fee\u6539\u7684\u662f\u5177\u4f53\u54ea\u4e00\u4e2a <span class=\"arithmatex\">\\(B[i]\\)</span>\uff0c\u989c\u8272\u5bf9\u5e94\u5206\u652f\u9884\u6d4b\u7684\u9519\u8bef\u7387\uff0c\u6d45\u8272\u90e8\u5206\u5bf9\u5e94\u6700\u540e\u4e00\u6761\u5206\u652f\u53ea\u80fd\u6b63\u786e\u9884\u6d4b 50%\uff0c\u6df1\u8272\u90e8\u5206\u5bf9\u5e94\u6700\u540e\u4e00\u6761\u5206\u652f\u603b\u662f\u53ef\u4ee5\u6b63\u786e\u9884\u6d4b\u3002</p>\n<p>\u4ece\u8fd9\u4e2a\u56fe\u53ef\u4ee5\u5f97\u5230\u4ec0\u4e48\u4fe1\u606f\u5462\uff1f\u9996\u5148\u89c2\u5bdf <span class=\"arithmatex\">\\(B[2]\\)</span> \u5bf9\u5e94\u7684\u8fd9\u4e00\u884c\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u786e\u5b9e\u53c2\u4e0e\u5230\u4e86 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u8ba1\u7b97\u4e2d\uff0c\u4f46\u662f\u4ec5\u4ec5\u7ecf\u8fc7 28 \u6b21\u79fb\u4f4d\uff0c\u8fd9\u4e2a\u8d21\u732e\u5c31\u88ab\u79fb\u51fa\u4e86 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span>\uff0c\u4e3a\u4e86\u4fdd\u7559\u5728 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u5185\uff0c\u6700\u591a\u79fb\u52a8 27 \u6b21\u3002\u7c7b\u4f3c\u5730\uff0c\u5728\u79fb\u51fa <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u4e4b\u524d\uff0c<span class=\"arithmatex\">\\(B[3]\\)</span> \u6700\u591a\u79fb\u52a8 26 \u6b21\uff0c<span class=\"arithmatex\">\\(B[4]\\)</span> \u6700\u591a\u79fb\u52a8 25 \u6b21\uff0c<span class=\"arithmatex\">\\(B[5]\\)</span> \u6700\u591a\u79fb\u52a8 24 \u6b21\u3002</p>\n<p>\u4f46\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e9b <span class=\"arithmatex\">\\(B\\)</span> \u662f\u540c\u65f6\u8fdb\u5165 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\uff1a\u8fd9\u6697\u793a\u5b83\u4eec\u5bf9\u5e94 <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u7684\u4e0d\u540c\u4f4d\u7f6e\u3002\u5982\u679c\u67d0\u4e2a <span class=\"arithmatex\">\\(B[i]\\)</span> \u51fa\u73b0\u5728 <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u66f4\u9ad8\u4f4d\u7684\u5730\u65b9\uff0c\u5b83\u4e5f\u4f1a\u8fdb\u5165 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u66f4\u9ad8\u4f4d\uff0c\u7ecf\u8fc7\u66f4\u5c11\u7684\u79fb\u4f4d\u6b21\u6570\u5c31\u4f1a\u88ab\u79fb\u51fa <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span>\uff1b\u53cd\u4e4b\uff0c\u5982\u679c <span class=\"arithmatex\">\\(B[i]\\)</span> \u51fa\u73b0\u5728 <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u66f4\u4f4e\u4f4d\u7684\u5730\u65b9\uff0c\u5b83\u80fd\u591f\u5728 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u4e2d\u505c\u7559\u66f4\u957f\u7684\u65f6\u95f4\u3002</p>\n<p>\u6839\u636e\u4e0a\u9762\u7684\u5b9e\u9a8c\uff0c\u53ef\u89c1 <span class=\"arithmatex\">\\(B[5], B[4], B[3], B[2]\\)</span> \u53c2\u4e0e\u5230\u4e86 <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u8ba1\u7b97\u4e2d\uff0c\u800c <span class=\"arithmatex\">\\(B\\)</span> \u7684\u5176\u4ed6\u4f4d\u5219\u6ca1\u6709\u3002\u4f46\u6bd4\u8f83\u5947\u602a\u7684\u662f\uff0c<span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7406\u5e94\u53ef\u4ee5\u8bb0\u5f55\u6700\u8fd1 100 \u6761\u5206\u652f\u7684\u4fe1\u606f\uff0c\u4f46\u5b9e\u9645\u4e0a\u53ea\u89c2\u5bdf\u5230\u4e86 28\u3002\u6240\u4ee5\u4e00\u5b9a\u8fd8\u6709\u5176\u4ed6\u7684\u4fe1\u606f\u3002</p>\n<h3 id=\"\u76ee\u7684\u5730\u5740-t-\u7684\u8d21\u732e\">\u76ee\u7684\u5730\u5740 T \u7684\u8d21\u732e<a class=\"headerlink\" href=\"#\u76ee\u7684\u5730\u5740-t-\u7684\u8d21\u732e\" title=\"Permanent link\">&para;</a></h3>\n<p>\u521a\u521a\u6d4b\u8bd5\u4e86 <span class=\"arithmatex\">\\(B\\)</span>\uff0c\u63a5\u4e0b\u6765\u6d4b\u8bd5 <span class=\"arithmatex\">\\(T\\)</span> \u5404\u4f4d\u5bf9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u8d21\u732e\uff0c\u65b9\u6cd5\u7c7b\u4f3c\uff1a</p>\n<ol>\n<li>\u4e3a\u4e86\u8ba9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u8fdb\u5165\u4e00\u4e2a\u7a33\u5b9a\u7684\u521d\u59cb\u503c\uff0c\u6267\u884c 100 \u4e2a\u65e0\u6761\u4ef6\u5206\u652f\uff1b</li>\n<li>\u8bbe\u8ba1\u4e00\u4e2a\u95f4\u63a5\u5206\u652f\uff0c\u6839\u636e\u968f\u673a\u6570\uff0c\u968f\u673a\u8df3\u8f6c\u5230\u4e24\u4e2a\u4e0d\u540c\u7684\u76ee\u7684\u5730\u5740\uff0c\u8fd9\u4e24\u4e2a\u76ee\u7684\u5730\u5740\u53ea\u5728 <span class=\"arithmatex\">\\(T[i]\\)</span> \u4e0a\u4e0d\u540c\uff0c\u5176\u4f59\u7684\u4f4d\u90fd\u76f8\u540c\uff0c\u5206\u652f\u5730\u5740\u76f8\u540c\uff1b</li>\n<li>\u6267\u884c\u82e5\u5e72\u6761\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u76ee\u7684\u662f\u628a <span class=\"arithmatex\">\\(T[i]\\)</span> \u5bf9 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u8d21\u732e\u5411\u524d\u79fb\u52a8\uff1b</li>\n<li>\u6267\u884c\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5176\u8df3\u8f6c\u65b9\u5411\u53d6\u51b3\u4e8e\u7b2c\u4e8c\u6b65\u4e2d\u95f4\u63a5\u5206\u652f\u6240\u4f7f\u7528\u7684\u968f\u673a\u6570\u3002</li>\n</ol>\n<p>\u5bf9\u5e94\u7684\u4ee3\u7801\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\">// step 1.</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"c1\">// 100 jumps forward</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"nl\">jump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"nl\">jump_98</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_99</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"nl\">jump_99</span><span class=\"p\">:</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a><span class=\"c1\">// step 2.</span>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">();</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"c1\">// indirect branch</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"c1\">// the follow two targets differ in T[i]</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">target0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target1</span><span class=\"p\">};</span>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a><span class=\"nl\">target0</span><span class=\"p\">:</span>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"c1\">// add many nops</span>\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a><span class=\"nl\">target1</span><span class=\"p\">:</span>\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a>\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a><span class=\"c1\">// step 3.</span>\n</span><span id=\"__span-2-20\"><a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\" href=\"#__codelineno-2-20\"></a><span class=\"c1\">// variable number of jumps forward</span>\n</span><span id=\"__span-2-21\"><a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\" href=\"#__codelineno-2-21\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-22\"><a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\" href=\"#__codelineno-2-22\"></a><span class=\"nl\">varjump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-23\"><a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\" href=\"#__codelineno-2-23\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-2-24\"><a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\" href=\"#__codelineno-2-24\"></a><span class=\"nl\">varjump_k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-25\"><a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\" href=\"#__codelineno-2-25\"></a>\n</span><span id=\"__span-2-26\"><a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\" href=\"#__codelineno-2-26\"></a><span class=\"c1\">// step 4.</span>\n</span><span id=\"__span-2-27\"><a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\" href=\"#__codelineno-2-27\"></a><span class=\"c1\">// conditional branch</span>\n</span><span id=\"__span-2-28\"><a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\" href=\"#__codelineno-2-28\"></a><span class=\"nl\">last</span><span class=\"p\">:</span>\n</span><span id=\"__span-2-29\"><a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\" href=\"#__codelineno-2-29\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-30\"><a id=\"__codelineno-2-30\" name=\"__codelineno-2-30\" href=\"#__codelineno-2-30\"></a><span class=\"nl\">end</span><span class=\"p\">:</span>\n</span></code></pre></div>\n<p>\u5728 Apple M1 Firestorm \u4e0a<a href=\"https://github.com/jiegec/cpu-micro-benchmarks/blob/master/src/phr_target_bits_location_gen.cpp\">\u6d4b\u8bd5</a>\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-phrt.png\" /></p>\n<details class=\"question\">\n<summary>\u4e3a\u4e86\u6d4b\u8bd5 T[31]\uff0c\u5c82\u4e0d\u662f\u8981\u63d2\u5165\u5f88\u591a\u4e2a NOP\uff0c\u4e00\u65b9\u9762\u4e8c\u8fdb\u5236\u5f88\u5927\uff0c\u5176\u6b21\u8fd8\u8981\u6267\u884c\u5f88\u957f\u65f6\u95f4\uff1f</summary>\n<p>\u662f\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u5728\u6d4b\u8bd5\u7684\u65f6\u5019\uff0c\u91c7\u7528\u7684\u662f\u7c7b\u4f3c JIT \u7684\u65b9\u6cd5\uff0c\u901a\u8fc7 mmap <code>MAP_FIXED</code> \u5728\u5185\u5b58\u4e2d\u7279\u5b9a\u4f4d\u7f6e\u5206\u914d\u5e76\u5199\u5165\u4ee3\u7801\uff0c\u907f\u514d\u4e86\u7528\u6c47\u7f16\u5668\u751f\u6210\u4e00\u4e2a\u5de8\u5927\u7684 ELF\u3002\u540c\u65f6\uff0c\u4e3a\u4e86\u907f\u514d\u6267\u884c\u5927\u91cf\u7684 NOP\uff0c\u8003\u8651\u5230\u524d\u9762\u5df2\u7ecf\u53d1\u73b0 <span class=\"arithmatex\">\\(B[6]\\)</span> \u6216\u66f4\u9ad8\u7684\u4f4d\u6ca1\u6709\u53c2\u4e0e\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u8ba1\u7b97\u4e2d\uff0c\u6240\u4ee5\u53ef\u4ee5\u6dfb\u52a0\u989d\u5916\u7684\u4e00\u7ec4\u65e0\u6761\u4ef6\u5206\u652f\u6765\u8df3\u8fc7\u5927\u91cf\u7684 NOP\uff0c\u5b83\u4eec\u7684\u76ee\u7684\u5730\u5740\u76f8\u540c\uff0c\u5206\u652f\u5730\u5740\u4f4e\u4f4d\u76f8\u540c\uff0c\u56e0\u6b64\u5bf9 PHR \u4e0d\u4f1a\u4ea7\u751f\u5f71\u54cd\u3002\u5bf9\u5e94\u7684\u4ee3\u7801\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"c1\">// step 1.</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"c1\">// 100 jumps forward</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"nl\">jump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"nl\">jump_98</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_99</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"nl\">jump_99</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"c1\">// step 2.</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">();</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"c1\">// indirect branch</span>\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a><span class=\"c1\">// the follow two targets differ in T[i]</span>\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">target0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target1</span><span class=\"p\">};</span>\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-3-15\"><a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\" href=\"#__codelineno-3-15\"></a><span class=\"nl\">target0</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-16\"><a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\" href=\"#__codelineno-3-16\"></a><span class=\"c1\">// skip over nops, while keeping B[5:2]=0</span>\n</span><span id=\"__span-3-17\"><a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\" href=\"#__codelineno-3-17\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">target2</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-18\"><a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\" href=\"#__codelineno-3-18\"></a><span class=\"c1\">// add many nops</span>\n</span><span id=\"__span-3-19\"><a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\" href=\"#__codelineno-3-19\"></a><span class=\"nl\">target1</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-20\"><a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\" href=\"#__codelineno-3-20\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">target2</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-21\"><a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\" href=\"#__codelineno-3-21\"></a>\n</span><span id=\"__span-3-22\"><a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\" href=\"#__codelineno-3-22\"></a><span class=\"nl\">target2</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-23\"><a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\" href=\"#__codelineno-3-23\"></a>\n</span><span id=\"__span-3-24\"><a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\" href=\"#__codelineno-3-24\"></a><span class=\"c1\">// step 3.</span>\n</span><span id=\"__span-3-25\"><a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\" href=\"#__codelineno-3-25\"></a><span class=\"c1\">// variable number of jumps forward</span>\n</span><span id=\"__span-3-26\"><a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\" href=\"#__codelineno-3-26\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-27\"><a id=\"__codelineno-3-27\" name=\"__codelineno-3-27\" href=\"#__codelineno-3-27\"></a><span class=\"nl\">varjump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-28\"><a id=\"__codelineno-3-28\" name=\"__codelineno-3-28\" href=\"#__codelineno-3-28\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-3-29\"><a id=\"__codelineno-3-29\" name=\"__codelineno-3-29\" href=\"#__codelineno-3-29\"></a><span class=\"nl\">varjump_k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-30\"><a id=\"__codelineno-3-30\" name=\"__codelineno-3-30\" href=\"#__codelineno-3-30\"></a>\n</span><span id=\"__span-3-31\"><a id=\"__codelineno-3-31\" name=\"__codelineno-3-31\" href=\"#__codelineno-3-31\"></a><span class=\"c1\">// step 4.</span>\n</span><span id=\"__span-3-32\"><a id=\"__codelineno-3-32\" name=\"__codelineno-3-32\" href=\"#__codelineno-3-32\"></a><span class=\"c1\">// conditional branch</span>\n</span><span id=\"__span-3-33\"><a id=\"__codelineno-3-33\" name=\"__codelineno-3-33\" href=\"#__codelineno-3-33\"></a><span class=\"nl\">last</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-34\"><a id=\"__codelineno-3-34\" name=\"__codelineno-3-34\" href=\"#__codelineno-3-34\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-35\"><a id=\"__codelineno-3-35\" name=\"__codelineno-3-35\" href=\"#__codelineno-3-35\"></a><span class=\"nl\">end</span><span class=\"p\">:</span>\n</span></code></pre></div>\n</details>\n<p>\u7531\u6b64\u6211\u4eec\u7ec8\u4e8e\u627e\u5230\u4e86\u5206\u652f\u5386\u53f2\u6700\u957f\u8bb0\u5f55 100 \u6761\u5206\u652f\u7684\u6765\u6e90\uff1a<span class=\"arithmatex\">\\(T[2]\\)</span> \u4f1a\u7ecf\u8fc7 <span class=\"arithmatex\">\\(\\mathrm{footprint}\\)</span> \u88ab\u5f02\u6216\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u6700\u4f4e\u4f4d\uff0c\u7136\u540e\u6bcf\u6b21\u6267\u884c\u4e00\u4e2a\u8df3\u8f6c\u5206\u652f\u5de6\u79fb\u4e00\u6b21\uff0c\u76f4\u5230\u79fb\u52a8 100 \u6b21\u624d\u88ab\u79fb\u51fa <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span>\u3002\u7c7b\u4f3c\u5730\uff0c<span class=\"arithmatex\">\\(T[3]\\)</span> \u53ea\u9700\u8981 99 \u6b21\u5c31\u80fd\u79fb\u51fa <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span>\uff0c\u8bf4\u660e <span class=\"arithmatex\">\\(T[3]\\)</span> \u88ab\u5f02\u6216\u5230\u4e86 <span class=\"arithmatex\">\\(\\mathrm{PHR}[1]\\)</span>\u3002\u4f9d\u6b64\u7c7b\u63a8\uff0c\u53ef\u4ee5\u77e5\u9053\u6d89\u53ca <span class=\"arithmatex\">\\(T\\)</span> \u7684 <span class=\"arithmatex\">\\(\\mathrm{footprint} = T[31:2]\\)</span>\uff0c\u5176\u4e2d <span class=\"arithmatex\">\\(T[31:2]\\)</span> \u4ee3\u8868\u4e00\u4e2a 30 \u4f4d\u7684\u6570\uff0c\u6bcf\u4e00\u4f4d\u4ece\u9ad8\u5230\u4f4e\u5206\u522b\u5bf9\u5e94 <span class=\"arithmatex\">\\(T[31], T[30], \\cdots, T[2]\\)</span>\u3002</p>\n<h3 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff0c\u524d\u9762\u6d4b\u8bd5 <span class=\"arithmatex\">\\(B\\)</span> \u7684\u65f6\u5019\uff0c\u79fb\u4f4d\u6b21\u6570\u90a3\u4e48\u5c11\uff0c\u660e\u663e\u5c11\u4e8e <span class=\"arithmatex\">\\(T\\)</span> \u7684\u79fb\u4f4d\u6b21\u6570\u3002\u8fd9\u6709\u4e24\u79cd\u53ef\u80fd\uff1a</p>\n<ol>\n<li>\u786c\u4ef6\u4e0a\u53ea\u6709\u4e00\u4e2a <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u5bc4\u5b58\u5668\uff0c<span class=\"arithmatex\">\\(T[31:2]\\)</span> \u88ab\u5f02\u6216\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u4f4e\u4f4d\uff0c\u800c <span class=\"arithmatex\">\\(B[5:2]\\)</span> \u88ab\u5f02\u6216\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u7684\u4e2d\u95f4\u4f4d\u7f6e\uff1b</li>\n<li>\u786c\u4ef6\u4e0a\u6709\u4e24\u4e2a <span class=\"arithmatex\">\\(\\mathrm{PHR}\\)</span> \u5bc4\u5b58\u5668\uff0c\u5176\u4e2d\u4e00\u4e2a\u662f 100 \u4f4d\uff0c\u5b83\u7684 <span class=\"arithmatex\">\\(\\mathrm{footprint} = T[31:2]\\)</span>\uff0c\u8bb0\u4e3a <span class=\"arithmatex\">\\(\\mathrm{PHRT}\\)</span>\uff1b\u53e6\u4e00\u4e2a\u662f 28 \u4f4d\uff0c\u5b83\u7684 <span class=\"arithmatex\">\\(\\mathrm{footprint} = B[5:2]\\)</span>\uff0c\u8bb0\u4e3a <span class=\"arithmatex\">\\(\\mathrm{PHRB}\\)</span>\u3002</li>\n</ol>\n<p>\u7ecf\u8fc7\u540e\u7eed\u7684\u6d4b\u8bd5\uff0c\u57fa\u672c\u786e\u8ba4\u786c\u4ef6\u5b9e\u73b0\u7684\u662f\u7b2c\u4e8c\u79cd\u3002\u7528\u6570\u5b66\u516c\u5f0f\u8868\u8fbe\uff1a</p>\n<p><span class=\"arithmatex\">\\(\\mathrm{PHRT}_{\\mathrm{new}} = (\\mathrm{PHRT}_{\\mathrm{old}} \\ll 1) \\oplus \\mathrm{T}[31:2]\\)</span></p>\n<p><span class=\"arithmatex\">\\(\\mathrm{PHRB}_{\\mathrm{new}} = (\\mathrm{PHRB}_{\\mathrm{old}} \\ll 1) \\oplus \\mathrm{B}[5:2]\\)</span></p>\n<p>\u6709\u610f\u601d\u7684\u662f\uff0c\u5728\u6211\u7684\u8bba\u6587\u53d1\u8868\u540e\u4e0d\u4e45\uff0cApple \u516c\u5f00\u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US12159142B1/en\">Managing table accesses for tagged geometric length (TAGE) load value prediction</a> \u4e2d\u5c31\u51fa\u73b0\u4e86\u76f8\u5173\u8868\u8ff0\uff0c\u8bc1\u660e\u4e86\u9006\u5411\u7ed3\u679c\u7684\u6b63\u786e\u6027\u3002</p>\n<p>\u6309\u7167\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u6211\u8fd8\u9006\u5411\u5de5\u7a0b\u4e86 Apple\u3001Qualcomm\u3001ARM \u548c Intel \u7684\u591a\u4ee3\u5904\u7406\u5668\u7684\u5206\u652f\u5386\u53f2\u8bb0\u5f55\u65b9\u6cd5\uff0c<a href=\"https://jia.je/cpu/cbp.html\">\u5e76\u8fdb\u884c\u4e86\u516c\u5f00</a>\uff0c\u4f9b\u611f\u5174\u8da3\u7684\u8bfb\u8005\u9605\u8bfb\uff0c\u4e5f\u6b22\u8fce\u8bfb\u8005\u5c06\u6d4b\u8bd5\u4ee3\u7801\u79fb\u690d\u5230\u66f4\u591a\u5904\u7406\u5668\u4e0a\uff0c\u5e76\u8d21\u732e\u9006\u5411\u5de5\u7a0b\u7684\u7ed3\u679c\u3002</p>\n<h2 id=\"tage-\u8868\u7684\u9006\u5411\">TAGE \u8868\u7684\u9006\u5411<a class=\"headerlink\" href=\"#tage-\u8868\u7684\u9006\u5411\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u76ee\u5149\u8f6c\u5411 TAGE \u8868\u7684\u9006\u5411\u5de5\u7a0b\u3002TAGE \u8868\u4e0e\u7f13\u5b58\u7ed3\u6784\u7c7b\u4f3c\uff0c\u4e5f\u662f\u4e00\u4e2a\u591a\u8def\u7ec4\u76f8\u8fde\u7684\u7ed3\u6784\uff0c\u901a\u8fc7 index \u8bbf\u95ee\u82e5\u5e72\u8def\uff0c\u7136\u540e\u5bf9\u6bcf\u4e00\u8def\u8fdb\u884c tag \u5339\u914d\uff0c\u5339\u914d\u6b63\u786e\u7684\u90a3\u4e00\u8def\u63d0\u4f9b\u9884\u6d4b\u3002TAGE \u5728\u9884\u6d4b\u65f6\uff0c\u8f93\u5165\u662f\u5386\u53f2\u5bc4\u5b58\u5668\uff0c\u5373\u4e0a\u9762\u9006\u5411\u5f97\u5230\u7684 <span class=\"arithmatex\">\\(\\mathrm{PHRT}\\)</span> \u548c <span class=\"arithmatex\">\\(\\mathrm{PHRB}\\)</span>\uff0c\u4ee5\u53ca\u5206\u652f\u5730\u5740\uff0c\u76ee\u524d\u8fd9\u4e24\u4e2a\u8f93\u5165\u90fd\u662f\u53ef\u63a7\u7684\u3002\u4e3a\u4e86\u907f\u514d\u591a\u4e2a\u8868\u540c\u65f6\u63d0\u4f9b\u9884\u6d4b\uff0c\u9996\u5148\u9006\u5411\u5de5\u7a0b\u4f7f\u7528\u5206\u652f\u5386\u53f2\u6700\u957f\u7684\u8868\u7684\u53c2\u6570\uff1a\u5b83\u7684\u5bb9\u91cf\u662f\u591a\u5c11\uff0cindex \u5982\u4f55\u8ba1\u7b97\uff0ctag \u5982\u4f55\u8ba1\u7b97\uff0c\u4ee5\u53ca\u51e0\u8def\u7ec4\u76f8\u8fde\u3002</p>\n<p>\u5982\u4f55\u786e\u4fdd\u4f7f\u7528\u5206\u652f\u5386\u53f2\u6700\u957f\u7684\u8868\u63d0\u4f9b\u9884\u6d4b\u5462\uff1f\u5176\u5b9e\u8fd8\u662f\u5229\u7528\u5206\u652f\u5386\u53f2\u7684\u7279\u6027\uff0c\u5c06\u968f\u673a\u6570\u6ce8\u5165\u5230 <span class=\"arithmatex\">\\(PHRT\\)</span> \u4e2d\uff0c\u4f8b\u5982\u524d\u9762\u7684\u95f4\u63a5\u5206\u652f\uff0c\u8ba9\u4e24\u4e2a\u76ee\u7684\u5730\u5740\u53ea\u5728 <span class=\"arithmatex\">\\(T[2]\\)</span> \u4e0a\u4e0d\u540c\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"c1\">// add some unconditional jumps to reset phr to some constant value</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"c1\">// 100 jumps forward</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"nl\">jump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"nl\">jump_98</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">jump_99</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"nl\">jump_99</span><span class=\"p\">:</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"c1\">// inject</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">();</span>\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"c1\">// indirect branch</span>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"c1\">// the follow two targets differ in T[2]</span>\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">target0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target1</span><span class=\"p\">};</span>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a><span class=\"nl\">target0</span><span class=\"p\">:</span>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"c1\">// add nop here</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a><span class=\"nl\">target1</span><span class=\"p\">:</span>\n</span><span id=\"__span-4-18\"><a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\" href=\"#__codelineno-4-18\"></a>\n</span><span id=\"__span-4-19\"><a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\" href=\"#__codelineno-4-19\"></a><span class=\"c1\">// add some unconditional jumps to shift the injected bit left</span>\n</span><span id=\"__span-4-20\"><a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\" href=\"#__codelineno-4-20\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_0</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-21\"><a id=\"__codelineno-4-21\" name=\"__codelineno-4-21\" href=\"#__codelineno-4-21\"></a><span class=\"nl\">varjump_0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">varjump_1</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-22\"><a id=\"__codelineno-4-22\" name=\"__codelineno-4-22\" href=\"#__codelineno-4-22\"></a><span class=\"c1\">// ...</span>\n</span><span id=\"__span-4-23\"><a id=\"__codelineno-4-23\" name=\"__codelineno-4-23\" href=\"#__codelineno-4-23\"></a><span class=\"nl\">varjump_k</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-24\"><a id=\"__codelineno-4-24\" name=\"__codelineno-4-24\" href=\"#__codelineno-4-24\"></a><span class=\"nl\">last</span><span class=\"p\">:</span>\n</span></code></pre></div>\n<p>\u6839\u636e\u524d\u9762\u7684\u5206\u6790\uff0c<span class=\"arithmatex\">\\(T[2]\\)</span> \u4f1a\u88ab\u5f02\u6216\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHRT}\\)</span> \u7684\u6700\u4f4e\u4f4d\u4e0a\uff0c\u6bcf\u6267\u884c\u4e00\u6b21\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u5c31\u5de6\u79fb\u4e00\u4f4d\u3002\u56e0\u6b64\uff0c\u901a\u8fc7\u82e5\u5e72\u4e2a\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u53ef\u4ee5\u628a <code>d % 2</code> \u8fd9\u4e2a\u968f\u673a\u6570\u6ce8\u5165\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHRT}\\)</span> \u7684\u4efb\u610f\u4e00\u4f4d\u4e0a\u3002\u4e4b\u540e\u6211\u4eec\u8fd8\u4f1a\u5f88\u591a\u6b21\u5730\u8fdb\u884c\u8fd9\u79cd\u968f\u673a\u6570\u7684\u6ce8\u5165\u3002</p>\n<p>\u628a\u968f\u673a\u6570\u6ce8\u5165\u5230 <span class=\"arithmatex\">\\(\\mathrm{PHRT}\\)</span> \u9ad8\u4f4d\u4ee5\u540e\uff0c\u518d\u9884\u6d4b\u4e00\u4e2a\u6839\u636e\u968f\u673a\u6570\u8df3\u8f6c\u6216\u4e0d\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5b83\u53ea\u80fd\u7531\u4f7f\u7528\u5206\u652f\u5386\u53f2\u6700\u957f\u7684\u8868\u6765\u8fdb\u884c\u9884\u6d4b\u3002</p>\n<h3 id=\"\u9006\u5411\u5de5\u7a0b-pc-\u8f93\u5165\">\u9006\u5411\u5de5\u7a0b PC \u8f93\u5165<a class=\"headerlink\" href=\"#\u9006\u5411\u5de5\u7a0b-pc-\u8f93\u5165\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\uff0c\u6211\u4eec\u5e0c\u671b\u63a8\u65ad PC \u5982\u4f55\u53c2\u4e0e\u5230 index \u6216 tag \u8ba1\u7b97\u4e2d\u3002\u901a\u5e38\uff0cTAGE \u53ea\u4f1a\u91c7\u7528\u4e00\u90e8\u5206 PC \u4f4d\u53c2\u4e0e index \u6216 tag \u8ba1\u7b97\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5982\u679c\u4e24\u4e2a\u5206\u652f\u5728 PC \u4e0a\u4e0d\u540c\u7684\u90e8\u5206\u6ca1\u6709\u53c2\u4e0e index \u6216 tag \u8ba1\u7b97\uff0c\u90a3\u4e48 TAGE \u65e0\u6cd5\u533a\u5206\u8fd9\u4e24\u6761\u5206\u652f\u3002\u5982\u679c\u8fd9\u4e24\u4e2a\u5206\u652f\u8df3\u8f6c\u65b9\u5411\u76f8\u53cd\uff0c\u5e76\u4e14\u7528\u76f8\u540c\u7684 PHR \u8fdb\u884c\u9884\u6d4b\uff0c\u90a3\u4e48\u4e00\u5b9a\u4f1a\u51fa\u73b0\u9519\u8bef\u7684\u9884\u6d4b\u3002\u601d\u8def\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u7528 100 \u4e2a\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u4fdd\u8bc1 PHR \u53d8\u6210\u4e00\u4e2a\u786e\u5b9a\u7684\u503c\uff1b</li>\n<li>\u6ce8\u5165\u968f\u673a\u6570 <code>d % 2</code> \u5230 PHRT\uff0c\u5e76\u79fb\u52a8\u5230\u9ad8\u4f4d\uff08\u4f8b\u5982 <span class=\"arithmatex\">\\(PHRT[99]\\)</span>\uff09\uff0c\u4f7f\u7528\u524d\u9762\u6240\u8ff0\u7684\u65b9\u6cd5\uff1b</li>\n<li>\u6267\u884c\u4e24\u4e2a\u6761\u4ef6\u5206\u652f\uff0c\u5b83\u4eec\u5728\u5206\u652f\u5730\u5740\u4e0a\u53ea\u6709\u4e00\u4f4d <span class=\"arithmatex\">\\(PC[i]\\)</span> \u4e0d\u540c\uff0c\u5b83\u4eec\u7684\u8df3\u8f6c\u6761\u4ef6\u76f8\u53cd\uff0c\u5f53\u7b2c\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u4e0d\u8df3\u8f6c\u7684\u65f6\u5019\uff0c\u4f1a\u6267\u884c\u7b2c\u4e8c\u4e2a\u6761\u4ef6\u5206\u652f\uff0c\u5b83\u603b\u662f\u4f1a\u8df3\u8f6c\u3002</li>\n</ol>\n<p>\u5bf9\u5e94\u4ee3\u7801\u7c7b\u4f3c\u4e8e\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"c1\">// step 1. inject phrt</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">();</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"n\">inject_phrt</span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"p\">);</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"c1\">// step 2. a pair of conditional branches with different direction</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a><span class=\"c1\">// their PC differs in one bit</span>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"nl\">end</span><span class=\"p\">:</span>\n</span></code></pre></div>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0cPC \u7684\u8f93\u5165\u662f <span class=\"arithmatex\">\\(PC[18:2]\\)</span>\uff0c\u5176\u4f59\u7684\u6ca1\u6709\u3002</p>\n<h3 id=\"\u9006\u5411\u5de5\u7a0b\u76f8\u8fde\u5ea6\u548c-index-\u51fd\u6570\u7684-pc-\u8f93\u5165\">\u9006\u5411\u5de5\u7a0b\u76f8\u8fde\u5ea6\u548c index \u51fd\u6570\u7684 PC \u8f93\u5165<a class=\"headerlink\" href=\"#\u9006\u5411\u5de5\u7a0b\u76f8\u8fde\u5ea6\u548c-index-\u51fd\u6570\u7684-pc-\u8f93\u5165\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u662f\u6bd4\u8f83\u590d\u6742\u7684\u4e00\u6b65\uff0c\u540c\u65f6\u9006\u5411\u5de5\u7a0b\u8868\u7684\u76f8\u8fde\u5ea6\u548c index \u51fd\u6570\u7684 PC \u8f93\u5165\u3002\u8fd9\u662f\u56e0\u4e3a\u8fd9\u4e24\u90e8\u5206\u662f\u7d27\u5bc6\u8026\u5408\u7684\uff1a\u53ea\u6709\u77e5\u9053\u76f8\u8fde\u5ea6\uff0c\u624d\u80fd\u77e5\u9053\u9884\u6d4b\u51fa\u6765\u7684\u5206\u652f\u6570\u5bf9\u5e94\u51e0\u4e2a set\uff1b\u4f46\u4e0d\u77e5\u9053 index \u51fd\u6570\uff0c\u53c8\u65e0\u6cd5\u63a7\u5236\u5206\u652f\u88ab\u5206\u914d\u5230\u51e0\u4e2a set \u4e2d\u3002\u9996\u5148\uff0c\u4e3a\u4e86\u907f\u514d PHR \u7684\u5e72\u6270\uff0c\u8fd8\u662f\u53ea\u6ce8\u5165\u4e00\u4e2a\u968f\u673a\u6570\u5230 <span class=\"arithmatex\">\\(PHRT[99]\\)</span> \u4e0a\uff08\u4e8b\u5b9e\u4e0a\uff0c<span class=\"arithmatex\">\\(PHRT[99]\\)</span> \u4e0d\u662f\u968f\u4fbf\u9009\u62e9\u7684\uff0c\u800c\u662f\u9700\u8981\u5728 index \u51fd\u6570\u4e2d\uff0c\u4f46\u901a\u8fc7\u6d4b\u8bd5\u53ef\u4ee5\u627e\u5230\u6ee1\u8db3\u8981\u6c42\u7684\u4f4d\uff09\u3002\u5176\u6b21\uff0c\u6784\u9020\u4e00\u7cfb\u5217\u5206\u652f\uff0c\u5b83\u4eec\u7684\u5730\u5740\u6ee1\u8db3\uff1a\u7b2c i \u6761\u5206\u652f\uff08i \u4ece 0 \u5f00\u59cb\uff09\u7684\u5206\u652f\u5730\u5740\u662f <span class=\"arithmatex\">\\(i2^k\\)</span>\uff0c\u5176\u4e2d <span class=\"arithmatex\">\\(k\\)</span> \u662f\u63a5\u4e0b\u6765\u8981\u904d\u5386\u7684\u53c2\u6570\u3002\u5f53 <span class=\"arithmatex\">\\(k=3\\)</span> \u65f6\uff0c\u5206\u652f\u4f1a\u88ab\u653e\u5230 <code>0x0, 0x8, 0x10, 0x18, 0x20</code> \u7b49\u5730\u5740\uff0c\u6d89\u53ca\u7684 PC \u4f4d\u6570\u968f\u7740\u5206\u652f\u6570\u7684\u589e\u52a0\u800c\u589e\u52a0\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5206\u7c7b\u8ba8\u8bba\uff1a</p>\n<ul>\n<li>\u5047\u5982\u6d89\u53ca\u7684 PC \u4f4d\u90fd\u5728 tag \u4e2d\uff0c\u6ca1\u6709\u51fa\u73b0\u5728 index \u4e2d\uff1a\u90a3\u4e48\u8fd9\u4e9b\u5206\u652f\u90fd\u4f1a\u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a set \u5185\uff0c\u4e00\u65e6\u5206\u652f\u6570\u91cf\u8d85\u51fa\u76f8\u8fde\u5ea6\uff0c\u5c31\u4f1a\u51fa\u73b0\u9884\u6d4b\u9519\u8bef\u3002</li>\n<li>\u5047\u5982\u6d89\u53ca\u7684 PC \u4f4d\u6709\u4e00\u90e8\u5206\u51fa\u73b0\u5728 index \u4e2d\uff1a\u90a3\u4e48\u6bcf\u6709\u4e00\u4e2a PC \u4f4d\u51fa\u73b0\u5728 index \u4e2d\uff0c\u8fd9\u4e9b\u5206\u652f\u53ef\u4ee5\u88ab\u5206\u914d\u5230\u7684 set \u6570\u91cf\u5c31\u7ffb\u500d\uff0c\u76f4\u5230\u8fd9\u4e9b set \u90fd\u6ee1\u4e86\u4ee5\u540e\uff0c\u624d\u4f1a\u51fa\u73b0\u9884\u6d4b\u9519\u8bef\u3002</li>\n<li>\u5047\u5982\u6d89\u53ca\u7684 PC \u4f4d\u6709\u4e00\u90e8\u5206\u8d85\u51fa PC \u8f93\u5165\u7684\u8303\u56f4\uff08\u5982\u524d\u9762\u9006\u5411\u5de5\u7a0b\u5f97\u5230\u7684 <span class=\"arithmatex\">\\(PC[18:2]\\)</span>\uff09\uff1a\u90a3\u4e48\u8d85\u51fa\u8f93\u5165\u7684\u90e8\u5206\u5730\u5740\u4f1a\u88ab\u5ffd\u7565\uff0c\u4f7f\u5f97 set \u5185\u51fa\u73b0\u51b2\u7a81\u3002</li>\n</ul>\n<p><a href=\"https://github.com/jiegec/cpu-micro-benchmarks/blob/master/src/pht_associativity_gen.cpp\">\u5b9e\u9a8c</a>\u7ed3\u679c\u5982\u4e0b\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-assoc.png\" /></p>\n<p>\u7eb5\u5750\u6807\u5c31\u662f\u4e0a\u9762\u7684 <span class=\"arithmatex\">\\(k\\)</span>\uff0c\u6a2a\u5750\u6807\u662f\u6d4b\u8bd5\u7684\u6761\u4ef6\u5206\u652f\u6570\uff0c\u989c\u8272\u8868\u793a\u9884\u6d4b\u7684\u9519\u8bef\u7387\u3002\u5f53\u989c\u8272\u4ece\u6df1\u8272\u53d8\u6d45\uff0c\u5c31\u8bf4\u660e\u51fa\u73b0\u4e86\u9884\u6d4b\u9519\u8bef\u3002\u89c2\u5bdf\uff1a</p>\n<ul>\n<li><span class=\"arithmatex\">\\(PC[3]\\)</span> \u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u80fd\u9884\u6d4b 4 \u4e2a\u5206\u652f\uff0c\u800c <span class=\"arithmatex\">\\(PC[4]\\)</span> \u6216 <span class=\"arithmatex\">\\(PC[5]\\)</span> \u53ef\u4ee5\u9884\u6d4b 8 \u4e2a\u5206\u652f\uff0c\u6697\u793a\u4e86\u56db\u8def\u7ec4\u76f8\u8fde\uff0c\u7136\u540e <span class=\"arithmatex\">\\(PC[4]\\)</span> \u548c <span class=\"arithmatex\">\\(PC[5]\\)</span> \u5bf9\u5e94\u5230\u4e86\u4e24\u4e2a set\uff0c\u6240\u4ee5\u80fd\u591f\u6b63\u786e\u9884\u6d4b 8 \u4e2a\u5206\u652f\u3002</li>\n<li><span class=\"arithmatex\">\\(PC[6]\\)</span> \u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u9884\u6d4b 16 \u4e2a\u5206\u652f\uff0c\u5bf9\u5e94 4 \u4e2a set\uff1b\u540e\u7eed <span class=\"arithmatex\">\\(PC[7]\\)</span> \u548c <span class=\"arithmatex\">\\(PC[8]\\)</span> \u53c8\u53ef\u4ee5\u9884\u6d4b 8 \u4e2a\u5206\u652f\uff0c\u5bf9\u5e94 2 \u4e2a set\uff1b\u610f\u5473\u7740 <span class=\"arithmatex\">\\(PC[6]\\)</span> \u5728 index \u4e2d\uff0c\u7ed9 <span class=\"arithmatex\">\\(PC[4]\\)</span> \u548c <span class=\"arithmatex\">\\(PC[5]\\)</span> \u63d0\u4f9b\u4e86\u4e24\u500d\u7684 set\uff1b<span class=\"arithmatex\">\\(PC[9]\\)</span> \u5728 index \u4e2d\uff0c\u7ed9 <span class=\"arithmatex\">\\(PC[6]\\)</span>\u3001<span class=\"arithmatex\">\\(PC[7]\\)</span> \u548c <span class=\"arithmatex\">\\(PC[8]\\)</span> \u63d0\u4f9b\u4e86\u4e24\u500d\u7684 set\u3002</li>\n<li>\u540e\u7eed\u66f4\u9ad8\u7684 PC \u4f4d\uff0c\u6ca1\u6709\u53d7\u5230 index \u51fd\u6570\u7684\u5f71\u54cd\uff0c\u56e0\u6b64\u90fd\u662f 4\uff0c\u76f4\u5230\u6700\u540e\u8d85\u51fa PC \u8f93\u5165\u8303\u56f4\u3002</li>\n</ul>\n<p>\u8fd9\u5c31\u8bf4\u660e\u5b83\u662f\u56db\u8def\u7ec4\u76f8\u8fde\uff0cPC[6] \u548c PC[9] \u53c2\u4e0e\u5230\u4e86 index \u51fd\u6570\u4e2d\u3002</p>\n<p>\u4e0b\u9762\u7ed9\u8bfb\u8005\u4e00\u4e2a\u5c0f\u7ec3\u4e60\uff0c\u4e0b\u9762\u662f\u5728 Qualcomm Oryon \u4e0a\u6d4b\u5f97\u7684\u7ed3\u679c\uff0c\u53ef\u4ee5\u770b\u5230\u566a\u58f0\u6bd4\u8f83\u5927\uff0c\u4f60\u80fd\u63a8\u65ad\u51fa\u5b83\u662f\u51e0\u8def\u7ec4\u76f8\u8fde\uff0c\u6709\u54ea\u4e9b PC \u53c2\u4e0e\u5230\u4e86 index \u8ba1\u7b97\u5417\uff1f</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-assoc-oryon.png\" /></p>\n<details class=\"question\">\n<summary>\u63ed\u6653\u7b54\u6848</summary>\n<p>\u56db\u8def\u7ec4\u76f8\u8fde\uff0c<span class=\"arithmatex\">\\(PC[6]\\)</span> \u548c <span class=\"arithmatex\">\\(PC[7]\\)</span> \u53c2\u4e0e\u5230\u4e86 index \u51fd\u6570\u3002</p>\n</details>\n<p>\u90a3\u4e48\uff0c\u8fd9\u79cd\u6d4b\u8bd5\u662f\u600e\u4e48\u6784\u9020\u7684\u5462\uff1f\u5373\u9700\u8981\u7528\u76f8\u540c\u7684 PHR \u53bb\u9884\u6d4b <span class=\"arithmatex\">\\(PC=i2^k\\)</span> \u7684\u591a\u6761\u5206\u652f\u3002\u601d\u8def\u6bd4\u8f83\u590d\u6742\uff1a</p>\n<ol>\n<li>\u9996\u5148\u6267\u884c\u4e00\u6761\u95f4\u63a5\u5206\u652f\uff0c\u76ee\u7684\u5730\u5740\u662f <span class=\"arithmatex\">\\(i2^{k-1}\\)</span>\uff0c\u90a3\u4e48\u5b83\u5bf9 PHRT \u7684\u8d21\u732e\u662f <span class=\"arithmatex\">\\(\\mathrm{PHRT}_1 = (\\mathrm{PHRT}_0 \\ll 1) \\oplus (i2^{k-3})\\)</span>\uff1b</li>\n<li>\u63a5\u4e0b\u6765\uff0c\u5728 <span class=\"arithmatex\">\\(i2^{k-1}\\)</span> \u7684\u4f4d\u7f6e\uff0c\u518d\u6267\u884c\u4e00\u6761\u76f4\u63a5\u5206\u652f\uff0c\u76ee\u7684\u5730\u5740\u662f <span class=\"arithmatex\">\\(i2^k\\)</span>\uff0c\u90a3\u4e48\u5b83\u5bf9 PHRT \u7684\u8d21\u732e\u662f <span class=\"arithmatex\">\\(\\mathrm{PHRT}_2 = (\\mathrm{PHRT}_1 \\ll 1) \\oplus (i2^{k-2}) = (((\\mathrm{PHRT}_0 \\ll 1) \\oplus (i2^{k-3})) \\ll 1) \\oplus (i2^{k-2}) = \\mathrm{PHRT}_0 \\ll 2\\)</span>\u3002</li>\n</ol>\n<p>\u53ef\u89c1\u7ecf\u8fc7\u4e24\u6b65\u4ee5\u540e\uff0cPHRT \u662f\u4fdd\u6301\u4e0d\u53d8\u7684\u3002\u9488\u5bf9 PHRB\uff0c\u53ea\u8981 <span class=\"arithmatex\">\\(i2^{k-1}\\)</span> \u6ca1\u6709\u6d89\u53ca <span class=\"arithmatex\">\\(PC[5:2]\\)</span>\uff0c\u5c31\u80fd\u4fdd\u8bc1\u76f8\u540c\u3002\u90a3\u4e48\u5982\u679c <span class=\"arithmatex\">\\(k\\)</span> \u8db3\u591f\u5c0f\uff0c\u4e5f\u6709\u529e\u6cd5\uff1a</p>\n<ol>\n<li>\u9996\u5148\u6267\u884c\u4e00\u6761\u95f4\u63a5\u5206\u652f\uff0c\u76ee\u7684\u5730\u5740\u662f <span class=\"arithmatex\">\\(i2^{k-1}\\)</span>\uff1b</li>\n<li>\u63a5\u4e0b\u6765\u6267\u884c\u5927\u91cf\u7684 NOP\uff0c\u4f7f\u5f97 <span class=\"arithmatex\">\\(B\\)</span> \u7684\u4f4e\u4f4d\u7b49\u4e8e 0\uff0c\u7136\u540e\u518d\u6267\u884c\u4e00\u6761\u95f4\u63a5\u5206\u652f\uff0c\u76ee\u7684\u5730\u5740\u662f <span class=\"arithmatex\">\\(i2^k\\)</span>\u3002</li>\n</ol>\n<p>\u56e0\u6b64\u6211\u4eec\u603b\u662f\u53ef\u4ee5\u901a\u8fc7\u4e24\u6b21\u5206\u652f\uff0c\u5b9e\u73b0\u7528\u76f8\u540c\u7684 PHR \u9884\u6d4b\u4e0d\u540c PC \u4e0a\u7684\u591a\u6761\u5206\u652f\u3002</p>\n<h3 id=\"\u9006\u5411\u5de5\u7a0b-tag-\u51fd\u6570\">\u9006\u5411\u5de5\u7a0b tag \u51fd\u6570<a class=\"headerlink\" href=\"#\u9006\u5411\u5de5\u7a0b-tag-\u51fd\u6570\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u8fdb\u884c tag \u51fd\u6570\u7684\u9006\u5411\u5de5\u7a0b\u3002\u4e3a\u4e86\u9006\u5411\u5de5\u7a0b tag \u51fd\u6570\uff0c\u6211\u4eec\u5e0c\u671b\u627e\u5230\u4e24\u4e2a\u4f4d\u5728 tag \u51fd\u6570\u4e2d\u6709\u5f02\u6216\u5173\u7cfb\uff0c\u90a3\u4e48\u5982\u679c\u8fd9\u4e24\u4e2a\u4f4d\u540c\u65f6\u8bbe\u4e3a 0\uff0c\u6216\u8005\u540c\u65f6\u8bbe\u4e3a 1\uff0c\u5176\u5f02\u6216\u7ed3\u679c\u90fd\u7b49\u4e8e 0\uff0c\u4f7f\u5f97\u8ba1\u7b97\u51fa\u6765\u7684 tag \u51fd\u6570\u76f8\u540c\uff0c\u5982\u679c\u6b64\u65f6 index \u8fd8\u76f8\u540c\uff0c\u90a3\u4e48\u9884\u6d4b\u5668\u5c31\u65e0\u6cd5\u533a\u5206\u8fd9\u4e24\u79cd\u60c5\u51b5\u3002</p>\n<p>\u4e3a\u4e86\u5229\u7528\u8fd9\u4e00\u70b9\uff0c\u751f\u6210\u4e24\u4e2a 0 \u5230 1 \u7684\u968f\u673a\u6570 <span class=\"arithmatex\">\\(k\\)</span> \u548c <span class=\"arithmatex\">\\(l\\)</span>\uff0c\u5206\u522b\u628a\u5b83\u4eec\u6ce8\u5165\u5230 PC\u3001PHRB \u6216\u8005 PHRT \u4e2d\uff0c\u53bb\u9884\u6d4b\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\uff0c\u5176\u8df3\u8f6c\u4e0e\u5426\u53d6\u51b3\u4e8e <span class=\"arithmatex\">\\(k\\)</span> \u7684\u503c\uff08\u8bba\u6587\u4e2d\u6709\u4e2a\u5c0f typo\uff09\u3002\u5982\u679c <span class=\"arithmatex\">\\(k\\)</span> \u548c <span class=\"arithmatex\">\\(l\\)</span> \u5728 tag \u51fd\u6570\u4e2d\u6709\u5f02\u6216\u5173\u7cfb\uff0c\u90a3\u4e48\u9884\u6d4b\u5668\u603b\u4f1a\u9884\u6d4b\u9519\u8bef\u3002</p>\n<p>\u5b9e\u9a8c\u7ed3\u679c\u5927\u81f4\u5982\u4e0b\uff0c\u6a2a\u7eb5\u5750\u6807\u8868\u793a\u6ce8\u5165\u54ea\u4e00\u4e2a\u4f4d\uff0c\u989c\u8272\u4ee3\u8868\u9884\u6d4b\u9519\u8bef\u7387\uff0c\u6df1\u8272\u610f\u5473\u7740\u9884\u6d4b\u9519\u8bef\uff0c\u4e5f\u5c31\u662f\u627e\u5230\u4e86\u4e00\u7ec4\u5f02\u6216\u5173\u7cfb\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-assoc-tag-pc-phr.png\" /></p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-assoc-tag-phr-phr.png\" /></p>\n<p>\u5176\u4e2d\u6709\u4e00\u4e9b\u5f02\u6216\u5173\u7cfb\uff0c\u56e0\u4e3a\u5bf9\u5e94\u7684\u4f4d\u5728 index \u4e2d\u51fa\u73b0\u7684\u7f18\u6545\uff0c\u5bfc\u81f4\u6ca1\u6709\u663e\u73b0\u51fa\u6765\u3002\u6839\u636e\u5df2\u77e5\u7684\u5f02\u6216\u5173\u7cfb\u5916\u63a8\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7684 tag \u8ba1\u7b97\u516c\u5f0f\uff1a</p>\n<ul>\n<li>PC[7] xor PHRT[0,12,...,96] xor PHRB[8,21]</li>\n<li>PC[8] xor PHRT[1,13,...,97] xor PHRB[9,22]</li>\n<li>PC[9] xor PHRT[2,14,...,98] xor PHRB[10,23,24]</li>\n<li>PC[10] xor PHRT[3,15,...,87,99] xor PHRB[11,12,25]</li>\n<li>PC[11] xor PHRT[4,16,...,88] xor PHRB[0,13,26]</li>\n<li>PC[12] xor PHRT[5,17,...,89] xor PHRB[1,14,27]</li>\n<li>PC[13] xor PHRT[6,18,...,90] xor PHRB[2,15]</li>\n<li>PC[14] xor PHRT[7,19,...,91] xor PHRB[3,16]</li>\n<li>PC[15] xor PHRT[8,20,...,92] xor PHRB[4,17]</li>\n<li>PC[16] xor PHRT[9,21,...,93] xor PHRB[5,18]</li>\n<li>PC[17] xor PHRT[10,22,...,94] xor PHRB[6,19]</li>\n<li>PC[18] xor PHRT[11,23,...,95] xor PHRB[7,20]</li>\n<li>PC[2:5]: \u5355\u72ec\u51fa\u73b0\uff0c\u4e0d\u548c\u5176\u4ed6\u4f4d\u5f02\u6216</li>\n</ul>\n<p>\u90a3\u4e48\uff0c\u8fd9\u91cc\u662f\u600e\u4e48\u5b9e\u73b0\u9488\u5bf9 PC\u3001PHRT \u548c PHRB \u7684\u6ce8\u5165\u7684\u5462\uff1f\u9488\u5bf9 PHRT \u7684\u6ce8\u5165\u524d\u9762\u5df2\u7ecf\u63d0\u5230\u8fc7\uff0c\u53ea\u9700\u8981\u4e00\u4e2a\u95f4\u63a5\u5206\u652f\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"c1\">// target differs in T[2]</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">target0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target1</span><span class=\"p\">};</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"p\">[</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"nl\">target0</span><span class=\"p\">:</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"c1\">// add nop</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"nl\">target1</span><span class=\"p\">:</span>\n</span></code></pre></div>\n<p>PHRB \u7684\u6ce8\u5165\u5c31\u6bd4\u8f83\u590d\u6742\u4e86\uff0c\u4f8b\u5982\u8981\u6ce8\u5165 <span class=\"arithmatex\">\\(B[2]=k\\)</span>\uff0c\u6211\u4eec\u9700\u8981\u8fdb\u884c\u4e09\u6b21\u5206\u652f\u7684\u8df3\u8f6c\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B\\)</span> \u76f8\u540c\uff0c<span class=\"arithmatex\">\\(T[2]=k\\)</span>\uff1b</li>\n<li>\u7b2c\u4e8c\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B[2]=k\\)</span>\uff0c<span class=\"arithmatex\">\\(T[3]=k\\)</span>\uff1b</li>\n<li>\u7b2c\u4e09\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B[2]=B[3]=k\\)</span>, <span class=\"arithmatex\">\\(T\\)</span> \u76f8\u540c\u3002</li>\n</ol>\n<p>\u7ecf\u8fc7\u8ba1\u7b97\uff0c\u53ef\u4ee5\u53d1\u73b0\u524d\u4e24\u6b21\u8df3\u8f6c\u5bf9 PHRT \u7684\u62b5\u6d88\uff0c\u7b2c\u4e8c\u6b21\u8df3\u8f6c\u7684 <span class=\"arithmatex\">\\(B[2]\\)</span> \u4e0e\u7b2c\u4e09\u6b21\u8df3\u8f6c\u7684 <span class=\"arithmatex\">\\(B[3]\\)</span> \u62b5\u6d88\uff0c\u6700\u540e\u76f8\u5f53\u4e8e\u53ea\u6709\u6700\u540e\u4e00\u6b21\u8df3\u8f6c\u7684 <span class=\"arithmatex\">\\(B[2]=k\\)</span> \u5bf9 PHRB \u4ea7\u751f\u4e86\u8d21\u732e\u3002</p>\n<p>\u6700\u590d\u6742\u7684\u662f PC \u7684\u6ce8\u5165\uff0c\u8fd9\u6b21\u9700\u8981\u5206\u60c5\u51b5\u8ba8\u8bba\uff1a</p>\n<p>\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u8981\u6ce8\u5165\u7684 PC \u4f4d\u6bd4\u8f83\u9ad8\uff0c\u5177\u4f53\u6765\u8bf4\uff0c\u662f <span class=\"arithmatex\">\\(PC[7]\\)</span> \u6216\u8005\u66f4\u9ad8\u7684\u4f4d\u6570\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u907f\u514d\u5f15\u5165\u5bf9 PHRB \u7684\u8d21\u732e\uff0c\u56e0\u4e3a\u5b83\u53ea\u8003\u8651 <span class=\"arithmatex\">\\(B[5:2]\\)</span>\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B\\)</span> \u76f8\u540c\uff0c<span class=\"arithmatex\">\\(T[6]=k\\)</span>\uff1b</li>\n<li>\u7b2c\u4e8c\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B[6]=k\\)</span> \u4f46\u5bf9 PHRB \u6ca1\u6709\u8d21\u732e\uff0c<span class=\"arithmatex\">\\(T[7]=k\\)</span>\u3002</li>\n</ol>\n<p>\u90a3\u4e48\u4e24\u6b21\u8df3\u8f6c\u5b8c\u4ee5\u540e\uff0cPHRB \u4e0d\u53d8\uff0cPHRT \u7684\u8d21\u732e\u88ab\u62b5\u6d88\u6389\uff0c\u540c\u65f6\u5b9e\u73b0\u4e86 <span class=\"arithmatex\">\\(PC[7]=k\\)</span> \u7684\u6ce8\u5165\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u8981\u6ce8\u5165\u7684\u6b63\u597d\u662f <span class=\"arithmatex\">\\(PC[6]\\)</span>\uff0c\u7ee7\u7eed\u7528\u4e0a\u9762\u7684\u65b9\u6cd5\u4f1a\u53d1\u73b0 PHRB \u65e0\u6cd5\u62b5\u6d88\uff0c\u8fd9\u65f6\u5019\uff0c\u9700\u8981\u5f15\u5165\u7b2c\u4e09\u6b21\u8df3\u8f6c\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B\\)</span> \u76f8\u540c\uff0c<span class=\"arithmatex\">\\(T[3]=k\\)</span>\uff1b </li>\n<li>\u7b2c\u4e8c\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B[3]=k\\)</span>\uff0c<span class=\"arithmatex\">\\(T[5]=T[4]=k\\)</span>\uff1b</li>\n<li>\u7b2c\u4e09\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B[4]=k\\)</span>\uff0c<span class=\"arithmatex\">\\(T[6]=k\\)</span>\u3002</li>\n</ol>\n<p>\u9a8c\u7b97\u53ef\u4ee5\u53d1\u73b0\uff0cPHRB \u548c PHRT \u7684\u8d21\u732e\u5168\u90fd\u88ab\u62b5\u6d88\uff0c\u6210\u529f\u6ce8\u5165 <span class=\"arithmatex\">\\(PC[6]=k\\)</span>\u3002</p>\n<p>\u6700\u540e\u6765\u770b\u8981\u6ce8\u5165\u7684 PC \u66f4\u4f4e\u7684\u60c5\u51b5\uff0c\u4f8b\u5982\u8981\u6ce8\u5165 <span class=\"arithmatex\">\\(PC[3]=k\\)</span>\uff0c\u8fd8\u662f\u7528\u4e09\u6b21\u8df3\u8f6c\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B\\)</span> \u76f8\u540c\uff0c<span class=\"arithmatex\">\\(T[2]=k\\)</span>\uff1b </li>\n<li>\u7b2c\u4e8c\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B[2]=k\\)</span>\uff0c<span class=\"arithmatex\">\\(T[2]=T[3]=k\\)</span>\uff1b</li>\n<li>\u7b2c\u4e09\u6b21\u8df3\u8f6c\uff0c<span class=\"arithmatex\">\\(B[3]=k\\)</span>\uff0c<span class=\"arithmatex\">\\(T[3]=k\\)</span>\u3002</li>\n</ol>\n<p>\u8fd9\u6837\u5c31\u6210\u529f\u6ce8\u5165 <span class=\"arithmatex\">\\(PC[3]=k\\)</span>\u3002</p>\n<p>\u90a3\u4e48 PC \u7684\u6ce8\u5165\u5c31\u5b8c\u6210\u4e86\uff0c\u53ea\u6709 <span class=\"arithmatex\">\\(PC[2]\\)</span> \u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u65b9\u6cd5\u6765\u6ce8\u5165\u3002</p>\n<h3 id=\"\u9006\u5411\u5de5\u7a0b-index-\u51fd\u6570\">\u9006\u5411\u5de5\u7a0b index \u51fd\u6570<a class=\"headerlink\" href=\"#\u9006\u5411\u5de5\u7a0b-index-\u51fd\u6570\" title=\"Permanent link\">&para;</a></h3>\n<p>\u76f8\u8fde\u5ea6\u548c tag \u51fd\u6570\u5df2\u77e5\uff0c\u63a5\u4e0b\u6765\uff0c\u8ba9\u6211\u4eec\u9006\u5411\u5de5\u7a0b\u6700\u540e\u7684 index \u51fd\u6570\u3002\u9006\u5411\u5de5\u7a0b\u7684\u601d\u8def\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u901a\u8fc7\u524d\u9762\u7684\u9006\u5411\u5de5\u7a0b\uff0c\u53d1\u73b0 <span class=\"arithmatex\">\\(PC[5:2]\\)</span> \u662f\u72ec\u7acb\u51fa\u73b0\u5728 tag \u51fd\u6570\u4e2d\uff0c\u5e76\u4e14\u6ca1\u6709\u51fa\u73b0\u5728 index \u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u6784\u9020\u51fa\u591a\u4e2a\u5206\u652f\uff0c\u5b83\u4eec\u7684 tag \u4e0d\u540c\uff1b</li>\n<li>\u8fdb\u4e00\u6b65\uff0c\u6784\u9020\u4e24\u7ec4\u6761\u4ef6\u5206\u652f\uff0c\u6bcf\u7ec4\u90fd\u6709\u56db\u4e2a\u6761\u4ef6\u5206\u652f\uff0c\u56e0\u4e3a\u662f\u56db\u8def\u7ec4\u76f8\u8fde\uff0c\u5982\u679c\u8fd9\u4e24\u7ec4\u5206\u522b\u6620\u5c04\u5230\u4e24\u4e2a set \u4e2d\uff0c\u5c31\u53ef\u4ee5\u6b63\u786e\u9884\u6d4b\uff1b\u53cd\u4e4b\uff0c\u5982\u679c\u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a set \u4e2d\uff0c\u5c31\u4f1a\u9884\u6d4b\u9519\u8bef\uff1b</li>\n<li>\u548c\u4e4b\u524d\u7c7b\u4f3c\uff0c\u5411 PC\u3001PHRB \u6216 PHRT \u6ce8\u5165\u4e24\u4e2a\u968f\u673a\u6570 <span class=\"arithmatex\">\\(k\\)</span> \u548c <span class=\"arithmatex\">\\(l\\)</span>\uff0c\u7136\u540e\u9884\u6d4b\u4e24\u7ec4\u5171\u516b\u4e2a\u6761\u4ef6\u5206\u652f\uff0c\u8fd9\u4e9b\u6761\u4ef6\u5206\u652f\u7684\u8df3\u8f6c\u65b9\u5411\u90fd\u662f <code>k xor l</code>\uff1b</li>\n<li>\u5982\u679c <span class=\"arithmatex\">\\(k\\)</span> \u548c <span class=\"arithmatex\">\\(l\\)</span> \u6ce8\u5165\u7684\u4f4d\u540c\u65f6\u51fa\u73b0\u5728 index \u51fd\u6570\u4e2d\uff0c\u4f46\u662f\u6ca1\u6709\u5f02\u6216\u5173\u7cfb\uff0c\u90a3\u4e48\u8fd9\u516b\u4e2a\u6761\u4ef6\u5206\u652f\u53ef\u4ee5\u6b63\u786e\u5730\u88ab\u9884\u6d4b\uff1b</li>\n<li>\u5982\u679c <span class=\"arithmatex\">\\(k\\)</span> \u548c <span class=\"arithmatex\">\\(l\\)</span> \u6ce8\u5165\u7684\u4f4d\u540c\u65f6\u51fa\u73b0\u5728 index \u51fd\u6570\u4e2d\uff0c\u5e76\u4e14\u6709\u5f02\u6216\u5173\u7cfb\uff0c\u90a3\u4e48\u8fd9\u516b\u4e2a\u6761\u4ef6\u5206\u652f\u4f1a\u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a set \u5185\uff0c\u6700\u591a\u53ea\u80fd\u6b63\u786e\u9884\u6d4b\u5176\u4e2d\u56db\u4e2a\u5206\u652f\uff1b</li>\n<li>\u5982\u679c <span class=\"arithmatex\">\\(k\\)</span> \u548c <span class=\"arithmatex\">\\(l\\)</span> \u6ce8\u5165\u7684\u4f4d\u81f3\u5c11\u51fa\u73b0\u4e00\u4e2a\u5728 tag \u51fd\u6570\u4e2d\uff0c\u90a3\u4e48\u4e00\u4e2a\u5206\u652f\u4f1a\u5728\u540c\u4e00\u4e2a set \u5185\u5360\u7528\u4e24\u9879\uff0c\u5bfc\u81f4\u6700\u591a\u53ea\u80fd\u6b63\u786e\u9884\u6d4b\u5176\u4e2d\u4e24\u4e2a\u5206\u652f\u3002</li>\n</ol>\n<p>\u6ce8\u5165 <span class=\"arithmatex\">\\(PC[9]\\)</span> \u548c <span class=\"arithmatex\">\\(PHRT[i]\\)</span> \u7684<a href=\"https://github.com/jiegec/cpu-micro-benchmarks/blob/master/src/pht_index_bits_xor.cpp\">\u5b9e\u9a8c</a>\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-reverse-engineer-index.png\" /></p>\n<p>\u7ed3\u5408\u4e0a\u9762\u7684\u8ba8\u8bba\uff0c\u53ef\u4ee5\u77e5\u9053\uff1a</p>\n<ul>\n<li>PC[9] \u548c PHRT[38] \u548c PHRT[88] \u6709\u5f02\u6216\u5173\u7cfb</li>\n<li>PHRT[2]\u3001PHRT[12]\u3001PHRT[17]\u3001PHRT[22]\u3001PHRT[27]\u3001PHRT[33]\u3001PHRT[43]\u3001PHRT[53]\u3001PHRT[58]\u3001PHRT[63]\u3001PHRT[68]\u3001PHRT[73]\u3001PHRT[78]\u3001PHRT[83]\u3001PHRT[93] \u5728 index \u4e2d\uff0c\u4f46\u662f\u548c PC[9] \u6ca1\u6709\u5f02\u6216\u5173\u7cfb</li>\n</ul>\n<p>\u5b9e\u9645\u4e0a\u8fd8\u6709 PHRT[7] \u548c PHRT[48] \u4e5f\u5728 index \u4e2d\uff0c\u4f46\u5b9e\u9645\u4e0a\u6d4b\u8bd5\u7684\u65f6\u5019\u4e3a\u4e86\u4fdd\u8bc1\u5386\u53f2\u6700\u957f\u7684\u8868\u63d0\u4f9b\u9884\u6d4b\uff0c\u8fd8\u989d\u5916\u6ce8\u5165\u4e86 PHRT[99]\uff0c\u5b83\u4e0e PHRT[7] \u548c PHRT[48] \u6709\u5f02\u6216\u5173\u7cfb\uff0c\u6240\u4ee5\u5728\u4e0a\u56fe\u6ca1\u6709\u663e\u73b0\u51fa\u6765\u3002</p>\n<p>\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\uff0c\u53bb\u6d4b\u8bd5 PHRT \u4e0e PHRT\u3001PHRT \u4e0e PHRB\u3001PHRB \u4e0e PHRB \u4e4b\u95f4\u7684\u5f02\u6216\u5173\u7cfb\uff0c\u5c31\u53ef\u4ee5\u627e\u5230\u6700\u7ec8\u7684 index \u51fd\u6570\uff1a</p>\n<ul>\n<li>PHRT[2] xor PHRT[43] xor PHRT[93]</li>\n<li>PHRT[7] xor PHRT[48] xor PHRT[99]</li>\n<li>PHRT[12] xor PHRT[63] xor PHRB[5]</li>\n<li>PHRT[17] xor PHRT[68] xor PHRB[10]</li>\n<li>PHRT[22] xor PHRT[73] xor PHRB[15]</li>\n<li>PHRT[27] xor PHRT[78] xor PHRB[20]</li>\n<li>PHRT[33] xor PHRT[83] xor PHRB[25]</li>\n<li>PHRT[38] xor PHRT[88] xor PC[9]</li>\n<li>PHRT[53] xor PHRT[58] xor PHRB[0]</li>\n<li>PC[6]</li>\n</ul>\n<p>\u81f3\u6b64\u4f7f\u7528\u5206\u652f\u5386\u53f2\u6700\u957f\u7684\u8868\u7684\u9006\u5411\u5c31\u5b8c\u6210\u4e86\u3002\u63a5\u4e0b\u6765\u8ba8\u8bba\u4e00\u4e0b\uff0c\u5982\u4f55\u9006\u5411\u5de5\u7a0b\u5206\u652f\u5386\u53f2\u66f4\u77ed\u7684\u8868\u3002</p>\n<h3 id=\"\u9006\u5411\u5de5\u7a0b\u4f7f\u7528\u5206\u652f\u5386\u53f2\u66f4\u77ed\u7684-tage-\u8868\">\u9006\u5411\u5de5\u7a0b\u4f7f\u7528\u5206\u652f\u5386\u53f2\u66f4\u77ed\u7684 TAGE \u8868<a class=\"headerlink\" href=\"#\u9006\u5411\u5de5\u7a0b\u4f7f\u7528\u5206\u652f\u5386\u53f2\u66f4\u77ed\u7684-tage-\u8868\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u63d0\u5230\uff0cTAGE \u5728\u9884\u6d4b\u65f6\uff0c\u4f1a\u9009\u53d6\u63d0\u4f9b\u9884\u6d4b\u7684\u591a\u4e2a\u8868\u4e2d\u4f7f\u7528\u5386\u53f2\u6700\u957f\u7684\u90a3\u4e2a\u8868\u3002\u90a3\u4e48\uff0c\u5982\u679c\u8981\u6d4b\u8bd5\u4f7f\u7528\u5386\u53f2\u7b2c\u4e8c\u957f\u7684\u8868\uff0c\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f\u6211\u4eec\u5c1d\u8bd5\u4e86\u4ee5\u4e0b\u65b9\u6cd5\uff1a</p>\n<ul>\n<li>\u5728\u4f7f\u7528\u5386\u53f2\u66f4\u957f\u7684\u8868\u91cc\uff0c\u9884\u5148\u63d2\u5165\u4e00\u4e9b\u8868\u9879\uff0c\u518d\u53bb\u6d4b\u8bd5\u5386\u53f2\u8f83\u77ed\u7684\u8868\u7684\u60c5\u51b5\uff0c\u7531\u4e8e TAGE \u4f1a\u5229\u7528\u5b83\u7684 useful \u8ba1\u6570\u5668\u6765\u8fdb\u884c\u65b0\u8868\u9879\u7684\u5206\u914d\uff0c\u5f53\u5386\u53f2\u66f4\u957f\u7684\u8868\u91cc\u7684\u8868\u9879\u7684 useful \u4e0d\u4e3a\u96f6\uff0c\u53ef\u4ee5\u9632\u6b62\u5b83\u88ab\u8986\u76d6\u6210\u65b0\u7684\u5185\u5bb9\uff0c\u903c\u8feb TAGE \u7528\u5386\u53f2\u66f4\u77ed\u7684\u8868\u6765\u8fdb\u884c\u9884\u6d4b\uff1b</li>\n<li>\u628a\u591a\u4e2a\u8868\u5f53\u6210\u4e00\u4e2a\u6574\u4f53\u6765\u8003\u8651\uff0c\u6bd4\u5982\u5728\u6d4b\u8bd5\u80fd\u591f\u6b63\u5e38\u9884\u6d4b\u7684\u5206\u652f\u6570\u91cf\u7684\u65f6\u5019\uff0c\u5f97\u5230\u7684\u662f\u591a\u4e2a\u8868\u53e0\u52a0\u7684\u7ed3\u679c\uff0c\u518d\u51cf\u53bb\u5df2\u77e5\u6570\u91cf\uff0c\u53ef\u4ee5\u5f97\u5230\u5386\u53f2\u6bd4\u8f83\u77ed\u7684\u8868\u7684\u4fe1\u606f\uff1b</li>\n<li>\u5728\u8d85\u51fa\u8981\u6d4b\u8bd5\u7684\u8868\u7684\u5386\u53f2\u90e8\u5206\uff0c\u6ce8\u5165\u5927\u91cf\u968f\u673a\u6570\uff0c\u4f8b\u5982\u8981\u6d4b\u8bd5\u7684\u4e00\u4e2a\u8868\uff0c\u53ea\u7528\u5230\u4e86\u5386\u53f2\u7684\u4f4e 57 \u4f4d\uff0c\u90a3\u5c31\u5728\u66f4\u9ad8\u7684\u90e8\u5206\u6ce8\u5165\u5927\u91cf\u7684\u968f\u673a\u6570\uff0c\u90a3\u4e48\u5386\u53f2\u6700\u957f\u7684\u8868\u80fd\u591f\u63d0\u4f9b\u9884\u6d4b\u7684\u6982\u7387\u4f1a\u975e\u5e38\u5c0f\uff0c\u4ece\u800c\u903c\u8feb TAGE \u7528\u5f53\u524d\u88ab\u6d4b\u8bd5\u7684\u8868\u6765\u505a\u9884\u6d4b\u3002</li>\n</ul>\n<p>\u901a\u8fc7\u8fd9\u4e9b\u65b9\u6cd5\uff0c\u6211\u4eec\u6210\u529f\u5730\u9006\u5411\u51fa\u4e86 Firestorm \u7684\u5269\u4e0b\u7684 TAGE \u8868\u7684\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://github.com/jiegec/cpu-micro-benchmarks/blob/master/reports/dissecting_cbp_of_apple_firestorm_and_qualcomm_oryon/README.md\">\u5b8c\u6574\u7ed3\u679c</a></li>\n<li><a href=\"https://github.com/jiegec/cpu-micro-benchmarks/\">\u4ee3\u7801\u5f00\u6e90</a></li>\n</ul>\n<p>\u6709\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u8bd5\u7740\u81ea\u5df1\u590d\u73b0\u4e00\u4e0b\uff0c\u770b\u770b\u80fd\u4e0d\u80fd\u5f97\u5230\u5bf9\u5e94\u7684\u5b9e\u9a8c\u7ed3\u679c\uff0c\u7136\u540e\u4ece\u7ed3\u679c\u4e2d\u5206\u6790\u51fa\u786c\u4ef6\u7684\u53c2\u6570\u3002\u6709\u610f\u601d\u7684\u662f\uff0c\u6211\u4eec\u9006\u5411\u51fa\u6765 Qualcomm Oryon \u7684\u5206\u652f\u9884\u6d4b\u5668\u7684\u5927\u5c0f\uff086 \u4e2a\u8868\u4e00\u5171 80KB \u7684\u7a7a\u95f4\uff09\uff0c\u4e0e\u5b98\u65b9\u5728 Hot Chips \u4e0a\u516c\u5f00\u7684\u662f\u4e00\u81f4\u7684\u3002</p>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6211\u4eec\u901a\u8fc7\u4e00\u7cfb\u5217\u65b9\u6cd5\uff0c\u5b9e\u73b0\u4e86\u5bf9 Apple M1 Firestorm \u7684\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u9006\u5411\uff0c\u5e76\u4e14\u6210\u529f\u5730\u628a\u5b83\u5e94\u7528\u5230\u4e86\u8bbe\u8ba1\u57fa\u672c\u4e00\u6837\u7684 Qualcomm Oryon \u5904\u7406\u5668\u4e0a\uff0c\u4e3a\u540e\u7eed\u7684\u7814\u7a76\u63d0\u4f9b\u4e86\u57fa\u7840\u3002</p>\n<h2 id=\"\u5f15\u7528\u6587\u732e\">\u5f15\u7528\u6587\u732e<a class=\"headerlink\" href=\"#\u5f15\u7528\u6587\u732e\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://arxiv.org/abs/2411.13900\">Dissecting Conditional Branch Predictors of Apple Firestorm and Qualcomm Oryon for Software Optimization and Architectural Analysis</a></li>\n<li><a href=\"https://cseweb.ucsd.edu/~tullsen/halfandhalf.pdf\">Half&amp;Half: Demystifying Intel\u2019s Directional Branch Predictors for Fast, Secure Partitioned Execution</a></li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/cbp-reverse-engineer.png", "date_modified": "2025-10-28T00:00:00+00:00", "date_published": "2025-10-28T00:00:00+00:00", "authors": [], "tags": ["apple", "cbp", "cpu", "firestorm", "hardware", "m1", "re"]}, {"id": "https://jia.je/software/2025/10/09/blog-analytics-three-months/", "url": "https://jia.je/software/2025/10/09/blog-analytics-three-months/", "title": "\u672c\u535a\u5ba2\u8fd1\u4e09\u4e2a\u6708\u6765\u7684\u8bbf\u95ee\u6570\u636e\u89c2\u5bdf", "content_html": "<h1 id=\"\u672c\u535a\u5ba2\u8fd1\u4e09\u4e2a\u6708\u6765\u7684\u8bbf\u95ee\u6570\u636e\u89c2\u5bdf\">\u672c\u535a\u5ba2\u8fd1\u4e09\u4e2a\u6708\u6765\u7684\u8bbf\u95ee\u6570\u636e\u89c2\u5bdf<a class=\"headerlink\" href=\"#\u672c\u535a\u5ba2\u8fd1\u4e09\u4e2a\u6708\u6765\u7684\u8bbf\u95ee\u6570\u636e\u89c2\u5bdf\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u5199\u5728\u524d\u9762\">\u5199\u5728\u524d\u9762<a class=\"headerlink\" href=\"#\u5199\u5728\u524d\u9762\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u4e2a\u535a\u5ba2\u81ea 2014 \u5e74\u66f4\u65b0\u81f3\u4eca\uff0c\u5df2\u8d70\u8fc7\u8fd1\u5341\u4e00\u4e2a\u5e74\u5934\uff0c\u7d2f\u8ba1\u53d1\u5e03\u4e86\u56db\u767e\u591a\u7bc7\u6587\u7ae0\u3002\u51fa\u4e8e\u597d\u5947\uff0c\u6211\u4e00\u76f4\u60f3\u4e86\u89e3\u54ea\u4e9b\u5185\u5bb9\u66f4\u53d7\u8bfb\u8005\u6b22\u8fce\u3002\u4e94\u5e74\u524d\uff0c\u6211\u66fe\u914d\u7f6e\u8fc7 Google Analytics\uff0c\u4f46\u4f7f\u7528\u4f53\u9a8c\u5e76\u4e0d\u7406\u60f3\uff0c\u4e8e\u662f\u8f6c\u800c\u81ea\u884c\u90e8\u7f72\u4e86 <a href=\"https://github.com/rybbit-io/rybbit/\">rybbit</a> \u5b9e\u4f8b\u6765\u6536\u96c6\u8bbf\u95ee\u6570\u636e\u3002\u5982\u4eca\u4e09\u4e2a\u6708\u8fc7\u53bb\uff0c\u662f\u65f6\u5019\u4e0e\u5927\u5bb6\u5206\u4eab\u4e00\u4e9b\u6709\u8da3\u7684\u53d1\u73b0\u3002</p>\n<p>P.S. \u5982\u679c\u4f60\u5bf9\u6570\u636e\u6536\u96c6\u6709\u6240\u987e\u8651\uff0c\u53ef\u4ee5\u5c4f\u853d\u5bf9\u5e94\u7684 analytics \u811a\u672c\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u6570\u636e\u603b\u89c8\u4e0e\u8d8b\u52bf\">\u6570\u636e\u603b\u89c8\u4e0e\u8d8b\u52bf<a class=\"headerlink\" href=\"#\u6570\u636e\u603b\u89c8\u4e0e\u8d8b\u52bf\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u6765\u770b\u8fd9\u4e09\u4e2a\u6708\u5185\u7684\u6574\u4f53\u8bbf\u95ee\u60c5\u51b5\u4e0e\u8d8b\u52bf\uff1a</p>\n<p><img alt=\"\" src=\"../../../../blog-analytics-three-months-overall.png\" /></p>\n<p>\u8bbf\u95ee\u91cf\u6bd4\u6211\u7684\u9884\u671f\u8981\u9ad8\u4e00\u4e9b\u3002\u867d\u7136\u8fd9\u4e9b\u5e74\u5199\u4e86\u4e0d\u5c11\u5185\u5bb9\uff0c\u4f46\u5e76\u6ca1\u6709\u523b\u610f\u5ba3\u4f20\uff0c\u4e3b\u8981\u4f9d\u8d56\u641c\u7d22\u5f15\u64ce\u63a8\u8350\u548c\u8bfb\u8005\u7684\u8ba2\u9605\u4e0e\u8f6c\u53d1\u3002\u4ece\u65f6\u95f4\u8d8b\u52bf\u4e0a\u53ef\u4ee5\u770b\u51fa\u4e24\u4e2a\u660e\u663e\u7279\u70b9\uff1a</p>\n<ol>\n<li>\u5de5\u4f5c\u65e5\u8bbf\u95ee\u91cf\u663e\u8457\u9ad8\u4e8e\u5468\u672b\uff0c\u901a\u5e38\u4e3a\u5468\u672b\u7684\u4e24\u5230\u4e09\u500d\uff1b</li>\n<li>\u5f00\u5b66\u540e\u5de5\u4f5c\u65e5\u7684\u8bbf\u95ee\u91cf\u6bd4\u6691\u5047\u671f\u95f4\u53c8\u9ad8\u51fa\u4e00\u500d\uff0c\u4f46\u5468\u672b\u4f9d\u7136\u4f4e\u8ff7\u3002</li>\n</ol>\n<p>\u7531\u6b64\u63a8\u6d4b\uff0c\u5b66\u751f\u8bfb\u8005\u5360\u6bd4\u8f83\u9ad8\u3002\u7ed3\u5408\u56fd\u5e86\u5047\u671f\u8bbf\u95ee\u91cf\u7684\u4e0b\u964d\u6765\u770b\uff0c\u56fd\u5185\u8bfb\u8005\u4ecd\u662f\u4e3b\u529b\u3002\u4e0b\u9762\u662f\u5404\u56fd\u5bb6\u4e0e\u5730\u533a\u7684\u8bbf\u95ee\u5206\u5e03\uff1a</p>\n<p><img alt=\"\" src=\"../../../../blog-analytics-three-months-location.png\" /></p>\n<p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u4e5f\u6709\u4e0d\u5c11\u6d77\u5916\u8bfb\u8005\u8bbf\u95ee\uff0c\u770b\u6765\u8fd1\u5e74\u6765\u6709\u610f\u8bc6\u5730\u64b0\u5199\u82f1\u6587\u5185\u5bb9\u786e\u5b9e\u4ea7\u751f\u4e86\u6548\u679c\u3002</p>\n<p>\u4ee5 UTC+8 \u65f6\u533a\u4e3a\u57fa\u51c6\uff0c\u4ece\u8bbf\u95ee\u65f6\u95f4\u5206\u5e03\u4e2d\u53ef\u4ee5\u770b\u51fa\u5927\u5bb6\u7684\u4f5c\u606f\u4e60\u60ef\uff1a</p>\n<p><img alt=\"\" src=\"../../../../blog-analytics-three-months-time.png\" /></p>\n<p>\u5c3d\u7ba1\u5927\u5bb6\u53ef\u80fd\u4e60\u60ef\u71ac\u591c\uff0c\u4f46\u6df1\u591c\u9605\u8bfb\u535a\u5ba2\u7684\u5e76\u4e0d\u591a\uff0c\u591a\u6570\u8bbf\u95ee\u96c6\u4e2d\u5728\u5de5\u4f5c\u65f6\u95f4\u3002</p>\n<p>\u63a5\u4e0b\u6765\u662f\u57fa\u4e8e User Agent \u7684\u7edf\u8ba1\u3002\u9996\u5148\u662f\u6d4f\u89c8\u5668\u5206\u5e03\uff1a</p>\n<p><img alt=\"\" src=\"../../../../blog-analytics-three-months-browser.png\" /></p>\n<p>\u4e0d\u51fa\u6240\u6599\uff0cChrome \u53ca\u57fa\u4e8e Chromium \u5185\u6838\u7684\u6d4f\u89c8\u5668\u5360\u636e\u4e3b\u6d41\uff0cFirefox \u548c Safari \u5360\u6bd4\u4e0d\u9ad8\u3002\u6211\u672c\u4eba\u76ee\u524d\u4e5f\u5728\u4f7f\u7528 Firefox\uff0c\u5e0c\u671b\u5b83\u80fd\u6301\u7eed\u53d1\u5c55\uff0c\u907f\u514d Chrome \u4e00\u5bb6\u72ec\u5927\u3002</p>\n<p>\u64cd\u4f5c\u7cfb\u7edf\u5206\u5e03\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../blog-analytics-three-months-os.png\" /></p>\n<p>Windows \u5360\u6bd4\u6700\u9ad8\uff0cmacOS \u6b21\u4e4b\u3002\u8003\u8651\u5230\u535a\u5ba2\u5185\u5bb9\u4e3b\u8981\u6d89\u53ca\u8ba1\u7b97\u673a\u6280\u672f\uff0c\u8fd9\u4e5f\u5927\u81f4\u53cd\u6620\u4e86\u76f8\u5173\u4ece\u4e1a\u4eba\u5458\u7684\u504f\u597d\u3002</p>\n<p>\u4ee5\u4e0b\u662f\u8bbf\u95ee\u6b21\u6570\u8f83\u591a\u7684\u51e0\u7bc7\u6587\u7ae0\uff1a</p>\n<ul>\n<li><a href=\"../../../../../hardware/2022/12/10/acpi-notes/\">ACPI \u5b66\u4e60\u7b14\u8bb0</a>: 886 \u6b21</li>\n<li><a href=\"../../../../2021/12/26/nvidia-cuda/\">NVIDIA \u9a71\u52a8\u548c CUDA \u7248\u672c\u4fe1\u606f\u901f\u67e5</a>: 835 \u6b21</li>\n<li><a href=\"../../../../../system/2023/08/11/openbmc-qemu/\">\u5728 QEMU \u4e2d\u8fd0\u884c OpenBMC</a>: 725 \u6b21</li>\n<li><a href=\"../../../../2023/08/02/spec-cpu-2006/\">SPEC CPU 2006 \u6027\u80fd\u6d4b\u8bd5</a>: 520 \u6b21</li>\n<li><a href=\"../../../../../hardware/2020/05/10/mifare-classic-ndef/\">MIFARE Classic \u4e0a\u914d\u7f6e NDEF</a>: 464 \u6b21</li>\n</ul>\n<p>\u8fd9\u4e2a\u6392\u540d\u6709\u4e9b\u51fa\u4e4e\u6211\u7684\u610f\u6599\u3002\u8fd9\u51e0\u7bc7\u6587\u7ae0\u5728\u64b0\u5199\u65f6\u5e76\u672a\u7279\u522b\u8003\u8651\u5165\u95e8\u8bfb\u8005\u7684\u7406\u89e3\u96be\u5ea6\u6216\u5185\u5bb9\u7684\u4e30\u5bcc\u6027\u3002\u6216\u8bb8\u662f\u56e0\u4e3a\u5b83\u4eec\u6d89\u53ca\u7684\u9886\u57df\u8d44\u6599\u8f83\u5c11\uff0c\u56e0\u6b64\u5728\u76f8\u5173\u5173\u952e\u8bcd\u641c\u7d22\u4e2d\u5bb9\u6613\u88ab\u627e\u5230\u3002\u8fd9\u4e00\u70b9\u5728 Google Search Console \u4e2d\u4e5f\u5f97\u5230\u4e86\u5370\u8bc1\uff1a</p>\n<p><img alt=\"\" src=\"../../../../blog-analytics-three-months-search.png\" /></p>\n<p>\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u4e00\u4e9b\u7cbe\u5fc3\u51c6\u5907\u7684\u6587\u7ae0\u9605\u8bfb\u91cf\u5e76\u4e0d\u9ad8\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u6240\u5728\u9886\u57df\u5df2\u6709\u8f83\u591a\u4f18\u8d28\u5185\u5bb9\uff0c\u65b0\u6587\u7ae0\u96be\u4ee5\u8131\u9896\u800c\u51fa\u3002\u8fd9\u4e5f\u8bf4\u660e\u6587\u7ae0\u8d28\u91cf\u4e0e\u9605\u8bfb\u91cf\u4e4b\u95f4\u5e76\u975e\u7b80\u5355\u7684\u6b63\u6bd4\u5173\u7cfb\u3002</p>\n<p>\u6211\u8fd8\u6ce8\u610f\u5230\u4e00\u4e9b\u91cd\u5ea6\u7528\u6237\uff0c\u4ed6\u4eec\u4e0d\u4ec5\u9605\u8bfb\u591a\u7bc7\u6587\u7ae0\uff0c\u4e14\u505c\u7559\u65f6\u95f4\u8f83\u957f\uff1a</p>\n<ul>\n<li>\u672a\u77e5\u7528\u6237\u4e00\uff1a\u9605\u8bfb\u4e86\u5206\u652f\u9884\u6d4b\u3001\u4e71\u5e8f\u6267\u884c\u3001CPU \u5fae\u67b6\u6784\u5206\u6790\u7b49\u6587\u7ae0\uff0c\u63a8\u6d4b\u53ef\u80fd\u662f\u521a\u5f00\u59cb\u7814\u7a76 CPU \u5fae\u67b6\u6784\u7684\u540c\u884c\uff1b</li>\n<li>\u672a\u77e5\u7528\u6237\u4e8c\uff1a\u6d4f\u89c8\u4e86 wishbone\u3001\u4e71\u5e8f\u6267\u884c\u76f8\u5173\u5185\u5bb9\uff0c\u731c\u6d4b\u662f\u5b66\u4e60\u6e05\u534e\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u8bfe\u7a0b\u7684\u5b66\u751f\uff1b</li>\n<li>\u672a\u77e5\u7528\u6237\u4e09\uff1a\u4ece\u534e\u4e3a\u76f8\u5173\u6587\u7ae0\u8fdb\u5165\uff0c\u968f\u540e\u6d4f\u89c8\u4e86\u5176\u4ed6\u5185\u5bb9\uff0c\u53ef\u80fd\u662f\u641c\u7d22\u534e\u4e3a\u5185\u5bb9\u8fdb\u5165\u535a\u5ba2\u540e\uff0c\u88ab\u5176\u4ed6\u6587\u7ae0\u5438\u5f15\u7684\u8bfb\u8005\uff1b</li>\n<li>\u672a\u77e5\u7528\u6237\u56db\uff1a\u9605\u8bfb\u4e86 ARM/Samsung/Intel \u7b49\u5904\u7406\u5668\u5fae\u67b6\u6784\u5206\u6790\u6587\u7ae0\uff0c\u53c8\u4e00\u4f4d\u540c\u884c\uff0c\u4f46\u6709\u4e00\u5b9a\u57fa\u7840\uff0c\u66f4\u52a0\u5173\u6ce8\u4e1a\u754c\u3002</li>\n</ul>\n<p>\u7c7b\u4f3c\u7684\u4f8b\u5b50\u8fd8\u6709\u4e0d\u5c11\uff0c\u5728\u6b64\u4e0d\u4e00\u4e00\u5217\u4e3e\u3002\u5c3d\u7ba1 CPU \u76f8\u5173\u6587\u7ae0\u7684\u9605\u8bfb\u91cf\u4e0d\u53ca\u8f6f\u4ef6\u7c7b\u5185\u5bb9\uff0c\u4f46\u80fd\u5f97\u5230\u8fd9\u4e48\u591a\u540c\u884c\u7684\u5173\u6ce8\uff0c\u786e\u5b9e\u4ee4\u4eba\u6b23\u6170\u2014\u2014\u6bd5\u7adf\u8fd9\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u5c0f\u4f17\u9886\u57df\uff0c\u4e0d\u80fd\u5962\u6c42\u8fc7\u9ad8\u7684\u9605\u8bfb\u91cf\u3002</p>\n<p>\u901a\u8fc7\u8fd9\u6b21\u6570\u636e\u5206\u6790\uff0c\u6211\u6536\u83b7\u4e86\u4e0d\u5c11\u6709\u8da3\u7684\u89c2\u5bdf\u3002\u672a\u6765\u53ef\u80fd\u4f1a\u4e0d\u5b9a\u671f\u66f4\u65b0\u7c7b\u4f3c\u5185\u5bb9\uff0c\u770b\u770b\u968f\u7740\u65f6\u95f4\u63a8\u79fb\uff0c\u662f\u5426\u4f1a\u6709\u65b0\u7684\u53d1\u73b0\u3002</p>\n<p>\u6700\u540e\uff0c\u5982\u679c\u4f60\u5bf9\u8bbf\u95ee\u6570\u636e\u7684\u6536\u96c6\u611f\u5230\u4e0d\u9002\uff0c\u53ef\u4ee5\u76f4\u63a5\u5c4f\u853d analytics \u811a\u672c\uff08\u6216\u8bb8\u4f60\u7684\u6d4f\u89c8\u5668\u63d2\u4ef6\u5df2\u7ecf\u8fd9\u6837\u505a\u4e86\uff09\u3002\u6839\u636e rybbit \u7684\u5b98\u65b9\u8bf4\u660e\uff0c\u5176\u4fe1\u606f\u6536\u96c6\u65b9\u6cd5\u8f83\u4e3a\u5c0a\u91cd\u7528\u6237\u9690\u79c1\uff0c\u6211\u4e5f\u6ca1\u6709\u5bf9\u4ee3\u7801\u8fdb\u884c\u4efb\u4f55\u4fee\u6539\uff0c\u4e0d\u653e\u5fc3\u7684\u8bfb\u8005\u53ef\u4ee5\u9605\u8bfb <a href=\"https://github.com/rybbit-io/rybbit\">rybbit</a> \u7684\u6e90\u7801\u6765\u5ba1\u8ba1\u3002</p>\n<p>P.S. \u4f60\u80fd\u770b\u51fa\u8fd9\u7bc7\u6587\u7ae0\u662f\uff0c\u6211\u5148\u5199\u4e86\u4e00\u904d\uff0c\u7136\u540e\u8ba9\u5927\u6a21\u578b\u6da6\u8272\u7684\u7ed3\u679c\u5417\uff1f</p>", "image": "https://jia.je/assets/images/social/blog/posts/software/blog-analytics-three-months.png", "date_modified": "2025-10-09T00:00:00+00:00", "date_published": "2025-10-09T00:00:00+00:00", "authors": [], "tags": ["analytics", "blog", "rybbit", "software"]}, {"id": "https://jia.je/hardware/2025/09/10/arm-core-development/", "url": "https://jia.je/hardware/2025/09/10/arm-core-development/", "title": "ARM \u516c\u7248\u6838\u5fae\u67b6\u6784\u6f14\u8fdb", "content_html": "<h1 id=\"arm-\u516c\u7248\u6838\u5fae\u67b6\u6784\u6f14\u8fdb\">ARM \u516c\u7248\u6838\u5fae\u67b6\u6784\u6f14\u8fdb<a class=\"headerlink\" href=\"#arm-\u516c\u7248\u6838\u5fae\u67b6\u6784\u6f14\u8fdb\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u516c\u7248\u6838\u5fae\u67b6\u6784\u7684\u6f14\u8fdb\u9891\u7e41\uff0c\u578b\u53f7\u53c8\u6bd4\u8f83\u591a\uff0c\u76f8\u5173\u4fe1\u606f\u6563\u843d\u5728\u5404\u79cd\u5730\u65b9\uff0c\u4e3a\u4e86\u65b9\u4fbf\u67e5\u9605\uff0c\u5728\u8fd9\u91cc\u505a\u4e00\u4e2a\u6536\u96c6\u3002</p>\n<!-- more -->\n\n<h2 id=\"2025-\u5e74\">2025 \u5e74<a class=\"headerlink\" href=\"#2025-\u5e74\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"c1-ultra\">C1-Ultra<a class=\"headerlink\" href=\"#c1-ultra\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://pc.watch.impress.co.jp/docs/column/ubiq/2046162.html\">Arm \u306e\u65b0\u3057\u3044 CPU\u300cC1\u300d\u306f 2 \u6841\u30d1\u30fc\u30bb\u30f3\u30c8\u306e\u6027\u80fd\u30a2\u30c3\u30d7\u3002\u96fb\u529b\u52b9\u7387\u3082\u5927\u5e45\u6539\u5584</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=U1tPpV0RWNw\">Inside Arm's New C1\u2011Ultra CPU: Double\u2011Digit IPC Gains Again!</a><ul>\n<li>C1-Ultra: successor to Cortex X925</li>\n<li>Branch prediction: Additional tracking for local/per-PC history</li>\n<li>33% increase in L1 I-Cache available bandwidth</li>\n<li>Out of order window size growth: Up to 25% growth, Up to ~2K instruction in flight</li>\n<li>2x L1 data cache capacity (128KB)</li>\n<li>Data prefetchers: array-indexing coverage</li>\n</ul>\n</li>\n<li><a href=\"https://developer.arm.com/documentation/108014/latest/\">Arm\u00ae C1-Ultra Core Technical Reference Manual</a><ul>\n<li>Implementation of the Scalable Vector Extension (SVE) with a 128-bit vector length and Scalable Vector Extension 2 (SVE2)</li>\n<li>Implementation of the Scalable Matrix Extension (SME) and Scalable Matrix Extension 2 (SME2), and support for the C1-SME2 unit</li>\n<li>configure the L2 cache to be 2048KB or 3072KB</li>\n<li>A 64KB, 4-way set associative L1 instruction cache with 64-byte cache lines</li>\n<li>A fully associative L1 instruction Translation Lookaside Bu\ufb00er (TLB) with native support for 4KB, 16KB, 64KB, and 2MB page sizes</li>\n<li>A 128KB, 4-way set associative cache with 64-byte cache lines</li>\n<li>A fully associative L1 data TLB with native support for 4KB, 16KB, and 64KB page sizes and 2MB and 512MB block sizes</li>\n<li>L2 cache is private to the core and can be configured to be 2MB 8-way set associative or 3MB 12-way set associative</li>\n<li>L1 instruction TLB, Fully associative, 128 entries</li>\n<li>L1 data TLB, Fully associative, 96 entries</li>\n<li>L1 Statistical Profiling Extension (SPE) TLB, Located in the SPE block, VA to PA translations of any page and block size, 1 entry</li>\n<li>L1 TRace Bu\ufb00er Extension (TRBE) TLB, VA to PA translations of any page and block size, 1 entry</li>\n<li>L2 TLB, Shared by instructions and data, 8-way set associative, 2048 entries</li>\n<li>L1 instruction cache, 64KB, 4-way set associative, Virtually Indexed, Physically Tagged (VIPT) behaving as Physically Indexed, Physically Tagged (PIPT), Pseudo-Least Recently Used (LRU) cache replacement policy for L1, 32 bytes per cycle interface with L2</li>\n<li>L1 data cache, 128KB, 4-way set associative, Virtually Indexed, Physically Tagged (VIPT) behaving as Physically Indexed, Physically Tagged (PIPT), Re-Reference Interval Prediction (RRIP) replacement policy, 4\u00d764-bit read paths and 4\u00d764-bit write paths for the integer execute pipeline, 4\u00d7128-bit read paths and 4\u00d7128-bit write paths for the vector execute pipeline</li>\n<li>L2 cache, 2MB 8-way set associative with 4 banks or 3MB 12-way set associative with 4 banks, Physically Indexed, Physically Tagged (PIPT), Dynamic biased cache replacement policy, One CHI Issue E compliant interfaces with 256-bit read and write DAT channel widths</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"c1-pro\">C1-Pro<a class=\"headerlink\" href=\"#c1-pro\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=yUqEhahvAVE\">Arm Lumex C1-Pro CPU Core: What You Need to Know</a><ul>\n<li>C1-Pro: successor to Cortex-A725</li>\n<li>Larger direction predictor and branch history</li>\n<li>2x capacity 0-cycle BTB</li>\n<li>16x capacity 1-cycle BTB</li>\n<li>50% more L1 Instruction TLB capacity</li>\n<li>Increase effective L1D cache bandwidth</li>\n<li>Lower latency L2 TLB hit</li>\n<li>New indirect prefetcher</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2024-\u5e74\">2024 \u5e74<a class=\"headerlink\" href=\"#2024-\u5e74\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"cortex-x925\">Cortex X925<a class=\"headerlink\" href=\"#cortex-x925\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://www.anandtech.com/show/21399/arm-unveils-2024-cpu-core-designs-cortex-x925-a725-and-a520-arm-v9-2-redefined-for-3nm-/2\">Arm Unveils 2024 CPU Core Designs, Cortex X925, A725 and A520: Arm v9.2 Redefined For 3nm</a> <a href=\"https://web.archive.org/web/20250626065356/https://www.anandtech.com/show/21399/arm-unveils-2024-cpu-core-designs-cortex-x925-a725-and-a520-arm-v9-2-redefined-for-3nm-/2\">Archive</a><ul>\n<li>Decode &amp; Dispatch: 10-wide</li>\n<li>SIMD/FP execution: 6x 128b</li>\n<li>Integer ALU pipelines: 1- and 2-cycle operations</li>\n<li>Integer multiply execution: 4x versus Cortex-X4</li>\n<li>FP compare execution: 2x versus Cortex-X4</li>\n<li><code>&gt;2x</code> increase in SIMD/FP issue queues</li>\n<li>2x increase in max instruction-window capacity\uff08\u6ce8\uff1aCortex X4 \u662f 384x2\uff0c\u63a8\u6d4b Cortex X925 \u662f 768x2\uff09</li>\n<li>Sign-extension instruction elimination</li>\n<li>Branch prediction: 2x instruction window size</li>\n<li>Instruction Fetch: 2x increase in L1 I$ available bandwidth, 2x increase in L1 iTLB size, Fold out unconditional direct branches</li>\n<li>3 -&gt; 4 load pipelines</li>\n<li>2x increase in L1 D$ available bandwidth</li>\n<li>25-40% in back-end OoO growth</li>\n</ul>\n</li>\n<li><a href=\"https://developer.arm.com/documentation/102807/0001\">Arm\u00ae Cortex-X925 Core Technical Reference Manual</a><ul>\n<li>Implementation of the Scalable Vector Extension (SVE) with a 128-bit vector length and Scalable Vector Extension 2 (SVE2)</li>\n<li>configure the L2 cache to be 2048KB or 3072KB</li>\n<li>A 64KB, 4-way set associative L1 instruction cache with 64-byte cache lines</li>\n<li>A fully associative L1 instruction Translation Lookaside Bu\ufb00er (TLB) with native support for 4KB, 16KB, 64KB, and 2MB page sizes</li>\n<li>A 64KB, 4-way set associative cache with 64-byte cache lines</li>\n<li>A fully associative L1 data TLB with native support for 4KB, 16KB and 64KB page sizes and 2MB and 512MB block sizes</li>\n<li>L2 cache is private to the core and can be configured to be 2MB 8-way set associative or 3MB 12-way set associative</li>\n<li>L1 instruction TLB, Caches entries at the 4KB, 16KB, 64KB, or 2MB granularity of Virtual Address (VA) to Physical Address (PA) mapping only, Fully associative, 128 entries</li>\n<li>L1 data TLB, Caches entries at the 4KB, 16KB, 64KB, 2MB, or 512MB granularity of VA to PA mappings only, Fully associative, 96 entries</li>\n<li>L2 TLB, Shared by instructions and data, VA to PA mappings for 4KB, 16KB, 64KB, 2MB, 32MB, 512MB, and 1GB block sizes, Intermediate Physical Address (IPA) to PA mappings for: 2MB and 1GB block sizes in a 4KB translation granule, 32MB block size in a 16KB translation granule, 512MB block size in a 64KB granule; Intermediate PAs (descriptor PAs) obtained during a translation table walk, 8-way set associative, 2048 entries</li>\n<li>L1 instruction cache, 64KB, 4-way set associative, Virtually Indexed, Physically Tagged (VIPT) behaving as Physically Indexed, Physically Tagged (PIPT)</li>\n<li>The Cortex\u00ae-X925 core supports the AArch64 prefetch memory instructions, PRFM PLI, into the L1 instruction cache or L2 cache</li>\n<li>L1 data cache, 64KB, 4-way set associative, Virtually Indexed, Physically Tagged (VIPT) behaving as Physically Indexed, Physically Tagged (PIPT), Re-Reference Interval Prediction (RRIP) replacement policy, 4\u00d764-bit read paths and 4\u00d764-bit write paths for the integer execute pipeline, 4\u00d7128-bit read paths and 4\u00d7128-bit write paths for the vector execute pipeline</li>\n<li>L2 cache, 2MB 8-way set associative with 4 banks or 3MB 12-way set associative with 4 banks, Physically Indexed, Physically Tagged (PIPT)</li>\n</ul>\n</li>\n<li><a href=\"https://developer.arm.com/documentation/109842/latest/\">Arm\u00ae Cortex-X925 Core Software Optimization Guide</a></li>\n</ul>\n<h2 id=\"2023-\u5e74\">2023 \u5e74<a class=\"headerlink\" href=\"#2023-\u5e74\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"cortex-x4\">Cortex X4<a class=\"headerlink\" href=\"#cortex-x4\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://www.anandtech.com/show/18871/arm-unveils-armv92-mobile-architecture-cortex-x4-a720-and-a520-64bit-exclusive/2\">Arm Unveils 2023 Mobile CPU Core Designs: Cortex-X4, A720, and A520 - the Armv9.2 Family</a> <a href=\"https://web.archive.org/web/20250622110728/http://www4.anandtech.com/show/18871/arm-unveils-armv92-mobile-architecture-cortex-x4-a720-and-a520-64bit-exclusive/2\">Archive</a><ul>\n<li>Support for larger L2 (2M)</li>\n<li>Dispatch width: 10 instrs vs Cortex-X3 (6 instrs <code>I$</code>, 8 instrs <code>Mop$</code>)</li>\n<li>Overall pipeline depth (branch mispredict penalty): 10 cycles vs Cortex-X3 (11 cycles <code>I$</code>, 9 cycles <code>Mop$</code>)</li>\n<li>ALUs: 8 vs 6 (Cortex-X3)</li>\n<li>Branch units: 3 vs 2 (Cortex-X3)</li>\n<li>Integer MAC: 2 vs 1 (Cortex-X3)</li>\n<li>Pipelined FP divider / sqrt: Y vs N (Cortex-X3)</li>\n<li>MCA capacity: 320x2 -&gt; 384x2</li>\n<li>4th LS address generation: LS LS LD -&gt; LS LD LD ST</li>\n<li>New L1 temporal data prefetcher</li>\n<li>Reduced L1 data bank conflicts</li>\n<li>Larger L1 data TLB: 48 -&gt; 96</li>\n</ul>\n</li>\n<li><a href=\"https://developer.arm.com/documentation/102484/latest/\">Arm\u00ae Cortex-X4 Core Technical Reference Manual</a></li>\n</ul>\n<h3 id=\"cortex-a720\">Cortex A720<a class=\"headerlink\" href=\"#cortex-a720\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://www.anandtech.com/show/18871/arm-unveils-armv92-mobile-architecture-cortex-x4-a720-and-a520-64bit-exclusive/3\">Arm Unveils 2023 Mobile CPU Core Designs: Cortex-X4, A720, and A520 - the Armv9.2 Family</a> <a href=\"https://web.archive.org/web/20250522224324/https://www.anandtech.com/show/18871/arm-unveils-armv92-mobile-architecture-cortex-x4-a720-and-a520-64bit-exclusive/3\">Archive</a><ul>\n<li>11-cycle mispredict penalty, vs 12 (Cortex-A715)</li>\n<li>Improved 2-taken branch prediction</li>\n<li>Pipelined FDIV/FSQRT unit</li>\n<li>Faster transfers from Floating-Point/NEON/SVE2 to Integer</li>\n<li>Earlier deallocation of mops from Load-Store Issue Queues</li>\n<li>Lower latency for L2 cache hits, 9-cycle latency to access L2, vs 10 (Cortex-A715)</li>\n<li>Up to 2x memset(0) bandwidth in L2</li>\n<li>New L2 spatial-prefetch engine</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2022-\u5e74\">2022 \u5e74<a class=\"headerlink\" href=\"#2022-\u5e74\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"cortex-x3\">Cortex X3<a class=\"headerlink\" href=\"#cortex-x3\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://fuse.wikichip.org/news/6855/arm-unveils-next-gen-flagship-core-cortex-x3/\">Arm Unveils Next-Gen Flagship Core: Cortex-X3</a><ul>\n<li>50% larger L1 + L2 (new) BTB capacity</li>\n<li>10x larger L0 BTB capacity</li>\n<li>New predictor dedicated for indirect branches</li>\n<li>Double return-stack capacity (32 entries)</li>\n<li>Mop cache 50% capacity (1.5K entries)</li>\n<li>Removed 1 pipeline stage in Mop Cache fetch, 10-&gt;9 cycles for a branch mispredict</li>\n<li>Increase decode bandwidth: 5-&gt;6</li>\n<li>Integer ALUs increase 4-&gt;6: 2-&gt;4 single-cycle (SX), 2 single-/multi-cycle (MX)</li>\n<li>ROB/MCQ: 288x2 -&gt; 320x2</li>\n<li>Integer load bandwdith: 24B -&gt; 32B</li>\n<li>Additional data prefetch engines: Spatial, Pointer/Indirect</li>\n</ul>\n</li>\n<li><a href=\"https://developer.arm.com/documentation/101593/latest/\">Arm\u00ae Cortex\u2011X3 Core Technical Reference Manual</a></li>\n</ul>\n<h3 id=\"neoverse-v2\">Neoverse V2<a class=\"headerlink\" href=\"#neoverse-v2\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://hc2023.hotchips.org/assets/program/conference/day1/CPU1/HC2023.Arm.MagnusBruce.v04.FINAL.pdf\">Arm Neoverse V2 platform: Leadership Performance and Power Efficiency for Next-Generation Cloud Computing, ML and HPC Workloads</a><ul>\n<li>6-wide/8-wide front-end</li>\n<li>64KB ICache</li>\n<li>320+ OoO window</li>\n<li>8-wide dispatch</li>\n<li>8-wide retire</li>\n<li>2 LS + 1 LD / cycle</li>\n<li>64KB DCache</li>\n<li>6-ALU + 2-branch</li>\n<li>Quad 128-bit low latency SIMD datapath</li>\n<li>L2 10-cycle load-to-use, 128B/cycle, private L2 cache 1 or 2 MB</li>\n<li>Two predicted branches per cycle</li>\n<li>Predictor acts as ICache prefetcher</li>\n<li>64kB, 4-way set-associative L1 instruction cache</li>\n<li>Two-level Branch Target Buffer</li>\n<li>8 table TAGE direction predictor with staged output</li>\n<li>10x larger nanoBTB</li>\n<li>Split main BTB into two levels with 50% more entries</li>\n<li>TAGE: 2x larger tables with 2-way associativity, Longer history</li>\n<li>Indirect branches: Dedicated predictor</li>\n<li>Fetch bandwidth: Doubled instruction TLB and cache BW</li>\n<li>Fetch Queue: Doubled from 16 to 32 entries</li>\n<li>Fill Buffer: Increased size from 12 to 16 entries</li>\n<li>Decode bandwidth: Increased decoder lanes from 5 to 6, Increased Decode Queue from 16 to 24 entries</li>\n<li>Rename checkpoints: Increased from 5 to 6 total checkpoints, Increased from 3 to 5 vector checkpoints</li>\n<li>Late read of physical register file \u2013 no data in IQs</li>\n<li>Result caches with lazy writeback</li>\n<li>Added two more single-cycle ALUs</li>\n<li>Larger Issue Queues, SX/MX: Increased from 20 to 22 entries, VX: Increased from 20 to 28 entries</li>\n<li>Predicate operations: Doubled predicate bandwidth</li>\n<li>Zero latency MOV; Subset of register-register and immediate move operations execute with zero latency</li>\n<li>Instruction fusion: More fusion cases, including CMP + CSEL/CSET</li>\n<li>Two load/store pipes + one load pipe</li>\n<li>4 x 8B result busses (integer)</li>\n<li>3 x 16B result busses (FP, SVE, Neon)</li>\n<li>ST to LD forwarding at L1 hit latency</li>\n<li>RST and MB to reduce tag and data accesses</li>\n<li>Fully-associative L1 DTLB with multiple page sizes</li>\n<li>64kB 4-way set associative Dcache</li>\n<li>TLB Increased from 40 to 48 entries</li>\n<li>Replacement policy Changed from PLRU to dynamic RRIP</li>\n<li>Larger Queues: Store Buffer, ReadAfterRead, ReadAfterWrite</li>\n<li>Efficiency: VA hash based store to load forwarding</li>\n<li>Multiple prefetching engines training on L1 and L2 accesses: Spatial Memory Streaming, Best Offset, Stride, Correlated Miss Cache, Page</li>\n<li>New PF engines: Global SMS \u2013 larger offsets than SMS, Sampling Indirect Prefetch \u2013 pointer dereference, TableWalk \u2013 Page Table Entrie</li>\n<li>Private unified Level 2 cache, 8-way SA, 4 independent banks</li>\n<li>64B read or write per 2 cycles per bank = 128B/cycle total</li>\n<li>96-entry Transaction Queue</li>\n<li>Inclusive with L1 caches for efficient data and instruction coherency</li>\n<li>AMBA CHI interface with 256b DAT channels</li>\n<li>Capacity 2MB/8-way with latency of 1MB (10-cycle ld-to-use)</li>\n<li>Replacement policy 6-state RRIP (up from 4)</li>\n</ul>\n</li>\n<li><a href=\"https://chipsandcheese.com/p/hot-chips-2023-arms-neoverse-v2\">Hot Chips 2023: Arm\u2019s Neoverse V2</a></li>\n<li><a href=\"https://developer.arm.com/documentation/102375/latest/\">Arm\u00ae Neoverse\u2122 V2 Core Technical Reference Manual</a></li>\n<li><a href=\"https://developer.arm.com/documentation/109898/latest/\">Arm Neoverse V2 Software Optimization Guide</a></li>\n</ul>\n<h2 id=\"2021-\u5e74\">2021 \u5e74<a class=\"headerlink\" href=\"#2021-\u5e74\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"cortex-x2\">Cortex X2<a class=\"headerlink\" href=\"#cortex-x2\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://chipsandcheese.com/2023/10/27/cortex-x2-arm-aims-high/\">Cortex X2: Arm Aims High</a></li>\n<li><a href=\"https://developer.arm.com/documentation/101803/0200\">Arm\u00ae Cortex\u00ae\u2011X2 Core Technical Reference Manual</a></li>\n<li><a href=\"https://www.anandtech.com/show/16693/arm-announces-mobile-armv9-cpu-microarchitectures-cortexx2-cortexa710-cortexa510/2\">Arm Announces Mobile Armv9 CPU Microarchitectures: Cortex-X2, Cortex-A710 &amp; Cortex-A510</a></li>\n</ul>\n<h2 id=\"2020-\u5e74\">2020 \u5e74<a class=\"headerlink\" href=\"#2020-\u5e74\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"neoverse-n2\">Neoverse N2<a class=\"headerlink\" href=\"#neoverse-n2\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://hc33.hotchips.org/assets/program/conference/day1/20210818_Hotchips_NeoverseN2.pdf\">Arm Neoverse N2: Arm\u2019s 2nd generation high performance infrastructure CPUs and system IPs</a><ul>\n<li>Branch Prediction, 2x 8 instrs (up to 2 taken per cycle), 2x improvement</li>\n<li>Nano BTB (0 cyc taken-branch bubble), 64 entry, 4x improvement</li>\n<li>Conditional branch direction state, 1.5x improvement</li>\n<li>Main BTB, 8K entry, 1.33x improvement</li>\n<li>Alt-Path Branch Prediction</li>\n<li>64KB Instruction cache</li>\n<li>1.5K entry Mop Cache</li>\n<li>16-entry Fetch Queue, 1.33x improvement</li>\n<li>Fetch Width: 4 instr from <code>i$</code>, 5 instr from <code>MOP$</code>, Up to 1.5x improvement</li>\n<li>Early branch redirect: uncond + cond</li>\n<li>Decode width: 4 (I-cache) or 5 (Mop cache), Up to 1.25x improvement</li>\n<li>Branch predict up to 16-inst/cycle, 2-taken/cycle</li>\n<li>New Macro-op (MOP) cache with 1.5k entries</li>\n<li>50% larger branch direction predicton</li>\n<li>33% larger BTB with shorter average latency</li>\n<li>Early re-steering for conditional branches that miss the BTB</li>\n<li>Rename width: 5 instrs, 1.2x improvement</li>\n<li>Rename Checkpointing: Yes</li>\n<li>ROB size: 160+, 1.25x improvement</li>\n<li>ALUs: 4, 1.33x improvement</li>\n<li>Branch resolution: 2 per cycle, 2x improvement</li>\n<li>Overall Pipeline Depth: 10 cycles, 1.1x improvement</li>\n<li>64KB L1 Data cache</li>\n<li>Private 512KB/1MB L2 Cache</li>\n<li>AGU: 2-LD/ST + 1 LD, 1.5x improvement</li>\n<li>L1 LD Hit bandwidth: 3x 16B/cycle, 1.5x improvement</li>\n<li>Store data B/W: 32B/cycle, 2x improvement</li>\n<li>L2 bandwidth: 64B read + 64B write, 2x improvement</li>\n<li>L2 transactions: 64, 1.3x improvement</li>\n<li>Data Prefetch Engines: Stride, spatial/region, stream, temporal</li>\n<li>Correlated Miss Caching (CMC) prefetching</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"neoverse-v1\">Neoverse V1<a class=\"headerlink\" href=\"#neoverse-v1\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://teratec.eu/library/pdf/forum/2021/A05-03.pdf\">SW defined cars: HPC, from the cloud to the dashboard for an amazing driver experience</a><ul>\n<li>Faster run-ahead for prefetching into the I$ (2x32B bandwidth)</li>\n<li>33% larger BTBs (8K entry)</li>\n<li>6x nano BTB (96 entry), zero-cycle bubble</li>\n<li>2x number of concurrent code regions tracked in front-end</li>\n<li>Introduction of Mop Cache, L0 decoded instruction cache (3K entry)</li>\n<li>high dispatch bandwidth, 8-instrs per cycle, 2x increase, I$ decode bandwidth increased from 4x to 5x</li>\n<li>Lower latency decode pipeline by 1 stage</li>\n<li>OoO window size, 2x+ ROB (256 entry + compression)</li>\n<li>Increase superscalar integer execution bandwidth, 1-&gt;2 Branch Execution, 3-&gt;4 ALU</li>\n<li>2x vector/fp bandwidth, 2x256b \u2013 SVE (new), 4x128b \u2013 Neon/FP</li>\n<li>3rd LD AGU/pipe (50% incr), LS LS LD</li>\n<li>LD/ST data bandwidth, LD: 2x16B -&gt; 3x16B, LD (SVE): 2x32B, ST: 16B -&gt; 32B (2x), broken out into separate issue pipes</li>\n<li>Number of outstanding external memory transactions (48-&gt;96)</li>\n<li>MMU capacity 1.2K-&gt;2K entry (67% incr)</li>\n<li>L2 latency reduced by 1 cycle for 1M (now 10cyc load to use)</li>\n<li>11+ stage accordion pipeline</li>\n<li>8-wide front-end / 15-wide issue</li>\n<li>Four 64-bit integer ALUs + two dedicated Branch units</li>\n<li>2x 256-bit SVE datapaths</li>\n<li>4x 128-bit Neon/FP datapaths</li>\n<li>3x load / store addr</li>\n<li>3x load data &amp; 2x store data pipeline</li>\n<li>8-wide Instruction fetch</li>\n<li>5-8 wide decode / rename</li>\n<li>pipeline: P1 P2 F1 F2 DE1 RR RD I0 I1 I2 ...</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"cortex-x1\">Cortex X1<a class=\"headerlink\" href=\"#cortex-x1\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://www.anandtech.com/show/15813/arm-cortex-a78-cortex-x1-cpu-ip-diverging/3\">Arm's New Cortex-A78 and Cortex-X1 Microarchitectures: An Efficiency and Performance Divergence</a> <a href=\"https://web.archive.org/web/20250716133719/https://www.anandtech.com/show/15813/arm-cortex-a78-cortex-x1-cpu-ip-diverging/3\">Archive</a><ul>\n<li>50% larger L0-BTB capacity, 96 entries, zero-cycle bubble taken-branch latency</li>\n<li>Increased fetch bandwidth available, 5 instruction fetch from the instruction cache, 8 Mop fetch from the Mop cache</li>\n<li>2x Mop cache capacity over Cortex-A77, 3K entries</li>\n<li>33% increase in dispatch bandwidth, up to 8-instr/cycle</li>\n<li>40% increase in out-of-order window size, 224 entry instruction window</li>\n<li>2x FP/ASIMD execution bandwidth, 4x128b total bandwidth</li>\n<li>Doubling available L1-D, L2 bandwidth</li>\n<li>Doubleing of maximum L2 capacity</li>\n<li>Up to 33% increase in window growth for in-flight loads and stores</li>\n<li>66% larger L2-TLB capacity, 2K entries</li>\n</ul>\n</li>\n<li><a href=\"https://fuse.wikichip.org/news/3543/arm-cortex-x1-the-first-from-the-cortex-x-custom-program/\">Arm Cortex-X1: The First From The Cortex-X Custom Program</a></li>\n<li><a href=\"https://developer.arm.com/documentation/101433/0102\">Arm\u00ae Cortex\u00ae\u2011X1 Core Technical Reference Manual</a></li>\n</ul>\n<h3 id=\"cortex-a78\">Cortex A78<a class=\"headerlink\" href=\"#cortex-a78\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://www.anandtech.com/show/15813/arm-cortex-a78-cortex-x1-cpu-ip-diverging/2\">Arm's New Cortex-A78 and Cortex-X1 Microarchitectures: An Efficiency and Performance Divergence</a> <a href=\"https://web.archive.org/web/20250529000334/https://www.anandtech.com/show/15813/arm-cortex-a78-cortex-x1-cpu-ip-diverging/2\">Archive</a><ul>\n<li>Expand prediction support to 2 taken branches per cycles</li>\n<li>Additional IMUL bandwidth, up to 2x per cycle</li>\n<li>50% increase in load bandwidth over Cortex-A77, additional load AGU / result</li>\n<li>Double store-data bandwidth, 32B per cycle</li>\n<li>Double L2 interface bandwidth</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2019-\u5e74\">2019 \u5e74<a class=\"headerlink\" href=\"#2019-\u5e74\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"neoverse-n1\">Neoverse N1<a class=\"headerlink\" href=\"#neoverse-n1\" title=\"Permanent link\">&para;</a></h3>\n<ul>\n<li><a href=\"https://www.arm.com/-/media/global/solutions/infrastructure/arm-neoverse-n1-platform.pdf\">The Arm Neoverse N1 Platform: Building Blocks for the Next-Gen Cloud-to-Edge Infrastructure SoC</a><ul>\n<li>4-wide front-end</li>\n<li>dispatching/committing up to 8 instructions per cycle</li>\n<li>three ALUs, a branch execution unit, two Advanced SIMD units, and two load/store execution units</li>\n<li>minimum misprediction penalty is 11-cycle</li>\n<li>fetch up to 4 instructions per cycle</li>\n<li>large 6K-entry main branch target buffer with 3-cycle access latency</li>\n<li>64-entry micro-BTB and a 16-entry nano-BTB</li>\n<li>12-entry fetch queue</li>\n<li>fully associative 48-entry instruction TLB</li>\n<li>4-way set-associative 64KB I-cache</li>\n<li>I-cache can deliver up to 16B of instructions per cycle</li>\n<li>up to 8 outstanding I-cache refill requests</li>\n<li>4-wide decoder</li>\n<li>renaming unit can receive up to 4 macro-ops per cycle</li>\n<li>up to 8 micro-operations can be dispatched into the out-of-order engine each cycle</li>\n<li>The commit queue can track up to 128 micro operations</li>\n<li>up to 8 micro-ops can be committed per cycle</li>\n<li>a distributed issue queue with more than 100 micro-operations</li>\n<li>4 integer execution pipelines, 2 load/store pipelines, and 2 Advanced SIMD pipelines</li>\n<li>64kB 4-way set associative L1 data cache, 4-cycle load to use latency and a bandwidth of 32 bytes/cycle</li>\n<li>The core-private 8-way set associative L2 cache is up to 1MB in size and has a load-to-use latency of 11 cycles</li>\n<li>can also be configured with smaller L2 cache sizes of 256kB and 512kB with a load-to-use latency of 9 cycles</li>\n<li>L2 cache connects to the system via an AMBA 5 CHI interface with 16-byte data channels</li>\n<li>L3 cluster cache can be up to 2MB, with a load-to-use latency ranging between 28 and 33 cycles</li>\n<li>up to 256MB of shared system-level cache</li>\n</ul>\n</li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/arm-core-development.png", "date_modified": "2025-09-10T00:00:00+00:00", "date_published": "2025-09-10T00:00:00+00:00", "authors": [], "tags": ["arm", "c1", "cortex", "cpu", "hardware", "neoverse"]}, {"id": "https://jia.je/hardware/2025/07/08/amd-zen-3-btb/", "url": "https://jia.je/hardware/2025/07/08/amd-zen-3-btb/", "title": "AMD Zen 3 \u7684 BTB \u7ed3\u6784\u5206\u6790", "content_html": "<h1 id=\"amd-zen-3-\u7684-btb-\u7ed3\u6784\u5206\u6790\">AMD Zen 3 \u7684 BTB \u7ed3\u6784\u5206\u6790<a class=\"headerlink\" href=\"#amd-zen-3-\u7684-btb-\u7ed3\u6784\u5206\u6790\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e4b\u524d\uff0c\u6211\u4eec\u5206\u6790\u4e86 <a href=\"../../07/amd-zen-1-btb/\">AMD Zen 1</a> \u548c <a href=\"../amd-zen-2-btb/\">AMD Zen 2</a> \u7684 BTB\uff0c\u63a5\u4e0b\u6765\u5206\u6790\u5b83\u7684\u518d\u4e0b\u4e00\u4ee3\u5fae\u67b6\u6784\uff1a2020 \u5e74\u53d1\u5e03\u7684 AMD Zen 3 \u7684 BTB\uff0c\u770b\u770b AMD \u7684 Zen \u7cfb\u5217\u7684 BTB \u662f\u5982\u4f55\u6f14\u8fdb\u7684\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD \u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/software-optimization-guides/56665.zip\">Software Optimization Guide for AMD EPYC\u2122 7003 Processors (Publication No. 56665)</a> \u4e2d\u6709\u5982\u4e0b\u7684\u8868\u8ff0\uff1a</p>\n<blockquote>\n<p>The branch target buffer (BTB) is a two-level structure accessed using the fetch address of the previous fetch block.</p>\n</blockquote>\n<p>Zen 3 \u7684 BTB \u6709\u4e24\u7ea7\uff0c\u76f8\u6bd4 Zen 1 \u548c Zen 2 \u5c11\u4e86\u4e00\u7ea7\u3002BTB \u662f\u7528\u4e4b\u524d fetch block \u7684\u5730\u5740\u53bb\u67e5\u8be2\uff0c\u800c\u4e0d\u518d\u662f\u5f53\u524d fetch block \u7684\u5730\u5740\u3002\u7528\u5f53\u524d fetch block \u7684\u5730\u5740\u67e5\u8be2 BTB \u5f88\u597d\u7406\u89e3\uff0c\u8981\u5bfb\u627e\u67d0\u4e2a\u5730\u5740\u5f00\u59cb\u7684\u7b2c\u4e00\u4e2a\u5206\u652f\uff0c\u5c31\u7528\u8fd9\u4e2a\u5730\u5740\u53bb\u67e5\u8be2 BTB\uff0cZen 1 \u548c Zen 2 \u90fd\u662f\u5982\u6b64\uff1b\u7528\u4e4b\u524d fetch block \u7684\u5730\u5740\uff0c\u5219\u662f\u7528\u66f4\u65e9\u7684\u4fe1\u606f\uff0c\u53bb\u83b7\u53d6\u5f53\u524d fetch block \u7684\u4fe1\u606f\uff0c\u4f8b\u5982\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"nl\">entrypoint1:</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"no\">entrypoint2</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"nl\">entrypoint2:</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"w\">    </span><span class=\"c1\"># what&#39;s the first branch after entrypoint2?</span>\n</span></code></pre></div>\n<p>\u5728\u67e5\u8be2\u4ece entrypoint2 \u5f00\u59cb\u7684\u7b2c\u4e00\u6761\u5206\u652f\u6307\u4ee4\u7684\u65f6\u5019\uff0c\u5982\u679c\u4f7f\u7528\u5f53\u524d fetch block\uff0c\u5c31\u662f\u7528 entrypoint2 \u7684\u5730\u5740\u53bb\u67e5\u8be2\uff0c\u90a3\u5c31\u5fc5\u987b\u7b49\u5230\u524d\u9762 <code>jmp entrypoint2</code> \u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u88ab\u8ba1\u7b97\u5f97\u51fa\uff1b\u5982\u679c\u4f7f\u7528\u4e4b\u524d fetch block\uff0c\u5c31\u662f\u7528 entrypoint1 \u7684\u5730\u5740\u53bb\u67e5\u8be2\uff0c\u4e0d\u7528\u7b49\u5230 <code>jmp entrypoint2</code> \u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u88ab\u8ba1\u7b97\u5f97\u51fa\u3002\u56e0\u6b64\uff0c\u5982\u679c\u7528\u4e4b\u524d fetch block\uff0c\u53ef\u4ee5\u66f4\u65e9\u5730\u8fdb\u884c BTB \u7684\u8bbf\u95ee\uff0c\u4ece\u800c\u51cf\u5c11 BTB \u7684\u5ef6\u8fdf\uff0c\u6216\u8005\u5728\u76f8\u540c\u5ef6\u8fdf\u4e0b\u83b7\u5f97\u66f4\u5927\u7684\u5bb9\u91cf\u3002\u4f46\u662f\uff0c\u4ee3\u4ef7\u662f\uff1a</p>\n<ul>\n<li>\u4ece entrypoint1 \u8df3\u8f6c\u5230\u7684 fetch block \u53ef\u80fd\u6709\u591a\u4e2a\uff0c\u4f8b\u5982\u6700\u540e\u4e00\u6761\u662f\u95f4\u63a5\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u5c31\u9700\u8981\u627e\u5230\u6b63\u786e\u7684\u5206\u652f\u7684\u4fe1\u606f</li>\n<li>\u53ef\u80fd\u4f1a\u4ece\u4e0d\u540c\u7684\u5730\u5740\u8df3\u8f6c\u5230 entrypoint2 \u8fd9\u4e2a fetch block\uff0c\u56e0\u6b64\u5b83\u7684\u4fe1\u606f\u53ef\u80fd\u4f1a\u4fdd\u5b58\u591a\u4efd</li>\n</ul>\n<blockquote>\n<p>Each BTB entry can hold up to two branches if the last bytes of the branches reside in the same 64-byte aligned cache line and the first branch is a conditional branch.</p>\n</blockquote>\n<p>Zen 3 \u7684 BTB entry \u6709\u4e00\u5b9a\u7684\u538b\u7f29\u80fd\u529b\uff0c\u4e00\u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u524d\u63d0\u662f\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a 64B \u7f13\u5b58\u884c\u4e2d\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u5206\u652f\u662f\u6761\u4ef6\u5206\u652f\u3002\u8fd9\u6837\uff0c\u5982\u679c\u7b2c\u4e8c\u6761\u5206\u652f\u662f\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u5206\u652f\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u6839\u636e\u7b2c\u4e00\u6761\u5206\u652f\u7684\u65b9\u5411\u9884\u6d4b\u7684\u7ed3\u679c\uff0c\u51b3\u5b9a\u8981\u7528\u54ea\u6761\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u4f5c\u4e3a\u4e0b\u4e00\u4e2a fetch block \u7684\u5730\u5740\u3002\u867d\u7136\u6709\u538b\u7f29\u80fd\u529b\uff0c\u4f46\u662f\u6ca1\u6709\u63d0\u5230\u5355\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff0c\u6240\u4ee5\u53ea\u662f\u6269\u5927\u4e86\u7b49\u6548 BTB \u5bb9\u91cf\u3002\u548c Zen 1\u3001Zen 2 \u4e00\u6837\u3002</p>\n<blockquote>\n<p>L1BTB has 1024 entries and predicts with zero bubbles for conditional and unconditional direct branches, and one cycle for calls, returns and indirect branches.</p>\n</blockquote>\n<p>Zen 3 \u7684\u7b2c\u4e00\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 1024 \u4e2a entry\uff0c\u4f46\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u662f\u5426\u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u4e5f\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u6570\u91cf\u4ee3\u8868\u4e86\u5b9e\u9645\u7684 entry \u6570\u91cf\u8fd8\u662f\u5206\u652f\u6570\u91cf\uff0c\u540e\u7eed\u4f1a\u505a\u5b9e\u9a8c\u8bc1\u5b9e\uff1b\u9488\u5bf9\u6761\u4ef6\u548c\u65e0\u6761\u4ef6\u76f4\u63a5\u5206\u652f\u7684\u9884\u6d4b\u4e0d\u4ea7\u751f\u6c14\u6ce1\uff0c\u610f\u5473\u7740\u5b83\u7684\u5ef6\u8fdf\u662f\u4e00\u4e2a\u5468\u671f\u3002\u76f8\u6bd4 Zen 2 \u5bb9\u91cf\u7ffb\u500d\uff0c\u4e14\u5ef6\u8fdf\u964d\u4f4e\u4e00\u4e2a\u5468\u671f\uff0c\u731c\u6d4b\u548c\u4f7f\u7528 previous fetch block \u6709\u5173\u3002</p>\n<blockquote>\n<p>L2BTB has 6656 entries and creates three bubbles if its prediction differs from L1BTB.</p>\n</blockquote>\n<p>Zen 3 \u7684\u7b2c\u4e8c\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 6656 \u4e2a entry\uff0c\u4f46\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u662f\u5426\u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u4e5f\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u6570\u91cf\u4ee3\u8868\u4e86\u5b9e\u9645\u7684 entry \u6570\u91cf\u8fd8\u662f\u5206\u652f\u6570\u91cf\uff0c\u540e\u7eed\u4f1a\u505a\u5b9e\u9a8c\u8bc1\u5b9e\uff1b\u9884\u6d4b\u4f1a\u4ea7\u751f\u4e09\u4e2a\u6c14\u6ce1\uff0c\u610f\u5473\u7740\u5b83\u7684\u5ef6\u8fdf\u662f\u56db\u4e2a\u5468\u671f\u3002</p>\n<p>\u7b80\u5355\u6574\u7406\u4e00\u4e0b\u5b98\u65b9\u4fe1\u606f\uff0c\u5927\u6982\u6709\u4e24\u7ea7 BTB\uff1a</p>\n<ul>\n<li>1024-entry L1 BTB, 1 cycle latency</li>\n<li>6656-entry L2 BTB, 4 cycle latency</li>\n</ul>\n<p>\u76f8\u6bd4 Zen 1 \u548c Zen 2 \u6709\u6bd4\u8f83\u5927\u7684\u4e0d\u540c\uff1a\u53bb\u6389\u4e86\u539f\u6765\u5f88\u5c0f\u7684 L0 BTB\uff0c\u6269\u5927\u4e86 L1 BTB\uff0c\u540c\u65f6\u5ef6\u8fdf\u7f29\u77ed\u4e86\u4e00\u4e2a\u5468\u671f\uff1b\u867d\u7136 L2 BTB \u6709\u6240\u7f29\u5c0f\uff0c\u4f46\u662f\u5ef6\u8fdf\u4e5f\u53d8\u77ed\u4e86\u4e00\u4e2a\u5468\u671f\u3002</p>\n<p>\u4e0b\u9762\u7ed3\u5408\u5fae\u67b6\u6784\u6d4b\u8bd5\uff0c\u8fdb\u4e00\u6b65\u7814\u7a76\u5b83\u7684\u5185\u90e8\u7ed3\u6784\u3002</p>\n<h2 id=\"\u5fae\u67b6\u6784\u6d4b\u8bd5\">\u5fae\u67b6\u6784\u6d4b\u8bd5<a class=\"headerlink\" href=\"#\u5fae\u67b6\u6784\u6d4b\u8bd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e4b\u524d\u7684\u535a\u5ba2\u91cc\uff0c\u6211\u4eec\u5df2\u7ecf\u6d4b\u8bd5\u4e86\u5404\u79cd\u5904\u7406\u5668\u7684 BTB\uff0c\u5728\u8fd9\u91cc\u4e5f\u662f\u4e00\u6837\u7684\uff1a\u6309\u7167\u4e00\u5b9a\u7684 stride \u5206\u5e03\u65e0\u6761\u4ef6\u76f4\u63a5\u5206\u652f\uff0c\u6784\u6210\u4e00\u4e2a\u94fe\u6761\uff0c\u7136\u540e\u6d4b\u91cf CPI\u3002</p>\n<p>\u8003\u8651\u5230 Zen 3 \u7684 BTB \u53ef\u80fd\u51fa\u73b0\u4e00\u4e2a entry \u4fdd\u5b58\u4e24\u6761\u5206\u652f\u7684\u60c5\u51b5\uff0c\u5e76\u4e14\u8fd8\u5bf9\u5206\u652f\u7684\u7c7b\u578b\u6709\u8981\u6c42\uff0c\u56e0\u6b64\u4e0b\u9762\u7684\u6d4b\u8bd5\u90fd\u4f1a\u8fdb\u884c\u56db\u7ec4\uff0c\u5206\u522b\u5bf9\u5e94\u56db\u79cd\u5206\u652f\u6a21\u5f0f\uff1a</p>\n<ul>\n<li>uncond\uff1a\u6240\u6709\u5206\u652f\u90fd\u662f\u65e0\u6761\u4ef6\u5206\u652f\uff1auncond, uncond, uncond, uncond, ...</li>\n<li>cond\uff1a\u6240\u6709\u5206\u652f\u90fd\u662f\u6761\u4ef6\u5206\u652f\uff1acond, cond, cond, cond, ...</li>\n<li>mix (uncond + cond)\uff1a\u6761\u4ef6\u5206\u652f\u548c\u65e0\u6761\u4ef6\u5206\u652f\u8f6e\u6d41\u51fa\u73b0\uff0c\u4f46 uncond \u5728\u5148\uff1auncond, cond, uncond, cond, ...</li>\n<li>mix (cond + uncond)\uff1a\u6761\u4ef6\u5206\u652f\u548c\u65e0\u6761\u4ef6\u5206\u652f\u8f6e\u6d41\u51fa\u73b0\uff0c\u4f46 cond \u5728\u5148\uff1acond, uncond, cond, uncond, ...</li>\n</ul>\n<p>\u867d\u7136 Zen 3 \u4f7f\u7528 previous fetch block \u6765\u8bbf\u95ee BTB\uff0c\u4f46\u5728\u8fd9\u51e0\u79cd\u5206\u652f\u6a21\u5f0f\u4e2d\uff0c\u4f7f\u7528 previous fetch block \u8fd8\u662f\u8bbf\u95ee current fetch block\uff0c\u7ed3\u679c\u90fd\u662f\u552f\u4e00\u7684\uff0c\u6240\u4ee5\u5e76\u4e0d\u4f1a\u5bf9\u7ed3\u679c\u5e26\u6765\u5f71\u54cd\u3002</p>\n<h3 id=\"stride4b\">stride=4B<a class=\"headerlink\" href=\"#stride4b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u662f stride=4B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-3-btb-4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u62d0\u70b9\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u662f 4 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94 L1 BTB\uff0c\u6ca1\u6709\u8fbe\u5230\u5b8c\u6574\u5bb9\u91cf\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u5206\u652f\u592a\u8fc7\u5bc6\u96c6</li>\n<li>\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u662f 2048 \u6761\u5206\u652f\uff0cCPI=3.6\uff1b\u7b2c\u4e09\u4e2a\u62d0\u70b9\u662f 4096 \u6761\u5206\u652f\uff0cCPI=4/4.2/4.4</li>\n</ul>\n<p>Zen 3 \u5728 stride=4B \u7684\u60c5\u51b5\u4e0b L1 BTB \u8868\u73b0\u6bd4\u8f83\u4e00\u822c\uff0c\u5e94\u8be5\u662f\u727a\u7272\u4e86\u9ad8\u5bc6\u5ea6\u5206\u652f\u4e0b\u7684\u6027\u80fd\uff1b\u800c\u4e3b\u8981\u547d\u4e2d\u7684\u662f L2 BTB\uff0c\u5728\u4e0d\u540c\u7684\u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u6d4b\u51fa\u6765\u5dee\u4e0d\u591a\u7684\u7ed3\u679c\u3002\u4e3a\u4e86\u9a8c\u8bc1\u8fd9\u4e00\u70b9\uff0c\u7edf\u8ba1\u4e86\u5982\u4e0b\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff08\u6765\u6e90\uff1a<a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/56214-B0-PUB.zip\">Processor Programming Reference (PPR) for AMD Family 19h Model 21h, Revision B0 Processors</a>\uff09\uff1a</p>\n<blockquote>\n<p>PMCx08B [L2 Branch Prediction Overrides Existing Prediction (speculative)] (Core::X86::Pmc::Core::BpL2BTBCorrect)</p>\n</blockquote>\n<p>\u5b83\u4ee3\u8868\u4e86 L2 BTB \u63d0\u4f9b\u9884\u6d4b\uff08\u51c6\u786e\u5730\u8bf4\uff0cL2 BTB \u63d0\u4f9b\u4e86\u9884\u6d4b\u4e14\u548c L1 BTB \u63d0\u4f9b\u7684\u9884\u6d4b\u7ed3\u679c\u4e0d\u540c\uff0c\u8986\u76d6\u4e86 L1 BTB \u7684\u9884\u6d4b\u7ed3\u679c\uff09\u7684\u6b21\u6570\uff0c\u5f53\u5206\u652f\u6570\u4e0d\u5927\u4e8e 4 \u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u8ba1\u6570\u5668\u7684\u503c\u7ea6\u7b49\u4e8e\u96f6\uff1b\u6b64\u540e\u5feb\u901f\u4e0a\u5347\uff0c\u8bf4\u660e\u540e\u7eed\u90fd\u662f L2 BTB \u5728\u63d0\u4f9b\u9884\u6d4b\u3002</p>\n<p>\u66f4\u8fdb\u4e00\u6b65\u89c2\u5bdf\uff0c\u53d1\u73b0 2048 \u5230 4096 \u7684 CPI \u4e0a\u5347\uff0c\u6765\u81ea\u4e8e L1 BTB \u5b8c\u5168\u5931\u6548\uff1a2048 \u6761\u5206\u652f\u65f6\uff0cL1 BTB \u8fd8\u80fd\u63d0\u4f9b\u7ea6 10% \u7684\u9884\u6d4b\uff0c\u6240\u4ee5 CPI=<code>0.1*1+0.9*4=3.7</code>\uff0c\u4f46\u5230 4096 \u6761\u5206\u652f\u7684\u65f6\u5019\uff0c\u5b8c\u5168\u7531 L2 BTB \u63d0\u4f9b\u5206\u652f\uff0c\u6b64\u65f6 CPI=4\u3002</p>\n<p>\u8d85\u8fc7 4096 \u4ee5\u540e\uff0c\u5219 L2 BTB \u4e5f\u5f00\u59cb\u7f3a\u5931\uff0c\u51fa\u73b0\u4e86\u8bd1\u7801\u65f6\u624d\u80fd\u53d1\u73b0\u7684\u5206\u652f\uff0c\u5982\u679c\u8fd9\u662f\u4e00\u6761 uncond \u5206\u652f\uff0c\u90a3\u4e48\u4f1a\u5728\u8bd1\u7801\u65f6\u56de\u6eda\uff0c\u8fd9\u4e00\u70b9\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6027\u80fd\u8ba1\u6570\u5668\u7684\u63d0\u5347\u6765\u8bc1\u660e\uff08\u6765\u6e90\uff1a<a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/56214-B0-PUB.zip\">Processor Programming Reference (PPR) for AMD Family 19h Model 21h, Revision B0 Processors</a>\uff09\uff1a</p>\n<blockquote>\n<p>PMCx091 [Decode Redirects] (Core::X86::Pmc::Core::BpDeReDirect): The number of times the instruction decoder overrides the predicted target.</p>\n</blockquote>\n<p>\u4f46\u5728 L2 BTB \u7f3a\u5931\u540e\uff0c\u5982\u679c\u8bd1\u7801\u5668\u53d1\u73b0\u4e86 cond \u5206\u652f\uff0c\u4f1a\u628a\u5b83\u9884\u6d4b\u4e3a\u4e0d\u8df3\u8f6c\uff0c\u6240\u4ee5\u8981\u7b49\u5230\u6267\u884c\u624d\u80fd\u53d1\u73b0\u5206\u652f\u9884\u6d4b\u9519\u8bef\u3002\u8fd9\u5c31\u5bfc\u81f4\u4e86 cond \u6a21\u5f0f\u4e0b L2 BTB \u6ea2\u51fa\u65f6 CPI=16\uff0c\u800c uncond \u6a21\u5f0f\u4e0b L2 BTB \u6ea2\u51fa\u65f6 CPI=12\uff0c\u63d0\u524d\u5728\u8bd1\u7801\u9636\u6bb5\u53d1\u73b0\u4e86 uncond \u5206\u652f\u5e76\u7ea0\u6b63\u3002</p>\n<p>\u4f46\u8bd1\u7801\u5668\u7684\u7ea0\u6b63\u80fd\u529b\u4e0d\u662f\u4e07\u80fd\u7684\uff1a\u5047\u5982\u5b83\u9996\u5148\u53d1\u73b0\u4e86\u4e00\u6761 cond \u5206\u652f\uff0c\u5728\u5b83\u5176\u540e\u53c8\u53d1\u73b0\u4e86\u4e00\u6761 uncond \u5206\u652f\uff0c\u5b83\u4f1a\u7528 uncond \u5206\u652f\u53bb\u7ea0\u6b63\uff0c\u4f46\u5b9e\u9645\u4e0a\u524d\u9762\u7684 cond \u5206\u652f\u4f1a\u8df3\u8f6c\uff0c\u6240\u4ee5\u6b64\u65f6\u8bd1\u7801\u5668\u7ea0\u6b63\u4e5f\u65e0\u6cd5\u63d0\u5347\u6027\u80fd\uff0c\u5373\u4f7f BpDeReDirect \u8ba1\u6570\u5668\u7684\u503c\u770b\u8d77\u6765\u5f88\u5927\u3002</p>\n<h3 id=\"stride8b\">stride=8B<a class=\"headerlink\" href=\"#stride8b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf stride=8B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-3-btb-8b.png\" /></p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5728\u6240\u6709\u5206\u652f\u6a21\u5f0f\u4e0b\u90fd\u662f 1024 \u4e2a\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94 1024-entry \u7684 L1 BTB</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u4e0d\u592a\u660e\u663e\uff0c\u4f46\u662f\u5728 4096 \u9644\u8fd1\u5728\u6240\u6709\u5206\u652f\u6a21\u5f0f\u4e0b\u90fd\u662f\u4e00\u4e2a\u62d0\u70b9\uff0cCPI=4\uff0c\u5bf9\u5e94 L2 BTB\uff1b\u5728 mix (uncond + cond) \u6a21\u5f0f\u4e0b\uff0c\u8d85\u8fc7 4096 \u5206\u652f\u540e CPI \u7f13\u6162\u4e0a\u5347\uff0c\u5230 6144 \u6761\u5206\u652f CPI=4.25\uff0c\u5230 6656 \u6761\u5206\u652f CPI=4.85\uff0c\u4e4b\u540e CPI \u5feb\u901f\u4e0a\u5347\uff1b\u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\uff0c\u5230 5888 \u6761\u5206\u652f CPI=5\u3002</li>\n</ul>\n<p>L2 BTB \u7684\u5bb9\u91cf\u4e0d\u592a\u786e\u5b9a\uff0c\u8d85\u8fc7 4096 \u540e\u9700\u8981\u4e00\u4e2a entry \u4fdd\u5b58\u4e24\u6761\u5206\u652f\u624d\u80fd\u83b7\u5f97\u66f4\u591a\u5bb9\u91cf\uff0c\u4f46\u4e5f\u5e26\u6765\u4e86\u4e00\u5b9a\u7684\u989d\u5916\u7684\u5ef6\u8fdf\u3002\u4e0e\u6b64\u540c\u65f6 4096 \u4e5f\u5bf9\u5e94\u4e86 32KB ICache \u7684\u5bb9\u91cf\uff0c\u8fd9\u4f1a\u5bf9\u5206\u6790\u5e26\u6765\u5e72\u6270\u3002</p>\n<p>\u4ece BpDeReDirect \u8ba1\u6570\u5668\u6765\u770b\uff0cuncond \u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u5f53\u5206\u652f\u6570\u91cf\u8d85\u8fc7 4096 \u540e\uff0cL2 BTB \u4ece 4096 \u65f6\u65e0\u7f3a\u5931\uff0c\u4e4b\u540e\u7f3a\u5931\u5feb\u901f\u63d0\u5347\uff0c\u8bf4\u660e\u6b64\u65f6 L2 BTB \u5bb9\u91cf\u786e\u5b9e\u662f 4096\u3002\u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\uff0c\u5206\u652f\u6570\u8d85\u8fc7 4096 \u65f6\uff0cBpDeReDirect \u8ba1\u6570\u5668\u7565\u5fae\u4e0a\u5347\uff0c\u76f4\u5230 6144 \u6761\u5206\u652f\u540e\u624d\u6709\u660e\u663e\u7684\u4e0a\u5347\u3002</p>\n<h3 id=\"stride16b\">stride=16B<a class=\"headerlink\" href=\"#stride16b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=16B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-3-btb-16b.png\" /></p>\n<p>\u76f8\u6bd4 stride=8B\uff0cL1 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\u30024096 \u5bf9\u5e94\u7684 CPI \u6709\u6240\u4e0b\u964d\uff0c\u4ece BpL2BTBCorrect \u6027\u80fd\u8ba1\u6570\u5668\u53ef\u4ee5\u53d1\u73b0\u662f L1 BTB \u8d77\u4e86\u4e00\u5b9a\u7684\u4f5c\u7528\u3002\u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\uff0c\u76f4\u5230 5632 \u6761\u5206\u652f\u8fd8\u7ef4\u6301\u4e86 CPI=3.25\uff0c\u4e4b\u540e CPI \u7f13\u6162\u4e0a\u5347\uff0c\u5230 6656 \u6761\u5206\u652f\u65f6 CPI=3.75\uff0c\u5230 6912 \u6761\u5206\u652f\u65f6 CPI=4\u3002</p>\n<p>CPI=3.25 \u53ef\u80fd\u662f\u6765\u81ea\u4e8e 1 \u548c 4 \u7684\u52a0\u6743\u5e73\u5747\uff1a25% \u7684\u65f6\u5019\u662f 1 \u5468\u671f\uff0c75% \u7684\u65f6\u5019\u662f 4 \u5468\u671f\uff0c\u5e73\u5747\u4e0b\u6765\u5c31\u662f <code>1*0.25+4*0.75=3.25</code>\u3002\u8fd9\u610f\u5473\u7740 L1 BTB \u8fd8\u8981\u4fdd\u6301 25% \u7684\u547d\u4e2d\u7387\u3002\u89c2\u5bdf BpL2BTBCorrect \u6027\u80fd\u8ba1\u6570\u5668\uff0c\u53d1\u73b0\u5b83\u7684\u53d6\u503c\u7b49\u4e8e 75% \u7684\u5206\u652f\u6267\u884c\u6b21\u6570\uff0c\u610f\u5473\u7740 L1 BTB \u786e\u5b9e\u63d0\u4f9b\u4e86 25% \u7684\u9884\u6d4b\uff0cL2 BTB \u63d0\u4f9b\u4e86\u5269\u4e0b 75% \u7684\u9884\u6d4b\u3002\u8fd9\u4e00\u70b9\u662f\u633a\u6709\u610f\u601d\u7684\uff0c\u610f\u5473\u7740 L1 BTB \u53ef\u80fd\u91c7\u7528\u4e86\u4e00\u4e9b\u5bf9\u8fd9\u79cd\u5faa\u73af\u8bbf\u95ee\u6a21\u5f0f\u53cb\u597d\u7684\u66ff\u6362\u7b56\u7565\uff1a\u6734\u7d20\u7684 LRU\uff08\u6216\u7c7b LRU\uff09\u66ff\u6362\u7b56\u7565\u4f1a\u5bfc\u81f4 L1 BTB \u51fa\u73b0 100% \u7f3a\u5931\u3002</p>\n<h3 id=\"stride32b\">stride=32B<a class=\"headerlink\" href=\"#stride32b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=32B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-3-btb-32b.png\" /></p>\n<p>\u76f8\u6bd4 stride=16B\uff0cL1 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff0c\u4f46\u662f\u51fa\u73b0\u4e86\u4e00\u4e9b\u6027\u80fd\u6ce2\u52a8\u3002\u6240\u6709\u5206\u652f\u6a21\u5f0f\u4e0b\uff0cL2 BTB \u7684\u62d0\u70b9\u90fd\u51fa\u73b0\u5728 5120\uff0c\u4f46\u6027\u80fd\u6ce2\u52a8\u6bd4\u8f83\u5927\uff0cmix (cond + uncond) \u6a21\u5f0f\u4e0b\u7684 CPI \u8fbe\u5230\u4e86 4.6\u3002\u901a\u8fc7 BpDeReDirect \u6027\u80fd\u8ba1\u6570\u5668\u7684\u53d8\u5316\uff0c\u53ef\u4ee5\u786e\u8ba4\u8fd9\u4e2a\u62d0\u70b9\u786e\u5b9e\u662f\u6765\u81ea\u4e8e L2 BTB \u7684\u7f3a\u5931\u3002</p>\n<p>\u524d\u9762\u63d0\u5230\uff0c\u8bd1\u7801\u5668\u7684\u7ea0\u6b63\u80fd\u529b\u53ef\u80fd\u4f1a\u7ed9\u51fa\u9519\u8bef\u7684\u7b54\u6848\uff0c\u5728 stride=32B \u65f6\uff0c\u5c31\u4f1a\u51fa\u73b0\u4e00\u4e2a\u5f88\u6709\u610f\u601d\u7684\u73b0\u8c61\uff1a</p>\n<ul>\n<li>\u8d85\u51fa L2 BTB \u5bb9\u91cf\u540e\uff0cmix (uncond + cond) \u6a21\u5f0f\u4e0b BpDeReDirect \u5360\u5206\u652f\u6570\u91cf\u7684 50%</li>\n<li>\u8d85\u51fa L2 BTB \u5bb9\u91cf\u540e\uff0cmix (cond + uncond) \u6a21\u5f0f\u4e0b BpDeReDirect \u5360\u5206\u652f\u6570\u91cf\u7684\u63a5\u8fd1 100%</li>\n</ul>\n<p>\u89e3\u91ca\u8d77\u6765\u4e5f\u5e76\u4e0d\u590d\u6742\uff1astride=32B \u7684\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a 64B cacheline \u53ea\u6709\u4e24\u6761\u5206\u652f\uff0c\u90a3\u4e48\uff1a</p>\n<ul>\n<li>mix (uncond + cond) \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e00\u6761\u5206\u652f\u662f uncond\uff0c\u8bd1\u7801\u5668\u4f1a\u53d1\u73b0\u5e76 redirect\uff1b\u7b2c\u4e8c\u6761\u5206\u652f\u662f cond\uff0c\u8bd1\u7801\u5668\u4f1a\u65e0\u89c6\u5b83\uff0c\u4e0d\u8fdb\u884c redirect\uff1b\u6240\u4ee5\u6700\u540e\u662f 50% \u7684 redirect \u6bd4\u4f8b</li>\n<li>mix (cond + uncond) \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e00\u6761\u5206\u652f\u662f cond\uff0c\u8bd1\u7801\u5668\u4f1a\u770b\u5230\u540e\u9762\u7684 uncond \u5206\u652f\u5e76 redirect\uff1b\u7b2c\u4e8c\u6761\u5206\u652f\u662f uncond\uff0c\u8bd1\u7801\u5668\u4f1a\u53d1\u73b0\u5e76 redirect\uff1b\u6240\u4ee5\u6700\u540e\u662f\u63a5\u8fd1 100% \u7684 redirect \u6bd4\u4f8b</li>\n</ul>\n<p>\u987a\u5e26\u4e00\u63d0\uff0cuncond \u6a21\u5f0f\u4e0b\u7684 BpDeReDirect \u5360\u5206\u652f\u6570\u91cf\u7684\u63a5\u8fd1 100%\uff0ccond \u6a21\u5f0f\u4e0b\u7684 BpDeReDirect \u5360\u5206\u652f\u6570\u91cf\u7684 0%\uff0c\u90fd\u662f\u7b26\u5408\u9884\u671f\u7684\u3002</p>\n<h3 id=\"stride64b\">stride=64B<a class=\"headerlink\" href=\"#stride64b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=64B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-3-btb-64b.png\" /></p>\n<p>\u76f8\u6bd4 stride=32B\uff0cL1 BTB \u7684\u5bb9\u91cf\u51cf\u534a\uff0c\u8fbe\u5230\u4e86 512\u3002\u4e4b\u540e\u51fa\u73b0\u4e86\u6bd4\u8f83\u660e\u663e\u7684\u6027\u80fd\u6ce2\u52a8\uff0c\u4f46\u56db\u79cd\u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u62d0\u70b9\u4f9d\u7136\u90fd\u662f\u51fa\u73b0\u5728 5120 \u6761\u5206\u652f\u7684\u4f4d\u7f6e\u3002\u901a\u8fc7 BpDeReDirect \u6027\u80fd\u8ba1\u6570\u5668\u7684\u53d8\u5316\uff0c\u53ef\u4ee5\u786e\u8ba4\u8fd9\u4e2a\u62d0\u70b9\u786e\u5b9e\u662f\u6765\u81ea\u4e8e L2 BTB \u7684\u7f3a\u5931\u3002\u7531\u4e8e uncond \u6a21\u5f0f\u4e0b\uff0cBTB sharing \u4e0d\u4f1a\u5de5\u4f5c\uff0c\u610f\u5473\u7740 L2 BTB \u81f3\u5c11\u6709 5120 \u4e2a entry\u3002</p>\n<h3 id=\"stride128b\">stride=128B<a class=\"headerlink\" href=\"#stride128b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=128B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-3-btb-128b.png\" /></p>\n<p>\u76f8\u6bd4 stride=64B\uff0cL1 BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u51cf\u5c0f\uff0c\u8fbe\u5230\u4e86 256\uff1bL2 BTB \u7684\u6027\u80fd\u4f9d\u7136\u6ce2\u52a8\u5267\u70c8\uff0c\u4f46\u56db\u79cd\u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u62d0\u70b9\u4f9d\u7136\u90fd\u662f\u51fa\u73b0\u5728 5120 \u6761\u5206\u652f\u7684\u4f4d\u7f6e\u3002</p>\n<p>\u8003\u8651\u5230 5120 \u8fd9\u4e2a\u62d0\u70b9\u9891\u7e41\u51fa\u73b0\uff0c\u8ba4\u4e3a L2 BTB \u5728\u4e0d\u8003\u8651 BTB entry sharing \u7684\u60c5\u51b5\u4e0b\uff0c\u5b9e\u9645\u5bb9\u91cf\u5e94\u8be5\u662f 5120\u3002\u90a3\u4e48\u5269\u4e0b\u7684 1536 \u4e2a\u5206\u652f\u5c31\u662f\u6765\u81ea\u4e8e\u538b\u7f29\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6d4b\u8bd5\u5230\u8fd9\u91cc\u5c31\u5dee\u4e0d\u591a\u4e86\uff0c\u66f4\u5927\u7684 stride \u5f97\u5230\u7684\u4e5f\u662f\u7c7b\u4f3c\u7684\u7ed3\u679c\uff0c\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u7684\u53d1\u73b0\uff1a</p>\n<ul>\n<li>L1 BTB \u662f 1024-entry\uff0c1 cycle latency\uff0c\u5bb9\u91cf\u968f\u7740 stride \u53d8\u5316\uff0c\u5927\u6982\u7387\u662f PC[n:5] \u8fd9\u4e00\u6bb5\u88ab\u7528\u4e8e index\uff0c\u4f7f\u5f97 stride=64B \u5f00\u59cb\u5bb9\u91cf\u4e0d\u65ad\u51cf\u534a</li>\n<li>L2 BTB \u662f 5120-entry\uff0c4 cycle latency\uff1b\u5176\u4e2d\u6709 1536 \u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u524d\u63d0\u662f\u8fd9\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a cacheline \u5f53\u4e2d\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u662f cond\uff0c\u7b2c\u4e8c\u6761\u662f uncond</li>\n</ul>\n<h2 id=\"zen-1-\u5230-zen-3-\u7684-btb-\u7684\u5bf9\u6bd4\">Zen 1 \u5230 Zen 3 \u7684 BTB \u7684\u5bf9\u6bd4<a class=\"headerlink\" href=\"#zen-1-\u5230-zen-3-\u7684-btb-\u7684\u5bf9\u6bd4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u662f\u5bf9\u6bd4\u8868\u683c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>uArch</th>\n<th>AMD Zen 1</th>\n<th>AMD Zen 2</th>\n<th>AMD Zen 3</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L0 BTB size</td>\n<td>4+4 branches</td>\n<td>8+8 branches</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>L0 BTB latency</td>\n<td>1 cycle</td>\n<td>1 cycle</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>L1 BTB size</td>\n<td>256 branches</td>\n<td>512 branches</td>\n<td>1024 branches</td>\n</tr>\n<tr>\n<td>L1 BTB latency</td>\n<td>2 cycles</td>\n<td>2 cycles</td>\n<td>1 cycle</td>\n</tr>\n<tr>\n<td>L2 BTB size w/o sharing</td>\n<td>2K branches</td>\n<td>4K branches</td>\n<td>5K branches</td>\n</tr>\n<tr>\n<td>L2 BTB size w/ sharing</td>\n<td>4K branches</td>\n<td>7K branches</td>\n<td>6.5K branches</td>\n</tr>\n<tr>\n<td>L2 BTB latency</td>\n<td>5 cycles</td>\n<td>5 cycles</td>\n<td>4 cycles</td>\n</tr>\n<tr>\n<td>Technology Node</td>\n<td>14nm</td>\n<td>7nm</td>\n<td>7nm</td>\n</tr>\n<tr>\n<td>Release Year</td>\n<td>2017</td>\n<td>2019</td>\n<td>2020</td>\n</tr>\n</tbody>\n</table>\n<p>Zen 3 \u5728 Zen 2 \u7684\u57fa\u7840\u4e0a\uff0c\u6ca1\u6709\u66f4\u6362\u5236\u7a0b\uff0c\u800c\u662f\u901a\u8fc7 previous fetch block \u7684\u65b9\u5f0f\uff0c\u51cf\u5c11 L1 BTB \u7684\u5ef6\u8fdf\u5230 1 cycle\uff0c\u987a\u5e26\u53bb\u6389\u4e86 L0 BTB\u3002L2 BTB \u7684\u5927\u5c0f\u8fdb\u884c\u4e86\u8c03\u6574\uff0c\u51cf\u5c11\u4e86\u5171\u4eab\u7684\u90e8\u5206\uff0c\u800c\u589e\u52a0\u4e86\u4e0d\u9650\u5236\u5206\u652f\u7c7b\u578b\u7684 BTB entry \u6570\u91cf\uff0c\u540c\u65f6\u51cf\u5c11\u4e86\u4e00\u4e2a\u5468\u671f\u7684\u5ef6\u8fdf\uff0c\u4e0d\u786e\u5b9a\u8fd9\u4e2a\u5ef6\u8fdf\u662f\u5355\u7eaf\u901a\u8fc7\u4f18\u5316\u5bb9\u91cf\u5b9e\u73b0\u7684\uff0c\u8fd8\u662f\u8bf4\u4e5f\u4f9d\u8d56\u4e86 previous fetch block \u7684\u65b9\u6cd5\u6765\u51cf\u5c11\u5468\u671f\uff0c\u66f4\u503e\u5411\u4e8e\u662f\u540e\u8005\uff0c\u56e0\u4e3a L1 \u548c L2 BTB \u90fd\u51cf\u5c11\u4e86\u4e00\u4e2a\u5468\u671f\u7684\u5ef6\u8fdf\u3002</p>\n<p>\u5982\u679c\u6309\u7167 Intel \u7684 tick-tock \u8bf4\u6cd5\uff0c\u90a3\u4e48 Zen 2 \u76f8\u6bd4 Zen 1 \u662f\u4e00\u6b21 tick\uff0c\u66f4\u6362\u5236\u7a0b\uff0c\u5fae\u67b6\u6784\u4e0a\u505a\u5c11\u91cf\u6539\u52a8\uff1bZen 3 \u76f8\u6bd4 Zen 2 \u662f\u4e00\u6b21 tock\uff0c\u4e0d\u66f4\u6362\u5236\u7a0b\uff0c\u4f46\u662f\u5728\u5fae\u67b6\u6784\u4e0a\u505a\u8f83\u591a\u6539\u52a8\u3002Zen 4 \u662f 2022 \u5e74\u53d1\u5e03\u7684\uff0c\u4f7f\u7528\u7684\u662f 5nm \u5236\u7a0b\uff1bZen 5 \u662f 2024 \u5e74\u53d1\u5e03\u7684\uff0c\u4f7f\u7528\u7684\u662f 4nm \u5236\u7a0b\u3002\u603b\u7ed3\u4e00\u4e0b\u89c4\u5f8b\uff0cAMD \u4f1a\u82b1\u8d39\u4e24\u5e74\u7684\u65f6\u95f4\u6765\u5347\u7ea7\u5236\u7a0b\uff0c\u5e76\u4e14\u5b9e\u9645\u4e0a\uff0cZen 4 \u548c Zen 5 \u4e0d\u4ec5\u66f4\u65b0\u4e86\u5236\u7a0b\uff0c\u8fd8\u5728\u524d\u7aef\u5fae\u67b6\u6784\u4e0a\u6709\u8f83\u5927\u7684\u6539\u52a8\u3002</p>\n<h2 id=\"amd-zen-3-\u548c-arm-neoverse-v1-\u7684-btb-\u7684\u5bf9\u6bd4\">AMD Zen 3 \u548c ARM Neoverse V1 \u7684 BTB \u7684\u5bf9\u6bd4<a class=\"headerlink\" href=\"#amd-zen-3-\u548c-arm-neoverse-v1-\u7684-btb-\u7684\u5bf9\u6bd4\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD Zen 3 \u548c ARM Neoverse V1 \u90fd\u662f\u5728 2020 \u53d1\u5e03\u7684\u5904\u7406\u5668\uff0c\u4e0b\u9762\u5bf9\u5b83\u4eec\u8fdb\u884c\u4e00\u4e2a\u5bf9\u6bd4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>uArch</th>\n<th>AMD Zen 3</th>\n<th>ARM Neoverse V1</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L1/Nano BTB size</td>\n<td>1024 branches</td>\n<td>48*2 branches</td>\n</tr>\n<tr>\n<td>L1/Nano BTB latency</td>\n<td>1 cycle</td>\n<td>1 cycle</td>\n</tr>\n<tr>\n<td>L1/Nano BTB throughput</td>\n<td>1 branch</td>\n<td>1-2 branches</td>\n</tr>\n<tr>\n<td>L2/Main BTB size w/o sharing</td>\n<td>5K branches</td>\n<td>4K*2 branches</td>\n</tr>\n<tr>\n<td>L2/Main BTB size w/ sharing</td>\n<td>6.5K branches</td>\n<td>4K*2 branches</td>\n</tr>\n<tr>\n<td>L2/Main BTB latency</td>\n<td>4 cycles</td>\n<td>2 cycles</td>\n</tr>\n<tr>\n<td>L2/Main BTB throughput</td>\n<td>1 branch</td>\n<td>1-2 branches</td>\n</tr>\n<tr>\n<td>Technology Node</td>\n<td>7nm</td>\n<td>5nm</td>\n</tr>\n</tbody>\n</table>\n<p>\u867d\u7136 AMD Zen 3 \u901a\u8fc7 previous fetch block \u4f18\u5316\uff0c\u5b9e\u73b0\u4e86 1 cycle \u4e0b\u66f4\u5927\u7684 L1 BTB\uff0c\u4f46\u8fd9\u4e00\u70b9\u5728 2022 \u5e74\u53d1\u5e03\u7684 ARM Neoverse V2 \u4e0a\u88ab\u8ffd\u8d76\uff1aARM Neoverse V2 \u7684 L1/Nano BTB \u4e5f\u505a\u5230\u4e86 1024 \u7684\u5bb9\u91cf\u3002</p>\n<p>\u5728 L2 BTB \u65b9\u9762\uff0cARM Neoverse V1 \u5360\u636e\u4e86\u9886\u5148\uff0c\u65e0\u8bba\u662f\u5ef6\u8fdf\u8fd8\u662f\u5bb9\u91cf\uff1b\u5f53\u7136\u4e86\uff0cARM Neoverse V1 \u7684\u5236\u7a0b\u4e5f\u8981\u66f4\u52a0\u9886\u5148\uff0cARM \u91c7\u7528\u7684 5nm \u5bf9\u6bd4 AMD \u91c7\u7528\u7684 7nm\u3002</p>\n<p>\u66f4\u8fdb\u4e00\u6b65\uff0cARM Neoverse V1 \u5b9e\u73b0\u4e86\u4e00\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff0c\u5373 two taken\uff08ARM \u7684\u8bf4\u6cd5\u662f two predicted branches per cycle\uff09\uff0c\u5728 2 cycle \u7684 Main BTB \u4e0a\u53ef\u4ee5\u5b9e\u73b0\u63a5\u8fd1 AMD Zen 3 \u7684 L1 BTB \u7684\u9884\u6d4b\u541e\u5410\u3002AMD \u4e5f\u4e0d\u7518\u793a\u5f31\uff0c\u5728 2022 \u5e74\u53d1\u5e03\u7684 AMD Zen 4 \u5904\u7406\u5668\u4e0a\uff0c\u5b9e\u73b0\u4e86 two taken\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/amd-zen-3-btb.png", "date_modified": "2025-07-08T00:00:01+00:00", "date_published": "2025-07-08T00:00:01+00:00", "authors": [], "tags": ["amd", "btb", "cpu", "hardware", "zen"]}, {"id": "https://jia.je/hardware/2025/07/08/amd-zen-2-btb/", "url": "https://jia.je/hardware/2025/07/08/amd-zen-2-btb/", "title": "AMD Zen 2 \u7684 BTB \u7ed3\u6784\u5206\u6790", "content_html": "<h1 id=\"amd-zen-2-\u7684-btb-\u7ed3\u6784\u5206\u6790\">AMD Zen 2 \u7684 BTB \u7ed3\u6784\u5206\u6790<a class=\"headerlink\" href=\"#amd-zen-2-\u7684-btb-\u7ed3\u6784\u5206\u6790\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e4b\u524d\uff0c\u6211\u4eec\u5206\u6790\u4e86 <a href=\"../../07/amd-zen-1-btb/\">AMD Zen 1</a> \u7684 BTB\uff0c\u63a5\u4e0b\u6765\u5206\u6790\u5b83\u7684\u4e0b\u4e00\u4ee3\u5fae\u67b6\u6784\uff1a2019 \u5e74\u53d1\u5e03\u7684 AMD Zen 2 \u7684 BTB\uff0c\u770b\u770b AMD \u7684 Zen \u7cfb\u5217\u7684 BTB \u662f\u5982\u4f55\u6f14\u8fdb\u7684\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD \u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/software-optimization-guides/56305.zip\">Software Optimization Guide for AMD EPYC\u2122 7002 Processors (Publication No. 56305)</a> \u4e2d\u6709\u5982\u4e0b\u7684\u8868\u8ff0\uff1a</p>\n<blockquote>\n<p>The branch target buffer (BTB) is a three-level structure accessed using the fetch address of the current fetch block.</p>\n</blockquote>\n<p>Zen 2 \u7684 BTB \u6709\u4e09\u7ea7\uff0c\u662f\u7528\u5f53\u524d fetch block \u7684\u5730\u5740\u53bb\u67e5\u8be2\uff0c\u548c Zen 1 \u4e00\u6837\u3002</p>\n<blockquote>\n<p>Each BTB entry includes information for branches and their targets. Each BTB\nentry can hold up to two branches if the branches reside in the same 64-byte aligned cache line and the first branch is a conditional branch.</p>\n</blockquote>\n<p>Zen 2 \u7684 BTB entry \u6709\u4e00\u5b9a\u7684\u538b\u7f29\u80fd\u529b\uff0c\u4e00\u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u524d\u63d0\u662f\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a 64B \u7f13\u5b58\u884c\u4e2d\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u5206\u652f\u662f\u6761\u4ef6\u5206\u652f\u3002\u8fd9\u6837\uff0c\u5982\u679c\u7b2c\u4e8c\u6761\u5206\u652f\u662f\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u5206\u652f\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u6839\u636e\u7b2c\u4e00\u6761\u5206\u652f\u7684\u65b9\u5411\u9884\u6d4b\u7684\u7ed3\u679c\uff0c\u51b3\u5b9a\u8981\u7528\u54ea\u6761\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u4f5c\u4e3a\u4e0b\u4e00\u4e2a fetch block \u7684\u5730\u5740\u3002\u867d\u7136\u6709\u538b\u7f29\u80fd\u529b\uff0c\u4f46\u662f\u6ca1\u6709\u63d0\u5230\u5355\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff0c\u6240\u4ee5\u53ea\u662f\u6269\u5927\u4e86\u7b49\u6548 BTB \u5bb9\u91cf\u3002\u548c Zen 1 \u4e00\u6837\u3002</p>\n<blockquote>\n<p>L0BTB holds 8 forward taken branches and 8 backward taken branches, and predicts with zero bubbles</p>\n</blockquote>\n<p>Zen 2 \u7684\u7b2c\u4e00\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 8 \u6761\u524d\u5411\u5206\u652f\u548c 8 \u6761\u540e\u5411\u5206\u652f\uff0c\u9884\u6d4b\u4e0d\u4f1a\u5e26\u6765\u6d41\u6c34\u7ebf\u6c14\u6ce1\uff0c\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a\u5468\u671f\u90fd\u53ef\u4ee5\u9884\u6d4b\u4e00\u6b21\u3002\u76f8\u6bd4 Zen 1 \u5bb9\u91cf\u7ffb\u500d\u3002</p>\n<blockquote>\n<p>L1BTB has 512 entries and creates one bubble if prediction differs from L0BTB</p>\n</blockquote>\n<p>Zen 2 \u7684\u7b2c\u4e8c\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 512 \u4e2a entry\uff0c\u4f46\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u662f\u5426\u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u4e5f\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u6570\u91cf\u4ee3\u8868\u4e86\u5b9e\u9645\u7684 entry \u6570\u91cf\u8fd8\u662f\u5206\u652f\u6570\u91cf\uff0c\u540e\u7eed\u4f1a\u505a\u5b9e\u9a8c\u8bc1\u5b9e\uff1b\u9884\u6d4b\u4f1a\u4ea7\u751f\u5355\u4e2a\u6c14\u6ce1\uff0c\u610f\u5473\u7740\u5b83\u7684\u5ef6\u8fdf\u662f\u4e24\u4e2a\u5468\u671f\u3002\u76f8\u6bd4 Zen 1 \u5bb9\u91cf\u7ffb\u500d\u3002</p>\n<blockquote>\n<p>L2BTB has 7168 entries and creates four bubbles if its prediction differs from L1BTB.</p>\n</blockquote>\n<p>Zen 2 \u7684\u7b2c\u4e09\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 7168 \u4e2a entry\uff0c\u4f46\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u662f\u5426\u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u4e5f\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u6570\u91cf\u4ee3\u8868\u4e86\u5b9e\u9645\u7684 entry \u6570\u91cf\u8fd8\u662f\u5206\u652f\u6570\u91cf\uff0c\u540e\u7eed\u4f1a\u505a\u5b9e\u9a8c\u8bc1\u5b9e\uff1b\u9884\u6d4b\u4f1a\u4ea7\u751f\u56db\u4e2a\u6c14\u6ce1\uff0c\u610f\u5473\u7740\u5b83\u7684\u5ef6\u8fdf\u662f\u4e94\u4e2a\u5468\u671f\u3002</p>\n<p>\u7b80\u5355\u6574\u7406\u4e00\u4e0b\u5b98\u65b9\u4fe1\u606f\uff0c\u5927\u6982\u6709\u4e09\u7ea7 BTB\uff1a</p>\n<ul>\n<li>(8+8)-entry L0 BTB, 1 cycle latency</li>\n<li>512-entry L1 BTB, 2 cycle latency</li>\n<li>7168-entry L2 BTB, 5 cycle latency</li>\n</ul>\n<p>\u4ece\u8868\u8ff0\u6765\u770b\uff0c\u9664\u4e86\u5bb9\u91cf\u4ee5\u5916\u57fa\u672c\u548c Zen 1 \u4e00\u81f4\uff0c\u731c\u6d4b\u662f\u5728 Zen 1 \u7684\u57fa\u7840\u4e0a\u6269\u5927\u4e86\u5bb9\u91cf\u3002</p>\n<p>\u4e0b\u9762\u7ed3\u5408\u5fae\u67b6\u6784\u6d4b\u8bd5\uff0c\u8fdb\u4e00\u6b65\u7814\u7a76\u5b83\u7684\u5185\u90e8\u7ed3\u6784\u3002</p>\n<h2 id=\"\u5fae\u67b6\u6784\u6d4b\u8bd5\">\u5fae\u67b6\u6784\u6d4b\u8bd5<a class=\"headerlink\" href=\"#\u5fae\u67b6\u6784\u6d4b\u8bd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e4b\u524d\u7684\u535a\u5ba2\u91cc\uff0c\u6211\u4eec\u5df2\u7ecf\u6d4b\u8bd5\u4e86\u5404\u79cd\u5904\u7406\u5668\u7684 BTB\uff0c\u5728\u8fd9\u91cc\u4e5f\u662f\u4e00\u6837\u7684\uff1a\u6309\u7167\u4e00\u5b9a\u7684 stride \u5206\u5e03\u65e0\u6761\u4ef6\u76f4\u63a5\u5206\u652f\uff0c\u6784\u6210\u4e00\u4e2a\u94fe\u6761\uff0c\u7136\u540e\u6d4b\u91cf CPI\u3002</p>\n<p>\u8003\u8651\u5230 Zen 2 \u7684 BTB \u53ef\u80fd\u51fa\u73b0\u4e00\u4e2a entry \u4fdd\u5b58\u4e24\u6761\u5206\u652f\u7684\u60c5\u51b5\uff0c\u5e76\u4e14\u8fd8\u5bf9\u5206\u652f\u7684\u7c7b\u578b\u6709\u8981\u6c42\uff0c\u56e0\u6b64\u4e0b\u9762\u7684\u6d4b\u8bd5\u90fd\u4f1a\u8fdb\u884c\u56db\u7ec4\uff0c\u5206\u522b\u5bf9\u5e94\u56db\u79cd\u5206\u652f\u6a21\u5f0f\uff1a</p>\n<ul>\n<li>uncond\uff1a\u6240\u6709\u5206\u652f\u90fd\u662f\u65e0\u6761\u4ef6\u5206\u652f\uff1auncond, uncond, uncond, uncond, ...</li>\n<li>cond\uff1a\u6240\u6709\u5206\u652f\u90fd\u662f\u6761\u4ef6\u5206\u652f\uff1acond, cond, cond, cond, ...</li>\n<li>mix (uncond + cond)\uff1a\u6761\u4ef6\u5206\u652f\u548c\u65e0\u6761\u4ef6\u5206\u652f\u8f6e\u6d41\u51fa\u73b0\uff0c\u4f46 uncond \u5728\u5148\uff1auncond, cond, uncond, cond, ...</li>\n<li>mix (cond + uncond)\uff1a\u6761\u4ef6\u5206\u652f\u548c\u65e0\u6761\u4ef6\u5206\u652f\u8f6e\u6d41\u51fa\u73b0\uff0c\u4f46 cond \u5728\u5148\uff1acond, uncond, cond, uncond, ...</li>\n</ul>\n<h3 id=\"stride4b\">stride=4B<a class=\"headerlink\" href=\"#stride4b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u662f stride=4B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-2-btb-4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u6240\u6709\u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e00\u4e2a\u53f0\u9636\u90fd\u662f\u5230 8 \u6761\u5206\u652f\uff0cCPI=1\uff0c8 \u5bf9\u5e94\u4e86 8-entry \u7684 L0 BTB</li>\n<li>\u6240\u6709\u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e8c\u4e2a\u53f0\u9636\u90fd\u662f\u5230 256 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5bf9\u5e94\u4e86 512-entry \u7684 L1 BTB\uff0c\u53ea\u4f53\u73b0\u51fa\u4e86\u4e00\u534a\u7684\u5bb9\u91cf\uff1b\u4f46\u5728 mix (uncond + cond) \u548c mix (cond + uncond) \u6a21\u5f0f\u4e0b\uff0c\u5206\u652f\u4ece 256 \u5230 512 \u65f6 CPI \u7f13\u6162\u4e0a\u5347\uff0c\u610f\u5473\u7740 L1 BTB \u7684 512-entry \u8fd8\u662f\u53ef\u4ee5\u5b8c\u6574\u8bbf\u95ee\uff0c\u53ea\u662f\u5e26\u6765\u4e86\u4e00\u5b9a\u7684\u5f00\u9500\uff1aCPI \u4ece 2 \u589e\u52a0\u5230\u4e86 2.5</li>\n<li>\u5728 uncond \u548c cond \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 4096 \u6761\u5206\u652f\uff0cCPI=5\uff0c\u5bf9\u5e94 L2 BTB\uff0c\u6ca1\u6709\u663e\u73b0\u51fa\u5b8c\u6574\u7684 7168 \u7684\u5927\u5c0f</li>\n<li>\u5728 mix (uncond + cond) \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e09\u4e2a\u53f0\u9636\u5ef6\u4f38\u5230\u4e86 5120\uff0c\u8d85\u51fa\u4e86 4096\uff0c\u4f9d\u7136\u6ca1\u6709\u663e\u73b0\u51fa\u5b8c\u6574\u7684 7168 \u7684\u5927\u5c0f</li>\n<li>\u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e09\u4e2a\u53f0\u9636\u5ef6\u4f38\u5230\u4e86 7168\uff0c\u663e\u73b0\u51fa\u5b8c\u6574\u7684 7168 \u7684\u5927\u5c0f</li>\n</ul>\n<p>\u548c Zen 1 \u4e0d\u540c\uff0cZen 2 \u7684 L1 BTB \u51fa\u73b0\u4e86\u4e0d\u540c\u6a21\u5f0f\u4e0b\u5bb9\u91cf\u4e0d\u540c\u7684\u60c5\u51b5\uff0c\u539f\u56e0\u672a\u77e5\uff0c\u540e\u7eed\u8fd8\u4f1a\u770b\u5230\u7c7b\u4f3c\u7684\u60c5\u51b5\u3002</p>\n<p>Zen 2 \u7684 L2 BTB \u4f9d\u7136\u662f\u5e26\u6709\u538b\u7f29\u7684\uff0c\u53ea\u6709\u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\u624d\u53ef\u4ee5\u5c3d\u53ef\u80fd\u5730\u7528\u4e0a\u6240\u6709\u7684\u5bb9\u91cf\uff0c\u800c\u5176\u4f59\u7684\u4e09\u79cd\u6a21\u5f0f\u90fd\u6709\u5bb9\u91cf\u4e0a\u7684\u635f\u5931\u3002</p>\n<h3 id=\"stride8b\">stride=8B<a class=\"headerlink\" href=\"#stride8b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf stride=8B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-2-btb-8b.png\" /></p>\n<p>\u73b0\u8c61\u548c stride=4B \u57fa\u672c\u76f8\u540c\uff0cL1 BTB \u4ece 256 \u5230 512 \u90e8\u5206\u7684\u53d8\u5316\u659c\u7387\u6709\u6240\u4e0d\u540c\uff0c\u5176\u4f59\u90e8\u5206\u4e00\u81f4\u3002</p>\n<h3 id=\"stride16b\">stride=16B<a class=\"headerlink\" href=\"#stride16b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=16B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-2-btb-16b.png\" /></p>\n<p>\u76f8\u6bd4 stride=4B/8B\uff0cL0 BTB \u548c L2 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1b\u9664\u4e86 cond \u6a21\u5f0f\u4ee5\u5916\uff0cL1 BTB \u7684\u5bb9\u91cf\u51cf\u534a\u5230\u4e86 128\uff0c\u610f\u5473\u7740 L1 BTB \u91c7\u7528\u4e86\u7ec4\u76f8\u8fde\uff0c\u6b64\u65f6\u6709\u4e00\u534a\u7684 set \u4e0d\u80fd\u88ab\u7528\u4e0a\u3002\u6b64\u5916\uff0c\u6bd4\u8f83\u7279\u522b\u7684\u662f\uff0c\u4ece stride=16B \u5f00\u59cb\uff0cCPI=5 \u7684\u5e73\u53f0\u51fa\u73b0\u4e86\u6ce2\u52a8\uff0cuncond \u6a21\u5f0f\u4e0b CPI \u4ece 5 \u53d8\u5230 4 \u518d\u53d8\u5230\u4e86 5\uff0c\u731c\u6d4b\u6b64\u65f6 L1 BTB \u4e5f\u6709\u4e00\u5b9a\u7684\u6bd4\u4f8b\u4f1a\u4ecb\u5165\u3002</p>\n<h3 id=\"stride32b\">stride=32B<a class=\"headerlink\" href=\"#stride32b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=32B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-2-btb-32b.png\" /></p>\n<p>\u76f8\u6bd4 stride=16B\uff0cL0 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1b\u9664\u4e86 cond \u6a21\u5f0f\u4ee5\u5916\uff0cL1 BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u51cf\u5230\u4e86 64\uff0c\u7b26\u5408\u7ec4\u76f8\u8fde\u7684\u9884\u671f\uff1bL2 BTB \u5728 mix (uncond + cond) \u6a21\u5f0f\u4e0b\u4e0d\u518d\u80fd\u4f53\u73b0\u51fa 5120 \u7684\u5bb9\u91cf\uff0c\u800c\u662f 4096\uff1a\u6b64\u65f6\u5728\u4e00\u4e2a 64B cacheline \u4e2d\u53ea\u6709\u4e24\u6761\u5206\u652f\uff0c\u7b2c\u4e00\u6761\u5206\u652f\u662f uncond\uff0c\u7b2c\u4e8c\u6761\u5206\u652f\u662f cond\uff0c\u4e0d\u6ee1\u8db3 entry \u5171\u4eab\u7684\u6761\u4ef6\uff08\u5fc5\u987b cond + uncond\uff0c\u4e0d\u80fd\u662f uncond + cond\uff09\uff0c\u6b64\u65f6 uncond \u548c cond \u5206\u522b\u4fdd\u5b58\u5728\u4e24\u4e2a entry \u4e2d\uff0c\u6bcf\u4e2a entry \u53ea\u4fdd\u5b58\u4e00\u6761\u5206\u652f\uff0c\u56e0\u6b64 L2 BTB \u53ea\u80fd\u4f53\u73b0\u51fa 4096 \u7684\u5bb9\u91cf\u3002\u800c mix (cond + uncond) \u6a21\u5f0f\u4f9d\u7136\u6ee1\u8db3 entry \u5171\u4eab\u7684\u6761\u4ef6\uff0c\u6240\u4ee5\u4f9d\u7136\u4f53\u73b0\u51fa 7168 \u7684\u5bb9\u91cf\u3002\u7279\u522b\u5730\uff0c\u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\u51fa\u73b0\u4e86\u975e\u5e38\u5267\u70c8\u7684 CPI \u6296\u52a8\uff0c\u53ef\u80fd\u51fa\u73b0\u4e86\u4e00\u4e9b\u9884\u671f\u4e4b\u5916\u7684\u6027\u80fd\u95ee\u9898\u3002</p>\n<h3 id=\"stride64b\">stride=64B<a class=\"headerlink\" href=\"#stride64b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=64B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-2-btb-64b.png\" /></p>\n<p>\u76f8\u6bd4 stride=32B\uff0cL0 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1b\u9664\u4e86 cond \u6a21\u5f0f\u4ee5\u5916\uff0cL1 BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u51cf\u5230\u4e86 32\uff0c\u7b26\u5408\u7ec4\u76f8\u8fde\u7684\u9884\u671f\uff0c\u4f46 cond \u6a21\u5f0f\u4e0b\u4f9d\u7136\u4fdd\u6301\u4e86 512 \u7684\u5bb9\u91cf\uff1bL2 BTB \u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\u53ea\u80fd\u4f53\u73b0\u51fa 4096 \u7684\u5bb9\u91cf\uff0c\u6b64\u65f6\u6bcf\u4e2a 64B cacheline \u90fd\u53ea\u6709\u4e00\u6761\u5206\u652f\uff0c\u4e0d\u6ee1\u8db3\u4e24\u6761\u5206\u652f\u5171\u4eab\u4e00\u4e2a entry \u7684\u6761\u4ef6\u3002</p>\n<h3 id=\"stride128b\">stride=128B<a class=\"headerlink\" href=\"#stride128b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=128B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-2-btb-128b.png\" /></p>\n<p>\u76f8\u6bd4 stride=64B\uff0cL0 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1b\u9664\u4e86 cond \u6a21\u5f0f\u4ee5\u5916\uff0cL1 BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u51cf\u5230\u4e86 16\uff0c\u7b26\u5408\u7ec4\u76f8\u8fde\u7684\u9884\u671f\uff0c\u800c cond \u6a21\u5f0f\u4e0b L1 BTB \u5bb9\u91cf\u4e5f\u51cf\u5c11\u5230\u4e86 256\uff1bL2 BTB \u7684\u5bb9\u91cf\u51cf\u534a\u5230\u4e86 2048\uff0c\u610f\u5473\u7740 L2 BTB \u4e5f\u662f\u7ec4\u76f8\u8fde\u7ed3\u6784\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6d4b\u8bd5\u5230\u8fd9\u91cc\u5c31\u5dee\u4e0d\u591a\u4e86\uff0c\u66f4\u5927\u7684 stride \u5f97\u5230\u7684\u4e5f\u662f\u7c7b\u4f3c\u7684\u7ed3\u679c\uff0c\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u7684\u53d1\u73b0\uff1a</p>\n<ul>\n<li>L0 BTB \u662f (8+8)-entry\uff0c1 cycle latency\uff0c\u4e0d\u968f\u7740 stride \u53d8\u5316\uff0c\u5168\u76f8\u8fde</li>\n<li>L1 BTB \u662f 512-entry\uff0c2 cycle latency\uff0c\u5bb9\u91cf\u968f\u7740 stride \u53d8\u5316\uff0c\u5927\u6982\u7387\u662f PC[n:3] \u8fd9\u4e00\u6bb5\u88ab\u7528\u4e8e index\uff0c\u4f7f\u5f97 stride=16B \u5f00\u59cb\u5bb9\u91cf\u4e0d\u65ad\u51cf\u534a\uff1b\u4f46 cond \u6a21\u5f0f\u4e0b\u7684\u884c\u4e3a\u548c\u5176\u4f59\u51e0\u79cd\u6a21\u5f0f\u4e0d\u540c\uff0c\u76f4\u5230 stride=128B \u624d\u5f00\u59cb\u5bb9\u91cf\u51cf\u534a</li>\n<li>L2 BTB \u662f 4096-entry\uff0c5 cycle latency\uff0c\u5bb9\u91cf\u968f\u7740 stride \u53d8\u5316\uff0c\u5927\u6982\u7387\u662f PC[n:6] \u8fd9\u4e00\u6bb5\u88ab\u7528\u4e8e index\uff0c\u4f7f\u5f97 stride=128B \u5f00\u59cb\u5bb9\u91cf\u4e0d\u65ad\u51cf\u534a\uff1b\u5176\u4e2d\u6709 3072 \u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u524d\u63d0\u662f\u8fd9\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a cacheline \u5f53\u4e2d\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u662f cond\uff0c\u7b2c\u4e8c\u6761\u662f uncond\uff1b\u56e0\u6b64\u6700\u591a\u4fdd\u5b58 7168 \u6761\u5206\u652f</li>\n</ul>\n<h2 id=\"zen-1-\u548c-zen-2-\u7684-btb-\u7684\u5bf9\u6bd4\">Zen 1 \u548c Zen 2 \u7684 BTB \u7684\u5bf9\u6bd4<a class=\"headerlink\" href=\"#zen-1-\u548c-zen-2-\u7684-btb-\u7684\u5bf9\u6bd4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u662f\u5bf9\u6bd4\u8868\u683c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>uArch</th>\n<th>AMD Zen 1</th>\n<th>AMD Zen 2</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L0 BTB size</td>\n<td>4+4 branches</td>\n<td>8+8 branches</td>\n</tr>\n<tr>\n<td>L0 BTB latency</td>\n<td>1 cycle</td>\n<td>1 cycle</td>\n</tr>\n<tr>\n<td>L1 BTB size</td>\n<td>256 branches</td>\n<td>512 branches</td>\n</tr>\n<tr>\n<td>L1 BTB latency</td>\n<td>2 cycles</td>\n<td>2 cycles</td>\n</tr>\n<tr>\n<td>L2 BTB size w/o sharing</td>\n<td>2K branches</td>\n<td>4K branches</td>\n</tr>\n<tr>\n<td>L2 BTB size w/ sharing</td>\n<td>4K branches</td>\n<td>7K branches</td>\n</tr>\n<tr>\n<td>L2 BTB latency</td>\n<td>5 cycles</td>\n<td>5 cycles</td>\n</tr>\n<tr>\n<td>Technology Node</td>\n<td>14nm</td>\n<td>7nm</td>\n</tr>\n<tr>\n<td>Release Year</td>\n<td>2017</td>\n<td>2019</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u89c1 Zen 2 \u5728\u5bb9\u91cf\u4e0a\u505a\u4e86\u4e00\u5b9a\u7684\u6269\u5c55\uff0c\u4f46\u673a\u5236\u4e0a\u6bd4\u8f83\u7c7b\u4f3c\uff1b\u7279\u522b\u5730\uff0c\u53ef\u80fd\u662f\u89c2\u5bdf\u5230 cond + uncond \u7684\u538b\u7f29\u80fd\u591f\u751f\u6548\u7684\u6bd4\u4f8b\u6ca1\u6709\u90a3\u4e48\u9ad8\uff0c\u6240\u4ee5\u53ea\u5141\u8bb8\u5176\u4e2d\u4e00\u90e8\u5206 entry \u88ab\u538b\u7f29\uff0c\u4f8b\u5982 4 \u8def\u7ec4\u76f8\u8fde\uff0c\u53ea\u6709\u524d 3 \u4e2a way \u662f\u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff1b\u5269\u4e0b\u7684\u4e00\u4e2a way \u53ea\u80fd\u4fdd\u5b58\u4e00\u6761\u5206\u652f\u3002</p>\n<h2 id=\"amd-zen-2-\u548c-arm-neoverse-n1-\u7684-btb-\u7684\u5bf9\u6bd4\">AMD Zen 2 \u548c ARM Neoverse N1 \u7684 BTB \u7684\u5bf9\u6bd4<a class=\"headerlink\" href=\"#amd-zen-2-\u548c-arm-neoverse-n1-\u7684-btb-\u7684\u5bf9\u6bd4\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD Zen 2 \u548c ARM Neoverse N1 \u90fd\u662f\u5728 2019 \u53d1\u5e03\u7684\u5904\u7406\u5668\uff0c\u4e0b\u9762\u5bf9\u5b83\u4eec\u8fdb\u884c\u4e00\u4e2a\u5bf9\u6bd4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>uArch</th>\n<th>AMD Zen 2</th>\n<th>ARM Neoverse N1</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L0/Nano BTB size</td>\n<td>8+8 branches</td>\n<td>16 branches</td>\n</tr>\n<tr>\n<td>L0/Nano BTB latency</td>\n<td>1 cycle</td>\n<td>1 cycle</td>\n</tr>\n<tr>\n<td>L1/Micro BTB size</td>\n<td>512 branches</td>\n<td>64 branches</td>\n</tr>\n<tr>\n<td>L1/Micro BTB latency</td>\n<td>2 cycles</td>\n<td>2 cycles</td>\n</tr>\n<tr>\n<td>L2/Main BTB size w/o sharing</td>\n<td>4K branches</td>\n<td>3K*2 branches</td>\n</tr>\n<tr>\n<td>L2/Main BTB size w/ sharing</td>\n<td>7K branches</td>\n<td>3K*2 branches</td>\n</tr>\n<tr>\n<td>L2/Main BTB latency</td>\n<td>5 cycles</td>\n<td>2-3 cycles</td>\n</tr>\n<tr>\n<td>Technology Node</td>\n<td>7nm</td>\n<td>7nm</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u89c1 AMD Zen 2 \u5728 BTB \u5bb9\u91cf\u4e0a\u6709\u4f18\u52bf\uff0c\u4f46\u662f\u5ef6\u8fdf\u8981\u66f4\u957f\uff1b\u4e24\u8005\u90fd\u5728\u6700\u540e\u4e00\u7ea7 BTB \u4e0a\u505a\u4e86\u538b\u7f29\uff0c\u4f46\u662f\u538b\u7f29\u7684\u65b9\u6cd5\u548c\u76ee\u7684\u4e0d\u540c\uff1a</p>\n<ul>\n<li>AMD Zen 2 \u7684\u538b\u7f29\u65b9\u6cd5\u662f\uff0c\u628a\u540c\u4e00\u4e2a 64B cacheline \u5185\u4e00\u6761 cond \u548c\u4e00\u6761 uncond \u6307\u4ee4\u653e\u5728\u540c\u4e00\u4e2a entry \u5f53\u4e2d\u3002\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\uff0c\u5f53\u9884\u6d4b\u5230 cond \u5206\u652f\u4e0d\u8df3\u8f6c\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u76f4\u63a5\u6839\u636e uncond \u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u5f97\u5230\u4e0b\u4e00\u4e2a fetch block \u7684\u5730\u5740\uff1b\u4f46\u662f\u4e5f\u5bf9\u4ee3\u7801\u7684\u7ed3\u6784\u6709\u8981\u6c42\uff0c\u5fc5\u987b\u662f\u5728\u540c\u4e00\u4e2a cacheline \u4e2d\uff0c\u4f9d\u6b21\u51fa\u73b0\u4e00\u4e2a cond \u548c\u4e00\u4e2a uncond</li>\n<li>ARM Neoverse N1 \u7684\u538b\u7f29\u65b9\u6cd5\u662f\uff0c\u6839\u636e\u7acb\u5373\u6570\u8303\u56f4\u5bf9\u5206\u652f\u8fdb\u884c\u5206\u7c7b\uff0c\u5982\u679c\u5206\u652f\u7684\u7acb\u5373\u6570\u8303\u56f4\u6bd4\u8f83\u5c0f\uff0c\u5c31\u53ea\u5360\u7528\u4e00\u4e2a entry \u7684\u4e00\u534a\u4e5f\u5c31\u662f 41 bit\uff1b\u5982\u679c\u5206\u652f\u7684\u7acb\u5373\u6570\u8303\u56f4\u8fc7\u5927\uff0c\u5c31\u5360\u7528\u4e00\u4e2a\u5b8c\u6574\u7684 82 bit \u7684 entry\uff1b\u8fd9\u4e3b\u8981\u662f\u4e00\u4e2a\u51cf\u5c11 SRAM \u5360\u7528\u7684\u4f18\u5316\uff0c\u907f\u514d\u4e86\u6240\u6709\u7684\u5206\u652f\u90fd\u8981\u8bb0\u5f55\u5b8c\u6574\u7684 82 bit \u4fe1\u606f\uff1b\u5bf9\u4ee3\u7801\u7684\u7ed3\u6784\u8981\u6c42\u6bd4\u8f83\u5c0f\uff0c\u53ea\u8981\u662f\u8df3\u8f6c\u8ddd\u79bb\u4e0d\u592a\u8fdc\u7684\u5206\u652f\uff0c\u90fd\u53ef\u4ee5\u5b58\u5230 41 bit \u5185</li>\n</ul>\n<p>\u4e8c\u8005\u90fd\u6ca1\u6709\u5b9e\u73b0\u4e00\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff0c\u5373 two taken\uff08ARM \u7684\u8bf4\u6cd5\u662f two predicted branches per cycle\uff09\u3002\u8fd9\u8981\u7b49\u5230 2020 \u5e74\u7684 ARM Neoverse N2/V1\uff0c\u6216\u8005 2022 \u5e74\u7684 AMD Zen 4 \u624d\u88ab\u5b9e\u73b0\u3002</p>\n<p>\u6ce8\u610f\u5230 AMD \u7684 <a href=\"https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/software-optimization-guides/56305.zip\">Software Optimization Guide for AMD EPYC\u2122 7002 Processors (Publication No. 56305)</a> \u6587\u6863\u91cc\uff0c\u6709\u8fd9\u4e48\u4e00\u6bb5\u8868\u8ff0\uff1a</p>\n<blockquote>\n<p>Branches whose target crosses a half-megabyte aligned boundary are unable to be installed in the L0 BTB or to share BTB entries with other branches.</p>\n</blockquote>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u4e24\u4e2a\u5206\u652f\u8981\u5171\u4eab\u4e00\u4e2a BTB entry\uff0c\u90a3\u4e48\u5b83\u4eec\u7684\u76ee\u7684\u5730\u5740\u4e0d\u80fd\u8de8\u8d8a 512KB \u8fb9\u754c\uff0c\u4e5f\u5c31\u662f\u548c\u5206\u652f\u5730\u5740\u7684\u504f\u79fb\u91cf\u4e0d\u8d85\u8fc7 19 \u4f4d\u3002\u6309 48 \u4f4d\u865a\u62df\u5730\u5740\u8ba1\u7b97\uff0c\u5982\u679c BTB entry \u53ea\u8bb0\u5f55\u4e00\u6761\u5206\u652f\uff0c\u6700\u591a\u9700\u8981\u8bb0\u5f55\u76ee\u7684\u5730\u5740\u7684\u5b8c\u6574 48 \u4f4d\u5730\u5740\uff1b\u5982\u679c\u73b0\u5728 BTB entry \u8981\u5b58\u4e24\u6761\u5206\u652f\uff0c\u8fd9\u4e24\u6761\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u90fd\u53ea\u9700\u8981\u8bb0\u5f55 19 \u4f4d\uff0c\u52a0\u8d77\u6765\u4e5f\u5c31 38 \u4f4d\uff0c\u8fd8\u53ef\u4ee5\u7a7a\u4f59 10 \u4f4d\u7684\u4fe1\u606f\u7528\u6765\u7ef4\u62a4 BTB sharing \u6240\u9700\u7684\u989d\u5916\u4fe1\u606f\u3002</p>\n<p>\u6240\u4ee5\u8bf4\u5230\u5e95\uff0c\u65e0\u8bba\u662f AMD \u8fd8\u662f ARM\uff0c\u505a\u7684\u4e8b\u60c5\u90fd\u662f\u5bf9\u4e00\u4e2a\u56fa\u5b9a\u957f\u5ea6\u7684 entry \u8bbe\u7f6e\u4e86\u4e0d\u540c\u7684\u683c\u5f0f\uff0c\u4e00\u4e2a\u683c\u5f0f\u4fdd\u5b58\u7684\u5730\u5740\u4f4d\u6570\u591a\uff0c\u4f46\u662f\u53ea\u80fd\u4fdd\u5b58\u4e00\u4e2a\u5206\u652f\uff1b\u53e6\u4e00\u4e2a\u683c\u5f0f\u4fdd\u5b58\u7684\u5730\u5740\u4f4d\u6570\u5c11\uff0c\u4f46\u662f\u53ef\u4ee5\u4fdd\u5b58\u4e24\u4e2a\u5206\u652f\u3002\u533a\u522b\u5c31\u662f AMD \u5bf9\u4e24\u4e2a\u5206\u652f\u7684\u7c7b\u578b\u548c\u4f4d\u7f6e\u6709\u8981\u6c42\uff0c\u800c ARM \u5141\u8bb8\u8fd9\u4e24\u4e2a\u5206\u652f\u6beb\u65e0\u5173\u7cfb\u3002\u8fd9\u5c31\u662f\u4e0d\u540c\u5382\u5546\u7684\u53d6\u820d\u4e86\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/amd-zen-2-btb.png", "date_modified": "2025-07-08T00:00:00+00:00", "date_published": "2025-07-08T00:00:00+00:00", "authors": [], "tags": ["amd", "btb", "cpu", "hardware", "zen"]}, {"id": "https://jia.je/hardware/2025/07/07/amd-zen-1-btb/", "url": "https://jia.je/hardware/2025/07/07/amd-zen-1-btb/", "title": "AMD Zen 1 \u7684 BTB \u7ed3\u6784\u5206\u6790", "content_html": "<h1 id=\"amd-zen-1-\u7684-btb-\u7ed3\u6784\u5206\u6790\">AMD Zen 1 \u7684 BTB \u7ed3\u6784\u5206\u6790<a class=\"headerlink\" href=\"#amd-zen-1-\u7684-btb-\u7ed3\u6784\u5206\u6790\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD Zen 1 \u662f AMD \u5728 2017 \u5e74\u53d1\u5e03\u7684 Zen \u7cfb\u5217\u7b2c\u4e00\u4ee3\u5fae\u67b6\u6784\u3002\u5728\u4e4b\u524d\uff0c\u6211\u4eec\u5206\u6790\u4e86 ARM Neoverse <a href=\"../../../06/05/arm-neoverse-n1-btb/\">N1</a> \u548c <a href=\"../../../06/23/arm-neoverse-v1-btb/\">V1</a> \u7684 BTB\uff0c\u90a3\u4e48\u73b0\u5728\u4e5f\u628a\u89c6\u7ebf\u8f6c\u5230 AMD \u4e0a\uff0c\u770b\u770b AMD \u7684 Zen \u7cfb\u5217\u7684 BTB \u662f\u5982\u4f55\u6f14\u8fdb\u7684\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD \u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/55723_3_01_0.zip\">Software Optimization Guide for AMD Family 17h Processors (Publication No. 55723)</a> \u4e2d\u6709\u5982\u4e0b\u7684\u8868\u8ff0\uff1a</p>\n<blockquote>\n<p>The branch target buffer (BTB) is a three-level structure accessed using the fetch address of the current fetch block.</p>\n</blockquote>\n<p>Zen 1 \u7684 BTB \u6709\u4e09\u7ea7\uff0c\u662f\u7528\u5f53\u524d fetch block \u7684\u5730\u5740\u53bb\u67e5\u8be2\u3002</p>\n<blockquote>\n<p>Each BTB entry includes information for branches and their targets. Each BTB entry can hold up to two branches if the branches reside in the same 64-byte aligned cache line and the first branch is a conditional branch.</p>\n</blockquote>\n<p>Zen 1 \u7684 BTB entry \u6709\u4e00\u5b9a\u7684\u538b\u7f29\u80fd\u529b\uff0c\u4e00\u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u524d\u63d0\u662f\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a 64B \u7f13\u5b58\u884c\u4e2d\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u5206\u652f\u662f\u6761\u4ef6\u5206\u652f\u3002\u8fd9\u6837\uff0c\u5982\u679c\u7b2c\u4e8c\u6761\u5206\u652f\u662f\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u5206\u652f\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u6839\u636e\u7b2c\u4e00\u6761\u5206\u652f\u7684\u65b9\u5411\u9884\u6d4b\u7684\u7ed3\u679c\uff0c\u51b3\u5b9a\u8981\u7528\u54ea\u6761\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u4f5c\u4e3a\u4e0b\u4e00\u4e2a fetch block \u7684\u5730\u5740\u3002\u867d\u7136\u6709\u538b\u7f29\u80fd\u529b\uff0c\u4f46\u662f\u6ca1\u6709\u63d0\u5230\u5355\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff0c\u6240\u4ee5\u53ea\u662f\u6269\u5927\u4e86\u7b49\u6548 BTB \u5bb9\u91cf\u3002</p>\n<p>\u4f8b\u5982\uff0c\u6709\u8fd9\u4e48\u4e00\u6bb5\u4ee3\u7801\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\"># fetch block entrypoint</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"nl\">entrypoint:</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"c1\"># do something</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"nf\">jnz</span><span class=\"w\"> </span><span class=\"no\">targetA</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"c1\"># do something</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"no\">targetB</span>\n</span></code></pre></div>\n<p>\u90a3\u4e48 jnz \u548c jmp \u6307\u4ee4\u53ef\u4ee5\u653e\u5230\u540c\u4e00\u4e2a entry \u5f53\u4e2d\uff0c\u4e00\u6b21\u8bfb\u51fa\u6765\uff0c\u7136\u540e\u5bf9 jnz \u6307\u4ee4\u8fdb\u884c\u5206\u652f\u65b9\u5411\u9884\u6d4b\uff1a</p>\n<ul>\n<li>\u5982\u679c jnz \u9884\u6d4b\u4e3a\u8df3\u8f6c\uff0c\u90a3\u4e48\u5f53\u524d fetch block \u4ece entrypoint \u5f00\u59cb\uff0c\u5230 jnz \u7ed3\u675f\uff1b\u4e0b\u4e00\u4e2a fetch block \u4ece targetA \u5f00\u59cb</li>\n<li>\u5982\u679c jnz \u9884\u6d4b\u4e3a\u4e0d\u8df3\u8f6c\uff0c\u90a3\u4e48\u5f53\u524d fetch block \u4ece entrypoint \u5f00\u59cb\uff0c\u5230 jmp \u7ed3\u675f\uff1b\u4e0b\u4e00\u4e2a fetch block \u4ece targetB \u5f00\u59cb</li>\n</ul>\n<blockquote>\n<p>L0BTB holds 4 forward taken branches and 4 backward taken branches, and predicts with zero bubbles.</p>\n</blockquote>\n<p>Zen 1 \u7684\u7b2c\u4e00\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 4 \u6761\u524d\u5411\u5206\u652f\u548c 4 \u6761\u540e\u5411\u5206\u652f\uff0c\u9884\u6d4b\u4e0d\u4f1a\u5e26\u6765\u6d41\u6c34\u7ebf\u6c14\u6ce1\uff0c\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a\u5468\u671f\u90fd\u53ef\u4ee5\u9884\u6d4b\u4e00\u6b21\u3002</p>\n<blockquote>\n<p>L1BTB has 256 entries and creates one bubble if prediction differs from L0BTB.</p>\n</blockquote>\n<p>Zen 1 \u7684\u7b2c\u4e8c\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 256 \u4e2a entry\uff0c\u4f46\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u662f\u5426\u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u4e5f\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u6570\u91cf\u4ee3\u8868\u4e86\u5b9e\u9645\u7684 entry \u6570\u91cf\u8fd8\u662f\u5206\u652f\u6570\u91cf\uff0c\u540e\u7eed\u4f1a\u505a\u5b9e\u9a8c\u8bc1\u5b9e\uff1b\u9884\u6d4b\u4f1a\u4ea7\u751f\u5355\u4e2a\u6c14\u6ce1\uff0c\u610f\u5473\u7740\u5b83\u7684\u5ef6\u8fdf\u662f\u4e24\u4e2a\u5468\u671f\u3002</p>\n<blockquote>\n<p>L2BTB has 4096 entries and creates four bubbles if its prediction differs from L1BTB.</p>\n</blockquote>\n<p>Zen 1 \u7684\u7b2c\u4e09\u7ea7 BTB \u53ef\u4ee5\u4fdd\u5b58 4096 \u4e2a entry\uff0c\u4f46\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u662f\u5426\u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u4e5f\u4e0d\u786e\u5b9a\u8fd9\u4e2a entry \u6570\u91cf\u4ee3\u8868\u4e86\u5b9e\u9645\u7684 entry \u6570\u91cf\u8fd8\u662f\u5206\u652f\u6570\u91cf\uff0c\u540e\u7eed\u4f1a\u505a\u5b9e\u9a8c\u8bc1\u5b9e\uff1b\u9884\u6d4b\u4f1a\u4ea7\u751f\u56db\u4e2a\u6c14\u6ce1\uff0c\u610f\u5473\u7740\u5b83\u7684\u5ef6\u8fdf\u662f\u4e94\u4e2a\u5468\u671f\u3002</p>\n<p>\u7b80\u5355\u6574\u7406\u4e00\u4e0b\u5b98\u65b9\u4fe1\u606f\uff0c\u5927\u6982\u6709\u4e09\u7ea7 BTB\uff1a</p>\n<ul>\n<li>(4+4)-entry L0 BTB, 1 cycle latency</li>\n<li>256-entry L1 BTB, 2 cycle latency</li>\n<li>4096-entry L2 BTB, 5 cycle latency</li>\n</ul>\n<p>\u4e0b\u9762\u7ed3\u5408\u5fae\u67b6\u6784\u6d4b\u8bd5\uff0c\u8fdb\u4e00\u6b65\u7814\u7a76\u5b83\u7684\u5185\u90e8\u7ed3\u6784\u3002</p>\n<h2 id=\"\u5fae\u67b6\u6784\u6d4b\u8bd5\">\u5fae\u67b6\u6784\u6d4b\u8bd5<a class=\"headerlink\" href=\"#\u5fae\u67b6\u6784\u6d4b\u8bd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e4b\u524d\u7684\u535a\u5ba2\u91cc\uff0c\u6211\u4eec\u5df2\u7ecf\u6d4b\u8bd5\u4e86\u5404\u79cd\u5904\u7406\u5668\u7684 BTB\uff0c\u5728\u8fd9\u91cc\u4e5f\u662f\u4e00\u6837\u7684\uff1a\u6309\u7167\u4e00\u5b9a\u7684 stride \u5206\u5e03\u65e0\u6761\u4ef6\u76f4\u63a5\u5206\u652f\uff0c\u6784\u6210\u4e00\u4e2a\u94fe\u6761\uff0c\u7136\u540e\u6d4b\u91cf CPI\u3002</p>\n<p>\u8003\u8651\u5230 Zen 1 \u7684 BTB \u53ef\u80fd\u51fa\u73b0\u4e00\u4e2a entry \u4fdd\u5b58\u4e24\u6761\u5206\u652f\u7684\u60c5\u51b5\uff0c\u5e76\u4e14\u8fd8\u5bf9\u5206\u652f\u7684\u7c7b\u578b\u6709\u8981\u6c42\uff0c\u56e0\u6b64\u4e0b\u9762\u7684\u6d4b\u8bd5\u90fd\u4f1a\u8fdb\u884c\u56db\u7ec4\uff0c\u5206\u522b\u5bf9\u5e94\u56db\u79cd\u5206\u652f\u6a21\u5f0f\uff1a</p>\n<ul>\n<li>uncond\uff1a\u6240\u6709\u5206\u652f\u90fd\u662f\u65e0\u6761\u4ef6\u5206\u652f\uff1auncond, uncond, uncond, uncond, ...</li>\n<li>cond\uff1a\u6240\u6709\u5206\u652f\u90fd\u662f\u6761\u4ef6\u5206\u652f\uff1acond, cond, cond, cond, ...</li>\n<li>mix (uncond + cond)\uff1a\u6761\u4ef6\u5206\u652f\u548c\u65e0\u6761\u4ef6\u5206\u652f\u8f6e\u6d41\u51fa\u73b0\uff0c\u4f46 uncond \u5728\u5148\uff1auncond, cond, uncond, cond, ...</li>\n<li>mix (cond + uncond)\uff1a\u6761\u4ef6\u5206\u652f\u548c\u65e0\u6761\u4ef6\u5206\u652f\u8f6e\u6d41\u51fa\u73b0\uff0c\u4f46 cond \u5728\u5148\uff1acond, uncond, cond, uncond, ...</li>\n</ul>\n<h3 id=\"stride4b\">stride=4B<a class=\"headerlink\" href=\"#stride4b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u662f stride=4B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-1-btb-4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u6240\u6709\u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e00\u4e2a\u53f0\u9636\u90fd\u662f\u5230 4 \u6761\u5206\u652f\uff0cCPI=1.25\uff0c\u6bd4 1 \u5468\u671f\u7565\u9ad8\uff0c\u731c\u6d4b\u662f\u56e0\u4e3a\u5faa\u73af\u4f53\u6bd4\u8f83\u5c0f\uff0c\u5faa\u73af\u7ed3\u675f\u7684\u64cd\u4f5c\u7684\u5f00\u9500\u6ca1\u6709\u5e73\u644a\u9020\u6210\u7684\uff1b4 \u5bf9\u5e94\u4e86 4-entry \u7684 L0 BTB</li>\n<li>\u6240\u6709\u5206\u652f\u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e8c\u4e2a\u53f0\u9636\u90fd\u662f\u5230 256 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5bf9\u5e94\u4e86 256-entry \u7684 L1 BTB\uff0c\u610f\u5473\u7740 L1 BTB \u6ca1\u6709\u505a\u4e00\u4e2a BTB entry \u8bb0\u5f55\u4e24\u6761\u5206\u652f\u7684\u4f18\u5316\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f 256 \u4e2a entry \u4fdd\u5b58 256 \u6761\u5206\u652f</li>\n<li>\u5728 uncond \u548c cond \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 2048 \u6761\u5206\u652f\uff0cCPI=5\uff0c\u5bf9\u5e94 L2 BTB\uff0c\u6ca1\u6709\u663e\u73b0\u51fa\u5b8c\u6574\u7684 4096 \u7684\u5927\u5c0f\uff0c\u610f\u5473\u7740 L2 BTB \u5b9e\u9645\u4e0a\u53ea\u6709 2048 \u4e2a entry\uff0c\u6bcf\u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u800c uncond \u548c cond \u6a21\u5f0f\u4e0b\uff0c\u4e0d\u6ee1\u8db3\u6bcf\u4e2a entry \u4fdd\u5b58\u4e24\u6761\u5206\u652f\u7684\u6761\u4ef6\uff0c\u6240\u4ee5\u53ea\u4fdd\u5b58\u4e86 2048 \u6761\u5206\u652f</li>\n<li>\u5728 mix (uncond + cond) \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e09\u4e2a\u53f0\u9636\u4e00\u76f4\u5ef6\u4f38\u5230\u4e86 3072\uff0c\u8d85\u51fa\u4e86 2048\uff0c\u610f\u5473\u7740\u51fa\u73b0\u4e86\u4e24\u6761\u5206\u652f\u4fdd\u5b58\u5728\u4e00\u4e2a entry \u7684\u60c5\u51b5\uff0c\u4f46\u5e76\u6ca1\u6709\u4f53\u73b0\u51fa\u5b8c\u6574\u7684 4096 \u6761\u5206\u652f\u7684\u5927\u5c0f</li>\n<li>\u5728 mix (cond + uncond) \u6a21\u5f0f\u4e0b\uff0c\u7b2c\u4e09\u4e2a\u53f0\u9636\u5ef6\u4f38\u5230\u4e86 4096\uff0c\u4f53\u73b0\u51fa\u5b8c\u6574\u7684 4096 \u7684 L2 BTB \u5927\u5c0f</li>\n</ul>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\uff0c\u8fc7\u4e86 L2 BTB \u5bb9\u91cf\u4ee5\u540e\uff0c\u6027\u80fd\u9aa4\u964d\u5230\u5341\u591a\u4e2a cycle\uff0c\u6b64\u65f6\u8fd8\u6ca1\u6709\u8d85\u51fa L1 ICache \u5bb9\u91cf\uff0c\u8fd9\u4e48\u957f\u7684\u5ef6\u8fdf\uff0c\u5373\u4f7f\u662f\u5728 uncond \u6a21\u5f0f\u4e0b\uff0c\u53ef\u4ee5\u5728\u8bd1\u7801\u7684\u65f6\u5019\u53d1\u73b0 uncond \u5206\u652f\u5e76 redirect\uff0c\u4e5f\u8981 16+ \u4e2a\u5468\u671f\uff0c\u53ef\u89c1\u5176\u6d41\u6c34\u7ebf\u4e4b\u957f\u3002</p>\n<h3 id=\"stride8b\">stride=8B<a class=\"headerlink\" href=\"#stride8b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf stride=8B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-1-btb-8b.png\" /></p>\n<p>\u73b0\u8c61\u548c stride=4B \u57fa\u672c\u76f8\u540c\uff0c\u5404\u7ea7 BTB \u663e\u73b0\u51fa\u6765\u7684\u5927\u5c0f\u6ca1\u6709\u53d8\u5316\u3002</p>\n<h3 id=\"stride16b\">stride=16B<a class=\"headerlink\" href=\"#stride16b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=16B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-1-btb-16b.png\" /></p>\n<p>\u76f8\u6bd4 stride=4B/8B\uff0cL0 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1bL1 BTB \u7684\u5bb9\u91cf\u51cf\u534a\u5230\u4e86 128\uff0c\u610f\u5473\u7740 L1 BTB \u91c7\u7528\u4e86\u7ec4\u76f8\u8fde\uff0c\u6b64\u65f6\u6709\u4e00\u534a\u7684 set \u4e0d\u80fd\u88ab\u7528\u4e0a\u3002\u6b64\u5916\uff0c\u6bd4\u8f83\u7279\u522b\u7684\u662f\uff0c\u4ece stride=16B \u5f00\u59cb\uff0cCPI=5 \u7684\u5e73\u53f0\u51fa\u73b0\u4e86\u6ce2\u52a8\uff0cCPI \u4ece 5 \u53d8\u5230 4 \u518d\u53d8\u5230\u4e86 5\uff0c\u731c\u6d4b\u6b64\u65f6 L1 BTB \u4e5f\u6709\u4e00\u5b9a\u7684\u6bd4\u4f8b\u4f1a\u4ecb\u5165\u3002L2 BTB \u5728 mix (uncond + cond) \u6a21\u5f0f\u4e0b\uff0c\u62d0\u70b9\u4ece 3072 \u524d\u79fb\u5230 2560\u3002</p>\n<h3 id=\"stride32b\">stride=32B<a class=\"headerlink\" href=\"#stride32b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=32B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-1-btb-32b.png\" /></p>\n<p>\u76f8\u6bd4 stride=16B\uff0cL0 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1bL1 BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u51cf\u5230\u4e86 64\uff0c\u7b26\u5408\u7ec4\u76f8\u8fde\u7684\u9884\u671f\uff1bL2 BTB \u5728 mix (uncond + cond) \u6a21\u5f0f\u4e0b\u4e0d\u518d\u80fd\u4f53\u73b0\u51fa 3072 \u7684\u5bb9\u91cf\uff0c\u800c\u662f 2048\uff1a\u6b64\u65f6\u5728\u4e00\u4e2a 64B cacheline \u4e2d\u53ea\u6709\u4e24\u6761\u5206\u652f\uff0c\u7b2c\u4e00\u6761\u5206\u652f\u662f uncond\uff0c\u7b2c\u4e8c\u6761\u5206\u652f\u662f cond\uff0c\u4e0d\u6ee1\u8db3 entry \u5171\u4eab\u7684\u6761\u4ef6\uff08\u5fc5\u987b cond + uncond\uff0c\u4e0d\u80fd\u662f uncond + cond\uff09\uff0c\u6b64\u65f6 uncond \u548c cond \u5206\u522b\u4fdd\u5b58\u5728\u4e24\u4e2a entry \u4e2d\uff0c\u6bcf\u4e2a entry \u53ea\u4fdd\u5b58\u4e00\u6761\u5206\u652f\uff0c\u56e0\u6b64 L2 BTB \u53ea\u80fd\u4f53\u73b0\u51fa 2048 \u7684\u5bb9\u91cf\u3002\u800c mix (cond + uncond) \u6a21\u5f0f\u4f9d\u7136\u6ee1\u8db3 entry \u5171\u4eab\u7684\u6761\u4ef6\uff0c\u6240\u4ee5\u4f9d\u7136\u4f53\u73b0\u51fa 4096 \u7684\u5bb9\u91cf\u3002</p>\n<h3 id=\"stride64b\">stride=64B<a class=\"headerlink\" href=\"#stride64b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=64B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-1-btb-64b.png\" /></p>\n<p>\u76f8\u6bd4 stride=32B\uff0cL0 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1bL1 BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u51cf\u5230\u4e86 32\uff0c\u7b26\u5408\u7ec4\u76f8\u8fde\u7684\u9884\u671f\uff1bL2 BTB \u5728  mix (cond + uncond) \u6a21\u5f0f\u4e0b\u53ea\u80fd\u4f53\u73b0\u51fa 2048 \u7684\u5bb9\u91cf\uff0c\u6b64\u65f6\u6bcf\u4e2a 64B cacheline \u90fd\u53ea\u6709\u4e00\u6761\u5206\u652f\uff0c\u4e0d\u6ee1\u8db3\u4e24\u6761\u5206\u652f\u5171\u4eab\u4e00\u4e2a entry \u7684\u6761\u4ef6\u3002</p>\n<h3 id=\"stride128b\">stride=128B<a class=\"headerlink\" href=\"#stride128b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=128B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd-zen-1-btb-128b.png\" /></p>\n<p>\u76f8\u6bd4 stride=64B\uff0cL0 BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1bL1 BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u51cf\u5230\u4e86 16\uff0c\u7b26\u5408\u7ec4\u76f8\u8fde\u7684\u9884\u671f\uff1bL2 BTB \u7684\u5bb9\u91cf\u51cf\u534a\u5230\u4e86 1024\uff0c\u610f\u5473\u7740 L2 BTB \u4e5f\u662f\u7ec4\u76f8\u8fde\u7ed3\u6784\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6d4b\u8bd5\u5230\u8fd9\u91cc\u5c31\u5dee\u4e0d\u591a\u4e86\uff0c\u66f4\u5927\u7684 stride \u5f97\u5230\u7684\u4e5f\u662f\u7c7b\u4f3c\u7684\u7ed3\u679c\uff0c\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u7684\u53d1\u73b0\uff1a</p>\n<ul>\n<li>L0 BTB \u662f (4+4)-entry\uff0c1 cycle latency\uff0c\u4e0d\u968f\u7740 stride \u53d8\u5316\uff0c\u5168\u76f8\u8fde</li>\n<li>L1 BTB \u662f 256-entry\uff0c2 cycle latency\uff0c\u5bb9\u91cf\u968f\u7740 stride \u53d8\u5316\uff0c\u5927\u6982\u7387\u662f PC[n:3] \u8fd9\u4e00\u6bb5\u88ab\u7528\u4e8e index\uff0c\u4f7f\u5f97 stride=16B \u5f00\u59cb\u5bb9\u91cf\u4e0d\u65ad\u51cf\u534a</li>\n<li>L2 BTB \u662f 2048-entry\uff0c5 cycle latency\uff0c\u5bb9\u91cf\u968f\u7740 stride \u53d8\u5316\uff0c\u5927\u6982\u7387\u662f PC[n:6] \u8fd9\u4e00\u6bb5\u88ab\u7528\u4e8e index\uff0c\u4f7f\u5f97 stride=128B \u5f00\u59cb\u5bb9\u91cf\u4e0d\u65ad\u51cf\u534a\uff1b\u6bcf\u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0c\u524d\u63d0\u662f\u8fd9\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a cacheline \u5f53\u4e2d\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u662f cond\uff0c\u7b2c\u4e8c\u6761\u662f uncond\uff1b\u56e0\u6b64\u6700\u591a\u4fdd\u5b58 4096 \u4e2a\u5206\u652f</li>\n</ul>\n<p>\u4e5f\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u53d1\u73b0\u4e86\u5404\u79cd\u6ca1\u6709\u89e3\u91ca\u7684\u9057\u7559\u95ee\u9898\uff1a</p>\n<ul>\n<li>stride=4B/8B/16B \u4e14\u4e3a mix (uncond + cond) \u6a21\u5f0f\u65f6\uff0cL2 BTB \u4f53\u73b0\u51fa 3072/3072/2560 \u7684\u5bb9\u91cf\uff0c\u800c\u975e 4096\uff1a\u89e3\u6790\u89c1\u540e</li>\n<li>L2 BTB \u5bf9\u5e94\u7684 CPI=5 \u7684\u53f0\u9636\u51fa\u73b0\u6bd4\u8f83\u660e\u663e\u7684\uff0c\u5728 4-5 \u4e4b\u95f4\u7684\u6ce2\u52a8\uff1a\u6682\u65e0\u89e3\u91ca</li>\n</ul>\n<p>\u63a5\u4e0b\u6765\u5c1d\u8bd5\u89e3\u6790\u4e00\u4e0b\u8fd9\u4e9b\u9057\u7559\u95ee\u9898\u80cc\u540e\u7684\u539f\u7406\u3002\u90e8\u5206\u9057\u7559\u95ee\u9898\uff0c\u5e76\u6ca1\u6709\u88ab\u89e3\u91ca\u51fa\u6765\uff0c\u6b22\u8fce\u8bfb\u8005\u63d0\u51fa\u731c\u60f3\u3002</p>\n<h2 id=\"\u89e3\u6790\u9057\u7559\u95ee\u9898\">\u89e3\u6790\u9057\u7559\u95ee\u9898<a class=\"headerlink\" href=\"#\u89e3\u6790\u9057\u7559\u95ee\u9898\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"stride4b8b16b-\u4e14\u4e3a-mix-uncond--cond-\u6a21\u5f0f\u65f6l2-btb-\u4f53\u73b0\u51fa-307230722560-\u7684\u5bb9\u91cf\u800c\u975e-4096\">stride=4B/8B/16B \u4e14\u4e3a mix (uncond + cond) \u6a21\u5f0f\u65f6\uff0cL2 BTB \u4f53\u73b0\u51fa 3072/3072/2560 \u7684\u5bb9\u91cf\uff0c\u800c\u975e 4096<a class=\"headerlink\" href=\"#stride4b8b16b-\u4e14\u4e3a-mix-uncond--cond-\u6a21\u5f0f\u65f6l2-btb-\u4f53\u73b0\u51fa-307230722560-\u7684\u5bb9\u91cf\u800c\u975e-4096\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u6d4b\u8bd5\u51fa\u6765\uff0c\u89c2\u5bdf\u5230\u4e24\u4e2a\u5947\u602a\u7684\u5bb9\u91cf\uff1a3072 \u548c 2560\uff0c\u5206\u522b\u6709 3 \u548c 5 \u7684\u56e0\u5b50\u3002\u4e0b\u9762\u901a\u8fc7\u8fdb\u4e00\u6b65\u7684\u5b9e\u9a8c\uff0c\u89c2\u5bdf\u5b83\u7684\u6765\u6e90\u3002</p>\n<h4 id=\"stride16b-\u5bf9\u5e94-2560-\u7684-l2-btb-\u5bb9\u91cf\">stride=16B \u5bf9\u5e94 2560 \u7684 L2 BTB \u5bb9\u91cf<a class=\"headerlink\" href=\"#stride16b-\u5bf9\u5e94-2560-\u7684-l2-btb-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9996\u5148\u9488\u5bf9\u8fd9\u4e2a 2560 \u7684\u62d0\u70b9\uff0c\u505a\u4e86\u4e00\u7cfb\u5217\u6d4b\u8bd5\uff0c\u5728 stride=16B \u7684\u60c5\u51b5\u4e0b\uff0c\u6d4b\u8bd5\u4e0d\u540c\u7684 uncond/cond \u5206\u652f\u7684\u7ec4\u5408\uff0c\u4e0b\u9762\u662f 64B cacheline \u5185\u56db\u6761\u5206\u652f\u7684\u7c7b\u578b\u7684\u4e0d\u540c\u7ec4\u5408\uff08U \u4ee3\u8868 Uncond\uff0cC \u4ee3\u8868 Cond\uff09\uff0c\u4ee5\u53ca\u8be5\u7ec4\u5408\u5bf9\u5e94\u7684\u5bb9\u91cf\uff1a</p>\n<ul>\n<li>CCCC: 2048\uff08\u5373 cond \u6a21\u5f0f\uff09</li>\n<li>CCCU: 2560</li>\n<li>CCUC: 2560</li>\n<li>CCUU: 2560</li>\n<li>CUCC: 2560</li>\n<li>CUCU: 4096\uff08\u5373 mix (cond + uncond) \u6a21\u5f0f\uff09</li>\n<li>CUUC: 2560</li>\n<li>CUUU: 2560</li>\n<li>UCCC: 2048</li>\n<li>UCCU: 2560</li>\n<li>UCUC: 2560\uff08\u5373 mix (uncond + cond) \u6a21\u5f0f\uff09</li>\n<li>UCUU: 2560</li>\n<li>UUCC: 2048</li>\n<li>UUCU: 2560</li>\n<li>UUUC: 2048</li>\n<li>UUUU: 2048\uff08\u5373 uncond \u6a21\u5f0f\uff09</li>\n</ul>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\uff0c\u5982\u679c\u6ca1\u6709\u51fa\u73b0\u8fde\u7eed\u7684 CU\uff08CCCC/UCCC/UUCC/UUUC/UUUU\uff09\uff0c\u5bb9\u91cf\u662f 2048\uff1b\u5982\u679c\u51fa\u73b0\u4e86\u4e00\u7ec4 CU\uff08CC<strong>CU</strong>/C<strong>CU</strong>C/C<strong>CU</strong>U/<strong>CU</strong>CC/<strong>CU</strong>UC/<strong>CU</strong>UU/UC<strong>CU</strong>/U<strong>CU</strong>C/U<strong>CU</strong>U/UU<strong>CU</strong>\uff09\uff0c\u5bb9\u91cf\u662f 2560\uff1b\u51fa\u73b0\u4e86\u4e24\u7ec4 CU\uff08<strong>CUCU</strong>\uff09\uff0c\u5c31\u662f mix (cond + uncond) \u6a21\u5f0f\uff0c\u5bb9\u91cf\u662f 4096\u3002</p>\n<p>\u4e00\u79cd\u53ef\u80fd\u7684\u731c\u60f3\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6ca1\u6709\u51fa\u73b0\u8fde\u7eed\u7684 CU\uff0c\u90a3\u4e48\u6bcf\u4e2a branch \u5360\u7528\u4e00\u4e2a entry\uff0c\u90a3\u4e48\u5bb9\u91cf\u5c31\u662f 2048 \u4e2a branch</li>\n<li>\u5982\u679c\u51fa\u73b0\u4e86\u4e00\u7ec4 CU\uff0c\u90a3\u4e48\u4e00\u4e2a 64B cacheline \u91cc\u7684 4 \u4e2a branch \u5bf9\u5e94 3 \u4e2a entry\uff0c\u90a3\u4e48\u524d 2048 \u4e2a branch \u5bf9\u5e94 1536 \u4e2a entry\uff0c\u8fd8\u5269\u4e0b 512 \u4e2a entry\uff0c\u8fd9\u4e9b entry \u6bcf\u4e2a entry \u53ea\u653e 1 \u4e2a branch\uff08\u8ba8\u8bba\u89c1\u540e\uff09\uff0c\u6240\u4ee5\u6700\u540e\u5bb9\u91cf\u662f <code>2048+512=2560</code> \u4e2a branch</li>\n<li>\u5982\u679c\u51fa\u73b0\u4e86\u4e24\u7ec4 CU\uff0c\u90a3\u4e48\u6bcf\u4e00\u7ec4 CU \u7684\u4e24\u4e2a branch \u5bf9\u5e94\u4e00\u4e2a entry\uff0c\u5bb9\u91cf\u662f 4096 \u4e2a branch</li>\n</ul>\n<p>\u4f46\u662f\u4e5f\u9057\u7559\u4e86\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u53ea\u6709\u4e00\u7ec4 CU \u7684\u60c5\u51b5\u4e0b\uff0c\u4e3a\u5565\u5269\u4e0b\u7684 512 \u4e2a entry \u53ea\u653e 512 \u4e2a branch\uff0c\u800c\u4e0d\u80fd\u653e 1024 \u4e2a branch\uff0c\u6309\u7406\u8bf4\u662f\u53ef\u80fd\u518d\u6b21\u51fa\u73b0 cond + uncond \u5408\u5e76\uff1f\u8fd9\u4e2a\u95ee\u9898\u6682\u65f6\u8fd8\u6ca1\u6709\u89e3\u91ca\u3002</p>\n<p>\u7531\u6b64\u53ef\u4ee5\u770b\u51fa\uff0c2560 \u7684\u6765\u6e90\u662f 4 \u8def\u7ec4\u76f8\u8fde\uff0c\u7136\u540e\u5176\u4e2d\u4e00\u8def\u53d1\u751f\u4e86 cond + uncond \u7684\u5408\u5e76\uff0c\u6240\u4ee5\u6700\u7ec8\u662f 5 \u4e2a\u5206\u652f\u4fdd\u5b58\u5230 4 \u8def\u5f53\u4e2d\uff0c\u518d\u6765\u4e00\u6761\u5206\u652f\u5c31\u4f1a\u653e\u4e0d\u4e0b\u3002</p>\n<h4 id=\"stride4b8b-\u5bf9\u5e94-3072-\u7684-l2-btb-\u5bb9\u91cf\">stride=4B/8B \u5bf9\u5e94 3072 \u7684 L2 BTB \u5bb9\u91cf<a class=\"headerlink\" href=\"#stride4b8b-\u5bf9\u5e94-3072-\u7684-l2-btb-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5e26\u7740\u4e0a\u9762\u7684\u5206\u6790\uff0c\u518d\u53bb\u89c2\u5bdf stride=4B/8B \u65f6\u7684 3072:3072 \u6709 3 \u7684\u56e0\u5b50\uff0c\u6240\u4ee5\u5927\u6982\u7387\u662f\u4ece 2 \u8def\u7ec4\u76f8\u8fde\u5f97\u6765\uff0c\u5176\u4e2d\u4e00\u8def\u51fa\u73b0\u4e86 cond + uncond \u7684\u5408\u5e76\uff0c\u6240\u4ee5\u51fa\u73b0\u4e86 3 \u4e2a branch \u5360\u7528 2 \u4e2a entry \u7684\u60c5\u51b5\uff0c\u6700\u540e\u4f53\u73b0\u51fa\u6765\u5c31\u662f 3072 \u7684 L2 BTB \u5bb9\u91cf\u3002</p>\n<p>\u4f3c\u4e4e\u5230\u8fd9\u91cc\uff0c3072 \u548c 2560 \u5206\u522b\u7684 3 \u548c 5 \u7684\u56e0\u5b50\u90fd\u80fd\u89e3\u91ca\u4e86\uff0c\u5269\u4e0b\u7684\u5c31\u662f\u89e3\u6790\u5177\u4f53\u7684\u7ec4\u76f8\u8fde\u7684\u7ed3\u6784\u3002</p>\n<h4 id=\"\u7ec4\u76f8\u8fde\u5206\u6790\">\u7ec4\u76f8\u8fde\u5206\u6790<a class=\"headerlink\" href=\"#\u7ec4\u76f8\u8fde\u5206\u6790\" title=\"Permanent link\">&para;</a></h4>\n<p>\u90a3\u4e48\u5230\u5e95\u662f 2 \u8def\u7ec4\u76f8\u8fde\uff0c\u8fd8\u662f 4 \u8def\u7ec4\u76f8\u8fde\u5462\uff0c\u53e6\u5916\u8fd9\u4e2a\u7ec4\u76f8\u8fde\u7684 set \u662f\u600e\u4e48\u6784\u6210\u7684\u5462\uff1f</p>\n<p>\u9996\u5148\u56de\u5fc6\u4e00\u4e0b\uff0c\u5728 <a href=\"../../../06/05/arm-neoverse-n1-btb/\">ARM Neoverse N1</a> \u4e2d\uff0c\u8fde\u7eed\u7684 32B \u5185\u80fd\u653e 6 \u4e2a\u5206\u652f\uff0c\u4f46\u662f stride=8B \u7684\u65f6\u5019\uff0c\u4e00\u6b21\u5c31\u4f1a\u5f80\u540c\u4e00\u4e2a set \u91cc\u589e\u52a0 4 \u4e2a\u5206\u652f\uff0c\u4e8e\u662f\u4e00\u4e2a set \u5185\u7684\u5206\u652f\u6570\u4ece 0 \u53d8\u5230 4 \u518d\u53d8\u5230 8\uff0c\u62d0\u70b9\u51fa\u73b0\u5728 4 \u4e2a\u5206\u652f\uff0c\u800c\u4e0d\u662f 6 \u4e2a\u5206\u652f\u3002\u56e0\u6b64\u4e3a\u4e86\u8fbe\u5230\u524d\u9762\u51fa\u73b0\u7684 3072 \u548c 2560 \u7684\u62d0\u70b9\uff0c\u65b0\u589e\u7684\u5206\u652f\u4e5f\u5f97\u5747\u5300\u5730\u5206\u5230\u5404\u4e2a set \u5f53\u4e2d\u3002</p>\n<p>\u524d\u9762\u6839\u636e L2 BTB \u7684\u5bb9\u91cf\u5206\u6790\u5230\uff0cL2 BTB \u7684 Index \u53ef\u80fd\u662f PC[n:6]\uff0c\u4f46\u80af\u5b9a\u4e0d\u662f\u7b80\u5355\u7684\u8fd9\u4e48\u53d6\uff0c\u5426\u5219\u4e5f\u4f1a\u51fa\u73b0 ARM Neoverse N1 \u7c7b\u4f3c\u7684\u95ee\u9898\u3002\u53ea\u80fd\u8bf4\u660e PC[6] \u5f80\u4e0a\u6709\u82e5\u5e72\u4e2a bit \u662f\u5355\u72ec\u51fa\u73b0\u5728 L2 BTB \u7684 Index \u5f53\u4e2d\u7684\uff0c\u800c PC[5] \u4ee5\u4e0b\u7684 bit\uff0c\u53ef\u80fd\u4ee5\u67d0\u79cd\u54c8\u5e0c\u51fd\u6570\u7684\u5f62\u5f0f\uff0c\u53c2\u4e0e\u5230 Index \u5f53\u4e2d\u3002</p>\n<p>\u6240\u4ee5\uff0cL2 BTB \u53ef\u80fd\u662f\u4ee5 PC[n:6] \u4f5c\u4e3a Index \u53bb\u8bbf\u95ee\uff0c\u7136\u540e\u5185\u90e8\u6709\u591a\u4e2a bank\uff0c\u6bcf\u4e2a bank \u5185\u90e8\u662f 2 \u8def\u7ec4\u76f8\u8fde\u3002bank index \u662f\u901a\u8fc7 PC \u7ecf\u8fc7\u54c8\u5e0c\u8ba1\u7b97\u5f97\u6765\uff0c\u4f7f\u5f97\u5728 stride=4B/8B \u7684\u65f6\u5019\uff0c\u4f53\u73b0\u51fa 2 \u8def\u7ec4\u76f8\u8fde\uff0c\u800c\u5728 stride=16B \u7684\u65f6\u5019\uff0c\u4f53\u73b0\u51fa 4 \u8def\u7ec4\u76f8\u8fde\u3002\u540c\u65f6\uff0c\u5206\u652f\u8fd8\u80fd\u591f\u5747\u5300\u5730\u5206\u5e03\u5230\u5404\u4e2a bank \u5f53\u4e2d\uff0c\u907f\u514d\u4e86\u548c ARM Neoverse N1 \u7c7b\u4f3c\u7684\u60c5\u51b5\u7684\u53d1\u751f\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/amd-zen-1-btb.png", "date_modified": "2025-07-07T00:00:00+00:00", "date_published": "2025-07-07T00:00:00+00:00", "authors": [], "tags": ["amd", "btb", "cpu", "hardware", "zen"]}, {"id": "https://jia.je/hardware/2025/06/23/arm-neoverse-v1-btb/", "url": "https://jia.je/hardware/2025/06/23/arm-neoverse-v1-btb/", "title": "ARM Neoverse V1 (\u4ee3\u53f7 Zeus) \u7684 BTB \u7ed3\u6784\u5206\u6790", "content_html": "<h1 id=\"arm-neoverse-v1-\u4ee3\u53f7-zeus-\u7684-btb-\u7ed3\u6784\u5206\u6790\">ARM Neoverse V1 (\u4ee3\u53f7 Zeus) \u7684 BTB \u7ed3\u6784\u5206\u6790<a class=\"headerlink\" href=\"#arm-neoverse-v1-\u4ee3\u53f7-zeus-\u7684-btb-\u7ed3\u6784\u5206\u6790\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM Neoverse V1 \u662f ARM Neoverse N1 \u7684\u4e0b\u4e00\u4ee3\u670d\u52a1\u5668 CPU\uff0c\u5728 2020 \u5e74\u53d1\u5e03\u3002\u6b64\u524d\u6211\u4eec\u5206\u6790\u8fc7 <a href=\"./\">Neoverse N1 \u7684 BTB \u8bbe\u8ba1</a>\u3002\u800c ARM Neoverse V1 \u5728\u5f88\u591a\u5730\u65b9\u90fd\u548c Cortex-X1 \u7c7b\u4f3c\uff0c\u76f8\u6bd4 Neoverse N1/Cortex-A76 \u6709\u4e86\u4e00\u4e9b\u6539\u8fdb\uff0c\u5728\u8fd9\u91cc\u5bf9\u5b83\u7684 BTB \u505a\u4e00\u4e9b\u5206\u6790\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u6536\u96c6\u4e86\u4e00\u4e9b ARM Neoverse V1 \u7684 BTB \u7ed3\u6784\u7684\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://teratec.eu/library/pdf/forum/2021/A05-03.pdf\">SW defined cars: HPC, from the cloud to the dashboard for an amazing driver experience</a><ul>\n<li>64KB L1 ICache, 2x32B bandwidth</li>\n<li>8K-entry main BTB</li>\n<li>96-entry nano BTB, 0 cycle bubble</li>\n<li>2 stage prediction pipeline: P1 &amp; P2\uff0c\u5927\u6982\u7387 nano BTB \u5728 P1\uff0cmain BTB \u5728 P2</li>\n</ul>\n</li>\n<li><a href=\"https://hc2023.hotchips.org/assets/program/conference/day1/CPU1/HC2023.Arm.MagnusBruce.v04.FINAL.pdf\">Arm Neoverse V2 platform: Leadership Performance and Power Efficiency for Next-Generation Cloud Computing, ML and HPC Workloads</a><ul>\n<li>2 predicted branches per cycle\uff0c\u6bcf\u5468\u671f\u6700\u591a\u9884\u6d4b\u4e24\u6761\u5206\u652f</li>\n</ul>\n</li>\n</ul>\n<p>\u7b80\u5355\u6574\u7406\u4e00\u4e0b\u5b98\u65b9\u4fe1\u606f\uff0c\u5927\u6982\u6709\u4e24\u7ea7 BTB\uff1a</p>\n<ul>\n<li>96-entry nano BTB, 1 cycle latency (0 cycle bubble)</li>\n<li>8K-entry main BTB</li>\n<li>2 predicted branches per cycle</li>\n</ul>\n<p>\u4f46\u662f\u5f88\u591a\u7ec6\u8282\u662f\u7f3a\u5931\u7684\uff0c\u56e0\u6b64\u4e0b\u9762\u7ed3\u5408\u5fae\u67b6\u6784\u6d4b\u8bd5\uff0c\u8fdb\u4e00\u6b65\u7814\u7a76\u5b83\u7684\u5185\u90e8\u7ed3\u6784\u3002</p>\n<h2 id=\"\u5fae\u67b6\u6784\u6d4b\u8bd5\">\u5fae\u67b6\u6784\u6d4b\u8bd5<a class=\"headerlink\" href=\"#\u5fae\u67b6\u6784\u6d4b\u8bd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e4b\u524d\u7684\u535a\u5ba2\u91cc\uff0c\u6211\u4eec\u5df2\u7ecf\u6d4b\u8bd5\u4e86\u5404\u79cd\u5904\u7406\u5668\u7684 BTB\uff0c\u5728\u8fd9\u91cc\u4e5f\u662f\u4e00\u6837\u7684\uff1a\u6309\u7167\u4e00\u5b9a\u7684 stride \u5206\u5e03\u65e0\u6761\u4ef6\uff08uncond\uff09\u6216\u603b\u662f\u8df3\u8f6c\u7684\u6709\u6761\u4ef6\uff08cond\uff09\u76f4\u63a5\u5206\u652f\uff0c\u6784\u6210\u4e00\u4e2a\u94fe\u6761\uff0c\u7136\u540e\u6d4b\u91cf CPI\u3002\u5728\u5148\u524d\u7684 <a href=\"../../05/arm-neoverse-n1-btb/\">Neoverse N1 \u6d4b\u8bd5</a> \u91cc\uff0c\u6211\u4eec\u53ea\u6d4b\u8bd5\u4e86\u65e0\u6761\u4ef6\u5206\u652f\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u5728 Neoverse N1 \u4e0a\u7528\u6761\u4ef6\u5206\u652f\u6d4b\u51fa\u6765\u7684\u7ed3\u679c\u4e5f\u662f\u4e00\u6837\u7684\uff0c\u4f46\u5728 Neoverse V1 \u4e0a\u5c31\u4e0d\u540c\u4e86\uff0c\u6240\u4ee5\u5728\u8fd9\u91cc\u8981\u5206\u5f00\u8ba8\u8bba\u3002</p>\n<h3 id=\"stride4b-uncond\">stride=4B uncond<a class=\"headerlink\" href=\"#stride4b-uncond\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u662f stride=4B uncond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-4b-uncond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230\u63a5\u8fd1 64 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u4f46\u662f\u6ca1\u6709\u4f53\u73b0\u51fa\u5b8c\u6574\u7684 96 \u7684\u5bb9\u91cf</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 16384 \u6761\u5206\u652f\uff0cCPI \u5728 5 \u5230 6 \u4e4b\u95f4\uff0c\u5927\u4e8e main BTB \u7684 2 cycle latency\uff0c\u8bf4\u660e\u6b64\u65f6\u6ca1\u6709\u547d\u4e2d main BTB\uff0c\u800c\u662f\u8981\u7b49\u5230\u53d6\u6307\u548c\u8bd1\u7801\u540e\uff0c\u8ba1\u7b97\u51fa\u6b63\u786e\u7684\u76ee\u7684\u5730\u5740\u518d\u56de\u6eda\uff0c\u5bfc\u81f4\u4e86 5+ cycle latency\uff1b16384 \u5bf9\u5e94 64KB L1 ICache \u5bb9\u91cf</li>\n</ul>\n<p>\u90a3\u4e48 stride=4B uncond \u7684\u60c5\u51b5\u4e0b\u5c31\u9057\u7559\u4e86\u5982\u4e0b\u95ee\u9898\uff1a</p>\n<ol>\n<li>nano BTB \u6ca1\u8868\u73b0\u51fa 96 \u7684\u5bb9\u91cf\uff0c\u53ea\u8868\u73b0\u51fa\u63a5\u8fd1 64 \u7684\u5bb9\u91cf</li>\n<li>\u6ca1\u6709\u89c2\u5bdf\u5230 2 predicted branches per cycle</li>\n<li>\u6ca1\u6709\u547d\u4e2d main BTB</li>\n</ol>\n<h3 id=\"stride4b-cond\">stride=4B cond<a class=\"headerlink\" href=\"#stride4b-cond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=4B cond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-4b-cond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 48 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u4f46\u662f\u6ca1\u6709\u4f53\u73b0\u51fa\u5b8c\u6574\u7684 96 \u7684\u5bb9\u91cf</li>\n<li>\u4e4b\u540e\u6ca1\u6709\u660e\u663e\u7684\u5206\u754c\u70b9\uff0c\u6027\u80fd\u6ce2\u52a8\u5267\u70c8\uff0c\u6ca1\u6709\u89c2\u5bdf\u5230 main BTB \u7684\u53f0\u9636</li>\n</ul>\n<p>nano BTB \u53ea\u8868\u73b0\u51fa 48 \u7684\u5bb9\u91cf\uff0c\u521a\u597d\u662f 96 \u7684\u4e00\u534a\uff1b\u540c\u65f6\u6ca1\u6709\u89c2\u5bdf\u5230 2 predicted branches per cycle\u3002\u8003\u8651\u8fd9\u4e24\u70b9\uff0c\u53ef\u4ee5\u8ba4\u4e3a nano BTB \u7684\u7ec4\u7ec7\u65b9\u5f0f\u548c\u5206\u652f\u7c7b\u578b\u6709\u5173\uff0c\u5f53\u5206\u652f\u8fc7\u4e8e\u5bc6\u96c6\uff08stride=4B\uff09\u6216\u8005\u7528\u6761\u4ef6\u5206\u652f\uff08cond\uff09\u65f6\uff0c\u4e0d\u80fd\u5f97\u5230\u5b8c\u6574\u7684 96-entry \u7684\u5927\u5c0f\uff0c\u6b64\u65f6\u4e5f\u4f1a\u56de\u843d\u5230 CPI=1 \u7684\u60c5\u51b5\u3002</p>\n<p>\u90a3\u4e48 stride=4B cond \u7684\u60c5\u51b5\u4e0b\u5c31\u9057\u7559\u4e86\u5982\u4e0b\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u6ca1\u6709\u547d\u4e2d main BTB</li>\n</ol>\n<h3 id=\"stride8b-uncond\">stride=8B uncond<a class=\"headerlink\" href=\"#stride8b-uncond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=8B uncond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-8b-uncond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 96 \u6761\u5206\u652f\uff0cCPI=0.5\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u4f53\u73b0\u4e86 2 predicted branches per cycle</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 8192 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94 main BTB\uff0c\u6b64\u65f6\u4e5f\u5bf9\u5e94\u4e86 64KB L1 ICache\uff1b\u6b64\u5916\uff0c\u4ece 4096 \u5f00\u59cb\u6709\u7565\u5fae\u7684\u4e0a\u5347</li>\n</ul>\n<p>\u6b64\u65f6 nano BTB \u5b8c\u6574\u5730\u8868\u73b0\u51fa\u4e86\u5b83\u7684 96-entry \u5bb9\u91cf\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86 CPI=0.5 \u7684\u6548\u679c\u3002main BTB \u4e5f\u5b9e\u73b0\u4e86 CPI=1\uff0c\u8003\u8651\u5230\u5b83\u7684\u5bb9\u91cf\u4e0d\u592a\u53ef\u80fd\u5355\u5468\u671f\u7ed9\u51fa\u4e00\u4e2a\u5206\u652f\u7684\u7ed3\u679c\uff0c\u5927\u6982\u7387\u662f\u4e24\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\u6307\u4ee4\u3002</p>\n<p>\u90a3\u4e48 stride=8B uncond \u7684\u60c5\u51b5\u4e0b\u5c31\u9057\u7559\u4e86\u5982\u4e0b\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u4ece 4096 \u6761\u5206\u652f\u5f00\u59cb\u6027\u80fd\u6709\u7565\u5fae\u7684\u4e0b\u964d</li>\n</ol>\n<h3 id=\"stride8b-cond\">stride=8B cond<a class=\"headerlink\" href=\"#stride8b-cond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=8B cond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-8b-cond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 48 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u6ca1\u6709 2 predicted branches per cycle\uff0c\u5bb9\u91cf\u4e5f\u53ea\u6709 96 \u7684\u4e00\u534a</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 8192 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5bf9\u5e94 main BTB\uff0c\u6b64\u65f6\u4e5f\u5bf9\u5e94\u4e86 64KB L1 ICache</li>\n</ul>\n<p>\u548c\u4e4b\u524d\u4e00\u6837\uff0c\u9047\u5230 cond \u5206\u652f\uff0cnano BTB \u7684\u5bb9\u91cf\u53ea\u6709\u4e00\u534a\uff0c\u4e5f\u89c2\u5bdf\u4e0d\u5230 2 predicted branches per cycle\u3002\u53e6\u4e00\u8fb9\uff0cmain BTB \u7684 CPI \u4e5f\u5230\u4e86 2\uff0c\u610f\u5473\u7740\u6b64\u65f6 main BTB \u4e5f\u53ea\u80fd\u4e24\u4e2a\u5468\u671f\u9884\u6d4b\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u548c\u4e4b\u524d\u7684\u5206\u6790\u543b\u5408\u3002</p>\n<p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u7528\u6761\u4ef6\u5206\u652f\uff0c\u5c31\u4e0d\u80fd\u9884\u6d4b\u4e24\u6761\u5206\u652f\u6307\u4ee4\u4e86\u5462\uff1f\u731c\u6d4b\u662f\uff0cBTB \u53ef\u4ee5\u4e00\u6b21\u7ed9\u51fa\u4e24\u6761\u5206\u652f\u7684\u4fe1\u606f\uff0c\u4f46\u662f\u6ca1\u6709\u65f6\u95f4\u53bb\u540c\u65f6\u9884\u6d4b\u8fd9\u4e24\u6761\u5206\u652f\u7684\u65b9\u5411\u3002\u6240\u4ee5\u5c31\u56de\u843d\u5230\u4e86\u666e\u901a\u7684 2 cycle BTB \u60c5\u51b5\u3002</p>\n<h3 id=\"stride16b-uncond\">stride=16B uncond<a class=\"headerlink\" href=\"#stride16b-uncond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=16B uncond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-16b-uncond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 96 \u6761\u5206\u652f\uff0cCPI=0.5\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u4f53\u73b0\u4e86 2 predicted branches per cycle</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 2048 \u6761\u5206\u652f\uff0cCPI=1\uff1b\u7565\u5fae\u4e0a\u5347\u5230 4096\uff0c\u6b64\u65f6\u662f 64KB L1 ICache \u7684\u5bb9\u91cf\uff1b\u5230 8192 \u51fa\u73b0\u660e\u663e\u7a81\u53d8\uff0c\u5bf9\u5e94 main BTB \u5bb9\u91cf</li>\n</ul>\n<p>\u90a3\u4e48 stride=16B uncond \u7684\u60c5\u51b5\u4e0b\u5c31\u9057\u7559\u4e86\u5982\u4e0b\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u4ece 2048 \u6761\u5206\u652f\u5f00\u59cb\u6027\u80fd\u6709\u7565\u5fae\u7684\u4e0b\u964d</li>\n</ol>\n<h3 id=\"stride16b-cond\">stride=16B cond<a class=\"headerlink\" href=\"#stride16b-cond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=16B cond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-16b-cond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 48 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u6ca1\u6709 2 predicted branches per cycle\uff0c\u5bb9\u91cf\u4e5f\u53ea\u6709 96 \u7684\u4e00\u534a</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 8192 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5bf9\u5e94 main BTB</li>\n</ul>\n<p>\u9884\u6d4b\u7684\u6548\u679c\u548c stride=8B cond \u5b8c\u5168\u76f8\u540c\u3002</p>\n<p>\u90a3\u4e48 stride=16B cond \u7684\u60c5\u51b5\u4e0b\u5c31\u9057\u7559\u4e86\u5982\u4e0b\u95ee\u9898\uff1a</p>\n<ol>\n<li>64KB ICache \u5e94\u8be5\u5728 4096 \u6761\u5206\u652f\u5bfc\u81f4\u74f6\u9888\uff0c\u4f46\u662f\u5b9e\u9645\u6ca1\u6709\u89c2\u5bdf\u5230</li>\n</ol>\n<h3 id=\"stride32b-uncond\">stride=32B uncond<a class=\"headerlink\" href=\"#stride32b-uncond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=32B uncond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-32b-uncond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 96 \u6761\u5206\u652f\uff0cCPI=0.5\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u4f53\u73b0\u4e86 2 predicted branches per cycle</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 1024 \u6761\u5206\u652f\uff0cCPI=1\uff1b\u7565\u5fae\u4e0a\u5347\u5230 2048\uff0c\u6b64\u65f6\u662f 64KB L1 ICache \u7684\u5bb9\u91cf\uff1b\u5230 8192 \u53f3\u4fa7\u51fa\u73b0\u660e\u663e\u7a81\u53d8</li>\n</ul>\n<p>\u90a3\u4e48 stride=32B uncond \u7684\u60c5\u51b5\u4e0b\u5c31\u9057\u7559\u4e86\u5982\u4e0b\u95ee\u9898\uff1a</p>\n<ol>\n<li>\u4ece 1024 \u6761\u5206\u652f\u5f00\u59cb\u6027\u80fd\u6709\u7565\u5fae\u7684\u4e0b\u964d</li>\n<li>\u6027\u80fd\u660e\u663e\u4e0b\u964d\u7684\u70b9\u5728 8192 \u53f3\u4fa7\uff0c\u800c\u4e0d\u662f 8192</li>\n</ol>\n<h3 id=\"stride32b-cond\">stride=32B cond<a class=\"headerlink\" href=\"#stride32b-cond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=32B cond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-32b-cond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 48 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u6ca1\u6709 2 predicted branches per cycle\uff0c\u5bb9\u91cf\u4e5f\u53ea\u6709 96 \u7684\u4e00\u534a</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 2048 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5bf9\u5e94 64KB L1 ICache \u5bb9\u91cf\uff0c\u4e4b\u540e\u7f13\u6162\u4e0a\u5347\uff0c\u5230 8192 \u51fa\u73b0\u6027\u80fd\u7a81\u53d8\uff0c\u5bf9\u5e94 main BTB \u5bb9\u91cf</li>\n</ul>\n<p>\u57fa\u672c\u7b26\u5408\u9884\u671f\uff0c\u53ea\u662f\u5728 stride=16B cond \u7684\u57fa\u7840\u4e0a\uff0c\u5f15\u5165\u4e86 64KB L1 ICache \u5bfc\u81f4\u7684\u6027\u80fd\u4e0b\u964d\u3002</p>\n<h3 id=\"stride64b-uncond\">stride=64B uncond<a class=\"headerlink\" href=\"#stride64b-uncond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=64B uncond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-64b-uncond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 96 \u6761\u5206\u652f\uff0cCPI=0.5\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u4f53\u73b0\u4e86 2 predicted branches per cycle</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 1024 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94 64KB L1 ICache \u7684\u5bb9\u91cf</li>\n<li>\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 4096\uff0cCPI=3\uff0c\u5bf9\u5e94 main BTB \u7684\u5bb9\u91cf\uff1bmain BTB \u5bb9\u91cf\u51cf\u534a\uff0c\u610f\u5473\u7740 main BTB \u5e94\u5f53\u662f\u4e2a\u7ec4\u76f8\u8fde\u7ed3\u6784</li>\n</ul>\n<h3 id=\"stride64b-cond\">stride=64B cond<a class=\"headerlink\" href=\"#stride64b-cond\" title=\"Permanent link\">&para;</a></h3>\n<p>stride=64B cond \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-v1-btb-64b-cond.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u5982\u4e0b\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 48 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 96-entry \u7684 nano BTB\uff0c\u6ca1\u6709 2 predicted branches per cycle\uff0c\u5bb9\u91cf\u4e5f\u53ea\u6709 96 \u7684\u4e00\u534a</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 1024 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5bf9\u5e94 64KB L1 ICache \u5bb9\u91cf\uff0c\u4e4b\u540e\u7f13\u6162\u4e0a\u5347\uff0c\u5230 4096 \u51fa\u73b0\u6027\u80fd\u7a81\u53d8\uff0c\u5bf9\u5e94 main BTB \u5bb9\u91cf\uff1bmain BTB \u5bb9\u91cf\u53ea\u6709 8192 \u7684\u4e00\u534a\uff0c\u610f\u5473\u7740\u5b83\u662f\u7ec4\u76f8\u8fde\u7ed3\u6784</li>\n</ul>\n<h3 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6d4b\u8bd5\u5230\u8fd9\u91cc\u5c31\u5dee\u4e0d\u591a\u4e86\uff0c\u66f4\u5927\u7684 stride \u5f97\u5230\u7684\u4e5f\u662f\u7c7b\u4f3c\u7684\u7ed3\u679c\uff0c\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u7684\u53d1\u73b0\uff1a</p>\n<ul>\n<li>nano BTB \u662f 96-entry\uff0c1 cycle latency\uff0c\u5bf9\u4e8e uncond \u5206\u652f\u53ef\u4ee5\u505a\u5230\u4e00\u6b21\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff0c\u5927\u5c0f\u4e0d\u968f\u7740 stride \u53d8\u5316\uff0c\u5bf9\u5e94\u5168\u76f8\u8fde\u7ed3\u6784</li>\n<li>main BTB \u662f 8K-entry\uff0c2 cycle latency\uff0c\u5bf9\u4e8e uncond \u5206\u652f\u53ef\u4ee5\u505a\u5230\u4e00\u6b21\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff0c\u6b64\u65f6\u53ef\u4ee5\u8fbe\u5230 CPI=1\uff1b\u5bb9\u91cf\u968f\u7740 stride \u53d8\u5316\uff0c\u5bf9\u5e94\u7ec4\u76f8\u8fde\u7ed3\u6784</li>\n<li>64KB ICache \u5f88\u591a\u65f6\u5019\u4f1a\u6bd4 main BTB \u66f4\u65e9\u6210\u4e3a\u74f6\u9888</li>\n</ul>\n<p>\u4e5f\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u53d1\u73b0\u4e86\u5404\u79cd\u6ca1\u6709\u89e3\u91ca\u7684\u9057\u7559\u95ee\u9898\uff1a</p>\n<ul>\n<li>cond \u5206\u652f\u60c5\u51b5\u4e0b\uff0c\u6ca1\u6709 2 predicted branches per cycle\uff0c\u6b64\u65f6\u4e24\u7ea7 BTB \u5206\u522b\u53ef\u4ee5\u505a\u5230 CPI=1 \u548c CPI=2\uff0c\u540c\u65f6 nano BTB \u5bb9\u91cf\u51cf\u534a\u5230 48\uff1a\u89e3\u91ca\u89c1\u540e</li>\n<li>stride=4B uncond/cond \u7684\u60c5\u51b5\u4e0b\uff0cmain BTB \u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c\uff1a\u89e3\u91ca\u89c1\u540e</li>\n<li>stride=8B/16B/32B uncond \u7684\u60c5\u51b5\u4e0b\uff0c4096/2048/1024 \u6761\u5206\u652f\u5904\u51fa\u73b0\u4e86\u6027\u80fd\u4e0b\u964d\uff1a\u6682\u65e0\u89e3\u91ca</li>\n<li>stride=32B uncond \u7684\u60c5\u51b5\u4e0b\uff0cmain BTB \u5bfc\u81f4\u7684\u62d0\u70b9\u5e94\u8be5\u5728 8192\uff0c\u4f46\u5b9e\u9645\u4e0a\u5728 8192 \u53f3\u4fa7\uff1a\u6682\u65e0\u89e3\u91ca</li>\n<li>stride=16B cond \u7684\u60c5\u51b5\u4e0b\uff0c64KB ICache \u5e94\u8be5\u5728 4096 \u6761\u5206\u652f\u5bfc\u81f4\u74f6\u9888\uff0c\u4f46\u662f\u5b9e\u9645\u6ca1\u6709\u89c2\u5bdf\u5230\uff1a\u6682\u65e0\u89e3\u91ca</li>\n</ul>\n<p>\u63a5\u4e0b\u6765\u5c1d\u8bd5\u89e3\u6790\u4e00\u4e0b\u8fd9\u4e9b\u9057\u7559\u95ee\u9898\u80cc\u540e\u7684\u539f\u7406\u3002\u90e8\u5206\u9057\u7559\u95ee\u9898\uff0c\u5e76\u6ca1\u6709\u88ab\u89e3\u91ca\u51fa\u6765\uff0c\u6b22\u8fce\u8bfb\u8005\u63d0\u51fa\u731c\u60f3\u3002</p>\n<h2 id=\"\u89e3\u6790\u9057\u7559\u95ee\u9898\">\u89e3\u6790\u9057\u7559\u95ee\u9898<a class=\"headerlink\" href=\"#\u89e3\u6790\u9057\u7559\u95ee\u9898\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"cond-\u5206\u652f\u60c5\u51b5\u4e0b\u6ca1\u6709-2-predicted-branches-per-cycle\u540c\u65f6-nano-btb-\u53ea\u6709-48-\u7684\u5bb9\u91cf\">cond \u5206\u652f\u60c5\u51b5\u4e0b\uff0c\u6ca1\u6709 2 predicted branches per cycle\uff0c\u540c\u65f6 nano BTB \u53ea\u6709 48 \u7684\u5bb9\u91cf<a class=\"headerlink\" href=\"#cond-\u5206\u652f\u60c5\u51b5\u4e0b\u6ca1\u6709-2-predicted-branches-per-cycle\u540c\u65f6-nano-btb-\u53ea\u6709-48-\u7684\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6bd4\u8f83\u76f8\u540c stride \u4e0b\uff0ccond \u548c uncond \u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u770b\u5230\uff0ccond \u60c5\u51b5\u4e0b\u4e24\u7ea7 BTB \u7684 CPI \u90fd\u7ffb\u500d\uff0c\u8fd9\u610f\u5473\u7740\uff0c\u5f53\u9047\u5230\u5168\u662f cond \u5206\u652f\u65f6\uff0c\u5927\u6982\u662f\u56e0\u4e3a\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u5e26\u5bbd\u95ee\u9898\uff0c\u4e0d\u80fd\u4e00\u6b21\u6027\u9884\u6d4b\u4e24\u4e2a cond \u5206\u652f\u7684\u65b9\u5411\uff0c\u800c\u53ea\u80fd\u9884\u6d4b\u7b2c\u4e00\u6761 cond \u5206\u652f\uff0c\u90a3\u4e48\u7b2c\u4e8c\u6761 cond \u5206\u652f\u7684\u4fe1\u606f\uff0c\u5373\u4f7f\u901a\u8fc7 BTB \u8bfb\u53d6\u51fa\u6765\uff0c\u4e5f\u4e0d\u80fd\u7acb\u5373\u4f7f\u7528\uff0c\u8fd8\u5f97\u7b49\u4e0b\u4e00\u6b21\u7684\u9884\u6d4b\u3002</p>\n<p>\u4e3a\u4e86\u9a8c\u8bc1\u8fd9\u4e2a\u731c\u60f3\uff0c\u989d\u5916\u505a\u4e86\u4e00\u7ec4\u5b9e\u9a8c\uff1a\u628a\u5206\u652f\u6309\u7167 cond, uncond, cond, uncond, ... \u7684\u987a\u5e8f\u6392\u5217\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e2a cond \u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u6709\u4e00\u6761 uncond \u5206\u652f\u3002\u6b64\u65f6\u6d4b\u51fa\u6765\u7684\u7ed3\u679c\uff0c\u548c uncond \u76f8\u540c\uff0c\u4e5f\u5c31\u662f\u53ef\u4ee5\u505a\u5230 2 predicted branches per cycle\u3002\u6b64\u65f6\uff0cBTB \u4f9d\u7136\u4e00\u6b21\u63d0\u4f9b\u4e86\u4e24\u6761\u5206\u652f\u7684\u4fe1\u606f\uff0c\u53ea\u4e0d\u8fc7\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u53ea\u9884\u6d4b\u4e86\u7b2c\u4e00\u4e2a cond \u7684\u65b9\u5411\u3002\u5982\u679c\u5b83\u9884\u6d4b\u4e3a\u4e0d\u8df3\u8f6c\uff0c\u90a3\u4e48\u4e0b\u4e00\u4e2a PC \u5c31\u662f cond \u5206\u652f\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\uff1b\u5982\u679c\u5b83\u9884\u6d4b\u4e3a\u8df3\u8f6c\uff0c\u90a3\u4e48\u4e0b\u4e00\u4e2a PC \u5c31\u662f uncond \u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u3002</p>\n<p>nano BTB \u7684\u5bb9\u91cf\u51cf\u534a\uff0c\u610f\u5473\u7740 nano BTB \u7684 96 \u7684\u5bb9\u91cf\uff0c\u5b9e\u9645\u4e0a\u662f 48 \u4e2a entry\uff0c\u6bcf\u4e2a entry \u6700\u591a\u8bb0\u5f55\u4e24\u6761\u5206\u652f\u3002\u8003\u8651\u5230 nano BTB \u7684\u5bb9\u91cf\u4e0d\u968f stride \u53d8\u5316\uff0c\u5927\u6982\u7387\u662f\u5168\u76f8\u8fde\uff0c\u5e76\u4e14\u662f\u6839\u636e\u7b2c\u4e00\u6761\u5206\u652f\u7684\u5730\u5740\u8fdb\u884c\u5168\u76f8\u8fde\u5339\u914d\uff0c\u8fd9\u6837\uff0c\u5728 cond + cond \u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5c31\u53ea\u80fd\u8868\u73b0\u51fa 48 \u7684\u5bb9\u91cf\u3002\u4f46\u662f stride=4B uncond \u7684\u60c5\u51b5\u4e0b\u8868\u73b0\u51fa\u4ecb\u4e8e 48 \u548c 64 \u4e4b\u95f4\u7684\u5bb9\u91cf\uff0c\u8fd8\u4e0d\u77e5\u9053\u662f\u4ec0\u4e48\u539f\u56e0\u3002</p>\n<p>main BTB \u7684\u5bb9\u91cf\u4e0d\u53d8\uff0c\u610f\u5473\u7740\u5b83\u5728 cond + cond \u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u9000\u5316\u4e3a\u666e\u901a\u7684 BTB\uff0c\u6b64\u65f6\u6240\u6709\u5bb9\u91cf\u90fd\u53ef\u4ee5\u7528\u6765\u4fdd\u5b58 cond \u5206\u652f\uff0c\u5e76\u4e14\u90fd\u80fd\u5339\u914d\u5230\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5177\u4f53\u662f\u600e\u4e48\u505a\u5230 2 predicted branches per cycle \u5462\uff1f\u731c\u6d4b\u5728\u6267\u884c\u7684\u65f6\u5019\uff0c\u68c0\u6d4b\u8fd9\u79cd\u4e00\u4e2a\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u540e\uff0c\u8ddf\u7740\u4e00\u6761 uncond \u5206\u652f\u7684\u60c5\u51b5\uff1a\u5982\u679c\u6709\u7684\u8bdd\uff0c\u5c31\u628a\u7b2c\u4e8c\u6761\u5206\u652f\u7684\u4fe1\u606f\uff0c\u653e\u5728\u7b2c\u4e00\u6761\u5206\u652f\u7684\u4fe1\u606f\u540e\u9762\uff08\u8fd9\u5728 <a href=\"https://dl.acm.org/doi/pdf/10.1145/3613424.3623774\">Branch Target Buffer Organizations</a> \u4e2d\u88ab\u79f0\u4e3a MB-BTB \u7ed3\u6784\uff09\uff0c\u5355\u4e2a\u5468\u671f\u76f4\u63a5\u4ece SRAM \u8bfb\u53d6\u51fa\u6765\uff0c\u7136\u540e\u7ec4\u6210\u4e24\u4e2a fetch bundle\uff1a</p>\n<ul>\n<li>prediction pc -- first branch pc</li>\n<li>first branch target -- second branch pc</li>\n</ul>\n<p>\u7136\u540e\u4e0b\u4e00\u4e2a\u5468\u671f\u4ece second branch target \u5f00\u59cb\u7ee7\u7eed\u9884\u6d4b\u3002\u6839\u636e\u5b98\u65b9\u4fe1\u606f\uff0cNeoverse V1 \u7684 L1 ICache \u652f\u6301 2x32B \u7684\u5e26\u5bbd\uff0c\u8fd9\u4e2a 2x \u4ee3\u8868\u4e86\u53ef\u4ee5\u4ece\u4e24\u4e2a\u4e0d\u540c\u7684\u5730\u65b9\u8bfb\u53d6\u6307\u4ee4\uff0c\u4e5f\u5c31\u662f L1 ICache \u81f3\u5c11\u662f\u53cc bank \u751a\u81f3\u53cc\u7aef\u53e3\u7684 SRAM\u3002\u8003\u8651\u5230\u524d\u9762\u7684\u6d4b\u8bd5\u4e2d\uff0cCPI=0.5 \u7684\u8303\u56f4\u8de8\u8d8a\u4e86\u5404\u79cd stride\uff0c\u8ba4\u4e3a L1 ICache \u662f\u53cc bank \u7684\u53ef\u80fd\u5199\u6bd4\u8f83\u5c0f\uff0c\u4e0d\u7136\u5e94\u8be5\u4f1a\u89c2\u6d4b\u5230 bank conflict\uff0c\u5927\u6982\u7387\u5c31\u662f\u53cc\u7aef\u53e3\u4e86\u3002</p>\n<p>\u6b64\u5916\uff0c\u8003\u8651\u5230 fetch bundle \u7684\u957f\u5ea6\u9650\u5236\uff0cfirst branch target \u5230 second branch pc \u4e0d\u80fd\u592a\u8fdc\u3002\u5728\u4e0a\u9762\u7684\u6d4b\u8bd5\u4e2d\uff0c\u8fd9\u4e2a\u8ddd\u79bb\u603b\u662f 0\uff1b\u8bfb\u8005\u5982\u679c\u611f\u5174\u8da3\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u628a\u8ddd\u79bb\u62c9\u957f\uff0c\u770b\u770b\u8d85\u8fc7 32B \u4ee5\u540e\uff0c\u662f\u4e0d\u662f\u4f1a\u8ba9 2 predicted branches per cycle \u5931\u6548\u3002\u7c7b\u4f3c\u7684\u8868\u8ff0\uff0c\u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/57647.zip\">AMD Zen 4 Software Optimization Guide</a> \u4e2d\u4e5f\u6709\u51fa\u73b0\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>The branch target buffer (BTB) is a two-level structure accessed using the fetch address of the previous fetch block.\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>Each BTB entry includes information for branches and their targets.\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>Each BTB entry can hold up to two branches, and two pair cases are supported:\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>\u2022 A conditional branch followed by another branch with both branches having their last byte in the same 64 byte aligned cacheline.\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>\u2022 A direct branch (excluding CALLs) followed by a branch ending within the 64 byte aligned cacheline containing the target of the first branch.\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a>Predicting with BTB pairs allows two fetches to be predicted in one prediction cycle.\n</span></code></pre></div>\n<p>\u4e0a\u9762\u7684\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u5bf9\u5e94\u4e86\u7b2c\u4e8c\u6761\u5206\u652f\u7684 pc\uff0c\u5728\u7b2c\u4e00\u6761\u5206\u652f\u7684 target \u7684\u540c\u4e00\u4e2a 64 \u5b57\u8282 cacheline \u5185\u7684\u8981\u6c42\u3002\u53ef\u89c1\uff0cARM \u548c AMD \u5728 BTB \u7684\u8bbe\u8ba1\u4e0a\u662f\u8d8b\u540c\u7684\u3002</p>\n<p>\u5c0f\u7ed3\uff0cNeoverse V1 \u5728\u6ee1\u8db3\u5982\u4e0b\u6761\u4ef6\u65f6\uff0c\u53ef\u4ee5\u505a\u5230 2 predicted branches per cycle\uff1a</p>\n<ul>\n<li>uncond + uncond</li>\n<li>cond + uncond</li>\n</ul>\n<h3 id=\"stride4b-uncondcond-\u7684\u60c5\u51b5\u4e0bmain-btb-\u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c\">stride=4B uncond/cond \u7684\u60c5\u51b5\u4e0b\uff0cmain BTB \u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c<a class=\"headerlink\" href=\"#stride4b-uncondcond-\u7684\u60c5\u51b5\u4e0bmain-btb-\u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7c7b\u4f3c\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u5728\u5206\u6790 <a href=\"../../05/arm-neoverse-n1-btb/\">Neoverse N1</a> \u7684\u65f6\u5019\u5c31\u9047\u5230\u4e86\u3002Neoverse N1 \u7684\u60c5\u51b5\u662f\uff0c\u6bcf\u5bf9\u9f50\u7684 32B \u5757\u5185\uff0c\u7531\u4e8e 6 \u8def\u7ec4\u76f8\u8fde\uff0c\u6700\u591a\u8bb0\u5f55 6 \u6761\u5206\u652f\uff0c\u800c stride=4B \u65f6\uff0c\u6709 8 \u6761\u5206\u652f\uff0c\u6240\u4ee5\u51fa\u73b0\u4e86\u6027\u80fd\u95ee\u9898\u3002</p>\n<p>\u90a3\u4e48 Neoverse V1 \u662f\u4e0d\u662f\u8fd8\u662f\u7c7b\u4f3c\u7684\u60c5\u51b5\u5462\uff1f\u67e5\u9605 <a href=\"https://developer.arm.com/documentation/101427/latest/\">Neoverse V1 TRM</a>\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u7684 L1 (main) BTB \u7684\u63cf\u8ff0\u662f\uff1a</p>\n<ul>\n<li>Index: [15:4]</li>\n<li>Data: [91:0]</li>\n</ul>\n<p>\u56de\u60f3\u4e4b\u524d Neoverse N1 \u7684 main BTB \u5bb9\u91cf\uff1aIndex \u662f [14:5]\uff0c\u610f\u5473\u7740\u6709 1024 \u4e2a set\uff1b3 \u4e2a Way\uff0c\u6bcf\u4e2a Way \u91cc\u9762\u662f 82 bit \u7684\u6570\u636e\uff0c\u6bcf\u4e2a\u5206\u652f\u5360\u7528 41 bit\uff0c\u6240\u4ee5\u4e00\u5171\u53ef\u4ee5\u5b58 <code>1024*3*2=6K</code> \u6761\u5206\u652f\u3002</p>\n<p>\u7c7b\u6bd4\u4e00\u4e0b\uff0cNeoverse V1 \u7684 main BTB \u5bb9\u91cf\u4e5f\u5c31\u53ef\u4ee5\u8ba1\u7b97\u5f97\u51fa\uff1aIndex \u662f [15:4]\uff0c\u610f\u5473\u7740\u6709 4096 \u4e2a set\uff1b\u6ca1\u6709 Way\uff0c\u8bf4\u660e\u5c31\u662f\u76f4\u63a5\u6620\u5c04\uff1b92 bit \u7684\u6570\u636e\uff0c\u5927\u6982\u7387\u4e5f\u662f\u6bcf\u4e2a\u5206\u652f\u5360\u7528\u4e00\u534a\u4e5f\u5c31\u662f 46 bit\uff0c\u6240\u4ee5\u4e00\u5171\u53ef\u4ee5\u5b58 <code>4096*2=8K</code> \u6761\u5206\u652f\uff0c\u548c\u5b98\u65b9\u6570\u636e\u543b\u5408\u3002\u5728\u9700\u8981 2 predicted branches \u7684\u65f6\u5019\uff0c\u5c31\u628a\u8fd9\u4e24\u4e2a\u5206\u652f\u653e\u5230\u540c\u4e00\u4e2a 92-bit entry \u5185\u5373\u53ef\u3002\u4e00\u5171\u5360\u7528 <code>4096*92=376832</code> bit \u4e5f\u5c31\u662f 46 KB \u7684\u7a7a\u95f4\u3002</p>\n<p>\u90a3\u4e48\uff0c\u5728 stride=4B \u7684\u60c5\u51b5\u4e0b\uff0c\u5bf9\u9f50\u7684 16B \u5757\u5185\u7684\u5206\u652f\u4f1a\u88ab\u653e\u5230\u540c\u4e00\u4e2a set \u5185\uff0c\u800c\u6bcf\u4e2a set \u53ea\u80fd\u653e\u4e24\u6761\u5206\u652f\uff0c\u800c stride=4B \u65f6\u9700\u8981\u653e\u56db\u6761\u5206\u652f\uff0c\u8fd9\u5c31\u5bfc\u81f4\u4e86 main BTB \u51fa\u73b0\u6027\u80fd\u95ee\u9898\u3002</p>\n<p>\u4f46\u6bd4\u8f83\u5947\u602a\u7684\u662f\uff0cmain BTB \u7684\u5bb9\u91cf\uff0c\u5728 stride=32B \u65f6\u662f 8192\uff0c\u800c stride=64B \u65f6\u662f 4096\uff0c\u8fd9\u548c Index \u662f PC[15:4] \u4e0d\u7b26\uff0c\u8fd9\u6210\u4e3a\u4e86\u65b0\u7684\u9057\u7559\u95ee\u9898\u3002\u6709\u4e00\u79cd\u53ef\u80fd\uff0c\u5c31\u662f TRM \u5199\u7684\u4e0d\u51c6\u786e\uff0cIndex \u5e76\u975e PC[15:4]\u3002\u53e6\u5916\u8fd8\u6709\u4e00\u4e2a\u4f50\u8bc1\uff1aNeoverse N2 \u7684 BTB \u8bbe\u8ba1\u548c Neoverse V1 \u57fa\u672c\u76f8\u540c\uff0c\u4f46\u662f\u5b83\u7684 TRM \u5199\u7684 Index \u5c31\u662f [11:0]\uff0c\u8fd9\u5c31\u80af\u5b9a\u4e0d\u662f PC[11:0] \u4e86\u3002</p>\n<p>\u629b\u5f00 TRM\uff0c\u6839\u636e JamesAslan \u5728 <a href=\"https://zhuanlan.zhihu.com/p/595585895\">\u5077\u61d2\u7684 BTB\uff1fARM Cortex X1 \u521d\u63a2</a> \u4e2d\u7684\u6d4b\u8bd5\uff0cMain BTB \u662f\u56db\u8def\u7ec4\u76f8\u8fde\u3002\u5982\u679c\u6309\u7167\u56db\u8def\u7ec4\u76f8\u8fde\u6765\u8003\u8651\uff0c\u90a3\u4e48 8K \u6761\u5206\u652f\uff0c\u5b9e\u9645\u4e0a\u5e94\u8be5\u662f 2048 \u4e2a set\uff0c2 \u4e2a way\uff0c\u4e00\u5171\u662f 4K \u4e2a entry\uff0c\u6bcf\u4e2a entry \u6700\u591a\u4fdd\u5b58\u4e24\u6761\u5206\u652f\u3002\u6b64\u65f6 Index \u5e94\u8be5\u6709 11 \u4e2a bit\u3002\u5728 2 way \u6bcf way \u4e24\u6761\u5206\u652f\u7b49\u6548\u4e3a 4 way \u7684\u60c5\u51b5\u4e0b\uff0cstride=4B \u51fa\u73b0\u5206\u652f\u6570\u6bd4 way \u6570\u91cf\u66f4\u591a\u7684\u60c5\u51b5\uff0cstride=8B \u5219\u4e0d\u4f1a\uff0c\u610f\u5473\u7740\u53c2\u4e0e\u5230 Index \u7684\u6700\u4f4e\u7684 PC \u5e94\u8be5\u662f PC[5]\uff0c\u5373\u6bcf\u4e2a\u5bf9\u9f50\u7684 32B \u5757\u5185\uff0c\u6700\u591a\u653e\u56db\u6761\u5206\u652f\uff08Neoverse N1 \u4e0a\u662f\u6bcf\u4e2a\u5bf9\u9f50\u7684 32B \u5757\u5185\u6700\u591a\u653e\u516d\u6761\u5206\u652f\uff09\u3002\u8fd9\u6837\u7684\u8bdd\uff0cIndex \u53ef\u80fd\u5b9e\u9645\u4e0a\u662f PC[15:5]\u3002</p>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u603b\u7ed3\u4e00\u4e0b Neoverse V1 \u7684 BTB\uff1a</p>\n<ul>\n<li>48-entry(96 branches) nano BTB, at most 2 branches per entry, 1 cycle latency, at most 2 predicted branches every 1 cycle, fully associative</li>\n<li>4K-entry(8K branches) main BTB, at most 2 branches per entry, 2 cycle latency, at most 2 predicted branches every 2 cycles, 2-way(4-branch-way) set-associative, index PC[15:5]</li>\n</ul>\n<p>\u5f53 uncond + uncond \u6216\u8005 cond + uncond \u65f6\uff0c\u53ef\u4ee5\u5b9e\u73b0\u6bcf\u6b21\u9884\u6d4b\u4e24\u6761\u5206\u652f\uff1b\u5bf9\u4e8e cond + cond\uff0c\u6bcf\u6b21\u53ea\u80fd\u9884\u6d4b\u4e00\u6761\u5206\u652f\u3002</p>\n<p>2 predicted branches per cycle \u901a\u5e38\u4e5f\u88ab\u79f0\u4e3a 2 taken branches per cycle\uff0c\u7b80\u79f0 2 taken\u3002</p>\n<h2 id=\"\u9644\u5f55\">\u9644\u5f55<a class=\"headerlink\" href=\"#\u9644\u5f55\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"neoverse-n2\u4ee3\u53f7-perseus\u7684-btb-\u7ed3\u6784\u5206\u6790\">Neoverse N2\uff08\u4ee3\u53f7 Perseus\uff09\u7684 BTB \u7ed3\u6784\u5206\u6790<a class=\"headerlink\" href=\"#neoverse-n2\u4ee3\u53f7-perseus\u7684-btb-\u7ed3\u6784\u5206\u6790\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6839\u636e\u5b98\u65b9\u4fe1\u606f\uff0cNeoverse N2 \u548c Neoverse V1 \u7684 BTB \u914d\u7f6e\u5341\u5206\u7c7b\u4f3c\uff0c\u4ece\u6570\u5b57\u6765\u770b\u53ea\u6709 nano BTB \u7f29\u5c0f\u5230\u4e86 32-entry(64 branches)\uff0c\u5176\u4f59\u662f\u76f8\u540c\u7684\uff0c\u4f8b\u5982 main BTB \u5bb9\u91cf\u4e5f\u662f 8K branches\u3002\u5b9e\u6d4b\u4e0b\u6765\uff0cBTB \u6d4b\u8bd5\u56fe\u50cf\u548c Neoverse V1 \u57fa\u672c\u4e00\u6837\uff0c\u53ea\u6709 nano BTB \u5bb9\u91cf\u7684\u533a\u522b\u3002\u56e0\u6b64\u672c\u6587\u4e5f\u53ef\u4ee5\u8ba4\u4e3a\u662f\u5bf9 Neoverse N2 \u7684 BTB \u7ed3\u6784\u5206\u6790\u3002\u8003\u8651\u5230 Neoverse N2 \u548c Neoverse V1 \u7684\u53d1\u5e03\u65f6\u95f4\u76f8\u540c\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u4eec\u7528\u7684\u5c31\u662f\u76f8\u540c\u7684\u524d\u7aef\u8bbe\u8ba1\uff0c\u53ea\u662f\u6539\u4e86\u4e00\u4e0b\u53c2\u6570\u3002</p>\n<h3 id=\"\u5404\u4ee3-neoverse-\u5904\u7406\u5668\u7684-btb-\u7ed3\u6784\u5bf9\u6bd4\">\u5404\u4ee3 Neoverse \u5904\u7406\u5668\u7684 BTB \u7ed3\u6784\u5bf9\u6bd4<a class=\"headerlink\" href=\"#\u5404\u4ee3-neoverse-\u5904\u7406\u5668\u7684-btb-\u7ed3\u6784\u5bf9\u6bd4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6bd4\u8f83\u4e00\u4e0b Neoverse V1 \u548c Neoverse N1 \u7684\u8bbe\u8ba1\uff1a</p>\n<ul>\n<li>Neoverse N1 \u8bbe\u8ba1\u4e86\u4e09\u7ea7 BTB\uff0816+64+6K\uff09\uff0c\u5206\u522b\u5bf9\u5e94 1-3 \u7684\u5468\u671f\u7684\u5ef6\u8fdf\uff0c\u7279\u522b\u5730\uff0cmain BTB \u8bbe\u8ba1\u4e86 fastpath \u6765\u5b9e\u73b0\u4e00\u5b9a\u60c5\u51b5\u4e0b\u7684 2 \u5468\u671f\u5ef6\u8fdf</li>\n<li>Neoverse V1 \u8bbe\u8ba1\u4e86\u4e24\u7ea7 BTB\uff0896+8K\uff09\uff0c\u5206\u522b\u5bf9\u5e94 1-2 \u7684\u5468\u671f\u7684\u5ef6\u8fdf\uff0c\u5e76\u4e14\u90fd\u652f\u6301 2 taken</li>\n</ul>\n<p>Neoverse V1 \u76f8\u6bd4 Neoverse N1\uff0c\u5728\u5bb9\u91cf\u548c\u5ef6\u8fdf\u4e0a\u90fd\u6709\u6bd4\u8f83\u660e\u663e\u7684\u63d0\u5347\uff0c\u8fd8\u989d\u5916\u7ed9\u4e24\u7ea7 BTB \u90fd\u5f15\u5165\u4e86 2 taken \u7684\u652f\u6301\uff0c\u8fdb\u4e00\u6b65\u63d0\u5347\u4e86\u541e\u5410\u3002</p>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u5bf9\u6bd4\u8868\u683c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>uArch</th>\n<th>Neoverse N1</th>\n<th>Neoverse V1</th>\n<th>Neoverse N2</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Nano BTB size</td>\n<td>16 branches</td>\n<td>48*2 branches</td>\n<td>32*2 branches</td>\n</tr>\n<tr>\n<td>Nano BTB latency</td>\n<td>1 cycle</td>\n<td>1 cycle</td>\n<td>1 cycle</td>\n</tr>\n<tr>\n<td>Nano BTB throughput</td>\n<td>1 branch</td>\n<td>1-2 branches</td>\n<td>1-2 branches</td>\n</tr>\n<tr>\n<td>Micro BTB size</td>\n<td>64 branches</td>\n<td>N/A</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>Micro BTB latency</td>\n<td>2 cycles</td>\n<td>N/A</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>Main BTB size</td>\n<td>3K*2 branches</td>\n<td>4K*2 branches</td>\n<td>4K*2 branches</td>\n</tr>\n<tr>\n<td>Main BTB latency</td>\n<td>2-3 cycles</td>\n<td>2 cycle</td>\n<td>2 cycle</td>\n</tr>\n<tr>\n<td>Main BTB throughput</td>\n<td>1 branch</td>\n<td>1-2 branches</td>\n<td>1-2 branches</td>\n</tr>\n<tr>\n<td>Main BTB area (bits)</td>\n<td>3K*82=251904</td>\n<td>4K*92=376832</td>\n<td>4K*92=376832</td>\n</tr>\n<tr>\n<td>Main BTB area (KiB)</td>\n<td>30.75</td>\n<td>46</td>\n<td>46</td>\n</tr>\n<tr>\n<td>Technology Node</td>\n<td>7nm</td>\n<td>5nm</td>\n<td>5nm</td>\n</tr>\n</tbody>\n</table>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/arm-neoverse-v1-btb.png", "date_modified": "2025-06-23T00:00:00+00:00", "date_published": "2025-06-23T00:00:00+00:00", "authors": [], "tags": ["arm", "btb", "cpu", "hardware", "neoverse"]}, {"id": "https://jia.je/hardware/2025/06/10/linux-vm-on-harmonyos-computer/", "url": "https://jia.je/hardware/2025/06/10/linux-vm-on-harmonyos-computer/", "title": "\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u7684\u865a\u62df\u673a\u5185\u542f\u52a8 Linux", "content_html": "<h1 id=\"\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u7684\u865a\u62df\u673a\u5185\u542f\u52a8-linux\">\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u7684\u865a\u62df\u673a\u5185\u542f\u52a8 Linux<a class=\"headerlink\" href=\"#\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u7684\u865a\u62df\u673a\u5185\u542f\u52a8-linux\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u5728\u7814\u7a76\u9e3f\u8499\u7535\u8111\uff0c\u7fa4\u53cb <a href=\"https://github.com/Fearyncess\">@Fearyncess</a> \u6478\u7d22\u51fa\u4e86\uff0c\u5982\u4f55\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u7684\u865a\u62df\u673a\u5185\u542f\u52a8 Linux\uff0c\u800c\u4e0d\u662f Windows\u3002\u5728\u6b64\u505a\u4e2a\u590d\u73b0\u5e76\u8bb0\u5f55\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u65b9\u6cd5\">\u65b9\u6cd5<a class=\"headerlink\" href=\"#\u65b9\u6cd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u76ee\u524d\u9e3f\u8499\u7684\u5e94\u7528\u5e02\u573a\u4e0a\u6709\u4e24\u5bb6\u865a\u62df\u673a\uff0c\u6211\u7528 Oseasy \u865a\u62df\u673a\uff0c\u4f46\u662f\u7406\u8bba\u4e0a\u94e0\u5927\u5e08\u4e5f\u662f\u53ef\u4ee5\u7684\u3002\uff08P.S. @driver1998 \u53cd\u9988\uff1a\u201c\u94e0\u5927\u5e08\u6d4b\u8bd5\u4e5f\u80fd\u542f\u52a8\uff0c\u4f46\u952e\u76d8\u5de6\u53f3\u65b9\u5411\u952e\u7684\u5904\u7406\u6709\u70b9\u95ee\u9898\uff0c\u865a\u62df\u673a\u5185\u6536\u4e0d\u5230\u6309\u952e\u677e\u5f00\u7684\u4fe1\u53f7\uff0cEFI \u548c Linux \u91cc \u9762\u90fd\u662f\u8fd9\u6837\u3002\u76ee\u524d\u5efa\u8bae\u7528 OSEasy\u3002\u201d\uff09</p>\n<p>\u9996\u5148\u9700\u8981\u5728 U \u76d8\u4e0a\uff0c\u628a\u4e00\u4e2a UEFI arm64 \u7684 Linux \u5b89\u88c5\u76d8\u5199\u8fdb\u53bb\u3002\u6211\u7528\u7684\u662f Ventoy + Debian Installer\uff0c\u7406\u8bba\u4e0a\u76f4\u63a5\u5199\u4f8b\u5982 Debian \u53d1\u884c\u7248\u7684\u5b89\u88c5 ISO \u4e5f\u662f\u53ef\u4ee5\u7684\u3002</p>\n<p>\u7136\u540e\u628a U \u76d8\u63d2\u5230\u9e3f\u8499\u7535\u8111\u4e0a\uff0c\u6253\u5f00 Windows \u865a\u62df\u673a\uff0c\u76f4\u901a\u5230\u865a\u62df\u673a\u91cc\u9762\uff0c\u4fdd\u8bc1\u865a\u62df\u673a\u91cc\u9762\u53ef\u4ee5\u770b\u5230 U \u76d8\u3002</p>\n<p>\u63a5\u7740\uff0c\u8fdb\u5165 Windows \u78c1\u76d8\u7ba1\u7406\uff0c\u7f29\u5c0f Windows \u7684 NTFS \u5206\u533a\uff0c\u7559\u51fa\u7a7a\u95f4\u3002\u6ce8\u610f Windows \u542f\u52a8\u7684\u65f6\u5019\u4f1a\u81ea\u52a8 growpart\uff0c\u6240\u4ee5\u88c5 Debian \u524d\uff0c\u4e0d\u8981\u56de\u5230 Windows\u3002\u88c5\u597d\u4ee5\u540e\uff0c\u53ef\u4ee5\u7ee7\u7eed\u7528 Windows\u3002</p>\n<p>\u63a5\u7740\uff0c\u91cd\u542f Windows\uff0c\u540c\u65f6\u6309\u4f4f Escape\uff0c\u8fdb\u5165 OVMF \u7684\u754c\u9762\uff0c\u7136\u540e\u9009\u62e9 Boot Manager\uff0c\u4ece U \u76d8\u542f\u52a8\uff0c\u7136\u540e\u5c31\u8fdb\u5165 Ventoy \u7684\u754c\u9762\u4e86\u3002\uff08\u6ce8\uff1a\u6839\u636e @quiccat \u7fa4\u53cb\u63d0\u9192\uff0c\u5728 Windows \u5185\uff0c\u901a\u8fc7\u8bbe\u7f6e-&gt;\u7cfb\u7edf-&gt;\u6062\u590d-&gt;\u9ad8\u7ea7\u542f\u52a8-&gt;UEFI \u56fa\u4ef6\u8bbe\u7f6e\u4e5f\u53ef\u4ee5\u8fdb\u5165 OVMF \u7684\u8bbe\u7f6e\u754c\u9762\uff09</p>\n<p>\u5269\u4e0b\u7684\u5c31\u662f\u6b63\u5e38\u7684 Linux \u5b89\u88c5\u8fc7\u7a0b\u4e86\uff0c\u5206\u533a\u7684\u65f6\u5019\uff0c\u6ce8\u610f\u4fdd\u7559 Windows \u5df2\u6709\u7684 NTFS\uff0c\u53ef\u4ee5\u548c Windows \u7528\u540c\u4e00\u4e2a ESP \u5206\u533a\u3002\u7f51\u7edc\u7684\u8bdd\uff0c\u914d\u7f6e\u9759\u6001 IP \u662f 172.16.100.2\uff0c\u9ed8\u8ba4\u7f51\u5173\u662f 172.16.100.1 \u5373\u53ef\u3002\u91cd\u542f\u4ee5\u540e\uff0c\u5728 grub \u754c\u9762\uff0c\u4fee\u6539 linux \u914d\u7f6e\uff0c\u5728 cmdline \u4e00\u680f\u6dfb\u52a0 <code>modprobe.blacklist=vmwgfx</code>\uff0c\u8fd9\u6837\u5c31\u80fd\u542f\u52a8\u4e86\u3002\u5185\u6838\u7248\u672c\u662f Debian Bookworm \u7684 6.1\u3002</p>\n<p>\u5404\u5185\u6838\u7248\u672c\u542f\u52a8\u60c5\u51b5\uff1a</p>\n<ul>\n<li>5.10 from debian\uff1a\u6b63\u5e38</li>\n<li>6.1 from debian\uff1a\u6b63\u5e38</li>\n<li>6.2/6.3/6.4 from kernel.ubuntu.com: <code>echo simpledrm &gt; /etc/modules-load.d/simpledrm.conf</code> \u540e\u6b63\u5e38\uff0c\u5426\u5219\u7cfb\u7edf\u53ef\u4ee5\u542f\u52a8\u4f46\u662f\u56fe\u5f62\u754c\u9762\u8d77\u4e0d\u6765</li>\n<li>6.5 from kernel.ubuntu.com\uff1a\u8d77\u4e0d\u6765\uff0c\u9700\u8981\u5f3a\u5236\u5173\u673a</li>\n<li>6.12 from debian\uff1a\u8d77\u4e0d\u6765\uff0c\u9700\u8981\u5f3a\u5236\u5173\u673a</li>\n</ul>\n<p>\u7ecf\u8fc7 @Fearyncess \u7684\u4e8c\u5206\uff0c\u627e\u5230\u4e86\u5bfc\u81f4\u95ee\u9898\u7684 <a href=\"https://github.com/torvalds/linux/commit/edc25898f0b6cceed6c90b0e79916bd04de7dd19\">commit</a>\u3002</p>\n<p>\u6700\u7ec8\u6548\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../../software/linux-vm-on-harmonyos-computer.png\" /></p>\n<p>\u4e3b\u8981\u7684\u9057\u61be\u662f\u5206\u8fa8\u7387\uff1a\u5c4f\u5e55\u4e24\u4fa7\u6709\u9ed1\u8fb9\uff0c\u5e76\u4e14\u7531\u4e8e\u5bbd\u5ea6\u4e0d\u540c\uff0c\u89e6\u6478\u5c4f\u7684\u4f4d\u7f6e\u6620\u5c04\u4f1a\u504f\u4e2d\u95f4\u3002</p>\n<h2 id=\"\u9644\u5f55\">\u9644\u5f55<a class=\"headerlink\" href=\"#\u9644\u5f55\" title=\"Permanent link\">&para;</a></h2>\n<p>Geekbench 6 \u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<ul>\n<li>6 \u6838\uff1a<a href=\"https://browser.geekbench.com/v6/cpu/12309313\">Windows Single-Core 1436, Multi-Core 5296</a>, <a href=\"https://browser.geekbench.com/v6/cpu/12373700\">Linux Single-Core 1500, Multi-Core 5699</a></li>\n<li>8 \u6838\uff1a<a href=\"https://browser.geekbench.com/v6/cpu/12309427\">Windows Single-Core 1462, Multi-Core 7043</a>, <a href=\"https://browser.geekbench.com/v6/cpu/12373488\">Linux Single-Core 1489, Multi-Core 6076</a>, <a href=\"https://browser.geekbench.com/v6/cpu/12373797\">Linux Single-Core 1503, Multi-Core 6289</a></li>\n</ul>\n<p>\u5982\u679c\u6ca1\u6709 blacklist \u7684\u8bdd\uff0cvmwgfx \u9a71\u52a8\u7684\u62a5\u9519\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>vmwgfx 0000:00:04.0: [drm] FIFO at 0x0000000020000000 size is 2048 kiB\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>vmwgfx 0000:00:04.0: [drm] VRAM at 0x0000000010000000 size is 262144 kiB\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>vmwgfx 0000:00:04.0: [drm] *ERROR* Unsupported SVGA ID 0xffffffff on chipset 0x405\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>vmwgfx: probe of 0000:00:04.0 failed with error -38\n</span></code></pre></div>\n<p>blacklist vmwgfx \u540e\u7528\u7684\u662f efifb\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>[    0.465898] pci 0000:00:04.0: BAR 1: assigned to efifb\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>[    1.197638] efifb: probing for efifb\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>[    1.197705] efifb: framebuffer at 0x10000000, using 7500k, total 7500k\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>[    1.197708] efifb: mode is 1600x1200x32, linelength=6400, pages=1\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>[    1.197711] efifb: scrolling: redraw\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>[    1.197712] efifb: Truecolor: size=8:8:8:8, shift=24:16:8:0\n</span></code></pre></div>\n<p>\u865a\u62df\u673a\u7684 IP \u5730\u5740\uff0c\u4ece\u5bbf\u4e3b\u673a\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\uff0c\u901a\u8fc7 WVMBr \u8bbf\u95ee\uff0c\u76ee\u6d4b\u662f\u76f4\u63a5 Tap \u63a5\u51fa\u6765\uff0c\u7136\u540e\u5efa\u4e86\u4e2a Bridge\uff0c\u5916\u52a0 NAT\uff0c\u53ea\u662f\u6ca1\u6709 DHCP\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/software/linux-vm-on-harmonyos-computer.png", "date_modified": "2025-06-10T00:00:00+00:00", "date_published": "2025-06-10T00:00:00+00:00", "authors": [], "tags": ["arm64", "hardware", "harmonyos", "huawei", "linux", "matebook", "matebookpro"]}, {"id": "https://jia.je/hardware/2025/06/10/terminal-emulator-text-rendering/", "url": "https://jia.je/hardware/2025/06/10/terminal-emulator-text-rendering/", "title": "\u7ec8\u7aef\u6a21\u62df\u5668\u7684\u6587\u5b57\u7ed8\u5236", "content_html": "<h1 id=\"\u7ec8\u7aef\u6a21\u62df\u5668\u7684\u6587\u5b57\u7ed8\u5236\">\u7ec8\u7aef\u6a21\u62df\u5668\u7684\u6587\u5b57\u7ed8\u5236<a class=\"headerlink\" href=\"#\u7ec8\u7aef\u6a21\u62df\u5668\u7684\u6587\u5b57\u7ed8\u5236\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u5728\u9020\u9e3f\u8499\u7535\u8111\u4e0a\u7684\u7ec8\u7aef\u6a21\u62df\u5668 <a href=\"https://github.com/jiegec/Termony\">Termony</a>\uff0c\u4e00\u5f00\u59cb\u7528 ArkTS \u7684 Text + Span \u7a7a\u95f4\u6765\u7ed8\u5236\u7ec8\u7aef\uff0c\u540e\u6765\u53d1\u73b0\u8fd9\u6837\u6027\u80fd\u548c\u53ef\u5b9a\u5236\u6027\u6bd4\u8f83\u5dee\uff0c\u5c31\u9009\u62e9\u4e86\u81ea\u5df1\u7528 OpenGL \u5b9e\u73b0\uff0c\u987a\u5e26\u5b66\u4e60\u4e86\u4e00\u4e0b\u7ec8\u7aef\u6a21\u62df\u5668\u7684\u6587\u5b57\u7ed8\u5236\u662f\u4ec0\u4e48\u6837\u7684\u4e00\u4e2a\u8fc7\u7a0b\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u8bfb\u53d6\u5b57\u5f62\">\u8bfb\u53d6\u5b57\u5f62<a class=\"headerlink\" href=\"#\u8bfb\u53d6\u5b57\u5f62\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6587\u672c\u7ed8\u5236\uff0c\u9996\u5148\u5c31\u8981\u4ece\u5b57\u4f53\u6587\u4ef6\u4e2d\u8bfb\u53d6\u5b57\u5f62\uff0c\u63d0\u53d6\u51fa Bitmap \u6765\uff0c\u7136\u540e\u628a Bitmap \u7ed8\u5236\u5230\u8be5\u53bb\u7684\u5730\u65b9\u3002\u4e3a\u4e86\u63d0\u53d6\u8fd9\u4e9b\u4fe1\u606f\uff0c\u9996\u5148\u7528 FreeType \u5e93\uff0c\u5b83\u53ef\u4ee5\u89e3\u6790\u5b57\u4f53\u6587\u4ef6\uff0c\u7136\u540e\u8ba1\u7b97\u51fa\u7ed9\u5b9a\u5927\u5c0f\u7684\u7ed9\u5b9a\u5b57\u7b26\u7684 Bitmap\u3002\u4f46\u662f\uff0c\u8fd9\u4e2a Bitmap \u5b83\u53ea\u8bb0\u5f55\u5b57\u4f53\u975e\u7a7a\u767d\u7684\u90e8\u5206\uff08\u51c6\u786e\u7684\u8bf4\uff0c\u662f Bounding Box\uff09\uff0c\u5982\u4e0b\u56fe\u7684 width * height \u90e8\u5206\uff1a</p>\n<p><img alt=\"\" src=\"../../../../../software/terminal-emulator-text-rendering-font.png\" /></p>\n<p>\uff08\u56fe\u6e90\uff1a<a href=\"https://freetype.org/freetype2/docs/tutorial/step2.html\">Managing Glyphs - FreeType Tutorial II</a>\uff09</p>\n<p>\u5176\u4e2d x \u8f74\uff0c\u5e94\u8be5\u662f\u540c\u4e00\u884c\u7684\u5b57\u4f53\u5bf9\u9f50\u7684\uff0c\u8fd9\u6837\u624d\u4f1a\u770b\u5230\u6709\u9ad8\u6709\u4f4e\u7684\u5b57\u7b26\u51fa\u73b0\u5728\u540c\u4e00\u884c\uff0c\u800c\u4e0d\u662f\u5168\u90e8\u4e0a\u5bf9\u9f50\u6216\u8005\u4e0b\u5bf9\u9f50\u3002\u5f97\u5230\u7684 Bitmap \u662f\u884c\u4f18\u5148\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\uff1a</p>\n<ul>\n<li>\u56fe\u4e2d\u5de6\u4e0a\u89d2\uff0c\u5750\u6807 (xMin, yMax) \u5bf9\u5e94 Bitmap \u6570\u7ec4\u7684\u4e0b\u6807\u662f <code>0</code></li>\n<li>\u56fe\u4e2d\u53f3\u4e0a\u89d2\uff0c\u5750\u6807 (xMax, yMax) \u5bf9\u5e94 Bitmap \u6570\u7ec4\u7684\u4e0b\u6807\u662f <code>width-1</code></li>\n<li>\u56fe\u4e2d\u5de6\u4e0b\u89d2\uff0c\u5750\u6807 (xMin, yMin) \u5bf9\u5e94 Bitmap \u6570\u7ec4\u7684\u4e0b\u6807\u662f <code>width*(height-1)</code></li>\n<li>\u56fe\u4e2d\u53f3\u4e0b\u89d2\uff0c\u5750\u6807 (xMax, yMax) \u5bf9\u5e94 Bitmap \u6570\u7ec4\u7684\u4e0b\u6807\u662f <code>width*(height-1)+width-1</code></li>\n</ul>\n<p>\u5f97\u5230\u8fd9\u4e2a Bitmap \u540e\uff0c\u5982\u679c\u6211\u4eec\u4e0d\u7528 OpenGL\uff0c\u800c\u662f\u76f4\u63a5\u751f\u6210 PNG\uff0c\u90a3\u5c31\u76f4\u63a5\u8fdb\u884c\u4e00\u6b21 copy \u751a\u81f3 blend \u5c31\u53ef\u4ee5\u628a\u6587\u5b57\u7ed8\u5236\u4e0a\u53bb\u4e86\u3002\u4f46\u662f\uff0c\u6211\u4eec\u8981\u7528 OpenGL \u7684 shader\uff0c\u5c31\u9700\u8981\u628a bitmap \u653e\u5230 texture \u91cc\u9762\u3002\u7531\u4e8e\u76ee\u524d\u6211\u4eec\u7528\u7684\u5c31\u662f\u5355\u8272\u7684\u5b57\u4f53\uff0c\u6240\u4ee5\u5b83\u5bf9\u5e94\u53ea\u6709\u4e00\u4e2a channel \u7684 texture\u3002</p>\n<p>OpenGL \u7684 texture\uff0c\u91cc\u9762\u4e5f\u662f\u4fdd\u5b58\u7684 bitmap\uff0c\u4f46\u5b83\u7684\u5750\u6807\u7cfb\u7edf\u7684\u547d\u540d\u65b9\u5f0f\u4e0d\u592a\u4e00\u6837\uff1a\u5b83\u7684\u6c34\u5e73\u5411\u53f3\u65b9\u5411\u662f U \u8f74\uff0c\u7ad6\u76f4\u5411\u4e0a\u65b9\u5411\u662f V \u8f74\uff0c\u7136\u540e\u5b83\u7684 bitmap \u4fdd\u5b58\u4e2a\u6570\u4e5f\u662f\u884c\u4f18\u5148\uff0c\u4f46\u662f\u4ece (0, 0) \u5750\u6807\u5f00\u59cb\u4fdd\u5b58\u50cf\u7d20\uff0c\u7136\u540e U \u548c V \u7684\u8303\u56f4\u90fd\u662f 0 \u5230 1\u3002</p>\n<p>\u6240\u4ee5\uff0c\u5982\u679c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a width*height \u7684\u5355\u901a\u9053 texture\uff0c\u76f4\u63a5\u628a\u4e0a\u9762\u7684 bitmap \u62f7\u8d1d\u5230 texture \u5185\u90e8\uff0c\u5b9e\u9645\u7684\u6548\u679c\u5927\u6982\u662f\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a> V\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a> ^\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a> |\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a> C      D\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a> |\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a> |\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a> A------B---&gt;U\n</span></code></pre></div>\n<p>\u4e0a\u56fe\u4e2d\u51e0\u4e2a\u70b9\u7684\u5750\u6807\u4ee5\u53ca\u5bf9\u5e94\u7684 bitmap \u6570\u7ec4\u7684\u4e0b\u6807\uff1a</p>\n<ul>\n<li>A \u70b9\uff1aU = 0\uff0cV = 0\uff0c\u5bf9\u5e94 bitmap \u6570\u7ec4\u4e0b\u6807 <code>0</code></li>\n<li>B \u70b9\uff1aU = 1\uff0cV = 0\uff0c\u5bf9\u5e94 bitmap \u6570\u7ec4\u4e0b\u6807 <code>width-1</code></li>\n<li>C \u70b9\uff1aU = 0\uff0cV = 1\uff0c\u5bf9\u5e94 bitmap \u6570\u7ec4\u4e0b\u6807 <code>width*(height-1)</code></li>\n<li>D \u70b9\uff1aU = 1\uff0cV = 1\uff0c\u5bf9\u5e94 bitmap \u6570\u7ec4\u4e0b\u6807 <code>width*(height-1)+width-1</code></li>\n</ul>\n<p>\u6240\u4ee5\u5728\u5411 OpenGL \u7684 texture \u4fdd\u5b58 bitmap \u7684\u65f6\u5019\uff0c\u76f8\u5f53\u4e8e\u505a\u4e86\u4e00\u4e2a\u4e0a\u4e0b\u7ffb\u8f6c\uff0c\u4e0d\u8fc7\u8fd9\u6ca1\u6709\u5173\u7cfb\uff0c\u540e\u7eed\u5728\u6307\u5b9a\u4e09\u89d2\u5f62\u9876\u70b9\u7684 U V \u5750\u6807\u7684\u65f6\u5019\uff0c\u4fdd\u8bc1\u5bf9\u5e94\u5173\u7cfb\u5373\u53ef\u3002</p>\n<h2 id=\"\u9010\u4e2a\u5b57\u7b26\u7ed8\u5236\">\u9010\u4e2a\u5b57\u7b26\u7ed8\u5236<a class=\"headerlink\" href=\"#\u9010\u4e2a\u5b57\u7b26\u7ed8\u5236\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6709\u4e86\u8fd9\u4e2a\u57fa\u7840\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u9010\u4e2a\u5b57\u7b26\u7ed8\u5236\uff1a\u63d0\u524d\u628a\u6240\u6709\u8981\u7528\u5230\u7684\u5b57\u7b26\uff0c\u4ece\u5b57\u4f53\u63d0\u53d6\u51fa\u5bf9\u5e94\u7684 Bitmap\uff0c\u6bcf\u4e2a\u5b57\u7b26\u5bf9\u5e94\u5230\u4e00\u4e2a Texture\u3002\u7136\u540e\u8981\u7ed8\u5236\u6587\u5b57\u7684\u65f6\u5019\uff0c\u9010\u4e2a\u5b57\u7b26\uff0c\u7528\u5bf9\u5e94\u7684 Texture\uff0c\u5728\u60f3\u8981\u7ed8\u5236\u7684\u4f4d\u7f6e\u4e0a\uff0c\u7ed8\u5236\u4e00\u4e2a\u5b57\u7b26\u3002\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e2a\u76ee\u7684\uff0c\u5199\u4e00\u4e2a\u7b80\u5355\u7684 Shader\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\">// vertex shader</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"cp\">#version 320 es</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"w\"> </span><span class=\"n\">vertex</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// xy is position, zw is its texture coordinates</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">vec2</span><span class=\"w\"> </span><span class=\"n\">texCoors</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// output texture coordinates</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"w\">  </span><span class=\"n\">gl_Position</span><span class=\"p\">.</span><span class=\"n\">xy</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vertex</span><span class=\"p\">.</span><span class=\"n\">xy</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a><span class=\"w\">  </span><span class=\"n\">gl_Position</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// we don&#39;t care about depth now</span>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"w\">  </span><span class=\"n\">gl_Position</span><span class=\"p\">.</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// (x, y, z, w) corresponds to (x/w, y/w, z/w), so we set w = 1.0</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"w\">  </span><span class=\"n\">texCoords</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vertex</span><span class=\"p\">.</span><span class=\"n\">zw</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a><span class=\"c1\">// fragment shader</span>\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a><span class=\"cp\">#version 320 es</span>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a><span class=\"n\">precision</span><span class=\"w\"> </span><span class=\"n\">lowp</span><span class=\"w\"> </span><span class=\"kt\">float</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">vec2</span><span class=\"w\"> </span><span class=\"n\">texCoords</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a><span class=\"n\">uniform</span><span class=\"w\"> </span><span class=\"n\">sampler2D</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a><span class=\"w\">  </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">texture</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">texCoords</span><span class=\"p\">).</span><span class=\"n\">r</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-20\"><a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\" href=\"#__codelineno-1-20\"></a><span class=\"w\">  </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"p\">(</span><span class=\"mf\">1.0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-1-21\"><a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\" href=\"#__codelineno-1-21\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u7ed9\u6bcf\u4e2a\u9876\u70b9\u8bbe\u7f6e\u56db\u4e2a\u5c5e\u6027\uff0c\u5305\u5728\u4e00\u4e2a vec4 \u4e2d\uff1a</p>\n<ul>\n<li>xy\uff1a\u8bb0\u5f55\u4e86\u8fd9\u4e2a\u9876\u70b9\u7684\u5750\u6807\uff0cx \u548c y \u8303\u56f4\u90fd\u662f -1 \u5230 1</li>\n<li>zw\uff1a\u8bb0\u5f55\u4e86\u8fd9\u4e2a\u9876\u70b9\u7684 texture \u5750\u6807 u \u548c v\uff0c\u8303\u56f4\u90fd\u662f 0 \u5230 1</li>\n</ul>\n<p>vertex shader \u53ea\u662f\u7b80\u5355\u5730\u628a\u8fd9\u4e9b\u4fe1\u606f\u4f20\u9012\u5230\u9876\u70b9\u7684\u5750\u6807\u548c fragment shader\u3002fragment shader \u505a\u7684\u4e8b\u60c5\u662f\uff1a</p>\n<ul>\n<li>\u6839\u636e\u5f53\u524d\u70b9\u7ecf\u8fc7\u63d2\u503c\u51fa\u6765\u7684 u v \u5750\u6807\uff0c\u5728 texture \u4e2d\u8fdb\u884c\u91c7\u6837</li>\n<li>\u7531\u4e8e\u8fd9\u4e2a texture \u53ea\u6709\u5355\u901a\u9053\uff0c\u6240\u4ee5\u5b83\u7684\u7b2c\u4e00\u4e2a channel \u4e5f\u5c31\u662f <code>texture(text, texCoords).r</code> \u5c31\u4ee3\u8868\u4e86\u8fd9\u4e2a\u5b57\u4f53\u5728\u8fd9\u4e2a\u4f4d\u7f6e\u7684 alpha \u503c</li>\n<li>\u7136\u540e\u628a alpha \u503c\u8f93\u51fa\uff1a<code>(1.0, 1.0, 1.0, alpha)</code>\uff0c\u5373\u5e26\u6709 alpha \u7684\u767d\u8272</li>\n</ul>\n<p>\u5728\u7ed8\u5236\u6587\u5b57\u4e4b\u524d\uff0c\u5148\u7ed8\u5236\u597d\u80cc\u666f\u8272\uff0c\u7136\u540e\u901a\u8fc7\u8bbe\u7f6e blending function\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"n\">glEnable</span><span class=\"p\">(</span><span class=\"n\">GL_BLEND</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"n\">glBlendFunc</span><span class=\"p\">(</span><span class=\"n\">GL_SRC_ALPHA</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">GL_ONE_MINUS_SRC_ALPHA</span><span class=\"p\">);</span><span class=\"w\">  </span>\n</span></code></pre></div>\n<p>\u5b83\u4f7f\u5f97 blending \u91c7\u7528\u5982\u4e0b\u7684\u516c\u5f0f\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"k\">final</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"p\">.</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"p\">.</span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc dest \u5c31\u662f\u7ed8\u5236\u6587\u672c\u524d\u7684\u989c\u8272\uff0csrc \u5c31\u662f fragment shader \u8f93\u51fa\u7684\u989c\u8272\uff0c\u4e5f\u5c31\u662f <code>(1.0, 1.0, 1.0, alpha)</code>\u3002\u4ee3\u5165\u516c\u5f0f\uff0c\u5c31\u77e5\u9053\u6700\u7ec8\u7684\u7ed3\u679c\u662f\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u4e5f\u5c31\u662f\u4ee5 alpha \u4e3a\u4e0d\u900f\u660e\u5ea6\uff0c\u628a\u767d\u8272\u548c\u80cc\u666f\u989c\u8272\u8fdb\u884c\u4e86\u4e00\u6b21 blend\u3002</p>\n<p>\u5982\u679c\u8981\u8bbe\u7f6e\u5b57\u4f53\u989c\u8272\uff0c\u53ea\u9700\u8981\u4fee\u6539\u4e00\u4e0b fragment shader\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"cp\">#version 320 es</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"n\">precision</span><span class=\"w\"> </span><span class=\"n\">lowp</span><span class=\"w\"> </span><span class=\"kt\">float</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">vec2</span><span class=\"w\"> </span><span class=\"n\">texCoords</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"n\">uniform</span><span class=\"w\"> </span><span class=\"n\">sampler2D</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a><span class=\"n\">uniform</span><span class=\"w\"> </span><span class=\"n\">vec3</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"w\">  </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">texture</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">texCoords</span><span class=\"p\">).</span><span class=\"n\">r</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">  </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"p\">(</span><span class=\"n\">textColor</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u6b64\u65f6 src \u7b49\u4e8e <code>(textColor.r, textColor.g, textColor.b, alpha)</code>\uff0c\u7ecf\u8fc7\u878d\u5408\u540e\u7684\u7ed3\u679c\u4e3a\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5373\u6700\u7ec8\u989c\u8272\uff0c\u7b49\u4e8e\u5b57\u4f53\u989c\u8272\u548c\u539f\u6765\u80cc\u666f\u989c\u8272\uff0c\u57fa\u4e8e bitmap \u7684 alpha \u503c\u7684\u878d\u5408\u3002</p>\n<p>\u89e3\u51b3\u4e86\u989c\u8272\uff0c\u63a5\u4e0b\u6765\u8003\u8651\u5982\u4f55\u8bbe\u7f6e\u9876\u70b9\u7684\u4fe1\u606f\u3002\u524d\u9762\u63d0\u5230\uff0c\u5f97\u5230\u7684 bitmap \u662f\u4e00\u4e2a\u77e9\u5f62\uff0c\u800c OpenGL \u7ed8\u56fe\u7684\u57fa\u672c\u5143\u7d20\u662f\u4e09\u89d2\u5f62\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u62c6\u5206\u6210\u4e24\u4e2a\u4e09\u89d2\u5f62\u6765\u7ed8\u56fe\uff0c\u5047\u5982\u8bf4\u8981\u7ed8\u5236\u4e00\u4e2a\u77e9\u5f62\uff0c\u5b83\u4e2a\u56db\u4e2a\u9876\u70b9\u5982\u4e0b\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a>3-4\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a>| |\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a>1-2\n</span></code></pre></div>\n<p>\u5982\u679c\u786e\u5b9a\u5de6\u4e0b\u89d2 3 \u8fd9\u4e2a\u9876\u70b9\u7684\u5750\u6807\u662f (xpos, ypos)\uff0c\u7136\u540e\u77e9\u5f62\u7684\u5bbd\u5ea6\u662f w\uff0c\u9ad8\u5ea6\u662f h\uff0c\u8003\u8651\u5230 OpenGL \u7684\u5750\u6807\u7cfb\u4e5f\u662f\u5411\u53f3 X \u6b63\u65b9\u5411\uff0c\u5411\u4e0a Y \u6b63\u65b9\u5411\uff0c\u90a3\u4e48\u8fd9\u56db\u4e2a\u9876\u70b9\u7684\u5750\u6807\uff1a</p>\n<ul>\n<li>\u9876\u70b9 1\uff1a(xpos, ypos)</li>\n<li>\u9876\u70b9 2\uff1a(xpos + w, ypos)</li>\n<li>\u9876\u70b9 3\uff1a(xpos, ypos + h)</li>\n<li>\u9876\u70b9 4\uff1a(xpos + w, ypos + h)</li>\n</ul>\n<p>\u63a5\u4e0b\u6765\u8003\u8651\u8fd9\u4e9b\u9876\u70b9\u5bf9\u5e94\u7684 uv \u5750\u6807\u3002\u9996\u5148\uff0c\u6211\u4eec\u77e5\u9053\u8fd9\u4e9b\u9876\u70b9\u5bf9\u5e94\u7684 bitmap \u7684\u4e0b\u6807\u5728\u54ea\u91cc\uff1b\u7136\u540e\u6211\u4eec\u53c8\u77e5\u9053\u8fd9\u4e9b bitmap \u7684\u4e0b\u6807\u5bf9\u5e94\u7684 uv \u5750\u6807\uff0c\u90a3\u5c31\u6bcf\u4e2a\u9876\u70b9\u627e\u4e00\u6b21\u5bf9\u5e94\u5173\u7cfb\uff1a</p>\n<ul>\n<li>\u9876\u70b9 1\uff1a(xpos, ypos)\uff0c\u4e0b\u6807\u662f <code>width*(height-1)</code>\uff0cuv \u5750\u6807\u662f (0, 1)</li>\n<li>\u9876\u70b9 2\uff1a(xpos + w, ypos)\uff0c\u4e0b\u6807\u662f <code>width*(height-1)+width-1</code>\uff0cuv \u5750\u6807\u662f (1, 1)</li>\n<li>\u9876\u70b9 3\uff1a(xpos, ypos + h)\uff0c\u4e0b\u6807\u662f <code>0</code>\uff0cuv \u5750\u6807\u662f (0, 0)</li>\n<li>\u9876\u70b9 4\uff1a(xpos + w, ypos + h)\uff0c\u4e0b\u6807\u662f <code>width-1</code>\uff0cuv \u5750\u6807\u662f (1, 0)</li>\n</ul>\n<p>\u4e3a\u4e86\u7ed8\u5236\u8fd9\u4e2a\u77e9\u5f62\uff0c\u7ed8\u5236\u4e24\u4e2a\u4e09\u89d2\u5f62\uff0c\u5206\u522b\u662f 3-&gt;1-&gt;2 \u548c 3-&gt;2-&gt;4\uff0c\u4e00\u5171\u516d\u4e2a\u9876\u70b9\u7684 (x, y, u, v) \u4fe1\u606f\u5c31\u662f\uff1a</p>\n<ul>\n<li>3: (xpos    , ypos + h, 0, 0)</li>\n<li>1: (xpos    , ypos    , 0, 1)</li>\n<li>2: (xpos + w, ypos    , 1, 1)</li>\n<li>3: (xpos    , ypos + h, 0, 0)</li>\n<li>2: (xpos + w, ypos    , 1, 1)</li>\n<li>4: (xpos + w, ypos + h, 1, 0)</li>\n</ul>\n<p>\u628a\u8fd9\u4e9b\u6570\u4f20\u9012\u7ed9 vertex shader\uff0c\u5c31\u53ef\u4ee5\u753b\u51fa\u6765\u8fd9\u4e2a\u5b57\u7b26\u4e86\u3002</p>\n<p>\u6700\u540e\u8fd8\u6709\u4e00\u4e2a\u5c0f\u7ec6\u8282\uff1a\u4e0a\u8ff0\u7684 xpos \u548c ypos \u8bf4\u7684\u662f\u77e9\u5f62\u5de6\u4e0b\u89d2\u7684\u5750\u6807\uff0c\u4f46\u662f\u6211\u4eec\u753b\u56fe\u7684\u65f6\u5019\uff0c\u5b9e\u9645\u4e0a\u671f\u671b\u7684\u662f\u628a\u5b57\u7b26\u90fd\u753b\u5230\u540c\u4e00\u6761\u7ebf\u4e0a\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u6307\u5b9a origin \u7684 xy \u5750\u6807\uff0c\u7136\u540e\u6839\u636e\u6bcf\u4e2a\u5b57\u7b26\u7684 bearingX \u548c bearingY \u6765\u7b97\u51fa\u5b83\u7684\u77e9\u5f62\u7684\u5de6\u4e0b\u89d2\u7684\u5750\u6807 xpos \u548c ypos\uff1a</p>\n<ul>\n<li>xpos = originX + bearingX</li>\n<li>ypos = originY + bearingY - height</li>\n</ul>\n<p>\u81f3\u6b64\u5c31\u5b9e\u73b0\u4e86\u9010\u4e2a\u5b57\u7b26\u7ed8\u5236\u9700\u8981\u7684\u6240\u6709\u5185\u5bb9\u3002\u8fd9\u4e5f\u662f <a href=\"https://learnopengl.com/In-Practice/Text-Rendering\">Text Rendering - Learn OpenGL</a> \u8fd9\u7bc7\u6587\u7ae0\u6240\u8bb2\u7684\u5185\u5bb9\u3002</p>\n<h2 id=\"texture-atlas\">Texture Atlas<a class=\"headerlink\" href=\"#texture-atlas\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0a\u9762\u8fd9\u79cd\u9010\u5b57\u7b26\u7ed8\u5236\u7684\u65b9\u6cd5\u6bd4\u8f83\u7b80\u5355\uff0c\u4f46\u662f\u4e5f\u6709\u786c\u4f24\uff0c\u6bd4\u5982\u6bcf\u6b21\u7ed8\u5236\u5b57\u7b26\uff0c\u90fd\u9700\u8981\u5207\u6362 texture\uff0c\u66f4\u65b0 buffer\uff0c\u518d\u8fdb\u884c\u4e00\u6b21 glDrawArrays \u8fdb\u884c\u7ed8\u5236\uff0c\u6548\u7387\u6bd4\u8f83\u4f4e\u3002\u6240\u4ee5\u4e00\u4e2a\u60f3\u6cd5\u662f\uff0c\u628a\u8fd9\u4e9b bitmap \u62fc\u63a5\u8d77\u6765\uff0c\u5408\u6210\u4e00\u4e2a\u5927\u7684 texture\uff0c\u7136\u540e\u628a\u6bcf\u4e2a\u5b57\u7b26\u5728\u8fd9\u4e2a\u5927\u7684 texture \u5185\u7684 uv \u5750\u6807\u4fdd\u5b58\u4e0b\u6765\u3002\u8fd9\u6837\uff0c\u53ef\u4ee5\u4e00\u6b21\u6027\u628a\u6240\u6709\u5b57\u7b26\u7684\u6240\u6709\u4e09\u89d2\u5f62\u90fd\u4f20\u9012\u7ed9 OpenGL\uff0c\u4e00\u6b21\u7ed8\u5236\u5b8c\u6210\uff0c\u4e0d\u6d89\u53ca\u5230 texture \u7684\u5207\u6362\u3002\u8fd9\u6837\u6548\u7387\u4f1a\u9ad8\u5f88\u591a\u3002</p>\n<p>\u5177\u4f53\u5230\u4ee3\u7801\u4e0a\uff0c\u4e5f\u5c31\u662f\u5206\u6210\u4e24\u6b65\uff1a</p>\n<ul>\n<li>bitmap \u7684\u62fc\u63a5\uff0c\u8fd9\u4e00\u6b65\u6bd4\u8f83\u7075\u6d3b\uff0c\u7406\u60f3\u60c5\u51b5\u4e0b\u662f\u6784\u9020\u4e00\u4e2a\u6bd4\u8f83\u7d27\u5bc6\u7684\u6392\u5e03\uff0c\u4f46\u4e5f\u53ef\u4ee5\u7559\u4e00\u4e9b\u7a7a\u95f4\uff0c\u76f4\u63a5\u5bf9\u9f50\u5230\u6700\u5927\u5bbd\u5ea6/\u9ad8\u5ea6\u7684\u6574\u6570\u500d\u7f51\u683c\u4e0a\uff0c\u7136\u540e\u8fdb\u884c uv \u5750\u6807\u7684\u8ba1\u7b97</li>\n<li>\u5269\u4e0b\u7684\uff0c\u5c31\u662f\u5728\u8ba1\u7b97\u9876\u70b9\u4fe1\u606f\u7684\u65f6\u5019\uff0c\u7528\u8ba1\u7b97\u597d\u7684 uv \u5750\u6807\uff0c\u5176\u4e2d left/right \u5bf9\u5e94 bitmap \u5de6\u53f3\u4e24\u4fa7\u7684 u \u5750\u6807\uff0ctop/bottom \u5bf9\u5e94 bitmap \u4e0a\u4e0b\u4e24\u4fa7\u7684 v \u5750\u6807\uff08\u6ce8\u610f top \u6bd4 bottom \u5c0f\uff0c\u56e0\u4e3a\u7ad6\u76f4\u65b9\u5411\u662f\u53cd\u7684\uff09\uff1a<ul>\n<li>3: (xpos    , ypos + h, left , top   )</li>\n<li>1: (xpos    , ypos    , left , bottom)</li>\n<li>2: (xpos + w, ypos    , right, bottom)</li>\n<li>3: (xpos    , ypos + h, left , top   )</li>\n<li>2: (xpos + w, ypos    , right, bottom)</li>\n<li>4: (xpos + w, ypos + h, right, top   )</li>\n</ul>\n</li>\n</ul>\n<p>\u6b64\u5916\uff0c\u5728\u524d\u9762\u7684 shader \u4ee3\u7801\u91cc\uff0c\u5b57\u4f53\u989c\u8272\u7528\u7684\u662f uniform\uff0c\u4e5f\u5c31\u662f\u6bcf\u6b21\u8c03\u7528\u53ea\u80fd\u7528\u540c\u4e00\u79cd\u989c\u8272\u3002\u4fee\u6539\u7684\u65b9\u6cd5\uff0c\u5c31\u662f\u628a\u5b83\u4e5f\u53d8\u6210\u9876\u70b9\u7684\u5c5e\u6027\uff0c\u4ece vertex shader \u76f4\u63a5\u4f20\u7ed9 fragment shader\uff0c\u66ff\u4ee3 uniform \u53d8\u91cf\u3002\u4e0d\u8fc7\u7531\u4e8e vec4 \u5df2\u7ecf\u653e\u4e0d\u4e0b\u66f4\u591a\u7684\u7ef4\u5ea6\u4e86\uff0c\u6240\u4ee5\u9700\u8981\u53e6\u5916\u5f00\u4e00\u4e2a attribute\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"c1\">// vertex shader</span>\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"cp\">#version 320 es</span>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"w\"> </span><span class=\"n\">vertex</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// xy is position, zw is its texture coordinates</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">vec3</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">vec2</span><span class=\"w\"> </span><span class=\"n\">texCoors</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// output texture coordinates</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">vec3</span><span class=\"w\"> </span><span class=\"n\">fragTextColor</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// send to fragment shader</span>\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a><span class=\"w\">  </span><span class=\"n\">gl_Position</span><span class=\"p\">.</span><span class=\"n\">xy</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vertex</span><span class=\"p\">.</span><span class=\"n\">xy</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a><span class=\"w\">  </span><span class=\"n\">gl_Position</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// we don&#39;t care about depth now</span>\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a><span class=\"w\">  </span><span class=\"n\">gl_Position</span><span class=\"p\">.</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// (x, y, z, w) corresponds to (x/w, y/w, z/w), so we set w = 1.0</span>\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a><span class=\"w\">  </span><span class=\"n\">texCoords</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vertex</span><span class=\"p\">.</span><span class=\"n\">zw</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a><span class=\"w\">  </span><span class=\"n\">fragTextColor</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a>\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a><span class=\"c1\">// fragment shader</span>\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a><span class=\"cp\">#version 320 es</span>\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a><span class=\"n\">precision</span><span class=\"w\"> </span><span class=\"n\">lowp</span><span class=\"w\"> </span><span class=\"kt\">float</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">vec2</span><span class=\"w\"> </span><span class=\"n\">texCoords</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"n\">vec3</span><span class=\"w\"> </span><span class=\"n\">fragTextColor</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-21\"><a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\" href=\"#__codelineno-8-21\"></a><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-22\"><a id=\"__codelineno-8-22\" name=\"__codelineno-8-22\" href=\"#__codelineno-8-22\"></a><span class=\"n\">uniform</span><span class=\"w\"> </span><span class=\"n\">sampler2D</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-23\"><a id=\"__codelineno-8-23\" name=\"__codelineno-8-23\" href=\"#__codelineno-8-23\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-8-24\"><a id=\"__codelineno-8-24\" name=\"__codelineno-8-24\" href=\"#__codelineno-8-24\"></a><span class=\"w\">  </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">texture</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">texCoords</span><span class=\"p\">).</span><span class=\"n\">r</span><span class=\"p\">;</span>\n</span><span id=\"__span-8-25\"><a id=\"__codelineno-8-25\" name=\"__codelineno-8-25\" href=\"#__codelineno-8-25\"></a><span class=\"w\">  </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vec4</span><span class=\"p\">(</span><span class=\"n\">fragTextColor</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-8-26\"><a id=\"__codelineno-8-26\" name=\"__codelineno-8-26\" href=\"#__codelineno-8-26\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<h2 id=\"\u80cc\u666f\u548c\u5149\u6807\u7ed8\u5236\">\u80cc\u666f\u548c\u5149\u6807\u7ed8\u5236<a class=\"headerlink\" href=\"#\u80cc\u666f\u548c\u5149\u6807\u7ed8\u5236\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u56de\u5230\u7ec8\u7aef\u6a21\u62df\u5668\uff0c\u5b83\u9664\u4e86\u7ed8\u5236\u5b57\u7b26\uff0c\u8fd8\u9700\u8981\u7ed8\u5236\u80cc\u666f\u989c\u8272\u548c\u5149\u6807\u3002\u524d\u9762\u5728\u7ed8\u5236\u5b57\u7b26\u7684\u65f6\u5019\uff0c\u53ea\u628a bounding box \u7ed8\u5236\u4e86\u51fa\u6765\uff0c\u90a3\u4e48\u5269\u4e0b\u7684\u7a7a\u767d\u90e8\u5206\u662f\u6ca1\u6709\u7ed8\u5236\u7684\u3002\u4f46\u662f\u7ec8\u7aef\u91cc\uff0c\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u7684\u80cc\u666f\u989c\u8272\u90fd\u53ef\u80fd\u4e0d\u540c\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u7ed9\u6bcf\u4e2a\u4f4d\u7f6e\u7ed8\u5236\u5bf9\u5e94\u7684\u80cc\u666f\u989c\u8272\u3002\u8fd9\u91cc\u6709\u4e24\u79cd\u505a\u6cd5\uff1a</p>\n<p>\u7b2c\u4e00\u79cd\u505a\u6cd5\u662f\uff0c\u628a\u524d\u9762\u6bcf\u4e2a\u5b57\u7b26\u7684 bitmap \u6269\u5c55\u5230\u7ec8\u7aef\u91cc\u4e00\u4e2a\u56fa\u5b9a\u7684\u4f4d\u7f6e\u7684\u5927\u5c0f\uff0c\u8fd9\u6837\u6bcf\u6b21\u7ed8\u5236\u7684\u77e9\u5f62\uff0c\u5c31\u662f\u5b8c\u6574\u7684\u4e00\u4e2a\u4f4d\u7f6e\u7684\u533a\u57df\uff0c\u8fd9\u4e2a\u65f6\u5019\u518d\u53bb\u7ed8\u5236\u80cc\u666f\u989c\u8272\uff0c\u5c31\u6bd4\u8f83\u5bb9\u6613\u4e86\uff1a\u4fee\u6539 vertex shader \u548c fragment shader\uff0c\u5728\u5185\u90e8\u8fdb\u884c\u4e00\u6b21 blend\uff1a<code>color = vec4(fragTextColor.rgb * alpha + fragBackgroundColor.rgb * (1.0 - alpha), 1.0)</code>\uff0c\u76f8\u5f53\u4e8e\u662f\u4e22\u6389\u4e86 OpenGL \u7684 blend function\uff0c\u81ea\u5df1\u5b8c\u6210\u4e86\u524d\u666f\u548c\u540e\u666f\u7684\u7ed8\u5236\u3002</p>\n<p>\u4f46\u8fd9\u4e2a\u65b9\u6cd5\u6709\u4e2a\u95ee\u9898\uff1a\u5e76\u975e\u6240\u6709\u7684\u5b57\u7b26\u7684 bitmap \u90fd\u53ef\u4ee5\u653e\u5230\u4e00\u4e2a\u56fa\u5b9a\u5927\u5c0f\u7684\u77e9\u5f62\u91cc\u7684\u3002\u6709\u4e00\u4e9b\u7279\u6b8a\u5b57\u7b26\uff0c\u8981\u4e48\u957f\u7684\u592a\u9ad8\uff0c\u8981\u4e48\u5728\u5f88\u4e0b\u9762\u7684\u4f4d\u7f6e\u3002\u540e\u7eed\u53ef\u80fd\u8fd8\u6709\u66f4\u590d\u6742\u7684\u9700\u6c42\uff0c\u6bd4\u5982 CJK \u548c Emoji\uff0c\u90a3\u4e48\u5b57\u7b26\u7684\u5bbd\u5ea6\u53c8\u4e0d\u4e00\u6837\u4e86\u3002\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u5bfc\u51fa\u4e86\u7b2c\u4e8c\u79cd\u505a\u6cd5\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u8f6e\uff0c\u5148\u7ed8\u5236\u51fa\u7ec8\u7aef\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u80cc\u666f\u989c\u8272</li>\n<li>\u7b2c\u4e8c\u8f6e\uff0c\u518d\u7ed8\u5236\u51fa\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u5b57\u7b26\uff0c\u548c\u80cc\u666f\u8fdb\u884c\u878d\u5408</li>\n</ul>\n<p>\u8fd9\u65f6\u5019 shader \u6ca1\u6cd5\u81ea\u5df1\u505a blend\uff0c\u6240\u4ee5\u8fd9\u8003\u8651\u600e\u4e48\u7528 blend function \u6765\u5b9e\u73b0\u8fd9\u4e2a blend \u7684\u8ba1\u7b97\u3002\u9996\u5148\uff0c\u8981\u8003\u8651\u6211\u4eec\u6700\u7ec8\u9700\u8981\u7684\u7ed3\u679c\u662f\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u7531\u4e8e\u662f OpenGL \u505a\u7684 blending\uff0c\u6211\u4eec\u9700\u8981\u7528 OpenGL \u81ea\u5e26\u7684 blending mode \u6765\u5b9e\u73b0\u4e0a\u8ff0\u516c\u5f0f\u3002OpenGL \u53ef\u4ee5\u6307\u5b9a RGB \u7684 source \u548c dest \u7684 blending \u65b9\u5f0f\uff0c\u6bd4\u5982\uff1a</p>\n<ul>\n<li>GL_ONE\uff1a\u4e58\u4ee5 1 \u7684\u7cfb\u6570</li>\n<li>GL_ONE_MINUS_SRC_ALPHA\uff1a\u4e58\u4ee5 (1 - source.a) \u7684\u7cfb\u6570</li>\n</ul>\n<p>\u6839\u636e\u8fd9\u4e2a\uff0c\u5c31\u53ef\u4ee5\u60f3\u5230\uff0c\u8bbe\u7f6e <code>source = vec4(textColor.rgb * alpha, alpha)</code>\uff0c\u8bbe\u7f6e source \u91c7\u7528 GL_ONE \u65b9\u5f0f\uff0cdest \u91c7\u7528 GL_ONE_MINUS_SRC_ALPHA \u6a21\u5f0f\uff0c\u90a3\u4e48 OpenGL \u8d1f\u8d23\u5269\u4e0b\u7684 blending \u5de5\u4f5c <code>final = source * 1 + dest * (1 - source.a)</code>\uff08\u8981\u6c42 <code>dest.a = 1.0</code>\uff09\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">textColor</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">);</span>\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"k\">final</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u6b63\u597d\u5b9e\u73b0\u4e86\u60f3\u8981\u7684\u8ba1\u7b97\u516c\u5f0f\u3002\u8fd9\u4e2a\u65b9\u6cd5\u6765\u81ea\u4e8e <a href=\"https://github.com/servo/webrender/blob/main/webrender/doc/text-rendering.md\">Text Rendering - WebRender</a>\u3002\u6709\u4e86\u8fd9\u4e2a\u63a8\u5bfc\u540e\uff0c\u5c31\u53ef\u4ee5\u5206\u4e24\u8f6e\uff0c\u5b8c\u6210\u7ec8\u7aef\u91cc\u524d\u540e\u666f\u7684\u7ed8\u5236\u4e86\u3002</p>\n<p>\u76ee\u524d <a href=\"https://github.com/jiegec/Termony\">Termony</a> \u7528\u7684\u5c31\u662f\u8fd9\u79cd\u5b9e\u73b0\u65b9\u6cd5\uff1a</p>\n<ul>\n<li>\u9996\u5148\u628a\u4e0d\u540c\u5b57\u91cd\u7684\u5404\u79cd\u5b57\u7b26\u7684 bitmap \u62fc\u5728\u4e00\u8d77\uff0c\u653e\u5728\u4e00\u4e2a texture \u5185\u90e8</li>\n<li>\u4f7f\u7528\u4e24\u9636\u6bb5\u7ed8\u5236\uff0c\u7b2c\u4e00\u9636\u6bb5</li>\n</ul>\n<p>\u6ce8\uff1a\u5982\u679c\u5728 source \u4f7f\u7528 GL_SRC_ALPHA\uff0c\u8bbe\u7f6e <code>source = vec4(textColor.rgb, alpha)</code>\uff0c\u8fd9\u6837 <code>final.r = source.r * source.a + dest.r * (1 - source.a) = textColor.r * alpha + dest.r * (1 - alpha)</code>\uff0c\u7ed3\u679c\u662f\u4e0a\u9762\u662f\u4e00\u6837\u7684\uff0c\u4e0d\u8fc7\u8fd9\u4e2a\u65f6\u5019 final \u7684 alpha \u503c\u7b49\u4e8e <code>source.a * source.a + dest.a * (1 - source.a)</code> \u662f alpha \u548c dest.a \u7ecf\u8fc7 blend \u4ee5\u540e\u7684\u7ed3\u679c\uff0c\u4e0d\u518d\u662f 1.0\uff0c\u5982\u679c\u4e0d\u7528\u5b83\u5c31\u65e0\u6240\u8c13\u3002\u4e0a\u9762\u8fd9\u79cd <code>vec4(textColor.rgb * alpha, alpha)</code> \u7684\u8ba1\u7b97\u65b9\u6cd5\uff0c\u53eb\u505a premultiplied alpha\uff0c\u4e5f\u5c31\u662f\u9884\u5148\u628a alpha \u4e58\u5230\u989c\u8272\u9879\u91cc\uff0c\u53ef\u4ee5\u65b9\u4fbf\u540e\u7eed\u7684\u8ba1\u7b97\u3002</p>\n<h2 id=\"\u5728\u9e3f\u8499\u4e0a\u4f7f\u7528-opengl-\u6e32\u67d3\">\u5728\u9e3f\u8499\u4e0a\u4f7f\u7528 OpenGL \u6e32\u67d3<a class=\"headerlink\" href=\"#\u5728\u9e3f\u8499\u4e0a\u4f7f\u7528-opengl-\u6e32\u67d3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u518d\u7b80\u5355\u5217\u4e3e\u4e00\u4e0b\uff0c\u5728\u9e3f\u8499\u4e0a\u7528 OpenGL \u6e32\u67d3\u90fd\u9700\u8981\u54ea\u4e9b\u4e8b\u60c5\uff1a</p>\n<p>\u9996\u5148\uff0c\u5728 ArkTS \u4e2d\uff0c\u63d2\u5165\u4e00\u4e2a XComponent\uff0c\u7136\u540e\u5728 XComponentController \u7684\u56de\u8c03\u51fd\u6570\u4e2d\uff0c\u901a\u77e5 native api\uff1a</p>\n<div class=\"language-javascript highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a><span class=\"k\">import</span><span class=\"w\"> </span><span class=\"nx\">testNapi</span><span class=\"w\"> </span><span class=\"kr\">from</span><span class=\"w\"> </span><span class=\"s1\">&#39;libentry.so&#39;</span><span class=\"p\">;</span>\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a>\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nx\">MyXComponentController</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nx\">XComponentController</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"w\">  </span><span class=\"nx\">onSurfaceCreated</span><span class=\"p\">(</span><span class=\"nx\">surfaceId</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">string</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ow\">void</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">    </span><span class=\"nx\">hilog</span><span class=\"p\">.</span><span class=\"nx\">info</span><span class=\"p\">(</span><span class=\"nx\">DOMAIN</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;testTag&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;onSurfaceCreated surfaceId: %{public}s&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">surfaceId</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">    </span><span class=\"nx\">testNapi</span><span class=\"p\">.</span><span class=\"nx\">createSurface</span><span class=\"p\">(</span><span class=\"nb\">BigInt</span><span class=\"p\">(</span><span class=\"nx\">surfaceId</span><span class=\"p\">));</span>\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a>\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">  </span><span class=\"nx\">onSurfaceChanged</span><span class=\"p\">(</span><span class=\"nx\">surfaceId</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">string</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">rect</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">SurfaceRect</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ow\">void</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a><span class=\"w\">    </span><span class=\"nx\">hilog</span><span class=\"p\">.</span><span class=\"nx\">info</span><span class=\"p\">(</span><span class=\"nx\">DOMAIN</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;testTag&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;onSurfaceChanged surfaceId: %{public}s rect: %{public}s&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">surfaceId</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">rect</span><span class=\"p\">));</span>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a><span class=\"w\">    </span><span class=\"nx\">testNapi</span><span class=\"p\">.</span><span class=\"nx\">resizeSurface</span><span class=\"p\">(</span><span class=\"nb\">BigInt</span><span class=\"p\">(</span><span class=\"nx\">surfaceId</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nx\">rect</span><span class=\"p\">.</span><span class=\"nx\">surfaceWidth</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">rect</span><span class=\"p\">.</span><span class=\"nx\">surfaceHeight</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-11-13\"><a id=\"__codelineno-11-13\" name=\"__codelineno-11-13\" href=\"#__codelineno-11-13\"></a>\n</span><span id=\"__span-11-14\"><a id=\"__codelineno-11-14\" name=\"__codelineno-11-14\" href=\"#__codelineno-11-14\"></a><span class=\"w\">  </span><span class=\"nx\">onSurfaceDestroyed</span><span class=\"p\">(</span><span class=\"nx\">surfaceId</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">string</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ow\">void</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-15\"><a id=\"__codelineno-11-15\" name=\"__codelineno-11-15\" href=\"#__codelineno-11-15\"></a><span class=\"w\">    </span><span class=\"nx\">hilog</span><span class=\"p\">.</span><span class=\"nx\">info</span><span class=\"p\">(</span><span class=\"nx\">DOMAIN</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;testTag&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;onSurfaceDestroyed surfaceId: %{public}s&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">surfaceId</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-16\"><a id=\"__codelineno-11-16\" name=\"__codelineno-11-16\" href=\"#__codelineno-11-16\"></a><span class=\"w\">    </span><span class=\"nx\">testNapi</span><span class=\"p\">.</span><span class=\"nx\">destroySurface</span><span class=\"p\">(</span><span class=\"nb\">BigInt</span><span class=\"p\">(</span><span class=\"nx\">surfaceId</span><span class=\"p\">))</span>\n</span><span id=\"__span-11-17\"><a id=\"__codelineno-11-17\" name=\"__codelineno-11-17\" href=\"#__codelineno-11-17\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-11-18\"><a id=\"__codelineno-11-18\" name=\"__codelineno-11-18\" href=\"#__codelineno-11-18\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-11-19\"><a id=\"__codelineno-11-19\" name=\"__codelineno-11-19\" href=\"#__codelineno-11-19\"></a>\n</span><span id=\"__span-11-20\"><a id=\"__codelineno-11-20\" name=\"__codelineno-11-20\" href=\"#__codelineno-11-20\"></a><span class=\"err\">@</span><span class=\"nx\">Component</span>\n</span><span id=\"__span-11-21\"><a id=\"__codelineno-11-21\" name=\"__codelineno-11-21\" href=\"#__codelineno-11-21\"></a><span class=\"nx\">struct</span><span class=\"w\"> </span><span class=\"nx\">Index</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-22\"><a id=\"__codelineno-11-22\" name=\"__codelineno-11-22\" href=\"#__codelineno-11-22\"></a><span class=\"w\">  </span><span class=\"nx\">xComponentController</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">XComponentController</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"ow\">new</span><span class=\"w\"> </span><span class=\"nx\">MyXComponentController</span><span class=\"p\">();</span>\n</span><span id=\"__span-11-23\"><a id=\"__codelineno-11-23\" name=\"__codelineno-11-23\" href=\"#__codelineno-11-23\"></a>\n</span><span id=\"__span-11-24\"><a id=\"__codelineno-11-24\" name=\"__codelineno-11-24\" href=\"#__codelineno-11-24\"></a><span class=\"w\">  </span><span class=\"nx\">build</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-25\"><a id=\"__codelineno-11-25\" name=\"__codelineno-11-25\" href=\"#__codelineno-11-25\"></a><span class=\"w\">    </span><span class=\"c1\">// ...</span>\n</span><span id=\"__span-11-26\"><a id=\"__codelineno-11-26\" name=\"__codelineno-11-26\" href=\"#__codelineno-11-26\"></a><span class=\"w\">    </span><span class=\"nx\">XComponent</span><span class=\"p\">({</span>\n</span><span id=\"__span-11-27\"><a id=\"__codelineno-11-27\" name=\"__codelineno-11-27\" href=\"#__codelineno-11-27\"></a><span class=\"w\">      </span><span class=\"nx\">type</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">XComponentType</span><span class=\"p\">.</span><span class=\"nx\">SURFACE</span><span class=\"p\">,</span>\n</span><span id=\"__span-11-28\"><a id=\"__codelineno-11-28\" name=\"__codelineno-11-28\" href=\"#__codelineno-11-28\"></a><span class=\"w\">      </span><span class=\"nx\">controller</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">xComponentController</span>\n</span><span id=\"__span-11-29\"><a id=\"__codelineno-11-29\" name=\"__codelineno-11-29\" href=\"#__codelineno-11-29\"></a><span class=\"w\">    </span><span class=\"p\">})</span>\n</span><span id=\"__span-11-30\"><a id=\"__codelineno-11-30\" name=\"__codelineno-11-30\" href=\"#__codelineno-11-30\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-11-31\"><a id=\"__codelineno-11-31\" name=\"__codelineno-11-31\" href=\"#__codelineno-11-31\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>native \u90e8\u5206\u9700\u8981\u5b9e\u73b0\u81f3\u5c11\u4e24\u4e2a\u51fd\u6570\uff1acreateSurface \u548c resizeSurface\u3002\u5176\u4e2d\u4e3b\u8981\u7684\u5de5\u4f5c\u5728 CreateSurface \u4e2d\u5b8c\u6210\uff0cResizeSurface \u4f1a\u5728\u7a97\u53e3\u5927\u5c0f\u53d8\u5316\u7684\u65f6\u5019\u88ab\u8c03\u7528\u3002</p>\n<p>CreateSurface \u8981\u505a\u7684\u4e8b\u60c5\uff1a</p>\n<p>\u8bfb\u53d6 surface id\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">argc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-2\"><a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\" href=\"#__codelineno-12-2\"></a><span class=\"n\">napi_value</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"k\">nullptr</span><span class=\"p\">};</span>\n</span><span id=\"__span-12-3\"><a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\" href=\"#__codelineno-12-3\"></a><span class=\"n\">napi_get_cb_info</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">nullptr</span><span class=\"p\">);</span>\n</span><span id=\"__span-12-4\"><a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\" href=\"#__codelineno-12-4\"></a>\n</span><span id=\"__span-12-5\"><a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\" href=\"#__codelineno-12-5\"></a><span class=\"kt\">int64_t</span><span class=\"w\"> </span><span class=\"n\">surface_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-6\"><a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\" href=\"#__codelineno-12-6\"></a><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">lossless</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-7\"><a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\" href=\"#__codelineno-12-7\"></a><span class=\"n\">napi_status</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">napi_get_value_bigint_int64</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">surface_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">lossless</span><span class=\"p\">);</span>\n</span><span id=\"__span-12-8\"><a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\" href=\"#__codelineno-12-8\"></a><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">napi_ok</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u521b\u5efa OHNativeWindow\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a><span class=\"n\">OHNativeWindow</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">native_window</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a><span class=\"n\">OH_NativeWindow_CreateNativeWindowFromSurfaceId</span><span class=\"p\">(</span><span class=\"n\">surface_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">native_window</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-3\"><a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\" href=\"#__codelineno-13-3\"></a><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">native_window</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u521b\u5efa EGLDisplay\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a><span class=\"n\">EGLNativeWindowType</span><span class=\"w\"> </span><span class=\"n\">egl_window</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">EGLNativeWindowType</span><span class=\"p\">)</span><span class=\"n\">native_window</span><span class=\"p\">;</span>\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a><span class=\"n\">EGLDisplay</span><span class=\"w\"> </span><span class=\"n\">egl_display</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">eglGetDisplay</span><span class=\"p\">(</span><span class=\"n\">EGL_DEFAULT_DISPLAY</span><span class=\"p\">);</span>\n</span><span id=\"__span-14-3\"><a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\" href=\"#__codelineno-14-3\"></a><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">egl_display</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">EGL_NO_DISPLAY</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u521d\u59cb\u5316 EGL\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"n\">EGLint</span><span class=\"w\"> </span><span class=\"n\">major_version</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a><span class=\"n\">EGLint</span><span class=\"w\"> </span><span class=\"n\">minor_version</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a><span class=\"n\">EGLBoolean</span><span class=\"w\"> </span><span class=\"n\">egl_res</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">eglInitialize</span><span class=\"p\">(</span><span class=\"n\">egl_display</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">major_version</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">minor_version</span><span class=\"p\">);</span>\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">egl_res</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">EGL_TRUE</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u9009\u62e9 EGL \u914d\u7f6e\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-16-1\"><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\" href=\"#__codelineno-16-1\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">EGLint</span><span class=\"w\"> </span><span class=\"n\">attrib</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">EGL_SURFACE_TYPE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-2\"><a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\" href=\"#__codelineno-16-2\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_WINDOW_BIT</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-3\"><a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\" href=\"#__codelineno-16-3\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_RENDERABLE_TYPE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-4\"><a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\" href=\"#__codelineno-16-4\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_OPENGL_ES2_BIT</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-5\"><a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\" href=\"#__codelineno-16-5\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_RED_SIZE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-6\"><a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\" href=\"#__codelineno-16-6\"></a><span class=\"w\">                          </span><span class=\"mi\">8</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-7\"><a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\" href=\"#__codelineno-16-7\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_GREEN_SIZE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-8\"><a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\" href=\"#__codelineno-16-8\"></a><span class=\"w\">                          </span><span class=\"mi\">8</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-9\"><a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\" href=\"#__codelineno-16-9\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_BLUE_SIZE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-10\"><a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\" href=\"#__codelineno-16-10\"></a><span class=\"w\">                          </span><span class=\"mi\">8</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-11\"><a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\" href=\"#__codelineno-16-11\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_ALPHA_SIZE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-12\"><a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\" href=\"#__codelineno-16-12\"></a><span class=\"w\">                          </span><span class=\"mi\">8</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-13\"><a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\" href=\"#__codelineno-16-13\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_DEPTH_SIZE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-14\"><a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\" href=\"#__codelineno-16-14\"></a><span class=\"w\">                          </span><span class=\"mi\">24</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-15\"><a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\" href=\"#__codelineno-16-15\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_STENCIL_SIZE</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-16\"><a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\" href=\"#__codelineno-16-16\"></a><span class=\"w\">                          </span><span class=\"mi\">8</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-17\"><a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\" href=\"#__codelineno-16-17\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_SAMPLE_BUFFERS</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-18\"><a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\" href=\"#__codelineno-16-18\"></a><span class=\"w\">                          </span><span class=\"mi\">1</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-19\"><a id=\"__codelineno-16-19\" name=\"__codelineno-16-19\" href=\"#__codelineno-16-19\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_SAMPLES</span><span class=\"p\">,</span>\n</span><span id=\"__span-16-20\"><a id=\"__codelineno-16-20\" name=\"__codelineno-16-20\" href=\"#__codelineno-16-20\"></a><span class=\"w\">                          </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"c1\">// Request 4 samples for multisampling</span>\n</span><span id=\"__span-16-21\"><a id=\"__codelineno-16-21\" name=\"__codelineno-16-21\" href=\"#__codelineno-16-21\"></a><span class=\"w\">                          </span><span class=\"n\">EGL_NONE</span><span class=\"p\">};</span>\n</span><span id=\"__span-16-22\"><a id=\"__codelineno-16-22\" name=\"__codelineno-16-22\" href=\"#__codelineno-16-22\"></a>\n</span><span id=\"__span-16-23\"><a id=\"__codelineno-16-23\" name=\"__codelineno-16-23\" href=\"#__codelineno-16-23\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">EGLint</span><span class=\"w\"> </span><span class=\"n\">max_config_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-16-24\"><a id=\"__codelineno-16-24\" name=\"__codelineno-16-24\" href=\"#__codelineno-16-24\"></a><span class=\"n\">EGLint</span><span class=\"w\"> </span><span class=\"n\">num_configs</span><span class=\"p\">;</span>\n</span><span id=\"__span-16-25\"><a id=\"__codelineno-16-25\" name=\"__codelineno-16-25\" href=\"#__codelineno-16-25\"></a><span class=\"n\">EGLConfig</span><span class=\"w\"> </span><span class=\"n\">egl_config</span><span class=\"p\">;</span>\n</span><span id=\"__span-16-26\"><a id=\"__codelineno-16-26\" name=\"__codelineno-16-26\" href=\"#__codelineno-16-26\"></a><span class=\"n\">egl_res</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">eglChooseConfig</span><span class=\"p\">(</span><span class=\"n\">egl_display</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">attrib</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">egl_config</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">max_config_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">num_configs</span><span class=\"p\">);</span>\n</span><span id=\"__span-16-27\"><a id=\"__codelineno-16-27\" name=\"__codelineno-16-27\" href=\"#__codelineno-16-27\"></a><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">egl_res</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">EGL_TRUE</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u521b\u5efa EGLSurface\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-17-1\"><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\" href=\"#__codelineno-17-1\"></a><span class=\"n\">EGLSurface</span><span class=\"w\"> </span><span class=\"n\">egl_surface</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">eglCreateWindowSurface</span><span class=\"p\">(</span><span class=\"n\">egl_display</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">egl_config</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">egl_window</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u521b\u5efa EGLContext\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-18-1\"><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\" href=\"#__codelineno-18-1\"></a><span class=\"n\">EGLint</span><span class=\"w\"> </span><span class=\"n\">context_attributes</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">EGL_CONTEXT_CLIENT_VERSION</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">EGL_NONE</span><span class=\"p\">};</span>\n</span><span id=\"__span-18-2\"><a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\" href=\"#__codelineno-18-2\"></a><span class=\"n\">EGLContext</span><span class=\"w\"> </span><span class=\"n\">egl_context</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">eglCreateContext</span><span class=\"p\">(</span><span class=\"n\">egl_display</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">egl_config</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">EGL_NO_CONTEXT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">context_attributes</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5728\u5f53\u524d\u7ebf\u7a0b\u542f\u7528 EGL\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-19-1\"><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\" href=\"#__codelineno-19-1\"></a><span class=\"n\">eglMakeCurrent</span><span class=\"p\">(</span><span class=\"n\">egl_display</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">egl_surface</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">egl_surface</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">egl_context</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5728\u8fd9\u4e4b\u540e\u5c31\u53ef\u4ee5\u7528 OpenGL \u7684\u5404\u79cd\u51fd\u6570\u4e86\u3002OpenGL \u7ed8\u5236\u5b8c\u6210\u4ee5\u540e\uff0c\u66f4\u65b0\u5230\u7a97\u53e3\u4e0a\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-20-1\"><a id=\"__codelineno-20-1\" name=\"__codelineno-20-1\" href=\"#__codelineno-20-1\"></a><span class=\"n\">eglSwapBuffers</span><span class=\"p\">(</span><span class=\"n\">egl_display</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">egl_surface</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5728 ResizeSurface \u4e2d\uff0c\u4e3b\u8981\u662f\u66f4\u65b0 glViewport\uff0c\u8ba9\u5b83\u6309\u7167\u65b0\u7684 surface \u5927\u5c0f\u6765\u7ed8\u5236\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://learnopengl.com/In-Practice/Text-Rendering\">Text Rendering - Learn OpenGL</a></li>\n<li><a href=\"https://github.com/servo/webrender/blob/main/webrender/doc/text-rendering.md\">Text Rendering - WebRender</a></li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/software/terminal-emulator-text-rendering.png", "date_modified": "2025-06-10T00:00:00+00:00", "date_published": "2025-06-10T00:00:00+00:00", "authors": [], "tags": ["arm64", "hardware", "harmonyos", "huawei", "matebook", "matebookpro", "termony"]}, {"id": "https://jia.je/hardware/2025/06/06/huawei-matebook-pro/", "url": "https://jia.je/hardware/2025/06/06/huawei-matebook-pro/", "title": "\u9e3f\u8499\u7535\u8111 MateBook Pro \u5f00\u7bb1\u4f53\u9a8c", "content_html": "<h1 id=\"\u9e3f\u8499\u7535\u8111-matebook-pro-\u5f00\u7bb1\u4f53\u9a8c\">\u9e3f\u8499\u7535\u8111 MateBook Pro \u5f00\u7bb1\u4f53\u9a8c<a class=\"headerlink\" href=\"#\u9e3f\u8499\u7535\u8111-matebook-pro-\u5f00\u7bb1\u4f53\u9a8c\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u8d2d\u4e70\">\u8d2d\u4e70<a class=\"headerlink\" href=\"#\u8d2d\u4e70\" title=\"Permanent link\">&para;</a></h2>\n<p>2025.6.6 \u53f7\u6b63\u5f0f\u5f00\u5356\uff0c\u5f53\u534e\u4e3a\u7ebf\u4e0a\u5546\u57ce\u663e\u793a\u6ca1\u8d27\u7684\u65f6\u5019\uff0c\u679c\u65ad\u53bb\u7ebf\u4e0b\u95e8\u5e97\u4e70\u4e86\u4e00\u53f0\u56de\u6765\u3002\u8d2d\u4e70\u7684\u662f 32GB \u5185\u5b58\uff0c1TB SSD \u5b58\u50a8\uff0c\u52a0\u67d4\u5149\u5c4f\u7684\u7248\u672c\uff0c\u578b\u53f7 HAD-W32\uff0c\u539f\u4ef7 9999\uff0c\u56fd\u8865\u540e 7999\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5f00\u7bb1\">\u5f00\u7bb1<a class=\"headerlink\" href=\"#\u5f00\u7bb1\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7531\u4e8e\u7528\u4e86\u56fd\u8865\uff0c\u9700\u8981\u5f53\u9762\u6fc0\u6d3b\uff0c\u5c31\u5728\u5e97\u91cc\u76f4\u63a5\u6fc0\u6d3b\u4e86\uff0c\u6240\u4ee5\u6ca1\u6709\u4f53\u9a8c\u5230\u9e3f\u8499\u7cfb\u7edf\u7684\u626b\u7801\u6fc0\u6d3b\u529f\u80fd\uff0c\u6709\u70b9\u53ef\u60dc\u3002\u6fc0\u6d3b\u524d\u7684\u7b2c\u4e00\u6b21\u5f00\u673a\u9700\u8981\u63d2\u7535\uff0c\u76f4\u63a5\u6309\u7535\u6e90\u952e\u662f\u6ca1\u6709\u53cd\u5e94\u7684\u3002\u6fc0\u6d3b\u8fc7\u7a0b\u4e5f\u5f88\u7b80\u5355\uff0c\u8054\u7f51\uff0c\u521b\u5efa\u7528\u6237\uff0c\u767b\u5f55\u534e\u4e3a\u8d26\u53f7\uff0c\u8f93\u5165\u6307\u7eb9\uff0c\u5c31\u53ef\u4ee5\u4e86\u3002\u5305\u88c5\u76d2\u91cc\u8fd8\u6709 140W \u5355\u53e3 Type-C \u7535\u6e90\u9002\u914d\u5668\uff0c\u4f53\u79ef\u633a\u5c0f\u7684\u3002\u6b64\u5916\u9644\u8d60\u4e86\u4e00\u6761 Type-C to Type-C \u7684\u7ebf\uff0c\u8fd8\u6709\u4e00\u4e2a Type-C \u6709\u7ebf\u8033\u673a\uff0c\u5916\u52a0\u4e00\u4e2a Type-A \u6bcd\u53e3\u52a0 Type-C \u516c\u53e3\u7684\u7ebf\uff0c\u53ef\u4ee5\u7528\u6765\u63a5 Type-A \u516c\u53e3\u7684\u5916\u8bbe\u3002\u6b64\u5916\u8fd8\u6709\u5feb\u901f\u6307\u5357\u548c\u4e00\u4e2a\u8d85\u7ea4\u629b\u5149\u5e03\u3002\u5e97\u5bb6\u8fd8\u8d34\u5fc3\u5730\u63d0\u4f9b\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u7684\u5b89\u88c5\u6559\u7a0b\u3002</p>\n<p>\u5916\u5f62\u4e0a\uff0c\u5c31\u662f MateBook X Pro \u52a0\u4e86\u4e00\u4e2a HarmonyOS \u7684\u6807\u8bc6\uff0c\u4e0a\u624b\u5f88\u8f7b\uff0c\u4e0d\u6127\u662f\u4e0d\u5230\u4e00\u516c\u65a4\u7684\u7b14\u8bb0\u672c\uff0c\u5bf9\u4e8e\u4e60\u60ef\u7528 MacBookAir \u8f7b\u8584\u672c\u7684\u6211\u6765\u8bf4\uff0c\u662f\u5f88\u5927\u7684\u4e00\u4e2a\u4eae\u70b9\u3002\u4e0d\u50cf MacBookAir\uff0c\u8fd9\u53f0\u9e3f\u8499\u7535\u8111\u6709\u98ce\u6247\uff0c\u6709\u70b9\u5c0f\u5c0f\u7684\u4e0d\u4e60\u60ef\uff0c\u4f46\u8fd8\u7b97\u5b89\u9759\u3002</p>\n<p>\u89c4\u683c\u5982\u4e0b\uff1a</p>\n<ul>\n<li>970g \u91cd\u91cf</li>\n<li>14.2 \u5bf8\u663e\u793a\u5668</li>\n<li>3120x2080 \u5206\u8fa8\u7387\uff0c120 Hz \u5237\u65b0\u7387</li>\n<li>1.8mm \u952e\u7a0b\u952e\u76d8</li>\n<li>70 Wh \u7535\u6c60</li>\n</ul>\n<h2 id=\"\u7cfb\u7edf\u4f53\u9a8c\">\u7cfb\u7edf\u4f53\u9a8c<a class=\"headerlink\" href=\"#\u7cfb\u7edf\u4f53\u9a8c\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9884\u88c5\u7684\u7248\u672c\u662f HarmonyOS 5.0.1.305\uff0c\u6709\u66f4\u65b0 5.0.1.310 SP9\uff08SP9C00E301R9P2patch02\uff0c\u5185\u6838 1.9.5 2025-05-26\uff09\uff0c\u9996\u5148\u66f4\u65b0\u4e86\u4e00\u4e0b\u7cfb\u7edf\u3002\u8fd9\u662f\u6211\u7684\u7b2c\u4e00\u53f0\u652f\u6301\u89e6\u5c4f\u7684\u7b14\u8bb0\u672c\uff0c\u6240\u4ee5\u7528\u8d77\u6765\u8fd8\u6709\u70b9\u65b0\u5947\u3002\u8fd9\u4e2a\u67d4\u5149\u5c4f\u7528\u8d77\u6765\u89e6\u611f\u4e0d\u9519\uff0c\u548c\u4e4b\u524d\u4e70\u7684\u67d4\u5149\u5c4f MatePad \u7684\u89e6\u611f\u7c7b\u4f3c\u3002</p>\n<p>\u5e95\u90e8\u72b6\u6001\u680f\u7684\u989c\u8272\u4f1a\u968f\u7740\u60c5\u51b5\u53d8\u5316\uff0c\u6bd4\u5982\u5728\u684c\u9762\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u58c1\u7eb8\u662f\u9ed1\u8272\u7684\uff0c\u72b6\u6001\u680f\u4e5f\u5c31\u662f\u9ed1\u8272\u7684\u3002\u5982\u679c\u6253\u5f00\u4e86\u8bbe\u7f6e\uff0c\u8bbe\u7f6e\u662f\u767d\u8272\u7684\uff0c\u72b6\u6001\u680f\u4e5f\u5c31\u662f\u767d\u8272\u7684\u3002\u4e4b\u540e\u53ef\u4ee5\u591a\u6d4b\u8bd5\u4e00\u4e0b\u5b83\u5177\u4f53\u7684\u53d8\u8272\u903b\u8f91\u3002</p>\n<p>\u7cfb\u7edf\u91cc\u9884\u88c5\u4e86 WPS Office\uff0c\u8fc5\u96f7\uff0c\u4ebf\u56fe\uff0c\u4e2d\u671b CAD\uff0c\u526a\u6620\uff0c\u597d\u538b\uff0c\u6296\u97f3\u7b49\uff0c\u9762\u5411\u7684\u5ba2\u6237\u7fa4\u4f53\u5f88\u663e\u7136\u4e86\u3002\u867d\u7136\u9884\u88c5\uff0c\u4f46\u90fd\u53ef\u4ee5\u5378\u8f7d\u3002</p>\n<p>\u5185\u7f6e\u4e86\u63a7\u5236\u624b\u673a\u5c4f\u5e55\u7684\u529f\u80fd\uff0c\u6709\u7565\u5fae\u7684\u4e0d\u8ddf\u624b\uff0c\u4f46\u7531\u4e8e\u7535\u8111\u672c\u8eab\u4e5f\u662f\u89e6\u5c4f\uff0c\u6240\u4ee5\u4f53\u9a8c\u8fd8\u662f\u548c\u624b\u673a\u5f88\u63a5\u8fd1\u7684\u3002\u4e0b\u65b9\u662f\u7ecf\u5178\u7684\u4e09\u4e2a\u6309\u94ae\u3002\u8fd9\u4e2a\u534f\u540c\uff0c\u53ef\u4ee5\u7535\u8111\u548c\u624b\u673a\u540c\u65f6\u64cd\u4f5c\uff0c\u8fd8\u662f\u633a\u597d\u7684\uff0c\u4e0d\u4f1a\u8bf4\u7535\u8111\u63a7\u5236\u4e86\u624b\u673a\uff0c\u624b\u673a\u5c31\u4e0d\u80fd\u7528\u7684\u60c5\u51b5\u3002\u624b\u673a\u754c\u9762\u5de6\u4e0a\u89d2\u4f1a\u63d0\u793a\u534f\u540c\u4e2d\u3002\u952e\u9f20\u5171\u4eab\u529f\u80fd\u4e0d\u9519\uff0c\u53ef\u4ee5\u628a\u624b\u673a\u5f53\u5c4f\u5e55\uff0c\u7136\u540e\u7528\u7535\u8111\u7684\u952e\u76d8\u548c\u89e6\u6478\u677f\u63a7\u5236\uff0c\u5916\u63a5\u7684\u9f20\u6807\u4e5f\u53ef\u4ee5\u3002</p>\n<p>\u89e6\u6478\u677f\u624b\u52bf\u65b9\u9762\uff0c\u53ef\u4ee5\u5728\u8bbe\u7f6e\u91cc\u4fee\u6539\uff0c\u6bd4\u5982\u83dc\u5355\u5f39\u51fa\u6539\u6210\u53cc\u6307\u70b9\u6309\u6216\u8f7b\u70b9\u3002\u89e6\u6478\u677f\u7684\u624b\u611f\u6bd4\u82f9\u679c\u8fd8\u662f\u6709\u4e00\u5b9a\u7684\u5dee\u8ddd\uff0c\u4f46\u662f\u5c4f\u5e55\u89e6\u6478\u5f25\u8865\u4e86\u8fd9\u4e2a\u95ee\u9898\u3002\u6ca1\u6709\u627e\u5230\u4e09\u6307\u62d6\u62fd\u7684\u624b\u52bf\uff0c\u5b83\u7528\u7684\u662f\u7c7b\u4f3c Windows \u7684\u8f7b\u70b9\u4e24\u6b21\uff0c\u7b2c\u4e8c\u6b21\u4e0d\u62ac\u8d77\u7684\u505a\u6cd5\u3002</p>\n<p>\u5c4f\u5e55\u5206\u8fa8\u7387 2080 x 3120\uff0c14.2 \u82f1\u5bf8\u3002</p>\n<p>2025-06-17 \u63a8\u9001\u4e86 5.0.1.310 SP9\uff0cSP9C00E301R9P2patch05\uff0c\u5185\u6838 1.9.5 2025-05-26\u3002</p>\n<p>2025-06-24 \u63a8\u9001\u4e86 5.0.1.315 SP12\uff0cSP12C00E302R9P3patch01\uff0c\u5185\u6838 1.9.5 2025-06-20\u3002</p>\n<p>2025-06-30 \u63a8\u9001\u4e86 5.0.1.315 SP17\uff0cSP17C00E302R9P3\uff0c\u5185\u6838 1.9.5 2025-06-24\u3002</p>\n<h2 id=\"\u5e94\u7528\u4f53\u9a8c\">\u5e94\u7528\u4f53\u9a8c<a class=\"headerlink\" href=\"#\u5e94\u7528\u4f53\u9a8c\" title=\"Permanent link\">&para;</a></h2>\n<p>\u76ee\u524d\uff082025 \u5e74 6 \u6708 6 \u65e5\uff09\u5e94\u7528\u5546\u57ce\u6709\u8fd9\u4e9b\u8f6f\u4ef6\uff1a</p>\n<ul>\n<li>Bilibili</li>\n<li>\u98de\u4e66</li>\n<li>\u9489\u9489</li>\n<li>\u817e\u8baf\u4f1a\u8bae</li>\n<li>QQ\uff08\u5728\u5e94\u7528\u5c1d\u9c9c\u5185\uff09</li>\n<li>CodeArts IDE\uff08\u5728\u5e94\u7528\u5c1d\u9c9c\u5185\uff0c\u9700\u8981\u5f00\u53d1\u8005\u6a21\u5f0f\uff09</li>\n</ul>\n<p>\u6682\u65f6\u8fd8\u6ca1\u6709\u5fae\u4fe1\uff0c\u53ef\u4ee5\u901a\u8fc7\u64cd\u63a7\u624b\u673a\u6765\u53d1\u5fae\u4fe1\uff0c\u4f46\u662f\u5728\u6d88\u606f\u680f\u91cc\u6309\u56de\u8f66\u662f\u6362\u884c\uff0c\u6ca1\u627e\u5230\u53d1\u9001\u6309\u94ae\u5bf9\u5e94\u7684\u7535\u8111\u6309\u952e\uff0c\u9700\u8981\u624b\u52a8\u64cd\u3002\u4f46\u662f\u5c45\u7136\u6709\u4f01\u4e1a\u5fae\u4fe1\u3002</p>\n<p>UPDATE: 2025-06-26 \u5fae\u4fe1\u6b63\u5f0f\u4e0a\u67b6\u3002</p>\n<p>UPDATE: 2025-06-13 \u6536\u5230\u4e86\u5fae\u4fe1\u7684\u6d4b\u8bd5\u77ed\u4fe1\uff0c\u53ef\u4ee5\u4f53\u9a8c\u4e86\uff0c\u7248\u672c\u662f 4.0.1.30\u30022025-06-14 \u63a8\u9001\u4e86 4.0.1.31 \u6d4b\u8bd5\u7248\u672c\u30022025-06-19 \u63a8\u9001\u4e86 4.0.1.32 \u7248\u672c\u3002</p>\n<p>\u652f\u6301\u5e94\u7528\u63a5\u7eed\uff0c\u5728\u624b\u673a\u4e0a\u64ad\u653e\u7684 B \u7ad9\u89c6\u9891\uff0c\u53ef\u4ee5\u5728\u7535\u8111\u4e0a\u63a5\u7eed\u7ee7\u7eed\u770b\u3002</p>\n<p>\u671f\u5f85\u4e00\u4e2a\u529f\u80fd\uff0c\u5f53\u7535\u8111\u4e0a\u51fa\u73b0\u9700\u8981\u626b\u7684\u4e8c\u7ef4\u7801\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u901a\u8fc7\u534f\u540c\u529f\u80fd\uff0c\u4e0d\u7528\u64cd\u4f5c\u624b\u673a\uff0c\u8ba9\u624b\u673a\u76f4\u63a5\u626b\u7535\u8111\u7684\u5c4f\u5e55\u3002\u4e0d\u8fc7\u53cd\u8fc7\u6765\uff0c\u5982\u679c\u7535\u8111\u4e0a\u6709\u9700\u8981\u8f93\u5165\u624b\u673a\u77ed\u4fe1\u9a8c\u8bc1\u7801\u7684\u573a\u666f\uff0c\u5c31\u5df2\u7ecf\u5f88\u65b9\u4fbf\u4e86\u3002</p>\n<p>\u8bd5\u4e86\u4e00\u4e0b\u817e\u8baf\u4f1a\u8bae\uff0c\u58f0\u97f3\uff0c\u89c6\u9891\uff0c\u5171\u4eab\u5c4f\u5e55\u90fd\u662f\u6b63\u5e38\u5de5\u4f5c\u7684\u3002\u4f46\u662f\u5171\u4eab\u7684\u5c4f\u5e55\u53ea\u6709\u7b14\u8bb0\u672c\u81ea\u5df1\u7684\u5c4f\u5e55\uff0c\u8fd8\u4e0d\u80fd\u9009\u53d6\u5171\u4eab\u54ea\u4e2a\u5c4f\u5e55\u7684\u5185\u5bb9\uff0c\u4e5f\u4e0d\u80fd\u9009\u53d6\u5171\u4eab\u54ea\u4e2a\u7a97\u53e3\u3002</p>\n<h2 id=\"\u5f00\u53d1\u8005\u6a21\u5f0f\">\u5f00\u53d1\u8005\u6a21\u5f0f<a class=\"headerlink\" href=\"#\u5f00\u53d1\u8005\u6a21\u5f0f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5f00\u53d1\u8005\u6a21\u5f0f\u7684\u6253\u5f00\u65b9\u5f0f\u548c\u624b\u673a\u4e0a\u4e00\u6837\uff0c\u5728\u8bbe\u7f6e\u91cc\u72c2\u70b9\u8f6f\u4ef6\u7248\u672c\u3002\u81ea\u5e26\u4e86\u4e00\u4e2a Terminal App\uff0c\u4f1a\u63d0\u793a\u4f60\u5982\u4f55\u6253\u5f00\u5f00\u53d1\u8005\u6a21\u5f0f\u3002</p>\n<p>\u6253\u5f00\u4ee5\u540e\u5c31\u53ef\u4ee5\u8bbf\u95ee\u7ec8\u7aef\u4e86\u3002shell \u662f\u7528\u7684 toybox\u3002df \u5982\u4e0b\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>$<span class=\"w\"> </span>df<span class=\"w\"> </span>-h\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>Filesystem<span class=\"w\">                                            </span>Size<span class=\"w\">  </span>Used<span class=\"w\"> </span>Avail<span class=\"w\"> </span>Use%<span class=\"w\"> </span>Mounted<span class=\"w\"> </span>on\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>tmpfs<span class=\"w\">                                                  </span>16G<span class=\"w\">   </span>52K<span class=\"w\">   </span>16G<span class=\"w\">   </span><span class=\"m\">1</span>%<span class=\"w\"> </span>/\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>tmpfs<span class=\"w\">                                                  </span>16G<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">   </span>16G<span class=\"w\">   </span><span class=\"m\">0</span>%<span class=\"w\"> </span>/storage/hmdfs\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>/dev/block/dm-4<span class=\"w\">                                       </span><span class=\"m\">5</span>.7M<span class=\"w\">  </span><span class=\"m\">5</span>.7M<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">100</span>%<span class=\"w\"> </span>/cust\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a>/dev/block/dm-6<span class=\"w\">                                       </span><span class=\"m\">3</span>.1G<span class=\"w\">  </span><span class=\"m\">3</span>.1G<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">100</span>%<span class=\"w\"> </span>/preload\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>/dev/block/dm-0<span class=\"w\">                                       </span><span class=\"m\">3</span>.0G<span class=\"w\">  </span><span class=\"m\">3</span>.0G<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">100</span>%<span class=\"w\"> </span>/system/variant\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a>/dev/block/dm-5<span class=\"w\">                                       </span><span class=\"m\">8</span>.0K<span class=\"w\">  </span><span class=\"m\">8</span>.0K<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">100</span>%<span class=\"w\"> </span>/version\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>/dev/block/platform/b0000000.hi_pcie/by-name/userdata<span class=\"w\"> </span>928G<span class=\"w\">   </span>59G<span class=\"w\">  </span>869G<span class=\"w\">   </span><span class=\"m\">7</span>%<span class=\"w\"> </span>/data/service/hnp\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a>tmpfs<span class=\"w\">                                                  </span>16G<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">   </span>16G<span class=\"w\">   </span><span class=\"m\">0</span>%<span class=\"w\"> </span>/module_update\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>/dev/block/dm-2<span class=\"w\">                                       </span><span class=\"m\">9</span>.3G<span class=\"w\">  </span><span class=\"m\">8</span>.1G<span class=\"w\">  </span><span class=\"m\">1</span>.1G<span class=\"w\">  </span><span class=\"m\">88</span>%<span class=\"w\"> </span>/sys_prod\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a>devfs<span class=\"w\">                                                  </span>15G<span class=\"w\">  </span>104M<span class=\"w\">   </span>15G<span class=\"w\">   </span><span class=\"m\">1</span>%<span class=\"w\"> </span>/dev\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a>/data/service/el2/100/hmdfs/non_account<span class=\"w\">               </span>928G<span class=\"w\">   </span>59G<span class=\"w\">  </span>869G<span class=\"w\">   </span><span class=\"m\">7</span>%<span class=\"w\"> </span>/mnt/hmdfs/100/non_account\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a>/dev/block/loop0<span class=\"w\">                                      </span>114M<span class=\"w\">  </span>112M<span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">100</span>%<span class=\"w\"> </span>/module_update/ArkWebCore\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a>tmpfs<span class=\"w\">                                                 </span><span class=\"m\">1</span>.0G<span class=\"w\">  </span>608K<span class=\"w\">  </span><span class=\"m\">0</span>.9G<span class=\"w\">   </span><span class=\"m\">1</span>%<span class=\"w\"> </span>/dev/shm\n</span></code></pre></div>\n<p>\u67e5\u770b <a href=\"../../../../huawei-matebook-pro-cpuinfo.txt\"><code>/proc/cpuinfo</code></a>\u3002\u56db\u4e2a 0xd42\uff082.0 GHz\uff09\uff0c\u516b\u4e2a 0xd43\uff082.0 GHz\uff09\uff0c\u516b\u4e2a 0xd03\uff082.3 GHz\uff09\uff0c\u5171 20 \u4e2a\u903b\u8f91\u6838\u3002\u4ece part id \u6765\u770b\uff0c0xd03 \u548c 0xd42 \u5bf9\u5e94\u9e92\u9e9f 9010 \u7684\u5927\u6838\u548c\u4e2d\u6838\uff0c\u4f46 0xd43 \u662f\u65b0\u7684 part id\u3002</p>\n<p>\u4f7f\u7528 <a href=\"https://github.com/jiegec/SPECCPU2017Harmony\">https://github.com/jiegec/SPECCPU2017Harmony</a> \u6027\u80fd\u6d4b\u8bd5\uff1a</p>\n<ul>\n<li>X90 P-Core 2.3 GHz 0xd03 Full: INT 4.87 FP 7.42</li>\n<li>X90 E-Core 2.0 GHz 0xd43 Full: INT 4.28 FP 6.52</li>\n<li>X90 LPE-Core 2.0 GHz 0xd42 Full: INT 3.25 FP TODO</li>\n<li>9010 P-Core 2.3 GHz 0xd03 Best: INT 4.18 FP 6.22</li>\n<li>9010 P-Core 2.3 GHz 0xd03 Full: INT 3.96 FP 5.86</li>\n<li>9010 E-Core 2.2 GHz 0xd42 Full: INT 3.21 FP 4.72</li>\n</ul>\n<p>\u8be6\u7ec6\u6570\u636e\uff1a <a href=\"https://github.com/jiegec/SPECCPU2017Harmony/tree/master/results\">https://github.com/jiegec/SPECCPU2017Harmony/tree/master/results</a>\u3002Best \u4ee3\u8868\u6bcf\u4e00\u9879\u5355\u72ec\u8dd1\uff0c\u6563\u70ed\u6761\u4ef6\u597d\uff0cFull \u4ee3\u8868\u987a\u7740\u8dd1\u4e00\u904d\uff0c\u6563\u70ed\u6761\u4ef6\u5dee\u3002\u7531\u4e8e\u7f16\u8bd1\u5668\u548c\u7f16\u8bd1\u9009\u9879\u4e0d\u540c\uff0c\u4e0d\u80fd\u548c\u5728\u5176\u4ed6\u5e73\u53f0\u4e0a\u8dd1\u7684 SPEC CPU 2017 \u6210\u7ee9\u76f4\u63a5\u5bf9\u6bd4\uff0c\u4ec5\u4f9b\u53c2\u8003\u3002</p>\n<p>\u5927\u6982\u6027\u80fd\u6392\u5e8f\uff1aX90 P-Core &gt; X90 E-Core &gt; 9010 P-Core &gt; X90 LPE-Core &gt; 9010 E-Core &gt; 9010 LPE-Core\u3002</p>\n<p>\u5373\u4f7f\u662f\u540c\u6837\u7684 2.3 GHz 0xd03 \u7684\u6838\uff0cX90 \u6bd4 9010 \u5feb\u4e0a 20%\uff1a\u53ef\u80fd\u662f\u6563\u70ed\u95ee\u9898\uff0c\u6216\u8005\u7f13\u5b58\u5927\u5c0f\u548c\u5185\u5b58\u5e26\u5bbd\u7684\u95ee\u9898\uff0c\u6216\u8bb8\u8fde\u5fae\u67b6\u6784\u90fd\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u8fd9\u4e9b\u90fd\u9700\u8981\u540e\u7eed\u8fdb\u4e00\u6b65\u6d4b\u8bd5\u3002\u800c X90 \u7684\u4e2d\u6838\u4e5f\u6bd4 9010 \u7684\u5927\u6838\u8981\u5feb\u3002</p>\n<h3 id=\"codearts-ide\">CodeArts IDE<a class=\"headerlink\" href=\"#codearts-ide\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8bd5\u4e86\u4e00\u4e0b\u4ece\u5e94\u7528\u5546\u57ce\u5b89\u88c5\u7684 CodeArts IDE\uff0c\u663e\u793a\u652f\u6301 Java \u548c Python \u5f00\u53d1\uff0cUI \u4e0a\u6709\u70b9\u50cf JetBrains\uff0c\u4f46\u5e94\u8be5\u662f\u57fa\u4e8e VSCode \u505a\u7684\u4e8c\u6b21\u5f00\u53d1\u3002\u5b9e\u9645\u6d4b\u4e86\u4e00\u4e0b\uff0c\u7528\u5b83\u521b\u5efa Python \u9879\u76ee\u540e\uff0c\u53ef\u4ee5\u5728 CodeArts IDE \u7684\u547d\u4ee4\u884c\u91cc\u7528 Python3\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>$<span class=\"w\"> </span><span class=\"nb\">pwd</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>/storage/Users/currentUser/IDEProjects/pythonProject\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>$<span class=\"w\"> </span>python3<span class=\"w\"> </span>main.py\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>Hello<span class=\"w\"> </span>World!\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>$<span class=\"w\"> </span>which<span class=\"w\"> </span>python3\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>/storage/Users/currentUser/IDEProjects/pythonProject/venv/bin/python3o\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>$<span class=\"w\"> </span>/data/app/bin/python<span class=\"w\"> </span>--version\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>Python<span class=\"w\"> </span><span class=\"m\">3</span>.12.5\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u7684 <code>/storage/Users/currentUser/</code> \u5c31\u662f HOME \u76ee\u5f55\uff0c\u5bf9\u5e94\u6587\u4ef6\u7ba1\u7406\u5668\u7684\u4e2a\u4eba\u76ee\u5f55\u3002</p>\n<p>\u770b\u4e86\u770b <code>/data/app/bin</code> \u76ee\u5f55\uff0c\u4e0b\u9762\u6709 git\uff0cpython\uff0cunzip, vi\uff0crg\uff0cjava\uff08bisheng jdk 8/17\uff09\uff0cssh\uff0celectron\uff08\u7528\u6765\u8dd1 LSP\uff01\uff09\u7b49\u7b49\u3002</p>\n<p>\u8bd5\u4e86\u8bd5 pip\uff0c\u4e5f\u662f\u5de5\u4f5c\u7684\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"o\">(</span>venv<span class=\"o\">)</span><span class=\"w\"> </span>$<span class=\"w\"> </span>python3<span class=\"w\"> </span>-m<span class=\"w\"> </span>pip<span class=\"w\"> </span>install<span class=\"w\"> </span>requests\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"o\">(</span>venv<span class=\"o\">)</span><span class=\"w\"> </span>$<span class=\"w\"> </span>python3\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>Python<span class=\"w\"> </span><span class=\"m\">3</span>.12.5<span class=\"w\"> </span><span class=\"o\">(</span>main,<span class=\"w\"> </span>Aug<span class=\"w\"> </span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"m\">2024</span>,<span class=\"w\"> </span><span class=\"m\">01</span>:18:17<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>Clang<span class=\"w\"> </span><span class=\"m\">15</span>.0.4<span class=\"w\"> </span><span class=\"o\">(</span>llvm-project<span class=\"w\"> </span>81cdec3cd117b1e6e3a9f1ebc4695d790c978463<span class=\"o\">)]</span><span class=\"w\"> </span>on<span class=\"w\"> </span>linux\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>Type<span class=\"w\"> </span><span class=\"s2\">&quot;help&quot;</span>,<span class=\"w\"> </span><span class=\"s2\">&quot;copyright&quot;</span>,<span class=\"w\"> </span><span class=\"s2\">&quot;credits&quot;</span><span class=\"w\"> </span>or<span class=\"w\"> </span><span class=\"s2\">&quot;license&quot;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>more<span class=\"w\"> </span>information.\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a>&gt;&gt;&gt;<span class=\"w\"> </span>import<span class=\"w\"> </span>requests\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a>&gt;&gt;&gt;<span class=\"w\"> </span>requests.get<span class=\"o\">(</span><span class=\"s2\">&quot;https://github.com&quot;</span><span class=\"o\">)</span>.status_code\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"m\">200</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a>&gt;&gt;&gt;<span class=\"w\"> </span>\n</span></code></pre></div>\n<p>\u9700\u8981 native \u7f16\u8bd1\u7684\u5e93\uff0c\u6bd4\u5982 numpy \u8fd8\u4e0d\u884c\uff0c\u4f1a\u63d0\u793a\u627e\u4e0d\u5230 make\u3002</p>\n<p>\u7ec8\u7aef\u91cc\u7684 ssh \u662f\u53ef\u4ee5\u7528\u7684\uff0c\u5b9e\u6d4b ssh \u5230\u8fdc\u7a0b\u7684 linux \u4e0a\u662f\u6ca1\u95ee\u9898\u7684\u3002</p>\n<p>\u7ec8\u7aef\u91cc\u7684\u62ec\u53f7\u8865\u5168\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u7b49\u5f85\u4fee\u590d\u3002CodeArts IDE \u7684 Python \u5355\u6b65\u8c03\u8bd5\u529f\u80fd\u4e5f\u662f\u5de5\u4f5c\u7684\u3002</p>\n<p>\u4f3c\u4e4e\u6ca1\u6709\u5b89\u88c5 Remote \u5f00\u53d1\u7684\u63d2\u4ef6\uff0c\u4e5f\u6ca1\u6709\u5b89\u88c5\u63d2\u4ef6\u7684\u83dc\u5355\u3002</p>\n<p>\u65e2\u7136\u53ef\u4ee5\u8dd1 shell\uff0c\u610f\u5473\u7740\u53ef\u4ee5 execve \u4e86\uff0c\u610f\u5473\u7740\u53ef\u4ee5\u505a termux \u7684\u7c7b\u4f3c\u7269\u4e86\u3002\u671f\u5f85\u9e3f\u8499 5 \u4e0a\u65e9\u65e5\u6709 Termux \u7528\uff0c\u76f4\u63a5\u8dd1 Linux \u53d1\u884c\u7248\u3002\u5b9e\u9645\u6d4b\u4e86\u4e00\u4e0b\uff0cPopen \u786e\u5b9e\u662f\u5de5\u4f5c\u7684\u3002</p>\n<p>UPDATE: \u5f00\u4e86\u4e2a\u5751\uff1a<a href=\"https://github.com/jiegec/Termony\">https://github.com/jiegec/Termony</a>\uff0c\u76ee\u524d\u5df2\u7ecf\u80fd\u8dd1\u5f88\u591a\u547d\u4ee4\u4e86\uff0c\u5305\u62ec\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u7f16\u8bd1 C/C++ \u4ee3\u7801\u3002</p>\n<p>\u8bd5\u4e86\u4e00\u4e0b HOME \u76ee\u5f55\uff0c\u53d1\u73b0\u5b83\u91cc\u9762\u4e0d\u80fd\u6709\u53ef\u6267\u884c\u7684\u6587\u4ef6\uff0c\u6240\u4ee5\u53ef\u80fd\u8fd8\u662f\u5f97\u6253\u5305\u5230\u4e00\u4e2a App \u91cc\u9762\uff0c\u901a\u8fc7 <code>/data/app/bin</code> \u7c7b\u4f3c\u7684\u8def\u5f84\u6765\u8bbf\u95ee\u3002</p>\n<p>\u5728 CodeArts IDE \u91cc\uff0c\u53ef\u4ee5\u8bbf\u95ee /data/storage/el1/bundle \u76ee\u5f55\uff0c\u91cc\u9762\u6709\u4e00\u4e2a pc_entry.hap \u6587\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>cat /data/storage/el1/bundle/pc_entry.hap | ssh hostname \"cat - &gt; pc_entry.hap\"</code> \u62f7\u8d1d\u5230\u5176\u4ed6\u673a\u5668\u4e0a\u3002\u8fd9\u4e2a\u6587\u4ef6\u6709 1.9GB\uff0c\u53ef\u4ee5\u770b\u5230\u5728 <code>/data/app</code> \u4e0b\u9762\u7684\u5404\u79cd\u6587\u4ef6\uff0c\u5176\u5b9e\u662f\u6765\u81ea\u4e8e\u8fd9\u4e2a <code>pc_entry.hap</code> \u7684 <code>hnp/arm64-v8a</code> \u4e0b\u9762\u7684\u4e00\u7cfb\u5217\u6587\u4ef6\uff0c\u4f8b\u5982 <code>git.hnp</code> \u5c31\u662f\u4e00\u4e2a zip \u538b\u7f29\u5305\uff0c\u91cc\u9762\u5c31\u662f <code>/data/app/git.org/git_1.2</code> \u76ee\u5f55\u7684\u5185\u5bb9\uff0c\u8fd9\u4e2a\u4e1c\u897f\u53eb\u505a <code>\u5e94\u7528\u5305\u5185 Native \u5305\uff08.hnp\uff09</code>\u3002\u8fd9\u4e9b\u6587\u4ef6\u5728 module.json \u91cc\u58f0\u660e\uff0c\u5bf9\u5e94 <a href=\"https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file#hnppackages%E6%A0%87%E7%AD%BE\">hnpPackages \u6807\u7b7e</a>\uff1a</p>\n<div class=\"language-json highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">  </span><span class=\"nt\">&quot;module&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;hnpPackages&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;electron.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">      </span><span class=\"p\">},</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;huaweicloud-smartassist-java-ls.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">      </span><span class=\"p\">},</span>\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;bishengjdk8.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-15\"><a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\" href=\"#__codelineno-3-15\"></a><span class=\"w\">      </span><span class=\"p\">},</span>\n</span><span id=\"__span-3-16\"><a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\" href=\"#__codelineno-3-16\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-17\"><a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\" href=\"#__codelineno-3-17\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;rg.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-18\"><a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\" href=\"#__codelineno-3-18\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-19\"><a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\" href=\"#__codelineno-3-19\"></a><span class=\"w\">      </span><span class=\"p\">},</span>\n</span><span id=\"__span-3-20\"><a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\" href=\"#__codelineno-3-20\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-21\"><a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\" href=\"#__codelineno-3-21\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;unzip.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-22\"><a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\" href=\"#__codelineno-3-22\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-23\"><a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\" href=\"#__codelineno-3-23\"></a><span class=\"w\">      </span><span class=\"p\">},</span>\n</span><span id=\"__span-3-24\"><a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\" href=\"#__codelineno-3-24\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-25\"><a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\" href=\"#__codelineno-3-25\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;git.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-26\"><a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\" href=\"#__codelineno-3-26\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-27\"><a id=\"__codelineno-3-27\" name=\"__codelineno-3-27\" href=\"#__codelineno-3-27\"></a><span class=\"w\">      </span><span class=\"p\">},</span>\n</span><span id=\"__span-3-28\"><a id=\"__codelineno-3-28\" name=\"__codelineno-3-28\" href=\"#__codelineno-3-28\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-29\"><a id=\"__codelineno-3-29\" name=\"__codelineno-3-29\" href=\"#__codelineno-3-29\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;bishengjdk17.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-30\"><a id=\"__codelineno-3-30\" name=\"__codelineno-3-30\" href=\"#__codelineno-3-30\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-31\"><a id=\"__codelineno-3-31\" name=\"__codelineno-3-31\" href=\"#__codelineno-3-31\"></a><span class=\"w\">      </span><span class=\"p\">},</span>\n</span><span id=\"__span-3-32\"><a id=\"__codelineno-3-32\" name=\"__codelineno-3-32\" href=\"#__codelineno-3-32\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-33\"><a id=\"__codelineno-3-33\" name=\"__codelineno-3-33\" href=\"#__codelineno-3-33\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;package&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;python.hnp&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-34\"><a id=\"__codelineno-3-34\" name=\"__codelineno-3-34\" href=\"#__codelineno-3-34\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;private&quot;</span>\n</span><span id=\"__span-3-35\"><a id=\"__codelineno-3-35\" name=\"__codelineno-3-35\" href=\"#__codelineno-3-35\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-36\"><a id=\"__codelineno-3-36\" name=\"__codelineno-3-36\" href=\"#__codelineno-3-36\"></a><span class=\"w\">    </span><span class=\"p\">],</span>\n</span><span id=\"__span-3-37\"><a id=\"__codelineno-3-37\" name=\"__codelineno-3-37\" href=\"#__codelineno-3-37\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;name&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;pc_entry&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-38\"><a id=\"__codelineno-3-38\" name=\"__codelineno-3-38\" href=\"#__codelineno-3-38\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;packageName&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;pc_entry&quot;</span>\n</span><span id=\"__span-3-39\"><a id=\"__codelineno-3-39\" name=\"__codelineno-3-39\" href=\"#__codelineno-3-39\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-40\"><a id=\"__codelineno-3-40\" name=\"__codelineno-3-40\" href=\"#__codelineno-3-40\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u89e3\u538b <code>git.hnp</code> \u540e\uff0c\u91cc\u9762\u7684\u6587\u4ef6\u4f1a\u88ab\u590d\u5236\u5230 <code>/data/app/git.org/git_1.2</code> \u76ee\u5f55\u4e0b\uff0c\u7136\u540e\u6709\u4e00\u4e2a <code>hnp.json</code> \u6307\u5b9a\u4e86\u5728 <code>/data/app/bin</code> \u521b\u5efa\u54ea\u4e9b\u6587\u4ef6\u7684\u8f6f\u8fde\u63a5\uff0c\u6bd4\u5982\uff1a</p>\n<div class=\"language-json highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;install&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"w\">        </span><span class=\"nt\">&quot;links&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"w\">            </span><span class=\"p\">{</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"w\">                </span><span class=\"nt\">&quot;source&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;bin/expr&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"w\">                </span><span class=\"nt\">&quot;target&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;expr&quot;</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"w\">            </span><span class=\"p\">},</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"w\">            </span><span class=\"p\">{</span>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"w\">                </span><span class=\"nt\">&quot;source&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;bin/git&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"w\">                </span><span class=\"nt\">&quot;target&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;git&quot;</span>\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"w\">        </span><span class=\"p\">]</span>\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a><span class=\"w\">    </span><span class=\"p\">},</span>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;name&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;git&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;type&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;hnp-config&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">    </span><span class=\"nt\">&quot;version&quot;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;1.2&quot;</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5728 HarmonyOS SDK \u91cc\uff0c\u6709\u4e00\u4e2a hnpcli\uff0c\u53ef\u4ee5\u7528\u6765\u751f\u6210 .hnp \u6587\u4ef6\u3002</p>\n<p>\u9664\u6b64\u4e4b\u5916\uff0c\u5c31\u662f VSCode \u52a0\u5404\u79cd\u63d2\u4ef6\u4e86\u3002</p>\n<p>\u9e3f\u8499\u7535\u8111\u4e0a\uff0c\u53ef\u4ee5\u8bbf\u95ee\u5404\u4e2a App \u7684\u5185\u90e8\u76ee\u5f55\u4e86\uff0c\u65e0\u8bba\u662f\u81ea\u5e26\u7684\u6587\u4ef6\u6d4f\u89c8\u5668\uff0c\u8fd8\u662f\u901a\u8fc7 DevEco Studio\u3002\u8fd9\u7ed9\u8c03\u8bd5\u5e26\u6765\u4e86\u5f88\u591a\u4fbf\u5229\u3002</p>\n<p>UPDATE: 2025-06-21 \u63a8\u9001\u4e86 1.0.3 \u7248\u672c\u3002\u5b9e\u6d4b\u5728 shell \u91cc\u9762\u8f93\u5165\u62ec\u53f7\uff0c\u4e0d\u4f1a\u51fa\u73b0\u62ec\u53f7\u8865\u5168\u8dd1\u5230\u9519\u8bef\u7684\u4f4d\u7f6e\u7684\u95ee\u9898\u4e86\u3002</p>\n<p>UPDATE: 2025-12-01 \u5c1d\u8bd5 CodeArts 1.0.9 \u7248\u672c\uff0c\u53ef\u4ee5\u521b\u5efa C++ \u9879\u76ee\u4e86\uff0c\u7f16\u8bd1\u6ca1\u95ee\u9898\u5e76\u4e14\u6709\u81ea\u7b7e\u540d\u7684\u63d0\u793a\uff0c\u4f46\u662f\u6267\u884c\u7f16\u8bd1\u51fa\u6765\u7684\u7a0b\u5e8f\u8fd8\u662f\u4f1a\u62a5\u9519\uff0c\u4f30\u8ba1\u8fd8\u662f\u81ea\u7b7e\u540d\u7684\u673a\u5236\u8fd8\u6709\u95ee\u9898\u3002</p>\n<p>UPDATE: 2025-12-11 \u7ecf @w12101111 \u7fa4\u53cb\u63d0\u9192\uff0c\u5728\u8bbe\u7f6e-&gt;\u9690\u79c1\u548c\u5b89\u5168-&gt;\u9ad8\u7ea7-&gt;\u52fe\u9009\u8fd0\u884c\u5916\u90e8\u6765\u6e90\u7684\u6269\u5c55\u7a0b\u5e8f\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5728 CodeArts IDE \u91cc\u8fd0\u884c\u548c\u8c03\u8bd5\u7f16\u8bd1\u51fa\u6765\u7684 C++ \u7a0b\u5e8f\u4e86\u3002\u81f3\u6b64\uff0c\u9e3f\u8499\u7535\u8111\u81ea\u5df1\u8fd0\u884c\u81ea\u5df1\u7f16\u8bd1\u7684 ELF \u5df2\u7ecf\u662f\u53ef\u884c\u7684\u4e86\u3002</p>\n<h3 id=\"deveco-studio\">DevEco Studio<a class=\"headerlink\" href=\"#deveco-studio\" title=\"Permanent link\">&para;</a></h3>\n<p>2025-12-01 \u62ff\u5230\u4e86 DevEco Studio \u7684\u5185\u6d4b\u8d44\u683c\uff08\u76f4\u63a5\u7f51\u4e0a\u7533\u8bf7\u5373\u53ef\uff09\uff0c\u6d4b\u8bd5\u4e86\u4e00\u4e0b DevEco Studio 6.0.5.220 \u9e3f\u8499\u9884\u89c8\u7248\u3002\u76ee\u524d\u80fd\u591f\u6784\u5efa hap\uff0c\u5e76\u4e14\u5b89\u88c5\u5728\u9e3f\u8499\u7535\u8111\u4e0a\uff0c\u901a\u8fc7 USB \u8fde\u63a5\u9e3f\u8499\u624b\u673a\u4e5f\u53ef\u4ee5\u6b63\u5e38\u5b89\u88c5\u3002</p>\n<h2 id=\"\u865a\u62df\u673a\">\u865a\u62df\u673a<a class=\"headerlink\" href=\"#\u865a\u62df\u673a\" title=\"Permanent link\">&para;</a></h2>\n<p>\u76ee\u524d\u5e94\u7528\u5546\u57ce\u6709\u4e24\u5bb6\u865a\u62df\u673a\uff1aOseasy \u548c\u94e0\u5927\u5e08\u3002\u4e24\u8005\u90fd\u662f\u63d0\u793a\u5b89\u88c5 ARM64 \u7248\u672c\u7684 Windows\uff0c\u5c1d\u8bd5\u4e86\u4e00\u4e0b\u7ed9\u5b83\u4e00\u4e2a Debian \u7684\u5b89\u88c5 ISO\uff0c\u5b83\u4e0d\u8ba4\u3002\u7528\u7684 unattended install\uff0c\u4e0d\u9700\u8981\u8fdb\u884c\u4ec0\u4e48\u64cd\u4f5c\u3002Oseasy \u548c\u94e0\u5927\u5e08\u7684\u865a\u62df\u673a\u4e0d\u80fd\u540c\u65f6\u5f00\uff0c\u4f46\u662f\u53ef\u4ee5\u4e00\u8fb9\u5b89\u88c5\u5b8c\uff0c\u518d\u53bb\u5b89\u88c5\u53e6\u4e00\u8fb9\u7684 Windows\u3002</p>\n<p>\u8bd5\u4e86\u8bd5\u5728\u865a\u62df\u673a\u91cc\u88c5 WSL\uff0c\u8bf4\u6ca1\u6709\u786c\u4ef6\u865a\u62df\u5316\uff0c\u5927\u6982\u662f\u6ca1\u6709\u6253\u5f00\u5d4c\u5957\u865a\u62df\u5316\u7684\u529f\u80fd\u3002</p>\n<p>\u5728 6 \u6838 Oseasy \u865a\u62df\u673a\u91cc\u8fd0\u884c ARM64 Geekbench 6\uff1a<a href=\"https://browser.geekbench.com/v6/cpu/12309313\">Single-Core 1436, Multi-Core 5296</a>\u3002Oseasy 8 \u6838\uff1a<a href=\"https://browser.geekbench.com/v6/cpu/12309427\">Single-Core 1462, Multi-Core 7043</a>\u3002\u7b97\u4e0a\u5269\u4e0b\u7684 12 \u4e2a\u903b\u8f91\u6838\uff0c\u8003\u8651\u865a\u62df\u5316\u7684\u5f00\u9500\uff0c\u591a\u6838\u5206\u6570\u8fbe\u5230\u7f51\u4f20\u7684 11640 \u5206\uff0c\u611f\u89c9\u662f\u53ef\u80fd\u7684\u3002</p>\n<p>Oseasy \u865a\u62df\u673a\u53ea\u5141\u8bb8\u5f00\u5230 8 \u4e2a\u6838\u5fc3\uff0c\u5b9e\u6d4b\u4e0b\u6765\uff0c\u4f1a\u4f18\u5148\u8c03\u5ea6\u5230 0xD03 \u7684\u516b\u4e2a\u903b\u8f91\u6838\u4e2d\u5176\u4e2d\u56db\u4e2a\u903b\u8f91\u6838\uff08\u4e0d\u540c\u65f6\u7528\u4e00\u4e2a\u7269\u7406\u6838\u7684\u4e24\u4e2a\u903b\u8f91\u6838\uff09\uff0c\u4e4b\u540e\u518d\u8c03\u5ea6\u5230 0xD43 \u7684\u516b\u4e2a\u903b\u8f91\u6838\u4e2d\u7684\u56db\u4e2a\u903b\u8f91\u6838\uff08\u4e5f\u4e0d\u540c\u65f6\u7528\u540c\u4e00\u4e2a\u7269\u7406\u6838\u7684\u4e24\u4e2a\u903b\u8f91\u6838\uff09\u3002\u5728 Oseasy \u865a\u62df\u673a\u91cc\u770b\u5230\u7684 CPU \u4fe1\u606f\u662f Cortex-A53\uff0c\u6ca1\u6709\u6b63\u786e\u66b4\u9732\u5916\u9762\u7684\u5904\u7406\u5668\u4fe1\u606f\uff0c\u4ece cpuinfo \u6765\u770b\uff0c\u4e5f\u6ca1\u6709\u66b4\u9732 SVE\u3002</p>\n<p>UPDATE: \u80fd\u8dd1 Linux \u4e86\uff0c\u89c1 <a href=\"../../10/linux-vm-on-harmonyos-computer/\">\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u7684\u865a\u62df\u673a\u5185\u542f\u52a8 Linux</a>\u3002</p>\n<h2 id=\"\u5916\u8bbe\">\u5916\u8bbe<a class=\"headerlink\" href=\"#\u5916\u8bbe\" title=\"Permanent link\">&para;</a></h2>\n<p>\u628a Type-C Hub \u63a5\u5230 MateBook Pro \u4e0a\uff0c\u663e\u793a\u5668\uff0c\u952e\u76d8\u9f20\u6807\u90fd\u6b63\u5e38\u5de5\u4f5c\u4e86\u3002</p>\n<h2 id=\"\u4fa7\u8f7d\">\u4fa7\u8f7d<a class=\"headerlink\" href=\"#\u4fa7\u8f7d\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6253\u5f00\u5f00\u53d1\u8005\u6a21\u5f0f\u540e\uff0c\u5728\u8bbe\u7f6e\u91cc\uff0c\u53ef\u4ee5\u6253\u5f00 USB \u8c03\u8bd5\uff1a\u628a\u7535\u8111\u53f3\u8fb9\u7684 USB Type-C \u63a5\u5230\u53e6\u4e00\u53f0\u7535\u8111\u4e0a\uff0c\u5c31\u53ef\u4ee5\u7528 hdc \u8fde\u63a5\u4e86\u3002</p>\n<p>\u7136\u540e\u7ed9\u81ea\u5df1\u7684\u9879\u76ee\u52a0\u4e0a 2in1 \u7684 device type\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a>diff --git a/entry/build-profile.json5 b/entry/build-profile.json5\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a>index 38bdcc9..ad6fd45 100644\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a>--- a/entry/build-profile.json5\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a>+++ b/entry/build-profile.json5\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a>@@ -30,7 +30,13 @@\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>   ],\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>   &quot;targets&quot;: [\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a>     {\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a>-      &quot;name&quot;: &quot;default&quot;\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a>+      &quot;name&quot;: &quot;default&quot;,\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a>+      &quot;config&quot;: {\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a>+        &quot;deviceType&quot;: [\n</span><span id=\"__span-5-13\"><a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\" href=\"#__codelineno-5-13\"></a>+          &quot;default&quot;,\n</span><span id=\"__span-5-14\"><a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\" href=\"#__codelineno-5-14\"></a>+          &quot;2in1&quot;\n</span><span id=\"__span-5-15\"><a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\" href=\"#__codelineno-5-15\"></a>+        ]\n</span><span id=\"__span-5-16\"><a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\" href=\"#__codelineno-5-16\"></a>+      }\n</span><span id=\"__span-5-17\"><a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\" href=\"#__codelineno-5-17\"></a>     },\n</span><span id=\"__span-5-18\"><a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\" href=\"#__codelineno-5-18\"></a>     {\n</span><span id=\"__span-5-19\"><a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\" href=\"#__codelineno-5-19\"></a>       &quot;name&quot;: &quot;ohosTest&quot;,\n</span><span id=\"__span-5-20\"><a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\" href=\"#__codelineno-5-20\"></a>diff --git a/entry/src/main/module.json5 b/entry/src/main/module.json5\n</span><span id=\"__span-5-21\"><a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\" href=\"#__codelineno-5-21\"></a>index 7b8532f..76c009c 100644\n</span><span id=\"__span-5-22\"><a id=\"__codelineno-5-22\" name=\"__codelineno-5-22\" href=\"#__codelineno-5-22\"></a>--- a/entry/src/main/module.json5\n</span><span id=\"__span-5-23\"><a id=\"__codelineno-5-23\" name=\"__codelineno-5-23\" href=\"#__codelineno-5-23\"></a>+++ b/entry/src/main/module.json5\n</span><span id=\"__span-5-24\"><a id=\"__codelineno-5-24\" name=\"__codelineno-5-24\" href=\"#__codelineno-5-24\"></a>@@ -5,7 +5,8 @@\n</span><span id=\"__span-5-25\"><a id=\"__codelineno-5-25\" name=\"__codelineno-5-25\" href=\"#__codelineno-5-25\"></a>     &quot;description&quot;: &quot;$string:module_desc&quot;,\n</span><span id=\"__span-5-26\"><a id=\"__codelineno-5-26\" name=\"__codelineno-5-26\" href=\"#__codelineno-5-26\"></a>     &quot;mainElement&quot;: &quot;EntryAbility&quot;,\n</span><span id=\"__span-5-27\"><a id=\"__codelineno-5-27\" name=\"__codelineno-5-27\" href=\"#__codelineno-5-27\"></a>     &quot;deviceTypes&quot;: [\n</span><span id=\"__span-5-28\"><a id=\"__codelineno-5-28\" name=\"__codelineno-5-28\" href=\"#__codelineno-5-28\"></a>-      &quot;default&quot;\n</span><span id=\"__span-5-29\"><a id=\"__codelineno-5-29\" name=\"__codelineno-5-29\" href=\"#__codelineno-5-29\"></a>+      &quot;default&quot;,\n</span><span id=\"__span-5-30\"><a id=\"__codelineno-5-30\" name=\"__codelineno-5-30\" href=\"#__codelineno-5-30\"></a>+      &quot;2in1&quot;\n</span><span id=\"__span-5-31\"><a id=\"__codelineno-5-31\" name=\"__codelineno-5-31\" href=\"#__codelineno-5-31\"></a>     ],\n</span><span id=\"__span-5-32\"><a id=\"__codelineno-5-32\" name=\"__codelineno-5-32\" href=\"#__codelineno-5-32\"></a>     &quot;requestPermissions&quot;: [\n</span><span id=\"__span-5-33\"><a id=\"__codelineno-5-33\" name=\"__codelineno-5-33\" href=\"#__codelineno-5-33\"></a>       {\n</span></code></pre></div>\n<p>\u5c31\u53ef\u4ee5\u5728\u9e3f\u8499\u7535\u8111\u4e0a\u8dd1\u4e86\u3002\u6211\u7f16\u5199\u7684\u4e24\u4e2a\u9e3f\u8499\u4e0a\u7684\u5e94\u7528\uff1a<a href=\"https://github.com/jiegec/SPECCPU2017Harmony\">https://github.com/jiegec/SPECCPU2017Harmony</a> \u548c <a href=\"https://github.com/jiegec/NetworkToolsHarmony\">https://github.com/jiegec/NetworkToolsHarmony</a> \u90fd\u80fd\u6b63\u5e38\u5728 MateBook Pro \u4e0a\u8fd0\u884c\u3002</p>\n<p>\u6d4b\u8bd5\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u7528 hdc \u4f20\u6587\u4ef6\u5230\u7535\u8111\u6bd4\u4f20\u624b\u673a\u66f4\u5feb\uff1aPura 70 Pro+ \u662f 24 MB/s\uff0cMateBook Pro \u662f 31 MB/s\u3002</p>\n<p>\u5f00\u6e90\u7684\u9e3f\u8499\u5e94\u7528\u4e5f\u53ef\u4ee5\u7f16\u8bd1 + \u8fd0\u884c\uff1a</p>\n<ul>\n<li><a href=\"https://gitee.com/smdsbz/moonlight-ohos\">https://gitee.com/smdsbz/moonlight-ohos</a></li>\n</ul>\n<p>\u76ee\u524d\u8fd8\u6ca1\u627e\u5230\u600e\u4e48\u8ba9\u9e3f\u8499\u7535\u8111\u81ea\u5df1\u8c03\u8bd5\u81ea\u5df1\u3002</p>\n<h2 id=\"\u5353\u6613\u901a\">\u5353\u6613\u901a<a class=\"headerlink\" href=\"#\u5353\u6613\u901a\" title=\"Permanent link\">&para;</a></h2>\n<p>2025-12-15\uff1a\u5728\u5e94\u7528\u5e02\u573a\u7684\u5e94\u7528\u5c1d\u9c9c\u91cc\u770b\u5230\u4e86\u5353\u6613\u901a\uff0c\u76ee\u524d\u53ea\u80fd\u5168\u5c4f\u6253\u5f00 Android \u5e94\u7528\u3002\u8bd5\u4e86\u4e00\u4e0b Duolinguo\uff0c\u662f\u5de6\u53f3\u5206\u5c4f\u7684\u663e\u793a\u65b9\u5f0f\uff0c\u6709\u70b9\u7c7b\u4f3c\u53cc\u6298\u53e0\u624b\u673a\uff0c\u5de6\u53f3\u5404\u4e00\u4e2a\u7ad6\u5c4f\u3002</p>\n<h2 id=\"\u79fb\u690d\u95ee\u9898\">\u79fb\u690d\u95ee\u9898<a class=\"headerlink\" href=\"#\u79fb\u690d\u95ee\u9898\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li>ioctl(fd, TCSETS) \u4f1a\u5931\u8d25\uff0cioctl(fd, TCSETSW) \u5219\u6210\u529f</li>\n<li>libc \u7f3a\u5c11\u4e00\u4e9b\u51fd\u6570\uff0c\u6bd4\u5982 getspnam\uff0c\u6709\u4e00\u4e9b\u51fd\u6570\u4e0d\u53ef\u7528\uff0c\u4f8b\u5982 getpwuid</li>\n<li>openssl \u7684 hwcap \u68c0\u6d4b\u6709\u95ee\u9898\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4 sigill</li>\n<li>\u65e0\u6cd5\u8bbf\u95ee /proc/stat</li>\n</ul>\n<h2 id=\"termony\">Termony<a class=\"headerlink\" href=\"#termony\" title=\"Permanent link\">&para;</a></h2>\n<p>\u76ee\u524d\u901a\u8fc7 <a href=\"https://github.com/jiegec/Termony\">https://github.com/jiegec/Termony</a> \u8fd0\u884c\u4e86\u4e00\u4e9b benchmark\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a>$<span class=\"w\"> </span>vkpeak<span class=\"w\"> </span><span class=\"m\">0</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"nv\">device</span><span class=\"w\">       </span><span class=\"o\">=</span><span class=\"w\"> </span>Maleoon<span class=\"w\"> </span><span class=\"m\">916</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a>fp32-scalar<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">718</span>.54<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a>fp32-vec4<span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1038</span>.34<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a>\n</span><span id=\"__span-6-7\"><a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\" href=\"#__codelineno-6-7\"></a>fp16-scalar<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1083</span>.84<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-8\"><a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\" href=\"#__codelineno-6-8\"></a>fp16-vec4<span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1791</span>.44<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-9\"><a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\" href=\"#__codelineno-6-9\"></a>fp16-matrix<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-10\"><a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\" href=\"#__codelineno-6-10\"></a>\n</span><span id=\"__span-6-11\"><a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\" href=\"#__codelineno-6-11\"></a>fp64-scalar<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-12\"><a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\" href=\"#__codelineno-6-12\"></a>fp64-vec4<span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-13\"><a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\" href=\"#__codelineno-6-13\"></a>\n</span><span id=\"__span-6-14\"><a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\" href=\"#__codelineno-6-14\"></a>int32-scalar<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">303</span>.34<span class=\"w\"> </span>GIOPS\n</span><span id=\"__span-6-15\"><a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\" href=\"#__codelineno-6-15\"></a>int32-vec4<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">316</span>.56<span class=\"w\"> </span>GIOPS\n</span><span id=\"__span-6-16\"><a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\" href=\"#__codelineno-6-16\"></a>\n</span><span id=\"__span-6-17\"><a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\" href=\"#__codelineno-6-17\"></a>int16-scalar<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">709</span>.12<span class=\"w\"> </span>GIOPS\n</span><span id=\"__span-6-18\"><a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\" href=\"#__codelineno-6-18\"></a>int16-vec4<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">830</span>.55<span class=\"w\"> </span>GIOPS\n</span><span id=\"__span-6-19\"><a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\" href=\"#__codelineno-6-19\"></a>\n</span><span id=\"__span-6-20\"><a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\" href=\"#__codelineno-6-20\"></a>int8-dotprod<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>GIOPS\n</span><span id=\"__span-6-21\"><a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\" href=\"#__codelineno-6-21\"></a>int8-matrix<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>GIOPS\n</span><span id=\"__span-6-22\"><a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\" href=\"#__codelineno-6-22\"></a>\n</span><span id=\"__span-6-23\"><a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\" href=\"#__codelineno-6-23\"></a>bf16-dotprod<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>GFLOPS\n</span><span id=\"__span-6-24\"><a id=\"__codelineno-6-24\" name=\"__codelineno-6-24\" href=\"#__codelineno-6-24\"></a>bf16-matrix<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span>.00<span class=\"w\"> </span>GFLOPS\n</span></code></pre></div>\n<h2 id=\"\u672a\u5b8c\u5f85\u7eed\">\u672a\u5b8c\u5f85\u7eed<a class=\"headerlink\" href=\"#\u672a\u5b8c\u5f85\u7eed\" title=\"Permanent link\">&para;</a></h2>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/huawei-matebook-pro.png", "date_modified": "2025-06-06T00:00:00+00:00", "date_published": "2025-06-06T00:00:00+00:00", "authors": [], "tags": ["arm64", "hardware", "harmonyos", "huawei", "matebook", "matebookpro"]}, {"id": "https://jia.je/hardware/2025/06/06/using-fortran-on-harmonyos-5/", "url": "https://jia.je/hardware/2025/06/06/using-fortran-on-harmonyos-5/", "title": "\u5728 HarmonyOS 5 \u4e0a\u8fd0\u884c Fortran \u7a0b\u5e8f", "content_html": "<h1 id=\"\u5728-harmonyos-5-\u4e0a\u8fd0\u884c-fortran-\u7a0b\u5e8f\">\u5728 HarmonyOS 5 \u4e0a\u8fd0\u884c Fortran \u7a0b\u5e8f<a class=\"headerlink\" href=\"#\u5728-harmonyos-5-\u4e0a\u8fd0\u884c-fortran-\u7a0b\u5e8f\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u6bb5\u65f6\u95f4\u628a SPEC CPU 2017 \u79fb\u690d\u5230\u4e86\u9e3f\u8499 5 \u4e0a\uff1a<a href=\"https://github.com/jiegec/SPECCPU2017Harmony\">https://github.com/jiegec/SPECCPU2017Harmony</a>\uff0c\u7531\u4e8e SPEC CPU 2017 \u91cc\u6709\u4e0d\u5c11 Fortran \u7a0b\u5e8f\uff0c\u6240\u4ee5\u5c31\u7814\u7a76\u4e86\u4e00\u4e0b\u600e\u4e48\u7f16\u8bd1 Fortran \u4ee3\u7801\uff0c\u6700\u7ec8\u641e\u6210\u4e86\uff0c\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e00\u4e0b\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u8fc7\u7a0b\">\u8fc7\u7a0b<a class=\"headerlink\" href=\"#\u8fc7\u7a0b\" title=\"Permanent link\">&para;</a></h2>\n<p>HarmonyOS 5 \u7684\u5de5\u5177\u94fe\u7528\u7684\u662f LLVM 15\uff0c\u81ea\u5e26\u7684\u7f16\u8bd1\u5668\u662f clang\uff0c\u90a3\u4e2a\u65f6\u5019\u8fd8\u6ca1\u6709 LLVM flang\u3002\u4f46\u662f\uff0c\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0c\u4f7f\u7528\u65b0\u7248\u672c\u7684 flang\uff0c\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u53ea\u662f\u9700\u8981\u505a\u4e00\u4e9b\u989d\u5916\u7684\u64cd\u4f5c\u3002\u4f8b\u5982 flang \u6709\u81ea\u5df1\u7684 runtime\uff08\u7c7b\u6bd4 libgcc \u548c LLVM \u7684 compiler-rt\uff09\uff0c\u9700\u8981\u4ea4\u53c9\u7f16\u8bd1\u4e00\u4e2a arm64 \u7684\u7248\u672c\uff0c\u4e0b\u9762\u662f\u4ed3\u5e93\u4e2d <a href=\"https://github.com/jiegec/SPECCPU2017Harmony/blob/f02cbe4a043d4c1489ebfae8a190e4a1ab6ca2c8/build-flang.sh\">build-flang.sh</a> \u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"ch\">#!/bin/sh</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"c1\"># build missing libraries for aarch64-linux-ohos target</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"c1\"># assume llvm-project is cloned at $HOME/llvm-project</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"nb\">set</span><span class=\"w\"> </span>-x<span class=\"w\"> </span>-e\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>mkdir<span class=\"w\"> </span>-p<span class=\"w\"> </span>flang\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">PATH</span><span class=\"o\">=</span>~/command-line-tools/sdk/default/openharmony/native/llvm/bin:<span class=\"nv\">$PATH</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"nv\">DST</span><span class=\"o\">=</span><span class=\"nv\">$PWD</span>/flang\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span><span class=\"nv\">$HOME</span>/llvm-project\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span>main\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"c1\"># match hash in flang-new-20 --version</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>git<span class=\"w\"> </span>reset<span class=\"w\"> </span>7cf14539b644<span class=\"w\"> </span>--hard\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>libunwind\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a>rm<span class=\"w\"> </span>-rf<span class=\"w\"> </span>build\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a>mkdir<span class=\"w\"> </span>-p<span class=\"w\"> </span>build\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>build\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a>cmake<span class=\"w\"> </span>..<span class=\"w\"> </span>-G<span class=\"w\"> </span>Ninja<span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a><span class=\"w\">    </span>-DCMAKE_C_FLAGS<span class=\"o\">=</span><span class=\"s2\">&quot;-target aarch64-linux-ohos -fuse-ld=lld&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"w\">    </span>-DCMAKE_C_COMPILER<span class=\"o\">=</span><span class=\"s2\">&quot;clang&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-20\"><a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\" href=\"#__codelineno-0-20\"></a><span class=\"w\">    </span>-DCMAKE_CXX_FLAGS<span class=\"o\">=</span><span class=\"s2\">&quot;-target aarch64-linux-ohos -fuse-ld=lld&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-21\"><a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\" href=\"#__codelineno-0-21\"></a><span class=\"w\">    </span>-DCMAKE_CXX_COMPILER<span class=\"o\">=</span><span class=\"s2\">&quot;clang++&quot;</span>\n</span><span id=\"__span-0-22\"><a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\" href=\"#__codelineno-0-22\"></a>ninja\n</span><span id=\"__span-0-23\"><a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\" href=\"#__codelineno-0-23\"></a>cp<span class=\"w\"> </span>lib/libunwind.a<span class=\"w\"> </span><span class=\"nv\">$DST</span>/\n</span><span id=\"__span-0-24\"><a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\" href=\"#__codelineno-0-24\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>../../\n</span><span id=\"__span-0-25\"><a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\" href=\"#__codelineno-0-25\"></a>\n</span><span id=\"__span-0-26\"><a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\" href=\"#__codelineno-0-26\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>flang/lib/Decimal\n</span><span id=\"__span-0-27\"><a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\" href=\"#__codelineno-0-27\"></a>rm<span class=\"w\"> </span>-rf<span class=\"w\"> </span>build\n</span><span id=\"__span-0-28\"><a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\" href=\"#__codelineno-0-28\"></a>mkdir<span class=\"w\"> </span>-p<span class=\"w\"> </span>build\n</span><span id=\"__span-0-29\"><a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\" href=\"#__codelineno-0-29\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>build\n</span><span id=\"__span-0-30\"><a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\" href=\"#__codelineno-0-30\"></a>cmake<span class=\"w\"> </span>..<span class=\"w\"> </span>-G<span class=\"w\"> </span>Ninja<span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-31\"><a id=\"__codelineno-0-31\" name=\"__codelineno-0-31\" href=\"#__codelineno-0-31\"></a><span class=\"w\">    </span>-DCMAKE_C_FLAGS<span class=\"o\">=</span><span class=\"s2\">&quot;-target aarch64-linux-ohos -fuse-ld=lld -fPIC&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-32\"><a id=\"__codelineno-0-32\" name=\"__codelineno-0-32\" href=\"#__codelineno-0-32\"></a><span class=\"w\">    </span>-DCMAKE_C_COMPILER<span class=\"o\">=</span><span class=\"s2\">&quot;clang&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-33\"><a id=\"__codelineno-0-33\" name=\"__codelineno-0-33\" href=\"#__codelineno-0-33\"></a><span class=\"w\">    </span>-DCMAKE_CXX_FLAGS<span class=\"o\">=</span><span class=\"s2\">&quot;-target aarch64-linux-ohos -fuse-ld=lld -fPIC&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-34\"><a id=\"__codelineno-0-34\" name=\"__codelineno-0-34\" href=\"#__codelineno-0-34\"></a><span class=\"w\">    </span>-DCMAKE_CXX_COMPILER<span class=\"o\">=</span><span class=\"s2\">&quot;clang++&quot;</span>\n</span><span id=\"__span-0-35\"><a id=\"__codelineno-0-35\" name=\"__codelineno-0-35\" href=\"#__codelineno-0-35\"></a>ninja\n</span><span id=\"__span-0-36\"><a id=\"__codelineno-0-36\" name=\"__codelineno-0-36\" href=\"#__codelineno-0-36\"></a>cp<span class=\"w\"> </span>libFortranDecimal.a<span class=\"w\"> </span><span class=\"nv\">$DST</span>/\n</span><span id=\"__span-0-37\"><a id=\"__codelineno-0-37\" name=\"__codelineno-0-37\" href=\"#__codelineno-0-37\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>../../../../\n</span><span id=\"__span-0-38\"><a id=\"__codelineno-0-38\" name=\"__codelineno-0-38\" href=\"#__codelineno-0-38\"></a>\n</span><span id=\"__span-0-39\"><a id=\"__codelineno-0-39\" name=\"__codelineno-0-39\" href=\"#__codelineno-0-39\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>flang/runtime\n</span><span id=\"__span-0-40\"><a id=\"__codelineno-0-40\" name=\"__codelineno-0-40\" href=\"#__codelineno-0-40\"></a>rm<span class=\"w\"> </span>-rf<span class=\"w\"> </span>build\n</span><span id=\"__span-0-41\"><a id=\"__codelineno-0-41\" name=\"__codelineno-0-41\" href=\"#__codelineno-0-41\"></a>mkdir<span class=\"w\"> </span>-p<span class=\"w\"> </span>build\n</span><span id=\"__span-0-42\"><a id=\"__codelineno-0-42\" name=\"__codelineno-0-42\" href=\"#__codelineno-0-42\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>build\n</span><span id=\"__span-0-43\"><a id=\"__codelineno-0-43\" name=\"__codelineno-0-43\" href=\"#__codelineno-0-43\"></a>cmake<span class=\"w\"> </span>..<span class=\"w\"> </span>-G<span class=\"w\"> </span>Ninja<span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-44\"><a id=\"__codelineno-0-44\" name=\"__codelineno-0-44\" href=\"#__codelineno-0-44\"></a><span class=\"w\">    </span>-DCMAKE_C_FLAGS<span class=\"o\">=</span><span class=\"s2\">&quot;-target aarch64-linux-ohos -fuse-ld=lld -fPIC&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-45\"><a id=\"__codelineno-0-45\" name=\"__codelineno-0-45\" href=\"#__codelineno-0-45\"></a><span class=\"w\">    </span>-DCMAKE_C_COMPILER<span class=\"o\">=</span><span class=\"s2\">&quot;clang&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-46\"><a id=\"__codelineno-0-46\" name=\"__codelineno-0-46\" href=\"#__codelineno-0-46\"></a><span class=\"w\">    </span>-DCMAKE_CXX_FLAGS<span class=\"o\">=</span><span class=\"s2\">&quot;-target aarch64-linux-ohos -fuse-ld=lld -fPIC&quot;</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n</span><span id=\"__span-0-47\"><a id=\"__codelineno-0-47\" name=\"__codelineno-0-47\" href=\"#__codelineno-0-47\"></a><span class=\"w\">    </span>-DCMAKE_CXX_COMPILER<span class=\"o\">=</span><span class=\"s2\">&quot;clang++&quot;</span>\n</span><span id=\"__span-0-48\"><a id=\"__codelineno-0-48\" name=\"__codelineno-0-48\" href=\"#__codelineno-0-48\"></a>ninja\n</span><span id=\"__span-0-49\"><a id=\"__codelineno-0-49\" name=\"__codelineno-0-49\" href=\"#__codelineno-0-49\"></a>cp<span class=\"w\"> </span>libFortranRuntime.a<span class=\"w\"> </span><span class=\"nv\">$DST</span>/\n</span><span id=\"__span-0-50\"><a id=\"__codelineno-0-50\" name=\"__codelineno-0-50\" href=\"#__codelineno-0-50\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>../../../\n</span><span id=\"__span-0-51\"><a id=\"__codelineno-0-51\" name=\"__codelineno-0-51\" href=\"#__codelineno-0-51\"></a>\n</span><span id=\"__span-0-52\"><a id=\"__codelineno-0-52\" name=\"__codelineno-0-52\" href=\"#__codelineno-0-52\"></a>ls<span class=\"w\"> </span>-al<span class=\"w\"> </span><span class=\"nv\">$DST</span>\n</span></code></pre></div>\n<p>\u6838\u5fc3\u5c31\u662f\u4ee5 aarch64-linux-ohos \u4e3a target\uff0c\u7f16\u8bd1\u51fa\u4e09\u4e2a <code>.a</code> \u6587\u4ef6\uff0c\u4e4b\u540e\u518d\u94fe\u63a5\u4e0a\u5c31\u53ef\u4ee5\u4e86\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cruntime \u7248\u672c\u548c flang \u7248\u672c\u9700\u8981\u4e00\u81f4\u3002\u4e3a\u4e86\u5077\u61d2\uff0c\u76f4\u63a5\u7528\u7684\u662f LLVM APT \u63d0\u4f9b\u7684 flang-new-20 \u7684 binary\uff0c\u90a3\u4e48\u5b83\u662f\u4f1a\u968f\u7740 apt upgrade \u800c\u66f4\u65b0\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u91cd\u65b0\u7f16\u8bd1\u4e00\u6b21 flang runtime\uff0c\u7136\u540e\u94fe\u63a5\u5230\u7a0b\u5e8f\u91cc\u3002\u5982\u679c\u7248\u672c\u4e0d\u5bf9\u4e0a\uff0c\u53ef\u80fd\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>fatal Fortran runtime error(/home/jiegec/llvm-project/flang/runtime/descriptor.cpp:74): not yet implemented: type category(6)\n</span></code></pre></div>\n<p>\u53c2\u8003 <a href=\"https://github.com/llvm/llvm-project/issues/129877\">[flang] fatal Fortran runtime error</a>\uff0c\u5c31\u77e5\u9053\u662f\u7f16\u8bd1\u5668\u7248\u672c\u548c runtime \u4e0d\u517c\u5bb9\u7684\u95ee\u9898\u4e86\u3002</p>\n<p>\u7f16\u8bd1\u597d\u4e86 fortran runtime \u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u7528 flang-new-20 \u7f16\u8bd1 fortran \u4ee3\u7801\u4e86\u3002\u8fd9\u91cc\u7ed9\u51fa CMake \u7684\u914d\u7f6e\u65b9\u5f0f\uff0c\u4e3b\u8981\u6d89\u53ca\u5230\u9700\u8981\u7528\u7684\u7f16\u8bd1\u9009\u9879\uff1a</p>\n<div class=\"language-cmake highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"s\">CMAKE_Fortran_COMPILER_FORCED</span><span class=\"w\"> </span><span class=\"s\">TRUE</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"s\">CMAKE_Fortran_COMPILER</span><span class=\"w\"> </span><span class=\"s2\">&quot;flang-new-20&quot;</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"s\">CMAKE_Fortran_FLAGS</span><span class=\"w\"> </span><span class=\"s2\">&quot;-target aarch64-linux-ohos -fuse-ld=lld -L ${CMAKE_CURRENT_SOURCE_DIR}/../../../../flang -nostdlib -L ${CMAKE_CURRENT_SOURCE_DIR}/../../../../../command-line-tools/sdk/default/openharmony/native/sysroot/usr/lib/aarch64-linux-ohos -lc -lm -L ${CMAKE_CURRENT_SOURCE_DIR}/../../../../../command-line-tools/sdk/default/openharmony/native/llvm/lib/clang/15.0.4/lib/aarch64-linux-ohos/ -lclang_rt.builtins -lFortranRuntime -lFortranDecimal&quot;</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"nb\">enable_language</span><span class=\"p\">(</span><span class=\"s\">Fortran</span><span class=\"p\">)</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u7684\u76f8\u5bf9\u8def\u5f84\uff0c\u5176\u5b9e\u5c31\u662f\u8981\u627e\u5230\u65b0\u7f16\u8bd1\u51fa\u6765\u7684 flang runtime\uff0c\u4ee5\u53ca HarmonyOS command line tools \u91cc\u9762\u7684\u4e00\u4e9b\u5e93\uff0c\u5177\u4f53\u8def\u5f84\u9700\u8981\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u6765\u8c03\u6574\uff0c\u8fd9\u91cc\u53ea\u662f\u4e00\u4e2a\u6837\u4f8b\u3002</p>\n<p>\u5230\u8fd9\u91cc\uff0c\u5c31\u53ef\u4ee5\u5728 HarmonyOS 5 \u4e0a\u8fd0\u884c Fortran \u7a0b\u5e8f\u4e86\u3002\u5176\u5b9e\u8fd8\u53ef\u4ee5\u8003\u8651\u7814\u7a76\u4e00\u4e0b GFortran\uff0c\u6216\u8bb8\u4e5f\u662f\u80fd\u5b9e\u73b0\u7684\uff0c\u4f46\u76ee\u524d\u8fd8\u6ca1\u6709\u53bb\u505a\u8fdb\u4e00\u6b65\u7684\u5c1d\u8bd5\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/software/using-fortran-on-harmonyos-5.png", "date_modified": "2025-06-06T00:00:00+00:00", "date_published": "2025-06-06T00:00:00+00:00", "authors": [], "tags": ["arm64", "clang", "flang", "fortran", "hardware", "harmonyos", "huawei", "llvm"]}, {"id": "https://jia.je/hardware/2025/06/05/arm-neoverse-n1-btb/", "url": "https://jia.je/hardware/2025/06/05/arm-neoverse-n1-btb/", "title": "ARM Neoverse N1 (\u4ee3\u53f7 Ares) \u7684 BTB \u7ed3\u6784\u5206\u6790", "content_html": "<h1 id=\"arm-neoverse-n1-\u4ee3\u53f7-ares-\u7684-btb-\u7ed3\u6784\u5206\u6790\">ARM Neoverse N1 (\u4ee3\u53f7 Ares) \u7684 BTB \u7ed3\u6784\u5206\u6790<a class=\"headerlink\" href=\"#arm-neoverse-n1-\u4ee3\u53f7-ares-\u7684-btb-\u7ed3\u6784\u5206\u6790\" title=\"Permanent link\">&para;</a></h1>\n<p>\u672c\u6587\u540c\u6b65\u53d1\u5e03\u5230\u672c\u4eba\u7684<a href=\"https://zhuanlan.zhihu.com/p/1926041649617826619\">\u77e5\u4e4e</a>\u3002</p>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM Neoverse N1 \u662f 2019 \u5e74\u53d1\u5e03\u7684\u6bd4\u8f83\u65e9\u7684\u4e00\u4ee3 ARM \u670d\u52a1\u5668\u7684\u5904\u7406\u5668\uff0c\u5b83\u5728\u5f88\u591a\u5730\u65b9\u90fd\u548c Cortex-A76 \u7c7b\u4f3c\u3002\u5b83\u7684 BTB \u7ed3\u6784\u6bd4\u8f83\u6709\u610f\u601d\uff0c\u6240\u4ee5\u5728\u8fd9\u91cc\u5bf9\u5b83\u7684 BTB \u505a\u4e00\u4e9b\u5206\u6790\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u6536\u96c6\u4e86\u4e00\u4e9b ARM Neoverse N1 \u7684 BTB \u7ed3\u6784\u7684\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://hc33.hotchips.org/assets/program/conference/day1/20210818_Hotchips_NeoverseN2.pdf\">Arm Neoverse N2: Arm\u2019s 2nd generation high performance infrastructure CPUs and system IPs</a> \u4e2d\u5bf9 Neoverse N1 \u7684\u4ecb\u7ecd\uff1a<ul>\n<li>Branch Prediction Width: 8 instrs</li>\n<li>Nano BTB (0 cyc taken-branch bubble): 16 entry</li>\n<li>Main BTB: 6K entry</li>\n</ul>\n</li>\n<li><a href=\"https://www.arm.com/-/media/global/solutions/infrastructure/arm-neoverse-n1-platform.pdf\">The Arm Neoverse N1 Platform: Building Blocks for the Next-Gen Cloud-to-Edge Infrastructure SoC</a> \u7684\u4ecb\u7ecd\uff1a<ul>\n<li>6K entry Main BTB, 3 cycle access latency</li>\n<li>64-entry Micro BTB</li>\n<li>16-entry Nano BTB</li>\n<li>4-way set associative 64KB L1 ICache</li>\n</ul>\n</li>\n</ul>\n<p>\u7b80\u5355\u6574\u7406\u4e00\u4e0b\u5b98\u65b9\u4fe1\u606f\uff0c\u5927\u6982\u6709\u4e09\u7ea7 BTB\uff1a</p>\n<ul>\n<li>16-entry Nano BTB, 1 cycle latency (0 cycle bubble)</li>\n<li>64-entry Micro BTB</li>\n<li>6K-entry Main BTB, 3 cycle latency</li>\n</ul>\n<p>\u4f46\u662f\u5f88\u591a\u7ec6\u8282\u662f\u7f3a\u5931\u7684\uff0c\u56e0\u6b64\u4e0b\u9762\u7ed3\u5408\u5fae\u67b6\u6784\u6d4b\u8bd5\uff0c\u8fdb\u4e00\u6b65\u7814\u7a76\u5b83\u7684\u5185\u90e8\u7ed3\u6784\u3002</p>\n<h2 id=\"\u5fae\u67b6\u6784\u6d4b\u8bd5\">\u5fae\u67b6\u6784\u6d4b\u8bd5<a class=\"headerlink\" href=\"#\u5fae\u67b6\u6784\u6d4b\u8bd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u4e4b\u524d\u7684\u535a\u5ba2\u91cc\uff0c\u6211\u4eec\u5df2\u7ecf\u6d4b\u8bd5\u4e86\u5404\u79cd\u5904\u7406\u5668\u7684 BTB\uff0c\u5728\u8fd9\u91cc\u4e5f\u662f\u4e00\u6837\u7684\uff1a\u6309\u7167\u4e00\u5b9a\u7684 stride \u5206\u5e03\u65e0\u6761\u4ef6\u76f4\u63a5\u5206\u652f\uff0c\u6784\u6210\u4e00\u4e2a\u94fe\u6761\uff0c\u7136\u540e\u6d4b\u91cf CPI\u3002</p>\n<h3 id=\"stride4b\">stride=4B<a class=\"headerlink\" href=\"#stride4b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u662f stride=4B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 16 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 16-entry \u7684 Nano BTB</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 80 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5176\u4e2d <code>80=16+64</code>\uff0c\u591a\u51fa\u6765\u7684\u90e8\u5206\u5bf9\u5e94\u4e86 64-entry \u7684 Micro BTB\uff0c\u610f\u5473\u7740 Micro BTB \u76f8\u5bf9 Nano BTB \u662f Victim BTB \u7684\u5730\u4f4d\uff1aNano BTB \u88ab\u66ff\u6362\u51fa\u53bb\u7684 entry \u4f1a\u8fdb\u5165\u5230 Micro BTB\uff0c\u800c\u547d\u4e2d Micro BTB \u7684 entry \u4f1a\u88ab\u79fb\u52a8\u5230 Nano BTB</li>\n<li>\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 8192 \u6761\u5206\u652f\uff0cCPI=5\uff0c\u5927\u4e8e Main BTB \u7684 3 cycle latency\uff0c\u8bf4\u660e\u6b64\u65f6\u6ca1\u6709\u547d\u4e2d Main BTB\uff0c\u800c\u662f\u8981\u7b49\u5230\u53d6\u6307\u548c\u8bd1\u7801\u540e\uff0c\u8ba1\u7b97\u51fa\u6b63\u786e\u7684\u76ee\u7684\u5730\u5740\u518d\u56de\u6eda\uff0c\u5bfc\u81f4\u4e86 5 cycle latency\uff1b8192 \u7684\u6027\u80fd\u4e0b\u964d\u539f\u56e0\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7814\u7a76\uff0c16384 \u7684\u6027\u80fd\u4e0b\u964d\u5bf9\u5e94\u4e86 64KB \u7684 ICache\uff0c\u56e0\u4e3a <code>4B*16384=64KB</code></li>\n</ul>\n<p>\u90a3\u4e48 stride=4B \u7684\u60c5\u51b5\u4e0b\u5c31\u9057\u7559\u4e86\u4e24\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u6ca1\u6709\u547d\u4e2d Main BTB\uff1b8192 \u5904\u4e3a\u4ec0\u4e48\u51fa\u73b0\u4e86\u6027\u80fd\u4e0b\u964d\u3002</p>\n<h3 id=\"stride8b\">stride=8B<a class=\"headerlink\" href=\"#stride8b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf stride=8B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-8b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 16 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 16-entry \u7684 Nano BTB\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 80 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5176\u4e2d <code>80=16+64</code>\uff0c\u591a\u51fa\u6765\u7684\u90e8\u5206\u5bf9\u5e94\u4e86 64-entry \u7684 Micro BTB\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 4096 \u6761\u5206\u652f\uff0cCPI=2.75\uff0c\u7ea6\u7b49\u4e8e Main BTB \u7684 3 cycle latency\uff0c\u8bf4\u660e\u6b64\u65f6\u547d\u4e2d\u7684\u662f Main BTB\uff0c\u4f46\u662f\u5b83\u5e76\u6ca1\u6709\u8fbe\u5230\u5ba3\u79f0\u7684 6144-entry \u7684 Main BTB \u5bb9\u91cf\uff1b8192 \u8fd8\u6709\u4e00\u4e2a\u6027\u80fd\u4e0b\u964d\uff0c\u8fd9\u5bf9\u5e94\u4e86 64KB \u7684 ICache\uff1a<code>8B*8192=64KB</code></li>\n</ul>\n<p>\u76f8\u6bd4 stride=4B\uff0cNano BTB \u548c Micro BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1b\u800c Main BTB \u5f00\u59cb\u80fd\u591f\u547d\u4e2d\uff0c\u8fd9\u4ee3\u8868 Main BTB \u5728\u5206\u652f\u7279\u522b\u5bc6\u96c6\u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u51fa\u73b0\u6027\u80fd\u95ee\u9898\u3002</p>\n<p>\u90a3\u4e48 stride=8B \u7684\u60c5\u51b5\u4e0b\u9057\u7559\u4e86\u4e24\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48 CPI=2.75 \u800c\u4e0d\u662f 3\uff1f\u4e3a\u4ec0\u4e48\u53ea\u89c2\u5bdf\u5230\u4e86 4K \u7684 Main BTB \u5bb9\u91cf\uff0c\u800c\u4e0d\u662f 6K\uff1f</p>\n<h3 id=\"stride16b\">stride=16B<a class=\"headerlink\" href=\"#stride16b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=16B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-16b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u56db\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 16 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 16-entry \u7684 Nano BTB\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 80 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u5176\u4e2d <code>80=16+64</code>\uff0c\u591a\u51fa\u6765\u7684\u90e8\u5206\u5bf9\u5e94\u4e86 64-entry \u7684 Micro BTB\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 4096 \u6761\u5206\u652f\uff0cCPI=2.5\uff0c\u6bd4 Main BTB \u7684 3 cycle latency \u7565\u5c0f\uff0c\u4f46\u662f\u5927\u4e8e 2\uff0c\u8bf4\u660e\u6b64\u65f6\u547d\u4e2d\u7684\u662f Main BTB\uff0c\u6b64\u65f6\u9047\u5230\u4e86 64KB ICache \u7684\u74f6\u9888\uff1a<code>4096*16B=64KB</code></li>\n<li>\u7b2c\u56db\u4e2a\u53f0\u9636\u5230 6144 \u6761\u5206\u652f\uff0cCPI=3.5\uff0c\u6bd4 Main BTB \u7684 3 cycle latency \u7565\u5927\uff0c\u662f\u56e0\u4e3a 64KB ICache \u51fa\u73b0\u4e86\u7f3a\u5931\uff0c\u4f46\u8fd9\u4e2a\u65f6\u5019\u7ec8\u4e8e\u663e\u73b0\u4e86\u5ba3\u4f20\u7684 Main BTB \u7684 6144 \u7684\u5bb9\u91cf</li>\n</ul>\n<p>\u76f8\u6bd4 stride=8B\uff0cNano BTB \u548c Micro BTB \u7684\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\uff1bMain BTB \u7684 6144 \u5bb9\u91cf\u5f00\u59cb\u663e\u73b0\uff0c\u5e76\u4e14\u51fa\u73b0\u5730\u6bd4 64KB ICache \u66f4\u665a\u3002</p>\n<p>\u90a3\u4e48 stride=16B \u7684\u60c5\u51b5\u4e0b\u9057\u7559\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u51fa\u73b0\u4e86 CPI=2.5 \u7684\u5e73\u53f0\uff1f</p>\n<h3 id=\"stride32b\">stride=32B<a class=\"headerlink\" href=\"#stride32b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=32B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-32b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 16 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 16-entry \u7684 Nano BTB\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 2048 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u6b64\u65f6\u9047\u5230\u4e86 64KB ICache \u7684\u74f6\u9888\uff1a<code>2048*32B=64KB</code>\uff0c\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u5df2\u7ecf\u8d85\u51fa\u4e86 Micro BTB \u7684\u5bb9\u91cf\uff0c\u800c Main BTB \u6709 3 cycle \u7684 latency\uff0c\u4e3a\u4f55\u8fd8\u80fd\u4fdd\u6301 CPI=2 \u5462</li>\n<li>\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 6144 \u6761\u5206\u652f\uff0cCPI=4\uff0c\u6bd4 Main BTB \u7684 3 cycle latency \u7565\u5927\uff0c\u662f\u56e0\u4e3a 64KB ICache \u51fa\u73b0\u4e86\u7f3a\u5931\uff0c\u663e\u73b0\u7684\u662f\u5ba3\u4f20\u7684 Main BTB \u7684 6144 \u7684\u5bb9\u91cf\uff0c\u66f4\u52a0\u8bf4\u660e\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5185 Main BTB \u662f\u547d\u4e2d\u7684</li>\n</ul>\n<p>\u90a3\u4e48 stride=32B \u7684\u60c5\u51b5\u4e0b\u9057\u7559\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u5728 Main BTB \u7684\u8303\u56f4\u5185\u51fa\u73b0\u4e86 CPI=2 \u7684\u5e73\u53f0\uff1f</p>\n<h3 id=\"stride64b\">stride=64B<a class=\"headerlink\" href=\"#stride64b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=64B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-64b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 16 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 16-entry \u7684 Nano BTB\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 1024 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u6b64\u65f6\u9047\u5230\u4e86 64KB ICache \u7684\u74f6\u9888\uff1a<code>1024*64B=64KB</code>\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 3122 \u6761\u5206\u652f\uff0cCPI=6\uff0c\u6bd4 Main BTB \u7684 3 cycle latency \u5927\uff0c\u662f\u56e0\u4e3a 64KB ICache \u51fa\u73b0\u4e86\u7f3a\u5931\uff0c\u6b64\u65f6 Main BTB \u7684\u5bb9\u91cf\u780d\u534a</li>\n</ul>\n<p>stride=64B \u76f8\u6bd4 stride=32B \u7684 Main BTB \u5bb9\u91cf\u780d\u534a\uff0c\u8fd9\u662f\u7ec4\u76f8\u8fde\u7684\u8868\u73b0\uff1a\u5982\u679c PC[5] \u5728\u7ec4\u76f8\u8fde\u7684 index \u5f53\u4e2d\uff0c\u90a3\u4e48\u5f53 stride=64B \u65f6\uff0cPC[5] \u6052\u7b49\u4e8e 0\uff0c\u610f\u5473\u7740\u53ea\u6709\u4e00\u534a\u7684 set \u53ef\u4ee5\u88ab\u7528\u5230\uff0c\u90a3\u4e5f\u5c31\u53ea\u6709\u4e00\u534a\u7684\u5bb9\u91cf\u4e86\u3002</p>\n<p>Nano BTB \u548c Micro BTB \u5bb9\u91cf\u6ca1\u6709\u53d8\u5c0f\uff0c\u610f\u5473\u7740\u5b83\u4eec\u5927\u6982\u7387\u662f\u5168\u76f8\u8fde\u7684\uff1a\u8fd9\u4e5f\u548c\u5b83\u4eec\u7684\u5927\u5c0f\u76f8\u543b\u5408\u3002</p>\n<p>\u90a3\u4e48 stride=64B \u7684\u60c5\u51b5\u4e0b\u9057\u7559\u7684\u95ee\u9898\u548c stride=32B \u4e00\u6837\uff1a\u4e3a\u4ec0\u4e48\u5728 Main BTB \u7684\u8303\u56f4\u5185\u51fa\u73b0\u4e86 CPI=2 \u7684\u5e73\u53f0\uff1f</p>\n<h3 id=\"stride128b\">stride=128B<a class=\"headerlink\" href=\"#stride128b\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7ee7\u7eed\u89c2\u5bdf stride=128B \u7684\u60c5\u51b5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-128b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u56fe\u50cf\u4e0a\u51fa\u73b0\u4e86\u4e09\u4e2a\u6bd4\u8f83\u663e\u8457\u7684\u53f0\u9636\uff1a</p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u53f0\u9636\u5230 16 \u6761\u5206\u652f\uff0cCPI=1\uff0c\u5bf9\u5e94\u4e86 16-entry \u7684 Nano BTB\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e8c\u4e2a\u53f0\u9636\u5230 512 \u6761\u5206\u652f\uff0cCPI=2\uff0c\u6b64\u65f6\u9047\u5230\u4e86 64KB ICache \u7684\u74f6\u9888\uff1a<code>512*128B=64KB</code>\uff0c\u548c\u4e4b\u524d\u4e00\u6837</li>\n<li>\u7b2c\u4e09\u4e2a\u53f0\u9636\u5230 1536 \u6761\u5206\u652f\uff0cCPI=6.x\uff0c\u6bd4 Main BTB \u7684 3 cycle latency \u5927\uff0c\u662f\u56e0\u4e3a 64KB ICache \u51fa\u73b0\u4e86\u7f3a\u5931\uff0c\u6b64\u65f6 Main BTB \u7684\u5bb9\u91cf\u8fdb\u4e00\u6b65\u780d\u534a</li>\n</ul>\n<p>stride=128B \u76f8\u6bd4 stride=64B \u7684 Main BTB \u5bb9\u91cf\u8fdb\u4e00\u6b65\u780d\u534a\uff0c\u4e5f\u662f\u7ec4\u76f8\u8fde\u7684\u8868\u73b0\uff0c\u610f\u5473\u7740 PC[6] \u4e5f\u5728\u7ec4\u76f8\u8fde\u7684 idnex \u5f53\u4e2d\uff0c\u53ea\u6709\u56db\u5206\u4e4b\u4e00\u7684 set \u53ef\u4ee5\u88ab\u7528\u5230\u3002</p>\n<p>\u90a3\u4e48 stride=128B \u7684\u60c5\u51b5\u4e0b\u9057\u7559\u7684\u95ee\u9898\u548c stride=32B \u4e00\u6837\uff1a\u4e3a\u4ec0\u4e48\u5728 Main BTB \u7684\u8303\u56f4\u5185\u51fa\u73b0\u4e86 CPI=2 \u7684\u5e73\u53f0\uff1f</p>\n<h3 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6d4b\u8bd5\u5230\u8fd9\u91cc\u5c31\u5dee\u4e0d\u591a\u4e86\uff0c\u66f4\u5927\u7684 stride \u5f97\u5230\u7684\u4e5f\u662f\u7c7b\u4f3c\u7684\u7ed3\u679c\uff0c\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u7684\u53d1\u73b0\uff1a</p>\n<ul>\n<li>Nano BTB \u662f 16-entry\uff0c1 cycle latency\uff0c\u4e0d\u968f\u7740 stride \u53d8\u5316</li>\n<li>Micro BTB \u662f 64-entry\uff0c2 cycle latency\uff0c\u4e5f\u4e0d\u968f\u7740 stride \u53d8\u5316</li>\n<li>Main BTB \u662f 6K-entry\uff0c3 cycle latency\uff0c\u5bb9\u91cf\u968f\u7740 stride \u53d8\u5316\uff0c\u5927\u6982\u7387\u662f PC[n:5] \u8fd9\u4e00\u6bb5\u88ab\u7528\u4e8e index\uff0c\u4f7f\u5f97 stride=64B \u5f00\u59cb\u5bb9\u91cf\u4e0d\u65ad\u51cf\u534a</li>\n<li>64KB ICache \u5f88\u591a\u65f6\u5019\u4f1a\u6bd4 Main BTB \u66f4\u65e9\u6210\u4e3a\u74f6\u9888</li>\n</ul>\n<p>\u4e5f\u603b\u7ed3\u4e00\u4e0b\u524d\u9762\u53d1\u73b0\u4e86\u5404\u79cd\u6ca1\u6709\u89e3\u91ca\u7684\u9057\u7559\u95ee\u9898\uff1a</p>\n<ul>\n<li>stride=4B \u7684\u60c5\u51b5\u4e0b\uff0cMain BTB \u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c\uff1a\u89e3\u91ca\u89c1\u540e</li>\n<li>stride=4B \u7684\u60c5\u51b5\u4e0b\uff0c8192 \u6761\u5206\u652f\u5904\u51fa\u73b0\u4e86\u6027\u80fd\u4e0b\u964d\uff1a\u6682\u65e0\u89e3\u91ca</li>\n<li>stride=8B \u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u89c2\u5bdf\u5230 4096 \u7684 Main BTB \u5bb9\u91cf\uff0c\u800c\u4e0d\u662f 6144\uff1a\u89e3\u91ca\u89c1\u540e</li>\n<li>stride=8B \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 Main BTB \u547d\u4e2d\u7684\u8303\u56f4\u5185\uff0cCPI=2.75\uff1a\u89e3\u91ca\u89c1\u540e</li>\n<li>stride=16B \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 Main BTB \u547d\u4e2d\u7684\u8303\u56f4\u5185\uff0cCPI=2.5\uff1a\u89e3\u91ca\u89c1\u540e</li>\n<li>stride=32B \u6216 64B \u6216 128B \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 Main BTB \u547d\u4e2d\u7684\u8303\u56f4\u5185\uff0cCPI=2\uff1a\u89e3\u91ca\u89c1\u540e</li>\n</ul>\n<p>\u63a5\u4e0b\u6765\u5c1d\u8bd5\u89e3\u6790\u4e00\u4e0b\u8fd9\u4e9b\u9057\u7559\u95ee\u9898\u80cc\u540e\u7684\u539f\u7406\u3002\u90e8\u5206\u9057\u7559\u95ee\u9898\uff0c\u5e76\u6ca1\u6709\u88ab\u89e3\u91ca\u51fa\u6765\uff0c\u6b22\u8fce\u8bfb\u8005\u63d0\u51fa\u731c\u60f3\u3002</p>\n<h2 id=\"\u89e3\u6790\u9057\u7559\u95ee\u9898\">\u89e3\u6790\u9057\u7559\u95ee\u9898<a class=\"headerlink\" href=\"#\u89e3\u6790\u9057\u7559\u95ee\u9898\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"stride4b-\u7684\u60c5\u51b5\u4e0bmain-btb-\u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c\">stride=4B \u7684\u60c5\u51b5\u4e0b\uff0cMain BTB \u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c<a class=\"headerlink\" href=\"#stride4b-\u7684\u60c5\u51b5\u4e0bmain-btb-\u6ca1\u6709\u50cf\u9884\u671f\u90a3\u6837\u5de5\u4f5c\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5bf9\u4e8e\u8fd9\u79cd\u7c7b\u4f3c Cache \u7684\u7ed3\u6784\uff0c\u5f53\u5b83\u770b\u8d77\u6765\u603b\u662f\u6ca1\u6709\u547d\u4e2d\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u5c31\u662f\u6bcf\u4e00\u4e2a Set \u5185\u8981\u8bbf\u95ee\u7684\u6570\u636e\u8d85\u51fa\u4e86 Way\uff0c\u5bfc\u81f4\u6bcf\u6b21\u65b0\u8bbf\u95ee\u7684\u90fd\u4f1a\u7f3a\u5931\u3002\u4e0a\u9762\u5206\u6790\u5230\uff0cMain BTB \u7684 Index \u5927\u6982\u662f PC[n:5] \u8fd9\u4e00\u6bb5\uff0c\u90a3\u4e48\u4e00\u4e2a\u5bf9\u9f50\u7684 32B \u8303\u56f4\u5185\uff0c\u5206\u652f\u6307\u4ee4\u90fd\u4f1a\u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a set \u5185\u3002\u5f53 stride=4B \u7684\u65f6\u5019\uff0c\u5bf9\u9f50\u7684 32B \u8303\u56f4\u5185\u6709 8 \u6761\u6307\u4ee4\uff1b\u800c stride=8B \u7684\u65f6\u5019\uff0c\u53ea\u6709 4 \u6761\u6307\u4ee4\u30028 \u6761\u6307\u4ee4\u4e0d\u884c\uff0c4 \u6761\u6307\u4ee4\u53ef\u4ee5\uff0c\u6697\u793a\u4e86\u4e2d\u95f4\u8de8\u8d8a\u4e86 Way \u7684\u6570\u91cf\u3002</p>\n<p>\u9996\u5148\u6765\u56de\u987e\u4e00\u4e0b Main BTB \u7684 6144-entry \u662f\u600e\u4e48\u6765\u7684\uff1a\u867d\u7136\u5b83\u6ca1\u8bf4\u662f\u51e0\u8def\u7ec4\u76f8\u8fde\uff0c\u4f46\u56e0\u4e3a 6144 \u6709\u4e00\u4e2a 3 \u7684\u56e0\u5b50\uff0c\u5b83\u4e0d\u662f\u4e8c\u7684\u5e42\u6b21\uff0c\u6240\u4ee5\u4e00\u5b9a\u662f\u5728 Way \u6570\u91cf\u4e0a\u4ea7\u751f\u7684\u3002\u8fd9\u5c31\u5bfc\u81f4\u4e86\u81f3\u5c11\u8fd9\u6837\u51e0\u79cd\u53ef\u80fd\uff1a</p>\n<ul>\n<li>3-way set associative, 2048 sets</li>\n<li>6-way set associative, 1024 sets</li>\n<li>12-way set associative, 512 sets</li>\n</ul>\n<p>\u56de\u987e\u524d\u9762\u7684\u5206\u6790\uff1a4 \u6761\u6307\u4ee4\u6ca1\u6709\u8d85\u8fc7 Way \u6570\u91cf\uff0c8 \u6761\u6307\u4ee4\u8d85\u8fc7\u4e86\uff0c\u90a3\u4e48\u53ea\u80fd\u662f\u4e0a\u8ff0\u53ef\u80fd\u91cc\u7684 6-way set associative\uff0c1024 sets \u7684\u60c5\u51b5\u3002</p>\n<p>\u7ffb\u9605 <a href=\"https://developer.arm.com/documentation/100616/latest/\">Arm\u00ae Neoverse\u2122 N1 Core Technical Reference Manual</a>\uff0c\u5b83\u662f\u8fd9\u4e48\u8bf4\u7684\uff1a</p>\n<p>L1 BTB data location encoding:</p>\n<ul>\n<li><code>[31:24]</code>: RAMID = 0x02</li>\n<li><code>[23:20]</code>: Reserved</li>\n<li><code>[19:18]</code>: Way</li>\n<li><code>[17:15]</code>: Reserved</li>\n<li><code>[14:5]</code>: Index <code>[14:5]</code></li>\n<li><code>[4:0]</code>: Reserved</li>\n</ul>\n<p>\u5b83\u6697\u793a\u4e86 L1 BTB\uff08\u4e5f\u5c31\u662f Main BTB\uff09\u7684 Index \u662f PC[14:5]\uff0c\u8fd9\u548c\u6211\u4eec\u4e4b\u524d\u7684\u89c2\u5bdf\u4e00\u81f4\u3002\u8fd9\u6837\u7b97\u51fa\u6765\u6709 <code>2^(14-5+1)=1024</code> \u4e2a set\uff0c\u548c\u6211\u4eec\u524d\u9762\u7684 6-way set associative\uff0c1024 sets \u7684\u731c\u6d4b\u662f\u4e00\u81f4\u7684\u3002</p>\n<p>\u4f46\u662f\uff0c\u8fd9\u65f6\u5019\u53c8\u51fa\u73b0\u4e00\u4e2a\u95ee\u9898\uff1a<code>[19:18]</code> \u53ea\u80fd\u8bb0\u5f55\u4e24\u4f4d\u7684 Way \u7f16\u53f7\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e0d\u80fd\u8d85\u8fc7 4 \u4e2a Way\uff0c\u4f46\u5b9e\u9645\u4e0a\u6709 6 \u4e2a Way\u3002\u8fd9\u4f3c\u4e4e\u53c8\u51fa\u73b0\u4e86\u77db\u76fe\u3002</p>\n<p>\u7ee7\u7eed\u53bb\u9605\u8bfb\u6587\u6863\u91cc\u5bf9\u4ece BTB \u8bfb\u51fa\u6765\u7684\u6570\u636e\u7684\u63cf\u8ff0\uff1a</p>\n<p>L1 BTB cache format:</p>\n<ul>\n<li>Instruction Register 0 [63:0]: Data [63:0]</li>\n<li>Instruction Register 1 [17:0]: Data [81:64]</li>\n</ul>\n<p>\u8fd9\u6697\u793a\u4e86\u7ed9\u5b9a\u4e00\u4e2a Index \u548c\u4e00\u4e2a Way\uff0c\u53ef\u4ee5\u8bfb\u51fa\u6765 82 bit \u7684\u6570\u636e\uff0c\u8fd9\u4e0d\u592a\u5bfb\u5e38\uff1a\u4e00\u4e2a\u5206\u652f\u7684\u4fe1\u606f\uff0c\u901a\u5e38\u4e0d\u9700\u8981\u8fd9\u4e48\u591a bit \u7684\u6570\u636e\u3002\u4e00\u4e2a BTB Entry\uff0c\u901a\u5e38\u9700\u8981\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<ul>\n<li>valid</li>\n<li>branch type: conditional or unconditional, direct or indirect, call or return, etc.</li>\n<li>tag</li>\n<li>replacement policy</li>\n<li>part of target address</li>\n</ul>\n<p>\u9664\u975e\u4fdd\u5b58\u4e86\u5b8c\u6574\u7684 target address \u548c tag\uff0c\u662f\u8fbe\u4e0d\u5230 82 bit \u8fd9\u4e48\u591a\u7684\u3002\u4f46\u662f\u8fd9\u6837\u53c8\u663e\u5f97\u5f88\u6d6a\u8d39\uff0c\u53ef\u80fd\u8fd8\u6709\u5176\u4ed6\u7684\u53ef\u80fd\u6027\u3002</p>\n<p>\u8003\u8651\u5230\u4e0a\u9762\u51fa\u73b0\u7684\u4e24\u4f4d\u7684 Way \u7f16\u53f7\uff0c\u5e76\u4e14\u6709 3 \u7684\u7d20\u6570\u56e0\u5b50\uff0c\u53ea\u80fd\u662f 3-way \u7ec4\u76f8\u8fde\u4e86\u3002\u5982\u679c\u6309 3-way \u7ec4\u76f8\u8fde\uff0c1024 \u4e2a set \u6765\u7b97\uff0c\u53ea\u6709 3072 \u4e2a entry\uff0c\u8ddd\u79bb Main BTB \u7684\u5bb9\u91cf 6144 \u4e2a entry \u521a\u597d\u53ea\u6709\u4e00\u534a\u3002\u4e00\u4e2a\u60f3\u6cd5\u8bde\u751f\u4e86\uff1a\u5982\u679c\u4e00\u4e2a BTB entry \u53ef\u4ee5\u4fdd\u5b58\u4e24\u4e2a\u5206\u652f\u7684\u4fe1\u606f\u5462\uff1f82 bit \u6b63\u597d\u662f 2 \u7684\u500d\u6570\uff0c\u9664\u4ee5\u4e8c\u662f 41 bit\uff0c\u6bcf\u4e2a\u5206\u652f\u5b58 41 bit \u7684\u6570\u636e\u662f\u6bd4\u8f83\u5408\u7406\u7684\u6570\u636e\u3002\u8fd9\u6837\uff0c\u5c31\u53ef\u4ee5\u63a8\u5bfc\u51fa\u6765\uff0c\u5b83 Main BTB \u7684\u7ec4\u7ec7\u65b9\u5f0f\u662f\uff1a</p>\n<ul>\n<li>Index: PC[14:5]\uff0c\u6709 1024 \u4e2a set</li>\n<li>3-Way \u7ec4\u76f8\u8fde</li>\n<li>\u6bcf\u4e2a Entry \u662f 82 bit\uff0c\u53ef\u4ee5\u8bb0\u5f55\u4e24\u6761\u5206\u652f\u7684\u4fe1\u606f</li>\n</ul>\n<p>\u6240\u4ee5 BTB \u7684 Entry \u600e\u4e48\u8ba1\u7b97\u5176\u5b9e\u4f1a\u6bd4\u8f83\u590d\u6742\uff0c\u5230\u5e95\u662f\u6309\u5b9e\u9645\u7684 Entry \u6570\uff0c\u8fd8\u662f\u6309\u5206\u652f\u6570\uff0c\u9700\u8981\u6df1\u5165\u5206\u6790\u624d\u80fd\u7406\u89e3\u3002</p>\n<p>\u90a3\u4e48\uff0c\u4e3a\u4ec0\u4e48\u8981\u628a\u4e24\u6761\u5206\u652f\u4fdd\u5b58\u5728\u4e00\u4e2a BTB Entry \u91cc\u5462\uff1fNeoverse N1 \u5e76\u6ca1\u6709\u5b9e\u73b0 two taken\uff0c\u4f3c\u4e4e\u5e76\u6ca1\u6709\u653e\u5728\u4e00\u8d77\u7684\u5fc5\u8981\u3002\u800c\u4e14\u867d\u7136\u662f 3-Way \u7ec4\u76f8\u8fde\uff0c\u5339\u914d\u7684\u65f6\u5019\u8fd8\u662f 6-Way \u7684\uff0c\u90a3\u4e48\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u8fd9\u65f6\u5019\u5c31\u8981\u63d0\u5230\u5f88\u591a\u5904\u7406\u5668\u5b9e\u73b0\u7684\u4e00\u4e2a\u4f18\u5316\u4e86\uff1a\u5927\u591a\u6570\u5206\u652f\uff0c\u5b83\u7684\u76ee\u7684\u5730\u5740\u8ddd\u79bb\u5b83\u81ea\u5df1\u662f\u5f88\u77ed\u7684\uff0c\u5373\u4f7f\u8003\u8651\u6307\u4ee4\u652f\u6301\u7684\u6700\u5927\u8303\u56f4\uff0c\u6bd4\u5982 AArch64 \u6307\u4ee4\u91cc\u9762\uff0cB \u6307\u4ee4\u7684\u7acb\u5373\u6570\u662f 26 \u4f4d\uff0cB.cond \u548c CBNZ \u7684\u7acb\u5373\u6570\u662f 19 \u4f4d\uff0c\u4e5f\u6bd4\u5b8c\u6574\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5c0f\u5f88\u591a\u3002\u9488\u5bf9\u591a\u6570\u7684\u8df3\u8f6c\u8ddd\u79bb\u6bd4\u8f83\u77ed\u7684\u5206\u652f\uff0c\u53ef\u4ee5\u7528\u4e00\u4e2a\u66f4\u538b\u7f29\u7684\u8868\u793a\u6765\u4fdd\u5b58\uff0c\u4f7f\u5f97 BTB \u53ef\u4ee5\u4fdd\u5b58\u66f4\u591a\u7684\u5206\u652f\uff1b\u540c\u65f6\uff0c\u4e5f\u4fdd\u7559\u9488\u5bf9\u8df3\u8f6c\u8ddd\u79bb\u6bd4\u8f83\u957f\u7684\u5206\u652f\u7684\u652f\u6301\u3002\u8fd9\u548c\u524d\u9762\u7684\u8fd9\u4e2a\u8bbe\u8ba1\u5c31\u5bf9\u4e0a\u4e86\uff1a\u5bf9\u4e8e\u8df3\u8f6c\u8ddd\u79bb\u77ed\u7684\u5206\u652f\uff0c\u6bcf 41 bit \u53ef\u4ee5\u4fdd\u5b58\u4e00\u6761\u5206\u652f\u7684\u4fe1\u606f\uff1b\u5bf9\u4e8e\u8df3\u8f6c\u8ddd\u79bb\u8fdc\u7684\u5206\u652f\uff0c\u518d\u7528 82 bit \u6765\u4fdd\u5b58\u4e00\u6761\u5206\u652f\u7684\u4fe1\u606f\u3002\u4ece\u53e6\u5916\u4e00\u4e2a\u89d2\u5ea6\u6765\u8bf4\uff0c41 bit \u4e5f\u786e\u5b9e\u4fdd\u5b58\u4e0d\u4e0b\u5b8c\u6574\u7684\u865a\u62df\u5730\u5740\uff0c\u6240\u4ee5\u9700\u8981\u6709\u4e00\u4e2a\u65b9\u6848\u7ed9\u8df3\u8f6c\u8ddd\u79bb\u8fdc\u7684\u5206\u652f\u515c\u5e95\u3002</p>\n<p>\u90a3\u4e48\u5982\u679c\u8df3\u8f6c\u8ddd\u79bb\u6bd4\u8f83\u8fdc\uff0cMain BTB \u7684\u5bb9\u91cf\u5c06\u4f1a\u53ea\u6709\u4e00\u534a\u3002\u611f\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u8bbe\u8ba1\u5b9e\u9a8c\u6765\u9a8c\u8bc1\u8fd9\u4e00\u70b9\u3002</p>\n<p>\u5c0f\u7ed3\uff1aMain BTB \u662f 1024 set\uff0c3 way set associative \u7684\u7ed3\u6784\uff0c\u4e00\u5171 3072 \u4e2a entry\uff0c\u6bcf\u4e2a entry \u53ef\u4ee5\u4fdd\u5b58\u4e24\u6761\u5206\u652f\uff0cIndex \u662f PC[14:5]\u3002stride=4B \u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u51fa\u73b0\u4e00\u4e2a set \u5185 8 \u6761\u5206\u652f\u7684\u60c5\u51b5\uff0c\u65e0\u6cd5\u5728 3 \u4e2a entry \u5185\u653e\u4e0b\uff0c\u6240\u4ee5\u603b\u662f\u4f1a\u51fa\u73b0\u7f3a\u5931\u3002\u4e00\u5171\u5360\u7528 <code>3072*82=251904</code> bit \u4e5f\u5c31\u662f 30.75 KB \u7684\u7a7a\u95f4\u3002</p>\n<h3 id=\"stride8b-\u7684\u60c5\u51b5\u4e0b\u53ea\u89c2\u5bdf\u5230-4096-\u7684-main-btb-\u5bb9\u91cf\u800c\u4e0d\u662f-6144\">stride=8B \u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u89c2\u5bdf\u5230 4096 \u7684 Main BTB \u5bb9\u91cf\uff0c\u800c\u4e0d\u662f 6144<a class=\"headerlink\" href=\"#stride8b-\u7684\u60c5\u51b5\u4e0b\u53ea\u89c2\u5bdf\u5230-4096-\u7684-main-btb-\u5bb9\u91cf\u800c\u4e0d\u662f-6144\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 stride=8B \u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u89c2\u5bdf\u5230 4096 \u7684 Main BTB \u5bb9\u91cf\uff0c\u5b9e\u9645\u4e0a\uff0c\u7528\u521a\u624d\u5206\u6790\u7684 Main BTB \u7ed3\u6784\uff0c\u5c31\u53ef\u4ee5\u5206\u6790\u51fa\u6765\u3002</p>\n<p>\u9996\u5148\uff0c\u8fd9\u4e2a\u6d4b\u8bd5\u7684\u6784\u9020\u65b9\u6cd5\u662f\uff0c\u7ed9\u5b9a\u5206\u652f\u6570\u548c stride\uff0c\u6309\u7167\u8fd9\u4e2a stride \u5728\u8fde\u7eed\u7684\u4e00\u6bb5\u865a\u62df\u5730\u5740\u4e0a\u5206\u5e03\u8fd9\u4e9b\u5206\u652f\u3002\u4ee5 stride=8B \u4e3a\u4f8b\uff0c\u90a3\u4e48\u5206\u652f i \u7684\u5730\u5740\u5c31\u662f <code>8*i</code>\uff08\u5b9e\u9645\u60c5\u51b5\u4e0b\u9ad8\u4f4d\u4e0d\u662f 0\uff0c\u4f46\u662f\u6240\u6709\u7684\u5206\u652f\u7684\u9ad8\u4f4d\u662f\u76f8\u540c\u7684\uff0c\u4f8b\u5982 <code>0x100000000+8*i</code>\uff0c\u4f46\u8fd9\u4e0d\u5f71\u54cd\u5206\u6790\uff09\u3002\u6211\u4eec\u6765\u89c2\u5bdf\u4e00\u4e0b\u524d\u51e0\u4e2a\u5206\u652f\u7684\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Branch 0: addr=0x00, index=0</li>\n<li>Branch 1: addr=0x08, index=0</li>\n<li>Branch 2: addr=0x10, index=0</li>\n<li>Branch 3: addr=0x18, index=0</li>\n<li>Branch 4: addr=0x20, index=1</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\u4ece\u5206\u652f 5 \u5f00\u59cb\uff0c\u5230\u4e86\u4e00\u4e2a\u65b0\u7684 set\uff0c\u7b2c\u4e00\u4e2a set \u5185\u51fa\u73b0\u4e86 4 \u6761\u5206\u652f\uff0c\u5c0f\u4e8e\u4e00\u4e2a set \u5185\u53ef\u4ee5\u4fdd\u5b58\u7684\u6700\u591a 6 \u6761\u5206\u652f\u3002\u63a5\u4e0b\u6765\u770b\u4ece\u5206\u652f 4096 \u5f00\u59cb\u7684\u51e0\u4e2a\u5206\u652f\uff1a</p>\n<ul>\n<li>Branch 4096: addr=0x8000, index=0</li>\n<li>Branch 4097: addr=0x8008, index=0</li>\n<li>Branch 4098: addr=0x8010, index=0</li>\n<li>Branch 4099: addr=0x8018, index=0</li>\n<li>Branch 4100: addr=0x8020, index=1</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cindex=0 \u8fd9\u4e2a set \u51fa\u73b0\u4e86 8 \u4e2a Branch\uff1aBranch 0-3 \u548c Branch 4096-4099\uff0c\u5df2\u7ecf\u5927\u4e8e\u4e00\u4e2a set \u5185\u53ef\u4ee5\u4fdd\u5b58\u7684\u6700\u591a 6 \u6761\u5206\u652f\u3002\u867d\u7136 Main BTB \u5bb9\u91cf\u662f 6144\uff0c\u4f46\u7531\u4e8e\u5206\u652f\u7684\u6392\u5e03\u65b9\u5f0f\uff0c\u4f1a\u9996\u5148\u5728\u4e00\u4e2a set \u91cc\u51fa\u73b0\u6ea2\u51fa\u3002\u7136\u540e\u968f\u7740\u5206\u652f\u7ee7\u7eed\u589e\u52a0\uff0c\u4ea7\u751f\u6ea2\u51fa\u7684 set \u7684\u6bd4\u4f8b\u9010\u6e10\u4e0a\u5347\uff0c\u76f4\u5230 8192 \u6761\u5206\u652f\u7684\u65f6\u5019\uff0c\u6bcf\u4e2a set \u90fd\u5b8c\u5168\u6ea2\u51fa\u4e86\u3002\u6b64\u65f6\u4e5f\u6070\u597d\u9047\u5230\u4e86 64KB ICache \u7684\u74f6\u9888\uff0c\u5982\u679c ICache \u66f4\u5927\uff0c\u5e94\u8be5\u4f1a\u5728 8192 \u7684\u5730\u65b9\u89c2\u5bdf\u5230\u4e00\u4e2a\u5e73\u53f0\uff0c\u6b64\u65f6 Main BTB \u5b8c\u5168\u7f3a\u5931\u3002</p>\n<p>\u7ee7\u7eed\u589e\u52a0 stride\uff0c\u5c31\u6ca1\u6709\u4e86\u8fd9\u4e2a\u95ee\u9898\u3002\u4ee5 stride=16B \u4e3a\u4f8b\u5b50\uff0cBranch i \u5730\u5740\u662f <code>i*16</code>\uff0c\u90a3\u4e48\u8fd9\u4e9b\u5206\u652f\u7684\u5730\u5740\u662f\uff1a</p>\n<ul>\n<li>Branch 0: addr=0x00, index=0</li>\n<li>Branch 1: addr=0x10, index=0</li>\n<li>Branch 2: addr=0x20, index=1</li>\n<li>Branch 3: addr=0x30, index=1</li>\n<li>... </li>\n<li>Branch 2048: addr=0x8000, index=0</li>\n<li>Branch 2049: addr=0x8010, index=0</li>\n<li>Branch 2050: addr=0x8020, index=1</li>\n<li>Branch 2051: addr=0x8030, index=1</li>\n<li>... </li>\n<li>Branch 4096: addr=0x10000, index=0</li>\n<li>Branch 4097: addr=0x10010, index=0</li>\n<li>Branch 4098: addr=0x10020, index=1</li>\n<li>Branch 4099: addr=0x10030, index=1</li>\n<li>... </li>\n<li>Branch 6144: addr=0x18000, index=0</li>\n<li>Branch 6145: addr=0x18010, index=0</li>\n<li>Branch 6146: addr=0x18020, index=1</li>\n<li>Branch 6147: addr=0x18030, index=1</li>\n</ul>\n<p>\u8fd9\u4e2a\u65f6\u5019\uff0c\u6bcf\u4e2a set \u4f1a\u4ee5\u4e24\u4e2a branch \u7684\u7c92\u5ea6\u6765\u589e\u52a0\uff0c\u7531\u4e8e 6 \u662f 2 \u7684\u500d\u6570\uff0c\u6240\u4ee5\u4ece 4096 \u5f00\u59cb\uff0cset \u9010\u6e10\u88ab\u586b\u6ee1\uff0c\u4f1a\u7b49\u5230 6144 \u6761\u5206\u652f\u624d\u4f1a\u4ea7\u751f\u6ea2\u51fa\u3002</p>\n<p>\u5c0f\u7ed3\uff1a\u7531\u4e8e Main BTB \u7684 Index \u662f PC[14:5]\uff0c\u6240\u4ee5\u5728 stride=8B \u7684\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a set \u5185\u4ee5 4 \u4e2a branch \u7684\u7c92\u5ea6\u6765\u589e\u52a0\uff0c\u4f1a\u6709\u90e8\u5206 set \u5df2\u7ecf\u51fa\u73b0\u6ea2\u51fa\uff08\u53ea\u80fd\u5b58 6 \u4e2a\u5206\u652f\uff0c\u4f46\u9700\u8981\u5b58 8 \u4e2a\u5206\u652f\uff09\uff0c\u800c\u53e6\u4e00\u90e8\u5206 set \u8fd8\u6ca1\u6709\u6ee1\u7684\u60c5\u51b5\uff08\u80fd\u5b58 6 \u4e2a\u5206\u652f\uff0c\u4f46\u53ea\u5b58\u4e86 4 \u4e2a\u5206\u652f\uff09\u3002\u8fd9\u4e2a\u62d0\u70b9\u5c31\u662f 4096 \u6761\u5206\u652f\u3002</p>\n<h3 id=\"stride8b-\u7684\u60c5\u51b5\u4e0b\u5728-main-btb-\u547d\u4e2d\u7684\u8303\u56f4\u5185cpi275stride16b-\u7684\u60c5\u51b5\u4e0b\u5728-main-btb-\u547d\u4e2d\u7684\u8303\u56f4\u5185cpi25stride32b-\u6216-64b-\u6216-128b-\u7684\u60c5\u51b5\u4e0b\u5728-main-btb-\u547d\u4e2d\u7684\u8303\u56f4\u5185cpi2\">stride=8B \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 Main BTB \u547d\u4e2d\u7684\u8303\u56f4\u5185\uff0cCPI=2.75\uff1bstride=16B \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 Main BTB \u547d\u4e2d\u7684\u8303\u56f4\u5185\uff0cCPI=2.5\uff1bstride=32B \u6216 64B \u6216 128B \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 Main BTB \u547d\u4e2d\u7684\u8303\u56f4\u5185\uff0cCPI=2<a class=\"headerlink\" href=\"#stride8b-\u7684\u60c5\u51b5\u4e0b\u5728-main-btb-\u547d\u4e2d\u7684\u8303\u56f4\u5185cpi275stride16b-\u7684\u60c5\u51b5\u4e0b\u5728-main-btb-\u547d\u4e2d\u7684\u8303\u56f4\u5185cpi25stride32b-\u6216-64b-\u6216-128b-\u7684\u60c5\u51b5\u4e0b\u5728-main-btb-\u547d\u4e2d\u7684\u8303\u56f4\u5185cpi2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u524d\u9762\u63d0\u5230\uff0c\u547d\u4e2d Main BTB \u7684\u65f6\u5019\uff0c\u5176\u5b9e CPI \u5e76\u4e0d\u662f 3\uff0c\u800c\u662f 2 \u5230 3 \u4e4b\u95f4\u7684\u4e00\u4e2a\u6570\uff0c\u8fd9\u4f3c\u4e4e\u610f\u5473\u7740 Main BTB \u5e76\u975e\u603b\u662f 3 \u5468\u671f\u63d0\u4f9b\u4e00\u4e2a\u9884\u6d4b\u3002\u8003\u8651\u5230 Main BTB \u5bb9\u91cf\u6bd4\u8f83\u5927\uff0c\u5f88\u96be\u5355\u5468\u671f\u63d0\u4f9b\u4e00\u4e2a\u9884\u6d4b\uff0c\u731c\u6d4b Main BTB \u53ef\u4ee5\u4e24\u5468\u671f\u6216\u8005\u4e09\u5468\u671f\u63d0\u4f9b\u4e00\u4e2a\u9884\u6d4b\u3002\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u5728\u4e0d\u540c\u7684\u5ef6\u8fdf\u4e0b\u7ed9\u51fa\u9884\u6d4b\u7ed3\u679c\u5462\uff1f</p>\n<p>\u9996\u5148\u6765\u5206\u6790\u4e00\u4e0b Main BTB \u662f\u5982\u4f55\u505a\u9884\u6d4b\u7684\uff1a\u5b83\u9996\u5148\u4f1a\u7528\u4f20\u5165\u7684 VA \u8bbf\u95ee SRAM\uff0c\u5f97\u5230 3 \u4e2a 82-bit \u7684\u6570\u636e\uff0c\u91cc\u9762\u6700\u591a\u53ef\u4ee5\u5b58 6 \u6761\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\u3002\u5f97\u5230\u8fd9\u4e9b\u6570\u636e\u4ee5\u540e\uff0c\u8fdb\u884c tag \u6bd4\u8f83\uff0c\u7b5b\u9009\u51fa\u5176\u4e2d\u5339\u914d\u7684\u90e8\u5206\u3002\u5982\u679c\u6ca1\u6709\u5339\u914d\u7684\uff0c\u6216\u8005\u53ea\u6709\u4e00\u4e2a\u5339\u914d\u7684\u5206\u652f\uff0c\u90a3\u90fd\u597d\u8bf4\u3002\u4f46\u662f\uff0c\u5982\u679c\u6709\u591a\u6761\u5339\u914d\u7684\u5206\u652f\u5462\uff1f</p>\n<p>\u4f8b\u5982\uff0c\u8fd9\u662f\u4e00\u4e2a\u5bf9\u9f50\u7684 32B \u5757\uff0c\u91cc\u9762\u6709 8 \u6761 4 \u5b57\u8282\u7684\u6307\u4ee4\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>0     4     8     12    16    20    24    28  \n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>+-----+-----+-----+-----+-----+-----+-----+-----+\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>| NOP | NOP | Br  | NOP | NOP | NOP | Br  | NOP |\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>+-----+-----+-----+-----+-----+-----+-----+-----+\n</span></code></pre></div>\n<p>\u5047\u5982\u8981\u4ece\u5730\u5740 4 \u5904\u5f00\u59cb\u6267\u884c\uff0c\u90a3\u4e48 Main BTB \u5e94\u8be5\u8981\u5f97\u5230\u7684\u662f\u4f4d\u4e8e\u5730\u5740 8 \u7684\u5206\u652f\u7684\u4fe1\u606f\uff1b\u5047\u5982\u8981\u4ece\u5730\u5740 16 \u5904\u5f00\u59cb\u6267\u884c\uff0c\u90a3\u4e48 Main BTB \u5e94\u8be5\u8981\u5f97\u5230\u7684\u662f\u4f4d\u4e8e\u5730\u5740 24 \u7684\u5206\u652f\u7684\u4fe1\u606f\u3002\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e2a\u4e8b\u60c5\uff0c\u786c\u4ef6\u4e0a\u5e94\u8be5\uff1a</p>\n<ul>\n<li>\u9996\u5148\u627e\u5230\u5728\u540c\u4e00\u4e2a 32B \u5757\u5185\u7684\u6240\u6709\u5206\u652f\uff1a\u901a\u8fc7 tag \u6bd4\u5bf9\uff0c\u627e\u5230\u8fd9\u4e2a set \u5185\u7684\u5728\u8be5 32B \u5185\u7684\u6240\u6709\u5206\u652f</li>\n<li>\u63a5\u7740\uff0c\u627e\u5230\u6bd4\u8f93\u5165\u7684 VA <strong>\u5927\u4e8e\u6216\u8005\u7b49\u4e8e</strong>\u7684<strong>\u7b2c\u4e00\u4e2a</strong>\u5206\u652f</li>\n</ul>\n<p>\u8fd9\u4e2a\u903b\u8f91\u662f\u6bd4\u8f83\u590d\u6742\u7684\uff0c\u9996\u5148\u8981\u7b5b\u9009\u51fa\u5730\u5740\u5927\u4e8e\u6216\u7b49\u4e8e\u8f93\u5165\u7684 VA \u7684\u5206\u652f\uff0c\u5176\u6b21\u8981\u627e\u5230\u5176\u4e2d VA \u6700\u5c0f\u7684\u5206\u652f\u3002\u4e00\u4e2a\u601d\u8def\u662f\u4fdd\u8bc1 BTB \u91cc\u9762\u7684 VA \u662f\u6392\u597d\u5e8f\u7684\uff0c\u4f46\u662f\u786c\u4ef6\u4e0a\u6392\u5e8f\u5e76\u4e0d\u597d\u505a\uff0c\u800c\u4e14\u5373\u4f7f\u6392\u5e8f\u4e86\uff0c\u4e5f\u9700\u8981\u505a\u7c7b\u4f3c\u4e8c\u5206\u641c\u7d22\u7684\u4e8b\u60c5\u3002\u53e6\u4e00\u4e2a\u601d\u8def\u5c31\u662f\u4e0d\u7ba1\u987a\u5e8f\uff0c\u7528\u7ec4\u5408\u903b\u8f91\u628a\u6240\u6709\u53ef\u80fd\u6027\u90fd\u8003\u8651\u5230\uff0c\u8ba1\u7b97\u51fa\u8981\u627e\u7684\u5206\u652f\u3002</p>\n<p>\u4f46\u662f\u8fd9\u4e2a\u7ec4\u5408\u903b\u8f91\u6bd4\u8f83\u590d\u6742\uff0c\u672c\u8d28\u4e0a\u5c31\u662f\u4e00\u4e2a filter+min \u64cd\u4f5c\uff0c\u9700\u8981\u6bd4\u8f83\u5927\u7684\u5ef6\u8fdf\u3002\u4e09\u4e2a\u5468\u671f\u80fd\u505a\u4e0b\u6765\uff0c\u4f46\u662f\u4e24\u4e2a\u5468\u671f\u5185\uff0c\u5c31\u505a\u4e0d\u4e0b\u8fd9\u4e48\u590d\u6742\u7684\u7ec4\u5408\u903b\u8f91\u4e86\u3002\u90a3\u600e\u4e48\u529e\u5462\uff1f</p>\n<p>\u89c2\u5bdf\u4e00\u4e0b CPI \u6bd4 3 \u5c0f\u7684\u60c5\u51b5\uff1a</p>\n<ul>\n<li>stride=8B \u7684 CPI=2.75</li>\n<li>stride=16B \u7684 CPI=2.5</li>\n<li>stride=32B \u6216 64B \u6216 128B \u7684 CPI=2</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u968f\u7740 stride \u589e\u52a0\uff0cCPI \u9010\u6e10\u51cf\u5c11\uff0c\u5230 stride=32B \u7684\u65f6\u5019\uff0c\u80fd\u591f\u7a33\u5b9a\u5730\u8fbe\u5230 CPI=2 \u7684\u60c5\u51b5\u3002\u8bbe\u60f3 Main BTB \u6709\u4e00\u4e2a 2 \u5468\u671f\u51fa\u7ed3\u679c\u7684 fast path\uff0c\u90a3\u4e48\u5b83\u6b64\u65f6\u53ef\u4ee5\u7a33\u5b9a\u5730\u89e6\u53d1\uff1b\u800c stride=16B \u53ea\u6709\u4e00\u534a\u7684\u65f6\u5019\u53ef\u4ee5\u89e6\u53d1 fast path\uff1a<code>0.5*2+0.5*3=2.5</code>\uff1bstride=8B \u53ea\u6709\u56db\u5206\u4e4b\u4e00\u7684\u65f6\u5019\u53ef\u4ee5\u89e6\u53d1 fast path\uff1a<code>0.25*2+0.75*3=2.75</code>\u3002\u8fd9\u6837\u8fd9\u4e9b CPI \u90fd\u8bf4\u5f97\u901a\u4e86\uff0c\u5176\u5b9e\u5c31\u662f\u6709\u591a\u5927\u7684\u6982\u7387\u80fd\u591f\u89e6\u53d1 fast path\u3002\u90a3\u4e48 fast path \u751f\u6548\u7684\u6bd4\u4f8b\u662f\uff1a</p>\n<ul>\n<li>stride=8B \u6709\u56db\u5206\u4e4b\u4e00\u7684\u6982\u7387\u8d70 fast path</li>\n<li>stride=16B \u6709\u4e8c\u5206\u4e4b\u4e00\u7684\u6982\u7387\u8d70 fast path</li>\n<li>stride=32B \u6216 64B \u6216 128B \u4e00\u5b9a\u53ef\u4ee5\u8d70 fast path</li>\n</ul>\n<p>\u6b64\u65f6\u4f60\u53ef\u80fd\u5df2\u7ecf\u53d1\u73b0\u4e86\u4e00\u4e9b\u89c4\u5f8b\uff1a<code>32/4=8</code>\uff0c\u7136\u540e <code>32/2=16</code>\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u5bf9\u9f50\u7684 32B \u5757\u91cc\uff0c\u6709\u56db\u6761\u5206\u652f\u7684\u65f6\u5019\uff0c\u5e73\u5747\u53ea\u6709\u4e00\u6761\u5206\u652f\u53ef\u4ee5\u8d70 fast path\uff1b\u6709\u4e24\u6761\u5206\u652f\u7684\u65f6\u5019\uff0c\u5e73\u5747\u4e5f\u662f\u4e00\u6761\u5206\u652f\u53ef\u4ee5\u8d70 fast path\uff1b\u53ea\u6709\u4e00\u6761\u5206\u652f\u7684\u65f6\u5019\uff0c\u5b83\u603b\u662f\u53ef\u4ee5\u8d70 fast path\u3002</p>\n<p>\u518d\u56de\u60f3\u4e00\u4e0b\u524d\u9762\u7684\u5339\u914d\u903b\u8f91\uff1a</p>\n<ol>\n<li>\u627e\u5230\u8be5 32B \u5757\u5185\u6240\u6709\u7684\u5206\u652f\uff1a\u8fd9\u4e00\u6b65\u514d\u4e0d\u4e86</li>\n<li>\u627e\u5230\u5927\u4e8e\u6216\u7b49\u4e8e\u8f93\u5165 VA \u5730\u5740\u7684\u6240\u6709\u5206\u652f\uff1a\u8fd9\u4e00\u6b65\u4e5f\u514d\u4e0d\u4e86</li>\n<li>\u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u8981\u6c42\u7684\u5206\u652f\uff1a\u5982\u679c\u53ea\u6709\u4e00\u6761\u5206\u652f\uff0c\u90a3\u5c31\u4e0d\u7528\u5bfb\u627e\u6700\u5c0f\u503c\u4e86\uff0c\u8fd9\u5c31\u662f fast path \u7684\u6761\u4ef6</li>\n</ol>\n<p>\u8fd9\u5c31\u89e3\u91ca\u4e86\u524d\u9762\u7684\u73b0\u8c61\uff1a\u5f53 stride=8B \u7684\u65f6\u5019\uff0c\u5bf9\u9f50\u7684 32B \u5757\u5185\u90e8\u662f\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>0     4     8     12    16    20    24    28  \n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>+-----+-----+-----+-----+-----+-----+-----+-----+\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>| Br  | NOP | Br  | NOP | Br  | NOP | Br  | NOP |\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>+-----+-----+-----+-----+-----+-----+-----+-----+\n</span></code></pre></div>\n<p>\u5206\u652f\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u7528\u7684\u5730\u5740\u5206\u522b\u662f 0\u30018\u300116 \u548c 24\u3002\u5f53\u7528 0\u30018 \u548c 16 \u7684\u8f93\u5165 VA \u67e5\u8be2\u7684\u65f6\u5019\uff0c\u5206\u522b\u80fd\u627e\u5230 4\u30013 \u548c 2 \u6761 VA \u5927\u4e8e\u6216\u7b49\u4e8e\u8f93\u5165 VA \u7684\u5206\u652f\u3002\u53ea\u6709\u5728\u7528 24 \u7684\u8f93\u5165 VA \u67e5\u8be2\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u627e\u5230\u4e00\u6761\u5206\u652f\uff0c\u4e0d\u9700\u8981\u518d\u6c42 min\u3002</p>\n<p>stride=16B \u7684\u60c5\u51b5\u7c7b\u4f3c\uff0c\u5728\u9884\u6d4b\u7b2c\u4e8c\u6761\u5206\u652f\u7684\u65f6\u5019\uff0c\u53ea\u6709\u4e00\u6761\u5206\u652f\u6ee1\u8db3\u8981\u6c42\uff0c\u53ef\u4ee5\u8d70 fast path\u3002</p>\n<p>stride=32B \u6216\u66f4\u5927\u7684\u65f6\u5019\uff0c\u5bf9\u9f50\u7684 32B \u5757\u5185\u90fd\u53ea\u6709\u4e00\u6761\u5206\u652f\uff0c\u6ee1\u8db3\u8d70 fast path \u7684\u6761\u4ef6\u3002</p>\n<p>\u8fd9\u5c31\u89e3\u91ca\u4e86\u524d\u9762\u770b\u5230\u7684\u5404\u79cd\u5947\u602a\u7684 CPI \u73b0\u8c61\u3002</p>\n<p>\u90a3\u4e48\uff0c\u4e3a\u4ec0\u4e48\u53ea\u6709 Main BTB \u4f1a\u51fa\u73b0\u8fd9\u79cd\u73b0\u8c61\u5462\uff0c\u7406\u8bba\u4e0a\u6765\u8bf4\uff0cNano BTB \u548c Micro BTB \u4e5f\u53ef\u4ee5\u505a\u7c7b\u4f3c\u7684\u4f18\u5316\uff1f\u8fd9\u5c31\u6d89\u53ca\u5230\u4e86 BTB \u7684\u4e0d\u540c\u7684\u7ec4\u7ec7\u65b9\u5f0f\uff1a</p>\n<ol>\n<li>\u4e00\u79cd\u662f Main BTB \u8fd9\u79cd\uff0c\u6bcf\u6761\u5206\u652f\u53ea\u4fdd\u5b58\u4e00\u4efd\uff0c\u90a3\u4e48\u4e3a\u4e86\u627e\u5230\u67d0\u4e2a VA \u5f00\u59cb\u7684\u7b2c\u4e00\u6761\u5206\u652f\uff0c\u5c31\u9700\u8981\u628a\u6ee1\u8db3\u8981\u6c42\u7684\u5206\u652f\u90fd\u627e\u51fa\u6765\uff0c\u518d\u5bfb\u627e\u5730\u5740\u6700\u5c0f\u7684\u90a3\u4e00\u4e2a\uff1b\u5177\u4f53\u5b9e\u73b0\u4e0a\uff0c\u4e5f\u6709\u4e24\u79cd\u60c5\u51b5\uff1a<ol>\n<li>\u5bf9\u4e8e\u6bcf\u4e2a\u53ef\u80fd\u51fa\u73b0\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0c\u90fd\u8fdb\u884c\u4e00\u6b21 BTB \u67e5\u8be2\uff08\u8fd9\u79cd\u7ed3\u6784\u53eb Instruction BTB\uff09</li>\n<li>\u5bf9\u4e8e\u6bcf\u4e2a\u5bf9\u9f50\u7684\u5757\uff0c\u8bb0\u5f55\u8fd9\u4e2a\u5757\u5185\u7684\u6709\u9650\u6761\u5206\u652f\u7684\u4fe1\u606f\uff08\u8fd9\u79cd\u7ed3\u6784\u53eb Region BTB\uff09\uff0cMain BTB \u91c7\u7528\u7684\u5c31\u662f\u8fd9\u79cd\uff0c\u6bcf\u4e2a\u5bf9\u9f50\u7684 32B \u5757\u5185\u6700\u591a\u4fdd\u5b58\u516d\u6761\u5206\u652f</li>\n</ol>\n</li>\n<li>\u53e6\u4e00\u79cd\u7ed3\u6784\uff0c\u5219\u662f\u76f4\u63a5\u8bb0\u5f55\u4ece\u67d0\u4e2a VA \u5f00\u59cb\u7684\u7b2c\u4e00\u6761\u5206\u652f\uff0c\u5373\u7ed9\u5b9a VA\uff0c\u67e5\u8be2 BTB \u540e\uff0c\u5339\u914d\u5230\u7684 entry \u91cc\u8bb0\u5f55\u7684\u5c31\u662f\u4ece\u8fd9\u4e2a VA \u5f00\u59cb\u7684\u7b2c\u4e00\u6761\u5206\u652f\uff08\u8fd9\u79cd\u7ed3\u6784\u53eb\u505a Block BTB\uff09\uff1b\u8fd9\u6837\u4e00\u6761\u5206\u652f\u53ef\u80fd\u4f1a\u51fa\u73b0\u5728\u591a\u4e2a entry \u5185\uff0c\u6b64\u65f6\u5c31\u4e0d\u4f1a\u6d89\u53ca\u5230\u4e0a\u9762\u6240\u8ff0\u7684 fast path \u4f18\u5316</li>\n</ol>\n<p>\u90a3\u4e48\u731c\u6d4b Nano BTB \u548c Micro BTB \u91c7\u7528\u4e86 Block BTB \u7684\u65b9\u6cd5\uff0c\u6216\u8005\u56e0\u4e3a\u5ef6\u8fdf\u672c\u8eab\u5c31\u8db3\u591f\u4f4e\uff0c\u5373\u4f7f\u53ef\u4ee5\u505a fast path\uff0c\u4e5f\u6ca1\u6709\u5f15\u5165 fast path \u4f18\u5316\u3002</p>\n<p>\u8be6\u7ec6\u7684 BTB \u8bbe\u8ba1\u5206\u6790\uff0c\u53ef\u4ee5\u53c2\u8003 <a href=\"../../../../2024/09/12/brief-into-ooo-3/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e09\uff1a\u524d\u7aef\uff09</a> \u7684\u76f8\u5173\u5185\u5bb9\u3002</p>\n<p>\u5c0f\u7ed3\uff1aMain BTB \u53ef\u4ee5\u5728 2 \u6216 3 \u5468\u671f\u63d0\u4f9b\u9884\u6d4b\uff0c\u5176\u4e2d 2 \u5468\u671f\u9884\u6d4b\u7684\u6761\u4ef6\u662f\uff0c\u53ea\u627e\u5230\u4e00\u6761 VA \u5927\u4e8e\u6216\u7b49\u4e8e\u8f93\u5165 VA \u7684\u5206\u652f\uff0c\u6b64\u65f6\u53ef\u4ee5\u8df3\u8fc7\u6c42 min \u7684\u7ec4\u5408\u903b\u8f91\uff0c\u5728\u7b2c\u4e8c\u4e2a\u5468\u671f\u7ed9\u51fa\u9884\u6d4b\u3002</p>\n<h2 id=\"\u6a21\u62df\">\u6a21\u62df<a class=\"headerlink\" href=\"#\u6a21\u62df\" title=\"Permanent link\">&para;</a></h2>\n<p>\u65e2\u7136\u5df2\u7ecf\u77e5\u9053\u4e86\u5b83\u7684 BTB \u7ed3\u6784\uff0c\u5c31\u5199\u4e86\u4e00\u6bb5\u7a0b\u5e8f\u6765\u6a21\u62df\u5b83\u7684\u5de5\u4f5c\u8fc7\u7a0b\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\">// Cortex-A76/Neoverse-N1 BTB model</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"c1\">// 16-entry Nano BTB, fully associative, 1 cycle latency.</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"c1\">// 64-entry Micro BTB, fully associative, 2 cycle latency.</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"c1\">// 3072-entry Main BTB, 3-way set associative, 2-3 cycle latency, each entry at</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"c1\">// most 2 branches, index PC[14:5].</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;assert.h&gt;</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;set&gt;</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdint.h&gt;</span>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;string.h&gt;</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;utility&gt;</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;vector&gt;</span>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a>\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">BTBEntry</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">valid</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-2-20\"><a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\" href=\"#__codelineno-2-20\"></a>\n</span><span id=\"__span-2-21\"><a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\" href=\"#__codelineno-2-21\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"n\">BTBEntry</span><span class=\"w\"> </span><span class=\"n\">NanoBTBEntry</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-22\"><a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\" href=\"#__codelineno-2-22\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"n\">BTBEntry</span><span class=\"w\"> </span><span class=\"n\">MicroBTBEntry</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-23\"><a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\" href=\"#__codelineno-2-23\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"n\">BTBEntry</span><span class=\"w\"> </span><span class=\"n\">MainBTBEntry</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-24\"><a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\" href=\"#__codelineno-2-24\"></a>\n</span><span id=\"__span-2-25\"><a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\" href=\"#__codelineno-2-25\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Model</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-26\"><a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\" href=\"#__codelineno-2-26\"></a><span class=\"w\">  </span><span class=\"n\">NanoBTBEntry</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-27\"><a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\" href=\"#__codelineno-2-27\"></a><span class=\"w\">  </span><span class=\"n\">MicroBTBEntry</span><span class=\"w\"> </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-28\"><a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\" href=\"#__codelineno-2-28\"></a><span class=\"w\">  </span><span class=\"c1\">// pretend as 6-way</span>\n</span><span id=\"__span-2-29\"><a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\" href=\"#__codelineno-2-29\"></a><span class=\"w\">  </span><span class=\"n\">MainBTBEntry</span><span class=\"w\"> </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"mi\">1024</span><span class=\"p\">][</span><span class=\"mi\">6</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-30\"><a id=\"__codelineno-2-30\" name=\"__codelineno-2-30\" href=\"#__codelineno-2-30\"></a><span class=\"w\">  </span><span class=\"c1\">// 64KB ICache, pretend as direct mapped</span>\n</span><span id=\"__span-2-31\"><a id=\"__codelineno-2-31\" name=\"__codelineno-2-31\" href=\"#__codelineno-2-31\"></a><span class=\"w\">  </span><span class=\"c1\">// index: PC[15:6]</span>\n</span><span id=\"__span-2-32\"><a id=\"__codelineno-2-32\" name=\"__codelineno-2-32\" href=\"#__codelineno-2-32\"></a><span class=\"w\">  </span><span class=\"c1\">// tag: PC[:16]</span>\n</span><span id=\"__span-2-33\"><a id=\"__codelineno-2-33\" name=\"__codelineno-2-33\" href=\"#__codelineno-2-33\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">iCache</span><span class=\"p\">[</span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-34\"><a id=\"__codelineno-2-34\" name=\"__codelineno-2-34\" href=\"#__codelineno-2-34\"></a>\n</span><span id=\"__span-2-35\"><a id=\"__codelineno-2-35\" name=\"__codelineno-2-35\" href=\"#__codelineno-2-35\"></a><span class=\"w\">  </span><span class=\"c1\">// return latency</span>\n</span><span id=\"__span-2-36\"><a id=\"__codelineno-2-36\" name=\"__codelineno-2-36\" href=\"#__codelineno-2-36\"></a><span class=\"w\">  </span><span class=\"c1\">// use pc to predict a branch at pc, i.e. pva = pc</span>\n</span><span id=\"__span-2-37\"><a id=\"__codelineno-2-37\" name=\"__codelineno-2-37\" href=\"#__codelineno-2-37\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">match</span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-38\"><a id=\"__codelineno-2-38\" name=\"__codelineno-2-38\" href=\"#__codelineno-2-38\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// BTB miss penalty</span>\n</span><span id=\"__span-2-39\"><a id=\"__codelineno-2-39\" name=\"__codelineno-2-39\" href=\"#__codelineno-2-39\"></a><span class=\"w\">    </span><span class=\"c1\">// Nano BTB at P1</span>\n</span><span id=\"__span-2-40\"><a id=\"__codelineno-2-40\" name=\"__codelineno-2-40\" href=\"#__codelineno-2-40\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-41\"><a id=\"__codelineno-2-41\" name=\"__codelineno-2-41\" href=\"#__codelineno-2-41\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-42\"><a id=\"__codelineno-2-42\" name=\"__codelineno-2-42\" href=\"#__codelineno-2-42\"></a><span class=\"w\">        </span><span class=\"c1\">// Nano BTB hit</span>\n</span><span id=\"__span-2-43\"><a id=\"__codelineno-2-43\" name=\"__codelineno-2-43\" href=\"#__codelineno-2-43\"></a><span class=\"w\">        </span><span class=\"c1\">// LRU: move it to head</span>\n</span><span id=\"__span-2-44\"><a id=\"__codelineno-2-44\" name=\"__codelineno-2-44\" href=\"#__codelineno-2-44\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-45\"><a id=\"__codelineno-2-45\" name=\"__codelineno-2-45\" href=\"#__codelineno-2-45\"></a><span class=\"w\">          </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-46\"><a id=\"__codelineno-2-46\" name=\"__codelineno-2-46\" href=\"#__codelineno-2-46\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-47\"><a id=\"__codelineno-2-47\" name=\"__codelineno-2-47\" href=\"#__codelineno-2-47\"></a><span class=\"w\">        </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-48\"><a id=\"__codelineno-2-48\" name=\"__codelineno-2-48\" href=\"#__codelineno-2-48\"></a><span class=\"w\">        </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-49\"><a id=\"__codelineno-2-49\" name=\"__codelineno-2-49\" href=\"#__codelineno-2-49\"></a><span class=\"w\">        </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-50\"><a id=\"__codelineno-2-50\" name=\"__codelineno-2-50\" href=\"#__codelineno-2-50\"></a><span class=\"w\">        </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">main_btb</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-51\"><a id=\"__codelineno-2-51\" name=\"__codelineno-2-51\" href=\"#__codelineno-2-51\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-52\"><a id=\"__codelineno-2-52\" name=\"__codelineno-2-52\" href=\"#__codelineno-2-52\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-53\"><a id=\"__codelineno-2-53\" name=\"__codelineno-2-53\" href=\"#__codelineno-2-53\"></a>\n</span><span id=\"__span-2-54\"><a id=\"__codelineno-2-54\" name=\"__codelineno-2-54\" href=\"#__codelineno-2-54\"></a><span class=\"w\">    </span><span class=\"c1\">// Nano BTB miss, check Micro BTB at P1</span>\n</span><span id=\"__span-2-55\"><a id=\"__codelineno-2-55\" name=\"__codelineno-2-55\" href=\"#__codelineno-2-55\"></a><span class=\"w\">    </span><span class=\"c1\">// like victim cache</span>\n</span><span id=\"__span-2-56\"><a id=\"__codelineno-2-56\" name=\"__codelineno-2-56\" href=\"#__codelineno-2-56\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-57\"><a id=\"__codelineno-2-57\" name=\"__codelineno-2-57\" href=\"#__codelineno-2-57\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-58\"><a id=\"__codelineno-2-58\" name=\"__codelineno-2-58\" href=\"#__codelineno-2-58\"></a><span class=\"w\">        </span><span class=\"c1\">// Micro BTB hit</span>\n</span><span id=\"__span-2-59\"><a id=\"__codelineno-2-59\" name=\"__codelineno-2-59\" href=\"#__codelineno-2-59\"></a><span class=\"w\">        </span><span class=\"c1\">// Move to Nano BTB</span>\n</span><span id=\"__span-2-60\"><a id=\"__codelineno-2-60\" name=\"__codelineno-2-60\" href=\"#__codelineno-2-60\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-61\"><a id=\"__codelineno-2-61\" name=\"__codelineno-2-61\" href=\"#__codelineno-2-61\"></a><span class=\"w\">          </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-62\"><a id=\"__codelineno-2-62\" name=\"__codelineno-2-62\" href=\"#__codelineno-2-62\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-63\"><a id=\"__codelineno-2-63\" name=\"__codelineno-2-63\" href=\"#__codelineno-2-63\"></a><span class=\"w\">        </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-64\"><a id=\"__codelineno-2-64\" name=\"__codelineno-2-64\" href=\"#__codelineno-2-64\"></a><span class=\"w\">        </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-65\"><a id=\"__codelineno-2-65\" name=\"__codelineno-2-65\" href=\"#__codelineno-2-65\"></a>\n</span><span id=\"__span-2-66\"><a id=\"__codelineno-2-66\" name=\"__codelineno-2-66\" href=\"#__codelineno-2-66\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-67\"><a id=\"__codelineno-2-67\" name=\"__codelineno-2-67\" href=\"#__codelineno-2-67\"></a><span class=\"w\">          </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-68\"><a id=\"__codelineno-2-68\" name=\"__codelineno-2-68\" href=\"#__codelineno-2-68\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-69\"><a id=\"__codelineno-2-69\" name=\"__codelineno-2-69\" href=\"#__codelineno-2-69\"></a><span class=\"w\">        </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-70\"><a id=\"__codelineno-2-70\" name=\"__codelineno-2-70\" href=\"#__codelineno-2-70\"></a><span class=\"w\">        </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-71\"><a id=\"__codelineno-2-71\" name=\"__codelineno-2-71\" href=\"#__codelineno-2-71\"></a><span class=\"w\">        </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-72\"><a id=\"__codelineno-2-72\" name=\"__codelineno-2-72\" href=\"#__codelineno-2-72\"></a><span class=\"w\">        </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">main_btb</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-73\"><a id=\"__codelineno-2-73\" name=\"__codelineno-2-73\" href=\"#__codelineno-2-73\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-74\"><a id=\"__codelineno-2-74\" name=\"__codelineno-2-74\" href=\"#__codelineno-2-74\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-75\"><a id=\"__codelineno-2-75\" name=\"__codelineno-2-75\" href=\"#__codelineno-2-75\"></a>\n</span><span id=\"__span-2-76\"><a id=\"__codelineno-2-76\" name=\"__codelineno-2-76\" href=\"#__codelineno-2-76\"></a><span class=\"w\">    </span><span class=\"c1\">// Micro BTB miss</span>\n</span><span id=\"__span-2-77\"><a id=\"__codelineno-2-77\" name=\"__codelineno-2-77\" href=\"#__codelineno-2-77\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-78\"><a id=\"__codelineno-2-78\" name=\"__codelineno-2-78\" href=\"#__codelineno-2-78\"></a><span class=\"w\">      </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-79\"><a id=\"__codelineno-2-79\" name=\"__codelineno-2-79\" href=\"#__codelineno-2-79\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-80\"><a id=\"__codelineno-2-80\" name=\"__codelineno-2-80\" href=\"#__codelineno-2-80\"></a><span class=\"w\">    </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-81\"><a id=\"__codelineno-2-81\" name=\"__codelineno-2-81\" href=\"#__codelineno-2-81\"></a><span class=\"w\">    </span><span class=\"n\">microBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-82\"><a id=\"__codelineno-2-82\" name=\"__codelineno-2-82\" href=\"#__codelineno-2-82\"></a>\n</span><span id=\"__span-2-83\"><a id=\"__codelineno-2-83\" name=\"__codelineno-2-83\" href=\"#__codelineno-2-83\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-84\"><a id=\"__codelineno-2-84\" name=\"__codelineno-2-84\" href=\"#__codelineno-2-84\"></a><span class=\"w\">      </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-85\"><a id=\"__codelineno-2-85\" name=\"__codelineno-2-85\" href=\"#__codelineno-2-85\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-86\"><a id=\"__codelineno-2-86\" name=\"__codelineno-2-86\" href=\"#__codelineno-2-86\"></a><span class=\"w\">    </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-87\"><a id=\"__codelineno-2-87\" name=\"__codelineno-2-87\" href=\"#__codelineno-2-87\"></a><span class=\"w\">    </span><span class=\"n\">nanoBTB</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-88\"><a id=\"__codelineno-2-88\" name=\"__codelineno-2-88\" href=\"#__codelineno-2-88\"></a>\n</span><span id=\"__span-2-89\"><a id=\"__codelineno-2-89\" name=\"__codelineno-2-89\" href=\"#__codelineno-2-89\"></a><span class=\"w\">  </span><span class=\"nl\">main_btb</span><span class=\"p\">:</span>\n</span><span id=\"__span-2-90\"><a id=\"__codelineno-2-90\" name=\"__codelineno-2-90\" href=\"#__codelineno-2-90\"></a><span class=\"w\">    </span><span class=\"c1\">// check Main BTB</span>\n</span><span id=\"__span-2-91\"><a id=\"__codelineno-2-91\" name=\"__codelineno-2-91\" href=\"#__codelineno-2-91\"></a><span class=\"w\">    </span><span class=\"c1\">// PC[4:2]</span>\n</span><span id=\"__span-2-92\"><a id=\"__codelineno-2-92\" name=\"__codelineno-2-92\" href=\"#__codelineno-2-92\"></a><span class=\"w\">    </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mh\">0x1c</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-93\"><a id=\"__codelineno-2-93\" name=\"__codelineno-2-93\" href=\"#__codelineno-2-93\"></a><span class=\"w\">    </span><span class=\"c1\">// PC[14:5]</span>\n</span><span id=\"__span-2-94\"><a id=\"__codelineno-2-94\" name=\"__codelineno-2-94\" href=\"#__codelineno-2-94\"></a><span class=\"w\">    </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mh\">0x7fe0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-95\"><a id=\"__codelineno-2-95\" name=\"__codelineno-2-95\" href=\"#__codelineno-2-95\"></a><span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-96\"><a id=\"__codelineno-2-96\" name=\"__codelineno-2-96\" href=\"#__codelineno-2-96\"></a><span class=\"w\">    </span><span class=\"c1\">// PC[n:15]</span>\n</span><span id=\"__span-2-97\"><a id=\"__codelineno-2-97\" name=\"__codelineno-2-97\" href=\"#__codelineno-2-97\"></a><span class=\"w\">    </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-98\"><a id=\"__codelineno-2-98\" name=\"__codelineno-2-98\" href=\"#__codelineno-2-98\"></a><span class=\"w\">    </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">min_offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-99\"><a id=\"__codelineno-2-99\" name=\"__codelineno-2-99\" href=\"#__codelineno-2-99\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">min_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-100\"><a id=\"__codelineno-2-100\" name=\"__codelineno-2-100\" href=\"#__codelineno-2-100\"></a><span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-101\"><a id=\"__codelineno-2-101\" name=\"__codelineno-2-101\" href=\"#__codelineno-2-101\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-102\"><a id=\"__codelineno-2-102\" name=\"__codelineno-2-102\" href=\"#__codelineno-2-102\"></a><span class=\"w\">      </span><span class=\"c1\">// find matches</span>\n</span><span id=\"__span-2-103\"><a id=\"__codelineno-2-103\" name=\"__codelineno-2-103\" href=\"#__codelineno-2-103\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">valid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-104\"><a id=\"__codelineno-2-104\" name=\"__codelineno-2-104\" href=\"#__codelineno-2-104\"></a><span class=\"w\">        </span><span class=\"c1\">// check offset</span>\n</span><span id=\"__span-2-105\"><a id=\"__codelineno-2-105\" name=\"__codelineno-2-105\" href=\"#__codelineno-2-105\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mh\">0x1c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-106\"><a id=\"__codelineno-2-106\" name=\"__codelineno-2-106\" href=\"#__codelineno-2-106\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">min_i</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-107\"><a id=\"__codelineno-2-107\" name=\"__codelineno-2-107\" href=\"#__codelineno-2-107\"></a><span class=\"w\">            </span><span class=\"n\">min_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-108\"><a id=\"__codelineno-2-108\" name=\"__codelineno-2-108\" href=\"#__codelineno-2-108\"></a><span class=\"w\">            </span><span class=\"n\">min_offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mh\">0x1c</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-109\"><a id=\"__codelineno-2-109\" name=\"__codelineno-2-109\" href=\"#__codelineno-2-109\"></a><span class=\"w\">          </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mh\">0x1c</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">min_offset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-110\"><a id=\"__codelineno-2-110\" name=\"__codelineno-2-110\" href=\"#__codelineno-2-110\"></a><span class=\"w\">            </span><span class=\"n\">min_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-111\"><a id=\"__codelineno-2-111\" name=\"__codelineno-2-111\" href=\"#__codelineno-2-111\"></a><span class=\"w\">            </span><span class=\"n\">min_offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mh\">0x1c</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-112\"><a id=\"__codelineno-2-112\" name=\"__codelineno-2-112\" href=\"#__codelineno-2-112\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-113\"><a id=\"__codelineno-2-113\" name=\"__codelineno-2-113\" href=\"#__codelineno-2-113\"></a><span class=\"w\">          </span><span class=\"n\">matches</span><span class=\"o\">++</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-114\"><a id=\"__codelineno-2-114\" name=\"__codelineno-2-114\" href=\"#__codelineno-2-114\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-115\"><a id=\"__codelineno-2-115\" name=\"__codelineno-2-115\" href=\"#__codelineno-2-115\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-116\"><a id=\"__codelineno-2-116\" name=\"__codelineno-2-116\" href=\"#__codelineno-2-116\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-117\"><a id=\"__codelineno-2-117\" name=\"__codelineno-2-117\" href=\"#__codelineno-2-117\"></a>\n</span><span id=\"__span-2-118\"><a id=\"__codelineno-2-118\" name=\"__codelineno-2-118\" href=\"#__codelineno-2-118\"></a><span class=\"w\">    </span><span class=\"c1\">// hit</span>\n</span><span id=\"__span-2-119\"><a id=\"__codelineno-2-119\" name=\"__codelineno-2-119\" href=\"#__codelineno-2-119\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">min_offset</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-120\"><a id=\"__codelineno-2-120\" name=\"__codelineno-2-120\" href=\"#__codelineno-2-120\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-121\"><a id=\"__codelineno-2-121\" name=\"__codelineno-2-121\" href=\"#__codelineno-2-121\"></a><span class=\"w\">        </span><span class=\"c1\">// LRU</span>\n</span><span id=\"__span-2-122\"><a id=\"__codelineno-2-122\" name=\"__codelineno-2-122\" href=\"#__codelineno-2-122\"></a><span class=\"w\">        </span><span class=\"n\">MainBTBEntry</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">min_i</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-123\"><a id=\"__codelineno-2-123\" name=\"__codelineno-2-123\" href=\"#__codelineno-2-123\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">min_i</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-124\"><a id=\"__codelineno-2-124\" name=\"__codelineno-2-124\" href=\"#__codelineno-2-124\"></a><span class=\"w\">          </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-125\"><a id=\"__codelineno-2-125\" name=\"__codelineno-2-125\" href=\"#__codelineno-2-125\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-126\"><a id=\"__codelineno-2-126\" name=\"__codelineno-2-126\" href=\"#__codelineno-2-126\"></a><span class=\"w\">        </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-127\"><a id=\"__codelineno-2-127\" name=\"__codelineno-2-127\" href=\"#__codelineno-2-127\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-128\"><a id=\"__codelineno-2-128\" name=\"__codelineno-2-128\" href=\"#__codelineno-2-128\"></a>\n</span><span id=\"__span-2-129\"><a id=\"__codelineno-2-129\" name=\"__codelineno-2-129\" href=\"#__codelineno-2-129\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-130\"><a id=\"__codelineno-2-130\" name=\"__codelineno-2-130\" href=\"#__codelineno-2-130\"></a><span class=\"w\">        </span><span class=\"c1\">// fast path</span>\n</span><span id=\"__span-2-131\"><a id=\"__codelineno-2-131\" name=\"__codelineno-2-131\" href=\"#__codelineno-2-131\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-132\"><a id=\"__codelineno-2-132\" name=\"__codelineno-2-132\" href=\"#__codelineno-2-132\"></a><span class=\"w\">          </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-133\"><a id=\"__codelineno-2-133\" name=\"__codelineno-2-133\" href=\"#__codelineno-2-133\"></a><span class=\"w\">          </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-134\"><a id=\"__codelineno-2-134\" name=\"__codelineno-2-134\" href=\"#__codelineno-2-134\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-135\"><a id=\"__codelineno-2-135\" name=\"__codelineno-2-135\" href=\"#__codelineno-2-135\"></a><span class=\"w\">      </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-136\"><a id=\"__codelineno-2-136\" name=\"__codelineno-2-136\" href=\"#__codelineno-2-136\"></a><span class=\"w\">        </span><span class=\"c1\">// slow path</span>\n</span><span id=\"__span-2-137\"><a id=\"__codelineno-2-137\" name=\"__codelineno-2-137\" href=\"#__codelineno-2-137\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-138\"><a id=\"__codelineno-2-138\" name=\"__codelineno-2-138\" href=\"#__codelineno-2-138\"></a><span class=\"w\">          </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-139\"><a id=\"__codelineno-2-139\" name=\"__codelineno-2-139\" href=\"#__codelineno-2-139\"></a><span class=\"w\">          </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-140\"><a id=\"__codelineno-2-140\" name=\"__codelineno-2-140\" href=\"#__codelineno-2-140\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-141\"><a id=\"__codelineno-2-141\" name=\"__codelineno-2-141\" href=\"#__codelineno-2-141\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-142\"><a id=\"__codelineno-2-142\" name=\"__codelineno-2-142\" href=\"#__codelineno-2-142\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-143\"><a id=\"__codelineno-2-143\" name=\"__codelineno-2-143\" href=\"#__codelineno-2-143\"></a>\n</span><span id=\"__span-2-144\"><a id=\"__codelineno-2-144\" name=\"__codelineno-2-144\" href=\"#__codelineno-2-144\"></a><span class=\"w\">    </span><span class=\"c1\">// miss</span>\n</span><span id=\"__span-2-145\"><a id=\"__codelineno-2-145\" name=\"__codelineno-2-145\" href=\"#__codelineno-2-145\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-146\"><a id=\"__codelineno-2-146\" name=\"__codelineno-2-146\" href=\"#__codelineno-2-146\"></a><span class=\"w\">      </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-147\"><a id=\"__codelineno-2-147\" name=\"__codelineno-2-147\" href=\"#__codelineno-2-147\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-148\"><a id=\"__codelineno-2-148\" name=\"__codelineno-2-148\" href=\"#__codelineno-2-148\"></a><span class=\"w\">    </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-149\"><a id=\"__codelineno-2-149\" name=\"__codelineno-2-149\" href=\"#__codelineno-2-149\"></a><span class=\"w\">    </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-150\"><a id=\"__codelineno-2-150\" name=\"__codelineno-2-150\" href=\"#__codelineno-2-150\"></a><span class=\"w\">    </span><span class=\"n\">mainBTB</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-151\"><a id=\"__codelineno-2-151\" name=\"__codelineno-2-151\" href=\"#__codelineno-2-151\"></a>\n</span><span id=\"__span-2-152\"><a id=\"__codelineno-2-152\" name=\"__codelineno-2-152\" href=\"#__codelineno-2-152\"></a><span class=\"w\">  </span><span class=\"nl\">end</span><span class=\"p\">:</span>\n</span><span id=\"__span-2-153\"><a id=\"__codelineno-2-153\" name=\"__codelineno-2-153\" href=\"#__codelineno-2-153\"></a><span class=\"w\">    </span><span class=\"c1\">// BTB miss</span>\n</span><span id=\"__span-2-154\"><a id=\"__codelineno-2-154\" name=\"__codelineno-2-154\" href=\"#__codelineno-2-154\"></a>\n</span><span id=\"__span-2-155\"><a id=\"__codelineno-2-155\" name=\"__codelineno-2-155\" href=\"#__codelineno-2-155\"></a><span class=\"w\">    </span><span class=\"c1\">// compute icache penalty</span>\n</span><span id=\"__span-2-156\"><a id=\"__codelineno-2-156\" name=\"__codelineno-2-156\" href=\"#__codelineno-2-156\"></a><span class=\"w\">    </span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-157\"><a id=\"__codelineno-2-157\" name=\"__codelineno-2-157\" href=\"#__codelineno-2-157\"></a><span class=\"w\">    </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-158\"><a id=\"__codelineno-2-158\" name=\"__codelineno-2-158\" href=\"#__codelineno-2-158\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iCache</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-159\"><a id=\"__codelineno-2-159\" name=\"__codelineno-2-159\" href=\"#__codelineno-2-159\"></a><span class=\"w\">      </span><span class=\"c1\">// extra 4 cycle penalty</span>\n</span><span id=\"__span-2-160\"><a id=\"__codelineno-2-160\" name=\"__codelineno-2-160\" href=\"#__codelineno-2-160\"></a><span class=\"w\">      </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-161\"><a id=\"__codelineno-2-161\" name=\"__codelineno-2-161\" href=\"#__codelineno-2-161\"></a><span class=\"w\">      </span><span class=\"n\">iCache</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-162\"><a id=\"__codelineno-2-162\" name=\"__codelineno-2-162\" href=\"#__codelineno-2-162\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-163\"><a id=\"__codelineno-2-163\" name=\"__codelineno-2-163\" href=\"#__codelineno-2-163\"></a>\n</span><span id=\"__span-2-164\"><a id=\"__codelineno-2-164\" name=\"__codelineno-2-164\" href=\"#__codelineno-2-164\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-165\"><a id=\"__codelineno-2-165\" name=\"__codelineno-2-165\" href=\"#__codelineno-2-165\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-166\"><a id=\"__codelineno-2-166\" name=\"__codelineno-2-166\" href=\"#__codelineno-2-166\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-2-167\"><a id=\"__codelineno-2-167\" name=\"__codelineno-2-167\" href=\"#__codelineno-2-167\"></a>\n</span><span id=\"__span-2-168\"><a id=\"__codelineno-2-168\" name=\"__codelineno-2-168\" href=\"#__codelineno-2-168\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-169\"><a id=\"__codelineno-2-169\" name=\"__codelineno-2-169\" href=\"#__codelineno-2-169\"></a><span class=\"w\">  </span><span class=\"kt\">FILE</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fopen</span><span class=\"p\">(</span><span class=\"s\">&quot;btb_size.csv&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;w&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-170\"><a id=\"__codelineno-2-170\" name=\"__codelineno-2-170\" href=\"#__codelineno-2-170\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">min_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-171\"><a id=\"__codelineno-2-171\" name=\"__codelineno-2-171\" href=\"#__codelineno-2-171\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">max_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16384</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-172\"><a id=\"__codelineno-2-172\" name=\"__codelineno-2-172\" href=\"#__codelineno-2-172\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">max_product</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1048576</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-173\"><a id=\"__codelineno-2-173\" name=\"__codelineno-2-173\" href=\"#__codelineno-2-173\"></a><span class=\"w\">  </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"kt\">int</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">mults</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"p\">,</span>\n</span><span id=\"__span-2-174\"><a id=\"__codelineno-2-174\" name=\"__codelineno-2-174\" href=\"#__codelineno-2-174\"></a><span class=\"w\">                            </span><span class=\"mi\">21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">27</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">35</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"p\">};</span>\n</span><span id=\"__span-2-175\"><a id=\"__codelineno-2-175\" name=\"__codelineno-2-175\" href=\"#__codelineno-2-175\"></a>\n</span><span id=\"__span-2-176\"><a id=\"__codelineno-2-176\" name=\"__codelineno-2-176\" href=\"#__codelineno-2-176\"></a><span class=\"w\">  </span><span class=\"n\">fprintf</span><span class=\"p\">(</span><span class=\"n\">fp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;pattern,size,stride,min,avg,max</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-177\"><a id=\"__codelineno-2-177\" name=\"__codelineno-2-177\" href=\"#__codelineno-2-177\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"w\"> </span><span class=\"o\">*=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-178\"><a id=\"__codelineno-2-178\" name=\"__codelineno-2-178\" href=\"#__codelineno-2-178\"></a><span class=\"w\">    </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">set</span><span class=\"o\">&lt;</span><span class=\"kt\">int</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">sizes</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-179\"><a id=\"__codelineno-2-179\" name=\"__codelineno-2-179\" href=\"#__codelineno-2-179\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">size_base</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">min_size</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">size_base</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">max_product</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-180\"><a id=\"__codelineno-2-180\" name=\"__codelineno-2-180\" href=\"#__codelineno-2-180\"></a><span class=\"w\">         </span><span class=\"n\">size_base</span><span class=\"w\"> </span><span class=\"o\">*=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-181\"><a id=\"__codelineno-2-181\" name=\"__codelineno-2-181\" href=\"#__codelineno-2-181\"></a><span class=\"w\">      </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">mult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mults</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-182\"><a id=\"__codelineno-2-182\" name=\"__codelineno-2-182\" href=\"#__codelineno-2-182\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size_base</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mult</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-183\"><a id=\"__codelineno-2-183\" name=\"__codelineno-2-183\" href=\"#__codelineno-2-183\"></a><span class=\"w\">             </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">size_base</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mult</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">max_product</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n</span><span id=\"__span-2-184\"><a id=\"__codelineno-2-184\" name=\"__codelineno-2-184\" href=\"#__codelineno-2-184\"></a><span class=\"w\">             </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">max_size</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-185\"><a id=\"__codelineno-2-185\" name=\"__codelineno-2-185\" href=\"#__codelineno-2-185\"></a><span class=\"w\">             </span><span class=\"n\">size</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-186\"><a id=\"__codelineno-2-186\" name=\"__codelineno-2-186\" href=\"#__codelineno-2-186\"></a><span class=\"w\">          </span><span class=\"n\">sizes</span><span class=\"p\">.</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-187\"><a id=\"__codelineno-2-187\" name=\"__codelineno-2-187\" href=\"#__codelineno-2-187\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-188\"><a id=\"__codelineno-2-188\" name=\"__codelineno-2-188\" href=\"#__codelineno-2-188\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-189\"><a id=\"__codelineno-2-189\" name=\"__codelineno-2-189\" href=\"#__codelineno-2-189\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-190\"><a id=\"__codelineno-2-190\" name=\"__codelineno-2-190\" href=\"#__codelineno-2-190\"></a>\n</span><span id=\"__span-2-191\"><a id=\"__codelineno-2-191\" name=\"__codelineno-2-191\" href=\"#__codelineno-2-191\"></a><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sizes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-192\"><a id=\"__codelineno-2-192\" name=\"__codelineno-2-192\" href=\"#__codelineno-2-192\"></a><span class=\"w\">      </span><span class=\"n\">Model</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-193\"><a id=\"__codelineno-2-193\" name=\"__codelineno-2-193\" href=\"#__codelineno-2-193\"></a><span class=\"w\">      </span><span class=\"n\">memset</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">));</span>\n</span><span id=\"__span-2-194\"><a id=\"__codelineno-2-194\" name=\"__codelineno-2-194\" href=\"#__codelineno-2-194\"></a><span class=\"w\">      </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">cycles</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-195\"><a id=\"__codelineno-2-195\" name=\"__codelineno-2-195\" href=\"#__codelineno-2-195\"></a><span class=\"w\">      </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">branch_count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-196\"><a id=\"__codelineno-2-196\" name=\"__codelineno-2-196\" href=\"#__codelineno-2-196\"></a><span class=\"w\">      </span><span class=\"c1\">// warmup</span>\n</span><span id=\"__span-2-197\"><a id=\"__codelineno-2-197\" name=\"__codelineno-2-197\" href=\"#__codelineno-2-197\"></a><span class=\"w\">      </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">branch_count</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-198\"><a id=\"__codelineno-2-198\" name=\"__codelineno-2-198\" href=\"#__codelineno-2-198\"></a><span class=\"w\">        </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-199\"><a id=\"__codelineno-2-199\" name=\"__codelineno-2-199\" href=\"#__codelineno-2-199\"></a><span class=\"w\">        </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-200\"><a id=\"__codelineno-2-200\" name=\"__codelineno-2-200\" href=\"#__codelineno-2-200\"></a><span class=\"w\">        </span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"n\">pc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-201\"><a id=\"__codelineno-2-201\" name=\"__codelineno-2-201\" href=\"#__codelineno-2-201\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-202\"><a id=\"__codelineno-2-202\" name=\"__codelineno-2-202\" href=\"#__codelineno-2-202\"></a>\n</span><span id=\"__span-2-203\"><a id=\"__codelineno-2-203\" name=\"__codelineno-2-203\" href=\"#__codelineno-2-203\"></a><span class=\"w\">      </span><span class=\"c1\">// test</span>\n</span><span id=\"__span-2-204\"><a id=\"__codelineno-2-204\" name=\"__codelineno-2-204\" href=\"#__codelineno-2-204\"></a><span class=\"w\">      </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">branch_count</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-205\"><a id=\"__codelineno-2-205\" name=\"__codelineno-2-205\" href=\"#__codelineno-2-205\"></a><span class=\"w\">        </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-206\"><a id=\"__codelineno-2-206\" name=\"__codelineno-2-206\" href=\"#__codelineno-2-206\"></a><span class=\"w\">        </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-207\"><a id=\"__codelineno-2-207\" name=\"__codelineno-2-207\" href=\"#__codelineno-2-207\"></a><span class=\"w\">        </span><span class=\"n\">cycles</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"n\">pc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-208\"><a id=\"__codelineno-2-208\" name=\"__codelineno-2-208\" href=\"#__codelineno-2-208\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-209\"><a id=\"__codelineno-2-209\" name=\"__codelineno-2-209\" href=\"#__codelineno-2-209\"></a><span class=\"w\">      </span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">cpi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"p\">)</span><span class=\"n\">cycles</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">branch_count</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-210\"><a id=\"__codelineno-2-210\" name=\"__codelineno-2-210\" href=\"#__codelineno-2-210\"></a><span class=\"w\">      </span><span class=\"n\">fprintf</span><span class=\"p\">(</span><span class=\"n\">fp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;0,%d,%d,%.2f,%.2f,%.2f</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">stride</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cpi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cpi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cpi</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-211\"><a id=\"__codelineno-2-211\" name=\"__codelineno-2-211\" href=\"#__codelineno-2-211\"></a><span class=\"w\">      </span><span class=\"n\">fflush</span><span class=\"p\">(</span><span class=\"n\">fp</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-212\"><a id=\"__codelineno-2-212\" name=\"__codelineno-2-212\" href=\"#__codelineno-2-212\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-213\"><a id=\"__codelineno-2-213\" name=\"__codelineno-2-213\" href=\"#__codelineno-2-213\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-214\"><a id=\"__codelineno-2-214\" name=\"__codelineno-2-214\" href=\"#__codelineno-2-214\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-215\"><a id=\"__codelineno-2-215\" name=\"__codelineno-2-215\" href=\"#__codelineno-2-215\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8fd9\u4e2a\u6a21\u578b\u53ea\u8bc4\u4f30\u4e86 BTB \u548c L1 ICache \u7684\u6027\u80fd\u5f71\u54cd\u3002\u4e0b\u9762\u662f\u6a21\u62df\u548c\u5b9e\u9645\u7684\u5bf9\u6bd4\u56fe\uff0c\u5de6\u8fb9\u662f\u6a21\u62df\uff0c\u53f3\u8fb9\u662f\u5b9e\u9645\uff1a</p>\n<p>stride=4B\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-4b-model.png\" /></p>\n<p>stride=8B\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-8b-model.png\" /></p>\n<p>stride=16B\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-16b-model.png\" /></p>\n<p>stride=32B\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-32b-model.png\" /></p>\n<p>stride=64B\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-64b-model.png\" /></p>\n<p>stride=128B\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm-neoverse-n1-btb-128b-model.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u6a21\u578b\u548c\u5b9e\u9645\u7684\u8868\u73b0\u662f\u975e\u5e38\u4e00\u81f4\u7684\u3002</p>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u603b\u7ed3\u4e00\u4e0b Neoverse N1 \u7684 BTB\uff1a</p>\n<ul>\n<li>16-entry Nano BTB, fully associative, 1 cycle latency</li>\n<li>64-entry Micro BTB, fully associative, 2 cycle latency, behave as victim BTB of Nano BTB</li>\n<li>3072-entry(6144 branches) Main BTB, 3-way(6-branch-way) set associative, 2-3 cycle latency, each entry at most 2 branches, index PC[14:5]</li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/arm-neoverse-n1-btb.png", "date_modified": "2025-06-05T00:00:00+00:00", "date_published": "2025-06-05T00:00:00+00:00", "authors": [], "tags": ["arm", "btb", "cpu", "hardware", "neoverse"]}, {"id": "https://jia.je/hardware/2025/05/21/apple-m4/", "url": "https://jia.je/hardware/2025/05/21/apple-m4/", "title": "Apple M4 \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"apple-m4-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Apple M4 \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#apple-m4-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u62ff\u5230\u4e86 Apple M4 \u7684\u73af\u5883\uff0c\u501f\u6b64\u673a\u4f1a\u6d4b\u8bd5\u4e00\u4e0b Apple M4 \u7684\u5fae\u67b6\u6784\uff0c\u548c\u4e4b\u524d<a href=\"../../../../2024/12/26/apple-m1/\">\u5206\u6790\u7684 Apple M1 \u7684\u5fae\u67b6\u6784</a>\u505a\u6bd4\u8f83\u3002\u7531\u4e8e Asahi Linux \u5c1a\u4e0d\u652f\u6301 Apple M4\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u6d4b\u8bd5\u90fd\u5728 macOS \u4e0a\u8fdb\u884c\u3002</p>\n<!-- more -->\n\n<p><img alt=\"\" src=\"../../../../apple-m4.png\" /></p>\n<details class=\"note\">\n<summary>\u56fe\u7247\u6765\u6e90</summary>\n<p>\u4f7f\u7528 <a href=\"https://github.com/Tongyi-MAI/Z-Image\">Z-Image</a> \u751f\u6210\uff0c\u63d0\u793a\u8bcd\uff1a <code>Create a cover iamge for Apple M4 \u5fae\u67b6\u6784\u8bc4\u6d4b, with a proper Apple M4 MacBookAir in the middle with M4 in the background, your text must be accurate</code></p>\n</details>\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>Apple M4 \u7684\u5b98\u65b9\u4fe1\u606f\u4e4f\u5584\u53ef\u9648\uff0c\u5173\u4e8e\u5fae\u67b6\u6784\u7684\u4fe1\u606f\u51e0\u4e4e\u4e3a\u96f6\uff0c\u4f46\u80fd\u4ece\u64cd\u4f5c\u7cfb\u7edf\u6c47\u62a5\u7684\u786c\u4ef6\u4fe1\u606f\u4e2d\u627e\u5230\u4e00\u4e9b\u5185\u5bb9\u3002</p>\n<p>UPDATE: \u540e\u6765\u82f9\u679c\u53d1\u5e03\u4e86 <a href=\"https://developer.apple.com/download/apple-silicon-cpu-optimization-guide/\">Apple Silicon CPU Optimization Guide</a>\uff0c\u7b97\u662f\u4e3a\u6570\u4e0d\u591a\u7684\u5b98\u65b9\u4fe1\u606f\u4e86\u3002</p>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u9488\u5bf9 Apple M4 \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://www.bilibili.com/video/BV1NJ4m1w7zk/\">\u82f9\u679c M4 \u6027\u80fd\u5206\u6790\uff1a\u5c3d\u529b\u4e86\uff0c\u4f46\u82af\u7247\u5de5\u827a\u5feb\u5230\u5934\u4e86\uff01</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u53d6\u6307\u5e26\u5bbd\">\u53d6\u6307\u5e26\u5bbd<a class=\"headerlink\" href=\"#\u53d6\u6307\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"p-core\">P-Core<a class=\"headerlink\" href=\"#p-core\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u5b9e\u9645\u7684 Fetch \u5bbd\u5ea6\uff0c\u53c2\u8003 <a href=\"https://zhuanlan.zhihu.com/p/720136752\">\u5982\u4f55\u6d4b\u91cf\u771f\u6b63\u7684\u53d6\u6307\u5e26\u5bbd\uff08I-fetch width\uff09 - JamesAslan</a> \u6784\u9020\u4e86\u6d4b\u8bd5\u3002</p>\n<p>\u5176\u539f\u7406\u662f\u5f53 Fetch \u8981\u8de8\u9875\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u4e24\u4e2a\u76f8\u90bb\u9875\u53ef\u80fd\u6620\u5c04\u5230\u4e0d\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u5982\u679c\u8981\u652f\u6301\u5355\u5468\u671f\u8de8\u9875\u53d6\u6307\uff0c\u9700\u8981\u67e5\u8be2\u4e24\u6b21 ITLB\uff0c\u6216\u8005 ITLB \u9700\u8981\u628a\u76f8\u90bb\u4e24\u4e2a\u9875\u7684\u6620\u5c04\u5b58\u5728\u4e00\u8d77\u3002\u8fd9\u4e2a\u573a\u666f\u4e00\u822c\u6bd4\u8f83\u5c11\uff0c\u5904\u7406\u5668\u5f88\u5c11\u4f1a\u9488\u5bf9\u8fd9\u79cd\u7279\u6b8a\u60c5\u51b5\u505a\u4f18\u5316\uff0c\u4f46\u4e5f\u4e0d\u662f\u6ca1\u6709\u3002\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u628a\u5faa\u73af\u653e\u5728\u4e24\u4e2a\u9875\u7684\u8fb9\u754c\u4e0a\uff0c\u53d1\u73b0 M4 P-Core \u5fae\u67b6\u6784\u9047\u5230\u8de8\u9875\u7684\u53d6\u6307\u65f6\u786e\u5b9e\u4f1a\u62c6\u6210\u4e24\u4e2a\u5468\u671f\u6765\u8fdb\u884c\u3002</p>\n<p>\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u5728\u7b2c\u4e00\u4e2a\u9875\u7684\u6700\u540e\u56db\u4e2a\u5b57\u8282\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u4e0a\uff0c\u90a3\u4e48\u6bcf\u6b21\u5faa\u73af\u7684\u53d6\u6307\u65f6\u95f4\uff0c\u5c31\u662f\u4e00\u4e2a\u5468\u671f\uff08\u8bfb\u53d6\u7b2c\u4e00\u4e2a\u9875\u5185\u7684\u6307\u4ee4\uff09\u52a0\u4e0a\u7b2c\u4e8c\u4e2a\u9875\u5185\u6307\u4ee4\u9700\u8981 Fetch \u7684\u5468\u671f\u6570\uff0c\u591a\u7684\u8fd9\u4e00\u4e2a\u5468\u671f\u5c31\u8db3\u4ee5\u628a Fetch \u5bbd\u5ea6\u4ece\u540e\u7aef\u9650\u5236\u4e2d\u533a\u5206\u5f00\uff0c\u5b9e\u9a8c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-if-width.png\" /></p>\n<p>\u56fe\u4e2d\u84dd\u7ebf\uff08cross-page\uff09\u8868\u793a\u7684\u5c31\u662f\u4e0a\u9762\u6240\u8ff0\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u4e00\u4e2a\u9875\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u7684\u60c5\u51b5\uff0c\u6a2a\u5750\u6807\u662f\u7b2c\u4e8c\u4e2a\u9875\u5185\u7684\u6307\u4ee4\u6570\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u7684\u6307\u4ee4\u6570\u7b49\u4e8e\u6a2a\u5750\u6807 +1\u3002\u7eb5\u5750\u6807\u662f\u8fd0\u884c\u5f88\u591a\u6b21\u5faa\u73af\u7684\u603b cycle \u6570\u9664\u4ee5\u5faa\u73af\u6b21\u6570\uff0c\u4e5f\u5c31\u662f\u5e73\u5747\u6bcf\u6b21\u5faa\u73af\u8017\u8d39\u7684\u5468\u671f\u6570\u3002\u53ef\u4ee5\u770b\u5230\u6bcf 16 \u6761\u6307\u4ee4\u4f1a\u591a\u4e00\u4e2a\u5468\u671f\uff0c\u56e0\u6b64 M4 P-Core \u7684\u524d\u7aef\u53d6\u6307\u5bbd\u5ea6\u786e\u5b9e\u662f 16 \u6761\u6307\u4ee4\uff0c\u548c Apple M1 \u7684 P-Core \u662f\u76f8\u540c\u7684\u3002</p>\n<p>\u4e3a\u4e86\u786e\u8ba4\u8fd9\u4e2a\u74f6\u9888\u662f\u7531\u53d6\u6307\u9020\u6210\u7684\uff0c\u53c8\u6784\u9020\u4e86\u4e00\u7ec4\u5b9e\u9a8c\uff0c\u628a\u5faa\u73af\u7684\u6240\u6709\u6307\u4ee4\u90fd\u653e\u5230\u4e00\u4e2a\u9875\u4e2d\uff0c\u8fd9\u4e2a\u65f6\u5019 Fetch \u4e0d\u518d\u6210\u4e3a\u74f6\u9888\uff08\u56fe\u4e2d aligned\uff09\uff0c\u4e24\u4e2a\u66f2\u7ebf\u7684\u5bf9\u6bd4\u53ef\u4ee5\u660e\u786e\u5730\u5f97\u51fa\u4e0a\u8ff0\u7ed3\u8bba\u3002</p>\n<p>\u968f\u7740\u6307\u4ee4\u6570\u8fdb\u4e00\u6b65\u589e\u52a0\uff0c\u6700\u7ec8\u74f6\u9888\u5728\u6bcf\u5468\u671f\u6267\u884c\u7684 NOP \u6307\u4ee4\u6570\uff0c\u56e0\u6b64\u4e24\u6761\u7ebf\u91cd\u5408\u3002</p>\n<h4 id=\"e-core\">E-Core<a class=\"headerlink\" href=\"#e-core\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 M4 E-Core\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-if-width.png\" /></p>\n<p>\u7531\u4e8e\u4e24\u4e2a\u66f2\u7ebf\u6c47\u5408\u7684\u70b9\u592a\u524d\uff08NOP \u6307\u4ee4\u6267\u884c\u5f97\u4e0d\u591f\u5feb\uff09\uff0c\u65e0\u6cd5\u786e\u5b9a M4 E-Core \u7684\u53d6\u6307\u5bbd\u5ea6\uff0c\u4f46\u53ef\u4ee5\u786e\u8ba4\u7684\u662f\u5b83\u6bcf\u5468\u671f\u53d6\u503c\u4e0d\u5c11\u4e8e 10 \u6761\u6307\u4ee4\uff0c\u6bd4 Apple M1 \u7684 E-Core \u8981\u66f4\u5feb\u3002\u5982\u679c\u8bfb\u8005\u60f3\u5230\u4ec0\u4e48\u529e\u6cd5\u6765\u786e\u8ba4 M4 E-Core \u7684\u53d6\u6307\u5bbd\u5ea6\uff0c\u6b22\u8fce\u5728\u8bc4\u8bba\u533a\u7ed9\u51fa\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0cP-Core \u5177\u6709 192KB L1 ICache\uff0cE-Core \u5177\u6709 128KB L1 ICache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>hw.perflevel0.l1icachesize: 196608\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>hw.perflevel1.l1icachesize: 131072\n</span></code></pre></div>\n<p>\u6839\u636e Apple Silicon CPU Optimization Guide\uff0c\u4ece M1 Family \u5230 M4 Family\uff0cA14 Bionic \u5230 A18 Family\uff0cP-Core \u7684 L1 ICache \u7684\u914d\u7f6e\u90fd\u662f 192KiB, 6-way, 64B lines\uff1b\u5bf9\u5e94\u5904\u7406\u5668\u7684 E-Core \u7684 L1 ICache \u90fd\u662f 192KiB, 64B lines\uff0c\u5176\u4e2d M1 Family \u548c A14 Bionic \u662f 8-way\uff0c\u5176\u4f59\u5904\u7406\u5668\uff08M2 Family \u548c A15 Bionic \u5f00\u59cb\uff09\u662f 4-way\u3002</p>\n<p>\u5ef6\u7eed\u4e86\u4ece Apple M1 \u4ee5\u6765\u7684\u5927\u5c0f\u3002</p>\n<h4 id=\"p-core_1\">P-Core<a class=\"headerlink\" href=\"#p-core_1\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b M4 P-Core \u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-fetch-bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 192 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 10 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2.5 IPC\uff0c\u8fd9\u91cc\u7684 192 KB \u5c31\u5bf9\u5e94\u4e86 M4 P-Core \u7684 L1 ICache \u7684\u5bb9\u91cf\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002\u867d\u7136 Fetch \u53ef\u4ee5\u6bcf\u5468\u671f 16 \u6761\u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u4e00\u6761 64B \u7684\u7f13\u5b58\u884c\uff0c\u7531\u4e8e\u540e\u7aef\u7684\u9650\u5236\uff0c\u53ea\u80fd\u89c2\u5bdf\u5230 10 \u7684 IPC\u3002</p>\n<h4 id=\"e-core_1\">E-Core<a class=\"headerlink\" href=\"#e-core_1\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 M4 E-Core\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-fetch-bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 128 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 5 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2.0 IPC\uff0c\u8fd9\u91cc\u7684 128 KB \u5c31\u5bf9\u5e94\u4e86 M4 E-Core \u7684 L1 ICache \u7684\u5bb9\u91cf\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002</p>\n<h3 id=\"btb\">BTB<a class=\"headerlink\" href=\"#btb\" title=\"Permanent link\">&para;</a></h3>\n<p><a href=\"../../../../2024/12/26/apple-m1/\">Apple M1</a> \u7684 BTB \u8bbe\u8ba1\u76f8\u5bf9\u6bd4\u8f83\u7b80\u5355\uff1a1024 \u9879\u7684\u7ec4\u76f8\u8fde L1 BTB\uff0c\u63a5\u7740\u662f\u4ee5 192KB L1 ICache \u4f5c\u4e3a\u515c\u5e95\u7684 3 \u5468\u671f\u7684\u7b49\u6548 BTB\u3002\u4f46\u662f M4 \u4e0a\u7684 BTB \u6d4b\u8bd5\u56fe\u50cf\u53d8\u5316\u5f88\u5927\uff0c\u4e0b\u9762\u8fdb\u884c\u4ed4\u7ec6\u7684\u5206\u6790\u3002</p>\n<h4 id=\"p-core_2\">P-Core<a class=\"headerlink\" href=\"#p-core_2\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u5927\u91cf\u7684\u65e0\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff08B \u6307\u4ee4\uff09\uff0cBTB \u9700\u8981\u8bb0\u5f55\u8fd9\u4e9b\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\uff0c\u90a3\u4e48\u5982\u679c\u5206\u652f\u6570\u91cf\u8d85\u8fc7\u4e86 BTB \u7684\u5bb9\u91cf\uff0c\u6027\u80fd\u4f1a\u51fa\u73b0\u660e\u663e\u4e0b\u964d\u3002\u5f53\u628a\u5927\u91cf B \u6307\u4ee4\u7d27\u5bc6\u653e\u7f6e\uff0c\u4e5f\u5c31\u662f\u6bcf 4 \u5b57\u8282\u4e00\u6761 B \u6307\u4ee4\u65f6\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-btb-4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u6700\u4f4e\u7684 CPI \u80fd\u8fbe\u5230\u63a5\u8fd1 0.5\uff08\u5b9e\u9645\u503c\u5728 0.55\uff09\uff0c\u8bf4\u660e Apple M4 \u6709\u4e86\u4e00\u5b9a\u7684\u6bcf\u5468\u671f\u6267\u884c 2 taken branches \u7684\u80fd\u529b\uff0c\u540e\u9762\u4f1a\u7740\u91cd\u8ba8\u8bba\u8fd9\u4e00\u70b9\u3002\u5728\u7ecf\u8fc7 CPI \u6700\u4f4e\u70b9\u4e4b\u540e\uff0c\u6027\u80fd\u51fa\u73b0\u4e86\u5148\u4e0b\u964d\u540e\u4e0a\u5347\u518d\u4e0b\u964d\u7684\u60c5\u51b5\uff0c\u6700\u7ec8\u5728 2048 \u4e2a\u5206\u652f\u5f00\u59cb\u7a33\u5b9a\u5728 2 \u5de6\u53f3\uff08\u5b9e\u9645\u503c\u5728 2.10\uff09\u7684 CPI\u3002</p>\n<p>\u8fd9\u4e2a 2 \u5de6\u53f3\u7684 CPI \u4e00\u76f4\u7a33\u5b9a\u7ef4\u6301\uff0c\u4e00\u76f4\u5ef6\u7eed\u5230 49152 \u4e2a\u5206\u652f\u3002\u8d85\u51fa BTB \u5bb9\u91cf\u4ee5\u540e\uff0c\u5206\u652f\u9884\u6d4b\u65f6\uff0c\u65e0\u6cd5\u4ece BTB \u4e2d\u5f97\u5230\u54ea\u4e9b\u6307\u4ee4\u662f\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u53ea\u80fd\u7b49\u5230\u53d6\u6307\u751a\u81f3\u8bd1\u7801\u540e\u624d\u80fd\u540e\u77e5\u540e\u89c9\u5730\u53d1\u73b0\u8fd9\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u8fd9\u6837\u5c31\u51fa\u73b0\u4e86\u6027\u80fd\u635f\u5931\uff0c\u51fa\u73b0\u4e86 2 CPI \u7684\u60c5\u51b5\u300249152 \u8fd9\u4e2a\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u662f\u6307\u4ee4 footprint \u8d85\u51fa L1 ICache \u7684\u60c5\u51b5\uff1aL1 ICache \u662f 192KB\uff0c\u6309\u7167\u6bcf 4 \u5b57\u8282\u4e00\u4e2a B \u6307\u4ee4\u8ba1\u7b97\uff0c\u6700\u591a\u53ef\u4ee5\u5b58\u653e 49152 \u6761 B \u6307\u4ee4\u3002</p>\n<p>\u8fd9\u4e2a 2 CPI \u7684\u5e73\u53f0\u5728 Apple M1 \u4e2d\u662f 3 CPI\uff0c\u8fd9\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u4f18\u5316\uff0c\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7 L1 ICache \u80fd\u4ee5\u6bcf 2 \u5468\u671f\u4e00\u6761\u65e0\u6761\u4ef6\u5206\u652f\u7684\u6027\u80fd\u515c\u5e95\u3002</p>\n<p>\u63a5\u4e0b\u6765\u964d\u4f4e\u5206\u652f\u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u5728 B \u6307\u4ee4\u4e4b\u95f4\u63d2\u5165 NOP \u6307\u4ee4\uff0c\u4f7f\u5f97\u6bcf 8 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-btb-8b.png\" /></p>\n<p>\u56fe\u50cf\u57fa\u672c\u5c31\u662f 4 \u5b57\u8282\u95f4\u8ddd\u60c5\u51b5\u4e0b\uff0c\u6574\u4f53\u5de6\u79fb\u7684\u7ed3\u679c\uff0c\u8bf4\u660e\u5404\u7ea7 BTB \u7ed3\u6784\u5927\u6982\u662f\u7ec4\u76f8\u8fde\uff0c\u5f53\u95f4\u8ddd\u4e3a 8 \u5b57\u8282\uff0cPC[2] \u6052\u4e3a 0 \u7684\u65f6\u5019\uff0c\u53ea\u6709\u4e00\u534a\u7684\u7ec4\u53ef\u4ee5\u88ab\u7528\u5230\u3002</p>\n<p>\u7ee7\u7eed\u964d\u4f4e\u5206\u652f\u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u5728 B \u6307\u4ee4\u4e4b\u95f4\u63d2\u5165 NOP \u6307\u4ee4\uff0c\u4f7f\u5f97\u6bcf 16 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-btb-16b.png\" /></p>\n<p>\u6bcf 32 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-btb-32b.png\" /></p>\n<p>\u4ece\u95f4\u8ddd\u4e3a 4 \u5b57\u8282\u5230\u95f4\u8ddd\u4e3a 32 \u5b57\u8282\uff0c\u6574\u4e2a\u7684\u56fe\u50cf\u90fd\u662f\u7c7b\u4f3c\u7684\uff0c\u53ea\u662f\u4e0d\u65ad\u5728\u5de6\u79fb\u3002\u4f46\u662f\u5f53\u6bcf 64 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\u7684\u65f6\u5019\uff0c\u60c5\u51b5\u5c31\u4e0d\u540c\u4e86\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-btb-64b.png\" /></p>\n<p>\u6574\u4f53\u7684 CPI \u6709\u6bd4\u8f83\u660e\u663e\u7684\u4e0b\u964d\uff0c\u6700\u4f4e\u7684 CPI \u4e5f\u5728 2 \u4ee5\u4e0a\uff0c\u8fd9\u548c Apple M1 \u4e0a\u4f9d\u7136\u662f\u5728 4 \u5b57\u8282\u95f4\u8ddd\u7684\u56fe\u50cf\u7684\u57fa\u7840\u4e0a\u5de6\u79fb\u6709\u663e\u8457\u7684\u4e0d\u540c\u3002</p>\n<p>\u524d\u9762\u63d0\u5230\uff0cApple M4 P-Core \u51fa\u73b0\u4e86\u6bcf\u5468\u671f 2 taken branches\uff0c\u4f46\u662f\u5f53\u5206\u652f\u4e0d\u5728\u540c\u4e00\u4e2a 64B \u5185\u7684\u65f6\u5019\uff0c\u6027\u80fd\u4f1a\u6709\u660e\u663e\u4e0b\u964d\uff1b\u53e6\u4e00\u65b9\u9762\uff0c\u4ee5 ARM Neoverse V2 \u4e3a\u4f8b\uff0c\u5b83\u5b9e\u73b0\u7684\u6bcf\u5468\u671f 2 taken branches\uff0c\u5373\u4f7f\u5206\u652f\u4e0d\u5728\u540c\u4e00\u4e2a 64B \u5185\uff0c\u4e5f\u662f\u53ef\u4ee5\u505a\u5230\u7684\uff0c\u4e0b\u9762\u662f\u5728 64B \u95f4\u8ddd\u4e0b ARM Neoverse V2 \u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-neoverse-v2-2-taken.png\" /></p>\n<p>\u6839\u636e\u8fd9\u4e9b\u73b0\u8c61\uff0c\u627e\u5230\u4e86 Apple \u7684\u4e00\u7bc7\u4e13\u5229 <a href=\"https://patents.google.com/patent/US20240028339A1/en\">Using a Next Fetch Predictor Circuit with Short Branches and Return Fetch Groups</a>\uff0c\u5b83\u63d0\u5230\u4e86\u4e00\u79cd\u7b26\u5408\u4e0a\u8ff0\u73b0\u8c61\u7684\u5b9e\u73b0 2 taken branches \u7684\u65b9\u6cd5\uff1a\u5982\u679c\u5728\u4e00\u4e2a fetch group\uff08\u5728\u8fd9\u91cc\u662f 64B\uff09\u5185\uff0c\u6709\u4e00\u6761\u5206\u652f\uff0c\u5b83\u7684\u76ee\u7684\u5730\u5740\u8fd8\u5728\u8fd9\u4e2a fetch group \u5185\uff0c\u7531\u4e8e fetch group \u7684\u6307\u4ee4\u90fd\u5df2\u7ecf\u53d6\u51fa\u6765\u4e86\uff0c\u6240\u4ee5\u540c\u4e00\u4e2a\u5468\u671f\u5185\uff0c\u53ef\u4ee5\u4ece\u8fd9\u6761\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u5f00\u59cb\uff0c\u7ee7\u7eed\u83b7\u53d6\u6307\u4ee4\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\"># the beginning of a fetch group</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"nf\">nop</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"c1\"># the branch</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"nf\">b</span><span class=\"w\"> </span><span class=\"no\">target</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"c1\"># some instructions are skipped between branch and its target</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"nf\">svc</span><span class=\"w\"> </span><span class=\"mi\">#0</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"c1\"># the branch target resides in the same fetch group</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a><span class=\"nl\">target:</span>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"c1\"># some instructions after the branch target</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x1</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a><span class=\"nf\">ret</span>\n</span></code></pre></div>\n<p>\u90a3\u4e48\u5728\u4f20\u7edf\u7684\u8bbe\u8ba1\u91cc\uff0c\u8fd9\u6bb5\u4ee3\u7801\u4f1a\u88ab\u5206\u6210\u4e24\u4e2a\u5468\u671f\u53bb\u53d6\u6307\uff0c\u7b2c\u4e00\u4e2a\u5468\u671f\u53d6 <code>nop</code> \u548c <code>b target</code>\uff0c\u7b2c\u4e8c\u4e2a\u5468\u671f\u53d6 <code>add x3, x2, x1</code> \u548c <code>ret</code>\uff1b\u6309\u7167\u8fd9\u4e2a\u4e13\u5229\u7684\u8bf4\u6cd5\uff0c\u53ef\u4ee5\u5728\u4e00\u4e2a\u5468\u671f\u5185\u53d6\u51fa\u6240\u6709\u6307\u4ee4\uff0c\u7136\u540e\u628a\u4e2d\u95f4\u88ab\u8df3\u8fc7\u7684 <code>svc #0</code> \u6307\u4ee4\u8df3\u8fc7\u53bb\uff0c\u4e0d\u53bb\u6267\u884c\u5b83\u3002\u5f53\u7136\u4e86\uff0c\u5206\u652f\u9884\u6d4b\u5668\u90a3\u8fb9\u4e5f\u9700\u8981\u505a\u4fee\u6539\uff0c\u80fd\u591f\u53bb\u9884\u6d4b\u7b2c\u4e8c\u4e2a\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\uff0c\u7528\u4e8e\u4e0b\u4e00\u4e2a\u5468\u671f\u3002</p>\n<p>\u5982\u679c\u662f\u8fd9\u79cd\u5b9e\u73b0\u65b9\u6cd5\uff0c\u662f\u53ef\u80fd\u5728\u4e00\u4e2a Coupled \u524d\u7aef\u5185\uff0c\u5b9e\u73b0\u8fd9\u79cd\u6709\u9650\u573a\u666f\u7684\u6bcf\u5468\u671f\u6267\u884c 2 taken branches\uff0c\u6838\u5fc3\u662f\u6bcf\u5468\u671f\u4f9d\u7136\u53ea\u8bbf\u95ee\u4e00\u6b21 ICache\u3002</p>\n<h4 id=\"e-core_2\">E-Core<a class=\"headerlink\" href=\"#e-core_2\" title=\"Permanent link\">&para;</a></h4>\n<p>\u53e6\u4e00\u65b9\u9762\uff0cM4 E-Core \u7684 BTB \u8bbe\u8ba1\u548c Apple M1 \u7684 E-Core \u5341\u5206\u63a5\u8fd1\uff0c\u5f53\u5206\u652f\u95f4\u8ddd\u662f 4 \u5b57\u8282\u65f6\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-btb-4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 1024 \u7684\u62d0\u70b9\uff0c1024 \u4e4b\u524d\u662f 1 IPC\uff0c\u4e4b\u540e\u589e\u52a0\u5230 3 IPC\u3002\u6bd4\u8f83\u5947\u602a\u7684\u662f\uff0c\u6ca1\u6709\u770b\u5230\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u3002</p>\n<p>8B \u7684\u95f4\u8ddd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-btb-8b.png\" /></p>\n<p>\u62d0\u70b9\u524d\u79fb\u5230 512\u3002</p>\n<p>16B \u7684\u95f4\u8ddd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-btb-16b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u524d\u79fb\u5230 256\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 8192\uff0c\u800c M4 E-Core \u7684 L1 ICache \u5bb9\u91cf\u662f 128KB\uff0c16B \u95f4\u8ddd\u4e0b\u6b63\u597d\u53ef\u4ee5\u4fdd\u5b58 8192 \u4e2a\u5206\u652f\u3002</p>\n<p>\u53ef\u89c1 M4 E-Core \u7684\u524d\u7aef\u8bbe\u8ba1\u548c M4 P-Core \u6709\u8f83\u5927\u7684\u4e0d\u540c\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6839\u636e Apple Silicon CPU Optimization Guide\uff0c\u4ece M1 Family \u5230 M4 Family\uff0cA14 Bionic \u5230 A18 Family\uff0c\u5176 P-Core \u7684 L1 ITLB \u914d\u7f6e\u90fd\u662f\u4e00\u6837\u7684\uff1a192 entries\uff0c\u8003\u8651\u5230\u6bcf\u4e2a\u9875\u662f 16 KiB\uff0c\u5bf9\u5e94 3 MiB \u7684\u5185\u5b58\uff1bE-Core \u7684\u8bdd\uff0cM1 Family \u548c A14 Bionic \u7684 L1 ITLB \u662f 128 entries\uff0c\u4e4b\u540e\u7684\u5904\u7406\u5668\uff08M2 Family \u548c A15 Bionic \u5f00\u59cb\uff09\u5219 E-Core \u4e5f\u662f 192 entries\u3002</p>\n<p>\u56e0\u6b64\uff0cM4 \u7684 P-Core L1 ITLB \u662f 192 entries\uff0cE-Core L1 ITLB \u4e5f\u662f 192 entries\u3002</p>\n<h4 id=\"p-core_3\">P-Core<a class=\"headerlink\" href=\"#p-core_3\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 B \u6307\u4ee4\uff0c\u4f7f\u5f97 B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff0c\u5728 M4 P-Core \u4e0a\u8fdb\u884c\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-itlb.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u662f\u7531\u4e8e L1 BTB \u7684\u51b2\u7a81\u7f3a\u5931\uff0c\u4e4b\u540e\u5728 192 \u4e2a\u9875\u65f6\u4ece 3 Cycle \u5feb\u901f\u589e\u52a0\u5230 12 Cycle\uff0c\u5219\u5bf9\u5e94\u4e86 192 \u9879\u7684 L1 ITLB \u5bb9\u91cf\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002\u8fd9\u548c M1 P-Core \u662f\u4e00\u6837\u7684\u3002</p>\n<h4 id=\"e-core_3\">E-Core<a class=\"headerlink\" href=\"#e-core_3\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 M4 E-Core \u4e0a\u91cd\u590d\u5b9e\u9a8c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-itlb.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u662f\u7531\u4e8e L1 BTB \u7684\u51b2\u7a81\u7f3a\u5931\uff0c\u4e4b\u540e\u5728 192 \u4e2a\u9875\u65f6\u4ece 3 Cycle \u5feb\u901f\u589e\u52a0\u5230 10 Cycle\uff0c\u5219\u5bf9\u5e94\u4e86 192 \u9879\u7684 L1 ITLB \u5bb9\u91cf\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002\u76f8\u6bd4 M1 E-Core \u7684 128 \u9879\uff0c\u5bb9\u91cf\u53d8\u5927\u4e86\uff0c\u548c M4 P-Core \u770b\u9f50\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6839\u636e Apple Silicon CPU Optimization Guide\uff0cM1 Family \u7684 Sustained uops Per Cycle \u6700\u5927\u503c\uff0cP-Core \u662f 8\uff0cE-Core \u662f 4\uff1bM2 Family \u7684 P-Core \u4e0d\u53d8\uff0cE-Core \u63d0\u5347\u5230\u4e86 5\uff1bM3 Family \u7684 P-Core \u63d0\u5347\u5230\u4e86 9\uff0cE-Core \u548c M2 \u6301\u5e73\uff1bM4 Family \u7684 P-Core \u8fdb\u4e00\u6b65\u63d0\u5347\u5230\u4e86 10\uff0cE-Core \u7ee7\u7eed\u548c M2 \u6301\u5e73\u3002</p>\n<p>\u4ece\u524d\u9762\u7684\u6d4b\u8bd5\u6765\u770b\uff0cM4 P-Core \u6700\u5927\u89c2\u5bdf\u5230 10 IPC\uff0cM4 E-Core \u6700\u5927\u89c2\u5bdf\u5230 5 IPC\uff0c\u90a3\u4e48 Decode \u5bbd\u5ea6\u4e5f\u81f3\u5c11\u662f\u8fd9\u4e48\u591a\uff0c\u6682\u65f6\u4e5f\u4e0d\u80fd\u6392\u9664\u6709\u66f4\u5927\u7684 Decode \u5bbd\u5ea6\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002\u76f8\u6bd4 M1 \u7684 P-Core 8 IPC\uff0cE-Core 4 IPC \u90fd\u6709\u62d3\u5bbd\u3002</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"p-core_4\">P-Core<a class=\"headerlink\" href=\"#p-core_4\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\uff0c\u5728 M4 P-Core \u4e0a\u5f97\u5230\u4e0b\u9762\u7684\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 60 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 M4 P-Core \u7684 Return Stack \u6df1\u5ea6\u4e3a 60\uff0c\u6bd4 M1 P-Core \u7684 50 \u8981\u66f4\u5927\u3002\u8fd9\u91cc\u6d4b\u8bd5\u7684\u4e24\u4e2a Variant\uff0c\u5bf9\u5e94\u7684\u662f Return \u7684\u76ee\u7684\u5730\u5740\u4e0d\u53d8\u8fd8\u662f\u4f1a\u53d8\u5316\u3002</p>\n<h4 id=\"e-core_4\">E-Core<a class=\"headerlink\" href=\"#e-core_4\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 M4 E-Core \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 40 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 M4 E-Core \u7684 Return Stack \u6df1\u5ea6\u4e3a 40\uff0c\u6bd4 M1 E-Core \u7684 32 \u8981\u66f4\u5927\u3002</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u7269\u7406\u5bc4\u5b58\u5668\u5806\">\u7269\u7406\u5bc4\u5b58\u5668\u5806<a class=\"headerlink\" href=\"#\u7269\u7406\u5bc4\u5b58\u5668\u5806\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"p-core_5\">P-Core<a class=\"headerlink\" href=\"#p-core_5\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u7269\u7406\u5bc4\u5b58\u5668\u5806\u7684\u5927\u5c0f\uff0c\u4e00\u822c\u4f1a\u7528\u4e24\u4e2a\u4f9d\u8d56\u94fe\u5f88\u957f\u7684\u64cd\u4f5c\u653e\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\uff0c\u4e2d\u95f4\u586b\u5165\u82e5\u5e72\u4e2a\u65e0\u5173\u7684\u6307\u4ee4\uff0c\u5e76\u4e14\u7528\u8fd9\u4e9b\u6307\u4ee4\u6765\u8017\u8d39\u7269\u7406\u5bc4\u5b58\u5668\u5806\u3002M4 P-Core \u6d4b\u8bd5\u7ed3\u679c\u89c1\u4e0b\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-prf.png\" /></p>\n<ul>\n<li>32b int\uff1a\u6d4b\u8bd5 speculative 32 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 720 \u5de6\u53f3</li>\n<li>64b int\uff1a\u6d4b\u8bd5 speculative 64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 360 \u5de6\u53f3\uff0c\u53ea\u6709 32b \u7684\u4e00\u534a\uff0c\u53ef\u89c1\u5b9e\u9645\u7684\u7269\u7406\u5bc4\u5b58\u5668\u5806\u6709 360 \u5de6\u53f3\u4e2a 64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\uff0c\u4f46\u662f\u53ef\u4ee5\u5206\u6210\u4e24\u534a\u5206\u522b\u5f53\u6210 32 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7528\uff0c\u8fd9\u4e00\u4e2a\u4f18\u5316\u5728 M1 \u662f\u6ca1\u6709\u7684\uff0c\u5373\u7528 32b \u6216\u8005\u7528 64b \u6574\u6570\uff0c\u6d4b\u51fa\u6765\u7684\u6574\u6570\u5bc4\u5b58\u5668\u6570\u91cf\u76f8\u540c</li>\n<li>flags\uff1a\u6d4b\u8bd5 speculative NZCV \u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 175 \u5de6\u53f3</li>\n<li>32b fp\uff1a\u6d4b\u8bd5 speculative 32 \u4f4d\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u6ca1\u6709\u89c2\u5bdf\u5230\u660e\u663e\u7684\u62d0\u70b9</li>\n</ul>\n<p>\u5bc4\u5b58\u5668\u5806\u5927\u5c0f\u548c M1 P-Core \u6bd4\u8f83\u7c7b\u4f3c\uff0c\u4f46\u662f\u591a\u4e86 32 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u4f18\u5316\u3002</p>\n<h4 id=\"e-core_5\">E-Core<a class=\"headerlink\" href=\"#e-core_5\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 M4 E-Core \u4e0a\u590d\u73b0\u76f8\u540c\u7684\u6d4b\u8bd5\uff0c\u53d1\u73b0\u6027\u80fd\u975e\u5e38\u4e0d\u7a33\u5b9a\uff0c\u4e0d\u786e\u5b9a\u662f\u4ec0\u4e48\u539f\u56e0\u3002</p>\n<h3 id=\"load-store-unit--l1-dcache\">Load Store Unit + L1 DCache<a class=\"headerlink\" href=\"#load-store-unit--l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"l1-dcache-\u5bb9\u91cf\">L1 DCache \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dcache-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0cM4 P-Core \u5177\u6709 128KB L1 DCache\uff0cM4 E-Core \u5177\u6709 64KB L1 DCache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>hw.perflevel0.l1dcachesize: 131072\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>hw.perflevel1.l1dcachesize: 65536\n</span></code></pre></div>\n<p>\u6839\u636e Apple Silicon CPU Optimization Guide\uff0c\u4ece M1 Family \u5230 M4 Family\uff0c\u4ece A14 Bionic \u5230 A18 Family\uff0cP-Core \u7684 L1 DCache \u90fd\u662f 128KiB, 8-way, 64B lines \u7684\u914d\u7f6e\uff0cE-Core \u7684 L1 DCache \u90fd\u662f 64KiB, 8-way, 64B lines \u7684\u914d\u7f6e\u3002</p>\n<p>\u548c M1 \u76f8\u540c\u3002</p>\n<h5 id=\"p-core_6\">P-Core<a class=\"headerlink\" href=\"#p-core_6\" title=\"Permanent link\">&para;</a></h5>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u5728\u6bcf\u4e2a\u9875\u7684\u5f00\u5934\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff0cM4 P-Core \u4e0a\u7684\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 128KB \u51fa\u73b0\u4e86\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 128KB \u7684 L1 DCache \u5bb9\u91cf\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002\u5f53 footprint \u6bd4\u8f83\u5c0f\u7684\u65f6\u5019\uff0c\u7531\u4e8e Load Address/Value Predictor \u7684\u4ecb\u5165\uff0c\u6253\u7834\u4e86\u4f9d\u8d56\u94fe\uff0c\u6240\u4ee5\u51fa\u73b0\u4e86 latency \u5c0f\u4e8e\u6b63\u5e38 load to use \u7684 3 cycle latency \u7684\u60c5\u51b5\u3002</p>\n<h5 id=\"e-core_6\">E-Core<a class=\"headerlink\" href=\"#e-core_6\" title=\"Permanent link\">&para;</a></h5>\n<p>M4 E-Core \u4e0a\u7684\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 128KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u4f46\u5b9e\u9645\u4e0a M4 E-Core \u7684 L1 DCache \u53ea\u6709 64KB\u3002\u731c\u6d4b\u8fd9\u662f\u56e0\u4e3a\u5728\u6d4b\u8bd5\u7684\u65f6\u5019\uff0c\u662f\u5728\u6bcf\u4e2a 16KB \u9875\u7684\u5f00\u5934\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u4f46\u5982\u679c L1 DCache \u7684 Index \u5e76\u975e\u90fd\u5728 16KB \u5185\u90e8\uff0c\u5c31\u4f1a\u5bfc\u81f4\u5b9e\u9645\u6d4b\u51fa\u6765\u7684\u4e0d\u662f L1 DCache \u7684\u5927\u5c0f\u3002\u4fee\u6539\u6d4b\u8bd5\uff0c\u4f7f\u5f97\u6bcf 8 \u5b57\u8282\u4e00\u4e2a\u6307\u9488\uff0c\u6b64\u65f6\u6d4b\u51fa\u6765\u7684\u7ed3\u679c\u5c31\u662f\u6b63\u786e\u7684 64KB \u5927\u5c0f\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-l1dc-2.png\" /></p>\n<p>\u6b64\u65f6 64KB \u5bf9\u5e94\u7684\u5c31\u662f 64KB \u7684 L1 DCache \u5bb9\u91cf\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002L1 DCache \u8303\u56f4\u5185\u5ef6\u8fdf\u662f 3 cycle\uff0c\u4e4b\u540e\u63d0\u5347\u5230 14+ cycle\u3002\u7531\u6b64\u53ef\u89c1 M4 E-Core \u6ca1\u6709 Load Address/Value Predictor\uff0c\u4e0d\u80fd\u6253\u65ad\u4f9d\u8d56\u94fe\u3002</p>\n<h4 id=\"l1-dtlb-\u5bb9\u91cf\">L1 DTLB \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dtlb-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6839\u636e Apple Silicon CPU Optimization Guide\uff0c\u5bf9\u4e8e P-Core \u6765\u8bf4\uff0c\u9664\u4e86 M2 Family\u3001A14 Bionic \u548c A15 Bionic \u7684 L1 DTLB \u662f 256 entries \u4ee5\u5916\uff0c\u5176\u4f59\u7684 M1 Family\u3001M3 Family \u5230 M4 Family\uff0cA16 Bionic \u5230 A18 Family \u7684 L1 DTLB \u90fd\u662f 160 entries\u3002\u5bf9\u4e8e E-Core \u6765\u8bf4\uff0c\u9664\u4e86 M1 Family \u548c A14 Bionic \u662f 129 entries\uff0c\u5176\u4f59\u7684\u4ece M2 Family \u5230 M4 Family\uff0cA15 Bionic \u5230 A18 Family \u90fd\u662f 192 entries\u3002</p>\n<p>\u56e0\u6b64\uff0cM4 \u7684 P-Core L1 DTLB \u5bb9\u91cf\u662f 160\uff0cE-Core L1 DTLB \u5bb9\u91cf\u662f 192\u3002</p>\n<h5 id=\"p-core_7\">P-Core<a class=\"headerlink\" href=\"#p-core_7\" title=\"Permanent link\">&para;</a></h5>\n<p>\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21 pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u7684\u4e0d\u540c cache line \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff0c\u5728 M4 P-Core \u4e0a\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-l1dtlb.png\" /></p>\n<p>\u4ece 160 \u4e2a\u9875\u5f00\u59cb\u6027\u80fd\u4e0b\u964d\uff0c\u5230 200 \u4e2a\u9875\u65f6\u6027\u80fd\u7a33\u5b9a\u5728 9 CPI\uff0c\u8ba4\u4e3a M4 P-Core \u7684 L1 DTLB \u6709 160 \u9879\uff0c\u5927\u5c0f\u548c M1 P-Core \u76f8\u540c\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u30029 CPI \u5305\u62ec\u4e86 L1 DTLB miss L2 TLB hit \u5e26\u6765\u7684\u989d\u5916\u5ef6\u8fdf\u3002\u4e2d\u95f4\u6709\u65f6\u6027\u80fd\u7279\u522b\u5feb\uff0c\u662f Load Address/Value Predictor \u7684\u529f\u52b3\u3002</p>\n<h5 id=\"e-core_7\">E-Core<a class=\"headerlink\" href=\"#e-core_7\" title=\"Permanent link\">&para;</a></h5>\n<p>M4 E-Core \u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-l1dtlb.png\" /></p>\n<p>\u4ece 192 \u4e2a\u9875\u5f00\u59cb\u6027\u80fd\u4e0b\u964d\uff0c\u5230 224 \u4e2a\u9875\u65f6\u6027\u80fd\u7a33\u5b9a\u5728 9 CPI\uff0c\u8ba4\u4e3a M4 E-Core \u7684 L1 DTLB \u6709 192 \u9879\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\uff0c\u6bd4 M1 E-Core \u7684 128 \u9879\u66f4\u5927\uff0c\u751a\u81f3\u5927\u8fc7\u4e86 P-Core\u30029 CPI \u5305\u62ec\u4e86 L1 DTLB miss L2 TLB hit \u5e26\u6765\u7684\u989d\u5916\u5ef6\u8fdf\uff0c\u6bd4 M1 E-Core \u5c11\u4e86\u4e00\u4e2a\u5468\u671f\u3002</p>\n<h4 id=\"loadstore-\u5e26\u5bbd\">Load/Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#loadstore-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<h5 id=\"p-core_8\">P-Core<a class=\"headerlink\" href=\"#p-core_8\" title=\"Permanent link\">&para;</a></h5>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b M4 P-Core \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>3x 128b Load + 1x 128b Store</li>\n<li>2x 128b Load + 2x 128b Store</li>\n<li>1x 128b Load + 2x 128b Store</li>\n<li>2x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 48B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 32B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002\u548c M1 P-Core \u76f8\u540c\u3002</p>\n<h5 id=\"e-core_8\">E-Core<a class=\"headerlink\" href=\"#e-core_8\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5b9e\u6d4b M4 E-Core \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>2x 128b Load</li>\n<li>1x 128b Load + 1x 128b Store</li>\n<li>1x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 32B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 16B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002\u548c M1 E-Core \u76f8\u540c\u3002</p>\n<h4 id=\"memory-dependency-predictor\">Memory Dependency Predictor<a class=\"headerlink\" href=\"#memory-dependency-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u9884\u6d4b\u6267\u884c Load\uff0c\u9700\u8981\u4fdd\u8bc1 Load \u548c\u4e4b\u524d\u7684 Store \u8bbf\u95ee\u7684\u5185\u5b58\u6ca1\u6709 Overlap\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u9884\u6d4b\u5668\u6765\u9884\u6d4b Load \u548c Store \u4e4b\u524d\u5728\u5185\u5b58\u4e0a\u7684\u4f9d\u8d56\u3002\u53c2\u8003 <a href=\"https://blog.stuffedcow.net/2014/01/x86-memory-disambiguation/\">Store-to-Load Forwarding and Memory Disambiguation in x86 Processors</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e24\u4e2a\u6307\u4ee4\u6a21\u5f0f\uff0c\u5206\u522b\u5728\u5730\u5740\u548c\u6570\u636e\u4e0a\u6709\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>\u6570\u636e\u4f9d\u8d56\uff0c\u5730\u5740\u65e0\u4f9d\u8d56\uff1a<code>str x3, [x1]</code> \u548c <code>ldr x3, [x2]</code></li>\n<li>\u5730\u5740\u4f9d\u8d56\uff0c\u6570\u636e\u65e0\u4f9d\u8d56\uff1a<code>str x2, [x1]</code> \u548c <code>ldr x1, [x2]</code></li>\n</ul>\n<p>\u521d\u59cb\u5316\u65f6\uff0c<code>x1</code> \u548c <code>x2</code> \u6307\u5411\u540c\u4e00\u4e2a\u5730\u5740\uff0c\u91cd\u590d\u5982\u4e0a\u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u89c2\u5bdf\u5230\u591a\u5c11\u6761 <code>ldr</code> \u6307\u4ee4\u65f6\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\u3002</p>\n<h5 id=\"p-core_9\">P-Core<a class=\"headerlink\" href=\"#p-core_9\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5728 M4 P-Core \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-memory-dependency-predictor.png\" /></p>\n<p>\u6570\u636e\u4f9d\u8d56\u6ca1\u6709\u660e\u663e\u7684\u9608\u503c\uff0c\u4f46\u4ece 72 \u5f00\u59cb\u51fa\u73b0\u4e86\u4e00\u4e2a\u5c0f\u7684\u589e\u957f\uff0c\u4e14\u659c\u7387\u4e0d\u4e3a\u96f6\uff1b\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 39\u3002\u76f8\u6bd4 M1 P-Core \u6709\u6240\u51cf\u5c0f\u3002</p>\n<h5 id=\"e-core_9\">E-Core<a class=\"headerlink\" href=\"#e-core_9\" title=\"Permanent link\">&para;</a></h5>\n<p>M4 E-Core:</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-memory-dependency-predictor.png\" /></p>\n<p>\u6570\u636e\u4f9d\u8d56\u7684\u9608\u503c\u662f 20\uff0c\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 14\u3002\u6bd4 M1 E-Core \u7565\u5927\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<h5 id=\"p-core_10\">P-Core<a class=\"headerlink\" href=\"#p-core_10\" title=\"Permanent link\">&para;</a></h5>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0cM4 P-Core \u4e0a\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>[-1,0]</td>\n<td>[-3,0]</td>\n<td>[-7,0]</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>[-1,1]</td>\n<td>[-3,1]</td>\n<td>[-7,1]</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[-1,3]</td>\n<td>[-3,3]</td>\n<td>[-7,3]</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[-1,7]</td>\n<td>[-3,7]</td>\n<td>[-7,7]</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u8868\u53ef\u4ee5\u770b\u5230\uff0c\u6240\u6709 Store \u548c Load Overlap \u7684\u60c5\u51b5\uff0c\u65e0\u8bba\u5730\u5740\u504f\u79fb\uff0c\u90fd\u80fd\u6210\u529f\u8f6c\u53d1\u3002\u751a\u81f3\u5728 Load \u6216 Store \u8de8\u8d8a 64B \u7f13\u5b58\u884c\u8fb9\u754c\u65f6\uff0c\u4e5f\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u4ee3\u4ef7\u662f\u591a\u4e00\u4e2a\u5468\u671f\u3002</p>\n<p>\u4e00\u4e2a Load \u9700\u8981\u8f6c\u53d1\u4e24\u4e2a\u3001\u56db\u4e2a\u751a\u81f3\u516b\u4e2a Store \u7684\u6570\u636e\u65f6\uff0c\u4e5f\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\u3002\u5373\u4f7f\u6570\u636e\u8de8\u8d8a\u7f13\u5b58\u884c\uff0c\u4e5f\u53ef\u4ee5\u8f6c\u53d1\uff0c\u53ea\u662f\u591a\u8017\u8d39 1-2 \u4e2a\u5468\u671f\u3002\u4f46\u5728\u8de8 64B \u7f13\u5b58\u884c\u7684\u65f6\u5019\uff0c\u4ee3\u4ef7\u53ef\u80fd\u591a\u4e8e\u4e00\u4e2a\u5468\u671f\u3002\u76f8\u6bd4 M1 P-Core\uff0cM4 P-Core \u5728\u8de8\u8d8a\u7f13\u5b58\u884c\u7684\u60c5\u51b5\u4e0b\u4e5f\u53ef\u4ee5\u5f97\u5230\u6bd4\u8f83\u597d\u7684\u6027\u80fd\u3002</p>\n<p>\u6210\u529f\u8f6c\u53d1\u65f6 7 cycle \u5de6\u53f3\u3002</p>\n<p>\u5c0f\u7ed3\uff1aApple M4 P-Core \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u652f\u6301</li>\n<li>1 ld + 2 st: \u652f\u6301</li>\n<li>1 ld + 4 st: \u652f\u6301</li>\n<li>1 ld + 8 st: \u652f\u6301</li>\n<li>\u8de8 64B \u7f13\u5b58\u884c\u8fb9\u754c\u65f6\uff0c\u6027\u80fd\u7565\u5fae\u4e0b\u964d</li>\n</ul>\n<h5 id=\"e-core_10\">E-Core<a class=\"headerlink\" href=\"#e-core_10\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5728 M4 E-Core \u4e0a\uff0c\u5982\u679c Load \u548c Store \u8bbf\u95ee\u8303\u56f4\u51fa\u73b0\u91cd\u53e0\uff0c\u5f53\u9700\u8981\u8f6c\u53d1\u4e00\u4e2a\u5230\u4e24\u4e2a Store \u7684\u6570\u636e\u65f6\uff0c\u9700\u8981 7 Cycle\uff0c\u65e0\u8bba\u662f\u5426\u8de8\u7f13\u5b58\u884c\u3002\u5982\u679c\u9700\u8981\u8f6c\u53d1\u56db\u4e2a Store \u7684\u6570\u636e\uff0c\u5219\u9700\u8981 8 Cycle\uff1b\u8f6c\u53d1\u516b\u4e2a Store \u7684\u6570\u636e\u9700\u8981 11 Cycle\u3002\u76f8\u6bd4 M1 E-Core\uff0c\u591a\u6570\u60c5\u51b5\u4e0b\u83b7\u5f97\u4e86\u6027\u80fd\u63d0\u5347\u3002</p>\n<h4 id=\"load-to-use-latency\">Load to use latency<a class=\"headerlink\" href=\"#load-to-use-latency\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6839\u636e Apple Silicon CPU Optimization Guide\uff0cApple \u5b9e\u73b0\u4e86 fast pointer chasing with a 3-cycle latency\uff0c\u8981\u6c42\u540e\u4e00\u4e2a load \u7684 base register \u548c\u524d\u4e00\u4e2a load \u7684 destination register \u76f8\u540c\u3002</p>\n<h5 id=\"p-core_11\">P-Core<a class=\"headerlink\" href=\"#p-core_11\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5b9e\u6d4b M4 P-Core \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5982\u679c\u8bbf\u5b58\u8de8\u8d8a\u4e86 8B \u8fb9\u754c\uff0c\u5219\u9000\u5316\u5230 4 cycle\u3002</p>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u6ce8\u610f\u7531\u4e8e Load Address/Value Predictor \u7684\u5b58\u5728\uff0c\u6d4b\u8bd5\u7684\u65f6\u5019\u9700\u8981\u6392\u9664\u9884\u6d4b\u5668\u5e26\u6765\u7684\u5f71\u54cd\u3002\u5ef6\u8fdf\u65b9\u9762\uff0c\u548c M1 P-Core \u76f8\u540c\u3002</p>\n<h5 id=\"e-core_11\">E-Core<a class=\"headerlink\" href=\"#e-core_11\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5b9e\u6d4b M4 E-Core \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5982\u679c\u8bbf\u5b58\u8de8\u8d8a\u4e86 8B/16B/32B \u8fb9\u754c\uff0c\u4f9d\u7136\u662f 3 cycle\uff1b\u8de8\u8d8a\u4e86 64B \u8fb9\u754c\u5219\u9000\u5316\u5230 7 cycle\u3002</p>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5ef6\u8fdf\u65b9\u9762\uff0c\u548c M1 E-Core \u76f8\u540c\u3002</p>\n<h4 id=\"virtual-address-utagway-predictor\">Virtual Address UTag/Way-Predictor<a class=\"headerlink\" href=\"#virtual-address-utagway-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>Linear Address UTag/Way-Predictor \u662f AMD \u7684\u53eb\u6cd5\uff0c\u4f46\u4f7f\u7528\u76f8\u540c\u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u5728 Apple M1 \u4e0a\u89c2\u5bdf\u5230\u7c7b\u4f3c\u7684\u73b0\u8c61\uff0c\u731c\u60f3\u5b83\u4e5f\u7528\u4e86\u7c7b\u4f3c\u7684\u57fa\u4e8e\u865a\u62df\u5730\u5740\u7684 UTag/Way Predictor \u65b9\u6848\uff0c\u5e76\u6d4b\u51fa\u6765\u5b83\u7684 UTag \u4e5f\u6709 8 bit\uff0cM4 P-Core \u548c M4 E-Core \u90fd\u662f\u76f8\u540c\u7684\uff1a</p>\n<ul>\n<li>VA[14] xor VA[22] xor VA[30] xor VA[38] xor VA[46]</li>\n<li>VA[15] xor VA[23] xor VA[31] xor VA[39] xor VA[47]</li>\n<li>VA[16] xor VA[24] xor VA[32] xor VA[40]</li>\n<li>VA[17] xor VA[25] xor VA[33] xor VA[41]</li>\n<li>VA[18] xor VA[26] xor VA[34] xor VA[42]</li>\n<li>VA[19] xor VA[27] xor VA[35] xor VA[43]</li>\n<li>VA[20] xor VA[28] xor VA[36] xor VA[44]</li>\n<li>VA[21] xor VA[29] xor VA[37] xor VA[45]</li>\n</ul>\n<p>\u4e00\u5171\u6709 8 bit\uff0c\u7531 VA[47:14] \u6298\u53e0\u800c\u6765\u3002\u548c Apple M1 \u76f8\u540c\u3002</p>\n<h4 id=\"load-addressvalue-predictor\">Load Address/Value Predictor<a class=\"headerlink\" href=\"#load-addressvalue-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>Apple \u4ece M2 \u5f00\u59cb\u5f15\u5165 Load Address Predictor\uff0c\u4ece M3 \u5f00\u59cb\u5f15\u5165 Load Value Predictor\uff0c\u76f8\u5173\u7684\u4fe1\u606f\u5982\u4e0b\uff1a</p>\n<ul>\n<li>Load Address Predictor\uff1a\u652f\u6301 Constant \u548c Striding Address \u4e24\u79cd\u6a21\u5f0f\uff0c\u4e13\u5229\u662f <a href=\"https://patents.google.com/patent/US11829763B2/\">Early load execution via constant address and stride prediction</a></li>\n<li>Load Value Predictor\uff08\u4e5f\u79f0 Load Output Predictor\uff09\uff1a\u53ea\u652f\u6301 Constant Value\uff0c\u4e13\u5229\u662f <a href=\"https://patents.google.com/patent/US12067398B1/en\">Shared learning table for load value prediction and load address prediction</a></li>\n</ul>\n<p>\u8fd9\u4e24\u4e2a Predictor \u4f1a\u5bf9\u5df2\u6709\u7684\u57fa\u4e8e Load \u7684\u5404\u79cd microbenchmark \u5e26\u6765\u6df1\u523b\u7684\u5f71\u54cd\u3002</p>\n<p>\u7f51\u4e0a\u5df2\u6709\u9488\u5bf9\u8fd9\u4e24\u4e2a Predictor \u7684\u9006\u5411\u548c\u653b\u51fb\uff1a<a href=\"https://predictors.fail/\">SLAP: Data Speculation Attacks via Load Address Prediction on Apple Silicon;FLOP Breaking the Apple M3 CPU via False Load Output Predictions</a>\u3002</p>\n<p>\u82f9\u679c\u8fd8\u6709\u4e00\u4e2a\u540e\u7eed\u7684\u4e13\u5229\uff1a<a href=\"https://patents.google.com/patent/US12159142B1/\">Managing table accesses for tagged geometric length (TAGE) load value prediction</a>\uff0c\u6697\u793a\u4e86\u82f9\u679c\u53ef\u80fd\u4f1a\u4f7f\u7528 VTAGE \u7b97\u6cd5\u6765\u5b9e\u73b0 load value prediction\uff0c\u53ea\u662f\u4e0d\u77e5\u9053\u4f1a\u4e0d\u4f1a\u5b9e\u88c5\uff0c\u4f1a\u5728\u54ea\u4ee3\u5904\u7406\u5668\u4e0a\u5b9e\u88c5\uff0c\u662f\u4e0d\u662f\u5df2\u7ecf\u5b9e\u88c5\u5728\u5df2\u7ecf\u53d1\u5e03\u7684\u5904\u7406\u5668\u4e0a\u4e86\u3002</p>\n<h5 id=\"p-core_12\">P-Core<a class=\"headerlink\" href=\"#p-core_12\" title=\"Permanent link\">&para;</a></h5>\n<p>\u6784\u9020\u4f9d\u8d56\u94fe\uff0c\u4f46\u662f\u5b9e\u9645\u6d4b\u8bd5\u53ef\u4ee5\u89c2\u5bdf\u5230\u6253\u7834\u4f9d\u8d56\u94fe\u7684\u60c5\u51b5\uff0c\u6bd4\u4e32\u884c\u6267\u884c\u8981\u66f4\u5feb\u3002\u6d4b\u8bd5\u4e0b\u6765\uff0c\u5927\u6982\u53ef\u4ee5\u8ddf\u8e2a 60 \u6761 Load \u6307\u4ee4\u7684\u5730\u5740\u5e76\u5b9e\u73b0\u9884\u6d4b\u3002</p>\n<h5 id=\"e-core_12\">E-Core<a class=\"headerlink\" href=\"#e-core_12\" title=\"Permanent link\">&para;</a></h5>\n<p>M4 E-Core \u6ca1\u6709\u5b9e\u73b0 Load Address/Value Predictor\u3002</p>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6839\u636e Apple Silicon CPU Optimization Guide\uff0cM4 Family \u7684 P-Core \u5305\u62ec\u5982\u4e0b\u8ba1\u7b97\u5355\u5143\uff1a</p>\n<ol>\n<li>ALU/f, BRc/i</li>\n<li>ALU/f, BRc</li>\n<li>ALU/f</li>\n<li>ALU/f, PRED/f</li>\n<li>ALU, MUL, MISC</li>\n<li>ALU, DIV</li>\n<li>ALU, MUL</li>\n<li>ALU, MUL</li>\n<li>GENERAL, MOVE2GPR, FCMPf, FCSELf, FDIV, MUL, SHA</li>\n<li>GENERAL, MOVE2GPR, FCSELf, MUL</li>\n<li>GENERAL, MUL</li>\n<li>GENERAL, MUL</li>\n</ol>\n<p>\u4ece M3 \u5f00\u59cb\uff0cP-Core \u6574\u6570\u8ba1\u7b97\u5355\u5143\u4ece 6 \u4e2a\u589e\u52a0\u5230 8 \u4e2a\u3002\u6d6e\u70b9\u90e8\u5206\u6ca1\u6709\u53d8\u5316\u3002</p>\n<p>P-Core \u8bbf\u5b58\uff1a</p>\n<ul>\n<li>Burst: 3 load uops, 2 store uops (address part), and 2 store uops (data part)<ul>\n<li>\u5373 3 load, 2 sta, 2 std</li>\n</ul>\n</li>\n<li>Sustained: 4 uops, 2 write into the cache</li>\n</ul>\n<p>\u548c M1 E-Core \u76f8\u540c\u3002</p>\n<p>M4 Family \u7684 E-Core \u5305\u62ec\u5982\u4e0b\u8ba1\u7b97\u5355\u5143\uff1a</p>\n<ol>\n<li>ALU/f, MUL, MAC, MISC, PRED/f</li>\n<li>ALU/F, BRi, DIV</li>\n<li>ALU/f, BRc</li>\n<li>ALU/f</li>\n<li>GENERAL, MOVE2GPR, FCMPf, FCSELf, FDIV, MUL, SHA</li>\n<li>GENERAL, MOVE2GPR, FCMPf, FCSELf, MUL</li>\n<li>GENERAL</li>\n</ol>\n<p>\u4ece M3 \u5f00\u59cb\uff0cE-Core \u6574\u6570\u8ba1\u7b97\u5355\u5143\u4ece 3 \u4e2a\u589e\u52a0\u5230 4 \u4e2a\u3002\u4ece M3 Max/M4 Family \u5f00\u59cb\uff0cE-Core \u6d6e\u70b9\u5355\u5143\u4ece 2 \u4e2a\u589e\u52a0\u5230 3 \u4e2a\u3002\u6ce8\u610f M3/M3 Pro \u7684 E-Core \u4f9d\u7136\u662f 2 \u4e2a\u6d6e\u70b9\u5355\u5143\u3002</p>\n<p>E-Core \u8bbf\u5b58\uff1a</p>\n<ul>\n<li>Burst: 3 load uops, 2 store uops (address part), and 2 store uops (data part)<ul>\n<li>\u5373 3 load, 2 sta, 2 std</li>\n</ul>\n</li>\n<li>Sustained: 4 uops, 2 write into the cache</li>\n</ul>\n<p>\u548c M1 E-Core \u76f8\u540c\u3002</p>\n<h4 id=\"p-core_13\">P-Core<a class=\"headerlink\" href=\"#p-core_13\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 M4 P-Core \u4e0a\u6d4b\u8bd5\u5982\u4e0b\u5404\u7c7b\u6307\u4ee4\u7684\u5ef6\u8fdf\u548c\u6bcf\u5468\u671f\u541e\u5410\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Instruction</th>\n<th>Latency</th>\n<th>Throughput</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>asimd int add</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd aesd/aese</td>\n<td>2/3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd aesimc/aesmc</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fabs</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fadd</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fmax</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmin</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmla</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmul</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fneg</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp cvtf2i (fcvtzs)</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp cvti2f (scvtf)</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fabs</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fadd</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fjcvtzs</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fmax</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fmin</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fmov f2i</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmov i2f</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fmul</td>\n<td>4</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fneg</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frecpx</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int add</td>\n<td>1</td>\n<td>7.5</td>\n</tr>\n<tr>\n<td>int addi</td>\n<td>1</td>\n<td>8</td>\n</tr>\n<tr>\n<td>int bfm</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int crc</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int csel</td>\n<td>1</td>\n<td>4</td>\n</tr>\n<tr>\n<td>int madd (addend)</td>\n<td>1</td>\n<td>2.8</td>\n</tr>\n<tr>\n<td>int madd (others)</td>\n<td>4</td>\n<td>2.8</td>\n</tr>\n<tr>\n<td>int mrs nzcv</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>int mul</td>\n<td>3</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int nop</td>\n<td>-</td>\n<td>10</td>\n</tr>\n<tr>\n<td>int sbfm</td>\n<td>1</td>\n<td>8</td>\n</tr>\n<tr>\n<td>int sdiv</td>\n<td>7</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int smull</td>\n<td>3</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int ubfm</td>\n<td>1</td>\n<td>8</td>\n</tr>\n<tr>\n<td>int udiv</td>\n<td>7</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>not taken branch</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>taken branch</td>\n<td>-</td>\n<td>1-2</td>\n</tr>\n<tr>\n<td>mem asimd load</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>mem asimd store</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem int load</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>mem int store</td>\n<td>-</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u521d\u6b65\u5f97\u5230\u7684\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6807\u91cf\u6d6e\u70b9\u548c ASIMD \u541e\u5410\u6700\u5927\u90fd\u662f 4\uff0c\u610f\u5473\u7740\u6709 4 \u4e2a\u6d6e\u70b9/ASIMD \u6267\u884c\u5355\u5143\uff0c\u4f46\u5e76\u975e\u5b8c\u5168\u5bf9\u79f0\uff0c\u4f8b\u5982 fdiv/frecpe/frecpx/frsqrte/fsqrt/fjcvtzs \u7531\u4e8e\u541e\u5410\u4e0d\u8d85\u8fc7 1\uff0c\u5927\u6982\u7387\u53ea\u80fd\u5728\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\u3002\u4f46\u8fd9\u4e9b\u6307\u4ee4\u662f\u4e0d\u662f\u90fd\u53ea\u80fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\uff0c\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u6d4b\u8bd5\uff1b\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c\uff0c\u4f46\u6d6e\u70b9\u4e58\u6cd5 fmla/fmul \u7684\u5ef6\u8fdf\u4ece 4 \u5468\u671f\u964d\u4f4e\u5230\u4e86 3 \u5468\u671f</li>\n<li>\u6d6e\u70b9\u548c\u6574\u6570\u4e4b\u95f4\u7684 move \u6216 convert \u6307\u4ee4\uff0cfmov i2f/cvti2f \u541e\u5410\u662f 3\uff0cfmov f2i/cvtf2i \u541e\u5410\u662f 2\uff0c\u90a3\u4e48\u8fd9\u4e9b\u6307\u4ee4\u662f\u5728\u54ea\u4e2a\u6267\u884c\u5355\u5143\u91cc\u5b9e\u73b0\u7684\uff0c\u662f\u5426\u9700\u8981\u540c\u65f6\u5360\u7528\u6574\u6570\u6267\u884c\u5355\u5143\u548c\u6d6e\u70b9\u6267\u884c\u5355\u5143\uff0c\u9700\u8981\u8fdb\u4e00\u6b65\u6d4b\u8bd5\uff1b\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c</li>\n<li>\u6574\u6570\u65b9\u9762\uff0c\u6839\u636e\u541e\u5410\uff0c\u63a8\u65ad\u51fa\u5982\u4e0b\u51e0\u7c7b\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u6570\u91cf\uff1a<ol>\n<li>ALU: 8</li>\n<li>CSEL: 4</li>\n<li>Mul/MAdd: 3</li>\n<li>Br/MRS NZCV: 2</li>\n<li>CRC/BFM/Div: 1</li>\n<li>ALU/CSEL/Mul/MAdd \u7684\u6267\u884c\u5355\u5143\u76f8\u6bd4 M1 P-Core \u6709\u6269\u5145</li>\n</ol>\n</li>\n<li>\u8bbf\u5b58\u65b9\u9762\uff0c\u6bcf\u5468\u671f\u6700\u591a 3 Load \u6216\u8005 2 Store\uff1b\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c</li>\n</ol>\n<p>\u9996\u5148\u6765\u770b\u6d6e\u70b9\u548c ASIMD \u5355\u5143\uff0c\u6839\u636e\u4e0a\u9762\u7684\u4fe1\u606f\uff0c\u8ba4\u4e3a\u81f3\u5c11\u6709 4 \u4e2a\u6267\u884c\u5355\u5143\uff0c\u6bcf\u4e2a\u6267\u884c\u5355\u5143\u90fd\u53ef\u4ee5\u505a\u8fd9\u4e9b\u64cd\u4f5c\uff1aasimd int add/aes/fabs/fadd/fmax/fmin/fmla/fmul/fneg\uff0c\u4e0b\u9762\u628a\u8fd9\u4e9b\u6307\u4ee4\u79f0\u4e3a basic fp/asimd ops + aes\u3002\u63a5\u4e0b\u6765\u8981\u5224\u65ad\uff0cfmov f2i/fmov i2f/fdiv/frecpe/frecpx/frsqrte/fsqrt \u7531\u54ea\u4e9b\u6267\u884c\u5355\u5143\u8d1f\u8d23\u6267\u884c\uff0c\u65b9\u6cd5\u662f\u628a\u8fd9\u4e9b\u6307\u4ee4\u6df7\u5408\u8d77\u6765\u6d4b\u8bd5\u541e\u5410\uff08\u6b64\u5904\u7684\u541e\u5410\u4e0d\u4ee3\u8868 CPI\uff0c\u800c\u662f\u6bcf\u5468\u80fd\u591f\u6267\u884c\u591a\u5c11\u6b21\u6307\u4ee4\u7ec4\u5408\uff0c\u4f8b\u5982\u7528 2 \u6761\u6307\u4ee4\u7684\u7ec4\u5408\u6d4b\u8bd5\uff0c\u90a3\u4e48\u541e\u5410\u7b49\u4e8e CPI \u9664\u4ee5 2\uff09\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fp fdiv + fp frecpe</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frecpx</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frsqrte</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp fsqrt</td>\n<td>0.33=1/3</td>\n</tr>\n<tr>\n<td>fp fdiv + fmov f2i</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fmov f2i</td>\n<td>0.33=1/3</td>\n</tr>\n<tr>\n<td>fp fdiv + 3x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 4x fmov i2f</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>fmov i2f + 4x fp fadd</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fmov f2i + 4x fp fadd</td>\n<td>0.75=1/1.33</td>\n</tr>\n</tbody>\n</table>\n<p>\u6839\u636e\u4ee5\u4e0a\u6d4b\u8bd5\u7ed3\u679c\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7684\u63a8\u8bba\uff1a</p>\n<ol>\n<li>fp fdiv/frecpe/frecpx/frsqrte \u6df7\u5408\u7684\u65f6\u5019\uff0c\u541e\u5410\u53ea\u6709\u4e00\u534a\uff0cIPC \u4e0d\u53d8\uff0c\u8bf4\u660e\u8fd9\u4e9b\u6307\u4ee4\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u4e2d\uff0c\u6df7\u5408\u5e76\u4e0d\u80fd\u5e26\u6765\u66f4\u9ad8\u7684 IPC\uff1b\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c</li>\n<li>fp fdiv \u548c fp fsqrt \u6df7\u5408\u65f6\uff0c\u541e\u5410\u4e0b\u964d\u5230 0.33 \u4e00\u4e2a\u4e0d\u592a\u6574\u7684\u6570\u5b57\uff0c\u731c\u6d4b\u662f\u56e0\u4e3a\u5b83\u4eec\u5c5e\u4e8e\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u7684\u4e0d\u540c\u6d41\u6c34\u7ebf\uff0c\u62a2\u5360\u5bc4\u5b58\u5668\u5806\u5199\u53e3\uff1b\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c</li>\n<li>fp fdiv + fmov f2i \u7684\u65f6\u5019\u541e\u5410\u662f 0.5\uff0c\u800c fdiv + 2x fmov f2i \u65f6\u541e\u5410\u4e0b\u964d\u5230 0.33\uff0cIPC \u7ef4\u6301\u5728 1\uff0c\u8bf4\u660e\u6709 1 \u4e2a\u6267\u884c\u5355\u5143\u6267\u884c fdiv \u6216 fmov f2i\uff0c\u4f46\u5947\u602a\u7684\u662f\u5355\u72ec\u6267\u884c fmov f2i \u53ef\u4ee5\u8fbe\u5230 2 \u7684 IPC\uff1b\u8fd9\u90e8\u5206\u541e\u5410\u6bd4 M1 P-Core \u8981\u5dee</li>\n<li>fp fdiv + 3x fmov i2f \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u800c fdiv + 4x fmov i2f \u65f6\u541e\u5410\u4e0b\u964d\u5230 0.75\uff0c\u6b64\u65f6\u6bcf\u5468\u671f\u8fd8\u662f\u6267\u884c 3 \u6761 fmov i2f \u6307\u4ee4\uff0c\u610f\u5473\u7740 fdiv \u6ca1\u6709\u62a2\u5360 fmov i2f \u7684\u6267\u884c\u5355\u5143\uff0c\u5b83\u4eec\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u72ec\u7acb\u7684\uff1b\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c</li>\n<li>fmov i2f + 4x fp fadd \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u8bf4\u660e fmov i2f \u6ca1\u6709\u62a2\u5360 fp fadd \u7684\u6267\u884c\u5355\u5143\uff1b\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c</li>\n</ol>\n<p>\u63a8\u65ad\u8fd9\u56db\u4e2a\u6267\u884c\u5355\u5143\u652f\u6301\u7684\u64cd\u4f5c\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u5f53\u7136\u8fd8\u6709\u5f88\u591a\u6307\u4ee4\u6ca1\u6709\u6d4b\uff0c\u4e0d\u8fc7\u539f\u7406\u662f\u4e00\u6837\u7684\u3002\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c\u3002</p>\n<p>\u8bbf\u5b58\u90e8\u5206\uff0c\u524d\u9762\u5df2\u7ecf\u5728\u6d4b LSU \u7684\u65f6\u5019\u6d4b\u8fc7\u4e86\uff0c\u6bcf\u5468\u671f Load + Store \u4e0d\u8d85\u8fc7 4 \u4e2a\uff0c\u5176\u4e2d Load \u4e0d\u8d85\u8fc7 3 \u4e2a\uff0cStore \u4e0d\u8d85\u8fc7 2 \u4e2a\u3002\u867d\u7136\u4ece IPC \u7684\u89d2\u5ea6\u6765\u770b LSU \u7684 Load/Store Pipe \u672a\u5fc5\u51c6\u786e\uff0c\u6bd4\u5982\u53ef\u80fd\u5b83\u53d1\u5c04\u548c\u63d0\u4ea4\u7684\u5e26\u5bbd\u662f\u4e0d\u540c\u7684\uff0c\u4f46\u5148\u6682\u65f6\u7b80\u5316\u4e3a\u5982\u4e0b\u7684\u6267\u884c\u5355\u5143\uff1a</p>\n<ol>\n<li>load + store</li>\n<li>load</li>\n<li>load</li>\n<li>store</li>\n</ol>\n<p>\u8fd9\u90e8\u5206\u548c M1 P-Core \u76f8\u540c\u3002</p>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\u3002\u4ece addi \u7684\u6307\u4ee4\u6765\u770b\uff0c\u6709 8 \u4e2a ALU\uff0c\u80fd\u591f\u6267\u884c\u57fa\u672c\u7684\u6574\u6570\u6307\u4ee4\u3002\u4f46\u5176\u4ed6\u5f88\u591a\u6307\u4ee4\u53ef\u80fd\u53ea\u6709\u4e00\u90e8\u5206\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c\uff1abfm/crc/csel/madd/mrs nzcv/mul/div/branch/fmov i2f\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e9b\u6307\u4ee4\u4f7f\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u5426\u91cd\u5408\uff0c\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u6df7\u5408\u6307\u4ee4\u6d4b\u8bd5\uff0c\u541e\u5410\u7684\u5b9a\u4e49\u548c\u4e0a\u9762\u76f8\u540c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>4x int csel + 3x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int csel + 2x fmov f2i</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2x int csel + 2x fmov f2i</td>\n<td>0.80=1/1.25</td>\n</tr>\n<tr>\n<td>3x int csel + int bfm</td>\n<td>1</td>\n</tr>\n<tr>\n<td>4x int csel + int bfm</td>\n<td>0.80=1/1.25</td>\n</tr>\n<tr>\n<td>4x int csel + int crc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int madd</td>\n<td>1.33=1/0.75</td>\n</tr>\n<tr>\n<td>4x int csel + int madd</td>\n<td>1</td>\n</tr>\n<tr>\n<td>4x int csel + 2x int madd</td>\n<td>1</td>\n</tr>\n<tr>\n<td>4x int csel + 3x int madd</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>4x int csel + int mul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int sdiv</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>4x int csel + int sdiv</td>\n<td>0.45=1/2.23</td>\n</tr>\n<tr>\n<td>3x int csel + mrs nzcv</td>\n<td>1</td>\n</tr>\n<tr>\n<td>4x int csel + mrs nzcv</td>\n<td>0.80=1/1.25</td>\n</tr>\n<tr>\n<td>3x int csel + not taken branch</td>\n<td>1</td>\n</tr>\n<tr>\n<td>4x int csel + not taken branch</td>\n<td>0.80=1/1.25</td>\n</tr>\n<tr>\n<td>mrs nzcv + not taken branch</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mrs nzcv + 2x not taken branch</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>2x fmov f2i + 2x not taken branch</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2x fmov f2i + 2x int mul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2x int madd + int crc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int madd + int crc</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>2x int madd + int mul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int madd + int mul</td>\n<td>0.75</td>\n</tr>\n<tr>\n<td>2x int madd + int sdiv</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>3x int madd + int sdiv</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>3x int madd + mrs nzcv</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>\u6839\u636e\u4e0a\u8ff0\u7ed3\u679c\u5206\u6790\uff1a</p>\n<ol>\n<li>\u541e\u5410\u4e0e\u4e0d\u6df7\u5408\u65f6\u76f8\u540c\uff0c\u4ee3\u8868\u6df7\u5408\u7684\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408</li>\n<li>2x int madd + int mul \u7684 IPC \u662f 3\uff0c3x int add + int mul \u7684 IPC \u4e5f\u662f 3\uff0c\u8bf4\u660e\u6709\u4e09\u4e2a\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c madd \u548c mul\uff1a<ol>\n<li>alu + madd + mul</li>\n<li>alu + madd + mul</li>\n<li>alu + madd + mul</li>\n</ol>\n</li>\n<li>2x int madd + int crc \u7684 IPC \u662f 3\uff0c3x int madd + int crc \u7684 IPC \u4e5f\u662f 3\uff0c\u8bf4\u660e\u5176\u4e2d\u4e00\u4e2a\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c crc\uff1a<ol>\n<li>alu + madd + mul + crc</li>\n<li>alu + madd + mul</li>\n<li>alu + madd + mul</li>\n</ol>\n</li>\n<li>4x int csel + 2x int madd \u7684\u541e\u5410\u662f 1\uff0c4x int csel + 3x int madd \u7684\u541e\u5410\u662f 0.75\uff0c\u8bf4\u660e\u5b83\u4eec\u6709\u4e00\u4e2a\u91cd\u5408\u7684\u6267\u884c\u5355\u5143\uff0c\u5e76\u4e14\u7531\u4e8e 4x int csel + int crc \u7684\u541e\u5410\u662f 1\uff0c\u6240\u4ee5\u91cd\u5408\u7684\u6267\u884c\u5355\u5143\u4e0d\u662f crc \u7684\u90a3\u4e00\u4e2a\uff1a<ol>\n<li>alu + madd + mul + crc</li>\n<li>alu + madd + mul + csel</li>\n<li>alu + madd + mul</li>\n<li>alu + csel</li>\n<li>alu + csel</li>\n<li>alu + csel</li>\n</ol>\n</li>\n<li>4x int csel + mrs nzcv \u7684 IPC \u7b49\u4e8e 4\uff0c\u8bf4\u660e mrs nzcv \u7684\u6267\u884c\u5355\u5143\u88ab\u5305\u62ec\u5728\u80fd\u6267\u884c csel \u7684\u56db\u4e2a\u6267\u884c\u5355\u5143\u5f53\u4e2d\uff1b\u800c 3x int madd + mrs nzcv \u7684\u541e\u5410\u7b49\u4e8e 1\uff0c\u8bf4\u660e mrs nzcv \u7684\u6267\u884c\u5355\u5143\u548c int madd \u4e0d\u91cd\u5408\uff1a<ol>\n<li>alu + madd + mul + crc</li>\n<li>alu + madd + mul + csel</li>\n<li>alu + madd + mul</li>\n<li>alu + csel + mrs nzcv</li>\n<li>alu + csel + mrs nzcv</li>\n<li>alu + csel</li>\n</ol>\n</li>\n<li>\u56e0\u4e3a mrs nzcv + 2x not taken branch \u7684\u541e\u5410\u662f 0.67\uff0c\u6b64\u65f6 IPC \u7b49\u4e8e 2\uff0c\u8bf4\u660e\u5b83\u4eec\u7684\u6267\u884c\u5355\u5143\u91cd\u5408\uff1a<ol>\n<li>alu + madd + mul + crc</li>\n<li>alu + madd + mul + csel</li>\n<li>alu + madd + mul</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel</li>\n</ol>\n</li>\n</ol>\n<p>\u5f97\u5230\u521d\u6b65\u7684\u7ed3\u679c\uff1a</p>\n<ol>\n<li>alu + madd + mul + crc</li>\n<li>alu + madd + mul + csel</li>\n<li>alu + madd + mul</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel</li>\n<li>alu</li>\n<li>alu</li>\n</ol>\n<p>\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u6307\u4ee4\u6ca1\u6709\u6d4b\u8bd5\uff0c\u4e0d\u8fc7\u65b9\u6cd5\u662f\u7c7b\u4f3c\u7684\u3002\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u91cc\uff0c\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u503c\u5f97\u4e00\u63d0\u7684\u70b9\uff1a</p>\n<ol>\n<li>fmov f2i \u540c\u65f6\u5360\u7528\u4e86\u6d6e\u70b9\u6267\u884c\u5355\u5143\u548c\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u8fd9\u4e3b\u8981\u662f\u4e3a\u4e86\u590d\u7528\u5bc4\u5b58\u5668\u5806\u8bfb\u5199\u53e3\uff1afmov f2i \u9700\u8981\u8bfb\u6d6e\u70b9\u5bc4\u5b58\u5668\u5806\uff0c\u53c8\u9700\u8981\u5199\u6574\u6570\u5bc4\u5b58\u5668\u5806\uff0c\u90a3\u5c31\u5728\u6d6e\u70b9\u4fa7\u8bfb\u5bc4\u5b58\u5668\uff0c\u5728\u6574\u6570\u4fa7\u5199\u5bc4\u5b58\u5668\u3002</li>\n<li>fmov i2f \u65e2\u4e0d\u5728\u6d6e\u70b9\uff0c\u4e5f\u4e0d\u5728\u6574\u6570\uff0c\u90a3\u53ea\u80fd\u5728\u8bbf\u5b58\u4e86\uff1a\u800c\u6b63\u597d\u8bbf\u5b58\u6267\u884c\u5355\u5143\u9700\u8981\u8bfb\u6574\u6570\uff0c\u5199\u6574\u6570\u6216\u6d6e\u70b9\uff0c\u90a3\u5c31\u53ef\u4ee5\u590d\u7528\u5b83\u7684\u5bc4\u5b58\u5668\u5806\u5199\u53e3\u6765\u5b9e\u73b0 fmov i2f \u7684\u529f\u80fd\u3002</li>\n<li>\u53ef\u89c1\u6574\u6570/\u6d6e\u70b9/\u8bbf\u5b58\u6267\u884c\u5355\u5143\u5e76\u4e0d\u662f\u5b8c\u5168\u9694\u79bb\u7684\uff0c\u4f8b\u5982\u4e00\u4e9b\u5fae\u67b6\u6784\uff0c\u6574\u6570\u548c\u6d6e\u70b9\u662f\u76f4\u63a5\u653e\u5728\u4e00\u8d77\u7684\u3002</li>\n</ol>\n<p>\u5c0f\u7ed3\uff1aM4 P-Core \u7684\u6267\u884c\u5355\u5143\u5982\u4e0b\uff1a</p>\n<ol>\n<li>alu + madd + mul + crc</li>\n<li>alu + madd + mul + csel</li>\n<li>alu + madd + mul</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel</li>\n<li>alu</li>\n<li>alu</li>\n<li>load + store</li>\n<li>load</li>\n<li>load</li>\n<li>store</li>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u76f8\u6bd4 M1 P-Core\uff0c\u53ea\u5728\u6574\u6570\u65b9\u9762\u6709\u6269\u5145\u3002\u548c\u5b98\u65b9\u7684\u4fe1\u606f\uff0c\u9664\u4e86 store data/address \u90e8\u5206\u6ca1\u6709\u63a2\u6d4b\u51fa\u6765\u4ee5\u5916\u90fd\u4e00\u81f4\u3002</p>\n<h4 id=\"e-core_13\">E-Core<a class=\"headerlink\" href=\"#e-core_13\" title=\"Permanent link\">&para;</a></h4>\n<p>\u63a5\u4e0b\u6765\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 M4 E-Core\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Instruction</th>\n<th>Latency</th>\n<th>Throughput</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>asimd int add</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd aesd/aese</td>\n<td>2.5/3</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd aesimc/aesmc</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd fabs</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd fadd</td>\n<td>2.5</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd fdiv 64b</td>\n<td>11</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fdiv 32b</td>\n<td>9</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fmax</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd fmin</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd fmla</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fmul</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fneg</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>asimd frecpe</td>\n<td>4</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd frsqrte</td>\n<td>4</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 64b</td>\n<td>15</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 32b</td>\n<td>12</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp cvtf2i (fcvtzs)</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp cvti2f (scvtf)</td>\n<td>-</td>\n<td>1.5</td>\n</tr>\n<tr>\n<td>fp fabs</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fadd</td>\n<td>2.5</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fjcvtzs</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmax</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fmin</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fmov f2i</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmov i2f</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmul</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fneg</td>\n<td>2</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frecpx</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int add</td>\n<td>1</td>\n<td>4</td>\n</tr>\n<tr>\n<td>int addi</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int bfm</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int crc</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int csel</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int madd (addend)</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int madd (others)</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int mrs nzcv</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int mul</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int nop</td>\n<td>-</td>\n<td>5</td>\n</tr>\n<tr>\n<td>int sbfm</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int sdiv</td>\n<td>7</td>\n<td>0.125=1/8</td>\n</tr>\n<tr>\n<td>int smull</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int ubfm</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int udiv</td>\n<td>7</td>\n<td>0.125=1/8</td>\n</tr>\n<tr>\n<td>not taken branch</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>taken branch</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem asimd load</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem asimd store</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem int load</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem int store</td>\n<td>-</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u521d\u6b65\u5f97\u5230\u7684\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6807\u91cf\u6d6e\u70b9\u548c ASIMD \u541e\u5410\u6700\u5927\u90fd\u662f 3\uff0c\u610f\u5473\u7740\u6709 3 \u4e2a\u6d6e\u70b9/ASIMD \u6267\u884c\u5355\u5143\uff0c\u4f46\u5e76\u975e\u5b8c\u5168\u5bf9\u79f0\uff0c\u4f8b\u5982 fdiv/frecpe/frecpx/frsqrte/fsqrt \u7531\u4e8e\u541e\u5410\u4e0d\u8d85\u8fc7 1\uff0c\u5927\u6982\u7387\u53ea\u80fd\u5728\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\uff1bfmla/fmul \u7684\u541e\u5410\u53ea\u6709 2\uff0c\u53ea\u80fd\u5728\u5176\u4e2d\u4e24\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\u3002\u4f46\u8fd9\u4e9b\u6307\u4ee4\u662f\u4e0d\u662f\u90fd\u53ea\u80fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\uff0c\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u6d4b\u8bd5\uff1b\u76f8\u6bd4 M1 E-Core\uff0c\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6d6e\u70b9/ASIMD \u6267\u884c\u5355\u5143</li>\n<li>\u6574\u6570\u65b9\u9762\uff0c\u6839\u636e\u541e\u5410\uff0c\u63a8\u65ad\u51fa\u5982\u4e0b\u51e0\u7c7b\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u6570\u91cf\uff1a<ol>\n<li>ALU: 4</li>\n<li>CSEL/MRS NZCV/SBFM/UBFM: 3</li>\n<li>Br: 2</li>\n<li>Mul/CRC/BFM/MAdd/Div: 1</li>\n<li>\u76f8\u6bd4 M1 E-Core \u589e\u52a0\u4e86 ALU \u7684\u6570\u91cf</li>\n</ol>\n</li>\n<li>\u867d\u7136 Br \u7684\u541e\u5410\u53ef\u4ee5\u8fbe\u5230 2\uff0c\u4f46\u662f\u6bcf\u5468\u671f\u53ea\u80fd\u6709\u4e00\u4e2a taken branch\uff0c\u548c M1 E-Core \u76f8\u540c</li>\n<li>\u8bbf\u5b58\u65b9\u9762\uff0c\u6bcf\u5468\u671f\u6700\u591a 2 Load \u6216\u8005 1 Store\uff0c\u548c M1 E-Core \u76f8\u540c</li>\n</ol>\n<p>\u8fd8\u662f\u5148\u770b\u6d6e\u70b9\uff0c\u57fa\u672c\u6307\u4ee4 add/aes/fabs/fadd/fmax/fmin/fneg \u90fd\u80fd\u505a\u5230 3 \u7684\u541e\u5410\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e09\u4e2a\u6267\u884c\u5355\u5143\u90fd\u80fd\u6267\u884c\u8fd9\u4e9b\u57fa\u672c\u6307\u4ee4\u3002\u63a5\u4e0b\u6765\u6d4b\u5176\u4f59\u6307\u4ee4\u7684\u6df7\u5408\u541e\u5410\uff08\u541e\u5410\u5b9a\u4e49\u89c1\u4e0a\uff09\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fp fdiv + fp frecpe</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frecpx</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frsqrte</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp fsqrt</td>\n<td>0.31=1/3.25</td>\n</tr>\n<tr>\n<td>fp fdiv + fmov f2i</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fmov f2i</td>\n<td>0.66=1/1.50</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 3x fmov i2f</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>fp fdiv + fp fmul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fp fmul</td>\n<td>0.6</td>\n</tr>\n<tr>\n<td>fp fmul + fmov f2i</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2x fp fmul + fmov f2i</td>\n<td>0.67=1/1.50</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u89c1 fdiv/frecpe/frecpx/frsqrte/fsqrt \u90fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt</li>\n<li>basic fp/asimd ops + aes</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u7531\u4e8e fp fdiv + 2x fmov f2i \u7684 IPC \u662f 2\uff0c\u8bf4\u660e\u5b83\u4eec\u6709\u91cd\u5408\u7684\u6267\u884c\u5355\u5143\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i</li>\n<li>basic fp/asimd ops + aes + fmov f2i</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u56e0\u4e3a 2x fp fmul + fmov f2i \u7684 IPC \u4e5f\u53ea\u6709 2\uff0c\u8bf4\u660e fp fmul \u548c fmov f2i \u662f\u91cd\u5408\u7684\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + fmul</li>\n<li>basic fp/asimd ops + aes + fmov f2i + fmul</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u8fd8\u6709\u5f88\u591a\u6307\u4ee4\u6ca1\u6709\u6d4b\uff0c\u4e0d\u8fc7\u539f\u7406\u662f\u4e00\u6837\u7684\u3002\u8bbf\u5b58\u5728\u524d\u9762\u6d4b LSU \u7684\u65f6\u5019\u5df2\u7ecf\u6d4b\u8fc7\u4e86\uff1a</p>\n<ol>\n<li>load + store</li>\n<li>load</li>\n</ol>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\u3002\u4ece add \u7684\u6307\u4ee4\u6765\u770b\uff0c\u6709 4 \u4e2a ALU\uff0c\u80fd\u591f\u6267\u884c\u57fa\u672c\u7684\u6574\u6570\u6307\u4ee4\u3002\u4f46\u5176\u4ed6\u5f88\u591a\u6307\u4ee4\u53ef\u80fd\u53ea\u6709\u4e00\u90e8\u5206\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c\uff1abfm/crc/csel/madd/mul/div/branch\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e9b\u6307\u4ee4\u4f7f\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u5426\u91cd\u5408\uff0c\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u6df7\u5408\u6307\u4ee4\u6d4b\u8bd5\uff0c\u541e\u5410\u7684\u5b9a\u4e49\u548c\u4e0a\u9762\u76f8\u540c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>int madd + int mul</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + int crc</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + 2x not taken branch</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u6b64\u53ef\u89c1\uff0cmadd/mul/crc \u662f\u4e00\u4e2a\u6267\u884c\u5355\u5143\uff0c\u548c branch \u7684\u4e24\u4e2a\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408\uff0c\u56e0\u6b64\u6574\u6570\u4fa7\u7684\u6267\u884c\u5355\u5143\u6709\uff1a</p>\n<ol>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + madd + mul + crc</li>\n<li>alu</li>\n</ol>\n<p>\u5c0f\u7ed3\uff1aM4 E-Core \u7684\u6267\u884c\u5355\u5143\u5982\u4e0b\uff1a</p>\n<ol>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + madd + mul + crc</li>\n<li>alu</li>\n<li>load + store</li>\n<li>load</li>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + fmul</li>\n<li>basic fp/asimd ops + aes + fmov f2i + fmul</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u76f8\u6bd4 M1 E-Core\uff0c\u6574\u6570\u548c\u6d6e\u70b9\u65b9\u9762\u90fd\u6709\u6269\u5145\u3002\u548c\u5b98\u65b9\u7684\u4fe1\u606f\uff0c\u9664\u4e86 store data/address \u90e8\u5206\u6ca1\u6709\u63a2\u6d4b\u51fa\u6765\u4ee5\u5916\u90fd\u4e00\u81f4\uff0c\u66f4\u5177\u4f53\u6765\u8bf4\uff0c\u5e94\u8be5\u66f4\u63a5\u8fd1\uff1a</p>\n<ol>\n<li>load + sta</li>\n<li>load + sta + std</li>\n</ol>\n<h3 id=\"scheduler\">Scheduler<a class=\"headerlink\" href=\"#scheduler\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"p-core_14\">P-Core<a class=\"headerlink\" href=\"#p-core_14\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 M4 P-Core \u4e0a\u6d4b\u8bd5\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u53ef\u8c03\u5ea6 + \u4e0d\u53ef\u8c03\u5ea6</th>\n<th>\u53ef\u8c03\u5ea6</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ld</td>\n<td>66</td>\n<td>51</td>\n</tr>\n<tr>\n<td>st addr</td>\n<td>66</td>\n<td>51</td>\n</tr>\n<tr>\n<td>st data</td>\n<td>86</td>\n<td>70</td>\n</tr>\n<tr>\n<td>alu</td>\n<td>198</td>\n<td>175</td>\n</tr>\n<tr>\n<td>fp</td>\n<td>266</td>\n<td>243</td>\n</tr>\n<tr>\n<td>crc</td>\n<td>36</td>\n<td>23</td>\n</tr>\n<tr>\n<td>idiv</td>\n<td>36</td>\n<td>23</td>\n</tr>\n<tr>\n<td>bfm</td>\n<td>31</td>\n<td>18</td>\n</tr>\n<tr>\n<td>fjcvtzs</td>\n<td>72</td>\n<td>60</td>\n</tr>\n<tr>\n<td>fmov f2i</td>\n<td>144</td>\n<td>121</td>\n</tr>\n<tr>\n<td>csel</td>\n<td>98</td>\n<td>85</td>\n</tr>\n<tr>\n<td>mrs nzcv</td>\n<td>60</td>\n<td>47</td>\n</tr>\n</tbody>\n</table>\n<p>\u9996\u5148\u770b\u6d6e\u70b9\uff1a</p>\n<ol>\n<li>\u53ef\u8c03\u5ea6\u90e8\u5206 fp \u662f 243\uff0cfmov f2i \u662f 121\uff0cfjcvtzs \u662f 60\uff0c\u6709\u660e\u663e\u7684 4:2:1 \u7684\u5173\u7cfb</li>\n<li>fp/fmov f2i/fjcvtzs \u541e\u5410\u521a\u597d\u4e5f\u662f 4:2:1 \u7684\u5173\u7cfb</li>\n<li>\u56e0\u6b64\u56db\u4e2a\u6267\u884c\u5355\u5143\u524d\u9762\u5404\u6709\u4e00\u4e2a\u72ec\u7acb\u7684 60 entry \u7684 Scheduler</li>\n<li>\u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\uff0c266-243=23\uff0c144-121=23\uff0c72-60=12\uff0c\u731c\u6d4b\u6709\u4e24\u4e2a Non Scheduling Queue\uff0c\u6bcf\u4e2a Non Scheduling Queue 12 entry\uff0c\u5206\u522b\u5bf9\u5e94\u4e24\u4e2a Scheduler</li>\n</ol>\n<p>\u76f8\u6bd4 M1 P-Core \u6709\u6bd4\u8f83\u5927\u7684\u6269\u5145\uff1aScheduler \u5927\u5c0f\u4ece 36 \u6269\u5927\u5230 60\uff0cNon Scheduling Queue \u4ece 6 \u6269\u5927\u5230\u4e86 12\u3002</p>\n<p>\u4e0b\u9762\u662f\u8bbf\u5b58\u90e8\u5206\uff0cload \u548c store addr \u4e00\u6837\uff0c\u4f46 store data \u8981\u66f4\u591a\uff0c\u53ef\u80fd\u505a\u4e86\u4e0d\u540c\u7684\u5904\u7406\u3002</p>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\uff0c\u7531\u4e8e\u6709 8 \u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u60c5\u51b5\u4f1a\u6bd4\u8f83\u590d\u6742\uff1a</p>\n<ol>\n<li>\u53ef\u8c03\u5ea6\u90e8\u5206 alu \u4e00\u5171\u662f 175\uff0c\u5176\u4e2d csel \u662f 85\uff0ccrc/idiv \u90fd\u662f 23\uff0cbfm \u662f 18\uff0cmrs nzcv \u662f 47\uff0c\u7ed3\u5408 8 \u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u53ef\u4ee5\u5f97\u5230\u8fd9 8 \u4e2a\u6267\u884c\u5355\u5143\u5bf9\u5e94\u7684 Scheduler \u5927\u5c0f\u5173\u7cfb\uff1a<ol>\n<li>alu + madd + mul + crc: 23 entries</li>\n<li>alu + madd + mul + csel: a entries</li>\n<li>alu + madd + mul: b entries</li>\n<li>alu + csel + mrs nzcv + branch: c entries</li>\n<li>alu + csel + mrs nzcv + branch: 47-c entries</li>\n<li>alu + csel: 38-a entries</li>\n<li>alu: d entries</li>\n<li>alu: 67-b-d entries</li>\n</ol>\n</li>\n<li>alu \u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\u662f 198-175=23\uff0ccrc/idiv/bfm/csel/mrs nzcv \u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\u90fd\u662f 13\uff0c\u5e94\u8be5\u662f\u5176\u4e2d\u56db\u4e2a\u6267\u884c\u5355\u5143\u5171\u4eab\u4e00\u4e2a 12 entry \u7684 Non Scheduling Queue\uff1b\u53e6\u5916\u56db\u4e2a\u6267\u884c\u5355\u5143\u5171\u4eab\u5269\u4e0b\u7684 12 entry \u7684 Non Scheduling Queue</li>\n<li>\u6700\u540e\u53ea\u5dee a \u5230 d \u7684\u53d6\u503c\u6ca1\u6709\u6c42\u51fa\u6765\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fdb\u4e00\u6b65\u6d4b\u8bd5\u6765\u66f4\u52a0\u7cbe\u786e\u5730\u6c42\u51fa</li>\n</ol>\n<p>Scheduler \u5927\u5c0f\u76f8\u6bd4 M1 P-Core \u6709\u6bd4\u8f83\u5927\u7684\u6269\u5145\uff0cNon Scheduling Queue \u6ca1\u6709\u53d8\u5316\u3002</p>\n<h4 id=\"e-core_14\">E-Core<a class=\"headerlink\" href=\"#e-core_14\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 M4 E-Core \u4e0a\u6d4b\u8bd5\uff0c\u7ed3\u679c\u5f88\u4e0d\u7a33\u5b9a\uff0c\u9700\u8981\u8fdb\u4e00\u6b65\u7814\u7a76\u3002</p>\n<h3 id=\"reorder-buffer\">Reorder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"p-core_15\">P-Core<a class=\"headerlink\" href=\"#p-core_15\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9996\u5148\u7528\u4e0d\u540c\u6570\u91cf\u7684 fsqrt \u4f9d\u8d56\u94fe\u52a0 NOP \u6307\u4ee4\u6d4b\u8bd5 M4 P-Core \u7684 ROB \u5927\u5c0f\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-rob.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u5f53 fsqrt \u6570\u91cf\u8db3\u591f\u591a\u7684\u65f6\u5019\uff0c\u51fa\u73b0\u4e86\u7edf\u4e00\u7684\u62d0\u70b9\uff0c\u5728 3184 \u6761\u6307\u4ee4\u5de6\u53f3\u3002</p>\n<p>\u4e3a\u4e86\u6d4b Coalesced ROB \u7684\u5927\u5c0f\uff0c\u6539\u6210\u7528 load/store \u6307\u4ee4\uff0c\u53ef\u4ee5\u6d4b\u5230\u62d0\u70b9\u5728 313 \u5de6\u53f3\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-rob-load.png\" /></p>\n<p>3184 \u9664\u4ee5 313 \u7ea6\u7b49\u4e8e 10\uff0c\u610f\u5473\u7740\u6bcf\u4e2a group \u53ef\u4ee5\u4fdd\u5b58 10 \u6761\u6307\u4ee4\uff0c\u4e00\u5171\u6709 313 \u5de6\u53f3\u4e2a group\u3002\u76f8\u6bd4 M1 P-Core\uff0cGroup \u6570\u91cf\u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u80fd\u4fdd\u5b58\u7684\u6307\u4ee4\u6570\u91cf\u6709\u4e86\u5f88\u5927\u7684\u63d0\u5347\u3002</p>\n<h4 id=\"e-core_15\">E-Core<a class=\"headerlink\" href=\"#e-core_15\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9996\u5148\u7528 NOP \u6307\u4ee4\u6d4b\u8bd5 M4 E-Core \u7684 ROB \u5927\u5c0f\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-rob.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 513 \u6761\u6307\u4ee4\u3002</p>\n<p>\u4e3a\u4e86\u6d4b Coalesced ROB \u7684\u5927\u5c0f\uff0c\u6539\u6210\u7528 load/store \u6307\u4ee4\uff0c\u53ef\u4ee5\u6d4b\u5230\u62d0\u70b9\u5728 121 \u5de6\u53f3\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-rob-load.png\" /></p>\n<p>\u4f46\u662f 513 \u9664\u4ee5 121 \u662f 4.24\uff0c\u79bb 4 \u6216\u8005 5 \u90fd\u6709\u4e00\u6bb5\u8ddd\u79bb\uff0c\u6bd4\u8f83\u5947\u602a\uff0c\u4e0d\u786e\u5b9a\u6bcf\u4e2a group \u53ef\u4ee5\u653e\u591a\u5c11\u6761\u6307\u4ee4\u3002\u5bb9\u91cf\u4e0a\u6bd4 M1 E-Core \u6709\u660e\u663e\u63d0\u5347\u3002</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0c4 \u4e2a M4 P-Core \u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 16MB L2 Cache\uff0c6 \u4e2a M4 E-Core \u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 4MB L2 Cache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a>hw.perflevel0.l2cachesize: 16777216\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a>hw.perflevel0.cpusperl2: 4\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a>hw.perflevel1.l2cachesize: 4194304\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a>hw.perflevel1.cpusperl2: 6\n</span></code></pre></div>\n<p>\u6839\u636e Apple Silicon CPU Optimization Guide\uff0cL2 Cache \u914d\u7f6e\u5982\u4e0b\uff1a</p>\n<ul>\n<li>M1 Family/A14 Bionic: P-Core cluster 12MiB, 12-way, 128B lines; E-Core cluster 4MiB, 16-way, 128B lines</li>\n<li>M2/M3/M4 Family/A16 Bionic/A17 Pro/A18 Pro: P-Core cluster 16MiB, 16-way, 128B lines; E-Core cluster 4MiB, 16-way, 128B lines</li>\n<li>A14 Bionic/A18: P-Core cluster 8MiB, 16-way, 128B lines; E-Core cluster 4MiB, 16-way, 128B lines</li>\n</ul>\n<h3 id=\"memory-cache\">Memory Cache<a class=\"headerlink\" href=\"#memory-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6839\u636e Apple Silicon CPU Optimization Guide\uff0cMemory Cache\uff08\u5728\u522b\u7684\u5904\u7406\u5668\u4e5f\u53eb System Level Cache\uff0c\u5c31\u662f Last Level Cache\uff09\u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p>\n<ul>\n<li>M1/M2/M3/M4: 8MiB, 16-way, 128B lines</li>\n<li>M3 Pro/A18: 12MiB, 16-way, 128B lines</li>\n<li>A14 Bionic: 16MiB, 16-way, 128B lines</li>\n<li>M1 Pro/M2 Pro/M4 Pro/A16 Bionic/A17 Pro/A18 Pro: 24MiB, 12-way, 128B lines</li>\n<li>A15 Bionic: 32MiB, 16-way, 128B lines</li>\n<li>M1 Max/M2 Max/M3 Max/M4 Max: 48MiB, 12-way, 128B lines</li>\n<li>M1 Ultra/M2 Ultra/M3 Ultra: 96MiB, 12-way, 128B lines</li>\n</ul>\n<h3 id=\"l2-tlb\">L2 TLB<a class=\"headerlink\" href=\"#l2-tlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6839\u636e Apple Silicon CPU Optimization Guide\uff0cP-Core \u7684 L2 TLB \u5bb9\u91cf\uff0c\u4ece M1 Family \u5230 M4 Family\uff0c\u4ece A14 Bionic \u5230 A18 Family\uff0c\u90fd\u662f 3072 entries\uff1bE-Core \u7684 L2 TLB \u5bb9\u91cf\uff0cM1 Family \u548c A14 Bionic \u662f 1024 entries\uff0cM2 Family \u5230 M4 Family \u548c A15 Bionic \u5230 A18 Family \u90fd\u662f 2048 entries\u3002</p>\n<h4 id=\"p-core_16\">P-Core<a class=\"headerlink\" href=\"#p-core_16\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6cbf\u7528\u4e4b\u524d\u6d4b\u8bd5 L1 DTLB \u7684\u65b9\u6cd5\uff0c\u628a\u89c4\u6a21\u6269\u5927\u5230 L2 Unified TLB \u7684\u8303\u56f4\uff0c\u5c31\u53ef\u4ee5\u6d4b\u51fa\u6765 L2 Unified TLB \u7684\u5bb9\u91cf\uff0c\u4e0b\u9762\u662f M4 P-Core \u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-p-core-l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 3072 \u4e2a Page\uff0c\u8bf4\u660e M4 P-Core \u7684 L2 TLB \u5bb9\u91cf\u662f 3072 \u9879\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e00\u81f4\u3002\u8fd9\u548c M1 P-Core \u662f\u4e00\u6837\u7684\u3002</p>\n<h4 id=\"e-core_16\">E-Core<a class=\"headerlink\" href=\"#e-core_16\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 M4 E-Core \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple-m4-e-core-l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 1024 \u4e2a Page\uff0c\u8bf4\u660e M4 E-Core \u7684 L2 TLB \u5bb9\u91cf\u662f 1024 \u9879\uff0c\u548c\u5b98\u65b9\u4fe1\u606f\u4e0d\u4e00\u81f4\uff0c\u5b98\u65b9\u4fe1\u606f\u5199\u7684\u662f 2048 \u9879\u3002\u8fd9\u548c M1 E-Core \u6d4b\u51fa\u6765\u662f\u4e00\u6837\u7684\u3002</p>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>M4 \u76f8\u6bd4 M1\uff0c\u5728\u5f88\u591a\u65b9\u9762\u505a\u4e86\u8fed\u4ee3\uff1a</p>\n<ol>\n<li>P-Core \u7684\u524d\u7aef\u6709\u8f83\u5927\u6539\u8fdb\uff0c\u5c24\u5176\u662f BTB \u90e8\u5206</li>\n<li>\u5404\u79cd\u7ed3\u6784\u76f8\u6bd4 M1 \u6709\u4e86\u5bb9\u91cf\u7684\u589e\u52a0</li>\n<li>\u5bc4\u5b58\u5668\u5806\u589e\u52a0\u4e86\u5bf9 32 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u4f18\u5316</li>\n<li>\u5f15\u5165\u4e86 Load Address/Value Predictor</li>\n<li>\u6269\u5145\u4e86\u6267\u884c\u5355\u5143\uff0cP-Core \u4e3b\u8981\u6269\u5145\u4e86\u6574\u6570\uff0cE-Core \u5219\u662f\u6574\u6570\u548c\u6d6e\u70b9\u90fd\u505a\u4e86\u6269\u5145</li>\n<li>\u6dfb\u52a0\u4e86 SME \u6307\u4ee4\u96c6</li>\n</ol>\n<p>\u4f46\u4e5f\u6709\u4e00\u4e9b\u9057\u61be\uff0c\u4f8b\u5982\u8bbf\u5b58\u65b9\u9762\u6ca1\u6709\u6bcf\u5468\u671f\u5e26\u5bbd\u4e0a\u7684\u589e\u52a0\uff0cP-Core \u7684\u6d6e\u70b9\u4e5f\u6ca1\u6709\u589e\u52a0\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/apple-m4.png", "date_modified": "2025-05-21T00:00:00+00:00", "date_published": "2025-05-21T00:00:00+00:00", "authors": [], "tags": ["apple", "cpu", "hardware", "m4", "performance", "uarch-review"]}, {"id": "https://jia.je/hardware/2025/05/14/rocket-chip-diplomacy/", "url": "https://jia.je/hardware/2025/05/14/rocket-chip-diplomacy/", "title": "\u5206\u6790 Rocket Chip \u4e2d Diplomacy \u7cfb\u7edf", "content_html": "<h1 id=\"\u5206\u6790-rocket-chip-\u4e2d-diplomacy-\u7cfb\u7edf\">\u5206\u6790 Rocket Chip \u4e2d Diplomacy \u7cfb\u7edf<a class=\"headerlink\" href=\"#\u5206\u6790-rocket-chip-\u4e2d-diplomacy-\u7cfb\u7edf\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>Rocket Chip \u5927\u91cf\u4f7f\u7528\u4e86 Diplomacy \u7cfb\u7edf\u6765\u7ec4\u7ec7\u5b83\u7684\u603b\u7ebf\u3001\u4e2d\u65ad\u548c\u65f6\u949f\u7f51\u7edc\u3002\u56e0\u6b64\uff0c\u5982\u679c\u60f3\u8981\u5bf9 Rocket Chip \u8fdb\u884c\u5b9a\u5236\uff0c\u90a3\u4e48\u5fc5\u987b\u8981\u5bf9 Rocket Chip \u4e2d Diplomacy \u7cfb\u7edf\u7684\u4f7f\u7528\u6709\u5145\u5206\u7684\u4e86\u89e3\uff0c\u800c\u8fd9\u65b9\u9762\u7684\u6587\u6863\u6bd4\u8f83\u6b20\u7f3a\u3002\u672c\u6587\u662f\u5bf9 Rocket Chip \u4e2d Diplomacy \u7cfb\u7edf\u7684\u4f7f\u7528\u7684\u5206\u6790\u3002\u9605\u8bfb\u672c\u6587\u524d\uff0c\u5efa\u8bae\u9605\u8bfb\u5148\u524d\u7684 <a href=\"../../../../2022/01/05/diplomacy/\">\u5206\u6790 Diplomacy \u7cfb\u7edf</a> \u6587\u7ae0\uff0c\u5bf9 Diplomacy \u7cfb\u7edf\u7684\u8bbe\u8ba1\u548c\u5185\u90e8\u5b9e\u73b0\u83b7\u5f97\u4e00\u5b9a\u7684\u4e86\u89e3\u3002</p>\n<!-- more -->\n\n<h2 id=\"rocket-chip-\u603b\u7ebf\u7ed3\u6784\u6982\u8981\">Rocket Chip \u603b\u7ebf\u7ed3\u6784\u6982\u8981<a class=\"headerlink\" href=\"#rocket-chip-\u603b\u7ebf\u7ed3\u6784\u6982\u8981\" title=\"Permanent link\">&para;</a></h2>\n<p>Rocket Chip \u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u603b\u7ebf\uff1a</p>\n<ol>\n<li>sbus: System Bus</li>\n<li>mbus: Memory Bus</li>\n<li>cbus: Control Bus</li>\n<li>pbus: Periphery Bus</li>\n<li>fbus: Frontend Bus</li>\n</ol>\n<p>\u56fe\u793a\u53ef\u4ee5\u89c1\u53c2\u8003\u6587\u6863\u4e2d\u7684\u94fe\u63a5\uff0c\u4e0d\u8fc7\u94fe\u63a5\u4e2d\u7684\u7ed3\u6784\u548c\u5b9e\u9645\u7684\u6709\u4e00\u4e9b\u533a\u522b\u3002\u76ee\u524d\u7684 Rocket Chip \u7684\u603b\u7ebf\u7ed3\u6784\u5927\u81f4\u662f\u8fd9\u6837\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>fbus -&gt; sbus -&gt; mbus\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>tile --/    \\-&gt; cbus -&gt; pbus\n</span></code></pre></div>\n<p>\u4e3b\u8981\u662f pbus \u7684\u4f4d\u7f6e\u4ece\u8fde\u63a5 sbus \u79fb\u52a8\u5230\u4e86\u8fde\u63a5 cbus\u3002</p>\n<p>\u6839\u636e\u914d\u7f6e\u4e0d\u540c\uff0c\u603b\u7ebf\u7ed3\u6784\u4e5f\u4e0d\u540c\uff0c\u4f8b\u5982\u5728\u6709 coh(coherence manager) \u7684\u65f6\u5019\uff0c\u662f\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>fbus -&gt; sbus -&gt; coh -&gt; mbus\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>tile --/    \\-&gt; cbus -&gt; pbus\n</span></code></pre></div>\n<h2 id=\"\u6df1\u5165\u5206\u6790-rocket-chip-\u603b\u7ebf\u7ed3\u6784\">\u6df1\u5165\u5206\u6790 Rocket Chip \u603b\u7ebf\u7ed3\u6784<a class=\"headerlink\" href=\"#\u6df1\u5165\u5206\u6790-rocket-chip-\u603b\u7ebf\u7ed3\u6784\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u53cc\u6838 Rocket Chip \u7684 GraphML \u5bfc\u51fa\u6765\u7528 yED \u7ed8\u5236\u7684\u67b6\u6784\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../rocket-chip-diplomacy.svg\" /></p>\n<p>\u63a5\u4e0b\u6765\u6df1\u5165\u5206\u6790\u56fe\u4e2d\u7684\u5404\u4e2a\u8fde\u63a5\u5173\u7cfb\u4ee5\u53ca\u5bf9\u5e94\u7684\u4ee3\u7801\u3002</p>\n<h3 id=\"tilelink-\u548c-axi-\u603b\u7ebf\">TileLink \u548c AXI \u603b\u7ebf<a class=\"headerlink\" href=\"#tilelink-\u548c-axi-\u603b\u7ebf\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8fd9\u4e2a\u56fe\u6bd4\u8f83\u590d\u6742\uff0c\u6df7\u5408\u4e86\u591a\u4e2a Diplomacy \u7f51\u7edc\uff0c\u9996\u5148\u662f\u603b\u7ebf\u7684\u90e8\u5206\uff0c\u5305\u62ec TileLink \u548c AXI\uff1a</p>\n<ol>\n<li>\u4e24\u4e2a Tile\uff0c\u5bf9\u5e94\u4e00\u4e2a\u53cc\u6838\u7684\u7cfb\u7edf\uff1b\u6bcf\u4e2a Tile \u5185\u90e8\u6709\u4e00\u4e2a dcache \u548c icache\uff0c\u8fde\u63a5\u5230\u4e00\u4e2a tlMasterXbar \u4e0a\uff0c\u518d\u901a\u8fc7 coupler_from_rockettile \u8fde\u63a5\u5230 fixer \u518d\u5230 system_bus_xbar</li>\n<li>\u4ece system_bus_xbar \u5206\u51fa\u6765\u4e09\u8def Slave\uff1a<ol>\n<li>\u7b2c\u4e00\u8def\u662f cbus\uff0c\u901a\u8fc7 out_xbar\uff0c\u8fde\u63a5\u5230\u591a\u4e2a slave\uff1adebug\uff0cerror device\uff0cplic\uff0cclint\uff0cl2 control\uff0cbootrom</li>\n<li>\u7b2c\u4e8c\u8def\u662f mmio\uff0c\u901a\u8fc7 tl2axi4\uff0c\u8f6c\u6210 AXI4 \u8fde\u63a5\u5230\u5916\u90e8\u7684 MMIO \u5916\u8bbe</li>\n<li>\u7b2c\u4e09\u8def\u662f coh\uff0c\u8fde\u63a5\u5230 InclusiveCache\uff0c\u518d\u8fde\u63a5\u5230 mbus\uff0c\u901a\u8fc7 tl2axi4\uff0c\u8f6c\u6210 AXI4 \u8fde\u63a5\u5230\u5916\u90e8\u7684\u5185\u5b58</li>\n</ol>\n</li>\n<li>system_bus_xbar \u9664\u4e86\u6bcf\u4e2a tile \u5bf9\u5e94\u4e00\u4e2a master \u4ee5\u5916\uff0c\u8fd8\u6709\u4e00\u4e2a master\uff1afbus\uff0c\u5b83\u4ece\u5916\u90e8\u7684 AXI4 \u8fdb\u6765\uff0c\u901a\u8fc7 axi42tl \u8f6c\u6362\uff0c\u63a5\u5230 fbus\uff0c\u63d0\u4f9b\u4e00\u4e2a\u6709\u7f13\u5b58\u4e00\u81f4\u6027\u7684 AXI \u8bbf\u95ee\u63a5\u53e3\uff0c\u7528\u4e8e DMA</li>\n</ol>\n<p>\u7b80\u5316\u540e\u7684\u7ed3\u6784\u5982\u56fe\uff1a</p>\n<pre class=\"mermaid\"><code>flowchart TD\n    subgraph tile0\n        dcache0[dcache]\n        icache0[icache]\n        tlMasterXbar0[tlMasterXbar]\n        dcache0 --&gt; tlMasterXbar0\n        icache0 --&gt; tlMasterXbar0\n    end\n\n    subgraph tile1\n        dcache1[dcache]\n        icache1[icache]\n        tlMasterXbar1[tlMasterXbar]\n        dcache1 --&gt; tlMasterXbar1\n        icache1 --&gt; tlMasterXbar1\n    end\n\n    sbus\n    tlMasterXbar0 --&gt; sbus\n    tlMasterXbar1 --&gt; sbus\n    axi_fbus --&gt; axi42tl --&gt; fbus --&gt; sbus\n    sbus --&gt; cbus --&gt; out_xbar\n    out_xbar --&gt; debug\n    out_xbar --&gt; error\n    out_xbar --&gt; plit\n    out_xbar --&gt; clint\n    out_xbar --&gt; l2_ctrl\n    out_xbar --&gt; bootrom\n    cbus --&gt; pbus\n    sbus --&gt; tl2axi4_mmio[tl2axi4] --&gt; axi_mmio\n    sbus --&gt; coh --&gt; mbus --&gt; tl2axi4_mem[tl2axi4] --&gt; axi_mem</code></pre>\n<p>\u90a3\u4e48\u8fd9\u4e9b\u8fde\u63a5\u5173\u7cfb\u5728\u4ee3\u7801\u4e2d\u662f\u600e\u4e48\u642d\u5efa\u7684\u5462\uff1a</p>\n<ol>\n<li>\n<p>\u9996\u5148\u662f tile \u5185\u90e8\uff0cdcache \u548c icache \u5206\u522b\u901a\u8fc7\u4e00\u4e2a widget \u8fde\u5230\u4e00\u4e2a tlMasterXbar \u4e0a\uff1a</p>\n<p><div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Frontend</span><span class=\"p\">(</span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">icacheParams</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ICacheParams</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tileId</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Int</span><span class=\"p\">)(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"w\">  </span><span class=\"k\">lazy</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">FrontendModule</span><span class=\"p\">(</span><span class=\"bp\">this</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"w\">  </span><span class=\"c1\">// icache resides in frontend</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">icache</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">ICache</span><span class=\"p\">(</span><span class=\"n\">icacheParams</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tileId</span><span class=\"p\">))</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">masterNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icache</span><span class=\"p\">.</span><span class=\"n\">masterNode</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">slaveNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icache</span><span class=\"p\">.</span><span class=\"n\">slaveNode</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">resetVectorSinkNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">BundleBridgeSink</span><span class=\"p\">[</span><span class=\"nc\">UInt</span><span class=\"p\">](</span><span class=\"nc\">Some</span><span class=\"p\">(()</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"nc\">UInt</span><span class=\"p\">(</span><span class=\"n\">masterNode</span><span class=\"p\">.</span><span class=\"n\">edges</span><span class=\"p\">.</span><span class=\"n\">out</span><span class=\"p\">.</span><span class=\"n\">head</span><span class=\"p\">.</span><span class=\"n\">bundle</span><span class=\"p\">.</span><span class=\"n\">addressBits</span><span class=\"p\">.</span><span class=\"nc\">W</span><span class=\"p\">)))</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"nc\">HasICacheFrontend</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">CanHavePTW</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">BaseTile</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">frontend</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">Frontend</span><span class=\"p\">(</span><span class=\"n\">tileParams</span><span class=\"p\">.</span><span class=\"n\">icache</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tileId</span><span class=\"p\">))</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"w\">  </span><span class=\"c1\">// tlMasterXbar.node &lt;-- TLWidthWidget &lt;-- frontend.masterNode(i.e. icache.masterNode)</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a><span class=\"w\">  </span><span class=\"n\">tlMasterXbar</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLWidthWidget</span><span class=\"p\">(</span><span class=\"n\">tileParams</span><span class=\"p\">.</span><span class=\"n\">icache</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">.</span><span class=\"n\">rowBits</span><span class=\"o\">/</span><span class=\"mi\">8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">frontend</span><span class=\"p\">.</span><span class=\"n\">masterNode</span>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"nc\">HasHellaCache</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">BaseTile</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a><span class=\"w\">  </span><span class=\"k\">lazy</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">dcache</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HellaCache</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">BuildHellaCache</span><span class=\"p\">)(</span><span class=\"bp\">this</span><span class=\"p\">)(</span><span class=\"n\">p</span><span class=\"p\">))</span>\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a><span class=\"w\">  </span><span class=\"n\">tlMasterXbar</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLWidthWidget</span><span class=\"p\">(</span><span class=\"n\">tileParams</span><span class=\"p\">.</span><span class=\"n\">dcache</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">.</span><span class=\"n\">rowBits</span><span class=\"o\">/</span><span class=\"mi\">8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dcache</span><span class=\"p\">.</span><span class=\"n\">node</span>\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n2. \u5176\u6b21\u662f\u6bcf\u4e2a tile \u7684 tlMasterXbar \u8fde\u63a5\u5230 coupler_from_rockettile\uff0c\u518d\u8fde\u5230 sbus(system_bus_xbar)</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"c1\">// in HasTiles.scala</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"cm\">/** Connect the port where the tile is the master to a TileLink interconnect. */</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">connectMasterPorts</span><span class=\"p\">(</span><span class=\"n\">domain</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">TilePRCIDomain</span><span class=\"p\">[</span><span class=\"nc\">TileType</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Attachable</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">Unit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">  </span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"p\">.</span><span class=\"n\">p</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">  </span><span class=\"c1\">// crossingParams.master.where defaults to SBUS, see below</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">  </span><span class=\"c1\">// so dataBus is system_bus_xbar</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">dataBus</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"p\">.</span><span class=\"n\">locateTLBusWrapper</span><span class=\"p\">(</span><span class=\"n\">crossingParams</span><span class=\"p\">.</span><span class=\"n\">master</span><span class=\"p\">.</span><span class=\"n\">where</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">  </span><span class=\"c1\">// coupler_from_rockettile (val baseName = &quot;rockettile&quot; in RocketTileParams)</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">  </span><span class=\"n\">dataBus</span><span class=\"p\">.</span><span class=\"n\">coupleFrom</span><span class=\"p\">(</span><span class=\"n\">tileParams</span><span class=\"p\">.</span><span class=\"n\">baseName</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">bus</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"c1\">// crossMasterPort is defined below</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">    </span><span class=\"n\">bus</span><span class=\"w\"> </span><span class=\"o\">:=*</span><span class=\"w\"> </span><span class=\"n\">crossingParams</span><span class=\"p\">.</span><span class=\"n\">master</span><span class=\"p\">.</span><span class=\"n\">injectNode</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">:=*</span><span class=\"w\"> </span><span class=\"n\">domain</span><span class=\"p\">.</span><span class=\"n\">crossMasterPort</span><span class=\"p\">(</span><span class=\"n\">crossingParams</span><span class=\"p\">.</span><span class=\"n\">crossingType</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a>\n</span><span id=\"__span-3-15\"><a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\" href=\"#__codelineno-3-15\"></a><span class=\"c1\">// in HierarchicalElementPRCIDomain.scala</span>\n</span><span id=\"__span-3-16\"><a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\" href=\"#__codelineno-3-16\"></a><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">crossMasterPort</span><span class=\"p\">(</span><span class=\"n\">crossingType</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ClockCrossingType</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">TLOutwardNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-17\"><a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\" href=\"#__codelineno-3-17\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">tlMasterResetXing</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nc\">DisableMonitors</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-3-18\"><a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\" href=\"#__codelineno-3-18\"></a><span class=\"w\">    </span><span class=\"n\">element</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">element</span><span class=\"p\">.</span><span class=\"n\">makeMasterBoundaryBuffers</span><span class=\"p\">(</span><span class=\"n\">crossingType</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">:=*</span>\n</span><span id=\"__span-3-19\"><a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\" href=\"#__codelineno-3-19\"></a><span class=\"w\">      </span><span class=\"c1\">// masterNode is defined below</span>\n</span><span id=\"__span-3-20\"><a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\" href=\"#__codelineno-3-20\"></a><span class=\"w\">      </span><span class=\"n\">element_reset_domain</span><span class=\"p\">.</span><span class=\"n\">crossTLOut</span><span class=\"p\">(</span><span class=\"n\">element</span><span class=\"p\">.</span><span class=\"n\">masterNode</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-21\"><a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\" href=\"#__codelineno-3-21\"></a><span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-22\"><a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\" href=\"#__codelineno-3-22\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">tlMasterClockXing</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">.</span><span class=\"n\">crossOut</span><span class=\"p\">(</span><span class=\"n\">tlMasterResetXing</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-23\"><a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\" href=\"#__codelineno-3-23\"></a><span class=\"w\">  </span><span class=\"n\">tlMasterClockXing</span><span class=\"p\">(</span><span class=\"n\">crossingType</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-24\"><a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\" href=\"#__codelineno-3-24\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-3-25\"><a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\" href=\"#__codelineno-3-25\"></a>\n</span><span id=\"__span-3-26\"><a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\" href=\"#__codelineno-3-26\"></a><span class=\"c1\">// in RocketTile.scala</span>\n</span><span id=\"__span-3-27\"><a id=\"__codelineno-3-27\" name=\"__codelineno-3-27\" href=\"#__codelineno-3-27\"></a><span class=\"n\">tlOtherMastersNode</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tlMasterXbar</span><span class=\"p\">.</span><span class=\"n\">node</span>\n</span><span id=\"__span-3-28\"><a id=\"__codelineno-3-28\" name=\"__codelineno-3-28\" href=\"#__codelineno-3-28\"></a><span class=\"n\">masterNode</span><span class=\"w\"> </span><span class=\"o\">:=*</span><span class=\"w\"> </span><span class=\"n\">tlOtherMastersNode</span>\n</span><span id=\"__span-3-29\"><a id=\"__codelineno-3-29\" name=\"__codelineno-3-29\" href=\"#__codelineno-3-29\"></a>\n</span><span id=\"__span-3-30\"><a id=\"__codelineno-3-30\" name=\"__codelineno-3-30\" href=\"#__codelineno-3-30\"></a><span class=\"c1\">// crossingParams defaults to RocketCrossingParams()</span>\n</span><span id=\"__span-3-31\"><a id=\"__codelineno-3-31\" name=\"__codelineno-3-31\" href=\"#__codelineno-3-31\"></a><span class=\"c1\">// in RocketSubsystem.scala</span>\n</span><span id=\"__span-3-32\"><a id=\"__codelineno-3-32\" name=\"__codelineno-3-32\" href=\"#__codelineno-3-32\"></a><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">RocketCrossingParams</span><span class=\"p\">(</span>\n</span><span id=\"__span-3-33\"><a id=\"__codelineno-3-33\" name=\"__codelineno-3-33\" href=\"#__codelineno-3-33\"></a><span class=\"w\">  </span><span class=\"n\">crossingType</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ClockCrossingType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">SynchronousCrossing</span><span class=\"p\">(),</span>\n</span><span id=\"__span-3-34\"><a id=\"__codelineno-3-34\" name=\"__codelineno-3-34\" href=\"#__codelineno-3-34\"></a><span class=\"w\">  </span><span class=\"n\">master</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalElementPortParamsLike</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalElementMasterPortParams</span><span class=\"p\">(),</span>\n</span><span id=\"__span-3-35\"><a id=\"__codelineno-3-35\" name=\"__codelineno-3-35\" href=\"#__codelineno-3-35\"></a><span class=\"w\">  </span><span class=\"n\">slave</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalElementSlavePortParams</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalElementSlavePortParams</span><span class=\"p\">(),</span>\n</span><span id=\"__span-3-36\"><a id=\"__codelineno-3-36\" name=\"__codelineno-3-36\" href=\"#__codelineno-3-36\"></a><span class=\"w\">  </span><span class=\"n\">mmioBaseAddressPrefixWhere</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperLocation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">CBUS</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-37\"><a id=\"__codelineno-3-37\" name=\"__codelineno-3-37\" href=\"#__codelineno-3-37\"></a><span class=\"w\">  </span><span class=\"n\">resetCrossingType</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ResetCrossingType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">NoResetCrossing</span><span class=\"p\">(),</span>\n</span><span id=\"__span-3-38\"><a id=\"__codelineno-3-38\" name=\"__codelineno-3-38\" href=\"#__codelineno-3-38\"></a><span class=\"w\">  </span><span class=\"n\">forceSeparateClockReset</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Boolean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n</span><span id=\"__span-3-39\"><a id=\"__codelineno-3-39\" name=\"__codelineno-3-39\" href=\"#__codelineno-3-39\"></a><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalElementCrossingParamsLike</span>\n</span><span id=\"__span-3-40\"><a id=\"__codelineno-3-40\" name=\"__codelineno-3-40\" href=\"#__codelineno-3-40\"></a>\n</span><span id=\"__span-3-41\"><a id=\"__codelineno-3-41\" name=\"__codelineno-3-41\" href=\"#__codelineno-3-41\"></a><span class=\"c1\">// default crossingParams.master.where is SBUS(System Bus)</span>\n</span><span id=\"__span-3-42\"><a id=\"__codelineno-3-42\" name=\"__codelineno-3-42\" href=\"#__codelineno-3-42\"></a><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalElementMasterPortParams</span><span class=\"p\">(</span>\n</span><span id=\"__span-3-43\"><a id=\"__codelineno-3-43\" name=\"__codelineno-3-43\" href=\"#__codelineno-3-43\"></a><span class=\"w\">  </span><span class=\"n\">buffers</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Int</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-44\"><a id=\"__codelineno-3-44\" name=\"__codelineno-3-44\" href=\"#__codelineno-3-44\"></a><span class=\"w\">  </span><span class=\"n\">cork</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Option</span><span class=\"p\">[</span><span class=\"nc\">Boolean</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">,</span>\n</span><span id=\"__span-3-45\"><a id=\"__codelineno-3-45\" name=\"__codelineno-3-45\" href=\"#__codelineno-3-45\"></a><span class=\"w\">  </span><span class=\"n\">where</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperLocation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">SBUS</span>\n</span><span id=\"__span-3-46\"><a id=\"__codelineno-3-46\" name=\"__codelineno-3-46\" href=\"#__codelineno-3-46\"></a><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalElementPortParamsLike</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-47\"><a id=\"__codelineno-3-47\" name=\"__codelineno-3-47\" href=\"#__codelineno-3-47\"></a><span class=\"w\">  </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">injectNode</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Attachable</span><span class=\"p\">)(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">TLNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-48\"><a id=\"__codelineno-3-48\" name=\"__codelineno-3-48\" href=\"#__codelineno-3-48\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">TLBuffer</span><span class=\"p\">.</span><span class=\"n\">chainNode</span><span class=\"p\">(</span><span class=\"n\">buffers</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">:=*</span><span class=\"w\"> </span><span class=\"n\">cork</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"nc\">TLCacheCork</span><span class=\"p\">(</span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">getOrElse</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nc\">TLTempNode</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">})</span>\n</span><span id=\"__span-3-49\"><a id=\"__codelineno-3-49\" name=\"__codelineno-3-49\" href=\"#__codelineno-3-49\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-50\"><a id=\"__codelineno-3-50\" name=\"__codelineno-3-50\" href=\"#__codelineno-3-50\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u63a5\u7740\u662f sbus \u8fde\u63a5\u5230 coh\uff0ccoh \u8fde\u63a5\u5230 mbus\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"c1\">// in BusTopology.scala</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"cm\">/** Parameterization of a topology containing a banked coherence manager and a bus for attaching memory devices. */</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">CoherentBusTopologyParams</span><span class=\"p\">(</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"w\">  </span><span class=\"n\">mbus</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">MemoryBusParams</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"w\">  </span><span class=\"n\">coherence</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">BankedCoherenceParams</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"w\">  </span><span class=\"n\">sbusToMbusXType</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ClockCrossingType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">NoCrossing</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"w\">  </span><span class=\"n\">driveMBusClockFromSBus</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Boolean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperTopology</span><span class=\"p\">(</span>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"w\">  </span><span class=\"c1\">// instantiate mbus and coherence manager</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"w\">  </span><span class=\"n\">instantiations</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">coherence</span><span class=\"p\">.</span><span class=\"n\">nBanks</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Nil</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">List</span><span class=\"p\">(</span>\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">MBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"p\">),</span>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">COH</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">CoherenceManagerWrapperParams</span><span class=\"p\">(</span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">blockBytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">coherence</span><span class=\"p\">.</span><span class=\"n\">nBanks</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">COH</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">)(</span><span class=\"n\">coherence</span><span class=\"p\">.</span><span class=\"n\">coherenceManager</span><span class=\"p\">)))),</span>\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a><span class=\"w\">  </span><span class=\"n\">connections</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">coherence</span><span class=\"p\">.</span><span class=\"n\">nBanks</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Nil</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">List</span><span class=\"p\">(</span>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">    </span><span class=\"c1\">// (master, slave, parameters)</span>\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a><span class=\"w\">    </span><span class=\"c1\">// coh := sbus</span>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">SBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">COH</span><span class=\"p\">,</span><span class=\"w\">   </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"p\">(</span><span class=\"n\">driveClockFromMaster</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">nodeBinding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">BIND_STAR</span><span class=\"p\">)()),</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a><span class=\"w\">    </span><span class=\"c1\">// mbus := coh</span>\n</span><span id=\"__span-4-18\"><a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\" href=\"#__codelineno-4-18\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">COH</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"nc\">MBUS</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"p\">.</span><span class=\"n\">crossTo</span><span class=\"p\">(</span>\n</span><span id=\"__span-4-19\"><a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\" href=\"#__codelineno-4-19\"></a><span class=\"w\">      </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sbusToMbusXType</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-20\"><a id=\"__codelineno-4-20\" name=\"__codelineno-4-20\" href=\"#__codelineno-4-20\"></a><span class=\"w\">      </span><span class=\"n\">driveClockFromMaster</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveMBusClockFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">,</span>\n</span><span id=\"__span-4-21\"><a id=\"__codelineno-4-21\" name=\"__codelineno-4-21\" href=\"#__codelineno-4-21\"></a><span class=\"w\">      </span><span class=\"n\">nodeBinding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">BIND_QUERY</span><span class=\"p\">))</span>\n</span><span id=\"__span-4-22\"><a id=\"__codelineno-4-22\" name=\"__codelineno-4-22\" href=\"#__codelineno-4-22\"></a><span class=\"w\">  </span><span class=\"p\">)</span>\n</span><span id=\"__span-4-23\"><a id=\"__codelineno-4-23\" name=\"__codelineno-4-23\" href=\"#__codelineno-4-23\"></a><span class=\"p\">)</span>\n</span><span id=\"__span-4-24\"><a id=\"__codelineno-4-24\" name=\"__codelineno-4-24\" href=\"#__codelineno-4-24\"></a>\n</span><span id=\"__span-4-25\"><a id=\"__codelineno-4-25\" name=\"__codelineno-4-25\" href=\"#__codelineno-4-25\"></a><span class=\"c1\">// in BusWrapper.scala</span>\n</span><span id=\"__span-4-26\"><a id=\"__codelineno-4-26\" name=\"__codelineno-4-26\" href=\"#__codelineno-4-26\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperTopology</span><span class=\"p\">(</span>\n</span><span id=\"__span-4-27\"><a id=\"__codelineno-4-27\" name=\"__codelineno-4-27\" href=\"#__codelineno-4-27\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">instantiations</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">[(</span><span class=\"nc\">Location</span><span class=\"p\">[</span><span class=\"nc\">TLBusWrapper</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperInstantiationLike</span><span class=\"p\">)],</span>\n</span><span id=\"__span-4-28\"><a id=\"__codelineno-4-28\" name=\"__codelineno-4-28\" href=\"#__codelineno-4-28\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">connections</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">[(</span><span class=\"nc\">Location</span><span class=\"p\">[</span><span class=\"nc\">TLBusWrapper</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"nc\">Location</span><span class=\"p\">[</span><span class=\"nc\">TLBusWrapper</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperConnectionLike</span><span class=\"p\">)]</span>\n</span><span id=\"__span-4-29\"><a id=\"__codelineno-4-29\" name=\"__codelineno-4-29\" href=\"#__codelineno-4-29\"></a><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">CanInstantiateWithinContextThatHasTileLinkLocations</span>\n</span><span id=\"__span-4-30\"><a id=\"__codelineno-4-30\" name=\"__codelineno-4-30\" href=\"#__codelineno-4-30\"></a><span class=\"w\">  </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">CanConnectWithinContextThatHasTileLinkLocations</span>\n</span><span id=\"__span-4-31\"><a id=\"__codelineno-4-31\" name=\"__codelineno-4-31\" href=\"#__codelineno-4-31\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-32\"><a id=\"__codelineno-4-32\" name=\"__codelineno-4-32\" href=\"#__codelineno-4-32\"></a><span class=\"w\">  </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">instantiate</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HasTileLinkLocations</span><span class=\"p\">)(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">Unit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-4-33\"><a id=\"__codelineno-4-33\" name=\"__codelineno-4-33\" href=\"#__codelineno-4-33\"></a><span class=\"w\">    </span><span class=\"n\">instantiations</span><span class=\"p\">.</span><span class=\"n\">foreach</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">loc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">loc</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-4-34\"><a id=\"__codelineno-4-34\" name=\"__codelineno-4-34\" href=\"#__codelineno-4-34\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-4-35\"><a id=\"__codelineno-4-35\" name=\"__codelineno-4-35\" href=\"#__codelineno-4-35\"></a><span class=\"w\">  </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HasTileLinkLocations</span><span class=\"p\">)(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">Unit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-4-36\"><a id=\"__codelineno-4-36\" name=\"__codelineno-4-36\" href=\"#__codelineno-4-36\"></a><span class=\"w\">    </span><span class=\"n\">connections</span><span class=\"p\">.</span><span class=\"n\">foreach</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">master</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">slave</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">master</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">slave</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-4-37\"><a id=\"__codelineno-4-37\" name=\"__codelineno-4-37\" href=\"#__codelineno-4-37\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-4-38\"><a id=\"__codelineno-4-38\" name=\"__codelineno-4-38\" href=\"#__codelineno-4-38\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u4e3a\u4e86\u8ba9 Rocket Chip \u53ef\u4ee5\u8bbf\u95ee\u5916\u90e8\u7684 AXI MMIO \u8bbe\u5907\uff0c\u5728 sbus \u4e0b\u9762\u6dfb\u52a0\u4e86 tl \u5230 axi \u7684\u4e00\u6761\u8def\u5f84\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"cm\">/** Adds a AXI4 port to the system intended to master an MMIO device bus */</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"nc\">CanHaveMasterAXI4MMIOPort</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">BaseSubsystem</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">mmioPortParamsOpt</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">ExtBus</span><span class=\"p\">)</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">portName</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">&quot;mmio_port_axi4&quot;</span>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">SimpleBus</span><span class=\"p\">(</span><span class=\"n\">portName</span><span class=\"p\">.</span><span class=\"n\">kebab</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">Nil</span><span class=\"p\">)</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">mmioAXI4Node</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AXI4SlaveNode</span><span class=\"p\">(</span>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"w\">    </span><span class=\"n\">mmioPortParamsOpt</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">      </span><span class=\"nc\">AXI4SlavePortParameters</span><span class=\"p\">(</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\">        </span><span class=\"n\">slaves</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">(</span><span class=\"nc\">AXI4SlaveParameters</span><span class=\"p\">(</span>\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">          </span><span class=\"n\">address</span><span class=\"w\">       </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AddressSet</span><span class=\"p\">.</span><span class=\"n\">misaligned</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">base</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">),</span>\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\">          </span><span class=\"n\">resources</span><span class=\"w\">     </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">.</span><span class=\"n\">ranges</span><span class=\"p\">,</span>\n</span><span id=\"__span-5-13\"><a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\" href=\"#__codelineno-5-13\"></a><span class=\"w\">          </span><span class=\"n\">executable</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">executable</span><span class=\"p\">,</span>\n</span><span id=\"__span-5-14\"><a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\" href=\"#__codelineno-5-14\"></a><span class=\"w\">          </span><span class=\"n\">supportsWrite</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">TransferSizes</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">maxXferBytes</span><span class=\"p\">),</span>\n</span><span id=\"__span-5-15\"><a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\" href=\"#__codelineno-5-15\"></a><span class=\"w\">          </span><span class=\"n\">supportsRead</span><span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">TransferSizes</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">maxXferBytes</span><span class=\"p\">))),</span>\n</span><span id=\"__span-5-16\"><a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\" href=\"#__codelineno-5-16\"></a><span class=\"w\">        </span><span class=\"n\">beatBytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">)).</span><span class=\"n\">toSeq</span><span class=\"p\">)</span>\n</span><span id=\"__span-5-17\"><a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\" href=\"#__codelineno-5-17\"></a>\n</span><span id=\"__span-5-18\"><a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\" href=\"#__codelineno-5-18\"></a><span class=\"w\">  </span><span class=\"c1\">// in BaseSubsystem.scala:</span>\n</span><span id=\"__span-5-19\"><a id=\"__codelineno-5-19\" name=\"__codelineno-5-19\" href=\"#__codelineno-5-19\"></a><span class=\"w\">  </span><span class=\"c1\">// def viewpointBus: TLBusWrapper = tlBusWrapperLocationMap(p(TLManagerViewpointLocated(location)))</span>\n</span><span id=\"__span-5-20\"><a id=\"__codelineno-5-20\" name=\"__codelineno-5-20\" href=\"#__codelineno-5-20\"></a><span class=\"w\">  </span><span class=\"c1\">// case class TLManagerViewpointLocated(where: HierarchicalLocation) extends Field[Location[TLBusWrapper]](SBUS)</span>\n</span><span id=\"__span-5-21\"><a id=\"__codelineno-5-21\" name=\"__codelineno-5-21\" href=\"#__codelineno-5-21\"></a><span class=\"w\">  </span><span class=\"c1\">// so viewpointBus points to sbus by default</span>\n</span><span id=\"__span-5-22\"><a id=\"__codelineno-5-22\" name=\"__codelineno-5-22\" href=\"#__codelineno-5-22\"></a><span class=\"w\">  </span><span class=\"n\">mmioPortParamsOpt</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-5-23\"><a id=\"__codelineno-5-23\" name=\"__codelineno-5-23\" href=\"#__codelineno-5-23\"></a><span class=\"w\">    </span><span class=\"n\">viewpointBus</span><span class=\"p\">.</span><span class=\"n\">coupleTo</span><span class=\"p\">(</span><span class=\"s\">s&quot;port_named_</span><span class=\"si\">$</span><span class=\"n\">portName</span><span class=\"s\">&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-5-24\"><a id=\"__codelineno-5-24\" name=\"__codelineno-5-24\" href=\"#__codelineno-5-24\"></a><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">mmioAXI4Node</span>\n</span><span id=\"__span-5-25\"><a id=\"__codelineno-5-25\" name=\"__codelineno-5-25\" href=\"#__codelineno-5-25\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4Buffer</span><span class=\"p\">()</span>\n</span><span id=\"__span-5-26\"><a id=\"__codelineno-5-26\" name=\"__codelineno-5-26\" href=\"#__codelineno-5-26\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4UserYanker</span><span class=\"p\">()</span>\n</span><span id=\"__span-5-27\"><a id=\"__codelineno-5-27\" name=\"__codelineno-5-27\" href=\"#__codelineno-5-27\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4Deinterleaver</span><span class=\"p\">(</span><span class=\"n\">viewpointBus</span><span class=\"p\">.</span><span class=\"n\">blockBytes</span><span class=\"p\">)</span>\n</span><span id=\"__span-5-28\"><a id=\"__codelineno-5-28\" name=\"__codelineno-5-28\" href=\"#__codelineno-5-28\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4IdIndexer</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">idBits</span><span class=\"p\">)</span>\n</span><span id=\"__span-5-29\"><a id=\"__codelineno-5-29\" name=\"__codelineno-5-29\" href=\"#__codelineno-5-29\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLToAXI4</span><span class=\"p\">()</span>\n</span><span id=\"__span-5-30\"><a id=\"__codelineno-5-30\" name=\"__codelineno-5-30\" href=\"#__codelineno-5-30\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLWidthWidget</span><span class=\"p\">(</span><span class=\"n\">viewpointBus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">)</span>\n</span><span id=\"__span-5-31\"><a id=\"__codelineno-5-31\" name=\"__codelineno-5-31\" href=\"#__codelineno-5-31\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span>\n</span><span id=\"__span-5-32\"><a id=\"__codelineno-5-32\" name=\"__codelineno-5-32\" href=\"#__codelineno-5-32\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-5-33\"><a id=\"__codelineno-5-33\" name=\"__codelineno-5-33\" href=\"#__codelineno-5-33\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-5-34\"><a id=\"__codelineno-5-34\" name=\"__codelineno-5-34\" href=\"#__codelineno-5-34\"></a>\n</span><span id=\"__span-5-35\"><a id=\"__codelineno-5-35\" name=\"__codelineno-5-35\" href=\"#__codelineno-5-35\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">mmio_axi4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">InModuleBody</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">mmioAXI4Node</span><span class=\"p\">.</span><span class=\"n\">makeIOs</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-5-36\"><a id=\"__codelineno-5-36\" name=\"__codelineno-5-36\" href=\"#__codelineno-5-36\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u7c7b\u4f3c\u5730\uff0c\u4e3a\u4e86\u8ba9 Rocket Chip \u53ef\u4ee5\u8bbf\u95ee\u5916\u90e8\u7684 AXI Memory\uff0c\u5728 mbus \u4e0b\u9762\u6dfb\u52a0\u4e86 tl \u5230 axi \u7684\u4e00\u6761\u8def\u5f84\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"cm\">/** Adds a port to the system intended to master an AXI4 DRAM controller. */</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"nc\">CanHaveMasterAXI4MemPort</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">BaseSubsystem</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">memPortParamsOpt</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">ExtMem</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">portName</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">&quot;axi4&quot;</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">MemoryDevice</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">idBits</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">memPortParamsOpt</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">.</span><span class=\"n\">master</span><span class=\"p\">.</span><span class=\"n\">idBits</span><span class=\"p\">).</span><span class=\"n\">getOrElse</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-7\"><a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\" href=\"#__codelineno-6-7\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tlBusWrapperLocationMap</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nc\">MBUS</span><span class=\"p\">).</span><span class=\"n\">getOrElse</span><span class=\"p\">(</span><span class=\"n\">viewpointBus</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-8\"><a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\" href=\"#__codelineno-6-8\"></a>\n</span><span id=\"__span-6-9\"><a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\" href=\"#__codelineno-6-9\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">memAXI4Node</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AXI4SlaveNode</span><span class=\"p\">(</span><span class=\"n\">memPortParamsOpt</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">({</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"nc\">MemoryPortParams</span><span class=\"p\">(</span><span class=\"n\">memPortParams</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nMemoryChannels</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-6-10\"><a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\" href=\"#__codelineno-6-10\"></a><span class=\"w\">    </span><span class=\"nc\">Seq</span><span class=\"p\">.</span><span class=\"n\">tabulate</span><span class=\"p\">(</span><span class=\"n\">nMemoryChannels</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">channel</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-6-11\"><a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\" href=\"#__codelineno-6-11\"></a><span class=\"w\">      </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AddressSet</span><span class=\"p\">.</span><span class=\"n\">misaligned</span><span class=\"p\">(</span><span class=\"n\">memPortParams</span><span class=\"p\">.</span><span class=\"n\">base</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memPortParams</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-12\"><a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\" href=\"#__codelineno-6-12\"></a><span class=\"w\">      </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AddressSet</span><span class=\"p\">(</span><span class=\"n\">channel</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">blockBytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"p\">((</span><span class=\"n\">nMemoryChannels</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">blockBytes</span><span class=\"p\">))</span>\n</span><span id=\"__span-6-13\"><a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\" href=\"#__codelineno-6-13\"></a>\n</span><span id=\"__span-6-14\"><a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\" href=\"#__codelineno-6-14\"></a><span class=\"w\">      </span><span class=\"nc\">AXI4SlavePortParameters</span><span class=\"p\">(</span>\n</span><span id=\"__span-6-15\"><a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\" href=\"#__codelineno-6-15\"></a><span class=\"w\">        </span><span class=\"n\">slaves</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">(</span><span class=\"nc\">AXI4SlaveParameters</span><span class=\"p\">(</span>\n</span><span id=\"__span-6-16\"><a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\" href=\"#__codelineno-6-16\"></a><span class=\"w\">          </span><span class=\"n\">address</span><span class=\"w\">       </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"p\">.</span><span class=\"n\">flatMap</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">.</span><span class=\"n\">intersect</span><span class=\"p\">(</span><span class=\"n\">filter</span><span class=\"p\">)),</span>\n</span><span id=\"__span-6-17\"><a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\" href=\"#__codelineno-6-17\"></a><span class=\"w\">          </span><span class=\"n\">resources</span><span class=\"w\">     </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"p\">.</span><span class=\"n\">reg</span><span class=\"p\">,</span>\n</span><span id=\"__span-6-18\"><a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\" href=\"#__codelineno-6-18\"></a><span class=\"w\">          </span><span class=\"n\">regionType</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">RegionType</span><span class=\"p\">.</span><span class=\"nc\">UNCACHED</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"c1\">// cacheable</span>\n</span><span id=\"__span-6-19\"><a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\" href=\"#__codelineno-6-19\"></a><span class=\"w\">          </span><span class=\"n\">executable</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n</span><span id=\"__span-6-20\"><a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\" href=\"#__codelineno-6-20\"></a><span class=\"w\">          </span><span class=\"n\">supportsWrite</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">TransferSizes</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">blockBytes</span><span class=\"p\">),</span>\n</span><span id=\"__span-6-21\"><a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\" href=\"#__codelineno-6-21\"></a><span class=\"w\">          </span><span class=\"n\">supportsRead</span><span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">TransferSizes</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">blockBytes</span><span class=\"p\">),</span>\n</span><span id=\"__span-6-22\"><a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\" href=\"#__codelineno-6-22\"></a><span class=\"w\">          </span><span class=\"n\">interleavedId</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))),</span><span class=\"w\"> </span><span class=\"c1\">// slave does not interleave read responses</span>\n</span><span id=\"__span-6-23\"><a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\" href=\"#__codelineno-6-23\"></a><span class=\"w\">        </span><span class=\"n\">beatBytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">memPortParams</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-24\"><a id=\"__codelineno-6-24\" name=\"__codelineno-6-24\" href=\"#__codelineno-6-24\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-25\"><a id=\"__codelineno-6-25\" name=\"__codelineno-6-25\" href=\"#__codelineno-6-25\"></a><span class=\"w\">  </span><span class=\"p\">}).</span><span class=\"n\">toList</span><span class=\"p\">.</span><span class=\"n\">flatten</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-26\"><a id=\"__codelineno-6-26\" name=\"__codelineno-6-26\" href=\"#__codelineno-6-26\"></a>\n</span><span id=\"__span-6-27\"><a id=\"__codelineno-6-27\" name=\"__codelineno-6-27\" href=\"#__codelineno-6-27\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">until</span><span class=\"w\"> </span><span class=\"n\">memAXI4Node</span><span class=\"p\">.</span><span class=\"n\">portParams</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-28\"><a id=\"__codelineno-6-28\" name=\"__codelineno-6-28\" href=\"#__codelineno-6-28\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">mem_bypass_xbar</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mbus</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nc\">TLXbar</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-29\"><a id=\"__codelineno-6-29\" name=\"__codelineno-6-29\" href=\"#__codelineno-6-29\"></a>\n</span><span id=\"__span-6-30\"><a id=\"__codelineno-6-30\" name=\"__codelineno-6-30\" href=\"#__codelineno-6-30\"></a><span class=\"w\">    </span><span class=\"c1\">// Create an incoherent alias for the AXI4 memory</span>\n</span><span id=\"__span-6-31\"><a id=\"__codelineno-6-31\" name=\"__codelineno-6-31\" href=\"#__codelineno-6-31\"></a><span class=\"w\">    </span><span class=\"n\">memPortParamsOpt</span><span class=\"p\">.</span><span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">memPortParams</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-32\"><a id=\"__codelineno-6-32\" name=\"__codelineno-6-32\" href=\"#__codelineno-6-32\"></a><span class=\"w\">      </span><span class=\"n\">memPortParams</span><span class=\"p\">.</span><span class=\"n\">incohBase</span><span class=\"p\">.</span><span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">incohBase</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-33\"><a id=\"__codelineno-6-33\" name=\"__codelineno-6-33\" href=\"#__codelineno-6-33\"></a><span class=\"w\">        </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">cohRegion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AddressSet</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">incohBase</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-34\"><a id=\"__codelineno-6-34\" name=\"__codelineno-6-34\" href=\"#__codelineno-6-34\"></a><span class=\"w\">        </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">incohRegion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AddressSet</span><span class=\"p\">(</span><span class=\"n\">incohBase</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">incohBase</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-35\"><a id=\"__codelineno-6-35\" name=\"__codelineno-6-35\" href=\"#__codelineno-6-35\"></a><span class=\"w\">        </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">replicator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tlBusWrapperLocationMap</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">TLManagerViewpointLocated</span><span class=\"p\">(</span><span class=\"n\">location</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-36\"><a id=\"__codelineno-6-36\" name=\"__codelineno-6-36\" href=\"#__codelineno-6-36\"></a><span class=\"w\">          </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">replicator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">RegionReplicator</span><span class=\"p\">(</span><span class=\"nc\">ReplicatedRegion</span><span class=\"p\">(</span><span class=\"n\">cohRegion</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cohRegion</span><span class=\"p\">.</span><span class=\"n\">widen</span><span class=\"p\">(</span><span class=\"n\">incohBase</span><span class=\"p\">))))</span>\n</span><span id=\"__span-6-37\"><a id=\"__codelineno-6-37\" name=\"__codelineno-6-37\" href=\"#__codelineno-6-37\"></a><span class=\"w\">          </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">prefixSource</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">BundleBridgeSource</span><span class=\"p\">[</span><span class=\"nc\">UInt</span><span class=\"p\">](()</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"nc\">UInt</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"nc\">W</span><span class=\"p\">))</span>\n</span><span id=\"__span-6-38\"><a id=\"__codelineno-6-38\" name=\"__codelineno-6-38\" href=\"#__codelineno-6-38\"></a><span class=\"w\">          </span><span class=\"n\">replicator</span><span class=\"p\">.</span><span class=\"n\">prefix</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prefixSource</span>\n</span><span id=\"__span-6-39\"><a id=\"__codelineno-6-39\" name=\"__codelineno-6-39\" href=\"#__codelineno-6-39\"></a><span class=\"w\">          </span><span class=\"c1\">// prefix is unused for TL uncached, so this is ok</span>\n</span><span id=\"__span-6-40\"><a id=\"__codelineno-6-40\" name=\"__codelineno-6-40\" href=\"#__codelineno-6-40\"></a><span class=\"w\">          </span><span class=\"nc\">InModuleBody</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">prefixSource</span><span class=\"p\">.</span><span class=\"n\">bundle</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"nc\">U</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"nc\">W</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-41\"><a id=\"__codelineno-6-41\" name=\"__codelineno-6-41\" href=\"#__codelineno-6-41\"></a><span class=\"w\">          </span><span class=\"n\">replicator</span>\n</span><span id=\"__span-6-42\"><a id=\"__codelineno-6-42\" name=\"__codelineno-6-42\" href=\"#__codelineno-6-42\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-43\"><a id=\"__codelineno-6-43\" name=\"__codelineno-6-43\" href=\"#__codelineno-6-43\"></a><span class=\"w\">        </span><span class=\"n\">viewpointBus</span><span class=\"p\">.</span><span class=\"n\">coupleTo</span><span class=\"p\">(</span><span class=\"s\">s&quot;memory_controller_bypass_port_named_</span><span class=\"si\">$</span><span class=\"n\">portName</span><span class=\"s\">&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-44\"><a id=\"__codelineno-6-44\" name=\"__codelineno-6-44\" href=\"#__codelineno-6-44\"></a><span class=\"w\">          </span><span class=\"p\">(</span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">crossIn</span><span class=\"p\">(</span><span class=\"n\">mem_bypass_xbar</span><span class=\"p\">)(</span><span class=\"nc\">ValName</span><span class=\"p\">(</span><span class=\"s\">&quot;bus_xing&quot;</span><span class=\"p\">))(</span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">SbusToMbusXTypeKey</span><span class=\"p\">))</span>\n</span><span id=\"__span-6-45\"><a id=\"__codelineno-6-45\" name=\"__codelineno-6-45\" href=\"#__codelineno-6-45\"></a><span class=\"w\">            </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLWidthWidget</span><span class=\"p\">(</span><span class=\"n\">viewpointBus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-46\"><a id=\"__codelineno-6-46\" name=\"__codelineno-6-46\" href=\"#__codelineno-6-46\"></a><span class=\"w\">            </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">replicator</span><span class=\"p\">.</span><span class=\"n\">node</span>\n</span><span id=\"__span-6-47\"><a id=\"__codelineno-6-47\" name=\"__codelineno-6-47\" href=\"#__codelineno-6-47\"></a><span class=\"w\">            </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLFilter</span><span class=\"p\">(</span><span class=\"nc\">TLFilter</span><span class=\"p\">.</span><span class=\"n\">mSubtract</span><span class=\"p\">(</span><span class=\"n\">cohRegion</span><span class=\"p\">))</span>\n</span><span id=\"__span-6-48\"><a id=\"__codelineno-6-48\" name=\"__codelineno-6-48\" href=\"#__codelineno-6-48\"></a><span class=\"w\">            </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLFilter</span><span class=\"p\">(</span><span class=\"nc\">TLFilter</span><span class=\"p\">.</span><span class=\"n\">mResourceRemover</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-49\"><a id=\"__codelineno-6-49\" name=\"__codelineno-6-49\" href=\"#__codelineno-6-49\"></a><span class=\"w\">            </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">_</span>\n</span><span id=\"__span-6-50\"><a id=\"__codelineno-6-50\" name=\"__codelineno-6-50\" href=\"#__codelineno-6-50\"></a><span class=\"w\">          </span><span class=\"p\">)</span>\n</span><span id=\"__span-6-51\"><a id=\"__codelineno-6-51\" name=\"__codelineno-6-51\" href=\"#__codelineno-6-51\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-52\"><a id=\"__codelineno-6-52\" name=\"__codelineno-6-52\" href=\"#__codelineno-6-52\"></a><span class=\"w\">      </span><span class=\"p\">})</span>\n</span><span id=\"__span-6-53\"><a id=\"__codelineno-6-53\" name=\"__codelineno-6-53\" href=\"#__codelineno-6-53\"></a><span class=\"w\">    </span><span class=\"p\">})</span>\n</span><span id=\"__span-6-54\"><a id=\"__codelineno-6-54\" name=\"__codelineno-6-54\" href=\"#__codelineno-6-54\"></a>\n</span><span id=\"__span-6-55\"><a id=\"__codelineno-6-55\" name=\"__codelineno-6-55\" href=\"#__codelineno-6-55\"></a><span class=\"w\">    </span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">coupleTo</span><span class=\"p\">(</span><span class=\"s\">s&quot;memory_controller_port_named_</span><span class=\"si\">$</span><span class=\"n\">portName</span><span class=\"s\">&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-56\"><a id=\"__codelineno-6-56\" name=\"__codelineno-6-56\" href=\"#__codelineno-6-56\"></a><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">memAXI4Node</span>\n</span><span id=\"__span-6-57\"><a id=\"__codelineno-6-57\" name=\"__codelineno-6-57\" href=\"#__codelineno-6-57\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4UserYanker</span><span class=\"p\">()</span>\n</span><span id=\"__span-6-58\"><a id=\"__codelineno-6-58\" name=\"__codelineno-6-58\" href=\"#__codelineno-6-58\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4IdIndexer</span><span class=\"p\">(</span><span class=\"n\">idBits</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-59\"><a id=\"__codelineno-6-59\" name=\"__codelineno-6-59\" href=\"#__codelineno-6-59\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLToAXI4</span><span class=\"p\">()</span>\n</span><span id=\"__span-6-60\"><a id=\"__codelineno-6-60\" name=\"__codelineno-6-60\" href=\"#__codelineno-6-60\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLWidthWidget</span><span class=\"p\">(</span><span class=\"n\">mbus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-61\"><a id=\"__codelineno-6-61\" name=\"__codelineno-6-61\" href=\"#__codelineno-6-61\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mem_bypass_xbar</span>\n</span><span id=\"__span-6-62\"><a id=\"__codelineno-6-62\" name=\"__codelineno-6-62\" href=\"#__codelineno-6-62\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">_</span>\n</span><span id=\"__span-6-63\"><a id=\"__codelineno-6-63\" name=\"__codelineno-6-63\" href=\"#__codelineno-6-63\"></a><span class=\"w\">      </span><span class=\"p\">)</span>\n</span><span id=\"__span-6-64\"><a id=\"__codelineno-6-64\" name=\"__codelineno-6-64\" href=\"#__codelineno-6-64\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-65\"><a id=\"__codelineno-6-65\" name=\"__codelineno-6-65\" href=\"#__codelineno-6-65\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-66\"><a id=\"__codelineno-6-66\" name=\"__codelineno-6-66\" href=\"#__codelineno-6-66\"></a>\n</span><span id=\"__span-6-67\"><a id=\"__codelineno-6-67\" name=\"__codelineno-6-67\" href=\"#__codelineno-6-67\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">mem_axi4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">InModuleBody</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">memAXI4Node</span><span class=\"p\">.</span><span class=\"n\">makeIOs</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-68\"><a id=\"__codelineno-6-68\" name=\"__codelineno-6-68\" href=\"#__codelineno-6-68\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u7c7b\u4f3c\u5730\uff0c\u4e3a\u4e86\u8ba9\u5916\u90e8\u7684 AXI Master \u53ef\u4ee5\u8bbf\u95ee\u4e00\u81f4\u7684\u5185\u5b58\uff0c\u5728 fbus \u4e0a\u9762\u6dfb\u52a0\u4e86\u4ece axi \u5230 tl \u7684\u4e00\u6761\u8def\u5f84\uff0c\u800c fbus \u662f\u8fde\u5230 sbus \u4e0a\u7684\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"cm\">/** Adds an AXI4 port to the system intended to be a slave on an MMIO device bus */</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"nc\">CanHaveSlaveAXI4Port</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">BaseSubsystem</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">slavePortParamsOpt</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">ExtIn</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">portName</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">&quot;slave_port_axi4&quot;</span>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">fifoBits</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">fbus</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tlBusWrapperLocationMap</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nc\">FBUS</span><span class=\"p\">).</span><span class=\"n\">getOrElse</span><span class=\"p\">(</span><span class=\"n\">viewpointBus</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">l2FrontendAXI4Node</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">AXI4MasterNode</span><span class=\"p\">(</span>\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a><span class=\"w\">    </span><span class=\"n\">slavePortParamsOpt</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"w\">      </span><span class=\"nc\">AXI4MasterPortParameters</span><span class=\"p\">(</span>\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"w\">        </span><span class=\"n\">masters</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">(</span><span class=\"nc\">AXI4MasterParameters</span><span class=\"p\">(</span>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a><span class=\"w\">          </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">portName</span><span class=\"p\">.</span><span class=\"n\">kebab</span><span class=\"p\">,</span>\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a><span class=\"w\">          </span><span class=\"n\">id</span><span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">IdRange</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">idBits</span><span class=\"p\">))))).</span><span class=\"n\">toSeq</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-14\"><a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\" href=\"#__codelineno-7-14\"></a>\n</span><span id=\"__span-7-15\"><a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\" href=\"#__codelineno-7-15\"></a><span class=\"w\">  </span><span class=\"n\">slavePortParamsOpt</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-7-16\"><a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\" href=\"#__codelineno-7-16\"></a><span class=\"w\">    </span><span class=\"n\">fbus</span><span class=\"p\">.</span><span class=\"n\">coupleFrom</span><span class=\"p\">(</span><span class=\"s\">s&quot;port_named_</span><span class=\"si\">$</span><span class=\"n\">portName</span><span class=\"s\">&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-7-17\"><a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\" href=\"#__codelineno-7-17\"></a><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"n\">_</span>\n</span><span id=\"__span-7-18\"><a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\" href=\"#__codelineno-7-18\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLBuffer</span><span class=\"p\">(</span><span class=\"nc\">BufferParams</span><span class=\"p\">.</span><span class=\"n\">default</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-19\"><a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\" href=\"#__codelineno-7-19\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLFIFOFixer</span><span class=\"p\">(</span><span class=\"nc\">TLFIFOFixer</span><span class=\"p\">.</span><span class=\"n\">all</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-20\"><a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\" href=\"#__codelineno-7-20\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLWidthWidget</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-21\"><a id=\"__codelineno-7-21\" name=\"__codelineno-7-21\" href=\"#__codelineno-7-21\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4ToTL</span><span class=\"p\">()</span>\n</span><span id=\"__span-7-22\"><a id=\"__codelineno-7-22\" name=\"__codelineno-7-22\" href=\"#__codelineno-7-22\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4UserYanker</span><span class=\"p\">(</span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"n\">sourceBits</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">fifoBits</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)))</span>\n</span><span id=\"__span-7-23\"><a id=\"__codelineno-7-23\" name=\"__codelineno-7-23\" href=\"#__codelineno-7-23\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4Fragmenter</span><span class=\"p\">()</span>\n</span><span id=\"__span-7-24\"><a id=\"__codelineno-7-24\" name=\"__codelineno-7-24\" href=\"#__codelineno-7-24\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">AXI4IdIndexer</span><span class=\"p\">(</span><span class=\"n\">fifoBits</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-25\"><a id=\"__codelineno-7-25\" name=\"__codelineno-7-25\" href=\"#__codelineno-7-25\"></a><span class=\"w\">        </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l2FrontendAXI4Node</span><span class=\"w\"> </span><span class=\"p\">)</span>\n</span><span id=\"__span-7-26\"><a id=\"__codelineno-7-26\" name=\"__codelineno-7-26\" href=\"#__codelineno-7-26\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-7-27\"><a id=\"__codelineno-7-27\" name=\"__codelineno-7-27\" href=\"#__codelineno-7-27\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-7-28\"><a id=\"__codelineno-7-28\" name=\"__codelineno-7-28\" href=\"#__codelineno-7-28\"></a>\n</span><span id=\"__span-7-29\"><a id=\"__codelineno-7-29\" name=\"__codelineno-7-29\" href=\"#__codelineno-7-29\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">l2_frontend_bus_axi4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">InModuleBody</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">l2FrontendAXI4Node</span><span class=\"p\">.</span><span class=\"n\">makeIOs</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-7-30\"><a id=\"__codelineno-7-30\" name=\"__codelineno-7-30\" href=\"#__codelineno-7-30\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-7-31\"><a id=\"__codelineno-7-31\" name=\"__codelineno-7-31\" href=\"#__codelineno-7-31\"></a>\n</span><span id=\"__span-7-32\"><a id=\"__codelineno-7-32\" name=\"__codelineno-7-32\" href=\"#__codelineno-7-32\"></a><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalBusTopologyParams</span><span class=\"p\">(</span>\n</span><span id=\"__span-7-33\"><a id=\"__codelineno-7-33\" name=\"__codelineno-7-33\" href=\"#__codelineno-7-33\"></a><span class=\"w\">  </span><span class=\"n\">pbus</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PeripheryBusParams</span><span class=\"p\">,</span>\n</span><span id=\"__span-7-34\"><a id=\"__codelineno-7-34\" name=\"__codelineno-7-34\" href=\"#__codelineno-7-34\"></a><span class=\"w\">  </span><span class=\"n\">fbus</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">FrontBusParams</span><span class=\"p\">,</span>\n</span><span id=\"__span-7-35\"><a id=\"__codelineno-7-35\" name=\"__codelineno-7-35\" href=\"#__codelineno-7-35\"></a><span class=\"w\">  </span><span class=\"n\">cbus</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PeripheryBusParams</span><span class=\"p\">,</span>\n</span><span id=\"__span-7-36\"><a id=\"__codelineno-7-36\" name=\"__codelineno-7-36\" href=\"#__codelineno-7-36\"></a><span class=\"w\">  </span><span class=\"n\">xTypes</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">SubsystemCrossingParams</span><span class=\"p\">,</span>\n</span><span id=\"__span-7-37\"><a id=\"__codelineno-7-37\" name=\"__codelineno-7-37\" href=\"#__codelineno-7-37\"></a><span class=\"w\">  </span><span class=\"n\">driveClocksFromSBus</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Boolean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span>\n</span><span id=\"__span-7-38\"><a id=\"__codelineno-7-38\" name=\"__codelineno-7-38\" href=\"#__codelineno-7-38\"></a><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperTopology</span><span class=\"p\">(</span>\n</span><span id=\"__span-7-39\"><a id=\"__codelineno-7-39\" name=\"__codelineno-7-39\" href=\"#__codelineno-7-39\"></a><span class=\"w\">  </span><span class=\"n\">instantiations</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">List</span><span class=\"p\">(</span>\n</span><span id=\"__span-7-40\"><a id=\"__codelineno-7-40\" name=\"__codelineno-7-40\" href=\"#__codelineno-7-40\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">PBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pbus</span><span class=\"p\">),</span>\n</span><span id=\"__span-7-41\"><a id=\"__codelineno-7-41\" name=\"__codelineno-7-41\" href=\"#__codelineno-7-41\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">FBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fbus</span><span class=\"p\">),</span>\n</span><span id=\"__span-7-42\"><a id=\"__codelineno-7-42\" name=\"__codelineno-7-42\" href=\"#__codelineno-7-42\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">CBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cbus</span><span class=\"p\">)),</span>\n</span><span id=\"__span-7-43\"><a id=\"__codelineno-7-43\" name=\"__codelineno-7-43\" href=\"#__codelineno-7-43\"></a><span class=\"w\">  </span><span class=\"n\">connections</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">List</span><span class=\"p\">(</span>\n</span><span id=\"__span-7-44\"><a id=\"__codelineno-7-44\" name=\"__codelineno-7-44\" href=\"#__codelineno-7-44\"></a><span class=\"w\">    </span><span class=\"c1\">// (master, slave, params)</span>\n</span><span id=\"__span-7-45\"><a id=\"__codelineno-7-45\" name=\"__codelineno-7-45\" href=\"#__codelineno-7-45\"></a><span class=\"w\">    </span><span class=\"c1\">// cbus := sbus</span>\n</span><span id=\"__span-7-46\"><a id=\"__codelineno-7-46\" name=\"__codelineno-7-46\" href=\"#__codelineno-7-46\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">SBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">CBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">crossTo</span><span class=\"p\">(</span><span class=\"n\">xTypes</span><span class=\"p\">.</span><span class=\"n\">sbusToCbusXType</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveClocksFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">)),</span>\n</span><span id=\"__span-7-47\"><a id=\"__codelineno-7-47\" name=\"__codelineno-7-47\" href=\"#__codelineno-7-47\"></a><span class=\"w\">    </span><span class=\"c1\">// pbus := cbus</span>\n</span><span id=\"__span-7-48\"><a id=\"__codelineno-7-48\" name=\"__codelineno-7-48\" href=\"#__codelineno-7-48\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">CBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">PBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">crossTo</span><span class=\"p\">(</span><span class=\"n\">xTypes</span><span class=\"p\">.</span><span class=\"n\">cbusToPbusXType</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveClocksFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">)),</span>\n</span><span id=\"__span-7-49\"><a id=\"__codelineno-7-49\" name=\"__codelineno-7-49\" href=\"#__codelineno-7-49\"></a><span class=\"w\">    </span><span class=\"c1\">// sbus := fbus</span>\n</span><span id=\"__span-7-50\"><a id=\"__codelineno-7-50\" name=\"__codelineno-7-50\" href=\"#__codelineno-7-50\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nc\">FBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">SBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"p\">.</span><span class=\"n\">crossFrom</span><span class=\"p\">(</span><span class=\"n\">xTypes</span><span class=\"p\">.</span><span class=\"n\">fbusToSbusXType</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveClocksFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">)))</span>\n</span><span id=\"__span-7-51\"><a id=\"__codelineno-7-51\" name=\"__codelineno-7-51\" href=\"#__codelineno-7-51\"></a><span class=\"p\">)</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u4e0a\u4e00\u6bb5\u4ee3\u7801\u4e2d\uff0c\u5728 sbus \u7684\u4e0b\u6e38\u6302\u8f7d\u4e86 cbus\uff0c\u5728 cbus \u4e0b\u6e38\u6302\u8f7d\u4e86 pbus\uff1b\u90a3\u4e48 debug/plic/clint \u7b49\u8bbe\u5907\u90fd\u662f\u6302\u8f7d\u5728 cbus \u4e0b\u7684\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"c1\">// in HasPeripheryDebug of Periphery.scala</span>\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"c1\">// default to cbus</span>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"k\">lazy</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">locateTLBusWrapper</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">ExportDebug</span><span class=\"p\">).</span><span class=\"n\">slaveWhere</span><span class=\"p\">)</span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">tlDM</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">TLDebugModule</span><span class=\"p\">(</span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">))</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"n\">tlDM</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">coupleTo</span><span class=\"p\">(</span><span class=\"s\">&quot;debug&quot;</span><span class=\"p\">){</span><span class=\"w\"> </span><span class=\"nc\">TLFragmenter</span><span class=\"p\">(</span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">blockBytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nameSuffix</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"s\">&quot;Debug&quot;</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nc\">TLBuffer</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"c1\">// in CanHavePeripheryCLINT of CLINT.scala</span>\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"c1\">// default to cbus</span>\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">locateTLBusWrapper</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">CLINTAttachKey</span><span class=\"p\">).</span><span class=\"n\">slaveWhere</span><span class=\"p\">)</span>\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clintDomainWrapper</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">generateSynchronousDomain</span><span class=\"p\">(</span><span class=\"s\">&quot;CLINT&quot;</span><span class=\"p\">).</span><span class=\"n\">suggestName</span><span class=\"p\">(</span><span class=\"s\">&quot;clint_domain&quot;</span><span class=\"p\">)</span>\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clint</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">clintDomainWrapper</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">CLINT</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a><span class=\"n\">clintDomainWrapper</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">clint</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">coupleTo</span><span class=\"p\">(</span><span class=\"s\">&quot;clint&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nc\">TLFragmenter</span><span class=\"p\">(</span><span class=\"n\">tlbus</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"s\">&quot;CLINT&quot;</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a><span class=\"c1\">// in CanHavePeripheryPLIC of Plic.scala</span>\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a><span class=\"c1\">// default to cbus</span>\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">locateTLBusWrapper</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">PLICAttachKey</span><span class=\"p\">).</span><span class=\"n\">slaveWhere</span><span class=\"p\">)</span>\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">plicDomainWrapper</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">generateSynchronousDomain</span><span class=\"p\">(</span><span class=\"s\">&quot;PLIC&quot;</span><span class=\"p\">).</span><span class=\"n\">suggestName</span><span class=\"p\">(</span><span class=\"s\">&quot;plic_domain&quot;</span><span class=\"p\">)</span>\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">plic</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">plicDomainWrapper</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">TLPLIC</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">beatBytes</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a><span class=\"n\">plicDomainWrapper</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">plic</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tlbus</span><span class=\"p\">.</span><span class=\"n\">coupleTo</span><span class=\"p\">(</span><span class=\"s\">&quot;plic&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nc\">TLFragmenter</span><span class=\"p\">(</span><span class=\"n\">tlbus</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"s\">&quot;PLIC&quot;</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a><span class=\"n\">plicDomainWrapper</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">plic</span><span class=\"p\">.</span><span class=\"n\">intnode</span><span class=\"w\"> </span><span class=\"o\">:=*</span><span class=\"w\"> </span><span class=\"n\">ibus</span><span class=\"p\">.</span><span class=\"n\">toPLIC</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n</ol>\n<p>\u81f3\u6b64\u5c31\u628a\u524d\u9762\u63d0\u5230\u7684 Rocket Chip \u7684\u603b\u7ebf\u7ed3\u6784\u5728\u6e90\u7801\u4e2d\u7684\u5bf9\u5e94\u5173\u7cfb\u90fd\u627e\u5230\u4e86\u3002</p>\n<p>\u9664\u4e86\u8fd9\u4e00\u7ec4\u5927\u7684\u603b\u7ebf\u7ed3\u6784\uff0c\u5b9e\u9645\u4e0a\u8c03\u8bd5\u6a21\u5757\u5185\u90e8\u8fd8\u6709\u4e00\u4e2a\u5c0f\u7684\u603b\u7ebf\uff0c\u4e3b\u8981\u662f\u628a RISC-V Debug \u7684 DMI \u8f6c\u5316\u4e3a TileLink\uff0c\u7136\u540e\u8bbf\u95ee\u5185\u90e8\u7684\u4e00\u4e9b\u5bc4\u5b58\u5668\u3002</p>\n<h3 id=\"\u4e2d\u65ad\">\u4e2d\u65ad<a class=\"headerlink\" href=\"#\u4e2d\u65ad\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9664\u4e86\u603b\u7ebf\uff0c\u4e2d\u65ad\u4e5f\u662f\u901a\u8fc7 Diplomacy \u7ba1\u7406\u7684\u3002\u9996\u5148\u53ef\u4ee5\u770b\u5230\uff0c\u6bcf\u4e2a Tile \u6709\u4e00\u4e2a\u4e2d\u65ad\u7684 SinkNode\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"c1\">// Use diplomatic interrupts to external interrupts from the subsystem into the tile</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"nc\">SinksExternalInterrupts</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">BaseTile</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">intInwardNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">intXbar</span><span class=\"p\">.</span><span class=\"n\">intnode</span><span class=\"w\"> </span><span class=\"o\">:=*</span><span class=\"w\"> </span><span class=\"nc\">IntIdentityNode</span><span class=\"p\">()(</span><span class=\"nc\">ValName</span><span class=\"p\">(</span><span class=\"s\">&quot;int_local&quot;</span><span class=\"p\">))</span>\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"w\">  </span><span class=\"k\">protected</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">intSinkNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">IntSinkNode</span><span class=\"p\">(</span><span class=\"nc\">IntSinkPortSimple</span><span class=\"p\">())</span>\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"w\">  </span><span class=\"n\">intSinkNode</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">intXbar</span><span class=\"p\">.</span><span class=\"n\">intnode</span>\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a>\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a><span class=\"w\">  </span><span class=\"c1\">// go from flat diplomatic Interrupts to bundled TileInterrupts</span>\n</span><span id=\"__span-9-8\"><a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\" href=\"#__codelineno-9-8\"></a><span class=\"w\">  </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">decodeCoreInterrupts</span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">TileInterrupts</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">Unit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-9-9\"><a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\" href=\"#__codelineno-9-9\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">async_ips</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">debug</span><span class=\"p\">)</span>\n</span><span id=\"__span-9-10\"><a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\" href=\"#__codelineno-9-10\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">periph_ips</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">(</span>\n</span><span id=\"__span-9-11\"><a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\" href=\"#__codelineno-9-11\"></a><span class=\"w\">      </span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">msip</span><span class=\"p\">,</span>\n</span><span id=\"__span-9-12\"><a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\" href=\"#__codelineno-9-12\"></a><span class=\"w\">      </span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">mtip</span><span class=\"p\">,</span>\n</span><span id=\"__span-9-13\"><a id=\"__codelineno-9-13\" name=\"__codelineno-9-13\" href=\"#__codelineno-9-13\"></a><span class=\"w\">      </span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">meip</span><span class=\"p\">)</span>\n</span><span id=\"__span-9-14\"><a id=\"__codelineno-9-14\" name=\"__codelineno-9-14\" href=\"#__codelineno-9-14\"></a>\n</span><span id=\"__span-9-15\"><a id=\"__codelineno-9-15\" name=\"__codelineno-9-15\" href=\"#__codelineno-9-15\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">seip</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">seip</span><span class=\"p\">.</span><span class=\"n\">isDefined</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Seq</span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">seip</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">Nil</span>\n</span><span id=\"__span-9-16\"><a id=\"__codelineno-9-16\" name=\"__codelineno-9-16\" href=\"#__codelineno-9-16\"></a>\n</span><span id=\"__span-9-17\"><a id=\"__codelineno-9-17\" name=\"__codelineno-9-17\" href=\"#__codelineno-9-17\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">core_ips</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">lip</span>\n</span><span id=\"__span-9-18\"><a id=\"__codelineno-9-18\" name=\"__codelineno-9-18\" href=\"#__codelineno-9-18\"></a>\n</span><span id=\"__span-9-19\"><a id=\"__codelineno-9-19\" name=\"__codelineno-9-19\" href=\"#__codelineno-9-19\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">interrupts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">intSinkNode</span><span class=\"p\">.</span><span class=\"n\">in</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-9-20\"><a id=\"__codelineno-9-20\" name=\"__codelineno-9-20\" href=\"#__codelineno-9-20\"></a><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">async_ips</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"n\">periph_ips</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"n\">seip</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"n\">core_ips</span><span class=\"p\">).</span><span class=\"n\">zip</span><span class=\"p\">(</span><span class=\"n\">interrupts</span><span class=\"p\">).</span><span class=\"n\">foreach</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-9-21\"><a id=\"__codelineno-9-21\" name=\"__codelineno-9-21\" href=\"#__codelineno-9-21\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-9-22\"><a id=\"__codelineno-9-22\" name=\"__codelineno-9-22\" href=\"#__codelineno-9-22\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-9-23\"><a id=\"__codelineno-9-23\" name=\"__codelineno-9-23\" href=\"#__codelineno-9-23\"></a>\n</span><span id=\"__span-9-24\"><a id=\"__codelineno-9-24\" name=\"__codelineno-9-24\" href=\"#__codelineno-9-24\"></a><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">TileInterrupts</span><span class=\"p\">(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">CoreBundle</span><span class=\"p\">()(</span><span class=\"n\">p</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-9-25\"><a id=\"__codelineno-9-25\" name=\"__codelineno-9-25\" href=\"#__codelineno-9-25\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Bool</span><span class=\"p\">()</span>\n</span><span id=\"__span-9-26\"><a id=\"__codelineno-9-26\" name=\"__codelineno-9-26\" href=\"#__codelineno-9-26\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">mtip</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Bool</span><span class=\"p\">()</span>\n</span><span id=\"__span-9-27\"><a id=\"__codelineno-9-27\" name=\"__codelineno-9-27\" href=\"#__codelineno-9-27\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">msip</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Bool</span><span class=\"p\">()</span>\n</span><span id=\"__span-9-28\"><a id=\"__codelineno-9-28\" name=\"__codelineno-9-28\" href=\"#__codelineno-9-28\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">meip</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Bool</span><span class=\"p\">()</span>\n</span><span id=\"__span-9-29\"><a id=\"__codelineno-9-29\" name=\"__codelineno-9-29\" href=\"#__codelineno-9-29\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">seip</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">usingSupervisor</span><span class=\"p\">.</span><span class=\"n\">option</span><span class=\"p\">(</span><span class=\"nc\">Bool</span><span class=\"p\">())</span>\n</span><span id=\"__span-9-30\"><a id=\"__codelineno-9-30\" name=\"__codelineno-9-30\" href=\"#__codelineno-9-30\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">lip</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Vec</span><span class=\"p\">(</span><span class=\"n\">coreParams</span><span class=\"p\">.</span><span class=\"n\">nLocalInterrupts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">Bool</span><span class=\"p\">())</span>\n</span><span id=\"__span-9-31\"><a id=\"__codelineno-9-31\" name=\"__codelineno-9-31\" href=\"#__codelineno-9-31\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">nmi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">usingNMI</span><span class=\"p\">.</span><span class=\"n\">option</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">NMI</span><span class=\"p\">(</span><span class=\"n\">resetVectorLen</span><span class=\"p\">))</span>\n</span><span id=\"__span-9-32\"><a id=\"__codelineno-9-32\" name=\"__codelineno-9-32\" href=\"#__codelineno-9-32\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u901a\u8fc7 Diplomacy \u7684 intXbar \u8f93\u5165\u591a\u8def\u7684\u4e2d\u65ad\uff0c\u7136\u540e\u6309\u7167\u987a\u5e8f\uff0c\u8fd8\u539f\u51fa\u5bf9\u5e94\u7684 debug/mtip/msip/seip \u7b49\u4e2d\u65ad\u4fe1\u53f7\u3002\u4ece\u524d\u9762\u7684\u56fe\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u770b\u5230 intXbar \u7684\u7b2c\u4e00\u4e2a\u8f93\u5165 debug\uff08\u7ecf\u8fc7 intsink\uff09\u6765\u81ea dmOuter \u4e5f\u5c31\u662f\u8c03\u8bd5\u6a21\u5757\uff0c\u7b2c\u4e8c\u4e2a\u548c\u7b2c\u4e09\u4e2a\u8f93\u5165 msip \u548c mtip\uff08\u7ecf\u8fc7 intsink_1\uff09\u6765\u81ea clint\uff08\u8d1f\u8d23\u65f6\u949f mtimer \u548c\u8f6f\u4ef6\u4e2d\u65ad\uff09\uff0c\u6700\u540e\u7684 meip \u548c seip\uff08\u7ecf\u8fc7 intsink_2/3\uff09\u6765\u81ea plic\uff08\u8d1f\u8d23\u5916\u90e8\u4e2d\u65ad\uff09\u3002\u4e3a\u4e86\u5904\u7406\u5916\u90e8\u4e2d\u65ad\uff0c\u4ece\u5916\u9762\u63a5\u4e86 6 \u4f4d\u7684\u4e2d\u65ad\u4fe1\u53f7\u5230 plic\u3002</p>\n<h3 id=\"\u65f6\u949f\">\u65f6\u949f<a class=\"headerlink\" href=\"#\u65f6\u949f\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6700\u540e\uff0c\u65f6\u949f\uff08\u65f6\u949f\u52a0\u4e0a\u590d\u4f4d\uff09\u4e5f\u662f\u7531 Diplomacy \u7ba1\u7406\u7684\uff1a\u4ece\u524d\u9762\u7684\u56fe\u4e2d\uff0c\u4ece aggregator \u8fdb\u6765\uff0c\u9996\u5148\u5230 sbus\uff0c\u7136\u540e\u5206\u51fa\u6765\u591a\u8def\u7684\u65f6\u949f\u4fe1\u53f7\uff1a\u7b2c\u4e00\u8def\u5230 cbus\uff0c\u7528\u4e8e cbus \u7684\u5404\u4e2a\u5916\u8bbe\uff08plic/clint \u7b49\uff09\uff0c\u8fdb\u4e00\u6b65\u4e5f\u4ece cbus \u5f15\u5230 pbus\uff1b\u7b2c\u4e8c\u8def\u5230\u5404\u4e2a tile\uff1b\u7b2c\u4e09\u8def\u5230 coh\uff08coherence wrapper\uff09\uff1b\u7b2c\u56db\u8def\u5230 fbus\u3002\u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u8fd9\u4e9b\u65f6\u949f\u90fd\u662f\u540c\u4e00\u4e2a\u4fe1\u53f7\uff0c\u6ca1\u6709\u989d\u5916\u7684\u5904\u7406\uff0c\u4f46\u662f\u901a\u8fc7\u914d\u7f6e\uff0c\u53ef\u4ee5\u628a\u5b83\u4eec\u533a\u5206\u5f00\uff0c\u653e\u5230\u4e0d\u540c\u7684\u65f6\u949f\u57df\uff0c\u5e76\u5728\u8de8\u65f6\u949f\u57df\u7684\u65f6\u5019\uff0c\u6dfb\u52a0\u5408\u9002\u7684\u8de8\u65f6\u949f\u57df\u7684\u5904\u7406\u3002</p>\n<p>\u90a3\u4e48\u8fd9\u4e9b\u65f6\u949f\u662f\u600e\u4e48\u5206\u51fa\u6765\u7684\u5462\uff1a</p>\n<ol>\n<li>\n<p>aggregator \u628a\u65f6\u949f\u66b4\u9732\u5230 IO \u4e0a\uff0c\u7136\u540e\u5185\u90e8\u66b4\u9732\u4e00\u4e2a allClockGroupsNode\uff0c\u8fde\u63a5\u5230 sbus \u4e0a\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"c1\">// in BaseSubsystem.scala</span>\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"nc\">HasConfigurablePRCILocations</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"bp\">this</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HasPRCILocations</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">ibus</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">InterruptBusWrapper</span><span class=\"p\">)</span>\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">allClockGroupsNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">ClockGroupIdentityNode</span><span class=\"p\">()</span>\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">io_clocks</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">(</span><span class=\"nc\">SubsystemDriveClockGroupsFromIO</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-10-6\"><a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\" href=\"#__codelineno-10-6\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">aggregator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">ClockGroupAggregator</span><span class=\"p\">()</span>\n</span><span id=\"__span-10-7\"><a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\" href=\"#__codelineno-10-7\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">ClockGroupSourceNode</span><span class=\"p\">(</span><span class=\"nc\">Seq</span><span class=\"p\">(</span><span class=\"nc\">ClockGroupSourceParameters</span><span class=\"p\">()))</span>\n</span><span id=\"__span-10-8\"><a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\" href=\"#__codelineno-10-8\"></a><span class=\"w\">    </span><span class=\"n\">allClockGroupsNode</span><span class=\"w\"> </span><span class=\"o\">:*=</span><span class=\"w\"> </span><span class=\"n\">aggregator</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">source</span>\n</span><span id=\"__span-10-9\"><a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\" href=\"#__codelineno-10-9\"></a><span class=\"w\">    </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"nc\">InModuleBody</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-10-10\"><a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\" href=\"#__codelineno-10-10\"></a><span class=\"w\">      </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">elements</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">out</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">.</span><span class=\"n\">_1</span><span class=\"p\">.</span><span class=\"n\">member</span><span class=\"p\">.</span><span class=\"n\">elements</span><span class=\"p\">).</span><span class=\"n\">flatten</span>\n</span><span id=\"__span-10-11\"><a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\" href=\"#__codelineno-10-11\"></a><span class=\"w\">      </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">io</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">IO</span><span class=\"p\">(</span><span class=\"nc\">Flipped</span><span class=\"p\">(</span><span class=\"nc\">RecordMap</span><span class=\"p\">(</span><span class=\"n\">elements</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span>\n</span><span id=\"__span-10-12\"><a id=\"__codelineno-10-12\" name=\"__codelineno-10-12\" href=\"#__codelineno-10-12\"></a><span class=\"w\">        </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">cloneType</span>\n</span><span id=\"__span-10-13\"><a id=\"__codelineno-10-13\" name=\"__codelineno-10-13\" href=\"#__codelineno-10-13\"></a><span class=\"w\">      </span><span class=\"p\">}:</span><span class=\"n\">_*</span><span class=\"p\">)))</span>\n</span><span id=\"__span-10-14\"><a id=\"__codelineno-10-14\" name=\"__codelineno-10-14\" href=\"#__codelineno-10-14\"></a><span class=\"w\">      </span><span class=\"n\">elements</span><span class=\"p\">.</span><span class=\"n\">foreach</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">io</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">).</span><span class=\"n\">foreach</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-10-15\"><a id=\"__codelineno-10-15\" name=\"__codelineno-10-15\" href=\"#__codelineno-10-15\"></a><span class=\"w\">      </span><span class=\"n\">io</span>\n</span><span id=\"__span-10-16\"><a id=\"__codelineno-10-16\" name=\"__codelineno-10-16\" href=\"#__codelineno-10-16\"></a><span class=\"w\">    </span><span class=\"p\">})</span>\n</span><span id=\"__span-10-17\"><a id=\"__codelineno-10-17\" name=\"__codelineno-10-17\" href=\"#__codelineno-10-17\"></a><span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-10-18\"><a id=\"__codelineno-10-18\" name=\"__codelineno-10-18\" href=\"#__codelineno-10-18\"></a><span class=\"w\">    </span><span class=\"nc\">None</span>\n</span><span id=\"__span-10-19\"><a id=\"__codelineno-10-19\" name=\"__codelineno-10-19\" href=\"#__codelineno-10-19\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-10-20\"><a id=\"__codelineno-10-20\" name=\"__codelineno-10-20\" href=\"#__codelineno-10-20\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-10-21\"><a id=\"__codelineno-10-21\" name=\"__codelineno-10-21\" href=\"#__codelineno-10-21\"></a>\n</span><span id=\"__span-10-22\"><a id=\"__codelineno-10-22\" name=\"__codelineno-10-22\" href=\"#__codelineno-10-22\"></a><span class=\"k\">abstract</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">BaseSubsystem</span><span class=\"p\">(</span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">location</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HierarchicalLocation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">InSubsystem</span><span class=\"p\">)</span>\n</span><span id=\"__span-10-23\"><a id=\"__codelineno-10-23\" name=\"__codelineno-10-23\" href=\"#__codelineno-10-23\"></a><span class=\"w\">                            </span><span class=\"p\">(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">)</span>\n</span><span id=\"__span-10-24\"><a id=\"__codelineno-10-24\" name=\"__codelineno-10-24\" href=\"#__codelineno-10-24\"></a><span class=\"w\">  </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">BareSubsystem</span>\n</span><span id=\"__span-10-25\"><a id=\"__codelineno-10-25\" name=\"__codelineno-10-25\" href=\"#__codelineno-10-25\"></a><span class=\"w\">  </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">HasDTS</span>\n</span><span id=\"__span-10-26\"><a id=\"__codelineno-10-26\" name=\"__codelineno-10-26\" href=\"#__codelineno-10-26\"></a><span class=\"w\">  </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">Attachable</span>\n</span><span id=\"__span-10-27\"><a id=\"__codelineno-10-27\" name=\"__codelineno-10-27\" href=\"#__codelineno-10-27\"></a><span class=\"w\">  </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">HasConfigurablePRCILocations</span>\n</span><span id=\"__span-10-28\"><a id=\"__codelineno-10-28\" name=\"__codelineno-10-28\" href=\"#__codelineno-10-28\"></a><span class=\"w\">  </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">HasConfigurableTLNetworkTopology</span>\n</span><span id=\"__span-10-29\"><a id=\"__codelineno-10-29\" name=\"__codelineno-10-29\" href=\"#__codelineno-10-29\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-10-30\"><a id=\"__codelineno-10-30\" name=\"__codelineno-10-30\" href=\"#__codelineno-10-30\"></a>\n</span><span id=\"__span-10-31\"><a id=\"__codelineno-10-31\" name=\"__codelineno-10-31\" href=\"#__codelineno-10-31\"></a><span class=\"w\">  </span><span class=\"c1\">// viewpointBus points to sbus by default</span>\n</span><span id=\"__span-10-32\"><a id=\"__codelineno-10-32\" name=\"__codelineno-10-32\" href=\"#__codelineno-10-32\"></a><span class=\"w\">  </span><span class=\"n\">viewpointBus</span><span class=\"p\">.</span><span class=\"n\">clockGroupNode</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">allClockGroupsNode</span>\n</span><span id=\"__span-10-33\"><a id=\"__codelineno-10-33\" name=\"__codelineno-10-33\" href=\"#__codelineno-10-33\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u524d\u9762\u63d0\u5230\uff0c\u901a\u8fc7 CoherentBusTopologyParams\uff0c\u5b9e\u73b0 <code>mbus := coh := sbus</code> \u7684\u8fde\u63a5\uff0c\u901a\u8fc7 HierarchicalBusTopologyParams\uff0c\u5b9e\u73b0 <code>pbus := cbus := sbus := fbus</code> \u7684\u8fde\u63a5\uff0c\u4e0e\u6b64\u540c\u65f6\uff0c\u65f6\u949f\u4e5f\u88ab\u63a5\u4e0a\u4e86\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a><span class=\"c1\">// in BusTopology.scala</span>\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a><span class=\"c1\">// (master, slave, parameters)</span>\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"c1\">// from CoherentBusTopologyParams</span>\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"c1\">// coh := sbus, use sbus&#39;s clock for coh</span>\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"p\">(</span><span class=\"nc\">SBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">COH</span><span class=\"p\">,</span><span class=\"w\">   </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"p\">(</span><span class=\"n\">driveClockFromMaster</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">nodeBinding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">BIND_STAR</span><span class=\"p\">)()),</span>\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"c1\">// mbus := coh, use coh&#39;s clock for mbus by default</span>\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"p\">(</span><span class=\"nc\">COH</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"nc\">MBUS</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"p\">.</span><span class=\"n\">crossTo</span><span class=\"p\">(</span>\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">  </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sbusToMbusXType</span><span class=\"p\">,</span>\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">  </span><span class=\"n\">driveClockFromMaster</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveMBusClockFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">,</span>\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a><span class=\"w\">  </span><span class=\"n\">nodeBinding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">BIND_QUERY</span><span class=\"p\">))</span>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a>\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"c1\">// from HierarchicalBusTopologyParams</span>\n</span><span id=\"__span-11-13\"><a id=\"__codelineno-11-13\" name=\"__codelineno-11-13\" href=\"#__codelineno-11-13\"></a><span class=\"c1\">// cbus := sbus, use sbus&#39;s clock for cbus by default</span>\n</span><span id=\"__span-11-14\"><a id=\"__codelineno-11-14\" name=\"__codelineno-11-14\" href=\"#__codelineno-11-14\"></a><span class=\"p\">(</span><span class=\"nc\">SBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">CBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">crossTo</span><span class=\"p\">(</span><span class=\"n\">xTypes</span><span class=\"p\">.</span><span class=\"n\">sbusToCbusXType</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveClocksFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">)),</span>\n</span><span id=\"__span-11-15\"><a id=\"__codelineno-11-15\" name=\"__codelineno-11-15\" href=\"#__codelineno-11-15\"></a><span class=\"c1\">// pbus := cbus, use cbus&#39;s clock for pbus by default</span>\n</span><span id=\"__span-11-16\"><a id=\"__codelineno-11-16\" name=\"__codelineno-11-16\" href=\"#__codelineno-11-16\"></a><span class=\"p\">(</span><span class=\"nc\">CBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">PBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">crossTo</span><span class=\"p\">(</span><span class=\"n\">xTypes</span><span class=\"p\">.</span><span class=\"n\">cbusToPbusXType</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveClocksFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">)),</span>\n</span><span id=\"__span-11-17\"><a id=\"__codelineno-11-17\" name=\"__codelineno-11-17\" href=\"#__codelineno-11-17\"></a><span class=\"c1\">// sbus := fbus, use sbus&#39;s clock for fbus by default</span>\n</span><span id=\"__span-11-18\"><a id=\"__codelineno-11-18\" name=\"__codelineno-11-18\" href=\"#__codelineno-11-18\"></a><span class=\"p\">(</span><span class=\"nc\">FBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">SBUS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapperConnection</span><span class=\"p\">.</span><span class=\"n\">crossFrom</span><span class=\"p\">(</span><span class=\"n\">xTypes</span><span class=\"p\">.</span><span class=\"n\">fbusToSbusXType</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">driveClocksFromSBus</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nc\">None</span><span class=\"p\">)))</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u5177\u4f53\u5730\uff0c\u6bcf\u4e2a bus \u6709\u4e00\u4e2a\u81ea\u5df1\u7684 clockGroupNode\uff0cbus \u4e4b\u95f4\u7684 clockGroupNode \u6309\u7167\u4e0a\u9762\u6240\u5c5e\u7684\u65b9\u5f0f\u8fde\u63a5\uff0c\u7136\u540e bus \u4e0b\u9762\u7684\u8bbe\u5907\u518d\u6302\u5230 fixedClockNode \u4e0b\u9762\uff1a</p>\n<div class=\"language-scala highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a><span class=\"k\">abstract</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">TLBusWrapper</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HasTLBusParams</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">busName</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">String</span><span class=\"p\">)(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">)</span>\n</span><span id=\"__span-12-2\"><a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\" href=\"#__codelineno-12-2\"></a><span class=\"w\">    </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">ClockDomain</span>\n</span><span id=\"__span-12-3\"><a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\" href=\"#__codelineno-12-3\"></a><span class=\"w\">    </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">HasTLBusParams</span>\n</span><span id=\"__span-12-4\"><a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\" href=\"#__codelineno-12-4\"></a><span class=\"w\">    </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">CanHaveBuiltInDevices</span>\n</span><span id=\"__span-12-5\"><a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\" href=\"#__codelineno-12-5\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-12-6\"><a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\" href=\"#__codelineno-12-6\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clockGroupAggregator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">ClockGroupAggregator</span><span class=\"p\">(</span><span class=\"n\">busName</span><span class=\"p\">){</span><span class=\"w\"> </span><span class=\"k\">override</span><span class=\"w\"> </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">shouldBeInlined</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"> </span><span class=\"p\">}).</span><span class=\"n\">suggestName</span><span class=\"p\">(</span><span class=\"n\">busName</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"s\">&quot;_clock_groups&quot;</span><span class=\"p\">)</span>\n</span><span id=\"__span-12-7\"><a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\" href=\"#__codelineno-12-7\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clockGroup</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"p\">(</span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">ClockGroup</span><span class=\"p\">(</span><span class=\"n\">busName</span><span class=\"p\">){</span><span class=\"w\"> </span><span class=\"k\">override</span><span class=\"w\"> </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">shouldBeInlined</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"> </span><span class=\"p\">})</span>\n</span><span id=\"__span-12-8\"><a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\" href=\"#__codelineno-12-8\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clockGroupNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">clockGroupAggregator</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"c1\">// other bus clock groups attach here</span>\n</span><span id=\"__span-12-9\"><a id=\"__codelineno-12-9\" name=\"__codelineno-12-9\" href=\"#__codelineno-12-9\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clockNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">clockGroup</span><span class=\"p\">.</span><span class=\"n\">node</span>\n</span><span id=\"__span-12-10\"><a id=\"__codelineno-12-10\" name=\"__codelineno-12-10\" href=\"#__codelineno-12-10\"></a><span class=\"w\">  </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">fixedClockNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">FixedClockBroadcast</span><span class=\"p\">(</span><span class=\"n\">fixedClockOpt</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\">// device clocks attach here</span>\n</span><span id=\"__span-12-11\"><a id=\"__codelineno-12-11\" name=\"__codelineno-12-11\" href=\"#__codelineno-12-11\"></a><span class=\"w\">  </span><span class=\"k\">private</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clockSinkNode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">ClockSinkNode</span><span class=\"p\">(</span><span class=\"nc\">List</span><span class=\"p\">(</span><span class=\"nc\">ClockSinkParameters</span><span class=\"p\">(</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fixedClockOpt</span><span class=\"p\">)))</span>\n</span><span id=\"__span-12-12\"><a id=\"__codelineno-12-12\" name=\"__codelineno-12-12\" href=\"#__codelineno-12-12\"></a>\n</span><span id=\"__span-12-13\"><a id=\"__codelineno-12-13\" name=\"__codelineno-12-13\" href=\"#__codelineno-12-13\"></a><span class=\"w\">  </span><span class=\"n\">clockGroup</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clockGroupAggregator</span><span class=\"p\">.</span><span class=\"n\">node</span>\n</span><span id=\"__span-12-14\"><a id=\"__codelineno-12-14\" name=\"__codelineno-12-14\" href=\"#__codelineno-12-14\"></a><span class=\"w\">  </span><span class=\"n\">fixedClockNode</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clockGroup</span><span class=\"p\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"c1\">// first member of group is always domain&#39;s own clock</span>\n</span><span id=\"__span-12-15\"><a id=\"__codelineno-12-15\" name=\"__codelineno-12-15\" href=\"#__codelineno-12-15\"></a><span class=\"w\">  </span><span class=\"n\">clockSinkNode</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fixedClockNode</span>\n</span><span id=\"__span-12-16\"><a id=\"__codelineno-12-16\" name=\"__codelineno-12-16\" href=\"#__codelineno-12-16\"></a>\n</span><span id=\"__span-12-17\"><a id=\"__codelineno-12-17\" name=\"__codelineno-12-17\" href=\"#__codelineno-12-17\"></a><span class=\"w\">  </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">clockBundle</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">clockSinkNode</span><span class=\"p\">.</span><span class=\"n\">in</span><span class=\"p\">.</span><span class=\"n\">head</span><span class=\"p\">.</span><span class=\"n\">_1</span>\n</span><span id=\"__span-12-18\"><a id=\"__codelineno-12-18\" name=\"__codelineno-12-18\" href=\"#__codelineno-12-18\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-12-19\"><a id=\"__codelineno-12-19\" name=\"__codelineno-12-19\" href=\"#__codelineno-12-19\"></a>\n</span><span id=\"__span-12-20\"><a id=\"__codelineno-12-20\" name=\"__codelineno-12-20\" href=\"#__codelineno-12-20\"></a><span class=\"c1\">// in ClockDomain.scala</span>\n</span><span id=\"__span-12-21\"><a id=\"__codelineno-12-21\" name=\"__codelineno-12-21\" href=\"#__codelineno-12-21\"></a><span class=\"k\">abstract</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Domain</span><span class=\"p\">(</span><span class=\"k\">implicit</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parameters</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">LazyModule</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"nc\">HasDomainCrossing</span>\n</span><span id=\"__span-12-22\"><a id=\"__codelineno-12-22\" name=\"__codelineno-12-22\" href=\"#__codelineno-12-22\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-12-23\"><a id=\"__codelineno-12-23\" name=\"__codelineno-12-23\" href=\"#__codelineno-12-23\"></a><span class=\"w\">  </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">clockBundle</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ClockBundle</span>\n</span><span id=\"__span-12-24\"><a id=\"__codelineno-12-24\" name=\"__codelineno-12-24\" href=\"#__codelineno-12-24\"></a>\n</span><span id=\"__span-12-25\"><a id=\"__codelineno-12-25\" name=\"__codelineno-12-25\" href=\"#__codelineno-12-25\"></a><span class=\"w\">  </span><span class=\"k\">lazy</span><span class=\"w\"> </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">new</span><span class=\"w\"> </span><span class=\"nc\">Impl</span>\n</span><span id=\"__span-12-26\"><a id=\"__codelineno-12-26\" name=\"__codelineno-12-26\" href=\"#__codelineno-12-26\"></a><span class=\"w\">  </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">Impl</span><span class=\"w\"> </span><span class=\"k\">extends</span><span class=\"w\"> </span><span class=\"nc\">LazyRawModuleImp</span><span class=\"p\">(</span><span class=\"bp\">this</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-12-27\"><a id=\"__codelineno-12-27\" name=\"__codelineno-12-27\" href=\"#__codelineno-12-27\"></a><span class=\"w\">    </span><span class=\"n\">childClock</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clockBundle</span><span class=\"p\">.</span><span class=\"n\">clock</span>\n</span><span id=\"__span-12-28\"><a id=\"__codelineno-12-28\" name=\"__codelineno-12-28\" href=\"#__codelineno-12-28\"></a><span class=\"w\">    </span><span class=\"n\">childReset</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clockBundle</span><span class=\"p\">.</span><span class=\"n\">reset</span>\n</span><span id=\"__span-12-29\"><a id=\"__codelineno-12-29\" name=\"__codelineno-12-29\" href=\"#__codelineno-12-29\"></a><span class=\"w\">    </span><span class=\"k\">override</span><span class=\"w\"> </span><span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">provideImplicitClockToLazyChildren</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span>\n</span><span id=\"__span-12-30\"><a id=\"__codelineno-12-30\" name=\"__codelineno-12-30\" href=\"#__codelineno-12-30\"></a>\n</span><span id=\"__span-12-31\"><a id=\"__codelineno-12-31\" name=\"__codelineno-12-31\" href=\"#__codelineno-12-31\"></a><span class=\"w\">    </span><span class=\"c1\">// these are just for backwards compatibility with external devices</span>\n</span><span id=\"__span-12-32\"><a id=\"__codelineno-12-32\" name=\"__codelineno-12-32\" href=\"#__codelineno-12-32\"></a><span class=\"w\">    </span><span class=\"c1\">// that were manually wiring themselves to the domain&#39;s clock/reset input:</span>\n</span><span id=\"__span-12-33\"><a id=\"__codelineno-12-33\" name=\"__codelineno-12-33\" href=\"#__codelineno-12-33\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">clock</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">IO</span><span class=\"p\">(</span><span class=\"nc\">Output</span><span class=\"p\">(</span><span class=\"n\">chiselTypeOf</span><span class=\"p\">(</span><span class=\"n\">clockBundle</span><span class=\"p\">.</span><span class=\"n\">clock</span><span class=\"p\">)))</span>\n</span><span id=\"__span-12-34\"><a id=\"__codelineno-12-34\" name=\"__codelineno-12-34\" href=\"#__codelineno-12-34\"></a><span class=\"w\">    </span><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"n\">reset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">IO</span><span class=\"p\">(</span><span class=\"nc\">Output</span><span class=\"p\">(</span><span class=\"n\">chiselTypeOf</span><span class=\"p\">(</span><span class=\"n\">clockBundle</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">)))</span>\n</span><span id=\"__span-12-35\"><a id=\"__codelineno-12-35\" name=\"__codelineno-12-35\" href=\"#__codelineno-12-35\"></a><span class=\"w\">    </span><span class=\"n\">clock</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clockBundle</span><span class=\"p\">.</span><span class=\"n\">clock</span>\n</span><span id=\"__span-12-36\"><a id=\"__codelineno-12-36\" name=\"__codelineno-12-36\" href=\"#__codelineno-12-36\"></a><span class=\"w\">    </span><span class=\"n\">reset</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clockBundle</span><span class=\"p\">.</span><span class=\"n\">reset</span>\n</span><span id=\"__span-12-37\"><a id=\"__codelineno-12-37\" name=\"__codelineno-12-37\" href=\"#__codelineno-12-37\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-12-38\"><a id=\"__codelineno-12-38\" name=\"__codelineno-12-38\" href=\"#__codelineno-12-38\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n</ol>\n<h2 id=\"tilelink-widgets\">TileLink Widgets<a class=\"headerlink\" href=\"#tilelink-widgets\" title=\"Permanent link\">&para;</a></h2>\n<p>Rocket Chip \u4e2d\u7528 Diplomacy \u5b9e\u73b0 TileLink \u603b\u7ebf\u7684\u8fde\u63a5\u3002\u6d89\u53ca\u5230\u7684\u76f8\u5173\u7ed3\u6784\u5982\u4e0b\uff1a</p>\n<ol>\n<li>TLBundle\uff1a\u4ee3\u8868 TileLink \u603b\u7ebf\u7684\u63a5\u53e3\uff0c\u6839\u636e TLBundleParameters \u4f8b\u5316</li>\n<li>TLMasterPortParameters\uff1a\u4fe1\u606f TileLink Master \u7684\u4fe1\u606f\uff0c\u4ece Upstream \u5411 Downstream \u4f20\u9012</li>\n<li>TLSlavePortParameters\uff1a\u4fe1\u606f TileLink Slave \u7684\u4fe1\u606f\uff0c\u4ece Downstream \u5411 Upstream \u4f20\u9012</li>\n<li>TLEdgeOut\uff1a\u8bb0\u5f55 Outward \u8fb9\uff0c\u4e5f\u5c31\u662f Master \u4fa7\u7684 TileLink \u7684\u4fe1\u606f</li>\n<li>TLEdgeIn\uff1a\u8bb0\u5f55 Inward \u8fb9\uff0c\u4e5f\u5c31\u662f Slave \u4fa7\u7684 TileLink \u7684\u4fe1\u606f</li>\n<li>TLImp: <code>extends NodeImp[TLMasterPortParameters, TLSlavePortParameters, TLEdgeOut, TLEdgeIn, TLBundle]</code>\uff0c\u57fa\u4e8e\u8fd9\u4e2a\u7c7b\u578b\u6765\u5bfc\u51fa\u5404\u79cd\u7c7b\u578b\u7684 TileLink Node</li>\n<li>TLXBar\uff1aTileLink \u7684 Crossbar\uff0c\u751f\u6210\u4e00\u4e2a\u7ee7\u627f NexusNode \u7684 TLNexusNode\uff0c\u5b83\u7684\u4fe1\u606f\u4f20\u9012\u65b9\u5f0f\u662f\uff0c\u628a\u4e0b\u6e38\u7684\u5404\u4e2a Slave \u4fe1\u606f\u62fc\u8d77\u6765\u4f20\u7ed9\u4e0a\u6e38\uff0c\u4f7f\u5f97 Master \u53ef\u4ee5\u770b\u5230\u6240\u6709 Slave \u7684\u4fe1\u606f\uff1b\u628a\u4e0a\u6e38\u7684\u5404\u4e2a Master \u4fe1\u606f\u62fc\u8d77\u6765\u4f20\u7ed9\u4e0b\u6e38\uff0c\u4f7f\u5f97 Slave \u53ef\u4ee5\u770b\u5230\u6240\u6709 Master \u7684\u4fe1\u606f</li>\n<li>TLToAXI4\uff1a\u751f\u6210\u4e00\u4e2a\u7ee7\u627f AdapterNode \u7684 TLToAXI4Node\uff0c\u628a TileLink Master \u8f6c\u6210 AXI4 Master\uff0c\u628a\u4e0a\u6e38\u7684 TileLink Master \u4fe1\u606f\u8f6c\u6362\u4e3a AXI Master \u4f20\u9012\u7ed9\u4e0b\u6e38\uff0c\u628a\u4e0b\u6e38\u7684 AXI Slave \u4fe1\u606f\u8f6c\u6362\u4e3a TileLink Slave \u4f20\u9012\u7ed9\u4e0a\u6e38</li>\n</ol>\n<h2 id=\"\u53c2\u8003\u6587\u6863\">\u53c2\u8003\u6587\u6863<a class=\"headerlink\" href=\"#\u53c2\u8003\u6587\u6863\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://chipyard.readthedocs.io/en/latest/TileLink-Diplomacy-Reference/index.html\">TileLink and Diplomacy Reference</a></li>\n<li><a href=\"https://chipyard.readthedocs.io/en/latest/Generators/Rocket-Chip.html#memory-system\">Rocket Chip - Memory System</a></li>\n<li><a href=\"https://github.com/chipsalliance/diplomacy\">chipsalliance/diplomacy</a></li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/rocket-chip-diplomacy.png", "date_modified": "2025-05-14T00:00:00+00:00", "date_published": "2025-05-14T00:00:00+00:00", "authors": [], "tags": ["chisel", "diplomacy", "hardware", "rocketchip"]}, {"id": "https://jia.je/hardware/2025/04/23/intel-redwood-cove/", "url": "https://jia.je/hardware/2025/04/23/intel-redwood-cove/", "title": "Intel Redwood Cove \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"intel-redwood-cove-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Intel Redwood Cove \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#intel-redwood-cove-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e4b\u524d\u6211\u4eec\u6d4b\u8bd5\u4e86 Intel \u7684\u5fae\u67b6\u6784 <a href=\"../../../01/10/intel-golden-cove/\">Redwood Cove</a>\uff0c\u8fd9\u6b21\u5c31\u6765\u6d4b\u4e00\u4e0b Redwood Cove\uff0c\u5b83\u88ab\u7528\u5230\u4e86 Meteor Lake \u4ee5\u53ca Granite Rapids \u4e0a\u3002\u8fd9\u6b21\u5c31\u4ee5\u963f\u91cc\u4e91 <a href=\"https://help.aliyun.com/zh/ecs/user-guide/overview-of-instance-families#g9i\">g9i</a> \u5b9e\u4f8b\u7684 Granite Rapids \u673a\u5668\u6765\u6d4b\u8bd5\u4e00\u4e0b Redwood Cove \u5fae\u67b6\u6784\u7684\u5404\u9879\u6307\u6807\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel \u5173\u4e8e Redwood Cove \u5fae\u67b6\u6784\u6709\u8fd9\u4e9b\u5b98\u65b9\u7684\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://www.intel.com/content/www/us/en/content-details/814198/intel-64-and-ia-32-architectures-optimization-reference-manual-volume-1.html\">Intel\u00ae 64 and IA-32 Architectures Optimization Reference Manual Volume 1</a></li>\n<li><a href=\"https://www.thefpsreview.com/wp-content/uploads/2023/10/Meteor-Lake-Architecture-Overview.pdf\">Meteor Lake Architecture Overview</a></li>\n</ul>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Redwood Cove \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://chipsandcheese.com/p/intels-redwood-cove-baby-steps-are-still-steps\">Intel\u2019s Redwood Cove: Baby Steps are Still Steps</a></li>\n<li><a href=\"https://www.anandtech.com/show/20046/intel-unveils-meteor-lake-architecture-intel-4-heralds-the-disaggregated-future-of-mobile-cpus/2\">Intel Unveils Meteor Lake Architecture: Intel 4 Heralds the Disaggregated Future of Mobile CPUs</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel Redwood Cove \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Larger instruction cache: 32K\u2192<strong>64K</strong>.</li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 4 \u5b57\u8282 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b\u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel-redwood-cove-fetch-bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 64 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 6 IPC\uff0c\u4e4b\u540e\u5219\u964d\u5230 3.2 IPC\uff0c\u8fd9\u91cc\u7684 64 KB \u5c31\u5bf9\u5e94\u4e86 L1 ICache \u7684\u5bb9\u91cf\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 jmp \u6307\u4ee4\uff0c\u4f7f\u5f97 jmp \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel-redwood-cove-itlb-size.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 256 \u4e2a Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 256 \u7684 L1 ITLB \u5bb9\u91cf\u3002\u6ce8\u610f\u8981\u907f\u514d ICache \u548c BTB \u7684\u5bb9\u91cf\u6210\u4e3a\u74f6\u9888\uff0c\u628a jmp \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 Cache Line \u548c BTB entry \u4e0a\u3002</p>\n<p>\u8d85\u8fc7 256 \u4e2a Page \u4ee5\u540e\uff0c\u5982\u56fe\u6709\u5468\u671f\u6570\u7a81\u7136\u4e0b\u964d\u540e\u7f13\u6162\u4e0a\u5347\u7684\u60c5\u51b5\uff08\u4f8b\u5982\u6a2a\u5750\u6807 288-&gt;289\u3001320-&gt;321\u3001352-&gt;353\u3001384-&gt;385 \u7b49\uff0c\u4ee5 32 \u4e3a\u5468\u671f\uff09\uff0c\u80cc\u540e\u7684\u539f\u7406\u9700\u8981\u8fdb\u4e00\u6b65\u5206\u6790\u3002</p>\n<p>\u548c <a href=\"../../../01/10/intel-golden-cove/\">Golden Cove</a> \u662f\u4e00\u6837\u7684\u3002</p>\n<h3 id=\"instruction-decode-queue-idq--loop-stream-detector-lsd\">Instruction Decode Queue (IDQ) + Loop Stream Detector (LSD)<a class=\"headerlink\" href=\"#instruction-decode-queue-idq--loop-stream-detector-lsd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Improved LSD coverage: the IDQ can hold <strong>192</strong> \u03bcops per logical processor in single-thread mode or 96 \u03bcops per thread when SMT is active.</li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 Instruction Decode Queue \u7684\u5927\u5c0f\uff0c\u6784\u9020\u4e0d\u540c\u5927\u5c0f\u7684\u5faa\u73af\uff0c\u5faa\u73af\u4f53\u662f\u590d\u5236\u82e5\u5e72\u4efd\u7684 <code>inc %rsi</code> \u6307\u4ee4\uff0c\u6700\u540e\u662f <code>dec + jnz</code> \u4f5c\u4e3a\u5faa\u73af\u7ed3\u5c3e\uff0c\u901a\u8fc7 <a href=\"https://perfmon-events.intel.com/index.html?pltfrm=ahybrid.html&amp;evnt=LSD.UOPS\">LSD.UOPS</a> \u6027\u80fd\u8ba1\u6570\u5668\u7edf\u8ba1\u6bcf\u6b21\u5faa\u73af\u6709\u591a\u5c11\u4e2a UOP \u6765\u81ea\u4e8e Loop Stream Detector \u673a\u5236\uff0c\u53d1\u73b0\u5176\u6700\u5927\u503c\u4e3a 191\uff0c\u8bf4\u660e Redwood Cove \u7684 Loop Stream Detector \u53ef\u4ee5\u8bc6\u522b\u6700\u591a 191 \u4e2a uop \u7684\u5faa\u73af\u3002\u6b64\u65f6\u6bcf\u4e2a\u5faa\u73af\u8981\u6267\u884c 192 \u6761\u6307\u4ee4\uff0c\u6700\u540e\u7684 <code>dec + jnz</code> \u88ab\u878d\u5408\u6210\u4e86\u4e00\u4e2a uop\u3002</p>\n<p>\u5faa\u73af\u4f53\u4e2d\uff0c\u5982\u679c\u7528 <code>nop</code> \u6307\u4ee4\u6765\u586b\u5145\uff0c\u4f1a\u5f97\u5230 39 \u5de6\u53f3\u7684\u6bd4 192 \u5c0f\u5f97\u591a\u7684\u5bb9\u91cf\uff0c\u731c\u6d4b\u662f\u8fdb\u5165\u4e86\u4f4e\u529f\u8017\u6a21\u5f0f\u3002</p>\n<h3 id=\"instruction-prefetch-instruction\">Instruction Prefetch Instruction<a class=\"headerlink\" href=\"#instruction-prefetch-instruction\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Code Software Prefetch x86 architecture extension (Granite Rapids only).</li>\n<li>PREFETCHIT0: (temporal code)\u2014prefetch code into all levels of the cache hierarchy.</li>\n<li>PREFETCHIT1: (temporal code with respect to first level cache misses)\u2014prefetch code into all but the first-level of the cache hierarchy.</li>\n</ul>\n<h3 id=\"conditional-branch-predictor\">Conditional Branch Predictor<a class=\"headerlink\" href=\"#conditional-branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53c2\u8003 <a href=\"https://cseweb.ucsd.edu/~dstefan/pubs/yavarzadeh:2023:half.pdf\">Half&amp;Half: Demystifying Intel\u2019s Directional Branch Predictors for Fast, Secure Partitioned Execution</a> \u8bba\u6587\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u6d4b\u51fa Redwood Cove \u7684\u5206\u652f\u9884\u6d4b\u5668\u91c7\u7528\u7684\u5386\u53f2\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 388 \u4f4d\u7684 Path History Register\uff0c\u6bcf\u6b21\u6267\u884c taken branch \u65f6\u66f4\u65b0</li>\n<li>\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a<code>PHRnew = (PHRold &lt;&lt; 2) xor footprint</code></li>\n<li>footprint \u5171\u6709 16 \u4f4d\uff0c\u5176\u4e2d B \u4ee3\u8868\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0cT \u4ee3\u8868\u5206\u652f\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740\uff1a<ul>\n<li>footprint[0] = B[3] xor T[0]</li>\n<li>footprint[1] = B[4] xor T[1]</li>\n<li>footprint[2] = B[5]</li>\n<li>footprint[3] = B[6]</li>\n<li>footprint[4] = B[7]</li>\n<li>footprint[5] = B[8]</li>\n<li>footprint[6] = B[9]</li>\n<li>footprint[7] = B[10]</li>\n<li>footprint[8] = B[0] xor T[2]</li>\n<li>footprint[9] = B[1] xor T[3]</li>\n<li>footprint[10] = B[2] xor T[4]</li>\n<li>footprint[11] = B[11] xor T[5]</li>\n<li>footprint[12] = B[12]</li>\n<li>footprint[13] = B[13]</li>\n<li>footprint[14] = B[14]</li>\n<li>footprint[15] = B[15]</li>\n</ul>\n</li>\n</ol>\n<p>\u548c <a href=\"../../../01/10/intel-golden-cove/\">Golden Cove</a> \u662f\u4e00\u6837\u7684\u3002\u5404\u5382\u5546\u5904\u7406\u5668\u7684 PHR \u66f4\u65b0\u89c4\u5219\u89c1 <a href=\"https://jia.je/cpu/cbp.html\">jiegec/cpu</a>\u3002</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"l1-dcache\">L1 DCache<a class=\"headerlink\" href=\"#l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<ul>\n<li>0KB-48KB: 5 cycle\uff0c\u5bf9\u5e94 L1 DCache</li>\n<li>48KB-384KB: 16 cycle\uff0c\u5bf9\u5e94 L2 Cache\uff0c\u4e14\u547d\u4e2d\u4e86 L1 DTLB\uff1b\u8bf4\u660e L1 miss L2 hit \u5e26\u6765\u4e86 11 cycle \u7684\u635f\u5931</li>\n</ul>\n<h3 id=\"l1-dtlb\">L1 DTLB<a class=\"headerlink\" href=\"#l1-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7528\u7c7b\u4f3c\u6d4b L1 DCache \u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21 pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel-redwood-cove-dtlb-size.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 96 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 96 \u7684 L1 DTLB \u5bb9\u91cf\u3002\u6ca1\u6709\u8d85\u51fa L1 DTLB \u5bb9\u91cf\u524d\uff0cLoad to use latency \u662f 5 cycle\uff1b\u8d85\u51fa L1 DTLB \u5bb9\u91cf\u540e\uff0cLoad to use latency \u662f 12 cycle\uff0c\u8bf4\u660e L1 DTLB miss \u5e26\u6765\u4e86 7 cycle \u7684\u635f\u5931\u3002</p>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>EXE: 3-cycle Floating Point multiplication.</li>\n</ul>\n<h3 id=\"lsu\">LSU<a class=\"headerlink\" href=\"#lsu\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"load-store-\u5e26\u5bbd\">Load Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#load-store-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>3x 256b Load</li>\n<li>2x 256b Load + 2x 256b Store</li>\n<li>1x 256b Load + 2x 256b Store</li>\n<li>2x 256b Store</li>\n<li>2x 512b Load</li>\n<li>1x 512b Load + 1x 512b Store</li>\n<li>1x 512b Store</li>\n</ul>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0cRedwood Cove \u4e0a\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[0,2]</td>\n<td>{0}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[0,6]</td>\n<td>[0,4]</td>\n<td>{0}</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cRedwood Cove \u5728 Store \u5b8c\u5168\u5305\u542b Load \u7684\u60c5\u51b5\u4e0b\u90fd\u53ef\u4ee5\u8f6c\u53d1\uff0c\u6ca1\u6709\u989d\u5916\u7684\u5bf9\u9f50\u8981\u6c42\u3002\u4f46\u5f53 Load \u548c Store \u53ea\u6709\u90e8\u5206\u91cd\u5408\u65f6\uff0c\u5c31\u65e0\u6cd5\u8f6c\u53d1\u3002\u4e24\u4e2a\u8fde\u7eed\u7684 32 \u4f4d\u7684 Store \u548c\u4e00\u4e2a 64 \u4f4d\u7684 Load \u91cd\u5408\u4e5f\u4e0d\u80fd\u8f6c\u53d1\u3002</p>\n<p>\u7279\u522b\u5730\uff0c\u5728 y=x \u4e14\u4e0d\u8de8\u8d8a\u7f13\u5b58\u884c\u8fb9\u754c\u4e14\u6ee1\u8db3\u4e0b\u5217\u8981\u6c42\u7684\u60c5\u51b5\u4e0b\uff0cStore Forwarding \u4e0d\u4f1a\u6216\u53ea\u5e26\u6765\u5f88\u5c0f\u7684\u6027\u80fd\u635f\u5931\uff1a</p>\n<ul>\n<li>8b Store -&gt; 8b Load</li>\n<li>32b Store -&gt; 8b Load</li>\n<li>64b Store -&gt; 8b Load</li>\n<li>32b Store -&gt; 32b Load</li>\n<li>64b Store -&gt; 32b Load</li>\n<li>64b Store -&gt; 64b Load</li>\n</ul>\n<p>\u8003\u8651\u5230 y \u5fc5\u987b\u7b49\u4e8e x\uff0c\u4e5f\u5c31\u662f\u5730\u5740\u8981\u4e00\u6837\uff0c\u731c\u6d4b Redwood Cove \u4f7f\u7528\u4e86\u7c7b\u4f3c Memory Renaming \u7684\u6280\u672f\u6765\u5b9e\u73b0\u8fd9\u4e2a\u6548\u679c\u3002\u5982\u679c\u662f\u8fde\u7eed\u4e24\u4e2a\u5bf9\u540c\u4e00\u4e2a\u5730\u5740\u7684 Store \u5bf9\u4e00\u4e2a Load \u7684\u8f6c\u53d1\uff0c\u6548\u679c\u548c\u53ea\u6709\u4e00\u4e2a Store \u662f\u4e00\u6837\u7684\u3002</p>\n<p>\u9664\u4e86\u4e0a\u8ff0\u60c5\u51b5\u4ee5\u5916\uff0cStore Forwarding \u6210\u529f\u65f6\u7684\u5ef6\u8fdf\u5728 5 \u4e2a\u5468\u671f\uff0c\u5931\u8d25\u5219\u8981 19 \u4e2a\u5468\u671f\u3002</p>\n<p>\u548c <a href=\"../../../01/10/intel-golden-cove/\">Golden Cove</a> \u662f\u4e00\u6837\u7684\u3002</p>\n<p>\u5c0f\u7ed3\uff1aRedwood Cove \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42 st \u5305\u542b ld\uff0c\u7279\u522b\u5730\uff0c\u5730\u5740\u76f8\u540c\u65f6\uff0c\u6027\u80fd\u6700\u597d</li>\n<li>1 ld + 2+ st: \u4e0d\u652f\u6301</li>\n</ul>\n<h3 id=\"prefetcher\">Prefetcher<a class=\"headerlink\" href=\"#prefetcher\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>New HW data prefetcher to recognize and prefetch the \u201cArray of Pointers\u201d pattern.</li>\n</ul>\n<p>Intel Redwood Cove \u7684\u5904\u7406\u5668\u901a\u8fc7 MSR 1A4H \u53ef\u4ee5\u914d\u7f6e\u5404\u4e2a\u9884\u53d6\u5668\uff08\u6765\u6e90\uff1aSoftware Developers Manual\uff0cAdditional MSRs Supported by the Intel\u00ae Core\u2122 Ultra 7 Processors Supporting Performance Hybrid Architecture\uff09\uff1a</p>\n<ul>\n<li>MSR_1A4H[0]: the L2 hardware prefetcher, which fetches additional lines of code or data into the L2 cache.</li>\n<li>MSR_1A4H[1]: the L2 adjacent cache line prefetcher, which fetches the cache line that comprises a cache line pair (128 bytes). \u8fd9\u548c AMD \u7684 Up/Down Prefetcher \u5e94\u8be5\u662f\u4e00\u4e2a\u610f\u601d</li>\n<li>MSR_1A4H[2]: the L1 data cache prefetcher, which fetches the next cache line into L1 data cache. \u8fd9\u4e2a\u5e94\u8be5\u5c5e\u4e8e Next Line Prefetcher</li>\n<li>MSR_1A4H[3]: the L1 data cache IP prefetcher, which uses sequential load history (based on instruction pointer of previous loads) to determine whether to prefetch additional lines.</li>\n<li>MSR_1A4H[4]: Next page prefetcher\uff0c\u5f53\u8bbf\u95ee\u5feb\u8d70\u5230\u4e00\u4e2a\u9875\u7684\u7ed3\u5c3e\u7684\u65f6\u5019\uff0c\u4ece\u4e0b\u4e00\u4e2a\u9875\u7684\u5f00\u5934\u5f00\u59cb prefetch\uff0c\u63d0\u524d\u8fdb\u884c\u53ef\u80fd\u7684 TLB refill</li>\n<li>MSR_1A4H[5]: the L2 Adaptive Multipath Probability (AMP) prefetcher. \u8fd9\u4e2a\u5e94\u8be5\u5c5e\u4e8e Spatial Prefetcher</li>\n<li>MSR_1A4H[6]: LLC page prefetcher\uff0c\u7c7b\u4f3c Next page prefetcher \u7684\u601d\u8def\uff0c\u4f46\u662f\u628a\u865a\u62df\u5730\u5740\u4e0a\u8fde\u7eed\u7684\u4e24\u4e2a 4KB \u7684\u9875\uff0c\u4e00\u5171 8KB \u7684\u6570\u636e\u9884\u53d6\u5230 LLC \u7f13\u5b58\u4e0a</li>\n<li>MSR_1A4H[7]: Array of pointers prefetcher\uff0c\u9488\u5bf9\u6307\u9488\u6570\u7ec4 <code>T *arr[]</code> \u7684\u573a\u666f\u8fdb\u884c\u9884\u53d6</li>\n<li>MSR_1A4H[8]: Stream prefetch code fetch</li>\n</ul>\n<h3 id=\"reorder-buffer\">ReOrder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 ROB \u7684\u5927\u5c0f\uff0c\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5f00\u59cb\u548c\u7ed3\u675f\u662f\u957f\u5ef6\u8fdf\u7684 long latency load\u3002\u4e2d\u95f4\u662f\u82e5\u5e72\u6761 NOP \u6307\u4ee4\uff0c\u5f53 NOP \u6307\u4ee4\u6bd4\u8f83\u5c11\u65f6\uff0c\u5faa\u73af\u7684\u65f6\u5019\u53d6\u51b3\u4e8e load \u6307\u4ee4\u7684\u65f6\u95f4\uff1b\u5f53 NOP \u6307\u4ee4\u6570\u91cf\u8fc7\u591a\uff0c\u586b\u6ee1\u4e86 ROB \u4ee5\u540e\uff0c\u5c31\u4f1a\u5bfc\u81f4 ROB \u65e0\u6cd5\u4fdd\u5b58\u5faa\u73af\u672b\u5c3e\u7684 load \u6307\u4ee4\uff0c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\u3002\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel-redwood-cove-rob-size.png\" /></p>\n<p>\u5f53 NOP \u6570\u91cf\u8fbe\u5230 512 \u65f6\uff0c\u6027\u80fd\u5f00\u59cb\u6025\u5267\u4e0b\u6ed1\uff0c\u8bf4\u660e Redwood Cove \u7684 ROB \u5927\u5c0f\u662f 512\u3002</p>\n<h2 id=\"\u603b\u7ed3\">\u603b\u7ed3<a class=\"headerlink\" href=\"#\u603b\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>Redwood Cove \u76f8\u6bd4 Golden Cove \u662f\u6bd4\u8f83\u5c0f\u7684\u4e00\u4e2a\u8fed\u4ee3\uff0c\u66f4\u65b0\u7684\u90e8\u5206\u4e3b\u8981\u6709\uff1a</p>\n<ol>\n<li>\u6269\u5927\u4e86 L1 ICache \u5bb9\u91cf</li>\n<li>\u6269\u5927\u4e86\u5206\u652f\u9884\u6d4b\u5668\u7684\u5bb9\u91cf</li>\n<li>\u589e\u52a0\u4e86\u66f4\u591a\u9884\u53d6\u5668</li>\n</ol>\n<p>\u56e0\u6b64\u6027\u80fd\u63d0\u5347\u4e5f\u6bd4\u8f83\u5c0f\uff0c\u5e0c\u671b Intel \u53ef\u4ee5\u66f4\u52a0\u7ed9\u529b\u4e00\u4e9b\uff0c\u7ed9 AMD \u4e00\u4e9b\u7ade\u4e89\u538b\u529b\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/hardware/intel-redwood-cove.png", "date_modified": "2025-04-23T00:00:00+00:00", "date_published": "2025-04-23T00:00:00+00:00", "authors": [], "tags": ["cpu", "graniterapids", "hardware", "intel", "meteorlake", "performance", "redwoodcove", "uarch-review"]}, {"id": "https://jia.je/software/2025/04/10/cbp-experiments/", "url": "https://jia.je/software/2025/04/10/cbp-experiments/", "title": "\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c", "content_html": "<h1 id=\"\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\">\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c<a class=\"headerlink\" href=\"#\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u9488\u5bf9\u5404\u79cd\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff08Conditional Branch Predictor\uff09\u505a\u4e86\u5728\u5404\u79cd benchmark \u4e0a\u7684\u5b9e\u9a8c\uff0c\u5728\u6b64\u8bb0\u5f55\u4e00\u4e0b\u505a\u8fd9\u4e2a\u5b9e\u9a8c\u7684\u6d41\u7a0b\u3002</p>\n<p>\u4ee3\u7801\u5df2\u5f00\u6e90\uff1a<a href=\"https://github.com/jiegec/cbp-experiments\">jiegec/cbp-experiments</a>\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u6d41\u7a0b\">\u6d41\u7a0b<a class=\"headerlink\" href=\"#\u6d41\u7a0b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8bf4\u5230\u505a\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\uff0c\u5230\u5e95\u662f\u505a\u4ec0\u4e48\u5462\uff1f\u5176\u5b9e\u5c31\u662f\u9488\u5bf9\u672a\u6765\u7684\u5904\u7406\u5668\u4e2d\u7684\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u8bbe\u8ba1\uff0c\u5728\u63d0\u524d\u51c6\u5907\u597d\u7684\u4e00\u4e9b benchmark \u4e0a\u8fdb\u884c\u6a21\u62df\uff0c\u89c2\u5bdf\u5b83\u7684\u9884\u6d4b\u51c6\u786e\u6027\u3002\u65e2\u7136\u662f\u672a\u6765\u7684\u5904\u7406\u5668\uff0c\u90a3\u4e48\u786c\u4ef6\u80af\u5b9a\u662f\u6ca1\u6709\u7684\uff0c\u5982\u679c\u76f4\u63a5\u7528 RTL \u53bb\u5b9e\u73b0\u65b0\u7684\u9884\u6d4b\u5668\uff0c\u518d\u7528 RTL \u4eff\u771f\uff0c\u7ed3\u679c\u56fa\u7136\u51c6\u786e\uff0c\u4f46\u8fd9\u8fd8\u662f\u592a\u590d\u6742\u5e76\u4e14\u592a\u6162\u4e86\u3002\u6240\u4ee5\u5728\u524d\u671f\u7684\u65f6\u5019\uff0c\u9996\u5148\u4f1a\u6784\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u5b9e\u9a8c\u73af\u5883\uff0c\u5728\u53ea\u8003\u8651\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u3001\u4e0d\u8003\u8651\u5176\u4ed6\u6307\u4ee4\u7684\u60c5\u51b5\u4e0b\uff0c\u5355\u7eaf\u6765\u89c2\u5bdf\u9884\u6d4b\u7684\u6548\u679c\uff0c\u4ece\u800c\u53ef\u4ee5\u5b9e\u73b0\u6bd4\u8f83\u5feb\u901f\u7684\u8bbe\u8ba1\u8fed\u4ee3\u3002</p>\n<p>\u4e3a\u4e86\u8fbe\u6210\u8fd9\u4e2a\u76ee\u7684\uff0c\u9700\u8981\uff1a</p>\n<ol>\n<li>\u63d0\u524d\u51c6\u5907\u597d\u4e00\u4e9b benchmark\uff0c\u63d0\u53d6\u51fa\u8fd9\u4e2a benchmark \u4e2d\u6240\u6d89\u53ca\u5230\u7684\u6761\u4ef6\u5206\u652f trace\uff0c\u4ee5\u53ca\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6240\u9700\u8981\u7684\u5176\u4ed6\u4fe1\u606f</li>\n<li>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u7f29\u77ed\u6a21\u62df\u7684\u65f6\u95f4\u548c trace \u7684\u5927\u5c0f\uff0c\u5229\u7528 SimPoint \u7b49\u6280\u672f\u6765\u51cf\u5c11\u8981\u6a21\u62df\u7684\u6307\u4ee4\u6761\u6570</li>\n<li>\u642d\u5efa\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\u5668\uff0c\u5728\u4e0a\u4e00\u6b65\u63d0\u53d6\u51fa\u6765\u7684 trace \u4e2d\u6a21\u62df\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u6267\u884c\uff0c\u4ece\u800c\u5f97\u5230\u7ed3\u679c</li>\n</ol>\n<p>\u4e0b\u9762\u6309\u7167\u8fd9\u4e2a\u987a\u5e8f\uff0c\u5206\u522b\u6765\u8ba8\u8bba\u4e00\u4e0b\u8fd9\u4e2a\u6d41\u7a0b\u3002</p>\n<h2 id=\"benchmark-\u51c6\u5907\">benchmark \u51c6\u5907<a class=\"headerlink\" href=\"#benchmark-\u51c6\u5907\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6bd4\u8f83\u5e38\u89c1\u7684 benchmark \u5c31\u662f SPEC INT 2017\uff0c\u5f53\u7136\u73b0\u5728\u5f88\u591a\u8bba\u6587\u4e5f\u4f1a\u81ea\u5df1\u53bb\u5bfb\u627e\u4e00\u4e9b\u5176\u4ed6\u7684 benchmark\uff0c\u4e0d\u540c\u7684 benchmark \u5b83\u7684\u7a0b\u5e8f\u7684\u7279\u6027\u4e5f\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u672a\u6765\u4e5f\u53ef\u80fd\u4f1a\u6709\u65b0\u7684 benchmark \u51fa\u6765\uff0c\u6240\u4ee5\u6709\u5fc5\u8981\u4e86\u89e3\u4ece benchmark \u5230 trace \u7684\u8fc7\u7a0b\u3002\u9009\u597d\u4e86 benchmark \u4ee5\u540e\uff0c\u6211\u4eec\u9700\u8981\u601d\u8003\u600e\u4e48\u53bb\u751f\u6210\u4e00\u4e2a trace\uff1a\u4e3a\u4e86\u51cf\u5c11\u540e\u7eed\u6a21\u62df\u7684\u8d1f\u62c5\uff0c\u6211\u4eec\u9700\u8981\u4ece benchmark \u4e2d\u63d0\u53d6\u6761\u4ef6\u5206\u652f\u7684\u6267\u884c\u5386\u53f2\uff0c\u4f5c\u4e3a groundtruth\uff0c\u5582\u7ed9\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u8fd9\u6837\u624d\u80fd\u77e5\u9053\u6bcf\u6b21\u9884\u6d4b\u662f\u5426\u51c6\u786e\u3002\u5f53\u7136\u4e86\uff0c\u7f51\u4e0a\u5df2\u7ecf\u6709\u5f88\u591a\u73b0\u6210\u7684 trace\uff0c\u6bd4\u5982 CBP Championship \u6bd4\u8d5b\u4e5f\u90fd\u6709\u63d0\u4f9b\u81ea\u5df1\u7684 benchmark trace\uff08P.S. 2025 \u5e74\u7684 CBP Championship \u6b63\u5728\u706b\u70ed\u8fdb\u884c\u4e2d\uff09\uff0c\u4f46\u8bfb\u5b8c\u672c\u6587\uff0c\u4f60\u5e94\u8be5\u53ef\u4ee5\u5c1d\u8bd5\u81ea\u5df1\u5b8c\u6210\u8fd9\u4e2a\u4ece benchmark \u5230 trace \u7684\u8fc7\u7a0b\u3002</p>\n<p>\u90a3\u4e48\u7b2c\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff0c\u600e\u4e48\u83b7\u53d6 benchmark \u4e2d\u5206\u652f\u6307\u4ee4\u6267\u884c\u7684\u4fe1\u606f\u5462\uff1f\u9996\u5148\u6765\u770b\u4e00\u7ec4\u6570\u636e\uff0c\u5728 amd64 \u4e0a\uff0c\u7528 <code>-O3</code> \u7f16\u8bd1 SPEC INT 2017 \u7684 benchmark\uff0c\u4e00\u5171 10 \u4e2a\u5b50 benchmark\uff0c\u52a0\u8d77\u6765\u8fd0\u884c\u7684\u6307\u4ee4\u6570\u5927\u7ea6\u662f 1.6e13 \u6761\uff0c\u5176\u4e2d\u6709\u5927\u7ea6 2.9e12 \u6761\u5206\u652f\u6307\u4ee4\uff08\u5305\u62ec\u4e86\u6709\u6761\u4ef6\u548c\u65e0\u6761\u4ef6\uff09\uff0c\u8fd9\u4e2a\u6570\u91cf\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u65e0\u8bba\u662f\u4fdd\u5b58\u8fd9\u4e9b\u6267\u884c\u4fe1\u606f\u7684\u6027\u80fd\u5f00\u9500\uff0c\u8fd8\u662f\u9700\u8981\u7684\u5b58\u50a8\u7a7a\u95f4\uff0c\u90fd\u662f\u6bd4\u8f83\u5de8\u5927\u7684\u3002</p>\n<p>\u8003\u8651\u5230\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u53ea\u9700\u8981\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u53ea\u8003\u8651 2.9e12 \u6761\u5206\u652f\u6307\u4ee4\u7684\u90e8\u5206\uff0c\u800c\u4e0d\u53bb\u8003\u8651\u5b8c\u6574\u7684 1.6e13 \u6761\u6307\u4ee4\uff0c\u9996\u5148\u53ef\u4ee5\u51cf\u5c11\u4e00\u4e2a\u6570\u91cf\u7ea7\u3002\u63a5\u7740\uff0c\u8003\u8651\u6bcf\u4e2a\u5206\u652f\u6307\u4ee4\u9700\u8981\u8bb0\u5f55\u54ea\u4e9b\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u77e5\u9053\u6bcf\u4e00\u6761\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\u3001\u6bcf\u4e00\u6761\u76f4\u63a5\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740</li>\n<li>\u5bf9\u4e8e\u6267\u884c\u7684\u6bcf\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u8981\u8bb0\u5f55\u5b83\u8df3\u8f6c\u4e0e\u5426</li>\n<li>\u5bf9\u4e8e\u6267\u884c\u7684\u6bcf\u4e00\u6761\u95f4\u63a5\u5206\u652f\u6307\u4ee4\uff0c\u9700\u8981\u8bb0\u5f55\u5b83\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740</li>\n</ol>\n<p>\u5176\u4e2d\u7b2c\u4e00\u70b9\uff0c\u7531\u4e8e\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u672c\u8eab\u662f\u4e0d\u53d8\u7684\uff08\u4e0d\u8003\u8651 JIT\uff09\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u5b58\u4e00\u4efd\u5c31\u884c\u3002\u800c SPEC INT 2017 \u6240\u6709\u7a0b\u5e8f\u7684\u5206\u652f\u6307\u4ee4\u52a0\u8d77\u6765\u5927\u6982\u53ea\u6709 5e4 \u7684\u91cf\u7ea7\uff0c\u76f8\u6bd4 2.9e12 \u7684\u6267\u884c\u7684\u5206\u652f\u6307\u4ee4\u6570\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\u3002\u7b2c\u4e09\u70b9\uff0c\u7531\u4e8e\u95f4\u63a5\u5206\u652f\u6307\u4ee4\u901a\u5e38\u4e5f\u662f\u6bd4\u8f83\u5c11\u7684\uff0c\u800c\u4e14\u540c\u4e00\u6761\u95f4\u63a5\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u901a\u5e38\u6765\u8bf4\u4e0d\u4f1a\u7279\u522b\u591a\uff0c\u4e5f\u6709\u538b\u7f29\u7684\u7a7a\u95f4\u3002\u90a3\u4e48\u6700\u4e3b\u8981\u7684\u7a7a\u95f4\u6765\u81ea\u4e8e\uff1a</p>\n<ol>\n<li>\u867d\u7136\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u6570\u91cf\u4e0d\u591a\uff0c\u4f46\u662f\u6267\u884c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u6b21\u6570\u5f88\u591a\uff0c\u6bcf\u4e00\u6b21\u6267\u884c\u7684\u53ef\u80fd\u662f\u4e0d\u540c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5982\u679c\u8981\u8bb0\u5f55\u5f53\u524d\u8fd9\u6b21\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48\u8fd9\u4e2a\u6307\u4ee4\u7684\u5730\u5740\u6216\u8005\u4e00\u4e2a id \u6240\u5360\u7528\u7684\u7a7a\u95f4\u4f1a\u5f88\u5927\uff1b\u5982\u679c\u4e0d\u8bb0\u5f55\u5f53\u524d\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u5206\u652f\u5206\u652f\u6307\u4ee4\uff0c\u5c31\u9700\u8981\u5728\u540e\u7eed\u5904\u7406\u7684\u65f6\u5019\uff0c\u7ed3\u5408\u53ef\u6267\u884c\u7a0b\u5e8f\u7684\u6c47\u7f16\u6765\u63a8\u65ad\uff0c\u5f53\u524d\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4</li>\n<li>\u5176\u6b21\u5c31\u662f\u8981\u8bb0\u5f55\u6761\u4ef6\u5206\u652f\u8df3\u8f6c\u4e0e\u5426\uff0c\u8fd9\u4e00\u4e2a\u7684\u5f00\u9500\u76f8\u5bf9\u4f1a\u5c0f\u4e00\u4e9b\uff0c\u53ea\u9700\u8981\u4e00\u4e2a bit</li>\n</ol>\n<p>\u7531\u6b64\u53ef\u4ee5\u63a8\u5bfc\u51fa\u4e0d\u540c\u7684 trace \u8bb0\u5f55\u65b9\u5f0f\uff1a</p>\n<p>\u7b2c\u4e00\u79cd\u65b9\u5f0f\u662f\uff0c\u9047\u5230\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u65f6\uff0c\u53ea\u8bb0\u5f55\u8df3\u8f6c\uff08Taken\uff09\u8fd8\u662f\u4e0d\u8df3\u8f6c\uff08Not Taken\uff09\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4fdd\u5b58\u7684\u6570\u636e\u91cf\u6700\u5c0f\uff08\u5e73\u5747\u6bcf\u4e2a\u5206\u652f\u53ea\u9700\u8981\u6bd4 1 bit \u7565\u591a\u7684\u7a7a\u95f4\uff09\uff0c\u4f46\u662f\u540e\u7eed\u9700\u8981\u7ed3\u5408\u6c47\u7f16\uff0c\u6062\u590d\u51fa\u6267\u884c\u7684\u8fc7\u7a0b\uff0c\u66f4\u8fdb\u4e00\u6b65\u8fd8\u53ef\u4ee5\u538b\u7f29\u90a3\u4e9b return \u7684\u76ee\u7684\u5730\u5740\u7b49\u4e8e\u5bf9\u5e94\u7684 call \u6307\u4ee4\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\u7684\u5730\u5740\u7684\u60c5\u51b5\uff08Indirect Transfer Compression for Returns\uff09\u3002Intel PT \u91c7\u7528\u7684\u662f\u8fd9\u79cd\u65b9\u6cd5\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u662f\uff0c\u9047\u5230\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u65f6\uff0c\u4e0d\u4ec5\u8bb0\u5f55\u8df3\u8f6c\u4e0e\u5426\uff0c\u8fd8\u8bb0\u5f55\u5b83\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u5206\u652f\u6307\u4ee4\u3002\u8fd9\u79cd\u65b9\u5f0f\u4fdd\u5b58\u7684\u6570\u636e\u91cf\u7a0d\u591a\uff0c\u5047\u5982\u8981\u652f\u6301 5e4 \u6761\u4e0d\u540c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u4e3a\u4e86\u4fdd\u5b58\u8fd9\u4e2a id\uff0c\u5c31\u9700\u8981 16 \u4f4d\u3002\u7c7b\u4f3c\u5730\uff0c\u4e5f\u53ef\u4ee5\u53ea\u8bb0\u5f55\u8df3\u8f6c\u4e86\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48\u90a3\u4e9b\u6ca1\u6709\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5c31\u9700\u8981\u540e\u7eed\u7ed3\u5408\u6c47\u7f16\u6216\u8005\u5b8c\u6574\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u8868\u6765\u6062\u590d\u51fa\u6765\u3002CBP Championship \u7684 trace \u91c7\u7528\u7684\u662f\u8fd9\u79cd\u65b9\u6cd5\u3002</p>\n<p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u660e\u663e\u7a7a\u95f4\u4f1a\u66f4\u5c0f\uff0c\u4ee5 2.9e12 \u6761\u6267\u884c\u7684\u5206\u652f\u6307\u4ee4\u6570\uff0c\u5927\u6982\u9700\u8981 300GB \u7684\u78c1\u76d8\u7a7a\u95f4\uff1b\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff0c\u540c\u6837\u7684\u5206\u652f\u6307\u4ee4\u6570\uff0c\u5c31\u9700\u8981\u5927\u6982 5.8TB \u7684\u78c1\u76d8\u7a7a\u95f4\u3002\u5f53\u7136\u4e86\uff0c\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u5b58\u7684\u6570\u636e\u53ef\u4ee5\u7ecf\u8fc7\u65e0\u635f\u538b\u7f29\u8fdb\u4e00\u6b65\u7f29\u5c0f\u7a7a\u95f4\uff0c\u5b9e\u6d4b\u538b\u7f29\u540e\u5927\u6982\u662f\u6bcf\u5206\u652f 0.16 \u5b57\u8282\uff08\u8fd9\u4e2a\u6570\u5b57\u4e0e\u6240\u8dd1\u7684 benchmark \u6709\u5173\u7cfb\uff0c\u5206\u652f\u5bb9\u6613\u88ab\u9884\u6d4b\u7684 benchmark \u5bf9\u5e94\u66f4\u597d\u7684\u538b\u7f29\u7387\uff0c\u56e0\u4e3a\u67d0\u79cd\u610f\u4e49\u6765\u8bf4\u5206\u652f\u9884\u6d4b\u4e5f\u662f\u4e00\u79cd\u65e0\u635f\u538b\u7f29\uff09\uff0c\u53ea\u6bd4\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5927\u6982\u6bcf\u5206\u652f 0.14 \u5b57\u8282\u7565\u5927\u3002\u540c\u7406\uff0c\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5b58\u7684\u6570\u636e\u4e5f\u53ef\u4ee5\u7ecf\u8fc7\u65e0\u635f\u538b\u7f29\u8fdb\u4e00\u6b65\u7f29\u5c0f\u7a7a\u95f4\uff0c\u8fbe\u5230\u6bcf\u5206\u652f\u5927\u7ea6 0.018 \u5b57\u8282\u7684\u7a0b\u5ea6\uff08\u538b\u7f29\u7387\u4e5f\u548c\u5206\u652f\u9884\u6d4b\u51c6\u786e\u7387\u6709\u5173\uff09\u3002</p>\n<p>\u5728\u8bc4\u4f30\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u65f6\u5019\uff0c\u9664\u4e86\u77e5\u9053\u5206\u652f\u672c\u8eab\uff0c\u8fd8\u9700\u8981\u77e5\u9053\u6267\u884c\u7684\u6307\u4ee4\u6570\uff0c\u7528\u4e8e\u8ba1\u7b97 MPKI \u7b49\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u901a\u8fc7 PMU \u5355\u72ec\u7edf\u8ba1\u51fa\u6765\uff0c\u6216\u8005\u76f4\u63a5\u6839\u636e\u63a7\u5236\u6d41\u63a8\u7b97\u51fa\u6267\u884c\u7684\u6307\u4ee4\u6570\uff0c\u4f8b\u5982\u5728\u7b49\u957f\u6307\u4ee4\u7684 ISA \u4e0a\u76f4\u63a5\u7528\u5730\u5740\u5dee\u9664\u4ee5\u6307\u4ee4\u957f\u5ea6\u6765\u8ba1\u7b97\u6307\u4ee4\u6570\uff0c\u5728\u53d8\u957f\u6307\u4ee4\u7684 ISA \u4e0a Parse ELF \u53bb\u89e3\u6790\u63a7\u5236\u6d41\u7ecf\u8fc7\u7684\u6307\u4ee4\uff1a</p>\n<ol>\n<li>\u89e3\u6790 ELF\uff0c\u7528\u53cd\u6c47\u7f16\u5668\u5f97\u5230\u6bcf\u6761\u6307\u4ee4\u7684\u5730\u5740\uff0c\u4ece\u5c0f\u5230\u5927\u6392\u5e8f\u653e\u5230\u6570\u7ec4\u4e2d</li>\n<li>\u5bf9\u4e8e\u6bcf\u4e2a\u5206\u652f\u5730\u5740\u548c\u76ee\u7684\u5730\u5740\uff0c\u67e5\u8be2\u5b83\u5bf9\u5e94\u7684\u6307\u4ee4\u5728\u6307\u4ee4\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u8bb0\u5f55\u4e0b\u6765</li>\n<li>\u7edf\u8ba1\u6307\u4ee4\u6570\u65f6\uff0c\u6bcf\u9047\u5230\u4e00\u4e2a\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u5c31\u7528\u5f53\u524d\u8df3\u8f6c\u7684\u5206\u652f\u7684\u5206\u652f\u5730\u5740\u5728\u6307\u4ee4\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u51cf\u53bb\u4e0a\u4e00\u4e2a\u8df3\u8f6c\u7684\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u5728\u6307\u4ee4\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u52a0\u4e0a\u4e00\uff0c\u7d2f\u52a0\u5230\u6307\u4ee4\u6570\u4e2d</li>\n</ol>\n<p>\u5f53\u7136\u4e86\uff0c\u8fd9\u91cc\u6709\u4e00\u4e9b\u7ec6\u8282\uff0c\u4f8b\u5982\u5982\u679c\u7a0b\u5e8f\u662f PIE\uff0c\u90a3\u4e48\u9700\u8981\u77e5\u9053\u5b83\u52a0\u8f7d\u7684\u57fa\u5730\u5740\uff0c\u4ece\u800c\u628a\u8fd0\u884c\u65f6\u7684\u6307\u4ee4\u5730\u5740\u548c ELF \u5bf9\u5e94\u8d77\u6765\uff1b\u7c7b\u4f3c\u5730\uff0c\u5982\u679c\u7a0b\u5e8f\u52a0\u8f7d\u4e86 libc \u7b49\u52a8\u6001\u5e93\uff0c\u4e5f\u9700\u8981\u77e5\u9053\u5b83\u4eec\u7684\u52a0\u8f7d\u5730\u5740\u3002\u8fd9\u4e9b\u4fe1\u606f\u53ef\u4ee5\u5728\u6293\u53d6\u6307\u4ee4 trace \u7684\u540c\u65f6\uff0c\u987a\u5e26\u8bb0\u5f55\u4e0b\u6765\u3002\u5982\u679c\u60f3\u89c4\u907f\u8fd9\u4e2a\u9ebb\u70e6\uff0c\u53ef\u4ee5\u4f7f\u7528\u9759\u6001\u7f16\u8bd1\uff0c\u4e0d\u8fc7 vdso \u4f9d\u7136\u4f1a\u52a8\u6001\u52a0\u8f7d\uff0c\u4f46 vdso \u5185\u6307\u4ee4\u5f88\u5c11\uff0c\u901a\u5e38\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\uff0c\u53ef\u4ee5\u7279\u5224\u5ffd\u7565\u6389\u3002</p>\n<p>\u6b64\u5916\uff0c\u5982\u679c\u5206\u652f\u9884\u6d4b\u5668\u9700\u8981\u77e5\u9053\u5206\u652f\u6307\u4ee4\u7684 fallthrough \u5730\u5740\uff08\u4f8b\u5982 Path History Register\uff09\uff0c\u4e14\u4f7f\u7528\u7684\u662f\u53d8\u957f\u6307\u4ee4\u96c6\uff0c\u8fd8\u9700\u8981\u8bb0\u5f55\u5206\u652f\u6307\u4ee4\u7684\u957f\u5ea6\u3002\u8fd9\u4e9b\u9700\u6c42\u5b9e\u73b0\u8d77\u6765\u90fd\u5e76\u4e0d\u590d\u6742\uff0c\u4e5f\u53ea\u9700\u8981\u5360\u7528\u5f88\u5c0f\u7684\u7a7a\u95f4\u3002</p>\n<p>TB \u7ea7\u522b\u7684\u89c4\u6a21\uff0c\u65e0\u8bba\u662f\u4fdd\u5b58\u8fd9\u4e9b\u6570\u636e\uff0c\u8fd8\u662f\u751f\u6210\u8fd9\u4e9b\u6570\u636e\uff0c\u6216\u8005\u66f4\u8fdb\u4e00\u6b65\u5728\u8fd9\u4e9b\u6570\u636e\u4e0a\u6a21\u62df\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u90fd\u4f1a\u5e26\u6765\u5f88\u5927\u7684\u8d1f\u62c5\u3002\u56e0\u6b64\uff0c\u9700\u8981\u4e00\u4e2a\u529e\u6cd5\u6765\u51cf\u5c11\u8981\u6a21\u62df\u7684 trace \u957f\u5ea6\u3002</p>\n<h2 id=\"simpoint\">SimPoint<a class=\"headerlink\" href=\"#simpoint\" title=\"Permanent link\">&para;</a></h2>\n<p><a href=\"https://cseweb.ucsd.edu/~calder/papers/ASPLOS-02-SimPoint.pdf\">SimPoint</a> \u662f\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u65b9\u6cd5\uff1a\u5b83\u89c2\u5bdf\u5230\u4e86\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u73b0\u8c61\uff0c\u5c31\u662f\u8fd9\u4e9b benchmark \u5176\u5b9e\u5927\u591a\u6570\u65f6\u5019\u662f\u5728\u91cd\u590d\u505a\u76f8\u540c\u7684\u4e8b\u60c5\uff0c\u53ea\u4e0d\u8fc7\u6d89\u53ca\u5230\u7684\u6570\u636e\u4e0d\u540c\u3002\u8fd9\u4e5f\u5f88\u597d\u7406\u89e3\uff0c\u56e0\u4e3a\u5f88\u591a\u7a0b\u5e8f\u91cc\u9762\u90fd\u662f\u5faa\u73af\uff0c\u800c\u5faa\u73af\u662f\u5f88\u6709\u89c4\u5f8b\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u9884\u671f\u7a0b\u5e8f\u7684\u884c\u4e3a\u5728\u65f6\u95f4\u5c3a\u5ea6\u4e0a\u4e5f\u4f1a\u6709\u4e00\u5b9a\u7684\u5468\u671f\u6027\u3002\u4e0b\u9762\u662f SimPoint \u8bba\u6587\u4e2d\u7684\u4e00\u4e2a\u56fe\uff0c\u5b83\u8bb0\u5f55\u4e86 gzip-graphic benchmark \u7684 IPC\uff08\u6bcf\u5468\u671f\u6307\u4ee4\u6570\uff0c\u56fe\u4e2d\u7684\u5b9e\u7ebf\uff09\u548c L1 \u6570\u636e\u7f13\u5b58\u7f3a\u5931\u7387\uff08\u56fe\u4e2d\u7684\u865a\u7ebf\uff09\u968f\u7740\u6267\u884c\u8fc7\u7a0b\u7684\u53d8\u5316\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u6bd4\u8f83\u660e\u663e\u7684\u5468\u671f\u6027\uff0c\u800c\u6d89\u53ca\u5230\u5468\u671f\u6027\uff0c\u5c31\u4f1a\u60f3\u5230\u5229\u7528\u5468\u671f\u7684\u6027\u8d28\uff1a\u5982\u679c\u5728\u4e00\u4e2a\u5468\u671f\u4e0a\u8bc4\u4f30\u5b83\u7684 IPC \u6216\u8005\u5206\u652f\u9884\u6d4b\u5668\u7684\u51c6\u786e\u7387\uff0c\u7136\u540e\u5916\u63a8\u5230\u5176\u4ed6\u7684\u5468\u671f\uff0c\u662f\u4e0d\u662f\u5927\u5927\u7f29\u5c0f\u4e86\u6267\u884c\u65f6\u95f4\uff1fSimPoint \u5229\u7528\u8fd9\u4e2a\u601d\u60f3\uff0c\u8bbe\u8ba1\u4e86\u5982\u4e0b\u7684\u6b65\u9aa4\uff1a</p>\n<ol>\n<li>\u9996\u5148\u628a\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u6309\u7167\u6267\u884c\u7684\u6307\u4ee4\u6570\u5207\u5206\u6210\u5f88\u591a\u4e2a slice</li>\n<li>\u63a5\u7740\u5bf9 slice \u8fdb\u884c\u805a\u7c7b\uff0c\u4f7f\u5f97\u6bcf\u4e00\u4e2a\u7c7b\u5185\u7684 slice \u7684\u884c\u4e3a\u7c7b\u4f3c\uff0c\u8fd9\u4e2a\u7c7b\u5c31\u53eb\u505a\u4e00\u4e2a phase</li>\n<li>\u4e4b\u540e\u505a\u5b9e\u9a8c\u7684\u65f6\u5019\uff0c\u53ea\u9700\u8981\u5bf9\u6bcf\u4e2a phase \u5185\u7684\u4e00\u4e2a slice \u8fdb\u884c\u5b9e\u9a8c\uff0c\u8bc4\u4f30\u51fa\u5b83\u7684 IPC \u6216\u8005\u5176\u4ed6\u6027\u80fd\u6307\u6807\uff0c\u518d\u6309\u7167 phase \u5185\u7684 slice \u6570\u91cf\u52a0\u6743\u5e73\u5747\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u5b8c\u6574\u6267\u884c\u8fc7\u7a0b\u7684\u6027\u80fd\u6307\u6807\u4e86</li>\n</ol>\n<p>\u8fd9\u91cc\u6bd4\u8f83\u6838\u5fc3\u7684\u6b65\u9aa4\uff0c\u5c31\u662f\u600e\u4e48\u5bf9 slice \u805a\u7c7b\uff1fSimPoint \u8bba\u6587\u91c7\u7528\u4e86\u673a\u5668\u5b66\u4e60\u7684\u65b9\u6cd5\uff1a\u9488\u5bf9\u6bcf\u4e2a slice\uff0c\u7edf\u8ba1\u5b83\u5728\u4e0d\u540c Basic Block \u5185\u6267\u884c\u7684\u65f6\u95f4\u7684\u6bd4\u4f8b\uff0c\u628a\u8fd9\u4e2a\u7edf\u8ba1\u6570\u636e\u8bb0\u4e3a Basic Block Vector\uff1b\u90a3\u4e48\u805a\u7c7b\uff0c\u5c31\u662f\u9488\u5bf9\u90a3\u4e9b Basic Block Vector \u76f8\u8fd1\u7684 Slice\uff0c\u8fdb\u884c K-Means \u7b97\u6cd5\u3002</p>\n<p>\u7531\u4e8e K-Means \u7b97\u6cd5\u6267\u884c\u7684\u65f6\u5019\uff0c\u9700\u8981\u9996\u5148\u77e5\u9053\u805a\u51fa\u6765\u591a\u5c11\u4e2a\u7c7b\uff0c\u6240\u4ee5 SimPoint \u679a\u4e3e\u4e86\u82e5\u5e72\u4e2a\u4e0d\u540c\u7684\u7c7b\u7684\u4e2a\u6570\uff0c\u5bf9\u6bcf\u4e2a K-Means \u805a\u7c7b\u7ed3\u679c\u8fdb\u884c\u6253\u5206\uff1aBIC\uff08Bayesian Information Criterion\uff09\uff0c\u6839\u636e\u6253\u5206\u627e\u5230\u4e00\u4e2a\u805a\u7c7b\u6548\u679c\u8db3\u591f\u597d\uff0c\u4f46\u662f\u7c7b\u53c8\u4e0d\u662f\u7279\u522b\u591a\u7684\u7ed3\u679c\u3002</p>\n<p>\u8fdb\u4e00\u6b65\u4e3a\u4e86\u63d0\u5347\u805a\u7c7b\u7684\u6027\u80fd\uff0cSimPoint \u8fd8\u8fdb\u884c\u4e86\u4e00\u6b21\u964d\u7ef4\u64cd\u4f5c\uff0c\u628a\u5f88\u957f\u7684 Basic Block Vector \u7ebf\u6027\u6620\u5c04\u5230\u4e00\u4e2a\u6bd4\u8f83\u5c0f\u7684 15 \u7ef4\u7684\u5411\u91cf\u4e0a\u3002</p>\n<p>SimPoint \u8bba\u6587\u4e2d\u5c55\u793a\u4e86\u805a\u7c7b\u7684\u6548\u679c\uff0c\u8fd8\u662f\u5f88\u53ef\u89c2\u7684\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-2.png\" /></p>\n<p>\u5b8c\u6210\u805a\u7c7b\u4ee5\u540e\uff0cSimPoint \u7684\u8f93\u51fa\u5c31\u662f\u82e5\u5e72\u4e2a phase\uff0c\u6bcf\u4e00\u4e2a\u7c7b\u5bf9\u5e94\u4e00\u4e2a phase\uff0c\u6bcf\u4e2a phase \u5305\u62ec\uff1a</p>\n<ol>\n<li>\u6743\u91cd\uff1a\u6743\u91cd\u5c31\u662f\u8fd9\u4e2a\u7c7b\u4e2d slice \u7684\u4e2a\u6570</li>\n<li>\u4ee3\u8868\u8fd9\u4e2a phase \u7684\u4e00\u4e2a slice \u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u5b83\u662f\u4ece\u7b2c\u51e0\u6761\u6307\u4ee4\u5f00\u59cb\u5230\u7b2c\u51e0\u6761\u6307\u4ee4</li>\n</ol>\n<p>\u5b8c\u6210 SimPoint \u7b97\u6cd5\u540e\uff0c\u5f97\u5230\u7684 trace \u957f\u5ea6\u5927\u5927\u51cf\u5c0f\uff0c\u4f8b\u5982\u4e00\u6bb5\u539f\u59cb\u7684\u957f\u4e3a 1e10 \u6761\u6307\u4ee4\u7684 trace\uff0c\u4ee5 3e7 \u6761\u6307\u4ee4\u4e3a\u4e00\u4e2a slice\uff0c\u805a\u7c7b\u4ee5\u540e\uff0c\u53ea\u5269\u4e0b 10 \u4e2a phase\uff0c\u90a3\u4e48\u9700\u8981\u6a21\u62df\u548c\u4fdd\u5b58\u7684 trace \u957f\u5ea6\u53ea\u5269\u4e0b\u4e86 3e8 \u6761\u6307\u4ee4\u3002SimPoint \u805a\u7c7b\u6574\u4e2a\u6d41\u7a0b\u7684\u6027\u80fd\u5927\u6982\u5728\u6bcf\u79d2 2e8 \u6761\u5206\u652f\u6307\u4ee4\u7684\u91cf\u7ea7\u3002</p>\n<p>\u56de\u987e\u524d\u9762\u63d0\u5230\u7684\u5b8c\u6574\u7684 SPEC INT 2017 \u7684\u91cf\u7ea7\uff1a2.9e12 \u6761\u6267\u884c\u7684\u5206\u652f\u6307\u4ee4\u6570\uff0c\u7ecf\u8fc7 SimPoint \u5904\u7406\u540e\uff0c\u5047\u5982\u6bcf\u4e2a\u5b50 benchmark \u62c6\u5206\u6210 15 \u4e2a\u957f\u5ea6\u4e3a 1e8 \u6761\u6307\u4ee4\u7684 phase\uff0c\u90a3\u4e48\u6700\u7ec8\u53ef\u80fd\u53ea\u9700\u8981 3e10 \u6761\u6307\u4ee4\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u5904\u7406\u7684\u5927\u5c0f\u4e86\uff0c\u4ee5\u5355\u6838\u6bcf\u79d2\u6a21\u62df 1e7 \u6761\u5206\u652f\u6307\u4ee4\u7684\u901f\u5ea6\uff0c\u5b8c\u6574\u8dd1\u4e00\u6b21\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\uff0c\u53ef\u80fd\u53ea\u9700\u8981\u51e0\u5341\u5206\u949f\u7684\u65f6\u95f4\uff0c\u518d\u52a0\u4e0a\u591a\u6838\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u7f29\u77ed\u5230\u51e0\u5206\u949f\u3002</p>\n<h2 id=\"trace-\u6293\u53d6\">trace \u6293\u53d6<a class=\"headerlink\" href=\"#trace-\u6293\u53d6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u521a\u624d\u8ba8\u8bba\u4e86\u5f88\u591a trace \u7684\u5927\u5c0f\u4ee5\u53ca\u5982\u4f55\u7528 SimPoint \u538b\u7f29\u7a7a\u95f4\uff0c\u90a3\u4e48\u8fd9\u4e2a trace \u5230\u5e95\u600e\u4e48\u6293\u53d6\u5462\uff1f\u4e3b\u8981\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\u57fa\u4e8e\u786c\u4ef6\u5df2\u6709\u7684 trace\uff0c\u6bd4\u5982 <a href=\"../../../../2024/12/10/linux-perf-pmu/\">Intel PT</a>\uff0c\u4f46\u9700\u8981\u6ce8\u610f\uff0cIntel PT \u662f\u53ef\u80fd\u4e22\u5931\u5386\u53f2\u7684\uff0c\u867d\u7136\u6bd4\u4f8b\u6bd4\u8f83\u5c0f\uff1b\u4e3a\u4e86\u907f\u514d\u4e22\u5931\u5386\u53f2\uff0c\u5efa\u8bae\u8bbe\u7f6e <code>sysctl kernel.perf_event_paranoid=-1</code>\uff08\u6216\u8005\u7528 root \u6743\u9650\u6765\u8fd0\u884c <code>perf record</code>\uff0c\u5373\u7ed5\u8fc7 <code>mlock limit after perf_event_mlock_kb</code> \u7684\u9650\u5236\uff09\u6765\u6269\u5927 Intel PT \u4f7f\u7528\u7684 buffer \u5927\u5c0f\uff0c\u4ece 32KB \u6269\u5927\u5230 1MB\uff08\u53c2\u8003 <a href=\"https://github.com/mysqlperformance/pt_perf\">pt_perf</a>\uff09\uff0c\u5728\u5927\u5c0f\u6838\u673a\u5668\u4e0a\u8fd8\u8981\u7ed1\u5b9a\u5230\u4e00\u4e2a\u5927\u6838\u4e0a</li>\n<li>\u57fa\u4e8e\u8f6f\u4ef6\u7684 Binary Instrumentation\uff0c\u5373\u9488\u5bf9\u5206\u652f\u6307\u4ee4\u63d2\u6869\uff0c\u6bd4\u5982 Pin\u3001DynamoRIO \u751a\u81f3 QEMU</li>\n</ol>\n<p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u6027\u80fd\u662f\u6700\u597d\u7684\uff0c\u8fd0\u884c\u5f00\u9500\u6bd4\u8f83\u5c0f\uff0c\u8017\u8d39 1.4x \u7684\u65f6\u95f4\uff0c\u4f46\u662f\u540e\u7eed\u5904\u7406\u4e5f\u6bd4\u8f83\u8d39\u52b2\u4e00\u4e9b\uff0c\u6b64\u5916\u6bd4\u8f83\u4f9d\u8d56\u5e73\u53f0\uff0cARM \u4e0a\u867d\u7136\u4e5f\u6709 SPE\uff0c\u4f46\u662f\u652f\u6301\u7684\u5e73\u53f0\u6bd4\u8f83\u5c11\u3002\u5176\u4ed6\u5e73\u53f0\u5c31\u4e0d\u597d\u8bf4\u4e86\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u6027\u80fd\u4f1a\u5dee\u4e00\u4e9b\uff0c\u5927\u6982\u4f1a\u6709 30-50x \u7684\u6027\u80fd\u5f00\u9500\uff0c\u4f46\u662f\u4e00\u5929\u4e00\u591c\u4e5f\u80fd\u591f\u628a SPEC INT 2017 \u8dd1\u5b8c\u3002\u5b9e\u73b0\u7684\u65f6\u5019\uff0c\u9700\u8981\u6ce8\u610f\u5728\u9047\u5230\u5206\u652f\u7684\u65f6\u5019\uff0c\u9996\u5148\u628a\u4fe1\u606f\u4fdd\u5b58\u5728\u5185\u5b58\u7684 buffer \u4e2d\uff0cbuffer \u6ee1\u4e86\u518d\u5199\u76d8\uff1b\u6b64\u5916\uff0c\u4e3a\u4e86\u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4\u4ee5\u53ca\u5199\u76d8\u6240\u8017\u8d39\u7684 I/O \u65f6\u95f4\uff0c\u53ef\u4ee5\u5728\u5185\u5b58\u4e2d\u4e00\u8fb9\u751f\u6210\u6570\u636e\u4e00\u8fb9\u538b\u7f29\uff0c\u76f4\u63a5\u628a\u538b\u7f29\u597d\u7684\u6570\u636e\u5199\u5165\u5230\u6587\u4ef6\u4e2d\u3002</p>\n<p>\u5b9e\u8df5\u4e2d\uff0c\u53ef\u4ee5\u5148\u7528 Intel PT \u6293\u53d6 trace\uff0c\u518d\u628a trace \u8f6c\u6362\u4e3a\u7b2c\u4e8c\u79cd\u683c\u5f0f\uff0c\u6700\u7ec8\u7684\u6293\u53d6 + \u8f6c\u6362\u7684\u6027\u80fd\u5f00\u9500\u5927\u6982\u662f 15x\u3002\u5927\u81f4\u7b97\u6cd5\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u904d\u5386\u7a0b\u5e8f\u4e2d\u6240\u6709\u7684\u5206\u652f\uff0c\u6309\u7167\u5730\u5740\u4ece\u5c0f\u5230\u5927\u4fdd\u5b58\u8d77\u6765\u5728\u6570\u7ec4\u5f53\u4e2d\uff0c\u9488\u5bf9\u90a3\u4e9b\u76f4\u63a5\u5206\u652f\uff0c\u63d0\u524d\u8ba1\u7b97\u597d\u4ece\u5b83\u7684\u76ee\u7684\u5730\u5740\u5f00\u59cb\u9047\u5230\u7684\u7b2c\u4e00\u4e2a\u5206\u652f\u5728\u6570\u7ec4\u7684\u4e0b\u6807</li>\n<li>\u89e3\u6790 perf.data \u4e2d\u7684 Intel PT packet\uff0c\u63d0\u53d6\u51fa\u5176\u4e2d\u7684 TNT \u548c TIP packet\uff0c\u4ece\u7a0b\u5e8f\u7684 entrypoint \u5f00\u59cb\uff0c\u6cbf\u7740 Intel PT \u7684 trace \u91cd\u5efa\u63a7\u5236\u6d41\uff1a\u6761\u4ef6\u5206\u652f\u4ece TNT packet \u83b7\u53d6\u65b9\u5411\uff0c\u95f4\u63a5\u5206\u652f\u4ece TIP packet \u83b7\u53d6\u76ee\u7684\u5730\u5740\uff0c</li>\n<li>\u5982\u679c\u5206\u652f\u8df3\u8f6c\u4e86\uff0c\u5c31\u6839\u636e\u76ee\u7684\u5730\u5740\u627e\u5230\u4ece\u76ee\u7684\u5730\u5740\u5f00\u59cb\u9047\u5230\u7684\u4e0b\u4e00\u4e2a\u5206\u652f\uff08\u4e8c\u5206\u67e5\u627e\uff09\uff1b\u5982\u679c\u6ca1\u6709\u8df3\u8f6c\uff0c\u5c31\u76f4\u63a5\u8bbf\u95ee\u6570\u7ec4\u7684\u4e0b\u4e00\u4e2a\u5206\u652f</li>\n<li>\u6ce8\u610f RET compression \u7684\u5904\u7406\uff1a\u7ef4\u62a4 call stack\uff0c\u5982\u679c\u9047\u5230 return \u7684\u65f6\u5019\u521a\u597d\u5728 TNT packet \u4e2d\uff0c\u4e14\u5bf9\u5e94\u7684 bit \u662f Taken\uff0c\u5219\u4ece call stack \u53d6\u51fa\u76ee\u7684\u5730\u5740\uff1b\u4e00\u4e2a\u4f18\u5316\u662f call stack \u4e0d\u4ec5\u8bb0\u5f55\u5730\u5740\uff0c\u8fd8\u8bb0\u5f55\u4ece\u8fd9\u4e2a\u5730\u5740\u5f00\u59cb\u9047\u5230\u7684\u4e0b\u4e00\u4e2a\u5206\u652f\u5728\u6570\u7ec4\u7684\u4e0b\u6807</li>\n<li>\u91cd\u5efa\u63a7\u5236\u6d41\u7684\u540c\u65f6\uff0c\u8f93\u51fa\u7b2c\u4e8c\u79cd\u683c\u5f0f\u7684 trace\uff0c\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\u6d41\u5f0f\u538b\u7f29</li>\n</ol>\n<p>\u4ee5\u4e0a\u7684\u8fd9\u4e9b\u6027\u80fd\u5f00\u9500\u53ea\u662f\u5728\u4e00\u4e2a\u7a0b\u5e8f\u4e0a\u6d4b\u5f97\u7684\u7ed3\u679c\uff0c\u4e0d\u540c\u7684\u7a0b\u5e8f\u4e0a\uff0c\u5176\u6027\u80fd\u5f00\u9500\u4e5f\u6709\u5f88\u5927\u7684\u4e0d\u540c\u3002</p>\n<p>\u5bf9\u4e8e\u52a8\u6001\u94fe\u63a5\uff0cperf.data \u4f1a\u8bb0\u5f55 mmap event\uff1bPin \u548c DynamoRIO \u90fd\u53ef\u4ee5\u5bf9 module load \u4e8b\u4ef6\u8fdb\u884c\u63d2\u6869\u3002\u52a8\u6001\u5e93\u53ef\u4ee5\u4ece\u6587\u4ef6\u7cfb\u7edf\u4e2d\u8bbf\u95ee\uff0cvdso \u53ef\u4ee5\u4ece\u5185\u5b58\u4e2d<a href=\"https://ldpreload.com/p/blog/dump-vdso.c\">\u5bfc\u51fa</a>\u3002</p>\n<h2 id=\"\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\">\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df<a class=\"headerlink\" href=\"#\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u5b8c\u6210\u4e86\u524d\u9762\u7684\u5927\u90e8\u5206\u6b65\u9aa4\u4ee5\u540e\uff0c\u6700\u7ec8\u5c31\u662f\u642d\u5efa\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u6a21\u62df\u5668\u4e86\u3002\u5176\u5b9e\u8fd9\u4e00\u70b9\u5012\u662f\u5e76\u4e0d\u590d\u6742\uff0c\u4f8b\u5982 CBP Championship \u6216\u8005 ChampSim \u90fd\u6709\u73b0\u6210\u7684\u6846\u67b6\uff0c\u5b83\u4eec\u4e5f\u90fd\u63d0\u4f9b\u4e86\u4e00\u4e9b\u7ecf\u5178\u7684\u5206\u652f\u9884\u6d4b\u5668\u7684\u5b9e\u73b0\u4ee3\u7801\uff0c\u4f8b\u5982 TAGE-SC-L\u3002\u5728\u5b83\u4eec\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u5f00\u53d1\uff0c\u5c31\u53ef\u4ee5\u8bc4\u4f30\u5404\u79cd\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u9884\u6d4b\u6548\u679c\u4e86\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u9664\u4e86\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u5b9e\u9a8c\u4e5f\u53ef\u4ee5\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6784\u5efa trace \u7136\u540e\u8fd0\u884c\u3002\u4f46\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6709\u4e2a\u6bd4\u8f83\u597d\u7684\u7279\u70b9\uff1a\u5b83\u9700\u8981\u7684\u72b6\u6001\u6bd4\u8f83\u7b80\u5355\uff0c\u901a\u5e38\u62ff\u4e4b\u524d\u4e00\u6bb5\u6307\u4ee4\u505a\u9884\u70ed\u5373\u53ef\uff0c\u4e0d\u9700\u8981 checkpoint\uff1b\u800c\u5982\u679c\u8981\u5b8c\u6574\u6a21\u62df\u6574\u4e2a\u5904\u7406\u5668\u7684\u6267\u884c\uff0c\u901a\u5e38\u9700\u8981\u5f97\u5230\u7cfb\u7edf\u7684\u6574\u4e2a\u72b6\u6001\uff0c\u6bd4\u5982\u5185\u5b58\u548c\u5bc4\u5b58\u5668\uff0c\u624d\u80fd\u7ee7\u7eed\u6267\u884c\uff0c\u8fd9\u65f6\u5019\u5c31\u53ef\u80fd\u9700\u8981\u63d0\u524d\u628a slice \u5f00\u59cb\u7684\u72b6\u6001\u4fdd\u5b58\u4e0b\u6765\uff08checkpoint\uff09\uff0c\u6216\u8005\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u4e0d\u7cbe\u786e\u7684\u6a21\u62df\u5668\u5feb\u901f\u8ba1\u7b97\u51fa slice \u5f00\u59cb\u7684\u72b6\u6001\uff08fast forwarding\uff09\u3002</p>\n<h2 id=\"\u5b9e\u9a8c\u6570\u636e\">\u5b9e\u9a8c\u6570\u636e<a class=\"headerlink\" href=\"#\u5b9e\u9a8c\u6570\u636e\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"trace-\u6293\u53d6_1\">Trace \u6293\u53d6<a class=\"headerlink\" href=\"#trace-\u6293\u53d6_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u8fd9\u91cc\u5217\u51fa\u6700\u7ec8\u4f7f\u7528\u7684 trace \u683c\u5f0f\u548c\u5b9e\u9a8c\u6570\u636e\uff1a</p>\n<ol>\n<li>trace \u683c\u5f0f\uff1a\u4f7f\u7528\u7b2c\u4e8c\u79cd trace \u8bb0\u5f55\u65b9\u6cd5\uff0c\u6bcf\u6b21\u6267\u884c branch \u8bb0\u5f55 4 \u5b57\u8282\u7684\u4fe1\u606f\uff0c\u5305\u62ec branch id \u548c\u662f\u5426\u8df3\u8f6c\uff0c\u4f7f\u7528 zstd \u8fdb\u884c\u65e0\u635f\u538b\u7f29</li>\n<li>trace \u5927\u5c0f\u548c\u8fd0\u884c\u65f6\u95f4\u7edf\u8ba1\uff08GCC 12.2.0\uff0c<code>-O3 -static</code> \u7f16\u8bd1\uff0c\u5728 Intel i9-14900K \u4e0a\u5b9e\u9a8c\uff09\uff1a</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>\u5b50 benchmark</th>\n<th>\u5206\u652f\u6267\u884c\u6b21\u6570</th>\n<th>trace \u5927\u5c0f</th>\n<th>\u6bcf\u5206\u652f\u7a7a\u95f4\u5f00\u9500</th>\n<th>\u7a0b\u5e8f\u76f4\u63a5\u8fd0\u884c\u65f6\u95f4</th>\n<th>Pin \u6293\u53d6\u65f6\u95f4</th>\n<th>\u65f6\u95f4\u5f00\u9500</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>500.perlbench_r</td>\n<td>checkspam</td>\n<td>2.40e11</td>\n<td>8.87 GiB</td>\n<td>0.32 bit</td>\n<td>59s</td>\n<td>6334s</td>\n<td>107x</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>diffmail</td>\n<td>1.49e11</td>\n<td>2.78 GiB</td>\n<td>0.16 bit</td>\n<td>33s</td>\n<td>4615s</td>\n<td>140x</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>splitmail</td>\n<td>1.33e11</td>\n<td>1.49 GiB</td>\n<td>0.10 bit</td>\n<td>31s</td>\n<td>3385s</td>\n<td>109x</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>Total</td>\n<td>5.22e11</td>\n<td>13.14 GiB</td>\n<td>0.22 bit</td>\n<td>123s</td>\n<td>14334s</td>\n<td>117x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O3</td>\n<td>4.50e10</td>\n<td>3.28 GiB</td>\n<td>0.63 bit</td>\n<td>17s</td>\n<td>1625s</td>\n<td>96x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O2</td>\n<td>5.37e10</td>\n<td>3.46 GiB</td>\n<td>0.55 bit</td>\n<td>20s</td>\n<td>1930s</td>\n<td>97x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-smaller</td>\n<td>5.51e10</td>\n<td>2.84 GiB</td>\n<td>0.44 bit</td>\n<td>21s</td>\n<td>1830s</td>\n<td>87x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O5</td>\n<td>4.22e10</td>\n<td>1.20 GiB</td>\n<td>0.24 bit</td>\n<td>16s</td>\n<td>1369s</td>\n<td>86x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O3</td>\n<td>4.80e10</td>\n<td>1.50 GiB</td>\n<td>0.27 bit</td>\n<td>24s</td>\n<td>2209s</td>\n<td>92x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>Total</td>\n<td>2.44e11</td>\n<td>12.24 GiB</td>\n<td>0.43 bit</td>\n<td>98s</td>\n<td>8963s</td>\n<td>91x</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>N/A</td>\n<td>2.21e11</td>\n<td>31.0 GiB</td>\n<td>1.20 bit</td>\n<td>168s</td>\n<td>4800s</td>\n<td>29x</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>N/A</td>\n<td>2.15e11</td>\n<td>13.3 GiB</td>\n<td>0.53 bit</td>\n<td>135s</td>\n<td>7289s</td>\n<td>54x</td>\n</tr>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>N/A</td>\n<td>3.27e11</td>\n<td>4.45 GiB</td>\n<td>0.12 bit</td>\n<td>112s</td>\n<td>8883s</td>\n<td>79x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 1</td>\n<td>1.44e10</td>\n<td>579 MiB</td>\n<td>0.34 bit</td>\n<td>14s</td>\n<td>348s</td>\n<td>25x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 2</td>\n<td>4.42e10</td>\n<td>2.30 GiB</td>\n<td>0.45 bit</td>\n<td>39s</td>\n<td>1202s</td>\n<td>31x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>seek 500</td>\n<td>4.78e10</td>\n<td>2.77 GiB</td>\n<td>0.50 bit</td>\n<td>41s</td>\n<td>1258s</td>\n<td>31x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>Total</td>\n<td>1.06e11</td>\n<td>5.64 GiB</td>\n<td>0.46 bit</td>\n<td>94s</td>\n<td>2808s</td>\n<td>30x</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>N/A</td>\n<td>2.74e11</td>\n<td>31.6 GiB</td>\n<td>0.99 bit</td>\n<td>140s</td>\n<td>8093s</td>\n<td>58x</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>N/A</td>\n<td>3.38e11</td>\n<td>75.6 GiB</td>\n<td>1.92 bit</td>\n<td>224s</td>\n<td>8894s</td>\n<td>40x</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>N/A</td>\n<td>3.01e11</td>\n<td>26.3 GiB</td>\n<td>0.75 bit</td>\n<td>88s</td>\n<td>6753s</td>\n<td>77x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cld</td>\n<td>5.08e10</td>\n<td>9.16 GiB</td>\n<td>1.55 bit</td>\n<td>60s</td>\n<td>1252s</td>\n<td>21x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cpu2006docs</td>\n<td>1.84e11</td>\n<td>7.80 GiB</td>\n<td>0.36 bit</td>\n<td>65s</td>\n<td>3923s</td>\n<td>60x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>input</td>\n<td>7.96e10</td>\n<td>10.5 GiB</td>\n<td>1.14 bit</td>\n<td>55s</td>\n<td>1842s</td>\n<td>33x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>Total</td>\n<td>3.14e11</td>\n<td>27.5 GiB</td>\n<td>0.75 bit</td>\n<td>180s</td>\n<td>7017s</td>\n<td>39x</td>\n</tr>\n<tr>\n<td>Total</td>\n<td>N/A</td>\n<td>2.86e12</td>\n<td>241 GiB</td>\n<td>0.72 bit</td>\n<td>1362s</td>\n<td>77834s</td>\n<td>57x</td>\n</tr>\n</tbody>\n</table>\n<p>\u6bcf\u5206\u652f\u7684\u7a7a\u95f4\u5f00\u9500\u548c\u5728 i9-14900K \u4e0a\u6d4b\u5f97\u7684 MPKI\uff08Mispredictions Per Kilo Instructions\uff09\u6709\u6bd4\u8f83\u660e\u663e\u7684\u6b63\u76f8\u5173\u6027\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>MPKI</th>\n<th>\u6bcf\u5206\u652f\u7a7a\u95f4\u5f00\u9500</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>0.84</td>\n<td>0.12 bit</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>0.95</td>\n<td>0.22 bit</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>1.06</td>\n<td>0.46 bit</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>2.66</td>\n<td>0.75 bit</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>3.16</td>\n<td>0.43 bit</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>4.35</td>\n<td>0.99 bit</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>4.47</td>\n<td>0.53 bit</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>5.35</td>\n<td>0.75 bit</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>12.61</td>\n<td>1.92 bit</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>13.24</td>\n<td>1.20 bit</td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u4e8e LTO \u5bf9\u5206\u652f\u6570\u91cf\u7684\u5f71\u54cd\u8f83\u5927\uff0c\u989d\u5916\u5bf9\u6bd4\u4e86 <code>-O3</code> \u548c <code>-O3 -flto</code> \u7684\u533a\u522b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>\u5b50 benchmark</th>\n<th>O3 \u5206\u652f\u6267\u884c\u6b21\u6570</th>\n<th>O3 trace \u5927\u5c0f</th>\n<th>O3+LTO \u5206\u652f\u6267\u884c\u6b21\u6570</th>\n<th>O3+LTO trace \u5927\u5c0f</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>500.perlbench_r</td>\n<td>checkspam</td>\n<td>2.40e11</td>\n<td>8.87 GiB</td>\n<td>2.32e11</td>\n<td>8.77 GiB</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>diffmail</td>\n<td>1.49e11</td>\n<td>2.78 GiB</td>\n<td>1.45e11</td>\n<td>2.70 GiB</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>splitmail</td>\n<td>1.33e11</td>\n<td>1.49 GiB</td>\n<td>1.31e11</td>\n<td>1.48 GiB</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>Total</td>\n<td>5.22e11</td>\n<td>13.14 GiB</td>\n<td>5.08e11</td>\n<td>12.95 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O3</td>\n<td>4.50e10</td>\n<td>3.28 GiB</td>\n<td>4.27e10</td>\n<td>3.20 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O2</td>\n<td>5.37e10</td>\n<td>3.46 GiB</td>\n<td>5.10e10</td>\n<td>3.38 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-smaller</td>\n<td>5.51e10</td>\n<td>2.84 GiB</td>\n<td>5.31e10</td>\n<td>2.78 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O5</td>\n<td>4.22e10</td>\n<td>1.20 GiB</td>\n<td>4.05e10</td>\n<td>1.17 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O3</td>\n<td>4.80e10</td>\n<td>1.50 GiB</td>\n<td>4.58e10</td>\n<td>1.45 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>Total</td>\n<td>2.44e11</td>\n<td>12.24 GiB</td>\n<td>2.33e11</td>\n<td>11.98 GiB</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>N/A</td>\n<td>2.21e11</td>\n<td>31.0 GiB</td>\n<td>1.62e11</td>\n<td>26.6 GiB</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>N/A</td>\n<td>2.15e11</td>\n<td>13.3 GiB</td>\n<td>1.97e11</td>\n<td>13.2 GiB</td>\n</tr>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>N/A</td>\n<td>3.27e11</td>\n<td>4.45 GiB</td>\n<td>3.16e11</td>\n<td>4.37 GiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 1</td>\n<td>1.44e10</td>\n<td>579 MiB</td>\n<td>1.43e10</td>\n<td>575 MiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 2</td>\n<td>4.42e10</td>\n<td>2.30 GiB</td>\n<td>4.42e10</td>\n<td>2.29 GiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>seek 500</td>\n<td>4.78e10</td>\n<td>2.77 GiB</td>\n<td>4.77e10</td>\n<td>2.76 GiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>Total</td>\n<td>1.06e11</td>\n<td>5.64 GiB</td>\n<td>1.06e11</td>\n<td>5.61 GiB</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>N/A</td>\n<td>2.74e11</td>\n<td>31.6 GiB</td>\n<td>2.13e11</td>\n<td>29.1 GiB</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>N/A</td>\n<td>3.38e11</td>\n<td>75.6 GiB</td>\n<td>2.61e11</td>\n<td>72.3 GiB</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>N/A</td>\n<td>3.01e11</td>\n<td>26.3 GiB</td>\n<td>3.02e11</td>\n<td>26.2 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cld</td>\n<td>5.08e10</td>\n<td>9.16 GiB</td>\n<td>5.07e10</td>\n<td>9.12 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cpu2006docs</td>\n<td>1.84e11</td>\n<td>7.80 GiB</td>\n<td>1.84e11</td>\n<td>7.78 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>input</td>\n<td>7.96e10</td>\n<td>10.5 GiB</td>\n<td>7.94e10</td>\n<td>10.5 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>Total</td>\n<td>3.14e11</td>\n<td>27.5 GiB</td>\n<td>3.14e11</td>\n<td>27.4 GiB</td>\n</tr>\n<tr>\n<td>Total</td>\n<td>N/A</td>\n<td>2.86e12</td>\n<td>241 GiB</td>\n<td>2.61e12</td>\n<td>230 GiB</td>\n</tr>\n</tbody>\n</table>\n<p>LTO \u53bb\u6389\u4e86 9% \u7684\u5206\u652f\u6307\u4ee4\uff0c\u5bf9\u6574\u4f53\u6027\u80fd\u7684\u5f71\u54cd\u8fd8\u662f\u86ee\u5927\u7684\uff0cMPKI \u7684\u6570\u503c\u4e5f\u6709\u660e\u663e\u7684\u53d8\u5316\u3002</p>\n<h3 id=\"\u65f6\u95f4\u5f00\u9500\">\u65f6\u95f4\u5f00\u9500<a class=\"headerlink\" href=\"#\u65f6\u95f4\u5f00\u9500\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5404\u4e2a\u6b65\u9aa4\u9700\u8981\u8017\u8d39\u7684\u65f6\u95f4\uff08\u5355\u7ebf\u7a0b\uff09\uff1a</p>\n<ol>\n<li>\u6293\u53d6 trace\uff1a\u7ea6 20 \u5c0f\u65f6</li>\n<li>\u8fd0\u884c SimPoint: \u7ea6 4 \u5c0f\u65f6</li>\n<li>\u6a21\u62df\u5206\u652f\u9884\u6d4b\uff1a\u7ea6 1 \u5c0f\u65f6</li>\n</ol>\n<h3 id=\"simpoint_1\">SimPoint<a class=\"headerlink\" href=\"#simpoint_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8003\u8651\u5230\uff08\u5b50\uff09benchmark \u4e4b\u95f4\u6ca1\u6709\u4f9d\u8d56\u5173\u7cfb\uff0c\u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\u591a\u4e2a trace/simpoint/simulate \u64cd\u4f5c\uff0c\u4e0d\u8fc7\u8003\u8651\u5230\u5185\u5b58\u5360\u7528\u548c\u786c\u76d8 I/O \u538b\u529b\uff0c\u5b9e\u9645\u7684\u5e76\u884c\u6027\u4e5f\u6ca1\u6709\u90a3\u4e48\u9ad8\u3002</p>\n<p>\u8dd1\u51fa\u6765\u7684 SimPoint \u805a\u7c7b\u53ef\u89c6\u5316\u4e2d\u6548\u679c\u6bd4\u8f83\u597d\u7684\uff0c\u56fe\u4e2d\u6a2a\u8f74\u662f\u6309\u6267\u884c\u987a\u5e8f\u7684 SimPoint slice\uff0c\u7eb5\u8f74\u6bcf\u4e00\u4e2a y \u503c\u5bf9\u5e94\u4e00\u4e2a SimPoint phase\uff0c\u56fe\u4e2d\u7684\u70b9\u4ee3\u8868\u54ea\u4e2a slice \u88ab\u5f52\u5230\u4e86\u54ea\u4e2a phase \u4e0a\uff1a</p>\n<p>500.perlbench_r diffmail:</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-perlbench-diffmail.png\" /></p>\n<p>520.omnetpp_r:</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-omnetpp.png\" /></p>\n<p>557.xz_r input:</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-xz-input.png\" /></p>\n<p>\u4ee5 1e8 \u6761\u6307\u4ee4\u7684\u7c92\u5ea6\u5207\u5206 SimPoint\uff0c\u628a 241 GB \u7684 trace \u7f29\u51cf\u5230 415 MB \u7684\u89c4\u6a21\u3002</p>\n<h3 id=\"\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\">\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df<a class=\"headerlink\" href=\"#\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f7f\u7528 CBP 2016 \u7684 Andre Seznec TAGE-SC-L 8KB/64KB \u7684\u5206\u652f\u9884\u6d4b\u5668\u5728 SimPoint \u4e0a\u6a21\u62df SPEC INT 2017 Rate-1\uff0c\u53ea\u9700\u8981 9-10 \u5206\u949f\u3002</p>\n<p>\u4f7f\u7528 CBP 2016 \u7684 Andre Seznec TAGE-SC-L 8KB/64KB \u7684\u5206\u652f\u9884\u6d4b\u5668\u5728 SimPoint \u4e0a\u6a21\u62df\u7684 CMPKI\uff08\u53ea\u8003\u8651\u4e86\u65b9\u5411\u5206\u652f\uff09\uff0c\u548c Intel i9-14900K \u7684 MPKI\uff08\u8003\u8651\u4e86\u6240\u6709\u5206\u652f\uff09\u5728 SPEC INT 2017 Rate-1\uff08AMD64\uff0c<code>-O3</code>\uff09\u7684\u6bd4\u8f83\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>TAGE-SC-L 8KB</th>\n<th>TAGE-SC-L 64KB</th>\n<th>i9-14900K</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>500.perlbench_r</td>\n<td>1.00</td>\n<td>0.72</td>\n<td>0.95</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>4.69</td>\n<td>3.36</td>\n<td>3.16</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>13.02</td>\n<td>12.23</td>\n<td>13.24</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>4.09</td>\n<td>3.49</td>\n<td>4.47</td>\n</tr>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>0.85</td>\n<td>0.68</td>\n<td>0.84</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>0.76</td>\n<td>0.59</td>\n<td>1.06</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>4.59</td>\n<td>3.45</td>\n<td>4.35</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>11.79</td>\n<td>9.42</td>\n<td>12.61</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>2.96</td>\n<td>1.25</td>\n<td>2.66</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>4.68</td>\n<td>4.06</td>\n<td>5.35</td>\n</tr>\n<tr>\n<td>average</td>\n<td>4.84</td>\n<td>3.925</td>\n<td>4.87</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"\u4e0d\u540c\u7f16\u8bd1\u5668\u7f16\u8bd1\u9009\u9879\u548c\u6307\u4ee4\u96c6\u4e0b-spec-int-2017-\u7684\u6307\u4ee4\u6570\u548c\u5206\u652f\u6307\u4ee4\u6570\u89c4\u6a21\">\u4e0d\u540c\u7f16\u8bd1\u5668\u3001\u7f16\u8bd1\u9009\u9879\u548c\u6307\u4ee4\u96c6\u4e0b SPEC INT 2017 \u7684\u6307\u4ee4\u6570\u548c\u5206\u652f\u6307\u4ee4\u6570\u89c4\u6a21<a class=\"headerlink\" href=\"#\u4e0d\u540c\u7f16\u8bd1\u5668\u7f16\u8bd1\u9009\u9879\u548c\u6307\u4ee4\u96c6\u4e0b-spec-int-2017-\u7684\u6307\u4ee4\u6570\u548c\u5206\u652f\u6307\u4ee4\u6570\u89c4\u6a21\" title=\"Permanent link\">&para;</a></h3>\n<table>\n<thead>\n<tr>\n<th>ISA</th>\n<th>Flags</th>\n<th>Compiler</th>\n<th># Inst</th>\n<th># Branch Inst</th>\n<th>% Branch Inst</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>LLVM 17.0.6</td>\n<td>2.07e+13</td>\n<td>3.27e+12</td>\n<td>15.8%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>LLVM 18.1.8</td>\n<td>1.99e+13</td>\n<td>3.17e+12</td>\n<td>14.8%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>LLVM 19.1.4</td>\n<td>1.99e+13</td>\n<td>3.13e+12</td>\n<td>15.7%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>LLVM 20.1.5</td>\n<td>2.10e+13</td>\n<td>3.11e+12</td>\n<td>14.8%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3+WRAPV</td>\n<td>LLVM 20.1.5</td>\n<td>2.01e+13</td>\n<td>3.10e+12</td>\n<td>15.4%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>GCC 11.3</td>\n<td>1.69e+13</td>\n<td>2.88e+12</td>\n<td>17.0%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>GCC 12.2</td>\n<td>1.67e+13</td>\n<td>2.88e+12</td>\n<td>17.2%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>GCC 13.3</td>\n<td>1.66e+13</td>\n<td>2.88e+12</td>\n<td>17.3%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>GCC 14.2</td>\n<td>1.65e+13</td>\n<td>2.87e+12</td>\n<td>17.4%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>GCC 15.1</td>\n<td>1.58e+13</td>\n<td>2.85e+12</td>\n<td>18.0%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3+LTO</td>\n<td>GCC 12.2</td>\n<td>1.57e+13</td>\n<td>2.63e+12</td>\n<td>16.8%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3+LTO+JEMALLOC</td>\n<td>GCC 12.2</td>\n<td>1.57e+13</td>\n<td>2.62e+12</td>\n<td>16.7%</td>\n</tr>\n<tr>\n<td>ARM64</td>\n<td>O3</td>\n<td>GCC 12.2</td>\n<td>1.62e+13</td>\n<td>2.83e+12</td>\n<td>17.5%</td>\n</tr>\n<tr>\n<td>ARM64</td>\n<td>O3+LTO</td>\n<td>GCC 12.2</td>\n<td>1.53e+13</td>\n<td>2.59e+12</td>\n<td>16.9%</td>\n</tr>\n<tr>\n<td>ARM64</td>\n<td>O3+LTO+JEMALLOC</td>\n<td>GCC 12.2</td>\n<td>1.52e+13</td>\n<td>2.57e+12</td>\n<td>16.9%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3</td>\n<td>GCC 14.2</td>\n<td>1.75e+13</td>\n<td>2.86e+12</td>\n<td>16.3%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3+LTO</td>\n<td>GCC 14.2</td>\n<td>1.66e+13</td>\n<td>2.61e+12</td>\n<td>15.7%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3+LTO+JEMALLOC</td>\n<td>GCC 14.2</td>\n<td>1.65e+13</td>\n<td>2.61e+12</td>\n<td>15.8%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3</td>\n<td>GCC 15.1</td>\n<td>1.64e+13</td>\n<td>2.83e+12</td>\n<td>17.3%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3+LTO</td>\n<td>GCC 15.1</td>\n<td>1.55e+13</td>\n<td>2.59e+12</td>\n<td>16.7%</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>O3: <code>-O3</code></li>\n<li>LTO: <code>-flto</code></li>\n<li>JEMALLOC: <code>-ljemalloc</code></li>\n<li>WRAPV: <code>-fwrapv</code></li>\n</ul>\n<h2 id=\"\u57fa\u4e8e-pin-\u5f00\u53d1-branch-trace-\u5de5\u5177\">\u57fa\u4e8e Pin \u5f00\u53d1 branch trace \u5de5\u5177<a class=\"headerlink\" href=\"#\u57fa\u4e8e-pin-\u5f00\u53d1-branch-trace-\u5de5\u5177\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u7ed9\u51fa\u5982\u4f55\u7528 Pin \u5b9e\u73b0\u4e00\u4e2a branch trace \u5de5\u5177\u7684\u8fc7\u7a0b\uff1a</p>\n<ol>\n<li>\n<p>\u53c2\u8003 Pin \u7684\u6837\u4f8b\u4ee3\u7801\uff0cInstrument \u6bcf\u4e00\u6761\u6307\u4ee4\uff0c\u5982\u679c\u5b83\u662f\u5206\u652f\u6307\u4ee4\uff0c\u5c31\u8bb0\u5f55\u5b83\u7684\u6307\u4ee4\u5730\u5740\u3001\u76ee\u7684\u5730\u5740\u3001\u6307\u4ee4\u957f\u5ea6\u3001\u5206\u652f\u7c7b\u578b\u4ee5\u53ca\u662f\u5426\u8df3\u8f6c\u7684\u4fe1\u606f\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"nf\">Instruction</span><span class=\"p\">(</span><span class=\"n\">INS</span><span class=\"w\"> </span><span class=\"n\">ins</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">v</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">INS_IsControlFlow</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"w\">        </span><span class=\"n\">UINT32</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">INS_Size</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"w\">        </span><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">branch_type</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"cm\">/* omitted */</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"w\">        </span><span class=\"n\">INS_InsertCall</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IPOINT_BEFORE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">AFUNPTR</span><span class=\"p\">)</span><span class=\"n\">RecordBranch</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_INST_PTR</span><span class=\"p\">,</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"w\">                    </span><span class=\"n\">IARG_BRANCH_TARGET_ADDR</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_UINT32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_UINT32</span><span class=\"p\">,</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"w\">                    </span><span class=\"n\">type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_BRANCH_TAKEN</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_END</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">argv</span><span class=\"p\">[])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">PIN_Init</span><span class=\"p\">(</span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">argv</span><span class=\"p\">))</span>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">Usage</span><span class=\"p\">();</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"n\">INS_AddInstrumentFunction</span><span class=\"p\">(</span><span class=\"n\">Instruction</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a><span class=\"w\">    </span><span class=\"n\">PIN_StartProgram</span><span class=\"p\">();</span>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u8bb0\u5f55\u5206\u652f\u7684\u65f6\u5019\uff0c\u5206\u522b\u7ef4\u62a4\u5206\u652f\u7684\u6570\u7ec4\u548c\u5206\u652f\u6267\u884c\u4e8b\u4ef6\u7684\u6570\u7ec4\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u6b21\u6267\u884c\u7684\u5206\u652f\uff0c\u8bb0\u5f55\u5206\u652f\u7684 id \u4ee5\u53ca\u662f\u5426\u8df3\u8f6c\u7684\u4fe1\u606f\uff0c\u5230\u5206\u652f\u6267\u884c\u4e8b\u4ef6\u7684\u6570\u7ec4\u5f53\u4e2d\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"nf\">RecordBranch</span><span class=\"p\">(</span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inst_addr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">targ_addr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">UINT32</span><span class=\"w\"> </span><span class=\"n\">inst_length</span><span class=\"p\">,</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"w\">                </span><span class=\"n\">UINT32</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">BOOL</span><span class=\"w\"> </span><span class=\"n\">taken</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">branch</span><span class=\"w\"> </span><span class=\"n\">br</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">inst_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"p\">)</span><span class=\"n\">inst_addr</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">targ_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"p\">)</span><span class=\"n\">targ_addr</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">inst_length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst_length</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">branch_type</span><span class=\"p\">)</span><span class=\"n\">type</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">entry</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"w\">    </span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">taken</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">taken</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a>\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a><span class=\"w\">    </span><span class=\"c1\">// insert branch if not exists</span>\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a><span class=\"w\">    </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">br_map</span><span class=\"p\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">br</span><span class=\"p\">);</span>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">br_map</span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a><span class=\"w\">        </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">num_brs</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">MAX_BRS</span><span class=\"p\">);</span>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a><span class=\"w\">        </span><span class=\"n\">br_map</span><span class=\"p\">[</span><span class=\"n\">br</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">num_brs</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a><span class=\"w\">        </span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">br_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">num_brs</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a><span class=\"w\">        </span><span class=\"n\">brs</span><span class=\"p\">[</span><span class=\"n\">num_brs</span><span class=\"o\">++</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">br</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-20\"><a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\" href=\"#__codelineno-1-20\"></a><span class=\"w\">        </span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">br_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"o\">-&gt;</span><span class=\"n\">second</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-21\"><a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\" href=\"#__codelineno-1-21\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-1-22\"><a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\" href=\"#__codelineno-1-22\"></a>\n</span><span id=\"__span-1-23\"><a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\" href=\"#__codelineno-1-23\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffer_size</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">BUFFER_SIZE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-24\"><a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\" href=\"#__codelineno-1-24\"></a><span class=\"w\">        </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-1-25\"><a id=\"__codelineno-1-25\" name=\"__codelineno-1-25\" href=\"#__codelineno-1-25\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-1-26\"><a id=\"__codelineno-1-26\" name=\"__codelineno-1-26\" href=\"#__codelineno-1-26\"></a><span class=\"w\">    </span><span class=\"n\">write_buffer</span><span class=\"p\">[</span><span class=\"n\">buffer_size</span><span class=\"o\">++</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-27\"><a id=\"__codelineno-1-27\" name=\"__codelineno-1-27\" href=\"#__codelineno-1-27\"></a><span class=\"w\">    </span><span class=\"n\">num_entries</span><span class=\"o\">++</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-28\"><a id=\"__codelineno-1-28\" name=\"__codelineno-1-28\" href=\"#__codelineno-1-28\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u4e3a\u4e86\u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4\uff0c\u5f53\u7f13\u51b2\u533a\u6ee1\u7684\u65f6\u5019\uff0c\u9996\u5148\u7ecf\u8fc7 zstd \u7684\u6d41\u538b\u7f29\uff0c\u518d\u628a\u538b\u7f29\u540e\u7684\u5185\u5bb9\u5199\u5165\u5230\u6587\u4ef6\u4e2d\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\">// https://github.com/facebook/zstd/blob/dev/examples/streaming_compression.c</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"n\">ZSTD_EndDirective</span><span class=\"w\"> </span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ZSTD_e_continue</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"n\">ZSTD_inBuffer</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">write_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">write_buffer</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">};</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">finished</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"w\">    </span><span class=\"n\">ZSTD_outBuffer</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">zstd_output_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">zstd_output_buffer_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">};</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">remaining</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ZSTD_compressStream2</span><span class=\"p\">(</span><span class=\"n\">zstd_cctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">output</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">input</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mode</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">ZSTD_isError</span><span class=\"p\">(</span><span class=\"n\">remaining</span><span class=\"p\">));</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a><span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">fwrite</span><span class=\"p\">(</span><span class=\"n\">zstd_output_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"p\">.</span><span class=\"n\">pos</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"p\">.</span><span class=\"n\">pos</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"w\">    </span><span class=\"n\">finished</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">finished</span><span class=\"p\">);</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u6700\u540e\u5728\u7a0b\u5e8f\u7ed3\u675f\u65f6\uff0c\u628a\u5206\u652f\u6570\u7ec4\u5199\u5165\u5230\u6587\u4ef6\u5e76\u8bb0\u5f55\u5143\u6570\u636e\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"nf\">Fini</span><span class=\"p\">(</span><span class=\"n\">INT32</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">v</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"c1\">// 1. compress the remaining data in write buffer and write to file</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"c1\">// 2. save metadata, including:</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"c1\">//    1. number of branch executions</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"c1\">//    2. number of branches</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"c1\">//    3. branches array</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">argv</span><span class=\"p\">[])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">    </span><span class=\"n\">PIN_AddFiniFunction</span><span class=\"p\">(</span><span class=\"n\">Fini</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a><span class=\"w\">    </span><span class=\"n\">PIN_StartProgram</span><span class=\"p\">();</span>\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a><span class=\"w\">    </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u9488\u5bf9\u52a8\u6001\u94fe\u63a5\uff0c\u53ef\u4ee5\u5229\u7528 Pin \u5df2\u6709\u7684 API <code>IMG_AddInstrumentFunction</code> \u6765\u8ddf\u8e2a\uff0c\u65b9\u4fbf\u540e\u7eed\u627e\u5230 trace \u4e2d\u5404\u4e2a\u5730\u5740\u5bf9\u5e94\u7684\u6307\u4ee4</p>\n</li>\n</ol>\n<p>\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86 Branch Trace \u7684\u6293\u53d6\u3002</p>", "image": "https://jia.je/assets/images/social/blog/posts/software/cbp-experiments.png", "date_modified": "2025-04-10T00:00:00+00:00", "date_published": "2025-04-10T00:00:00+00:00", "authors": [], "tags": ["bp", "cbp", "cpu", "ooo", "software"]}, {"id": "https://jia.je/software/2025/04/07/tls-internals/", "url": "https://jia.je/software/2025/04/07/tls-internals/", "title": "Thread Local Storage (TLS) \u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"thread-local-storage-tls-\u5b9e\u73b0\u63a2\u7a76\">Thread Local Storage (TLS) \u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#thread-local-storage-tls-\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>TLS \u662f thread local storage \u7684\u7f29\u5199\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u5b58\u50a8\u4e00\u4e9b per-thread \u7684\u6570\u636e\uff0c\u4f46\u5b83\u5185\u90e8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f\u672c\u6587\u5bf9 glibc 2.31 \u7248\u672c\u7684 TLS \u5b9e\u73b0\u8fdb\u884c\u63a2\u7a76\u3002</p>\n<!-- more -->\n\n<h2 id=\"__thread\">__thread<a class=\"headerlink\" href=\"#__thread\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u6765\u770b TLS \u5728 C \u4e2d\u662f\u600e\u4e48\u4f7f\u7528\u7684\uff1a\u7528 <code>__thread</code> \u6807\u8bb0\u4e00\u4e2a\u5168\u5c40\u53d8\u91cf\uff08\u6ce8\uff1a\u8fdb\u5165 C11/C++11 \u6807\u51c6\u7684\u7528\u6cd5\u662f\u7528 <code>thread_local</code> \u6765\u6807\u8bb0\uff09\uff0c\u90a3\u4e48\u5b83\u5c31\u4f1a\u4fdd\u5b58\u5728 TLS \u5f53\u4e2d\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4efd\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u90a3\u4e48\u7f16\u8bd1\u5668\u5728\u751f\u6210\u8bbf\u95ee\u8fd9\u4e2a TLS \u5168\u5c40\u53d8\u91cf\u65f6\uff0c\u751f\u6210\u7684\u6307\u4ee4\u4e5f\u4e0d\u540c\u3002\u4ee5\u4e0b\u9762\u7684\u4ee3\u7801\u4e3a\u4f8b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">global_data</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">global</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">global_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">tls</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">tls_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u751f\u6210\u7684 amd64 \u6c47\u7f16\u5982\u4e0b\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"w\">        </span><span class=\"na\">.text</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"nl\">global:</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"w\">        </span><span class=\"nf\">movl</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">global_data</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"w\">        </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"nl\">tls:</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">        </span><span class=\"nf\">movl</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"no\">tls_data@tpoff</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"w\">        </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"w\">        </span><span class=\"na\">.section</span><span class=\"w\">        </span><span class=\"no\">.tbss</span><span class=\"p\">,</span><span class=\"s\">&quot;awT&quot;</span><span class=\"p\">,</span><span class=\"na\">@nobits</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"nl\">tls_data:</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"w\">        </span><span class=\"na\">.zero</span><span class=\"w\">   </span><span class=\"mi\">4</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"w\">        </span><span class=\"na\">.bss</span>\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a><span class=\"nl\">global_data:</span>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"w\">        </span><span class=\"na\">.zero</span><span class=\"w\">   </span><span class=\"mi\">4</span>\n</span></code></pre></div>\n<p>\u8bbf\u95ee\u5168\u5c40\u53d8\u91cf\u7684\u65f6\u5019\uff0c\u91c7\u7528\u7684\u662f\u5178\u578b\u7684 PC-relative \u65b9\u5f0f\u6765\u627e\u5230\u5168\u5c40\u53d8\u91cf <code>global_data</code> \u7684\u5730\u5740\uff1b\u8bbf\u95ee thread local \u53d8\u91cf\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u91c7\u7528\u4e86\u4e00\u4e2a\u6bd4\u8f83\u5c11\u89c1\u7684\u5199\u6cd5\uff1a<code>%fs:tls_data@tpoff</code>\uff0c\u5b83\u7684\u610f\u601d\u662f\u7531\u94fe\u63a5\u5668\u8ba1\u7b97\u51fa <code>tls_data</code> \u76f8\u5bf9 <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\u7684\u504f\u79fb\uff0c\u7136\u540e\u76f4\u63a5\u5199\u5230\u6307\u4ee4\u7684\u504f\u79fb\u91cc\u3002\u94fe\u63a5\u4ee5\u4e0a\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u770b\u5230\u6700\u7ec8\u7684\u4e8c\u8fdb\u5236\u662f\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"err\">0000000000001140</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">global</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"err\">1140:</span><span class=\"w\">       </span><span class=\"err\">89</span><span class=\"w\"> </span><span class=\"err\">3</span><span class=\"nf\">d</span><span class=\"w\"> </span><span class=\"no\">ce</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"no\">e</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"mi\">0x2ece</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">)</span><span class=\"w\">        </span><span class=\"c1\"># 4014 &lt;global_data&gt;</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"err\">1146:</span><span class=\"w\">       </span><span class=\"nf\">c3</span><span class=\"w\">                      </span><span class=\"no\">ret</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"err\">1147:</span><span class=\"w\">       </span><span class=\"err\">66</span><span class=\"w\"> </span><span class=\"err\">0</span><span class=\"nf\">f</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">nopw</span><span class=\"w\">   </span><span class=\"mi\">0x0</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">,</span><span class=\"nv\">%rax</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"err\">114</span><span class=\"nl\">e:</span><span class=\"w\">       </span><span class=\"err\">00</span><span class=\"w\"> </span><span class=\"err\">00</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"err\">0000000000001150</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">tls</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"err\">1150:</span><span class=\"w\">       </span><span class=\"err\">64</span><span class=\"w\"> </span><span class=\"err\">89</span><span class=\"w\"> </span><span class=\"err\">3</span><span class=\"nf\">c</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"w\"> </span><span class=\"no\">fc</span><span class=\"w\"> </span><span class=\"no\">ff</span><span class=\"w\"> </span><span class=\"no\">ff</span><span class=\"w\">    </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0xfffffffffffffffc</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"err\">1157:</span><span class=\"w\">       </span><span class=\"nf\">ff</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"err\">1158:</span><span class=\"w\">       </span><span class=\"nf\">c3</span><span class=\"w\">                      </span><span class=\"no\">ret</span>\n</span></code></pre></div>\n<p>\u53ef\u89c1\u6700\u7ec8 <code>global_data</code> \u88ab\u653e\u5230\u4e86\u76f8\u5bf9\u4e8c\u8fdb\u5236\u5f00\u5934 <code>0x4014</code> \u7684\u5730\u65b9\uff0c\u800c <code>tls_data</code> \u88ab\u653e\u5230\u4e86 <code>%fs:-0x4</code> \u7684\u4f4d\u7f6e\u3002\u90a3\u4e48\u8fd9\u4e2a <code>%fs</code> \u662f\u600e\u4e48\u5f97\u5230\u7684\uff0c<code>-0x4</code> \u7684\u504f\u79fb\u53c8\u662f\u600e\u4e48\u8ba1\u7b97\u7684\u5462\uff1f\u4e0b\u9762\u6765\u8fdb\u4e00\u6b65\u7814\u7a76\u80cc\u540e\u7684\u5b9e\u73b0\u3002</p>\n<h2 id=\"tls-\u7684\u7ec4\u7ec7\u65b9\u5f0f\">TLS \u7684\u7ec4\u7ec7\u65b9\u5f0f<a class=\"headerlink\" href=\"#tls-\u7684\u7ec4\u7ec7\u65b9\u5f0f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148 TLS \u662f per-thread \u7684\u5b58\u50a8\uff0c\u610f\u5473\u7740\u6bcf\u4e2a\u65b0\u7ebf\u7a0b\uff0c\u90fd\u6709\u4e00\u4e2a buffer \u9700\u8981\u4fdd\u5b58 TLS \u7684\u6570\u636e\u3002\u90a3\u4e48\u8fd9\u4e2a\u6570\u636e\u6240\u5728\u7684\u4f4d\u7f6e\uff0c\u4e5f\u9700\u8981\u4e00\u4e9b per-thread \u7684\u9ad8\u6548\u65b9\u5f0f\u6765\u8bbf\u95ee\uff0c\u5728 amd64 \u4e0a\uff0c\u5b83\u662f\u901a\u8fc7 <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\u6765\u7ef4\u62a4\u7684\u3002\u90a3\u4e48 TLS \u53ef\u80fd\u6709\u54ea\u4e9b\u6765\u6e90\u5462\uff1f\u9996\u5148\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\u53ef\u80fd\u4f1a\u7528\u4e00\u4e9b\uff0c\u5b83\u901a\u8fc7 DT_NEEDED \u7531\u52a8\u6001\u94fe\u63a5\u5668\u5728\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u4e5f\u6709\u4e00\u4e9b\uff08\u6bd4\u5982 <a href=\"../../../03/30/glibc-allocator/\">glibc \u7684 tcache</a>\uff09\uff0c\u6b64\u5916\u8fd0\u884c\u65f6 dlopen \u4e86\u4e00\u4e9b\u52a8\u6001\u5e93\u4e5f\u4f1a\u6709 TLS \u7684\u9700\u6c42\u3002\u4e3a\u4e86\u6ee1\u8db3\u8fd9\u4e9b\u9700\u6c42\uff0c\u9700\u8981\u8bbe\u8ba1\u4e00\u4e2a TLS \u7684\u7ed3\u6784\uff0c\u65e2\u80fd\u6ee1\u8db3\u8fd9\u4e9b\u5728\u542f\u52a8\u65f6\u5df2\u77e5\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u7684\u9700\u6c42\uff0c\u53c8\u80fd\u6ee1\u8db3\u8fd0\u884c\u65f6\u52a8\u6001\u52a0\u8f7d\u7684\u65b0\u52a8\u6001\u5e93\u7684\u9700\u6c42\u3002</p>\n<p>\u8fd9\u91cc\u9762\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684\u9700\u6c42\u662f\u660e\u786e\u7684\uff0c\u4e0d\u4f1a\u53d8\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u7531\u52a8\u6001\u94fe\u63a5\u5668\u5728\u52a0\u8f7d\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u7ed9\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u5206\u914d TLS \u7a7a\u95f4\uff1a</p>\n<ol>\n<li>\u6bd4\u5982\u53ef\u6267\u884c\u7a0b\u5e8f\u672c\u8eab\u9700\u8981 0x10 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u5b83\u542f\u52a8\u65f6\u52a0\u8f7d\u4e24\u4e2a\u52a8\u6001\u5e93 libc.so.6 \u548c libstdc++.so.6\uff0c\u671f\u4e2d libc.so.6 \u9700\u8981 0x20 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0clibstdc++.so.6 \u9700\u8981 0x30 \u5b57\u8282\u7684 TLS \u7a7a\u95f4</li>\n<li>\u52a0\u8d77\u6765\u4e00\u5171\u9700\u8981 0x60 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u90a3\u4e48\u5728\u521b\u5efa\u7ebf\u7a0b\u7684\u65f6\u5019\uff0c\u521b\u5efa\u597d 0x60 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u6309\u7167\u987a\u5e8f\u8fdb\u884c\u5206\u914d\uff1a<ol>\n<li>0x00-0x10: \u5c5e\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f</li>\n<li>0x10-0x30: \u5c5e\u4e8e libc.so.6</li>\n<li>0x30-0x60: \u5c5e\u4e8e libstdc++.so.6</li>\n</ol>\n</li>\n<li>\u5206\u914d\u597d\u8fd9\u4e2a\u7a7a\u95f4\u4ee5\u540e\uff0c\u56e0\u4e3a libc.so.6 \u65e0\u6cd5\u63d0\u524d\u9884\u77e5\u5b83\u4f1a\u88ab\u5206\u914d\u5230\u54ea\u4e2a\u4f4d\u7f6e\uff0c\u6240\u4ee5\u9700\u8981\u4e00\u6b21\u91cd\u5b9a\u4f4d\uff0c\u628a libc.so.6 \u91cc\u7684 TLS \u7a7a\u95f4\u7684\u4f7f\u7528\u91cd\u5b9a\u4f4d\u5230\u5206\u914d\u540e\u7684\u4f4d\u7f6e\uff0c\u4f8b\u5982 libc.so.6 \u7684 0x20 \u7684 TLS \u7a7a\u95f4\u5185\u7684\u5f00\u5934 8 \u5b57\u8282\uff0c\u73b0\u5728\u5728\u6574\u4e2a TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\u5c31\u662f <code>0x20 + 8 = 0x28</code></li>\n</ol>\n<p>\u4f46\u662f dlopen \u52a8\u6001\u52a0\u8f7d\u8fdb\u6765\u7684\u52a8\u6001\u5e93\u600e\u4e48\u529e\u5462\uff1f\u8fd9\u4e9b\u52a8\u6001\u5e93\u7684\u6570\u91cf\u53ef\u4ee5\u52a8\u6001\u53d8\u5316\uff0c\u53ef\u4ee5\u52a0\u8f7d\u4e5f\u53ef\u4ee5\u5378\u8f7d\uff0c\u518d\u8fd9\u4e48\u7ebf\u6027\u5206\u914d\u5c31\u4e0d\u5408\u9002\u4e86\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u7ed9\u6bcf\u4e2a dlopen \u5f97\u5230\u7684\u52a8\u6001\u5e93\u5206\u914d\u72ec\u7acb\u7684 TLS \u7a7a\u95f4\u3002\u65e2\u7136\u662f\u52a8\u6001\u5206\u914d\u7684\u7a7a\u95f4\uff0c\u90a3\u4e48\u8fd9\u4e9b\u72ec\u7acb\u7684 TLS \u7a7a\u95f4\u7684\u5730\u5740\uff0c\u4e0d\u540c\u7ebf\u7a0b\u4e0d\u540c\uff0c\u4e0d\u80fd\u901a\u8fc7\u4e00\u4e2a\u57fa\u5730\u5740\u52a0\u56fa\u5b9a\u504f\u79fb\u7684\u65b9\u5f0f\u6765\u8ba1\u7b97\uff0c\u5c31\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u673a\u5236\u6765\u627e\u5230\u5404\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u5730\u5740\u3002</p>\n<p>glibc \u7684\u5b9e\u73b0\u4e2d\uff0c\u5b83\u628a\u5404\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u8bb0\u5f55\u5728\u4e00\u4e2a <code>dtv</code> \u6570\u7ec4\u4e2d\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e00\u4e2a <code>__tls_get_addr</code> \u51fd\u6570\u6765\u67e5\u8be2\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u5185\u6307\u5b9a offset \u7684\u5b9e\u9645\u5730\u5740\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dl_tls_index</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_module</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tls_index</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"nf\">__tls_get_addr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tls_index</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ti</span><span class=\"p\">)</span>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"w\">  </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">THREAD_DTV</span><span class=\"w\"> </span><span class=\"p\">();</span>\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">dtv</span><span class=\"p\">[</span><span class=\"n\">ti</span><span class=\"o\">-&gt;</span><span class=\"n\">ti_module</span><span class=\"p\">].</span><span class=\"n\">pointer</span><span class=\"p\">.</span><span class=\"n\">val</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a>\n</span><span id=\"__span-4-18\"><a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\" href=\"#__codelineno-4-18\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">ti</span><span class=\"o\">-&gt;</span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-19\"><a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\" href=\"#__codelineno-4-19\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>dtv</code> \u6570\u7ec4\u7684\u6307\u9488\u4fdd\u5b58\u5728 <code>struct pthread</code>\uff08\u5373 Thread Control Block (TCB)\uff09\u4e2d\uff0c\u800c\u8fd9\u4e2a <code>struct pthread</code> \u5c31\u4fdd\u5b58\u5728 <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\u6307\u5411\u7684\u5730\u5740\u4e0a\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pthread</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\">  </span><span class=\"n\">tcbhead_t</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\">  </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\">  </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"n\">stack_guard</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-13\"><a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\" href=\"#__codelineno-5-13\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-14\"><a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\" href=\"#__codelineno-5-14\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcbhead_t</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-15\"><a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\" href=\"#__codelineno-5-15\"></a>\n</span><span id=\"__span-5-16\"><a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\" href=\"#__codelineno-5-16\"></a><span class=\"cp\"># define THREAD_DTV() \\</span>\n</span><span id=\"__span-5-17\"><a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\" href=\"#__codelineno-5-17\"></a><span class=\"cp\">  ({ struct pthread *__pd;                            \\</span>\n</span><span id=\"__span-5-18\"><a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\" href=\"#__codelineno-5-18\"></a><span class=\"cp\">     THREAD_GETMEM (__pd, header.dtv); })</span>\n</span></code></pre></div>\n<p>P.S. stack protector \u6240\u4f7f\u7528\u7684 canary \u7684\u503c\u5c31\u4fdd\u5b58\u5728 <code>pthread.header.stack_guard</code> \u5b57\u6bb5\u4e2d\uff0c\u4e5f\u5c31\u662f\u5728 <code>%fs:40</code> \u4f4d\u7f6e\u3002</p>\n<p>\u800c\u4e4b\u524d\u63d0\u5230\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u672c\u8eab\u7684 TLS \u7a7a\u95f4\u4ee5\u53ca\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff0c\u5b9e\u9645\u4e0a\u662f\u4fdd\u5b58\u5728 <code>struct thread</code> \u4e5f\u5c31\u662f TCB \u524d\u9762\u7684\u90e8\u5206\uff0c\u4ece\u9ad8\u5730\u5740\u5f80\u4f4e\u5730\u5740\u5206\u914d\uff08\u56fe\u7247\u6765\u6e90\uff1a<a href=\"https://www.akkadia.org/drepper/tls.pdf\">ELF Handling For Thread-Local Storage</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../tls-internals-ds.png\" /></p>\n<p>\u56fe\u4e2d <span class=\"arithmatex\">\\(tp_t\\)</span> \u5728 amd64 \u4e0b\u5c31\u662f <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\uff0c\u5b83\u76f4\u63a5\u6307\u5411\u7684\u5c31\u662f <code>struct thread</code> \u4e5f\u5c31\u662f TCB\uff1b\u4ece <code>%fs</code> \u5f00\u59cb\u5f80\u4f4e\u5730\u5740\uff0c\u5148\u5206\u914d\u53ef\u6267\u884c\u7a0b\u5e8f\u672c\u8eab\u7684 TLS \u7a7a\u95f4\uff08\u56fe\u4e2d <span class=\"arithmatex\">\\(tlsoffset_1\\)</span> \u5230 <span class=\"arithmatex\">\\(tp_t\\)</span> \u7684\u8303\u56f4\uff09\uff0c\u540e\u5206\u914d\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff08\u56fe\u4e2d <span class=\"arithmatex\">\\(tlsoffset_1\\)</span> \u5230 <span class=\"arithmatex\">\\(tlsoffset_2\\)</span> \u4ee5\u53ca <span class=\"arithmatex\">\\(tlsoffset_3\\)</span> \u5230 <span class=\"arithmatex\">\\(tlsoffset_2\\)</span> \u7684\u8303\u56f4\uff09\u3002\u6ce8\u610f\u8fd9\u4e9b\u504f\u79fb\u5bf9\u4e8e\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u662f\u76f8\u540c\u7684\uff0c\u53ea\u662f\u4e0d\u540c\u7ebf\u7a0b\u7684 <code>%fs</code> \u5bc4\u5b58\u5668\u4e0d\u540c\u3002</p>\n<p>\u800c\u5bf9\u4e8e dlopen \u52a8\u6001\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u5219 TLS \u7a7a\u95f4\u9700\u8981\u52a8\u6001\u5206\u914d\uff0c\u7136\u540e\u901a\u8fc7 <code>dtv</code> \u6570\u7ec4\u6765\u7d22\u5f15\uff08\u56fe\u4e2d <span class=\"arithmatex\">\\(dtv_{t,4}\\)</span> \u548c <span class=\"arithmatex\">\\(dtv_{t,5}\\)</span>\uff09\uff0c\u56e0\u6b64\u65e0\u6cd5\u901a\u8fc7\u91cd\u5b9a\u4f4d\u4fee\u6b63\uff0c\u800c\u662f\u8981\u5728\u8fd0\u884c\u65f6\u901a\u8fc7 <code>__tls_get_addr</code> \u51fd\u6570\u83b7\u53d6\u5730\u5740\u3002\u4e3a\u4e86\u8ba9 <code>__tls_get_addr</code> \u66f4\u5177\u6709\u901a\u7528\u6027\uff0c<code>dtv</code> \u6570\u7ec4\u4e5f\u8bb0\u5f55\u4e86\u5206\u914d\u5728 <code>%fs</code> \u6307\u5411\u7684 TCB \u66f4\u4f4e\u5730\u5740\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff0c\u6b64\u65f6 <code>__tls_get_addr</code> \u53ef\u4ee5\u67e5\u5230\u6240\u6709 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002\u6bcf\u4e2a\u52a8\u6001\u5e93\u5728 <code>dtv</code> \u6570\u7ec4\u4e2d\u90fd\u8bb0\u5f55\u4e86\u4fe1\u606f\uff0c\u90a3\u4e48\u8fd9\u4e2a\u52a8\u6001\u5e93\u5728 <code>dtv</code> \u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u8bb0\u4e3a\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff08module id\uff09\uff0c\u540e\u9762\u4f1a\u591a\u6b21\u51fa\u73b0\u8fd9\u4e2a\u6982\u5ff5\u3002</p>\n<p>\u77e5\u9053\u4e86 TLS \u7684\u7ec4\u7ec7\u65b9\u5f0f\u540e\uff0c\u63a5\u4e0b\u6765\u89c2\u5bdf\u7f16\u8bd1\u5668\u3001\u94fe\u63a5\u5668\u548c\u52a8\u6001\u94fe\u63a5\u5668\u662f\u5982\u4f55\u914d\u5408\u7740\u8ba9\u4ee3\u7801\u53ef\u4ee5\u627e\u5230\u6b63\u786e\u7684 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002</p>\n<h2 id=\"\u53ef\u6267\u884c\u7a0b\u5e8f\">\u53ef\u6267\u884c\u7a0b\u5e8f<a class=\"headerlink\" href=\"#\u53ef\u6267\u884c\u7a0b\u5e8f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u6765\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u573a\u666f\uff1a\u53ef\u6267\u884c\u7a0b\u5e8f\u76f4\u63a5\u8bbf\u95ee\u81ea\u5df1\u5b9a\u4e49\u7684 TLS \u53d8\u91cf\u3002\u524d\u9762\u63d0\u5230\uff0c\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u7a7a\u95f4\u76f4\u63a5\u4fdd\u5b58\u5230 <code>%fs</code> \u5f80\u4e0b\u7684\u5730\u5740\uff0c\u56e0\u6b64\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u662f\u53ef\u4ee5\u63d0\u524d\u8ba1\u7b97\u5f97\u5230\u7684\u3002\u4e0b\u9762\u770b\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data2</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n</span></code></pre></div>\n<p>\u7f16\u8bd1\u5f97\u5230\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-s highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"n\">read_tls_data1</span><span class=\"o\">:</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"w\">        </span><span class=\"n\">movl</span><span class=\"w\">    </span><span class=\"o\">%fs:tls_data1@tpoff, %</span><span class=\"n\">eax</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"w\">        </span><span class=\"n\">ret</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"n\">read_tls_data2</span><span class=\"o\">:</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a><span class=\"w\">        </span><span class=\"n\">movl</span><span class=\"w\">    </span><span class=\"o\">%fs:tls_data2@tpoff, %</span><span class=\"n\">eax</span>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"w\">        </span><span class=\"n\">ret</span>\n</span></code></pre></div>\n<p>\u8fd9\u5c31\u662f\u5728\u672c\u6587\u4e00\u5f00\u5934\u5c31\u770b\u5230\u7684\u8bed\u6cd5\uff1a<code>%fs:symbol@tpoff</code>\uff0c\u5b83\u4f1a\u5bf9\u5e94\u4e00\u4e2a <code>R_X86_64_TPOFF32</code> \u7c7b\u578b\u7684\u91cd\u5b9a\u4f4d\uff0c\u544a\u8bc9\u94fe\u63a5\u5668\uff0c\u8fd9\u662f\u4e00\u4e2a TLS \u53d8\u91cf\uff0c\u5e76\u4e14\u5b83\u7684\u504f\u79fb\u5728\u9759\u6001\u94fe\u63a5\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u6765\uff0c\u5e76\u4e14\u8fd9\u4e2a\u504f\u79fb\u4f1a\u76f4\u63a5\u5199\u5230 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u5185\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-c<span class=\"w\"> </span>tls.c<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0x0,%eax\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"w\">   </span><span class=\"m\">7</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"w\">                        </span><span class=\"m\">4</span>:<span class=\"w\"> </span>R_X86_64_TPOFF32<span class=\"w\">     </span>tls_data1\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"w\">   </span><span class=\"m\">8</span>:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a><span class=\"w\">   </span><span class=\"m\">9</span>:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a>\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a><span class=\"m\">0000000000000010</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a><span class=\"w\">  </span><span class=\"m\">10</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0x0,%eax\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a><span class=\"w\">  </span><span class=\"m\">17</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a><span class=\"w\">                        </span><span class=\"m\">14</span>:<span class=\"w\"> </span>R_X86_64_TPOFF32<span class=\"w\">    </span>tls_data2\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a><span class=\"w\">  </span><span class=\"m\">18</span>:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a><span class=\"m\">0000000000001140</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a><span class=\"w\">    </span><span class=\"m\">1140</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"nb\">fc</span><span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0xfffffffffffffffc,%eax\n</span><span id=\"__span-8-21\"><a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\" href=\"#__codelineno-8-21\"></a><span class=\"w\">    </span><span class=\"m\">1147</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-8-22\"><a id=\"__codelineno-8-22\" name=\"__codelineno-8-22\" href=\"#__codelineno-8-22\"></a><span class=\"w\">    </span><span class=\"m\">1148</span>:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-23\"><a id=\"__codelineno-8-23\" name=\"__codelineno-8-23\" href=\"#__codelineno-8-23\"></a><span class=\"w\">    </span><span class=\"m\">1149</span>:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-8-24\"><a id=\"__codelineno-8-24\" name=\"__codelineno-8-24\" href=\"#__codelineno-8-24\"></a>\n</span><span id=\"__span-8-25\"><a id=\"__codelineno-8-25\" name=\"__codelineno-8-25\" href=\"#__codelineno-8-25\"></a><span class=\"m\">0000000000001150</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-8-26\"><a id=\"__codelineno-8-26\" name=\"__codelineno-8-26\" href=\"#__codelineno-8-26\"></a><span class=\"w\">    </span><span class=\"m\">1150</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>f8<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0xfffffffffffffff8,%eax\n</span><span id=\"__span-8-27\"><a id=\"__codelineno-8-27\" name=\"__codelineno-8-27\" href=\"#__codelineno-8-27\"></a><span class=\"w\">    </span><span class=\"m\">1157</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-8-28\"><a id=\"__codelineno-8-28\" name=\"__codelineno-8-28\" href=\"#__codelineno-8-28\"></a><span class=\"w\">    </span><span class=\"m\">1158</span>:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-29\"><a id=\"__codelineno-8-29\" name=\"__codelineno-8-29\" href=\"#__codelineno-8-29\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-t<span class=\"w\"> </span>tls\n</span><span id=\"__span-8-30\"><a id=\"__codelineno-8-30\" name=\"__codelineno-8-30\" href=\"#__codelineno-8-30\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-8-31\"><a id=\"__codelineno-8-31\" name=\"__codelineno-8-31\" href=\"#__codelineno-8-31\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>g<span class=\"w\">       </span>.tbss<span class=\"w\">  </span><span class=\"m\">0000000000000004</span><span class=\"w\">              </span>tls_data2\n</span><span id=\"__span-8-32\"><a id=\"__codelineno-8-32\" name=\"__codelineno-8-32\" href=\"#__codelineno-8-32\"></a><span class=\"m\">0000000000000004</span><span class=\"w\"> </span>g<span class=\"w\">       </span>.tbss<span class=\"w\">  </span><span class=\"m\">0000000000000004</span><span class=\"w\">              </span>tls_data1\n</span></code></pre></div>\n<p>\u6839\u636e\u4ee5\u4e0a\u8f93\u51fa\u53ef\u4ee5\u770b\u5230\uff0c\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\u4f7f\u7528\u4e86 8 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u5176\u4e2d\u4f4e 4 \u5b57\u8282\u5bf9\u5e94 <code>tls_data2</code>\uff0c\u9ad8 4 \u5b57\u8282\u5bf9\u5e94 <code>tls_data1</code>\uff1b\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\uff0c\u94fe\u63a5\u5668\u5c31\u53ef\u4ee5\u63a8\u65ad\u51fa <code>tls_data2</code> \u4fdd\u5b58\u5728 <code>%fs-0x8</code> \u7684\u4f4d\u7f6e\uff0c<code>tls_data1</code> \u4fdd\u5b58\u5728 <code>%fs-0x4</code> \u7684\u4f4d\u7f6e\uff0c\u76f4\u63a5\u628a\u8fd9\u4e2a\u504f\u79fb\u7f16\u7801\u5230 <code>mov</code> \u6307\u4ee4\u5185\u3002\u8fd9\u6837\uff0c\u8fd0\u884c\u65f6\u5f00\u9500\u662f\u6700\u5c0f\u7684\u3002</p>\n<p>\u8fd9\u4e00\u79cd\u8bbf\u95ee TLS \u7684\u60c5\u51b5\uff0c\u4e5f\u53eb\u505a local exec TLS model\uff1a\u5b83\u53ea\u7528\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u8bbf\u95ee\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\u7684 TLS \u53d8\u91cf\u7684\u573a\u666f\u3002\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u7a7a\u95f4\u603b\u662f\u7d27\u8d34\u7740 <code>%fs</code> \u5206\u914d\uff0c\u4e0d\u4f1a\u53d7\u5230\u52a8\u6001\u5e93\u7684\u5f71\u54cd\uff0c\u56e0\u6b64\u53ef\u4ee5\u63d0\u524d\u8ba1\u7b97\u51fa\u5b83\u81ea\u5df1\u7684 TLS \u53d8\u91cf\u7684\u504f\u79fb\u3002</p>\n<h2 id=\"\u52a8\u6001\u5e93\">\u52a8\u6001\u5e93<a class=\"headerlink\" href=\"#\u52a8\u6001\u5e93\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf\u53e6\u4e00\u79cd\u60c5\u51b5\uff1a\u52a8\u6001\u5e93\u4f7f\u7528\u52a8\u6001\u5e93\u81ea\u5df1\u7684 TLS \u53d8\u91cf\u3002\u6309\u7167\u524d\u9762\u7684\u5206\u6790\uff0c\u6709\u4e24\u79cd\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u52a8\u6001\u5e93\u662f\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u88ab\u52a8\u6001\u94fe\u63a5\u5668\u52a0\u8f7d\uff0c\u90a3\u4e48\u5b83\u4f1a\u88ab\u5206\u914d\u5728 <code>%fs</code> \u5f80\u4f4e\u5730\u5740\u7684\u7a7a\u95f4\u3002\u867d\u7136\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u65e0\u6cd5\u5728\u94fe\u63a5\u9636\u6bb5\u5c31\u63d0\u524d\u5f97\u77e5\uff0c\u4f46\u662f\u52a8\u6001\u94fe\u63a5\u5668\u4f1a\u7ed9\u5b83\u5206\u914d\u8fde\u7eed\u7684 TLS \u7a7a\u95f4\uff0c\u4ece\u800c\u53ef\u4ee5\u8ba1\u7b97\u51fa\u5b83\u7684 TLS \u7a7a\u95f4\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u4e8e\u662f\u52a8\u6001\u94fe\u63a5\u5668\u53ef\u4ee5\u5e2e\u52a9\u5b8c\u6210\u5269\u4e0b\u7684\u91cd\u5b9a\u4f4d\u3002</li>\n<li>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u52a8\u6001\u5e93\u662f\u7531 dlopen \u88ab\u52a0\u8f7d\uff0c\u90a3\u4e48\u5b83\u88ab\u5206\u914d\u7684 TLS \u7a7a\u95f4\u7684\u5730\u5740\u5c31\u65e0\u6cd5\u4ece <code>%fs</code> \u76f4\u63a5\u8ba1\u7b97\u5f97\u51fa\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u501f\u52a9 <code>__tls_get_addr</code> \u51fd\u6570\u7684\u5e2e\u52a9\u3002</li>\n</ol>\n<h3 id=\"initial-exec-tls-model\">initial exec TLS model<a class=\"headerlink\" href=\"#initial-exec-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u6765\u770b\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u5b83\u4e5f\u88ab\u53eb\u505a initial exec TLS model\u3002\u8fd8\u662f\u4ece\u4f8b\u5b50\u5f00\u59cb\u770b\u8d77\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a>\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data2</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u9996\u5148\u89c2\u5bdf\u7f16\u8bd1\u51fa\u6765\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>initial-exec<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a>read_tls_data1:\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">        </span>movq<span class=\"w\">    </span>tls_data1@gottpoff<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rax\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-10-6\"><a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\" href=\"#__codelineno-10-6\"></a><span class=\"w\">        </span>ret\n</span><span id=\"__span-10-7\"><a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\" href=\"#__codelineno-10-7\"></a>\n</span><span id=\"__span-10-8\"><a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\" href=\"#__codelineno-10-8\"></a>read_tls_data2:\n</span><span id=\"__span-10-9\"><a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\" href=\"#__codelineno-10-9\"></a><span class=\"w\">        </span>movq<span class=\"w\">    </span>tls_data2@gottpoff<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rax\n</span><span id=\"__span-10-10\"><a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\" href=\"#__codelineno-10-10\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-10-11\"><a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\" href=\"#__codelineno-10-11\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u6b21\u751f\u6210\u7684\u6c47\u7f16\u4e0d\u540c\u4e86\uff1a\u5b83\u9996\u5148\u4ece <code>symbol@gottpoff(%rip)</code> \u8bfb\u53d6\u4e00\u4e2a offset \u5230 <code>%rax</code> \u5bc4\u5b58\u5668\uff0c\u518d\u4ece <code>%fs:(%rax)</code> \u5730\u5740\u8bfb\u53d6 TLS \u53d8\u91cf\u7684\u503c\u3002\u4e0a\u9762\u63d0\u5230\uff0c\u5728 initial exec TLS model \u4e0b\uff0cTLS \u7a7a\u95f4\u662f\u53ef\u4ee5\u76f8\u5bf9 <code>%fs</code> \u5bfb\u5740\u7684\uff0c\u4f46\u662f offset \u65e0\u6cd5\u63d0\u524d\u5f97\u77e5\uff0c\u9700\u8981\u7531\u52a8\u6001\u94fe\u63a5\u5668\u5b8c\u6210\u91cd\u5b9a\u4f4d\u3002</p>\n<p>\u56de\u5fc6\u4e4b\u524d\u5728<a href=\"../../../../2024/04/07/write-a-linker-4/\">\u300a\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff084\uff09\u300b</a>\u4e00\u6587\u4e2d\uff0c\u5f53\u52a8\u6001\u5e93\u60f3\u8981\u83b7\u5f97\u67d0\u4e2a\u53ea\u6709\u52a8\u6001\u94fe\u63a5\u5668\u624d\u77e5\u9053\u7684\u5730\u5740\uff0c\u5c31\u4f1a\u628a\u5b83\u9884\u7559\u597d\u4f4d\u7f6e\u653e\u5230 <code>.got</code> \u8868\u5f53\u4e2d\uff0c\u5e76\u4e14\u8f93\u51fa\u4e00\u4e2a dynamic relocation\uff0c\u544a\u8bc9\u52a8\u6001\u94fe\u63a5\u5668\u5982\u4f55\u628a\u5730\u5740\u8ba1\u7b97\u51fa\u6765\u5e76\u586b\u8fdb\u53bb\u3002\u5728\u8fd9\u91cc\uff0c\u539f\u7406\u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u53ea\u4e0d\u8fc7\u662f\u5728 <code>.got</code> \u8868\u4e2d\u9884\u7559\u4e86\u4e00\u4e2a\u7a7a\u95f4\u6765\u4fdd\u5b58 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u3002\u4e0b\u9762\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6\u5185\u662f\u600e\u4e48\u8bb0\u5f55\u8fd9\u4e2a\u4fe1\u606f\u7684\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>tls.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 7 &lt;read_tls_data1+0x7&gt;</span>\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">                        </span><span class=\"m\">3</span>:<span class=\"w\"> </span>R_X86_64_GOTTPOFF<span class=\"w\">    </span>tls_data1-0x4\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">   </span><span class=\"m\">7</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">   </span>a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">   </span>b:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a><span class=\"m\">0000000000000010</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"w\">  </span><span class=\"m\">10</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 17 &lt;read_tls_data2+0x7&gt;</span>\n</span><span id=\"__span-11-13\"><a id=\"__codelineno-11-13\" name=\"__codelineno-11-13\" href=\"#__codelineno-11-13\"></a><span class=\"w\">                        </span><span class=\"m\">13</span>:<span class=\"w\"> </span>R_X86_64_GOTTPOFF<span class=\"w\">   </span>tls_data2-0x4\n</span><span id=\"__span-11-14\"><a id=\"__codelineno-11-14\" name=\"__codelineno-11-14\" href=\"#__codelineno-11-14\"></a><span class=\"w\">  </span><span class=\"m\">17</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-11-15\"><a id=\"__codelineno-11-15\" name=\"__codelineno-11-15\" href=\"#__codelineno-11-15\"></a><span class=\"w\">  </span>1a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u65f6\u5019\u5b83\u5728 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u4f4d\u7f6e\u521b\u5efa\u4e86\u4e00\u4e2a <code>R_X86_64_GOTTPOFF</code> \u7c7b\u578b\u7684\u91cd\u5b9a\u4f4d\uff0c\u8fd9\u662f\u544a\u8bc9\u94fe\u63a5\u5668\uff1a\u521b\u5efa\u4e00\u4e2a <code>.got</code> entry\uff0c\u91cc\u9762\u7531\u52a8\u6001\u94fe\u63a5\u5668\u586b\u5199\u5bf9\u5e94 symbol \u5728\u8fd0\u884c\u65f6\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u7136\u540e\u94fe\u63a5\u5668\u628a <code>.got</code> entry \u76f8\u5bf9 <code>mov</code> \u6307\u4ee4\u7684\u504f\u79fb\u5199\u5230 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u5185\u3002</p>\n<p>\u81f3\u4e8e\u4e3a\u5565\u662f <code>symbol-0x4</code> \u800c\u4e0d\u662f <code>symbol</code>\uff0c\u539f\u56e0\u5728\u4e4b\u524d<a href=\"../../../../2024/03/30/write-a-linker-2/\">\u300a\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff082\uff09\u300b</a> \u5df2\u7ecf\u51fa\u73b0\u8fc7\uff1ax86 \u6307\u4ee4\u7684\u7acb\u5373\u6570\u504f\u79fb\u662f\u57fa\u4e8e\u6307\u4ee4\u7ed3\u5c3e\u7684\uff0c\u800c relocation \u6307\u5411\u7684\u662f\u7acb\u5373\u6570\u7684\u8d77\u59cb\u5730\u5740\uff0c\u4e5f\u5c31\u662f\u6307\u4ee4\u7ed3\u5c3e\u5730\u5740\u51cf\u53bb 4\uff0c\u90a3\u4e48\u7acb\u5373\u6570\u4e5f\u8981\u505a\u76f8\u5e94\u7684\u4fee\u6b63\u3002</p>\n<p>\u6700\u540e\uff0c\u89c2\u5bdf\u94fe\u63a5\u5668\u505a\u7684\u4e8b\u60c5\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-shared<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-12-2\"><a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\" href=\"#__codelineno-12-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-S<span class=\"w\"> </span>-R<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-12-3\"><a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\" href=\"#__codelineno-12-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-12-4\"><a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\" href=\"#__codelineno-12-4\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-12-5\"><a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\" href=\"#__codelineno-12-5\"></a>\n</span><span id=\"__span-12-6\"><a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\" href=\"#__codelineno-12-6\"></a><span class=\"m\">0000000000001100</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-12-7\"><a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\" href=\"#__codelineno-12-7\"></a><span class=\"w\">    </span><span class=\"m\">1100</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>d1<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ed1<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fd8 &lt;tls_data1+0x3fd4&gt;</span>\n</span><span id=\"__span-12-8\"><a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\" href=\"#__codelineno-12-8\"></a><span class=\"w\">    </span><span class=\"m\">1107</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-12-9\"><a id=\"__codelineno-12-9\" name=\"__codelineno-12-9\" href=\"#__codelineno-12-9\"></a><span class=\"w\">    </span>110a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-12-10\"><a id=\"__codelineno-12-10\" name=\"__codelineno-12-10\" href=\"#__codelineno-12-10\"></a><span class=\"w\">    </span>110b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-12-11\"><a id=\"__codelineno-12-11\" name=\"__codelineno-12-11\" href=\"#__codelineno-12-11\"></a>\n</span><span id=\"__span-12-12\"><a id=\"__codelineno-12-12\" name=\"__codelineno-12-12\" href=\"#__codelineno-12-12\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-12-13\"><a id=\"__codelineno-12-13\" name=\"__codelineno-12-13\" href=\"#__codelineno-12-13\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>a9<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ea9<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fc0 &lt;tls_data2+0x3fc0&gt;</span>\n</span><span id=\"__span-12-14\"><a id=\"__codelineno-12-14\" name=\"__codelineno-12-14\" href=\"#__codelineno-12-14\"></a><span class=\"w\">    </span><span class=\"m\">1117</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-12-15\"><a id=\"__codelineno-12-15\" name=\"__codelineno-12-15\" href=\"#__codelineno-12-15\"></a><span class=\"w\">    </span>111a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-12-16\"><a id=\"__codelineno-12-16\" name=\"__codelineno-12-16\" href=\"#__codelineno-12-16\"></a>\n</span><span id=\"__span-12-17\"><a id=\"__codelineno-12-17\" name=\"__codelineno-12-17\" href=\"#__codelineno-12-17\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.got:\n</span><span id=\"__span-12-18\"><a id=\"__codelineno-12-18\" name=\"__codelineno-12-18\" href=\"#__codelineno-12-18\"></a>\n</span><span id=\"__span-12-19\"><a id=\"__codelineno-12-19\" name=\"__codelineno-12-19\" href=\"#__codelineno-12-19\"></a>0000000000003fb8<span class=\"w\"> </span>&lt;.got&gt;:\n</span><span id=\"__span-12-20\"><a id=\"__codelineno-12-20\" name=\"__codelineno-12-20\" href=\"#__codelineno-12-20\"></a><span class=\"w\">        </span>...\n</span><span id=\"__span-12-21\"><a id=\"__codelineno-12-21\" name=\"__codelineno-12-21\" href=\"#__codelineno-12-21\"></a><span class=\"w\">                        </span>3fc0:<span class=\"w\"> </span>R_X86_64_TPOFF64<span class=\"w\">  </span>tls_data2\n</span><span id=\"__span-12-22\"><a id=\"__codelineno-12-22\" name=\"__codelineno-12-22\" href=\"#__codelineno-12-22\"></a><span class=\"w\">                        </span>3fd8:<span class=\"w\"> </span>R_X86_64_TPOFF64<span class=\"w\">  </span>tls_data1\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff1a</p>\n<ol>\n<li>\u94fe\u63a5\u5668\u4e3a\u4e24\u4e2a TLS \u53d8\u91cf\u5206\u522b\u521b\u5efa\u4e86\u4e00\u4e2a <code>.got</code> entry\uff0c<code>tls_data1</code> \u5bf9\u5e94 <code>0x3fd8</code>\uff0c<code>tls_data2</code> \u5bf9\u5e94 <code>0x3fc0</code></li>\n<li>\u94fe\u63a5\u5668\u5728\u8fd9\u4e24\u4e2a <code>.got</code> entry \u5904\u521b\u5efa\u4e86 dynamic relocation <code>R_X86_64_TPOFF64</code>\uff0c\u544a\u8bc9\u52a8\u6001\u94fe\u63a5\u5668\uff1a\u7ed9\u52a8\u6001\u5e93\u5206\u914d\u7a7a\u95f4\u540e\uff0c\u628a <code>tls_data1</code> \u548c <code>tls_data2</code> \u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5199\u5165\u5230\u8fd9\u4e24\u4e2a <code>.got</code> entry \u5185</li>\n<li>\n<p>\u94fe\u63a5\u5668\u8ba1\u7b97\u51fa\u4e86 <code>mov</code> \u6307\u4ee4\u548c <code>.got</code> entry \u7684\u76f8\u5bf9\u504f\u79fb\uff0c\u76f4\u63a5\u5199\u5230\u4e86 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u5f53\u4e2d\uff1a</p>\n<p><div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a><span class=\"m\">0000000000001100</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a><span class=\"w\">    </span><span class=\"m\">1100</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>d1<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ed1<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fd8 &lt;tls_data1+0x3fd4&gt;</span>\n</span><span id=\"__span-13-3\"><a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\" href=\"#__codelineno-13-3\"></a><span class=\"w\">    </span><span class=\"m\">1107</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-13-4\"><a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\" href=\"#__codelineno-13-4\"></a><span class=\"w\">    </span>110a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-13-5\"><a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\" href=\"#__codelineno-13-5\"></a><span class=\"w\">    </span>110b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-13-6\"><a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\" href=\"#__codelineno-13-6\"></a>\n</span><span id=\"__span-13-7\"><a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\" href=\"#__codelineno-13-7\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-13-8\"><a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\" href=\"#__codelineno-13-8\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>a9<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ea9<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fc0 &lt;tls_data2+0x3fc0&gt;</span>\n</span><span id=\"__span-13-9\"><a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\" href=\"#__codelineno-13-9\"></a><span class=\"w\">    </span><span class=\"m\">1117</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-13-10\"><a id=\"__codelineno-13-10\" name=\"__codelineno-13-10\" href=\"#__codelineno-13-10\"></a><span class=\"w\">    </span>111a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n4. \u90a3\u4e48\u5728\u8fd0\u884c\u65f6\uff0c\u4e3a\u4e86\u8bfb\u53d6 TLS \u53d8\u91cf\uff0c\u9996\u5148\u4ece <code>.got</code> \u8868\u8bfb\u53d6 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5199\u5230 <code>%rax</code> \u5bc4\u5b58\u5668\uff0c\u518d\u901a\u8fc7 <code>%fs:(%rax)</code> \u8bbf\u95ee TLS \u53d8\u91cf\u5373\u53ef</p>\n</li>\n</ol>\n<p>\u90a3\u4e48\u8fd9\u5c31\u662f initial exec TLS model \u7684\u5b9e\u73b0\u65b9\u6cd5\u4e86\uff1a\u5b83\u5229\u7528\u4e86\u52a8\u6001\u5e93\u4f1a\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u6027\u8d28\uff0c\u4fdd\u8bc1 TLS \u53d8\u91cf\u90fd\u4fdd\u5b58\u5728\u76f8\u5bf9 <code>%fs</code> \u7684\u8fd0\u884c\u65f6\u53ef\u77e5\u4e14\u4e0d\u53d8\u7684\u504f\u79fb\u4e0a\uff0c\u628a\u504f\u79fb\u8bb0\u5f55\u5728 <code>.got</code> \u8868\u4e2d\uff0c\u7531\u52a8\u6001\u94fe\u63a5\u5668\u53bb\u8ba1\u7b97\uff0c\u90a3\u4e48\u8bbf\u95ee\u7684\u65f6\u5019\u5c31\u5f88\u7b80\u5355\u4e86\uff0c\u76f4\u63a5\u8bfb\u53d6 offset \u4ece <code>%fs</code> \u8bbf\u95ee\u5373\u53ef\u3002</p>\n<h3 id=\"localglobal-dynamic-tls-model\">local/global dynamic TLS model<a class=\"headerlink\" href=\"#localglobal-dynamic-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u770b\u52a8\u6001\u5e93\u7684\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff1a\u5b83\u53ef\u80fd\u7531 dlopen \u52a0\u8f7d\uff0c\u56e0\u6b64 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u4f4d\u7f6e\u53ef\u80fd\u4f1a\u53d8\u5316\uff0c\u6b64\u65f6\u9700\u8981\u901a\u8fc7 <code>__tls_get_addr</code> \u51fd\u6570\u6765\u5f97\u5230 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002\u56de\u987e\u524d\u9762\u63d0\u5230\u7684 <code>__tls_get_addr</code> \u7684\u58f0\u660e\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dl_tls_index</span>\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-14-3\"><a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\" href=\"#__codelineno-14-3\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_module</span><span class=\"p\">;</span>\n</span><span id=\"__span-14-4\"><a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\" href=\"#__codelineno-14-4\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-14-5\"><a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\" href=\"#__codelineno-14-5\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tls_index</span><span class=\"p\">;</span>\n</span><span id=\"__span-14-6\"><a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\" href=\"#__codelineno-14-6\"></a>\n</span><span id=\"__span-14-7\"><a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\" href=\"#__codelineno-14-7\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">__tls_get_addr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tls_index</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ti</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5373\u5b83\u9700\u8981\u4e24\u4e2a\u4fe1\u606f\uff0c\u4e00\u4e2a\u662f TLS \u53d8\u91cf\u6240\u5728\u7684\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff08\u8fd9\u4e2a\u7f16\u53f7\u662f\u52a8\u6001\u751f\u6210\u7684\u4e00\u4e2a id\uff0c\u5b9e\u9645\u4e0a\u662f\u8fd9\u4e2a\u52a8\u6001\u5e93\u5728 <code>dtv</code> \u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff09\uff0c\u53e6\u5916\u662f\u8fd9\u4e2a TLS \u53d8\u91cf\u5728\u52a8\u6001\u5e93\u5185\u7684\u504f\u79fb\u3002\u8fd9\u65f6\u5019\uff0c\u53c8\u5206\u4e3a\u4e24\u79cd\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u8fd9\u4e2a TLS \u53d8\u91cf\u5c31\u5728\u8fd9\u4e2a\u52a8\u6001\u5e93\u672c\u8eab\u5185\u90e8\u5b9a\u4e49\uff0c\u6b64\u65f6 TLS \u53d8\u91cf\u5728\u52a8\u6001\u5e93\u5185\u7684\u504f\u79fb\u5728\u94fe\u63a5\u671f\u95f4\u5df2\u77e5\uff0c\u53ea\u662f\u4e0d\u77e5\u9053 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u9700\u8981\u901a\u8fc7 <code>__tls_get_addr</code> \u51fd\u6570\u83b7\u53d6\uff0c\u8fd9\u79cd\u60c5\u666f\u53eb\u505a local dynamic TLS model</li>\n<li>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u8fd9\u4e2a TLS \u53d8\u91cf\u4e0d\u77e5\u9053\u5728\u54ea\u4e2a\u52a8\u6001\u5e93\u5b9a\u4e49\uff0c\u6b64\u65f6\u53ea\u77e5\u9053\u8fd9\u4e2a TLS \u53d8\u91cf\u7684\u540d\u5b57\uff0c\u4e0d\u77e5\u9053\u5b83\u5c5e\u4e8e\u54ea\u4e2a\u52a8\u6001\u5e93\uff0c\u4e5f\u4e0d\u77e5\u9053\u5b83\u5728\u52a8\u6001\u5e93\u5185\u7684\u504f\u79fb\uff0c\u8fd9\u79cd\u60c5\u51b5\u53eb\u505a global dynamic TLS model\uff0c\u662f\u6700\u901a\u7528\u7684\u60c5\u51b5\uff0c\u5bf9 TLS \u53d8\u91cf\u6240\u5728\u7684\u4f4d\u7f6e\u6ca1\u6709\u4efb\u4f55\u5047\u8bbe</li>\n</ol>\n<h3 id=\"local-dynamic-tls-model\">local dynamic TLS model<a class=\"headerlink\" href=\"#local-dynamic-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u5206\u6790 local dynamic TLS model\uff0c\u5b83\u9762\u5411\u7684\u573a\u666f\u662f\u4e00\u4e2a\u53ef\u80fd\u88ab dlopen \u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u9700\u8981\u8bbf\u95ee\u81ea\u5df1\u7684 TLS \u53d8\u91cf\uff0c\u6b64\u65f6\u9700\u8981\u7528 <code>__tls_get_addr</code> \u8bfb\u53d6\u81ea\u5df1\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u6839\u636e\u94fe\u63a5\u65f6\u5df2\u77e5\u7684\u504f\u79fb\uff0c\u8ba1\u7b97\u51fa TLS \u53d8\u91cf\u5728\u8fd0\u884c\u65f6\u7684\u5730\u5740\u3002\u7531\u4e8e <code>__tls_get_addr</code> \u9700\u8981\u77e5\u9053\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff0c\u800c\u8fd9\u4e2a\u7f16\u53f7\u53ea\u6709\u52a8\u6001\u94fe\u63a5\u5668\u624d\u77e5\u9053\uff0c\u56e0\u6b64\u9700\u8981\u751f\u6210\u4e00\u4e2a dynamic relocation\uff0c\u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u628a\u8fd9\u4e2a\u52a8\u6001\u5e93\u81ea\u5df1\u7684\u7f16\u53f7\u5199\u5165\u5230 <code>.got</code> entry \u4e2d\uff0c\u4e4b\u540e\u624d\u80fd\u62ff\u8fd9\u4e2a <code>.got</code> entry \u7684\u503c\u8c03\u7528 <code>__tls_get_addr</code>\uff0c\u8fdb\u800c\u5f97\u5230 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002\u4e0b\u9762\u6765\u89c2\u5bdf\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6e90\u7801\u548c\u4e4b\u524d\u4e00\u6837\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a>\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-15-5\"><a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\" href=\"#__codelineno-15-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data2</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u9996\u5148\u67e5\u770b\u751f\u6210\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-16-1\"><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\" href=\"#__codelineno-16-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>local-dynamic<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-16-2\"><a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\" href=\"#__codelineno-16-2\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-16-3\"><a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\" href=\"#__codelineno-16-3\"></a>read_tls_data1:\n</span><span id=\"__span-16-4\"><a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\" href=\"#__codelineno-16-4\"></a>.LFB0:\n</span><span id=\"__span-16-5\"><a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\" href=\"#__codelineno-16-5\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-6\"><a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\" href=\"#__codelineno-16-6\"></a><span class=\"w\">        </span>leaq<span class=\"w\">    </span>tls_data1@tlsld<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-16-7\"><a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\" href=\"#__codelineno-16-7\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-16-8\"><a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\" href=\"#__codelineno-16-8\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>tls_data1@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-16-9\"><a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\" href=\"#__codelineno-16-9\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-10\"><a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\" href=\"#__codelineno-16-10\"></a><span class=\"w\">        </span>ret\n</span><span id=\"__span-16-11\"><a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\" href=\"#__codelineno-16-11\"></a>\n</span><span id=\"__span-16-12\"><a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\" href=\"#__codelineno-16-12\"></a>read_tls_data2:\n</span><span id=\"__span-16-13\"><a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\" href=\"#__codelineno-16-13\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-14\"><a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\" href=\"#__codelineno-16-14\"></a><span class=\"w\">        </span>leaq<span class=\"w\">    </span>tls_data2@tlsld<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-16-15\"><a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\" href=\"#__codelineno-16-15\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-16-16\"><a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\" href=\"#__codelineno-16-16\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>tls_data2@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-16-17\"><a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\" href=\"#__codelineno-16-17\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-18\"><a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\" href=\"#__codelineno-16-18\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u9996\u5148\u53ef\u4ee5\u770b\u5230\u7684\u662f\u4e00\u4e2a\u65b0\u7684\u8bed\u6cd5\uff1a<code>symbol@tlsld(%rip)</code>\uff0c\u751f\u6210\u4e00\u4e2a <code>R_X86_64_TLSLD</code> \u7c7b\u578b\u7684 relocation\uff0c\u5b83\u7684\u610f\u601d\u662f\u5728 <code>.got</code> \u8868\u4e2d\u751f\u6210\u4e00\u4e2a entry\uff0c\u8fd9\u4e2a entry \u4f1a\u4fdd\u5b58\u5f53\u524d\u52a8\u6001\u5e93\u5bf9\u5e94\u7684\u7f16\u53f7\uff0c\u7136\u540e\u5728\u8fd9\u91cc\u901a\u8fc7 <code>lea</code> \u6307\u4ee4\u628a\u8fd9\u4e2a <code>.got</code> entry \u7684\u5730\u5740\u4f5c\u4e3a <code>tls_index *</code> \u7c7b\u578b\u7684\u53c2\u6570\u4f20\u7ed9 <code>__tls_get_addr</code>\uff0c\u90a3\u4e48\u5b83\u5c31\u4f1a\u53bb\u5bfb\u627e\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u628a\u7ed3\u679c\u5199\u5165\u5230 <code>%rax</code> \u5bc4\u5b58\u5668\u5185\u3002</p>\n<p>\u5f97\u5230 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u540e\uff0c\u518d\u5229\u7528 <code>symbol@dtpoff(%rax)</code> \u7684\u8bed\u6cd5\uff0c\u751f\u6210 <code>R_X86_64_DTPOFF32</code> \u7c7b\u578b\u7684 relocation\uff0c\u5728\u94fe\u63a5\u7684\u65f6\u5019\u76f4\u63a5\u628a <code>symbol</code> \u76f8\u5bf9\u81ea\u5df1\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u7684\u504f\u79fb\u5199\u5230 <code>movl</code> \u6307\u4ee4\u5185\uff0c\u4ece\u800c\u5b9e\u73b0\u4e86 TLS \u53d8\u91cf\u7684\u8bbf\u95ee\u3002</p>\n<p>\u4e0b\u9762\u89c2\u5bdf\u751f\u6210\u7684\u5bf9\u8c61\u6587\u4ef6\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-17-1\"><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\" href=\"#__codelineno-17-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>tls.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-17-2\"><a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\" href=\"#__codelineno-17-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-17-3\"><a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\" href=\"#__codelineno-17-3\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-17-4\"><a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\" href=\"#__codelineno-17-4\"></a>\n</span><span id=\"__span-17-5\"><a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\" href=\"#__codelineno-17-5\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-17-6\"><a id=\"__codelineno-17-6\" name=\"__codelineno-17-6\" href=\"#__codelineno-17-6\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-7\"><a id=\"__codelineno-17-7\" name=\"__codelineno-17-7\" href=\"#__codelineno-17-7\"></a><span class=\"w\">   </span><span class=\"m\">4</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># b &lt;read_tls_data1+0xb&gt;</span>\n</span><span id=\"__span-17-8\"><a id=\"__codelineno-17-8\" name=\"__codelineno-17-8\" href=\"#__codelineno-17-8\"></a><span class=\"w\">                        </span><span class=\"m\">7</span>:<span class=\"w\"> </span>R_X86_64_TLSLD<span class=\"w\">       </span>tls_data1-0x4\n</span><span id=\"__span-17-9\"><a id=\"__codelineno-17-9\" name=\"__codelineno-17-9\" href=\"#__codelineno-17-9\"></a><span class=\"w\">   </span>b:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">10</span><span class=\"w\"> </span>&lt;read_tls_data1+0x10&gt;\n</span><span id=\"__span-17-10\"><a id=\"__codelineno-17-10\" name=\"__codelineno-17-10\" href=\"#__codelineno-17-10\"></a><span class=\"w\">                        </span>c:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">       </span>__tls_get_addr-0x4\n</span><span id=\"__span-17-11\"><a id=\"__codelineno-17-11\" name=\"__codelineno-17-11\" href=\"#__codelineno-17-11\"></a><span class=\"w\">  </span><span class=\"m\">10</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-17-12\"><a id=\"__codelineno-17-12\" name=\"__codelineno-17-12\" href=\"#__codelineno-17-12\"></a><span class=\"w\">                        </span><span class=\"m\">12</span>:<span class=\"w\"> </span>R_X86_64_DTPOFF32<span class=\"w\">   </span>tls_data1\n</span><span id=\"__span-17-13\"><a id=\"__codelineno-17-13\" name=\"__codelineno-17-13\" href=\"#__codelineno-17-13\"></a><span class=\"w\">  </span><span class=\"m\">16</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-14\"><a id=\"__codelineno-17-14\" name=\"__codelineno-17-14\" href=\"#__codelineno-17-14\"></a><span class=\"w\">  </span>1a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-17-15\"><a id=\"__codelineno-17-15\" name=\"__codelineno-17-15\" href=\"#__codelineno-17-15\"></a><span class=\"w\">  </span>1b:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-17-16\"><a id=\"__codelineno-17-16\" name=\"__codelineno-17-16\" href=\"#__codelineno-17-16\"></a>\n</span><span id=\"__span-17-17\"><a id=\"__codelineno-17-17\" name=\"__codelineno-17-17\" href=\"#__codelineno-17-17\"></a><span class=\"m\">0000000000000020</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-17-18\"><a id=\"__codelineno-17-18\" name=\"__codelineno-17-18\" href=\"#__codelineno-17-18\"></a><span class=\"w\">  </span><span class=\"m\">20</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-19\"><a id=\"__codelineno-17-19\" name=\"__codelineno-17-19\" href=\"#__codelineno-17-19\"></a><span class=\"w\">  </span><span class=\"m\">24</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 2b &lt;read_tls_data2+0xb&gt;</span>\n</span><span id=\"__span-17-20\"><a id=\"__codelineno-17-20\" name=\"__codelineno-17-20\" href=\"#__codelineno-17-20\"></a><span class=\"w\">                        </span><span class=\"m\">27</span>:<span class=\"w\"> </span>R_X86_64_TLSLD<span class=\"w\">      </span>tls_data2-0x4\n</span><span id=\"__span-17-21\"><a id=\"__codelineno-17-21\" name=\"__codelineno-17-21\" href=\"#__codelineno-17-21\"></a><span class=\"w\">  </span>2b:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">30</span><span class=\"w\"> </span>&lt;read_tls_data2+0x10&gt;\n</span><span id=\"__span-17-22\"><a id=\"__codelineno-17-22\" name=\"__codelineno-17-22\" href=\"#__codelineno-17-22\"></a><span class=\"w\">                        </span>2c:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">      </span>__tls_get_addr-0x4\n</span><span id=\"__span-17-23\"><a id=\"__codelineno-17-23\" name=\"__codelineno-17-23\" href=\"#__codelineno-17-23\"></a><span class=\"w\">  </span><span class=\"m\">30</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-17-24\"><a id=\"__codelineno-17-24\" name=\"__codelineno-17-24\" href=\"#__codelineno-17-24\"></a><span class=\"w\">                        </span><span class=\"m\">32</span>:<span class=\"w\"> </span>R_X86_64_DTPOFF32<span class=\"w\">   </span>tls_data2\n</span><span id=\"__span-17-25\"><a id=\"__codelineno-17-25\" name=\"__codelineno-17-25\" href=\"#__codelineno-17-25\"></a><span class=\"w\">  </span><span class=\"m\">36</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-26\"><a id=\"__codelineno-17-26\" name=\"__codelineno-17-26\" href=\"#__codelineno-17-26\"></a><span class=\"w\">  </span>3a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e <code>__tls_get_addr</code> \u7684\u8fd0\u884c\u65f6\u5730\u5740\u4e5f\u662f\u4e0d\u77e5\u9053\u7684\uff0c\u6240\u4ee5\u5c31\u548c\u8c03\u7528\u5176\u4ed6\u52a8\u6001\u5e93\u7684\u51fd\u6570\u4e00\u6837\uff0c\u7528\u5df2\u6709\u7684 PLT \u673a\u5236\u53bb\u91cd\u5b9a\u4f4d\u3002</p>\n<p>\u63a5\u4e0b\u6765\u770b\u6700\u540e\u7684\u52a8\u6001\u5e93\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-18-1\"><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\" href=\"#__codelineno-18-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-shared<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-18-2\"><a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\" href=\"#__codelineno-18-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-R<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-18-3\"><a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\" href=\"#__codelineno-18-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-18-4\"><a id=\"__codelineno-18-4\" name=\"__codelineno-18-4\" href=\"#__codelineno-18-4\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-18-5\"><a id=\"__codelineno-18-5\" name=\"__codelineno-18-5\" href=\"#__codelineno-18-5\"></a>\n</span><span id=\"__span-18-6\"><a id=\"__codelineno-18-6\" name=\"__codelineno-18-6\" href=\"#__codelineno-18-6\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-18-7\"><a id=\"__codelineno-18-7\" name=\"__codelineno-18-7\" href=\"#__codelineno-18-7\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-8\"><a id=\"__codelineno-18-8\" name=\"__codelineno-18-8\" href=\"#__codelineno-18-8\"></a><span class=\"w\">    </span><span class=\"m\">1114</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span>9d<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x2e9d<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fb8 &lt;_DYNAMIC+0x1c0&gt;</span>\n</span><span id=\"__span-18-9\"><a id=\"__codelineno-18-9\" name=\"__codelineno-18-9\" href=\"#__codelineno-18-9\"></a><span class=\"w\">    </span>111b:<span class=\"w\">       </span>e8<span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-18-10\"><a id=\"__codelineno-18-10\" name=\"__codelineno-18-10\" href=\"#__codelineno-18-10\"></a><span class=\"w\">    </span><span class=\"m\">1120</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x4<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-18-11\"><a id=\"__codelineno-18-11\" name=\"__codelineno-18-11\" href=\"#__codelineno-18-11\"></a><span class=\"w\">    </span><span class=\"m\">1126</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-12\"><a id=\"__codelineno-18-12\" name=\"__codelineno-18-12\" href=\"#__codelineno-18-12\"></a><span class=\"w\">    </span>112a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-18-13\"><a id=\"__codelineno-18-13\" name=\"__codelineno-18-13\" href=\"#__codelineno-18-13\"></a><span class=\"w\">    </span>112b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-18-14\"><a id=\"__codelineno-18-14\" name=\"__codelineno-18-14\" href=\"#__codelineno-18-14\"></a>\n</span><span id=\"__span-18-15\"><a id=\"__codelineno-18-15\" name=\"__codelineno-18-15\" href=\"#__codelineno-18-15\"></a><span class=\"m\">0000000000001130</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-18-16\"><a id=\"__codelineno-18-16\" name=\"__codelineno-18-16\" href=\"#__codelineno-18-16\"></a><span class=\"w\">    </span><span class=\"m\">1130</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-17\"><a id=\"__codelineno-18-17\" name=\"__codelineno-18-17\" href=\"#__codelineno-18-17\"></a><span class=\"w\">    </span><span class=\"m\">1134</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span>7d<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x2e7d<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fb8 &lt;_DYNAMIC+0x1c0&gt;</span>\n</span><span id=\"__span-18-18\"><a id=\"__codelineno-18-18\" name=\"__codelineno-18-18\" href=\"#__codelineno-18-18\"></a><span class=\"w\">    </span>113b:<span class=\"w\">       </span>e8<span class=\"w\"> </span>f0<span class=\"w\"> </span>fe<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-18-19\"><a id=\"__codelineno-18-19\" name=\"__codelineno-18-19\" href=\"#__codelineno-18-19\"></a><span class=\"w\">    </span><span class=\"m\">1140</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-18-20\"><a id=\"__codelineno-18-20\" name=\"__codelineno-18-20\" href=\"#__codelineno-18-20\"></a><span class=\"w\">    </span><span class=\"m\">1146</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-21\"><a id=\"__codelineno-18-21\" name=\"__codelineno-18-21\" href=\"#__codelineno-18-21\"></a><span class=\"w\">    </span>114a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-18-22\"><a id=\"__codelineno-18-22\" name=\"__codelineno-18-22\" href=\"#__codelineno-18-22\"></a>\n</span><span id=\"__span-18-23\"><a id=\"__codelineno-18-23\" name=\"__codelineno-18-23\" href=\"#__codelineno-18-23\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.got:\n</span><span id=\"__span-18-24\"><a id=\"__codelineno-18-24\" name=\"__codelineno-18-24\" href=\"#__codelineno-18-24\"></a>\n</span><span id=\"__span-18-25\"><a id=\"__codelineno-18-25\" name=\"__codelineno-18-25\" href=\"#__codelineno-18-25\"></a>0000000000003fb8<span class=\"w\"> </span>&lt;.got&gt;:\n</span><span id=\"__span-18-26\"><a id=\"__codelineno-18-26\" name=\"__codelineno-18-26\" href=\"#__codelineno-18-26\"></a><span class=\"w\">        </span>...\n</span><span id=\"__span-18-27\"><a id=\"__codelineno-18-27\" name=\"__codelineno-18-27\" href=\"#__codelineno-18-27\"></a><span class=\"w\">                        </span>3fb8:<span class=\"w\"> </span>R_X86_64_DTPMOD64<span class=\"w\"> </span>*ABS*\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u65e0\u8bba\u662f\u8bbf\u95ee <code>tls_data1</code> \u8fd8\u662f <code>tls_data2</code>\uff0c\u5728\u8c03\u7528 <code>__tls_get_addr</code> \u65f6\uff0c\u4f7f\u7528\u7684\u53c2\u6570\u90fd\u662f\u4e00\u6837\u7684 <code>0x3fb8</code>\uff0c\u4e5f\u5c31\u662f\u52a8\u6001\u94fe\u63a5\u5668\u628a\u5f53\u524d\u52a8\u6001\u5e93\u7684\u7f16\u53f7\u5199\u8fdb\u53bb\u7684 <code>.got</code> entry\u3002\u8fd4\u56de\u503c\u5c31\u662f\u5f53\u524d\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u57fa\u5730\u5740\uff0c\u628a\u8fd4\u56de\u503c\u52a0\u4e0a\u5bf9\u5e94\u7684 offset\uff08<code>tls_data1</code> \u7684\u504f\u79fb\u662f 4\uff0c<code>tls_data2</code> \u7684\u504f\u79fb\u662f 0\uff0c\u8fd9\u4e2a offset \u76f4\u63a5\u5199\u5230\u4e86 <code>movl</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u91cc\uff09\uff0c\u5c31\u5f97\u5230\u4e86 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002</p>\n<p>\u7279\u522b\u5730\uff0c\u5982\u679c\u5728\u4e00\u4e2a\u51fd\u6570\u91cc\u8bbf\u95ee\u591a\u4e2a\u5f53\u524d\u52a8\u6001\u5e93\u7684 TLS \u53d8\u91cf\uff0c\u90a3\u4e48 <code>__tls_get_addr</code> \u8c03\u7528\u662f\u53ef\u4ee5\u5408\u5e76\u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-19-1\"><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\" href=\"#__codelineno-19-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-19-2\"><a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\" href=\"#__codelineno-19-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-19-3\"><a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\" href=\"#__codelineno-19-3\"></a>\n</span><span id=\"__span-19-4\"><a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\" href=\"#__codelineno-19-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4f1a\u751f\u6210\u5982\u4e0b\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-20-1\"><a id=\"__codelineno-20-1\" name=\"__codelineno-20-1\" href=\"#__codelineno-20-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>local-dynamic<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-20-2\"><a id=\"__codelineno-20-2\" name=\"__codelineno-20-2\" href=\"#__codelineno-20-2\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-20-3\"><a id=\"__codelineno-20-3\" name=\"__codelineno-20-3\" href=\"#__codelineno-20-3\"></a>read_tls_data:\n</span><span id=\"__span-20-4\"><a id=\"__codelineno-20-4\" name=\"__codelineno-20-4\" href=\"#__codelineno-20-4\"></a>.LFB0:\n</span><span id=\"__span-20-5\"><a id=\"__codelineno-20-5\" name=\"__codelineno-20-5\" href=\"#__codelineno-20-5\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-20-6\"><a id=\"__codelineno-20-6\" name=\"__codelineno-20-6\" href=\"#__codelineno-20-6\"></a><span class=\"w\">        </span>leaq<span class=\"w\">    </span>tls_data1@tlsld<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-20-7\"><a id=\"__codelineno-20-7\" name=\"__codelineno-20-7\" href=\"#__codelineno-20-7\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-20-8\"><a id=\"__codelineno-20-8\" name=\"__codelineno-20-8\" href=\"#__codelineno-20-8\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>tls_data1@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%edx\n</span><span id=\"__span-20-9\"><a id=\"__codelineno-20-9\" name=\"__codelineno-20-9\" href=\"#__codelineno-20-9\"></a><span class=\"w\">        </span>addl<span class=\"w\">    </span>tls_data2@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%edx\n</span><span id=\"__span-20-10\"><a id=\"__codelineno-20-10\" name=\"__codelineno-20-10\" href=\"#__codelineno-20-10\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-20-11\"><a id=\"__codelineno-20-11\" name=\"__codelineno-20-11\" href=\"#__codelineno-20-11\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>%edx,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-20-12\"><a id=\"__codelineno-20-12\" name=\"__codelineno-20-12\" href=\"#__codelineno-20-12\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u51cf\u5c11\u4e86\u4e00\u6b21 <code>__tls_get_addr</code> \u7684\u8c03\u7528\u3002</p>\n<h3 id=\"global-dynamic-tls-model\">global dynamic TLS model<a class=\"headerlink\" href=\"#global-dynamic-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u518d\u6765\u4ecb\u7ecd\u6700\u540e\u4e00\u79cd\u60c5\u51b5\uff1a\u5bf9\u4e8e\u4e00\u4e2a dlopen \u7684\u52a8\u6001\u5e93\uff0c\u5982\u679c\u5b83\u8981\u8bbf\u95ee\u7684 TLS \u53d8\u91cf\uff0c\u53ea\u77e5\u9053\u540d\u5b57\uff0c\u4e0d\u77e5\u9053\u6765\u81ea\u54ea\u4e00\u4e2a\u52a8\u6001\u5e93\uff0c\u4e0d\u77e5\u9053\u504f\u79fb\u662f\u591a\u5c11\u3002\u8fd9\u65f6\u5019\uff0c\u53ea\u80fd\u628a\u5168\u90e8\u5de5\u4f5c\u4ea4\u7ed9\u52a8\u6001\u94fe\u63a5\u5668\u53bb\u505a\uff1a\u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u6839\u636e\u7b26\u53f7\uff0c\u53bb\u67e5\u627e\u7b26\u53f7\u8868\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u52a8\u6001\u5e93\u548c\u504f\u79fb\uff0c\u8bb0\u5f55\u4e0b\u6765\uff1b\u7531\u4e8e\u6d89\u53ca\u5230\u52a8\u6001\u5e93\u7684\u7f16\u53f7\u548c\u504f\u79fb\uff0c\u6240\u4ee5\u9700\u8981\u4e24\u4e2a\u8fde\u7eed\u7684 <code>.got</code> entry\uff0c\u6b63\u597d\u5bf9\u5e94 <code>tls_index</code> \u7ed3\u6784\u4f53\u7684\u4e24\u9879\u6210\u5458\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-21-1\"><a id=\"__codelineno-21-1\" name=\"__codelineno-21-1\" href=\"#__codelineno-21-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dl_tls_index</span>\n</span><span id=\"__span-21-2\"><a id=\"__codelineno-21-2\" name=\"__codelineno-21-2\" href=\"#__codelineno-21-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-21-3\"><a id=\"__codelineno-21-3\" name=\"__codelineno-21-3\" href=\"#__codelineno-21-3\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_module</span><span class=\"p\">;</span>\n</span><span id=\"__span-21-4\"><a id=\"__codelineno-21-4\" name=\"__codelineno-21-4\" href=\"#__codelineno-21-4\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-21-5\"><a id=\"__codelineno-21-5\" name=\"__codelineno-21-5\" href=\"#__codelineno-21-5\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tls_index</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u7ee7\u7eed\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u8fd9\u6b21\u91c7\u7528 global dynamic TLS model \u8fdb\u884c\u7f16\u8bd1\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-22-1\"><a id=\"__codelineno-22-1\" name=\"__codelineno-22-1\" href=\"#__codelineno-22-1\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-22-2\"><a id=\"__codelineno-22-2\" name=\"__codelineno-22-2\" href=\"#__codelineno-22-2\"></a>__thread<span class=\"w\"> </span>int<span class=\"w\"> </span>tls_data1<span class=\"p\">;</span>\n</span><span id=\"__span-22-3\"><a id=\"__codelineno-22-3\" name=\"__codelineno-22-3\" href=\"#__codelineno-22-3\"></a>__thread<span class=\"w\"> </span>int<span class=\"w\"> </span>tls_data2<span class=\"p\">;</span>\n</span><span id=\"__span-22-4\"><a id=\"__codelineno-22-4\" name=\"__codelineno-22-4\" href=\"#__codelineno-22-4\"></a>\n</span><span id=\"__span-22-5\"><a id=\"__codelineno-22-5\" name=\"__codelineno-22-5\" href=\"#__codelineno-22-5\"></a>int<span class=\"w\"> </span>read_tls_data1<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span>tls_data1<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</span><span id=\"__span-22-6\"><a id=\"__codelineno-22-6\" name=\"__codelineno-22-6\" href=\"#__codelineno-22-6\"></a>int<span class=\"w\"> </span>read_tls_data2<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span>tls_data2<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</span><span id=\"__span-22-7\"><a id=\"__codelineno-22-7\" name=\"__codelineno-22-7\" href=\"#__codelineno-22-7\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>global-dynamic<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-22-8\"><a id=\"__codelineno-22-8\" name=\"__codelineno-22-8\" href=\"#__codelineno-22-8\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-22-9\"><a id=\"__codelineno-22-9\" name=\"__codelineno-22-9\" href=\"#__codelineno-22-9\"></a>read_tls_data1:\n</span><span id=\"__span-22-10\"><a id=\"__codelineno-22-10\" name=\"__codelineno-22-10\" href=\"#__codelineno-22-10\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-11\"><a id=\"__codelineno-22-11\" name=\"__codelineno-22-11\" href=\"#__codelineno-22-11\"></a><span class=\"w\">        </span>data16<span class=\"w\">  </span>leaq<span class=\"w\">    </span>tls_data1@tlsgd<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-22-12\"><a id=\"__codelineno-22-12\" name=\"__codelineno-22-12\" href=\"#__codelineno-22-12\"></a><span class=\"w\">        </span>.value<span class=\"w\">  </span>0x6666\n</span><span id=\"__span-22-13\"><a id=\"__codelineno-22-13\" name=\"__codelineno-22-13\" href=\"#__codelineno-22-13\"></a><span class=\"w\">        </span>rex64\n</span><span id=\"__span-22-14\"><a id=\"__codelineno-22-14\" name=\"__codelineno-22-14\" href=\"#__codelineno-22-14\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-22-15\"><a id=\"__codelineno-22-15\" name=\"__codelineno-22-15\" href=\"#__codelineno-22-15\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-22-16\"><a id=\"__codelineno-22-16\" name=\"__codelineno-22-16\" href=\"#__codelineno-22-16\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-17\"><a id=\"__codelineno-22-17\" name=\"__codelineno-22-17\" href=\"#__codelineno-22-17\"></a><span class=\"w\">        </span>ret\n</span><span id=\"__span-22-18\"><a id=\"__codelineno-22-18\" name=\"__codelineno-22-18\" href=\"#__codelineno-22-18\"></a>\n</span><span id=\"__span-22-19\"><a id=\"__codelineno-22-19\" name=\"__codelineno-22-19\" href=\"#__codelineno-22-19\"></a>read_tls_data2:\n</span><span id=\"__span-22-20\"><a id=\"__codelineno-22-20\" name=\"__codelineno-22-20\" href=\"#__codelineno-22-20\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-21\"><a id=\"__codelineno-22-21\" name=\"__codelineno-22-21\" href=\"#__codelineno-22-21\"></a><span class=\"w\">        </span>data16<span class=\"w\">  </span>leaq<span class=\"w\">    </span>tls_data2@tlsgd<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-22-22\"><a id=\"__codelineno-22-22\" name=\"__codelineno-22-22\" href=\"#__codelineno-22-22\"></a><span class=\"w\">        </span>.value<span class=\"w\">  </span>0x6666\n</span><span id=\"__span-22-23\"><a id=\"__codelineno-22-23\" name=\"__codelineno-22-23\" href=\"#__codelineno-22-23\"></a><span class=\"w\">        </span>rex64\n</span><span id=\"__span-22-24\"><a id=\"__codelineno-22-24\" name=\"__codelineno-22-24\" href=\"#__codelineno-22-24\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-22-25\"><a id=\"__codelineno-22-25\" name=\"__codelineno-22-25\" href=\"#__codelineno-22-25\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-22-26\"><a id=\"__codelineno-22-26\" name=\"__codelineno-22-26\" href=\"#__codelineno-22-26\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-27\"><a id=\"__codelineno-22-27\" name=\"__codelineno-22-27\" href=\"#__codelineno-22-27\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u8fd9\u6b21\u51fa\u73b0\u4e86\u4e00\u4e9b\u4e0d\u4e00\u6837\u7684\u5185\u5bb9\uff1a<code>data16</code>\u3001<code>.value 0x6666</code> \u548c <code>rex64</code>\uff1b\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e9b\u662f\u65e0\u7528\u7684\u6307\u4ee4\u524d\u7f00\uff0c\u4e0d\u5f71\u54cd\u6307\u4ee4\u7684\u8bed\u4e49\uff0c\u4f46\u662f\u4fdd\u8bc1\u4e86\u8fd9\u6bb5\u4ee3\u7801\u6709\u8db3\u591f\u7684\u957f\u5ea6\uff0c\u65b9\u4fbf\u540e\u7eed\u94fe\u63a5\u5668\u8fdb\u884c\u4f18\u5316\u3002\u9664\u4e86\u8fd9\u4e9b\u5947\u602a\u7684\u524d\u7f00\uff0c\u6838\u5fc3\u5c31\u662f <code>symbol@tlsgd(%rip)</code> \u8bed\u6cd5\uff0c\u5b83\u4f1a\u521b\u5efa <code>R_X86_64_TLSGD</code> relocation\uff0c\u5b83\u7684\u610f\u601d\u662f\uff1a\u521b\u5efa\u4e00\u5bf9 <code>.got</code> entry\uff0c\u7b2c\u4e00\u4e2a entry \u5bf9\u5e94 symbol \u6240\u5728\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff0c\u7b2c\u4e8c\u4e2a entry \u5bf9\u5e94 symbol \u5728\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\uff0c\u8fd9\u4e24\u4e2a entry \u7ec4\u6210\u4e00\u4e2a <code>tls_index</code> \u7ed3\u6784\u4f53\uff1b\u901a\u8fc7 <code>leaq</code> \u6307\u4ee4\u5f97\u5230\u8fd9\u4e2a\u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c\u8c03\u7528 <code>__tls_get_addr</code>\uff0c\u5c31\u5f97\u5230\u4e86\u8fd9\u4e2a TLS \u53d8\u91cf\u7684\u5730\u5740\u3002</p>\n<p>\u63a5\u4e0b\u6765\u770b\u751f\u6210\u7684\u5bf9\u8c61\u6587\u4ef6\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-23-1\"><a id=\"__codelineno-23-1\" name=\"__codelineno-23-1\" href=\"#__codelineno-23-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>tls.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-23-2\"><a id=\"__codelineno-23-2\" name=\"__codelineno-23-2\" href=\"#__codelineno-23-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-23-3\"><a id=\"__codelineno-23-3\" name=\"__codelineno-23-3\" href=\"#__codelineno-23-3\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-23-4\"><a id=\"__codelineno-23-4\" name=\"__codelineno-23-4\" href=\"#__codelineno-23-4\"></a>\n</span><span id=\"__span-23-5\"><a id=\"__codelineno-23-5\" name=\"__codelineno-23-5\" href=\"#__codelineno-23-5\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-23-6\"><a id=\"__codelineno-23-6\" name=\"__codelineno-23-6\" href=\"#__codelineno-23-6\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-7\"><a id=\"__codelineno-23-7\" name=\"__codelineno-23-7\" href=\"#__codelineno-23-7\"></a><span class=\"w\">   </span><span class=\"m\">4</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># c &lt;read_tls_data1+0xc&gt;</span>\n</span><span id=\"__span-23-8\"><a id=\"__codelineno-23-8\" name=\"__codelineno-23-8\" href=\"#__codelineno-23-8\"></a><span class=\"w\">   </span>b:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-9\"><a id=\"__codelineno-23-9\" name=\"__codelineno-23-9\" href=\"#__codelineno-23-9\"></a><span class=\"w\">                        </span><span class=\"m\">8</span>:<span class=\"w\"> </span>R_X86_64_TLSGD<span class=\"w\">       </span>tls_data1-0x4\n</span><span id=\"__span-23-10\"><a id=\"__codelineno-23-10\" name=\"__codelineno-23-10\" href=\"#__codelineno-23-10\"></a><span class=\"w\">   </span>c:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\"> </span>&lt;read_tls_data1+0x14&gt;\n</span><span id=\"__span-23-11\"><a id=\"__codelineno-23-11\" name=\"__codelineno-23-11\" href=\"#__codelineno-23-11\"></a><span class=\"w\">  </span><span class=\"m\">13</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-12\"><a id=\"__codelineno-23-12\" name=\"__codelineno-23-12\" href=\"#__codelineno-23-12\"></a><span class=\"w\">                        </span><span class=\"m\">10</span>:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">      </span>__tls_get_addr-0x4\n</span><span id=\"__span-23-13\"><a id=\"__codelineno-23-13\" name=\"__codelineno-23-13\" href=\"#__codelineno-23-13\"></a><span class=\"w\">  </span><span class=\"m\">14</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-23-14\"><a id=\"__codelineno-23-14\" name=\"__codelineno-23-14\" href=\"#__codelineno-23-14\"></a><span class=\"w\">  </span><span class=\"m\">16</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-15\"><a id=\"__codelineno-23-15\" name=\"__codelineno-23-15\" href=\"#__codelineno-23-15\"></a><span class=\"w\">  </span>1a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-23-16\"><a id=\"__codelineno-23-16\" name=\"__codelineno-23-16\" href=\"#__codelineno-23-16\"></a><span class=\"w\">  </span>1b:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-23-17\"><a id=\"__codelineno-23-17\" name=\"__codelineno-23-17\" href=\"#__codelineno-23-17\"></a>\n</span><span id=\"__span-23-18\"><a id=\"__codelineno-23-18\" name=\"__codelineno-23-18\" href=\"#__codelineno-23-18\"></a><span class=\"m\">0000000000000020</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-23-19\"><a id=\"__codelineno-23-19\" name=\"__codelineno-23-19\" href=\"#__codelineno-23-19\"></a><span class=\"w\">  </span><span class=\"m\">20</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-20\"><a id=\"__codelineno-23-20\" name=\"__codelineno-23-20\" href=\"#__codelineno-23-20\"></a><span class=\"w\">  </span><span class=\"m\">24</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 2c &lt;read_tls_data2+0xc&gt;</span>\n</span><span id=\"__span-23-21\"><a id=\"__codelineno-23-21\" name=\"__codelineno-23-21\" href=\"#__codelineno-23-21\"></a><span class=\"w\">  </span>2b:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-22\"><a id=\"__codelineno-23-22\" name=\"__codelineno-23-22\" href=\"#__codelineno-23-22\"></a><span class=\"w\">                        </span><span class=\"m\">28</span>:<span class=\"w\"> </span>R_X86_64_TLSGD<span class=\"w\">      </span>tls_data2-0x4\n</span><span id=\"__span-23-23\"><a id=\"__codelineno-23-23\" name=\"__codelineno-23-23\" href=\"#__codelineno-23-23\"></a><span class=\"w\">  </span>2c:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">34</span><span class=\"w\"> </span>&lt;read_tls_data2+0x14&gt;\n</span><span id=\"__span-23-24\"><a id=\"__codelineno-23-24\" name=\"__codelineno-23-24\" href=\"#__codelineno-23-24\"></a><span class=\"w\">  </span><span class=\"m\">33</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-25\"><a id=\"__codelineno-23-25\" name=\"__codelineno-23-25\" href=\"#__codelineno-23-25\"></a><span class=\"w\">                        </span><span class=\"m\">30</span>:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">      </span>__tls_get_addr-0x4\n</span><span id=\"__span-23-26\"><a id=\"__codelineno-23-26\" name=\"__codelineno-23-26\" href=\"#__codelineno-23-26\"></a><span class=\"w\">  </span><span class=\"m\">34</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-23-27\"><a id=\"__codelineno-23-27\" name=\"__codelineno-23-27\" href=\"#__codelineno-23-27\"></a><span class=\"w\">  </span><span class=\"m\">36</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-28\"><a id=\"__codelineno-23-28\" name=\"__codelineno-23-28\" href=\"#__codelineno-23-28\"></a><span class=\"w\">  </span>3a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n<p>\u57fa\u672c\u7b26\u5408\u9884\u671f\uff0c\u901a\u8fc7 <code>R_X86_64_TLSGD</code> relocation \u6765\u8868\u793a\u610f\u56fe\uff0c\u901a\u8fc7\u53cd\u6c47\u7f16\u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u591a\u4f59\u7684\u90a3\u4e9b\u4fee\u9970\u7b26\u662f\u6ca1\u6709\u7528\u7684\uff0c\u8bed\u4e49\u4e0a\u5c31\u662f\u4e00\u6761 <code>leaq</code> \u52a0\u4e00\u6761 <code>call</code> \u6307\u4ee4\u3002\u548c\u4e4b\u524d local dynamic TLS model \u7c7b\u4f3c\uff0c<code>__tls_get_addr</code> \u4e5f\u662f\u7528\u5df2\u6709\u7684 PLT \u673a\u5236\u6765\u5bfb\u5740\u3002</p>\n<p>\u6700\u540e\u6765\u770b\u751f\u6210\u7684\u52a8\u6001\u5e93\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-24-1\"><a id=\"__codelineno-24-1\" name=\"__codelineno-24-1\" href=\"#__codelineno-24-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-shared<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-24-2\"><a id=\"__codelineno-24-2\" name=\"__codelineno-24-2\" href=\"#__codelineno-24-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-R<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-24-3\"><a id=\"__codelineno-24-3\" name=\"__codelineno-24-3\" href=\"#__codelineno-24-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-24-4\"><a id=\"__codelineno-24-4\" name=\"__codelineno-24-4\" href=\"#__codelineno-24-4\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-24-5\"><a id=\"__codelineno-24-5\" name=\"__codelineno-24-5\" href=\"#__codelineno-24-5\"></a>\n</span><span id=\"__span-24-6\"><a id=\"__codelineno-24-6\" name=\"__codelineno-24-6\" href=\"#__codelineno-24-6\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-24-7\"><a id=\"__codelineno-24-7\" name=\"__codelineno-24-7\" href=\"#__codelineno-24-7\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-8\"><a id=\"__codelineno-24-8\" name=\"__codelineno-24-8\" href=\"#__codelineno-24-8\"></a><span class=\"w\">    </span><span class=\"m\">1114</span>:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span>b4<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x2eb4<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fd0 &lt;tls_data1@@Base+0x3fcc&gt;</span>\n</span><span id=\"__span-24-9\"><a id=\"__codelineno-24-9\" name=\"__codelineno-24-9\" href=\"#__codelineno-24-9\"></a><span class=\"w\">    </span>111b:<span class=\"w\">       </span><span class=\"m\">00</span>\n</span><span id=\"__span-24-10\"><a id=\"__codelineno-24-10\" name=\"__codelineno-24-10\" href=\"#__codelineno-24-10\"></a><span class=\"w\">    </span>111c:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span>0c<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-24-11\"><a id=\"__codelineno-24-11\" name=\"__codelineno-24-11\" href=\"#__codelineno-24-11\"></a><span class=\"w\">    </span><span class=\"m\">1123</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-24-12\"><a id=\"__codelineno-24-12\" name=\"__codelineno-24-12\" href=\"#__codelineno-24-12\"></a><span class=\"w\">    </span><span class=\"m\">1124</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-24-13\"><a id=\"__codelineno-24-13\" name=\"__codelineno-24-13\" href=\"#__codelineno-24-13\"></a><span class=\"w\">    </span><span class=\"m\">1126</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-14\"><a id=\"__codelineno-24-14\" name=\"__codelineno-24-14\" href=\"#__codelineno-24-14\"></a><span class=\"w\">    </span>112a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-24-15\"><a id=\"__codelineno-24-15\" name=\"__codelineno-24-15\" href=\"#__codelineno-24-15\"></a><span class=\"w\">    </span>112b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-24-16\"><a id=\"__codelineno-24-16\" name=\"__codelineno-24-16\" href=\"#__codelineno-24-16\"></a>\n</span><span id=\"__span-24-17\"><a id=\"__codelineno-24-17\" name=\"__codelineno-24-17\" href=\"#__codelineno-24-17\"></a><span class=\"m\">0000000000001130</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-24-18\"><a id=\"__codelineno-24-18\" name=\"__codelineno-24-18\" href=\"#__codelineno-24-18\"></a><span class=\"w\">    </span><span class=\"m\">1130</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-19\"><a id=\"__codelineno-24-19\" name=\"__codelineno-24-19\" href=\"#__codelineno-24-19\"></a><span class=\"w\">    </span><span class=\"m\">1134</span>:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">74</span><span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x2e74<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fb0 &lt;tls_data2@@Base+0x3fb0&gt;</span>\n</span><span id=\"__span-24-20\"><a id=\"__codelineno-24-20\" name=\"__codelineno-24-20\" href=\"#__codelineno-24-20\"></a><span class=\"w\">    </span>113b:<span class=\"w\">       </span><span class=\"m\">00</span>\n</span><span id=\"__span-24-21\"><a id=\"__codelineno-24-21\" name=\"__codelineno-24-21\" href=\"#__codelineno-24-21\"></a><span class=\"w\">    </span>113c:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span>ec<span class=\"w\"> </span>fe<span class=\"w\"> </span>ff<span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-24-22\"><a id=\"__codelineno-24-22\" name=\"__codelineno-24-22\" href=\"#__codelineno-24-22\"></a><span class=\"w\">    </span><span class=\"m\">1143</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-24-23\"><a id=\"__codelineno-24-23\" name=\"__codelineno-24-23\" href=\"#__codelineno-24-23\"></a><span class=\"w\">    </span><span class=\"m\">1144</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-24-24\"><a id=\"__codelineno-24-24\" name=\"__codelineno-24-24\" href=\"#__codelineno-24-24\"></a><span class=\"w\">    </span><span class=\"m\">1146</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-25\"><a id=\"__codelineno-24-25\" name=\"__codelineno-24-25\" href=\"#__codelineno-24-25\"></a><span class=\"w\">    </span>114a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-24-26\"><a id=\"__codelineno-24-26\" name=\"__codelineno-24-26\" href=\"#__codelineno-24-26\"></a>\n</span><span id=\"__span-24-27\"><a id=\"__codelineno-24-27\" name=\"__codelineno-24-27\" href=\"#__codelineno-24-27\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.got:\n</span><span id=\"__span-24-28\"><a id=\"__codelineno-24-28\" name=\"__codelineno-24-28\" href=\"#__codelineno-24-28\"></a>\n</span><span id=\"__span-24-29\"><a id=\"__codelineno-24-29\" name=\"__codelineno-24-29\" href=\"#__codelineno-24-29\"></a>0000000000003fa8<span class=\"w\"> </span>&lt;.got&gt;:\n</span><span id=\"__span-24-30\"><a id=\"__codelineno-24-30\" name=\"__codelineno-24-30\" href=\"#__codelineno-24-30\"></a><span class=\"w\">        </span>...\n</span><span id=\"__span-24-31\"><a id=\"__codelineno-24-31\" name=\"__codelineno-24-31\" href=\"#__codelineno-24-31\"></a><span class=\"w\">                        </span>3fb0:<span class=\"w\"> </span>R_X86_64_DTPMOD64<span class=\"w\"> </span>tls_data2@@Base\n</span><span id=\"__span-24-32\"><a id=\"__codelineno-24-32\" name=\"__codelineno-24-32\" href=\"#__codelineno-24-32\"></a><span class=\"w\">                        </span>3fb8:<span class=\"w\"> </span>R_X86_64_DTPOFF64<span class=\"w\"> </span>tls_data2@@Base\n</span><span id=\"__span-24-33\"><a id=\"__codelineno-24-33\" name=\"__codelineno-24-33\" href=\"#__codelineno-24-33\"></a><span class=\"w\">                        </span>3fd0:<span class=\"w\"> </span>R_X86_64_DTPMOD64<span class=\"w\"> </span>tls_data1@@Base\n</span><span id=\"__span-24-34\"><a id=\"__codelineno-24-34\" name=\"__codelineno-24-34\" href=\"#__codelineno-24-34\"></a><span class=\"w\">                        </span>3fd8:<span class=\"w\"> </span>R_X86_64_DTPOFF64<span class=\"w\"> </span>tls_data1@@Base\n</span></code></pre></div>\n<p>\u89c2\u5bdf <code>.got</code>\uff0c\u53ef\u4ee5\u770b\u5230\u5bf9\u4e8e\u6bcf\u4e2a TLS \u53d8\u91cf\uff0c\u90fd\u751f\u6210\u4e86\u4e24\u4e2a entry\uff1a<code>tls_data2</code> \u5360\u7528\u4e86 <code>0x3fb0</code> \u548c <code>0x3fb8</code> \u4e24\u4e2a entry\uff0c\u7b2c\u4e00\u4e2a\u5bf9\u5e94\u52a8\u6001\u5e93\u7684\u4e0b\u6807\uff08MOD \u8868\u793a Module\uff09\uff0c\u7b2c\u4e8c\u4e2a\u5bf9\u5e94\u504f\u79fb\uff08OFF \u8868\u793a Offset\uff09\uff1b<code>tls_data1</code> \u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u5360\u7528\u4e86 <code>0x3fd0</code> \u548c <code>0x3fd8</code>\u3002\u5f53\u52a8\u6001\u94fe\u63a5\u5668\u5728 <code>.got</code> \u8868\u4e2d\u51c6\u5907\u597d <code>tls_index</code> \u7ed3\u6784\u4f53\u540e\uff0c\u5728\u8bbf\u95ee TLS \u53d8\u91cf\u65f6\uff0c\u53ea\u9700\u8981 <code>lea</code> + <code>call</code> \u5c31\u53ef\u4ee5\u627e\u5230 TLS \u53d8\u91cf\u7684\u5730\u5740\u4e86\u3002</p>\n<h2 id=\"\u56db\u79cd-tls-model-\u7684\u5bf9\u6bd4\">\u56db\u79cd TLS model \u7684\u5bf9\u6bd4<a class=\"headerlink\" href=\"#\u56db\u79cd-tls-model-\u7684\u5bf9\u6bd4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u8fdb\u884c\u56db\u79cd TLS model \u7684\u5bf9\u6bd4\uff1a</p>\n<ol>\n<li>local exec TLS model: \u7528\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u8bbf\u95ee\u81ea\u8eab\u7684 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u7a7a\u95f4\u603b\u662f\u7d27\u6328\u7740 <code>%fs</code>\uff0c\u6240\u4ee5\u81ea\u8eab\u7684 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5728\u94fe\u63a5\u65f6\u5df2\u77e5\uff0c\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u51fa\u6765\uff0c\u8fd0\u884c\u65f6\u5f00\u9500\u6700\u5c0f</li>\n<li>initial exec TLS model: \u7528\u4e8e\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u7531\u52a8\u6001\u94fe\u63a5\u5668\u81ea\u52a8\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u8bbf\u95ee\u81ea\u8eab\u7684 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u5b83\u7684 TLS \u7a7a\u95f4\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5728\u52a0\u8f7d\u540e\u5c31\u662f\u56fa\u5b9a\u7684\uff0c\u6240\u4ee5\u7531\u52a8\u6001\u94fe\u63a5\u5668\u8ba1\u7b97\u51fa\u5404\u4e2a TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u5199\u5230 <code>.got</code> \u8868\u4e2d\uff0c\u8fd0\u884c\u65f6\u53ea\u9700\u8981\u8bfb\u53d6 <code>.got</code> \u8868\u4e2d\u8bb0\u5f55\u7684 offset\uff0c\u548c <code>%fs</code> \u505a\u52a0\u6cd5\u5c31\u5f97\u5230\u4e86\u53d8\u91cf\u7684\u5730\u5740</li>\n<li>local dynamic TLS model: \u7528\u4e8e\u53ef\u80fd\u88ab dlopen \u7684\u52a8\u6001\u5e93\u8bbf\u95ee\u81ea\u8eab\u7684 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u5b83\u7684 TLS \u7a7a\u95f4\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u6240\u4ee5\u9700\u8981\u7528 <code>__tls_get_addr</code> \u8c03\u7528\u6765\u83b7\u53d6\u81ea\u8eab\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff1b\u4e3a\u4e86\u7ed9 <code>__tls_get_addr</code> \u4f20\u9012\u6b63\u786e\u7684\u53c2\u6570\uff0c\u544a\u8bc9\u8fd9\u4e2a\u51fd\u6570\u81ea\u5df1\u7684\u52a8\u6001\u5e93\u7f16\u53f7\u662f\u591a\u5c11\uff0c\u5728 <code>.got</code> \u8868\u4e2d\u9884\u7559\u4e86\u4e00\u4e2a entry \u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u628a\u8be5\u52a8\u6001\u5e93\u7684\u7f16\u53f7\u5199\u8fdb\u53bb\uff1b\u90a3\u4e48\u8fd0\u884c\u65f6\u53ea\u9700\u8981\u8bfb\u53d6 <code>.got</code> \u8868\u4e2d\u8bb0\u5f55\u7684\u52a8\u6001\u5e93\u7f16\u53f7\uff0c\u8c03\u7528 <code>__tls_get_addr</code>\uff0c\u518d\u548c\u94fe\u63a5\u65f6\u5df2\u77e5\u7684 offset \u505a\u52a0\u6cd5\u5c31\u5f97\u5230\u4e86\u53d8\u91cf\u7684\u5730\u5740</li>\n<li>global dynamic TLS model: \u7528\u4e8e\u901a\u7528\u60c5\u51b5\u4e0b\uff0c\u4e0d\u77e5\u9053 TLS \u53d8\u91cf\u5c5e\u4e8e\u54ea\u4e2a\u52a8\u6001\u5e93\uff0c\u4e5f\u4e0d\u77e5\u9053 TLS \u53d8\u91cf\u5728 TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\u662f\u591a\u5c11\uff0c\u6240\u4ee5\u9700\u8981\u52a8\u6001\u94fe\u63a5\u5668\u53bb\u67e5\u8be2 TLS \u53d8\u91cf\u5c5e\u4e8e\u54ea\u4e2a\u52a8\u6001\u5e93\uff0c\u653e\u5728\u54ea\u4e2a\u504f\u79fb\u4e0a\uff0c\u5e76\u4e14\u52a8\u6001\u94fe\u63a5\u5668\u8981\u628a\u8fd9\u4e24\u4e2a\u4fe1\u606f\u5199\u5230 <code>.got</code> \u8868\u4e2d\uff1b\u90a3\u4e48\u8fd0\u884c\u65f6\u5c31\u8981\u7528 <code>__tls_get_addr</code> \u8c03\u7528\u6765\u6839\u636e <code>.got</code> \u8868\u4e2d\u8bb0\u5f55\u7684\u52a8\u6001\u5e93\u7f16\u53f7\u4ee5\u53ca\u504f\u79fb\u6765\u627e\u5230\u53d8\u91cf\u7684\u5730\u5740</li>\n</ol>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u5bf9\u6bd4\u8868\u683c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Instructions</th>\n<th>GOT</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>local exec</td>\n<td>movq</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>initial exec</td>\n<td>movq + addq</td>\n<td>offset</td>\n</tr>\n<tr>\n<td>local dynamic</td>\n<td>leaq + call + leaq</td>\n<td>self module index</td>\n</tr>\n<tr>\n<td>global dynamic</td>\n<td>leaq + call</td>\n<td>module index + offset</td>\n</tr>\n</tbody>\n</table>\n<p>\u7279\u522b\u5730\uff0clocal dynamic TLS model \u7684 <code>leaq + call</code> \u662f\u53ef\u4ee5\u590d\u7528\u7684\uff0c\u6240\u4ee5\u6574\u4f53\u6765\u8bf4\uff0c\u8fd8\u662f\u8d8a\u901a\u7528\u7684 TLS model\uff0c\u8fd0\u884c\u65f6\u7684\u5f00\u9500\u8d8a\u5927\u3002</p>\n<h2 id=\"\u5b9e\u9645\u7f16\u7a0b\u4e2d\u7684-tls-model\">\u5b9e\u9645\u7f16\u7a0b\u4e2d\u7684 TLS model<a class=\"headerlink\" href=\"#\u5b9e\u9645\u7f16\u7a0b\u4e2d\u7684-tls-model\" title=\"Permanent link\">&para;</a></h2>\n<p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u53ef\u80fd\u4f1a\u7591\u60d1\uff1a\u5728\u7f16\u7a0b\u7684\u65f6\u5019\uff0c\u5927\u591a\u6570\u65f6\u5019\u5e76\u6ca1\u6709\u53bb\u7ba1 TLS model \u7684\u4e8b\u60c5\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728\u7f16\u8bd1\u7684\u65f6\u5019\u5e76\u6ca1\u6709\u6307\u5b9a\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u4f1a\u91c7\u7528\u4ec0\u4e48 TLS model \u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\u53d6\u51b3\u4e8e\u7f16\u8bd1\u5668\u548c\u94fe\u63a5\u5668\u4f1a\u6839\u636e\u6240\u80fd\u4e86\u89e3\u5230\u7684\u60c5\u51b5\uff0c\u9009\u62e9\u4e00\u4e2a\u6700\u4f18\u7684\u5b9e\u73b0\u65b9\u6cd5\u3002\u5728\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u90fd\u662f\u76f4\u63a5\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5168\u5c40\u7684 <code>__thread</code> \u53d8\u91cf\u7136\u540e\u53bb\u8bbf\u95ee\u5b83\uff0c\u4f46\u5982\u679c\u5b83\u662f <code>static</code> \u7684\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u5462\uff1f\u5982\u679c\u7f16\u8bd1\u7684\u65f6\u5019\uff0c\u6ca1\u6709\u5f00 <code>-fPIC</code>\uff0c\u4e5f\u5c31\u662f\u8bf4\u751f\u6210\u7684\u4ee3\u7801\u4e0d\u4f1a\u51fa\u73b0\u5728\u52a8\u6001\u5e93\u4e2d\uff0c\u53c8\u4f1a\u53d1\u751f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u9996\u5148\u6765\u770b\u4ece\u7f16\u8bd1\u5668\u5230\u6c47\u7f16\u7684\u8fd9\u4e00\u4e2a\u9636\u6bb5\uff0c\u4f1a\u91c7\u7528\u4ec0\u4e48\u6837\u7684 TLS model\uff1a</p>\n<ol>\n<li>\u5982\u679c\u5728\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6ca1\u6709\u5f00 <code>-fPIC</code>\uff0c\u90a3\u4e48\u751f\u6210\u7684\u4ee3\u7801\u53ea\u51fa\u73b0\u5728\u53ef\u6267\u884c\u7a0b\u5e8f\u4e2d\uff0c\u8fd9\u4e2a\u65f6\u5019\u7f16\u8bd1\u5668\u4f1a\u76f4\u63a5\u4f7f\u7528 local exec TLS model\uff0c\u5373\u751f\u6210 <code>movl %fs:symbol@tpoff, %rax</code> \u7684\u6307\u4ee4</li>\n<li>\u5982\u679c\u5728\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u5f00\u4e86 <code>-fPIC</code>\uff0c\u90a3\u4e48\u751f\u6210\u7684\u4ee3\u7801\u65e2\u53ef\u80fd\u51fa\u73b0\u5728\u53ef\u6267\u884c\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u53ef\u80fd\u51fa\u73b0\u5728\u52a8\u6001\u5e93\u4e2d\uff0c\u8fd9\u65f6\u4f1a\u9996\u5148\u9ed8\u8ba4\u4e3a global dynamic TLS model\uff0c\u5373\u751f\u6210 <code>data16 leaq symbol@tlsgd(%rip), %rdi; .value 0x6666; rex64; call __tls_get_addr@PLT; movl (%rax), %eax</code> \u6307\u4ee4</li>\n<li>\u4f46\u5982\u679c <code>__thread</code> \u53d8\u91cf\u8bbe\u7f6e\u4e86 <code>static</code>\uff0c\u5373\u4f7f\u6253\u5f00\u4e86 <code>-fPIC</code>\uff0c\u4e5f\u4fdd\u8bc1\u4e86\u8fd9\u4e2a TLS \u53d8\u91cf\u4e00\u5b9a\u662f\u8bbf\u95ee\u81ea\u5df1 TLS \u7a7a\u95f4\u4e2d\u7684\uff0c\u4e0d\u4f1a\u8bbf\u95ee\u522b\u4eba\u7684\uff0c\u90a3\u4e48\u7f16\u8bd1\u5668\u4f1a\u81ea\u52a8\u9009\u62e9 local dynamic TLS model\uff0c\u5373\u751f\u6210 <code>leaq symbol@tlsld(%rip), %rdi; call__tls_get_addr@PLT; movl %symbol@dtpoff(%rax), %eax</code> \u6307\u4ee4</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u4e8b\u60c5\uff1a</p>\n<ol>\n<li>\n<p>\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6253\u5f00\u4e86 <code>-fPIC</code> \u4e14\u6ca1\u6709\u7528 <code>static</code>\uff0c\u5982\u524d\u6240\u8ff0\uff0c\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 global dynamic TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u90a3\u4e48\u94fe\u63a5\u5668\u77e5\u9053\u8fd9\u4e2a\u65f6\u5019\u7528 local exec TLS model \u662f\u6027\u80fd\u66f4\u597d\u7684\uff0c\u90a3\u4e48\u5b83\u4f1a\u5bf9\u6307\u4ee4\u8fdb\u884c\u6539\u5199\uff0c\u6b64\u65f6\u4e4b\u524d\u9884\u7559\u7684\u65e0\u7528\u7684\u6307\u4ee4\u524d\u7f00 <code>data 16; .value 0x6666; rex64</code> \u8d77\u4e86\u4f5c\u7528\uff0c\u4fdd\u8bc1\u6539\u5199\u524d\u540e\u7684\u6307\u4ee4\u5e8f\u5217\u7684\u957f\u5ea6\u4e0d\u53d8\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-25-1\"><a id=\"__codelineno-25-1\" name=\"__codelineno-25-1\" href=\"#__codelineno-25-1\"></a><span class=\"c1\"># before linker optimizations: global dynamic</span>\n</span><span id=\"__span-25-2\"><a id=\"__codelineno-25-2\" name=\"__codelineno-25-2\" href=\"#__codelineno-25-2\"></a><span class=\"na\">data16</span><span class=\"w\"> </span><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tlsgd</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-25-3\"><a id=\"__codelineno-25-3\" name=\"__codelineno-25-3\" href=\"#__codelineno-25-3\"></a><span class=\"na\">.value</span><span class=\"w\"> </span><span class=\"mi\">0x6666</span>\n</span><span id=\"__span-25-4\"><a id=\"__codelineno-25-4\" name=\"__codelineno-25-4\" href=\"#__codelineno-25-4\"></a><span class=\"nf\">rex64</span>\n</span><span id=\"__span-25-5\"><a id=\"__codelineno-25-5\" name=\"__codelineno-25-5\" href=\"#__codelineno-25-5\"></a><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">__tls_get_addr@PLT</span>\n</span><span id=\"__span-25-6\"><a id=\"__codelineno-25-6\" name=\"__codelineno-25-6\" href=\"#__codelineno-25-6\"></a>\n</span><span id=\"__span-25-7\"><a id=\"__codelineno-25-7\" name=\"__codelineno-25-7\" href=\"#__codelineno-25-7\"></a><span class=\"c1\"># after linker optimizations: local exec</span>\n</span><span id=\"__span-25-8\"><a id=\"__codelineno-25-8\" name=\"__codelineno-25-8\" href=\"#__codelineno-25-8\"></a><span class=\"c1\"># the symbol@tpoff(%rax) relocation is resolved by the linker immediately</span>\n</span><span id=\"__span-25-9\"><a id=\"__codelineno-25-9\" name=\"__codelineno-25-9\" href=\"#__codelineno-25-9\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-25-10\"><a id=\"__codelineno-25-10\" name=\"__codelineno-25-10\" href=\"#__codelineno-25-10\"></a><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u7c7b\u4f3c\u5730\uff0c\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6253\u5f00\u4e86 <code>-fPIC</code> \u4e14\u7528\u4e86 <code>static</code>\uff0c\u5982\u524d\u6240\u8ff0\uff0c\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 local dynamic TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u90a3\u4e48\u94fe\u63a5\u5668\u77e5\u9053\u8fd9\u4e2a\u65f6\u5019\u7528 local exec TLS model \u662f\u6027\u80fd\u66f4\u597d\u7684\uff0c\u90a3\u4e48\u5b83\u4f1a\u5bf9\u6307\u4ee4\u8fdb\u884c\u6539\u5199\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6539\u5199\u524d\u540e\u7684\u6307\u4ee4\u5e8f\u5217\u7684\u957f\u5ea6\u4e0d\u53d8\uff0c\u8fd9\u6b21\u662f\u5728\u751f\u6210\u7684\u6c47\u7f16\u91cc\u52a0\u5165\u65e0\u7528\u7684\u6307\u4ee4\u524d\u7f00\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-26-1\"><a id=\"__codelineno-26-1\" name=\"__codelineno-26-1\" href=\"#__codelineno-26-1\"></a><span class=\"c1\"># before linker optimizations: local dynamic</span>\n</span><span id=\"__span-26-2\"><a id=\"__codelineno-26-2\" name=\"__codelineno-26-2\" href=\"#__codelineno-26-2\"></a><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tlsld</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-26-3\"><a id=\"__codelineno-26-3\" name=\"__codelineno-26-3\" href=\"#__codelineno-26-3\"></a><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">__tls_get_addr@PLT</span>\n</span><span id=\"__span-26-4\"><a id=\"__codelineno-26-4\" name=\"__codelineno-26-4\" href=\"#__codelineno-26-4\"></a><span class=\"nf\">movl</span><span class=\"w\"> </span><span class=\"no\">symbol@dtpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%eax</span>\n</span><span id=\"__span-26-5\"><a id=\"__codelineno-26-5\" name=\"__codelineno-26-5\" href=\"#__codelineno-26-5\"></a>\n</span><span id=\"__span-26-6\"><a id=\"__codelineno-26-6\" name=\"__codelineno-26-6\" href=\"#__codelineno-26-6\"></a><span class=\"c1\"># after linker optimizations: local exec</span>\n</span><span id=\"__span-26-7\"><a id=\"__codelineno-26-7\" name=\"__codelineno-26-7\" href=\"#__codelineno-26-7\"></a><span class=\"c1\"># the symbol@tpoff(%rax) relocation is resolved by the linker immediately</span>\n</span><span id=\"__span-26-8\"><a id=\"__codelineno-26-8\" name=\"__codelineno-26-8\" href=\"#__codelineno-26-8\"></a><span class=\"na\">.word</span><span class=\"w\"> </span><span class=\"mi\">0x6666</span>\n</span><span id=\"__span-26-9\"><a id=\"__codelineno-26-9\" name=\"__codelineno-26-9\" href=\"#__codelineno-26-9\"></a><span class=\"na\">.byte</span><span class=\"w\"> </span><span class=\"mi\">0x66</span>\n</span><span id=\"__span-26-10\"><a id=\"__codelineno-26-10\" name=\"__codelineno-26-10\" href=\"#__codelineno-26-10\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-26-11\"><a id=\"__codelineno-26-11\" name=\"__codelineno-26-11\" href=\"#__codelineno-26-11\"></a><span class=\"nf\">movl</span><span class=\"w\"> </span><span class=\"no\">symbol@tpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%eax</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6253\u5f00\u4e86 <code>-fPIC</code> \u4e14\u7528\u4e86 <code>extern</code> \u6765\u6807\u8bb0 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u7f16\u8bd1\u5668\u4e0d\u77e5\u9053\u8fd9\u4e2a TLS \u53d8\u91cf\u5c5e\u4e8e\u8c01\uff0c\u6240\u4ee5\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 global dynamic TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u5e76\u4e14\u7f16\u8bd1\u5668\u53d1\u73b0\u8fd9\u4e2a TLS \u53d8\u91cf\u5c5e\u4e8e\u4e00\u4e2a\u52a8\u6001\u5e93\uff0c\u8fd9\u610f\u5473\u7740\u8fd9\u4e2a TLS \u53d8\u91cf\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u4f1a\u968f\u7740\u52a8\u6001\u5e93\u52a0\u8f7d\u800c\u53d8\u5f97\u53ef\u7528\uff0c\u9002\u7528 initial exec TLS model\uff0c\u4e8e\u662f\u94fe\u63a5\u5668\u4e5f\u4f1a\u8fdb\u884c\u6539\u5199\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-27-1\"><a id=\"__codelineno-27-1\" name=\"__codelineno-27-1\" href=\"#__codelineno-27-1\"></a><span class=\"c1\"># before linker optimizations: global dynamic</span>\n</span><span id=\"__span-27-2\"><a id=\"__codelineno-27-2\" name=\"__codelineno-27-2\" href=\"#__codelineno-27-2\"></a><span class=\"na\">data16</span><span class=\"w\"> </span><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tlsgd</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-27-3\"><a id=\"__codelineno-27-3\" name=\"__codelineno-27-3\" href=\"#__codelineno-27-3\"></a><span class=\"na\">.value</span><span class=\"w\"> </span><span class=\"mi\">0x6666</span>\n</span><span id=\"__span-27-4\"><a id=\"__codelineno-27-4\" name=\"__codelineno-27-4\" href=\"#__codelineno-27-4\"></a><span class=\"nf\">rex64</span>\n</span><span id=\"__span-27-5\"><a id=\"__codelineno-27-5\" name=\"__codelineno-27-5\" href=\"#__codelineno-27-5\"></a><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">__tls_get_addr@PLT</span>\n</span><span id=\"__span-27-6\"><a id=\"__codelineno-27-6\" name=\"__codelineno-27-6\" href=\"#__codelineno-27-6\"></a>\n</span><span id=\"__span-27-7\"><a id=\"__codelineno-27-7\" name=\"__codelineno-27-7\" href=\"#__codelineno-27-7\"></a><span class=\"c1\"># after linker optimizations: initial exec</span>\n</span><span id=\"__span-27-8\"><a id=\"__codelineno-27-8\" name=\"__codelineno-27-8\" href=\"#__codelineno-27-8\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-27-9\"><a id=\"__codelineno-27-9\" name=\"__codelineno-27-9\" href=\"#__codelineno-27-9\"></a><span class=\"nf\">addq</span><span class=\"w\"> </span><span class=\"no\">symbol@gottpoff</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6ca1\u6709\u6253\u5f00 <code>-fPIC</code> \u4e14\u7528\u4e86 <code>extern</code> \u6765\u6807\u8bb0 TLS \u53d8\u91cf\uff0c\u90a3\u4e48\u7f16\u8bd1\u5668\u77e5\u9053\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u53ea\u80fd\u51fa\u73b0\u5728\u53ef\u6267\u884c\u7a0b\u5e8f\u4e2d\uff0c\u90a3\u4e48\u8fd9\u4e2a TLS \u53d8\u91cf\u8981\u4e48\u6765\u81ea\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\uff0c\u8981\u4e48\u6765\u81ea\u4e8e\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u6240\u4ee5\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 initial exec TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u5e76\u4e14\u7f16\u8bd1\u5668\u53d1\u73b0\u8fd9\u4e2a TLS \u53d8\u91cf\u5c5e\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\uff0c\u9002\u7528 local exec TLS model\uff0c\u4e8e\u662f\u94fe\u63a5\u5668\u4e5f\u4f1a\u8fdb\u884c\u6539\u5199\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-28-1\"><a id=\"__codelineno-28-1\" name=\"__codelineno-28-1\" href=\"#__codelineno-28-1\"></a><span class=\"c1\"># before linker optimizations: initial exec</span>\n</span><span id=\"__span-28-2\"><a id=\"__codelineno-28-2\" name=\"__codelineno-28-2\" href=\"#__codelineno-28-2\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-28-3\"><a id=\"__codelineno-28-3\" name=\"__codelineno-28-3\" href=\"#__codelineno-28-3\"></a><span class=\"nf\">addq</span><span class=\"w\"> </span><span class=\"no\">symbol@gottpoff</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-28-4\"><a id=\"__codelineno-28-4\" name=\"__codelineno-28-4\" href=\"#__codelineno-28-4\"></a>\n</span><span id=\"__span-28-5\"><a id=\"__codelineno-28-5\" name=\"__codelineno-28-5\" href=\"#__codelineno-28-5\"></a><span class=\"c1\"># after linker optimizations: local exec</span>\n</span><span id=\"__span-28-6\"><a id=\"__codelineno-28-6\" name=\"__codelineno-28-6\" href=\"#__codelineno-28-6\"></a><span class=\"c1\"># the symbol@tpoff(%rax) relocation is resolved by the linker immediately</span>\n</span><span id=\"__span-28-7\"><a id=\"__codelineno-28-7\" name=\"__codelineno-28-7\" href=\"#__codelineno-28-7\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-28-8\"><a id=\"__codelineno-28-8\" name=\"__codelineno-28-8\" href=\"#__codelineno-28-8\"></a><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span></code></pre></div>\n</li>\n</ol>\n<p>\u53ef\u89c1\u901a\u8fc7\u4e24\u9636\u6bb5\u7684\u5904\u7406\uff0c\u5728\u7f16\u8bd1\u5668\u548c\u94fe\u63a5\u5668\u7684\u534f\u540c\u4e0b\uff0c\u5c1d\u8bd5\u4f18\u5316\u5230\u4e00\u4e2a\u5f00\u9500\u66f4\u5c0f\u7684 TLS model\uff0c\u8f6c\u5316\u7684\u51e0\u79cd\u60c5\u51b5\u5982\u4e0b\uff1a</p>\n<ol>\n<li>global dynamic -&gt; initial exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u5f00\u4e86 -fPIC \u548c <code>extern</code>\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u52a8\u6001\u5e93</li>\n<li>global dynamic -&gt; local exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u5f00\u4e86 -fPIC\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u7a0b\u5e8f\u81ea\u5df1</li>\n<li>local dynamic -&gt; local exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u5f00\u4e86 -fPIC \u548c <code>-static</code>\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u7a0b\u5e8f\u81ea\u5df1</li>\n<li>initial exec -&gt; local exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u6ca1\u5f00 -fPIC\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u7a0b\u5e8f\u81ea\u5df1</li>\n</ol>\n<h2 id=\"tlsdesc\">TLSDESC<a class=\"headerlink\" href=\"#tlsdesc\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u63d0\u5230\uff0c\u5728 global dynamic \u548c local dynamic \u4e24\u79cd TLS model \u4e0b\uff0c\u8981\u8bbf\u95ee TLS \u53d8\u91cf\u7684\u65f6\u5019\uff0c\u9700\u8981\u8c03\u7528 <code>__tls_get_addr</code> \u51fd\u6570\uff0c\u8fd9\u662f\u6bd4\u8f83\u6162\u7684\u3002\u4e3a\u4e86\u4f18\u5316\u5b83\uff0c\u8ba9\u4eba\u60f3\u5230\u4e86 PLT \u673a\u5236\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u60c5\u51b5\u4e0b\uff0cPLT \u4f1a\u751f\u6210\u4e00\u4e2a stub\uff0c\u4ece <code>.got</code> \u8bfb\u53d6\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u5e76\u8df3\u8f6c\uff0c\u8fd9\u4e2a\u51fd\u6570\u6307\u9488\u521d\u59cb\u60c5\u51b5\u4e0b\u662f\u6267\u884c\u4e86 <code>stub</code> \u7684\u4e0b\u4e00\u6761\u6307\u4ee4</li>\n<li>\u5bf9\u4e8e\u7b2c\u4e00\u6b21\u6267\u884c\u8fd9\u4e2a stub\uff0c\u5b83\u4f1a\u628a\u8fd9\u4e2a\u51fd\u6570\u7684\u7f16\u53f7 push \u5230\u6808\u4e0a\uff0c\u7136\u540e\u8c03\u7528\u52a8\u6001\u94fe\u63a5\u5668\u63d0\u4f9b\u7684 <code>_dl_runtime_resolve</code> \u51fd\u6570\u6765\u5bfb\u627e\u8fd9\u4e2a\u51fd\u6570\u7684\u5b9e\u9645\u5730\u5740\uff1b\u6b64\u65f6 <code>_dl_runtime_resolve</code> \u4f1a\u628a\u627e\u5230\u7684\u51fd\u6570\u5730\u5740\u5199\u56de\u5230 <code>.got</code> \u7684\u51fd\u6570\u6307\u9488</li>\n<li>\u6b64\u540e\u518d\u6b21\u6267\u884c stub \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u4ece <code>.got</code> \u8bfb\u53d6\u8ba1\u7b97\u597d\u7684\u7684\u51fd\u6570\u6307\u9488\uff0c\u76f4\u63a5\u8df3\u8f6c\u5230\u5b9e\u9645\u7684\u51fd\u6570\u5730\u5740</li>\n</ol>\n<p>\u7531\u6b64\u53ef\u4ee5\u7c7b\u6bd4\u5f97\u5230\u4e00\u4e2a\u9488\u5bf9 TLS \u7684\u7c7b\u4f3c\u673a\u5236\uff0c\u79f0\u4e3a TLSDESC\uff1a</p>\n<ol>\n<li>TLSDESC \u5360\u7528 16 \u5b57\u8282\u7a7a\u95f4\uff0c\u524d\u9762 8 \u5b57\u8282\u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\uff0c\u540e\u9762 8 \u5b57\u8282\u7528\u6765\u4fdd\u5b58 offset\uff0c\u4fdd\u5b58\u5728 <code>.got</code> \u8868\u4e2d</li>\n<li>\u628a\u539f\u6765 local/global dynamic TLS model \u5bf9 <code>__tls_get_addr</code> \u7684\u8c03\u7528\uff0c\u6539\u6210\u8c03\u7528 TLSDESC \u4e2d\u7684\u51fd\u6570\u6307\u9488\uff0c\u8c03\u7528\u65f6 <code>%rax</code> \u5bc4\u5b58\u5668\u6307\u5411\u4e86 TLSDESC \u7684\u5730\u5740\uff0c\u5b83\u7684\u8fd4\u56de\u7ed3\u679c\u662f TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u540e\u7eed\u6307\u4ee4\u6839\u636e\u8fd9\u4e2a\u504f\u79fb\u8ba1\u7b97\u51fa\u5b9e\u9645\u7684\u5730\u5740</li>\n<li>\u52a8\u6001\u94fe\u63a5\u5668\u5728\u52a0\u8f7d\u7684\u65f6\u5019\uff0c\u5b83\u4f1a\u53bb\u5224\u65ad\u76ee\u6807 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u5426\u662f\u5e38\u91cf\uff1a\u5bf9\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u4ee5\u53ca\u968f\u7740\u7a0b\u5e8f\u542f\u52a8\u800c\u81ea\u52a8\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u5b83\u4eec\u7684 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u5e38\u91cf</li>\n<li>\n<p>\u5982\u679c\u76ee\u6807 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u5e38\u91cf\uff0c\u5219\u628a\u8fd9\u4e2a\u5e38\u91cf\u5199\u5165\u5230 <code>.got</code> \u8868\u4e2d TLSDESC \u53d8\u91cf\u7684 offset \u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u628a\u51fd\u6570\u6307\u9488\u6539\u5199\u6210 <code>_dl_tlsdesc_return</code>\uff0c\u5b83\u662f\u4e00\u4e2a\u5f88\u7b80\u5355\u7684\u5b9e\u73b0\uff0c\u56e0\u4e3a\u5728\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u65f6\uff0c<code>%rax</code> \u5bc4\u5b58\u5668\u6307\u5411\u4e86 TLSDESC \u7684\u5730\u5740\uff0c\u6240\u4ee5\u76f4\u63a5\u4ece <code>%rax+8</code> \u5730\u5740\u628a offset \u8bfb\u51fa\u6765\u7136\u540e\u8fd4\u56de\u5c31\u53ef\u4ee5\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-29-1\"><a id=\"__codelineno-29-1\" name=\"__codelineno-29-1\" href=\"#__codelineno-29-1\"></a><span class=\"nl\">_dl_tlsdesc_return:</span>\n</span><span id=\"__span-29-2\"><a id=\"__codelineno-29-2\" name=\"__codelineno-29-2\" href=\"#__codelineno-29-2\"></a><span class=\"w\">    </span><span class=\"nf\">movq</span><span class=\"w\">    </span><span class=\"mi\">8</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-29-3\"><a id=\"__codelineno-29-3\" name=\"__codelineno-29-3\" href=\"#__codelineno-29-3\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u5982\u679c\u76ee\u6807 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u4e0d\u662f\u5e38\u91cf\uff0c\u5219\u628a\u51fd\u6570\u6307\u9488\u6539\u5199\u6210 <code>_dl_tlsdesc_dynamic</code> \u51fd\u6570\uff0c\u518d\u8d70\u548c\u4e4b\u524d\u7684 <code>__tls_get_addr</code> \u7c7b\u4f3c\u7684\u903b\u8f91\uff0c\u5b8c\u6210\u5269\u4e0b\u7684\u67e5\u627e\uff1b\u7531\u4e8e\u8fd4\u56de\u503c\u662f TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u6240\u4ee5\u8fd4\u56de\u4e4b\u524d\u8fd8\u8981\u51cf\u53bb <code>%fs</code> \u7684\u5730\u5740\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-30-1\"><a id=\"__codelineno-30-1\" name=\"__codelineno-30-1\" href=\"#__codelineno-30-1\"></a><span class=\"cm\">/* %rax points to the TLS descriptor, such that 0(%rax) points to</span>\n</span><span id=\"__span-30-2\"><a id=\"__codelineno-30-2\" name=\"__codelineno-30-2\" href=\"#__codelineno-30-2\"></a><span class=\"cm\">    _dl_tlsdesc_dynamic itself, and 8(%rax) points to a struct</span>\n</span><span id=\"__span-30-3\"><a id=\"__codelineno-30-3\" name=\"__codelineno-30-3\" href=\"#__codelineno-30-3\"></a><span class=\"cm\">    tlsdesc_dynamic_arg object.  It must return in %rax the offset</span>\n</span><span id=\"__span-30-4\"><a id=\"__codelineno-30-4\" name=\"__codelineno-30-4\" href=\"#__codelineno-30-4\"></a><span class=\"cm\">    between the thread pointer and the object denoted by the</span>\n</span><span id=\"__span-30-5\"><a id=\"__codelineno-30-5\" name=\"__codelineno-30-5\" href=\"#__codelineno-30-5\"></a><span class=\"cm\">    argument, without clobbering any registers.</span>\n</span><span id=\"__span-30-6\"><a id=\"__codelineno-30-6\" name=\"__codelineno-30-6\" href=\"#__codelineno-30-6\"></a>\n</span><span id=\"__span-30-7\"><a id=\"__codelineno-30-7\" name=\"__codelineno-30-7\" href=\"#__codelineno-30-7\"></a><span class=\"cm\">    The assembly code that follows is a rendition of the following</span>\n</span><span id=\"__span-30-8\"><a id=\"__codelineno-30-8\" name=\"__codelineno-30-8\" href=\"#__codelineno-30-8\"></a><span class=\"cm\">    C code, hand-optimized a little bit.</span>\n</span><span id=\"__span-30-9\"><a id=\"__codelineno-30-9\" name=\"__codelineno-30-9\" href=\"#__codelineno-30-9\"></a>\n</span><span id=\"__span-30-10\"><a id=\"__codelineno-30-10\" name=\"__codelineno-30-10\" href=\"#__codelineno-30-10\"></a><span class=\"cm\">ptrdiff_t</span>\n</span><span id=\"__span-30-11\"><a id=\"__codelineno-30-11\" name=\"__codelineno-30-11\" href=\"#__codelineno-30-11\"></a><span class=\"cm\">_dl_tlsdesc_dynamic (register struct tlsdesc *tdp asm (&quot;%rax&quot;))</span>\n</span><span id=\"__span-30-12\"><a id=\"__codelineno-30-12\" name=\"__codelineno-30-12\" href=\"#__codelineno-30-12\"></a><span class=\"cm\">{</span>\n</span><span id=\"__span-30-13\"><a id=\"__codelineno-30-13\" name=\"__codelineno-30-13\" href=\"#__codelineno-30-13\"></a><span class=\"cm\">struct tlsdesc_dynamic_arg *td = tdp-&gt;arg;</span>\n</span><span id=\"__span-30-14\"><a id=\"__codelineno-30-14\" name=\"__codelineno-30-14\" href=\"#__codelineno-30-14\"></a><span class=\"cm\">dtv_t *dtv = *(dtv_t **)((char *)__thread_pointer + DTV_OFFSET);</span>\n</span><span id=\"__span-30-15\"><a id=\"__codelineno-30-15\" name=\"__codelineno-30-15\" href=\"#__codelineno-30-15\"></a><span class=\"cm\">if (__builtin_expect (td-&gt;gen_count &lt;= dtv[0].counter</span>\n</span><span id=\"__span-30-16\"><a id=\"__codelineno-30-16\" name=\"__codelineno-30-16\" href=\"#__codelineno-30-16\"></a><span class=\"cm\">            &amp;&amp; (dtv[td-&gt;tlsinfo.ti_module].pointer.val</span>\n</span><span id=\"__span-30-17\"><a id=\"__codelineno-30-17\" name=\"__codelineno-30-17\" href=\"#__codelineno-30-17\"></a><span class=\"cm\">                != TLS_DTV_UNALLOCATED),</span>\n</span><span id=\"__span-30-18\"><a id=\"__codelineno-30-18\" name=\"__codelineno-30-18\" href=\"#__codelineno-30-18\"></a><span class=\"cm\">            1))</span>\n</span><span id=\"__span-30-19\"><a id=\"__codelineno-30-19\" name=\"__codelineno-30-19\" href=\"#__codelineno-30-19\"></a><span class=\"cm\">    return dtv[td-&gt;tlsinfo.ti_module].pointer.val + td-&gt;tlsinfo.ti_offset</span>\n</span><span id=\"__span-30-20\"><a id=\"__codelineno-30-20\" name=\"__codelineno-30-20\" href=\"#__codelineno-30-20\"></a><span class=\"cm\">    - __thread_pointer;</span>\n</span><span id=\"__span-30-21\"><a id=\"__codelineno-30-21\" name=\"__codelineno-30-21\" href=\"#__codelineno-30-21\"></a>\n</span><span id=\"__span-30-22\"><a id=\"__codelineno-30-22\" name=\"__codelineno-30-22\" href=\"#__codelineno-30-22\"></a><span class=\"cm\">return __tls_get_addr_internal (&amp;td-&gt;tlsinfo) - __thread_pointer;</span>\n</span><span id=\"__span-30-23\"><a id=\"__codelineno-30-23\" name=\"__codelineno-30-23\" href=\"#__codelineno-30-23\"></a><span class=\"cm\">}</span>\n</span><span id=\"__span-30-24\"><a id=\"__codelineno-30-24\" name=\"__codelineno-30-24\" href=\"#__codelineno-30-24\"></a><span class=\"cm\">*/</span>\n</span></code></pre></div>\n</li>\n</ol>\n<p>\u5b83\u5229\u7528\u7684\u4e5f\u662f\u5728\u5185\u5b58\u4e2d\u4fdd\u5b58\u51fd\u6570\u6307\u9488\uff0c\u901a\u8fc7\u8fd0\u884c\u65f6\u66ff\u6362\u51fd\u6570\u6307\u9488\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0 slow path \u5230 fast path \u7684\u52a8\u6001\u66ff\u6362\u3002</p>\n<h2 id=\"dtv-\u7ef4\u62a4\">dtv \u7ef4\u62a4<a class=\"headerlink\" href=\"#dtv-\u7ef4\u62a4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u518d\u6765\u6df1\u5165\u5206\u6790\u4e00\u4e0b dtv \u7684\u7ef4\u62a4\u65b9\u5f0f\u3002\u524d\u9762\u63d0\u5230\uff0cdtv \u7684\u6307\u9488\u662f\u4fdd\u5b58\u5728 <code>struct pthread</code> \u5185\u7684\uff0c\u800c <code>struct pthread</code> \u53c8\u662f\u4fdd\u5b58\u5728 <code>%fs</code> \u5bc4\u5b58\u5668\u6307\u5411\u7684\u4f4d\u7f6e\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-31-1\"><a id=\"__codelineno-31-1\" name=\"__codelineno-31-1\" href=\"#__codelineno-31-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pthread</span>\n</span><span id=\"__span-31-2\"><a id=\"__codelineno-31-2\" name=\"__codelineno-31-2\" href=\"#__codelineno-31-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-31-3\"><a id=\"__codelineno-31-3\" name=\"__codelineno-31-3\" href=\"#__codelineno-31-3\"></a><span class=\"w\">  </span><span class=\"n\">tcbhead_t</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-4\"><a id=\"__codelineno-31-4\" name=\"__codelineno-31-4\" href=\"#__codelineno-31-4\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-31-5\"><a id=\"__codelineno-31-5\" name=\"__codelineno-31-5\" href=\"#__codelineno-31-5\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-31-6\"><a id=\"__codelineno-31-6\" name=\"__codelineno-31-6\" href=\"#__codelineno-31-6\"></a>\n</span><span id=\"__span-31-7\"><a id=\"__codelineno-31-7\" name=\"__codelineno-31-7\" href=\"#__codelineno-31-7\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span>\n</span><span id=\"__span-31-8\"><a id=\"__codelineno-31-8\" name=\"__codelineno-31-8\" href=\"#__codelineno-31-8\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-31-9\"><a id=\"__codelineno-31-9\" name=\"__codelineno-31-9\" href=\"#__codelineno-31-9\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-31-10\"><a id=\"__codelineno-31-10\" name=\"__codelineno-31-10\" href=\"#__codelineno-31-10\"></a><span class=\"w\">  </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-11\"><a id=\"__codelineno-31-11\" name=\"__codelineno-31-11\" href=\"#__codelineno-31-11\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-31-12\"><a id=\"__codelineno-31-12\" name=\"__codelineno-31-12\" href=\"#__codelineno-31-12\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcbhead_t</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u6240\u4ee5\u8981\u8bbf\u95ee dtv \u4e5f\u5f88\u7b80\u5355\uff0c\u76f4\u63a5\u4ece <code>%fs</code> \u52a0\u5b83\u5728 <code>struct pthread</code> \u7ed3\u6784\u4f53\u5185\u7684\u504f\u79fb\u5373\u53ef\u3002</p>\n<p>\u524d\u9762\u63d0\u5230\uff0c\u5728\u8c03\u7528 <code>__tls_get_addr</code> \u65f6\uff0c\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u52a8\u6001\u5e93\u7684 ID \u6765\u67e5\u8be2\u5f97\u5230\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u518d\u52a0\u4e0a\u5728\u8fd9\u4e2a TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\u3002\u800c\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684 ID\uff0c\u6b63\u597d\u5c31\u662f dtv \u6570\u7ec4\u7684\u4e0b\u6807\uff0c\u6240\u4ee5 <code>__tls_get_addr</code> \u505a\u7684\u4e8b\u60c5\u5927\u6982\u662f\uff1a</p>\n<ol>\n<li>\u627e\u5230 <code>dtv</code> \u7684\u5730\u5740\uff1a<code>mov %fs:DTV_OFFSET, %RDX_LP</code></li>\n<li>\u4ece <code>__tls_get_addr</code> \u51fd\u6570\u7684\u53c2\u6570\u91cc\u8bfb\u53d6 <code>ti_module</code> \u5b57\u6bb5\uff1a<code>mov TI_MODULE_OFFSET(%rdi), %RAX_LP</code></li>\n<li>\n<p>\u8bfb\u53d6 <code>dtv[ti-&gt;ti_module].val</code>\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u6a21\u5757\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff1a<code>salq $4, %rax; movq (%rdx, %rax), %rax</code>\uff0c\u8fd9\u91cc\u5de6\u79fb 4 \u4f4d\u662f\u56e0\u4e3a <code>dtv</code> \u6570\u7ec4\u7684\u6bcf\u4e2a\u5143\u7d20\u7684\u7c7b\u578b\u662f <code>dtv_t</code>\uff0c\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<p><div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-32-1\"><a id=\"__codelineno-32-1\" name=\"__codelineno-32-1\" href=\"#__codelineno-32-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span>\n</span><span id=\"__span-32-2\"><a id=\"__codelineno-32-2\" name=\"__codelineno-32-2\" href=\"#__codelineno-32-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-32-3\"><a id=\"__codelineno-32-3\" name=\"__codelineno-32-3\" href=\"#__codelineno-32-3\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">val</span><span class=\"p\">;</span><span class=\"w\">                    </span><span class=\"cm\">/* Pointer to data, or TLS_DTV_UNALLOCATED.  */</span>\n</span><span id=\"__span-32-4\"><a id=\"__codelineno-32-4\" name=\"__codelineno-32-4\" href=\"#__codelineno-32-4\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">to_free</span><span class=\"p\">;</span><span class=\"w\">                </span><span class=\"cm\">/* Unaligned pointer, for deallocation.  */</span>\n</span><span id=\"__span-32-5\"><a id=\"__codelineno-32-5\" name=\"__codelineno-32-5\" href=\"#__codelineno-32-5\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-32-6\"><a id=\"__codelineno-32-6\" name=\"__codelineno-32-6\" href=\"#__codelineno-32-6\"></a>\n</span><span id=\"__span-32-7\"><a id=\"__codelineno-32-7\" name=\"__codelineno-32-7\" href=\"#__codelineno-32-7\"></a><span class=\"cm\">/* Type for the dtv.  */</span>\n</span><span id=\"__span-32-8\"><a id=\"__codelineno-32-8\" name=\"__codelineno-32-8\" href=\"#__codelineno-32-8\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"nc\">dtv</span>\n</span><span id=\"__span-32-9\"><a id=\"__codelineno-32-9\" name=\"__codelineno-32-9\" href=\"#__codelineno-32-9\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-32-10\"><a id=\"__codelineno-32-10\" name=\"__codelineno-32-10\" href=\"#__codelineno-32-10\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-11\"><a id=\"__codelineno-32-11\" name=\"__codelineno-32-11\" href=\"#__codelineno-32-11\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"w\"> </span><span class=\"n\">pointer</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-12\"><a id=\"__codelineno-32-12\" name=\"__codelineno-32-12\" href=\"#__codelineno-32-12\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">dtv_t</span><span class=\"p\">;</span>\n</span></code></pre></div>\n4. \u628a\u8d77\u59cb\u5730\u5740\u52a0\u4e0a\u504f\u79fb\uff0c\u7136\u540e\u8fd4\u56de\uff1a<code>add TI_OFFSET_OFFSET(%rdi), %RAX_LP; ret</code></p>\n</li>\n</ol>\n<p>\u4f46\u5b9e\u9645\u60c5\u51b5\u4f1a\u6bd4\u8fd9\u4e2a\u66f4\u590d\u6742\uff1adlopen \u53ef\u80fd\u4f1a\u52a8\u6001\u5f15\u5165\u65b0\u7684\u52a8\u6001\u5e93\uff0c\u6b64\u65f6 dtv \u6570\u7ec4\u53ef\u80fd\u9700\u8981\u6269\u5f20\uff1b\u6b64\u5916\uff0c\u5982\u679c\u4e00\u4e2a\u52a8\u6001\u5e93\u6709 TLS \u53d8\u91cf\u4f46\u662f\u4ece\u6765\u4e0d\u7528\uff0c\u4e5f\u53ef\u4ee5 lazy \u5206\u914d\u5b83\u7684 TLS \u7a7a\u95f4\uff0c\u53ea\u6709\u5728\u7b2c\u4e00\u6b21\u8bbf\u95ee\u7684\u65f6\u5019\uff0c\u624d\u53bb\u5206\u914d\u3002</p>\n<p>\u9996\u5148\u6765\u8003\u8651\u7b2c\u4e00\u4e2a\u9700\u6c42\uff0c\u5904\u7406 dlopen \u5bfc\u81f4 dtv \u5143\u7d20\u4e2a\u6570\u53d8\u5316\uff0c\u5b83\u7684\u5b9e\u73b0\u65b9\u6cd5\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\n<p><code>dtv[0]</code> \u4e0d\u7528\u6765\u4fdd\u5b58 TLS \u7a7a\u95f4\u7684\u4fe1\u606f\uff0c\u800c\u662f\u8bb0\u5f55\u4e00\u4e2a counter\uff0c\u8fd9\u4e2a counter \u8bb0\u5f55\u7684\u662f\u5f53\u524d dtv \u7684\u7248\u672c\u53f7\uff08generation\uff09\uff0c\u53e6\u5916\u5728\u5168\u5c40\u53d8\u91cf <code>dl_tls_generation</code> \u4e2d\u8bb0\u5f55\u5f53\u524d\u6700\u65b0\u7684\u7248\u672c\u53f7\uff1b\u5f53 dlopen \u5bfc\u81f4 dtv \u7ed3\u6784\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u66f4\u65b0 <code>dl_tls_generation</code> \u7248\u672c\uff0c\u7136\u540e\u5728 <code>__tls_get_addr</code> \u91cc\u68c0\u67e5\u7248\u672c\u53f7\uff0c\u4e0d\u4e00\u81f4\u5219\u8fdb\u5165 slow path\uff1a</p>\n<p><div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-33-1\"><a id=\"__codelineno-33-1\" name=\"__codelineno-33-1\" href=\"#__codelineno-33-1\"></a><span class=\"nf\">ENTRY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">__tls_get_addr</span><span class=\"p\">)</span>\n</span><span id=\"__span-33-2\"><a id=\"__codelineno-33-2\" name=\"__codelineno-33-2\" href=\"#__codelineno-33-2\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"no\">DTV_OFFSET</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%RDX_LP</span>\n</span><span id=\"__span-33-3\"><a id=\"__codelineno-33-3\" name=\"__codelineno-33-3\" href=\"#__codelineno-33-3\"></a>\n</span><span id=\"__span-33-4\"><a id=\"__codelineno-33-4\" name=\"__codelineno-33-4\" href=\"#__codelineno-33-4\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">GL_TLS_GENERATION_OFFSET</span><span class=\"err\">+</span><span class=\"no\">_rtld_local</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-33-5\"><a id=\"__codelineno-33-5\" name=\"__codelineno-33-5\" href=\"#__codelineno-33-5\"></a><span class=\"w\">    </span><span class=\"cm\">/* GL(dl_tls_generation) == dtv[0].counter */</span>\n</span><span id=\"__span-33-6\"><a id=\"__codelineno-33-6\" name=\"__codelineno-33-6\" href=\"#__codelineno-33-6\"></a><span class=\"w\">    </span><span class=\"nf\">cmp</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">)</span>\n</span><span id=\"__span-33-7\"><a id=\"__codelineno-33-7\" name=\"__codelineno-33-7\" href=\"#__codelineno-33-7\"></a><span class=\"w\">    </span><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-33-8\"><a id=\"__codelineno-33-8\" name=\"__codelineno-33-8\" href=\"#__codelineno-33-8\"></a>\n</span><span id=\"__span-33-9\"><a id=\"__codelineno-33-9\" name=\"__codelineno-33-9\" href=\"#__codelineno-33-9\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">TI_MODULE_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-33-10\"><a id=\"__codelineno-33-10\" name=\"__codelineno-33-10\" href=\"#__codelineno-33-10\"></a><span class=\"w\">    </span><span class=\"cm\">/* dtv[ti-&gt;ti_module] */</span>\n</span><span id=\"__span-33-11\"><a id=\"__codelineno-33-11\" name=\"__codelineno-33-11\" href=\"#__codelineno-33-11\"></a><span class=\"w\">    </span><span class=\"nf\">salq</span><span class=\"w\">    </span><span class=\"no\">$4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-33-12\"><a id=\"__codelineno-33-12\" name=\"__codelineno-33-12\" href=\"#__codelineno-33-12\"></a><span class=\"w\">    </span><span class=\"nf\">movq</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">,</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-33-13\"><a id=\"__codelineno-33-13\" name=\"__codelineno-33-13\" href=\"#__codelineno-33-13\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-33-14\"><a id=\"__codelineno-33-14\" name=\"__codelineno-33-14\" href=\"#__codelineno-33-14\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">TI_OFFSET_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-33-15\"><a id=\"__codelineno-33-15\" name=\"__codelineno-33-15\" href=\"#__codelineno-33-15\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-33-16\"><a id=\"__codelineno-33-16\" name=\"__codelineno-33-16\" href=\"#__codelineno-33-16\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-33-17\"><a id=\"__codelineno-33-17\" name=\"__codelineno-33-17\" href=\"#__codelineno-33-17\"></a><span class=\"w\">    </span><span class=\"cm\">/* slow path, stack alignment omitted */</span>\n</span><span id=\"__span-33-18\"><a id=\"__codelineno-33-18\" name=\"__codelineno-33-18\" href=\"#__codelineno-33-18\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\">    </span><span class=\"no\">__tls_get_addr_slow</span>\n</span><span id=\"__span-33-19\"><a id=\"__codelineno-33-19\" name=\"__codelineno-33-19\" href=\"#__codelineno-33-19\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span></code></pre></div>\n2. \u5728 <code>__tls_get_addr_slow</code> \u4e2d\uff0c\u5982\u679c\u53d1\u73b0\u5f53\u524d dtv \u7684\u7248\u672c\u53f7\u548c\u6700\u65b0\u7684\u7248\u672c\u53f7 <code>dl_tls_generation</code> \u4e0d\u4e00\u81f4\uff0c\u5c31\u8c03\u7528 <code>update_get_addr</code> \u6765\u91cd\u65b0\u5206\u914d\u5185\u5b58\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-34-1\"><a id=\"__codelineno-34-1\" name=\"__codelineno-34-1\" href=\"#__codelineno-34-1\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span>\n</span><span id=\"__span-34-2\"><a id=\"__codelineno-34-2\" name=\"__codelineno-34-2\" href=\"#__codelineno-34-2\"></a><span class=\"nf\">__tls_get_addr_slow</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tls_index</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ti</span><span class=\"p\">)</span>\n</span><span id=\"__span-34-3\"><a id=\"__codelineno-34-3\" name=\"__codelineno-34-3\" href=\"#__codelineno-34-3\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-34-4\"><a id=\"__codelineno-34-4\" name=\"__codelineno-34-4\" href=\"#__codelineno-34-4\"></a><span class=\"w\">    </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">THREAD_DTV</span><span class=\"w\"> </span><span class=\"p\">();</span>\n</span><span id=\"__span-34-5\"><a id=\"__codelineno-34-5\" name=\"__codelineno-34-5\" href=\"#__codelineno-34-5\"></a>\n</span><span id=\"__span-34-6\"><a id=\"__codelineno-34-6\" name=\"__codelineno-34-6\" href=\"#__codelineno-34-6\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">dtv</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">GL</span><span class=\"p\">(</span><span class=\"n\">dl_tls_generation</span><span class=\"p\">)))</span>\n</span><span id=\"__span-34-7\"><a id=\"__codelineno-34-7\" name=\"__codelineno-34-7\" href=\"#__codelineno-34-7\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">update_get_addr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ti</span><span class=\"p\">);</span>\n</span><span id=\"__span-34-8\"><a id=\"__codelineno-34-8\" name=\"__codelineno-34-8\" href=\"#__codelineno-34-8\"></a>\n</span><span id=\"__span-34-9\"><a id=\"__codelineno-34-9\" name=\"__codelineno-34-9\" href=\"#__codelineno-34-9\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_get_addr_tail</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ti</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dtv</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">);</span>\n</span><span id=\"__span-34-10\"><a id=\"__codelineno-34-10\" name=\"__codelineno-34-10\" href=\"#__codelineno-34-10\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n</ol>\n<p>\u5177\u4f53\u7684 dtv \u66f4\u65b0\u903b\u8f91\u6bd4\u8f83\u590d\u6742\uff0c\u6709\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u7ffb\u9605 glibc \u7684\u6e90\u7801\u4e2d <code>update_get_addr</code> \u51fd\u6570\u7684\u5b9e\u73b0\u3002</p>\n<p>\u63a5\u4e0b\u6765\u8003\u8651\u7b2c\u4e8c\u4e2a\u9700\u6c42\uff0c\u4e5f\u5c31\u662f lazy \u5206\u914d\uff0c\u53ea\u6709\u5728\u7b2c\u4e00\u6b21\u8bbf\u95ee TLS \u7a7a\u95f4\u7684\u65f6\u5019\uff0c\u624d\u7ed9 dlopen \u7684\u52a8\u6001\u5e93\u5206\u914d TLS \u7a7a\u95f4\u3002\u4e3a\u4e86\u533a\u5206\u5df2\u5206\u914d\u548c\u672a\u5206\u914d\u7684 TLS \u7a7a\u95f4\uff0c\u672a\u5206\u914d\u7684 TLS \u7a7a\u95f4\u7684 <code>val</code> \u5b57\u6bb5\u7684\u503c\u662f <code>TLS_DTV_UNALLOCATED</code>\uff0c\u5f53 <code>__tls_get_addr</code> \u68c0\u6d4b\u5230 TLS \u7a7a\u95f4\u5c1a\u672a\u5206\u914d\u65f6\uff0c\u4e5f\u4f1a\u8fdb\u5165 slow path\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-35-1\"><a id=\"__codelineno-35-1\" name=\"__codelineno-35-1\" href=\"#__codelineno-35-1\"></a><span class=\"nf\">ENTRY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">__tls_get_addr</span><span class=\"p\">)</span>\n</span><span id=\"__span-35-2\"><a id=\"__codelineno-35-2\" name=\"__codelineno-35-2\" href=\"#__codelineno-35-2\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"no\">DTV_OFFSET</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%RDX_LP</span>\n</span><span id=\"__span-35-3\"><a id=\"__codelineno-35-3\" name=\"__codelineno-35-3\" href=\"#__codelineno-35-3\"></a>\n</span><span id=\"__span-35-4\"><a id=\"__codelineno-35-4\" name=\"__codelineno-35-4\" href=\"#__codelineno-35-4\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">GL_TLS_GENERATION_OFFSET</span><span class=\"err\">+</span><span class=\"no\">_rtld_local</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-5\"><a id=\"__codelineno-35-5\" name=\"__codelineno-35-5\" href=\"#__codelineno-35-5\"></a><span class=\"w\">    </span><span class=\"cm\">/* GL(dl_tls_generation) == dtv[0].counter */</span>\n</span><span id=\"__span-35-6\"><a id=\"__codelineno-35-6\" name=\"__codelineno-35-6\" href=\"#__codelineno-35-6\"></a><span class=\"w\">    </span><span class=\"nf\">cmp</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">)</span>\n</span><span id=\"__span-35-7\"><a id=\"__codelineno-35-7\" name=\"__codelineno-35-7\" href=\"#__codelineno-35-7\"></a><span class=\"w\">    </span><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-35-8\"><a id=\"__codelineno-35-8\" name=\"__codelineno-35-8\" href=\"#__codelineno-35-8\"></a>\n</span><span id=\"__span-35-9\"><a id=\"__codelineno-35-9\" name=\"__codelineno-35-9\" href=\"#__codelineno-35-9\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">TI_MODULE_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-10\"><a id=\"__codelineno-35-10\" name=\"__codelineno-35-10\" href=\"#__codelineno-35-10\"></a><span class=\"w\">    </span><span class=\"cm\">/* dtv[ti-&gt;ti_module] */</span>\n</span><span id=\"__span-35-11\"><a id=\"__codelineno-35-11\" name=\"__codelineno-35-11\" href=\"#__codelineno-35-11\"></a><span class=\"w\">    </span><span class=\"nf\">salq</span><span class=\"w\">    </span><span class=\"no\">$4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-35-12\"><a id=\"__codelineno-35-12\" name=\"__codelineno-35-12\" href=\"#__codelineno-35-12\"></a><span class=\"w\">    </span><span class=\"nf\">movq</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">,</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-35-13\"><a id=\"__codelineno-35-13\" name=\"__codelineno-35-13\" href=\"#__codelineno-35-13\"></a>\n</span><span id=\"__span-35-14\"><a id=\"__codelineno-35-14\" name=\"__codelineno-35-14\" href=\"#__codelineno-35-14\"></a><span class=\"w\">    </span><span class=\"cm\">/* branch if val == TLS_DTV_UNALLOCATED */</span>\n</span><span id=\"__span-35-15\"><a id=\"__codelineno-35-15\" name=\"__codelineno-35-15\" href=\"#__codelineno-35-15\"></a><span class=\"w\">    </span><span class=\"nf\">cmp</span><span class=\"w\"> </span><span class=\"no\">$-1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-16\"><a id=\"__codelineno-35-16\" name=\"__codelineno-35-16\" href=\"#__codelineno-35-16\"></a><span class=\"w\">    </span><span class=\"nf\">je</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-35-17\"><a id=\"__codelineno-35-17\" name=\"__codelineno-35-17\" href=\"#__codelineno-35-17\"></a>\n</span><span id=\"__span-35-18\"><a id=\"__codelineno-35-18\" name=\"__codelineno-35-18\" href=\"#__codelineno-35-18\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">TI_OFFSET_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-19\"><a id=\"__codelineno-35-19\" name=\"__codelineno-35-19\" href=\"#__codelineno-35-19\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-35-20\"><a id=\"__codelineno-35-20\" name=\"__codelineno-35-20\" href=\"#__codelineno-35-20\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-35-21\"><a id=\"__codelineno-35-21\" name=\"__codelineno-35-21\" href=\"#__codelineno-35-21\"></a><span class=\"w\">    </span><span class=\"cm\">/* slow path, stack alignment omitted */</span>\n</span><span id=\"__span-35-22\"><a id=\"__codelineno-35-22\" name=\"__codelineno-35-22\" href=\"#__codelineno-35-22\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\">    </span><span class=\"no\">__tls_get_addr_slow</span>\n</span><span id=\"__span-35-23\"><a id=\"__codelineno-35-23\" name=\"__codelineno-35-23\" href=\"#__codelineno-35-23\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span></code></pre></div>\n<p>\u5728 slow path \u4e2d\uff0c\u6700\u7ec8\u7531 <code>allocate_dtv_entry</code> \u51fd\u6570\u6765\u5206\u914d\u8fd9\u7247\u7a7a\u95f4\uff0c\u6ce8\u610f\u5230 TLS \u7a7a\u95f4\u53ef\u80fd\u6709\u5bf9\u9f50\u7684\u8981\u6c42\uff0c\u6240\u4ee5\u5b83\u5b9e\u9645\u4e0a\u8bb0\u5f55\u4e86\u4e24\u4e2a\u5730\u5740\uff0c\u4e00\u4e2a\u662f malloc \u5f97\u5230\u7684\u5730\u5740\uff08\u7528\u4e8e\u540e\u7eed\u7684 free \u8c03\u7528\uff09\uff0c\u4e00\u4e2a\u662f\u7ecf\u8fc7\u5bf9\u9f50\u540e\u7684\u5730\u5740\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-36-1\"><a id=\"__codelineno-36-1\" name=\"__codelineno-36-1\" href=\"#__codelineno-36-1\"></a><span class=\"cm\">/* Allocate one DTV entry.  */</span>\n</span><span id=\"__span-36-2\"><a id=\"__codelineno-36-2\" name=\"__codelineno-36-2\" href=\"#__codelineno-36-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span>\n</span><span id=\"__span-36-3\"><a id=\"__codelineno-36-3\" name=\"__codelineno-36-3\" href=\"#__codelineno-36-3\"></a><span class=\"n\">allocate_dtv_entry</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span>\n</span><span id=\"__span-36-4\"><a id=\"__codelineno-36-4\" name=\"__codelineno-36-4\" href=\"#__codelineno-36-4\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-36-5\"><a id=\"__codelineno-36-5\" name=\"__codelineno-36-5\" href=\"#__codelineno-36-5\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">powerof2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">alignment</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"k\">_Alignof</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">max_align_t</span><span class=\"p\">))</span>\n</span><span id=\"__span-36-6\"><a id=\"__codelineno-36-6\" name=\"__codelineno-36-6\" href=\"#__codelineno-36-6\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n</span><span id=\"__span-36-7\"><a id=\"__codelineno-36-7\" name=\"__codelineno-36-7\" href=\"#__codelineno-36-7\"></a><span class=\"w\">      </span><span class=\"cm\">/* The alignment is supported by malloc.  */</span>\n</span><span id=\"__span-36-8\"><a id=\"__codelineno-36-8\" name=\"__codelineno-36-8\" href=\"#__codelineno-36-8\"></a><span class=\"w\">      </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-36-9\"><a id=\"__codelineno-36-9\" name=\"__codelineno-36-9\" href=\"#__codelineno-36-9\"></a><span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">};</span>\n</span><span id=\"__span-36-10\"><a id=\"__codelineno-36-10\" name=\"__codelineno-36-10\" href=\"#__codelineno-36-10\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-36-11\"><a id=\"__codelineno-36-11\" name=\"__codelineno-36-11\" href=\"#__codelineno-36-11\"></a>\n</span><span id=\"__span-36-12\"><a id=\"__codelineno-36-12\" name=\"__codelineno-36-12\" href=\"#__codelineno-36-12\"></a><span class=\"w\">  </span><span class=\"cm\">/* Emulate memalign to by manually aligning a pointer returned by</span>\n</span><span id=\"__span-36-13\"><a id=\"__codelineno-36-13\" name=\"__codelineno-36-13\" href=\"#__codelineno-36-13\"></a><span class=\"cm\">     malloc.  First compute the size with an overflow check.  */</span>\n</span><span id=\"__span-36-14\"><a id=\"__codelineno-36-14\" name=\"__codelineno-36-14\" href=\"#__codelineno-36-14\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">alloc_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"p\">;</span>\n</span><span id=\"__span-36-15\"><a id=\"__codelineno-36-15\" name=\"__codelineno-36-15\" href=\"#__codelineno-36-15\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">alloc_size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span>\n</span><span id=\"__span-36-16\"><a id=\"__codelineno-36-16\" name=\"__codelineno-36-16\" href=\"#__codelineno-36-16\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n</span><span id=\"__span-36-17\"><a id=\"__codelineno-36-17\" name=\"__codelineno-36-17\" href=\"#__codelineno-36-17\"></a>\n</span><span id=\"__span-36-18\"><a id=\"__codelineno-36-18\" name=\"__codelineno-36-18\" href=\"#__codelineno-36-18\"></a><span class=\"w\">  </span><span class=\"cm\">/* Perform the allocation.  This is the pointer we need to free</span>\n</span><span id=\"__span-36-19\"><a id=\"__codelineno-36-19\" name=\"__codelineno-36-19\" href=\"#__codelineno-36-19\"></a><span class=\"cm\">     later.  */</span>\n</span><span id=\"__span-36-20\"><a id=\"__codelineno-36-20\" name=\"__codelineno-36-20\" href=\"#__codelineno-36-20\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">alloc_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-36-21\"><a id=\"__codelineno-36-21\" name=\"__codelineno-36-21\" href=\"#__codelineno-36-21\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-36-22\"><a id=\"__codelineno-36-22\" name=\"__codelineno-36-22\" href=\"#__codelineno-36-22\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n</span><span id=\"__span-36-23\"><a id=\"__codelineno-36-23\" name=\"__codelineno-36-23\" href=\"#__codelineno-36-23\"></a>\n</span><span id=\"__span-36-24\"><a id=\"__codelineno-36-24\" name=\"__codelineno-36-24\" href=\"#__codelineno-36-24\"></a><span class=\"w\">  </span><span class=\"cm\">/* Find the aligned position within the larger allocation.  */</span>\n</span><span id=\"__span-36-25\"><a id=\"__codelineno-36-25\" name=\"__codelineno-36-25\" href=\"#__codelineno-36-25\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">roundup</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">uintptr_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"p\">);</span>\n</span><span id=\"__span-36-26\"><a id=\"__codelineno-36-26\" name=\"__codelineno-36-26\" href=\"#__codelineno-36-26\"></a>\n</span><span id=\"__span-36-27\"><a id=\"__codelineno-36-27\" name=\"__codelineno-36-27\" href=\"#__codelineno-36-27\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">to_free</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"p\">};</span>\n</span><span id=\"__span-36-28\"><a id=\"__codelineno-36-28\" name=\"__codelineno-36-28\" href=\"#__codelineno-36-28\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u89c1\u8fd9\u4e9b lazy \u5206\u914d\u7684 TLS \u7a7a\u95f4\u90fd\u662f\u653e\u5728\u5806\u4e0a\u7684\uff0c\u7531 malloc \u8fdb\u884c\u52a8\u6001\u5206\u914d\u3002\u800c\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u968f\u7740\u7a0b\u5e8f\u542f\u52a8\u800c\u81ea\u52a8\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff0c\u662f\u968f\u7740 TCB \u4e5f\u5c31\u662f <code>struct pthread</code> \u4e00\u8d77\u5206\u914d\u7684\u3002\u5bf9\u4e8e\u65b0\u521b\u5efa\u7684\u7ebf\u7a0b\u6765\u8bf4\uff0cTCB \u653e\u7f6e\u5728\u6808\u7684\u9876\u90e8\uff0c\u800c\u4e0d\u662f\u5728\u5806\u4e0a\uff0c\u6240\u4ee5\u8981\u6c42\u5927\u5c0f\u4e0d\u80fd\u52a8\u6001\u53d8\u5316\uff0c\u53ea\u6709 dtv \u6570\u7ec4\u7684\u6307\u9488\u4fdd\u5b58\u5728 <code>struct pthread</code> \u4e2d\uff0cdtv \u6570\u7ec4\u672c\u8eab\u662f\u653e\u5728\u5806\u4e0a\u7684\uff0c\u6839\u636e\u9700\u8981\u8fdb\u884c malloc/realloc\uff08\u89c1 <code>_dl_resize_dtv</code> \u51fd\u6570\uff09\u3002\u5bf9\u4e8e\u521d\u59cb\u7ebf\u7a0b\u6765\u8bf4\uff0cTCB \u662f\u901a\u8fc7 malloc \u6216\u8005 sbrk \u52a8\u6001\u5206\u914d\u7684\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://www.akkadia.org/drepper/tls.pdf\">ELF Handling For Thread-Local Storage</a></li>\n<li><a href=\"https://maskray.me/blog/2021-02-14-all-about-thread-local-storage\">All about thread-local storage</a></li>\n<li><a href=\"https://stackoverflow.com/questions/8482079/what-system-data-is-stored-on-the-stack\">What system data is stored on the stack</a></li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/software/tls-internals.png", "date_modified": "2025-04-07T00:00:00+00:00", "date_published": "2025-04-07T00:00:00+00:00", "authors": [], "tags": ["glibc", "linux", "software", "tls"]}, {"id": "https://jia.je/software/2025/03/30/glibc-allocator/", "url": "https://jia.je/software/2025/03/30/glibc-allocator/", "title": "glibc \u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"glibc-\u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76\">glibc \u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#glibc-\u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>malloc \u548c free \u65e5\u5e38\u7528\u7684\u5f88\u591a\uff0c\u4f46\u5b83\u5185\u90e8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f\u672c\u6587\u5bf9 glibc 2.31 \u7248\u672c\u7684\u5185\u5b58\u5206\u914d\u5668\u7684\u5b9e\u73b0\u8fdb\u884c\u63a2\u7a76\u3002</p>\n<!-- more -->\n\n<p>\u672c\u6587\u7684\u5b8c\u6574\u7248\u5185\u5bb9\u5df2\u7ecf\u6574\u5408\u5230<a href=\"/kb/software/glibc_allocator.html\">\u77e5\u8bc6\u5e93</a>\u4e2d\u3002</p>\n<h2 id=\"malloc\">malloc<a class=\"headerlink\" href=\"#malloc\" title=\"Permanent link\">&para;</a></h2>\n<p>glibc 2.31 \u662f ubuntu 20.04 \u6240\u4f7f\u7528\u7684 libc \u7248\u672c\uff0c\u9996\u5148\u6765\u5206\u6790\u5b83\u7684\u5b9e\u73b0\uff0c\u6e90\u7801\u53ef\u4ee5\u4ece <a href=\"https://github.com/bminor/glibc/tree/glibc-2.31\">glibc-2.31 tag</a> \u4e2d\u627e\u5230\u3002</p>\n<p>\u9996\u5148\u6765\u770b malloc \u51fd\u6570\uff0c\u5b83\u5b9e\u73b0\u5728 <code>malloc/malloc.c</code> \u7684 <a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3022\"><code>__libc_malloc</code></a> \u51fd\u6570\u5f53\u4e2d\uff0c\u5ffd\u7565 <code>__malloc_hook</code> \u548c\u4e00\u4e9b\u68c0\u67e5\uff0c\u9996\u5148\u53ef\u4ee5\u770b\u5230\u5b83\u6709\u4e00\u6bb5\u4ee3\u7801\uff0c\u4f7f\u7528\u4e86\u4e00\u4e2a\u53eb\u505a tcache \u7684\u6570\u636e\u7ed3\u6784\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"cm\">/* int_free also calls request2size, be careful to not pad twice.  */</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tbytes</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">checked_request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">tbytes</span><span class=\"p\">))</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"w\">    </span><span class=\"n\">__set_errno</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ENOMEM</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tbytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"n\">MAYBE_INIT_TCACHE</span><span class=\"w\"> </span><span class=\"p\">();</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"n\">DIAG_PUSH_NEEDS_COMMENT</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"n\">DIAG_POP_NEEDS_COMMENT</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<h2 id=\"tcache-thread-local-cache\">tcache (Thread Local Cache)<a class=\"headerlink\" href=\"#tcache-thread-local-cache\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u4ed4\u7ec6\u5730\u7814\u7a76 tcache \u7684\u7ed3\u6784\u3002\u9996\u5148\uff0c\u5b83\u662f\u4e00\u4e2a per-thread \u7684\u6570\u636e\u7ed3\u6784\uff0c\u610f\u5473\u7740\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u4efd tcache\uff0c\u4e0d\u9700\u8981\u4e0a\u9501\u5c31\u53ef\u4ee5\u8bbf\u95ee\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"n\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u63a5\u4e0b\u6765\u770b\u5b83\u5177\u4f53\u4fdd\u5b58\u4e86\u4ec0\u4e48\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"cm\">/* We overlay this structure on the user-data portion of a chunk when</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"cm\">   the chunk is stored in the per-thread cache.  */</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"w\">  </span><span class=\"cm\">/* This field exists to detect double frees.  */</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_entry</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"cm\">/* There is one of these for each thread, which contains the</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"cm\">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"cm\">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a><span class=\"cm\">   are redundant (we could have just counted the linked list each</span>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"cm\">   time), this is for performance reasons.  */</span>\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a><span class=\"w\">  </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_perthread_struct</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-20\"><a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\" href=\"#__codelineno-2-20\"></a>\n</span><span id=\"__span-2-21\"><a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\" href=\"#__codelineno-2-21\"></a><span class=\"cm\">/* Caller must ensure that we know tc_idx is valid and there&#39;s room</span>\n</span><span id=\"__span-2-22\"><a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\" href=\"#__codelineno-2-22\"></a><span class=\"cm\">   for more chunks.  */</span>\n</span><span id=\"__span-2-23\"><a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\" href=\"#__codelineno-2-23\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">__always_inline</span><span class=\"w\"> </span><span class=\"kt\">void</span>\n</span><span id=\"__span-2-24\"><a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\" href=\"#__codelineno-2-24\"></a><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-25\"><a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\" href=\"#__codelineno-2-25\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-26\"><a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\" href=\"#__codelineno-2-26\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-27\"><a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\" href=\"#__codelineno-2-27\"></a>\n</span><span id=\"__span-2-28\"><a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\" href=\"#__codelineno-2-28\"></a><span class=\"w\">  </span><span class=\"cm\">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span>\n</span><span id=\"__span-2-29\"><a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\" href=\"#__codelineno-2-29\"></a><span class=\"cm\">     detect a double free.  */</span>\n</span><span id=\"__span-2-30\"><a id=\"__codelineno-2-30\" name=\"__codelineno-2-30\" href=\"#__codelineno-2-30\"></a><span class=\"w\">  </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-31\"><a id=\"__codelineno-2-31\" name=\"__codelineno-2-31\" href=\"#__codelineno-2-31\"></a>\n</span><span id=\"__span-2-32\"><a id=\"__codelineno-2-32\" name=\"__codelineno-2-32\" href=\"#__codelineno-2-32\"></a><span class=\"w\">  </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-33\"><a id=\"__codelineno-2-33\" name=\"__codelineno-2-33\" href=\"#__codelineno-2-33\"></a><span class=\"w\">  </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-34\"><a id=\"__codelineno-2-34\" name=\"__codelineno-2-34\" href=\"#__codelineno-2-34\"></a><span class=\"w\">  </span><span class=\"o\">++</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]);</span>\n</span><span id=\"__span-2-35\"><a id=\"__codelineno-2-35\" name=\"__codelineno-2-35\" href=\"#__codelineno-2-35\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-2-36\"><a id=\"__codelineno-2-36\" name=\"__codelineno-2-36\" href=\"#__codelineno-2-36\"></a>\n</span><span id=\"__span-2-37\"><a id=\"__codelineno-2-37\" name=\"__codelineno-2-37\" href=\"#__codelineno-2-37\"></a><span class=\"cm\">/* Caller must ensure that we know tc_idx is valid and there&#39;s</span>\n</span><span id=\"__span-2-38\"><a id=\"__codelineno-2-38\" name=\"__codelineno-2-38\" href=\"#__codelineno-2-38\"></a><span class=\"cm\">   available chunks to remove.  */</span>\n</span><span id=\"__span-2-39\"><a id=\"__codelineno-2-39\" name=\"__codelineno-2-39\" href=\"#__codelineno-2-39\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">__always_inline</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span>\n</span><span id=\"__span-2-40\"><a id=\"__codelineno-2-40\" name=\"__codelineno-2-40\" href=\"#__codelineno-2-40\"></a><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-41\"><a id=\"__codelineno-2-41\" name=\"__codelineno-2-41\" href=\"#__codelineno-2-41\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-42\"><a id=\"__codelineno-2-42\" name=\"__codelineno-2-42\" href=\"#__codelineno-2-42\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-43\"><a id=\"__codelineno-2-43\" name=\"__codelineno-2-43\" href=\"#__codelineno-2-43\"></a><span class=\"w\">  </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-44\"><a id=\"__codelineno-2-44\" name=\"__codelineno-2-44\" href=\"#__codelineno-2-44\"></a><span class=\"w\">  </span><span class=\"o\">--</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]);</span>\n</span><span id=\"__span-2-45\"><a id=\"__codelineno-2-45\" name=\"__codelineno-2-45\" href=\"#__codelineno-2-45\"></a><span class=\"w\">  </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-46\"><a id=\"__codelineno-2-46\" name=\"__codelineno-2-46\" href=\"#__codelineno-2-46\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-47\"><a id=\"__codelineno-2-47\" name=\"__codelineno-2-47\" href=\"#__codelineno-2-47\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\u5b83\u6709\u4e24\u4e2a\u6210\u5458\uff0c\u628a tcache \u5206\u4e3a <code>TCACHE_MAX_BINS</code> \u8fd9\u4e48\u591a\u4e2a bin\uff0c\u6bcf\u4e2a bin \u5206\u522b\u6709\u4e00\u4e2a\uff1a</p>\n<ol>\n<li><code>counts[bin]</code>\uff1a\u8bb0\u5f55\u4e86\u8fd9\u4e2a bin \u4e2d\u7a7a\u95f2\u5757\u7684\u6570\u91cf\uff0c<code>tcache_put</code> \u7684\u65f6\u5019\u52a0\u4e00\uff0c<code>tcache_get</code> \u7684\u65f6\u5019\u51cf\u4e00</li>\n<li><code>entries[bin]</code>: \u6bcf\u4e2a bin \u7528\u4e00\u4e2a\u94fe\u8868\u4fdd\u5b58\u4e86\u7a7a\u95f2\u5757\uff0c\u94fe\u8868\u7684\u8282\u70b9\u7c7b\u578b\u662f <code>tcache_entry</code>\uff0c\u90a3\u4e48 <code>entries[bin]</code> \u4fdd\u5b58\u4e86\u94fe\u8868\u5934\u7684\u6307\u9488</li>\n</ol>\n<p>bin \u662f\u5185\u5b58\u5206\u914d\u5668\u7684\u4e00\u4e2a\u5e38\u89c1\u505a\u6cd5\uff0c\u628a\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\u5206 bin\uff0c\u4ece\u800c\u4fdd\u8bc1\u62ff\u5230\u7684\u7a7a\u95f2\u5757\u8db3\u591f\u5927\u3002\u63a5\u4e0b\u6765\u770b <code>tcache_put</code> \u662f\u5982\u4f55\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache \u4e2d\u7684\uff1a</p>\n<ol>\n<li>\u628a\u7a7a\u95f2\u5757\u5f3a\u5236\u8f6c\u6362\u4e3a <code>tcache_entry</code> \u7ed3\u6784\u4f53\u7c7b\u578b</li>\n<li>\u628a\u5b83\u7684 <code>key</code> \u5b57\u6bb5\u6307\u5411 tcache\uff0c\u7528\u6765\u8868\u793a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u5f53\u524d\u5728 <code>tcache</code> \u5f53\u4e2d\uff0c\u540e\u7eed\u7528\u5b83\u6765\u68c0\u6d4b double free</li>\n<li>\u4ee5\u65b0\u7684 <code>tcache_entry</code> \u4f5c\u4e3a\u94fe\u8868\u5934\uff0c\u63d2\u5165\u5230 tcache \u7684\u5bf9\u5e94\u7684 bin \u5f53\u4e2d\uff1a<code>entries[tc_idx]</code></li>\n<li>\u66f4\u65b0\u8fd9\u4e2a bin \u7684\u7a7a\u95f2\u5757\u4e2a\u6570\u5230 <code>count[tc_idx]</code> \u5f53\u4e2d</li>\n</ol>\n<p>\u53cd\u8fc7\u6765\uff0c<code>tcache_get</code> \u5219\u662f\u4ece tcache \u4e2d\u62ff\u51fa\u4e00\u4e2a\u7a7a\u95f2\u5757\uff1a</p>\n<ol>\n<li>\u4ece\u94fe\u8868\u5934 <code>entries[tc_idx]</code> \u53d6\u51fa\u4e00\u4e2a\u7a7a\u95f2\u5757\uff0c\u628a\u5b83\u4ece\u94fe\u8868\u4e2d\u5220\u9664\uff1a<code>entries[tc_idx] = e-&gt;next</code></li>\n<li>\u66f4\u65b0\u8fd9\u4e2a bin \u7684\u7a7a\u95f2\u5757\u4e2a\u6570\u5230 <code>count[tc_idx]</code> \u5f53\u4e2d</li>\n<li>\u628a\u5b83\u7684 <code>key</code> \u5b57\u6bb5\u6307\u5411 NULL\uff0c\u7528\u6765\u8868\u793a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u5f53\u524d\u4e0d\u5728 <code>tcache</code> \u5f53\u4e2d</li>\n<li>\u8fd4\u56de\u8fd9\u4e2a\u7a7a\u95f2\u5757\u7684\u5730\u5740</li>\n</ol>\n<h3 id=\"malloc_1\">malloc<a class=\"headerlink\" href=\"#malloc_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u56de\u5230 <code>malloc</code> \u7684\u5b9e\u73b0\uff0c\u5b83\u9996\u5148\u6839\u636e\u7528\u6237\u8981\u5206\u914d\u7684\u7a7a\u95f4\u5927\u5c0f\uff08<code>bytes</code>\uff09\uff0c\u8ba1\u7b97\u51fa\u5b9e\u9645\u9700\u8981\u5206\u914d\u7684\u5927\u5c0f\uff08<code>tbytes</code>\uff09\uff0c\u548c\u5bf9\u5e94\u7684 bin\uff08<code>tc_idx</code>\uff09\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"cm\">/* int_free also calls request2size, be careful to not pad twice.  */</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tbytes</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">checked_request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">tbytes</span><span class=\"p\">))</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"n\">__set_errno</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ENOMEM</span><span class=\"p\">);</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tbytes</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>checked_request2size</code> \u5b9e\u73b0\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"cp\">#define request2size(req)                                         \\</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"cp\">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \\</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"cp\">   MINSIZE :                                                      \\</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"cp\">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"cm\">/* Check if REQ overflows when padded and aligned and if the resulting value</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"cm\">   is less than PTRDIFF_T.  Returns TRUE and the requested size or MINSIZE in</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"cm\">   case the value is less than MINSIZE on SZ or false if any of the previous</span>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"cm\">   check fail.  */</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"kt\">bool</span>\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"nf\">checked_request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">sz</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">__nonnull</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">PTRDIFF_MAX</span><span class=\"p\">))</span>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"n\">sz</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">);</span>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u5b9e\u73b0\u7684\u5b9e\u9645\u4e0a\u662f\u628a\u7528\u6237\u8bf7\u6c42\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u52a0\u4e0a <code>SIZE_SZ</code>\uff08\u5373 <code>sizeof(size_t)</code>\uff09\uff0c\u5411\u4e0a\u53d6\u6574\u5230 <code>MALLOC_ALIGN_MASK</code> \u5bf9\u5e94\u7684 alignment\uff08<code>MALLOC_ALIGNMENT</code>\uff0c\u901a\u5e38\u662f <code>2 * SIZE_SZ</code>\uff09\u7684\u6574\u6570\u500d\u6570\uff0c\u518d\u548c <code>MINSIZE</code> \u53d6 max\u3002\u8fd9\u91cc\u8981\u52a0 <code>SIZE_SZ</code>\uff0c\u662f\u56e0\u4e3a malloc \u4f1a\u7ef4\u62a4\u88ab\u5206\u914d\u7684\u5757\u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u5305\u62ec\u5757\u7684\u5927\u5c0f\u548c\u4e00\u4e9b flag\uff0c\u540e\u7eed\u4f1a\u8be6\u7ec6\u8ba8\u8bba\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5206\u914d\u7684\u5b9e\u9645\u7a7a\u95f4\u4f1a\u6bd4\u7528\u6237\u8bf7\u6c42\u7684\u7a7a\u95f4\u8981\u66f4\u5927\u3002</p>\n<p>\u63a5\u7740\uff0c\u770b\u5b83\u662f\u5982\u4f55\u8ba1\u7b97\u51fa tcache index \u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"cm\">/* When &quot;x&quot; is from chunksize().  */</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"cp\"># define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4ece MINSIZE \u5f00\u59cb\uff0c\u4ee5 MALLOC_ALIGNMENT \u4e3a\u5355\u4f4d\uff0c\u6bcf\u4e2a bin \u5bf9\u5e94\u4e00\u4e2a\u7ecf\u8fc7 align \u4ee5\u540e\u7684\u53ef\u80fd\u7684\u5185\u5b58\u5757\u5927\u5c0f\u3002\u5f97\u5230 tcache index \u540e\uff0c\u68c0\u67e5\u5bf9\u5e94\u7684 bin \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff0c\u5982\u679c\u6709\uff0c\u5219\u76f4\u63a5\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0ctcache \u76f8\u5f53\u4e8e\u662f\u4e00\u4e2a per thread \u7684\u5c0f\u7f13\u5b58\uff0c\u8bb0\u5f55\u4e86\u6700\u8fd1\u91ca\u653e\u7684\u5185\u5b58\u5757\uff0c\u53ef\u4f9b malloc \u4f7f\u7528\u3002\u7531\u4e8e bin \u7684\u6570\u91cf\u6709\u9650\uff0c\u6240\u4ee5\u6bd4\u8f83\u5927\u7684\u5185\u5b58\u5206\u914d\u4e0d\u4f1a\u7ecf\u8fc7 tcache\u3002</p>\n<p>P.S. <code>calloc</code> \u4e0d\u4f1a\u4f7f\u7528 tcache\uff0c\u800c\u662f\u7528\u540e\u9762\u63d0\u5230\u7684 <code>_int_malloc</code> \u8fdb\u884c\u5404\u79cd\u5206\u914d\u3002</p>\n<h3 id=\"free\">free<a class=\"headerlink\" href=\"#free\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e2\u7136 malloc \u7528\u5230\u4e86 tcache\uff0c\u81ea\u7136 free \u5c31\u8981\u5f80\u91cc\u9762\u653e\u7a7a\u95f2\u5757\u4e86\uff0c\u76f8\u5173\u7684\u4ee3\u7801\u5728 <code>_int_free</code> \u51fd\u6570\u5f53\u4e2d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* Check to see if it&#39;s already in the tcache.  */</span>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"w\">    </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"w\">    </span><span class=\"cm\">/* This test succeeds on double free.  However, we don&#39;t 100%</span>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"cm\">       trust it (it also matches random payload data at a 1 in</span>\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a><span class=\"cm\">       2^&lt;size_t&gt; chance), so verify it&#39;s not an unlikely</span>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"cm\">       coincidence before aborting.  */</span>\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"p\">))</span>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a><span class=\"w\">        </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tmp</span><span class=\"p\">;</span>\n</span><span id=\"__span-7-14\"><a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\" href=\"#__codelineno-7-14\"></a><span class=\"w\">        </span><span class=\"n\">LIBC_PROBE</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">memory_tcache_double_free</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-15\"><a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\" href=\"#__codelineno-7-15\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tmp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">];</span>\n</span><span id=\"__span-7-16\"><a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\" href=\"#__codelineno-7-16\"></a><span class=\"w\">             </span><span class=\"n\">tmp</span><span class=\"p\">;</span>\n</span><span id=\"__span-7-17\"><a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\" href=\"#__codelineno-7-17\"></a><span class=\"w\">             </span><span class=\"n\">tmp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tmp</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-18\"><a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\" href=\"#__codelineno-7-18\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tmp</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-19\"><a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\" href=\"#__codelineno-7-19\"></a><span class=\"w\">            </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;free(): double free detected in tcache 2&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-20\"><a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\" href=\"#__codelineno-7-20\"></a><span class=\"w\">            </span><span class=\"cm\">/* If we get here, it was a coincidence.  We&#39;ve wasted a</span>\n</span><span id=\"__span-7-21\"><a id=\"__codelineno-7-21\" name=\"__codelineno-7-21\" href=\"#__codelineno-7-21\"></a><span class=\"cm\">               few cycles, but don&#39;t abort.  */</span>\n</span><span id=\"__span-7-22\"><a id=\"__codelineno-7-22\" name=\"__codelineno-7-22\" href=\"#__codelineno-7-22\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-7-23\"><a id=\"__codelineno-7-23\" name=\"__codelineno-7-23\" href=\"#__codelineno-7-23\"></a>\n</span><span id=\"__span-7-24\"><a id=\"__codelineno-7-24\" name=\"__codelineno-7-24\" href=\"#__codelineno-7-24\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-25\"><a id=\"__codelineno-7-25\" name=\"__codelineno-7-25\" href=\"#__codelineno-7-25\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-7-26\"><a id=\"__codelineno-7-26\" name=\"__codelineno-7-26\" href=\"#__codelineno-7-26\"></a><span class=\"w\">        </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-27\"><a id=\"__codelineno-7-27\" name=\"__codelineno-7-27\" href=\"#__codelineno-7-27\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span>\n</span><span id=\"__span-7-28\"><a id=\"__codelineno-7-28\" name=\"__codelineno-7-28\" href=\"#__codelineno-7-28\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-7-29\"><a id=\"__codelineno-7-29\" name=\"__codelineno-7-29\" href=\"#__codelineno-7-29\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u903b\u8f91\u4e5f\u4e0d\u590d\u6742\uff1a</p>\n<ol>\n<li>\u8ba1\u7b97 tcache index\uff0c\u627e\u5230\u5bf9\u5e94\u7684 bin</li>\n<li>\u68c0\u67e5\u5b83\u662f\u4e0d\u662f\u5df2\u7ecf\u88ab free \u8fc7\u4e86\uff0c\u5373 double free\uff1afree \u8fc7\u7684\u6307\u9488\uff0c\u5b83\u7684 key \u5b57\u6bb5\u5e94\u5f53\u6307\u5411 tcache\uff0c\u5982\u679c\u5b9e\u9645\u68c0\u6d4b\u5230\u662f\u8fd9\u6837\uff0c\u90a3\u5c31\u53bb tcache \u91cc\u904d\u5386\u94fe\u8868\uff0c\u68c0\u67e5\u662f\u4e0d\u662f\u771f\u7684\u5728\u91cc\u9762\uff0c\u5982\u679c\u662f\uff0c\u8bf4\u660e double free \u4e86\uff0c\u62a5\u9519</li>\n<li>\u5982\u679c\u5bf9\u5e94\u7684 bin \u7684\u94fe\u8868\u957f\u5ea6\u4e0d\u662f\u5f88\u957f\uff08\u9608\u503c\u662f <code>mp_.tcache_count</code>\uff0c\u53d6\u503c\u89c1\u540e\uff09\uff0c\u5219\u6dfb\u52a0\u5230\u94fe\u8868\u5934\u90e8\uff0c\u5b8c\u6210 free \u7684\u8fc7\u7a0b</li>\n</ol>\n<p>\u90a3\u4e48 tcache \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6709\u591a\u5927\u5462\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"cm\">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span>\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"cp\"># define TCACHE_MAX_BINS  64</span>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"cm\">/* This is another arbitrary limit, which tunables can change.  Each</span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"cm\">   tcache bin will hold at most this number of chunks.  */</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"cp\"># define TCACHE_FILL_COUNT 7</span>\n</span></code></pre></div>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b83\u6709 64 \u4e2a bin\uff0c\u6bcf\u4e2a bin \u7684\u94fe\u8868\u6700\u591a 7 \u4e2a\u7a7a\u95f2\u5757\u3002</p>\n<p>\u5728 64 \u4f4d\u4e0b\uff0c\u8fd9 64 \u4e2a bin \u5bf9\u5e94\u7684\u5757\u5927\u5c0f\u662f\u4ece 32 \u5b57\u8282\u5230 1040 \u5b57\u8282\uff0c\u6bcf 16 \u5b57\u8282\u4e00\u4e2a bin\uff08<code>(1040 - 32) / 16 + 1 = 64</code>\uff09\u3002\u90a3\u4e48\uff0c<code>malloc(1032)</code> \u6216\u66f4\u5c0f\u7684\u5206\u914d\u4f1a\u7ecf\u8fc7 tcache\uff0c\u800c <code>malloc(1033)</code> \u6216\u66f4\u5927\u7684\u5206\u914d\u5219\u4e0d\u4f1a\u3002</p>\n<h3 id=\"\u5b9e\u9a8c\">\u5b9e\u9a8c<a class=\"headerlink\" href=\"#\u5b9e\u9a8c\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u6765\u5199\u4e00\u6bb5\u7a0b\u5e8f\u6765\u89c2\u5bdf tcache \u7684\u884c\u4e3a\uff0c\u8003\u8651\u5230\u4ece\u94fe\u8868\u5934\u90e8\u63d2\u5165\u548c\u5220\u9664\u662f\u540e\u8fdb\u5148\u51fa\uff08LIFO\uff09\uff0c\u76f8\u5f53\u4e8e\u662f\u4e00\u4e2a\u6808\uff0c\u6240\u4ee5\u5206\u914d\u4e24\u4e2a\u5927\u5c0f\u76f8\u540c\u7684\u5757\uff0c\u91ca\u653e\u540e\u518d\u5206\u914d\u76f8\u540c\u5927\u5c0f\u7684\u5757\uff0c\u5f97\u5230\u7684\u6307\u9488\u7684\u987a\u5e8f\u5e94\u8be5\u662f\u53cd\u8fc7\u6765\u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a>\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-8\"><a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\" href=\"#__codelineno-9-8\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-9\"><a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\" href=\"#__codelineno-9-9\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-10\"><a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\" href=\"#__codelineno-9-10\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-11\"><a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\" href=\"#__codelineno-9-11\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-12\"><a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\" href=\"#__codelineno-9-12\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8f93\u51fa\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"n\">p1</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732a0</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732d0</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732d0</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732a0</span>\n</span></code></pre></div>\n<p>\u7ed3\u679c\u7b26\u5408\u9884\u671f\uff0ctcache \u7684\u5185\u90e8\u72b6\u6001\u53d8\u5316\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li><code>free(p1)</code>\uff1ap1 \u53d8\u6210\u94fe\u8868\u7684\u5934\u90e8</li>\n<li><code>free(p2)</code>\uff1ap2 \u53d8\u6210\u94fe\u8868\u7684\u5934\u90e8\uff0cnext \u6307\u9488\u6307\u5411 p1</li>\n<li><code>p3 = malloc(32)</code>: p2 \u662f\u94fe\u8868\u7684\u5934\u90e8\uff0c\u6240\u4ee5\u88ab\u5206\u914d\u7ed9 p3\uff0c\u4e4b\u540e p1 \u6210\u4e3a\u94fe\u8868\u7684\u5934\u90e8</li>\n<li><code>p4 = malloc(32)</code>: p1 \u662f\u94fe\u8868\u7684\u5934\u90e8\uff0c\u6240\u4ee5\u88ab\u5206\u914d\u7ed9 p4</li>\n</ol>\n<p>\u5982\u679c\u4fee\u6539\u5206\u914d\u7684\u5927\u5c0f\uff0c\u8ba9\u5b83\u4eec\u88ab\u653e\u5230\u4e0d\u540c\u7684 bin\uff0c\u5c31\u4e0d\u4f1a\u51fa\u73b0\u987a\u5e8f\u98a0\u5012\u7684\u60c5\u51b5\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a>\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">48</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">48</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8f93\u51fa\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a><span class=\"n\">p1</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2a0</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2d0</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2a0</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2d0</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230 p3 \u7b49\u4e8e p1\uff0cp4 \u7b49\u4e8e p2\u3002\u6b64\u65f6 p1 \u548c p3 \u5c5e\u4e8e\u540c\u4e00\u4e2a bin\uff0c\u800c p2 \u548c p4 \u5c5e\u4e8e\u53e6\u4e00\u4e2a bin\u3002</p>\n<p>\u65e2\u7136\u6211\u4eec\u77e5\u9053\u4e86 tcache \u7684\u5185\u90e8\u6784\u9020\uff0c\u6211\u4eec\u53ef\u4ee5\u5199\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u9996\u5148\u5f97\u5230 tcache \u7684\u5730\u5740\uff0c\u518d\u6253\u5370\u51fa\u6bcf\u6b21 malloc/free \u4e4b\u540e\u7684\u72b6\u6001\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdint.h&gt;</span>\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-13-3\"><a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\" href=\"#__codelineno-13-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-13-4\"><a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\" href=\"#__codelineno-13-4\"></a>\n</span><span id=\"__span-13-5\"><a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\" href=\"#__codelineno-13-5\"></a><span class=\"cp\">#define TCACHE_MAX_BINS 64</span>\n</span><span id=\"__span-13-6\"><a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\" href=\"#__codelineno-13-6\"></a>\n</span><span id=\"__span-13-7\"><a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\" href=\"#__codelineno-13-7\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-8\"><a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\" href=\"#__codelineno-13-8\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-9\"><a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\" href=\"#__codelineno-13-9\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-10\"><a id=\"__codelineno-13-10\" name=\"__codelineno-13-10\" href=\"#__codelineno-13-10\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_entry</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-11\"><a id=\"__codelineno-13-11\" name=\"__codelineno-13-11\" href=\"#__codelineno-13-11\"></a>\n</span><span id=\"__span-13-12\"><a id=\"__codelineno-13-12\" name=\"__codelineno-13-12\" href=\"#__codelineno-13-12\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-13\"><a id=\"__codelineno-13-13\" name=\"__codelineno-13-13\" href=\"#__codelineno-13-13\"></a><span class=\"w\">  </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-13-14\"><a id=\"__codelineno-13-14\" name=\"__codelineno-13-14\" href=\"#__codelineno-13-14\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-13-15\"><a id=\"__codelineno-13-15\" name=\"__codelineno-13-15\" href=\"#__codelineno-13-15\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_perthread_struct</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-16\"><a id=\"__codelineno-13-16\" name=\"__codelineno-13-16\" href=\"#__codelineno-13-16\"></a>\n</span><span id=\"__span-13-17\"><a id=\"__codelineno-13-17\" name=\"__codelineno-13-17\" href=\"#__codelineno-13-17\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tcache</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-18\"><a id=\"__codelineno-13-18\" name=\"__codelineno-13-18\" href=\"#__codelineno-13-18\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-19\"><a id=\"__codelineno-13-19\" name=\"__codelineno-13-19\" href=\"#__codelineno-13-19\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-20\"><a id=\"__codelineno-13-20\" name=\"__codelineno-13-20\" href=\"#__codelineno-13-20\"></a><span class=\"w\">      </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span>\n</span><span id=\"__span-13-21\"><a id=\"__codelineno-13-21\" name=\"__codelineno-13-21\" href=\"#__codelineno-13-21\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;tcache bin #%d: %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-22\"><a id=\"__codelineno-13-22\" name=\"__codelineno-13-22\" href=\"#__codelineno-13-22\"></a><span class=\"w\">      </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-23\"><a id=\"__codelineno-13-23\" name=\"__codelineno-13-23\" href=\"#__codelineno-13-23\"></a><span class=\"w\">      </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-24\"><a id=\"__codelineno-13-24\" name=\"__codelineno-13-24\" href=\"#__codelineno-13-24\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot; -&gt; %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-25\"><a id=\"__codelineno-13-25\" name=\"__codelineno-13-25\" href=\"#__codelineno-13-25\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-26\"><a id=\"__codelineno-13-26\" name=\"__codelineno-13-26\" href=\"#__codelineno-13-26\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-13-27\"><a id=\"__codelineno-13-27\" name=\"__codelineno-13-27\" href=\"#__codelineno-13-27\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-28\"><a id=\"__codelineno-13-28\" name=\"__codelineno-13-28\" href=\"#__codelineno-13-28\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-13-29\"><a id=\"__codelineno-13-29\" name=\"__codelineno-13-29\" href=\"#__codelineno-13-29\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-13-30\"><a id=\"__codelineno-13-30\" name=\"__codelineno-13-30\" href=\"#__codelineno-13-30\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-13-31\"><a id=\"__codelineno-13-31\" name=\"__codelineno-13-31\" href=\"#__codelineno-13-31\"></a>\n</span><span id=\"__span-13-32\"><a id=\"__codelineno-13-32\" name=\"__codelineno-13-32\" href=\"#__codelineno-13-32\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-33\"><a id=\"__codelineno-13-33\" name=\"__codelineno-13-33\" href=\"#__codelineno-13-33\"></a><span class=\"w\">  </span><span class=\"c1\">// leak tcache address</span>\n</span><span id=\"__span-13-34\"><a id=\"__codelineno-13-34\" name=\"__codelineno-13-34\" href=\"#__codelineno-13-34\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">128</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-35\"><a id=\"__codelineno-13-35\" name=\"__codelineno-13-35\" href=\"#__codelineno-13-35\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p0</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-36\"><a id=\"__codelineno-13-36\" name=\"__codelineno-13-36\" href=\"#__codelineno-13-36\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p0</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-37\"><a id=\"__codelineno-13-37\" name=\"__codelineno-13-37\" href=\"#__codelineno-13-37\"></a><span class=\"w\">  </span><span class=\"n\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-38\"><a id=\"__codelineno-13-38\" name=\"__codelineno-13-38\" href=\"#__codelineno-13-38\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;tcache is at %p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-39\"><a id=\"__codelineno-13-39\" name=\"__codelineno-13-39\" href=\"#__codelineno-13-39\"></a><span class=\"w\">  </span><span class=\"c1\">// clear tcache</span>\n</span><span id=\"__span-13-40\"><a id=\"__codelineno-13-40\" name=\"__codelineno-13-40\" href=\"#__codelineno-13-40\"></a><span class=\"w\">  </span><span class=\"n\">p0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">128</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-41\"><a id=\"__codelineno-13-41\" name=\"__codelineno-13-41\" href=\"#__codelineno-13-41\"></a>\n</span><span id=\"__span-13-42\"><a id=\"__codelineno-13-42\" name=\"__codelineno-13-42\" href=\"#__codelineno-13-42\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-43\"><a id=\"__codelineno-13-43\" name=\"__codelineno-13-43\" href=\"#__codelineno-13-43\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-44\"><a id=\"__codelineno-13-44\" name=\"__codelineno-13-44\" href=\"#__codelineno-13-44\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-45\"><a id=\"__codelineno-13-45\" name=\"__codelineno-13-45\" href=\"#__codelineno-13-45\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after free(p1):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-46\"><a id=\"__codelineno-13-46\" name=\"__codelineno-13-46\" href=\"#__codelineno-13-46\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-47\"><a id=\"__codelineno-13-47\" name=\"__codelineno-13-47\" href=\"#__codelineno-13-47\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-48\"><a id=\"__codelineno-13-48\" name=\"__codelineno-13-48\" href=\"#__codelineno-13-48\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after free(p2):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-49\"><a id=\"__codelineno-13-49\" name=\"__codelineno-13-49\" href=\"#__codelineno-13-49\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-50\"><a id=\"__codelineno-13-50\" name=\"__codelineno-13-50\" href=\"#__codelineno-13-50\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-51\"><a id=\"__codelineno-13-51\" name=\"__codelineno-13-51\" href=\"#__codelineno-13-51\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after malloc(p3):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-52\"><a id=\"__codelineno-13-52\" name=\"__codelineno-13-52\" href=\"#__codelineno-13-52\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-53\"><a id=\"__codelineno-13-53\" name=\"__codelineno-13-53\" href=\"#__codelineno-13-53\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-54\"><a id=\"__codelineno-13-54\" name=\"__codelineno-13-54\" href=\"#__codelineno-13-54\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after malloc(p4):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-55\"><a id=\"__codelineno-13-55\" name=\"__codelineno-13-55\" href=\"#__codelineno-13-55\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-56\"><a id=\"__codelineno-13-56\" name=\"__codelineno-13-56\" href=\"#__codelineno-13-56\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-57\"><a id=\"__codelineno-13-57\" name=\"__codelineno-13-57\" href=\"#__codelineno-13-57\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8fd0\u884c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310010</span>\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-3\"><a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\" href=\"#__codelineno-14-3\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310740</span>\n</span><span id=\"__span-14-4\"><a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\" href=\"#__codelineno-14-4\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-5\"><a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\" href=\"#__codelineno-14-5\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310770</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310740</span>\n</span><span id=\"__span-14-6\"><a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\" href=\"#__codelineno-14-6\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">p3</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-7\"><a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\" href=\"#__codelineno-14-7\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310740</span>\n</span><span id=\"__span-14-8\"><a id=\"__codelineno-14-8\" name=\"__codelineno-14-8\" href=\"#__codelineno-14-8\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">p4</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-9\"><a id=\"__codelineno-14-9\" name=\"__codelineno-14-9\" href=\"#__codelineno-14-9\"></a><span class=\"n\">p1</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310740</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310770</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310770</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310740</span>\n</span></code></pre></div>\n<p>\u6253\u5370\u51fa\u6765\u7684\u7ed3\u679c\u548c\u9884\u671f\u4e00\u81f4\u3002</p>\n<p>\u63a5\u4e0b\u6765\u7ee7\u7eed\u5206\u6790 malloc \u7684\u540e\u7eed\u4ee3\u7801\u3002</p>\n<h2 id=\"\u56de\u5230-__libc_malloc\">\u56de\u5230 <code>__libc_malloc</code><a class=\"headerlink\" href=\"#\u56de\u5230-__libc_malloc\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5982\u679c malloc \u6ca1\u6709\u547d\u4e2d tcache\uff0c\u6216\u8005 free \u6ca1\u6709\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache \u5f53\u4e2d\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u4e8b\u60c5\u5462\uff1f\u63a5\u4e0b\u6765\u5f80\u540e\u770b\uff0c\u9996\u5148\u662f <code>__libc_malloc</code> \u7684\u540e\u7eed\u5b9e\u73b0\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_int_malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a><span class=\"w\">    </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-15-5\"><a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\" href=\"#__codelineno-15-5\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-6\"><a id=\"__codelineno-15-6\" name=\"__codelineno-15-6\" href=\"#__codelineno-15-6\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-15-7\"><a id=\"__codelineno-15-7\" name=\"__codelineno-15-7\" href=\"#__codelineno-15-7\"></a>\n</span><span id=\"__span-15-8\"><a id=\"__codelineno-15-8\" name=\"__codelineno-15-8\" href=\"#__codelineno-15-8\"></a><span class=\"n\">arena_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ar_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-15-9\"><a id=\"__codelineno-15-9\" name=\"__codelineno-15-9\" href=\"#__codelineno-15-9\"></a>\n</span><span id=\"__span-15-10\"><a id=\"__codelineno-15-10\" name=\"__codelineno-15-10\" href=\"#__codelineno-15-10\"></a><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_int_malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ar_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u51fa\u73b0\u4e86 arena \u7684\u6982\u5ff5\uff1a\u591a\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u63d0\u5347\u6027\u80fd\uff0c\u540c\u65f6\u7528\u591a\u4e2a arena\uff0c\u6bcf\u4e2a arena \u7528\u4e00\u628a\u9501\u6765\u4fdd\u8bc1\u591a\u7ebf\u7a0b\u5b89\u5168\uff0c\u4ece\u800c\u4f7f\u5f97\u591a\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u540c\u65f6\u4ece\u4e0d\u540c\u7684 arena \u4e2d\u5206\u914d\u5185\u5b58\u3002\u8fd9\u91cc\u5148\u4e0d\u8ba8\u8bba\u591a\u7ebf\u7a0b\u7684\u60c5\u51b5\uff0c\u5148\u5047\u8bbe\u5728\u5355\u7ebf\u7a0b\u7a0b\u5e8f\u4e0b\uff0c\u5168\u5c40\u53ea\u7528\u4e00\u4e2a arena\uff1a<code>main_arena</code>\uff0c\u7136\u540e\u4ece\u91cc\u9762\u5206\u914d\u5185\u5b58\u3002\u63a5\u4e0b\u6765\u770b <code>_int_malloc</code> \u7684\u5185\u90e8\u5b9e\u73b0\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u6839\u636e\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\u8fdb\u5165\u4e86\u4e0d\u540c\u7684\u5904\u7406\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-16-1\"><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\" href=\"#__codelineno-16-1\"></a><span class=\"c1\">// in _int_malloc</span>\n</span><span id=\"__span-16-2\"><a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\" href=\"#__codelineno-16-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">get_max_fast</span><span class=\"w\"> </span><span class=\"p\">()))</span>\n</span><span id=\"__span-16-3\"><a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\" href=\"#__codelineno-16-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-4\"><a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\" href=\"#__codelineno-16-4\"></a><span class=\"w\">    </span><span class=\"c1\">// fast bin handling</span>\n</span><span id=\"__span-16-5\"><a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\" href=\"#__codelineno-16-5\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-16-6\"><a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\" href=\"#__codelineno-16-6\"></a>\n</span><span id=\"__span-16-7\"><a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\" href=\"#__codelineno-16-7\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-16-8\"><a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\" href=\"#__codelineno-16-8\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-9\"><a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\" href=\"#__codelineno-16-9\"></a><span class=\"w\">    </span><span class=\"c1\">// small bin handling</span>\n</span><span id=\"__span-16-10\"><a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\" href=\"#__codelineno-16-10\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-16-11\"><a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\" href=\"#__codelineno-16-11\"></a><span class=\"k\">else</span>\n</span><span id=\"__span-16-12\"><a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\" href=\"#__codelineno-16-12\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-13\"><a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\" href=\"#__codelineno-16-13\"></a><span class=\"w\">    </span><span class=\"c1\">// consolidate fast bins to unsorted bins</span>\n</span><span id=\"__span-16-14\"><a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\" href=\"#__codelineno-16-14\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-16-15\"><a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\" href=\"#__codelineno-16-15\"></a>\n</span><span id=\"__span-16-16\"><a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\" href=\"#__codelineno-16-16\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(;;</span><span class=\"w\"> </span><span class=\"p\">)</span>\n</span><span id=\"__span-16-17\"><a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\" href=\"#__codelineno-16-17\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-18\"><a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\" href=\"#__codelineno-16-18\"></a><span class=\"w\">    </span><span class=\"c1\">// process unsorted bins</span>\n</span><span id=\"__span-16-19\"><a id=\"__codelineno-16-19\" name=\"__codelineno-16-19\" href=\"#__codelineno-16-19\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>malloc \u628a\u7a7a\u95f2\u7684\u5757\u5206\u6210\u56db\u79cd\u7c7b\u578b\u6765\u4fdd\u5b58\uff1a</p>\n<ol>\n<li>fast bin: \u7c7b\u4f3c\u524d\u9762\u7684 tcache bin\uff0c\u628a\u5927\u5c0f\u76f8\u540c\u7684\u7a7a\u95f2\u5757\u653e\u5230\u94fe\u8868\u4e2d\uff0c\u518d\u7ef4\u62a4\u591a\u4e2a\u5bf9\u5e94\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u7684\u94fe\u8868\u5934\u6307\u9488\uff0c\u91c7\u7528\u5355\u5411\u94fe\u8868\u7ef4\u62a4</li>\n<li>small bin\uff1asmall bin \u4e5f\u4f1a\u628a\u76f8\u540c\u7684\u7a7a\u95f2\u5757\u653e\u5728\u94fe\u8868\u4e2d\uff0c\u4f46\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u4f1a\u88ab\u5408\u5e76\u4e3a\u66f4\u5927\u7684\u7a7a\u95f2\u5757\uff0c\u91c7\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4</li>\n<li>large bin\uff1alarge bin \u53ef\u80fd\u4fdd\u5b58\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u91c7\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4</li>\n<li>unsorted bin\uff1a\u8fd1\u671f\u88ab free \u7684\u7a7a\u95f2\u5757\uff0c\u5982\u679c\u6ca1\u6709\u4fdd\u5b58\u5230 tcache\uff0c\u4f1a\u88ab\u653e\u5230 unsorted bin \u5f53\u4e2d\uff0c\u7559\u5f85\u540e\u7eed\u7684\u5904\u7406</li>\n</ol>\n<p>\u5728\u8ba8\u8bba\u8fd9\u4e9b bin \u7684\u7ef4\u62a4\u65b9\u5f0f\u4e4b\u524d\uff0c\u9996\u5148\u8981\u77e5\u9053 glibc \u662f\u600e\u4e48\u7ef4\u62a4\u5757\u7684\uff1a\u7a7a\u95f2\u7684\u65f6\u5019\u662f\u4ec0\u4e48\u5e03\u5c40\uff0c\u88ab\u5206\u914d\u7684\u65f6\u5019\u53c8\u662f\u4ec0\u4e48\u5e03\u5c40\uff1f</p>\n<h2 id=\"\u5757\u5e03\u5c40\">\u5757\u5e03\u5c40<a class=\"headerlink\" href=\"#\u5757\u5e03\u5c40\" title=\"Permanent link\">&para;</a></h2>\n<p>glibc \u6bcf\u4e2a\u7a7a\u95f2\u5757\uff08chunk\uff09\u5bf9\u5e94\u4e86\u4e0b\u9762\u7684\u7ed3\u6784\u4f53 <code>malloc_chunk</code>\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-17-1\"><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\" href=\"#__codelineno-17-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-2\"><a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\" href=\"#__codelineno-17-2\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\">      </span><span class=\"n\">mchunk_prev_size</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"cm\">/* Size of previous chunk (if free).  */</span>\n</span><span id=\"__span-17-3\"><a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\" href=\"#__codelineno-17-3\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\">      </span><span class=\"n\">mchunk_size</span><span class=\"p\">;</span><span class=\"w\">       </span><span class=\"cm\">/* Size in bytes, including overhead. */</span>\n</span><span id=\"__span-17-4\"><a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\" href=\"#__codelineno-17-4\"></a>\n</span><span id=\"__span-17-5\"><a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\" href=\"#__codelineno-17-5\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span><span class=\"w\">         </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-17-6\"><a id=\"__codelineno-17-6\" name=\"__codelineno-17-6\" href=\"#__codelineno-17-6\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-7\"><a id=\"__codelineno-17-7\" name=\"__codelineno-17-7\" href=\"#__codelineno-17-7\"></a>\n</span><span id=\"__span-17-8\"><a id=\"__codelineno-17-8\" name=\"__codelineno-17-8\" href=\"#__codelineno-17-8\"></a><span class=\"w\">  </span><span class=\"cm\">/* Only used for large blocks: pointer to next larger size.  */</span>\n</span><span id=\"__span-17-9\"><a id=\"__codelineno-17-9\" name=\"__codelineno-17-9\" href=\"#__codelineno-17-9\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-17-10\"><a id=\"__codelineno-17-10\" name=\"__codelineno-17-10\" href=\"#__codelineno-17-10\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-11\"><a id=\"__codelineno-17-11\" name=\"__codelineno-17-11\" href=\"#__codelineno-17-11\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u5b57\u6bb5\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u76f8\u90bb\u7684\u524d\u4e00\u4e2a\u7a7a\u95f2\u5757\u7684\u5927\u5c0f <code>mchunk_prev_size</code>\uff0c\u8bb0\u5f55\u5b83\u662f\u4e3a\u4e86\u65b9\u4fbf\u627e\u5230\u524d\u4e00\u4e2a\u7a7a\u95f2\u5757\u7684\u5f00\u5934\uff0c\u8fd9\u6837\u5408\u5e76\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u5c31\u5f88\u7b80\u5355</li>\n<li>\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u5927\u5c0f <code>mchunk_size</code>\uff0c\u7531\u4e8e\u5757\u7684\u5927\u5c0f\u662f\u5bf9\u9f50\u7684\uff0c\u6240\u4ee5\u5b83\u7684\u4f4e\u4f4d\u88ab\u7528\u6765\u8bb0\u5f55 flag</li>\n<li><code>fd</code> \u548c <code>bk</code>\uff1asmall bin \u548c large bin \u9700\u8981\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\u7a7a\u95f2\u5757\uff0c\u6307\u9488\u5c31\u4fdd\u5b58\u5728\u8fd9\u91cc</li>\n<li><code>fd_nextsize</code> \u548c <code>bk_next_size</code>\uff1alarge bin \u9700\u8981\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u65b9\u4fbf\u627e\u5230\u5408\u9002\u5927\u5c0f\u7684\u7a7a\u95f2\u5757</li>\n</ol>\n<p>\u8fd9\u662f\u7a7a\u95f2\u5757\u7684\u5185\u5b58\u5e03\u5c40\uff0c\u90a3\u4e48\u88ab\u5206\u914d\u7684\u5185\u5b58\u5462\uff1f\u88ab\u5206\u914d\u7684\u5185\u5b58\uff0c\u76f8\u5f53\u4e8e\u662f\u5982\u4e0b\u7684\u7ed3\u6784\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-18-1\"><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\" href=\"#__codelineno-18-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-18-2\"><a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\" href=\"#__codelineno-18-2\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\">      </span><span class=\"n\">mchunk_size</span><span class=\"p\">;</span><span class=\"w\">       </span><span class=\"cm\">/* Size in bytes, including overhead. */</span>\n</span><span id=\"__span-18-3\"><a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\" href=\"#__codelineno-18-3\"></a><span class=\"w\">  </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">payload</span><span class=\"p\">[];</span><span class=\"w\">                         </span><span class=\"cm\">/* malloc() returns pointer to payload */</span>\n</span><span id=\"__span-18-4\"><a id=\"__codelineno-18-4\" name=\"__codelineno-18-4\" href=\"#__codelineno-18-4\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c<code>malloc()</code> \u8fd4\u56de\u7684\u5730\u5740\uff0c\u7b49\u4e8e\u7a7a\u95f2\u5757\u91cc <code>fd</code> \u6240\u5728\u7684\u4f4d\u7f6e\u3002\u88ab\u5206\u914d\u7684\u5757\uff0c\u9664\u4e86\u7528\u6237\u8bf7\u6c42\u7684\u7a7a\u95f4\u4ee5\u5916\uff0c\u53ea\u6709\u524d\u9762\u7684 <code>sizeof(size_t)</code> \u5927\u5c0f\u7684\u7a7a\u95f4\u662f\u5185\u5b58\u5206\u914d\u5668\u5e26\u6765\u7684\u7a7a\u95f4\u5f00\u9500\u3002\u5757\u88ab\u91ca\u653e\u4ee5\u540e\uff0c\u5b83\u88ab\u91cd\u65b0\u89e3\u91ca\u6210 <code>malloc_chunk</code> \u7ed3\u6784\u4f53\uff08\u6ce8\u610f\u5b83\u4eec\u7684\u8d77\u59cb\u5730\u5740\u4e0d\u540c\uff0c<code>malloc_chunk</code> \u7684\u5730\u5740\u662f malloc \u8fd4\u56de\u7684 <code>payload</code> \u5730\u5740\u51cf\u53bb <code>2 * sizeof(size_t)</code>\uff0c\u5bf9\u5e94 <code>mchunk_prev_size</code> \u548c <code>mchunk_size</code> \u4e24\u4e2a\u5b57\u6bb5\uff09\u3002\u4e8b\u5b9e\u4e0a\uff0c<code>mchunk_prev_size</code> \u4fdd\u5b58\u5728\u7528\u6237\u8bf7\u6c42\u7684\u7a7a\u95f4\u7684\u6700\u540e\u51e0\u4e2a\u5b57\u8282\u3002\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-19-1\"><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\" href=\"#__codelineno-19-1\"></a> in-use chunk         free chunk\n</span><span id=\"__span-19-2\"><a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\" href=\"#__codelineno-19-2\"></a>+-------------+      +------------------+\n</span><span id=\"__span-19-3\"><a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\" href=\"#__codelineno-19-3\"></a>| mchunk_size |      | mchunk_size      |\n</span><span id=\"__span-19-4\"><a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\" href=\"#__codelineno-19-4\"></a>+-------------+      +------------------+\n</span><span id=\"__span-19-5\"><a id=\"__codelineno-19-5\" name=\"__codelineno-19-5\" href=\"#__codelineno-19-5\"></a>| payload     |      | fd               |\n</span><span id=\"__span-19-6\"><a id=\"__codelineno-19-6\" name=\"__codelineno-19-6\" href=\"#__codelineno-19-6\"></a>|             |      +------------------+\n</span><span id=\"__span-19-7\"><a id=\"__codelineno-19-7\" name=\"__codelineno-19-7\" href=\"#__codelineno-19-7\"></a>|             |      | bk               |\n</span><span id=\"__span-19-8\"><a id=\"__codelineno-19-8\" name=\"__codelineno-19-8\" href=\"#__codelineno-19-8\"></a>|             |      +------------------+\n</span><span id=\"__span-19-9\"><a id=\"__codelineno-19-9\" name=\"__codelineno-19-9\" href=\"#__codelineno-19-9\"></a>|             |      | fd_nextsize      |\n</span><span id=\"__span-19-10\"><a id=\"__codelineno-19-10\" name=\"__codelineno-19-10\" href=\"#__codelineno-19-10\"></a>|             | ---&gt; +------------------+\n</span><span id=\"__span-19-11\"><a id=\"__codelineno-19-11\" name=\"__codelineno-19-11\" href=\"#__codelineno-19-11\"></a>|             |      | bk_nextsize      |\n</span><span id=\"__span-19-12\"><a id=\"__codelineno-19-12\" name=\"__codelineno-19-12\" href=\"#__codelineno-19-12\"></a>|             |      +------------------+\n</span><span id=\"__span-19-13\"><a id=\"__codelineno-19-13\" name=\"__codelineno-19-13\" href=\"#__codelineno-19-13\"></a>|             |      | unused           |\n</span><span id=\"__span-19-14\"><a id=\"__codelineno-19-14\" name=\"__codelineno-19-14\" href=\"#__codelineno-19-14\"></a>|             |      |                  |\n</span><span id=\"__span-19-15\"><a id=\"__codelineno-19-15\" name=\"__codelineno-19-15\" href=\"#__codelineno-19-15\"></a>|             |      |                  |\n</span><span id=\"__span-19-16\"><a id=\"__codelineno-19-16\" name=\"__codelineno-19-16\" href=\"#__codelineno-19-16\"></a>|             |      |                  |\n</span><span id=\"__span-19-17\"><a id=\"__codelineno-19-17\" name=\"__codelineno-19-17\" href=\"#__codelineno-19-17\"></a>|             |      +------------------+\n</span><span id=\"__span-19-18\"><a id=\"__codelineno-19-18\" name=\"__codelineno-19-18\" href=\"#__codelineno-19-18\"></a>|             |      | mchunk_prev_size |\n</span><span id=\"__span-19-19\"><a id=\"__codelineno-19-19\" name=\"__codelineno-19-19\" href=\"#__codelineno-19-19\"></a>+-------------+      +------------------+\n</span></code></pre></div>\n<p>\u56e0\u6b64\u4e3a\u4e86\u5728 payload \u548c <code>malloc_chunk</code> \u6307\u9488\u4e4b\u95f4\u8f6c\u6362\uff0c\u4ee3\u7801\u4e2d\u8bbe\u8ba1\u4e86\u4e24\u4e2a\u5b8f\u6765\u7b80\u5316\u6307\u9488\u8fd0\u7b97\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-20-1\"><a id=\"__codelineno-20-1\" name=\"__codelineno-20-1\" href=\"#__codelineno-20-1\"></a><span class=\"cm\">/* conversion from malloc headers to user pointers, and back */</span>\n</span><span id=\"__span-20-2\"><a id=\"__codelineno-20-2\" name=\"__codelineno-20-2\" href=\"#__codelineno-20-2\"></a>\n</span><span id=\"__span-20-3\"><a id=\"__codelineno-20-3\" name=\"__codelineno-20-3\" href=\"#__codelineno-20-3\"></a><span class=\"cp\">#define chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span>\n</span><span id=\"__span-20-4\"><a id=\"__codelineno-20-4\" name=\"__codelineno-20-4\" href=\"#__codelineno-20-4\"></a><span class=\"cp\">#define mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span>\n</span></code></pre></div>\n<p>\u77e5\u9053\u4e86\u7a7a\u95f2\u5757\u7684\u7ef4\u62a4\u65b9\u5f0f\uff0c\u7531\u4e8e\u5404\u4e2a bin \u7ef4\u62a4\u7684\u5c31\u662f\u8fd9\u4e9b\u7a7a\u95f2\u5757\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u5206\u522b\u770b\u8fd9\u51e0\u79cd bin \u7684\u7ef4\u62a4\u65b9\u5f0f\u3002</p>\n<h2 id=\"fast-bin\">fast bin<a class=\"headerlink\" href=\"#fast-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>fast bin \u7684\u7ef4\u62a4\u65b9\u5f0f\u548c tcache \u7c7b\u4f3c\uff0c\u5b83\u628a\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u6309\u7167\u5927\u5c0f\u5206\u6210\u591a\u4e2a bin\uff0c\u6bcf\u4e2a bin \u8bb0\u5f55\u5728\u4e00\u4e2a\u5355\u5411\u94fe\u8868\u5f53\u4e2d\uff0c\u7136\u540e\u7528\u4e00\u4e2a\u6570\u7ec4\u8bb0\u5f55\u5404\u79cd bin \u5927\u5c0f\u7684\u94fe\u8868\u5934\uff0c\u8fd9\u91cc\u76f4\u63a5\u7528\u7684\u5c31\u662f <code>malloc_chunk</code> \u6307\u9488\u6570\u7ec4\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-21-1\"><a id=\"__codelineno-21-1\" name=\"__codelineno-21-1\" href=\"#__codelineno-21-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">mfastbinptr</span><span class=\"p\">;</span>\n</span><span id=\"__span-21-2\"><a id=\"__codelineno-21-2\" name=\"__codelineno-21-2\" href=\"#__codelineno-21-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span>\n</span><span id=\"__span-21-3\"><a id=\"__codelineno-21-3\" name=\"__codelineno-21-3\" href=\"#__codelineno-21-3\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-21-4\"><a id=\"__codelineno-21-4\" name=\"__codelineno-21-4\" href=\"#__codelineno-21-4\"></a><span class=\"w\">  </span><span class=\"cm\">/* other fields are omitted */</span>\n</span><span id=\"__span-21-5\"><a id=\"__codelineno-21-5\" name=\"__codelineno-21-5\" href=\"#__codelineno-21-5\"></a><span class=\"w\">  </span><span class=\"cm\">/* Fastbins */</span>\n</span><span id=\"__span-21-6\"><a id=\"__codelineno-21-6\" name=\"__codelineno-21-6\" href=\"#__codelineno-21-6\"></a><span class=\"w\">  </span><span class=\"n\">mfastbinptr</span><span class=\"w\"> </span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">NFASTBINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-21-7\"><a id=\"__codelineno-21-7\" name=\"__codelineno-21-7\" href=\"#__codelineno-21-7\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5728 64 \u4f4d\u4e0b\uff0c\u9ed8\u8ba4 <code>NFASTBINS</code> \u7b49\u4e8e 10\uff0c\u8ba1\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u6700\u5927\u7684\u7531 fast bin \u7ba1\u7406\u7684\u5757\u5927\u5c0f\u7b49\u4e8e <code>80 * sizeof(size_t) / 4 + sizeof(size_t)</code> \u5411\u4e0a\u53d6\u6574\u5230 16 \u7684\u500d\u6570\uff0c\u5728 64 \u4f4d\u673a\u5668\u4e0a\u7b49\u4e8e 176 \u5b57\u8282</li>\n<li>\u5206\u914d\u7c92\u5ea6\u4ece\u6700\u5c0f\u7684 32 \u5b57\u8282\u5230\u6700\u5927\u7684 176 \u5b57\u8282\uff0c\u6bcf 16 \u5b57\u8282\u4e00\u4e2a bin\uff0c\u4e00\u5171\u6709 10 \u4e2a bin\uff08<code>(176 - 32) / 16 + 1 = 10</code>\uff09</li>\n</ol>\n<p>\u4e0d\u8fc7\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cfast bin \u7ba1\u7406\u7684\u5757\u5927\u5c0f\u901a\u8fc7 <code>set_max_fast(DEFAULT_MXFAST)</code> \u88ab\u9650\u5236\u5728 <code>DEFAULT_MXFAST</code> \u9644\u8fd1\uff0c\u8fd9\u4e2a\u503c\u7b49\u4e8e <code>64 * sizeof(size_t) / 4</code>\uff0c\u52a0\u4e0a <code>sizeof(size_t)</code> \u518d\u5411\u4e0b\u53d6\u6574\u5230 16 \u7684\u500d\u6570\uff0c\u5c31\u662f 128 \u5b57\u8282\u3002\u6b64\u65f6\uff0c\u53ea\u6709\u524d 7 \u4e2a bin \u53ef\u4ee5\u88ab\u7528\u5230\uff0832 \u5b57\u8282\u5230 128 \u5b57\u8282\uff0c\u6bcf 16 \u5b57\u8282\u4e00\u4e2a bin\uff0c<code>(128 - 32) / 16 + 1 = 7</code>\uff09\uff0c\u5373 <code>malloc(120)</code> \u6216\u66f4\u5c0f\u7684\u5206\u914d\u4f1a\u4fdd\u5b58\u5230 fast bin \u4e2d\uff0c<code>malloc(121)</code> \u6216\u66f4\u5927\u7684\u5206\u914d\u5219\u4e0d\u4f1a\u3002</p>\n<h3 id=\"malloc_2\">malloc<a class=\"headerlink\" href=\"#malloc_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5206\u914d\u7684\u65f6\u5019\uff0c\u548c tcache \u7c7b\u4f3c\uff0c\u4e5f\u662f\u8ba1\u7b97\u51fa fastbin \u7684 index\uff0c\u7136\u540e\u53bb\u627e\u5bf9\u5e94\u7684\u94fe\u8868\uff0c\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u5219\u4ece\u94fe\u8868\u5934\u53d6\u51fa\u7a7a\u95f2\u5757\u7528\u4e8e\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-22-1\"><a id=\"__codelineno-22-1\" name=\"__codelineno-22-1\" href=\"#__codelineno-22-1\"></a><span class=\"cp\">#define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span>\n</span><span id=\"__span-22-2\"><a id=\"__codelineno-22-2\" name=\"__codelineno-22-2\" href=\"#__codelineno-22-2\"></a>\n</span><span id=\"__span-22-3\"><a id=\"__codelineno-22-3\" name=\"__codelineno-22-3\" href=\"#__codelineno-22-3\"></a><span class=\"cm\">/* offset 2 to use otherwise unindexable first 2 bins */</span>\n</span><span id=\"__span-22-4\"><a id=\"__codelineno-22-4\" name=\"__codelineno-22-4\" href=\"#__codelineno-22-4\"></a><span class=\"cp\">#define fastbin_index(sz) \\</span>\n</span><span id=\"__span-22-5\"><a id=\"__codelineno-22-5\" name=\"__codelineno-22-5\" href=\"#__codelineno-22-5\"></a><span class=\"cp\">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>\n</span><span id=\"__span-22-6\"><a id=\"__codelineno-22-6\" name=\"__codelineno-22-6\" href=\"#__codelineno-22-6\"></a>\n</span><span id=\"__span-22-7\"><a id=\"__codelineno-22-7\" name=\"__codelineno-22-7\" href=\"#__codelineno-22-7\"></a><span class=\"c1\">// in _int_malloc, allocate using fastbin</span>\n</span><span id=\"__span-22-8\"><a id=\"__codelineno-22-8\" name=\"__codelineno-22-8\" href=\"#__codelineno-22-8\"></a><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fastbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-9\"><a id=\"__codelineno-22-9\" name=\"__codelineno-22-9\" href=\"#__codelineno-22-9\"></a><span class=\"n\">mfastbinptr</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-10\"><a id=\"__codelineno-22-10\" name=\"__codelineno-22-10\" href=\"#__codelineno-22-10\"></a><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-11\"><a id=\"__codelineno-22-11\" name=\"__codelineno-22-11\" href=\"#__codelineno-22-11\"></a><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-12\"><a id=\"__codelineno-22-12\" name=\"__codelineno-22-12\" href=\"#__codelineno-22-12\"></a>\n</span><span id=\"__span-22-13\"><a id=\"__codelineno-22-13\" name=\"__codelineno-22-13\" href=\"#__codelineno-22-13\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-14\"><a id=\"__codelineno-22-14\" name=\"__codelineno-22-14\" href=\"#__codelineno-22-14\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-15\"><a id=\"__codelineno-22-15\" name=\"__codelineno-22-15\" href=\"#__codelineno-22-15\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-16\"><a id=\"__codelineno-22-16\" name=\"__codelineno-22-16\" href=\"#__codelineno-22-16\"></a><span class=\"w\">      </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-17\"><a id=\"__codelineno-22-17\" name=\"__codelineno-22-17\" href=\"#__codelineno-22-17\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-22-18\"><a id=\"__codelineno-22-18\" name=\"__codelineno-22-18\" href=\"#__codelineno-22-18\"></a><span class=\"w\">      </span><span class=\"n\">REMOVE_FB</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-19\"><a id=\"__codelineno-22-19\" name=\"__codelineno-22-19\" href=\"#__codelineno-22-19\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_likely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">))</span>\n</span><span id=\"__span-22-20\"><a id=\"__codelineno-22-20\" name=\"__codelineno-22-20\" href=\"#__codelineno-22-20\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-21\"><a id=\"__codelineno-22-21\" name=\"__codelineno-22-21\" href=\"#__codelineno-22-21\"></a><span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">victim_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fastbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">));</span>\n</span><span id=\"__span-22-22\"><a id=\"__codelineno-22-22\" name=\"__codelineno-22-22\" href=\"#__codelineno-22-22\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__builtin_expect</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim_idx</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n</span><span id=\"__span-22-23\"><a id=\"__codelineno-22-23\" name=\"__codelineno-22-23\" href=\"#__codelineno-22-23\"></a><span class=\"w\">          </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): memory corruption (fast)&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-24\"><a id=\"__codelineno-22-24\" name=\"__codelineno-22-24\" href=\"#__codelineno-22-24\"></a><span class=\"w\">        </span><span class=\"n\">check_remalloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-25\"><a id=\"__codelineno-22-25\" name=\"__codelineno-22-25\" href=\"#__codelineno-22-25\"></a><span class=\"w\">        </span><span class=\"cm\">/* While we&#39;re here, if we see other chunks of the same size,</span>\n</span><span id=\"__span-22-26\"><a id=\"__codelineno-22-26\" name=\"__codelineno-22-26\" href=\"#__codelineno-22-26\"></a><span class=\"cm\">          stash them in the tcache.  */</span>\n</span><span id=\"__span-22-27\"><a id=\"__codelineno-22-27\" name=\"__codelineno-22-27\" href=\"#__codelineno-22-27\"></a><span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-28\"><a id=\"__codelineno-22-28\" name=\"__codelineno-22-28\" href=\"#__codelineno-22-28\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-29\"><a id=\"__codelineno-22-29\" name=\"__codelineno-22-29\" href=\"#__codelineno-22-29\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-30\"><a id=\"__codelineno-22-30\" name=\"__codelineno-22-30\" href=\"#__codelineno-22-30\"></a><span class=\"w\">            </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-31\"><a id=\"__codelineno-22-31\" name=\"__codelineno-22-31\" href=\"#__codelineno-22-31\"></a>\n</span><span id=\"__span-22-32\"><a id=\"__codelineno-22-32\" name=\"__codelineno-22-32\" href=\"#__codelineno-22-32\"></a><span class=\"w\">            </span><span class=\"cm\">/* While bin not empty and tcache not full, copy chunks.  */</span>\n</span><span id=\"__span-22-33\"><a id=\"__codelineno-22-33\" name=\"__codelineno-22-33\" href=\"#__codelineno-22-33\"></a><span class=\"w\">            </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span>\n</span><span id=\"__span-22-34\"><a id=\"__codelineno-22-34\" name=\"__codelineno-22-34\" href=\"#__codelineno-22-34\"></a><span class=\"w\">                  </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-35\"><a id=\"__codelineno-22-35\" name=\"__codelineno-22-35\" href=\"#__codelineno-22-35\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-36\"><a id=\"__codelineno-22-36\" name=\"__codelineno-22-36\" href=\"#__codelineno-22-36\"></a><span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-37\"><a id=\"__codelineno-22-37\" name=\"__codelineno-22-37\" href=\"#__codelineno-22-37\"></a><span class=\"w\">                  </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-38\"><a id=\"__codelineno-22-38\" name=\"__codelineno-22-38\" href=\"#__codelineno-22-38\"></a><span class=\"w\">                </span><span class=\"k\">else</span>\n</span><span id=\"__span-22-39\"><a id=\"__codelineno-22-39\" name=\"__codelineno-22-39\" href=\"#__codelineno-22-39\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-40\"><a id=\"__codelineno-22-40\" name=\"__codelineno-22-40\" href=\"#__codelineno-22-40\"></a><span class=\"w\">                    </span><span class=\"n\">REMOVE_FB</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-41\"><a id=\"__codelineno-22-41\" name=\"__codelineno-22-41\" href=\"#__codelineno-22-41\"></a><span class=\"w\">                    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">))</span>\n</span><span id=\"__span-22-42\"><a id=\"__codelineno-22-42\" name=\"__codelineno-22-42\" href=\"#__codelineno-22-42\"></a><span class=\"w\">                      </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-43\"><a id=\"__codelineno-22-43\" name=\"__codelineno-22-43\" href=\"#__codelineno-22-43\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-44\"><a id=\"__codelineno-22-44\" name=\"__codelineno-22-44\" href=\"#__codelineno-22-44\"></a><span class=\"w\">                </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-45\"><a id=\"__codelineno-22-45\" name=\"__codelineno-22-45\" href=\"#__codelineno-22-45\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-46\"><a id=\"__codelineno-22-46\" name=\"__codelineno-22-46\" href=\"#__codelineno-22-46\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-47\"><a id=\"__codelineno-22-47\" name=\"__codelineno-22-47\" href=\"#__codelineno-22-47\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-48\"><a id=\"__codelineno-22-48\" name=\"__codelineno-22-48\" href=\"#__codelineno-22-48\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-49\"><a id=\"__codelineno-22-49\" name=\"__codelineno-22-49\" href=\"#__codelineno-22-49\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-50\"><a id=\"__codelineno-22-50\" name=\"__codelineno-22-50\" href=\"#__codelineno-22-50\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-51\"><a id=\"__codelineno-22-51\" name=\"__codelineno-22-51\" href=\"#__codelineno-22-51\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 <code>fastbin_index (nb)</code> \u6839\u636e\u5757\u7684\u5927\u5c0f\u8ba1\u7b97\u51fa fast bin \u7684 index\uff0c\u7136\u540e <code>fastbin (av, idx)</code> \u5bf9\u5e94 fast bin \u7684\u94fe\u8868\u5934\u6307\u9488</li>\n<li>\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u8bf4\u660e\u53ef\u4ee5\u4ece fast bin \u5206\u914d\u7a7a\u95f2\u5757\uff0c\u6b64\u65f6\u5c31\u628a\u94fe\u8868\u5934\u7684\u7ed3\u70b9\u5f39\u51fa\uff1a<code>*fb = victim-&gt;fd</code>\uff08\u5355\u7ebf\u7a0b\uff09\u6216 <code>REMOVE_FB (fb, pp, victim)</code>\uff08\u591a\u7ebf\u7a0b\uff09\uff1b\u53ea\u7528\u5230\u4e86\u5355\u5411\u94fe\u8868\u7684 <code>fd</code> \u6307\u9488\uff0c\u5176\u4f59\u7684\u5b57\u6bb5\u6ca1\u6709\u7528\u5230</li>\n<li>\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u5b89\u5168\u68c0\u67e5\uff1a<code>__builtin_expect</code> \u548c <code>check_remalloced_chunk</code></li>\n<li>\u68c0\u67e5 tcache \u5bf9\u5e94\u7684 bin\uff0c\u5982\u679c\u5b83\u8fd8\u6ca1\u6709\u6ee1\uff0c\u5c31\u628a fast bin \u94fe\u8868\u4e2d\u7684\u5143\u7d20\u632a\u5230 tcache \u5f53\u4e2d</li>\n<li>\u628a payload \u5730\u5740\u901a\u8fc7 <code>chunk2mem</code> \u8ba1\u7b97\u51fa\u6765\uff0c\u8fd4\u56de\u7ed9 malloc \u8c03\u7528\u8005</li>\n<li>\u8c03\u7528 <code>alloc_perturb</code> \u5f80\u65b0\u5206\u914d\u7684\u7a7a\u95f4\u5185\u5199\u5165\u5783\u573e\u6570\u636e\uff08\u53ef\u9009\uff09\uff0c\u907f\u514d\u6cc4\u9732\u4e4b\u524d\u7684\u6570\u636e</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6bd4\u8f83\u7b80\u5355\uff0c\u548c tcache \u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u5b83\u4ece thread local \u7684 tcache \u6539\u6210\u4e86\u652f\u6301\u591a\u7ebf\u7a0b\u7684\u7248\u672c\uff0c\u540c\u65f6\u4e3a\u4e86\u652f\u6301\u591a\u7ebf\u7a0b\u8bbf\u95ee\uff0c\u4f7f\u7528 CAS \u539f\u5b50\u6307\u4ee4\u6765\u66f4\u65b0\u94fe\u8868\u5934\u90e8\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-23-1\"><a id=\"__codelineno-23-1\" name=\"__codelineno-23-1\" href=\"#__codelineno-23-1\"></a><span class=\"cp\">#define REMOVE_FB(fb, victim, pp) \\</span>\n</span><span id=\"__span-23-2\"><a id=\"__codelineno-23-2\" name=\"__codelineno-23-2\" href=\"#__codelineno-23-2\"></a><span class=\"cp\">  do                              \\</span>\n</span><span id=\"__span-23-3\"><a id=\"__codelineno-23-3\" name=\"__codelineno-23-3\" href=\"#__codelineno-23-3\"></a><span class=\"cp\">    {                             \\</span>\n</span><span id=\"__span-23-4\"><a id=\"__codelineno-23-4\" name=\"__codelineno-23-4\" href=\"#__codelineno-23-4\"></a><span class=\"cp\">      victim = pp;                \\</span>\n</span><span id=\"__span-23-5\"><a id=\"__codelineno-23-5\" name=\"__codelineno-23-5\" href=\"#__codelineno-23-5\"></a><span class=\"cp\">      if (victim == NULL)         \\</span>\n</span><span id=\"__span-23-6\"><a id=\"__codelineno-23-6\" name=\"__codelineno-23-6\" href=\"#__codelineno-23-6\"></a><span class=\"cp\">        break;                    \\</span>\n</span><span id=\"__span-23-7\"><a id=\"__codelineno-23-7\" name=\"__codelineno-23-7\" href=\"#__codelineno-23-7\"></a><span class=\"cp\">    }                             \\</span>\n</span><span id=\"__span-23-8\"><a id=\"__codelineno-23-8\" name=\"__codelineno-23-8\" href=\"#__codelineno-23-8\"></a><span class=\"cp\">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) != victim);</span>\n</span></code></pre></div>\n<p>\u6b63\u56e0\u5982\u6b64\uff0c\u8fd9\u4e2a\u5206\u914d\u8fc7\u7a0b\u624d\u80fd\u505a\u5230\u6bd4\u8f83\u5feb\uff0c\u6240\u4ee5\u8fd9\u6837\u7684\u5206\u914d\u65b9\u6cd5\u53eb\u505a fast bin\u3002</p>\n<h3 id=\"free_1\">free<a class=\"headerlink\" href=\"#free_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u5206\u6790\u4e00\u4e0b free \u7684\u65f6\u5019\uff0c\u7a7a\u95f2\u5757\u662f\u5982\u4f55\u8fdb\u5165 fast bin \u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-24-1\"><a id=\"__codelineno-24-1\" name=\"__codelineno-24-1\" href=\"#__codelineno-24-1\"></a><span class=\"c1\">// in _int_free, after tcache handling</span>\n</span><span id=\"__span-24-2\"><a id=\"__codelineno-24-2\" name=\"__codelineno-24-2\" href=\"#__codelineno-24-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)(</span><span class=\"n\">get_max_fast</span><span class=\"w\"> </span><span class=\"p\">()))</span>\n</span><span id=\"__span-24-3\"><a id=\"__codelineno-24-3\" name=\"__codelineno-24-3\" href=\"#__codelineno-24-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-24-4\"><a id=\"__codelineno-24-4\" name=\"__codelineno-24-4\" href=\"#__codelineno-24-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* check omitted */</span>\n</span><span id=\"__span-24-5\"><a id=\"__codelineno-24-5\" name=\"__codelineno-24-5\" href=\"#__codelineno-24-5\"></a><span class=\"w\">    </span><span class=\"n\">free_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk2mem</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">SIZE_SZ</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-6\"><a id=\"__codelineno-24-6\" name=\"__codelineno-24-6\" href=\"#__codelineno-24-6\"></a>\n</span><span id=\"__span-24-7\"><a id=\"__codelineno-24-7\" name=\"__codelineno-24-7\" href=\"#__codelineno-24-7\"></a><span class=\"w\">    </span><span class=\"n\">atomic_store_relaxed</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">have_fastchunks</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-8\"><a id=\"__codelineno-24-8\" name=\"__codelineno-24-8\" href=\"#__codelineno-24-8\"></a><span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fastbin_index</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-9\"><a id=\"__codelineno-24-9\" name=\"__codelineno-24-9\" href=\"#__codelineno-24-9\"></a><span class=\"w\">    </span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-10\"><a id=\"__codelineno-24-10\" name=\"__codelineno-24-10\" href=\"#__codelineno-24-10\"></a>\n</span><span id=\"__span-24-11\"><a id=\"__codelineno-24-11\" name=\"__codelineno-24-11\" href=\"#__codelineno-24-11\"></a><span class=\"w\">    </span><span class=\"cm\">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span>\n</span><span id=\"__span-24-12\"><a id=\"__codelineno-24-12\" name=\"__codelineno-24-12\" href=\"#__codelineno-24-12\"></a><span class=\"w\">    </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-13\"><a id=\"__codelineno-24-13\" name=\"__codelineno-24-13\" href=\"#__codelineno-24-13\"></a>\n</span><span id=\"__span-24-14\"><a id=\"__codelineno-24-14\" name=\"__codelineno-24-14\" href=\"#__codelineno-24-14\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-24-15\"><a id=\"__codelineno-24-15\" name=\"__codelineno-24-15\" href=\"#__codelineno-24-15\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-24-16\"><a id=\"__codelineno-24-16\" name=\"__codelineno-24-16\" href=\"#__codelineno-24-16\"></a><span class=\"w\">        </span><span class=\"cm\">/* Check that the top of the bin is not the record we are going to</span>\n</span><span id=\"__span-24-17\"><a id=\"__codelineno-24-17\" name=\"__codelineno-24-17\" href=\"#__codelineno-24-17\"></a><span class=\"cm\">          add (i.e., double free).  */</span>\n</span><span id=\"__span-24-18\"><a id=\"__codelineno-24-18\" name=\"__codelineno-24-18\" href=\"#__codelineno-24-18\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__builtin_expect</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n</span><span id=\"__span-24-19\"><a id=\"__codelineno-24-19\" name=\"__codelineno-24-19\" href=\"#__codelineno-24-19\"></a><span class=\"w\">          </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;double free or corruption (fasttop)&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-20\"><a id=\"__codelineno-24-20\" name=\"__codelineno-24-20\" href=\"#__codelineno-24-20\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-21\"><a id=\"__codelineno-24-21\" name=\"__codelineno-24-21\" href=\"#__codelineno-24-21\"></a><span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-22\"><a id=\"__codelineno-24-22\" name=\"__codelineno-24-22\" href=\"#__codelineno-24-22\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-24-23\"><a id=\"__codelineno-24-23\" name=\"__codelineno-24-23\" href=\"#__codelineno-24-23\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-24-24\"><a id=\"__codelineno-24-24\" name=\"__codelineno-24-24\" href=\"#__codelineno-24-24\"></a><span class=\"w\">      </span><span class=\"k\">do</span>\n</span><span id=\"__span-24-25\"><a id=\"__codelineno-24-25\" name=\"__codelineno-24-25\" href=\"#__codelineno-24-25\"></a><span class=\"w\">        </span><span class=\"p\">{</span>\n</span><span id=\"__span-24-26\"><a id=\"__codelineno-24-26\" name=\"__codelineno-24-26\" href=\"#__codelineno-24-26\"></a><span class=\"w\">          </span><span class=\"cm\">/* Check that the top of the bin is not the record we are going to</span>\n</span><span id=\"__span-24-27\"><a id=\"__codelineno-24-27\" name=\"__codelineno-24-27\" href=\"#__codelineno-24-27\"></a><span class=\"cm\">            add (i.e., double free).  */</span>\n</span><span id=\"__span-24-28\"><a id=\"__codelineno-24-28\" name=\"__codelineno-24-28\" href=\"#__codelineno-24-28\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__builtin_expect</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n</span><span id=\"__span-24-29\"><a id=\"__codelineno-24-29\" name=\"__codelineno-24-29\" href=\"#__codelineno-24-29\"></a><span class=\"w\">            </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;double free or corruption (fasttop)&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-30\"><a id=\"__codelineno-24-30\" name=\"__codelineno-24-30\" href=\"#__codelineno-24-30\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-31\"><a id=\"__codelineno-24-31\" name=\"__codelineno-24-31\" href=\"#__codelineno-24-31\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-24-32\"><a id=\"__codelineno-24-32\" name=\"__codelineno-24-32\" href=\"#__codelineno-24-32\"></a><span class=\"w\">      </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">catomic_compare_and_exchange_val_rel</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"p\">))</span>\n</span><span id=\"__span-24-33\"><a id=\"__codelineno-24-33\" name=\"__codelineno-24-33\" href=\"#__codelineno-24-33\"></a><span class=\"w\">              </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-34\"><a id=\"__codelineno-24-34\" name=\"__codelineno-24-34\" href=\"#__codelineno-24-34\"></a>\n</span><span id=\"__span-24-35\"><a id=\"__codelineno-24-35\" name=\"__codelineno-24-35\" href=\"#__codelineno-24-35\"></a><span class=\"w\">    </span><span class=\"cm\">/* check omitted */</span>\n</span><span id=\"__span-24-36\"><a id=\"__codelineno-24-36\" name=\"__codelineno-24-36\" href=\"#__codelineno-24-36\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u7684\u903b\u8f91\u5f88\u7b80\u5355\uff1a\u5982\u679c\u5927\u5c0f\u5408\u9002\uff0c\u5c31\u76f4\u63a5\u6dfb\u52a0\u5230 fast bin \u7684\u94fe\u8868\u5934\u91cc\uff0c\u6ca1\u6709 tcache \u90a3\u6837\u7684\u957f\u5ea6\u9650\u5236\uff0c\u591a\u7ebf\u7a0b\u573a\u666f\u4e0b\u4f9d\u7136\u662f\u7528 CAS \u6765\u5b9e\u73b0\u539f\u5b50\u7684\u94fe\u8868\u63d2\u5165\u3002</p>\n<p>\u76f8\u6bd4 tcache\uff0cfast bin \u7684 double free \u68c0\u67e5\u66f4\u52a0\u7b80\u964b\uff1a\u5b83\u53ea\u80fd\u9632\u62a4\u8fde\u7eed\u4e24\u6b21 free \u540c\u4e00\u4e2a\u5757\uff0c\u53ea\u5224\u65ad\u4e86\u8981\u63d2\u5165\u94fe\u8868\u7684\u5757\u662f\u5426\u5728\u94fe\u8868\u5934\uff0c\u800c\u4e0d\u4f1a\u68c0\u67e5\u662f\u5426\u5728\u94fe\u8868\u4e2d\u95f4\u3002</p>\n<h3 id=\"\u5b9e\u9a8c_1\">\u5b9e\u9a8c<a class=\"headerlink\" href=\"#\u5b9e\u9a8c_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u5199\u4e00\u6bb5\u4ee3\u7801\u6765\u89c2\u5bdf fast bin \u7684\u66f4\u65b0\u8fc7\u7a0b\uff1a</p>\n<ol>\n<li>\u7531\u4e8e fastbin \u4fdd\u5b58\u5728 <code>main_arena</code> \u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u627e\u5230 <code>main_arena</code> \u7684\u8fd0\u884c\u65f6\u5730\u5740</li>\n<li><code>main_arena</code> \u4e0d\u5728 libc \u7b26\u53f7\u8868\u4e2d\uff0c\u4e0d\u80fd\u76f4\u63a5\u627e\u5230\u5b83\u7684\u5730\u5740\uff0c\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7 libc \u7684\u8c03\u8bd5\u7b26\u53f7\uff0c\u627e\u5230\u5b83\u76f8\u5bf9 image base \u7684 offset \u662f <code>0x1ecb80</code></li>\n<li>\u518d\u627e\u4e00\u4e2a\u5728\u7b26\u53f7\u8868\u4e2d\u7684\u7b26\u53f7 <code>_IO_2_1_stdout_</code>\uff0c\u5b83\u76f8\u5bf9 image base \u7684 offset \u662f <code>0x1ed6a0</code></li>\n<li>\u6839\u636e\u4ee5\u4e0a\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u627e\u5230 libc \u7684 image base \u5730\u5740\uff0c\u4ece\u800c\u63a8\u65ad <code>main_arena</code> \u7684\u5730\u5740\uff0c\u8fdb\u800c\u627e\u5230\u6240\u6709\u7684 fast bin</li>\n<li>\u4e0b\u9762\u5199\u4e00\u6bb5\u4ee3\u7801\uff0c\u89c2\u5bdf\u7a7a\u95f2\u5757\u8fdb\u5165 fast bin \u7684\u8fc7\u7a0b</li>\n</ol>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-25-1\"><a id=\"__codelineno-25-1\" name=\"__codelineno-25-1\" href=\"#__codelineno-25-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stddef.h&gt;</span>\n</span><span id=\"__span-25-2\"><a id=\"__codelineno-25-2\" name=\"__codelineno-25-2\" href=\"#__codelineno-25-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdint.h&gt;</span>\n</span><span id=\"__span-25-3\"><a id=\"__codelineno-25-3\" name=\"__codelineno-25-3\" href=\"#__codelineno-25-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-25-4\"><a id=\"__codelineno-25-4\" name=\"__codelineno-25-4\" href=\"#__codelineno-25-4\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-25-5\"><a id=\"__codelineno-25-5\" name=\"__codelineno-25-5\" href=\"#__codelineno-25-5\"></a>\n</span><span id=\"__span-25-6\"><a id=\"__codelineno-25-6\" name=\"__codelineno-25-6\" href=\"#__codelineno-25-6\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-7\"><a id=\"__codelineno-25-7\" name=\"__codelineno-25-7\" href=\"#__codelineno-25-7\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">mchunk_prev_size</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Size of previous chunk (if free).  */</span>\n</span><span id=\"__span-25-8\"><a id=\"__codelineno-25-8\" name=\"__codelineno-25-8\" href=\"#__codelineno-25-8\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">mchunk_size</span><span class=\"p\">;</span><span class=\"w\">      </span><span class=\"cm\">/* Size in bytes, including overhead. */</span>\n</span><span id=\"__span-25-9\"><a id=\"__codelineno-25-9\" name=\"__codelineno-25-9\" href=\"#__codelineno-25-9\"></a>\n</span><span id=\"__span-25-10\"><a id=\"__codelineno-25-10\" name=\"__codelineno-25-10\" href=\"#__codelineno-25-10\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fd</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-25-11\"><a id=\"__codelineno-25-11\" name=\"__codelineno-25-11\" href=\"#__codelineno-25-11\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-12\"><a id=\"__codelineno-25-12\" name=\"__codelineno-25-12\" href=\"#__codelineno-25-12\"></a>\n</span><span id=\"__span-25-13\"><a id=\"__codelineno-25-13\" name=\"__codelineno-25-13\" href=\"#__codelineno-25-13\"></a><span class=\"w\">  </span><span class=\"cm\">/* Only used for large blocks: pointer to next larger size.  */</span>\n</span><span id=\"__span-25-14\"><a id=\"__codelineno-25-14\" name=\"__codelineno-25-14\" href=\"#__codelineno-25-14\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-25-15\"><a id=\"__codelineno-25-15\" name=\"__codelineno-25-15\" href=\"#__codelineno-25-15\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-16\"><a id=\"__codelineno-25-16\" name=\"__codelineno-25-16\" href=\"#__codelineno-25-16\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-25-17\"><a id=\"__codelineno-25-17\" name=\"__codelineno-25-17\" href=\"#__codelineno-25-17\"></a>\n</span><span id=\"__span-25-18\"><a id=\"__codelineno-25-18\" name=\"__codelineno-25-18\" href=\"#__codelineno-25-18\"></a><span class=\"cm\">/* offset 2 to use otherwise unindexable first 2 bins */</span>\n</span><span id=\"__span-25-19\"><a id=\"__codelineno-25-19\" name=\"__codelineno-25-19\" href=\"#__codelineno-25-19\"></a><span class=\"cp\">#define fastbin_index(sz) ((((unsigned int)(sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>\n</span><span id=\"__span-25-20\"><a id=\"__codelineno-25-20\" name=\"__codelineno-25-20\" href=\"#__codelineno-25-20\"></a>\n</span><span id=\"__span-25-21\"><a id=\"__codelineno-25-21\" name=\"__codelineno-25-21\" href=\"#__codelineno-25-21\"></a><span class=\"cp\">#define INTERNAL_SIZE_T size_t</span>\n</span><span id=\"__span-25-22\"><a id=\"__codelineno-25-22\" name=\"__codelineno-25-22\" href=\"#__codelineno-25-22\"></a>\n</span><span id=\"__span-25-23\"><a id=\"__codelineno-25-23\" name=\"__codelineno-25-23\" href=\"#__codelineno-25-23\"></a><span class=\"cm\">/* MALLOC_ALIGNMENT equals to 16 on 64-bit */</span>\n</span><span id=\"__span-25-24\"><a id=\"__codelineno-25-24\" name=\"__codelineno-25-24\" href=\"#__codelineno-25-24\"></a><span class=\"cp\">#define MALLOC_ALIGNMENT                                                       \\</span>\n</span><span id=\"__span-25-25\"><a id=\"__codelineno-25-25\" name=\"__codelineno-25-25\" href=\"#__codelineno-25-25\"></a><span class=\"cp\">  (2 * SIZE_SZ &lt; __alignof__(long double) ? __alignof__(long double)           \\</span>\n</span><span id=\"__span-25-26\"><a id=\"__codelineno-25-26\" name=\"__codelineno-25-26\" href=\"#__codelineno-25-26\"></a><span class=\"cp\">                                          : 2 * SIZE_SZ)</span>\n</span><span id=\"__span-25-27\"><a id=\"__codelineno-25-27\" name=\"__codelineno-25-27\" href=\"#__codelineno-25-27\"></a>\n</span><span id=\"__span-25-28\"><a id=\"__codelineno-25-28\" name=\"__codelineno-25-28\" href=\"#__codelineno-25-28\"></a><span class=\"cm\">/* The corresponding word size.  */</span>\n</span><span id=\"__span-25-29\"><a id=\"__codelineno-25-29\" name=\"__codelineno-25-29\" href=\"#__codelineno-25-29\"></a><span class=\"cm\">/* SIZE_SZ equals to 8 on 64-bit */</span>\n</span><span id=\"__span-25-30\"><a id=\"__codelineno-25-30\" name=\"__codelineno-25-30\" href=\"#__codelineno-25-30\"></a><span class=\"cp\">#define SIZE_SZ (sizeof(INTERNAL_SIZE_T))</span>\n</span><span id=\"__span-25-31\"><a id=\"__codelineno-25-31\" name=\"__codelineno-25-31\" href=\"#__codelineno-25-31\"></a>\n</span><span id=\"__span-25-32\"><a id=\"__codelineno-25-32\" name=\"__codelineno-25-32\" href=\"#__codelineno-25-32\"></a><span class=\"cm\">/* The corresponding bit mask value.  */</span>\n</span><span id=\"__span-25-33\"><a id=\"__codelineno-25-33\" name=\"__codelineno-25-33\" href=\"#__codelineno-25-33\"></a><span class=\"cm\">/* MALLOC_ALIGN_MASK equals to 15 on 64-bit */</span>\n</span><span id=\"__span-25-34\"><a id=\"__codelineno-25-34\" name=\"__codelineno-25-34\" href=\"#__codelineno-25-34\"></a><span class=\"cp\">#define MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span>\n</span><span id=\"__span-25-35\"><a id=\"__codelineno-25-35\" name=\"__codelineno-25-35\" href=\"#__codelineno-25-35\"></a>\n</span><span id=\"__span-25-36\"><a id=\"__codelineno-25-36\" name=\"__codelineno-25-36\" href=\"#__codelineno-25-36\"></a><span class=\"cm\">/* The smallest possible chunk */</span>\n</span><span id=\"__span-25-37\"><a id=\"__codelineno-25-37\" name=\"__codelineno-25-37\" href=\"#__codelineno-25-37\"></a><span class=\"cm\">/* MIN_CHUNK_SIZE equals to 32 on 64-bit */</span>\n</span><span id=\"__span-25-38\"><a id=\"__codelineno-25-38\" name=\"__codelineno-25-38\" href=\"#__codelineno-25-38\"></a><span class=\"cp\">#define MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</span>\n</span><span id=\"__span-25-39\"><a id=\"__codelineno-25-39\" name=\"__codelineno-25-39\" href=\"#__codelineno-25-39\"></a>\n</span><span id=\"__span-25-40\"><a id=\"__codelineno-25-40\" name=\"__codelineno-25-40\" href=\"#__codelineno-25-40\"></a><span class=\"cm\">/* The smallest size we can malloc is an aligned minimal chunk */</span>\n</span><span id=\"__span-25-41\"><a id=\"__codelineno-25-41\" name=\"__codelineno-25-41\" href=\"#__codelineno-25-41\"></a><span class=\"cm\">/* MINSIZE equals to 32 on 64-bit */</span>\n</span><span id=\"__span-25-42\"><a id=\"__codelineno-25-42\" name=\"__codelineno-25-42\" href=\"#__codelineno-25-42\"></a><span class=\"cp\">#define MINSIZE                                                                \\</span>\n</span><span id=\"__span-25-43\"><a id=\"__codelineno-25-43\" name=\"__codelineno-25-43\" href=\"#__codelineno-25-43\"></a><span class=\"cp\">  (unsigned long)(((MIN_CHUNK_SIZE + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span>\n</span><span id=\"__span-25-44\"><a id=\"__codelineno-25-44\" name=\"__codelineno-25-44\" href=\"#__codelineno-25-44\"></a>\n</span><span id=\"__span-25-45\"><a id=\"__codelineno-25-45\" name=\"__codelineno-25-45\" href=\"#__codelineno-25-45\"></a><span class=\"cm\">/* equivalent to max(alignUp(req + SIZE_SZ, MALLOC_ALIGNMENT), MINSIZE) */</span>\n</span><span id=\"__span-25-46\"><a id=\"__codelineno-25-46\" name=\"__codelineno-25-46\" href=\"#__codelineno-25-46\"></a><span class=\"cp\">#define request2size(req)                                                      \\</span>\n</span><span id=\"__span-25-47\"><a id=\"__codelineno-25-47\" name=\"__codelineno-25-47\" href=\"#__codelineno-25-47\"></a><span class=\"cp\">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                             \\</span>\n</span><span id=\"__span-25-48\"><a id=\"__codelineno-25-48\" name=\"__codelineno-25-48\" href=\"#__codelineno-25-48\"></a><span class=\"cp\">       ? MINSIZE                                                               \\</span>\n</span><span id=\"__span-25-49\"><a id=\"__codelineno-25-49\" name=\"__codelineno-25-49\" href=\"#__codelineno-25-49\"></a><span class=\"cp\">       : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span>\n</span><span id=\"__span-25-50\"><a id=\"__codelineno-25-50\" name=\"__codelineno-25-50\" href=\"#__codelineno-25-50\"></a>\n</span><span id=\"__span-25-51\"><a id=\"__codelineno-25-51\" name=\"__codelineno-25-51\" href=\"#__codelineno-25-51\"></a><span class=\"cm\">/* MAX_FAST_SIZE equals to 160 on 64-bit */</span>\n</span><span id=\"__span-25-52\"><a id=\"__codelineno-25-52\" name=\"__codelineno-25-52\" href=\"#__codelineno-25-52\"></a><span class=\"cp\">#define MAX_FAST_SIZE (80 * SIZE_SZ / 4)</span>\n</span><span id=\"__span-25-53\"><a id=\"__codelineno-25-53\" name=\"__codelineno-25-53\" href=\"#__codelineno-25-53\"></a>\n</span><span id=\"__span-25-54\"><a id=\"__codelineno-25-54\" name=\"__codelineno-25-54\" href=\"#__codelineno-25-54\"></a><span class=\"cm\">/* NFASTBINS equals to 10 on 64-bit */</span>\n</span><span id=\"__span-25-55\"><a id=\"__codelineno-25-55\" name=\"__codelineno-25-55\" href=\"#__codelineno-25-55\"></a><span class=\"cp\">#define NFASTBINS (fastbin_index(request2size(MAX_FAST_SIZE)) + 1)</span>\n</span><span id=\"__span-25-56\"><a id=\"__codelineno-25-56\" name=\"__codelineno-25-56\" href=\"#__codelineno-25-56\"></a>\n</span><span id=\"__span-25-57\"><a id=\"__codelineno-25-57\" name=\"__codelineno-25-57\" href=\"#__codelineno-25-57\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-58\"><a id=\"__codelineno-25-58\" name=\"__codelineno-25-58\" href=\"#__codelineno-25-58\"></a><span class=\"w\">  </span><span class=\"cm\">/* Serialize access.  */</span>\n</span><span id=\"__span-25-59\"><a id=\"__codelineno-25-59\" name=\"__codelineno-25-59\" href=\"#__codelineno-25-59\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">mutex</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-60\"><a id=\"__codelineno-25-60\" name=\"__codelineno-25-60\" href=\"#__codelineno-25-60\"></a><span class=\"w\">  </span><span class=\"cm\">/* Flags (formerly in max_fast).  */</span>\n</span><span id=\"__span-25-61\"><a id=\"__codelineno-25-61\" name=\"__codelineno-25-61\" href=\"#__codelineno-25-61\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-62\"><a id=\"__codelineno-25-62\" name=\"__codelineno-25-62\" href=\"#__codelineno-25-62\"></a><span class=\"w\">  </span><span class=\"cm\">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>\n</span><span id=\"__span-25-63\"><a id=\"__codelineno-25-63\" name=\"__codelineno-25-63\" href=\"#__codelineno-25-63\"></a><span class=\"w\">  </span><span class=\"cm\">/* Note this is a bool but not all targets support atomics on booleans.  */</span>\n</span><span id=\"__span-25-64\"><a id=\"__codelineno-25-64\" name=\"__codelineno-25-64\" href=\"#__codelineno-25-64\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">have_fastchunks</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-65\"><a id=\"__codelineno-25-65\" name=\"__codelineno-25-65\" href=\"#__codelineno-25-65\"></a><span class=\"w\">  </span><span class=\"cm\">/* Fastbins */</span>\n</span><span id=\"__span-25-66\"><a id=\"__codelineno-25-66\" name=\"__codelineno-25-66\" href=\"#__codelineno-25-66\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">NFASTBINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-25-67\"><a id=\"__codelineno-25-67\" name=\"__codelineno-25-67\" href=\"#__codelineno-25-67\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-25-68\"><a id=\"__codelineno-25-68\" name=\"__codelineno-25-68\" href=\"#__codelineno-25-68\"></a>\n</span><span id=\"__span-25-69\"><a id=\"__codelineno-25-69\" name=\"__codelineno-25-69\" href=\"#__codelineno-25-69\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">dump_fastbin</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-70\"><a id=\"__codelineno-25-70\" name=\"__codelineno-25-70\" href=\"#__codelineno-25-70\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">libc_base</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mh\">0x1ed6a0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// offset of _IO_2_1_stdout_</span>\n</span><span id=\"__span-25-71\"><a id=\"__codelineno-25-71\" name=\"__codelineno-25-71\" href=\"#__codelineno-25-71\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">=</span>\n</span><span id=\"__span-25-72\"><a id=\"__codelineno-25-72\" name=\"__codelineno-25-72\" href=\"#__codelineno-25-72\"></a><span class=\"w\">      </span><span class=\"n\">libc_base</span><span class=\"w\"> </span><span class=\"o\">+</span>\n</span><span id=\"__span-25-73\"><a id=\"__codelineno-25-73\" name=\"__codelineno-25-73\" href=\"#__codelineno-25-73\"></a><span class=\"w\">      </span><span class=\"mh\">0x1ecb80</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// offset of main_arena</span>\n</span><span id=\"__span-25-74\"><a id=\"__codelineno-25-74\" name=\"__codelineno-25-74\" href=\"#__codelineno-25-74\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">NFASTBINS</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-75\"><a id=\"__codelineno-25-75\" name=\"__codelineno-25-75\" href=\"#__codelineno-25-75\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">main_arena</span><span class=\"o\">-&gt;</span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-76\"><a id=\"__codelineno-25-76\" name=\"__codelineno-25-76\" href=\"#__codelineno-25-76\"></a><span class=\"w\">      </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">main_arena</span><span class=\"o\">-&gt;</span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span>\n</span><span id=\"__span-25-77\"><a id=\"__codelineno-25-77\" name=\"__codelineno-25-77\" href=\"#__codelineno-25-77\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbin #%d: %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-78\"><a id=\"__codelineno-25-78\" name=\"__codelineno-25-78\" href=\"#__codelineno-25-78\"></a><span class=\"w\">      </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-79\"><a id=\"__codelineno-25-79\" name=\"__codelineno-25-79\" href=\"#__codelineno-25-79\"></a><span class=\"w\">      </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-80\"><a id=\"__codelineno-25-80\" name=\"__codelineno-25-80\" href=\"#__codelineno-25-80\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot; -&gt; %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-81\"><a id=\"__codelineno-25-81\" name=\"__codelineno-25-81\" href=\"#__codelineno-25-81\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-82\"><a id=\"__codelineno-25-82\" name=\"__codelineno-25-82\" href=\"#__codelineno-25-82\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-83\"><a id=\"__codelineno-25-83\" name=\"__codelineno-25-83\" href=\"#__codelineno-25-83\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-84\"><a id=\"__codelineno-25-84\" name=\"__codelineno-25-84\" href=\"#__codelineno-25-84\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-85\"><a id=\"__codelineno-25-85\" name=\"__codelineno-25-85\" href=\"#__codelineno-25-85\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-86\"><a id=\"__codelineno-25-86\" name=\"__codelineno-25-86\" href=\"#__codelineno-25-86\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-25-87\"><a id=\"__codelineno-25-87\" name=\"__codelineno-25-87\" href=\"#__codelineno-25-87\"></a>\n</span><span id=\"__span-25-88\"><a id=\"__codelineno-25-88\" name=\"__codelineno-25-88\" href=\"#__codelineno-25-88\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-89\"><a id=\"__codelineno-25-89\" name=\"__codelineno-25-89\" href=\"#__codelineno-25-89\"></a><span class=\"w\">  </span><span class=\"c1\">// use 10 malloc + free, the first 7 blocks will be saved in tcache, the rest</span>\n</span><span id=\"__span-25-90\"><a id=\"__codelineno-25-90\" name=\"__codelineno-25-90\" href=\"#__codelineno-25-90\"></a><span class=\"w\">  </span><span class=\"c1\">// ones will go to fastbin</span>\n</span><span id=\"__span-25-91\"><a id=\"__codelineno-25-91\" name=\"__codelineno-25-91\" href=\"#__codelineno-25-91\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"mi\">10</span><span class=\"p\">];</span>\n</span><span id=\"__span-25-92\"><a id=\"__codelineno-25-92\" name=\"__codelineno-25-92\" href=\"#__codelineno-25-92\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;allocate 10 pointers:&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-93\"><a id=\"__codelineno-25-93\" name=\"__codelineno-25-93\" href=\"#__codelineno-25-93\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-94\"><a id=\"__codelineno-25-94\" name=\"__codelineno-25-94\" href=\"#__codelineno-25-94\"></a><span class=\"w\">    </span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-95\"><a id=\"__codelineno-25-95\" name=\"__codelineno-25-95\" href=\"#__codelineno-25-95\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot; %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-96\"><a id=\"__codelineno-25-96\" name=\"__codelineno-25-96\" href=\"#__codelineno-25-96\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-97\"><a id=\"__codelineno-25-97\" name=\"__codelineno-25-97\" href=\"#__codelineno-25-97\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-98\"><a id=\"__codelineno-25-98\" name=\"__codelineno-25-98\" href=\"#__codelineno-25-98\"></a>\n</span><span id=\"__span-25-99\"><a id=\"__codelineno-25-99\" name=\"__codelineno-25-99\" href=\"#__codelineno-25-99\"></a><span class=\"w\">  </span><span class=\"c1\">// now one ptr goes to fastbin</span>\n</span><span id=\"__span-25-100\"><a id=\"__codelineno-25-100\" name=\"__codelineno-25-100\" href=\"#__codelineno-25-100\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-101\"><a id=\"__codelineno-25-101\" name=\"__codelineno-25-101\" href=\"#__codelineno-25-101\"></a><span class=\"w\">    </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-102\"><a id=\"__codelineno-25-102\" name=\"__codelineno-25-102\" href=\"#__codelineno-25-102\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-103\"><a id=\"__codelineno-25-103\" name=\"__codelineno-25-103\" href=\"#__codelineno-25-103\"></a>\n</span><span id=\"__span-25-104\"><a id=\"__codelineno-25-104\" name=\"__codelineno-25-104\" href=\"#__codelineno-25-104\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbins after 8 pointers freed:</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-105\"><a id=\"__codelineno-25-105\" name=\"__codelineno-25-105\" href=\"#__codelineno-25-105\"></a><span class=\"w\">  </span><span class=\"n\">dump_fastbin</span><span class=\"p\">();</span>\n</span><span id=\"__span-25-106\"><a id=\"__codelineno-25-106\" name=\"__codelineno-25-106\" href=\"#__codelineno-25-106\"></a>\n</span><span id=\"__span-25-107\"><a id=\"__codelineno-25-107\" name=\"__codelineno-25-107\" href=\"#__codelineno-25-107\"></a><span class=\"w\">  </span><span class=\"c1\">// free the 9th one</span>\n</span><span id=\"__span-25-108\"><a id=\"__codelineno-25-108\" name=\"__codelineno-25-108\" href=\"#__codelineno-25-108\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"mi\">8</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-109\"><a id=\"__codelineno-25-109\" name=\"__codelineno-25-109\" href=\"#__codelineno-25-109\"></a>\n</span><span id=\"__span-25-110\"><a id=\"__codelineno-25-110\" name=\"__codelineno-25-110\" href=\"#__codelineno-25-110\"></a><span class=\"w\">  </span><span class=\"c1\">// two pointers in the fastbin</span>\n</span><span id=\"__span-25-111\"><a id=\"__codelineno-25-111\" name=\"__codelineno-25-111\" href=\"#__codelineno-25-111\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbins after 9 pointers freed:</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-112\"><a id=\"__codelineno-25-112\" name=\"__codelineno-25-112\" href=\"#__codelineno-25-112\"></a><span class=\"w\">  </span><span class=\"n\">dump_fastbin</span><span class=\"p\">();</span>\n</span><span id=\"__span-25-113\"><a id=\"__codelineno-25-113\" name=\"__codelineno-25-113\" href=\"#__codelineno-25-113\"></a>\n</span><span id=\"__span-25-114\"><a id=\"__codelineno-25-114\" name=\"__codelineno-25-114\" href=\"#__codelineno-25-114\"></a><span class=\"w\">  </span><span class=\"c1\">// free the 10th one</span>\n</span><span id=\"__span-25-115\"><a id=\"__codelineno-25-115\" name=\"__codelineno-25-115\" href=\"#__codelineno-25-115\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"mi\">9</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-116\"><a id=\"__codelineno-25-116\" name=\"__codelineno-25-116\" href=\"#__codelineno-25-116\"></a>\n</span><span id=\"__span-25-117\"><a id=\"__codelineno-25-117\" name=\"__codelineno-25-117\" href=\"#__codelineno-25-117\"></a><span class=\"w\">  </span><span class=\"c1\">// three pointers in the fastbin</span>\n</span><span id=\"__span-25-118\"><a id=\"__codelineno-25-118\" name=\"__codelineno-25-118\" href=\"#__codelineno-25-118\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbins after 10 pointers freed:</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-119\"><a id=\"__codelineno-25-119\" name=\"__codelineno-25-119\" href=\"#__codelineno-25-119\"></a><span class=\"w\">  </span><span class=\"n\">dump_fastbin</span><span class=\"p\">();</span>\n</span><span id=\"__span-25-120\"><a id=\"__codelineno-25-120\" name=\"__codelineno-25-120\" href=\"#__codelineno-25-120\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-121\"><a id=\"__codelineno-25-121\" name=\"__codelineno-25-121\" href=\"#__codelineno-25-121\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8f93\u51fa\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-26-1\"><a id=\"__codelineno-26-1\" name=\"__codelineno-26-1\" href=\"#__codelineno-26-1\"></a><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d6b0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d6e0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d710</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d740</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d770</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7a0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7d0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d800</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d830</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d860</span>\n</span><span id=\"__span-26-2\"><a id=\"__codelineno-26-2\" name=\"__codelineno-26-2\" href=\"#__codelineno-26-2\"></a><span class=\"n\">fastbins</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"w\"> </span><span class=\"n\">freed</span><span class=\"o\">:</span>\n</span><span id=\"__span-26-3\"><a id=\"__codelineno-26-3\" name=\"__codelineno-26-3\" href=\"#__codelineno-26-3\"></a><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7f0</span>\n</span><span id=\"__span-26-4\"><a id=\"__codelineno-26-4\" name=\"__codelineno-26-4\" href=\"#__codelineno-26-4\"></a><span class=\"n\">fastbins</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"w\"> </span><span class=\"n\">freed</span><span class=\"o\">:</span>\n</span><span id=\"__span-26-5\"><a id=\"__codelineno-26-5\" name=\"__codelineno-26-5\" href=\"#__codelineno-26-5\"></a><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d820</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7f0</span>\n</span><span id=\"__span-26-6\"><a id=\"__codelineno-26-6\" name=\"__codelineno-26-6\" href=\"#__codelineno-26-6\"></a><span class=\"n\">fastbins</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"w\"> </span><span class=\"n\">freed</span><span class=\"o\">:</span>\n</span><span id=\"__span-26-7\"><a id=\"__codelineno-26-7\" name=\"__codelineno-26-7\" href=\"#__codelineno-26-7\"></a><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d850</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d820</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7f0</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4ee3\u7801\u5148\u5206\u914d\u4e86\u5341\u4e2a\u5757\uff0c\u518d\u6309\u987a\u5e8f\u91ca\u653e\uff0c\u90a3\u4e48\u524d\u4e03\u4e2a\u5757\u4f1a\u8fdb\u5165 tcache\uff0c\u5269\u4e0b\u7684\u4e09\u4e2a\u5757\u5219\u8fdb\u5165\u4e86\u540c\u4e00\u4e2a fast bin\uff0c\u5e76\u4e14\u540e\u91ca\u653e\u7684\u4f1a\u5728\u94fe\u8868\u7684\u5f00\u5934\u3002\u6ce8\u610f fast bin \u94fe\u8868\u91cc\u7684\u5730\u5740\u6253\u5370\u7684\u662f chunk \u5730\u5740\uff0c\u800c\u7528 <code>malloc</code> \u5206\u914d\u7684\u5730\u5740\u6307\u5411\u7684\u662f payload \u90e8\u5206\uff0c\u4e8c\u8005\u5dee\u4e86 16 \u5b57\u8282\uff0c\u6700\u7ec8 fast bin \u5c31\u662f\u628a\u5341\u4e2a\u5757\u91cc\u6700\u540e\u4e09\u4e2a\u5757\u7528\u94fe\u8868\u4e32\u8d77\u6765\u3002\u7531\u4e8e\u603b\u662f\u5f80\u94fe\u8868\u7684\u5934\u90e8\u63d2\u5165\u7a7a\u95f2\u5757\uff0c\u6240\u4ee5\u540e\u91ca\u653e\u7684\u5757\u51fa\u73b0\u5728\u9760\u524d\u7684\u4f4d\u7f6e\u3002</p>\n<h2 id=\"small-bin\">small bin<a class=\"headerlink\" href=\"#small-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5206\u6790\u5b8c fast bin\uff0c\u63a5\u4e0b\u6765\u6765\u770b small bin\u3002small bin \u6bcf\u4e2a bin \u5185\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u662f\u76f8\u540c\u7684\uff0c\u5e76\u4e14\u4e5f\u662f\u4ee5\u94fe\u8868\u7684\u65b9\u5f0f\u7ec4\u7ec7\uff0c\u53ea\u4e0d\u8fc7\u7528\u7684\u662f\u53cc\u5411\u94fe\u8868\u3002</p>\n<h3 id=\"malloc_3\">malloc<a class=\"headerlink\" href=\"#malloc_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf <code>_int_malloc</code> \u662f\u600e\u4e48\u4f7f\u7528 small bin \u7684\u3002\u524d\u9762\u63d0\u5230\uff0c<code>_int_malloc</code> \u9996\u5148\u4f1a\u5c1d\u8bd5\u5728 fast bin \u4e2d\u5206\u914d\uff0c\u5982\u679c\u5206\u914d\u5931\u8d25\uff0c\u6216\u8005\u5927\u5c0f\u8d85\u51fa\u4e86 fast bin \u7684\u8303\u56f4\uff0c\u63a5\u4e0b\u6765\u4f1a\u5c1d\u8bd5\u5728 small bin \u4e2d\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-27-1\"><a id=\"__codelineno-27-1\" name=\"__codelineno-27-1\" href=\"#__codelineno-27-1\"></a><span class=\"c1\">// in _int_malloc</span>\n</span><span id=\"__span-27-2\"><a id=\"__codelineno-27-2\" name=\"__codelineno-27-2\" href=\"#__codelineno-27-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-27-3\"><a id=\"__codelineno-27-3\" name=\"__codelineno-27-3\" href=\"#__codelineno-27-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-4\"><a id=\"__codelineno-27-4\" name=\"__codelineno-27-4\" href=\"#__codelineno-27-4\"></a><span class=\"w\">    </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">smallbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-5\"><a id=\"__codelineno-27-5\" name=\"__codelineno-27-5\" href=\"#__codelineno-27-5\"></a><span class=\"w\">    </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-6\"><a id=\"__codelineno-27-6\" name=\"__codelineno-27-6\" href=\"#__codelineno-27-6\"></a>\n</span><span id=\"__span-27-7\"><a id=\"__codelineno-27-7\" name=\"__codelineno-27-7\" href=\"#__codelineno-27-7\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-8\"><a id=\"__codelineno-27-8\" name=\"__codelineno-27-8\" href=\"#__codelineno-27-8\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-9\"><a id=\"__codelineno-27-9\" name=\"__codelineno-27-9\" href=\"#__codelineno-27-9\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-10\"><a id=\"__codelineno-27-10\" name=\"__codelineno-27-10\" href=\"#__codelineno-27-10\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">))</span>\n</span><span id=\"__span-27-11\"><a id=\"__codelineno-27-11\" name=\"__codelineno-27-11\" href=\"#__codelineno-27-11\"></a><span class=\"w\">          </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): smallbin double linked list corrupted&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-12\"><a id=\"__codelineno-27-12\" name=\"__codelineno-27-12\" href=\"#__codelineno-27-12\"></a><span class=\"w\">        </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-13\"><a id=\"__codelineno-27-13\" name=\"__codelineno-27-13\" href=\"#__codelineno-27-13\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-14\"><a id=\"__codelineno-27-14\" name=\"__codelineno-27-14\" href=\"#__codelineno-27-14\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-15\"><a id=\"__codelineno-27-15\" name=\"__codelineno-27-15\" href=\"#__codelineno-27-15\"></a>\n</span><span id=\"__span-27-16\"><a id=\"__codelineno-27-16\" name=\"__codelineno-27-16\" href=\"#__codelineno-27-16\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-17\"><a id=\"__codelineno-27-17\" name=\"__codelineno-27-17\" href=\"#__codelineno-27-17\"></a><span class=\"w\">          </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-18\"><a id=\"__codelineno-27-18\" name=\"__codelineno-27-18\" href=\"#__codelineno-27-18\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-19\"><a id=\"__codelineno-27-19\" name=\"__codelineno-27-19\" href=\"#__codelineno-27-19\"></a><span class=\"w\">        </span><span class=\"cm\">/* While we&#39;re here, if we see other chunks of the same size,</span>\n</span><span id=\"__span-27-20\"><a id=\"__codelineno-27-20\" name=\"__codelineno-27-20\" href=\"#__codelineno-27-20\"></a><span class=\"cm\">           stash them in the tcache.  */</span>\n</span><span id=\"__span-27-21\"><a id=\"__codelineno-27-21\" name=\"__codelineno-27-21\" href=\"#__codelineno-27-21\"></a><span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-22\"><a id=\"__codelineno-27-22\" name=\"__codelineno-27-22\" href=\"#__codelineno-27-22\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-23\"><a id=\"__codelineno-27-23\" name=\"__codelineno-27-23\" href=\"#__codelineno-27-23\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-24\"><a id=\"__codelineno-27-24\" name=\"__codelineno-27-24\" href=\"#__codelineno-27-24\"></a><span class=\"w\">            </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-25\"><a id=\"__codelineno-27-25\" name=\"__codelineno-27-25\" href=\"#__codelineno-27-25\"></a>\n</span><span id=\"__span-27-26\"><a id=\"__codelineno-27-26\" name=\"__codelineno-27-26\" href=\"#__codelineno-27-26\"></a><span class=\"w\">            </span><span class=\"cm\">/* While bin not empty and tcache not full, copy chunks over.  */</span>\n</span><span id=\"__span-27-27\"><a id=\"__codelineno-27-27\" name=\"__codelineno-27-27\" href=\"#__codelineno-27-27\"></a><span class=\"w\">            </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span>\n</span><span id=\"__span-27-28\"><a id=\"__codelineno-27-28\" name=\"__codelineno-27-28\" href=\"#__codelineno-27-28\"></a><span class=\"w\">                   </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-29\"><a id=\"__codelineno-27-29\" name=\"__codelineno-27-29\" href=\"#__codelineno-27-29\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-30\"><a id=\"__codelineno-27-30\" name=\"__codelineno-27-30\" href=\"#__codelineno-27-30\"></a><span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-31\"><a id=\"__codelineno-27-31\" name=\"__codelineno-27-31\" href=\"#__codelineno-27-31\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-32\"><a id=\"__codelineno-27-32\" name=\"__codelineno-27-32\" href=\"#__codelineno-27-32\"></a><span class=\"w\">                    </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-33\"><a id=\"__codelineno-27-33\" name=\"__codelineno-27-33\" href=\"#__codelineno-27-33\"></a><span class=\"w\">                    </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-34\"><a id=\"__codelineno-27-34\" name=\"__codelineno-27-34\" href=\"#__codelineno-27-34\"></a><span class=\"w\">                    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-35\"><a id=\"__codelineno-27-35\" name=\"__codelineno-27-35\" href=\"#__codelineno-27-35\"></a><span class=\"w\">                      </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-36\"><a id=\"__codelineno-27-36\" name=\"__codelineno-27-36\" href=\"#__codelineno-27-36\"></a><span class=\"w\">                    </span><span class=\"n\">bin</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-37\"><a id=\"__codelineno-27-37\" name=\"__codelineno-27-37\" href=\"#__codelineno-27-37\"></a><span class=\"w\">                    </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-38\"><a id=\"__codelineno-27-38\" name=\"__codelineno-27-38\" href=\"#__codelineno-27-38\"></a>\n</span><span id=\"__span-27-39\"><a id=\"__codelineno-27-39\" name=\"__codelineno-27-39\" href=\"#__codelineno-27-39\"></a><span class=\"w\">                    </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-40\"><a id=\"__codelineno-27-40\" name=\"__codelineno-27-40\" href=\"#__codelineno-27-40\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-41\"><a id=\"__codelineno-27-41\" name=\"__codelineno-27-41\" href=\"#__codelineno-27-41\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-42\"><a id=\"__codelineno-27-42\" name=\"__codelineno-27-42\" href=\"#__codelineno-27-42\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-43\"><a id=\"__codelineno-27-43\" name=\"__codelineno-27-43\" href=\"#__codelineno-27-43\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-44\"><a id=\"__codelineno-27-44\" name=\"__codelineno-27-44\" href=\"#__codelineno-27-44\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-45\"><a id=\"__codelineno-27-45\" name=\"__codelineno-27-45\" href=\"#__codelineno-27-45\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-46\"><a id=\"__codelineno-27-46\" name=\"__codelineno-27-46\" href=\"#__codelineno-27-46\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-47\"><a id=\"__codelineno-27-47\" name=\"__codelineno-27-47\" href=\"#__codelineno-27-47\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 <code>in_smallbin_range (nb)</code> \u68c0\u67e5\u5757\u7684\u5927\u5c0f\u662f\u5426\u5e94\u8be5\u653e\u5230 small bin \u5f53\u4e2d</li>\n<li>\u4f7f\u7528 <code>smallbin_index (nb)</code> \u6839\u636e\u5757\u7684\u5927\u5c0f\u8ba1\u7b97\u51fa small bin \u7684 index\uff0c\u7136\u540e <code>bin_at (av, idx)</code> \u5bf9\u5e94 small bin \u7684\u94fe\u8868\u5c3e\u90e8\u7684\u54e8\u5175\uff0c\u8fd9\u4e2a\u53cc\u5411\u94fe\u8868\u6709\u4e14\u53ea\u6709\u4e00\u4e2a\u54e8\u5175\uff0c\u8fd9\u4e2a\u54e8\u5175\u5c31\u653e\u5728 small bin \u6570\u7ec4\u5f53\u4e2d</li>\n<li>\u627e\u5230\u54e8\u5175\u7ed3\u70b9\u7684\u524d\u9a71\u7ed3\u70b9 <code>last (bin)</code>\uff0c\u5982\u679c\u94fe\u8868\u4e3a\u7a7a\uff0c\u90a3\u4e48\u54e8\u5175\u7684\u524d\u9a71\u7ed3\u70b9\u5c31\u662f\u5b83\u81ea\u5df1\uff1b\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u90a3\u4e48\u54e8\u5175\u7684\u524d\u9a71\u7ed3\u70b9\u5c31\u662f\u94fe\u8868\u91cc\u7684\u6700\u540e\u4e00\u4e2a\u7ed3\u70b9\uff0c\u628a\u5b83\u8d4b\u503c\u7ed9 <code>victim</code></li>\n<li>\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u6807\u8bb0\u4e3a\u6b63\u5728\u4f7f\u7528\uff1a<code>set_inuse_bit_at_offset (victim, nb)</code></li>\n<li>\u628a <code>victim</code> \u4ece\u94fe\u8868\u91cc\u5220\u9664\uff1a<code>bck = victim-&gt;bk; bin-&gt;bk = bck; bck-&gt;fd = bin;</code>\uff0c\u5178\u578b\u7684\u53cc\u5411\u94fe\u8868\u7684\u7ed3\u70b9\u5220\u9664\u8fc7\u7a0b\uff0c\u7ef4\u62a4 <code>victim</code> \u524d\u9a71\u7ed3\u70b9\u7684\u540e\u7ee7\u6307\u9488\uff0c\u7ef4\u62a4\u54e8\u5175 <code>bin</code> \u7684\u524d\u9a71\u6307\u9488</li>\n<li>\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u5b89\u5168\u68c0\u67e5\uff1a<code>check_malloced_chunk</code></li>\n<li>\u68c0\u67e5 tcache \u5bf9\u5e94\u7684 bin\uff0c\u5982\u679c\u5b83\u8fd8\u6ca1\u6709\u6ee1\uff0c\u5c31\u628a small bin \u94fe\u8868\u4e2d\u7684\u5143\u7d20\u632a\u5230 tcache \u5f53\u4e2d</li>\n<li>\u628a payload \u5730\u5740\u901a\u8fc7 <code>chunk2mem</code> \u8ba1\u7b97\u51fa\u6765\uff0c\u8fd4\u56de\u7ed9 malloc \u8c03\u7528\u8005</li>\n<li>\u8c03\u7528 <code>alloc_perturb</code> \u5f80\u65b0\u5206\u914d\u7684\u7a7a\u95f4\u5185\u5199\u5165\u5783\u573e\u6570\u636e\uff08\u53ef\u9009\uff09\uff0c\u907f\u514d\u6cc4\u9732\u4e4b\u524d\u7684\u6570\u636e</li>\n</ol>\n<p>\u5176\u5b9e\u73b0\u8fc7\u7a0b\u548c fast bin \u5f88\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u628a\u5355\u5411\u94fe\u8868\u6539\u6210\u4e86\u53cc\u5411\uff0c\u5e76\u4e14\u5f15\u5165\u4e86\u54e8\u5175\u7ed3\u70b9\uff0c\u8fd9\u4e2a\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7ed3\u6784\u7684 bins \u6570\u7ec4\u5f53\u4e2d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-28-1\"><a id=\"__codelineno-28-1\" name=\"__codelineno-28-1\" href=\"#__codelineno-28-1\"></a><span class=\"cp\">#define NSMALLBINS         64</span>\n</span><span id=\"__span-28-2\"><a id=\"__codelineno-28-2\" name=\"__codelineno-28-2\" href=\"#__codelineno-28-2\"></a><span class=\"cm\">/* SMALLBIN_WIDTH equals to 16 on 64-bit */</span>\n</span><span id=\"__span-28-3\"><a id=\"__codelineno-28-3\" name=\"__codelineno-28-3\" href=\"#__codelineno-28-3\"></a><span class=\"cp\">#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span>\n</span><span id=\"__span-28-4\"><a id=\"__codelineno-28-4\" name=\"__codelineno-28-4\" href=\"#__codelineno-28-4\"></a><span class=\"cm\">/* SMALLBIN_CORRECTION equals to 0 on 64-bit */</span>\n</span><span id=\"__span-28-5\"><a id=\"__codelineno-28-5\" name=\"__codelineno-28-5\" href=\"#__codelineno-28-5\"></a><span class=\"cp\">#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span>\n</span><span id=\"__span-28-6\"><a id=\"__codelineno-28-6\" name=\"__codelineno-28-6\" href=\"#__codelineno-28-6\"></a>\n</span><span id=\"__span-28-7\"><a id=\"__codelineno-28-7\" name=\"__codelineno-28-7\" href=\"#__codelineno-28-7\"></a><span class=\"cm\">/* MIN_LARGE_SIZE equals to 1024 on 64-bit */</span>\n</span><span id=\"__span-28-8\"><a id=\"__codelineno-28-8\" name=\"__codelineno-28-8\" href=\"#__codelineno-28-8\"></a><span class=\"cp\">#define MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span>\n</span><span id=\"__span-28-9\"><a id=\"__codelineno-28-9\" name=\"__codelineno-28-9\" href=\"#__codelineno-28-9\"></a>\n</span><span id=\"__span-28-10\"><a id=\"__codelineno-28-10\" name=\"__codelineno-28-10\" href=\"#__codelineno-28-10\"></a><span class=\"cm\">/* equivalent to (sz &lt; 1024) on 64-bit */</span>\n</span><span id=\"__span-28-11\"><a id=\"__codelineno-28-11\" name=\"__codelineno-28-11\" href=\"#__codelineno-28-11\"></a><span class=\"cp\">#define in_smallbin_range(sz)  \\</span>\n</span><span id=\"__span-28-12\"><a id=\"__codelineno-28-12\" name=\"__codelineno-28-12\" href=\"#__codelineno-28-12\"></a><span class=\"cp\">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span>\n</span><span id=\"__span-28-13\"><a id=\"__codelineno-28-13\" name=\"__codelineno-28-13\" href=\"#__codelineno-28-13\"></a>\n</span><span id=\"__span-28-14\"><a id=\"__codelineno-28-14\" name=\"__codelineno-28-14\" href=\"#__codelineno-28-14\"></a><span class=\"cm\">/* equivalent to (sz &gt;&gt; 4) on 64-bit */</span>\n</span><span id=\"__span-28-15\"><a id=\"__codelineno-28-15\" name=\"__codelineno-28-15\" href=\"#__codelineno-28-15\"></a><span class=\"cp\">#define smallbin_index(sz) \\</span>\n</span><span id=\"__span-28-16\"><a id=\"__codelineno-28-16\" name=\"__codelineno-28-16\" href=\"#__codelineno-28-16\"></a><span class=\"cp\">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\\</span>\n</span><span id=\"__span-28-17\"><a id=\"__codelineno-28-17\" name=\"__codelineno-28-17\" href=\"#__codelineno-28-17\"></a><span class=\"cp\">   + SMALLBIN_CORRECTION)</span>\n</span><span id=\"__span-28-18\"><a id=\"__codelineno-28-18\" name=\"__codelineno-28-18\" href=\"#__codelineno-28-18\"></a>\n</span><span id=\"__span-28-19\"><a id=\"__codelineno-28-19\" name=\"__codelineno-28-19\" href=\"#__codelineno-28-19\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mchunkptr</span><span class=\"p\">;</span>\n</span><span id=\"__span-28-20\"><a id=\"__codelineno-28-20\" name=\"__codelineno-28-20\" href=\"#__codelineno-28-20\"></a>\n</span><span id=\"__span-28-21\"><a id=\"__codelineno-28-21\" name=\"__codelineno-28-21\" href=\"#__codelineno-28-21\"></a><span class=\"cm\">/* addressing -- note that bin_at(0) does not exist */</span>\n</span><span id=\"__span-28-22\"><a id=\"__codelineno-28-22\" name=\"__codelineno-28-22\" href=\"#__codelineno-28-22\"></a><span class=\"cp\">#define bin_at(m, i) \\</span>\n</span><span id=\"__span-28-23\"><a id=\"__codelineno-28-23\" name=\"__codelineno-28-23\" href=\"#__codelineno-28-23\"></a><span class=\"cp\">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))                              \\</span>\n</span><span id=\"__span-28-24\"><a id=\"__codelineno-28-24\" name=\"__codelineno-28-24\" href=\"#__codelineno-28-24\"></a><span class=\"cp\">             - offsetof (struct malloc_chunk, fd))</span>\n</span><span id=\"__span-28-25\"><a id=\"__codelineno-28-25\" name=\"__codelineno-28-25\" href=\"#__codelineno-28-25\"></a>\n</span><span id=\"__span-28-26\"><a id=\"__codelineno-28-26\" name=\"__codelineno-28-26\" href=\"#__codelineno-28-26\"></a><span class=\"cp\">#define NBINS             128</span>\n</span><span id=\"__span-28-27\"><a id=\"__codelineno-28-27\" name=\"__codelineno-28-27\" href=\"#__codelineno-28-27\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span>\n</span><span id=\"__span-28-28\"><a id=\"__codelineno-28-28\" name=\"__codelineno-28-28\" href=\"#__codelineno-28-28\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-28-29\"><a id=\"__codelineno-28-29\" name=\"__codelineno-28-29\" href=\"#__codelineno-28-29\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-28-30\"><a id=\"__codelineno-28-30\" name=\"__codelineno-28-30\" href=\"#__codelineno-28-30\"></a><span class=\"w\">  </span><span class=\"cm\">/* Normal bins packed as described above */</span>\n</span><span id=\"__span-28-31\"><a id=\"__codelineno-28-31\" name=\"__codelineno-28-31\" href=\"#__codelineno-28-31\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">bins</span><span class=\"p\">[</span><span class=\"n\">NBINS</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-28-32\"><a id=\"__codelineno-28-32\" name=\"__codelineno-28-32\" href=\"#__codelineno-28-32\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4e4d\u4e00\u770b\u4f1a\u89c9\u5f97\u5f88\u5947\u602a\uff0c\u8fd9\u91cc <code>NBINS * 2 - 2</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f<code>mchunkptr</code> \u662f\u4e2a\u6307\u9488\u7c7b\u578b\uff0c\u90a3\u5b83\u6307\u5411\u7684\u6570\u636e\u5b58\u5728\u54ea\uff1f\u5176\u5b9e\u8fd9\u91cc\u7528\u4e86\u4e00\u4e2a\u5c0f\u7684 trick\uff1a</p>\n<ol>\n<li>\u4e0d\u53bb\u770b bins \u5143\u7d20\u7684\u7c7b\u578b\uff0c\u53ea\u8003\u8651\u5b83\u7684\u5143\u7d20\u7684\u5927\u5c0f\uff0c\u6bcf\u4e2a\u5143\u7d20\u5927\u5c0f\u662f <code>sizeof(size_t)</code>\uff0c\u4e00\u5171\u6709 <code>NBINS * 2 - 2</code> \u4e2a\u5143\u7d20</li>\n<li>\u800c\u6bcf\u4e2a bin \u5bf9\u5e94\u4e00\u4e2a\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\uff0c\u7531\u4e8e\u662f\u53cc\u5411\u94fe\u8868\uff0c\u54e8\u5175\u7ed3\u70b9\u4e5f\u6ca1\u6709\u6570\u636e\uff0c\u53ea\u9700\u8981\u4fdd\u5b58\u524d\u9a71\u548c\u540e\u7ee7\u4e24\u4e2a\u6307\u9488\uff0c\u5373\u6bcf\u4e2a bin \u53ea\u9700\u8981\u5b58\u4e24\u4e2a\u6307\u9488\u7684\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f <code>2 * sizeof(size_t)</code></li>\n<li>\u6b63\u597d <code>bins</code> \u6570\u7ec4\u7ed9\u6bcf\u4e2a bin \u7559\u51fa\u4e86 <code>2 * sizeof(size_t)</code> \u7684\u7a7a\u95f4\uff08bin 0 \u9664\u5916\uff0c\u8fd9\u4e2a bin \u4e0d\u5b58\u5728\uff09\uff0c\u6240\u4ee5\u5b9e\u9645\u4e0a\u8fd9\u4e9b\u54e8\u5175\u7ed3\u70b9\u7684\u524d\u9a71\u548c\u540e\u7ee7\u6307\u9488\u5c31\u4fdd\u5b58\u5728 <code>bins</code> \u6570\u7ec4\u91cc\uff0c\u6309\u987a\u5e8f\u4fdd\u5b58\uff0c\u9996\u5148\u662f bin 1 \u7684\u524d\u9a71\uff0c\u7136\u540e\u662f bin 1 \u7684\u540e\u7ee7\uff0c\u63a5\u7740\u662f bin 2 \u7684\u524d\u9a71\uff0c\u4f9d\u6b64\u7c7b\u63a8</li>\n<li>\u867d\u7136\u7a7a\u95f4\u5bf9\u4e0a\u4e86\uff0c\u4f46\u662f\u4e3a\u4e86\u65b9\u4fbf\u4f7f\u7528\uff0c\u4ee3\u7801\u91cc\u7528 <code>bin_at</code> \u5b8f\u6765\u8ba1\u7b97\u51fa\u4e00\u4e2a <code>malloc_chunk</code> \u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c\u800c\u5df2\u77e5 bins \u6570\u7ec4\u53ea\u4fdd\u5b58\u4e86 <code>fd</code> \u548c <code>bk</code> \u4e24\u4e2a\u6307\u9488\uff0c\u5e76\u4e14 bin \u7684\u4e0b\u6807\u4ece 1 \u5f00\u59cb\uff0c\u6240\u4ee5 bin i \u7684 <code>fd</code> \u6307\u9488\u5730\u5740\u5c31\u662f <code>(char *) &amp;((m)-&gt;bins[((i) - 1) * 2])</code>\uff0c\u518d\u51cf\u53bb <code>malloc_chunk</code> \u7ed3\u6784\u4f53\u4e2d <code>fd</code> \u6210\u5458\u7684\u504f\u79fb\uff0c\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a <code>malloc_chunk</code> \u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c\u5f53\u7136\u4e86\uff0c\u8fd9\u4e2a\u7ed3\u6784\u4f53\u53ea\u6709 <code>fd</code> \u548c <code>bk</code> \u4e24\u4e2a\u5b57\u6bb5\u662f\u5408\u6cd5\u7684\uff0c\u5176\u4ed6\u5b57\u6bb5\u5982\u679c\u8bbf\u95ee\u4e86\uff0c\u5c31\u4f1a\u8bbf\u95ee\u5230\u5176\u4ed6 bin \u90a3\u91cc\u53bb</li>\n</ol>\n<p>\u629b\u5f00\u8fd9\u4e9b trick\uff0c\u5176\u5b9e\u5c31\u7b49\u4ef7\u4e8e\u7528\u4e00\u4e2a\u6570\u7ec4\u4fdd\u5b58\u4e86\u6bcf\u4e2a bin \u7684 <code>fd</code> \u548c <code>bk</code> \u6307\u9488\uff0c\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u8981\u5f3a\u884c\u8f6c\u6362\u6210 <code>malloc_chunk</code> \u7c7b\u578b\u7684\u6307\u9488\uff0c\u53ef\u80fd\u662f\u4e3a\u4e86\u65b9\u4fbf\u4ee3\u7801\u7684\u7f16\u5199\uff0c\u4e0d\u9700\u8981\u533a\u5206\u7a7a\u95f2\u5757\u7684\u7ed3\u70b9\u548c\u54e8\u5175\u7ed3\u70b9\u3002</p>\n<p>\u6b64\u5916\uff0csmall bin \u7684\u5904\u7406\u91cc\u8fd8\u591a\u4e86\u4e00\u6b21 <code>set_inuse_bit_at_offset (victim, nb)</code>\uff0c\u5b83\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-29-1\"><a id=\"__codelineno-29-1\" name=\"__codelineno-29-1\" href=\"#__codelineno-29-1\"></a><span class=\"cp\">#define set_inuse_bit_at_offset(p, s)                                              \\</span>\n</span><span id=\"__span-29-2\"><a id=\"__codelineno-29-2\" name=\"__codelineno-29-2\" href=\"#__codelineno-29-2\"></a><span class=\"cp\">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size |= PREV_INUSE)</span>\n</span></code></pre></div>\n<p>\u4e4d\u4e00\u770b\u4f1a\u89c9\u5f97\u5f88\u5947\u602a\uff0c\u8fd9\u4e2a\u8bbf\u95ee\u4e0d\u662f\u8d8a\u754c\u4e86\u5417\uff1f\u5176\u5b9e\u8fd9\u4e2a\u5c31\u662f\u8de8\u8fc7\u5f53\u524d\u7684 chunk\uff0c\u8bbf\u95ee\u76f8\u90bb\u7684\u4e0b\u4e00\u4e2a chunk\uff0c\u5728\u5b83\u7684 <code>mchunk_size</code> \u5b57\u6bb5\u4e0a\u6253\u6807\u8bb0\uff0c\u8868\u793a\u5b83\u7684\u524d\u4e00\u4e2a chunk \u5df2\u7ecf\u88ab\u5360\u7528\u3002\u524d\u9762\u63d0\u5230\u8fc7\uff0c<code>mchunk_size</code> \u540c\u65f6\u4fdd\u5b58\u4e86 chunk \u7684\u5927\u5c0f\u548c\u4e00\u4e9b flag\uff0c\u7531\u4e8e chunk \u7684\u5927\u5c0f\u81f3\u5c11\u662f 8 \u5b57\u8282\u5bf9\u9f50\u7684\uff0832 \u4f4d\u7cfb\u7edf\u4e0a\uff09\uff0c\u6240\u4ee5\u6700\u4f4e\u7684 3 \u4f4d\u5c31\u88ab\u62ff\u6765\u4fdd\u5b58\u5982\u4e0b\u7684 flag\uff1a</p>\n<ol>\n<li><code>PREV_INUSE(0x1)</code>: \u524d\u4e00\u4e2a chunk \u5df2\u7ecf\u88ab\u5206\u914d</li>\n<li><code>IS_MAPPED(0x2)</code>\uff1a\u5f53\u524d chunk \u7684\u5185\u5b58\u6765\u81ea\u4e8e mmap</li>\n<li><code>NON_MAIN_ARENA(0x4)</code>\uff1a\u5f53\u524d chunk \u6765\u81ea\u4e8e main arena \u4ee5\u5916\u7684\u5176\u4ed6 arena</li>\n</ol>\n<p>\u5728\u8fd9\u91cc\uff0c\u5c31\u662f\u8bbe\u7f6e\u4e86 <code>PREV_INUSE</code> flag\uff0c\u65b9\u4fbf\u540e\u7eed\u7684\u76f8\u90bb\u5757\u7684\u5408\u5e76\u3002</p>\n<p>\u53ef\u4ee5\u6ce8\u610f\u5230\uff0csmall bin \u7684\u5206\u914d\u8303\u56f4\u662f <code>nb &lt; MIN_LARGE_SIZE</code>\uff0c\u56e0\u6b64\u5728 64 \u4f4d\u4e0a\uff0c<code>malloc(1000)</code> \u6216\u66f4\u5c0f\u7684\u5206\u914d\u4f1a\u88ab small bin \u5206\u914d\uff0c\u800c <code>malloc(1001)</code> \u6216\u66f4\u5927\u7684\u5206\u914d\u5219\u4e0d\u53ef\u4ee5\u3002</p>\n<h3 id=\"free_2\">free<a class=\"headerlink\" href=\"#free_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u8bb2\u8ff0 small bin \u5728 free \u4e2d\u7684\u5b9e\u73b0\u4e4b\u524d\uff0c\u5148\u8ba8\u8bba <code>_int_malloc</code> \u7684\u540e\u7eed\u903b\u8f91\uff0c\u6700\u540e\u518d\u56de\u8fc7\u5934\u6765\u770b free \u7684\u90e8\u5206\u3002</p>\n<h2 id=\"consolidate\">consolidate<a class=\"headerlink\" href=\"#consolidate\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5f53\u8981\u5206\u914d\u7684\u5757\u7ecf\u8fc7 fast bin \u548c small bin \u4e24\u6bb5\u903b\u8f91\u90fd\u6ca1\u80fd\u5206\u914d\u6210\u529f\uff0c\u5e76\u4e14\u8981\u5206\u914d\u7684\u5757\u6bd4\u8f83\u5927\u7684\u65f6\u5019\uff08<code>!in_small_range (nb)</code>\uff09\uff0c\u4f1a\u8fdb\u884c\u4e00\u6b21 <code>malloc_consolidate</code> \u8c03\u7528\uff0c\u8fd9\u4e2a\u51fd\u6570\u4f1a\u5c1d\u8bd5\u5bf9 fast bin \u4e2d\u7684\u7a7a\u95f2\u5757\u8fdb\u884c\u5408\u5e76\uff0c\u7136\u540e\u628a\u65b0\u7684\u5757\u63d2\u5165\u5230 unsorted bin \u5f53\u4e2d\u3002\u5b83\u7684\u5b9e\u73b0\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-30-1\"><a id=\"__codelineno-30-1\" name=\"__codelineno-30-1\" href=\"#__codelineno-30-1\"></a><span class=\"n\">unsorted_bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-2\"><a id=\"__codelineno-30-2\" name=\"__codelineno-30-2\" href=\"#__codelineno-30-2\"></a><span class=\"n\">maxfb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NFASTBINS</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-3\"><a id=\"__codelineno-30-3\" name=\"__codelineno-30-3\" href=\"#__codelineno-30-3\"></a><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-4\"><a id=\"__codelineno-30-4\" name=\"__codelineno-30-4\" href=\"#__codelineno-30-4\"></a><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-5\"><a id=\"__codelineno-30-5\" name=\"__codelineno-30-5\" href=\"#__codelineno-30-5\"></a><span class=\"w\">  </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">atomic_exchange_acq</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-6\"><a id=\"__codelineno-30-6\" name=\"__codelineno-30-6\" href=\"#__codelineno-30-6\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-7\"><a id=\"__codelineno-30-7\" name=\"__codelineno-30-7\" href=\"#__codelineno-30-7\"></a><span class=\"w\">    </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-8\"><a id=\"__codelineno-30-8\" name=\"__codelineno-30-8\" href=\"#__codelineno-30-8\"></a><span class=\"w\">      </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-30-9\"><a id=\"__codelineno-30-9\" name=\"__codelineno-30-9\" href=\"#__codelineno-30-9\"></a>\n</span><span id=\"__span-30-10\"><a id=\"__codelineno-30-10\" name=\"__codelineno-30-10\" href=\"#__codelineno-30-10\"></a><span class=\"w\">      </span><span class=\"n\">check_inuse_chunk</span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-11\"><a id=\"__codelineno-30-11\" name=\"__codelineno-30-11\" href=\"#__codelineno-30-11\"></a><span class=\"w\">      </span><span class=\"n\">nextp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-12\"><a id=\"__codelineno-30-12\" name=\"__codelineno-30-12\" href=\"#__codelineno-30-12\"></a>\n</span><span id=\"__span-30-13\"><a id=\"__codelineno-30-13\" name=\"__codelineno-30-13\" href=\"#__codelineno-30-13\"></a><span class=\"w\">      </span><span class=\"cm\">/* Slightly streamlined version of consolidation code in free() */</span>\n</span><span id=\"__span-30-14\"><a id=\"__codelineno-30-14\" name=\"__codelineno-30-14\" href=\"#__codelineno-30-14\"></a><span class=\"w\">      </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-15\"><a id=\"__codelineno-30-15\" name=\"__codelineno-30-15\" href=\"#__codelineno-30-15\"></a><span class=\"w\">      </span><span class=\"n\">nextchunk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-16\"><a id=\"__codelineno-30-16\" name=\"__codelineno-30-16\" href=\"#__codelineno-30-16\"></a><span class=\"w\">      </span><span class=\"n\">nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-17\"><a id=\"__codelineno-30-17\" name=\"__codelineno-30-17\" href=\"#__codelineno-30-17\"></a>\n</span><span id=\"__span-30-18\"><a id=\"__codelineno-30-18\" name=\"__codelineno-30-18\" href=\"#__codelineno-30-18\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">prev_inuse</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-19\"><a id=\"__codelineno-30-19\" name=\"__codelineno-30-19\" href=\"#__codelineno-30-19\"></a><span class=\"w\">        </span><span class=\"n\">prevsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">prev_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-20\"><a id=\"__codelineno-30-20\" name=\"__codelineno-30-20\" href=\"#__codelineno-30-20\"></a><span class=\"w\">        </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">prevsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-21\"><a id=\"__codelineno-30-21\" name=\"__codelineno-30-21\" href=\"#__codelineno-30-21\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"p\">((</span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">prevsize</span><span class=\"p\">));</span>\n</span><span id=\"__span-30-22\"><a id=\"__codelineno-30-22\" name=\"__codelineno-30-22\" href=\"#__codelineno-30-22\"></a><span class=\"w\">        </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-30-23\"><a id=\"__codelineno-30-23\" name=\"__codelineno-30-23\" href=\"#__codelineno-30-23\"></a><span class=\"w\">        </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-24\"><a id=\"__codelineno-30-24\" name=\"__codelineno-30-24\" href=\"#__codelineno-30-24\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-25\"><a id=\"__codelineno-30-25\" name=\"__codelineno-30-25\" href=\"#__codelineno-30-25\"></a>\n</span><span id=\"__span-30-26\"><a id=\"__codelineno-30-26\" name=\"__codelineno-30-26\" href=\"#__codelineno-30-26\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-27\"><a id=\"__codelineno-30-27\" name=\"__codelineno-30-27\" href=\"#__codelineno-30-27\"></a><span class=\"w\">        </span><span class=\"n\">nextinuse</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inuse_bit_at_offset</span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nextsize</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-28\"><a id=\"__codelineno-30-28\" name=\"__codelineno-30-28\" href=\"#__codelineno-30-28\"></a>\n</span><span id=\"__span-30-29\"><a id=\"__codelineno-30-29\" name=\"__codelineno-30-29\" href=\"#__codelineno-30-29\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">nextinuse</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-30\"><a id=\"__codelineno-30-30\" name=\"__codelineno-30-30\" href=\"#__codelineno-30-30\"></a><span class=\"w\">          </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-31\"><a id=\"__codelineno-30-31\" name=\"__codelineno-30-31\" href=\"#__codelineno-30-31\"></a><span class=\"w\">          </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nextchunk</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-32\"><a id=\"__codelineno-30-32\" name=\"__codelineno-30-32\" href=\"#__codelineno-30-32\"></a><span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span>\n</span><span id=\"__span-30-33\"><a id=\"__codelineno-30-33\" name=\"__codelineno-30-33\" href=\"#__codelineno-30-33\"></a><span class=\"w\">          </span><span class=\"n\">clear_inuse_bit_at_offset</span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-34\"><a id=\"__codelineno-30-34\" name=\"__codelineno-30-34\" href=\"#__codelineno-30-34\"></a>\n</span><span id=\"__span-30-35\"><a id=\"__codelineno-30-35\" name=\"__codelineno-30-35\" href=\"#__codelineno-30-35\"></a><span class=\"w\">        </span><span class=\"n\">first_unsorted</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_bin</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-36\"><a id=\"__codelineno-30-36\" name=\"__codelineno-30-36\" href=\"#__codelineno-30-36\"></a><span class=\"w\">        </span><span class=\"n\">unsorted_bin</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-37\"><a id=\"__codelineno-30-37\" name=\"__codelineno-30-37\" href=\"#__codelineno-30-37\"></a><span class=\"w\">        </span><span class=\"n\">first_unsorted</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-38\"><a id=\"__codelineno-30-38\" name=\"__codelineno-30-38\" href=\"#__codelineno-30-38\"></a>\n</span><span id=\"__span-30-39\"><a id=\"__codelineno-30-39\" name=\"__codelineno-30-39\" href=\"#__codelineno-30-39\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-40\"><a id=\"__codelineno-30-40\" name=\"__codelineno-30-40\" href=\"#__codelineno-30-40\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-41\"><a id=\"__codelineno-30-41\" name=\"__codelineno-30-41\" href=\"#__codelineno-30-41\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-42\"><a id=\"__codelineno-30-42\" name=\"__codelineno-30-42\" href=\"#__codelineno-30-42\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-43\"><a id=\"__codelineno-30-43\" name=\"__codelineno-30-43\" href=\"#__codelineno-30-43\"></a>\n</span><span id=\"__span-30-44\"><a id=\"__codelineno-30-44\" name=\"__codelineno-30-44\" href=\"#__codelineno-30-44\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-45\"><a id=\"__codelineno-30-45\" name=\"__codelineno-30-45\" href=\"#__codelineno-30-45\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_bin</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-46\"><a id=\"__codelineno-30-46\" name=\"__codelineno-30-46\" href=\"#__codelineno-30-46\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">first_unsorted</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-47\"><a id=\"__codelineno-30-47\" name=\"__codelineno-30-47\" href=\"#__codelineno-30-47\"></a><span class=\"w\">        </span><span class=\"n\">set_foot</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-48\"><a id=\"__codelineno-30-48\" name=\"__codelineno-30-48\" href=\"#__codelineno-30-48\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-49\"><a id=\"__codelineno-30-49\" name=\"__codelineno-30-49\" href=\"#__codelineno-30-49\"></a>\n</span><span id=\"__span-30-50\"><a id=\"__codelineno-30-50\" name=\"__codelineno-30-50\" href=\"#__codelineno-30-50\"></a><span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-51\"><a id=\"__codelineno-30-51\" name=\"__codelineno-30-51\" href=\"#__codelineno-30-51\"></a><span class=\"w\">        </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-52\"><a id=\"__codelineno-30-52\" name=\"__codelineno-30-52\" href=\"#__codelineno-30-52\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-53\"><a id=\"__codelineno-30-53\" name=\"__codelineno-30-53\" href=\"#__codelineno-30-53\"></a><span class=\"w\">        </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-54\"><a id=\"__codelineno-30-54\" name=\"__codelineno-30-54\" href=\"#__codelineno-30-54\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-55\"><a id=\"__codelineno-30-55\" name=\"__codelineno-30-55\" href=\"#__codelineno-30-55\"></a>\n</span><span id=\"__span-30-56\"><a id=\"__codelineno-30-56\" name=\"__codelineno-30-56\" href=\"#__codelineno-30-56\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nextp</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-57\"><a id=\"__codelineno-30-57\" name=\"__codelineno-30-57\" href=\"#__codelineno-30-57\"></a>\n</span><span id=\"__span-30-58\"><a id=\"__codelineno-30-58\" name=\"__codelineno-30-58\" href=\"#__codelineno-30-58\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-59\"><a id=\"__codelineno-30-59\" name=\"__codelineno-30-59\" href=\"#__codelineno-30-59\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">maxfb</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<ol>\n<li>\u7b2c\u4e00\u5c42\u5faa\u73af\uff0c\u904d\u5386\u6bcf\u4e2a\u975e\u7a7a\u7684 fast bin\uff0c\u8fdb\u884c\u4e0b\u5217\u64cd\u4f5c</li>\n<li>\u7b2c\u4e8c\u5c42\u5faa\u73af\uff0c\u6bcf\u4e2a\u975e\u7a7a\u7684 fast bin \u6709\u4e00\u4e2a\u5355\u5411\u94fe\u8868\uff0c\u6cbf\u7740\u94fe\u8868\u8fdb\u884c\u8fed\u4ee3\uff0c\u904d\u5386\u94fe\u8868\u4e0a\u7684\u6bcf\u4e2a\u7a7a\u95f2\u5757\uff0c\u8fdb\u884c\u4e0b\u5217\u64cd\u4f5c</li>\n<li>\u5faa\u73af\u5185\u90e8\uff0c\u68c0\u67e5\u5f53\u524d\u7a7a\u95f2\u5757\u80fd\u5426\u548c\u524d\u540e\u7684\u7a7a\u95f2\u5757\u5408\u5e76</li>\n<li>\u9996\u5148\u68c0\u67e5\u5728\u5b83\u524d\u9762\uff08\u5730\u5740\u66f4\u4f4e\u7684\uff09\u76f8\u90bb\u7684\u5757\u662f\u5426\u7a7a\u95f2\uff1a\u5982\u679c <code>PREV_INUSE</code> \u6ca1\u6709\u88ab\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>mchunk_prev_size</code> \u627e\u5230\u524d\u9762\u76f8\u90bb\u7684\u5757\u7684\u5f00\u5934\uff0c\u7136\u540e\u628a\u4e24\u4e2a\u5757\u5408\u5e76\u8d77\u6765\uff1b\u5982\u679c\u524d\u9762\u76f8\u90bb\u7684\u5757\u5df2\u7ecf\u5728\u67d0\u4e2a\u53cc\u5411\u94fe\u8868\u5f53\u4e2d\uff08\u4f8b\u5982 small bin\uff09\uff0c\u628a\u5b83\u4ece\u53cc\u5411\u94fe\u8868\u4e2d\u5220\u9664\uff1a<code>unlink_chunk (av, p);</code>\uff1b\u4e3a\u4ec0\u4e48\u524d\u9762\u8981\u7528\u53cc\u5411\u94fe\u8868\uff0c\u4e5f\u662f\u4e3a\u4e86\u5728\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u4ece\u94fe\u8868\u4e2d\u95f4\u5220\u9664\u4e00\u4e2a\u7ed3\u70b9</li>\n<li>\u63a5\u7740\u68c0\u67e5\u5728\u5b83\u540e\u9762\uff08\u5730\u5740\u66f4\u9ad8\u7684\uff09\u76f8\u90bb\u7684\u5757\u662f\u5426\u7a7a\u95f2\uff1a\u6839\u636e\u81ea\u5df1\u7684 size\uff0c\u8ba1\u7b97\u51fa\u4e0b\u4e00\u4e2a\u5757\u7684\u5730\u5740\uff0c\u5f97\u5230\u4e0b\u4e00\u4e2a\u5757\u7684\u5927\u5c0f\uff0c\u518d\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5757\u7684\u4e0b\u4e00\u4e2a\u5757\uff0c\u6839\u636e\u5b83\u7684 <code>PREV_INUSE</code>\uff0c\u5224\u65ad\u4e0b\u4e00\u4e2a\u5757\u662f\u5426\u7a7a\u95f2\uff1b\u5982\u679c\u7a7a\u95f2\uff0c\u90a3\u5c31\u628a\u4e0b\u4e00\u4e2a\u5757\u4e5f\u5408\u5e76\u8fdb\u6765\uff0c\u540c\u7406\u4e5f\u8981\u628a\u5b83\u4ece\u53cc\u5411\u94fe\u8868\u4e2d\u5220\u9664\uff1a<code>unlink_chunk (av, nextchunk);</code>\uff1b\u4ee3\u7801\u4e2d\u8fd8\u6709\u5bf9 top chunk \u7684\u7279\u6b8a\u5904\u7406\uff0c\u8fd9\u91cc\u5148\u7565\u8fc7</li>\n<li>\u5408\u5e76\u5b8c\u6210\u4ee5\u540e\uff0c\u628a\u5f53\u524d\u7684\u7a7a\u95f2\u5757\u653e\u5230 unsorted bin \u5f53\u4e2d\uff0c\u4e5f\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u53cc\u5411\u94fe\u8868\u5411\u94fe\u8868\u5934\u7684\u63d2\u5165\u7b97\u6cd5\uff1a<code>first_unsorted = unsorted_bin-&gt;fd; unsorted_bin-&gt;fd = p; first_unsorted-&gt;bk = p; p-&gt;bk = unsorted_bin; p-&gt;fd = first_unsorted;</code></li>\n</ol>\n<p><code>unlink_chunk</code> \u7684\u5b9e\u73b0\u5c31\u662f\u7ecf\u5178\u7684\u53cc\u5411\u94fe\u8868\u5220\u9664\u7ed3\u70b9\u7684\u7b97\u6cd5\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-31-1\"><a id=\"__codelineno-31-1\" name=\"__codelineno-31-1\" href=\"#__codelineno-31-1\"></a><span class=\"cm\">/* Take a chunk off a bin list.  */</span>\n</span><span id=\"__span-31-2\"><a id=\"__codelineno-31-2\" name=\"__codelineno-31-2\" href=\"#__codelineno-31-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span>\n</span><span id=\"__span-31-3\"><a id=\"__codelineno-31-3\" name=\"__codelineno-31-3\" href=\"#__codelineno-31-3\"></a><span class=\"nf\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">mstate</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-4\"><a id=\"__codelineno-31-4\" name=\"__codelineno-31-4\" href=\"#__codelineno-31-4\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-31-5\"><a id=\"__codelineno-31-5\" name=\"__codelineno-31-5\" href=\"#__codelineno-31-5\"></a><span class=\"w\">  </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-31-6\"><a id=\"__codelineno-31-6\" name=\"__codelineno-31-6\" href=\"#__codelineno-31-6\"></a>\n</span><span id=\"__span-31-7\"><a id=\"__codelineno-31-7\" name=\"__codelineno-31-7\" href=\"#__codelineno-31-7\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-8\"><a id=\"__codelineno-31-8\" name=\"__codelineno-31-8\" href=\"#__codelineno-31-8\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-9\"><a id=\"__codelineno-31-9\" name=\"__codelineno-31-9\" href=\"#__codelineno-31-9\"></a>\n</span><span id=\"__span-31-10\"><a id=\"__codelineno-31-10\" name=\"__codelineno-31-10\" href=\"#__codelineno-31-10\"></a><span class=\"w\">  </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-31-11\"><a id=\"__codelineno-31-11\" name=\"__codelineno-31-11\" href=\"#__codelineno-31-11\"></a>\n</span><span id=\"__span-31-12\"><a id=\"__codelineno-31-12\" name=\"__codelineno-31-12\" href=\"#__codelineno-31-12\"></a><span class=\"w\">  </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-13\"><a id=\"__codelineno-31-13\" name=\"__codelineno-31-13\" href=\"#__codelineno-31-13\"></a><span class=\"w\">  </span><span class=\"n\">bk</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-14\"><a id=\"__codelineno-31-14\" name=\"__codelineno-31-14\" href=\"#__codelineno-31-14\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-15\"><a id=\"__codelineno-31-15\" name=\"__codelineno-31-15\" href=\"#__codelineno-31-15\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-16\"><a id=\"__codelineno-31-16\" name=\"__codelineno-31-16\" href=\"#__codelineno-31-16\"></a><span class=\"w\">      </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-31-17\"><a id=\"__codelineno-31-17\" name=\"__codelineno-31-17\" href=\"#__codelineno-31-17\"></a>\n</span><span id=\"__span-31-18\"><a id=\"__codelineno-31-18\" name=\"__codelineno-31-18\" href=\"#__codelineno-31-18\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-19\"><a id=\"__codelineno-31-19\" name=\"__codelineno-31-19\" href=\"#__codelineno-31-19\"></a><span class=\"w\">        </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-20\"><a id=\"__codelineno-31-20\" name=\"__codelineno-31-20\" href=\"#__codelineno-31-20\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-21\"><a id=\"__codelineno-31-21\" name=\"__codelineno-31-21\" href=\"#__codelineno-31-21\"></a><span class=\"w\">            </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-22\"><a id=\"__codelineno-31-22\" name=\"__codelineno-31-22\" href=\"#__codelineno-31-22\"></a><span class=\"w\">          </span><span class=\"k\">else</span>\n</span><span id=\"__span-31-23\"><a id=\"__codelineno-31-23\" name=\"__codelineno-31-23\" href=\"#__codelineno-31-23\"></a><span class=\"w\">            </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-24\"><a id=\"__codelineno-31-24\" name=\"__codelineno-31-24\" href=\"#__codelineno-31-24\"></a><span class=\"w\">              </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-25\"><a id=\"__codelineno-31-25\" name=\"__codelineno-31-25\" href=\"#__codelineno-31-25\"></a><span class=\"w\">              </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-26\"><a id=\"__codelineno-31-26\" name=\"__codelineno-31-26\" href=\"#__codelineno-31-26\"></a><span class=\"w\">              </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-27\"><a id=\"__codelineno-31-27\" name=\"__codelineno-31-27\" href=\"#__codelineno-31-27\"></a><span class=\"w\">              </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-28\"><a id=\"__codelineno-31-28\" name=\"__codelineno-31-28\" href=\"#__codelineno-31-28\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-29\"><a id=\"__codelineno-31-29\" name=\"__codelineno-31-29\" href=\"#__codelineno-31-29\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-30\"><a id=\"__codelineno-31-30\" name=\"__codelineno-31-30\" href=\"#__codelineno-31-30\"></a><span class=\"w\">      </span><span class=\"k\">else</span>\n</span><span id=\"__span-31-31\"><a id=\"__codelineno-31-31\" name=\"__codelineno-31-31\" href=\"#__codelineno-31-31\"></a><span class=\"w\">        </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-32\"><a id=\"__codelineno-31-32\" name=\"__codelineno-31-32\" href=\"#__codelineno-31-32\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-33\"><a id=\"__codelineno-31-33\" name=\"__codelineno-31-33\" href=\"#__codelineno-31-33\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-34\"><a id=\"__codelineno-31-34\" name=\"__codelineno-31-34\" href=\"#__codelineno-31-34\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-35\"><a id=\"__codelineno-31-35\" name=\"__codelineno-31-35\" href=\"#__codelineno-31-35\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-36\"><a id=\"__codelineno-31-36\" name=\"__codelineno-31-36\" href=\"#__codelineno-31-36\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u7684 <code>fd_nextsize</code> \u548c <code>bk_nextsize</code> \u5b57\u6bb5\u9002\u7528\u4e8e large bin\uff0c\u540e\u9762\u4f1a\u8ba8\u8bba\u8fd9\u4e2a\u53cc\u5411\u94fe\u8868\u7684\u7ec6\u8282\u3002</p>\n<p>\u56e0\u6b64 unsorted bin \u4fdd\u5b58\u4e86\u4e00\u4e9b\u4ece fast bin \u5408\u5e76\u800c\u6765\u7684\u4e00\u4e9b\u5757\uff0c\u7531\u4e8e unsorted bin \u53ea\u6709\u4e00\u4e2a\uff0c\u6240\u4ee5\u5b83\u91cc\u9762\u4f1a\u4fdd\u5b58\u5404\u79cd\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u3002\u5b9e\u9645\u4e0a\uff0cunsorted bin \u5360\u7528\u7684\u5c31\u662f <code>malloc_state</code> \u7ed3\u6784\u4e2d\u7684 bin 1\uff0c\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\uff0c\u5757\u7684\u5927\u5c0f\u81f3\u5c11\u662f 32\uff0c\u800c\u5927\u5c0f\u4e3a 32 \u7684\u5757\uff0c\u5bf9\u5e94\u7684 small bin index \u662f 2\uff0c\u8bf4\u660e 1 \u6ca1\u6709\u88ab\u7528\u5230\uff0c\u5176\u5b9e\u5c31\u662f\u7559\u7ed9 unsorted bin \u7528\u7684\u3002\u5728 64 \u4f4d\u7cfb\u7edf\u4e0b\uff0c<code>malloc_state</code> \u7684 127 \u4e2a bin \u5206\u914d\u5982\u4e0b\uff1a</p>\n<ol>\n<li>bin 1 \u662f unsorted bin</li>\n<li>bin 2 \u5230 bin 63 \u662f small bin</li>\n<li>bin 64 \u5230 bin 126 \u662f large bin</li>\n</ol>\n<p>bin 127 \u6ca1\u6709\u7528\u5230\u3002</p>\n<p>\u7ecf\u8fc7\u8fd9\u6b21\u5408\u5e76\u4e4b\u540e\uff0c\u63a5\u4e0b\u6765 <code>_int_malloc</code> \u5c1d\u8bd5\u4ece unsorted bin \u548c large bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\u3002</p>\n<h2 id=\"\u518d\u6b21\u56de\u5230-__libc_malloc\">\u518d\u6b21\u56de\u5230 <code>__libc_malloc</code><a class=\"headerlink\" href=\"#\u518d\u6b21\u56de\u5230-__libc_malloc\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\uff0c<code>_int_malloc</code> \u6709\u4e00\u5927\u6bb5\u4ee3\u7801\u6765\u8fdb\u884c\u540e\u7eed\u7684\u5185\u5b58\u5206\u914d\uff0c\u5927\u6982\u6b65\u9aa4\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u628a unsorted bin \u4e2d\u7684\u7a7a\u95f2\u5757\u7684\u5904\u7406\uff0c\u653e\u5230 small bin \u6216\u8005 large bin \u4e2d\uff0c\u540c\u65f6\u5982\u679c\u6709\u5408\u9002\u7684\u5757\uff0c\u5c31\u5206\u914d\u7ed9 malloc \u7684\u8c03\u7528\u8005</li>\n<li>\u5982\u679c\u8fd8\u662f\u6ca1\u6709\u627e\u5230\u5408\u9002\u5927\u5c0f\u7684\u5757\uff0c\u5c31\u5728 large bin \u91cc\u5bfb\u627e\u7a7a\u95f2\u5757\u6765\u5206\u914d\uff1b\u5982\u679c\u627e\u4e0d\u5230\u5408\u9002\u5927\u5c0f\u7684\u5757\uff0c\u8fdb\u884c consolidate\uff0c\u5c1d\u8bd5\u66f4\u591a\u7684\u5408\u5e76\uff0c\u5f97\u5230\u66f4\u5927\u7684\u5757\uff1b\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\u591a\u6b21</li>\n<li>\u5982\u679c\u8fd8\u662f\u627e\u4e0d\u5230\u5408\u9002\u7684\u5757\uff0c\u5c31\u4ece\u5806\u9876\u5206\u914d\u65b0\u7684\u5757\uff0c\u5982\u679c\u5806\u5df2\u7ecf\u6ee1\u4e86\uff0c\u8fd8\u9700\u8981\u53bb\u6269\u5927\u5806\uff0c\u6216\u8005\u76f4\u63a5\u7528 mmap \u5206\u914d\u4e00\u7247\u5185\u5b58</li>\n</ol>\n<p>\u73b0\u5728\u5206\u6b65\u9aa4\u89c2\u5bdf\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u9996\u5148\u89c2\u5bdf unsorted bin \u7684\u5904\u7406\u3002</p>\n<h2 id=\"unsorted-bin\">unsorted bin<a class=\"headerlink\" href=\"#unsorted-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u662f unsorted bin \u7684\u7a7a\u95f2\u5757\u7684\u5904\u7406\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-32-1\"><a id=\"__codelineno-32-1\" name=\"__codelineno-32-1\" href=\"#__codelineno-32-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">iters</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-2\"><a id=\"__codelineno-32-2\" name=\"__codelineno-32-2\" href=\"#__codelineno-32-2\"></a><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-3\"><a id=\"__codelineno-32-3\" name=\"__codelineno-32-3\" href=\"#__codelineno-32-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-4\"><a id=\"__codelineno-32-4\" name=\"__codelineno-32-4\" href=\"#__codelineno-32-4\"></a><span class=\"w\">    </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-5\"><a id=\"__codelineno-32-5\" name=\"__codelineno-32-5\" href=\"#__codelineno-32-5\"></a><span class=\"w\">    </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-6\"><a id=\"__codelineno-32-6\" name=\"__codelineno-32-6\" href=\"#__codelineno-32-6\"></a><span class=\"w\">    </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-7\"><a id=\"__codelineno-32-7\" name=\"__codelineno-32-7\" href=\"#__codelineno-32-7\"></a>\n</span><span id=\"__span-32-8\"><a id=\"__codelineno-32-8\" name=\"__codelineno-32-8\" href=\"#__codelineno-32-8\"></a><span class=\"w\">    </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-9\"><a id=\"__codelineno-32-9\" name=\"__codelineno-32-9\" href=\"#__codelineno-32-9\"></a>\n</span><span id=\"__span-32-10\"><a id=\"__codelineno-32-10\" name=\"__codelineno-32-10\" href=\"#__codelineno-32-10\"></a><span class=\"w\">    </span><span class=\"cm\">/*</span>\n</span><span id=\"__span-32-11\"><a id=\"__codelineno-32-11\" name=\"__codelineno-32-11\" href=\"#__codelineno-32-11\"></a><span class=\"cm\">       If a small request, try to use last remainder if it is the</span>\n</span><span id=\"__span-32-12\"><a id=\"__codelineno-32-12\" name=\"__codelineno-32-12\" href=\"#__codelineno-32-12\"></a><span class=\"cm\">       only chunk in unsorted bin.  This helps promote locality for</span>\n</span><span id=\"__span-32-13\"><a id=\"__codelineno-32-13\" name=\"__codelineno-32-13\" href=\"#__codelineno-32-13\"></a><span class=\"cm\">       runs of consecutive small requests. This is the only</span>\n</span><span id=\"__span-32-14\"><a id=\"__codelineno-32-14\" name=\"__codelineno-32-14\" href=\"#__codelineno-32-14\"></a><span class=\"cm\">       exception to best-fit, and applies only when there is</span>\n</span><span id=\"__span-32-15\"><a id=\"__codelineno-32-15\" name=\"__codelineno-32-15\" href=\"#__codelineno-32-15\"></a><span class=\"cm\">       no exact fit for a small chunk.</span>\n</span><span id=\"__span-32-16\"><a id=\"__codelineno-32-16\" name=\"__codelineno-32-16\" href=\"#__codelineno-32-16\"></a><span class=\"cm\">     */</span>\n</span><span id=\"__span-32-17\"><a id=\"__codelineno-32-17\" name=\"__codelineno-32-17\" href=\"#__codelineno-32-17\"></a>\n</span><span id=\"__span-32-18\"><a id=\"__codelineno-32-18\" name=\"__codelineno-32-18\" href=\"#__codelineno-32-18\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n</span><span id=\"__span-32-19\"><a id=\"__codelineno-32-19\" name=\"__codelineno-32-19\" href=\"#__codelineno-32-19\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n</span><span id=\"__span-32-20\"><a id=\"__codelineno-32-20\" name=\"__codelineno-32-20\" href=\"#__codelineno-32-20\"></a><span class=\"w\">        </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">last_remainder</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n</span><span id=\"__span-32-21\"><a id=\"__codelineno-32-21\" name=\"__codelineno-32-21\" href=\"#__codelineno-32-21\"></a><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-22\"><a id=\"__codelineno-32-22\" name=\"__codelineno-32-22\" href=\"#__codelineno-32-22\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-23\"><a id=\"__codelineno-32-23\" name=\"__codelineno-32-23\" href=\"#__codelineno-32-23\"></a><span class=\"w\">        </span><span class=\"cm\">/* split and reattach remainder */</span>\n</span><span id=\"__span-32-24\"><a id=\"__codelineno-32-24\" name=\"__codelineno-32-24\" href=\"#__codelineno-32-24\"></a><span class=\"w\">        </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-25\"><a id=\"__codelineno-32-25\" name=\"__codelineno-32-25\" href=\"#__codelineno-32-25\"></a><span class=\"w\">        </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-26\"><a id=\"__codelineno-32-26\" name=\"__codelineno-32-26\" href=\"#__codelineno-32-26\"></a><span class=\"w\">        </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-27\"><a id=\"__codelineno-32-27\" name=\"__codelineno-32-27\" href=\"#__codelineno-32-27\"></a><span class=\"w\">        </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">last_remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-28\"><a id=\"__codelineno-32-28\" name=\"__codelineno-32-28\" href=\"#__codelineno-32-28\"></a><span class=\"w\">        </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-29\"><a id=\"__codelineno-32-29\" name=\"__codelineno-32-29\" href=\"#__codelineno-32-29\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-30\"><a id=\"__codelineno-32-30\" name=\"__codelineno-32-30\" href=\"#__codelineno-32-30\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-31\"><a id=\"__codelineno-32-31\" name=\"__codelineno-32-31\" href=\"#__codelineno-32-31\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-32\"><a id=\"__codelineno-32-32\" name=\"__codelineno-32-32\" href=\"#__codelineno-32-32\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-33\"><a id=\"__codelineno-32-33\" name=\"__codelineno-32-33\" href=\"#__codelineno-32-33\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-34\"><a id=\"__codelineno-32-34\" name=\"__codelineno-32-34\" href=\"#__codelineno-32-34\"></a>\n</span><span id=\"__span-32-35\"><a id=\"__codelineno-32-35\" name=\"__codelineno-32-35\" href=\"#__codelineno-32-35\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-32-36\"><a id=\"__codelineno-32-36\" name=\"__codelineno-32-36\" href=\"#__codelineno-32-36\"></a><span class=\"w\">                  </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-37\"><a id=\"__codelineno-32-37\" name=\"__codelineno-32-37\" href=\"#__codelineno-32-37\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-38\"><a id=\"__codelineno-32-38\" name=\"__codelineno-32-38\" href=\"#__codelineno-32-38\"></a><span class=\"w\">        </span><span class=\"n\">set_foot</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-39\"><a id=\"__codelineno-32-39\" name=\"__codelineno-32-39\" href=\"#__codelineno-32-39\"></a>\n</span><span id=\"__span-32-40\"><a id=\"__codelineno-32-40\" name=\"__codelineno-32-40\" href=\"#__codelineno-32-40\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-41\"><a id=\"__codelineno-32-41\" name=\"__codelineno-32-41\" href=\"#__codelineno-32-41\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-42\"><a id=\"__codelineno-32-42\" name=\"__codelineno-32-42\" href=\"#__codelineno-32-42\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-43\"><a id=\"__codelineno-32-43\" name=\"__codelineno-32-43\" href=\"#__codelineno-32-43\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-44\"><a id=\"__codelineno-32-44\" name=\"__codelineno-32-44\" href=\"#__codelineno-32-44\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-45\"><a id=\"__codelineno-32-45\" name=\"__codelineno-32-45\" href=\"#__codelineno-32-45\"></a>\n</span><span id=\"__span-32-46\"><a id=\"__codelineno-32-46\" name=\"__codelineno-32-46\" href=\"#__codelineno-32-46\"></a><span class=\"w\">    </span><span class=\"cm\">/* remove from unsorted list */</span>\n</span><span id=\"__span-32-47\"><a id=\"__codelineno-32-47\" name=\"__codelineno-32-47\" href=\"#__codelineno-32-47\"></a><span class=\"w\">    </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-48\"><a id=\"__codelineno-32-48\" name=\"__codelineno-32-48\" href=\"#__codelineno-32-48\"></a><span class=\"w\">    </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-49\"><a id=\"__codelineno-32-49\" name=\"__codelineno-32-49\" href=\"#__codelineno-32-49\"></a><span class=\"w\">    </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-50\"><a id=\"__codelineno-32-50\" name=\"__codelineno-32-50\" href=\"#__codelineno-32-50\"></a>\n</span><span id=\"__span-32-51\"><a id=\"__codelineno-32-51\" name=\"__codelineno-32-51\" href=\"#__codelineno-32-51\"></a><span class=\"w\">    </span><span class=\"cm\">/* Take now instead of binning if exact fit */</span>\n</span><span id=\"__span-32-52\"><a id=\"__codelineno-32-52\" name=\"__codelineno-32-52\" href=\"#__codelineno-32-52\"></a>\n</span><span id=\"__span-32-53\"><a id=\"__codelineno-32-53\" name=\"__codelineno-32-53\" href=\"#__codelineno-32-53\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-54\"><a id=\"__codelineno-32-54\" name=\"__codelineno-32-54\" href=\"#__codelineno-32-54\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-55\"><a id=\"__codelineno-32-55\" name=\"__codelineno-32-55\" href=\"#__codelineno-32-55\"></a><span class=\"w\">        </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-56\"><a id=\"__codelineno-32-56\" name=\"__codelineno-32-56\" href=\"#__codelineno-32-56\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-57\"><a id=\"__codelineno-32-57\" name=\"__codelineno-32-57\" href=\"#__codelineno-32-57\"></a><span class=\"w\">          </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-58\"><a id=\"__codelineno-32-58\" name=\"__codelineno-32-58\" href=\"#__codelineno-32-58\"></a><span class=\"w\">        </span><span class=\"cm\">/* Fill cache first, return to user only if cache fills.</span>\n</span><span id=\"__span-32-59\"><a id=\"__codelineno-32-59\" name=\"__codelineno-32-59\" href=\"#__codelineno-32-59\"></a><span class=\"cm\">           We may return one of these chunks later.  */</span>\n</span><span id=\"__span-32-60\"><a id=\"__codelineno-32-60\" name=\"__codelineno-32-60\" href=\"#__codelineno-32-60\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache_nb</span>\n</span><span id=\"__span-32-61\"><a id=\"__codelineno-32-61\" name=\"__codelineno-32-61\" href=\"#__codelineno-32-61\"></a><span class=\"w\">            </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-62\"><a id=\"__codelineno-32-62\" name=\"__codelineno-32-62\" href=\"#__codelineno-32-62\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-63\"><a id=\"__codelineno-32-63\" name=\"__codelineno-32-63\" href=\"#__codelineno-32-63\"></a><span class=\"w\">            </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-64\"><a id=\"__codelineno-32-64\" name=\"__codelineno-32-64\" href=\"#__codelineno-32-64\"></a><span class=\"w\">            </span><span class=\"n\">return_cached</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-65\"><a id=\"__codelineno-32-65\" name=\"__codelineno-32-65\" href=\"#__codelineno-32-65\"></a><span class=\"w\">            </span><span class=\"k\">continue</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-66\"><a id=\"__codelineno-32-66\" name=\"__codelineno-32-66\" href=\"#__codelineno-32-66\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-67\"><a id=\"__codelineno-32-67\" name=\"__codelineno-32-67\" href=\"#__codelineno-32-67\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-68\"><a id=\"__codelineno-32-68\" name=\"__codelineno-32-68\" href=\"#__codelineno-32-68\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-69\"><a id=\"__codelineno-32-69\" name=\"__codelineno-32-69\" href=\"#__codelineno-32-69\"></a><span class=\"w\">            </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-70\"><a id=\"__codelineno-32-70\" name=\"__codelineno-32-70\" href=\"#__codelineno-32-70\"></a><span class=\"w\">            </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-71\"><a id=\"__codelineno-32-71\" name=\"__codelineno-32-71\" href=\"#__codelineno-32-71\"></a><span class=\"w\">            </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-72\"><a id=\"__codelineno-32-72\" name=\"__codelineno-32-72\" href=\"#__codelineno-32-72\"></a><span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-73\"><a id=\"__codelineno-32-73\" name=\"__codelineno-32-73\" href=\"#__codelineno-32-73\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-74\"><a id=\"__codelineno-32-74\" name=\"__codelineno-32-74\" href=\"#__codelineno-32-74\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-75\"><a id=\"__codelineno-32-75\" name=\"__codelineno-32-75\" href=\"#__codelineno-32-75\"></a>\n</span><span id=\"__span-32-76\"><a id=\"__codelineno-32-76\" name=\"__codelineno-32-76\" href=\"#__codelineno-32-76\"></a><span class=\"w\">    </span><span class=\"cm\">/* place chunk in bin */</span>\n</span><span id=\"__span-32-77\"><a id=\"__codelineno-32-77\" name=\"__codelineno-32-77\" href=\"#__codelineno-32-77\"></a>\n</span><span id=\"__span-32-78\"><a id=\"__codelineno-32-78\" name=\"__codelineno-32-78\" href=\"#__codelineno-32-78\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-79\"><a id=\"__codelineno-32-79\" name=\"__codelineno-32-79\" href=\"#__codelineno-32-79\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-80\"><a id=\"__codelineno-32-80\" name=\"__codelineno-32-80\" href=\"#__codelineno-32-80\"></a><span class=\"w\">        </span><span class=\"n\">victim_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">smallbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-81\"><a id=\"__codelineno-32-81\" name=\"__codelineno-32-81\" href=\"#__codelineno-32-81\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim_index</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-82\"><a id=\"__codelineno-32-82\" name=\"__codelineno-32-82\" href=\"#__codelineno-32-82\"></a><span class=\"w\">        </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-83\"><a id=\"__codelineno-32-83\" name=\"__codelineno-32-83\" href=\"#__codelineno-32-83\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-84\"><a id=\"__codelineno-32-84\" name=\"__codelineno-32-84\" href=\"#__codelineno-32-84\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-85\"><a id=\"__codelineno-32-85\" name=\"__codelineno-32-85\" href=\"#__codelineno-32-85\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-86\"><a id=\"__codelineno-32-86\" name=\"__codelineno-32-86\" href=\"#__codelineno-32-86\"></a><span class=\"w\">        </span><span class=\"n\">victim_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-87\"><a id=\"__codelineno-32-87\" name=\"__codelineno-32-87\" href=\"#__codelineno-32-87\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim_index</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-88\"><a id=\"__codelineno-32-88\" name=\"__codelineno-32-88\" href=\"#__codelineno-32-88\"></a><span class=\"w\">        </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-89\"><a id=\"__codelineno-32-89\" name=\"__codelineno-32-89\" href=\"#__codelineno-32-89\"></a>\n</span><span id=\"__span-32-90\"><a id=\"__codelineno-32-90\" name=\"__codelineno-32-90\" href=\"#__codelineno-32-90\"></a><span class=\"w\">        </span><span class=\"cm\">/* maintain large bins in sorted order */</span>\n</span><span id=\"__span-32-91\"><a id=\"__codelineno-32-91\" name=\"__codelineno-32-91\" href=\"#__codelineno-32-91\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-92\"><a id=\"__codelineno-32-92\" name=\"__codelineno-32-92\" href=\"#__codelineno-32-92\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-93\"><a id=\"__codelineno-32-93\" name=\"__codelineno-32-93\" href=\"#__codelineno-32-93\"></a><span class=\"w\">            </span><span class=\"cm\">/* Or with inuse bit to speed comparisons */</span>\n</span><span id=\"__span-32-94\"><a id=\"__codelineno-32-94\" name=\"__codelineno-32-94\" href=\"#__codelineno-32-94\"></a><span class=\"w\">            </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">|=</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-95\"><a id=\"__codelineno-32-95\" name=\"__codelineno-32-95\" href=\"#__codelineno-32-95\"></a><span class=\"w\">            </span><span class=\"cm\">/* if smaller than smallest, bypass loop below */</span>\n</span><span id=\"__span-32-96\"><a id=\"__codelineno-32-96\" name=\"__codelineno-32-96\" href=\"#__codelineno-32-96\"></a><span class=\"w\">            </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-97\"><a id=\"__codelineno-32-97\" name=\"__codelineno-32-97\" href=\"#__codelineno-32-97\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-98\"><a id=\"__codelineno-32-98\" name=\"__codelineno-32-98\" href=\"#__codelineno-32-98\"></a><span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-99\"><a id=\"__codelineno-32-99\" name=\"__codelineno-32-99\" href=\"#__codelineno-32-99\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-100\"><a id=\"__codelineno-32-100\" name=\"__codelineno-32-100\" href=\"#__codelineno-32-100\"></a><span class=\"w\">                </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-101\"><a id=\"__codelineno-32-101\" name=\"__codelineno-32-101\" href=\"#__codelineno-32-101\"></a><span class=\"w\">                </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-102\"><a id=\"__codelineno-32-102\" name=\"__codelineno-32-102\" href=\"#__codelineno-32-102\"></a>\n</span><span id=\"__span-32-103\"><a id=\"__codelineno-32-103\" name=\"__codelineno-32-103\" href=\"#__codelineno-32-103\"></a><span class=\"w\">                </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-104\"><a id=\"__codelineno-32-104\" name=\"__codelineno-32-104\" href=\"#__codelineno-32-104\"></a><span class=\"w\">                </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-105\"><a id=\"__codelineno-32-105\" name=\"__codelineno-32-105\" href=\"#__codelineno-32-105\"></a><span class=\"w\">                </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-106\"><a id=\"__codelineno-32-106\" name=\"__codelineno-32-106\" href=\"#__codelineno-32-106\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-107\"><a id=\"__codelineno-32-107\" name=\"__codelineno-32-107\" href=\"#__codelineno-32-107\"></a><span class=\"w\">            </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-108\"><a id=\"__codelineno-32-108\" name=\"__codelineno-32-108\" href=\"#__codelineno-32-108\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-109\"><a id=\"__codelineno-32-109\" name=\"__codelineno-32-109\" href=\"#__codelineno-32-109\"></a><span class=\"w\">                </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-110\"><a id=\"__codelineno-32-110\" name=\"__codelineno-32-110\" href=\"#__codelineno-32-110\"></a><span class=\"w\">                </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-111\"><a id=\"__codelineno-32-111\" name=\"__codelineno-32-111\" href=\"#__codelineno-32-111\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-112\"><a id=\"__codelineno-32-112\" name=\"__codelineno-32-112\" href=\"#__codelineno-32-112\"></a><span class=\"w\">                    </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-113\"><a id=\"__codelineno-32-113\" name=\"__codelineno-32-113\" href=\"#__codelineno-32-113\"></a><span class=\"w\">                    </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-114\"><a id=\"__codelineno-32-114\" name=\"__codelineno-32-114\" href=\"#__codelineno-32-114\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-115\"><a id=\"__codelineno-32-115\" name=\"__codelineno-32-115\" href=\"#__codelineno-32-115\"></a>\n</span><span id=\"__span-32-116\"><a id=\"__codelineno-32-116\" name=\"__codelineno-32-116\" href=\"#__codelineno-32-116\"></a><span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">size</span>\n</span><span id=\"__span-32-117\"><a id=\"__codelineno-32-117\" name=\"__codelineno-32-117\" href=\"#__codelineno-32-117\"></a><span class=\"w\">                    </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-118\"><a id=\"__codelineno-32-118\" name=\"__codelineno-32-118\" href=\"#__codelineno-32-118\"></a><span class=\"w\">                  </span><span class=\"cm\">/* Always insert in the second position.  */</span>\n</span><span id=\"__span-32-119\"><a id=\"__codelineno-32-119\" name=\"__codelineno-32-119\" href=\"#__codelineno-32-119\"></a><span class=\"w\">                  </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-120\"><a id=\"__codelineno-32-120\" name=\"__codelineno-32-120\" href=\"#__codelineno-32-120\"></a><span class=\"w\">                </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-121\"><a id=\"__codelineno-32-121\" name=\"__codelineno-32-121\" href=\"#__codelineno-32-121\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-122\"><a id=\"__codelineno-32-122\" name=\"__codelineno-32-122\" href=\"#__codelineno-32-122\"></a><span class=\"w\">                    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-123\"><a id=\"__codelineno-32-123\" name=\"__codelineno-32-123\" href=\"#__codelineno-32-123\"></a><span class=\"w\">                    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-124\"><a id=\"__codelineno-32-124\" name=\"__codelineno-32-124\" href=\"#__codelineno-32-124\"></a><span class=\"w\">                    </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-125\"><a id=\"__codelineno-32-125\" name=\"__codelineno-32-125\" href=\"#__codelineno-32-125\"></a><span class=\"w\">                    </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-126\"><a id=\"__codelineno-32-126\" name=\"__codelineno-32-126\" href=\"#__codelineno-32-126\"></a><span class=\"w\">                    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-127\"><a id=\"__codelineno-32-127\" name=\"__codelineno-32-127\" href=\"#__codelineno-32-127\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-128\"><a id=\"__codelineno-32-128\" name=\"__codelineno-32-128\" href=\"#__codelineno-32-128\"></a><span class=\"w\">                </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-129\"><a id=\"__codelineno-32-129\" name=\"__codelineno-32-129\" href=\"#__codelineno-32-129\"></a><span class=\"w\">                </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-130\"><a id=\"__codelineno-32-130\" name=\"__codelineno-32-130\" href=\"#__codelineno-32-130\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-131\"><a id=\"__codelineno-32-131\" name=\"__codelineno-32-131\" href=\"#__codelineno-32-131\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-132\"><a id=\"__codelineno-32-132\" name=\"__codelineno-32-132\" href=\"#__codelineno-32-132\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-133\"><a id=\"__codelineno-32-133\" name=\"__codelineno-32-133\" href=\"#__codelineno-32-133\"></a><span class=\"w\">          </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-134\"><a id=\"__codelineno-32-134\" name=\"__codelineno-32-134\" href=\"#__codelineno-32-134\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-135\"><a id=\"__codelineno-32-135\" name=\"__codelineno-32-135\" href=\"#__codelineno-32-135\"></a>\n</span><span id=\"__span-32-136\"><a id=\"__codelineno-32-136\" name=\"__codelineno-32-136\" href=\"#__codelineno-32-136\"></a><span class=\"w\">    </span><span class=\"n\">mark_bin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim_index</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-137\"><a id=\"__codelineno-32-137\" name=\"__codelineno-32-137\" href=\"#__codelineno-32-137\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-138\"><a id=\"__codelineno-32-138\" name=\"__codelineno-32-138\" href=\"#__codelineno-32-138\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-139\"><a id=\"__codelineno-32-139\" name=\"__codelineno-32-139\" href=\"#__codelineno-32-139\"></a><span class=\"w\">    </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-140\"><a id=\"__codelineno-32-140\" name=\"__codelineno-32-140\" href=\"#__codelineno-32-140\"></a><span class=\"w\">    </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-141\"><a id=\"__codelineno-32-141\" name=\"__codelineno-32-141\" href=\"#__codelineno-32-141\"></a>\n</span><span id=\"__span-32-142\"><a id=\"__codelineno-32-142\" name=\"__codelineno-32-142\" href=\"#__codelineno-32-142\"></a><span class=\"w\">    </span><span class=\"cm\">/* If we&#39;ve processed as many chunks as we&#39;re allowed while</span>\n</span><span id=\"__span-32-143\"><a id=\"__codelineno-32-143\" name=\"__codelineno-32-143\" href=\"#__codelineno-32-143\"></a><span class=\"cm\">       filling the cache, return one of the cached ones.  */</span>\n</span><span id=\"__span-32-144\"><a id=\"__codelineno-32-144\" name=\"__codelineno-32-144\" href=\"#__codelineno-32-144\"></a><span class=\"w\">    </span><span class=\"o\">++</span><span class=\"n\">tcache_unsorted_count</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-145\"><a id=\"__codelineno-32-145\" name=\"__codelineno-32-145\" href=\"#__codelineno-32-145\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">return_cached</span>\n</span><span id=\"__span-32-146\"><a id=\"__codelineno-32-146\" name=\"__codelineno-32-146\" href=\"#__codelineno-32-146\"></a><span class=\"w\">        </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_unsorted_limit</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</span><span id=\"__span-32-147\"><a id=\"__codelineno-32-147\" name=\"__codelineno-32-147\" href=\"#__codelineno-32-147\"></a><span class=\"w\">        </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache_unsorted_count</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_unsorted_limit</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-148\"><a id=\"__codelineno-32-148\" name=\"__codelineno-32-148\" href=\"#__codelineno-32-148\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-149\"><a id=\"__codelineno-32-149\" name=\"__codelineno-32-149\" href=\"#__codelineno-32-149\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-150\"><a id=\"__codelineno-32-150\" name=\"__codelineno-32-150\" href=\"#__codelineno-32-150\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-151\"><a id=\"__codelineno-32-151\" name=\"__codelineno-32-151\" href=\"#__codelineno-32-151\"></a>\n</span><span id=\"__span-32-152\"><a id=\"__codelineno-32-152\" name=\"__codelineno-32-152\" href=\"#__codelineno-32-152\"></a><span class=\"cp\">#define MAX_ITERS       10000</span>\n</span><span id=\"__span-32-153\"><a id=\"__codelineno-32-153\" name=\"__codelineno-32-153\" href=\"#__codelineno-32-153\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">++</span><span class=\"n\">iters</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">MAX_ITERS</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-154\"><a id=\"__codelineno-32-154\" name=\"__codelineno-32-154\" href=\"#__codelineno-32-154\"></a><span class=\"w\">      </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-155\"><a id=\"__codelineno-32-155\" name=\"__codelineno-32-155\" href=\"#__codelineno-32-155\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u904d\u5386 unsorted bin \u53cc\u5411\u94fe\u8868\uff0c\u4ece\u54e8\u5175\u7ed3\u70b9\u5f00\u59cb\uff0c\u4ece\u540e\u5f80\u524d\u904d\u5386\u7a7a\u95f2\u5757</li>\n<li>fast path \u903b\u8f91\uff1a\u5982\u679c\u8981\u7533\u8bf7\u7684\u5757\u6bd4\u5f53\u524d\u7a7a\u95f2\u5757\u5c0f\uff0c\u5e76\u4e14\u5f53\u524d\u7a7a\u95f2\u5757\u53ef\u4ee5\u62c6\u5206\uff0c\u90a3\u5c31\u62c6\u5206\u5f53\u524d\u7684\u7a7a\u95f2\u5757\uff0c\u7136\u540e\u76f4\u63a5\u5206\u914d\u62c6\u5206\u540e\u7684\u7a7a\u95f2\u5757</li>\n<li>\u5982\u679c\u8981\u7533\u8bf7\u7684\u5757\u7684\u5927\u5c0f\u548c\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u76f8\u540c\uff0c\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache\uff0c\u6216\u8005\u76f4\u63a5\u5206\u914d\u8fd9\u4e2a\u7a7a\u95f2\u5757</li>\n<li>\u628a\u5f53\u524d\u7a7a\u95f2\u5757\u6839\u636e\u5927\u5c0f\uff0c\u5206\u53d1\u5230 small bin \u6216\u8005 large bin</li>\n<li>\u5982\u679c tcache \u4e2d\u6709\u5408\u9002\u7684\u7a7a\u95f2\u5757\uff0c\u5c31\u5206\u914d\u5b83</li>\n</ol>\n<p>\u7531\u6b64\u53ef\u89c1\uff0cunsorted bin \u4e2d\u7684\u7a7a\u95f2\u5757\u5728 malloc \u7684\u65f6\u5019\u4f1a\u88ab\u5206\u6d3e\u5230\u5bf9\u5e94\u7684 small bin \u6216\u8005 large bin \u5f53\u4e2d\u3002small bin \u7684\u5904\u7406\u6bd4\u8f83\u7b80\u5355\uff0c\u56e0\u4e3a\u6bcf\u4e2a bin \u7684\u5757\u5927\u5c0f\u90fd\u76f8\u540c\uff0c\u76f4\u63a5\u52a0\u5165\u5230\u53cc\u5411\u94fe\u8868\u5373\u53ef\u3002large bin \u7684\u5904\u7406\u5219\u6bd4\u8f83\u590d\u6742\uff0c\u4e0b\u9762\u4e3b\u8981\u6765\u5206\u6790 large bin \u7684\u7ed3\u6784\u3002</p>\n<h2 id=\"large-bin\">large bin<a class=\"headerlink\" href=\"#large-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>large bin \u548c\u5176\u4ed6 bin \u7684\u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8e\uff0c\u5b83\u6bcf\u4e2a bin \u7684\u5927\u5c0f\u4e0d\u662f\u4e00\u4e2a\u56fa\u5b9a\u7684\u503c\uff0c\u800c\u662f\u4e00\u4e2a\u8303\u56f4\u3002\u5728 64 \u4f4d\u4e0b\uff0cbin 64 \u5230 bin 127 \u5bf9\u5e94\u7684\u5757\u5927\u5c0f\u8303\u56f4\uff1a</p>\n<ol>\n<li>bin 64 \u5230 bin 96: \u4ece 1024 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 64 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 64 \u5bf9\u5e94 1024-1087 \u5b57\u8282\u8303\u56f4\uff0cbin 96 \u5bf9\u5e94 3072-3135 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 97 \u5230 bin 111: \u4ece 3136 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 512 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 97 \u5bf9\u5e94 3136-3583 \u5b57\u8282\u8303\u56f4\uff08\u6ca1\u6709\u6db5\u76d6 512 \u5b57\u8282\u662f\u56e0\u4e3a\u5bf9\u9f50\u95ee\u9898\uff0c\u5176\u4ed6\u7684\u90fd\u662f\u6db5\u76d6 512 \u5b57\u8282\uff09\uff0cbin 111 \u5bf9\u5e94 10240-10751 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 112 \u5230 bin 119: \u4ece 10752 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 4096 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 112 \u5bf9\u5e94 10752-12287 \u5b57\u8282\u8303\u56f4\uff08\u6ca1\u6709\u6db5\u76d6 4096 \u5b57\u8282\u662f\u56e0\u4e3a\u5bf9\u9f50\u95ee\u9898\uff0c\u5176\u4ed6\u7684\u90fd\u662f\u6db5\u76d6 4096 \u5b57\u8282\uff09\uff0cbin 119 \u5bf9\u5e94 36864-40959 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 120 \u5230 bin 123: \u4ece 40960 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 32768 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 120 \u5bf9\u5e94 40960-65535 \u5b57\u8282\u8303\u56f4\uff08\u6ca1\u6709\u6db5\u76d6 32768 \u5b57\u8282\u662f\u56e0\u4e3a\u5bf9\u9f50\u95ee\u9898\uff0c\u5176\u4ed6\u7684\u90fd\u662f\u6db5\u76d6 32768 \u5b57\u8282\uff09\uff0cbin 123 \u5bf9\u5e94 131072-163839 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 124: 163840-262143 \u5171 98304 \u4e2a\u5b57\u8282\u7684\u8303\u56f4</li>\n<li>bin 125: 262144-524287 \u5171 262144 \u4e2a\u5b57\u8282\u7684\u8303\u56f4</li>\n<li>bin 126: 524288 \u6216\u66f4\u957f</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u6bd4\u8f83\u77ed\u7684\u957f\u5ea6\u8303\u56f4\u7ed9\u7684 bin \u4e5f\u6bd4\u8f83\u591a\uff0c\u540e\u9762\u5219\u66f4\u52a0\u7a00\u758f\u3002\u4e0a\u8ff0\u5404\u4e2a bin \u7684\u5927\u5c0f\u8303\u56f4\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u4ee3\u7801\u6253\u5370\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-33-1\"><a id=\"__codelineno-33-1\" name=\"__codelineno-33-1\" href=\"#__codelineno-33-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-33-2\"><a id=\"__codelineno-33-2\" name=\"__codelineno-33-2\" href=\"#__codelineno-33-2\"></a><span class=\"cp\">#define largebin_index_64(sz)                                                  \\</span>\n</span><span id=\"__span-33-3\"><a id=\"__codelineno-33-3\" name=\"__codelineno-33-3\" href=\"#__codelineno-33-3\"></a><span class=\"cp\">  (((((unsigned long)(sz)) &gt;&gt; 6) &lt;= 48)                                        \\</span>\n</span><span id=\"__span-33-4\"><a id=\"__codelineno-33-4\" name=\"__codelineno-33-4\" href=\"#__codelineno-33-4\"></a><span class=\"cp\">       ? 48 + (((unsigned long)(sz)) &gt;&gt; 6)                                     \\</span>\n</span><span id=\"__span-33-5\"><a id=\"__codelineno-33-5\" name=\"__codelineno-33-5\" href=\"#__codelineno-33-5\"></a><span class=\"cp\">       : ((((unsigned long)(sz)) &gt;&gt; 9) &lt;= 20)                                  \\</span>\n</span><span id=\"__span-33-6\"><a id=\"__codelineno-33-6\" name=\"__codelineno-33-6\" href=\"#__codelineno-33-6\"></a><span class=\"cp\">             ? 91 + (((unsigned long)(sz)) &gt;&gt; 9)                               \\</span>\n</span><span id=\"__span-33-7\"><a id=\"__codelineno-33-7\" name=\"__codelineno-33-7\" href=\"#__codelineno-33-7\"></a><span class=\"cp\">             : ((((unsigned long)(sz)) &gt;&gt; 12) &lt;= 10)                           \\</span>\n</span><span id=\"__span-33-8\"><a id=\"__codelineno-33-8\" name=\"__codelineno-33-8\" href=\"#__codelineno-33-8\"></a><span class=\"cp\">                   ? 110 + (((unsigned long)(sz)) &gt;&gt; 12)                       \\</span>\n</span><span id=\"__span-33-9\"><a id=\"__codelineno-33-9\" name=\"__codelineno-33-9\" href=\"#__codelineno-33-9\"></a><span class=\"cp\">                   : ((((unsigned long)(sz)) &gt;&gt; 15) &lt;= 4)                      \\</span>\n</span><span id=\"__span-33-10\"><a id=\"__codelineno-33-10\" name=\"__codelineno-33-10\" href=\"#__codelineno-33-10\"></a><span class=\"cp\">                         ? 119 + (((unsigned long)(sz)) &gt;&gt; 15)                 \\</span>\n</span><span id=\"__span-33-11\"><a id=\"__codelineno-33-11\" name=\"__codelineno-33-11\" href=\"#__codelineno-33-11\"></a><span class=\"cp\">                         : ((((unsigned long)(sz)) &gt;&gt; 18) &lt;= 2)                \\</span>\n</span><span id=\"__span-33-12\"><a id=\"__codelineno-33-12\" name=\"__codelineno-33-12\" href=\"#__codelineno-33-12\"></a><span class=\"cp\">                               ? 124 + (((unsigned long)(sz)) &gt;&gt; 18)           \\</span>\n</span><span id=\"__span-33-13\"><a id=\"__codelineno-33-13\" name=\"__codelineno-33-13\" href=\"#__codelineno-33-13\"></a><span class=\"cp\">                               : 126)</span>\n</span><span id=\"__span-33-14\"><a id=\"__codelineno-33-14\" name=\"__codelineno-33-14\" href=\"#__codelineno-33-14\"></a>\n</span><span id=\"__span-33-15\"><a id=\"__codelineno-33-15\" name=\"__codelineno-33-15\" href=\"#__codelineno-33-15\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-33-16\"><a id=\"__codelineno-33-16\" name=\"__codelineno-33-16\" href=\"#__codelineno-33-16\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index_64</span><span class=\"p\">(</span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-17\"><a id=\"__codelineno-33-17\" name=\"__codelineno-33-17\" href=\"#__codelineno-33-17\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">;</span>\n</span><span id=\"__span-33-18\"><a id=\"__codelineno-33-18\" name=\"__codelineno-33-18\" href=\"#__codelineno-33-18\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1000000</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-33-19\"><a id=\"__codelineno-33-19\" name=\"__codelineno-33-19\" href=\"#__codelineno-33-19\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">largebin_index_64</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-33-20\"><a id=\"__codelineno-33-20\" name=\"__codelineno-33-20\" href=\"#__codelineno-33-20\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;%d-%d: %d, length %d</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-21\"><a id=\"__codelineno-33-21\" name=\"__codelineno-33-21\" href=\"#__codelineno-33-21\"></a><span class=\"w\">      </span><span class=\"n\">last_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span>\n</span><span id=\"__span-33-22\"><a id=\"__codelineno-33-22\" name=\"__codelineno-33-22\" href=\"#__codelineno-33-22\"></a><span class=\"w\">      </span><span class=\"n\">last_bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index_64</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-23\"><a id=\"__codelineno-33-23\" name=\"__codelineno-33-23\" href=\"#__codelineno-33-23\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-33-24\"><a id=\"__codelineno-33-24\" name=\"__codelineno-33-24\" href=\"#__codelineno-33-24\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-33-25\"><a id=\"__codelineno-33-25\" name=\"__codelineno-33-25\" href=\"#__codelineno-33-25\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;%d-inf: %d</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-26\"><a id=\"__codelineno-33-26\" name=\"__codelineno-33-26\" href=\"#__codelineno-33-26\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-33-27\"><a id=\"__codelineno-33-27\" name=\"__codelineno-33-27\" href=\"#__codelineno-33-27\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u56e0\u6b64 large bin \u91cc\u9762\u4f1a\u6709\u4e0d\u540c chunk \u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u3002\u4e3a\u4e86\u5feb\u901f\u5730\u5bfb\u627e\u60f3\u8981\u7684\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0clarge bin \u4e2d\u7a7a\u95f2\u5757\u6309\u7167\u4ece\u5927\u5230\u5c0f\u7684\u987a\u5e8f\u7ec4\u6210\u94fe\u8868\uff0c\u540c\u65f6\u901a\u8fc7 <code>fd_nextsize</code> \u548c <code>bk_nextsize</code> \u628a\u6bcf\u79cd\u5927\u5c0f\u51fa\u73b0\u7684\u7b2c\u4e00\u4e2a\u5757\u7ec4\u6210\u53cc\u5411\u94fe\u8868\u3002\u5927\u81f4\u7684\u8fde\u63a5\u65b9\u5f0f\u5982\u4e0b\uff0c\u53c2\u8003\u4e86 <a href=\"https://sourceware.org/glibc/wiki/MallocInternals\">Malloc Internals</a> \u7ed9\u7684\u793a\u4f8b\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-34-1\"><a id=\"__codelineno-34-1\" name=\"__codelineno-34-1\" href=\"#__codelineno-34-1\"></a>  bins[id]      chunk A              chunk B              chunk C\n</span><span id=\"__span-34-2\"><a id=\"__codelineno-34-2\" name=\"__codelineno-34-2\" href=\"#__codelineno-34-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-3\"><a id=\"__codelineno-34-3\" name=\"__codelineno-34-3\" href=\"#__codelineno-34-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1040     |\n</span><span id=\"__span-34-4\"><a id=\"__codelineno-34-4\" name=\"__codelineno-34-4\" href=\"#__codelineno-34-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-5\"><a id=\"__codelineno-34-5\" name=\"__codelineno-34-5\" href=\"#__codelineno-34-5\"></a>| bk = C   |  | fd = B          |  | fd = C          |  | fd = bins[id]   |\n</span><span id=\"__span-34-6\"><a id=\"__codelineno-34-6\" name=\"__codelineno-34-6\" href=\"#__codelineno-34-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-7\"><a id=\"__codelineno-34-7\" name=\"__codelineno-34-7\" href=\"#__codelineno-34-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |\n</span><span id=\"__span-34-8\"><a id=\"__codelineno-34-8\" name=\"__codelineno-34-8\" href=\"#__codelineno-34-8\"></a>              +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-9\"><a id=\"__codelineno-34-9\" name=\"__codelineno-34-9\" href=\"#__codelineno-34-9\"></a>              | fd_nextsize = C |                       | fd_nextsize = A |\n</span><span id=\"__span-34-10\"><a id=\"__codelineno-34-10\" name=\"__codelineno-34-10\" href=\"#__codelineno-34-10\"></a>              +-----------------+                       +-----------------+\n</span><span id=\"__span-34-11\"><a id=\"__codelineno-34-11\" name=\"__codelineno-34-11\" href=\"#__codelineno-34-11\"></a>              | bk_nextsize = C |                       | bk_nextsize = A |\n</span><span id=\"__span-34-12\"><a id=\"__codelineno-34-12\" name=\"__codelineno-34-12\" href=\"#__codelineno-34-12\"></a>              +-----------------+                       +-----------------+\n</span></code></pre></div>\n<p>\u5373\u6240\u6709\u7684\u7a7a\u95f2\u5757\u52a0\u54e8\u5175\u7ec4\u6210\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u4ece\u5927\u5230\u5c0f\u6309\u7167 <code>A -&gt; B -&gt; C</code> \u7684\u987a\u5e8f\u8fde\u63a5\uff1b\u7136\u540e\u6bcf\u79cd\u5927\u5c0f\u7684\u7b2c\u4e00\u4e2a\u5757 <code>A</code> \u548c <code>C</code> \u5355\u72ec\u5728\u4e00\u4e2a nextsize \u94fe\u8868\u5f53\u4e2d\u3002</p>\n<p>\u56e0\u6b64\u5728\u63d2\u5165 large bin \u7684\u65f6\u5019\uff0c\u5206\u5982\u4e0b\u51e0\u79cd\u60c5\u51b5\uff1a</p>\n<p>\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u5982\u679c\u65b0\u63d2\u5165\u7684\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u6bd4\u76ee\u524d\u5df2\u6709\u7a7a\u95f2\u5757\u90fd\u5c0f\uff0c\u5219\u76f4\u63a5\u63d2\u5165\u5230\u7a7a\u95f2\u5757\u548c nextsize \u94fe\u8868\u7684\u5c3e\u90e8\u3002\u4f8b\u5982\u8981\u63d2\u5165\u4e00\u4e2a <code>size = 1024</code> \u7684\u7a7a\u95f2\u5757 D\uff0c\u63d2\u5165\u540e\u72b6\u6001\u4e3a\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-35-1\"><a id=\"__codelineno-35-1\" name=\"__codelineno-35-1\" href=\"#__codelineno-35-1\"></a>  bins[id]      chunk A              chunk B              chunk C              chunk D          \n</span><span id=\"__span-35-2\"><a id=\"__codelineno-35-2\" name=\"__codelineno-35-2\" href=\"#__codelineno-35-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-3\"><a id=\"__codelineno-35-3\" name=\"__codelineno-35-3\" href=\"#__codelineno-35-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1040     |  | size = 1024     |\n</span><span id=\"__span-35-4\"><a id=\"__codelineno-35-4\" name=\"__codelineno-35-4\" href=\"#__codelineno-35-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-5\"><a id=\"__codelineno-35-5\" name=\"__codelineno-35-5\" href=\"#__codelineno-35-5\"></a>| bk = D   |  | fd = B          |  | fd = C          |  | fd = D          |  | fd = bins[id]   |\n</span><span id=\"__span-35-6\"><a id=\"__codelineno-35-6\" name=\"__codelineno-35-6\" href=\"#__codelineno-35-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-7\"><a id=\"__codelineno-35-7\" name=\"__codelineno-35-7\" href=\"#__codelineno-35-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |  | bk = C          |\n</span><span id=\"__span-35-8\"><a id=\"__codelineno-35-8\" name=\"__codelineno-35-8\" href=\"#__codelineno-35-8\"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-9\"><a id=\"__codelineno-35-9\" name=\"__codelineno-35-9\" href=\"#__codelineno-35-9\"></a>              | fd_nextsize = C |                       | fd_nextsize = D |  | fd_nextsize = A |\n</span><span id=\"__span-35-10\"><a id=\"__codelineno-35-10\" name=\"__codelineno-35-10\" href=\"#__codelineno-35-10\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span><span id=\"__span-35-11\"><a id=\"__codelineno-35-11\" name=\"__codelineno-35-11\" href=\"#__codelineno-35-11\"></a>              | bk_nextsize = D |                       | bk_nextsize = A |  | bk_nextsize = C |\n</span><span id=\"__span-35-12\"><a id=\"__codelineno-35-12\" name=\"__codelineno-35-12\" href=\"#__codelineno-35-12\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span></code></pre></div>\n<p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u5728\u904d\u5386 nextsize \u94fe\u8868\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u5df2\u7ecf\u6709\u5927\u5c0f\u76f8\u540c\u7684\u5757\uff0c\u90a3\u5c31\u628a\u65b0\u7684\u5757\u63d2\u5165\u5230\u5b83\u7684\u540e\u9762\u3002\u4f8b\u5982\u8981\u63d2\u5165\u4e00\u4e2a <code>size = 1072</code> \u7684\u7a7a\u95f2\u5757 D\uff0c\u901a\u8fc7\u904d\u5386 nextsize \u94fe\u8868\u627e\u5230\u4e86 A\uff0c\u63d2\u5165\u4e4b\u540e\u7684\u72b6\u6001\u4e3a\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-36-1\"><a id=\"__codelineno-36-1\" name=\"__codelineno-36-1\" href=\"#__codelineno-36-1\"></a>  bins[id]      chunk A              chunk D              chunk B              chunk C          \n</span><span id=\"__span-36-2\"><a id=\"__codelineno-36-2\" name=\"__codelineno-36-2\" href=\"#__codelineno-36-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-3\"><a id=\"__codelineno-36-3\" name=\"__codelineno-36-3\" href=\"#__codelineno-36-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1072     |  | size = 1040     |\n</span><span id=\"__span-36-4\"><a id=\"__codelineno-36-4\" name=\"__codelineno-36-4\" href=\"#__codelineno-36-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-5\"><a id=\"__codelineno-36-5\" name=\"__codelineno-36-5\" href=\"#__codelineno-36-5\"></a>| bk = C   |  | fd = D          |  | fd = B          |  | fd = C          |  | fd = bins[id]   |\n</span><span id=\"__span-36-6\"><a id=\"__codelineno-36-6\" name=\"__codelineno-36-6\" href=\"#__codelineno-36-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-7\"><a id=\"__codelineno-36-7\" name=\"__codelineno-36-7\" href=\"#__codelineno-36-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = D          |  | bk = C          |\n</span><span id=\"__span-36-8\"><a id=\"__codelineno-36-8\" name=\"__codelineno-36-8\" href=\"#__codelineno-36-8\"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-9\"><a id=\"__codelineno-36-9\" name=\"__codelineno-36-9\" href=\"#__codelineno-36-9\"></a>              | fd_nextsize = C |                                            | fd_nextsize = A |\n</span><span id=\"__span-36-10\"><a id=\"__codelineno-36-10\" name=\"__codelineno-36-10\" href=\"#__codelineno-36-10\"></a>              +-----------------+                                            +-----------------+\n</span><span id=\"__span-36-11\"><a id=\"__codelineno-36-11\" name=\"__codelineno-36-11\" href=\"#__codelineno-36-11\"></a>              | bk_nextsize = C |                                            | bk_nextsize = A |\n</span><span id=\"__span-36-12\"><a id=\"__codelineno-36-12\" name=\"__codelineno-36-12\" href=\"#__codelineno-36-12\"></a>              +-----------------+                                            +-----------------+\n</span></code></pre></div>\n<p>\u7b2c\u4e09\u79cd\u60c5\u51b5\uff0c\u5728\u904d\u5386 nextsize \u94fe\u8868\u8fc7\u7a0b\u4e2d\uff0c\u6ca1\u6709\u5927\u5c0f\u76f8\u540c\u7684\u5757\uff0c\u90a3\u5c31\u6309\u7167\u4ece\u5927\u5230\u5c0f\u7684\u987a\u5e8f\u63d2\u5165\u5230\u5408\u9002\u7684\u4f4d\u7f6e\u3002\u4f8b\u5982\u8981\u63d2\u5165\u4e00\u4e2a <code>size = 1056</code> \u7684\u7a7a\u95f2\u5757 D\uff0c\u901a\u8fc7\u904d\u5386 nextsize \u94fe\u8868\u627e\u5230\u4e86 A \u548c C\uff0c\u63d2\u5165\u4e4b\u540e\u7684\u72b6\u6001\u4e3a\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-37-1\"><a id=\"__codelineno-37-1\" name=\"__codelineno-37-1\" href=\"#__codelineno-37-1\"></a>  bins[id]      chunk A              chunk B              chunk D              chunk C          \n</span><span id=\"__span-37-2\"><a id=\"__codelineno-37-2\" name=\"__codelineno-37-2\" href=\"#__codelineno-37-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-3\"><a id=\"__codelineno-37-3\" name=\"__codelineno-37-3\" href=\"#__codelineno-37-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1056     |  | size = 1040     |\n</span><span id=\"__span-37-4\"><a id=\"__codelineno-37-4\" name=\"__codelineno-37-4\" href=\"#__codelineno-37-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-5\"><a id=\"__codelineno-37-5\" name=\"__codelineno-37-5\" href=\"#__codelineno-37-5\"></a>| bk = D   |  | fd = B          |  | fd = D          |  | fd = C          |  | fd = bins[id]   |\n</span><span id=\"__span-37-6\"><a id=\"__codelineno-37-6\" name=\"__codelineno-37-6\" href=\"#__codelineno-37-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-7\"><a id=\"__codelineno-37-7\" name=\"__codelineno-37-7\" href=\"#__codelineno-37-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |  | bk = D          |\n</span><span id=\"__span-37-8\"><a id=\"__codelineno-37-8\" name=\"__codelineno-37-8\" href=\"#__codelineno-37-8\"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-9\"><a id=\"__codelineno-37-9\" name=\"__codelineno-37-9\" href=\"#__codelineno-37-9\"></a>              | fd_nextsize = D |                       | fd_nextsize = C |  | fd_nextsize = A |\n</span><span id=\"__span-37-10\"><a id=\"__codelineno-37-10\" name=\"__codelineno-37-10\" href=\"#__codelineno-37-10\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span><span id=\"__span-37-11\"><a id=\"__codelineno-37-11\" name=\"__codelineno-37-11\" href=\"#__codelineno-37-11\"></a>              | bk_nextsize = C |                       | bk_nextsize = A |  | bk_nextsize = D |\n</span><span id=\"__span-37-12\"><a id=\"__codelineno-37-12\" name=\"__codelineno-37-12\" href=\"#__codelineno-37-12\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u4fdd\u8bc1\u4e86\u63d2\u5165\u4ee5\u540e\u7684 large bin\uff0c\u4f9d\u7136\u6ee1\u8db3\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\uff0c\u5e76\u4e14\u6bcf\u79cd\u5927\u5c0f\u7684\u7b2c\u4e00\u4e2a\u5757\u7ec4\u6210 nextsize \u94fe\u8868\u7684\u6027\u8d28\u3002</p>\n<h3 id=\"malloc_4\">malloc<a class=\"headerlink\" href=\"#malloc_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u7740\u56de\u5230 <code>_libc_malloc</code>\u3002\u524d\u9762\u63d0\u5230\uff0cunsorted bin \u4e2d\u7a7a\u95f2\u5757\u5df2\u7ecf\u88ab\u632a\u5230\u4e86 small bin \u6216\u8005 large bin\uff0c\u5e76\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u628a\u5408\u9002\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u76f4\u63a5\u5206\u914d\u3002\u5982\u679c\u8fd8\u662f\u6ca1\u6709\u5206\u914d\u6210\u529f\uff0c\u63a5\u4e0b\u6765\u5c31\u8981\u5728 large bin \u91cc\u5bfb\u627e\u4e00\u4e2a\u5757\u6765\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-38-1\"><a id=\"__codelineno-38-1\" name=\"__codelineno-38-1\" href=\"#__codelineno-38-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-2\"><a id=\"__codelineno-38-2\" name=\"__codelineno-38-2\" href=\"#__codelineno-38-2\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-3\"><a id=\"__codelineno-38-3\" name=\"__codelineno-38-3\" href=\"#__codelineno-38-3\"></a><span class=\"w\">    </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-4\"><a id=\"__codelineno-38-4\" name=\"__codelineno-38-4\" href=\"#__codelineno-38-4\"></a>\n</span><span id=\"__span-38-5\"><a id=\"__codelineno-38-5\" name=\"__codelineno-38-5\" href=\"#__codelineno-38-5\"></a><span class=\"w\">    </span><span class=\"cm\">/* skip scan if empty or largest chunk is too small */</span>\n</span><span id=\"__span-38-6\"><a id=\"__codelineno-38-6\" name=\"__codelineno-38-6\" href=\"#__codelineno-38-6\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bin</span>\n</span><span id=\"__span-38-7\"><a id=\"__codelineno-38-7\" name=\"__codelineno-38-7\" href=\"#__codelineno-38-7\"></a><span class=\"w\">        </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-8\"><a id=\"__codelineno-38-8\" name=\"__codelineno-38-8\" href=\"#__codelineno-38-8\"></a><span class=\"w\">          </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-9\"><a id=\"__codelineno-38-9\" name=\"__codelineno-38-9\" href=\"#__codelineno-38-9\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-10\"><a id=\"__codelineno-38-10\" name=\"__codelineno-38-10\" href=\"#__codelineno-38-10\"></a><span class=\"w\">        </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-11\"><a id=\"__codelineno-38-11\" name=\"__codelineno-38-11\" href=\"#__codelineno-38-11\"></a><span class=\"w\">        </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">&lt;</span>\n</span><span id=\"__span-38-12\"><a id=\"__codelineno-38-12\" name=\"__codelineno-38-12\" href=\"#__codelineno-38-12\"></a><span class=\"w\">                </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">)))</span>\n</span><span id=\"__span-38-13\"><a id=\"__codelineno-38-13\" name=\"__codelineno-38-13\" href=\"#__codelineno-38-13\"></a><span class=\"w\">          </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-14\"><a id=\"__codelineno-38-14\" name=\"__codelineno-38-14\" href=\"#__codelineno-38-14\"></a>\n</span><span id=\"__span-38-15\"><a id=\"__codelineno-38-15\" name=\"__codelineno-38-15\" href=\"#__codelineno-38-15\"></a><span class=\"w\">        </span><span class=\"cm\">/* Avoid removing the first entry for a size so that the skip</span>\n</span><span id=\"__span-38-16\"><a id=\"__codelineno-38-16\" name=\"__codelineno-38-16\" href=\"#__codelineno-38-16\"></a><span class=\"cm\">           list does not have to be rerouted.  */</span>\n</span><span id=\"__span-38-17\"><a id=\"__codelineno-38-17\" name=\"__codelineno-38-17\" href=\"#__codelineno-38-17\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-18\"><a id=\"__codelineno-38-18\" name=\"__codelineno-38-18\" href=\"#__codelineno-38-18\"></a><span class=\"w\">            </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-19\"><a id=\"__codelineno-38-19\" name=\"__codelineno-38-19\" href=\"#__codelineno-38-19\"></a><span class=\"w\">              </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-20\"><a id=\"__codelineno-38-20\" name=\"__codelineno-38-20\" href=\"#__codelineno-38-20\"></a><span class=\"w\">          </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-21\"><a id=\"__codelineno-38-21\" name=\"__codelineno-38-21\" href=\"#__codelineno-38-21\"></a>\n</span><span id=\"__span-38-22\"><a id=\"__codelineno-38-22\" name=\"__codelineno-38-22\" href=\"#__codelineno-38-22\"></a><span class=\"w\">        </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-23\"><a id=\"__codelineno-38-23\" name=\"__codelineno-38-23\" href=\"#__codelineno-38-23\"></a><span class=\"w\">        </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-24\"><a id=\"__codelineno-38-24\" name=\"__codelineno-38-24\" href=\"#__codelineno-38-24\"></a>\n</span><span id=\"__span-38-25\"><a id=\"__codelineno-38-25\" name=\"__codelineno-38-25\" href=\"#__codelineno-38-25\"></a><span class=\"w\">        </span><span class=\"cm\">/* Exhaust */</span>\n</span><span id=\"__span-38-26\"><a id=\"__codelineno-38-26\" name=\"__codelineno-38-26\" href=\"#__codelineno-38-26\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-27\"><a id=\"__codelineno-38-27\" name=\"__codelineno-38-27\" href=\"#__codelineno-38-27\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-28\"><a id=\"__codelineno-38-28\" name=\"__codelineno-38-28\" href=\"#__codelineno-38-28\"></a><span class=\"w\">            </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-29\"><a id=\"__codelineno-38-29\" name=\"__codelineno-38-29\" href=\"#__codelineno-38-29\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-30\"><a id=\"__codelineno-38-30\" name=\"__codelineno-38-30\" href=\"#__codelineno-38-30\"></a><span class=\"w\">              </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-31\"><a id=\"__codelineno-38-31\" name=\"__codelineno-38-31\" href=\"#__codelineno-38-31\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-32\"><a id=\"__codelineno-38-32\" name=\"__codelineno-38-32\" href=\"#__codelineno-38-32\"></a><span class=\"w\">        </span><span class=\"cm\">/* Split */</span>\n</span><span id=\"__span-38-33\"><a id=\"__codelineno-38-33\" name=\"__codelineno-38-33\" href=\"#__codelineno-38-33\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-38-34\"><a id=\"__codelineno-38-34\" name=\"__codelineno-38-34\" href=\"#__codelineno-38-34\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-35\"><a id=\"__codelineno-38-35\" name=\"__codelineno-38-35\" href=\"#__codelineno-38-35\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-36\"><a id=\"__codelineno-38-36\" name=\"__codelineno-38-36\" href=\"#__codelineno-38-36\"></a><span class=\"w\">            </span><span class=\"cm\">/* We cannot assume the unsorted list is empty and therefore</span>\n</span><span id=\"__span-38-37\"><a id=\"__codelineno-38-37\" name=\"__codelineno-38-37\" href=\"#__codelineno-38-37\"></a><span class=\"cm\">               have to perform a complete insert here.  */</span>\n</span><span id=\"__span-38-38\"><a id=\"__codelineno-38-38\" name=\"__codelineno-38-38\" href=\"#__codelineno-38-38\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-39\"><a id=\"__codelineno-38-39\" name=\"__codelineno-38-39\" href=\"#__codelineno-38-39\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-40\"><a id=\"__codelineno-38-40\" name=\"__codelineno-38-40\" href=\"#__codelineno-38-40\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-41\"><a id=\"__codelineno-38-41\" name=\"__codelineno-38-41\" href=\"#__codelineno-38-41\"></a><span class=\"w\">              </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): corrupted unsorted chunks&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-42\"><a id=\"__codelineno-38-42\" name=\"__codelineno-38-42\" href=\"#__codelineno-38-42\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-43\"><a id=\"__codelineno-38-43\" name=\"__codelineno-38-43\" href=\"#__codelineno-38-43\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-44\"><a id=\"__codelineno-38-44\" name=\"__codelineno-38-44\" href=\"#__codelineno-38-44\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-45\"><a id=\"__codelineno-38-45\" name=\"__codelineno-38-45\" href=\"#__codelineno-38-45\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-46\"><a id=\"__codelineno-38-46\" name=\"__codelineno-38-46\" href=\"#__codelineno-38-46\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-47\"><a id=\"__codelineno-38-47\" name=\"__codelineno-38-47\" href=\"#__codelineno-38-47\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-48\"><a id=\"__codelineno-38-48\" name=\"__codelineno-38-48\" href=\"#__codelineno-38-48\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-49\"><a id=\"__codelineno-38-49\" name=\"__codelineno-38-49\" href=\"#__codelineno-38-49\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-50\"><a id=\"__codelineno-38-50\" name=\"__codelineno-38-50\" href=\"#__codelineno-38-50\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-51\"><a id=\"__codelineno-38-51\" name=\"__codelineno-38-51\" href=\"#__codelineno-38-51\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-38-52\"><a id=\"__codelineno-38-52\" name=\"__codelineno-38-52\" href=\"#__codelineno-38-52\"></a><span class=\"w\">                      </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-38-53\"><a id=\"__codelineno-38-53\" name=\"__codelineno-38-53\" href=\"#__codelineno-38-53\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-54\"><a id=\"__codelineno-38-54\" name=\"__codelineno-38-54\" href=\"#__codelineno-38-54\"></a><span class=\"w\">            </span><span class=\"n\">set_foot</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-55\"><a id=\"__codelineno-38-55\" name=\"__codelineno-38-55\" href=\"#__codelineno-38-55\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-56\"><a id=\"__codelineno-38-56\" name=\"__codelineno-38-56\" href=\"#__codelineno-38-56\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-57\"><a id=\"__codelineno-38-57\" name=\"__codelineno-38-57\" href=\"#__codelineno-38-57\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-58\"><a id=\"__codelineno-38-58\" name=\"__codelineno-38-58\" href=\"#__codelineno-38-58\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-59\"><a id=\"__codelineno-38-59\" name=\"__codelineno-38-59\" href=\"#__codelineno-38-59\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-60\"><a id=\"__codelineno-38-60\" name=\"__codelineno-38-60\" href=\"#__codelineno-38-60\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-61\"><a id=\"__codelineno-38-61\" name=\"__codelineno-38-61\" href=\"#__codelineno-38-61\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4ece large bin \u5206\u914d\u7a7a\u95f2\u5757\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u6839\u636e\u5927\u5c0f\u627e\u5230\u5bf9\u5e94\u7684 large bin</li>\n<li>\u5982\u679c large bin \u4e2d\u6700\u5927\u7684\u7a7a\u95f2\u5757\u8db3\u591f\u5927\uff0c\u904d\u5386 nextsize \u94fe\u8868\uff0c\u627e\u5230\u4e00\u4e2a\u6bd4\u8981\u5206\u914d\u7684\u5927\u5c0f\u66f4\u5927\u7684\u6700\u5c0f\u7684\u7a7a\u95f2\u5757</li>\n<li>\u4e3a\u4e86\u907f\u514d\u66f4\u65b0 nextsize \u94fe\u8868\uff0c\u5982\u679c\u5f53\u524d\u5757\u5927\u5c0f\u5bf9\u5e94\u4e86\u4e0d\u6b62\u4e00\u4e2a\u7a7a\u95f2\u5757\uff0c\u90a3\u5c31\u53d6\u7b2c\u4e8c\u4e2a\u7a7a\u95f2\u5757\uff0c\u8fd9\u6837\u5c31\u4e0d\u7528\u66f4\u65b0 nextsize \u94fe\u8868</li>\n<li>\u8ba1\u7b97\u7a7a\u95f2\u5757\u5927\u5c0f\u548c\u8981\u5206\u914d\u7684\u5927\u5c0f\u7684\u5dee\u503c\uff0c\u5982\u679c\u5dee\u503c\u592a\u5c0f\uff0c\u591a\u4f59\u7684\u90e8\u5206\u5c31\u76f4\u63a5\u6d6a\u8d39\uff1b\u5982\u679c\u5dee\u7684\u7a7a\u95f4\u8fd8\u80fd\u653e\u4e0b\u4e00\u4e2a chunk\uff0c\u5c31\u8fdb\u884c\u62c6\u5206\uff0c\u628a\u62c6\u51fa\u6765\u7684\u5269\u4e0b\u7684\u90e8\u5206\u653e\u5230 unsorted bin \u4e2d</li>\n<li>\u8ba1\u7b97 payload \u5730\u5740\uff0c\u8fdb\u884c\u53ef\u9009\u7684 perturb\uff0c\u5b8c\u6210\u5206\u914d</li>\n</ol>\n<h2 id=\"\u5bfb\u627e\u66f4\u5927\u7684-bin\">\u5bfb\u627e\u66f4\u5927\u7684 bin<a class=\"headerlink\" href=\"#\u5bfb\u627e\u66f4\u5927\u7684-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5982\u679c\u5728\u5f53\u524d bin \u5185\u8fd8\u662f\u627e\u4e0d\u5230\u7a7a\u95f2\u5757\uff0c\u90a3\u5c31\u53ea\u80fd\u4ece\u66f4\u5927\u7684 bin \u91cc\u5bfb\u627e\u7a7a\u95f2\u5757\u4e86\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-39-1\"><a id=\"__codelineno-39-1\" name=\"__codelineno-39-1\" href=\"#__codelineno-39-1\"></a><span class=\"o\">++</span><span class=\"n\">idx</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-2\"><a id=\"__codelineno-39-2\" name=\"__codelineno-39-2\" href=\"#__codelineno-39-2\"></a><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-3\"><a id=\"__codelineno-39-3\" name=\"__codelineno-39-3\" href=\"#__codelineno-39-3\"></a><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">idx2block</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-4\"><a id=\"__codelineno-39-4\" name=\"__codelineno-39-4\" href=\"#__codelineno-39-4\"></a><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">block</span><span class=\"p\">];</span>\n</span><span id=\"__span-39-5\"><a id=\"__codelineno-39-5\" name=\"__codelineno-39-5\" href=\"#__codelineno-39-5\"></a><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">idx2bit</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-6\"><a id=\"__codelineno-39-6\" name=\"__codelineno-39-6\" href=\"#__codelineno-39-6\"></a>\n</span><span id=\"__span-39-7\"><a id=\"__codelineno-39-7\" name=\"__codelineno-39-7\" href=\"#__codelineno-39-7\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(;;</span><span class=\"w\"> </span><span class=\"p\">)</span>\n</span><span id=\"__span-39-8\"><a id=\"__codelineno-39-8\" name=\"__codelineno-39-8\" href=\"#__codelineno-39-8\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-9\"><a id=\"__codelineno-39-9\" name=\"__codelineno-39-9\" href=\"#__codelineno-39-9\"></a><span class=\"w\">    </span><span class=\"cm\">/* Skip rest of block if there are no more set bits in this block.  */</span>\n</span><span id=\"__span-39-10\"><a id=\"__codelineno-39-10\" name=\"__codelineno-39-10\" href=\"#__codelineno-39-10\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-11\"><a id=\"__codelineno-39-11\" name=\"__codelineno-39-11\" href=\"#__codelineno-39-11\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-12\"><a id=\"__codelineno-39-12\" name=\"__codelineno-39-12\" href=\"#__codelineno-39-12\"></a><span class=\"w\">        </span><span class=\"k\">do</span>\n</span><span id=\"__span-39-13\"><a id=\"__codelineno-39-13\" name=\"__codelineno-39-13\" href=\"#__codelineno-39-13\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-14\"><a id=\"__codelineno-39-14\" name=\"__codelineno-39-14\" href=\"#__codelineno-39-14\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">++</span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">BINMAPSIZE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"cm\">/* out of bins */</span>\n</span><span id=\"__span-39-15\"><a id=\"__codelineno-39-15\" name=\"__codelineno-39-15\" href=\"#__codelineno-39-15\"></a><span class=\"w\">              </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">use_top</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-16\"><a id=\"__codelineno-39-16\" name=\"__codelineno-39-16\" href=\"#__codelineno-39-16\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-17\"><a id=\"__codelineno-39-17\" name=\"__codelineno-39-17\" href=\"#__codelineno-39-17\"></a><span class=\"w\">        </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">block</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-18\"><a id=\"__codelineno-39-18\" name=\"__codelineno-39-18\" href=\"#__codelineno-39-18\"></a>\n</span><span id=\"__span-39-19\"><a id=\"__codelineno-39-19\" name=\"__codelineno-39-19\" href=\"#__codelineno-39-19\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">BINMAPSHIFT</span><span class=\"p\">));</span>\n</span><span id=\"__span-39-20\"><a id=\"__codelineno-39-20\" name=\"__codelineno-39-20\" href=\"#__codelineno-39-20\"></a><span class=\"w\">        </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-21\"><a id=\"__codelineno-39-21\" name=\"__codelineno-39-21\" href=\"#__codelineno-39-21\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-22\"><a id=\"__codelineno-39-22\" name=\"__codelineno-39-22\" href=\"#__codelineno-39-22\"></a>\n</span><span id=\"__span-39-23\"><a id=\"__codelineno-39-23\" name=\"__codelineno-39-23\" href=\"#__codelineno-39-23\"></a><span class=\"w\">    </span><span class=\"cm\">/* Advance to bin with set bit. There must be one. */</span>\n</span><span id=\"__span-39-24\"><a id=\"__codelineno-39-24\" name=\"__codelineno-39-24\" href=\"#__codelineno-39-24\"></a><span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-25\"><a id=\"__codelineno-39-25\" name=\"__codelineno-39-25\" href=\"#__codelineno-39-25\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-26\"><a id=\"__codelineno-39-26\" name=\"__codelineno-39-26\" href=\"#__codelineno-39-26\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">next_bin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-27\"><a id=\"__codelineno-39-27\" name=\"__codelineno-39-27\" href=\"#__codelineno-39-27\"></a><span class=\"w\">        </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-28\"><a id=\"__codelineno-39-28\" name=\"__codelineno-39-28\" href=\"#__codelineno-39-28\"></a><span class=\"w\">        </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-29\"><a id=\"__codelineno-39-29\" name=\"__codelineno-39-29\" href=\"#__codelineno-39-29\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-30\"><a id=\"__codelineno-39-30\" name=\"__codelineno-39-30\" href=\"#__codelineno-39-30\"></a>\n</span><span id=\"__span-39-31\"><a id=\"__codelineno-39-31\" name=\"__codelineno-39-31\" href=\"#__codelineno-39-31\"></a><span class=\"w\">    </span><span class=\"cm\">/* Inspect the bin. It is likely to be non-empty */</span>\n</span><span id=\"__span-39-32\"><a id=\"__codelineno-39-32\" name=\"__codelineno-39-32\" href=\"#__codelineno-39-32\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-33\"><a id=\"__codelineno-39-33\" name=\"__codelineno-39-33\" href=\"#__codelineno-39-33\"></a>\n</span><span id=\"__span-39-34\"><a id=\"__codelineno-39-34\" name=\"__codelineno-39-34\" href=\"#__codelineno-39-34\"></a><span class=\"w\">    </span><span class=\"cm\">/*  If a false alarm (empty bin), clear the bit. */</span>\n</span><span id=\"__span-39-35\"><a id=\"__codelineno-39-35\" name=\"__codelineno-39-35\" href=\"#__codelineno-39-35\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-36\"><a id=\"__codelineno-39-36\" name=\"__codelineno-39-36\" href=\"#__codelineno-39-36\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-37\"><a id=\"__codelineno-39-37\" name=\"__codelineno-39-37\" href=\"#__codelineno-39-37\"></a><span class=\"w\">        </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">block</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">&amp;=</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"n\">bit</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Write through */</span>\n</span><span id=\"__span-39-38\"><a id=\"__codelineno-39-38\" name=\"__codelineno-39-38\" href=\"#__codelineno-39-38\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">next_bin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-39\"><a id=\"__codelineno-39-39\" name=\"__codelineno-39-39\" href=\"#__codelineno-39-39\"></a><span class=\"w\">        </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-40\"><a id=\"__codelineno-39-40\" name=\"__codelineno-39-40\" href=\"#__codelineno-39-40\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-41\"><a id=\"__codelineno-39-41\" name=\"__codelineno-39-41\" href=\"#__codelineno-39-41\"></a>\n</span><span id=\"__span-39-42\"><a id=\"__codelineno-39-42\" name=\"__codelineno-39-42\" href=\"#__codelineno-39-42\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-39-43\"><a id=\"__codelineno-39-43\" name=\"__codelineno-39-43\" href=\"#__codelineno-39-43\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-44\"><a id=\"__codelineno-39-44\" name=\"__codelineno-39-44\" href=\"#__codelineno-39-44\"></a><span class=\"w\">        </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-45\"><a id=\"__codelineno-39-45\" name=\"__codelineno-39-45\" href=\"#__codelineno-39-45\"></a>\n</span><span id=\"__span-39-46\"><a id=\"__codelineno-39-46\" name=\"__codelineno-39-46\" href=\"#__codelineno-39-46\"></a><span class=\"w\">        </span><span class=\"cm\">/*  We know the first chunk in this bin is big enough to use. */</span>\n</span><span id=\"__span-39-47\"><a id=\"__codelineno-39-47\" name=\"__codelineno-39-47\" href=\"#__codelineno-39-47\"></a><span class=\"w\">        </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">));</span>\n</span><span id=\"__span-39-48\"><a id=\"__codelineno-39-48\" name=\"__codelineno-39-48\" href=\"#__codelineno-39-48\"></a>\n</span><span id=\"__span-39-49\"><a id=\"__codelineno-39-49\" name=\"__codelineno-39-49\" href=\"#__codelineno-39-49\"></a><span class=\"w\">        </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-50\"><a id=\"__codelineno-39-50\" name=\"__codelineno-39-50\" href=\"#__codelineno-39-50\"></a>\n</span><span id=\"__span-39-51\"><a id=\"__codelineno-39-51\" name=\"__codelineno-39-51\" href=\"#__codelineno-39-51\"></a><span class=\"w\">        </span><span class=\"cm\">/* unlink */</span>\n</span><span id=\"__span-39-52\"><a id=\"__codelineno-39-52\" name=\"__codelineno-39-52\" href=\"#__codelineno-39-52\"></a><span class=\"w\">        </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-53\"><a id=\"__codelineno-39-53\" name=\"__codelineno-39-53\" href=\"#__codelineno-39-53\"></a>\n</span><span id=\"__span-39-54\"><a id=\"__codelineno-39-54\" name=\"__codelineno-39-54\" href=\"#__codelineno-39-54\"></a><span class=\"w\">        </span><span class=\"cm\">/* Exhaust */</span>\n</span><span id=\"__span-39-55\"><a id=\"__codelineno-39-55\" name=\"__codelineno-39-55\" href=\"#__codelineno-39-55\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-56\"><a id=\"__codelineno-39-56\" name=\"__codelineno-39-56\" href=\"#__codelineno-39-56\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-57\"><a id=\"__codelineno-39-57\" name=\"__codelineno-39-57\" href=\"#__codelineno-39-57\"></a><span class=\"w\">            </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-58\"><a id=\"__codelineno-39-58\" name=\"__codelineno-39-58\" href=\"#__codelineno-39-58\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-59\"><a id=\"__codelineno-39-59\" name=\"__codelineno-39-59\" href=\"#__codelineno-39-59\"></a><span class=\"w\">              </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-60\"><a id=\"__codelineno-39-60\" name=\"__codelineno-39-60\" href=\"#__codelineno-39-60\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-61\"><a id=\"__codelineno-39-61\" name=\"__codelineno-39-61\" href=\"#__codelineno-39-61\"></a>\n</span><span id=\"__span-39-62\"><a id=\"__codelineno-39-62\" name=\"__codelineno-39-62\" href=\"#__codelineno-39-62\"></a><span class=\"w\">        </span><span class=\"cm\">/* Split */</span>\n</span><span id=\"__span-39-63\"><a id=\"__codelineno-39-63\" name=\"__codelineno-39-63\" href=\"#__codelineno-39-63\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-39-64\"><a id=\"__codelineno-39-64\" name=\"__codelineno-39-64\" href=\"#__codelineno-39-64\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-65\"><a id=\"__codelineno-39-65\" name=\"__codelineno-39-65\" href=\"#__codelineno-39-65\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-66\"><a id=\"__codelineno-39-66\" name=\"__codelineno-39-66\" href=\"#__codelineno-39-66\"></a>\n</span><span id=\"__span-39-67\"><a id=\"__codelineno-39-67\" name=\"__codelineno-39-67\" href=\"#__codelineno-39-67\"></a><span class=\"w\">            </span><span class=\"cm\">/* We cannot assume the unsorted list is empty and therefore</span>\n</span><span id=\"__span-39-68\"><a id=\"__codelineno-39-68\" name=\"__codelineno-39-68\" href=\"#__codelineno-39-68\"></a><span class=\"cm\">               have to perform a complete insert here.  */</span>\n</span><span id=\"__span-39-69\"><a id=\"__codelineno-39-69\" name=\"__codelineno-39-69\" href=\"#__codelineno-39-69\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-70\"><a id=\"__codelineno-39-70\" name=\"__codelineno-39-70\" href=\"#__codelineno-39-70\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-71\"><a id=\"__codelineno-39-71\" name=\"__codelineno-39-71\" href=\"#__codelineno-39-71\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">))</span>\n</span><span id=\"__span-39-72\"><a id=\"__codelineno-39-72\" name=\"__codelineno-39-72\" href=\"#__codelineno-39-72\"></a><span class=\"w\">              </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): corrupted unsorted chunks 2&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-73\"><a id=\"__codelineno-39-73\" name=\"__codelineno-39-73\" href=\"#__codelineno-39-73\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-74\"><a id=\"__codelineno-39-74\" name=\"__codelineno-39-74\" href=\"#__codelineno-39-74\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-75\"><a id=\"__codelineno-39-75\" name=\"__codelineno-39-75\" href=\"#__codelineno-39-75\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-76\"><a id=\"__codelineno-39-76\" name=\"__codelineno-39-76\" href=\"#__codelineno-39-76\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-77\"><a id=\"__codelineno-39-77\" name=\"__codelineno-39-77\" href=\"#__codelineno-39-77\"></a>\n</span><span id=\"__span-39-78\"><a id=\"__codelineno-39-78\" name=\"__codelineno-39-78\" href=\"#__codelineno-39-78\"></a><span class=\"w\">            </span><span class=\"cm\">/* advertise as last remainder */</span>\n</span><span id=\"__span-39-79\"><a id=\"__codelineno-39-79\" name=\"__codelineno-39-79\" href=\"#__codelineno-39-79\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-39-80\"><a id=\"__codelineno-39-80\" name=\"__codelineno-39-80\" href=\"#__codelineno-39-80\"></a><span class=\"w\">              </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">last_remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-81\"><a id=\"__codelineno-39-81\" name=\"__codelineno-39-81\" href=\"#__codelineno-39-81\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"p\">))</span>\n</span><span id=\"__span-39-82\"><a id=\"__codelineno-39-82\" name=\"__codelineno-39-82\" href=\"#__codelineno-39-82\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-83\"><a id=\"__codelineno-39-83\" name=\"__codelineno-39-83\" href=\"#__codelineno-39-83\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-84\"><a id=\"__codelineno-39-84\" name=\"__codelineno-39-84\" href=\"#__codelineno-39-84\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-85\"><a id=\"__codelineno-39-85\" name=\"__codelineno-39-85\" href=\"#__codelineno-39-85\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-86\"><a id=\"__codelineno-39-86\" name=\"__codelineno-39-86\" href=\"#__codelineno-39-86\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-39-87\"><a id=\"__codelineno-39-87\" name=\"__codelineno-39-87\" href=\"#__codelineno-39-87\"></a><span class=\"w\">                      </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-39-88\"><a id=\"__codelineno-39-88\" name=\"__codelineno-39-88\" href=\"#__codelineno-39-88\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-89\"><a id=\"__codelineno-39-89\" name=\"__codelineno-39-89\" href=\"#__codelineno-39-89\"></a><span class=\"w\">            </span><span class=\"n\">set_foot</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-90\"><a id=\"__codelineno-39-90\" name=\"__codelineno-39-90\" href=\"#__codelineno-39-90\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-91\"><a id=\"__codelineno-39-91\" name=\"__codelineno-39-91\" href=\"#__codelineno-39-91\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-92\"><a id=\"__codelineno-39-92\" name=\"__codelineno-39-92\" href=\"#__codelineno-39-92\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-93\"><a id=\"__codelineno-39-93\" name=\"__codelineno-39-93\" href=\"#__codelineno-39-93\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-94\"><a id=\"__codelineno-39-94\" name=\"__codelineno-39-94\" href=\"#__codelineno-39-94\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-95\"><a id=\"__codelineno-39-95\" name=\"__codelineno-39-95\" href=\"#__codelineno-39-95\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-96\"><a id=\"__codelineno-39-96\" name=\"__codelineno-39-96\" href=\"#__codelineno-39-96\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4e3a\u4e86\u8df3\u8fc7\u7a7a\u7684 bin\uff0c\u7ef4\u62a4\u4e86\u4e00\u4e2a bitmap\uff0c\u8bb0\u5f55\u54ea\u4e9b bin \u4f1a\u6709\u5185\u5bb9\u3002\u627e\u5230\u4e00\u4e2a\u975e\u7a7a\u7684 bin \u4ee5\u540e\uff0c\u5b83\u7684\u5927\u5c0f\u80af\u5b9a\u662f\u8db3\u591f\u5206\u914d\u7684\uff0c\u63a5\u4e0b\u6765\u5c31\u548c\u4e4b\u524d\u4e00\u6837\uff0c\u8981\u4e48\u820d\u5f03\u591a\u4f59\u7684\u7a7a\u95f4\uff0c\u8981\u4e48\u628a\u591a\u4f59\u7684\u7a7a\u95f4\u505a\u6210\u4e00\u4e2a chunk\uff0c\u63d2\u5165\u5230 unsorted bin \u5f53\u4e2d\u3002</p>\n<p>\u5982\u679c\u6240\u6709 bin \u90fd\u7a7a\u4e86\uff0c\u8bf4\u660e\u6ca1\u6709\u53ef\u4ee5\u5206\u914d\u7684\u53ef\u80fd\u4e86\uff0c\u5c31\u8df3\u8f6c\u5230 <code>use_top</code> \u903b\u8f91\u3002</p>\n<h2 id=\"top-chunk-\u5206\u914d\">top chunk \u5206\u914d<a class=\"headerlink\" href=\"#top-chunk-\u5206\u914d\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5982\u679c\u5df2\u6709\u7684 bin \u90fd\u65e0\u6cd5\u5206\u914d\u4e86\uff0c\u5c31\u5c1d\u8bd5\u62c6\u5206 top chunk \u6765\u8fdb\u884c\u5206\u914d\u3002top chunk \u6307\u7684\u662f\u5f53\u524d\u5806\u91cc\u5730\u5740\u6700\u9ad8\u7684\u90a3\u4e2a chunk\uff0c\u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3a\u672a\u5206\u914d\u7684\u90e8\u5206\u3002\u5206\u914d\u7684\u903b\u8f91\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-40-1\"><a id=\"__codelineno-40-1\" name=\"__codelineno-40-1\" href=\"#__codelineno-40-1\"></a><span class=\"nl\">use_top</span><span class=\"p\">:</span>\n</span><span id=\"__span-40-2\"><a id=\"__codelineno-40-2\" name=\"__codelineno-40-2\" href=\"#__codelineno-40-2\"></a><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-3\"><a id=\"__codelineno-40-3\" name=\"__codelineno-40-3\" href=\"#__codelineno-40-3\"></a><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-4\"><a id=\"__codelineno-40-4\" name=\"__codelineno-40-4\" href=\"#__codelineno-40-4\"></a>\n</span><span id=\"__span-40-5\"><a id=\"__codelineno-40-5\" name=\"__codelineno-40-5\" href=\"#__codelineno-40-5\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">system_mem</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-6\"><a id=\"__codelineno-40-6\" name=\"__codelineno-40-6\" href=\"#__codelineno-40-6\"></a><span class=\"w\">  </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): corrupted top size&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-7\"><a id=\"__codelineno-40-7\" name=\"__codelineno-40-7\" href=\"#__codelineno-40-7\"></a>\n</span><span id=\"__span-40-8\"><a id=\"__codelineno-40-8\" name=\"__codelineno-40-8\" href=\"#__codelineno-40-8\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-9\"><a id=\"__codelineno-40-9\" name=\"__codelineno-40-9\" href=\"#__codelineno-40-9\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-40-10\"><a id=\"__codelineno-40-10\" name=\"__codelineno-40-10\" href=\"#__codelineno-40-10\"></a><span class=\"w\">    </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-11\"><a id=\"__codelineno-40-11\" name=\"__codelineno-40-11\" href=\"#__codelineno-40-11\"></a><span class=\"w\">    </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-12\"><a id=\"__codelineno-40-12\" name=\"__codelineno-40-12\" href=\"#__codelineno-40-12\"></a><span class=\"w\">    </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-13\"><a id=\"__codelineno-40-13\" name=\"__codelineno-40-13\" href=\"#__codelineno-40-13\"></a><span class=\"w\">    </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-40-14\"><a id=\"__codelineno-40-14\" name=\"__codelineno-40-14\" href=\"#__codelineno-40-14\"></a><span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-40-15\"><a id=\"__codelineno-40-15\" name=\"__codelineno-40-15\" href=\"#__codelineno-40-15\"></a><span class=\"w\">    </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-16\"><a id=\"__codelineno-40-16\" name=\"__codelineno-40-16\" href=\"#__codelineno-40-16\"></a>\n</span><span id=\"__span-40-17\"><a id=\"__codelineno-40-17\" name=\"__codelineno-40-17\" href=\"#__codelineno-40-17\"></a><span class=\"w\">    </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-18\"><a id=\"__codelineno-40-18\" name=\"__codelineno-40-18\" href=\"#__codelineno-40-18\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-19\"><a id=\"__codelineno-40-19\" name=\"__codelineno-40-19\" href=\"#__codelineno-40-19\"></a><span class=\"w\">    </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-20\"><a id=\"__codelineno-40-20\" name=\"__codelineno-40-20\" href=\"#__codelineno-40-20\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-21\"><a id=\"__codelineno-40-21\" name=\"__codelineno-40-21\" href=\"#__codelineno-40-21\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-40-22\"><a id=\"__codelineno-40-22\" name=\"__codelineno-40-22\" href=\"#__codelineno-40-22\"></a>\n</span><span id=\"__span-40-23\"><a id=\"__codelineno-40-23\" name=\"__codelineno-40-23\" href=\"#__codelineno-40-23\"></a><span class=\"cm\">/* When we are using atomic ops to free fast chunks we can get</span>\n</span><span id=\"__span-40-24\"><a id=\"__codelineno-40-24\" name=\"__codelineno-40-24\" href=\"#__codelineno-40-24\"></a><span class=\"cm\">   here for all block sizes.  */</span>\n</span><span id=\"__span-40-25\"><a id=\"__codelineno-40-25\" name=\"__codelineno-40-25\" href=\"#__codelineno-40-25\"></a><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">atomic_load_relaxed</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">have_fastchunks</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-26\"><a id=\"__codelineno-40-26\" name=\"__codelineno-40-26\" href=\"#__codelineno-40-26\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-40-27\"><a id=\"__codelineno-40-27\" name=\"__codelineno-40-27\" href=\"#__codelineno-40-27\"></a><span class=\"w\">    </span><span class=\"n\">malloc_consolidate</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-28\"><a id=\"__codelineno-40-28\" name=\"__codelineno-40-28\" href=\"#__codelineno-40-28\"></a><span class=\"w\">    </span><span class=\"cm\">/* restore original bin index */</span>\n</span><span id=\"__span-40-29\"><a id=\"__codelineno-40-29\" name=\"__codelineno-40-29\" href=\"#__codelineno-40-29\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-30\"><a id=\"__codelineno-40-30\" name=\"__codelineno-40-30\" href=\"#__codelineno-40-30\"></a><span class=\"w\">      </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">smallbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-31\"><a id=\"__codelineno-40-31\" name=\"__codelineno-40-31\" href=\"#__codelineno-40-31\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-40-32\"><a id=\"__codelineno-40-32\" name=\"__codelineno-40-32\" href=\"#__codelineno-40-32\"></a><span class=\"w\">      </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-33\"><a id=\"__codelineno-40-33\" name=\"__codelineno-40-33\" href=\"#__codelineno-40-33\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-40-34\"><a id=\"__codelineno-40-34\" name=\"__codelineno-40-34\" href=\"#__codelineno-40-34\"></a>\n</span><span id=\"__span-40-35\"><a id=\"__codelineno-40-35\" name=\"__codelineno-40-35\" href=\"#__codelineno-40-35\"></a><span class=\"cm\">/*</span>\n</span><span id=\"__span-40-36\"><a id=\"__codelineno-40-36\" name=\"__codelineno-40-36\" href=\"#__codelineno-40-36\"></a><span class=\"cm\">   Otherwise, relay to handle system-dependent cases</span>\n</span><span id=\"__span-40-37\"><a id=\"__codelineno-40-37\" name=\"__codelineno-40-37\" href=\"#__codelineno-40-37\"></a><span class=\"cm\"> */</span>\n</span><span id=\"__span-40-38\"><a id=\"__codelineno-40-38\" name=\"__codelineno-40-38\" href=\"#__codelineno-40-38\"></a><span class=\"k\">else</span>\n</span><span id=\"__span-40-39\"><a id=\"__codelineno-40-39\" name=\"__codelineno-40-39\" href=\"#__codelineno-40-39\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-40-40\"><a id=\"__codelineno-40-40\" name=\"__codelineno-40-40\" href=\"#__codelineno-40-40\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sysmalloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-41\"><a id=\"__codelineno-40-41\" name=\"__codelineno-40-41\" href=\"#__codelineno-40-41\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-40-42\"><a id=\"__codelineno-40-42\" name=\"__codelineno-40-42\" href=\"#__codelineno-40-42\"></a><span class=\"w\">      </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-43\"><a id=\"__codelineno-40-43\" name=\"__codelineno-40-43\" href=\"#__codelineno-40-43\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-44\"><a id=\"__codelineno-40-44\" name=\"__codelineno-40-44\" href=\"#__codelineno-40-44\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5982\u679c top chunk \u7684\u7a7a\u95f4\u591f\u5927\uff0c\u90a3\u5c31\u5bf9 top chunk \u8fdb\u884c\u62c6\u5206\uff0c\u4f4e\u5730\u5740\u7684\u90e8\u5206\u5206\u914d\u51fa\u53bb\uff0c\u5269\u4e0b\u7684\u90e8\u5206\u6210\u4e3a\u65b0\u7684 top chunk\u3002\u5982\u679c top chunk \u4e0d\u591f\u5927\uff0c\u5e76\u4e14 fast bin \u8fd8\u6709\u7a7a\u95f4\uff0c\u90a3\u5c31\u518d\u6323\u624e\u4e00\u4e0b\uff0cconsolidate \u4e00\u4e0b\uff0c\u91cd\u65b0\u5206\u914d\u4e00\u6b21\u3002\u5982\u679c\u8fd9\u4e9b\u65b9\u6cd5\u90fd\u5931\u8d25\u4e86\uff0c\u90a3\u5c31\u8c03\u7528 sysmalloc\uff0c\u901a\u8fc7 mmap \u6216\u8005 sbrk \u7b49\u65b9\u5f0f\u6765\u5206\u914d\u65b0\u7684\u7a7a\u95f4\u3002</p>\n<p>\u524d\u9762\u5728\u8ba8\u8bba consolidate \u7684\u65f6\u5019\uff0c\u8df3\u8fc7\u4e86\u5bf9 top chunk \u7684\u7279\u6b8a\u5904\u7406\u3002\u5176\u5b9e\uff0ctop chunk \u7684\u7279\u6b8a\u5904\u7406\u4e5f\u5f88\u7b80\u5355\uff0c\u5982\u679c\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u4e0b\u4e00\u4e2a\u5757\u5c31\u662f top chunk\uff0c\u90a3\u5c31\u628a\u5f53\u524d\u7a7a\u95f2\u5757\u5408\u5e76\u5230 top chunk \u5373\u53ef\u3002</p>\n<h2 id=\"free_3\">free<a class=\"headerlink\" href=\"#free_3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u628a malloc \u7684\u6d41\u7a0b\u57fa\u672c\u5206\u6790\u5b8c\u4e86\uff0c\u63a5\u4e0b\u6765\u5206\u6790\u4e00\u4e0b free \u7684\u903b\u8f91\uff0c\u5b83\u505a\u7684\u4e8b\u60c5\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u524d\u9762\u5df2\u7ecf\u5206\u6790\u8fc7\uff0c\u5982\u679c tcache \u5bf9\u5e94\u7684 bin \u5b58\u5728\u4e14\u975e\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u63d2\u5165\u5230 tcache \u7684\u94fe\u8868\u5934</li>\n<li>\u5982\u679c\u5b58\u5728\u5bf9\u5e94\u7684 fast bin\uff0c\u5219\u63d2\u5165\u7a7a\u95f2\u5757\u5230 fast bin \u5bf9\u5e94\u94fe\u8868\u7684\u5934\u90e8</li>\n<li>\u5c1d\u8bd5\u548c\u5b83\u524d\u540e\u7684\u7a7a\u95f2\u5757\u8fdb\u884c\u5408\u5e76\uff0c\u5b9e\u73b0\u548c\u524d\u9762 consolidate \u7c7b\u4f3c\uff0c\u5408\u5e76\u540e\u8fdb\u5165 unsorted bin</li>\n<li>\u5982\u679c\u91ca\u653e\u7684\u5185\u5b58\u6bd4\u8f83\u591a\uff0c\u68c0\u67e5 top chunk \u5927\u5c0f\uff0c\u5982\u679c\u5269\u4f59\u7684\u7a7a\u95f4\u6bd4\u8f83\u591a\uff0c\u5219\u5f52\u8fd8\u4e00\u90e8\u5206\u5185\u5b58\u7ed9\u64cd\u4f5c\u7cfb\u7edf</li>\n<li>\u5bf9\u4e8e mmap \u5206\u914d\u7684\u5185\u5b58\uff0c\u7528 munmap \u91ca\u653e\u6389</li>\n</ol>\n<p>\u7531\u4e8e free \u7684\u5b9e\u73b0\u76f8\u5bf9\u7b80\u5355\uff0c\u5728\u8fd9\u91cc\u5c31\u4e0d\u8be6\u7ec6\u89e3\u6790\u4e86\uff0c\u6bd4\u8f83\u8be6\u7ec6\u7684\u5b9e\u73b0\u5206\u6790\u89c1\u540e\u3002</p>\n<h2 id=\"realloc\">realloc<a class=\"headerlink\" href=\"#realloc\" title=\"Permanent link\">&para;</a></h2>\n<p>realloc \u7684\u5b9e\u73b0\u5728 <code>__libc_realloc</code> \u5f53\u4e2d\uff0c\u5b83\u7684\u5b9e\u73b0\u6bd4\u8f83\u7b80\u5355\uff1a</p>\n<ol>\n<li>\u5982\u679c\u91cd\u65b0\u5206\u914d\u7684\u5927\u5c0f\u662f 0\uff0crealloc \u7b49\u4ef7\u4e3a free\uff0c\u5c31\u8c03\u7528 free</li>\n<li>\u5982\u679c\u65e7\u6307\u9488\u662f NULL\uff0crealloc \u7b49\u4ef7\u4e3a malloc\uff0c\u5c31\u8c03\u7528 malloc</li>\n<li>\u5982\u679c\u76f4\u63a5\u662f mmap \u51fa\u6765\u7684\u5757\uff0c\u5229\u7528 mremap \u6765\u6269\u5c55\u7a7a\u95f4</li>\n<li>\u5982\u679c\u662f\u8981\u7533\u8bf7\u66f4\u5c11\u7684\u5185\u5b58\uff0c\u628a\u591a\u51fa\u6765\u7684\u90e8\u5206\u62c6\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u5757\uff0c\u7136\u540e free \u6389\u5b83</li>\n<li>\u5982\u679c\u662f\u8981\u7533\u8bf7\u66f4\u591a\u7684\u5185\u5b58\uff0c\u5c1d\u8bd5\u4ece\u5185\u5b58\u66f4\u9ad8\u5730\u5740\u7684\u76f8\u90bb\u5757\u83b7\u53d6\u7a7a\u95f4\uff0c\u5982\u679c\u6709\u7684\u8bdd\uff0c\u5408\u5e76\u4e24\u4e2a\u5757\uff0c\u7136\u540e\u628a\u591a\u4f59\u7684\u7a7a\u95f4\u62c6\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u5757\uff0c\u7136\u540e free \u6389\u5b83\uff1b\u5982\u679c\u5185\u5b58\u66f4\u9ad8\u5730\u5740\u7684\u76f8\u90bb\u5757\u5df2\u7ecf\u88ab\u5360\u7528\uff0c\u5c31\u91cd\u65b0 malloc \u4e00\u4e2a\u5757\uff0c\u7528 memcpy \u628a\u6570\u636e\u62f7\u8d1d\u8fc7\u53bb\uff0c\u518d free \u6389\u65e7\u7684\u5185\u5b58</li>\n</ol>\n<h2 id=\"calloc\">calloc<a class=\"headerlink\" href=\"#calloc\" title=\"Permanent link\">&para;</a></h2>\n<p>calloc \u7684\u5b9e\u73b0\u5728 <code>__libc_calloc</code> \u5f53\u4e2d\uff0c\u5b83\u7684\u8bed\u4e49\u76f8\u6bd4 malloc \u591a\u4e86\u4e00\u4e2a\u6e05\u96f6\uff0c\u6240\u4ee5\u5b83\u7684\u5b9e\u73b0\u4e5f\u4e0d\u590d\u6742\uff1a</p>\n<ol>\n<li>\u5982\u679c top chunk \u8fd8\u6709\u7a7a\u95f4\uff0c\u5e76\u4e14 top chunk \u7684\u6570\u636e\u5df2\u7ecf\u88ab\u6e05\u96f6\uff0c\u5219\u4f18\u5148\u4ece top chunk \u5206\u914d\u7a7a\u95f4\uff0c\u907f\u514d\u4e86 memset \u7684\u5f00\u9500</li>\n<li>fallback \u5230 <code>_int_malloc</code> \u8fdb\u884c\u5185\u5b58\u5206\u914d\uff0c\u5206\u914d\u6210\u529f\u540e\uff0c\u518d memset \u6e05\u96f6</li>\n</ol>\n<h2 id=\"arena-\u548c-heap\">arena \u548c heap<a class=\"headerlink\" href=\"#arena-\u548c-heap\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u8ba8\u8bba\u4e86\u5404\u79cd chunk \u5728\u5185\u5b58\u5206\u914d\u5668\u5185\u90e8\u6d41\u8f6c\u7684\u60c5\u51b5\uff0c\u4f46\u5e76\u6ca1\u6709\u8ba8\u8bba\u8fd9\u4e9b\u7a7a\u95f4\u662f\u600e\u4e48\u4ece\u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u800c\u6765\u7684\uff0c\u53c8\u662f\u600e\u4e48\u7ef4\u62a4\u7684\u3002glibc \u5185\u5b58\u5206\u914d\u5668\u5b9e\u9645\u4e0a\u8bbe\u8ba1\u4e86\u4e24\u4e2a\u5c42\u6b21\uff1a</p>\n<ol>\n<li>arena \u5c42\u6b21\uff1a\u5bf9\u5e94\u9501\u7684\u7c92\u5ea6\uff0c\u4e00\u4e2a arena \u53ef\u4ee5\u5bf9\u5e94\u591a\u4e2a heap\uff0c\u6709\u4e00\u4e2a\u7279\u6b8a\u7684 arena \u662f main_arena\uff1barena \u7684\u6570\u91cf\u6709\u9650\u5236\uff0c\u5728 64 \u4f4d\u7cfb\u7edf\u4e0b\u9ed8\u8ba4\u7684\u6570\u91cf\u9650\u5236\u662f\u5904\u7406\u5668\u6838\u5fc3\u6570\u7684 8 \u500d\uff0c\u907f\u514d\u51fa\u73b0\u592a\u591a\u7684\u5185\u5b58\u788e\u7247</li>\n<li>heap \u5c42\u6b21\uff1a\u6bcf\u4e2a heap \u5927\u5c0f\u6709\u4e0a\u9650\uff1a<code>1024 * 1024</code> \u5b57\u8282\uff0c\u4e5f\u5c31\u662f 1MB\uff1b\u5f53 arena \u9700\u8981\u66f4\u591a\u7a7a\u95f4\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5206\u914d\u65b0\u7684 heap\uff1barena \u81ea\u8eab\u5c31\u4fdd\u5b58\u5728 arena \u7684\u7b2c\u4e00\u4e2a heap \u5185\u90e8\u7684\u7a7a\u95f4\uff0c\u540c\u4e00\u4e2a arena \u7684\u591a\u4e2a heap \u4e4b\u95f4\u901a\u5355\u5411\u94fe\u8868\u8fde\u63a5\u8d77\u6765\uff1barena \u7684 top chunk \u6307\u5411\u6700\u540e\u4e00\u4e2a\u521b\u5efa\u7684 heap \u7684\u9876\u90e8\u7684\u7a7a\u95f2\u5757</li>\n</ol>\n<p>arena \u7684\u7ed3\u6784\u5c31\u662f\u524d\u9762\u770b\u5230\u7684 <code>malloc_state</code>\uff0c\u5305\u62ec\u5982\u4e0b\u5b57\u6bb5\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-41-1\"><a id=\"__codelineno-41-1\" name=\"__codelineno-41-1\" href=\"#__codelineno-41-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span>\n</span><span id=\"__span-41-2\"><a id=\"__codelineno-41-2\" name=\"__codelineno-41-2\" href=\"#__codelineno-41-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-41-3\"><a id=\"__codelineno-41-3\" name=\"__codelineno-41-3\" href=\"#__codelineno-41-3\"></a><span class=\"w\">  </span><span class=\"cm\">/* Serialize access.  */</span>\n</span><span id=\"__span-41-4\"><a id=\"__codelineno-41-4\" name=\"__codelineno-41-4\" href=\"#__codelineno-41-4\"></a><span class=\"w\">  </span><span class=\"n\">__libc_lock_define</span><span class=\"w\"> </span><span class=\"p\">(,</span><span class=\"w\"> </span><span class=\"n\">mutex</span><span class=\"p\">);</span>\n</span><span id=\"__span-41-5\"><a id=\"__codelineno-41-5\" name=\"__codelineno-41-5\" href=\"#__codelineno-41-5\"></a>\n</span><span id=\"__span-41-6\"><a id=\"__codelineno-41-6\" name=\"__codelineno-41-6\" href=\"#__codelineno-41-6\"></a><span class=\"w\">  </span><span class=\"cm\">/* Flags (formerly in max_fast).  */</span>\n</span><span id=\"__span-41-7\"><a id=\"__codelineno-41-7\" name=\"__codelineno-41-7\" href=\"#__codelineno-41-7\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-8\"><a id=\"__codelineno-41-8\" name=\"__codelineno-41-8\" href=\"#__codelineno-41-8\"></a>\n</span><span id=\"__span-41-9\"><a id=\"__codelineno-41-9\" name=\"__codelineno-41-9\" href=\"#__codelineno-41-9\"></a><span class=\"w\">  </span><span class=\"cm\">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>\n</span><span id=\"__span-41-10\"><a id=\"__codelineno-41-10\" name=\"__codelineno-41-10\" href=\"#__codelineno-41-10\"></a><span class=\"w\">  </span><span class=\"cm\">/* Note this is a bool but not all targets support atomics on booleans.  */</span>\n</span><span id=\"__span-41-11\"><a id=\"__codelineno-41-11\" name=\"__codelineno-41-11\" href=\"#__codelineno-41-11\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">have_fastchunks</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-12\"><a id=\"__codelineno-41-12\" name=\"__codelineno-41-12\" href=\"#__codelineno-41-12\"></a>\n</span><span id=\"__span-41-13\"><a id=\"__codelineno-41-13\" name=\"__codelineno-41-13\" href=\"#__codelineno-41-13\"></a><span class=\"w\">  </span><span class=\"cm\">/* Fastbins */</span>\n</span><span id=\"__span-41-14\"><a id=\"__codelineno-41-14\" name=\"__codelineno-41-14\" href=\"#__codelineno-41-14\"></a><span class=\"w\">  </span><span class=\"n\">mfastbinptr</span><span class=\"w\"> </span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">NFASTBINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-41-15\"><a id=\"__codelineno-41-15\" name=\"__codelineno-41-15\" href=\"#__codelineno-41-15\"></a>\n</span><span id=\"__span-41-16\"><a id=\"__codelineno-41-16\" name=\"__codelineno-41-16\" href=\"#__codelineno-41-16\"></a><span class=\"w\">  </span><span class=\"cm\">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>\n</span><span id=\"__span-41-17\"><a id=\"__codelineno-41-17\" name=\"__codelineno-41-17\" href=\"#__codelineno-41-17\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">top</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-18\"><a id=\"__codelineno-41-18\" name=\"__codelineno-41-18\" href=\"#__codelineno-41-18\"></a>\n</span><span id=\"__span-41-19\"><a id=\"__codelineno-41-19\" name=\"__codelineno-41-19\" href=\"#__codelineno-41-19\"></a><span class=\"w\">  </span><span class=\"cm\">/* The remainder from the most recent split of a small request */</span>\n</span><span id=\"__span-41-20\"><a id=\"__codelineno-41-20\" name=\"__codelineno-41-20\" href=\"#__codelineno-41-20\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">last_remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-21\"><a id=\"__codelineno-41-21\" name=\"__codelineno-41-21\" href=\"#__codelineno-41-21\"></a>\n</span><span id=\"__span-41-22\"><a id=\"__codelineno-41-22\" name=\"__codelineno-41-22\" href=\"#__codelineno-41-22\"></a><span class=\"w\">  </span><span class=\"cm\">/* Normal bins packed as described above */</span>\n</span><span id=\"__span-41-23\"><a id=\"__codelineno-41-23\" name=\"__codelineno-41-23\" href=\"#__codelineno-41-23\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">bins</span><span class=\"p\">[</span><span class=\"n\">NBINS</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-41-24\"><a id=\"__codelineno-41-24\" name=\"__codelineno-41-24\" href=\"#__codelineno-41-24\"></a>\n</span><span id=\"__span-41-25\"><a id=\"__codelineno-41-25\" name=\"__codelineno-41-25\" href=\"#__codelineno-41-25\"></a><span class=\"w\">  </span><span class=\"cm\">/* Bitmap of bins */</span>\n</span><span id=\"__span-41-26\"><a id=\"__codelineno-41-26\" name=\"__codelineno-41-26\" href=\"#__codelineno-41-26\"></a><span class=\"w\">  </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">BINMAPSIZE</span><span class=\"p\">];</span>\n</span><span id=\"__span-41-27\"><a id=\"__codelineno-41-27\" name=\"__codelineno-41-27\" href=\"#__codelineno-41-27\"></a>\n</span><span id=\"__span-41-28\"><a id=\"__codelineno-41-28\" name=\"__codelineno-41-28\" href=\"#__codelineno-41-28\"></a><span class=\"w\">  </span><span class=\"cm\">/* Linked list */</span>\n</span><span id=\"__span-41-29\"><a id=\"__codelineno-41-29\" name=\"__codelineno-41-29\" href=\"#__codelineno-41-29\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-30\"><a id=\"__codelineno-41-30\" name=\"__codelineno-41-30\" href=\"#__codelineno-41-30\"></a>\n</span><span id=\"__span-41-31\"><a id=\"__codelineno-41-31\" name=\"__codelineno-41-31\" href=\"#__codelineno-41-31\"></a><span class=\"w\">  </span><span class=\"cm\">/* Linked list for free arenas.  Access to this field is serialized</span>\n</span><span id=\"__span-41-32\"><a id=\"__codelineno-41-32\" name=\"__codelineno-41-32\" href=\"#__codelineno-41-32\"></a><span class=\"cm\">     by free_list_lock in arena.c.  */</span>\n</span><span id=\"__span-41-33\"><a id=\"__codelineno-41-33\" name=\"__codelineno-41-33\" href=\"#__codelineno-41-33\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next_free</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-34\"><a id=\"__codelineno-41-34\" name=\"__codelineno-41-34\" href=\"#__codelineno-41-34\"></a>\n</span><span id=\"__span-41-35\"><a id=\"__codelineno-41-35\" name=\"__codelineno-41-35\" href=\"#__codelineno-41-35\"></a><span class=\"w\">  </span><span class=\"cm\">/* Number of threads attached to this arena.  0 if the arena is on</span>\n</span><span id=\"__span-41-36\"><a id=\"__codelineno-41-36\" name=\"__codelineno-41-36\" href=\"#__codelineno-41-36\"></a><span class=\"cm\">     the free list.  Access to this field is serialized by</span>\n</span><span id=\"__span-41-37\"><a id=\"__codelineno-41-37\" name=\"__codelineno-41-37\" href=\"#__codelineno-41-37\"></a><span class=\"cm\">     free_list_lock in arena.c.  */</span>\n</span><span id=\"__span-41-38\"><a id=\"__codelineno-41-38\" name=\"__codelineno-41-38\" href=\"#__codelineno-41-38\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\"> </span><span class=\"n\">attached_threads</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-39\"><a id=\"__codelineno-41-39\" name=\"__codelineno-41-39\" href=\"#__codelineno-41-39\"></a>\n</span><span id=\"__span-41-40\"><a id=\"__codelineno-41-40\" name=\"__codelineno-41-40\" href=\"#__codelineno-41-40\"></a><span class=\"w\">  </span><span class=\"cm\">/* Memory allocated from the system in this arena.  */</span>\n</span><span id=\"__span-41-41\"><a id=\"__codelineno-41-41\" name=\"__codelineno-41-41\" href=\"#__codelineno-41-41\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\"> </span><span class=\"n\">system_mem</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-42\"><a id=\"__codelineno-41-42\" name=\"__codelineno-41-42\" href=\"#__codelineno-41-42\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\"> </span><span class=\"n\">max_system_mem</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-43\"><a id=\"__codelineno-41-43\" name=\"__codelineno-41-43\" href=\"#__codelineno-41-43\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u5f88\u591a\u5b57\u6bb5\u5728\u4e4b\u524d\u5df2\u7ecf\u89c1\u8fc7\u4e86\uff0c\u6bd4\u5982\uff1a</p>\n<ol>\n<li><code>mutex</code>\uff1aarena \u7684\u4e92\u65a5\u9501</li>\n<li><code>have_fastchunks</code>\uff1a\u8bb0\u5f55 fast bin \u4e2d\u662f\u5426\u8fd8\u6709\u7a7a\u95f2\u5757\uff0c\u7528\u4e8e\u5224\u65ad\u662f\u5426\u9700\u8981 consolidate</li>\n<li><code>fastbinsY</code>\uff1a\u4fdd\u5b58 fast bin \u6bcf\u4e2a bin \u7684\u5934\u6307\u9488\u7684\u6570\u7ec4</li>\n<li><code>top</code>\uff1a\u6307\u5411 top chunk</li>\n<li><code>last_remainder</code>\uff1a\u6307\u5411\u6700\u8fd1\u4e00\u6b21 split \u51fa\u6765\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u4e8e\u8bbf\u5b58\u5c40\u90e8\u6027\u4f18\u5316</li>\n<li><code>bins</code>\uff1a\u4fdd\u5b58 unsorted bin\uff0csmall bin \u548c large bin \u5404\u4e2a\u53cc\u5411\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u7684 <code>fd</code> \u548c <code>bk</code> \u6307\u9488</li>\n<li><code>binmap</code>\uff1a\u8bb0\u5f55\u54ea\u4e9b small \u6216 large bin \u91cc\u9762\u6709\u7a7a\u95f2\u5757\uff0c\u7528\u4e8e\u52a0\u901f\u5bfb\u627e\u4e0b\u4e00\u4e2a\u6709\u7a7a\u95f2\u5757\u7684 bin</li>\n</ol>\n<p>\u4e4b\u524d\u6ca1\u6709\u6d89\u53ca\u5230\u7684\u5b57\u6bb5\u5305\u62ec\uff1a</p>\n<ol>\n<li><code>flags</code>: \u7ef4\u62a4 <code>NONCONTIGUOUS_BIT</code> \u6807\u8bb0\uff0c\u5373 arena \u6240\u4f7f\u7528\u7684\u5185\u5b58\u662f\u5426\u662f\u8fde\u7eed\u7684\uff0c\u4f8b\u5982\u7528 sbrk \u5206\u914d\u51fa\u6765\u7684\u5185\u5b58\u662f\u8fde\u7eed\u7684\uff0c\u7528 mmap \u5219\u4e0d\u662f</li>\n<li><code>next</code>: \u7ef4\u62a4\u6240\u6709 arena \u7684\u5355\u5411\u94fe\u8868\uff0c\u94fe\u8868\u5934\u5c31\u662f <code>main_arena</code></li>\n<li><code>next_free</code>: \u7ef4\u62a4\u6240\u6709\u7a7a\u95f2\u7684 arena \u7684\u5355\u5411\u94fe\u8868 free list\uff0c\u94fe\u8868\u5934\u4fdd\u5b58\u5728 <code>static mstate free_list</code></li>\n<li><code>attached_threads</code>: \u8bb0\u5f55\u6709\u591a\u5c11\u4e2a\u7ebf\u7a0b\u4f1a\u4f7f\u7528\u8fd9\u4e2a arena\uff0c\u7c7b\u4f3c\u4e8e\u4e00\u79cd\u5f15\u7528\u8ba1\u6570\uff0c\u5f53\u5b83\u51cf\u5230\u96f6\u7684\u65f6\u5019\uff0c\u610f\u5473\u7740 arena \u53ef\u4ee5\u88ab\u91ca\u653e\u5230 free list \u4e86</li>\n<li><code>system_mem</code>: \u8bb0\u5f55\u5b83\u4ece\u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u4e86\u591a\u5c11\u7684\u5185\u5b58\u7684\u5927\u5c0f</li>\n<li><code>max_system_mem</code>\uff1a\u8bb0\u5f55\u5b83\u5386\u53f2\u4e0a\u4ece\u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u6700\u591a\u7684\u5185\u5b58\u7684\u5927\u5c0f</li>\n</ol>\n<p>\u53ef\u89c1 arena \u7684\u7ed3\u6784\u8fd8\u662f\u6bd4\u8f83\u7b80\u5355\u7684\uff0c\u63a5\u4e0b\u6765\u5206\u6790 heap \u7684\u7ed3\u6784\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-42-1\"><a id=\"__codelineno-42-1\" name=\"__codelineno-42-1\" href=\"#__codelineno-42-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">_heap_info</span>\n</span><span id=\"__span-42-2\"><a id=\"__codelineno-42-2\" name=\"__codelineno-42-2\" href=\"#__codelineno-42-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-42-3\"><a id=\"__codelineno-42-3\" name=\"__codelineno-42-3\" href=\"#__codelineno-42-3\"></a><span class=\"w\">  </span><span class=\"n\">mstate</span><span class=\"w\"> </span><span class=\"n\">ar_ptr</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Arena for this heap. */</span>\n</span><span id=\"__span-42-4\"><a id=\"__codelineno-42-4\" name=\"__codelineno-42-4\" href=\"#__codelineno-42-4\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">_heap_info</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">prev</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Previous heap. */</span>\n</span><span id=\"__span-42-5\"><a id=\"__codelineno-42-5\" name=\"__codelineno-42-5\" href=\"#__codelineno-42-5\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">;</span><span class=\"w\">   </span><span class=\"cm\">/* Current size in bytes. */</span>\n</span><span id=\"__span-42-6\"><a id=\"__codelineno-42-6\" name=\"__codelineno-42-6\" href=\"#__codelineno-42-6\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">mprotect_size</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Size in bytes that has been mprotected</span>\n</span><span id=\"__span-42-7\"><a id=\"__codelineno-42-7\" name=\"__codelineno-42-7\" href=\"#__codelineno-42-7\"></a><span class=\"cm\">                           PROT_READ|PROT_WRITE.  */</span>\n</span><span id=\"__span-42-8\"><a id=\"__codelineno-42-8\" name=\"__codelineno-42-8\" href=\"#__codelineno-42-8\"></a><span class=\"w\">  </span><span class=\"cm\">/* Make sure the following data is properly aligned, particularly</span>\n</span><span id=\"__span-42-9\"><a id=\"__codelineno-42-9\" name=\"__codelineno-42-9\" href=\"#__codelineno-42-9\"></a><span class=\"cm\">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span>\n</span><span id=\"__span-42-10\"><a id=\"__codelineno-42-10\" name=\"__codelineno-42-10\" href=\"#__codelineno-42-10\"></a><span class=\"cm\">     MALLOC_ALIGNMENT. */</span>\n</span><span id=\"__span-42-11\"><a id=\"__codelineno-42-11\" name=\"__codelineno-42-11\" href=\"#__codelineno-42-11\"></a><span class=\"w\">  </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">pad</span><span class=\"p\">[</span><span class=\"mi\">-6</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">SIZE_SZ</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">MALLOC_ALIGN_MASK</span><span class=\"p\">];</span>\n</span><span id=\"__span-42-12\"><a id=\"__codelineno-42-12\" name=\"__codelineno-42-12\" href=\"#__codelineno-42-12\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">heap_info</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u5b57\u6bb5\u5982\u4e0b\uff1a</p>\n<ol>\n<li><code>ar_ptr</code>\uff1a\u6307\u5411 heap \u6240\u5c5e\u7684 arena</li>\n<li><code>prev</code>\uff1a\u6307\u5411\u524d\u4e00\u4e2a heap\uff0c\u7ec4\u6210\u4e00\u4e2a heap \u7684\u5355\u5411\u94fe\u8868\uff0c\u65b0\u6dfb\u52a0\u7684 heap \u653e\u5230\u94fe\u8868\u7684\u5c3e\u90e8</li>\n<li><code>size</code>: heap \u7684\u5927\u5c0f</li>\n<li><code>mprotect_size</code>: heap \u88ab\u8bbe\u7f6e\u4e3a\u53ef\u8bfb\u5199\u7684\u90e8\u5206\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u4e5f\u5c31\u662f heap \u7684\u6d3b\u8dc3\u90e8\u5206\u5927\u5c0f\uff0c\u5bf9\u9f50\u5230\u9875\u7684\u8fb9\u754c\uff1b\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cheap \u7684\u672a\u5206\u914d\u7a7a\u95f4\u88ab\u6620\u5c04\u4e3a\u4e0d\u53ef\u8bfb\u4e0d\u53ef\u5199\u4e0d\u53ef\u6267\u884c\u7684\u5c5e\u6027</li>\n<li><code>pad</code>: \u6dfb\u52a0 padding\uff0c\u4fdd\u8bc1\u5b83\u7684\u5927\u5c0f\u662f <code>MALLOC_ALIGNMENT</code> \u7684\u500d\u6570</li>\n</ol>\n<p>\u524d\u9762\u63d0\u5230\u8fc7\uff0carena \u7684\u7a7a\u95f4\u4f1a\u590d\u7528\u5b83\u7684\u7b2c\u4e00\u4e2a heap \u7684\u7a7a\u95f4\uff0c\u7d27\u63a5\u7740\u653e\u5728 <code>heap_info</code> \u7ed3\u6784\u4f53\u7684\u540e\u9762\u3002\u8fd9\u4e2a <code>heap_info</code> \u7ed3\u6784\u4f53\u5c31\u653e\u5728 heap \u6240\u7528\u7a7a\u95f4\u7684\u5f00\u5934\u3002</p>\n<p>heap \u6709\u4e00\u4e2a\u7279\u6027\uff0c\u5c31\u662f\u5b83\u7684\u8d77\u59cb\u5730\u5740\uff0c\u4e00\u5b9a\u662f\u5bf9\u9f50\u5230 <code>HEAP_MAX_SIZE</code>\uff08\u9ed8\u8ba4\u662f 64MB\uff09\u7684\u6574\u6570\u500d\u6570\uff0c\u5e76\u4e14\u5b83\u7684\u5927\u5c0f\u4e5f\u4e0d\u4f1a\u8d85\u8fc7 <code>HEAP_MAX_SIZE</code>\uff0c\u6240\u4ee5\u5982\u679c\u8981\u77e5\u9053\u67d0\u4e2a chunk \u5c5e\u4e8e\u54ea\u4e2a heap\uff0c\u53ea\u9700\u8981\u5411\u4e0b\u53d6\u6574\u5230 <code>HEAP_MAX_SIZE</code> \u7684\u500d\u6570\u5373\u53ef\u3002\u5982\u679c\u8981\u77e5\u9053\u67d0\u4e2a chunk \u5c5e\u4e8e\u54ea\u4e2a arena\uff0c\u5c31\u5148\u627e\u5230 heap\uff0c\u518d\u4ece heap_info \u83b7\u53d6 ar_ptr \u5c31\u53ef\u4ee5\u4e86\u3002</p>\n<p>\u6bd4\u8f83\u6709\u610f\u601d\u7684\u4e00\u4e2a\u70b9\u662f\uff0cheap \u4fdd\u5b58\u4e86 arena \u7684\u6307\u9488\uff0c\u4f46\u662f\u53cd\u8fc7\u6765\uff0carena \u5e76\u6ca1\u6709\u4fdd\u5b58 heap \u7684\u6307\u9488\uff0c\u90a3\u4e48\u600e\u4e48\u4ece arena \u627e\u5230\u5c5e\u4e8e\u8fd9\u4e2a arena \u7684\u6240\u6709 heap \u5462\uff1f\u8fd9\u4f1a\u7528\u5230\u4e00\u4e2a\u6027\u8d28\uff1aarena \u7684 top \u6c38\u8fdc\u6307\u5411\u6700\u65b0\u7684\u4e00\u4e2a heap \u7684\u5730\u5740\u6700\u9ad8\u7684\u7a7a\u95f2\u5757\uff0c\u800c\u8fd9\u4e2a\u6700\u65b0\u7684 heap \u6b63\u597d\u5904\u4e8e heap \u94fe\u8868\u7684\u5c3e\u90e8\uff0c\u6240\u4ee5\u5982\u679c\u8981\u904d\u5386 arena \u91cc\u7684 heap\uff0c\u53ea\u9700\u8981\uff1a</p>\n<ol>\n<li>\u83b7\u53d6 arena \u7684 top \u6307\u9488</li>\n<li>\u628a top \u6307\u9488\u5411\u4e0b\u53d6\u6574\u5230 <code>HEAP_MAX_SIZE</code> \u7684\u6574\u500d\u6570\uff0c\u5f97\u5230 top \u6240\u5728 heap \u7684 heap_info \u6307\u9488</li>\n<li>\u6cbf\u7740 heap_info \u7684 prev \u6307\u9488\u5411\u524d\u8d70\uff0c\u4e00\u76f4\u904d\u5386\uff0c\u76f4\u5230 prev \u6307\u9488\u4e3a NULL \u4e3a\u6b62</li>\n</ol>\n<p>\u6240\u4ee5 top \u6307\u9488\u4e5f\u5145\u5f53\u4e86 heap \u94fe\u8868\u7684\u5c3e\u6307\u9488\u7684\u4f5c\u7528\u3002</p>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf arena \u548c heap \u662f\u600e\u4e48\u521d\u59cb\u5316\u7684\u3002</p>\n<p>main arena \u662f\u7279\u6b8a\u7684\uff0c\u56e0\u4e3a\u5b83\u76f4\u63a5\u4fdd\u5b58\u5728 glibc \u7684 data \u6bb5\u5f53\u4e2d\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u52a8\u6001\u5206\u914d\uff0c\u5e76\u4e14 main arena \u7684\u6570\u636e\u662f\u901a\u8fc7 sbrk \u4ece\u7cfb\u7edf\u5206\u914d\u7684\uff0c\u5b83\u7684\u7ef4\u62a4\u903b\u8f91\u5728 <code>sysmalloc</code> \u51fd\u6570\u4e2d\u5b9e\u73b0\uff1a\u5f53 malloc \u5c1d\u8bd5\u5404\u79cd\u529e\u6cd5\u90fd\u627e\u4e0d\u5230\u7a7a\u95f4\u5206\u914d\u65f6\uff0c\u5c31\u4f1a\u8c03\u7528 <code>sysmalloc</code> \u6765\u6269\u5c55 top chunk \u5e76\u4ece top chunk \u4e2d\u5206\u914d\u65b0\u7684\u5757\u3002\u5f53 <code>sysmalloc</code> \u9047\u5230 main arena \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u5c1d\u8bd5\u7528 sbrk \u6269\u5c55\u5806\u7684\u5927\u5c0f\uff0c\u4ece\u800c\u6269\u5927 top chunk\u3002\u5f53\u7136\u4e86\uff0csbrk \u53ef\u80fd\u4f1a\u5931\u8d25\uff0c\u8fd9\u4e2a\u65f6\u5019 main arena \u4e5f\u4f1a\u901a\u8fc7 mmap \u6765\u5206\u914d\u66f4\u591a\u7684\u5185\u5b58\u3002</p>\n<p>\u5176\u4ed6\u7684 arena \u5219\u662f\u901a\u8fc7 <code>_int_new_arena</code> \u5206\u914d\u7684\uff0c\u5b83\u7684\u6d41\u7a0b\u662f\uff1a</p>\n<ol>\n<li>\u8c03\u7528 <code>new_heap</code> \u521b\u5efa\u4e00\u4e2a\u5806\uff0c\u81f3\u5c11\u80fd\u591f\u653e <code>heap_info</code> \u548c <code>malloc_state</code> \u7684\u7a7a\u95f4</li>\n<li>\u8fd9\u6bb5\u7a7a\u95f4\u7684\u5f00\u5934\u5c31\u662f <code>heap_info</code>\uff0c\u7d27\u968f\u5176\u540e\u5c31\u662f arena \u81ea\u5df1\u7684 <code>malloc_state</code>\uff0c\u7136\u540e\u628a top chunk \u6307\u5411 <code>malloc_state</code> \u540e\u9762\u7684\u7a7a\u95f2\u7a7a\u95f4</li>\n</ol>\n<p><code>new_heap</code> \u5219\u662f\u4f1a\u901a\u8fc7 <code>mmap</code> \u5411\u64cd\u4f5c\u7cfb\u7edf\u7533\u8bf7\u5185\u5b58\u3002\u56e0\u6b64\u9664\u4e86 main_arena \u4ee5\u5916\uff0c\u6240\u6709\u7684 arena \u7684 heap \u90fd\u4f1a\u653e\u5728 mmap \u51fa\u6765\u7684\u7a7a\u95f4\u91cc\u3002</p>\n<p>\u4e8e\u662f <code>sysmalloc</code> \u8981\u505a\u7684\u4e8b\u60c5\u4e5f\u6bd4\u8f83\u6e05\u6670\u4e86\uff0c\u5b83\u8981\u505a\u7684\u5c31\u662f\uff0c\u5728 top chunk \u4e0d\u591f\u5927\u7684\u65f6\u5019\uff0c\u5206\u914d\u66f4\u591a\u7a7a\u95f4\u7ed9 top chunk\uff1a</p>\n<ol>\n<li>\u5982\u679c\u8981\u5206\u914d\u7684\u5757\u7279\u522b\u5927\uff0c\u8d85\u51fa\u4e86\u9608\u503c <code>mmap_threshold</code>\uff0c\u5c31\u76f4\u63a5\u7528 mmap \u7533\u8bf7\u5185\u5b58</li>\n<li>\u5982\u679c\u4e0d\u662f main arena\uff0c\u5c31\u5c1d\u8bd5\u6269\u5927 top \u6240\u5728\u7684 heap\uff1aheap \u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u867d\u7136\u4f1a mmap \u4e00\u4e2a <code>HEAP_MAX_SIZE</code> \u5927\u5c0f\u7684\u5185\u5b58\uff0c\u4f46\u5927\u90e8\u5206\u7a7a\u95f4\u90fd\u88ab\u6620\u5c04\u4e3a\u4e0d\u53ef\u8bfb\u4e0d\u53ef\u5199\u4e0d\u53ef\u6267\u884c\uff1b\u6240\u4ee5\u6269\u5927 heap\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u628a\u8981\u7528\u7684\u90e8\u5206\u901a\u8fc7 mprotect \u6dfb\u52a0\u53ef\u8bfb\u548c\u53ef\u5199\u7684\u6743\u9650\uff1b\u5982\u679c heap \u8fbe\u5230\u4e86\u5927\u5c0f\u7684\u4e0a\u9650\uff0c\u90a3\u5c31\u65b0\u5efa\u4e00\u4e2a heap\uff0c\u628a top chunk \u653e\u5230\u65b0\u7684 heap \u4e0a\u53bb</li>\n<li>\u5982\u679c\u662f main arena\uff0c\u5c31\u7528 sbrk \u6269\u5927 top chunk\uff1b\u5982\u679c\u6269\u5927\u5931\u8d25\uff0c\u90a3\u5c31\u7528 mmap \u6765\u5206\u914d\u5185\u5b58</li>\n</ol>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u7ed3\u6784\">\u7ed3\u6784<a class=\"headerlink\" href=\"#\u7ed3\u6784\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5230\u8fd9\u91cc\u5c31\u57fa\u672c\u628a glibc \u7684\u5185\u5b58\u5206\u914d\u5668\u5206\u6790\u5f97\u5dee\u4e0d\u591a\u4e86\u3002glibc \u628a\u7a7a\u95f2\u5757\u653e\u5728\u5982\u4e0b\u56db\u79cd bin \u5185\uff1a</p>\n<ol>\n<li>fast bin: \u6bcf\u4e2a bin \u5bf9\u5e94\u56fa\u5b9a\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u5355\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u94fe\u8868\u5934\u6307\u9488\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>fastbinsY</code> \u6210\u5458</li>\n<li>unsorted bin: \u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u7ef4\u62a4\u4e00\u4e9b\u521a\u88ab free \u7684\u7a7a\u95f2\u5757\uff0c\u65e0\u5927\u5c0f\u8981\u6c42\uff0c\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>bins</code> \u6210\u5458\u521a\u5f00\u5934</li>\n<li>small bin: \u6bcf\u4e2a bin \u5bf9\u5e94\u56fa\u5b9a\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>bins</code> \u6210\u5458\uff0c\u7d27\u63a5\u5728 unsorted bin \u540e\u9762</li>\n<li>large bin: \u6bcf\u4e2a bin \u5bf9\u5e94\u4e00\u6bb5\u5927\u5c0f\u8303\u56f4\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u6309\u7167\u5757\u5927\u5c0f\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\uff0c\u6bcf\u4e2a\u5927\u5c0f\u7684\u7b2c\u4e00\u4e2a\u7a7a\u95f2\u5757\u5728 nextsize \u53cc\u5411\u94fe\u8868\u5f53\u4e2d\uff0c\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>bins</code> \u6210\u5458\u4e2d\uff0c\u7d27\u63a5\u5728 small bin \u540e\u9762</li>\n</ol>\n<p>\u9664\u4e86\u8fd9\u56db\u79cd bin \u4ee5\u5916\uff0c\u8fd8\u6709\u4e00\u4e2a per thread \u7684 tcache \u673a\u5236\uff0c\u7ed3\u6784\u548c fast bin \u7c7b\u4f3c\uff0c\u6bcf\u4e2a bin \u5bf9\u5e94\u56fa\u5b9a\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u5355\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u94fe\u8868\u5934\u6307\u9488\u4fdd\u5b58\u5728 <code>tcache</code> \u7684 <code>entries</code> \u6210\u5458\u3002</p>\n<p>\u5185\u5b58\u5728\u5206\u914d\u5668\u4e2d\u6d41\u8f6c\u7684\u8fc7\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u4e00\u5f00\u59cb\u4ece top chunk \u5f53\u4e2d\u88ab\u5206\u914d\u51fa\u6765</li>\n<li>\u88ab free \u4e86\u4ee5\u540e\uff0c\u8fdb\u5165 tcache\uff0c\u6216\u8005 fast bin\uff0c\u6216\u8005\u5408\u5e76\u540e\u653e\u5230 unsorted bin\uff0c\u6216\u8005\u5408\u5e76\u5230 top chunk</li>\n<li>\u5728 malloc \u7684\u65f6\u5019\uff0c\u4ece tcache \u6216\u8005 fast bin \u5206\u914d\uff0c\u53c8\u6216\u8005\u4ece unsorted bin \u4e2d\u53d6\u51fa\uff0c\u653e\u5230 small bin \u6216 large bin\uff0c\u4e2d\u9014\u53ef\u80fd\u88ab\u5206\u914d\u3001\u62c6\u5206\u6216\u8005\u5408\u5e76</li>\n</ol>\n<pre class=\"mermaid\"><code>flowchart TD\n    top_chunk[top chunk]\n    user[user allocated]\n    tcache\n    fast_bin[fast bin]\n    small_bin[small bin]\n    large_bin[large bin]\n    unsorted_bin[unsorted bin]\n\n    top_chunk --&gt;|malloc| user\n    tcache --&gt;|malloc| user\n    fast_bin --&gt;|malloc| user\n    fast_bin --&gt;|malloc| tcache\n    fast_bin --&gt;|consolidate| unsorted_bin\n    fast_bin --&gt;|consolidate| top_chunk\n    small_bin --&gt;|malloc| user\n    small_bin --&gt;|malloc| tcache\n    large_bin --&gt;|malloc| user\n    large_bin --&gt;|malloc| unsorted_bin\n    unsorted_bin --&gt;|malloc| user\n    unsorted_bin --&gt;|malloc| tcache\n    unsorted_bin --&gt;|malloc| small_bin\n    unsorted_bin --&gt;|malloc| large_bin\n\n    user --&gt;|free| tcache\n    user --&gt;|free| fast_bin\n    user --&gt;|free| unsorted_bin\n    user --&gt;|free| top_chunk\n    small_bin --&gt;|free| unsorted_bin\n    large_bin --&gt;|free| unsorted_bin</code></pre>\n<h3 id=\"malloc_5\">malloc<a class=\"headerlink\" href=\"#malloc_5\" title=\"Permanent link\">&para;</a></h3>\n<p>malloc \u7684\u5b8c\u6574\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a</p>\n<pre class=\"mermaid\"><code>---\nconfig:\n  theme: base\n  themeVariables:\n    fontSize: \"30px\"\n---\nflowchart TD\n    malloc[malloc \u5165\u53e3\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3022\"&gt;malloc.c:3022&lt;/a&gt;\uff09]\n    tcache[\u5c1d\u8bd5\u4ece tcache \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3047\"&gt;malloc.c:3047&lt;/a&gt;\uff09]\n    fastbin[\u5c1d\u8bd5\u4ece fast bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3577\"&gt;malloc.c:3577&lt;/a&gt;\uff09]\n    fastbin_migrate[\u5982\u679c fast bin \u8fd8\u6709\u7a7a\u95f2\u5757\u4e14 tcache \u6ca1\u6709\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u4ece fast bin \u632a\u5230 tcache\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3596\"&gt;malloc.c:3596&lt;/a&gt;\uff09]\n    smallbin[\u5c1d\u8bd5\u4ece small bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3635\"&gt;malloc.c:3635&lt;/a&gt;\uff09]\n    smallbin_migrate[\u5982\u679c small bin \u8fd8\u6709\u7a7a\u95f2\u5757\u4e14 tcache \u6ca1\u6709\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u4ece small bin \u632a\u5230 tcache\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3652\"&gt;malloc.c:3652&lt;/a&gt;\uff09]\n    malloc_ret[malloc \u7ed3\u675f]\n    consolidate[consolidate\uff1a\u904d\u5386 fast bin\uff0c\u628a\u7a7a\u95f2\u5757\u548c\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u5408\u5e76\uff0c\u63d2\u5165\u5230 unsorted bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4440\"&gt;malloc.c:4440&lt;/a&gt;\uff09]\n    consolidate_2[consolidate\uff1a\u904d\u5386 fast bin\uff0c\u628a\u7a7a\u95f2\u5757\u548c\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u5408\u5e76\uff0c\u63d2\u5165\u5230 unsorted bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4440\"&gt;malloc.c:4440&lt;/a&gt;\uff09]\n    check_large[\u5757\u5927\u5c0f\u662f\u5426\u5bf9\u5e94 large bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3695\"&gt;malloc.c:3695&lt;/a&gt;\uff09]\n    loop[\u5f00\u59cb\u5faa\u73af\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3725\"&gt;malloc.c:3725&lt;/a&gt;\uff09]\n    unsorted_bin[\u904d\u5386 unsorted bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3728\"&gt;malloc.c:3728&lt;/a&gt;\uff09]\n    remainder[\u5185\u5b58\u5c40\u90e8\u6027\u4f18\u5316\uff1a\u6700\u8fd1\u4e00\u6b21 split \u51fa\u6765\u7684 chunk \u662f\u5426\u6709\u8db3\u591f\u7684\u7a7a\u95f4\u5206\u914d\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3756\"&gt;malloc.c:3756&lt;/a&gt;\uff09]\n    remainder_success[\u62c6\u5206\u8fd9\u4e2a chunk \u4ee5\u5b8c\u6210\u5206\u914d\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3761\"&gt;malloc.c:3761&lt;/a&gt;\uff09]\n    remove_unsorted_bin[\u628a\u5f53\u524d chunk \u4ece unsorted bin \u4e2d\u5220\u9664\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3784\"&gt;malloc.c:3784&lt;/a&gt;\uff09]\n    check_same_size[\u5f53\u524d\u7a7a\u95f2\u5757\u5927\u5c0f\u548c\u8981\u5206\u914d\u7684\u5927\u5c0f\u662f\u5426\u76f8\u540c\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3792\"&gt;malloc.c:3792&lt;/a&gt;\uff09]\n    check_tcache_full[tcache bin \u662f\u5426\u5df2\u6ee1\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3800\"&gt;malloc.c:3800&lt;/a&gt;\uff09]\n    alloc_now[\u5206\u914d\u5f53\u524d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3807\"&gt;malloc.c:3807&lt;/a&gt;\uff09]\n    move_to_tcache[\u628a\u5f53\u524d\u7a7a\u95f2\u5757\u632a\u5230 tcache\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3803\"&gt;malloc.c:3803&lt;/a&gt;\uff09]\n    move_to_bin[\u6839\u636e\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\uff0c\u632a\u5230 small bin \u6216 large bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3821\"&gt;malloc.c:3821&lt;/a&gt;\uff09]\n    check_tcache[\u68c0\u67e5 tcache \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3891\"&gt;malloc.c:3891&lt;/a&gt;\uff09]\n    alloc_tcache[\u4ece tcache \u5206\u914d\u7a7a\u95f2\u5757]\n    unsorted_bin_exit[\u68c0\u67e5 tcache \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3906\"&gt;malloc.c:3906&lt;/a&gt;\uff09]\n    check_large_alloc[\u5757\u5927\u5c0f\u662f\u5426\u5bf9\u5e94 large bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3917\"&gt;malloc.c:3917&lt;/a&gt;\uff09]\n    alloc_large[\u5c1d\u8bd5\u4ece large bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3922\"&gt;malloc.c:3922&lt;/a&gt;\uff09]\n    alloc_larger[\u904d\u5386\u66f4\u5927\u7684 bin\uff0c\u5c1d\u8bd5\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3990\"&gt;malloc.c:3990&lt;/a&gt;\uff09]\n    alloc_top[\u5c1d\u8bd5\u4ece top chunk \u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4087\"&gt;malloc.c:4087&lt;/a&gt;\uff09]\n    alloc_system[\u4ece\u7cfb\u7edf\u8bf7\u6c42\u66f4\u591a\u5185\u5b58\u6765\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4139\"&gt;malloc.c:4139&lt;/a&gt;\uff09]\n    check_fast[fast bin \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4126\"&gt;malloc.c:4126&lt;/a&gt;\uff09]\n\n    malloc --&gt; tcache\n    tcache --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    tcache --&gt;|\u5206\u914d\u5931\u8d25| fastbin\n    fastbin --&gt;|\u5206\u914d\u5931\u8d25| smallbin\n    fastbin --&gt;|\u5206\u914d\u6210\u529f| fastbin_migrate \n    fastbin_migrate --&gt; malloc_ret\n    smallbin --&gt;|\u5206\u914d\u6210\u529f| smallbin_migrate\n    smallbin_migrate --&gt; malloc_ret\n    smallbin --&gt;|\u5206\u914d\u5931\u8d25| check_large\n    check_large --&gt;|\u662f| consolidate\n    check_large --&gt;|\u5426| loop\n    consolidate --&gt; loop\n    loop --&gt; unsorted_bin\n    unsorted_bin --&gt;|unsorted bin \u975e\u7a7a\uff0c\u6216\u8005\u5faa\u73af\u6b21\u6570\u4e0d\u8db3 10000 \u6b21| remainder\n    remainder --&gt;|\u662f| remainder_success\n    remainder_success --&gt; malloc_ret\n    remainder --&gt;|\u5426| remove_unsorted_bin\n    remove_unsorted_bin --&gt; check_same_size\n    check_same_size --&gt;|\u662f| check_tcache_full\n    check_tcache_full --&gt;|\u5426| move_to_tcache\n    check_tcache_full --&gt; |\u662f| alloc_now\n    alloc_now --&gt; malloc_ret\n    move_to_tcache --&gt; unsorted_bin\n    check_same_size --&gt;|\u5426| move_to_bin\n    move_to_bin --&gt; check_tcache\n    check_tcache --&gt;|\u662f| alloc_tcache\n    alloc_tcache --&gt; malloc_ret\n    check_tcache --&gt;|\u5426| unsorted_bin\n    unsorted_bin --&gt;|unsorted bin \u5df2\u7a7a\uff0c\u6216\u8005\u5faa\u73af\u6b21\u6570\u8d85\u8fc7 10000 \u6b21| unsorted_bin_exit\n    unsorted_bin_exit --&gt;|\u662f| alloc_tcache\n    unsorted_bin_exit --&gt;|\u5426| check_large_alloc\n    check_large_alloc --&gt;|\u662f| alloc_large\n    alloc_large --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    alloc_large --&gt;|\u5206\u914d\u5931\u8d25| alloc_larger\n    check_large_alloc --&gt;|\u5426| alloc_larger\n    alloc_larger --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    alloc_larger --&gt;|\u5206\u914d\u5931\u8d25| alloc_top\n    alloc_top --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    alloc_top --&gt;|\u5206\u914d\u5931\u8d25| check_fast\n    check_fast --&gt;|\u662f| consolidate_2\n    consolidate_2 --&gt; loop\n    check_fast --&gt;|\u5426| alloc_system\n    alloc_system --&gt; malloc_ret</code></pre>\n<p>\u524d\u9762\u5206\u6bb5\u6574\u7406\u4e86 malloc \u7684\u5b9e\u73b0\uff0c\u5728\u8fd9\u91cc\u5217\u51fa\u5b8c\u6574\u7684 malloc \u6d41\u7a0b\uff1a</p>\n<ol>\n<li>malloc \u7684\u5165\u53e3\u662f <code>__libc_malloc (size_t bytes)</code> \u51fd\u6570</li>\n<li>\u5982\u679c\u914d\u7f6e\u4e86 malloc hook\uff0c\u5219\u8c03\u7528 malloc hook\uff0c\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c</li>\n<li>\u6839\u636e\u7528\u6237\u4f20\u5165\u7684 malloc \u7684\u5b57\u8282\u6570\uff08<code>bytes</code>\uff09\uff0c\u7528 <code>checked_request2size</code> \u8ba1\u7b97\u51fa\u5b9e\u9645\u7684 chunk \u5927\u5c0f\uff0c\u7b97\u6cd5\u662f\u5148\u52a0\u4e0a <code>sizeof(size_t)</code>\uff08\u7ed9 <code>mchunk_size</code> \u9884\u7559\u7a7a\u95f4\uff09\uff0c\u7136\u540e\u5411\u4e0a\u5bf9\u9f50\u5230 <code>MALLOC_ALIGNMENT</code>\uff08\u901a\u5e38\u662f <code>2 * sizeof(size_t)</code>\uff09\u7684\u500d\u6570\uff0c\u518d\u548c <code>MINSIZE</code> \u53d6 max\uff0c\u5176\u4e2d <code>MINSIZE</code> \u901a\u5e38\u662f <code>4 * sizeof(size_t)</code>\uff0c\u56e0\u4e3a\u7a7a\u95f2\u5757\u81f3\u5c11\u8981\u4fdd\u5b58\u4e24\u4e2a size \u52a0\u4e0a\u53cc\u5411\u94fe\u8868\u7684 <code>fd</code> \u548c <code>bk</code> \u6307\u9488</li>\n<li>\u5982\u679c tcache \u8fd8\u6ca1\u521d\u59cb\u5316\uff0c\u5c31\u521d\u59cb\u5316 tcache</li>\n<li>\u6839\u636e chunk \u5927\u5c0f\uff0c\u8ba1\u7b97 tcache index\uff0c\u68c0\u67e5\u5bf9\u5e94\u7684 bin \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff1b\u5982\u679c\u6709\uff0c\u76f4\u63a5\u5206\u914d\u7a7a\u95f2\u5757\u5e76\u8fd4\u56de</li>\n<li>\u63a5\u7740\u83b7\u53d6\u4e00\u4e2a arena\uff0c\u5982\u6709\u5fc5\u8981\uff0c\u83b7\u53d6 arena \u7684\u9501\uff1b\u5728\u5355\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u4e00\u4e2a main_arena\uff1b\u591a\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u6709\u4e00\u4e2a\u9ed8\u8ba4\u7684 arena \u6307\u9488\uff08<code>static __thread mstate thread_arena</code>\uff09\uff0c\u5728\u9047\u5230 lock contention \u7684\u65f6\u5019\u53ef\u4ee5\u52a8\u6001\u5207\u6362</li>\n<li>\u8fdb\u5165 <code>_int_malloc</code> \u4ece arena \u4e2d\u5206\u914d\u4e00\u4e2a chunk\uff0c\u5206\u914d\u5b8c\u6210\u540e\u91ca\u653e arena \u7684\u9501</li>\n<li>\u63a5\u7740\u5206\u6790 <code>_int_malloc</code> \u7684\u5b9e\u73b0\uff0c\u9664 tcache \u4ee5\u5916\u7684\u5927\u90e8\u5206\u903b\u8f91\u90fd\u5728 <code>_int_malloc</code> \u51fd\u6570\u4e2d</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 fast bin \u7684\u5757\u5927\u5c0f\uff0c\u5728\u5bf9\u5e94\u7684 fast bin \u7684\u5355\u5411\u94fe\u8868\u4e2d\u5bfb\u627e\u7a7a\u95f2\u5757\uff1b\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u5219\u53d6\u51fa\u94fe\u8868\u5934\u7684\u7a7a\u95f2\u5757\uff0c\u4f5c\u4e3a\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u63a5\u7740\u628a fast bin \u94fe\u8868\u4e0a\u5269\u4f59\u7684\u7a7a\u95f2\u5757\u632a\u5230 tcache \u5f53\u4e2d\uff0c\u76f4\u5230 fast bin \u94fe\u8868\u7a7a\u6216\u8005 tcache \u6ee1\u4e3a\u6b62\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 small bin \u7684\u5757\u5927\u5c0f\uff0c\u5728\u5bf9\u5e94\u7684 small bin \u7684\u53cc\u5411\u94fe\u8868\u4e2d\u5bfb\u627e\u7a7a\u95f2\u5757\uff1b\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u5219\u53d6\u51fa\u94fe\u8868\u5c3e\u7684\u7a7a\u95f2\u5757\uff0c\u4f5c\u4e3a\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u63a5\u7740\u628a small bin \u94fe\u8868\u4e0a\u5269\u4f59\u7684\u7a7a\u95f2\u5757\u632a\u5230 tcache \u5f53\u4e2d\uff0c\u76f4\u5230 small bin \u94fe\u8868\u7a7a\u6216\u8005 tcache \u6ee1\u4e3a\u6b62\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 large bin \u7684\u5757\u5927\u5c0f\uff0c\u5219\u8fdb\u884c\u4e00\u6b21 malloc_consolidate\uff1a\u904d\u5386 fast bin \u6bcf\u4e00\u4e2a bin \u7684\u6bcf\u4e00\u4e2a\u7a7a\u95f2\u5757\uff0c\u5c1d\u8bd5\u628a\u5b83\u548c\u5185\u5b58\u4e0a\u76f8\u90bb\u7684\u524d\u540e\u7a7a\u95f2\u5757\u5408\u5e76\uff0c\u5408\u5e76\u540e\u7684\u7a7a\u95f2\u5757\u653e\u5165 unsorted bin\uff1b\u7279\u522b\u5730\uff0c\u5982\u679c\u7a7a\u95f2\u5757\u548c top chunk \u76f8\u90bb\uff0c\u5c31\u4f1a\u76f4\u63a5\u5408\u5e76\u5230 top chunk\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u628a\u7a7a\u95f2\u5757\u653e\u5165 unsorted bin</li>\n<li>\u5f00\u59cb\u4e00\u4e2a\u5927\u7684\u65e0\u9650\u5faa\u73af <code>for (;;)</code>\uff0c\u5982\u679c\u540e\u7eed\u5c1d\u8bd5\u5404\u79cd\u65b9\u5f0f\u90fd\u5206\u914d\u4e0d\u6210\u529f\uff0c\u4f46\u662f fast bin \u8fd8\u6709\u7a7a\u95f2\u5757\uff0c\u5728 malloc_consolidate \u540e\u4f1a\u4ece\u8fd9\u91cc\u5f00\u59cb\u518d\u5c1d\u8bd5\u4e00\u6b21\u5206\u914d</li>\n<li>\u904d\u5386 unsorted bin\uff0c\u6700\u591a\u5904\u7406 10000 \u4e2a\u7a7a\u95f2\u5757\uff1a<ol>\n<li>\u5982\u679c\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u5bf9\u5e94 small bin\uff0c\u5e76\u4e14\u5b83\u662f\u6700\u8fd1\u521a split \u51fa\u6765\u7684\u7a7a\u95f2\u5757\uff0c\u5e76\u4e14\u53ef\u4ee5\u653e\u5f97\u4e0b\u8981\u5206\u914d\u7684\u5757\uff0c\u5c31\u539f\u5730\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u5219\u653e\u56de\u5230 unsorted bin\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u628a\u7a7a\u95f2\u5757\u4ece unsorted bin \u94fe\u8868\u4e2d\u5220\u9664</li>\n<li>\u5982\u679c\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u6b63\u597d\u662f\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\uff0c\u5224\u65ad tcache \u662f\u5426\u8fd8\u6709\u7a7a\u95f4\uff1b\u5982\u679c tcache \u5df2\u7ecf\u6ee1\u4e86\uff0c\u76f4\u63a5\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u4f5c\u4e3a\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f\uff1b\u5982\u679c tcache \u8fd8\u6ca1\u6ee1\uff0c\u5219\u5148\u628a\u7a7a\u95f2\u5757\u632a\u5230 tcache \u5f53\u4e2d\uff0c\u7ee7\u7eed\u5904\u7406 unsorted bin \u7684\u5176\u4ed6\u7a7a\u95f2\u5757\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u5c3d\u91cf\u628a tcache \u586b\u6ee1</li>\n<li>\u6839\u636e\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\uff0c\u63d2\u5165\u5230\u5bf9\u5e94\u7684 small bin \u6216\u8005 large bin \u5f53\u4e2d</li>\n<li>\u8bb0\u5f55\u63d2\u5165\u5230 small bin \u6216\u8005 large bin \u7684\u7a7a\u95f2\u5757\u4e2a\u6570\uff0c\u5982\u679c\u8d85\u8fc7\u4e86\u9608\u503c\uff0c\u5e76\u4e14\u4e4b\u524d\u5df2\u7ecf\u627e\u5230\u4e00\u4e2a\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u6b63\u597d\u662f\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\uff0c\u540c\u65f6\u632a\u5230\u4e86 tcache \u5f53\u4e2d\uff0c\u5219\u7acb\u5373\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u4ece tcache \u4e2d\u53d6\u51fa\u5e76\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f\uff1b\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u907f\u514d\u5904\u7406\u592a\u591a\u65e0\u5173\u7684 unsorted bin \u4e2d\u7684\u7a7a\u95f2\u5757\uff0c\u5bfc\u81f4 malloc \u8c03\u7528\u65f6\u95f4\u8fc7\u957f</li>\n</ol>\n</li>\n<li>\u5982\u679c\u5728\u904d\u5386 unsorted bin \u8fc7\u7a0b\u4e2d\u627e\u5230\u4e86\u548c\u8981\u5206\u914d\u7684\u5757\u4e00\u6837\u5927\u7684\u7a7a\u95f2\u5757\uff0c\u90a3\u4e48\u8fd9\u4e2a\u7a7a\u95f2\u5757\u5df2\u7ecf\u5728 tcache \u5f53\u4e2d\u4e86\uff0c\u5219\u7acb\u5373\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u4ece tcache \u4e2d\u53d6\u51fa\u5e76\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5c5e\u4e8e large bin \u7684\u5757\u5927\u5c0f\uff0c\u5219\u627e\u5230\u5bf9\u5e94\u7684 large bin\uff0c\u4ece\u5c0f\u5230\u5927\u901a\u8fc7 nextsize \u94fe\u8868\u904d\u5386 large bin \u4e2d\u7684\u7a7a\u95f2\u5757\uff0c\u627e\u5230\u4e00\u4e2a\u8db3\u591f\u5927\u7684\u7a7a\u95f2\u5757\uff0c\u5bf9\u5b83\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u5219\u653e\u56de\u5230 unsorted bin\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u6839\u636e chunk size \u5927\u5c0f\uff0c\u627e\u5230\u5bf9\u5e94\u7684 small bin \u6216\u8005 large bin\uff0c\u7136\u540e\u4ece\u5c0f\u5230\u5927\u904d\u5386\u5404\u4e2a bin\uff08\u53ef\u80fd\u4ece small bin \u4e00\u8def\u904d\u5386\u5230 large bin\uff09\uff0c\u901a\u8fc7 bitmap \u8df3\u8fc7\u90a3\u4e9b\u7a7a\u7684 bin\uff0c\u627e\u5230\u7b2c\u4e00\u4e2a\u975e\u7a7a\u7684 bin \u7684\u7a7a\u95f2\u5757\uff0c\u5bf9\u5b83\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u5219\u653e\u56de\u5230 unsorted bin\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5982\u679c top chunk \u8db3\u591f\u5927\uff0c\u5219\u5bf9\u5b83\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u6210\u4e3a\u65b0\u7684 top chunk\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5982\u679c\u6b64\u65f6 fast bin \u6709\u7a7a\u95f2\u5757\uff0c\u8c03\u7528 malloc_consolidate\uff0c\u7136\u540e\u56de\u5230\u65e0\u9650\u5faa\u73af\u7684\u5f00\u5934\u518d\u5c1d\u8bd5\u4e00\u6b21\u5206\u914d</li>\n<li>\u6700\u540e\u7684\u515c\u5e95\u5206\u914d\u65b9\u6cd5\uff1a\u8c03\u7528 <code>sysmalloc</code>\uff0c\u901a\u8fc7 mmap \u6216 sbrk \u5411\u64cd\u4f5c\u7cfb\u7edf\u7533\u8bf7\u66f4\u591a\u7684\u5185\u5b58</li>\n</ol>\n<h3 id=\"free_4\">free<a class=\"headerlink\" href=\"#free_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u8fd9\u91cc\u5217\u51fa\u5b8c\u6574\u7684 free \u6d41\u7a0b\uff1a</p>\n<ol>\n<li>free \u7684\u5165\u53e3\u662f <code>__libc_free (void *mem)</code> \u51fd\u6570</li>\n<li>\u5982\u679c\u914d\u7f6e\u4e86 free hook\uff0c\u5219\u8c03\u7528 free hook\uff0c\u76f4\u63a5\u8fd4\u56de</li>\n<li>\u5982\u679c\u662f\u8c03\u7528 <code>free(NULL)</code>\uff0c\u76f4\u63a5\u8fd4\u56de</li>\n<li>\u68c0\u67e5 <code>mchunk_size</code> \u7684 <code>IS_MAPPED</code> \u5b57\u6bb5\uff0c\u5982\u679c\u5b83\u4e4b\u524d\u662f\u901a\u8fc7 mmap \u5206\u914d\u7684\uff0c\u90a3\u4e48\u5bf9\u5b83\u8fdb\u884c munmap\uff0c\u7136\u540e\u8fd4\u56de</li>\n<li>\u5982\u679c tcache \u8fd8\u6ca1\u521d\u59cb\u5316\uff0c\u5c31\u521d\u59cb\u5316 tcache</li>\n<li>\u627e\u5230\u8fd9\u4e2a chunk \u4ece\u54ea\u4e2a arena \u5206\u914d\u7684\uff1a\u68c0\u67e5 <code>mchunk_size</code> \u7684 <code>NON_MAIN_ARENA</code> \u5b57\u6bb5\uff0c\u5982\u679c\u5b83\u4e0d\u662f\u4ece main arena \u5206\u914d\u7684\uff0c\u5219\u6839\u636e chunk \u7684\u5730\u5740\uff0c\u627e\u5230 heap \u7684\u5730\u5740\uff08heap \u7684\u5927\u5c0f\u662f\u6709\u4e0a\u9650\u7684\uff0c\u5e76\u4e14 heap \u7684\u8d77\u59cb\u5730\u5740\u662f\u5bf9\u9f50\u5230 <code>HEAP_MAX_SIZE</code> \u7684\u6574\u500d\u6570\u8fb9\u754c\u7684\uff09\uff0c\u518d\u6839\u636e heap \u5f00\u5934\u7684 heap_info \u627e\u5230 arena \u7684\u5730\u5740</li>\n<li>\u8fdb\u5165 <code>_int_free</code>\uff0c\u63a5\u7740\u5206\u6790 <code>_int_free</code> \u7684\u5b9e\u73b0</li>\n<li>\u6839\u636e chunk size \u627e\u5230\u5bf9\u5e94\u7684 tcache bin\uff0c\u5982\u679c\u5b83\u8fd8\u6ca1\u6709\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache \u5f53\u4e2d\uff0c\u7136\u540e\u8fd4\u56de</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 fast bin \u7684\u5757\u5927\u5c0f\uff0c\u628a\u7a7a\u95f2\u5757\u653e\u5230\u5bf9\u5e94\u7684 fast bin \u7684\u5355\u5411\u94fe\u8868\u4e2d\uff0c\u7136\u540e\u8fd4\u56de\uff1b\u6ce8\u610f\u6b64\u65f6\u6ca1\u6709\u83b7\u53d6 arena \u7684\u9501\uff0c\u6240\u4ee5 fast bin \u7684\u64cd\u4f5c\u4f1a\u7528\u5230\u539f\u5b50\u6307\u4ee4\uff0c\u540c\u7406 malloc \u4e2d\u5bf9 fast bin \u7684\u64cd\u4f5c\u4e5f\u8981\u7528\u5230\u539f\u5b50\u6307\u4ee4\uff0c\u5373\u4f7f malloc \u6301\u6709\u4e86 arena \u7684\u9501</li>\n<li>\u83b7\u53d6 arena \u7684\u9501\uff0c\u5c1d\u8bd5\u628a\u7a7a\u95f2\u5757\u548c\u5728\u5185\u5b58\u4e2d\u76f8\u90bb\u7684\u524d\u540e\u7a7a\u95f2\u5757\u8fdb\u884c\u5408\u5e76\uff0c\u5408\u5e76\u540e\u7684\u7a7a\u95f2\u5757\u653e\u5165 unsorted bin\uff1b\u5408\u5e76\u65f6\uff0c\u5982\u679c\u88ab\u5408\u5e76\u7684\u7a7a\u95f2\u5757\u5df2\u7ecf\u5728 small bin \u6216\u8005 large bin \u5f53\u4e2d\uff0c\u5229\u7528\u53cc\u5411\u94fe\u8868\u7684\u7279\u6027\uff0c\u628a\u5b83\u4ece\u53cc\u5411\u94fe\u8868\u4e2d\u5220\u9664\uff1b\u5982\u679c\u548c top chunk \u76f8\u90bb\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u5408\u5e76\u5230 top chunk \u4e0a\uff0c\u7136\u540e\u8fd4\u56de</li>\n<li>\u5982\u679c\u91ca\u653e\u7684\u5757\u6bd4\u8f83\u5927\uff0c\u8d85\u8fc7\u4e86\u9608\u503c\uff0c\u5219\u89e6\u53d1\u4e00\u6b21 malloc_consolidate</li>\n</ol>\n<h2 id=\"\u5404\u79cd\u5e38\u91cf\u7684\u9ed8\u8ba4\u503c\">\u5404\u79cd\u5e38\u91cf\u7684\u9ed8\u8ba4\u503c<a class=\"headerlink\" href=\"#\u5404\u79cd\u5e38\u91cf\u7684\u9ed8\u8ba4\u503c\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u7ed9\u51fa glibc \u5185\u5b58\u5206\u914d\u5668\u5404\u5e38\u91cf\u5728 64 \u4f4d\u4e0b\u7684\u9ed8\u8ba4\u503c\uff1a</p>\n<ol>\n<li><code>MALLOC_ALIGNMENT = max(2 * SIZE_SZ, __alignof__ (long double))</code> \u7b49\u4e8e 16</li>\n<li><code>MIN_CHUNK_SIZE = offsetof(struct malloc_chunk, fd_nextsize)</code> \u7b49\u4e8e 32</li>\n<li><code>MINSIZE = alignUp(MIN_CHUNK_SIZE, MALLOC_ALIGNMENT)</code> \u7b49\u4e8e 32</li>\n<li><code>MAX_FAST_SIZE = 80 * SIZE_SZ / 4</code> \u7b49\u4e8e 160</li>\n<li><code>NSMALLBINS = 64</code></li>\n<li><code>MIN_LARGE_SIZE = (NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH</code> \u7b49\u4e8e 1024</li>\n<li><code>DEFAULT_MMAP_THRESHOLD_MIN = 128 * 1024</code> \u5373 128KB</li>\n<li><code>DEFAULT_MMAP_THRESHOLD_MAX = 4 * 1024 * 1024 * sizeof(long)</code> \u5373 32MB</li>\n<li><code>HEAP_MIN_SIZE = 32 * 1024</code> \u5373 32KB</li>\n<li><code>HEAP_MAX_SIZE = 2 * DEFAULT_MMAP_THRESHOLD_MAX</code> \u5373 64MB</li>\n<li><code>TCACHE_MAX_BINS = 64</code></li>\n<li><code>TCACHE_FILL_COUNT = 7</code></li>\n<li><code>NFASTBINS = fastbin_index(request2size(MAX_FAST_SIZE)) + 1</code> \u5373 10</li>\n<li><code>NBINS = 128</code></li>\n<li><code>DEFAULT_MXFAST = 64 * sizeof(size_t) / 4</code> \u5373 128</li>\n</ol>\n<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5404\u4e2a bin \u8d1f\u8d23\u7684\u5757\u5927\u5c0f\u8303\u56f4\uff1a</p>\n<ol>\n<li>tcache: \u5757\u5927\u5c0f\u4e0d\u8d85\u8fc7 1040 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(1032)</code> \u6216\u66f4\u5c0f</li>\n<li>fast bin: \u5757\u5927\u5c0f\u4e0d\u8d85\u8fc7 128 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(120)</code> \u6216\u66f4\u5c0f</li>\n<li>small bin: \u5757\u5927\u5c0f\u4e0d\u8d85\u8fc7 1008 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(1000)</code> \u6216\u66f4\u5c0f</li>\n<li>large bin: \u5757\u5927\u5c0f\u4e0d\u5c0f\u4e8e 1024 \u5b57\u8282\uff0c\u4e0d\u8d85\u8fc7 131056 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(1001)</code> \u5230 <code>malloc(131048)</code> \u7684\u8303\u56f4\uff0c\u66f4\u5927\u7684\u5185\u5b58\u5206\u914d\u4f1a\u76f4\u63a5\u8d70 mmap</li>\n</ol>\n<h2 id=\"\u6027\u80fd\u4f18\u5316\">\u6027\u80fd\u4f18\u5316<a class=\"headerlink\" href=\"#\u6027\u80fd\u4f18\u5316\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b glibc \u5185\u5b58\u5206\u914d\u5668\u7684\u5404\u79cd\u6027\u80fd\u4f18\u5316\u7279\u6027\uff1a</p>\n<ol>\n<li>tcache \u4f5c\u4e3a\u4e00\u4e2a thread local \u7684\u7ed3\u6784\uff0c\u4e0d\u9700\u8981\u9501\uff0c\u6027\u80fd\u662f\u6700\u597d\u7684\uff0c\u6240\u4ee5\u5c3d\u91cf\u628a\u7a7a\u95f2\u5757\u90fd\u4e22\u5230 tcache \u91cc\u9762\uff0c\u65e0\u8bba\u662f\u521a free \u7684\u7a7a\u95f2\u5757\uff0c\u8fd8\u662f\u5728 malloc \u8fc7\u7a0b\u4e2d\uff0c\u987a\u5e26\u628a\u4e00\u4e9b\u7a7a\u95f2\u5757\u4ece fast bin \u6216\u8005 small bin \u4e22\u5230 tcache \u91cc\uff0c\u8fd9\u6837\u4e5f\u51cf\u5c11\u4e86 lock arena \u7684\u6b21\u6570</li>\n<li>fast bin \u867d\u7136\u4e0d\u518d\u662f thread local\uff0c\u4f46\u5b83\u5728 free \u8def\u5f84\u4e0a\u4f7f\u7528\u539f\u5b50\u6307\u4ee4\u6765\u4ee3\u66ff\u9501\uff0c\u4f7f\u5f97 free \u5728\u5f88\u591a\u65f6\u5019\u4e0d\u9700\u8981\u83b7\u53d6 arena \u7684\u9501\uff1b\u800c\u628a fast bin \u7684\u7a7a\u95f2\u5757\u7684\u5408\u5e76\u64cd\u4f5c\u632a\u5230 malloc \u4e2d\u8fdb\u884c\uff0c\u6b64\u65f6 arena \u7684\u9501\u662f lock \u72b6\u6001\uff0c\u5c3d\u91cf\u5728\u4e00\u6b21 lock \u7684\u4e34\u754c\u533a\u91cc\u505a\u66f4\u591a\u7684\u4e8b\u60c5\uff0c\u51cf\u5c11 lock \u7684\u6b21\u6570</li>\n<li>small bin \u548c large bin \u7684\u533a\u5206\uff0c\u4e3b\u8981\u662f\u8003\u8651\u5230\u4e86\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\u5206\u5e03\uff0c\u8d8a\u5927\u503e\u5411\u4e8e\u8d8a\u7a00\u758f\uff1b\u4ee3\u4ef7\u662f large bin \u9700\u8981\u989d\u5916\u7ef4\u62a4 nextsize \u94fe\u8868\u6765\u5feb\u901f\u5730\u5bfb\u627e\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757</li>\n<li>\u5728\u56de\u6536 unsorted bin \u7684\u65f6\u5019\uff0c\u4f1a\u8fdb\u884c\u4e00\u4e2a\u5185\u5b58\u5c40\u90e8\u6027\u4f18\u5316\uff0c\u5373\u503e\u5411\u4e8e\u8fde\u7eed\u5730\u4ece\u540c\u4e00\u4e2a\u5757\u4e2d\u5207\u51fa\u5c0f\u5757\u7528\u4e8e\u5206\u914d\uff0c\u9002\u5408\u5728\u5faa\u73af\u4e2d\u5206\u914d\u5185\u5b58\u7684\u573a\u666f</li>\n<li>\u56de\u6536 unsorted bin \u65f6\uff0c\u5982\u679c\u9047\u5230\u4e86\u6b63\u597d\u548c\u8981\u5206\u914d\u7684\u5757\u5927\u5c0f\u76f8\u540c\u7684\u7a7a\u95f2\u5757\u65f6\uff0c\u5148\u4e0d\u6025\u7740\u5206\u914d\uff0c\u800c\u662f\u4e22\u5230 tcache \u4e2d\uff0c\u7136\u540e\u7ee7\u7eed\u5f80\u524d\u56de\u6536\u82e5\u5e72\u4e2a\u7a7a\u95f2\u5757\uff0c\u76f4\u5230 tcache \u6ee1\u4e86\u6216\u8005\u9047\u5230\u4e86\u8db3\u591f\u591a\u7684\u5927\u5c0f\u4e0d\u540c\u7684\u7a7a\u95f2\u5757\u4e3a\u6b62\uff1a\u8fd9\u662f\u5229\u7528\u4e86 unsorted bin \u4e2d\u7a7a\u95f2\u5757\u5927\u5c0f\u7684\u5c40\u90e8\u6027\uff0c\u6709\u673a\u4f1a\u628a\u4e00\u7cfb\u5217\u8fde\u7eed\u7684\u76f8\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u62ff\u5230 tcache \u5f53\u4e2d\uff0c\u5e76\u4e14\u9650\u5236\u4e86\u641c\u7d22\u7684\u957f\u5ea6\uff0c\u907f\u514d\u5e26\u6765\u8fc7\u591a\u989d\u5916\u7684\u5ef6\u8fdf</li>\n<li>\u5982\u679c\u5c1d\u8bd5\u4e86 unsorted bin\u3001small bin\u3001large bin \u548c top chunk \u90fd\u65e0\u6cd5\u5206\u914d\uff0c\u6700\u540e\u518d\u68c0\u67e5\u4e00\u6b21 fast bin \u662f\u5426\u4e3a\u7a7a\uff0c\u5982\u679c\u662f\u7a7a\u7684\uff0c\u5219\u8fdb\u884c\u4e00\u6b21 consolidate\uff0c\u628a fast bin \u91cc\u7684\u7a7a\u95f2\u5757\u4e22\u5230 unsorted bin \u4e2d\uff0c\u518d\u91cd\u65b0\u5c1d\u8bd5\u5206\u914d\u4e00\u6b21\uff1a\u6ce8\u610f\u8fd9\u6574\u4e2a\u8fc7\u7a0b malloc \u90fd\u662f\u6301\u6709 arena \u9501\u7684\uff0c\u800c fast bin \u5728 free \u4e2d\u7684\u5199\u5165\u662f\u4e0d\u9700\u8981\u6301\u6709 arena \u9501\u7684\uff0c\u800c\u662f\u76f4\u63a5\u7528\u539f\u5b50\u6307\u4ee4\u66f4\u65b0\uff0c\u6240\u4ee5\u8fd9\u662f\u8003\u8651\u5230\u5176\u4ed6\u7ebf\u7a0b\u5728\u540c\u65f6\u5f80\u540c\u4e00\u4e2a arena free \u7684\u60c5\u51b5</li>\n<li>\u5728\u5408\u5e76\u76f8\u90bb\u7a7a\u95f2\u5757\u7684\u65f6\u5019\uff0c\u88ab\u5408\u5e76\u7684\u7a7a\u95f2\u5757\u53ef\u80fd\u5df2\u7ecf\u5728 unsorted bin\u3001small bin \u6216\u8005 large bin \u5f53\u4e2d\uff0c\u4e3a\u4e86\u80fd\u591f\u628a\u7a7a\u95f2\u5757\u4ece\u8fd9\u4e9b bin \u91cc\u5220\u9664\uff0c\u7528\u53cc\u5411\u94fe\u8868\u6765\u5b9e\u73b0 O(1) \u65f6\u95f4\u7684\u5220\u9664</li>\n</ol>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://sourceware.org/glibc/wiki/MallocInternals\">Malloc Internals</a></li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/software/glibc-allocator.png", "date_modified": "2025-03-30T00:00:00+00:00", "date_published": "2025-03-30T00:00:00+00:00", "authors": [], "tags": ["allocator", "glibc", "linux", "malloc", "software"]}, {"id": "https://jia.je/software/2025/03/06/android-runtime-interpreter/", "url": "https://jia.je/software/2025/03/06/android-runtime-interpreter/", "title": "Android Runtime \u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"android-runtime-\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76\">Android Runtime \u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#android-runtime-\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728 <a href=\"../../01/v8-ignition-internals/\">V8 Ignition \u89e3\u91ca\u5668\u7684\u5185\u90e8\u5b9e\u73b0\u63a2\u7a76</a> \u4e2d\u63a2\u7a76\u4e86 JavaScript \u5f15\u64ce V8 \u7684\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\uff0c\u63a5\u4e0b\u6765\u5206\u6790\u4e00\u4e0b Android Runtime (ART) \u7684\u89e3\u91ca\u5668\uff0c\u5176\u539f\u7406\u4e5f\u662f\u7c7b\u4f3c\u7684\u3002\u672c\u535a\u5ba2\u5728 ARM64 Ubuntu 24.04 \u5e73\u53f0\u4e0a\u9488\u5bf9 <a href=\"https://android.googlesource.com/platform/art/+/refs/tags/android-15.0.0_r1/runtime/interpreter/\">Android Runtime (ART) 15.0.0 r1</a> \u7248\u672c\u8fdb\u884c\u5206\u6790\u3002</p>\n<!-- more -->\n\n<h2 id=\"dalvik-bytecode\">Dalvik Bytecode<a class=\"headerlink\" href=\"#dalvik-bytecode\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u5206\u6790\u89e3\u91ca\u5668\u7684\u4ee3\u7801\u524d\uff0c\u9700\u8981\u5148\u4e86\u89e3\u4e00\u4e0b\u89e3\u91ca\u5668\u7684\u8f93\u5165\uff0c\u4e5f\u5c31\u662f\u5b83\u6267\u884c\u7684\u5b57\u8282\u7801\u683c\u5f0f\u662f\u4ec0\u4e48\u3002Android Runtime \u7ee7\u627f\u548c\u53d1\u5c55\u4e86 <a href=\"https://source.android.com/docs/core/runtime/dalvik-bytecode\">Dalvik VM \u7684\u5b57\u8282\u7801 Dalvik Bytecode</a> \u683c\u5f0f\uff0c\u56e0\u6b64\u5728\u6253\u5305 Android \u5e94\u7528\u7684\u65f6\u5019\uff0cJava \u4ee3\u7801\u6700\u7ec8\u4f1a\u88ab\u7ffb\u8bd1\u6210 Dalvik Bytecode\u3002</p>\n<p>\u63a5\u4e0b\u6765\u6765\u5b9e\u8df5\u4e00\u4e0b\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u4ece Java \u4ee3\u7801\u5230 Dalvik Bytecode\uff1a</p>\n<p>\u7b2c\u4e00\u6b65\u662f\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u7684 Java \u7a0b\u5e8f\u5982\u4e0b\uff0c\u4fdd\u5b58\u5230 <code>MainActivity.java</code>\uff1a</p>\n<div class=\"language-java highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"kd\">public</span><span class=\"w\"> </span><span class=\"kd\">class</span> <span class=\"nc\">MainActivity</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"kd\">public</span><span class=\"w\"> </span><span class=\"kd\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"n\">String</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"w\">        </span><span class=\"n\">System</span><span class=\"p\">.</span><span class=\"na\">out</span><span class=\"p\">.</span><span class=\"na\">println</span><span class=\"p\">(</span><span class=\"s\">&quot;Hello, world!&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"w\">    </span><span class=\"kd\">public</span><span class=\"w\"> </span><span class=\"kd\">static</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u9996\u5148\u7528 <code>javac MainActivity.java</code> \u547d\u4ee4\u628a\u6e90\u7801\u7f16\u8bd1\u5230 Java Bytecode\u3002\u53ef\u4ee5\u7528 <code>javap -c MainActivity.class</code> \u67e5\u770b\u751f\u6210\u7684 Java Bytecode\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>Compiled from &quot;MainActivity.java&quot;\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>public class MainActivity {\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>  public MainActivity();\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>    Code:\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>       0: aload_0\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>       4: return\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a>  public static void main(java.lang.String[]);\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a>    Code:\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a>       0: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a>       3: ldc           #13                 // String Hello, world!\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a>       5: invokevirtual #15                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a>       8: return\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a>  public static int add(int, int);\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a>    Code:\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a>       0: iload_0\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a>       1: iload_1\n</span><span id=\"__span-1-20\"><a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\" href=\"#__codelineno-1-20\"></a>       2: iadd\n</span><span id=\"__span-1-21\"><a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\" href=\"#__codelineno-1-21\"></a>       3: ireturn\n</span><span id=\"__span-1-22\"><a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\" href=\"#__codelineno-1-22\"></a>}\n</span></code></pre></div>\n<p>Java Bytecode \u662f\u4e2a\u5178\u578b\u7684\u6808\u5f0f\u5b57\u8282\u7801\uff0c\u56e0\u6b64\u4ece <code>int add(int, int)</code> \u51fd\u6570\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u5206\u522b\u538b\u6808\u7b2c\u96f6\u4e2a\u548c\u7b2c\u4e00\u4e2a\u5c40\u90e8\u904d\u53d8\u91cf\uff08\u5373\u53c2\u6570 <code>a</code> \u548c <code>b</code>\uff09\uff0c\u7136\u540e\u7528 <code>iadd</code> \u6307\u4ee4\u4ece\u6808\u9876\u5f39\u51fa\u4e24\u4e2a\u5143\u7d20\uff0c\u6c42\u548c\u540e\u518d\u628a\u7ed3\u679c\u538b\u6808\u3002</p>\n<p>\u63a5\u7740\uff0c\u7528 Android SDK \u7684 Build Tools \u63d0\u4f9b\u7684\u547d\u4ee4 <code>d8</code> \u6765\u628a\u5b83\u8f6c\u6362\u4e3a Dalvik Bytecode\u3002\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u5b89\u88c5 Android SDK\uff0c\u53ef\u4ee5\u6309\u7167 <a href=\"https://developer.android.com/tools/sdkmanager\">sdkmanager \u6587\u6863</a> \u6765\u5b89\u88c5 sdkmanager\uff0c\u518d\u7528 sdkmanager \u5b89\u88c5\u8f83\u65b0\u7248\u672c\u7684 <code>build-tools</code>\u3002\u8f6c\u6362\u7684\u547d\u4ee4\u4e3a <code>$ANDROID_HOME/build-tools/$VERSION/d8 MainActivity.class</code>\uff0c\u7ed3\u679c\u4f1a\u4fdd\u5b58\u5728\u5f53\u524d\u76ee\u5f55\u7684 <code>classes.dex</code> \u6587\u4ef6\u5185\u3002\u63a5\u7740\u53ef\u4ee5\u7528 <code>$ANDROID_HOME/build-tools/$VERSION/dexdump -d classes.dex</code> \u6765\u67e5\u770b Dalvik Bytecode\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>Processing &#39;classes.dex&#39;...\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>Opened &#39;classes.dex&#39;, DEX version &#39;035&#39;\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>Class #0            -\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>  Class descriptor  : &#39;LMainActivity;&#39;\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a>  Access flags      : 0x0001 (PUBLIC)\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a>  Superclass        : &#39;Ljava/lang/Object;&#39;\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a>  Interfaces        -\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a>  Static fields     -\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>  Instance fields   -\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a>  Direct methods    -\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a>    #0              : (in LMainActivity;)\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a>      name          : &#39;&lt;init&gt;&#39;\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a>      type          : &#39;()V&#39;\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a>      access        : 0x10001 (PUBLIC CONSTRUCTOR)\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a>      code          -\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a>      registers     : 1\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a>      ins           : 1\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a>      outs          : 1\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a>      insns size    : 4 16-bit code units\n</span><span id=\"__span-2-20\"><a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\" href=\"#__codelineno-2-20\"></a>00016c:                                        |[00016c] MainActivity.&lt;init&gt;:()V\n</span><span id=\"__span-2-21\"><a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\" href=\"#__codelineno-2-21\"></a>00017c: 7010 0400 0000                         |0000: invoke-direct {v0}, Ljava/lang/Object;.&lt;init&gt;:()V // method@0004\n</span><span id=\"__span-2-22\"><a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\" href=\"#__codelineno-2-22\"></a>000182: 0e00                                   |0003: return-void\n</span><span id=\"__span-2-23\"><a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\" href=\"#__codelineno-2-23\"></a>      catches       : (none)\n</span><span id=\"__span-2-24\"><a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\" href=\"#__codelineno-2-24\"></a>      positions     :\n</span><span id=\"__span-2-25\"><a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\" href=\"#__codelineno-2-25\"></a>        0x0000 line=1\n</span><span id=\"__span-2-26\"><a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\" href=\"#__codelineno-2-26\"></a>      locals        :\n</span><span id=\"__span-2-27\"><a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\" href=\"#__codelineno-2-27\"></a>        0x0000 - 0x0004 reg=0 this LMainActivity;\n</span><span id=\"__span-2-28\"><a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\" href=\"#__codelineno-2-28\"></a>\n</span><span id=\"__span-2-29\"><a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\" href=\"#__codelineno-2-29\"></a>    #1              : (in LMainActivity;)\n</span><span id=\"__span-2-30\"><a id=\"__codelineno-2-30\" name=\"__codelineno-2-30\" href=\"#__codelineno-2-30\"></a>      name          : &#39;add&#39;\n</span><span id=\"__span-2-31\"><a id=\"__codelineno-2-31\" name=\"__codelineno-2-31\" href=\"#__codelineno-2-31\"></a>      type          : &#39;(II)I&#39;\n</span><span id=\"__span-2-32\"><a id=\"__codelineno-2-32\" name=\"__codelineno-2-32\" href=\"#__codelineno-2-32\"></a>      access        : 0x0009 (PUBLIC STATIC)\n</span><span id=\"__span-2-33\"><a id=\"__codelineno-2-33\" name=\"__codelineno-2-33\" href=\"#__codelineno-2-33\"></a>      code          -\n</span><span id=\"__span-2-34\"><a id=\"__codelineno-2-34\" name=\"__codelineno-2-34\" href=\"#__codelineno-2-34\"></a>      registers     : 2\n</span><span id=\"__span-2-35\"><a id=\"__codelineno-2-35\" name=\"__codelineno-2-35\" href=\"#__codelineno-2-35\"></a>      ins           : 2\n</span><span id=\"__span-2-36\"><a id=\"__codelineno-2-36\" name=\"__codelineno-2-36\" href=\"#__codelineno-2-36\"></a>      outs          : 0\n</span><span id=\"__span-2-37\"><a id=\"__codelineno-2-37\" name=\"__codelineno-2-37\" href=\"#__codelineno-2-37\"></a>      insns size    : 2 16-bit code units\n</span><span id=\"__span-2-38\"><a id=\"__codelineno-2-38\" name=\"__codelineno-2-38\" href=\"#__codelineno-2-38\"></a>000158:                                        |[000158] MainActivity.add:(II)I\n</span><span id=\"__span-2-39\"><a id=\"__codelineno-2-39\" name=\"__codelineno-2-39\" href=\"#__codelineno-2-39\"></a>000168: b010                                   |0000: add-int/2addr v0, v1\n</span><span id=\"__span-2-40\"><a id=\"__codelineno-2-40\" name=\"__codelineno-2-40\" href=\"#__codelineno-2-40\"></a>00016a: 0f00                                   |0001: return v0\n</span><span id=\"__span-2-41\"><a id=\"__codelineno-2-41\" name=\"__codelineno-2-41\" href=\"#__codelineno-2-41\"></a>      catches       : (none)\n</span><span id=\"__span-2-42\"><a id=\"__codelineno-2-42\" name=\"__codelineno-2-42\" href=\"#__codelineno-2-42\"></a>      positions     :\n</span><span id=\"__span-2-43\"><a id=\"__codelineno-2-43\" name=\"__codelineno-2-43\" href=\"#__codelineno-2-43\"></a>        0x0000 line=7\n</span><span id=\"__span-2-44\"><a id=\"__codelineno-2-44\" name=\"__codelineno-2-44\" href=\"#__codelineno-2-44\"></a>      locals        :\n</span><span id=\"__span-2-45\"><a id=\"__codelineno-2-45\" name=\"__codelineno-2-45\" href=\"#__codelineno-2-45\"></a>        0x0000 - 0x0002 reg=0 (null) I\n</span><span id=\"__span-2-46\"><a id=\"__codelineno-2-46\" name=\"__codelineno-2-46\" href=\"#__codelineno-2-46\"></a>        0x0000 - 0x0002 reg=1 (null) I\n</span><span id=\"__span-2-47\"><a id=\"__codelineno-2-47\" name=\"__codelineno-2-47\" href=\"#__codelineno-2-47\"></a>\n</span><span id=\"__span-2-48\"><a id=\"__codelineno-2-48\" name=\"__codelineno-2-48\" href=\"#__codelineno-2-48\"></a>    #2              : (in LMainActivity;)\n</span><span id=\"__span-2-49\"><a id=\"__codelineno-2-49\" name=\"__codelineno-2-49\" href=\"#__codelineno-2-49\"></a>      name          : &#39;main&#39;\n</span><span id=\"__span-2-50\"><a id=\"__codelineno-2-50\" name=\"__codelineno-2-50\" href=\"#__codelineno-2-50\"></a>      type          : &#39;([Ljava/lang/String;)V&#39;\n</span><span id=\"__span-2-51\"><a id=\"__codelineno-2-51\" name=\"__codelineno-2-51\" href=\"#__codelineno-2-51\"></a>      access        : 0x0009 (PUBLIC STATIC)\n</span><span id=\"__span-2-52\"><a id=\"__codelineno-2-52\" name=\"__codelineno-2-52\" href=\"#__codelineno-2-52\"></a>      code          -\n</span><span id=\"__span-2-53\"><a id=\"__codelineno-2-53\" name=\"__codelineno-2-53\" href=\"#__codelineno-2-53\"></a>      registers     : 2\n</span><span id=\"__span-2-54\"><a id=\"__codelineno-2-54\" name=\"__codelineno-2-54\" href=\"#__codelineno-2-54\"></a>      ins           : 1\n</span><span id=\"__span-2-55\"><a id=\"__codelineno-2-55\" name=\"__codelineno-2-55\" href=\"#__codelineno-2-55\"></a>      outs          : 2\n</span><span id=\"__span-2-56\"><a id=\"__codelineno-2-56\" name=\"__codelineno-2-56\" href=\"#__codelineno-2-56\"></a>      insns size    : 8 16-bit code units\n</span><span id=\"__span-2-57\"><a id=\"__codelineno-2-57\" name=\"__codelineno-2-57\" href=\"#__codelineno-2-57\"></a>000184:                                        |[000184] MainActivity.main:([Ljava/lang/String;)V\n</span><span id=\"__span-2-58\"><a id=\"__codelineno-2-58\" name=\"__codelineno-2-58\" href=\"#__codelineno-2-58\"></a>000194: 6201 0000                              |0000: sget-object v1, Ljava/lang/System;.out:Ljava/io/PrintStream; // field@0000\n</span><span id=\"__span-2-59\"><a id=\"__codelineno-2-59\" name=\"__codelineno-2-59\" href=\"#__codelineno-2-59\"></a>000198: 1a00 0100                              |0002: const-string v0, &quot;Hello, world!&quot; // string@0001\n</span><span id=\"__span-2-60\"><a id=\"__codelineno-2-60\" name=\"__codelineno-2-60\" href=\"#__codelineno-2-60\"></a>00019c: 6e20 0300 0100                         |0004: invoke-virtual {v1, v0}, Ljava/io/PrintStream;.println:(Ljava/lang/String;)V // method@0003\n</span><span id=\"__span-2-61\"><a id=\"__codelineno-2-61\" name=\"__codelineno-2-61\" href=\"#__codelineno-2-61\"></a>0001a2: 0e00                                   |0007: return-void\n</span><span id=\"__span-2-62\"><a id=\"__codelineno-2-62\" name=\"__codelineno-2-62\" href=\"#__codelineno-2-62\"></a>      catches       : (none)\n</span><span id=\"__span-2-63\"><a id=\"__codelineno-2-63\" name=\"__codelineno-2-63\" href=\"#__codelineno-2-63\"></a>      positions     :\n</span><span id=\"__span-2-64\"><a id=\"__codelineno-2-64\" name=\"__codelineno-2-64\" href=\"#__codelineno-2-64\"></a>        0x0000 line=3\n</span><span id=\"__span-2-65\"><a id=\"__codelineno-2-65\" name=\"__codelineno-2-65\" href=\"#__codelineno-2-65\"></a>        0x0007 line=4\n</span><span id=\"__span-2-66\"><a id=\"__codelineno-2-66\" name=\"__codelineno-2-66\" href=\"#__codelineno-2-66\"></a>      locals        :\n</span><span id=\"__span-2-67\"><a id=\"__codelineno-2-67\" name=\"__codelineno-2-67\" href=\"#__codelineno-2-67\"></a>        0x0000 - 0x0008 reg=1 (null) [Ljava/lang/String;\n</span><span id=\"__span-2-68\"><a id=\"__codelineno-2-68\" name=\"__codelineno-2-68\" href=\"#__codelineno-2-68\"></a>\n</span><span id=\"__span-2-69\"><a id=\"__codelineno-2-69\" name=\"__codelineno-2-69\" href=\"#__codelineno-2-69\"></a>  Virtual methods   -\n</span><span id=\"__span-2-70\"><a id=\"__codelineno-2-70\" name=\"__codelineno-2-70\" href=\"#__codelineno-2-70\"></a>  source_file_idx   : 9 (MainActivity.java)\n</span></code></pre></div>\n<p>\u5bf9\u6bd4 Java Bytecode\uff0c\u5728 Dalvik Bytecode \u91cc\u7684 <code>add</code> \u51fd\u6570\u7684\u5b9e\u73b0\u5c31\u5927\u4e0d\u76f8\u540c\u4e86\uff1a</p>\n<ol>\n<li><code>add-int/2addr v0, v1</code>: \u6c42\u5bc4\u5b58\u5668 <code>v1</code> \u548c\u5bc4\u5b58\u5668 <code>v0</code> \u4e4b\u548c\uff0c\u5728\u8fd9\u91cc\u5c31\u5bf9\u5e94 <code>a</code> \u548c <code>b</code> \u4e24\u4e2a\u53c2\u6570\uff0c\u7ed3\u679c\u5199\u5230 <code>v0</code> \u5bc4\u5b58\u5668\u5f53\u4e2d</li>\n<li><code>return v0</code>: \u4ee5\u5bc4\u5b58\u5668 <code>v0</code> \u4e3a\u8fd4\u56de\u503c\uff0c\u7ed3\u675f\u5f53\u524d\u51fd\u6570</li>\n</ol>\n<p>\u53ef\u89c1 Dalvik Bytecode \u91c7\u7528\u7684\u662f\u7c7b\u4f3c V8 \u7684\u57fa\u4e8e\u5bc4\u5b58\u5668\u7684\u5b57\u8282\u7801\uff0c\u4e0d\u8fc7\u6ca1\u6709 V8 \u7684 <code>accumulator</code>\u3002</p>\n<p>Dalvik Bytecode \u7684\u5b8c\u6574\u5217\u8868\u89c1 <a href=\"https://source.android.com/docs/core/runtime/dalvik-bytecode\">Dalvik bytecode format</a>\uff0c\u5b83\u7684\u683c\u5f0f\u57fa\u672c\u4e0a\u662f\u4e24\u4e2a\u5b57\u8282\u4e3a\u4e00\u7ec4\uff0c\u6bcf\u7ec4\u91cc\u7b2c\u4e00\u4e2a\u5b57\u8282\u4ee3\u8868 Op \u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u8282\u4ee3\u8868\u53c2\u6570\uff0c\u6709\u4e00\u4e9b Op \u540e\u9762\u8fd8\u4f1a\u5e26\u6709\u591a\u7ec4\u53c2\u6570\u3002</p>\n<p>\u4f8b\u5982\u4e0a\u9762\u7684 <code>add-int/2addr vA, vB</code> \u6307\u4ee4\u7684\u7f16\u7801\u662f\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u5b57\u8282\u662f <code>0xb0</code>\uff0c\u8868\u793a\u8fd9\u662f\u4e00\u4e2a <code>add-int/2addr</code> Op</li>\n<li>\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5171 8 \u4f4d\uff0c\u4f4e 4 \u4f4d\u7f16\u7801\u4e86 <code>vA</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>A</code>\uff0c\u9ad8 4 \u4f4d\u7f16\u7801\u4e86 <code>vB</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>B</code></li>\n</ol>\n<p>\u6240\u4ee5 <code>add-int/2addr v0, v1</code> \u7684\u7f16\u7801\u5c31\u662f <code>0xb0, 0 | (1 &lt;&lt; 4)</code> \u5373 <code>0xb0, 0x10</code>\u3002\u56e0\u4e3a\u5b58\u5f97\u5f88\u7d27\u51d1\uff0c\u5bc4\u5b58\u5668\u7f16\u53f7\u53ea\u6709 4 \u4f4d\uff0c\u6240\u4ee5\u8fd9\u4e2a Op \u7684\u64cd\u4f5c\u6570\u4e0d\u80fd\u8bbf\u95ee v16 \u6216\u66f4\u9ad8\u7684\u5bc4\u5b58\u5668\u3002</p>\n<p><code>return vAA</code> \u6307\u4ee4\u7684\u7f16\u7801\u7c7b\u4f3c\uff0c\u4e0d\u8fc7\u56e0\u4e3a\u53ea\u9700\u8981\u7f16\u7801\u4e00\u4e2a\u64cd\u4f5c\u6570\uff0c\u6240\u4ee5\u6709 8 \u4f4d\u53ef\u4ee5\u7f16\u7801\u8fd4\u56de\u503c\u7528\u54ea\u4e2a\u5bc4\u5b58\u5668\uff1b\u4e3a\u4e86\u533a\u5206\u662f 4 \u4f4d\u7684\u7f16\u7801\u8fd8\u662f 8 \u4f4d\u7684\u7f16\u7801\uff0c\u8fd9\u91cc\u7528 <code>vAA</code> \u8868\u793a\u53ef\u4ee5\u7528 8 \u4f4d\u6765\u8bb0\u5f55\u5bc4\u5b58\u5668\u7f16\u53f7\u3002<code>return vAA</code> \u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u662f <code>0x0f</code> \u8868\u793a Op \u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5c31\u662f\u5bc4\u5b58\u5668\u7f16\u53f7 <code>A</code>\u3002\u4e0a\u9762\u51fa\u73b0\u7684 <code>return v0</code> \u7684\u7f16\u7801\u5c31\u662f <code>0x0f, 0x00</code>\u3002</p>\n<p>\u4e00\u4e9b\u6bd4\u8f83\u590d\u6742\u7684 Op \u4f1a\u9644\u5e26\u66f4\u591a\u7684\u53c2\u6570\uff0c\u6b64\u65f6\u7f16\u7801\u5c31\u53ef\u80fd\u6d89\u53ca\u5230\u66f4\u591a\u7684\u5b57\u8282\u3002\u6bd4\u5982 <code>invoke-virtual {vC, vD, vE, vF, vG}, meth@BBBB</code>\uff0c\u53ef\u4ee5\u643a\u5e26\u53ef\u53d8\u4e2a\u5bc4\u5b58\u5668\u53c2\u6570\uff0c\u5728\u7f16\u7801\u7684\u65f6\u5019\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u5b57\u8282 <code>0x6e</code> \u8868\u793a\u8fd9\u662f\u4e00\u4e2a <code>invoke-virtual</code> Op</li>\n<li>\u7b2c\u4e8c\u4e2a\u5b57\u8282\u7684\u9ad8 4 \u4f4d\u8bb0\u5f55\u4e86\u53c2\u6570\u4e2a\u6570</li>\n<li>\u7b2c\u4e09\u548c\u7b2c\u56db\u4e2a\u5b57\u8282\u5171 16 \u4f4d\uff0c\u8bb0\u5f55\u4e86\u8981\u8c03\u7528\u7684\u51fd\u6570\u7684 index\uff0c\u8fd9\u4e2a index \u4f1a\u88ab\u62ff\u6765\u7d22\u5f15 DEX \u7684 method_ids \u8868</li>\n<li>\u7b2c\u4e94\u548c\u7b2c\u516d\u4e2a\u5b57\u8282\u5171 16 \u4f4d\uff0c\u914d\u5408\u7b2c\u4e8c\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff0c\u6700\u591a\u53ef\u4ee5\u4f20\u9012 5 \u4e2a\u5bc4\u5b58\u5668\u53c2\u6570\uff0c\u6bcf\u4e2a\u5bc4\u5b58\u5668\u53c2\u6570 4 \u4f4d</li>\n</ol>\n<p>\u56e0\u6b64\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c<code>invoke-virtual {v1, v0}, Ljava/io/PrintStream;.println:(Ljava/lang/String;)V // method@0003</code> \u88ab\u7f16\u7801\u4e3a\uff1a<code>0x6e, 0x20, 0x03, 0x00, 0x01, 0x00</code>\u3002\u53e6\u5916\u6784\u9020\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff0c\u628a\u4e94\u4e2a\u53c2\u6570\u90fd\u7528\u4e0a\uff1a<code>invoke-virtual {v1, v4, v0, v2, v3}, LMainActivity;.add4:(IIII)I // method@0002</code> \u88ab\u7f16\u7801\u4e3a <code>0x6e, 0x53, 0x02, 0x00, 0x41, 0x20</code>\uff0c\u53ef\u4ee5\u770b\u5230\u4e94\u4e2a\u53c2\u6570\u7684\u7f16\u7801\u987a\u5e8f\u662f\u7b2c\u4e94\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff08<code>v1</code>\uff09\u548c\u9ad8 4 \u4f4d\uff08<code>v4</code>\uff09\uff0c\u7b2c\u516d\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff08<code>v0</code>\uff09\u548c\u9ad8 4 \u4f4d\uff08<code>v2</code>\uff09\uff0c\u6700\u540e\u662f\u7b2c\u4e8c\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff08<code>v3</code>\uff09\u3002</p>\n<p>\u4e86\u89e3\u4e86 Dalvik Bytecode \u7684\u7ed3\u6784\uff0c\u63a5\u4e0b\u6765\u89c2\u5bdf\u5b83\u662f\u600e\u4e48\u88ab\u89e3\u91ca\u6267\u884c\u7684\u3002</p>\n<h2 id=\"\u89e3\u91ca\u5668\">\u89e3\u91ca\u5668<a class=\"headerlink\" href=\"#\u89e3\u91ca\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>Android Runtime (ART) \u7684\u89e3\u91ca\u5668\u653e\u5728 <code>runtime/interpreter</code> \u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8fdb\u884c\u4e00\u4e9b<a href=\"https://stackoverflow.com/questions/22187630/what-does-mterp-mean\">\u8003\u53e4</a>\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u662f\u4ece\u66f4\u65e9\u7684 Dalvik VM \u6765\u7684\u3002\u5b83\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u89e3\u91ca\u5668\u5b9e\u73b0\uff1a</p>\n<p>\u7b2c\u4e00\u4e2a\u89e3\u91ca\u5668\u57fa\u4e8e switch-case \u7684 C++ \u4ee3\u7801\u5b9e\u73b0\uff0c\u5176\u9010\u4e2a\u904d\u5386 Op\uff0c\u6839\u636e Op \u7684\u7c7b\u578b Opcode \u6267\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\uff0c\u7c7b\u4f3c\u4e0b\u9762\u7684\u4ee3\u7801\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">  </span><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">op</span><span class=\"p\">.</span><span class=\"n\">opcode</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"no\">op_add</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">      </span><span class=\"c1\">// implement add here</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">      </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"c1\">// ... other opcode handlers</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u7b2c\u4e8c\u4e2a\u89e3\u91ca\u5668\u4ee5 <a href=\"https://en.wikipedia.org/wiki/Threaded_code#Token_threading\">Token threading</a> \u7684\u65b9\u5f0f\u5b9e\u73b0\uff0c\u6bcf\u79cd Op \u5bf9\u5e94\u4e00\u6bb5\u4ee3\u7801\u3002\u8fd9\u6bb5\u4ee3\u7801\u5728\u5b8c\u6210 Op \u7684\u64cd\u4f5c\u540e\uff0c\u8bfb\u53d6\u4e0b\u4e00\u4e2a Op\uff0c\u518d\u95f4\u63a5\u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a Op \u5bf9\u5e94\u7684\u4ee3\u7801\u3002\u5176\u5de5\u4f5c\u539f\u7406\u7c7b\u4f3c\u4e0b\u9762\u7684\u4ee3\u7801\uff0c\u8fd9\u91cc <a href=\"https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html\"><code>goto *</code></a> \u662f GNU C \u7684\u6269\u5c55\uff0c\u5bf9\u5e94\u95f4\u63a5\u8df3\u8f6c\u6307\u4ee4\uff0c\u5176\u76ee\u7684\u5730\u5740\u53d6\u51b3\u4e8e <code>handlers[next_opcode]</code> \u7684\u503c\uff0c\u610f\u601d\u662f\u6839\u636e\u4e0b\u4e00\u4e2a op \u7684 Opcode\uff0c\u627e\u5230\u5bf9\u5e94\u7684 handler\uff0c\u76f4\u63a5\u8df3\u8f6c\u8fc7\u53bb\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"w\">  </span><span class=\"c1\">// op handlers array</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"w\">  </span><span class=\"n\">handlers</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"o\">&amp;</span><span class=\"n\">op_add</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">op_sub</span><span class=\"p\">};</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"nl\">op_add</span><span class=\"p\">:</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"w\">  </span><span class=\"c1\">// implement add here</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"w\">  </span><span class=\"c1\">// read next opcode here</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"w\">  </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">handlers</span><span class=\"p\">[</span><span class=\"n\">next_opcode</span><span class=\"p\">];</span>\n</span></code></pre></div>\n<p>\u5b9e\u9645\u5b9e\u73b0\u7684\u65f6\u5019\u66f4\u8fdb\u4e00\u6b65\uff0c\u7528\u6c47\u7f16\u5b9e\u73b0\u5404\u4e2a op handler\uff0c\u5e76\u628a handler \u653e\u5728\u4e86 128 \u5b57\u8282\u5bf9\u9f50\u7684\u4f4d\u7f6e\uff0c\u4fdd\u8bc1\u6bcf\u4e2a handler \u4e0d\u8d85\u8fc7 128 \u4e2a\u5b57\u8282\uff0c\u4ece\u800c\u628a\u8bfb\u53d6 <code>handlers</code> \u6570\u7ec4\u518d\u8df3\u8f6c\u7684 <code>goto *</code> \u6539\u6210\u4e86\u7528\u4e58\u6cd5\u548c\u52a0\u6cd5\u8ba1\u7b97\u51fa handler \u7684\u5730\u5740\u518d\u8df3\u8f6c\uff08computed goto\uff09\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"nl\">handlers_begin:</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"nl\">op_add:</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\">  </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"mi\">128</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"w\">  </span><span class=\"c1\"># implement add here</span>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"w\">  </span><span class=\"c1\"># read next opcode here</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a><span class=\"w\">  </span><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"no\">to</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">handlers_begin</span><span class=\"w\"> </span><span class=\"err\">+</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"no\">next_opcode</span><span class=\"p\">)</span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"nl\">op_sub:</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">  </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"mi\">128</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\">  </span><span class=\"c1\"># implement add here</span>\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">  </span><span class=\"c1\"># read next opcode here</span>\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\">  </span><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"no\">to</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">handlers_begin</span><span class=\"w\"> </span><span class=\"err\">+</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"no\">next_opcode</span><span class=\"p\">)</span><span class=\"c1\">;</span>\n</span></code></pre></div>\n<p>\u4e0b\u9762\u7ed3\u5408\u6e90\u7801\u6765\u5177\u4f53\u5206\u6790\u8fd9\u4e24\u79cd\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u3002</p>\n<h3 id=\"\u57fa\u4e8e-switch-case-\u7684\u89e3\u91ca\u5668\">\u57fa\u4e8e switch-case \u7684\u89e3\u91ca\u5668<a class=\"headerlink\" href=\"#\u57fa\u4e8e-switch-case-\u7684\u89e3\u91ca\u5668\" title=\"Permanent link\">&para;</a></h3>\n<p>\u76ee\u524d Android Runtime \u5305\u62ec\u4e00\u4e2a\u57fa\u4e8e switch-case \u7684\u89e3\u91ca\u5668\uff0c\u5b9e\u73b0\u5728 <code>runtime/interpreter/interpreter_switch_impl-inl.h</code> \u6587\u4ef6\u5f53\u4e2d\uff0c\u5b83\u7684\u6838\u5fc3\u903b\u8f91\u5c31\u662f\u4e00\u4e2a\u5faa\u73af\u5957 switch-case\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"w\">  </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nb\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"n\">dex_pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">GetDexPc</span><span class=\"p\">(</span><span class=\"n\">insns</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"w\">    </span><span class=\"n\">shadow_frame</span><span class=\"p\">.</span><span class=\"n\">SetDexPC</span><span class=\"p\">(</span><span class=\"n\">dex_pc</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"w\">    </span><span class=\"n\">TraceExecution</span><span class=\"p\">(</span><span class=\"n\">shadow_frame</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dex_pc</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"w\">    </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">inst_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Fetch16</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-7\"><a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\" href=\"#__codelineno-6-7\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-8\"><a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\" href=\"#__codelineno-6-8\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Moved outside to keep frames small under asan.</span>\n</span><span id=\"__span-6-9\"><a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\" href=\"#__codelineno-6-9\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">InstructionHandler</span><span class=\"o\">&lt;</span><span class=\"n\">transaction_active</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInvalidFormat</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n</span><span id=\"__span-6-10\"><a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\" href=\"#__codelineno-6-10\"></a><span class=\"w\">            </span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">instrumentation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shadow_frame</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dex_pc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"p\">).</span>\n</span><span id=\"__span-6-11\"><a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\" href=\"#__codelineno-6-11\"></a><span class=\"w\">            </span><span class=\"n\">Preamble</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-12\"><a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\" href=\"#__codelineno-6-12\"></a><span class=\"w\">      </span><span class=\"n\">DCHECK_EQ</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"o\">-&gt;</span><span class=\"n\">IsExceptionPending</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Opcode</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">MOVE_EXCEPTION</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-13\"><a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\" href=\"#__codelineno-6-13\"></a><span class=\"w\">      </span><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Opcode</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-14\"><a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\" href=\"#__codelineno-6-14\"></a><span class=\"cp\">#define OPCODE_CASE(OPCODE, OPCODE_NAME, NAME, FORMAT, i, a, e, v)                                \\</span>\n</span><span id=\"__span-6-15\"><a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\" href=\"#__codelineno-6-15\"></a><span class=\"cp\">        case OPCODE: {                                                                            \\</span>\n</span><span id=\"__span-6-16\"><a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\" href=\"#__codelineno-6-16\"></a><span class=\"cp\">          next = inst-&gt;RelativeAt(Instruction::SizeInCodeUnits(Instruction::FORMAT));             \\</span>\n</span><span id=\"__span-6-17\"><a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\" href=\"#__codelineno-6-17\"></a><span class=\"cp\">          success = OP_##OPCODE_NAME&lt;transaction_active&gt;(                                         \\</span>\n</span><span id=\"__span-6-18\"><a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\" href=\"#__codelineno-6-18\"></a><span class=\"cp\">              ctx, instrumentation, self, shadow_frame, dex_pc, inst, inst_data, next, exit);     \\</span>\n</span><span id=\"__span-6-19\"><a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\" href=\"#__codelineno-6-19\"></a><span class=\"cp\">          if (success &amp;&amp; LIKELY(!interpret_one_instruction)) {                                    \\</span>\n</span><span id=\"__span-6-20\"><a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\" href=\"#__codelineno-6-20\"></a><span class=\"cp\">            continue;                                                                             \\</span>\n</span><span id=\"__span-6-21\"><a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\" href=\"#__codelineno-6-21\"></a><span class=\"cp\">          }                                                                                       \\</span>\n</span><span id=\"__span-6-22\"><a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\" href=\"#__codelineno-6-22\"></a><span class=\"cp\">          break;                                                                                  \\</span>\n</span><span id=\"__span-6-23\"><a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\" href=\"#__codelineno-6-23\"></a><span class=\"cp\">        }</span>\n</span><span id=\"__span-6-24\"><a id=\"__codelineno-6-24\" name=\"__codelineno-6-24\" href=\"#__codelineno-6-24\"></a><span class=\"w\">  </span><span class=\"n\">DEX_INSTRUCTION_LIST</span><span class=\"p\">(</span><span class=\"n\">OPCODE_CASE</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-25\"><a id=\"__codelineno-6-25\" name=\"__codelineno-6-25\" href=\"#__codelineno-6-25\"></a><span class=\"cp\">#undef OPCODE_CASE</span>\n</span><span id=\"__span-6-26\"><a id=\"__codelineno-6-26\" name=\"__codelineno-6-26\" href=\"#__codelineno-6-26\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-27\"><a id=\"__codelineno-6-27\" name=\"__codelineno-6-27\" href=\"#__codelineno-6-27\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-28\"><a id=\"__codelineno-6-28\" name=\"__codelineno-6-28\" href=\"#__codelineno-6-28\"></a><span class=\"w\">    </span><span class=\"c1\">// exit condition handling omitted</span>\n</span><span id=\"__span-6-29\"><a id=\"__codelineno-6-29\" name=\"__codelineno-6-29\" href=\"#__codelineno-6-29\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86 <a href=\"https://en.wikipedia.org/wiki/X_macro\">X macro</a> \u7684\u7f16\u7a0b\u6280\u5de7\uff1a\u5982\u679c\u4f60\u9700\u8981\u5728\u4e0d\u540c\u7684\u5730\u65b9\u91cd\u590d\u51fa\u73b0\u540c\u4e00\u4e2a list\uff0c\u6bd4\u5982\u5728\u8fd9\u91cc\uff0c\u5c31\u662f\u6240\u6709\u53ef\u80fd\u7684 Opcode \u7c7b\u578b\uff0c\u4f60\u53ef\u4ee5\u5728\u4e00\u4e2a\u5934\u6587\u4ef6\u4e2d\u7528\u4e00\u4e2a\u5b8f\uff0c\u4ee5\u53e6\u4e00\u4e2a\u5b8f\u4e3a\u53c2\u6570\u53bb\u5217\u51fa\u6765\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"c1\">// V(opcode, instruction_code, name, format, index, flags, extended_flags, verifier_flags);</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"cp\">#define DEX_INSTRUCTION_LIST(V) \\</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"cp\">  V(0x00, NOP, &quot;nop&quot;, k10x, kIndexNone, kContinue, 0, kVerifyNothing) \\</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"cp\">  V(0x01, MOVE, &quot;move&quot;, k12x, kIndexNone, kContinue, 0, kVerifyRegA | kVerifyRegB) \\</span>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"cp\">  </span><span class=\"c1\">// omitted</span>\n</span></code></pre></div>\n<p>\u8fd9\u4e2a\u5b8f\u5b9a\u4e49\u5728 <code>libdexfile/dex/dex_instruction_list.h</code> \u5934\u6587\u4ef6\u5f53\u4e2d\u3002\u5728\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e34\u65f6\u5b9a\u4e49\u4e00\u4e2a\u5b8f\uff0c\u7136\u540e\u628a\u65b0\u5b9a\u4e49\u7684\u5b8f\u4f20\u5165 <code>DEX_INSTRUCTION_LIST</code> \u7684\u53c2\u6570\u5373\u53ef\u3002\u4f8b\u5982\u8981\u751f\u6210\u4e00\u4e2a\u6570\u7ec4\uff0c\u8bb0\u5f55\u6240\u6709\u7684 op \u540d\u5b57\uff0c\u53ef\u4ee5\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"c1\">// taken from libdexfile/dex/dex_instruction.cc</span>\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInstructionNames</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"cp\">#define INSTRUCTION_NAME(o, c, pname, f, i, a, e, v) pname,</span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&quot;dex_instruction_list.h&quot;</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"w\">  </span><span class=\"n\">DEX_INSTRUCTION_LIST</span><span class=\"p\">(</span><span class=\"n\">INSTRUCTION_NAME</span><span class=\"p\">)</span>\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"cp\">#undef DEX_INSTRUCTION_LIST</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"cp\">#undef INSTRUCTION_NAME</span>\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u8fd9\u6bb5\u4ee3\u7801\u7ecf\u8fc7 C \u9884\u5904\u7406\u5668\uff0c\u9996\u5148\u4f1a\u88ab\u5c55\u5f00\u4e3a\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInstructionNames</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"cp\">#define INSTRUCTION_NAME(o, c, pname, f, i, a, e, v) pname,</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"w\">  </span><span class=\"n\">INSTRUCTION_NAME</span><span class=\"p\">(</span><span class=\"mh\">0x00</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NOP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;nop&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">k10x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kIndexNone</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kContinue</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kVerifyNothing</span><span class=\"p\">)</span><span class=\"w\"> </span>\\\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"w\">  </span><span class=\"n\">INSTRUCTION_NAME</span><span class=\"p\">(</span><span class=\"mh\">0x01</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">MOVE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;move&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">k12x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kIndexNone</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kContinue</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kVerifyRegA</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">kVerifyRegB</span><span class=\"p\">)</span><span class=\"w\"> </span>\\\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"w\">  </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a><span class=\"cp\">#undef INSTRUCTION_NAME</span>\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u7ee7\u7eed\u5c55\u5f00\uff0c\u5c31\u5f97\u5230\u4e86\u60f3\u8981\u7559\u4e0b\u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInstructionNames</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a><span class=\"w\">  </span><span class=\"s\">&quot;nop&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a><span class=\"w\">  </span><span class=\"s\">&quot;move&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">  </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u56de\u5230 switch-case \u7684\u5730\u65b9\uff0c\u53ef\u4ee5\u9884\u89c1\u5230\uff0c\u9884\u5904\u7406\u4f1a\u751f\u6210\u7684\u4ee3\u7801\u5927\u6982\u662f\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Opcode</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a><span class=\"w\">  </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">                                                                            </span>\\\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"w\">    </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">RelativeAt</span><span class=\"p\">(</span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">SizeInCodeUnits</span><span class=\"p\">(</span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">k10x</span><span class=\"p\">));</span><span class=\"w\">             </span>\\\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"w\">    </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">OP_NOP</span><span class=\"o\">&lt;</span><span class=\"n\">transaction_active</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"w\">                                                 </span>\\\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">        </span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">instrumentation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shadow_frame</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dex_pc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"p\">);</span><span class=\"w\">   </span>\\\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">LIKELY</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">interpret_one_instruction</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">                                  </span>\\\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">      </span><span class=\"k\">continue</span><span class=\"p\">;</span><span class=\"w\">                                                                           </span>\\\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\">                                                                                     </span>\\\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">    </span><span class=\"k\">break</span><span class=\"p\">;</span><span class=\"w\">                                                                                </span>\\\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a><span class=\"w\">  </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>next = inst-&gt;RelativeAt(Instruction::SizeInCodeUnits(Instruction::k10x));</code> \u8bed\u53e5\u6839\u636e\u5f53\u524d Op \u7c7b\u578b\u8ba1\u7b97\u51fa\u5b83\u4f1a\u5360\u7528\u591a\u5c11\u4e2a\u5b57\u8282\uff0c\u4ece\u800c\u5f97\u5230\u4e0b\u4e00\u4e2a Op \u7684\u5730\u5740\u3002\u4e4b\u540e\u5c31\u662f\u8c03\u7528 <code>OP_NOP</code> \u51fd\u6570\u6765\u8fdb\u884c\u5b9e\u9645\u7684\u64cd\u4f5c\u4e86\u3002\u5f53\u7136\u4e86\uff0c\u8fd9\u4e2a\u5b9e\u9645\u7684\u64cd\u4f5c\uff0c\u8fd8\u662f\u9700\u8981\u5f00\u53d1\u8005\u53bb\u624b\u52a8\u5b9e\u73b0\uff08<code>OP_NOP</code> \u51fd\u6570\u4f1a\u8c03\u7528\u4e0b\u9762\u7684 <code>NOP</code> \u51fd\u6570\uff09\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a><span class=\"n\">HANDLER_ATTRIBUTES</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">NOP</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-12-2\"><a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\" href=\"#__codelineno-12-2\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-3\"><a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\" href=\"#__codelineno-12-3\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-12-4\"><a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\" href=\"#__codelineno-12-4\"></a>\n</span><span id=\"__span-12-5\"><a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\" href=\"#__codelineno-12-5\"></a><span class=\"n\">HANDLER_ATTRIBUTES</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">MOVE</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-12-6\"><a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\" href=\"#__codelineno-12-6\"></a><span class=\"w\">  </span><span class=\"n\">SetVReg</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">GetVReg</span><span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">()));</span>\n</span><span id=\"__span-12-7\"><a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\" href=\"#__codelineno-12-7\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-8\"><a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\" href=\"#__codelineno-12-8\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-12-9\"><a id=\"__codelineno-12-9\" name=\"__codelineno-12-9\" href=\"#__codelineno-12-9\"></a>\n</span><span id=\"__span-12-10\"><a id=\"__codelineno-12-10\" name=\"__codelineno-12-10\" href=\"#__codelineno-12-10\"></a><span class=\"n\">HANDLER_ATTRIBUTES</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">ADD_INT</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-12-11\"><a id=\"__codelineno-12-11\" name=\"__codelineno-12-11\" href=\"#__codelineno-12-11\"></a><span class=\"w\">  </span><span class=\"n\">SetVReg</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">SafeAdd</span><span class=\"p\">(</span><span class=\"n\">GetVReg</span><span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">()),</span><span class=\"w\"> </span><span class=\"n\">GetVReg</span><span class=\"p\">(</span><span class=\"n\">C</span><span class=\"p\">())));</span>\n</span><span id=\"__span-12-12\"><a id=\"__codelineno-12-12\" name=\"__codelineno-12-12\" href=\"#__codelineno-12-12\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-13\"><a id=\"__codelineno-12-13\" name=\"__codelineno-12-13\" href=\"#__codelineno-12-13\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<h3 id=\"\u57fa\u4e8e-token-threading-\u7684\u89e3\u91ca\u5668-mterp-nterp\">\u57fa\u4e8e token threading \u7684\u89e3\u91ca\u5668 mterp (nterp)<a class=\"headerlink\" href=\"#\u57fa\u4e8e-token-threading-\u7684\u89e3\u91ca\u5668-mterp-nterp\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7b2c\u4e8c\u4e2a\u89e3\u91ca\u5668\u5219\u662f\u57fa\u4e8e token threading \u7684\u89e3\u91ca\u5668\uff0c\u5b83\u7684\u6e90\u7801\u5728 <code>runtime/interpreter/mterp</code> \u76ee\u5f55\u4e0b\u3002\u7531\u4e8e\u8fd9\u4e9b\u4ee3\u7801\u662f\u7528\u6c47\u7f16\u5199\u7684\uff0c\u76f4\u63a5\u5199\u4f1a\u6709\u5f88\u591a\u91cd\u590d\u7684\u90e8\u5206\u3002\u4e3a\u4e86\u907f\u514d\u91cd\u590d\u7684\u4ee3\u7801\uff0c\u76ee\u524d\u7684\u89e3\u91ca\u5668 mterp (\u73b0\u5728\u53eb nterp) \u7528 Python \u811a\u672c\u6765\u751f\u6210\u6700\u7ec8\u7684\u6c47\u7f16\u4ee3\u7801\u3002\u8981\u751f\u6210\u5b83\uff0c\u4e5f\u5f88\u7b80\u5355\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>runtime/interpreter/mterp\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a>./gen_mterp.py<span class=\"w\"> </span>mterp_arm64ng.S<span class=\"w\"> </span>arm64ng/*.S\n</span></code></pre></div>\n<p>\u8fd9\u4e2a\u811a\u672c\u662f\u5e73\u53f0\u65e0\u5173\u7684\uff0c\u4f8b\u5982\u5982\u679c\u8981\u751f\u6210 amd64 \u5e73\u53f0\u7684\u6c47\u7f16\uff0c\u53ea\u9700\u8981\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>runtime/interpreter/mterp\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a>./gen_mterp.py<span class=\"w\"> </span>mterp_x86_64ng.S<span class=\"w\"> </span>x86_64ng/*.S\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u770b\u5230\u5b8c\u6574\u7684\u6c47\u7f16\u4ee3\u7801\u4e86\uff0c\u540e\u7eed\u7684\u5206\u6790\u90fd\u4f1a\u57fa\u4e8e\u8fd9\u4efd\u6c47\u7f16\u4ee3\u7801\u3002\u5982\u679c\u8bfb\u8005\u5bf9 amd64 \u6c47\u7f16\u6bd4\u8f83\u719f\u6089\uff0c\u4e5f\u53ef\u4ee5\u5728\u672c\u5730\u751f\u6210\u4e00\u4efd amd64 \u7684\u6c47\u7f16\u518d\u7ed3\u5408\u672c\u6587\u8fdb\u884c\u7406\u89e3\u3002</p>\n<p>\u4e0a\u9762\u63d0\u5230\u8fc7 <code>add-int/2addr vA, vB</code> \u8fd9\u4e2a\u505a\u6574\u6570\u52a0\u6cd5\u7684 Op\uff0c\u76f4\u63a5\u5728\u751f\u6210\u7684\u6c47\u7f16\u4e2d\uff0c\u627e\u5230\u5b83\u5bf9\u5e94\u7684\u4ee3\u7801\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"w\">    </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"no\">NTERP_HANDLER_SIZE</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a><span class=\"nl\">.L_op_add_int_2addr:</span><span class=\"w\"> </span><span class=\"cm\">/* 0xb0 */</span>\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* binop/2addr vA, vB */</span>\n</span><span id=\"__span-15-5\"><a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\" href=\"#__codelineno-15-5\"></a><span class=\"w\">    </span><span class=\"nf\">lsr</span><span class=\"w\">     </span><span class=\"no\">w3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">wINST</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#12</span><span class=\"w\">              </span><span class=\"c1\">// w3&lt;- B</span>\n</span><span id=\"__span-15-6\"><a id=\"__codelineno-15-6\" name=\"__codelineno-15-6\" href=\"#__codelineno-15-6\"></a><span class=\"w\">    </span><span class=\"nf\">ubfx</span><span class=\"w\">    </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">wINST</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#4</span><span class=\"w\">           </span><span class=\"c1\">// w9&lt;- A</span>\n</span><span id=\"__span-15-7\"><a id=\"__codelineno-15-7\" name=\"__codelineno-15-7\" href=\"#__codelineno-15-7\"></a><span class=\"w\">    </span><span class=\"nf\">GET_VREG</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w3</span><span class=\"w\">                     </span><span class=\"c1\">// w1&lt;- vB</span>\n</span><span id=\"__span-15-8\"><a id=\"__codelineno-15-8\" name=\"__codelineno-15-8\" href=\"#__codelineno-15-8\"></a><span class=\"w\">    </span><span class=\"nf\">GET_VREG</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"w\">                     </span><span class=\"c1\">// w0&lt;- vA</span>\n</span><span id=\"__span-15-9\"><a id=\"__codelineno-15-9\" name=\"__codelineno-15-9\" href=\"#__codelineno-15-9\"></a><span class=\"w\">    </span><span class=\"nf\">FETCH_ADVANCE_INST</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">                </span><span class=\"c1\">// advance rPC, load rINST</span>\n</span><span id=\"__span-15-10\"><a id=\"__codelineno-15-10\" name=\"__codelineno-15-10\" href=\"#__codelineno-15-10\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\">     </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"w\">                  </span><span class=\"c1\">// w0&lt;- op, w0-w3 changed</span>\n</span><span id=\"__span-15-11\"><a id=\"__codelineno-15-11\" name=\"__codelineno-15-11\" href=\"#__codelineno-15-11\"></a><span class=\"w\">    </span><span class=\"nf\">GET_INST_OPCODE</span><span class=\"w\"> </span><span class=\"no\">ip</span><span class=\"w\">                  </span><span class=\"c1\">// extract opcode from rINST</span>\n</span><span id=\"__span-15-12\"><a id=\"__codelineno-15-12\" name=\"__codelineno-15-12\" href=\"#__codelineno-15-12\"></a><span class=\"w\">    </span><span class=\"nf\">SET_VREG</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"w\">                     </span><span class=\"c1\">// vAA&lt;- w0</span>\n</span><span id=\"__span-15-13\"><a id=\"__codelineno-15-13\" name=\"__codelineno-15-13\" href=\"#__codelineno-15-13\"></a><span class=\"w\">    </span><span class=\"nf\">GOTO_OPCODE</span><span class=\"w\"> </span><span class=\"no\">ip</span><span class=\"w\">                      </span><span class=\"c1\">// jump to next instruction</span>\n</span><span id=\"__span-15-14\"><a id=\"__codelineno-15-14\" name=\"__codelineno-15-14\" href=\"#__codelineno-15-14\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>wINST</code> \u8868\u793a\u5f53\u524d Op \u7684\u524d\u4e24\u4e2a\u5b57\u8282\u7684\u5185\u5bb9\uff0c\u524d\u9762\u63d0\u5230\uff0c<code>add-int/2addr vA, vB</code> \u7f16\u7801\u4e3a\u4e24\u4e2a\u5b57\u8282\uff0c\u7b2c\u4e00\u4e2a\u5b57\u8282\u662f\u56fa\u5b9a\u7684 <code>0xb0</code>\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5171 8 \u4f4d\uff0c\u4f4e 4 \u4f4d\u7f16\u7801\u4e86 <code>vA</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>A</code>\uff0c\u9ad8 4 \u4f4d\u7f16\u7801\u4e86 <code>vB</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>B</code>\u3002\u7531\u4e8e\u8fd9\u662f\u5c0f\u7aef\u5e8f\u7684\u5904\u7406\u5668\uff0c\u90a3\u4e48\u89e3\u91ca\u4e3a 16 \u4f4d\u6574\u6570\uff0c\u4ece\u9ad8\u4f4d\u5230\u4f4e\u4f4d\u4f9d\u6b21\u662f\uff1a4 \u4f4d\u7684 <code>B</code>\uff0c4 \u4f4d\u7684 <code>A</code> \u548c 8 \u4f4d\u7684 <code>0xb0</code>\u3002\u77e5\u9053\u8fd9\u4e2a\u80cc\u666f\u4ee5\u540e\uff0c\u518d\u6765\u5206\u6790\u6bcf\u6761\u6307\u4ee4\u505a\u7684\u4e8b\u60c5\uff0c\u5c31\u5f88\u6e05\u6670\uff1a</p>\n<ol>\n<li><code>lsr w3, wINST, #12</code>\uff1a\u6c42 <code>wINST</code> \u53f3\u79fb\u52a8 12 \u4f4d\uff0c\u5f97\u5230\u4e86 <code>B</code></li>\n<li><code>ubfx w9, wINST, #8, #4</code>: <code>ubfx</code> \u662f Bit Extract \u6307\u4ee4\uff0c\u8fd9\u91cc\u7684\u610f\u601d\u662f\u4ece <code>wINST</code> \u7b2c 8 \u4f4d\u5f00\u59cb\u53d6 4 \u4f4d\u6570\u636e\u51fa\u6765\uff0c\u4e5f\u5c31\u662f <code>A</code></li>\n<li><code>GET_VREG w1, w3</code>: \u8bfb\u53d6\u5bc4\u5b58\u5668\u7f16\u53f7\u4e3a <code>w3</code> \u7684\u503c\uff0c\u5199\u5230 <code>w1</code> \u5f53\u4e2d\uff0c\u7ed3\u5408\u7b2c\u4e00\u6761\u6307\u4ee4\uff0c\u53ef\u77e5\u6b64\u65f6 <code>w1</code> \u7b49\u4e8e <code>B</code> \u5bc4\u5b58\u5668\u7684\u503c</li>\n<li><code>GET_VREG w0, w9</code>: \u8bfb\u53d6\u5bc4\u5b58\u5668\u7f16\u53f7\u4e3a <code>w9</code> \u7684\u503c\uff0c\u5199\u5230 <code>w0</code> \u5f53\u4e2d\uff0c\u7ed3\u5408\u7b2c\u4e8c\u6761\u6307\u4ee4\uff0c\u53ef\u77e5\u6b64\u65f6 <code>w0</code> \u7b49\u4e8e <code>A</code> \u5bc4\u5b58\u5668\u7684\u503c</li>\n<li><code>FETCH_ADVANCE_INST 1</code>: \u628a \"PC\" \u5f80\u524d\u79fb\u52a8 1 \u4e2a\u5355\u4f4d\u7684\u8ddd\u79bb\uff0c\u4e5f\u5c31\u662f\u4e24\u4e2a\u5b57\u8282\uff0c\u5e76\u8bfb\u53d6\u4e0b\u4e00\u4e2a Op \u5230 <code>rINST</code> \u5f53\u4e2d</li>\n<li><code>add w0, w0, w1</code>: \u8fdb\u884c\u5b9e\u9645\u7684\u6574\u6570\u52a0\u6cd5\u8fd0\u7b97\uff0c\u7ed3\u679c\u4fdd\u5b58\u5728 <code>w0</code> \u5f53\u4e2d</li>\n<li><code>GET_INST_OPCODE ip</code>: \u6839\u636e\u7b2c\u4e94\u6761\u6307\u4ee4\u8bfb\u53d6\u7684\u4e0b\u4e00\u4e2a Op \u7684\u503c <code>rINST</code>\uff0c\u89e3\u6790\u51fa\u5b83\u7684 Opcode</li>\n<li><code>SET_VREG w0, w9</code>: \u628a\u6574\u6570\u52a0\u6cd5\u7684\u7ed3\u679c\u5199\u56de\u5230\u5bc4\u5b58\u5668\u7f16\u53f7\u4e3a <code>w9</code> \u7684\u5bc4\u5b58\u5668\u5f53\u4e2d\uff0c\u7ed3\u5408\u7b2c\u4e8c\u6761\u6307\u4ee4\uff0c\u53ef\u77e5\u5199\u5165\u7684\u662f <code>A</code> \u5bc4\u5b58\u5668</li>\n<li><code>GOTO_OPCODE ip</code>: \u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a Op \u5bf9\u5e94\u7684 handler</li>\n</ol>\n<p>\u6574\u4f53\u4ee3\u7801\u8fd8\u662f\u6bd4\u8f83\u6e05\u6670\u7684\uff0c\u53ea\u662f\u8bf4\u628a\u8ba1\u7b97 <code>A + B</code> \u5199\u5165 <code>A</code> \u7684\u8fc7\u7a0b\u548c\u8bfb\u53d6\u4e0b\u4e00\u4e2a Op \u5e76\u8df3\u8f6c\u7684\u903b\u8f91\u7a7f\u63d2\u4e86\u8d77\u6765\uff0c\u624b\u52a8\u505a\u4e86\u4e00\u6b21\u5bc4\u5b58\u5668\u8c03\u5ea6\u3002\u90a3\u4e48\u8fd9\u4e9b <code>GET_REG</code> \u548c <code>FETCH_ADVANCE_INST</code> \u7b49\u7b49\u5177\u4f53\u53c8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f\u4e0b\u9762\u628a\u5b8f\u5c55\u5f00\u540e\u7684\u4ee3\u7801\u8d34\u51fa\u6765\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-16-1\"><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\" href=\"#__codelineno-16-1\"></a><span class=\"w\">    </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"no\">NTERP_HANDLER_SIZE</span>\n</span><span id=\"__span-16-2\"><a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\" href=\"#__codelineno-16-2\"></a><span class=\"nl\">.L_op_add_int_2addr:</span><span class=\"w\"> </span><span class=\"cm\">/* 0xb0 */</span>\n</span><span id=\"__span-16-3\"><a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\" href=\"#__codelineno-16-3\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-16-4\"><a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\" href=\"#__codelineno-16-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* binop/2addr vA, vB */</span>\n</span><span id=\"__span-16-5\"><a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\" href=\"#__codelineno-16-5\"></a>\n</span><span id=\"__span-16-6\"><a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\" href=\"#__codelineno-16-6\"></a><span class=\"w\">    </span><span class=\"c1\">// wINST is w23, the first 16-bit code unit of current instruction</span>\n</span><span id=\"__span-16-7\"><a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\" href=\"#__codelineno-16-7\"></a><span class=\"w\">    </span><span class=\"c1\">// lsr     w3, wINST, #12              // w3&lt;- B</span>\n</span><span id=\"__span-16-8\"><a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\" href=\"#__codelineno-16-8\"></a><span class=\"w\">    </span><span class=\"nf\">lsr</span><span class=\"w\"> </span><span class=\"no\">w3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#12</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-9\"><a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\" href=\"#__codelineno-16-9\"></a><span class=\"w\">    </span><span class=\"c1\">// ubfx    w9, wINST, #8, #4           // w9&lt;- A</span>\n</span><span id=\"__span-16-10\"><a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\" href=\"#__codelineno-16-10\"></a><span class=\"w\">    </span><span class=\"nf\">ubfx</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#4</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-11\"><a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\" href=\"#__codelineno-16-11\"></a>\n</span><span id=\"__span-16-12\"><a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\" href=\"#__codelineno-16-12\"></a><span class=\"w\">    </span><span class=\"c1\">// virtual registers are stored relative to xFP(x29), the interpreted frame pointer, used for accessing locals and args</span>\n</span><span id=\"__span-16-13\"><a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\" href=\"#__codelineno-16-13\"></a><span class=\"w\">    </span><span class=\"c1\">// GET_VREG w1, w3                     // w1&lt;- vB</span>\n</span><span id=\"__span-16-14\"><a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\" href=\"#__codelineno-16-14\"></a><span class=\"w\">    </span><span class=\"nf\">ldr</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-15\"><a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\" href=\"#__codelineno-16-15\"></a><span class=\"w\">    </span><span class=\"c1\">// GET_VREG w0, w9                     // w0&lt;- vA</span>\n</span><span id=\"__span-16-16\"><a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\" href=\"#__codelineno-16-16\"></a><span class=\"w\">    </span><span class=\"nf\">ldr</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-17\"><a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\" href=\"#__codelineno-16-17\"></a>\n</span><span id=\"__span-16-18\"><a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\" href=\"#__codelineno-16-18\"></a><span class=\"w\">    </span><span class=\"c1\">// xPC(x22) is the interpreted program counter, used for fetching instructions</span>\n</span><span id=\"__span-16-19\"><a id=\"__codelineno-16-19\" name=\"__codelineno-16-19\" href=\"#__codelineno-16-19\"></a><span class=\"w\">    </span><span class=\"c1\">// FETCH_ADVANCE_INST 1                // advance rPC, load rINST</span>\n</span><span id=\"__span-16-20\"><a id=\"__codelineno-16-20\" name=\"__codelineno-16-20\" href=\"#__codelineno-16-20\"></a><span class=\"w\">    </span><span class=\"c1\">// a pre-index load instruction that both reads wINST from memory and increments xPC(x22) by 2</span>\n</span><span id=\"__span-16-21\"><a id=\"__codelineno-16-21\" name=\"__codelineno-16-21\" href=\"#__codelineno-16-21\"></a><span class=\"w\">    </span><span class=\"nf\">ldrh</span><span class=\"w\"> </span><span class=\"no\">w23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x22</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]!</span>\n</span><span id=\"__span-16-22\"><a id=\"__codelineno-16-22\" name=\"__codelineno-16-22\" href=\"#__codelineno-16-22\"></a>\n</span><span id=\"__span-16-23\"><a id=\"__codelineno-16-23\" name=\"__codelineno-16-23\" href=\"#__codelineno-16-23\"></a><span class=\"w\">    </span><span class=\"c1\">// add     w0, w0, w1                  // w0&lt;- op, w0-w3 changed</span>\n</span><span id=\"__span-16-24\"><a id=\"__codelineno-16-24\" name=\"__codelineno-16-24\" href=\"#__codelineno-16-24\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-25\"><a id=\"__codelineno-16-25\" name=\"__codelineno-16-25\" href=\"#__codelineno-16-25\"></a>\n</span><span id=\"__span-16-26\"><a id=\"__codelineno-16-26\" name=\"__codelineno-16-26\" href=\"#__codelineno-16-26\"></a><span class=\"w\">    </span><span class=\"c1\">// ip(x16) is a scratch register, used to store the first byte (opcode) of wINST</span>\n</span><span id=\"__span-16-27\"><a id=\"__codelineno-16-27\" name=\"__codelineno-16-27\" href=\"#__codelineno-16-27\"></a><span class=\"w\">    </span><span class=\"c1\">// GET_INST_OPCODE ip                  // extract opcode from rINST</span>\n</span><span id=\"__span-16-28\"><a id=\"__codelineno-16-28\" name=\"__codelineno-16-28\" href=\"#__codelineno-16-28\"></a><span class=\"w\">    </span><span class=\"nf\">and</span><span class=\"w\"> </span><span class=\"no\">x16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0xff</span>\n</span><span id=\"__span-16-29\"><a id=\"__codelineno-16-29\" name=\"__codelineno-16-29\" href=\"#__codelineno-16-29\"></a>\n</span><span id=\"__span-16-30\"><a id=\"__codelineno-16-30\" name=\"__codelineno-16-30\" href=\"#__codelineno-16-30\"></a><span class=\"w\">    </span><span class=\"c1\">// save addition result to virtual register, which is relative to xFP(x29)</span>\n</span><span id=\"__span-16-31\"><a id=\"__codelineno-16-31\" name=\"__codelineno-16-31\" href=\"#__codelineno-16-31\"></a><span class=\"w\">    </span><span class=\"c1\">// also set its object references to zero, which is relative to xREFS(x25)</span>\n</span><span id=\"__span-16-32\"><a id=\"__codelineno-16-32\" name=\"__codelineno-16-32\" href=\"#__codelineno-16-32\"></a><span class=\"w\">    </span><span class=\"c1\">// SET_VREG w0, w9                     // vAA&lt;- w0</span>\n</span><span id=\"__span-16-33\"><a id=\"__codelineno-16-33\" name=\"__codelineno-16-33\" href=\"#__codelineno-16-33\"></a><span class=\"w\">    </span><span class=\"nf\">str</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span>\n</span><span id=\"__span-16-34\"><a id=\"__codelineno-16-34\" name=\"__codelineno-16-34\" href=\"#__codelineno-16-34\"></a><span class=\"w\">    </span><span class=\"nf\">str</span><span class=\"w\"> </span><span class=\"no\">wzr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x25</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span>\n</span><span id=\"__span-16-35\"><a id=\"__codelineno-16-35\" name=\"__codelineno-16-35\" href=\"#__codelineno-16-35\"></a>\n</span><span id=\"__span-16-36\"><a id=\"__codelineno-16-36\" name=\"__codelineno-16-36\" href=\"#__codelineno-16-36\"></a><span class=\"w\">    </span><span class=\"c1\">// now x16 saves the opcode, and xIBASE(x24) interpreted instruction base pointer, used for computed goto</span>\n</span><span id=\"__span-16-37\"><a id=\"__codelineno-16-37\" name=\"__codelineno-16-37\" href=\"#__codelineno-16-37\"></a><span class=\"w\">    </span><span class=\"c1\">// for opcode #k, the handler address of it would be `xIBASE + k * 128`</span>\n</span><span id=\"__span-16-38\"><a id=\"__codelineno-16-38\" name=\"__codelineno-16-38\" href=\"#__codelineno-16-38\"></a><span class=\"w\">    </span><span class=\"c1\">// GOTO_OPCODE ip                      // jump to next instruction</span>\n</span><span id=\"__span-16-39\"><a id=\"__codelineno-16-39\" name=\"__codelineno-16-39\" href=\"#__codelineno-16-39\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">x16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">lsl</span><span class=\"w\"> </span><span class=\"mi\">#7</span>\n</span><span id=\"__span-16-40\"><a id=\"__codelineno-16-40\" name=\"__codelineno-16-40\" href=\"#__codelineno-16-40\"></a><span class=\"w\">    </span><span class=\"nf\">br</span><span class=\"w\"> </span><span class=\"no\">x16</span>\n</span><span id=\"__span-16-41\"><a id=\"__codelineno-16-41\" name=\"__codelineno-16-41\" href=\"#__codelineno-16-41\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span></code></pre></div>\n<p>\u5404\u4e2a\u5bc4\u5b58\u5668\u7684\u542b\u4e49\u5df2\u7ecf\u5728\u4e0a\u9762\u7684\u6ce8\u91ca\u4e2d\u5199\u51fa\uff0c\u6bd4\u5982 <code>w23</code> \u8bb0\u5f55\u4e86\u5f53\u524d Op \u7684\u524d 16 \u4f4d\u7684\u5185\u5bb9\uff0c<code>x29</code> \u8bb0\u5f55\u4e86\u5f53\u524d\u7684 frame pointer\uff0c\u901a\u8fc7\u5b83\u53ef\u4ee5\u8bbf\u95ee\u5404\u4e2a virtual register\uff1b<code>x11</code> \u662f PC\uff0c\u8bb0\u5f55\u4e86\u6b63\u5728\u6267\u884c\u7684 Op \u7684\u5730\u5740\uff1b<code>x24</code> \u8bb0\u5f55\u4e86\u8fd9\u4e9b op handler \u7684\u8d77\u59cb\u5730\u5740\uff0c\u7531\u4e8e\u6bcf\u4e2a handler \u90fd\u4e0d\u8d85\u8fc7 128 \u5b57\u8282\uff0c\u4e14\u90fd\u5bf9\u9f50\u5230 128 \u5b57\u8282\u8fb9\u754c\uff08<code>.balign NTERP_HANDLER_SIZE</code>\uff09\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u7b80\u5355\u7684\u8fd0\u7b97 <code>xIBASE + opcode * 128</code> \u5373\u53ef\u627e\u5230\u4e0b\u4e00\u4e2a op \u7684 handler \u5730\u5740\uff0c\u4e0d\u9700\u8981\u518d\u8fdb\u884c\u4e00\u6b21\u8bbf\u5b58\u3002</p>\n<p>\u5982\u679c\u8981\u6bd4\u8f83\u4e00\u4e0b Android Runtime \u7684 mterp (nterp) \u548c <a href=\"../../01/v8-ignition-internals/\">V8 \u7684 Ignition \u89e3\u91ca\u5668</a>\u7684\u5b9e\u73b0\uff0c\u6709\u5982\u4e0b\u51e0\u70b9\u76f8\u540c\u4e0e\u4e0d\u540c\uff1a</p>\n<ol>\n<li>\u4e24\u8005\u90fd\u91c7\u7528\u4e86 token threading \u7684\u65b9\u6cd5\uff0c\u5373\u5728\u4e00\u4e2a Op \u5904\u7406\u5b8c\u6210\u4ee5\u540e\uff0c\u8ba1\u7b97\u51fa\u4e0b\u4e00\u4e2a Op \u7684 handler \u7684\u5730\u5740\uff0c\u8df3\u8f6c\u8fc7\u53bb</li>\n<li>V8 \u7684 op handler \u662f\u52a8\u6001\u751f\u6210\u7684\uff08<code>mksnapshot</code> \u9636\u6bb5\uff09\uff0c\u957f\u5ea6\u6ca1\u6709\u9650\u5236\uff0c\u5141\u8bb8\u751f\u6210\u6bd4\u8f83\u590d\u6742\u7684\u6c47\u7f16\uff0c\u4f46\u5982\u679c\u6c47\u7f16\u6bd4\u8f83\u77ed\uff08\u6bd4\u5982 release \u6a21\u5f0f\u4e0b\uff09\uff0c\u4e5f\u53ef\u4ee5\u8282\u7701\u4e00\u4e9b\u5185\u5b58\uff1b\u4ee3\u4ef7\u662f\u9700\u8981\u4e00\u6b21\u989d\u5916\u7684\u5bf9 dispatch table \u7684\u8bbf\u5b58\uff0c\u6765\u627e\u5230 opcode \u5bf9\u5e94\u7684 handler</li>\n<li>mterp \u7684 op handler \u5bf9\u9f50\u5230 128B \u8fb9\u754c\uff0c\u5e26\u6765\u7684\u597d\u5904\u662f\u4e0d\u9700\u8981\u8bbf\u95ee dispatch table\uff0c\u76f4\u63a5\u6839\u636e opcode \u8ba1\u7b97\u5730\u5740\u5373\u53ef\uff0c\u4e0d\u8fc7\u7531\u4e8e\u5f88\u591a handler \u5f88\u77ed\uff0c\u53ef\u80fd\u53ea\u6709\u5341\u6761\u6307\u4ee4\u5de6\u53f3\uff0c\u5c31\u4f1a\u6d6a\u8d39\u4e86\u4e00\u4e9b\u5185\u5b58</li>\n<li>V8 \u6ca1\u6709 handler \u957f\u5ea6\u7684\u9650\u5236\uff0c\u6240\u4ee5\u9488\u5bf9\u4e00\u4e9b\u5e38\u89c1\u7684 Op \u505a\u4e86\u4f18\u5316\uff08Short Star\uff09\uff0c\u53ef\u4ee5\u51cf\u5c11\u4e00\u4e9b\u8df3\u8f6c\u7684\u5f00\u9500</li>\n<li>V8 \u5728\u533a\u5206 Smi(Small integer) \u548c\u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u505a\u6cd5\u662f\u5728 LSB \u4e0a\u6253\u6807\u8bb0\uff1a0 \u8868\u793a Smi\uff0c1 \u8868\u793a\u5bf9\u8c61\uff1bmterp \u5219\u4e0d\u540c\uff0c\u5b83\u7ed9\u6bcf\u4e2a\u865a\u62df\u5bc4\u5b58\u5668\u7ef4\u62a4\u4e86\u4e24\u4e2a 32 \u4f4d\u7684\u503c\uff1a\u4e00\u4e2a\u4fdd\u5b58\u5728 xFP \u6307\u5411\u7684\u6570\u7ec4\u5f53\u4e2d\uff0c\u8bb0\u5f55\u7684\u662f\u5b83\u7684\u5b9e\u9645\u7684\u503c\uff0c\u6bd4\u5982 int \u7684\u503c\uff0c\u6216\u8005\u5bf9\u8c61\u7684\u5f15\u7528\uff1b\u53e6\u4e00\u4e2a\u4fdd\u5b58\u5728 xREFS \u6307\u5411\u7684\u6570\u7ec4\u5f53\u4e2d\uff0c\u8bb0\u5f55\u7684\u662f\u5b83\u5f15\u7528\u7684\u5bf9\u8c61\uff0c\u5982\u679c\u4e0d\u662f\u5bf9\u8c61\uff0c\u5219\u8bb0\u5f55\u7684\u662f 0</li>\n</ol>\n<p>\u9664\u4e86\u4ee5\u4e0a\u5217\u4e3e\u7684\u4e0d\u540c\u7684\u5730\u65b9\u4ee5\u5916\uff0c\u5176\u5b9e\u6574\u4f53\u6765\u770b\u662f\u5341\u5206\u7c7b\u4f3c\u7684\uff0c\u4e0b\u9762\u662f\u4e8c\u8005\u5b9e\u73b0\u628a\u6574\u6570\u52a0\u8f7d\u5230\u5bc4\u5b58\u5668\uff08<code>const/4 vA, #+B</code> \u548c <code>LdaSmi</code>\uff09\u7684\u6c47\u7f16\u7684\u5bf9\u6bd4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>mterp (nterp)</th>\n<th>Ignition</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Extract Dest Register</td>\n<td><code>ubfx w0, w23, #8, #4</code></td>\n<td>N/A (destination is always the accumulator)</td>\n</tr>\n<tr>\n<td>Extract Const Integer</td>\n<td><code>sbfx w1, w23, #12, #4</code></td>\n<td><code>add x1, x19, #1; ldrsb w1, [x20, x1]</code></td>\n</tr>\n<tr>\n<td>Read Next Op</td>\n<td><code>ldrh w23, [x22, #2]!</code></td>\n<td><code>add x19, x19, #2; ldrb w3, [x20, x19]</code></td>\n</tr>\n<tr>\n<td>Save Result</td>\n<td><code>str w1, [x29, w0, uxtw #2]; str wzr, [x25, w0, uxtw #2]</code></td>\n<td><code>add w0, w1, w1</code></td>\n</tr>\n<tr>\n<td>Computed Goto</td>\n<td><code>and x16, x23, 0xff; add x16, x24, x16, lsl #7; br x16</code></td>\n<td><code>ldr x2, [x21, x3, lsl #3]; mov x17, x2; br x2</code></td>\n</tr>\n</tbody>\n</table>\n<p>\u5728\u5bc4\u5b58\u5668\u7684\u7ea6\u5b9a\u548c\u4f7f\u7528\u4e0a\u7684\u533a\u522b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Purpose</th>\n<th>mterp (nterp)</th>\n<th>Ignition</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Intepreter PC</td>\n<td>base + offset in <code>x22</code></td>\n<td>base in <code>x20</code>, offset in <code>x19</code></td>\n</tr>\n<tr>\n<td>Virtual Register</td>\n<td>relative to <code>x29</code></td>\n<td>relative to <code>fp</code></td>\n</tr>\n<tr>\n<td>Dispatch Table</td>\n<td>computed from <code>x24</code></td>\n<td>saved in <code>x21</code></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"lua-\u89e3\u91ca\u5668\">Lua \u89e3\u91ca\u5668<a class=\"headerlink\" href=\"#lua-\u89e3\u91ca\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>\u65e2\u7136\u5df2\u7ecf\u5206\u6790\u4e86 <a href=\"../../01/v8-ignition-internals/\">V8</a> \u548c Android Runtime \u7684\u89e3\u91ca\u5668\uff0c\u4e5f\u6765\u7b80\u5355\u770b\u4e00\u4e0b <a href=\"https://www.lua.org/\">Lua</a> \u7684\u89e3\u91ca\u5668\u5b9e\u73b0\u3002\u5b83\u5199\u7684\u975e\u5e38\u7b80\u5355\uff0c\u6838\u5fc3\u4ee3\u7801\u5c31\u5728 <code>lvm.c</code> \u5f53\u4e2d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-17-1\"><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\" href=\"#__codelineno-17-1\"></a><span class=\"n\">vmdispatch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">GET_OPCODE</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-2\"><a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\" href=\"#__codelineno-17-2\"></a><span class=\"w\">  </span><span class=\"n\">vmcase</span><span class=\"p\">(</span><span class=\"n\">OP_MOVE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-3\"><a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\" href=\"#__codelineno-17-3\"></a><span class=\"w\">    </span><span class=\"n\">StkId</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RA</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-4\"><a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\" href=\"#__codelineno-17-4\"></a><span class=\"w\">    </span><span class=\"n\">setobjs2s</span><span class=\"p\">(</span><span class=\"n\">L</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">RB</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span>\n</span><span id=\"__span-17-5\"><a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\" href=\"#__codelineno-17-5\"></a><span class=\"w\">    </span><span class=\"n\">vmbreak</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-6\"><a id=\"__codelineno-17-6\" name=\"__codelineno-17-6\" href=\"#__codelineno-17-6\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-17-7\"><a id=\"__codelineno-17-7\" name=\"__codelineno-17-7\" href=\"#__codelineno-17-7\"></a><span class=\"w\">  </span><span class=\"n\">vmcase</span><span class=\"p\">(</span><span class=\"n\">OP_LOADI</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-8\"><a id=\"__codelineno-17-8\" name=\"__codelineno-17-8\" href=\"#__codelineno-17-8\"></a><span class=\"w\">    </span><span class=\"n\">StkId</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RA</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-9\"><a id=\"__codelineno-17-9\" name=\"__codelineno-17-9\" href=\"#__codelineno-17-9\"></a><span class=\"w\">    </span><span class=\"n\">lua_Integer</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GETARG_sBx</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-10\"><a id=\"__codelineno-17-10\" name=\"__codelineno-17-10\" href=\"#__codelineno-17-10\"></a><span class=\"w\">    </span><span class=\"n\">setivalue</span><span class=\"p\">(</span><span class=\"n\">s2v</span><span class=\"p\">(</span><span class=\"n\">ra</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-11\"><a id=\"__codelineno-17-11\" name=\"__codelineno-17-11\" href=\"#__codelineno-17-11\"></a><span class=\"w\">    </span><span class=\"n\">vmbreak</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-12\"><a id=\"__codelineno-17-12\" name=\"__codelineno-17-12\" href=\"#__codelineno-17-12\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-17-13\"><a id=\"__codelineno-17-13\" name=\"__codelineno-17-13\" href=\"#__codelineno-17-13\"></a><span class=\"w\">  </span><span class=\"c1\">// ...</span>\n</span><span id=\"__span-17-14\"><a id=\"__codelineno-17-14\" name=\"__codelineno-17-14\" href=\"#__codelineno-17-14\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u628a <code>switch</code>\u3001<code>case</code> \u548c <code>break</code> \u66ff\u6362\u6210\u4e86\u4e09\u4e2a\u5b8f <code>vmdispatch</code>\u3001<code>vmcase</code> \u548c <code>vmbreak</code>\u3002\u63a5\u4e0b\u6765\u770b\u5b83\u53ef\u80fd\u7684\u5b9a\u4e49\uff0c\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\u7f16\u8bd1\u5668\u4e0d\u652f\u6301 <code>goto *</code> \u8bed\u6cd5\uff0c\u6b64\u65f6\u5c31\u76f4\u63a5\u5c55\u5f00\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-18-1\"><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\" href=\"#__codelineno-18-1\"></a><span class=\"cp\">#define vmdispatch(o) switch(o)</span>\n</span><span id=\"__span-18-2\"><a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\" href=\"#__codelineno-18-2\"></a><span class=\"cp\">#define vmcase(l) case l:</span>\n</span><span id=\"__span-18-3\"><a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\" href=\"#__codelineno-18-3\"></a><span class=\"cp\">#define vmbreak break</span>\n</span></code></pre></div>\n<p>\u5982\u679c\u7f16\u8bd1\u5668\u652f\u6301 <code>goto *</code> \u8bed\u6cd5\uff0c\u5219\u5c55\u5f00\u6210\u5bf9\u5e94\u7684 <code>computed goto</code> \u5f62\u5f0f\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-19-1\"><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\" href=\"#__codelineno-19-1\"></a><span class=\"cp\">#define vmdispatch(x) goto *disptab[x];</span>\n</span><span id=\"__span-19-2\"><a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\" href=\"#__codelineno-19-2\"></a><span class=\"cp\">#define vmcase(l) L_##l:</span>\n</span><span id=\"__span-19-3\"><a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\" href=\"#__codelineno-19-3\"></a><span class=\"cp\">#define vmbreak mfetch(); vmdispatch(GET_OPCODE(i));</span>\n</span><span id=\"__span-19-4\"><a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\" href=\"#__codelineno-19-4\"></a>\n</span><span id=\"__span-19-5\"><a id=\"__codelineno-19-5\" name=\"__codelineno-19-5\" href=\"#__codelineno-19-5\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">disptab</span><span class=\"p\">[</span><span class=\"n\">NUM_OPCODES</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-19-6\"><a id=\"__codelineno-19-6\" name=\"__codelineno-19-6\" href=\"#__codelineno-19-6\"></a><span class=\"w\">  </span><span class=\"o\">&amp;&amp;</span><span class=\"n\">L_OP_MOVE</span><span class=\"p\">,</span>\n</span><span id=\"__span-19-7\"><a id=\"__codelineno-19-7\" name=\"__codelineno-19-7\" href=\"#__codelineno-19-7\"></a><span class=\"w\">  </span><span class=\"o\">&amp;&amp;</span><span class=\"n\">L_OP_LOADI</span><span class=\"p\">,</span>\n</span><span id=\"__span-19-8\"><a id=\"__codelineno-19-8\" name=\"__codelineno-19-8\" href=\"#__codelineno-19-8\"></a><span class=\"w\">  </span><span class=\"c1\">// ...</span>\n</span><span id=\"__span-19-9\"><a id=\"__codelineno-19-9\" name=\"__codelineno-19-9\" href=\"#__codelineno-19-9\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u548c\u4e4b\u524d\u5199\u7684\u89e3\u91ca\u5668\u7684\u4e0d\u540c\u5b9e\u73b0\u65b9\u6cd5\u5bf9\u5e94\uff0c\u5c31\u4e0d\u591a\u9610\u8ff0\u4e86\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/22187630/what-does-mterp-mean\">What does mterp mean?</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/523692715\">Android 11 \u65b0\u5f15\u5165\u7684 Dalvik \u5b57\u8282\u7801\u89e3\u91ca\u5668 Nterp</a></li>\n</ul>", "image": "https://jia.je/assets/images/social/blog/posts/software/android-runtime-interpreter.png", "date_modified": "2025-03-06T00:00:00+00:00", "date_published": "2025-03-06T00:00:00+00:00", "authors": [], "tags": ["android", "art", "interpreter", "linux", "runtime", "software"]}]}