{"version": "https://jsonfeed.org/version/1", "title": "\u6770\u54e5\u7684{\u8fd0\u7ef4\uff0c\u7f16\u7a0b\uff0c\u8c03\u677f\u5b50}\u5c0f\u7b14\u8bb0", "home_page_url": "https://jia.je/", "feed_url": "https://jia.je/feed_json_updated.json", "description": "\u6770\u54e5\u7684{\u8fd0\u7ef4\uff0c\u7f16\u7a0b\uff0c\u8c03\u677f\u5b50}\u5c0f\u7b14\u8bb0", "icon": null, "authors": [], "language": "zh", "items": [{"id": "https://jia.je/software/2025/04/10/cbp-experiments/", "url": "https://jia.je/software/2025/04/10/cbp-experiments/", "title": "\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c", "content_html": "<h1 id=\"\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\">\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c<a class=\"headerlink\" href=\"#\u5982\u4f55\u8fdb\u884c\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u9488\u5bf9\u5404\u79cd\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff08Conditional Branch Predictor\uff09\u505a\u4e86\u5728\u5404\u79cd benchmark \u4e0a\u7684\u5b9e\u9a8c\uff0c\u5728\u6b64\u8bb0\u5f55\u4e00\u4e0b\u505a\u8fd9\u4e2a\u5b9e\u9a8c\u7684\u6d41\u7a0b\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u6d41\u7a0b\">\u6d41\u7a0b<a class=\"headerlink\" href=\"#\u6d41\u7a0b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8bf4\u5230\u505a\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\uff0c\u5230\u5e95\u662f\u505a\u4ec0\u4e48\u5462\uff1f\u5176\u5b9e\u5c31\u662f\u9488\u5bf9\u672a\u6765\u7684\u5904\u7406\u5668\u4e2d\u7684\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u8bbe\u8ba1\uff0c\u5728\u63d0\u524d\u51c6\u5907\u597d\u7684\u4e00\u4e9b benchmark \u4e0a\u8fdb\u884c\u6a21\u62df\uff0c\u89c2\u5bdf\u5b83\u7684\u9884\u6d4b\u51c6\u786e\u6027\u3002\u65e2\u7136\u662f\u672a\u6765\u7684\u5904\u7406\u5668\uff0c\u90a3\u4e48\u786c\u4ef6\u80af\u5b9a\u662f\u6ca1\u6709\u7684\uff0c\u5982\u679c\u76f4\u63a5\u7528 RTL \u53bb\u5b9e\u73b0\u65b0\u7684\u9884\u6d4b\u5668\uff0c\u518d\u7528 RTL \u4eff\u771f\uff0c\u7ed3\u679c\u56fa\u7136\u51c6\u786e\uff0c\u4f46\u8fd9\u8fd8\u662f\u592a\u590d\u6742\u5e76\u4e14\u592a\u6162\u4e86\u3002\u6240\u4ee5\u5728\u524d\u671f\u7684\u65f6\u5019\uff0c\u9996\u5148\u4f1a\u6784\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u5b9e\u9a8c\u73af\u5883\uff0c\u5728\u53ea\u8003\u8651\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u3001\u4e0d\u8003\u8651\u5176\u4ed6\u6307\u4ee4\u7684\u60c5\u51b5\u4e0b\uff0c\u5355\u7eaf\u6765\u89c2\u5bdf\u9884\u6d4b\u7684\u6548\u679c\uff0c\u4ece\u800c\u53ef\u4ee5\u5b9e\u73b0\u6bd4\u8f83\u5feb\u901f\u7684\u8bbe\u8ba1\u8fed\u4ee3\u3002</p>\n<p>\u4e3a\u4e86\u8fbe\u6210\u8fd9\u4e2a\u76ee\u7684\uff0c\u9700\u8981\uff1a</p>\n<ol>\n<li>\u63d0\u524d\u51c6\u5907\u597d\u4e00\u4e9b benchmark\uff0c\u63d0\u53d6\u51fa\u8fd9\u4e2a benchmark \u4e2d\u6240\u6d89\u53ca\u5230\u7684\u6761\u4ef6\u5206\u652f trace\uff0c\u4ee5\u53ca\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6240\u9700\u8981\u7684\u5176\u4ed6\u4fe1\u606f</li>\n<li>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u7f29\u77ed\u6a21\u62df\u7684\u65f6\u95f4\u548c trace \u7684\u5927\u5c0f\uff0c\u5229\u7528 SimPoint \u7b49\u6280\u672f\u6765\u51cf\u5c11\u8981\u6a21\u62df\u7684\u6307\u4ee4\u6761\u6570</li>\n<li>\u642d\u5efa\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\u5668\uff0c\u5728\u4e0a\u4e00\u6b65\u63d0\u53d6\u51fa\u6765\u7684 trace \u4e2d\u6a21\u62df\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u6267\u884c\uff0c\u4ece\u800c\u5f97\u5230\u7ed3\u679c</li>\n</ol>\n<p>\u4e0b\u9762\u6309\u7167\u8fd9\u4e2a\u987a\u5e8f\uff0c\u5206\u522b\u6765\u8ba8\u8bba\u4e00\u4e0b\u8fd9\u4e2a\u6d41\u7a0b\u3002</p>\n<h2 id=\"benchmark-\u51c6\u5907\">benchmark \u51c6\u5907<a class=\"headerlink\" href=\"#benchmark-\u51c6\u5907\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6bd4\u8f83\u5e38\u89c1\u7684 benchmark \u5c31\u662f SPEC INT 2017\uff0c\u5f53\u7136\u73b0\u5728\u5f88\u591a\u8bba\u6587\u4e5f\u4f1a\u81ea\u5df1\u53bb\u5bfb\u627e\u4e00\u4e9b\u5176\u4ed6\u7684 benchmark\uff0c\u4e0d\u540c\u7684 benchmark \u5b83\u7684\u7a0b\u5e8f\u7684\u7279\u6027\u4e5f\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u672a\u6765\u4e5f\u53ef\u80fd\u4f1a\u6709\u65b0\u7684 benchmark \u51fa\u6765\uff0c\u6240\u4ee5\u6709\u5fc5\u8981\u4e86\u89e3\u4ece benchmark \u5230 trace \u7684\u8fc7\u7a0b\u3002\u9009\u597d\u4e86 benchmark \u4ee5\u540e\uff0c\u6211\u4eec\u9700\u8981\u601d\u8003\u600e\u4e48\u53bb\u751f\u6210\u4e00\u4e2a trace\uff1a\u4e3a\u4e86\u51cf\u5c11\u540e\u7eed\u6a21\u62df\u7684\u8d1f\u62c5\uff0c\u6211\u4eec\u9700\u8981\u4ece benchmark \u4e2d\u63d0\u53d6\u6761\u4ef6\u5206\u652f\u7684\u6267\u884c\u5386\u53f2\uff0c\u4f5c\u4e3a groundtruth\uff0c\u5582\u7ed9\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u8fd9\u6837\u624d\u80fd\u77e5\u9053\u6bcf\u6b21\u9884\u6d4b\u662f\u5426\u51c6\u786e\u3002\u5f53\u7136\u4e86\uff0c\u7f51\u4e0a\u5df2\u7ecf\u6709\u5f88\u591a\u73b0\u6210\u7684 trace\uff0c\u6bd4\u5982 CBP Championship \u6bd4\u8d5b\u4e5f\u90fd\u6709\u63d0\u4f9b\u81ea\u5df1\u7684 benchmark trace\uff08P.S. 2025 \u5e74\u7684 CBP Championship \u6b63\u5728\u706b\u70ed\u8fdb\u884c\u4e2d\uff09\uff0c\u4f46\u8bfb\u5b8c\u672c\u6587\uff0c\u4f60\u5e94\u8be5\u53ef\u4ee5\u5c1d\u8bd5\u81ea\u5df1\u5b8c\u6210\u8fd9\u4e2a\u4ece benchmark \u5230 trace \u7684\u8fc7\u7a0b\u3002</p>\n<p>\u90a3\u4e48\u7b2c\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff0c\u600e\u4e48\u83b7\u53d6 benchmark \u4e2d\u5206\u652f\u6307\u4ee4\u6267\u884c\u7684\u4fe1\u606f\u5462\uff1f\u9996\u5148\u6765\u770b\u4e00\u7ec4\u6570\u636e\uff0c\u5728 amd64 \u4e0a\uff0c\u7528 <code>-O3</code> \u7f16\u8bd1 SPEC INT 2017 \u7684 benchmark\uff0c\u4e00\u5171 10 \u4e2a\u5b50 benchmark\uff0c\u52a0\u8d77\u6765\u8fd0\u884c\u7684\u6307\u4ee4\u6570\u5927\u7ea6\u662f 1.6e13 \u6761\uff0c\u5176\u4e2d\u6709\u5927\u7ea6 2.9e12 \u6761\u5206\u652f\u6307\u4ee4\uff08\u5305\u62ec\u4e86\u6709\u6761\u4ef6\u548c\u65e0\u6761\u4ef6\uff09\uff0c\u8fd9\u4e2a\u6570\u91cf\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u65e0\u8bba\u662f\u4fdd\u5b58\u8fd9\u4e9b\u6267\u884c\u4fe1\u606f\u7684\u6027\u80fd\u5f00\u9500\uff0c\u8fd8\u662f\u9700\u8981\u7684\u5b58\u50a8\u7a7a\u95f4\uff0c\u90fd\u662f\u6bd4\u8f83\u5de8\u5927\u7684\u3002</p>\n<p>\u8003\u8651\u5230\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u53ea\u9700\u8981\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u53ea\u8003\u8651 2.9e12 \u6761\u5206\u652f\u6307\u4ee4\u7684\u90e8\u5206\uff0c\u800c\u4e0d\u53bb\u8003\u8651\u5b8c\u6574\u7684 1.6e13 \u6761\u6307\u4ee4\uff0c\u9996\u5148\u53ef\u4ee5\u51cf\u5c11\u4e00\u4e2a\u6570\u91cf\u7ea7\u3002\u63a5\u7740\uff0c\u8003\u8651\u6bcf\u4e2a\u5206\u652f\u6307\u4ee4\u9700\u8981\u8bb0\u5f55\u54ea\u4e9b\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u77e5\u9053\u6bcf\u4e00\u6761\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\u3001\u6bcf\u4e00\u6761\u76f4\u63a5\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740</li>\n<li>\u5bf9\u4e8e\u6267\u884c\u7684\u6bcf\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u8981\u8bb0\u5f55\u5b83\u8df3\u8f6c\u4e0e\u5426</li>\n<li>\u5bf9\u4e8e\u6267\u884c\u7684\u6bcf\u4e00\u6761\u95f4\u63a5\u5206\u652f\u6307\u4ee4\uff0c\u9700\u8981\u8bb0\u5f55\u5b83\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740</li>\n</ol>\n<p>\u5176\u4e2d\u7b2c\u4e00\u70b9\uff0c\u7531\u4e8e\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u672c\u8eab\u662f\u4e0d\u53d8\u7684\uff08\u4e0d\u8003\u8651 JIT\uff09\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u5b58\u4e00\u4efd\u5c31\u884c\u3002\u800c SPEC INT 2017 \u6240\u6709\u7a0b\u5e8f\u7684\u5206\u652f\u6307\u4ee4\u52a0\u8d77\u6765\u5927\u6982\u53ea\u6709 5e4 \u7684\u91cf\u7ea7\uff0c\u76f8\u6bd4 2.9e12 \u7684\u6267\u884c\u7684\u5206\u652f\u6307\u4ee4\u6570\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\u3002\u7b2c\u4e09\u70b9\uff0c\u7531\u4e8e\u95f4\u63a5\u5206\u652f\u6307\u4ee4\u901a\u5e38\u4e5f\u662f\u6bd4\u8f83\u5c11\u7684\uff0c\u800c\u4e14\u540c\u4e00\u6761\u95f4\u63a5\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u901a\u5e38\u6765\u8bf4\u4e0d\u4f1a\u7279\u522b\u591a\uff0c\u4e5f\u6709\u538b\u7f29\u7684\u7a7a\u95f4\u3002\u90a3\u4e48\u6700\u4e3b\u8981\u7684\u7a7a\u95f4\u6765\u81ea\u4e8e\uff1a</p>\n<ol>\n<li>\u867d\u7136\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u6570\u91cf\u4e0d\u591a\uff0c\u4f46\u662f\u6267\u884c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u6b21\u6570\u5f88\u591a\uff0c\u6bcf\u4e00\u6b21\u6267\u884c\u7684\u53ef\u80fd\u662f\u4e0d\u540c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5982\u679c\u8981\u8bb0\u5f55\u5f53\u524d\u8fd9\u6b21\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48\u8fd9\u4e2a\u6307\u4ee4\u7684\u5730\u5740\u6216\u8005\u4e00\u4e2a id \u6240\u5360\u7528\u7684\u7a7a\u95f4\u4f1a\u5f88\u5927\uff1b\u5982\u679c\u4e0d\u8bb0\u5f55\u5f53\u524d\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u5206\u652f\u5206\u652f\u6307\u4ee4\uff0c\u5c31\u9700\u8981\u5728\u540e\u7eed\u5904\u7406\u7684\u65f6\u5019\uff0c\u7ed3\u5408\u53ef\u6267\u884c\u7a0b\u5e8f\u7684\u6c47\u7f16\u6765\u63a8\u65ad\uff0c\u5f53\u524d\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u6761\u4ef6\u5206\u652f\u6307\u4ee4</li>\n<li>\u5176\u6b21\u5c31\u662f\u8981\u8bb0\u5f55\u6761\u4ef6\u5206\u652f\u8df3\u8f6c\u4e0e\u5426\uff0c\u8fd9\u4e00\u4e2a\u7684\u5f00\u9500\u76f8\u5bf9\u4f1a\u5c0f\u4e00\u4e9b\uff0c\u53ea\u9700\u8981\u4e00\u4e2a bit</li>\n</ol>\n<p>\u7531\u6b64\u53ef\u4ee5\u63a8\u5bfc\u51fa\u4e0d\u540c\u7684 trace \u8bb0\u5f55\u65b9\u5f0f\uff1a</p>\n<p>\u7b2c\u4e00\u79cd\u65b9\u5f0f\u662f\uff0c\u9047\u5230\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u65f6\uff0c\u53ea\u8bb0\u5f55\u8df3\u8f6c\uff08Taken\uff09\u8fd8\u662f\u4e0d\u8df3\u8f6c\uff08Not Taken\uff09\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4fdd\u5b58\u7684\u6570\u636e\u91cf\u6700\u5c0f\uff08\u5e73\u5747\u6bcf\u4e2a\u5206\u652f\u53ea\u9700\u8981\u6bd4 1 bit \u7565\u591a\u7684\u7a7a\u95f4\uff09\uff0c\u4f46\u662f\u540e\u7eed\u9700\u8981\u7ed3\u5408\u6c47\u7f16\uff0c\u6062\u590d\u51fa\u6267\u884c\u7684\u8fc7\u7a0b\uff0c\u66f4\u8fdb\u4e00\u6b65\u8fd8\u53ef\u4ee5\u538b\u7f29\u90a3\u4e9b return \u7684\u76ee\u7684\u5730\u5740\u7b49\u4e8e\u5bf9\u5e94\u7684 call \u6307\u4ee4\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\u7684\u5730\u5740\u7684\u60c5\u51b5\uff08Indirect Transfer Compression for Returns\uff09\u3002Intel PT \u91c7\u7528\u7684\u662f\u8fd9\u79cd\u65b9\u6cd5\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u662f\uff0c\u9047\u5230\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u65f6\uff0c\u4e0d\u4ec5\u8bb0\u5f55\u8df3\u8f6c\u4e0e\u5426\uff0c\u8fd8\u8bb0\u5f55\u5b83\u6267\u884c\u7684\u662f\u54ea\u4e00\u6761\u5206\u652f\u6307\u4ee4\u3002\u8fd9\u79cd\u65b9\u5f0f\u4fdd\u5b58\u7684\u6570\u636e\u91cf\u7a0d\u591a\uff0c\u5047\u5982\u8981\u652f\u6301 5e4 \u6761\u4e0d\u540c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u4e3a\u4e86\u4fdd\u5b58\u8fd9\u4e2a id\uff0c\u5c31\u9700\u8981 16 \u4f4d\u3002\u7c7b\u4f3c\u5730\uff0c\u4e5f\u53ef\u4ee5\u53ea\u8bb0\u5f55\u8df3\u8f6c\u4e86\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48\u90a3\u4e9b\u6ca1\u6709\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5c31\u9700\u8981\u540e\u7eed\u7ed3\u5408\u6c47\u7f16\u6216\u8005\u5b8c\u6574\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u8868\u6765\u6062\u590d\u51fa\u6765\u3002CBP Championship \u7684 trace \u91c7\u7528\u7684\u662f\u8fd9\u79cd\u65b9\u6cd5\u3002</p>\n<p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u660e\u663e\u7a7a\u95f4\u4f1a\u66f4\u5c0f\uff0c\u4ee5 2.9e12 \u6761\u6267\u884c\u7684\u5206\u652f\u6307\u4ee4\u6570\uff0c\u5927\u6982\u9700\u8981 300GB \u7684\u78c1\u76d8\u7a7a\u95f4\uff1b\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff0c\u540c\u6837\u7684\u5206\u652f\u6307\u4ee4\u6570\uff0c\u5c31\u9700\u8981\u5927\u6982 5.8TB \u7684\u78c1\u76d8\u7a7a\u95f4\u3002\u5f53\u7136\u4e86\uff0c\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u5b58\u7684\u6570\u636e\u53ef\u4ee5\u7ecf\u8fc7\u65e0\u635f\u538b\u7f29\u8fdb\u4e00\u6b65\u7f29\u5c0f\u7a7a\u95f4\uff0c\u5b9e\u6d4b\u538b\u7f29\u540e\u5927\u6982\u662f\u6bcf\u5206\u652f 0.16 \u5b57\u8282\uff08\u8fd9\u4e2a\u6570\u5b57\u4e0e\u6240\u8dd1\u7684 benchmark \u6709\u5173\u7cfb\uff0c\u5206\u652f\u5bb9\u6613\u88ab\u9884\u6d4b\u7684 benchmark \u5bf9\u5e94\u66f4\u597d\u7684\u538b\u7f29\u7387\uff0c\u56e0\u4e3a\u67d0\u79cd\u610f\u4e49\u6765\u8bf4\u5206\u652f\u9884\u6d4b\u4e5f\u662f\u4e00\u79cd\u65e0\u635f\u538b\u7f29\uff09\uff0c\u53ea\u6bd4\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5927\u6982\u6bcf\u5206\u652f 0.14 \u5b57\u8282\u7565\u5927\u3002\u540c\u7406\uff0c\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5b58\u7684\u6570\u636e\u4e5f\u53ef\u4ee5\u7ecf\u8fc7\u65e0\u635f\u538b\u7f29\u8fdb\u4e00\u6b65\u7f29\u5c0f\u7a7a\u95f4\uff0c\u8fbe\u5230\u6bcf\u5206\u652f\u5927\u7ea6 0.018 \u5b57\u8282\u7684\u7a0b\u5ea6\uff08\u538b\u7f29\u7387\u4e5f\u548c\u5206\u652f\u9884\u6d4b\u51c6\u786e\u7387\u6709\u5173\uff09\u3002</p>\n<p>\u5728\u8bc4\u4f30\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u65f6\u5019\uff0c\u9664\u4e86\u77e5\u9053\u5206\u652f\u672c\u8eab\uff0c\u8fd8\u9700\u8981\u77e5\u9053\u6267\u884c\u7684\u6307\u4ee4\u6570\uff0c\u7528\u4e8e\u8ba1\u7b97 MPKI \u7b49\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u901a\u8fc7 PMU \u5355\u72ec\u7edf\u8ba1\u51fa\u6765\uff0c\u6216\u8005\u76f4\u63a5\u6839\u636e\u63a7\u5236\u6d41\u63a8\u7b97\u51fa\u6267\u884c\u7684\u6307\u4ee4\u6570\uff0c\u4f8b\u5982\u5728\u7b49\u957f\u6307\u4ee4\u7684 ISA \u4e0a\u76f4\u63a5\u7528\u5730\u5740\u5dee\u9664\u4ee5\u6307\u4ee4\u957f\u5ea6\u6765\u8ba1\u7b97\u6307\u4ee4\u6570\uff0c\u5728\u53d8\u957f\u6307\u4ee4\u7684 ISA \u4e0a Parse ELF \u53bb\u89e3\u6790\u63a7\u5236\u6d41\u7ecf\u8fc7\u7684\u6307\u4ee4\uff1a</p>\n<ol>\n<li>\u89e3\u6790 ELF\uff0c\u7528\u53cd\u6c47\u7f16\u5668\u5f97\u5230\u6bcf\u6761\u6307\u4ee4\u7684\u5730\u5740\uff0c\u4ece\u5c0f\u5230\u5927\u6392\u5e8f\u653e\u5230\u6570\u7ec4\u4e2d</li>\n<li>\u5bf9\u4e8e\u6bcf\u4e2a\u5206\u652f\u5730\u5740\u548c\u76ee\u7684\u5730\u5740\uff0c\u67e5\u8be2\u5b83\u5bf9\u5e94\u7684\u6307\u4ee4\u5728\u6307\u4ee4\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u8bb0\u5f55\u4e0b\u6765</li>\n<li>\u7edf\u8ba1\u6307\u4ee4\u6570\u65f6\uff0c\u6bcf\u9047\u5230\u4e00\u4e2a\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u5c31\u7528\u5f53\u524d\u8df3\u8f6c\u7684\u5206\u652f\u7684\u5206\u652f\u5730\u5740\u5728\u6307\u4ee4\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u51cf\u53bb\u4e0a\u4e00\u4e2a\u8df3\u8f6c\u7684\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u5728\u6307\u4ee4\u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u52a0\u4e0a\u4e00\uff0c\u7d2f\u52a0\u5230\u6307\u4ee4\u6570\u4e2d</li>\n</ol>\n<p>\u5f53\u7136\u4e86\uff0c\u8fd9\u91cc\u6709\u4e00\u4e9b\u7ec6\u8282\uff0c\u4f8b\u5982\u5982\u679c\u7a0b\u5e8f\u662f PIE\uff0c\u90a3\u4e48\u9700\u8981\u77e5\u9053\u5b83\u52a0\u8f7d\u7684\u57fa\u5730\u5740\uff0c\u4ece\u800c\u628a\u8fd0\u884c\u65f6\u7684\u6307\u4ee4\u5730\u5740\u548c ELF \u5bf9\u5e94\u8d77\u6765\uff1b\u7c7b\u4f3c\u5730\uff0c\u5982\u679c\u7a0b\u5e8f\u52a0\u8f7d\u4e86 libc \u7b49\u52a8\u6001\u5e93\uff0c\u4e5f\u9700\u8981\u77e5\u9053\u5b83\u4eec\u7684\u52a0\u8f7d\u5730\u5740\u3002\u8fd9\u4e9b\u4fe1\u606f\u53ef\u4ee5\u5728\u6293\u53d6\u6307\u4ee4 trace \u7684\u540c\u65f6\uff0c\u987a\u5e26\u8bb0\u5f55\u4e0b\u6765\u3002\u5982\u679c\u60f3\u89c4\u907f\u8fd9\u4e2a\u9ebb\u70e6\uff0c\u53ef\u4ee5\u4f7f\u7528\u9759\u6001\u7f16\u8bd1\uff0c\u4e0d\u8fc7 vdso \u4f9d\u7136\u4f1a\u52a8\u6001\u52a0\u8f7d\uff0c\u4f46 vdso \u5185\u6307\u4ee4\u5f88\u5c11\uff0c\u901a\u5e38\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\uff0c\u53ef\u4ee5\u7279\u5224\u5ffd\u7565\u6389\u3002</p>\n<p>\u6b64\u5916\uff0c\u5982\u679c\u5206\u652f\u9884\u6d4b\u5668\u9700\u8981\u77e5\u9053\u5206\u652f\u6307\u4ee4\u7684 fallthrough \u5730\u5740\uff08\u4f8b\u5982 Path History Register\uff09\uff0c\u4e14\u4f7f\u7528\u7684\u662f\u53d8\u957f\u6307\u4ee4\u96c6\uff0c\u8fd8\u9700\u8981\u8bb0\u5f55\u5206\u652f\u6307\u4ee4\u7684\u957f\u5ea6\u3002\u8fd9\u4e9b\u9700\u6c42\u5b9e\u73b0\u8d77\u6765\u90fd\u5e76\u4e0d\u590d\u6742\uff0c\u4e5f\u53ea\u9700\u8981\u5360\u7528\u5f88\u5c0f\u7684\u7a7a\u95f4\u3002</p>\n<p>TB \u7ea7\u522b\u7684\u89c4\u6a21\uff0c\u65e0\u8bba\u662f\u4fdd\u5b58\u8fd9\u4e9b\u6570\u636e\uff0c\u8fd8\u662f\u751f\u6210\u8fd9\u4e9b\u6570\u636e\uff0c\u6216\u8005\u66f4\u8fdb\u4e00\u6b65\u5728\u8fd9\u4e9b\u6570\u636e\u4e0a\u6a21\u62df\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u90fd\u4f1a\u5e26\u6765\u5f88\u5927\u7684\u8d1f\u62c5\u3002\u56e0\u6b64\uff0c\u9700\u8981\u4e00\u4e2a\u529e\u6cd5\u6765\u51cf\u5c11\u8981\u6a21\u62df\u7684 trace \u957f\u5ea6\u3002</p>\n<h2 id=\"simpoint\">SimPoint<a class=\"headerlink\" href=\"#simpoint\" title=\"Permanent link\">&para;</a></h2>\n<p><a href=\"https://cseweb.ucsd.edu/~calder/papers/ASPLOS-02-SimPoint.pdf\">SimPoint</a> \u662f\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u65b9\u6cd5\uff1a\u5b83\u89c2\u5bdf\u5230\u4e86\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u73b0\u8c61\uff0c\u5c31\u662f\u8fd9\u4e9b benchmark \u5176\u5b9e\u5927\u591a\u6570\u65f6\u5019\u662f\u5728\u91cd\u590d\u505a\u76f8\u540c\u7684\u4e8b\u60c5\uff0c\u53ea\u4e0d\u8fc7\u6d89\u53ca\u5230\u7684\u6570\u636e\u4e0d\u540c\u3002\u8fd9\u4e5f\u5f88\u597d\u7406\u89e3\uff0c\u56e0\u4e3a\u5f88\u591a\u7a0b\u5e8f\u91cc\u9762\u90fd\u662f\u5faa\u73af\uff0c\u800c\u5faa\u73af\u662f\u5f88\u6709\u89c4\u5f8b\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u9884\u671f\u7a0b\u5e8f\u7684\u884c\u4e3a\u5728\u65f6\u95f4\u5c3a\u5ea6\u4e0a\u4e5f\u4f1a\u6709\u4e00\u5b9a\u7684\u5468\u671f\u6027\u3002\u4e0b\u9762\u662f SimPoint \u8bba\u6587\u4e2d\u7684\u4e00\u4e2a\u56fe\uff0c\u5b83\u8bb0\u5f55\u4e86 gzip-graphic benchmark \u7684 IPC\uff08\u6bcf\u5468\u671f\u6307\u4ee4\u6570\uff0c\u56fe\u4e2d\u7684\u5b9e\u7ebf\uff09\u548c L1 \u6570\u636e\u7f13\u5b58\u7f3a\u5931\u7387\uff08\u56fe\u4e2d\u7684\u865a\u7ebf\uff09\u968f\u7740\u6267\u884c\u8fc7\u7a0b\u7684\u53d8\u5316\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u6bd4\u8f83\u660e\u663e\u7684\u5468\u671f\u6027\uff0c\u800c\u6d89\u53ca\u5230\u5468\u671f\u6027\uff0c\u5c31\u4f1a\u60f3\u5230\u5229\u7528\u5468\u671f\u7684\u6027\u8d28\uff1a\u5982\u679c\u5728\u4e00\u4e2a\u5468\u671f\u4e0a\u8bc4\u4f30\u5b83\u7684 IPC \u6216\u8005\u5206\u652f\u9884\u6d4b\u5668\u7684\u51c6\u786e\u7387\uff0c\u7136\u540e\u5916\u63a8\u5230\u5176\u4ed6\u7684\u5468\u671f\uff0c\u662f\u4e0d\u662f\u5927\u5927\u7f29\u5c0f\u4e86\u6267\u884c\u65f6\u95f4\uff1fSimPoint \u5229\u7528\u8fd9\u4e2a\u601d\u60f3\uff0c\u8bbe\u8ba1\u4e86\u5982\u4e0b\u7684\u6b65\u9aa4\uff1a</p>\n<ol>\n<li>\u9996\u5148\u628a\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u6309\u7167\u6267\u884c\u7684\u6307\u4ee4\u6570\u5207\u5206\u6210\u5f88\u591a\u4e2a slice</li>\n<li>\u63a5\u7740\u5bf9 slice \u8fdb\u884c\u805a\u7c7b\uff0c\u4f7f\u5f97\u6bcf\u4e00\u4e2a\u7c7b\u5185\u7684 slice \u7684\u884c\u4e3a\u7c7b\u4f3c\uff0c\u8fd9\u4e2a\u7c7b\u5c31\u53eb\u505a\u4e00\u4e2a phase</li>\n<li>\u4e4b\u540e\u505a\u5b9e\u9a8c\u7684\u65f6\u5019\uff0c\u53ea\u9700\u8981\u5bf9\u6bcf\u4e2a phase \u5185\u7684\u4e00\u4e2a slice \u8fdb\u884c\u5b9e\u9a8c\uff0c\u8bc4\u4f30\u51fa\u5b83\u7684 IPC \u6216\u8005\u5176\u4ed6\u6027\u80fd\u6307\u6807\uff0c\u518d\u6309\u7167 phase \u5185\u7684 slice \u6570\u91cf\u52a0\u6743\u5e73\u5747\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u5b8c\u6574\u6267\u884c\u8fc7\u7a0b\u7684\u6027\u80fd\u6307\u6807\u4e86</li>\n</ol>\n<p>\u8fd9\u91cc\u6bd4\u8f83\u6838\u5fc3\u7684\u6b65\u9aa4\uff0c\u5c31\u662f\u600e\u4e48\u5bf9 slice \u805a\u7c7b\uff1fSimPoint \u8bba\u6587\u91c7\u7528\u4e86\u673a\u5668\u5b66\u4e60\u7684\u65b9\u6cd5\uff1a\u9488\u5bf9\u6bcf\u4e2a slice\uff0c\u7edf\u8ba1\u5b83\u5728\u4e0d\u540c Basic Block \u5185\u6267\u884c\u7684\u65f6\u95f4\u7684\u6bd4\u4f8b\uff0c\u628a\u8fd9\u4e2a\u7edf\u8ba1\u6570\u636e\u8bb0\u4e3a Basic Block Vector\uff1b\u90a3\u4e48\u805a\u7c7b\uff0c\u5c31\u662f\u9488\u5bf9\u90a3\u4e9b Basic Block Vector \u76f8\u8fd1\u7684 Slice\uff0c\u8fdb\u884c K-Means \u7b97\u6cd5\u3002</p>\n<p>\u7531\u4e8e K-Means \u7b97\u6cd5\u6267\u884c\u7684\u65f6\u5019\uff0c\u9700\u8981\u9996\u5148\u77e5\u9053\u805a\u51fa\u6765\u591a\u5c11\u4e2a\u7c7b\uff0c\u6240\u4ee5 SimPoint \u679a\u4e3e\u4e86\u82e5\u5e72\u4e2a\u4e0d\u540c\u7684\u7c7b\u7684\u4e2a\u6570\uff0c\u5bf9\u6bcf\u4e2a K-Means \u805a\u7c7b\u7ed3\u679c\u8fdb\u884c\u6253\u5206\uff1aBIC\uff08Bayesian Information Criterion\uff09\uff0c\u6839\u636e\u6253\u5206\u627e\u5230\u4e00\u4e2a\u805a\u7c7b\u6548\u679c\u8db3\u591f\u597d\uff0c\u4f46\u662f\u7c7b\u53c8\u4e0d\u662f\u7279\u522b\u591a\u7684\u7ed3\u679c\u3002</p>\n<p>\u8fdb\u4e00\u6b65\u4e3a\u4e86\u63d0\u5347\u805a\u7c7b\u7684\u6027\u80fd\uff0cSimPoint \u8fd8\u8fdb\u884c\u4e86\u4e00\u6b21\u964d\u7ef4\u64cd\u4f5c\uff0c\u628a\u5f88\u957f\u7684 Basic Block Vector \u7ebf\u6027\u6620\u5c04\u5230\u4e00\u4e2a\u6bd4\u8f83\u5c0f\u7684 15 \u7ef4\u7684\u5411\u91cf\u4e0a\u3002</p>\n<p>SimPoint \u8bba\u6587\u4e2d\u5c55\u793a\u4e86\u805a\u7c7b\u7684\u6548\u679c\uff0c\u8fd8\u662f\u5f88\u53ef\u89c2\u7684\uff1a</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-2.png\" /></p>\n<p>\u5b8c\u6210\u805a\u7c7b\u4ee5\u540e\uff0cSimPoint \u7684\u8f93\u51fa\u5c31\u662f\u82e5\u5e72\u4e2a phase\uff0c\u6bcf\u4e00\u4e2a\u7c7b\u5bf9\u5e94\u4e00\u4e2a phase\uff0c\u6bcf\u4e2a phase \u5305\u62ec\uff1a</p>\n<ol>\n<li>\u6743\u91cd\uff1a\u6743\u91cd\u5c31\u662f\u8fd9\u4e2a\u7c7b\u4e2d slice \u7684\u4e2a\u6570</li>\n<li>\u4ee3\u8868\u8fd9\u4e2a phase \u7684\u4e00\u4e2a slice \u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u5b83\u662f\u4ece\u7b2c\u51e0\u6761\u6307\u4ee4\u5f00\u59cb\u5230\u7b2c\u51e0\u6761\u6307\u4ee4</li>\n</ol>\n<p>\u5b8c\u6210 SimPoint \u7b97\u6cd5\u540e\uff0c\u5f97\u5230\u7684 trace \u957f\u5ea6\u5927\u5927\u51cf\u5c0f\uff0c\u4f8b\u5982\u4e00\u6bb5\u539f\u59cb\u7684\u957f\u4e3a 1e10 \u6761\u6307\u4ee4\u7684 trace\uff0c\u4ee5 3e7 \u6761\u6307\u4ee4\u4e3a\u4e00\u4e2a slice\uff0c\u805a\u7c7b\u4ee5\u540e\uff0c\u53ea\u5269\u4e0b 10 \u4e2a phase\uff0c\u90a3\u4e48\u9700\u8981\u6a21\u62df\u548c\u4fdd\u5b58\u7684 trace \u957f\u5ea6\u53ea\u5269\u4e0b\u4e86 3e8 \u6761\u6307\u4ee4\u3002SimPoint \u805a\u7c7b\u6574\u4e2a\u6d41\u7a0b\u7684\u6027\u80fd\u5927\u6982\u5728\u6bcf\u79d2 2e8 \u6761\u5206\u652f\u6307\u4ee4\u7684\u91cf\u7ea7\u3002</p>\n<p>\u56de\u987e\u524d\u9762\u63d0\u5230\u7684\u5b8c\u6574\u7684 SPEC INT 2017 \u7684\u91cf\u7ea7\uff1a2.9e12 \u6761\u6267\u884c\u7684\u5206\u652f\u6307\u4ee4\u6570\uff0c\u7ecf\u8fc7 SimPoint \u5904\u7406\u540e\uff0c\u5047\u5982\u6bcf\u4e2a\u5b50 benchmark \u62c6\u5206\u6210 15 \u4e2a\u957f\u5ea6\u4e3a 1e8 \u6761\u6307\u4ee4\u7684 phase\uff0c\u90a3\u4e48\u6700\u7ec8\u53ef\u80fd\u53ea\u9700\u8981 3e10 \u6761\u6307\u4ee4\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u5904\u7406\u7684\u5927\u5c0f\u4e86\uff0c\u4ee5\u5355\u6838\u6bcf\u79d2\u6a21\u62df 1e7 \u6761\u5206\u652f\u6307\u4ee4\u7684\u901f\u5ea6\uff0c\u5b8c\u6574\u8dd1\u4e00\u6b21\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u9a8c\uff0c\u53ef\u80fd\u53ea\u9700\u8981\u51e0\u5341\u5206\u949f\u7684\u65f6\u95f4\uff0c\u518d\u52a0\u4e0a\u591a\u6838\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u7f29\u77ed\u5230\u51e0\u5206\u949f\u3002</p>\n<h2 id=\"trace-\u6293\u53d6\">trace \u6293\u53d6<a class=\"headerlink\" href=\"#trace-\u6293\u53d6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u521a\u624d\u8ba8\u8bba\u4e86\u5f88\u591a trace \u7684\u5927\u5c0f\u4ee5\u53ca\u5982\u4f55\u7528 SimPoint \u538b\u7f29\u7a7a\u95f4\uff0c\u90a3\u4e48\u8fd9\u4e2a trace \u5230\u5e95\u600e\u4e48\u6293\u53d6\u5462\uff1f\u4e3b\u8981\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\u57fa\u4e8e\u786c\u4ef6\u5df2\u6709\u7684 trace\uff0c\u6bd4\u5982 <a href=\"../../../../2024/12/10/linux-perf-pmu/\">Intel PT</a>\uff0c\u4f46\u9700\u8981\u6ce8\u610f\uff0cIntel PT \u662f\u53ef\u80fd\u4e22\u5931\u5386\u53f2\u7684\uff0c\u867d\u7136\u6bd4\u4f8b\u6bd4\u8f83\u5c0f\uff1b\u4e3a\u4e86\u907f\u514d\u4e22\u5931\u5386\u53f2\uff0c\u5efa\u8bae\u8bbe\u7f6e <code>sysctl kernel.perf_event_paranoid=-1</code>\uff08\u6216\u8005\u7528 root \u6743\u9650\u6765\u8fd0\u884c <code>perf record</code>\uff0c\u5373\u7ed5\u8fc7 <code>mlock limit after perf_event_mlock_kb</code> \u7684\u9650\u5236\uff09\u6765\u6269\u5927 Intel PT \u4f7f\u7528\u7684 buffer \u5927\u5c0f\uff0c\u4ece 32KB \u6269\u5927\u5230 1MB\uff08\u53c2\u8003 <a href=\"https://github.com/mysqlperformance/pt_perf\">pt_perf</a>\uff09\uff0c\u5728\u5927\u5c0f\u6838\u673a\u5668\u4e0a\u8fd8\u8981\u7ed1\u5b9a\u5230\u4e00\u4e2a\u5927\u6838\u4e0a</li>\n<li>\u57fa\u4e8e\u8f6f\u4ef6\u7684 Binary Instrumentation\uff0c\u5373\u9488\u5bf9\u5206\u652f\u6307\u4ee4\u63d2\u6869\uff0c\u6bd4\u5982 Pin\u3001DynamoRIO \u751a\u81f3 QEMU</li>\n</ol>\n<p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u6027\u80fd\u662f\u6700\u597d\u7684\uff0c\u8fd0\u884c\u5f00\u9500\u6bd4\u8f83\u5c0f\uff0c\u8017\u8d39 1.4x \u7684\u65f6\u95f4\uff0c\u4f46\u662f\u540e\u7eed\u5904\u7406\u4e5f\u6bd4\u8f83\u8d39\u52b2\u4e00\u4e9b\uff0c\u6b64\u5916\u6bd4\u8f83\u4f9d\u8d56\u5e73\u53f0\uff0cARM \u4e0a\u867d\u7136\u4e5f\u6709 SPE\uff0c\u4f46\u662f\u652f\u6301\u7684\u5e73\u53f0\u6bd4\u8f83\u5c11\u3002\u5176\u4ed6\u5e73\u53f0\u5c31\u4e0d\u597d\u8bf4\u4e86\u3002</p>\n<p>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u6027\u80fd\u4f1a\u5dee\u4e00\u4e9b\uff0c\u5927\u6982\u4f1a\u6709 30-50x \u7684\u6027\u80fd\u5f00\u9500\uff0c\u4f46\u662f\u4e00\u5929\u4e00\u591c\u4e5f\u80fd\u591f\u628a SPEC INT 2017 \u8dd1\u5b8c\u3002\u5b9e\u73b0\u7684\u65f6\u5019\uff0c\u9700\u8981\u6ce8\u610f\u5728\u9047\u5230\u5206\u652f\u7684\u65f6\u5019\uff0c\u9996\u5148\u628a\u4fe1\u606f\u4fdd\u5b58\u5728\u5185\u5b58\u7684 buffer \u4e2d\uff0cbuffer \u6ee1\u4e86\u518d\u5199\u76d8\uff1b\u6b64\u5916\uff0c\u4e3a\u4e86\u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4\u4ee5\u53ca\u5199\u76d8\u6240\u8017\u8d39\u7684 I/O \u65f6\u95f4\uff0c\u53ef\u4ee5\u5728\u5185\u5b58\u4e2d\u4e00\u8fb9\u751f\u6210\u6570\u636e\u4e00\u8fb9\u538b\u7f29\uff0c\u76f4\u63a5\u628a\u538b\u7f29\u597d\u7684\u6570\u636e\u5199\u5165\u5230\u6587\u4ef6\u4e2d\u3002</p>\n<p>\u5b9e\u8df5\u4e2d\uff0c\u53ef\u4ee5\u5148\u7528 Intel PT \u6293\u53d6 trace\uff0c\u518d\u628a trace \u8f6c\u6362\u4e3a\u7b2c\u4e8c\u79cd\u683c\u5f0f\uff0c\u6700\u7ec8\u7684\u6293\u53d6 + \u8f6c\u6362\u7684\u6027\u80fd\u5f00\u9500\u5927\u6982\u662f 15x\u3002\u5927\u81f4\u7b97\u6cd5\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u904d\u5386\u7a0b\u5e8f\u4e2d\u6240\u6709\u7684\u5206\u652f\uff0c\u6309\u7167\u5730\u5740\u4ece\u5c0f\u5230\u5927\u4fdd\u5b58\u8d77\u6765\u5728\u6570\u7ec4\u5f53\u4e2d\uff0c\u9488\u5bf9\u90a3\u4e9b\u76f4\u63a5\u5206\u652f\uff0c\u63d0\u524d\u8ba1\u7b97\u597d\u4ece\u5b83\u7684\u76ee\u7684\u5730\u5740\u5f00\u59cb\u9047\u5230\u7684\u7b2c\u4e00\u4e2a\u5206\u652f\u5728\u6570\u7ec4\u7684\u4e0b\u6807</li>\n<li>\u89e3\u6790 perf.data \u4e2d\u7684 Intel PT packet\uff0c\u63d0\u53d6\u51fa\u5176\u4e2d\u7684 TNT \u548c TIP packet\uff0c\u4ece\u7a0b\u5e8f\u7684 entrypoint \u5f00\u59cb\uff0c\u6cbf\u7740 Intel PT \u7684 trace \u91cd\u5efa\u63a7\u5236\u6d41\uff1a\u6761\u4ef6\u5206\u652f\u4ece TNT packet \u83b7\u53d6\u65b9\u5411\uff0c\u95f4\u63a5\u5206\u652f\u4ece TIP packet \u83b7\u53d6\u76ee\u7684\u5730\u5740\uff0c</li>\n<li>\u5982\u679c\u5206\u652f\u8df3\u8f6c\u4e86\uff0c\u5c31\u6839\u636e\u76ee\u7684\u5730\u5740\u627e\u5230\u4ece\u76ee\u7684\u5730\u5740\u5f00\u59cb\u9047\u5230\u7684\u4e0b\u4e00\u4e2a\u5206\u652f\uff08\u4e8c\u5206\u67e5\u627e\uff09\uff1b\u5982\u679c\u6ca1\u6709\u8df3\u8f6c\uff0c\u5c31\u76f4\u63a5\u8bbf\u95ee\u6570\u7ec4\u7684\u4e0b\u4e00\u4e2a\u5206\u652f</li>\n<li>\u6ce8\u610f RET compression \u7684\u5904\u7406\uff1a\u7ef4\u62a4 call stack\uff0c\u5982\u679c\u9047\u5230 return \u7684\u65f6\u5019\u521a\u597d\u5728 TNT packet \u4e2d\uff0c\u4e14\u5bf9\u5e94\u7684 bit \u662f Taken\uff0c\u5219\u4ece call stack \u53d6\u51fa\u76ee\u7684\u5730\u5740\uff1b\u4e00\u4e2a\u4f18\u5316\u662f call stack \u4e0d\u4ec5\u8bb0\u5f55\u5730\u5740\uff0c\u8fd8\u8bb0\u5f55\u4ece\u8fd9\u4e2a\u5730\u5740\u5f00\u59cb\u9047\u5230\u7684\u4e0b\u4e00\u4e2a\u5206\u652f\u5728\u6570\u7ec4\u7684\u4e0b\u6807</li>\n<li>\u91cd\u5efa\u63a7\u5236\u6d41\u7684\u540c\u65f6\uff0c\u8f93\u51fa\u7b2c\u4e8c\u79cd\u683c\u5f0f\u7684 trace\uff0c\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\u6d41\u5f0f\u538b\u7f29</li>\n</ol>\n<p>\u4ee5\u4e0a\u7684\u8fd9\u4e9b\u6027\u80fd\u5f00\u9500\u53ea\u662f\u5728\u4e00\u4e2a\u7a0b\u5e8f\u4e0a\u6d4b\u5f97\u7684\u7ed3\u679c\uff0c\u4e0d\u540c\u7684\u7a0b\u5e8f\u4e0a\uff0c\u5176\u6027\u80fd\u5f00\u9500\u4e5f\u6709\u5f88\u5927\u7684\u4e0d\u540c\u3002</p>\n<p>\u5bf9\u4e8e\u52a8\u6001\u94fe\u63a5\uff0cperf.data \u4f1a\u8bb0\u5f55 mmap event\uff1bPin \u548c DynamoRIO \u90fd\u53ef\u4ee5\u5bf9 module load \u4e8b\u4ef6\u8fdb\u884c\u63d2\u6869\u3002\u52a8\u6001\u5e93\u53ef\u4ee5\u4ece\u6587\u4ef6\u7cfb\u7edf\u4e2d\u8bbf\u95ee\uff0cvdso \u53ef\u4ee5\u4ece\u5185\u5b58\u4e2d<a href=\"https://ldpreload.com/p/blog/dump-vdso.c\">\u5bfc\u51fa</a>\u3002</p>\n<h2 id=\"\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\">\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df<a class=\"headerlink\" href=\"#\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u5b8c\u6210\u4e86\u524d\u9762\u7684\u5927\u90e8\u5206\u6b65\u9aa4\u4ee5\u540e\uff0c\u6700\u7ec8\u5c31\u662f\u642d\u5efa\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u6a21\u62df\u5668\u4e86\u3002\u5176\u5b9e\u8fd9\u4e00\u70b9\u5012\u662f\u5e76\u4e0d\u590d\u6742\uff0c\u4f8b\u5982 CBP Championship \u6216\u8005 ChampSim \u90fd\u6709\u73b0\u6210\u7684\u6846\u67b6\uff0c\u5b83\u4eec\u4e5f\u90fd\u63d0\u4f9b\u4e86\u4e00\u4e9b\u7ecf\u5178\u7684\u5206\u652f\u9884\u6d4b\u5668\u7684\u5b9e\u73b0\u4ee3\u7801\uff0c\u4f8b\u5982 TAGE-SC-L\u3002\u5728\u5b83\u4eec\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u5f00\u53d1\uff0c\u5c31\u53ef\u4ee5\u8bc4\u4f30\u5404\u79cd\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u7684\u9884\u6d4b\u6548\u679c\u4e86\u3002</p>\n<p>\u5b9e\u9645\u4e0a\uff0c\u9664\u4e86\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\uff0c\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u5b9e\u9a8c\u4e5f\u53ef\u4ee5\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6784\u5efa trace \u7136\u540e\u8fd0\u884c\u3002\u4f46\u6761\u4ef6\u5206\u652f\u9884\u6d4b\u5668\u6709\u4e2a\u6bd4\u8f83\u597d\u7684\u7279\u70b9\uff1a\u5b83\u9700\u8981\u7684\u72b6\u6001\u6bd4\u8f83\u7b80\u5355\uff0c\u901a\u5e38\u62ff\u4e4b\u524d\u4e00\u6bb5\u6307\u4ee4\u505a\u9884\u70ed\u5373\u53ef\uff0c\u4e0d\u9700\u8981 checkpoint\uff1b\u800c\u5982\u679c\u8981\u5b8c\u6574\u6a21\u62df\u6574\u4e2a\u5904\u7406\u5668\u7684\u6267\u884c\uff0c\u901a\u5e38\u9700\u8981\u5f97\u5230\u7cfb\u7edf\u7684\u6574\u4e2a\u72b6\u6001\uff0c\u6bd4\u5982\u5185\u5b58\u548c\u5bc4\u5b58\u5668\uff0c\u624d\u80fd\u7ee7\u7eed\u6267\u884c\uff0c\u8fd9\u65f6\u5019\u5c31\u53ef\u80fd\u9700\u8981\u63d0\u524d\u628a slice \u5f00\u59cb\u7684\u72b6\u6001\u4fdd\u5b58\u4e0b\u6765\uff08checkpoint\uff09\uff0c\u6216\u8005\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u4e0d\u7cbe\u786e\u7684\u6a21\u62df\u5668\u5feb\u901f\u8ba1\u7b97\u51fa slice \u5f00\u59cb\u7684\u72b6\u6001\uff08fast forwarding\uff09\u3002</p>\n<h2 id=\"\u5b9e\u9a8c\u6570\u636e\">\u5b9e\u9a8c\u6570\u636e<a class=\"headerlink\" href=\"#\u5b9e\u9a8c\u6570\u636e\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"trace-\u6293\u53d6_1\">Trace \u6293\u53d6<a class=\"headerlink\" href=\"#trace-\u6293\u53d6_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u8fd9\u91cc\u5217\u51fa\u6700\u7ec8\u4f7f\u7528\u7684 trace \u683c\u5f0f\u548c\u5b9e\u9a8c\u6570\u636e\uff1a</p>\n<ol>\n<li>trace \u683c\u5f0f\uff1a\u4f7f\u7528\u7b2c\u4e8c\u79cd trace \u8bb0\u5f55\u65b9\u6cd5\uff0c\u6bcf\u6b21\u6267\u884c branch \u8bb0\u5f55 4 \u5b57\u8282\u7684\u4fe1\u606f\uff0c\u5305\u62ec branch id \u548c\u662f\u5426\u8df3\u8f6c\uff0c\u4f7f\u7528 zstd \u8fdb\u884c\u65e0\u635f\u538b\u7f29</li>\n<li>trace \u5927\u5c0f\u548c\u8fd0\u884c\u65f6\u95f4\u7edf\u8ba1\uff08GCC 12.2.0\uff0c<code>-O3 -static</code> \u7f16\u8bd1\uff0c\u5728 Intel i9-14900K \u4e0a\u5b9e\u9a8c\uff09\uff1a</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>\u5b50 benchmark</th>\n<th>\u5206\u652f\u6267\u884c\u6b21\u6570</th>\n<th>trace \u5927\u5c0f</th>\n<th>\u6bcf\u5206\u652f\u7a7a\u95f4\u5f00\u9500</th>\n<th>\u7a0b\u5e8f\u76f4\u63a5\u8fd0\u884c\u65f6\u95f4</th>\n<th>Pin \u6293\u53d6\u65f6\u95f4</th>\n<th>\u65f6\u95f4\u5f00\u9500</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>500.perlbench_r</td>\n<td>checkspam</td>\n<td>2.40e11</td>\n<td>8.87 GiB</td>\n<td>0.32 bit</td>\n<td>59s</td>\n<td>6334s</td>\n<td>107x</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>diffmail</td>\n<td>1.49e11</td>\n<td>2.78 GiB</td>\n<td>0.16 bit</td>\n<td>33s</td>\n<td>4615s</td>\n<td>140x</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>splitmail</td>\n<td>1.33e11</td>\n<td>1.49 GiB</td>\n<td>0.10 bit</td>\n<td>31s</td>\n<td>3385s</td>\n<td>109x</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>Total</td>\n<td>5.22e11</td>\n<td>13.14 GiB</td>\n<td>0.22 bit</td>\n<td>123s</td>\n<td>14334s</td>\n<td>117x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O3</td>\n<td>4.50e10</td>\n<td>3.28 GiB</td>\n<td>0.63 bit</td>\n<td>17s</td>\n<td>1625s</td>\n<td>96x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O2</td>\n<td>5.37e10</td>\n<td>3.46 GiB</td>\n<td>0.55 bit</td>\n<td>20s</td>\n<td>1930s</td>\n<td>97x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-smaller</td>\n<td>5.51e10</td>\n<td>2.84 GiB</td>\n<td>0.44 bit</td>\n<td>21s</td>\n<td>1830s</td>\n<td>87x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O5</td>\n<td>4.22e10</td>\n<td>1.20 GiB</td>\n<td>0.24 bit</td>\n<td>16s</td>\n<td>1369s</td>\n<td>86x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O3</td>\n<td>4.80e10</td>\n<td>1.50 GiB</td>\n<td>0.27 bit</td>\n<td>24s</td>\n<td>2209s</td>\n<td>92x</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>Total</td>\n<td>2.44e11</td>\n<td>12.24 GiB</td>\n<td>0.43 bit</td>\n<td>98s</td>\n<td>8963s</td>\n<td>91x</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>N/A</td>\n<td>2.21e11</td>\n<td>31.0 GiB</td>\n<td>1.20 bit</td>\n<td>168s</td>\n<td>4800s</td>\n<td>29x</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>N/A</td>\n<td>2.15e11</td>\n<td>13.3 GiB</td>\n<td>0.53 bit</td>\n<td>135s</td>\n<td>7289s</td>\n<td>54x</td>\n</tr>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>N/A</td>\n<td>3.27e11</td>\n<td>4.45 GiB</td>\n<td>0.12 bit</td>\n<td>112s</td>\n<td>8883s</td>\n<td>79x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 1</td>\n<td>1.44e10</td>\n<td>579 MiB</td>\n<td>0.34 bit</td>\n<td>14s</td>\n<td>348s</td>\n<td>25x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 2</td>\n<td>4.42e10</td>\n<td>2.30 GiB</td>\n<td>0.45 bit</td>\n<td>39s</td>\n<td>1202s</td>\n<td>31x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>seek 500</td>\n<td>4.78e10</td>\n<td>2.77 GiB</td>\n<td>0.50 bit</td>\n<td>41s</td>\n<td>1258s</td>\n<td>31x</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>Total</td>\n<td>1.06e11</td>\n<td>5.64 GiB</td>\n<td>0.46 bit</td>\n<td>94s</td>\n<td>2808s</td>\n<td>30x</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>N/A</td>\n<td>2.74e11</td>\n<td>31.6 GiB</td>\n<td>0.99 bit</td>\n<td>140s</td>\n<td>8093s</td>\n<td>58x</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>N/A</td>\n<td>3.38e11</td>\n<td>75.6 GiB</td>\n<td>1.92 bit</td>\n<td>224s</td>\n<td>8894s</td>\n<td>40x</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>N/A</td>\n<td>3.01e11</td>\n<td>26.3 GiB</td>\n<td>0.75 bit</td>\n<td>88s</td>\n<td>6753s</td>\n<td>77x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cld</td>\n<td>5.08e10</td>\n<td>9.16 GiB</td>\n<td>1.55 bit</td>\n<td>60s</td>\n<td>1252s</td>\n<td>21x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cpu2006docs</td>\n<td>1.84e11</td>\n<td>7.80 GiB</td>\n<td>0.36 bit</td>\n<td>65s</td>\n<td>3923s</td>\n<td>60x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>input</td>\n<td>7.96e10</td>\n<td>10.5 GiB</td>\n<td>1.14 bit</td>\n<td>55s</td>\n<td>1842s</td>\n<td>33x</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>Total</td>\n<td>3.14e11</td>\n<td>27.5 GiB</td>\n<td>0.75 bit</td>\n<td>180s</td>\n<td>7017s</td>\n<td>39x</td>\n</tr>\n<tr>\n<td>Total</td>\n<td>N/A</td>\n<td>2.86e12</td>\n<td>241 GiB</td>\n<td>0.72 bit</td>\n<td>1362s</td>\n<td>77834s</td>\n<td>57x</td>\n</tr>\n</tbody>\n</table>\n<p>\u6bcf\u5206\u652f\u7684\u7a7a\u95f4\u5f00\u9500\u548c\u5728 i9-14900K \u4e0a\u6d4b\u5f97\u7684 MPKI\uff08Mispredictions Per Kilo Instructions\uff09\u6709\u6bd4\u8f83\u660e\u663e\u7684\u6b63\u76f8\u5173\u6027\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>MPKI</th>\n<th>\u6bcf\u5206\u652f\u7a7a\u95f4\u5f00\u9500</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>0.84</td>\n<td>0.12 bit</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>0.95</td>\n<td>0.22 bit</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>1.06</td>\n<td>0.46 bit</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>2.66</td>\n<td>0.75 bit</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>3.16</td>\n<td>0.43 bit</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>4.35</td>\n<td>0.99 bit</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>4.47</td>\n<td>0.53 bit</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>5.35</td>\n<td>0.75 bit</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>12.61</td>\n<td>1.92 bit</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>13.24</td>\n<td>1.20 bit</td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u4e8e LTO \u5bf9\u5206\u652f\u6570\u91cf\u7684\u5f71\u54cd\u8f83\u5927\uff0c\u989d\u5916\u5bf9\u6bd4\u4e86 <code>-O3</code> \u548c <code>-O3 -flto</code> \u7684\u533a\u522b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>\u5b50 benchmark</th>\n<th>O3 \u5206\u652f\u6267\u884c\u6b21\u6570</th>\n<th>O3 trace \u5927\u5c0f</th>\n<th>O3+LTO \u5206\u652f\u6267\u884c\u6b21\u6570</th>\n<th>O3+LTO trace \u5927\u5c0f</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>500.perlbench_r</td>\n<td>checkspam</td>\n<td>2.40e11</td>\n<td>8.87 GiB</td>\n<td>2.32e11</td>\n<td>8.77 GiB</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>diffmail</td>\n<td>1.49e11</td>\n<td>2.78 GiB</td>\n<td>1.45e11</td>\n<td>2.70 GiB</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>splitmail</td>\n<td>1.33e11</td>\n<td>1.49 GiB</td>\n<td>1.31e11</td>\n<td>1.48 GiB</td>\n</tr>\n<tr>\n<td>500.perlbench_r</td>\n<td>Total</td>\n<td>5.22e11</td>\n<td>13.14 GiB</td>\n<td>5.08e11</td>\n<td>12.95 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O3</td>\n<td>4.50e10</td>\n<td>3.28 GiB</td>\n<td>4.27e10</td>\n<td>3.20 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-pp -O2</td>\n<td>5.37e10</td>\n<td>3.46 GiB</td>\n<td>5.10e10</td>\n<td>3.38 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>gcc-smaller</td>\n<td>5.51e10</td>\n<td>2.84 GiB</td>\n<td>5.31e10</td>\n<td>2.78 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O5</td>\n<td>4.22e10</td>\n<td>1.20 GiB</td>\n<td>4.05e10</td>\n<td>1.17 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>ref32 -O3</td>\n<td>4.80e10</td>\n<td>1.50 GiB</td>\n<td>4.58e10</td>\n<td>1.45 GiB</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>Total</td>\n<td>2.44e11</td>\n<td>12.24 GiB</td>\n<td>2.33e11</td>\n<td>11.98 GiB</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>N/A</td>\n<td>2.21e11</td>\n<td>31.0 GiB</td>\n<td>1.62e11</td>\n<td>26.6 GiB</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>N/A</td>\n<td>2.15e11</td>\n<td>13.3 GiB</td>\n<td>1.97e11</td>\n<td>13.2 GiB</td>\n</tr>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>N/A</td>\n<td>3.27e11</td>\n<td>4.45 GiB</td>\n<td>3.16e11</td>\n<td>4.37 GiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 1</td>\n<td>1.44e10</td>\n<td>579 MiB</td>\n<td>1.43e10</td>\n<td>575 MiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>pass 2</td>\n<td>4.42e10</td>\n<td>2.30 GiB</td>\n<td>4.42e10</td>\n<td>2.29 GiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>seek 500</td>\n<td>4.78e10</td>\n<td>2.77 GiB</td>\n<td>4.77e10</td>\n<td>2.76 GiB</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>Total</td>\n<td>1.06e11</td>\n<td>5.64 GiB</td>\n<td>1.06e11</td>\n<td>5.61 GiB</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>N/A</td>\n<td>2.74e11</td>\n<td>31.6 GiB</td>\n<td>2.13e11</td>\n<td>29.1 GiB</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>N/A</td>\n<td>3.38e11</td>\n<td>75.6 GiB</td>\n<td>2.61e11</td>\n<td>72.3 GiB</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>N/A</td>\n<td>3.01e11</td>\n<td>26.3 GiB</td>\n<td>3.02e11</td>\n<td>26.2 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cld</td>\n<td>5.08e10</td>\n<td>9.16 GiB</td>\n<td>5.07e10</td>\n<td>9.12 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>cpu2006docs</td>\n<td>1.84e11</td>\n<td>7.80 GiB</td>\n<td>1.84e11</td>\n<td>7.78 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>input</td>\n<td>7.96e10</td>\n<td>10.5 GiB</td>\n<td>7.94e10</td>\n<td>10.5 GiB</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>Total</td>\n<td>3.14e11</td>\n<td>27.5 GiB</td>\n<td>3.14e11</td>\n<td>27.4 GiB</td>\n</tr>\n<tr>\n<td>Total</td>\n<td>N/A</td>\n<td>2.86e12</td>\n<td>241 GiB</td>\n<td>2.61e12</td>\n<td>230 GiB</td>\n</tr>\n</tbody>\n</table>\n<p>LTO \u53bb\u6389\u4e86 9% \u7684\u5206\u652f\u6307\u4ee4\uff0c\u5bf9\u6574\u4f53\u6027\u80fd\u7684\u5f71\u54cd\u8fd8\u662f\u86ee\u5927\u7684\uff0cMPKI \u7684\u6570\u503c\u4e5f\u6709\u660e\u663e\u7684\u53d8\u5316\u3002</p>\n<h3 id=\"\u65f6\u95f4\u5f00\u9500\">\u65f6\u95f4\u5f00\u9500<a class=\"headerlink\" href=\"#\u65f6\u95f4\u5f00\u9500\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5404\u4e2a\u6b65\u9aa4\u9700\u8981\u8017\u8d39\u7684\u65f6\u95f4\uff08\u5355\u7ebf\u7a0b\uff09\uff1a</p>\n<ol>\n<li>\u6293\u53d6 trace\uff1a\u7ea6 20 \u5c0f\u65f6</li>\n<li>\u8fd0\u884c SimPoint: \u7ea6 4 \u5c0f\u65f6</li>\n<li>\u6a21\u62df\u5206\u652f\u9884\u6d4b\uff1a\u7ea6 1 \u5c0f\u65f6</li>\n</ol>\n<h3 id=\"simpoint_1\">SimPoint<a class=\"headerlink\" href=\"#simpoint_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u8003\u8651\u5230\uff08\u5b50\uff09benchmark \u4e4b\u95f4\u6ca1\u6709\u4f9d\u8d56\u5173\u7cfb\uff0c\u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\u591a\u4e2a trace/simpoint/simulate \u64cd\u4f5c\uff0c\u4e0d\u8fc7\u8003\u8651\u5230\u5185\u5b58\u5360\u7528\u548c\u786c\u76d8 I/O \u538b\u529b\uff0c\u5b9e\u9645\u7684\u5e76\u884c\u6027\u4e5f\u6ca1\u6709\u90a3\u4e48\u9ad8\u3002</p>\n<p>\u8dd1\u51fa\u6765\u7684 SimPoint \u805a\u7c7b\u53ef\u89c6\u5316\u4e2d\u6548\u679c\u6bd4\u8f83\u597d\u7684\uff0c\u56fe\u4e2d\u6a2a\u8f74\u662f\u6309\u6267\u884c\u987a\u5e8f\u7684 SimPoint slice\uff0c\u7eb5\u8f74\u6bcf\u4e00\u4e2a y \u503c\u5bf9\u5e94\u4e00\u4e2a SimPoint phase\uff0c\u56fe\u4e2d\u7684\u70b9\u4ee3\u8868\u54ea\u4e2a slice \u88ab\u5f52\u5230\u4e86\u54ea\u4e2a phase \u4e0a\uff1a</p>\n<p>500.perlbench_r diffmail:</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-perlbench-diffmail.png\" /></p>\n<p>520.omnetpp_r:</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-omnetpp.png\" /></p>\n<p>557.xz_r input:</p>\n<p><img alt=\"\" src=\"../../../../cbp-experiments-simpoint-xz-input.png\" /></p>\n<p>\u4ee5 1e8 \u6761\u6307\u4ee4\u7684\u7c92\u5ea6\u5207\u5206 SimPoint\uff0c\u628a 241 GB \u7684 trace \u7f29\u51cf\u5230 415 MB \u7684\u89c4\u6a21\u3002</p>\n<h3 id=\"\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\">\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df<a class=\"headerlink\" href=\"#\u5206\u652f\u9884\u6d4b\u5668\u6a21\u62df\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f7f\u7528 CBP 2016 \u7684 Andre Seznec TAGE-SC-L 8KB/64KB \u7684\u5206\u652f\u9884\u6d4b\u5668\u5728 SimPoint \u4e0a\u6a21\u62df SPEC INT 2017 Rate-1\uff0c\u53ea\u9700\u8981 9-10 \u5206\u949f\u3002</p>\n<p>\u4f7f\u7528 CBP 2016 \u7684 Andre Seznec TAGE-SC-L 8KB/64KB \u7684\u5206\u652f\u9884\u6d4b\u5668\u5728 SimPoint \u4e0a\u6a21\u62df\u7684 CMPKI\uff08\u53ea\u8003\u8651\u4e86\u65b9\u5411\u5206\u652f\uff09\uff0c\u548c Intel i9-14900K \u7684 MPKI\uff08\u8003\u8651\u4e86\u6240\u6709\u5206\u652f\uff09\u5728 SPEC INT 2017 Rate-1\uff08AMD64\uff0c<code>-O3</code>\uff09\u7684\u6bd4\u8f83\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>benchmark</th>\n<th>TAGE-SC-L 8KB</th>\n<th>TAGE-SC-L 64KB</th>\n<th>i9-14900K</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>500.perlbench_r</td>\n<td>1.00</td>\n<td>0.72</td>\n<td>0.95</td>\n</tr>\n<tr>\n<td>502.gcc_r</td>\n<td>4.69</td>\n<td>3.36</td>\n<td>3.16</td>\n</tr>\n<tr>\n<td>505.mcf_r</td>\n<td>13.02</td>\n<td>12.23</td>\n<td>13.24</td>\n</tr>\n<tr>\n<td>520.omnetpp_r</td>\n<td>4.09</td>\n<td>3.49</td>\n<td>4.47</td>\n</tr>\n<tr>\n<td>523.xalancbmk_r</td>\n<td>0.85</td>\n<td>0.68</td>\n<td>0.84</td>\n</tr>\n<tr>\n<td>525.x264_r</td>\n<td>0.76</td>\n<td>0.59</td>\n<td>1.06</td>\n</tr>\n<tr>\n<td>531.deepsjeng_r</td>\n<td>4.59</td>\n<td>3.45</td>\n<td>4.35</td>\n</tr>\n<tr>\n<td>541.leela_r</td>\n<td>11.79</td>\n<td>9.42</td>\n<td>12.61</td>\n</tr>\n<tr>\n<td>548.exchange2_r</td>\n<td>2.96</td>\n<td>1.25</td>\n<td>2.66</td>\n</tr>\n<tr>\n<td>557.xz_r</td>\n<td>4.68</td>\n<td>4.06</td>\n<td>5.35</td>\n</tr>\n<tr>\n<td>average</td>\n<td>4.84</td>\n<td>3.925</td>\n<td>4.87</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"\u4e0d\u540c\u7f16\u8bd1\u9009\u9879\u548c\u6307\u4ee4\u96c6\u4e0b-spec-int-2017-\u7684\u6307\u4ee4\u6570\u548c\u5206\u652f\u6307\u4ee4\u6570\u89c4\u6a21\">\u4e0d\u540c\u7f16\u8bd1\u9009\u9879\u548c\u6307\u4ee4\u96c6\u4e0b SPEC INT 2017 \u7684\u6307\u4ee4\u6570\u548c\u5206\u652f\u6307\u4ee4\u6570\u89c4\u6a21<a class=\"headerlink\" href=\"#\u4e0d\u540c\u7f16\u8bd1\u9009\u9879\u548c\u6307\u4ee4\u96c6\u4e0b-spec-int-2017-\u7684\u6307\u4ee4\u6570\u548c\u5206\u652f\u6307\u4ee4\u6570\u89c4\u6a21\" title=\"Permanent link\">&para;</a></h3>\n<table>\n<thead>\n<tr>\n<th>ISA</th>\n<th>Flags</th>\n<th>Compiler</th>\n<th># Inst</th>\n<th># Branch Inst</th>\n<th>% Branch Inst</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>LLVM 20.1.0</td>\n<td>2.10e+13</td>\n<td>3.11e+12</td>\n<td>14.8%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>LLVM 19.1.4</td>\n<td>1.99e+13</td>\n<td>3.13e+12</td>\n<td>15.7%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>GCC 11.3</td>\n<td>1.69e+13</td>\n<td>2.88e+12</td>\n<td>17.0%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3</td>\n<td>GCC 12.2</td>\n<td>1.67e+13</td>\n<td>2.88e+12</td>\n<td>17.2%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3+LTO</td>\n<td>GCC 12.2</td>\n<td>1.57e+13</td>\n<td>2.63e+12</td>\n<td>16.8%</td>\n</tr>\n<tr>\n<td>AMD64</td>\n<td>O3+LTO+JEMALLOC</td>\n<td>GCC 12.2</td>\n<td>1.57e+13</td>\n<td>2.62e+12</td>\n<td>16.7%</td>\n</tr>\n<tr>\n<td>ARM64</td>\n<td>O3</td>\n<td>GCC 12.2</td>\n<td>1.62e+13</td>\n<td>2.83e+12</td>\n<td>17.5%</td>\n</tr>\n<tr>\n<td>ARM64</td>\n<td>O3+LTO</td>\n<td>GCC 12.2</td>\n<td>1.53e+13</td>\n<td>2.59e+12</td>\n<td>16.9%</td>\n</tr>\n<tr>\n<td>ARM64</td>\n<td>O3+LTO+JEMALLOC</td>\n<td>GCC 12.2</td>\n<td>1.52e+13</td>\n<td>2.57e+12</td>\n<td>16.9%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3</td>\n<td>GCC 14.2</td>\n<td>1.75e+13</td>\n<td>2.86e+12</td>\n<td>16.3%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3+LTO</td>\n<td>GCC 14.2</td>\n<td>1.66e+13</td>\n<td>2.61e+12</td>\n<td>15.7%</td>\n</tr>\n<tr>\n<td>LoongArch</td>\n<td>O3+LTO+JEMALLOC</td>\n<td>GCC 14.2</td>\n<td>1.65e+13</td>\n<td>2.61e+12</td>\n<td>15.8%</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"\u57fa\u4e8e-pin-\u5f00\u53d1-branch-trace-\u5de5\u5177\">\u57fa\u4e8e Pin \u5f00\u53d1 branch trace \u5de5\u5177<a class=\"headerlink\" href=\"#\u57fa\u4e8e-pin-\u5f00\u53d1-branch-trace-\u5de5\u5177\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u7ed9\u51fa\u5982\u4f55\u7528 Pin \u5b9e\u73b0\u4e00\u4e2a branch trace \u5de5\u5177\u7684\u8fc7\u7a0b\uff1a</p>\n<ol>\n<li>\n<p>\u53c2\u8003 Pin \u7684\u6837\u4f8b\u4ee3\u7801\uff0cInstrument \u6bcf\u4e00\u6761\u6307\u4ee4\uff0c\u5982\u679c\u5b83\u662f\u5206\u652f\u6307\u4ee4\uff0c\u5c31\u8bb0\u5f55\u5b83\u7684\u6307\u4ee4\u5730\u5740\u3001\u76ee\u7684\u5730\u5740\u3001\u6307\u4ee4\u957f\u5ea6\u3001\u5206\u652f\u7c7b\u578b\u4ee5\u53ca\u662f\u5426\u8df3\u8f6c\u7684\u4fe1\u606f\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"nf\">Instruction</span><span class=\"p\">(</span><span class=\"n\">INS</span><span class=\"w\"> </span><span class=\"n\">ins</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">v</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">INS_IsControlFlow</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"w\">        </span><span class=\"n\">UINT32</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">INS_Size</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"w\">        </span><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"nc\">branch_type</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"cm\">/* omitted */</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"w\">        </span><span class=\"n\">INS_InsertCall</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IPOINT_BEFORE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">AFUNPTR</span><span class=\"p\">)</span><span class=\"n\">RecordBranch</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_INST_PTR</span><span class=\"p\">,</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"w\">                    </span><span class=\"n\">IARG_BRANCH_TARGET_ADDR</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_UINT32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_UINT32</span><span class=\"p\">,</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"w\">                    </span><span class=\"n\">type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_BRANCH_TAKEN</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">IARG_END</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">argv</span><span class=\"p\">[])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">PIN_Init</span><span class=\"p\">(</span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">argv</span><span class=\"p\">))</span>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">Usage</span><span class=\"p\">();</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"n\">INS_AddInstrumentFunction</span><span class=\"p\">(</span><span class=\"n\">Instruction</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a><span class=\"w\">    </span><span class=\"n\">PIN_StartProgram</span><span class=\"p\">();</span>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u8bb0\u5f55\u5206\u652f\u7684\u65f6\u5019\uff0c\u5206\u522b\u7ef4\u62a4\u5206\u652f\u7684\u6570\u7ec4\u548c\u5206\u652f\u6267\u884c\u4e8b\u4ef6\u7684\u6570\u7ec4\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u6b21\u6267\u884c\u7684\u5206\u652f\uff0c\u8bb0\u5f55\u5206\u652f\u7684 id \u4ee5\u53ca\u662f\u5426\u8df3\u8f6c\u7684\u4fe1\u606f\uff0c\u5230\u5206\u652f\u6267\u884c\u4e8b\u4ef6\u7684\u6570\u7ec4\u5f53\u4e2d\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"nf\">RecordBranch</span><span class=\"p\">(</span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inst_addr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">targ_addr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">UINT32</span><span class=\"w\"> </span><span class=\"n\">inst_length</span><span class=\"p\">,</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"w\">                </span><span class=\"n\">UINT32</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">BOOL</span><span class=\"w\"> </span><span class=\"n\">taken</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">branch</span><span class=\"w\"> </span><span class=\"n\">br</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">inst_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"p\">)</span><span class=\"n\">inst_addr</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">targ_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"p\">)</span><span class=\"n\">targ_addr</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">inst_length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst_length</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"w\">    </span><span class=\"n\">br</span><span class=\"p\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">branch_type</span><span class=\"p\">)</span><span class=\"n\">type</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">entry</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"w\">    </span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">taken</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">taken</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a>\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a><span class=\"w\">    </span><span class=\"c1\">// insert branch if not exists</span>\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a><span class=\"w\">    </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">br_map</span><span class=\"p\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">br</span><span class=\"p\">);</span>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">br_map</span><span class=\"p\">.</span><span class=\"n\">end</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a><span class=\"w\">        </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">num_brs</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">MAX_BRS</span><span class=\"p\">);</span>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a><span class=\"w\">        </span><span class=\"n\">br_map</span><span class=\"p\">[</span><span class=\"n\">br</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">num_brs</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a><span class=\"w\">        </span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">br_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">num_brs</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a><span class=\"w\">        </span><span class=\"n\">brs</span><span class=\"p\">[</span><span class=\"n\">num_brs</span><span class=\"o\">++</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">br</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-20\"><a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\" href=\"#__codelineno-1-20\"></a><span class=\"w\">        </span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">br_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"o\">-&gt;</span><span class=\"n\">second</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-21\"><a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\" href=\"#__codelineno-1-21\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-1-22\"><a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\" href=\"#__codelineno-1-22\"></a>\n</span><span id=\"__span-1-23\"><a id=\"__codelineno-1-23\" name=\"__codelineno-1-23\" href=\"#__codelineno-1-23\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">buffer_size</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">BUFFER_SIZE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-24\"><a id=\"__codelineno-1-24\" name=\"__codelineno-1-24\" href=\"#__codelineno-1-24\"></a><span class=\"w\">        </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-1-25\"><a id=\"__codelineno-1-25\" name=\"__codelineno-1-25\" href=\"#__codelineno-1-25\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-1-26\"><a id=\"__codelineno-1-26\" name=\"__codelineno-1-26\" href=\"#__codelineno-1-26\"></a><span class=\"w\">    </span><span class=\"n\">write_buffer</span><span class=\"p\">[</span><span class=\"n\">buffer_size</span><span class=\"o\">++</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-27\"><a id=\"__codelineno-1-27\" name=\"__codelineno-1-27\" href=\"#__codelineno-1-27\"></a><span class=\"w\">    </span><span class=\"n\">num_entries</span><span class=\"o\">++</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-28\"><a id=\"__codelineno-1-28\" name=\"__codelineno-1-28\" href=\"#__codelineno-1-28\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u4e3a\u4e86\u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4\uff0c\u5f53\u7f13\u51b2\u533a\u6ee1\u7684\u65f6\u5019\uff0c\u9996\u5148\u7ecf\u8fc7 zstd \u7684\u6d41\u538b\u7f29\uff0c\u518d\u628a\u538b\u7f29\u540e\u7684\u5185\u5bb9\u5199\u5165\u5230\u6587\u4ef6\u4e2d\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\">// https://github.com/facebook/zstd/blob/dev/examples/streaming_compression.c</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"n\">ZSTD_EndDirective</span><span class=\"w\"> </span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ZSTD_e_continue</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"n\">ZSTD_inBuffer</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">write_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">write_buffer</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">};</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">finished</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"w\">    </span><span class=\"n\">ZSTD_outBuffer</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">zstd_output_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">zstd_output_buffer_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">};</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">remaining</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ZSTD_compressStream2</span><span class=\"p\">(</span><span class=\"n\">zstd_cctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">output</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">input</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mode</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">ZSTD_isError</span><span class=\"p\">(</span><span class=\"n\">remaining</span><span class=\"p\">));</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a><span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">fwrite</span><span class=\"p\">(</span><span class=\"n\">zstd_output_buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"p\">.</span><span class=\"n\">pos</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"p\">.</span><span class=\"n\">pos</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"w\">    </span><span class=\"n\">finished</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">finished</span><span class=\"p\">);</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u6700\u540e\u5728\u7a0b\u5e8f\u7ed3\u675f\u65f6\uff0c\u628a\u5206\u652f\u6570\u7ec4\u5199\u5165\u5230\u6587\u4ef6\u5e76\u8bb0\u5f55\u5143\u6570\u636e\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"nf\">Fini</span><span class=\"p\">(</span><span class=\"n\">INT32</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">VOID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">v</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"c1\">// 1. compress the remaining data in write buffer and write to file</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"c1\">// 2. save metadata, including:</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"c1\">//    1. number of branch executions</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"c1\">//    2. number of branches</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"c1\">//    3. branches array</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">argv</span><span class=\"p\">[])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">    </span><span class=\"n\">PIN_AddFiniFunction</span><span class=\"p\">(</span><span class=\"n\">Fini</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a><span class=\"w\">    </span><span class=\"n\">PIN_StartProgram</span><span class=\"p\">();</span>\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a><span class=\"w\">    </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u9488\u5bf9\u52a8\u6001\u94fe\u63a5\uff0c\u53ef\u4ee5\u5229\u7528 Pin \u5df2\u6709\u7684 API <code>IMG_AddInstrumentFunction</code> \u6765\u8ddf\u8e2a\uff0c\u65b9\u4fbf\u540e\u7eed\u627e\u5230 trace \u4e2d\u5404\u4e2a\u5730\u5740\u5bf9\u5e94\u7684\u6307\u4ee4</p>\n</li>\n</ol>\n<p>\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86 Branch Trace \u7684\u6293\u53d6\u3002</p>", "image": null, "date_modified": "2025-04-10T00:00:00+00:00", "authors": [], "tags": ["bp", "cbp", "cpu", "ooo", "software"]}, {"id": "https://jia.je/software/2025/04/07/tls-internals/", "url": "https://jia.je/software/2025/04/07/tls-internals/", "title": "Thread Local Storage (TLS) \u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"thread-local-storage-tls-\u5b9e\u73b0\u63a2\u7a76\">Thread Local Storage (TLS) \u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#thread-local-storage-tls-\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>TLS \u662f thread local storage \u7684\u7f29\u5199\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u5b58\u50a8\u4e00\u4e9b per-thread \u7684\u6570\u636e\uff0c\u4f46\u5b83\u5185\u90e8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f\u672c\u6587\u5bf9 glibc 2.31 \u7248\u672c\u7684 TLS \u5b9e\u73b0\u8fdb\u884c\u63a2\u7a76\u3002</p>\n<!-- more -->\n\n<h2 id=\"__thread\">__thread<a class=\"headerlink\" href=\"#__thread\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u6765\u770b TLS \u5728 C \u4e2d\u662f\u600e\u4e48\u4f7f\u7528\u7684\uff1a\u7528 <code>__thread</code> \u6807\u8bb0\u4e00\u4e2a\u5168\u5c40\u53d8\u91cf\uff08\u6ce8\uff1a\u8fdb\u5165 C11/C++11 \u6807\u51c6\u7684\u7528\u6cd5\u662f\u7528 <code>thread_local</code> \u6765\u6807\u8bb0\uff09\uff0c\u90a3\u4e48\u5b83\u5c31\u4f1a\u4fdd\u5b58\u5728 TLS \u5f53\u4e2d\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4efd\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u90a3\u4e48\u7f16\u8bd1\u5668\u5728\u751f\u6210\u8bbf\u95ee\u8fd9\u4e2a TLS \u5168\u5c40\u53d8\u91cf\u65f6\uff0c\u751f\u6210\u7684\u6307\u4ee4\u4e5f\u4e0d\u540c\u3002\u4ee5\u4e0b\u9762\u7684\u4ee3\u7801\u4e3a\u4f8b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">global_data</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">global</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">global_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">tls</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">tls_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u751f\u6210\u7684 amd64 \u6c47\u7f16\u5982\u4e0b\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"w\">        </span><span class=\"na\">.text</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"nl\">global:</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"w\">        </span><span class=\"nf\">movl</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">global_data</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"w\">        </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"nl\">tls:</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">        </span><span class=\"nf\">movl</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"no\">tls_data@tpoff</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"w\">        </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"w\">        </span><span class=\"na\">.section</span><span class=\"w\">        </span><span class=\"no\">.tbss</span><span class=\"p\">,</span><span class=\"s\">&quot;awT&quot;</span><span class=\"p\">,</span><span class=\"na\">@nobits</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"nl\">tls_data:</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"w\">        </span><span class=\"na\">.zero</span><span class=\"w\">   </span><span class=\"mi\">4</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"w\">        </span><span class=\"na\">.bss</span>\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a><span class=\"nl\">global_data:</span>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"w\">        </span><span class=\"na\">.zero</span><span class=\"w\">   </span><span class=\"mi\">4</span>\n</span></code></pre></div>\n<p>\u8bbf\u95ee\u5168\u5c40\u53d8\u91cf\u7684\u65f6\u5019\uff0c\u91c7\u7528\u7684\u662f\u5178\u578b\u7684 PC-relative \u65b9\u5f0f\u6765\u627e\u5230\u5168\u5c40\u53d8\u91cf <code>global_data</code> \u7684\u5730\u5740\uff1b\u8bbf\u95ee thread local \u53d8\u91cf\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u91c7\u7528\u4e86\u4e00\u4e2a\u6bd4\u8f83\u5c11\u89c1\u7684\u5199\u6cd5\uff1a<code>%fs:tls_data@tpoff</code>\uff0c\u5b83\u7684\u610f\u601d\u662f\u7531\u94fe\u63a5\u5668\u8ba1\u7b97\u51fa <code>tls_data</code> \u76f8\u5bf9 <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\u7684\u504f\u79fb\uff0c\u7136\u540e\u76f4\u63a5\u5199\u5230\u6307\u4ee4\u7684\u504f\u79fb\u91cc\u3002\u94fe\u63a5\u4ee5\u4e0a\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u770b\u5230\u6700\u7ec8\u7684\u4e8c\u8fdb\u5236\u662f\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"err\">0000000000001140</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">global</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"err\">1140:</span><span class=\"w\">       </span><span class=\"err\">89</span><span class=\"w\"> </span><span class=\"err\">3</span><span class=\"nf\">d</span><span class=\"w\"> </span><span class=\"no\">ce</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"no\">e</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"mi\">0x2ece</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">)</span><span class=\"w\">        </span><span class=\"c1\"># 4014 &lt;global_data&gt;</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"err\">1146:</span><span class=\"w\">       </span><span class=\"nf\">c3</span><span class=\"w\">                      </span><span class=\"no\">ret</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"err\">1147:</span><span class=\"w\">       </span><span class=\"err\">66</span><span class=\"w\"> </span><span class=\"err\">0</span><span class=\"nf\">f</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">nopw</span><span class=\"w\">   </span><span class=\"mi\">0x0</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">,</span><span class=\"nv\">%rax</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"err\">114</span><span class=\"nl\">e:</span><span class=\"w\">       </span><span class=\"err\">00</span><span class=\"w\"> </span><span class=\"err\">00</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"err\">0000000000001150</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">tls</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"err\">1150:</span><span class=\"w\">       </span><span class=\"err\">64</span><span class=\"w\"> </span><span class=\"err\">89</span><span class=\"w\"> </span><span class=\"err\">3</span><span class=\"nf\">c</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"w\"> </span><span class=\"no\">fc</span><span class=\"w\"> </span><span class=\"no\">ff</span><span class=\"w\"> </span><span class=\"no\">ff</span><span class=\"w\">    </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"nv\">%edi</span><span class=\"p\">,</span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0xfffffffffffffffc</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"err\">1157:</span><span class=\"w\">       </span><span class=\"nf\">ff</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"err\">1158:</span><span class=\"w\">       </span><span class=\"nf\">c3</span><span class=\"w\">                      </span><span class=\"no\">ret</span>\n</span></code></pre></div>\n<p>\u53ef\u89c1\u6700\u7ec8 <code>global_data</code> \u88ab\u653e\u5230\u4e86\u76f8\u5bf9\u4e8c\u8fdb\u5236\u5f00\u5934 <code>0x4014</code> \u7684\u5730\u65b9\uff0c\u800c <code>tls_data</code> \u88ab\u653e\u5230\u4e86 <code>%fs:-0x4</code> \u7684\u4f4d\u7f6e\u3002\u90a3\u4e48\u8fd9\u4e2a <code>%fs</code> \u662f\u600e\u4e48\u5f97\u5230\u7684\uff0c<code>-0x4</code> \u7684\u504f\u79fb\u53c8\u662f\u600e\u4e48\u8ba1\u7b97\u7684\u5462\uff1f\u4e0b\u9762\u6765\u8fdb\u4e00\u6b65\u7814\u7a76\u80cc\u540e\u7684\u5b9e\u73b0\u3002</p>\n<h2 id=\"tls-\u7684\u7ec4\u7ec7\u65b9\u5f0f\">TLS \u7684\u7ec4\u7ec7\u65b9\u5f0f<a class=\"headerlink\" href=\"#tls-\u7684\u7ec4\u7ec7\u65b9\u5f0f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148 TLS \u662f per-thread \u7684\u5b58\u50a8\uff0c\u610f\u5473\u7740\u6bcf\u4e2a\u65b0\u7ebf\u7a0b\uff0c\u90fd\u6709\u4e00\u4e2a buffer \u9700\u8981\u4fdd\u5b58 TLS \u7684\u6570\u636e\u3002\u90a3\u4e48\u8fd9\u4e2a\u6570\u636e\u6240\u5728\u7684\u4f4d\u7f6e\uff0c\u4e5f\u9700\u8981\u4e00\u4e9b per-thread \u7684\u9ad8\u6548\u65b9\u5f0f\u6765\u8bbf\u95ee\uff0c\u5728 amd64 \u4e0a\uff0c\u5b83\u662f\u901a\u8fc7 <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\u6765\u7ef4\u62a4\u7684\u3002\u90a3\u4e48 TLS \u53ef\u80fd\u6709\u54ea\u4e9b\u6765\u6e90\u5462\uff1f\u9996\u5148\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\u53ef\u80fd\u4f1a\u7528\u4e00\u4e9b\uff0c\u5b83\u901a\u8fc7 DT_NEEDED \u7531\u52a8\u6001\u94fe\u63a5\u5668\u5728\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u4e5f\u6709\u4e00\u4e9b\uff08\u6bd4\u5982 <a href=\"../../../03/30/glibc-allocator/\">glibc \u7684 tcache</a>\uff09\uff0c\u6b64\u5916\u8fd0\u884c\u65f6 dlopen \u4e86\u4e00\u4e9b\u52a8\u6001\u5e93\u4e5f\u4f1a\u6709 TLS \u7684\u9700\u6c42\u3002\u4e3a\u4e86\u6ee1\u8db3\u8fd9\u4e9b\u9700\u6c42\uff0c\u9700\u8981\u8bbe\u8ba1\u4e00\u4e2a TLS \u7684\u7ed3\u6784\uff0c\u65e2\u80fd\u6ee1\u8db3\u8fd9\u4e9b\u5728\u542f\u52a8\u65f6\u5df2\u77e5\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u7684\u9700\u6c42\uff0c\u53c8\u80fd\u6ee1\u8db3\u8fd0\u884c\u65f6\u52a8\u6001\u52a0\u8f7d\u7684\u65b0\u52a8\u6001\u5e93\u7684\u9700\u6c42\u3002</p>\n<p>\u8fd9\u91cc\u9762\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684\u9700\u6c42\u662f\u660e\u786e\u7684\uff0c\u4e0d\u4f1a\u53d8\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u7531\u52a8\u6001\u94fe\u63a5\u5668\u5728\u52a0\u8f7d\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u7ed9\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u5206\u914d TLS \u7a7a\u95f4\uff1a</p>\n<ol>\n<li>\u6bd4\u5982\u53ef\u6267\u884c\u7a0b\u5e8f\u672c\u8eab\u9700\u8981 0x10 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u5b83\u542f\u52a8\u65f6\u52a0\u8f7d\u4e24\u4e2a\u52a8\u6001\u5e93 libc.so.6 \u548c libstdc++.so.6\uff0c\u671f\u4e2d libc.so.6 \u9700\u8981 0x20 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0clibstdc++.so.6 \u9700\u8981 0x30 \u5b57\u8282\u7684 TLS \u7a7a\u95f4</li>\n<li>\u52a0\u8d77\u6765\u4e00\u5171\u9700\u8981 0x60 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u90a3\u4e48\u5728\u521b\u5efa\u7ebf\u7a0b\u7684\u65f6\u5019\uff0c\u521b\u5efa\u597d 0x60 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u6309\u7167\u987a\u5e8f\u8fdb\u884c\u5206\u914d\uff1a<ol>\n<li>0x00-0x10: \u5c5e\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f</li>\n<li>0x10-0x30: \u5c5e\u4e8e libc.so.6</li>\n<li>0x30-0x60: \u5c5e\u4e8e libstdc++.so.6</li>\n</ol>\n</li>\n<li>\u5206\u914d\u597d\u8fd9\u4e2a\u7a7a\u95f4\u4ee5\u540e\uff0c\u56e0\u4e3a libc.so.6 \u65e0\u6cd5\u63d0\u524d\u9884\u77e5\u5b83\u4f1a\u88ab\u5206\u914d\u5230\u54ea\u4e2a\u4f4d\u7f6e\uff0c\u6240\u4ee5\u9700\u8981\u4e00\u6b21\u91cd\u5b9a\u4f4d\uff0c\u628a libc.so.6 \u91cc\u7684 TLS \u7a7a\u95f4\u7684\u4f7f\u7528\u91cd\u5b9a\u4f4d\u5230\u5206\u914d\u540e\u7684\u4f4d\u7f6e\uff0c\u4f8b\u5982 libc.so.6 \u7684 0x20 \u7684 TLS \u7a7a\u95f4\u5185\u7684\u5f00\u5934 8 \u5b57\u8282\uff0c\u73b0\u5728\u5728\u6574\u4e2a TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\u5c31\u662f <code>0x20 + 8 = 0x28</code></li>\n</ol>\n<p>\u4f46\u662f dlopen \u52a8\u6001\u52a0\u8f7d\u8fdb\u6765\u7684\u52a8\u6001\u5e93\u600e\u4e48\u529e\u5462\uff1f\u8fd9\u4e9b\u52a8\u6001\u5e93\u7684\u6570\u91cf\u53ef\u4ee5\u52a8\u6001\u53d8\u5316\uff0c\u53ef\u4ee5\u52a0\u8f7d\u4e5f\u53ef\u4ee5\u5378\u8f7d\uff0c\u518d\u8fd9\u4e48\u7ebf\u6027\u5206\u914d\u5c31\u4e0d\u5408\u9002\u4e86\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u7ed9\u6bcf\u4e2a dlopen \u5f97\u5230\u7684\u52a8\u6001\u5e93\u5206\u914d\u72ec\u7acb\u7684 TLS \u7a7a\u95f4\u3002\u65e2\u7136\u662f\u52a8\u6001\u5206\u914d\u7684\u7a7a\u95f4\uff0c\u90a3\u4e48\u8fd9\u4e9b\u72ec\u7acb\u7684 TLS \u7a7a\u95f4\u7684\u5730\u5740\uff0c\u4e0d\u540c\u7ebf\u7a0b\u4e0d\u540c\uff0c\u4e0d\u80fd\u901a\u8fc7\u4e00\u4e2a\u57fa\u5730\u5740\u52a0\u56fa\u5b9a\u504f\u79fb\u7684\u65b9\u5f0f\u6765\u8ba1\u7b97\uff0c\u5c31\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u673a\u5236\u6765\u627e\u5230\u5404\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u5730\u5740\u3002</p>\n<p>glibc \u7684\u5b9e\u73b0\u4e2d\uff0c\u5b83\u628a\u5404\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u8bb0\u5f55\u5728\u4e00\u4e2a <code>dtv</code> \u6570\u7ec4\u4e2d\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e00\u4e2a <code>__tls_get_addr</code> \u51fd\u6570\u6765\u67e5\u8be2\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u5185\u6307\u5b9a offset \u7684\u5b9e\u9645\u5730\u5740\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dl_tls_index</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_module</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tls_index</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"nf\">__tls_get_addr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tls_index</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ti</span><span class=\"p\">)</span>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"w\">  </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">THREAD_DTV</span><span class=\"w\"> </span><span class=\"p\">();</span>\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">dtv</span><span class=\"p\">[</span><span class=\"n\">ti</span><span class=\"o\">-&gt;</span><span class=\"n\">ti_module</span><span class=\"p\">].</span><span class=\"n\">pointer</span><span class=\"p\">.</span><span class=\"n\">val</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a>\n</span><span id=\"__span-4-18\"><a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\" href=\"#__codelineno-4-18\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">ti</span><span class=\"o\">-&gt;</span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-19\"><a id=\"__codelineno-4-19\" name=\"__codelineno-4-19\" href=\"#__codelineno-4-19\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>dtv</code> \u6570\u7ec4\u7684\u6307\u9488\u4fdd\u5b58\u5728 <code>struct pthread</code>\uff08\u5373 Thread Control Block (TCB)\uff09\u4e2d\uff0c\u800c\u8fd9\u4e2a <code>struct pthread</code> \u5c31\u4fdd\u5b58\u5728 <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\u6307\u5411\u7684\u5730\u5740\u4e0a\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pthread</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\">  </span><span class=\"n\">tcbhead_t</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\">  </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\">  </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"n\">stack_guard</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-13\"><a id=\"__codelineno-5-13\" name=\"__codelineno-5-13\" href=\"#__codelineno-5-13\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-5-14\"><a id=\"__codelineno-5-14\" name=\"__codelineno-5-14\" href=\"#__codelineno-5-14\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcbhead_t</span><span class=\"p\">;</span>\n</span><span id=\"__span-5-15\"><a id=\"__codelineno-5-15\" name=\"__codelineno-5-15\" href=\"#__codelineno-5-15\"></a>\n</span><span id=\"__span-5-16\"><a id=\"__codelineno-5-16\" name=\"__codelineno-5-16\" href=\"#__codelineno-5-16\"></a><span class=\"cp\"># define THREAD_DTV() \\</span>\n</span><span id=\"__span-5-17\"><a id=\"__codelineno-5-17\" name=\"__codelineno-5-17\" href=\"#__codelineno-5-17\"></a><span class=\"cp\">  ({ struct pthread *__pd;                            \\</span>\n</span><span id=\"__span-5-18\"><a id=\"__codelineno-5-18\" name=\"__codelineno-5-18\" href=\"#__codelineno-5-18\"></a><span class=\"cp\">     THREAD_GETMEM (__pd, header.dtv); })</span>\n</span></code></pre></div>\n<p>P.S. stack protector \u6240\u4f7f\u7528\u7684 canary \u7684\u503c\u5c31\u4fdd\u5b58\u5728 <code>pthread.header.stack_guard</code> \u5b57\u6bb5\u4e2d\uff0c\u4e5f\u5c31\u662f\u5728 <code>%fs:40</code> \u4f4d\u7f6e\u3002</p>\n<p>\u800c\u4e4b\u524d\u63d0\u5230\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u672c\u8eab\u7684 TLS \u7a7a\u95f4\u4ee5\u53ca\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff0c\u5b9e\u9645\u4e0a\u662f\u4fdd\u5b58\u5728 <code>struct thread</code> \u4e5f\u5c31\u662f TCB \u524d\u9762\u7684\u90e8\u5206\uff0c\u4ece\u9ad8\u5730\u5740\u5f80\u4f4e\u5730\u5740\u5206\u914d\uff08\u56fe\u7247\u6765\u6e90\uff1a<a href=\"https://www.akkadia.org/drepper/tls.pdf\">ELF Handling For Thread-Local Storage</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../tls-internals-ds.png\" /></p>\n<p>\u56fe\u4e2d <span class=\"arithmatex\">\\(tp_t\\)</span> \u5728 amd64 \u4e0b\u5c31\u662f <code>%fs</code> \u6bb5\u5bc4\u5b58\u5668\uff0c\u5b83\u76f4\u63a5\u6307\u5411\u7684\u5c31\u662f <code>struct thread</code> \u4e5f\u5c31\u662f TCB\uff1b\u4ece <code>%fs</code> \u5f00\u59cb\u5f80\u4f4e\u5730\u5740\uff0c\u5148\u5206\u914d\u53ef\u6267\u884c\u7a0b\u5e8f\u672c\u8eab\u7684 TLS \u7a7a\u95f4\uff08\u56fe\u4e2d <span class=\"arithmatex\">\\(tlsoffset_1\\)</span> \u5230 <span class=\"arithmatex\">\\(tp_t\\)</span> \u7684\u8303\u56f4\uff09\uff0c\u540e\u5206\u914d\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff08\u56fe\u4e2d <span class=\"arithmatex\">\\(tlsoffset_1\\)</span> \u5230 <span class=\"arithmatex\">\\(tlsoffset_2\\)</span> \u4ee5\u53ca <span class=\"arithmatex\">\\(tlsoffset_3\\)</span> \u5230 <span class=\"arithmatex\">\\(tlsoffset_2\\)</span> \u7684\u8303\u56f4\uff09\u3002\u6ce8\u610f\u8fd9\u4e9b\u504f\u79fb\u5bf9\u4e8e\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u662f\u76f8\u540c\u7684\uff0c\u53ea\u662f\u4e0d\u540c\u7ebf\u7a0b\u7684 <code>%fs</code> \u5bc4\u5b58\u5668\u4e0d\u540c\u3002</p>\n<p>\u800c\u5bf9\u4e8e dlopen \u52a8\u6001\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u5219 TLS \u7a7a\u95f4\u9700\u8981\u52a8\u6001\u5206\u914d\uff0c\u7136\u540e\u901a\u8fc7 <code>dtv</code> \u6570\u7ec4\u6765\u7d22\u5f15\uff08\u56fe\u4e2d <span class=\"arithmatex\">\\(dtv_{t,4}\\)</span> \u548c <span class=\"arithmatex\">\\(dtv_{t,5}\\)</span>\uff09\uff0c\u56e0\u6b64\u65e0\u6cd5\u901a\u8fc7\u91cd\u5b9a\u4f4d\u4fee\u6b63\uff0c\u800c\u662f\u8981\u5728\u8fd0\u884c\u65f6\u901a\u8fc7 <code>__tls_get_addr</code> \u51fd\u6570\u83b7\u53d6\u5730\u5740\u3002\u4e3a\u4e86\u8ba9 <code>__tls_get_addr</code> \u66f4\u5177\u6709\u901a\u7528\u6027\uff0c<code>dtv</code> \u6570\u7ec4\u4e5f\u8bb0\u5f55\u4e86\u5206\u914d\u5728 <code>%fs</code> \u6307\u5411\u7684 TCB \u66f4\u4f4e\u5730\u5740\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff0c\u6b64\u65f6 <code>__tls_get_addr</code> \u53ef\u4ee5\u67e5\u5230\u6240\u6709 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002\u6bcf\u4e2a\u52a8\u6001\u5e93\u5728 <code>dtv</code> \u6570\u7ec4\u4e2d\u90fd\u8bb0\u5f55\u4e86\u4fe1\u606f\uff0c\u90a3\u4e48\u8fd9\u4e2a\u52a8\u6001\u5e93\u5728 <code>dtv</code> \u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff0c\u8bb0\u4e3a\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff08module id\uff09\uff0c\u540e\u9762\u4f1a\u591a\u6b21\u51fa\u73b0\u8fd9\u4e2a\u6982\u5ff5\u3002</p>\n<p>\u77e5\u9053\u4e86 TLS \u7684\u7ec4\u7ec7\u65b9\u5f0f\u540e\uff0c\u63a5\u4e0b\u6765\u89c2\u5bdf\u7f16\u8bd1\u5668\u3001\u94fe\u63a5\u5668\u548c\u52a8\u6001\u94fe\u63a5\u5668\u662f\u5982\u4f55\u914d\u5408\u7740\u8ba9\u4ee3\u7801\u53ef\u4ee5\u627e\u5230\u6b63\u786e\u7684 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002</p>\n<h2 id=\"\u53ef\u6267\u884c\u7a0b\u5e8f\">\u53ef\u6267\u884c\u7a0b\u5e8f<a class=\"headerlink\" href=\"#\u53ef\u6267\u884c\u7a0b\u5e8f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u6765\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u573a\u666f\uff1a\u53ef\u6267\u884c\u7a0b\u5e8f\u76f4\u63a5\u8bbf\u95ee\u81ea\u5df1\u5b9a\u4e49\u7684 TLS \u53d8\u91cf\u3002\u524d\u9762\u63d0\u5230\uff0c\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u7a7a\u95f4\u76f4\u63a5\u4fdd\u5b58\u5230 <code>%fs</code> \u5f80\u4e0b\u7684\u5730\u5740\uff0c\u56e0\u6b64\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u662f\u53ef\u4ee5\u63d0\u524d\u8ba1\u7b97\u5f97\u5230\u7684\u3002\u4e0b\u9762\u770b\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data2</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n</span></code></pre></div>\n<p>\u7f16\u8bd1\u5f97\u5230\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-s highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"n\">read_tls_data1</span><span class=\"o\">:</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"w\">        </span><span class=\"n\">movl</span><span class=\"w\">    </span><span class=\"o\">%fs:tls_data1@tpoff, %</span><span class=\"n\">eax</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"w\">        </span><span class=\"n\">ret</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"n\">read_tls_data2</span><span class=\"o\">:</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a><span class=\"w\">        </span><span class=\"n\">movl</span><span class=\"w\">    </span><span class=\"o\">%fs:tls_data2@tpoff, %</span><span class=\"n\">eax</span>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"w\">        </span><span class=\"n\">ret</span>\n</span></code></pre></div>\n<p>\u8fd9\u5c31\u662f\u5728\u672c\u6587\u4e00\u5f00\u5934\u5c31\u770b\u5230\u7684\u8bed\u6cd5\uff1a<code>%fs:symbol@tpoff</code>\uff0c\u5b83\u4f1a\u5bf9\u5e94\u4e00\u4e2a <code>R_X86_64_TPOFF32</code> \u7c7b\u578b\u7684\u91cd\u5b9a\u4f4d\uff0c\u544a\u8bc9\u94fe\u63a5\u5668\uff0c\u8fd9\u662f\u4e00\u4e2a TLS \u53d8\u91cf\uff0c\u5e76\u4e14\u5b83\u7684\u504f\u79fb\u5728\u9759\u6001\u94fe\u63a5\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u6765\uff0c\u5e76\u4e14\u8fd9\u4e2a\u504f\u79fb\u4f1a\u76f4\u63a5\u5199\u5230 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u5185\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-c<span class=\"w\"> </span>tls.c<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0x0,%eax\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"w\">   </span><span class=\"m\">7</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"w\">                        </span><span class=\"m\">4</span>:<span class=\"w\"> </span>R_X86_64_TPOFF32<span class=\"w\">     </span>tls_data1\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"w\">   </span><span class=\"m\">8</span>:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a><span class=\"w\">   </span><span class=\"m\">9</span>:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a>\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a><span class=\"m\">0000000000000010</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a><span class=\"w\">  </span><span class=\"m\">10</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0x0,%eax\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a><span class=\"w\">  </span><span class=\"m\">17</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a><span class=\"w\">                        </span><span class=\"m\">14</span>:<span class=\"w\"> </span>R_X86_64_TPOFF32<span class=\"w\">    </span>tls_data2\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a><span class=\"w\">  </span><span class=\"m\">18</span>:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a><span class=\"m\">0000000000001140</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a><span class=\"w\">    </span><span class=\"m\">1140</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"nb\">fc</span><span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0xfffffffffffffffc,%eax\n</span><span id=\"__span-8-21\"><a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\" href=\"#__codelineno-8-21\"></a><span class=\"w\">    </span><span class=\"m\">1147</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-8-22\"><a id=\"__codelineno-8-22\" name=\"__codelineno-8-22\" href=\"#__codelineno-8-22\"></a><span class=\"w\">    </span><span class=\"m\">1148</span>:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-23\"><a id=\"__codelineno-8-23\" name=\"__codelineno-8-23\" href=\"#__codelineno-8-23\"></a><span class=\"w\">    </span><span class=\"m\">1149</span>:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>\n</span><span id=\"__span-8-24\"><a id=\"__codelineno-8-24\" name=\"__codelineno-8-24\" href=\"#__codelineno-8-24\"></a>\n</span><span id=\"__span-8-25\"><a id=\"__codelineno-8-25\" name=\"__codelineno-8-25\" href=\"#__codelineno-8-25\"></a><span class=\"m\">0000000000001150</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-8-26\"><a id=\"__codelineno-8-26\" name=\"__codelineno-8-26\" href=\"#__codelineno-8-26\"></a><span class=\"w\">    </span><span class=\"m\">1150</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">25</span><span class=\"w\"> </span>f8<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">    </span>mov<span class=\"w\">    </span>%fs:0xfffffffffffffff8,%eax\n</span><span id=\"__span-8-27\"><a id=\"__codelineno-8-27\" name=\"__codelineno-8-27\" href=\"#__codelineno-8-27\"></a><span class=\"w\">    </span><span class=\"m\">1157</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-8-28\"><a id=\"__codelineno-8-28\" name=\"__codelineno-8-28\" href=\"#__codelineno-8-28\"></a><span class=\"w\">    </span><span class=\"m\">1158</span>:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-8-29\"><a id=\"__codelineno-8-29\" name=\"__codelineno-8-29\" href=\"#__codelineno-8-29\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-t<span class=\"w\"> </span>tls\n</span><span id=\"__span-8-30\"><a id=\"__codelineno-8-30\" name=\"__codelineno-8-30\" href=\"#__codelineno-8-30\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-8-31\"><a id=\"__codelineno-8-31\" name=\"__codelineno-8-31\" href=\"#__codelineno-8-31\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>g<span class=\"w\">       </span>.tbss<span class=\"w\">  </span><span class=\"m\">0000000000000004</span><span class=\"w\">              </span>tls_data2\n</span><span id=\"__span-8-32\"><a id=\"__codelineno-8-32\" name=\"__codelineno-8-32\" href=\"#__codelineno-8-32\"></a><span class=\"m\">0000000000000004</span><span class=\"w\"> </span>g<span class=\"w\">       </span>.tbss<span class=\"w\">  </span><span class=\"m\">0000000000000004</span><span class=\"w\">              </span>tls_data1\n</span></code></pre></div>\n<p>\u6839\u636e\u4ee5\u4e0a\u8f93\u51fa\u53ef\u4ee5\u770b\u5230\uff0c\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\u4f7f\u7528\u4e86 8 \u5b57\u8282\u7684 TLS \u7a7a\u95f4\uff0c\u5176\u4e2d\u4f4e 4 \u5b57\u8282\u5bf9\u5e94 <code>tls_data2</code>\uff0c\u9ad8 4 \u5b57\u8282\u5bf9\u5e94 <code>tls_data1</code>\uff1b\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\uff0c\u94fe\u63a5\u5668\u5c31\u53ef\u4ee5\u63a8\u65ad\u51fa <code>tls_data2</code> \u4fdd\u5b58\u5728 <code>%fs-0x8</code> \u7684\u4f4d\u7f6e\uff0c<code>tls_data1</code> \u4fdd\u5b58\u5728 <code>%fs-0x4</code> \u7684\u4f4d\u7f6e\uff0c\u76f4\u63a5\u628a\u8fd9\u4e2a\u504f\u79fb\u7f16\u7801\u5230 <code>mov</code> \u6307\u4ee4\u5185\u3002\u8fd9\u6837\uff0c\u8fd0\u884c\u65f6\u5f00\u9500\u662f\u6700\u5c0f\u7684\u3002</p>\n<p>\u8fd9\u4e00\u79cd\u8bbf\u95ee TLS \u7684\u60c5\u51b5\uff0c\u4e5f\u53eb\u505a local exec TLS model\uff1a\u5b83\u53ea\u7528\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u8bbf\u95ee\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\u7684 TLS \u53d8\u91cf\u7684\u573a\u666f\u3002\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u7a7a\u95f4\u603b\u662f\u7d27\u8d34\u7740 <code>%fs</code> \u5206\u914d\uff0c\u4e0d\u4f1a\u53d7\u5230\u52a8\u6001\u5e93\u7684\u5f71\u54cd\uff0c\u56e0\u6b64\u53ef\u4ee5\u63d0\u524d\u8ba1\u7b97\u51fa\u5b83\u81ea\u5df1\u7684 TLS \u53d8\u91cf\u7684\u504f\u79fb\u3002</p>\n<h2 id=\"\u52a8\u6001\u5e93\">\u52a8\u6001\u5e93<a class=\"headerlink\" href=\"#\u52a8\u6001\u5e93\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf\u53e6\u4e00\u79cd\u60c5\u51b5\uff1a\u52a8\u6001\u5e93\u4f7f\u7528\u52a8\u6001\u5e93\u81ea\u5df1\u7684 TLS \u53d8\u91cf\u3002\u6309\u7167\u524d\u9762\u7684\u5206\u6790\uff0c\u6709\u4e24\u79cd\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u52a8\u6001\u5e93\u662f\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u88ab\u52a8\u6001\u94fe\u63a5\u5668\u52a0\u8f7d\uff0c\u90a3\u4e48\u5b83\u4f1a\u88ab\u5206\u914d\u5728 <code>%fs</code> \u5f80\u4f4e\u5730\u5740\u7684\u7a7a\u95f4\u3002\u867d\u7136\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u65e0\u6cd5\u5728\u94fe\u63a5\u9636\u6bb5\u5c31\u63d0\u524d\u5f97\u77e5\uff0c\u4f46\u662f\u52a8\u6001\u94fe\u63a5\u5668\u4f1a\u7ed9\u5b83\u5206\u914d\u8fde\u7eed\u7684 TLS \u7a7a\u95f4\uff0c\u4ece\u800c\u53ef\u4ee5\u8ba1\u7b97\u51fa\u5b83\u7684 TLS \u7a7a\u95f4\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u4e8e\u662f\u52a8\u6001\u94fe\u63a5\u5668\u53ef\u4ee5\u5e2e\u52a9\u5b8c\u6210\u5269\u4e0b\u7684\u91cd\u5b9a\u4f4d\u3002</li>\n<li>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u52a8\u6001\u5e93\u662f\u7531 dlopen \u88ab\u52a0\u8f7d\uff0c\u90a3\u4e48\u5b83\u88ab\u5206\u914d\u7684 TLS \u7a7a\u95f4\u7684\u5730\u5740\u5c31\u65e0\u6cd5\u4ece <code>%fs</code> \u76f4\u63a5\u8ba1\u7b97\u5f97\u51fa\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u501f\u52a9 <code>__tls_get_addr</code> \u51fd\u6570\u7684\u5e2e\u52a9\u3002</li>\n</ol>\n<h3 id=\"initial-exec-tls-model\">initial exec TLS model<a class=\"headerlink\" href=\"#initial-exec-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u6765\u770b\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u5b83\u4e5f\u88ab\u53eb\u505a initial exec TLS model\u3002\u8fd8\u662f\u4ece\u4f8b\u5b50\u5f00\u59cb\u770b\u8d77\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a>\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data2</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u9996\u5148\u89c2\u5bdf\u7f16\u8bd1\u51fa\u6765\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>initial-exec<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a>read_tls_data1:\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">        </span>movq<span class=\"w\">    </span>tls_data1@gottpoff<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rax\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-10-6\"><a id=\"__codelineno-10-6\" name=\"__codelineno-10-6\" href=\"#__codelineno-10-6\"></a><span class=\"w\">        </span>ret\n</span><span id=\"__span-10-7\"><a id=\"__codelineno-10-7\" name=\"__codelineno-10-7\" href=\"#__codelineno-10-7\"></a>\n</span><span id=\"__span-10-8\"><a id=\"__codelineno-10-8\" name=\"__codelineno-10-8\" href=\"#__codelineno-10-8\"></a>read_tls_data2:\n</span><span id=\"__span-10-9\"><a id=\"__codelineno-10-9\" name=\"__codelineno-10-9\" href=\"#__codelineno-10-9\"></a><span class=\"w\">        </span>movq<span class=\"w\">    </span>tls_data2@gottpoff<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rax\n</span><span id=\"__span-10-10\"><a id=\"__codelineno-10-10\" name=\"__codelineno-10-10\" href=\"#__codelineno-10-10\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-10-11\"><a id=\"__codelineno-10-11\" name=\"__codelineno-10-11\" href=\"#__codelineno-10-11\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u6b21\u751f\u6210\u7684\u6c47\u7f16\u4e0d\u540c\u4e86\uff1a\u5b83\u9996\u5148\u4ece <code>symbol@gottpoff(%rip)</code> \u8bfb\u53d6\u4e00\u4e2a offset \u5230 <code>%rax</code> \u5bc4\u5b58\u5668\uff0c\u518d\u4ece <code>%fs:(%rax)</code> \u5730\u5740\u8bfb\u53d6 TLS \u53d8\u91cf\u7684\u503c\u3002\u4e0a\u9762\u63d0\u5230\uff0c\u5728 initial exec TLS model \u4e0b\uff0cTLS \u7a7a\u95f4\u662f\u53ef\u4ee5\u76f8\u5bf9 <code>%fs</code> \u5bfb\u5740\u7684\uff0c\u4f46\u662f offset \u65e0\u6cd5\u63d0\u524d\u5f97\u77e5\uff0c\u9700\u8981\u7531\u52a8\u6001\u94fe\u63a5\u5668\u5b8c\u6210\u91cd\u5b9a\u4f4d\u3002</p>\n<p>\u56de\u5fc6\u4e4b\u524d\u5728<a href=\"../../../../2024/04/07/write-a-linker-4/\">\u300a\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff084\uff09\u300b</a>\u4e00\u6587\u4e2d\uff0c\u5f53\u52a8\u6001\u5e93\u60f3\u8981\u83b7\u5f97\u67d0\u4e2a\u53ea\u6709\u52a8\u6001\u94fe\u63a5\u5668\u624d\u77e5\u9053\u7684\u5730\u5740\uff0c\u5c31\u4f1a\u628a\u5b83\u9884\u7559\u597d\u4f4d\u7f6e\u653e\u5230 <code>.got</code> \u8868\u5f53\u4e2d\uff0c\u5e76\u4e14\u8f93\u51fa\u4e00\u4e2a dynamic relocation\uff0c\u544a\u8bc9\u52a8\u6001\u94fe\u63a5\u5668\u5982\u4f55\u628a\u5730\u5740\u8ba1\u7b97\u51fa\u6765\u5e76\u586b\u8fdb\u53bb\u3002\u5728\u8fd9\u91cc\uff0c\u539f\u7406\u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u53ea\u4e0d\u8fc7\u662f\u5728 <code>.got</code> \u8868\u4e2d\u9884\u7559\u4e86\u4e00\u4e2a\u7a7a\u95f4\u6765\u4fdd\u5b58 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u3002\u4e0b\u9762\u89c2\u5bdf\u5bf9\u8c61\u6587\u4ef6\u5185\u662f\u600e\u4e48\u8bb0\u5f55\u8fd9\u4e2a\u4fe1\u606f\u7684\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>tls.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-S<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 7 &lt;read_tls_data1+0x7&gt;</span>\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">                        </span><span class=\"m\">3</span>:<span class=\"w\"> </span>R_X86_64_GOTTPOFF<span class=\"w\">    </span>tls_data1-0x4\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">   </span><span class=\"m\">7</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">   </span>a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">   </span>b:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a><span class=\"m\">0000000000000010</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"w\">  </span><span class=\"m\">10</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 17 &lt;read_tls_data2+0x7&gt;</span>\n</span><span id=\"__span-11-13\"><a id=\"__codelineno-11-13\" name=\"__codelineno-11-13\" href=\"#__codelineno-11-13\"></a><span class=\"w\">                        </span><span class=\"m\">13</span>:<span class=\"w\"> </span>R_X86_64_GOTTPOFF<span class=\"w\">   </span>tls_data2-0x4\n</span><span id=\"__span-11-14\"><a id=\"__codelineno-11-14\" name=\"__codelineno-11-14\" href=\"#__codelineno-11-14\"></a><span class=\"w\">  </span><span class=\"m\">17</span>:<span class=\"w\">   </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-11-15\"><a id=\"__codelineno-11-15\" name=\"__codelineno-11-15\" href=\"#__codelineno-11-15\"></a><span class=\"w\">  </span>1a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u65f6\u5019\u5b83\u5728 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u4f4d\u7f6e\u521b\u5efa\u4e86\u4e00\u4e2a <code>R_X86_64_GOTTPOFF</code> \u7c7b\u578b\u7684\u91cd\u5b9a\u4f4d\uff0c\u8fd9\u662f\u544a\u8bc9\u94fe\u63a5\u5668\uff1a\u521b\u5efa\u4e00\u4e2a <code>.got</code> entry\uff0c\u91cc\u9762\u7531\u52a8\u6001\u94fe\u63a5\u5668\u586b\u5199\u5bf9\u5e94 symbol \u5728\u8fd0\u884c\u65f6\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u7136\u540e\u94fe\u63a5\u5668\u628a <code>.got</code> entry \u76f8\u5bf9 <code>mov</code> \u6307\u4ee4\u7684\u504f\u79fb\u5199\u5230 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u5185\u3002</p>\n<p>\u81f3\u4e8e\u4e3a\u5565\u662f <code>symbol-0x4</code> \u800c\u4e0d\u662f <code>symbol</code>\uff0c\u539f\u56e0\u5728\u4e4b\u524d<a href=\"../../../../2024/03/30/write-a-linker-2/\">\u300a\u5f00\u53d1\u4e00\u4e2a\u94fe\u63a5\u5668\uff082\uff09\u300b</a> \u5df2\u7ecf\u51fa\u73b0\u8fc7\uff1ax86 \u6307\u4ee4\u7684\u7acb\u5373\u6570\u504f\u79fb\u662f\u57fa\u4e8e\u6307\u4ee4\u7ed3\u5c3e\u7684\uff0c\u800c relocation \u6307\u5411\u7684\u662f\u7acb\u5373\u6570\u7684\u8d77\u59cb\u5730\u5740\uff0c\u4e5f\u5c31\u662f\u6307\u4ee4\u7ed3\u5c3e\u5730\u5740\u51cf\u53bb 4\uff0c\u90a3\u4e48\u7acb\u5373\u6570\u4e5f\u8981\u505a\u76f8\u5e94\u7684\u4fee\u6b63\u3002</p>\n<p>\u6700\u540e\uff0c\u89c2\u5bdf\u94fe\u63a5\u5668\u505a\u7684\u4e8b\u60c5\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-shared<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-12-2\"><a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\" href=\"#__codelineno-12-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-S<span class=\"w\"> </span>-R<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-12-3\"><a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\" href=\"#__codelineno-12-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-12-4\"><a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\" href=\"#__codelineno-12-4\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-12-5\"><a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\" href=\"#__codelineno-12-5\"></a>\n</span><span id=\"__span-12-6\"><a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\" href=\"#__codelineno-12-6\"></a><span class=\"m\">0000000000001100</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-12-7\"><a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\" href=\"#__codelineno-12-7\"></a><span class=\"w\">    </span><span class=\"m\">1100</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>d1<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ed1<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fd8 &lt;tls_data1+0x3fd4&gt;</span>\n</span><span id=\"__span-12-8\"><a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\" href=\"#__codelineno-12-8\"></a><span class=\"w\">    </span><span class=\"m\">1107</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-12-9\"><a id=\"__codelineno-12-9\" name=\"__codelineno-12-9\" href=\"#__codelineno-12-9\"></a><span class=\"w\">    </span>110a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-12-10\"><a id=\"__codelineno-12-10\" name=\"__codelineno-12-10\" href=\"#__codelineno-12-10\"></a><span class=\"w\">    </span>110b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-12-11\"><a id=\"__codelineno-12-11\" name=\"__codelineno-12-11\" href=\"#__codelineno-12-11\"></a>\n</span><span id=\"__span-12-12\"><a id=\"__codelineno-12-12\" name=\"__codelineno-12-12\" href=\"#__codelineno-12-12\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-12-13\"><a id=\"__codelineno-12-13\" name=\"__codelineno-12-13\" href=\"#__codelineno-12-13\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>a9<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ea9<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fc0 &lt;tls_data2+0x3fc0&gt;</span>\n</span><span id=\"__span-12-14\"><a id=\"__codelineno-12-14\" name=\"__codelineno-12-14\" href=\"#__codelineno-12-14\"></a><span class=\"w\">    </span><span class=\"m\">1117</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-12-15\"><a id=\"__codelineno-12-15\" name=\"__codelineno-12-15\" href=\"#__codelineno-12-15\"></a><span class=\"w\">    </span>111a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-12-16\"><a id=\"__codelineno-12-16\" name=\"__codelineno-12-16\" href=\"#__codelineno-12-16\"></a>\n</span><span id=\"__span-12-17\"><a id=\"__codelineno-12-17\" name=\"__codelineno-12-17\" href=\"#__codelineno-12-17\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.got:\n</span><span id=\"__span-12-18\"><a id=\"__codelineno-12-18\" name=\"__codelineno-12-18\" href=\"#__codelineno-12-18\"></a>\n</span><span id=\"__span-12-19\"><a id=\"__codelineno-12-19\" name=\"__codelineno-12-19\" href=\"#__codelineno-12-19\"></a>0000000000003fb8<span class=\"w\"> </span>&lt;.got&gt;:\n</span><span id=\"__span-12-20\"><a id=\"__codelineno-12-20\" name=\"__codelineno-12-20\" href=\"#__codelineno-12-20\"></a><span class=\"w\">        </span>...\n</span><span id=\"__span-12-21\"><a id=\"__codelineno-12-21\" name=\"__codelineno-12-21\" href=\"#__codelineno-12-21\"></a><span class=\"w\">                        </span>3fc0:<span class=\"w\"> </span>R_X86_64_TPOFF64<span class=\"w\">  </span>tls_data2\n</span><span id=\"__span-12-22\"><a id=\"__codelineno-12-22\" name=\"__codelineno-12-22\" href=\"#__codelineno-12-22\"></a><span class=\"w\">                        </span>3fd8:<span class=\"w\"> </span>R_X86_64_TPOFF64<span class=\"w\">  </span>tls_data1\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff1a</p>\n<ol>\n<li>\u94fe\u63a5\u5668\u4e3a\u4e24\u4e2a TLS \u53d8\u91cf\u5206\u522b\u521b\u5efa\u4e86\u4e00\u4e2a <code>.got</code> entry\uff0c<code>tls_data1</code> \u5bf9\u5e94 <code>0x3fd8</code>\uff0c<code>tls_data2</code> \u5bf9\u5e94 <code>0x3fc0</code></li>\n<li>\u94fe\u63a5\u5668\u5728\u8fd9\u4e24\u4e2a <code>.got</code> entry \u5904\u521b\u5efa\u4e86 dynamic relocation <code>R_X86_64_TPOFF64</code>\uff0c\u544a\u8bc9\u52a8\u6001\u94fe\u63a5\u5668\uff1a\u7ed9\u52a8\u6001\u5e93\u5206\u914d\u7a7a\u95f4\u540e\uff0c\u628a <code>tls_data1</code> \u548c <code>tls_data2</code> \u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5199\u5165\u5230\u8fd9\u4e24\u4e2a <code>.got</code> entry \u5185</li>\n<li>\n<p>\u94fe\u63a5\u5668\u8ba1\u7b97\u51fa\u4e86 <code>mov</code> \u6307\u4ee4\u548c <code>.got</code> entry \u7684\u76f8\u5bf9\u504f\u79fb\uff0c\u76f4\u63a5\u5199\u5230\u4e86 <code>mov</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u5f53\u4e2d\uff1a</p>\n<p><div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a><span class=\"m\">0000000000001100</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a><span class=\"w\">    </span><span class=\"m\">1100</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>d1<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ed1<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fd8 &lt;tls_data1+0x3fd4&gt;</span>\n</span><span id=\"__span-13-3\"><a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\" href=\"#__codelineno-13-3\"></a><span class=\"w\">    </span><span class=\"m\">1107</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-13-4\"><a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\" href=\"#__codelineno-13-4\"></a><span class=\"w\">    </span>110a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-13-5\"><a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\" href=\"#__codelineno-13-5\"></a><span class=\"w\">    </span>110b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-13-6\"><a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\" href=\"#__codelineno-13-6\"></a>\n</span><span id=\"__span-13-7\"><a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\" href=\"#__codelineno-13-7\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-13-8\"><a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\" href=\"#__codelineno-13-8\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\"> </span>a9<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>0x2ea9<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rax<span class=\"w\">        </span><span class=\"c1\"># 3fc0 &lt;tls_data2+0x3fc0&gt;</span>\n</span><span id=\"__span-13-9\"><a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\" href=\"#__codelineno-13-9\"></a><span class=\"w\">    </span><span class=\"m\">1117</span>:<span class=\"w\">       </span><span class=\"m\">64</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%fs:<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-13-10\"><a id=\"__codelineno-13-10\" name=\"__codelineno-13-10\" href=\"#__codelineno-13-10\"></a><span class=\"w\">    </span>111a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n4. \u90a3\u4e48\u5728\u8fd0\u884c\u65f6\uff0c\u4e3a\u4e86\u8bfb\u53d6 TLS \u53d8\u91cf\uff0c\u9996\u5148\u4ece <code>.got</code> \u8868\u8bfb\u53d6 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5199\u5230 <code>%rax</code> \u5bc4\u5b58\u5668\uff0c\u518d\u901a\u8fc7 <code>%fs:(%rax)</code> \u8bbf\u95ee TLS \u53d8\u91cf\u5373\u53ef</p>\n</li>\n</ol>\n<p>\u90a3\u4e48\u8fd9\u5c31\u662f initial exec TLS model \u7684\u5b9e\u73b0\u65b9\u6cd5\u4e86\uff1a\u5b83\u5229\u7528\u4e86\u52a8\u6001\u5e93\u4f1a\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u6027\u8d28\uff0c\u4fdd\u8bc1 TLS \u53d8\u91cf\u90fd\u4fdd\u5b58\u5728\u76f8\u5bf9 <code>%fs</code> \u7684\u8fd0\u884c\u65f6\u53ef\u77e5\u4e14\u4e0d\u53d8\u7684\u504f\u79fb\u4e0a\uff0c\u628a\u504f\u79fb\u8bb0\u5f55\u5728 <code>.got</code> \u8868\u4e2d\uff0c\u7531\u52a8\u6001\u94fe\u63a5\u5668\u53bb\u8ba1\u7b97\uff0c\u90a3\u4e48\u8bbf\u95ee\u7684\u65f6\u5019\u5c31\u5f88\u7b80\u5355\u4e86\uff0c\u76f4\u63a5\u8bfb\u53d6 offset \u4ece <code>%fs</code> \u8bbf\u95ee\u5373\u53ef\u3002</p>\n<h3 id=\"localglobal-dynamic-tls-model\">local/global dynamic TLS model<a class=\"headerlink\" href=\"#localglobal-dynamic-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u770b\u52a8\u6001\u5e93\u7684\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff1a\u5b83\u53ef\u80fd\u7531 dlopen \u52a0\u8f7d\uff0c\u56e0\u6b64 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u4f4d\u7f6e\u53ef\u80fd\u4f1a\u53d8\u5316\uff0c\u6b64\u65f6\u9700\u8981\u901a\u8fc7 <code>__tls_get_addr</code> \u51fd\u6570\u6765\u5f97\u5230 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002\u56de\u987e\u524d\u9762\u63d0\u5230\u7684 <code>__tls_get_addr</code> \u7684\u58f0\u660e\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dl_tls_index</span>\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-14-3\"><a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\" href=\"#__codelineno-14-3\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_module</span><span class=\"p\">;</span>\n</span><span id=\"__span-14-4\"><a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\" href=\"#__codelineno-14-4\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-14-5\"><a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\" href=\"#__codelineno-14-5\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tls_index</span><span class=\"p\">;</span>\n</span><span id=\"__span-14-6\"><a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\" href=\"#__codelineno-14-6\"></a>\n</span><span id=\"__span-14-7\"><a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\" href=\"#__codelineno-14-7\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">__tls_get_addr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tls_index</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ti</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5373\u5b83\u9700\u8981\u4e24\u4e2a\u4fe1\u606f\uff0c\u4e00\u4e2a\u662f TLS \u53d8\u91cf\u6240\u5728\u7684\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff08\u8fd9\u4e2a\u7f16\u53f7\u662f\u52a8\u6001\u751f\u6210\u7684\u4e00\u4e2a id\uff0c\u5b9e\u9645\u4e0a\u662f\u8fd9\u4e2a\u52a8\u6001\u5e93\u5728 <code>dtv</code> \u6570\u7ec4\u4e2d\u7684\u4e0b\u6807\uff09\uff0c\u53e6\u5916\u662f\u8fd9\u4e2a TLS \u53d8\u91cf\u5728\u52a8\u6001\u5e93\u5185\u7684\u504f\u79fb\u3002\u8fd9\u65f6\u5019\uff0c\u53c8\u5206\u4e3a\u4e24\u79cd\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u8fd9\u4e2a TLS \u53d8\u91cf\u5c31\u5728\u8fd9\u4e2a\u52a8\u6001\u5e93\u672c\u8eab\u5185\u90e8\u5b9a\u4e49\uff0c\u6b64\u65f6 TLS \u53d8\u91cf\u5728\u52a8\u6001\u5e93\u5185\u7684\u504f\u79fb\u5728\u94fe\u63a5\u671f\u95f4\u5df2\u77e5\uff0c\u53ea\u662f\u4e0d\u77e5\u9053 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u9700\u8981\u901a\u8fc7 <code>__tls_get_addr</code> \u51fd\u6570\u83b7\u53d6\uff0c\u8fd9\u79cd\u60c5\u666f\u53eb\u505a local dynamic TLS model</li>\n<li>\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\uff0c\u8fd9\u4e2a TLS \u53d8\u91cf\u4e0d\u77e5\u9053\u5728\u54ea\u4e2a\u52a8\u6001\u5e93\u5b9a\u4e49\uff0c\u6b64\u65f6\u53ea\u77e5\u9053\u8fd9\u4e2a TLS \u53d8\u91cf\u7684\u540d\u5b57\uff0c\u4e0d\u77e5\u9053\u5b83\u5c5e\u4e8e\u54ea\u4e2a\u52a8\u6001\u5e93\uff0c\u4e5f\u4e0d\u77e5\u9053\u5b83\u5728\u52a8\u6001\u5e93\u5185\u7684\u504f\u79fb\uff0c\u8fd9\u79cd\u60c5\u51b5\u53eb\u505a global dynamic TLS model\uff0c\u662f\u6700\u901a\u7528\u7684\u60c5\u51b5\uff0c\u5bf9 TLS \u53d8\u91cf\u6240\u5728\u7684\u4f4d\u7f6e\u6ca1\u6709\u4efb\u4f55\u5047\u8bbe</li>\n</ol>\n<h3 id=\"local-dynamic-tls-model\">local dynamic TLS model<a class=\"headerlink\" href=\"#local-dynamic-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u5206\u6790 local dynamic TLS model\uff0c\u5b83\u9762\u5411\u7684\u573a\u666f\u662f\u4e00\u4e2a\u53ef\u80fd\u88ab dlopen \u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u9700\u8981\u8bbf\u95ee\u81ea\u5df1\u7684 TLS \u53d8\u91cf\uff0c\u6b64\u65f6\u9700\u8981\u7528 <code>__tls_get_addr</code> \u8bfb\u53d6\u81ea\u5df1\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u6839\u636e\u94fe\u63a5\u65f6\u5df2\u77e5\u7684\u504f\u79fb\uff0c\u8ba1\u7b97\u51fa TLS \u53d8\u91cf\u5728\u8fd0\u884c\u65f6\u7684\u5730\u5740\u3002\u7531\u4e8e <code>__tls_get_addr</code> \u9700\u8981\u77e5\u9053\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff0c\u800c\u8fd9\u4e2a\u7f16\u53f7\u53ea\u6709\u52a8\u6001\u94fe\u63a5\u5668\u624d\u77e5\u9053\uff0c\u56e0\u6b64\u9700\u8981\u751f\u6210\u4e00\u4e2a dynamic relocation\uff0c\u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u628a\u8fd9\u4e2a\u52a8\u6001\u5e93\u81ea\u5df1\u7684\u7f16\u53f7\u5199\u5165\u5230 <code>.got</code> entry \u4e2d\uff0c\u4e4b\u540e\u624d\u80fd\u62ff\u8fd9\u4e2a <code>.got</code> entry \u7684\u503c\u8c03\u7528 <code>__tls_get_addr</code>\uff0c\u8fdb\u800c\u5f97\u5230 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002\u4e0b\u9762\u6765\u89c2\u5bdf\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u6e90\u7801\u548c\u4e4b\u524d\u4e00\u6837\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a>\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span><span id=\"__span-15-5\"><a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\" href=\"#__codelineno-15-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data2</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u9996\u5148\u67e5\u770b\u751f\u6210\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-16-1\"><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\" href=\"#__codelineno-16-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>local-dynamic<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-16-2\"><a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\" href=\"#__codelineno-16-2\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-16-3\"><a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\" href=\"#__codelineno-16-3\"></a>read_tls_data1:\n</span><span id=\"__span-16-4\"><a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\" href=\"#__codelineno-16-4\"></a>.LFB0:\n</span><span id=\"__span-16-5\"><a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\" href=\"#__codelineno-16-5\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-6\"><a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\" href=\"#__codelineno-16-6\"></a><span class=\"w\">        </span>leaq<span class=\"w\">    </span>tls_data1@tlsld<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-16-7\"><a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\" href=\"#__codelineno-16-7\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-16-8\"><a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\" href=\"#__codelineno-16-8\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>tls_data1@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-16-9\"><a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\" href=\"#__codelineno-16-9\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-10\"><a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\" href=\"#__codelineno-16-10\"></a><span class=\"w\">        </span>ret\n</span><span id=\"__span-16-11\"><a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\" href=\"#__codelineno-16-11\"></a>\n</span><span id=\"__span-16-12\"><a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\" href=\"#__codelineno-16-12\"></a>read_tls_data2:\n</span><span id=\"__span-16-13\"><a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\" href=\"#__codelineno-16-13\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-14\"><a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\" href=\"#__codelineno-16-14\"></a><span class=\"w\">        </span>leaq<span class=\"w\">    </span>tls_data2@tlsld<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-16-15\"><a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\" href=\"#__codelineno-16-15\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-16-16\"><a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\" href=\"#__codelineno-16-16\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>tls_data2@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-16-17\"><a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\" href=\"#__codelineno-16-17\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-16-18\"><a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\" href=\"#__codelineno-16-18\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u9996\u5148\u53ef\u4ee5\u770b\u5230\u7684\u662f\u4e00\u4e2a\u65b0\u7684\u8bed\u6cd5\uff1a<code>symbol@tlsld(%rip)</code>\uff0c\u751f\u6210\u4e00\u4e2a <code>R_X86_64_TLSLD</code> \u7c7b\u578b\u7684 relocation\uff0c\u5b83\u7684\u610f\u601d\u662f\u5728 <code>.got</code> \u8868\u4e2d\u751f\u6210\u4e00\u4e2a entry\uff0c\u8fd9\u4e2a entry \u4f1a\u4fdd\u5b58\u5f53\u524d\u52a8\u6001\u5e93\u5bf9\u5e94\u7684\u7f16\u53f7\uff0c\u7136\u540e\u5728\u8fd9\u91cc\u901a\u8fc7 <code>lea</code> \u6307\u4ee4\u628a\u8fd9\u4e2a <code>.got</code> entry \u7684\u5730\u5740\u4f5c\u4e3a <code>tls_index *</code> \u7c7b\u578b\u7684\u53c2\u6570\u4f20\u7ed9 <code>__tls_get_addr</code>\uff0c\u90a3\u4e48\u5b83\u5c31\u4f1a\u53bb\u5bfb\u627e\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u628a\u7ed3\u679c\u5199\u5165\u5230 <code>%rax</code> \u5bc4\u5b58\u5668\u5185\u3002</p>\n<p>\u5f97\u5230 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u540e\uff0c\u518d\u5229\u7528 <code>symbol@dtpoff(%rax)</code> \u7684\u8bed\u6cd5\uff0c\u751f\u6210 <code>R_X86_64_DTPOFF32</code> \u7c7b\u578b\u7684 relocation\uff0c\u5728\u94fe\u63a5\u7684\u65f6\u5019\u76f4\u63a5\u628a <code>symbol</code> \u76f8\u5bf9\u81ea\u5df1\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u7684\u504f\u79fb\u5199\u5230 <code>movl</code> \u6307\u4ee4\u5185\uff0c\u4ece\u800c\u5b9e\u73b0\u4e86 TLS \u53d8\u91cf\u7684\u8bbf\u95ee\u3002</p>\n<p>\u4e0b\u9762\u89c2\u5bdf\u751f\u6210\u7684\u5bf9\u8c61\u6587\u4ef6\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-17-1\"><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\" href=\"#__codelineno-17-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>tls.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-17-2\"><a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\" href=\"#__codelineno-17-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-17-3\"><a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\" href=\"#__codelineno-17-3\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-17-4\"><a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\" href=\"#__codelineno-17-4\"></a>\n</span><span id=\"__span-17-5\"><a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\" href=\"#__codelineno-17-5\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-17-6\"><a id=\"__codelineno-17-6\" name=\"__codelineno-17-6\" href=\"#__codelineno-17-6\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-7\"><a id=\"__codelineno-17-7\" name=\"__codelineno-17-7\" href=\"#__codelineno-17-7\"></a><span class=\"w\">   </span><span class=\"m\">4</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># b &lt;read_tls_data1+0xb&gt;</span>\n</span><span id=\"__span-17-8\"><a id=\"__codelineno-17-8\" name=\"__codelineno-17-8\" href=\"#__codelineno-17-8\"></a><span class=\"w\">                        </span><span class=\"m\">7</span>:<span class=\"w\"> </span>R_X86_64_TLSLD<span class=\"w\">       </span>tls_data1-0x4\n</span><span id=\"__span-17-9\"><a id=\"__codelineno-17-9\" name=\"__codelineno-17-9\" href=\"#__codelineno-17-9\"></a><span class=\"w\">   </span>b:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">10</span><span class=\"w\"> </span>&lt;read_tls_data1+0x10&gt;\n</span><span id=\"__span-17-10\"><a id=\"__codelineno-17-10\" name=\"__codelineno-17-10\" href=\"#__codelineno-17-10\"></a><span class=\"w\">                        </span>c:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">       </span>__tls_get_addr-0x4\n</span><span id=\"__span-17-11\"><a id=\"__codelineno-17-11\" name=\"__codelineno-17-11\" href=\"#__codelineno-17-11\"></a><span class=\"w\">  </span><span class=\"m\">10</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-17-12\"><a id=\"__codelineno-17-12\" name=\"__codelineno-17-12\" href=\"#__codelineno-17-12\"></a><span class=\"w\">                        </span><span class=\"m\">12</span>:<span class=\"w\"> </span>R_X86_64_DTPOFF32<span class=\"w\">   </span>tls_data1\n</span><span id=\"__span-17-13\"><a id=\"__codelineno-17-13\" name=\"__codelineno-17-13\" href=\"#__codelineno-17-13\"></a><span class=\"w\">  </span><span class=\"m\">16</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-14\"><a id=\"__codelineno-17-14\" name=\"__codelineno-17-14\" href=\"#__codelineno-17-14\"></a><span class=\"w\">  </span>1a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-17-15\"><a id=\"__codelineno-17-15\" name=\"__codelineno-17-15\" href=\"#__codelineno-17-15\"></a><span class=\"w\">  </span>1b:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-17-16\"><a id=\"__codelineno-17-16\" name=\"__codelineno-17-16\" href=\"#__codelineno-17-16\"></a>\n</span><span id=\"__span-17-17\"><a id=\"__codelineno-17-17\" name=\"__codelineno-17-17\" href=\"#__codelineno-17-17\"></a><span class=\"m\">0000000000000020</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-17-18\"><a id=\"__codelineno-17-18\" name=\"__codelineno-17-18\" href=\"#__codelineno-17-18\"></a><span class=\"w\">  </span><span class=\"m\">20</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-19\"><a id=\"__codelineno-17-19\" name=\"__codelineno-17-19\" href=\"#__codelineno-17-19\"></a><span class=\"w\">  </span><span class=\"m\">24</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 2b &lt;read_tls_data2+0xb&gt;</span>\n</span><span id=\"__span-17-20\"><a id=\"__codelineno-17-20\" name=\"__codelineno-17-20\" href=\"#__codelineno-17-20\"></a><span class=\"w\">                        </span><span class=\"m\">27</span>:<span class=\"w\"> </span>R_X86_64_TLSLD<span class=\"w\">      </span>tls_data2-0x4\n</span><span id=\"__span-17-21\"><a id=\"__codelineno-17-21\" name=\"__codelineno-17-21\" href=\"#__codelineno-17-21\"></a><span class=\"w\">  </span>2b:<span class=\"w\">   </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">30</span><span class=\"w\"> </span>&lt;read_tls_data2+0x10&gt;\n</span><span id=\"__span-17-22\"><a id=\"__codelineno-17-22\" name=\"__codelineno-17-22\" href=\"#__codelineno-17-22\"></a><span class=\"w\">                        </span>2c:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">      </span>__tls_get_addr-0x4\n</span><span id=\"__span-17-23\"><a id=\"__codelineno-17-23\" name=\"__codelineno-17-23\" href=\"#__codelineno-17-23\"></a><span class=\"w\">  </span><span class=\"m\">30</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-17-24\"><a id=\"__codelineno-17-24\" name=\"__codelineno-17-24\" href=\"#__codelineno-17-24\"></a><span class=\"w\">                        </span><span class=\"m\">32</span>:<span class=\"w\"> </span>R_X86_64_DTPOFF32<span class=\"w\">   </span>tls_data2\n</span><span id=\"__span-17-25\"><a id=\"__codelineno-17-25\" name=\"__codelineno-17-25\" href=\"#__codelineno-17-25\"></a><span class=\"w\">  </span><span class=\"m\">36</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-17-26\"><a id=\"__codelineno-17-26\" name=\"__codelineno-17-26\" href=\"#__codelineno-17-26\"></a><span class=\"w\">  </span>3a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e <code>__tls_get_addr</code> \u7684\u8fd0\u884c\u65f6\u5730\u5740\u4e5f\u662f\u4e0d\u77e5\u9053\u7684\uff0c\u6240\u4ee5\u5c31\u548c\u8c03\u7528\u5176\u4ed6\u52a8\u6001\u5e93\u7684\u51fd\u6570\u4e00\u6837\uff0c\u7528\u5df2\u6709\u7684 PLT \u673a\u5236\u53bb\u91cd\u5b9a\u4f4d\u3002</p>\n<p>\u63a5\u4e0b\u6765\u770b\u6700\u540e\u7684\u52a8\u6001\u5e93\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-18-1\"><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\" href=\"#__codelineno-18-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-shared<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-18-2\"><a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\" href=\"#__codelineno-18-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-R<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-18-3\"><a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\" href=\"#__codelineno-18-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-18-4\"><a id=\"__codelineno-18-4\" name=\"__codelineno-18-4\" href=\"#__codelineno-18-4\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-18-5\"><a id=\"__codelineno-18-5\" name=\"__codelineno-18-5\" href=\"#__codelineno-18-5\"></a>\n</span><span id=\"__span-18-6\"><a id=\"__codelineno-18-6\" name=\"__codelineno-18-6\" href=\"#__codelineno-18-6\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-18-7\"><a id=\"__codelineno-18-7\" name=\"__codelineno-18-7\" href=\"#__codelineno-18-7\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-8\"><a id=\"__codelineno-18-8\" name=\"__codelineno-18-8\" href=\"#__codelineno-18-8\"></a><span class=\"w\">    </span><span class=\"m\">1114</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span>9d<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x2e9d<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fb8 &lt;_DYNAMIC+0x1c0&gt;</span>\n</span><span id=\"__span-18-9\"><a id=\"__codelineno-18-9\" name=\"__codelineno-18-9\" href=\"#__codelineno-18-9\"></a><span class=\"w\">    </span>111b:<span class=\"w\">       </span>e8<span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-18-10\"><a id=\"__codelineno-18-10\" name=\"__codelineno-18-10\" href=\"#__codelineno-18-10\"></a><span class=\"w\">    </span><span class=\"m\">1120</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">04</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x4<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-18-11\"><a id=\"__codelineno-18-11\" name=\"__codelineno-18-11\" href=\"#__codelineno-18-11\"></a><span class=\"w\">    </span><span class=\"m\">1126</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-12\"><a id=\"__codelineno-18-12\" name=\"__codelineno-18-12\" href=\"#__codelineno-18-12\"></a><span class=\"w\">    </span>112a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-18-13\"><a id=\"__codelineno-18-13\" name=\"__codelineno-18-13\" href=\"#__codelineno-18-13\"></a><span class=\"w\">    </span>112b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-18-14\"><a id=\"__codelineno-18-14\" name=\"__codelineno-18-14\" href=\"#__codelineno-18-14\"></a>\n</span><span id=\"__span-18-15\"><a id=\"__codelineno-18-15\" name=\"__codelineno-18-15\" href=\"#__codelineno-18-15\"></a><span class=\"m\">0000000000001130</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-18-16\"><a id=\"__codelineno-18-16\" name=\"__codelineno-18-16\" href=\"#__codelineno-18-16\"></a><span class=\"w\">    </span><span class=\"m\">1130</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-17\"><a id=\"__codelineno-18-17\" name=\"__codelineno-18-17\" href=\"#__codelineno-18-17\"></a><span class=\"w\">    </span><span class=\"m\">1134</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span>7d<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>lea<span class=\"w\">    </span>0x2e7d<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fb8 &lt;_DYNAMIC+0x1c0&gt;</span>\n</span><span id=\"__span-18-18\"><a id=\"__codelineno-18-18\" name=\"__codelineno-18-18\" href=\"#__codelineno-18-18\"></a><span class=\"w\">    </span>113b:<span class=\"w\">       </span>e8<span class=\"w\"> </span>f0<span class=\"w\"> </span>fe<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">          </span>call<span class=\"w\">   </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-18-19\"><a id=\"__codelineno-18-19\" name=\"__codelineno-18-19\" href=\"#__codelineno-18-19\"></a><span class=\"w\">    </span><span class=\"m\">1140</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>0x0<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-18-20\"><a id=\"__codelineno-18-20\" name=\"__codelineno-18-20\" href=\"#__codelineno-18-20\"></a><span class=\"w\">    </span><span class=\"m\">1146</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-18-21\"><a id=\"__codelineno-18-21\" name=\"__codelineno-18-21\" href=\"#__codelineno-18-21\"></a><span class=\"w\">    </span>114a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-18-22\"><a id=\"__codelineno-18-22\" name=\"__codelineno-18-22\" href=\"#__codelineno-18-22\"></a>\n</span><span id=\"__span-18-23\"><a id=\"__codelineno-18-23\" name=\"__codelineno-18-23\" href=\"#__codelineno-18-23\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.got:\n</span><span id=\"__span-18-24\"><a id=\"__codelineno-18-24\" name=\"__codelineno-18-24\" href=\"#__codelineno-18-24\"></a>\n</span><span id=\"__span-18-25\"><a id=\"__codelineno-18-25\" name=\"__codelineno-18-25\" href=\"#__codelineno-18-25\"></a>0000000000003fb8<span class=\"w\"> </span>&lt;.got&gt;:\n</span><span id=\"__span-18-26\"><a id=\"__codelineno-18-26\" name=\"__codelineno-18-26\" href=\"#__codelineno-18-26\"></a><span class=\"w\">        </span>...\n</span><span id=\"__span-18-27\"><a id=\"__codelineno-18-27\" name=\"__codelineno-18-27\" href=\"#__codelineno-18-27\"></a><span class=\"w\">                        </span>3fb8:<span class=\"w\"> </span>R_X86_64_DTPMOD64<span class=\"w\"> </span>*ABS*\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u65e0\u8bba\u662f\u8bbf\u95ee <code>tls_data1</code> \u8fd8\u662f <code>tls_data2</code>\uff0c\u5728\u8c03\u7528 <code>__tls_get_addr</code> \u65f6\uff0c\u4f7f\u7528\u7684\u53c2\u6570\u90fd\u662f\u4e00\u6837\u7684 <code>0x3fb8</code>\uff0c\u4e5f\u5c31\u662f\u52a8\u6001\u94fe\u63a5\u5668\u628a\u5f53\u524d\u52a8\u6001\u5e93\u7684\u7f16\u53f7\u5199\u8fdb\u53bb\u7684 <code>.got</code> entry\u3002\u8fd4\u56de\u503c\u5c31\u662f\u5f53\u524d\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u57fa\u5730\u5740\uff0c\u628a\u8fd4\u56de\u503c\u52a0\u4e0a\u5bf9\u5e94\u7684 offset\uff08<code>tls_data1</code> \u7684\u504f\u79fb\u662f 4\uff0c<code>tls_data2</code> \u7684\u504f\u79fb\u662f 0\uff0c\u8fd9\u4e2a offset \u76f4\u63a5\u5199\u5230\u4e86 <code>movl</code> \u6307\u4ee4\u7684\u7acb\u5373\u6570\u91cc\uff09\uff0c\u5c31\u5f97\u5230\u4e86 TLS \u53d8\u91cf\u7684\u5730\u5740\u3002</p>\n<p>\u7279\u522b\u5730\uff0c\u5982\u679c\u5728\u4e00\u4e2a\u51fd\u6570\u91cc\u8bbf\u95ee\u591a\u4e2a\u5f53\u524d\u52a8\u6001\u5e93\u7684 TLS \u53d8\u91cf\uff0c\u90a3\u4e48 <code>__tls_get_addr</code> \u8c03\u7528\u662f\u53ef\u4ee5\u5408\u5e76\u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-19-1\"><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\" href=\"#__codelineno-19-1\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"p\">;</span>\n</span><span id=\"__span-19-2\"><a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\" href=\"#__codelineno-19-2\"></a><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span>\n</span><span id=\"__span-19-3\"><a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\" href=\"#__codelineno-19-3\"></a>\n</span><span id=\"__span-19-4\"><a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\" href=\"#__codelineno-19-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">read_tls_data</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_data1</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">tls_data2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4f1a\u751f\u6210\u5982\u4e0b\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-20-1\"><a id=\"__codelineno-20-1\" name=\"__codelineno-20-1\" href=\"#__codelineno-20-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>local-dynamic<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-20-2\"><a id=\"__codelineno-20-2\" name=\"__codelineno-20-2\" href=\"#__codelineno-20-2\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-20-3\"><a id=\"__codelineno-20-3\" name=\"__codelineno-20-3\" href=\"#__codelineno-20-3\"></a>read_tls_data:\n</span><span id=\"__span-20-4\"><a id=\"__codelineno-20-4\" name=\"__codelineno-20-4\" href=\"#__codelineno-20-4\"></a>.LFB0:\n</span><span id=\"__span-20-5\"><a id=\"__codelineno-20-5\" name=\"__codelineno-20-5\" href=\"#__codelineno-20-5\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-20-6\"><a id=\"__codelineno-20-6\" name=\"__codelineno-20-6\" href=\"#__codelineno-20-6\"></a><span class=\"w\">        </span>leaq<span class=\"w\">    </span>tls_data1@tlsld<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-20-7\"><a id=\"__codelineno-20-7\" name=\"__codelineno-20-7\" href=\"#__codelineno-20-7\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-20-8\"><a id=\"__codelineno-20-8\" name=\"__codelineno-20-8\" href=\"#__codelineno-20-8\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>tls_data1@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%edx\n</span><span id=\"__span-20-9\"><a id=\"__codelineno-20-9\" name=\"__codelineno-20-9\" href=\"#__codelineno-20-9\"></a><span class=\"w\">        </span>addl<span class=\"w\">    </span>tls_data2@dtpoff<span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%edx\n</span><span id=\"__span-20-10\"><a id=\"__codelineno-20-10\" name=\"__codelineno-20-10\" href=\"#__codelineno-20-10\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-20-11\"><a id=\"__codelineno-20-11\" name=\"__codelineno-20-11\" href=\"#__codelineno-20-11\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span>%edx,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-20-12\"><a id=\"__codelineno-20-12\" name=\"__codelineno-20-12\" href=\"#__codelineno-20-12\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u51cf\u5c11\u4e86\u4e00\u6b21 <code>__tls_get_addr</code> \u7684\u8c03\u7528\u3002</p>\n<h3 id=\"global-dynamic-tls-model\">global dynamic TLS model<a class=\"headerlink\" href=\"#global-dynamic-tls-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u518d\u6765\u4ecb\u7ecd\u6700\u540e\u4e00\u79cd\u60c5\u51b5\uff1a\u5bf9\u4e8e\u4e00\u4e2a dlopen \u7684\u52a8\u6001\u5e93\uff0c\u5982\u679c\u5b83\u8981\u8bbf\u95ee\u7684 TLS \u53d8\u91cf\uff0c\u53ea\u77e5\u9053\u540d\u5b57\uff0c\u4e0d\u77e5\u9053\u6765\u81ea\u54ea\u4e00\u4e2a\u52a8\u6001\u5e93\uff0c\u4e0d\u77e5\u9053\u504f\u79fb\u662f\u591a\u5c11\u3002\u8fd9\u65f6\u5019\uff0c\u53ea\u80fd\u628a\u5168\u90e8\u5de5\u4f5c\u4ea4\u7ed9\u52a8\u6001\u94fe\u63a5\u5668\u53bb\u505a\uff1a\u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u6839\u636e\u7b26\u53f7\uff0c\u53bb\u67e5\u627e\u7b26\u53f7\u8868\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u52a8\u6001\u5e93\u548c\u504f\u79fb\uff0c\u8bb0\u5f55\u4e0b\u6765\uff1b\u7531\u4e8e\u6d89\u53ca\u5230\u52a8\u6001\u5e93\u7684\u7f16\u53f7\u548c\u504f\u79fb\uff0c\u6240\u4ee5\u9700\u8981\u4e24\u4e2a\u8fde\u7eed\u7684 <code>.got</code> entry\uff0c\u6b63\u597d\u5bf9\u5e94 <code>tls_index</code> \u7ed3\u6784\u4f53\u7684\u4e24\u9879\u6210\u5458\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-21-1\"><a id=\"__codelineno-21-1\" name=\"__codelineno-21-1\" href=\"#__codelineno-21-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dl_tls_index</span>\n</span><span id=\"__span-21-2\"><a id=\"__codelineno-21-2\" name=\"__codelineno-21-2\" href=\"#__codelineno-21-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-21-3\"><a id=\"__codelineno-21-3\" name=\"__codelineno-21-3\" href=\"#__codelineno-21-3\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_module</span><span class=\"p\">;</span>\n</span><span id=\"__span-21-4\"><a id=\"__codelineno-21-4\" name=\"__codelineno-21-4\" href=\"#__codelineno-21-4\"></a><span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">ti_offset</span><span class=\"p\">;</span>\n</span><span id=\"__span-21-5\"><a id=\"__codelineno-21-5\" name=\"__codelineno-21-5\" href=\"#__codelineno-21-5\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tls_index</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u7ee7\u7eed\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u8fd9\u6b21\u91c7\u7528 global dynamic TLS model \u8fdb\u884c\u7f16\u8bd1\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-22-1\"><a id=\"__codelineno-22-1\" name=\"__codelineno-22-1\" href=\"#__codelineno-22-1\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-22-2\"><a id=\"__codelineno-22-2\" name=\"__codelineno-22-2\" href=\"#__codelineno-22-2\"></a>__thread<span class=\"w\"> </span>int<span class=\"w\"> </span>tls_data1<span class=\"p\">;</span>\n</span><span id=\"__span-22-3\"><a id=\"__codelineno-22-3\" name=\"__codelineno-22-3\" href=\"#__codelineno-22-3\"></a>__thread<span class=\"w\"> </span>int<span class=\"w\"> </span>tls_data2<span class=\"p\">;</span>\n</span><span id=\"__span-22-4\"><a id=\"__codelineno-22-4\" name=\"__codelineno-22-4\" href=\"#__codelineno-22-4\"></a>\n</span><span id=\"__span-22-5\"><a id=\"__codelineno-22-5\" name=\"__codelineno-22-5\" href=\"#__codelineno-22-5\"></a>int<span class=\"w\"> </span>read_tls_data1<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span>tls_data1<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</span><span id=\"__span-22-6\"><a id=\"__codelineno-22-6\" name=\"__codelineno-22-6\" href=\"#__codelineno-22-6\"></a>int<span class=\"w\"> </span>read_tls_data2<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span>tls_data2<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</span><span id=\"__span-22-7\"><a id=\"__codelineno-22-7\" name=\"__codelineno-22-7\" href=\"#__codelineno-22-7\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-ftls-model<span class=\"o\">=</span>global-dynamic<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-O2<span class=\"w\"> </span>-S<span class=\"w\"> </span>tls.c\n</span><span id=\"__span-22-8\"><a id=\"__codelineno-22-8\" name=\"__codelineno-22-8\" href=\"#__codelineno-22-8\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>tls.s\n</span><span id=\"__span-22-9\"><a id=\"__codelineno-22-9\" name=\"__codelineno-22-9\" href=\"#__codelineno-22-9\"></a>read_tls_data1:\n</span><span id=\"__span-22-10\"><a id=\"__codelineno-22-10\" name=\"__codelineno-22-10\" href=\"#__codelineno-22-10\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-11\"><a id=\"__codelineno-22-11\" name=\"__codelineno-22-11\" href=\"#__codelineno-22-11\"></a><span class=\"w\">        </span>data16<span class=\"w\">  </span>leaq<span class=\"w\">    </span>tls_data1@tlsgd<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-22-12\"><a id=\"__codelineno-22-12\" name=\"__codelineno-22-12\" href=\"#__codelineno-22-12\"></a><span class=\"w\">        </span>.value<span class=\"w\">  </span>0x6666\n</span><span id=\"__span-22-13\"><a id=\"__codelineno-22-13\" name=\"__codelineno-22-13\" href=\"#__codelineno-22-13\"></a><span class=\"w\">        </span>rex64\n</span><span id=\"__span-22-14\"><a id=\"__codelineno-22-14\" name=\"__codelineno-22-14\" href=\"#__codelineno-22-14\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-22-15\"><a id=\"__codelineno-22-15\" name=\"__codelineno-22-15\" href=\"#__codelineno-22-15\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-22-16\"><a id=\"__codelineno-22-16\" name=\"__codelineno-22-16\" href=\"#__codelineno-22-16\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-17\"><a id=\"__codelineno-22-17\" name=\"__codelineno-22-17\" href=\"#__codelineno-22-17\"></a><span class=\"w\">        </span>ret\n</span><span id=\"__span-22-18\"><a id=\"__codelineno-22-18\" name=\"__codelineno-22-18\" href=\"#__codelineno-22-18\"></a>\n</span><span id=\"__span-22-19\"><a id=\"__codelineno-22-19\" name=\"__codelineno-22-19\" href=\"#__codelineno-22-19\"></a>read_tls_data2:\n</span><span id=\"__span-22-20\"><a id=\"__codelineno-22-20\" name=\"__codelineno-22-20\" href=\"#__codelineno-22-20\"></a><span class=\"w\">        </span>subq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-21\"><a id=\"__codelineno-22-21\" name=\"__codelineno-22-21\" href=\"#__codelineno-22-21\"></a><span class=\"w\">        </span>data16<span class=\"w\">  </span>leaq<span class=\"w\">    </span>tls_data2@tlsgd<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,<span class=\"w\"> </span>%rdi\n</span><span id=\"__span-22-22\"><a id=\"__codelineno-22-22\" name=\"__codelineno-22-22\" href=\"#__codelineno-22-22\"></a><span class=\"w\">        </span>.value<span class=\"w\">  </span>0x6666\n</span><span id=\"__span-22-23\"><a id=\"__codelineno-22-23\" name=\"__codelineno-22-23\" href=\"#__codelineno-22-23\"></a><span class=\"w\">        </span>rex64\n</span><span id=\"__span-22-24\"><a id=\"__codelineno-22-24\" name=\"__codelineno-22-24\" href=\"#__codelineno-22-24\"></a><span class=\"w\">        </span>call<span class=\"w\">    </span>__tls_get_addr@PLT\n</span><span id=\"__span-22-25\"><a id=\"__codelineno-22-25\" name=\"__codelineno-22-25\" href=\"#__codelineno-22-25\"></a><span class=\"w\">        </span>movl<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,<span class=\"w\"> </span>%eax\n</span><span id=\"__span-22-26\"><a id=\"__codelineno-22-26\" name=\"__codelineno-22-26\" href=\"#__codelineno-22-26\"></a><span class=\"w\">        </span>addq<span class=\"w\">    </span><span class=\"nv\">$8</span>,<span class=\"w\"> </span>%rsp\n</span><span id=\"__span-22-27\"><a id=\"__codelineno-22-27\" name=\"__codelineno-22-27\" href=\"#__codelineno-22-27\"></a><span class=\"w\">        </span>ret\n</span></code></pre></div>\n<p>\u8fd9\u6b21\u51fa\u73b0\u4e86\u4e00\u4e9b\u4e0d\u4e00\u6837\u7684\u5185\u5bb9\uff1a<code>data16</code>\u3001<code>.value 0x6666</code> \u548c <code>rex64</code>\uff1b\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e9b\u662f\u65e0\u7528\u7684\u6307\u4ee4\u524d\u7f00\uff0c\u4e0d\u5f71\u54cd\u6307\u4ee4\u7684\u8bed\u4e49\uff0c\u4f46\u662f\u4fdd\u8bc1\u4e86\u8fd9\u6bb5\u4ee3\u7801\u6709\u8db3\u591f\u7684\u957f\u5ea6\uff0c\u65b9\u4fbf\u540e\u7eed\u94fe\u63a5\u5668\u8fdb\u884c\u4f18\u5316\u3002\u9664\u4e86\u8fd9\u4e9b\u5947\u602a\u7684\u524d\u7f00\uff0c\u6838\u5fc3\u5c31\u662f <code>symbol@tlsgd(%rip)</code> \u8bed\u6cd5\uff0c\u5b83\u4f1a\u521b\u5efa <code>R_X86_64_TLSGD</code> relocation\uff0c\u5b83\u7684\u610f\u601d\u662f\uff1a\u521b\u5efa\u4e00\u5bf9 <code>.got</code> entry\uff0c\u7b2c\u4e00\u4e2a entry \u5bf9\u5e94 symbol \u6240\u5728\u52a8\u6001\u5e93\u7684\u7f16\u53f7\uff0c\u7b2c\u4e8c\u4e2a entry \u5bf9\u5e94 symbol \u5728\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\uff0c\u8fd9\u4e24\u4e2a entry \u7ec4\u6210\u4e00\u4e2a <code>tls_index</code> \u7ed3\u6784\u4f53\uff1b\u901a\u8fc7 <code>leaq</code> \u6307\u4ee4\u5f97\u5230\u8fd9\u4e2a\u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c\u8c03\u7528 <code>__tls_get_addr</code>\uff0c\u5c31\u5f97\u5230\u4e86\u8fd9\u4e2a TLS \u53d8\u91cf\u7684\u5730\u5740\u3002</p>\n<p>\u63a5\u4e0b\u6765\u770b\u751f\u6210\u7684\u5bf9\u8c61\u6587\u4ef6\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-23-1\"><a id=\"__codelineno-23-1\" name=\"__codelineno-23-1\" href=\"#__codelineno-23-1\"></a>$<span class=\"w\"> </span>as<span class=\"w\"> </span>tls.s<span class=\"w\"> </span>-o<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-23-2\"><a id=\"__codelineno-23-2\" name=\"__codelineno-23-2\" href=\"#__codelineno-23-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-r<span class=\"w\"> </span>tls.o\n</span><span id=\"__span-23-3\"><a id=\"__codelineno-23-3\" name=\"__codelineno-23-3\" href=\"#__codelineno-23-3\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-23-4\"><a id=\"__codelineno-23-4\" name=\"__codelineno-23-4\" href=\"#__codelineno-23-4\"></a>\n</span><span id=\"__span-23-5\"><a id=\"__codelineno-23-5\" name=\"__codelineno-23-5\" href=\"#__codelineno-23-5\"></a><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-23-6\"><a id=\"__codelineno-23-6\" name=\"__codelineno-23-6\" href=\"#__codelineno-23-6\"></a><span class=\"w\">   </span><span class=\"m\">0</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-7\"><a id=\"__codelineno-23-7\" name=\"__codelineno-23-7\" href=\"#__codelineno-23-7\"></a><span class=\"w\">   </span><span class=\"m\">4</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># c &lt;read_tls_data1+0xc&gt;</span>\n</span><span id=\"__span-23-8\"><a id=\"__codelineno-23-8\" name=\"__codelineno-23-8\" href=\"#__codelineno-23-8\"></a><span class=\"w\">   </span>b:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-9\"><a id=\"__codelineno-23-9\" name=\"__codelineno-23-9\" href=\"#__codelineno-23-9\"></a><span class=\"w\">                        </span><span class=\"m\">8</span>:<span class=\"w\"> </span>R_X86_64_TLSGD<span class=\"w\">       </span>tls_data1-0x4\n</span><span id=\"__span-23-10\"><a id=\"__codelineno-23-10\" name=\"__codelineno-23-10\" href=\"#__codelineno-23-10\"></a><span class=\"w\">   </span>c:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\"> </span>&lt;read_tls_data1+0x14&gt;\n</span><span id=\"__span-23-11\"><a id=\"__codelineno-23-11\" name=\"__codelineno-23-11\" href=\"#__codelineno-23-11\"></a><span class=\"w\">  </span><span class=\"m\">13</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-12\"><a id=\"__codelineno-23-12\" name=\"__codelineno-23-12\" href=\"#__codelineno-23-12\"></a><span class=\"w\">                        </span><span class=\"m\">10</span>:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">      </span>__tls_get_addr-0x4\n</span><span id=\"__span-23-13\"><a id=\"__codelineno-23-13\" name=\"__codelineno-23-13\" href=\"#__codelineno-23-13\"></a><span class=\"w\">  </span><span class=\"m\">14</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-23-14\"><a id=\"__codelineno-23-14\" name=\"__codelineno-23-14\" href=\"#__codelineno-23-14\"></a><span class=\"w\">  </span><span class=\"m\">16</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-15\"><a id=\"__codelineno-23-15\" name=\"__codelineno-23-15\" href=\"#__codelineno-23-15\"></a><span class=\"w\">  </span>1a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-23-16\"><a id=\"__codelineno-23-16\" name=\"__codelineno-23-16\" href=\"#__codelineno-23-16\"></a><span class=\"w\">  </span>1b:<span class=\"w\">   </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-23-17\"><a id=\"__codelineno-23-17\" name=\"__codelineno-23-17\" href=\"#__codelineno-23-17\"></a>\n</span><span id=\"__span-23-18\"><a id=\"__codelineno-23-18\" name=\"__codelineno-23-18\" href=\"#__codelineno-23-18\"></a><span class=\"m\">0000000000000020</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-23-19\"><a id=\"__codelineno-23-19\" name=\"__codelineno-23-19\" href=\"#__codelineno-23-19\"></a><span class=\"w\">  </span><span class=\"m\">20</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-20\"><a id=\"__codelineno-23-20\" name=\"__codelineno-23-20\" href=\"#__codelineno-23-20\"></a><span class=\"w\">  </span><span class=\"m\">24</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x0<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 2c &lt;read_tls_data2+0xc&gt;</span>\n</span><span id=\"__span-23-21\"><a id=\"__codelineno-23-21\" name=\"__codelineno-23-21\" href=\"#__codelineno-23-21\"></a><span class=\"w\">  </span>2b:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-22\"><a id=\"__codelineno-23-22\" name=\"__codelineno-23-22\" href=\"#__codelineno-23-22\"></a><span class=\"w\">                        </span><span class=\"m\">28</span>:<span class=\"w\"> </span>R_X86_64_TLSGD<span class=\"w\">      </span>tls_data2-0x4\n</span><span id=\"__span-23-23\"><a id=\"__codelineno-23-23\" name=\"__codelineno-23-23\" href=\"#__codelineno-23-23\"></a><span class=\"w\">  </span>2c:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">34</span><span class=\"w\"> </span>&lt;read_tls_data2+0x14&gt;\n</span><span id=\"__span-23-24\"><a id=\"__codelineno-23-24\" name=\"__codelineno-23-24\" href=\"#__codelineno-23-24\"></a><span class=\"w\">  </span><span class=\"m\">33</span>:<span class=\"w\">   </span><span class=\"m\">00</span>\n</span><span id=\"__span-23-25\"><a id=\"__codelineno-23-25\" name=\"__codelineno-23-25\" href=\"#__codelineno-23-25\"></a><span class=\"w\">                        </span><span class=\"m\">30</span>:<span class=\"w\"> </span>R_X86_64_PLT32<span class=\"w\">      </span>__tls_get_addr-0x4\n</span><span id=\"__span-23-26\"><a id=\"__codelineno-23-26\" name=\"__codelineno-23-26\" href=\"#__codelineno-23-26\"></a><span class=\"w\">  </span><span class=\"m\">34</span>:<span class=\"w\">   </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-23-27\"><a id=\"__codelineno-23-27\" name=\"__codelineno-23-27\" href=\"#__codelineno-23-27\"></a><span class=\"w\">  </span><span class=\"m\">36</span>:<span class=\"w\">   </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-23-28\"><a id=\"__codelineno-23-28\" name=\"__codelineno-23-28\" href=\"#__codelineno-23-28\"></a><span class=\"w\">  </span>3a:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>ret\n</span></code></pre></div>\n<p>\u57fa\u672c\u7b26\u5408\u9884\u671f\uff0c\u901a\u8fc7 <code>R_X86_64_TLSGD</code> relocation \u6765\u8868\u793a\u610f\u56fe\uff0c\u901a\u8fc7\u53cd\u6c47\u7f16\u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u591a\u4f59\u7684\u90a3\u4e9b\u4fee\u9970\u7b26\u662f\u6ca1\u6709\u7528\u7684\uff0c\u8bed\u4e49\u4e0a\u5c31\u662f\u4e00\u6761 <code>leaq</code> \u52a0\u4e00\u6761 <code>call</code> \u6307\u4ee4\u3002\u548c\u4e4b\u524d local dynamic TLS model \u7c7b\u4f3c\uff0c<code>__tls_get_addr</code> \u4e5f\u662f\u7528\u5df2\u6709\u7684 PLT \u673a\u5236\u6765\u5bfb\u5740\u3002</p>\n<p>\u6700\u540e\u6765\u770b\u751f\u6210\u7684\u52a8\u6001\u5e93\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-24-1\"><a id=\"__codelineno-24-1\" name=\"__codelineno-24-1\" href=\"#__codelineno-24-1\"></a>$<span class=\"w\"> </span>gcc<span class=\"w\"> </span>-shared<span class=\"w\"> </span>tls.o<span class=\"w\"> </span>-o<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-24-2\"><a id=\"__codelineno-24-2\" name=\"__codelineno-24-2\" href=\"#__codelineno-24-2\"></a>$<span class=\"w\"> </span>objdump<span class=\"w\"> </span>-D<span class=\"w\"> </span>-R<span class=\"w\"> </span>libtls.so\n</span><span id=\"__span-24-3\"><a id=\"__codelineno-24-3\" name=\"__codelineno-24-3\" href=\"#__codelineno-24-3\"></a><span class=\"c1\"># omitted</span>\n</span><span id=\"__span-24-4\"><a id=\"__codelineno-24-4\" name=\"__codelineno-24-4\" href=\"#__codelineno-24-4\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.text:\n</span><span id=\"__span-24-5\"><a id=\"__codelineno-24-5\" name=\"__codelineno-24-5\" href=\"#__codelineno-24-5\"></a>\n</span><span id=\"__span-24-6\"><a id=\"__codelineno-24-6\" name=\"__codelineno-24-6\" href=\"#__codelineno-24-6\"></a><span class=\"m\">0000000000001110</span><span class=\"w\"> </span>&lt;read_tls_data1&gt;:\n</span><span id=\"__span-24-7\"><a id=\"__codelineno-24-7\" name=\"__codelineno-24-7\" href=\"#__codelineno-24-7\"></a><span class=\"w\">    </span><span class=\"m\">1110</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-8\"><a id=\"__codelineno-24-8\" name=\"__codelineno-24-8\" href=\"#__codelineno-24-8\"></a><span class=\"w\">    </span><span class=\"m\">1114</span>:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span>b4<span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x2eb4<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fd0 &lt;tls_data1@@Base+0x3fcc&gt;</span>\n</span><span id=\"__span-24-9\"><a id=\"__codelineno-24-9\" name=\"__codelineno-24-9\" href=\"#__codelineno-24-9\"></a><span class=\"w\">    </span>111b:<span class=\"w\">       </span><span class=\"m\">00</span>\n</span><span id=\"__span-24-10\"><a id=\"__codelineno-24-10\" name=\"__codelineno-24-10\" href=\"#__codelineno-24-10\"></a><span class=\"w\">    </span>111c:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span>0c<span class=\"w\"> </span>ff<span class=\"w\"> </span>ff<span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-24-11\"><a id=\"__codelineno-24-11\" name=\"__codelineno-24-11\" href=\"#__codelineno-24-11\"></a><span class=\"w\">    </span><span class=\"m\">1123</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-24-12\"><a id=\"__codelineno-24-12\" name=\"__codelineno-24-12\" href=\"#__codelineno-24-12\"></a><span class=\"w\">    </span><span class=\"m\">1124</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-24-13\"><a id=\"__codelineno-24-13\" name=\"__codelineno-24-13\" href=\"#__codelineno-24-13\"></a><span class=\"w\">    </span><span class=\"m\">1126</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-14\"><a id=\"__codelineno-24-14\" name=\"__codelineno-24-14\" href=\"#__codelineno-24-14\"></a><span class=\"w\">    </span>112a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-24-15\"><a id=\"__codelineno-24-15\" name=\"__codelineno-24-15\" href=\"#__codelineno-24-15\"></a><span class=\"w\">    </span>112b:<span class=\"w\">       </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>nopl<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n</span><span id=\"__span-24-16\"><a id=\"__codelineno-24-16\" name=\"__codelineno-24-16\" href=\"#__codelineno-24-16\"></a>\n</span><span id=\"__span-24-17\"><a id=\"__codelineno-24-17\" name=\"__codelineno-24-17\" href=\"#__codelineno-24-17\"></a><span class=\"m\">0000000000001130</span><span class=\"w\"> </span>&lt;read_tls_data2&gt;:\n</span><span id=\"__span-24-18\"><a id=\"__codelineno-24-18\" name=\"__codelineno-24-18\" href=\"#__codelineno-24-18\"></a><span class=\"w\">    </span><span class=\"m\">1130</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>ec<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>sub<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-19\"><a id=\"__codelineno-24-19\" name=\"__codelineno-24-19\" href=\"#__codelineno-24-19\"></a><span class=\"w\">    </span><span class=\"m\">1134</span>:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>8d<span class=\"w\"> </span>3d<span class=\"w\"> </span><span class=\"m\">74</span><span class=\"w\"> </span>2e<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>data16<span class=\"w\"> </span>lea<span class=\"w\"> </span>0x2e74<span class=\"o\">(</span>%rip<span class=\"o\">)</span>,%rdi<span class=\"w\">        </span><span class=\"c1\"># 3fb0 &lt;tls_data2@@Base+0x3fb0&gt;</span>\n</span><span id=\"__span-24-20\"><a id=\"__codelineno-24-20\" name=\"__codelineno-24-20\" href=\"#__codelineno-24-20\"></a><span class=\"w\">    </span>113b:<span class=\"w\">       </span><span class=\"m\">00</span>\n</span><span id=\"__span-24-21\"><a id=\"__codelineno-24-21\" name=\"__codelineno-24-21\" href=\"#__codelineno-24-21\"></a><span class=\"w\">    </span>113c:<span class=\"w\">       </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>e8<span class=\"w\"> </span>ec<span class=\"w\"> </span>fe<span class=\"w\"> </span>ff<span class=\"w\">    </span>data16<span class=\"w\"> </span>data16<span class=\"w\"> </span>rex.W<span class=\"w\"> </span>call<span class=\"w\"> </span><span class=\"m\">1030</span><span class=\"w\"> </span>&lt;__tls_get_addr@plt&gt;\n</span><span id=\"__span-24-22\"><a id=\"__codelineno-24-22\" name=\"__codelineno-24-22\" href=\"#__codelineno-24-22\"></a><span class=\"w\">    </span><span class=\"m\">1143</span>:<span class=\"w\">       </span>ff\n</span><span id=\"__span-24-23\"><a id=\"__codelineno-24-23\" name=\"__codelineno-24-23\" href=\"#__codelineno-24-23\"></a><span class=\"w\">    </span><span class=\"m\">1144</span>:<span class=\"w\">       </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                   </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rax<span class=\"o\">)</span>,%eax\n</span><span id=\"__span-24-24\"><a id=\"__codelineno-24-24\" name=\"__codelineno-24-24\" href=\"#__codelineno-24-24\"></a><span class=\"w\">    </span><span class=\"m\">1146</span>:<span class=\"w\">       </span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>c4<span class=\"w\"> </span><span class=\"m\">08</span><span class=\"w\">             </span>add<span class=\"w\">    </span><span class=\"nv\">$0</span>x8,%rsp\n</span><span id=\"__span-24-25\"><a id=\"__codelineno-24-25\" name=\"__codelineno-24-25\" href=\"#__codelineno-24-25\"></a><span class=\"w\">    </span>114a:<span class=\"w\">       </span>c3<span class=\"w\">                      </span>ret\n</span><span id=\"__span-24-26\"><a id=\"__codelineno-24-26\" name=\"__codelineno-24-26\" href=\"#__codelineno-24-26\"></a>\n</span><span id=\"__span-24-27\"><a id=\"__codelineno-24-27\" name=\"__codelineno-24-27\" href=\"#__codelineno-24-27\"></a>Disassembly<span class=\"w\"> </span>of<span class=\"w\"> </span>section<span class=\"w\"> </span>.got:\n</span><span id=\"__span-24-28\"><a id=\"__codelineno-24-28\" name=\"__codelineno-24-28\" href=\"#__codelineno-24-28\"></a>\n</span><span id=\"__span-24-29\"><a id=\"__codelineno-24-29\" name=\"__codelineno-24-29\" href=\"#__codelineno-24-29\"></a>0000000000003fa8<span class=\"w\"> </span>&lt;.got&gt;:\n</span><span id=\"__span-24-30\"><a id=\"__codelineno-24-30\" name=\"__codelineno-24-30\" href=\"#__codelineno-24-30\"></a><span class=\"w\">        </span>...\n</span><span id=\"__span-24-31\"><a id=\"__codelineno-24-31\" name=\"__codelineno-24-31\" href=\"#__codelineno-24-31\"></a><span class=\"w\">                        </span>3fb0:<span class=\"w\"> </span>R_X86_64_DTPMOD64<span class=\"w\"> </span>tls_data2@@Base\n</span><span id=\"__span-24-32\"><a id=\"__codelineno-24-32\" name=\"__codelineno-24-32\" href=\"#__codelineno-24-32\"></a><span class=\"w\">                        </span>3fb8:<span class=\"w\"> </span>R_X86_64_DTPOFF64<span class=\"w\"> </span>tls_data2@@Base\n</span><span id=\"__span-24-33\"><a id=\"__codelineno-24-33\" name=\"__codelineno-24-33\" href=\"#__codelineno-24-33\"></a><span class=\"w\">                        </span>3fd0:<span class=\"w\"> </span>R_X86_64_DTPMOD64<span class=\"w\"> </span>tls_data1@@Base\n</span><span id=\"__span-24-34\"><a id=\"__codelineno-24-34\" name=\"__codelineno-24-34\" href=\"#__codelineno-24-34\"></a><span class=\"w\">                        </span>3fd8:<span class=\"w\"> </span>R_X86_64_DTPOFF64<span class=\"w\"> </span>tls_data1@@Base\n</span></code></pre></div>\n<p>\u89c2\u5bdf <code>.got</code>\uff0c\u53ef\u4ee5\u770b\u5230\u5bf9\u4e8e\u6bcf\u4e2a TLS \u53d8\u91cf\uff0c\u90fd\u751f\u6210\u4e86\u4e24\u4e2a entry\uff1a<code>tls_data2</code> \u5360\u7528\u4e86 <code>0x3fb0</code> \u548c <code>0x3fb8</code> \u4e24\u4e2a entry\uff0c\u7b2c\u4e00\u4e2a\u5bf9\u5e94\u52a8\u6001\u5e93\u7684\u4e0b\u6807\uff08MOD \u8868\u793a Module\uff09\uff0c\u7b2c\u4e8c\u4e2a\u5bf9\u5e94\u504f\u79fb\uff08OFF \u8868\u793a Offset\uff09\uff1b<code>tls_data1</code> \u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u5360\u7528\u4e86 <code>0x3fd0</code> \u548c <code>0x3fd8</code>\u3002\u5f53\u52a8\u6001\u94fe\u63a5\u5668\u5728 <code>.got</code> \u8868\u4e2d\u51c6\u5907\u597d <code>tls_index</code> \u7ed3\u6784\u4f53\u540e\uff0c\u5728\u8bbf\u95ee TLS \u53d8\u91cf\u65f6\uff0c\u53ea\u9700\u8981 <code>lea</code> + <code>call</code> \u5c31\u53ef\u4ee5\u627e\u5230 TLS \u53d8\u91cf\u7684\u5730\u5740\u4e86\u3002</p>\n<h2 id=\"\u56db\u79cd-tls-model-\u7684\u5bf9\u6bd4\">\u56db\u79cd TLS model \u7684\u5bf9\u6bd4<a class=\"headerlink\" href=\"#\u56db\u79cd-tls-model-\u7684\u5bf9\u6bd4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u8fdb\u884c\u56db\u79cd TLS model \u7684\u5bf9\u6bd4\uff1a</p>\n<ol>\n<li>local exec TLS model: \u7528\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u8bbf\u95ee\u81ea\u8eab\u7684 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u7684 TLS \u7a7a\u95f4\u603b\u662f\u7d27\u6328\u7740 <code>%fs</code>\uff0c\u6240\u4ee5\u81ea\u8eab\u7684 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5728\u94fe\u63a5\u65f6\u5df2\u77e5\uff0c\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u51fa\u6765\uff0c\u8fd0\u884c\u65f6\u5f00\u9500\u6700\u5c0f</li>\n<li>initial exec TLS model: \u7528\u4e8e\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u7531\u52a8\u6001\u94fe\u63a5\u5668\u81ea\u52a8\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u8bbf\u95ee\u81ea\u8eab\u7684 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u5b83\u7684 TLS \u7a7a\u95f4\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u5728\u52a0\u8f7d\u540e\u5c31\u662f\u56fa\u5b9a\u7684\uff0c\u6240\u4ee5\u7531\u52a8\u6001\u94fe\u63a5\u5668\u8ba1\u7b97\u51fa\u5404\u4e2a TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u5199\u5230 <code>.got</code> \u8868\u4e2d\uff0c\u8fd0\u884c\u65f6\u53ea\u9700\u8981\u8bfb\u53d6 <code>.got</code> \u8868\u4e2d\u8bb0\u5f55\u7684 offset\uff0c\u548c <code>%fs</code> \u505a\u52a0\u6cd5\u5c31\u5f97\u5230\u4e86\u53d8\u91cf\u7684\u5730\u5740</li>\n<li>local dynamic TLS model: \u7528\u4e8e\u53ef\u80fd\u88ab dlopen \u7684\u52a8\u6001\u5e93\u8bbf\u95ee\u81ea\u8eab\u7684 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u5b83\u7684 TLS \u7a7a\u95f4\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u6240\u4ee5\u9700\u8981\u7528 <code>__tls_get_addr</code> \u8c03\u7528\u6765\u83b7\u53d6\u81ea\u8eab\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff1b\u4e3a\u4e86\u7ed9 <code>__tls_get_addr</code> \u4f20\u9012\u6b63\u786e\u7684\u53c2\u6570\uff0c\u544a\u8bc9\u8fd9\u4e2a\u51fd\u6570\u81ea\u5df1\u7684\u52a8\u6001\u5e93\u7f16\u53f7\u662f\u591a\u5c11\uff0c\u5728 <code>.got</code> \u8868\u4e2d\u9884\u7559\u4e86\u4e00\u4e2a entry \u8ba9\u52a8\u6001\u94fe\u63a5\u5668\u628a\u8be5\u52a8\u6001\u5e93\u7684\u7f16\u53f7\u5199\u8fdb\u53bb\uff1b\u90a3\u4e48\u8fd0\u884c\u65f6\u53ea\u9700\u8981\u8bfb\u53d6 <code>.got</code> \u8868\u4e2d\u8bb0\u5f55\u7684\u52a8\u6001\u5e93\u7f16\u53f7\uff0c\u8c03\u7528 <code>__tls_get_addr</code>\uff0c\u518d\u548c\u94fe\u63a5\u65f6\u5df2\u77e5\u7684 offset \u505a\u52a0\u6cd5\u5c31\u5f97\u5230\u4e86\u53d8\u91cf\u7684\u5730\u5740</li>\n<li>global dynamic TLS model: \u7528\u4e8e\u901a\u7528\u60c5\u51b5\u4e0b\uff0c\u4e0d\u77e5\u9053 TLS \u53d8\u91cf\u5c5e\u4e8e\u54ea\u4e2a\u52a8\u6001\u5e93\uff0c\u4e5f\u4e0d\u77e5\u9053 TLS \u53d8\u91cf\u5728 TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\u662f\u591a\u5c11\uff0c\u6240\u4ee5\u9700\u8981\u52a8\u6001\u94fe\u63a5\u5668\u53bb\u67e5\u8be2 TLS \u53d8\u91cf\u5c5e\u4e8e\u54ea\u4e2a\u52a8\u6001\u5e93\uff0c\u653e\u5728\u54ea\u4e2a\u504f\u79fb\u4e0a\uff0c\u5e76\u4e14\u52a8\u6001\u94fe\u63a5\u5668\u8981\u628a\u8fd9\u4e24\u4e2a\u4fe1\u606f\u5199\u5230 <code>.got</code> \u8868\u4e2d\uff1b\u90a3\u4e48\u8fd0\u884c\u65f6\u5c31\u8981\u7528 <code>__tls_get_addr</code> \u8c03\u7528\u6765\u6839\u636e <code>.got</code> \u8868\u4e2d\u8bb0\u5f55\u7684\u52a8\u6001\u5e93\u7f16\u53f7\u4ee5\u53ca\u504f\u79fb\u6765\u627e\u5230\u53d8\u91cf\u7684\u5730\u5740</li>\n</ol>\n<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u5bf9\u6bd4\u8868\u683c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Instructions</th>\n<th>GOT</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>local exec</td>\n<td>movq</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>initial exec</td>\n<td>movq + addq</td>\n<td>offset</td>\n</tr>\n<tr>\n<td>local dynamic</td>\n<td>leaq + call + leaq</td>\n<td>self module index</td>\n</tr>\n<tr>\n<td>global dynamic</td>\n<td>leaq + call</td>\n<td>module index + offset</td>\n</tr>\n</tbody>\n</table>\n<p>\u7279\u522b\u5730\uff0clocal dynamic TLS model \u7684 <code>leaq + call</code> \u662f\u53ef\u4ee5\u590d\u7528\u7684\uff0c\u6240\u4ee5\u6574\u4f53\u6765\u8bf4\uff0c\u8fd8\u662f\u8d8a\u901a\u7528\u7684 TLS model\uff0c\u8fd0\u884c\u65f6\u7684\u5f00\u9500\u8d8a\u5927\u3002</p>\n<h2 id=\"\u5b9e\u9645\u7f16\u7a0b\u4e2d\u7684-tls-model\">\u5b9e\u9645\u7f16\u7a0b\u4e2d\u7684 TLS model<a class=\"headerlink\" href=\"#\u5b9e\u9645\u7f16\u7a0b\u4e2d\u7684-tls-model\" title=\"Permanent link\">&para;</a></h2>\n<p>\u770b\u5230\u8fd9\u91cc\uff0c\u4f60\u53ef\u80fd\u4f1a\u7591\u60d1\uff1a\u5728\u7f16\u7a0b\u7684\u65f6\u5019\uff0c\u5927\u591a\u6570\u65f6\u5019\u5e76\u6ca1\u6709\u53bb\u7ba1 TLS model \u7684\u4e8b\u60c5\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728\u7f16\u8bd1\u7684\u65f6\u5019\u5e76\u6ca1\u6709\u6307\u5b9a\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u4f1a\u91c7\u7528\u4ec0\u4e48 TLS model \u5462\uff1f</p>\n<p>\u7b54\u6848\u662f\u53d6\u51b3\u4e8e\u7f16\u8bd1\u5668\u548c\u94fe\u63a5\u5668\u4f1a\u6839\u636e\u6240\u80fd\u4e86\u89e3\u5230\u7684\u60c5\u51b5\uff0c\u9009\u62e9\u4e00\u4e2a\u6700\u4f18\u7684\u5b9e\u73b0\u65b9\u6cd5\u3002\u5728\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u90fd\u662f\u76f4\u63a5\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5168\u5c40\u7684 <code>__thread</code> \u53d8\u91cf\u7136\u540e\u53bb\u8bbf\u95ee\u5b83\uff0c\u4f46\u5982\u679c\u5b83\u662f <code>static</code> \u7684\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u5462\uff1f\u5982\u679c\u7f16\u8bd1\u7684\u65f6\u5019\uff0c\u6ca1\u6709\u5f00 <code>-fPIC</code>\uff0c\u4e5f\u5c31\u662f\u8bf4\u751f\u6210\u7684\u4ee3\u7801\u4e0d\u4f1a\u51fa\u73b0\u5728\u52a8\u6001\u5e93\u4e2d\uff0c\u53c8\u4f1a\u53d1\u751f\u4ec0\u4e48\u5462\uff1f</p>\n<p>\u9996\u5148\u6765\u770b\u4ece\u7f16\u8bd1\u5668\u5230\u6c47\u7f16\u7684\u8fd9\u4e00\u4e2a\u9636\u6bb5\uff0c\u4f1a\u91c7\u7528\u4ec0\u4e48\u6837\u7684 TLS model\uff1a</p>\n<ol>\n<li>\u5982\u679c\u5728\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6ca1\u6709\u5f00 <code>-fPIC</code>\uff0c\u90a3\u4e48\u751f\u6210\u7684\u4ee3\u7801\u53ea\u51fa\u73b0\u5728\u53ef\u6267\u884c\u7a0b\u5e8f\u4e2d\uff0c\u8fd9\u4e2a\u65f6\u5019\u7f16\u8bd1\u5668\u4f1a\u76f4\u63a5\u4f7f\u7528 local exec TLS model\uff0c\u5373\u751f\u6210 <code>movl %fs:symbol@tpoff, %rax</code> \u7684\u6307\u4ee4</li>\n<li>\u5982\u679c\u5728\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u5f00\u4e86 <code>-fPIC</code>\uff0c\u90a3\u4e48\u751f\u6210\u7684\u4ee3\u7801\u65e2\u53ef\u80fd\u51fa\u73b0\u5728\u53ef\u6267\u884c\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u53ef\u80fd\u51fa\u73b0\u5728\u52a8\u6001\u5e93\u4e2d\uff0c\u8fd9\u65f6\u4f1a\u9996\u5148\u9ed8\u8ba4\u4e3a global dynamic TLS model\uff0c\u5373\u751f\u6210 <code>data16 leaq symbol@tlsgd(%rip), %rdi; .value 0x6666; rex64; call __tls_get_addr@PLT; movl (%rax), %eax</code> \u6307\u4ee4</li>\n<li>\u4f46\u5982\u679c <code>__thread</code> \u53d8\u91cf\u8bbe\u7f6e\u4e86 <code>static</code>\uff0c\u5373\u4f7f\u6253\u5f00\u4e86 <code>-fPIC</code>\uff0c\u4e5f\u4fdd\u8bc1\u4e86\u8fd9\u4e2a TLS \u53d8\u91cf\u4e00\u5b9a\u662f\u8bbf\u95ee\u81ea\u5df1 TLS \u7a7a\u95f4\u4e2d\u7684\uff0c\u4e0d\u4f1a\u8bbf\u95ee\u522b\u4eba\u7684\uff0c\u90a3\u4e48\u7f16\u8bd1\u5668\u4f1a\u81ea\u52a8\u9009\u62e9 local dynamic TLS model\uff0c\u5373\u751f\u6210 <code>leaq symbol@tlsld(%rip), %rdi; call__tls_get_addr@PLT; movl %symbol@dtpoff(%rax), %eax</code> \u6307\u4ee4</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u4e8b\u60c5\uff1a</p>\n<ol>\n<li>\n<p>\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6253\u5f00\u4e86 <code>-fPIC</code> \u4e14\u6ca1\u6709\u7528 <code>static</code>\uff0c\u5982\u524d\u6240\u8ff0\uff0c\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 global dynamic TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u90a3\u4e48\u94fe\u63a5\u5668\u77e5\u9053\u8fd9\u4e2a\u65f6\u5019\u7528 local exec TLS model \u662f\u6027\u80fd\u66f4\u597d\u7684\uff0c\u90a3\u4e48\u5b83\u4f1a\u5bf9\u6307\u4ee4\u8fdb\u884c\u6539\u5199\uff0c\u6b64\u65f6\u4e4b\u524d\u9884\u7559\u7684\u65e0\u7528\u7684\u6307\u4ee4\u524d\u7f00 <code>data 16; .value 0x6666; rex64</code> \u8d77\u4e86\u4f5c\u7528\uff0c\u4fdd\u8bc1\u6539\u5199\u524d\u540e\u7684\u6307\u4ee4\u5e8f\u5217\u7684\u957f\u5ea6\u4e0d\u53d8\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-25-1\"><a id=\"__codelineno-25-1\" name=\"__codelineno-25-1\" href=\"#__codelineno-25-1\"></a><span class=\"c1\"># before linker optimizations: global dynamic</span>\n</span><span id=\"__span-25-2\"><a id=\"__codelineno-25-2\" name=\"__codelineno-25-2\" href=\"#__codelineno-25-2\"></a><span class=\"na\">data16</span><span class=\"w\"> </span><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tlsgd</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-25-3\"><a id=\"__codelineno-25-3\" name=\"__codelineno-25-3\" href=\"#__codelineno-25-3\"></a><span class=\"na\">.value</span><span class=\"w\"> </span><span class=\"mi\">0x6666</span>\n</span><span id=\"__span-25-4\"><a id=\"__codelineno-25-4\" name=\"__codelineno-25-4\" href=\"#__codelineno-25-4\"></a><span class=\"nf\">rex64</span>\n</span><span id=\"__span-25-5\"><a id=\"__codelineno-25-5\" name=\"__codelineno-25-5\" href=\"#__codelineno-25-5\"></a><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">__tls_get_addr@PLT</span>\n</span><span id=\"__span-25-6\"><a id=\"__codelineno-25-6\" name=\"__codelineno-25-6\" href=\"#__codelineno-25-6\"></a>\n</span><span id=\"__span-25-7\"><a id=\"__codelineno-25-7\" name=\"__codelineno-25-7\" href=\"#__codelineno-25-7\"></a><span class=\"c1\"># after linker optimizations: local exec</span>\n</span><span id=\"__span-25-8\"><a id=\"__codelineno-25-8\" name=\"__codelineno-25-8\" href=\"#__codelineno-25-8\"></a><span class=\"c1\"># the symbol@tpoff(%rax) relocation is resolved by the linker immediately</span>\n</span><span id=\"__span-25-9\"><a id=\"__codelineno-25-9\" name=\"__codelineno-25-9\" href=\"#__codelineno-25-9\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-25-10\"><a id=\"__codelineno-25-10\" name=\"__codelineno-25-10\" href=\"#__codelineno-25-10\"></a><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u7c7b\u4f3c\u5730\uff0c\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6253\u5f00\u4e86 <code>-fPIC</code> \u4e14\u7528\u4e86 <code>static</code>\uff0c\u5982\u524d\u6240\u8ff0\uff0c\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 local dynamic TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u90a3\u4e48\u94fe\u63a5\u5668\u77e5\u9053\u8fd9\u4e2a\u65f6\u5019\u7528 local exec TLS model \u662f\u6027\u80fd\u66f4\u597d\u7684\uff0c\u90a3\u4e48\u5b83\u4f1a\u5bf9\u6307\u4ee4\u8fdb\u884c\u6539\u5199\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6539\u5199\u524d\u540e\u7684\u6307\u4ee4\u5e8f\u5217\u7684\u957f\u5ea6\u4e0d\u53d8\uff0c\u8fd9\u6b21\u662f\u5728\u751f\u6210\u7684\u6c47\u7f16\u91cc\u52a0\u5165\u65e0\u7528\u7684\u6307\u4ee4\u524d\u7f00\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-26-1\"><a id=\"__codelineno-26-1\" name=\"__codelineno-26-1\" href=\"#__codelineno-26-1\"></a><span class=\"c1\"># before linker optimizations: local dynamic</span>\n</span><span id=\"__span-26-2\"><a id=\"__codelineno-26-2\" name=\"__codelineno-26-2\" href=\"#__codelineno-26-2\"></a><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tlsld</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-26-3\"><a id=\"__codelineno-26-3\" name=\"__codelineno-26-3\" href=\"#__codelineno-26-3\"></a><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">__tls_get_addr@PLT</span>\n</span><span id=\"__span-26-4\"><a id=\"__codelineno-26-4\" name=\"__codelineno-26-4\" href=\"#__codelineno-26-4\"></a><span class=\"nf\">movl</span><span class=\"w\"> </span><span class=\"no\">symbol@dtpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%eax</span>\n</span><span id=\"__span-26-5\"><a id=\"__codelineno-26-5\" name=\"__codelineno-26-5\" href=\"#__codelineno-26-5\"></a>\n</span><span id=\"__span-26-6\"><a id=\"__codelineno-26-6\" name=\"__codelineno-26-6\" href=\"#__codelineno-26-6\"></a><span class=\"c1\"># after linker optimizations: local exec</span>\n</span><span id=\"__span-26-7\"><a id=\"__codelineno-26-7\" name=\"__codelineno-26-7\" href=\"#__codelineno-26-7\"></a><span class=\"c1\"># the symbol@tpoff(%rax) relocation is resolved by the linker immediately</span>\n</span><span id=\"__span-26-8\"><a id=\"__codelineno-26-8\" name=\"__codelineno-26-8\" href=\"#__codelineno-26-8\"></a><span class=\"na\">.word</span><span class=\"w\"> </span><span class=\"mi\">0x6666</span>\n</span><span id=\"__span-26-9\"><a id=\"__codelineno-26-9\" name=\"__codelineno-26-9\" href=\"#__codelineno-26-9\"></a><span class=\"na\">.byte</span><span class=\"w\"> </span><span class=\"mi\">0x66</span>\n</span><span id=\"__span-26-10\"><a id=\"__codelineno-26-10\" name=\"__codelineno-26-10\" href=\"#__codelineno-26-10\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-26-11\"><a id=\"__codelineno-26-11\" name=\"__codelineno-26-11\" href=\"#__codelineno-26-11\"></a><span class=\"nf\">movl</span><span class=\"w\"> </span><span class=\"no\">symbol@tpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%eax</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6253\u5f00\u4e86 <code>-fPIC</code> \u4e14\u7528\u4e86 <code>extern</code> \u6765\u6807\u8bb0 TLS \u53d8\u91cf\uff0c\u7531\u4e8e\u7f16\u8bd1\u5668\u4e0d\u77e5\u9053\u8fd9\u4e2a TLS \u53d8\u91cf\u5c5e\u4e8e\u8c01\uff0c\u6240\u4ee5\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 global dynamic TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u5e76\u4e14\u7f16\u8bd1\u5668\u53d1\u73b0\u8fd9\u4e2a TLS \u53d8\u91cf\u5c5e\u4e8e\u4e00\u4e2a\u52a8\u6001\u5e93\uff0c\u8fd9\u610f\u5473\u7740\u8fd9\u4e2a TLS \u53d8\u91cf\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u4f1a\u968f\u7740\u52a8\u6001\u5e93\u52a0\u8f7d\u800c\u53d8\u5f97\u53ef\u7528\uff0c\u9002\u7528 initial exec TLS model\uff0c\u4e8e\u662f\u94fe\u63a5\u5668\u4e5f\u4f1a\u8fdb\u884c\u6539\u5199\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-27-1\"><a id=\"__codelineno-27-1\" name=\"__codelineno-27-1\" href=\"#__codelineno-27-1\"></a><span class=\"c1\"># before linker optimizations: global dynamic</span>\n</span><span id=\"__span-27-2\"><a id=\"__codelineno-27-2\" name=\"__codelineno-27-2\" href=\"#__codelineno-27-2\"></a><span class=\"na\">data16</span><span class=\"w\"> </span><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tlsgd</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-27-3\"><a id=\"__codelineno-27-3\" name=\"__codelineno-27-3\" href=\"#__codelineno-27-3\"></a><span class=\"na\">.value</span><span class=\"w\"> </span><span class=\"mi\">0x6666</span>\n</span><span id=\"__span-27-4\"><a id=\"__codelineno-27-4\" name=\"__codelineno-27-4\" href=\"#__codelineno-27-4\"></a><span class=\"nf\">rex64</span>\n</span><span id=\"__span-27-5\"><a id=\"__codelineno-27-5\" name=\"__codelineno-27-5\" href=\"#__codelineno-27-5\"></a><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">__tls_get_addr@PLT</span>\n</span><span id=\"__span-27-6\"><a id=\"__codelineno-27-6\" name=\"__codelineno-27-6\" href=\"#__codelineno-27-6\"></a>\n</span><span id=\"__span-27-7\"><a id=\"__codelineno-27-7\" name=\"__codelineno-27-7\" href=\"#__codelineno-27-7\"></a><span class=\"c1\"># after linker optimizations: initial exec</span>\n</span><span id=\"__span-27-8\"><a id=\"__codelineno-27-8\" name=\"__codelineno-27-8\" href=\"#__codelineno-27-8\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-27-9\"><a id=\"__codelineno-27-9\" name=\"__codelineno-27-9\" href=\"#__codelineno-27-9\"></a><span class=\"nf\">addq</span><span class=\"w\"> </span><span class=\"no\">symbol@gottpoff</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u5982\u679c\u7f16\u8bd1\u6e90\u7801\u7684\u65f6\u5019\uff0c\u6ca1\u6709\u6253\u5f00 <code>-fPIC</code> \u4e14\u7528\u4e86 <code>extern</code> \u6765\u6807\u8bb0 TLS \u53d8\u91cf\uff0c\u90a3\u4e48\u7f16\u8bd1\u5668\u77e5\u9053\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u53ea\u80fd\u51fa\u73b0\u5728\u53ef\u6267\u884c\u7a0b\u5e8f\u4e2d\uff0c\u90a3\u4e48\u8fd9\u4e2a TLS \u53d8\u91cf\u8981\u4e48\u6765\u81ea\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\uff0c\u8981\u4e48\u6765\u81ea\u4e8e\u7a0b\u5e8f\u542f\u52a8\u65f6\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u6240\u4ee5\u7f16\u8bd1\u5668\u4f1a\u4f7f\u7528 initial exec TLS model\uff1b\u4f46\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u6587\u4ef6\u6700\u540e\u88ab\u94fe\u63a5\u5230\u4e86\u53ef\u6267\u884c\u7a0b\u5e8f\u5f53\u4e2d\uff0c\u5e76\u4e14\u7f16\u8bd1\u5668\u53d1\u73b0\u8fd9\u4e2a TLS \u53d8\u91cf\u5c5e\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u81ea\u5df1\uff0c\u9002\u7528 local exec TLS model\uff0c\u4e8e\u662f\u94fe\u63a5\u5668\u4e5f\u4f1a\u8fdb\u884c\u6539\u5199\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-28-1\"><a id=\"__codelineno-28-1\" name=\"__codelineno-28-1\" href=\"#__codelineno-28-1\"></a><span class=\"c1\"># before linker optimizations: initial exec</span>\n</span><span id=\"__span-28-2\"><a id=\"__codelineno-28-2\" name=\"__codelineno-28-2\" href=\"#__codelineno-28-2\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-28-3\"><a id=\"__codelineno-28-3\" name=\"__codelineno-28-3\" href=\"#__codelineno-28-3\"></a><span class=\"nf\">addq</span><span class=\"w\"> </span><span class=\"no\">symbol@gottpoff</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-28-4\"><a id=\"__codelineno-28-4\" name=\"__codelineno-28-4\" href=\"#__codelineno-28-4\"></a>\n</span><span id=\"__span-28-5\"><a id=\"__codelineno-28-5\" name=\"__codelineno-28-5\" href=\"#__codelineno-28-5\"></a><span class=\"c1\"># after linker optimizations: local exec</span>\n</span><span id=\"__span-28-6\"><a id=\"__codelineno-28-6\" name=\"__codelineno-28-6\" href=\"#__codelineno-28-6\"></a><span class=\"c1\"># the symbol@tpoff(%rax) relocation is resolved by the linker immediately</span>\n</span><span id=\"__span-28-7\"><a id=\"__codelineno-28-7\" name=\"__codelineno-28-7\" href=\"#__codelineno-28-7\"></a><span class=\"nf\">movq</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-28-8\"><a id=\"__codelineno-28-8\" name=\"__codelineno-28-8\" href=\"#__codelineno-28-8\"></a><span class=\"nf\">leaq</span><span class=\"w\"> </span><span class=\"no\">symbol@tpoff</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span></code></pre></div>\n</li>\n</ol>\n<p>\u53ef\u89c1\u901a\u8fc7\u4e24\u9636\u6bb5\u7684\u5904\u7406\uff0c\u5728\u7f16\u8bd1\u5668\u548c\u94fe\u63a5\u5668\u7684\u534f\u540c\u4e0b\uff0c\u5c1d\u8bd5\u4f18\u5316\u5230\u4e00\u4e2a\u5f00\u9500\u66f4\u5c0f\u7684 TLS model\uff0c\u8f6c\u5316\u7684\u51e0\u79cd\u60c5\u51b5\u5982\u4e0b\uff1a</p>\n<ol>\n<li>global dynamic -&gt; initial exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u5f00\u4e86 -fPIC \u548c <code>extern</code>\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u52a8\u6001\u5e93</li>\n<li>global dynamic -&gt; local exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u5f00\u4e86 -fPIC\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u7a0b\u5e8f\u81ea\u5df1</li>\n<li>local dynamic -&gt; local exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u5f00\u4e86 -fPIC \u548c <code>-static</code>\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u7a0b\u5e8f\u81ea\u5df1</li>\n<li>initial exec -&gt; local exec\uff1a\u7f16\u8bd1\u7684\u65f6\u5019\u6ca1\u5f00 -fPIC\uff0c\u7136\u540e\u94fe\u63a5\u5230\u53ef\u6267\u884c\u7a0b\u5e8f\u5185\uff0cTLS \u53d8\u91cf\u6765\u81ea\u7a0b\u5e8f\u81ea\u5df1</li>\n</ol>\n<h2 id=\"tlsdesc\">TLSDESC<a class=\"headerlink\" href=\"#tlsdesc\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u63d0\u5230\uff0c\u5728 global dynamic \u548c local dynamic \u4e24\u79cd TLS model \u4e0b\uff0c\u8981\u8bbf\u95ee TLS \u53d8\u91cf\u7684\u65f6\u5019\uff0c\u9700\u8981\u8c03\u7528 <code>__tls_get_addr</code> \u51fd\u6570\uff0c\u8fd9\u662f\u6bd4\u8f83\u6162\u7684\u3002\u4e3a\u4e86\u4f18\u5316\u5b83\uff0c\u8ba9\u4eba\u60f3\u5230\u4e86 PLT \u673a\u5236\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u60c5\u51b5\u4e0b\uff0cPLT \u4f1a\u751f\u6210\u4e00\u4e2a stub\uff0c\u4ece <code>.got</code> \u8bfb\u53d6\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u5e76\u8df3\u8f6c\uff0c\u8fd9\u4e2a\u51fd\u6570\u6307\u9488\u521d\u59cb\u60c5\u51b5\u4e0b\u662f\u6267\u884c\u4e86 <code>stub</code> \u7684\u4e0b\u4e00\u6761\u6307\u4ee4</li>\n<li>\u5bf9\u4e8e\u7b2c\u4e00\u6b21\u6267\u884c\u8fd9\u4e2a stub\uff0c\u5b83\u4f1a\u628a\u8fd9\u4e2a\u51fd\u6570\u7684\u7f16\u53f7 push \u5230\u6808\u4e0a\uff0c\u7136\u540e\u8c03\u7528\u52a8\u6001\u94fe\u63a5\u5668\u63d0\u4f9b\u7684 <code>_dl_runtime_resolve</code> \u51fd\u6570\u6765\u5bfb\u627e\u8fd9\u4e2a\u51fd\u6570\u7684\u5b9e\u9645\u5730\u5740\uff1b\u6b64\u65f6 <code>_dl_runtime_resolve</code> \u4f1a\u628a\u627e\u5230\u7684\u51fd\u6570\u5730\u5740\u5199\u56de\u5230 <code>.got</code> \u7684\u51fd\u6570\u6307\u9488</li>\n<li>\u6b64\u540e\u518d\u6b21\u6267\u884c stub \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u4ece <code>.got</code> \u8bfb\u53d6\u8ba1\u7b97\u597d\u7684\u7684\u51fd\u6570\u6307\u9488\uff0c\u76f4\u63a5\u8df3\u8f6c\u5230\u5b9e\u9645\u7684\u51fd\u6570\u5730\u5740</li>\n</ol>\n<p>\u7531\u6b64\u53ef\u4ee5\u7c7b\u6bd4\u5f97\u5230\u4e00\u4e2a\u9488\u5bf9 TLS \u7684\u7c7b\u4f3c\u673a\u5236\uff0c\u79f0\u4e3a TLSDESC\uff1a</p>\n<ol>\n<li>TLSDESC \u5360\u7528 16 \u5b57\u8282\u7a7a\u95f4\uff0c\u524d\u9762 8 \u5b57\u8282\u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\uff0c\u540e\u9762 8 \u5b57\u8282\u7528\u6765\u4fdd\u5b58 offset\uff0c\u4fdd\u5b58\u5728 <code>.got</code> \u8868\u4e2d</li>\n<li>\u628a\u539f\u6765 local/global dynamic TLS model \u5bf9 <code>__tls_get_addr</code> \u7684\u8c03\u7528\uff0c\u6539\u6210\u8c03\u7528 TLSDESC \u4e2d\u7684\u51fd\u6570\u6307\u9488\uff0c\u8c03\u7528\u65f6 <code>%rax</code> \u5bc4\u5b58\u5668\u6307\u5411\u4e86 TLSDESC \u7684\u5730\u5740\uff0c\u5b83\u7684\u8fd4\u56de\u7ed3\u679c\u662f TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u540e\u7eed\u6307\u4ee4\u6839\u636e\u8fd9\u4e2a\u504f\u79fb\u8ba1\u7b97\u51fa\u5b9e\u9645\u7684\u5730\u5740</li>\n<li>\u52a8\u6001\u94fe\u63a5\u5668\u5728\u52a0\u8f7d\u7684\u65f6\u5019\uff0c\u5b83\u4f1a\u53bb\u5224\u65ad\u76ee\u6807 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u5426\u662f\u5e38\u91cf\uff1a\u5bf9\u4e8e\u53ef\u6267\u884c\u7a0b\u5e8f\u4ee5\u53ca\u968f\u7740\u7a0b\u5e8f\u542f\u52a8\u800c\u81ea\u52a8\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\uff0c\u5b83\u4eec\u7684 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u5e38\u91cf</li>\n<li>\n<p>\u5982\u679c\u76ee\u6807 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u662f\u5e38\u91cf\uff0c\u5219\u628a\u8fd9\u4e2a\u5e38\u91cf\u5199\u5165\u5230 <code>.got</code> \u8868\u4e2d TLSDESC \u53d8\u91cf\u7684 offset \u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u628a\u51fd\u6570\u6307\u9488\u6539\u5199\u6210 <code>_dl_tlsdesc_return</code>\uff0c\u5b83\u662f\u4e00\u4e2a\u5f88\u7b80\u5355\u7684\u5b9e\u73b0\uff0c\u56e0\u4e3a\u5728\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u65f6\uff0c<code>%rax</code> \u5bc4\u5b58\u5668\u6307\u5411\u4e86 TLSDESC \u7684\u5730\u5740\uff0c\u6240\u4ee5\u76f4\u63a5\u4ece <code>%rax+8</code> \u5730\u5740\u628a offset \u8bfb\u51fa\u6765\u7136\u540e\u8fd4\u56de\u5c31\u53ef\u4ee5\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-29-1\"><a id=\"__codelineno-29-1\" name=\"__codelineno-29-1\" href=\"#__codelineno-29-1\"></a><span class=\"nl\">_dl_tlsdesc_return:</span>\n</span><span id=\"__span-29-2\"><a id=\"__codelineno-29-2\" name=\"__codelineno-29-2\" href=\"#__codelineno-29-2\"></a><span class=\"w\">    </span><span class=\"nf\">movq</span><span class=\"w\">    </span><span class=\"mi\">8</span><span class=\"p\">(</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-29-3\"><a id=\"__codelineno-29-3\" name=\"__codelineno-29-3\" href=\"#__codelineno-29-3\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span></code></pre></div>\n</li>\n<li>\n<p>\u5982\u679c\u76ee\u6807 TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\u4e0d\u662f\u5e38\u91cf\uff0c\u5219\u628a\u51fd\u6570\u6307\u9488\u6539\u5199\u6210 <code>_dl_tlsdesc_dynamic</code> \u51fd\u6570\uff0c\u518d\u8d70\u548c\u4e4b\u524d\u7684 <code>__tls_get_addr</code> \u7c7b\u4f3c\u7684\u903b\u8f91\uff0c\u5b8c\u6210\u5269\u4e0b\u7684\u67e5\u627e\uff1b\u7531\u4e8e\u8fd4\u56de\u503c\u662f TLS \u53d8\u91cf\u76f8\u5bf9 <code>%fs</code> \u7684\u504f\u79fb\uff0c\u6240\u4ee5\u8fd4\u56de\u4e4b\u524d\u8fd8\u8981\u51cf\u53bb <code>%fs</code> \u7684\u5730\u5740\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-30-1\"><a id=\"__codelineno-30-1\" name=\"__codelineno-30-1\" href=\"#__codelineno-30-1\"></a><span class=\"cm\">/* %rax points to the TLS descriptor, such that 0(%rax) points to</span>\n</span><span id=\"__span-30-2\"><a id=\"__codelineno-30-2\" name=\"__codelineno-30-2\" href=\"#__codelineno-30-2\"></a><span class=\"cm\">    _dl_tlsdesc_dynamic itself, and 8(%rax) points to a struct</span>\n</span><span id=\"__span-30-3\"><a id=\"__codelineno-30-3\" name=\"__codelineno-30-3\" href=\"#__codelineno-30-3\"></a><span class=\"cm\">    tlsdesc_dynamic_arg object.  It must return in %rax the offset</span>\n</span><span id=\"__span-30-4\"><a id=\"__codelineno-30-4\" name=\"__codelineno-30-4\" href=\"#__codelineno-30-4\"></a><span class=\"cm\">    between the thread pointer and the object denoted by the</span>\n</span><span id=\"__span-30-5\"><a id=\"__codelineno-30-5\" name=\"__codelineno-30-5\" href=\"#__codelineno-30-5\"></a><span class=\"cm\">    argument, without clobbering any registers.</span>\n</span><span id=\"__span-30-6\"><a id=\"__codelineno-30-6\" name=\"__codelineno-30-6\" href=\"#__codelineno-30-6\"></a>\n</span><span id=\"__span-30-7\"><a id=\"__codelineno-30-7\" name=\"__codelineno-30-7\" href=\"#__codelineno-30-7\"></a><span class=\"cm\">    The assembly code that follows is a rendition of the following</span>\n</span><span id=\"__span-30-8\"><a id=\"__codelineno-30-8\" name=\"__codelineno-30-8\" href=\"#__codelineno-30-8\"></a><span class=\"cm\">    C code, hand-optimized a little bit.</span>\n</span><span id=\"__span-30-9\"><a id=\"__codelineno-30-9\" name=\"__codelineno-30-9\" href=\"#__codelineno-30-9\"></a>\n</span><span id=\"__span-30-10\"><a id=\"__codelineno-30-10\" name=\"__codelineno-30-10\" href=\"#__codelineno-30-10\"></a><span class=\"cm\">ptrdiff_t</span>\n</span><span id=\"__span-30-11\"><a id=\"__codelineno-30-11\" name=\"__codelineno-30-11\" href=\"#__codelineno-30-11\"></a><span class=\"cm\">_dl_tlsdesc_dynamic (register struct tlsdesc *tdp asm (&quot;%rax&quot;))</span>\n</span><span id=\"__span-30-12\"><a id=\"__codelineno-30-12\" name=\"__codelineno-30-12\" href=\"#__codelineno-30-12\"></a><span class=\"cm\">{</span>\n</span><span id=\"__span-30-13\"><a id=\"__codelineno-30-13\" name=\"__codelineno-30-13\" href=\"#__codelineno-30-13\"></a><span class=\"cm\">struct tlsdesc_dynamic_arg *td = tdp-&gt;arg;</span>\n</span><span id=\"__span-30-14\"><a id=\"__codelineno-30-14\" name=\"__codelineno-30-14\" href=\"#__codelineno-30-14\"></a><span class=\"cm\">dtv_t *dtv = *(dtv_t **)((char *)__thread_pointer + DTV_OFFSET);</span>\n</span><span id=\"__span-30-15\"><a id=\"__codelineno-30-15\" name=\"__codelineno-30-15\" href=\"#__codelineno-30-15\"></a><span class=\"cm\">if (__builtin_expect (td-&gt;gen_count &lt;= dtv[0].counter</span>\n</span><span id=\"__span-30-16\"><a id=\"__codelineno-30-16\" name=\"__codelineno-30-16\" href=\"#__codelineno-30-16\"></a><span class=\"cm\">            &amp;&amp; (dtv[td-&gt;tlsinfo.ti_module].pointer.val</span>\n</span><span id=\"__span-30-17\"><a id=\"__codelineno-30-17\" name=\"__codelineno-30-17\" href=\"#__codelineno-30-17\"></a><span class=\"cm\">                != TLS_DTV_UNALLOCATED),</span>\n</span><span id=\"__span-30-18\"><a id=\"__codelineno-30-18\" name=\"__codelineno-30-18\" href=\"#__codelineno-30-18\"></a><span class=\"cm\">            1))</span>\n</span><span id=\"__span-30-19\"><a id=\"__codelineno-30-19\" name=\"__codelineno-30-19\" href=\"#__codelineno-30-19\"></a><span class=\"cm\">    return dtv[td-&gt;tlsinfo.ti_module].pointer.val + td-&gt;tlsinfo.ti_offset</span>\n</span><span id=\"__span-30-20\"><a id=\"__codelineno-30-20\" name=\"__codelineno-30-20\" href=\"#__codelineno-30-20\"></a><span class=\"cm\">    - __thread_pointer;</span>\n</span><span id=\"__span-30-21\"><a id=\"__codelineno-30-21\" name=\"__codelineno-30-21\" href=\"#__codelineno-30-21\"></a>\n</span><span id=\"__span-30-22\"><a id=\"__codelineno-30-22\" name=\"__codelineno-30-22\" href=\"#__codelineno-30-22\"></a><span class=\"cm\">return __tls_get_addr_internal (&amp;td-&gt;tlsinfo) - __thread_pointer;</span>\n</span><span id=\"__span-30-23\"><a id=\"__codelineno-30-23\" name=\"__codelineno-30-23\" href=\"#__codelineno-30-23\"></a><span class=\"cm\">}</span>\n</span><span id=\"__span-30-24\"><a id=\"__codelineno-30-24\" name=\"__codelineno-30-24\" href=\"#__codelineno-30-24\"></a><span class=\"cm\">*/</span>\n</span></code></pre></div>\n</li>\n</ol>\n<p>\u5b83\u5229\u7528\u7684\u4e5f\u662f\u5728\u5185\u5b58\u4e2d\u4fdd\u5b58\u51fd\u6570\u6307\u9488\uff0c\u901a\u8fc7\u8fd0\u884c\u65f6\u66ff\u6362\u51fd\u6570\u6307\u9488\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0 slow path \u5230 fast path \u7684\u52a8\u6001\u66ff\u6362\u3002</p>\n<h2 id=\"dtv-\u7ef4\u62a4\">dtv \u7ef4\u62a4<a class=\"headerlink\" href=\"#dtv-\u7ef4\u62a4\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u540e\u518d\u6765\u6df1\u5165\u5206\u6790\u4e00\u4e0b dtv \u7684\u7ef4\u62a4\u65b9\u5f0f\u3002\u524d\u9762\u63d0\u5230\uff0cdtv \u7684\u6307\u9488\u662f\u4fdd\u5b58\u5728 <code>struct pthread</code> \u5185\u7684\uff0c\u800c <code>struct pthread</code> \u53c8\u662f\u4fdd\u5b58\u5728 <code>%fs</code> \u5bc4\u5b58\u5668\u6307\u5411\u7684\u4f4d\u7f6e\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-31-1\"><a id=\"__codelineno-31-1\" name=\"__codelineno-31-1\" href=\"#__codelineno-31-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pthread</span>\n</span><span id=\"__span-31-2\"><a id=\"__codelineno-31-2\" name=\"__codelineno-31-2\" href=\"#__codelineno-31-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-31-3\"><a id=\"__codelineno-31-3\" name=\"__codelineno-31-3\" href=\"#__codelineno-31-3\"></a><span class=\"w\">  </span><span class=\"n\">tcbhead_t</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-4\"><a id=\"__codelineno-31-4\" name=\"__codelineno-31-4\" href=\"#__codelineno-31-4\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-31-5\"><a id=\"__codelineno-31-5\" name=\"__codelineno-31-5\" href=\"#__codelineno-31-5\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-31-6\"><a id=\"__codelineno-31-6\" name=\"__codelineno-31-6\" href=\"#__codelineno-31-6\"></a>\n</span><span id=\"__span-31-7\"><a id=\"__codelineno-31-7\" name=\"__codelineno-31-7\" href=\"#__codelineno-31-7\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span>\n</span><span id=\"__span-31-8\"><a id=\"__codelineno-31-8\" name=\"__codelineno-31-8\" href=\"#__codelineno-31-8\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-31-9\"><a id=\"__codelineno-31-9\" name=\"__codelineno-31-9\" href=\"#__codelineno-31-9\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-31-10\"><a id=\"__codelineno-31-10\" name=\"__codelineno-31-10\" href=\"#__codelineno-31-10\"></a><span class=\"w\">  </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-11\"><a id=\"__codelineno-31-11\" name=\"__codelineno-31-11\" href=\"#__codelineno-31-11\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-31-12\"><a id=\"__codelineno-31-12\" name=\"__codelineno-31-12\" href=\"#__codelineno-31-12\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcbhead_t</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u6240\u4ee5\u8981\u8bbf\u95ee dtv \u4e5f\u5f88\u7b80\u5355\uff0c\u76f4\u63a5\u4ece <code>%fs</code> \u52a0\u5b83\u5728 <code>struct pthread</code> \u7ed3\u6784\u4f53\u5185\u7684\u504f\u79fb\u5373\u53ef\u3002</p>\n<p>\u524d\u9762\u63d0\u5230\uff0c\u5728\u8c03\u7528 <code>__tls_get_addr</code> \u65f6\uff0c\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u52a8\u6001\u5e93\u7684 ID \u6765\u67e5\u8be2\u5f97\u5230\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u518d\u52a0\u4e0a\u5728\u8fd9\u4e2a TLS \u7a7a\u95f4\u5185\u7684\u504f\u79fb\u3002\u800c\u8fd9\u4e2a\u52a8\u6001\u5e93\u7684 ID\uff0c\u6b63\u597d\u5c31\u662f dtv \u6570\u7ec4\u7684\u4e0b\u6807\uff0c\u6240\u4ee5 <code>__tls_get_addr</code> \u505a\u7684\u4e8b\u60c5\u5927\u6982\u662f\uff1a</p>\n<ol>\n<li>\u627e\u5230 <code>dtv</code> \u7684\u5730\u5740\uff1a<code>mov %fs:DTV_OFFSET, %RDX_LP</code></li>\n<li>\u4ece <code>__tls_get_addr</code> \u51fd\u6570\u7684\u53c2\u6570\u91cc\u8bfb\u53d6 <code>ti_module</code> \u5b57\u6bb5\uff1a<code>mov TI_MODULE_OFFSET(%rdi), %RAX_LP</code></li>\n<li>\n<p>\u8bfb\u53d6 <code>dtv[ti-&gt;ti_module].val</code>\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u6a21\u5757\u7684 TLS \u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff1a<code>salq $4, %rax; movq (%rdx, %rax), %rax</code>\uff0c\u8fd9\u91cc\u5de6\u79fb 4 \u4f4d\u662f\u56e0\u4e3a <code>dtv</code> \u6570\u7ec4\u7684\u6bcf\u4e2a\u5143\u7d20\u7684\u7c7b\u578b\u662f <code>dtv_t</code>\uff0c\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<p><div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-32-1\"><a id=\"__codelineno-32-1\" name=\"__codelineno-32-1\" href=\"#__codelineno-32-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span>\n</span><span id=\"__span-32-2\"><a id=\"__codelineno-32-2\" name=\"__codelineno-32-2\" href=\"#__codelineno-32-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-32-3\"><a id=\"__codelineno-32-3\" name=\"__codelineno-32-3\" href=\"#__codelineno-32-3\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">val</span><span class=\"p\">;</span><span class=\"w\">                    </span><span class=\"cm\">/* Pointer to data, or TLS_DTV_UNALLOCATED.  */</span>\n</span><span id=\"__span-32-4\"><a id=\"__codelineno-32-4\" name=\"__codelineno-32-4\" href=\"#__codelineno-32-4\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">to_free</span><span class=\"p\">;</span><span class=\"w\">                </span><span class=\"cm\">/* Unaligned pointer, for deallocation.  */</span>\n</span><span id=\"__span-32-5\"><a id=\"__codelineno-32-5\" name=\"__codelineno-32-5\" href=\"#__codelineno-32-5\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-32-6\"><a id=\"__codelineno-32-6\" name=\"__codelineno-32-6\" href=\"#__codelineno-32-6\"></a>\n</span><span id=\"__span-32-7\"><a id=\"__codelineno-32-7\" name=\"__codelineno-32-7\" href=\"#__codelineno-32-7\"></a><span class=\"cm\">/* Type for the dtv.  */</span>\n</span><span id=\"__span-32-8\"><a id=\"__codelineno-32-8\" name=\"__codelineno-32-8\" href=\"#__codelineno-32-8\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"nc\">dtv</span>\n</span><span id=\"__span-32-9\"><a id=\"__codelineno-32-9\" name=\"__codelineno-32-9\" href=\"#__codelineno-32-9\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-32-10\"><a id=\"__codelineno-32-10\" name=\"__codelineno-32-10\" href=\"#__codelineno-32-10\"></a><span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-11\"><a id=\"__codelineno-32-11\" name=\"__codelineno-32-11\" href=\"#__codelineno-32-11\"></a><span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"w\"> </span><span class=\"n\">pointer</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-12\"><a id=\"__codelineno-32-12\" name=\"__codelineno-32-12\" href=\"#__codelineno-32-12\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">dtv_t</span><span class=\"p\">;</span>\n</span></code></pre></div>\n4. \u628a\u8d77\u59cb\u5730\u5740\u52a0\u4e0a\u504f\u79fb\uff0c\u7136\u540e\u8fd4\u56de\uff1a<code>add TI_OFFSET_OFFSET(%rdi), %RAX_LP; ret</code></p>\n</li>\n</ol>\n<p>\u4f46\u5b9e\u9645\u60c5\u51b5\u4f1a\u6bd4\u8fd9\u4e2a\u66f4\u590d\u6742\uff1adlopen \u53ef\u80fd\u4f1a\u52a8\u6001\u5f15\u5165\u65b0\u7684\u52a8\u6001\u5e93\uff0c\u6b64\u65f6 dtv \u6570\u7ec4\u53ef\u80fd\u9700\u8981\u6269\u5f20\uff1b\u6b64\u5916\uff0c\u5982\u679c\u4e00\u4e2a\u52a8\u6001\u5e93\u6709 TLS \u53d8\u91cf\u4f46\u662f\u4ece\u6765\u4e0d\u7528\uff0c\u4e5f\u53ef\u4ee5 lazy \u5206\u914d\u5b83\u7684 TLS \u7a7a\u95f4\uff0c\u53ea\u6709\u5728\u7b2c\u4e00\u6b21\u8bbf\u95ee\u7684\u65f6\u5019\uff0c\u624d\u53bb\u5206\u914d\u3002</p>\n<p>\u9996\u5148\u6765\u8003\u8651\u7b2c\u4e00\u4e2a\u9700\u6c42\uff0c\u5904\u7406 dlopen \u5bfc\u81f4 dtv \u5143\u7d20\u4e2a\u6570\u53d8\u5316\uff0c\u5b83\u7684\u5b9e\u73b0\u65b9\u6cd5\u662f\u8fd9\u6837\u7684\uff1a</p>\n<ol>\n<li>\n<p><code>dtv[0]</code> \u4e0d\u7528\u6765\u4fdd\u5b58 TLS \u7a7a\u95f4\u7684\u4fe1\u606f\uff0c\u800c\u662f\u8bb0\u5f55\u4e00\u4e2a counter\uff0c\u8fd9\u4e2a counter \u8bb0\u5f55\u7684\u662f\u5f53\u524d dtv \u7684\u7248\u672c\u53f7\uff08generation\uff09\uff0c\u53e6\u5916\u5728\u5168\u5c40\u53d8\u91cf <code>dl_tls_generation</code> \u4e2d\u8bb0\u5f55\u5f53\u524d\u6700\u65b0\u7684\u7248\u672c\u53f7\uff1b\u5f53 dlopen \u5bfc\u81f4 dtv \u7ed3\u6784\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u66f4\u65b0 <code>dl_tls_generation</code> \u7248\u672c\uff0c\u7136\u540e\u5728 <code>__tls_get_addr</code> \u91cc\u68c0\u67e5\u7248\u672c\u53f7\uff0c\u4e0d\u4e00\u81f4\u5219\u8fdb\u5165 slow path\uff1a</p>\n<p><div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-33-1\"><a id=\"__codelineno-33-1\" name=\"__codelineno-33-1\" href=\"#__codelineno-33-1\"></a><span class=\"nf\">ENTRY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">__tls_get_addr</span><span class=\"p\">)</span>\n</span><span id=\"__span-33-2\"><a id=\"__codelineno-33-2\" name=\"__codelineno-33-2\" href=\"#__codelineno-33-2\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"no\">DTV_OFFSET</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%RDX_LP</span>\n</span><span id=\"__span-33-3\"><a id=\"__codelineno-33-3\" name=\"__codelineno-33-3\" href=\"#__codelineno-33-3\"></a>\n</span><span id=\"__span-33-4\"><a id=\"__codelineno-33-4\" name=\"__codelineno-33-4\" href=\"#__codelineno-33-4\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">GL_TLS_GENERATION_OFFSET</span><span class=\"err\">+</span><span class=\"no\">_rtld_local</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-33-5\"><a id=\"__codelineno-33-5\" name=\"__codelineno-33-5\" href=\"#__codelineno-33-5\"></a><span class=\"w\">    </span><span class=\"cm\">/* GL(dl_tls_generation) == dtv[0].counter */</span>\n</span><span id=\"__span-33-6\"><a id=\"__codelineno-33-6\" name=\"__codelineno-33-6\" href=\"#__codelineno-33-6\"></a><span class=\"w\">    </span><span class=\"nf\">cmp</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">)</span>\n</span><span id=\"__span-33-7\"><a id=\"__codelineno-33-7\" name=\"__codelineno-33-7\" href=\"#__codelineno-33-7\"></a><span class=\"w\">    </span><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-33-8\"><a id=\"__codelineno-33-8\" name=\"__codelineno-33-8\" href=\"#__codelineno-33-8\"></a>\n</span><span id=\"__span-33-9\"><a id=\"__codelineno-33-9\" name=\"__codelineno-33-9\" href=\"#__codelineno-33-9\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">TI_MODULE_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-33-10\"><a id=\"__codelineno-33-10\" name=\"__codelineno-33-10\" href=\"#__codelineno-33-10\"></a><span class=\"w\">    </span><span class=\"cm\">/* dtv[ti-&gt;ti_module] */</span>\n</span><span id=\"__span-33-11\"><a id=\"__codelineno-33-11\" name=\"__codelineno-33-11\" href=\"#__codelineno-33-11\"></a><span class=\"w\">    </span><span class=\"nf\">salq</span><span class=\"w\">    </span><span class=\"no\">$4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-33-12\"><a id=\"__codelineno-33-12\" name=\"__codelineno-33-12\" href=\"#__codelineno-33-12\"></a><span class=\"w\">    </span><span class=\"nf\">movq</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">,</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-33-13\"><a id=\"__codelineno-33-13\" name=\"__codelineno-33-13\" href=\"#__codelineno-33-13\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-33-14\"><a id=\"__codelineno-33-14\" name=\"__codelineno-33-14\" href=\"#__codelineno-33-14\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">TI_OFFSET_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-33-15\"><a id=\"__codelineno-33-15\" name=\"__codelineno-33-15\" href=\"#__codelineno-33-15\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-33-16\"><a id=\"__codelineno-33-16\" name=\"__codelineno-33-16\" href=\"#__codelineno-33-16\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-33-17\"><a id=\"__codelineno-33-17\" name=\"__codelineno-33-17\" href=\"#__codelineno-33-17\"></a><span class=\"w\">    </span><span class=\"cm\">/* slow path, stack alignment omitted */</span>\n</span><span id=\"__span-33-18\"><a id=\"__codelineno-33-18\" name=\"__codelineno-33-18\" href=\"#__codelineno-33-18\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\">    </span><span class=\"no\">__tls_get_addr_slow</span>\n</span><span id=\"__span-33-19\"><a id=\"__codelineno-33-19\" name=\"__codelineno-33-19\" href=\"#__codelineno-33-19\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span></code></pre></div>\n2. \u5728 <code>__tls_get_addr_slow</code> \u4e2d\uff0c\u5982\u679c\u53d1\u73b0\u5f53\u524d dtv \u7684\u7248\u672c\u53f7\u548c\u6700\u65b0\u7684\u7248\u672c\u53f7 <code>dl_tls_generation</code> \u4e0d\u4e00\u81f4\uff0c\u5c31\u8c03\u7528 <code>update_get_addr</code> \u6765\u91cd\u65b0\u5206\u914d\u5185\u5b58\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-34-1\"><a id=\"__codelineno-34-1\" name=\"__codelineno-34-1\" href=\"#__codelineno-34-1\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span>\n</span><span id=\"__span-34-2\"><a id=\"__codelineno-34-2\" name=\"__codelineno-34-2\" href=\"#__codelineno-34-2\"></a><span class=\"nf\">__tls_get_addr_slow</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tls_index</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ti</span><span class=\"p\">)</span>\n</span><span id=\"__span-34-3\"><a id=\"__codelineno-34-3\" name=\"__codelineno-34-3\" href=\"#__codelineno-34-3\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-34-4\"><a id=\"__codelineno-34-4\" name=\"__codelineno-34-4\" href=\"#__codelineno-34-4\"></a><span class=\"w\">    </span><span class=\"n\">dtv_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dtv</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">THREAD_DTV</span><span class=\"w\"> </span><span class=\"p\">();</span>\n</span><span id=\"__span-34-5\"><a id=\"__codelineno-34-5\" name=\"__codelineno-34-5\" href=\"#__codelineno-34-5\"></a>\n</span><span id=\"__span-34-6\"><a id=\"__codelineno-34-6\" name=\"__codelineno-34-6\" href=\"#__codelineno-34-6\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">dtv</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">GL</span><span class=\"p\">(</span><span class=\"n\">dl_tls_generation</span><span class=\"p\">)))</span>\n</span><span id=\"__span-34-7\"><a id=\"__codelineno-34-7\" name=\"__codelineno-34-7\" href=\"#__codelineno-34-7\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">update_get_addr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ti</span><span class=\"p\">);</span>\n</span><span id=\"__span-34-8\"><a id=\"__codelineno-34-8\" name=\"__codelineno-34-8\" href=\"#__codelineno-34-8\"></a>\n</span><span id=\"__span-34-9\"><a id=\"__codelineno-34-9\" name=\"__codelineno-34-9\" href=\"#__codelineno-34-9\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tls_get_addr_tail</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ti</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dtv</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">);</span>\n</span><span id=\"__span-34-10\"><a id=\"__codelineno-34-10\" name=\"__codelineno-34-10\" href=\"#__codelineno-34-10\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n</li>\n</ol>\n<p>\u5177\u4f53\u7684 dtv \u66f4\u65b0\u903b\u8f91\u6bd4\u8f83\u590d\u6742\uff0c\u6709\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u7ffb\u9605 glibc \u7684\u6e90\u7801\u4e2d <code>update_get_addr</code> \u51fd\u6570\u7684\u5b9e\u73b0\u3002</p>\n<p>\u63a5\u4e0b\u6765\u8003\u8651\u7b2c\u4e8c\u4e2a\u9700\u6c42\uff0c\u4e5f\u5c31\u662f lazy \u5206\u914d\uff0c\u53ea\u6709\u5728\u7b2c\u4e00\u6b21\u8bbf\u95ee TLS \u7a7a\u95f4\u7684\u65f6\u5019\uff0c\u624d\u7ed9 dlopen \u7684\u52a8\u6001\u5e93\u5206\u914d TLS \u7a7a\u95f4\u3002\u4e3a\u4e86\u533a\u5206\u5df2\u5206\u914d\u548c\u672a\u5206\u914d\u7684 TLS \u7a7a\u95f4\uff0c\u672a\u5206\u914d\u7684 TLS \u7a7a\u95f4\u7684 <code>val</code> \u5b57\u6bb5\u7684\u503c\u662f <code>TLS_DTV_UNALLOCATED</code>\uff0c\u5f53 <code>__tls_get_addr</code> \u68c0\u6d4b\u5230 TLS \u7a7a\u95f4\u5c1a\u672a\u5206\u914d\u65f6\uff0c\u4e5f\u4f1a\u8fdb\u5165 slow path\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-35-1\"><a id=\"__codelineno-35-1\" name=\"__codelineno-35-1\" href=\"#__codelineno-35-1\"></a><span class=\"nf\">ENTRY</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">__tls_get_addr</span><span class=\"p\">)</span>\n</span><span id=\"__span-35-2\"><a id=\"__codelineno-35-2\" name=\"__codelineno-35-2\" href=\"#__codelineno-35-2\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%fs</span><span class=\"p\">:</span><span class=\"no\">DTV_OFFSET</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%RDX_LP</span>\n</span><span id=\"__span-35-3\"><a id=\"__codelineno-35-3\" name=\"__codelineno-35-3\" href=\"#__codelineno-35-3\"></a>\n</span><span id=\"__span-35-4\"><a id=\"__codelineno-35-4\" name=\"__codelineno-35-4\" href=\"#__codelineno-35-4\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">GL_TLS_GENERATION_OFFSET</span><span class=\"err\">+</span><span class=\"no\">_rtld_local</span><span class=\"p\">(</span><span class=\"nv\">%rip</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-5\"><a id=\"__codelineno-35-5\" name=\"__codelineno-35-5\" href=\"#__codelineno-35-5\"></a><span class=\"w\">    </span><span class=\"cm\">/* GL(dl_tls_generation) == dtv[0].counter */</span>\n</span><span id=\"__span-35-6\"><a id=\"__codelineno-35-6\" name=\"__codelineno-35-6\" href=\"#__codelineno-35-6\"></a><span class=\"w\">    </span><span class=\"nf\">cmp</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">)</span>\n</span><span id=\"__span-35-7\"><a id=\"__codelineno-35-7\" name=\"__codelineno-35-7\" href=\"#__codelineno-35-7\"></a><span class=\"w\">    </span><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-35-8\"><a id=\"__codelineno-35-8\" name=\"__codelineno-35-8\" href=\"#__codelineno-35-8\"></a>\n</span><span id=\"__span-35-9\"><a id=\"__codelineno-35-9\" name=\"__codelineno-35-9\" href=\"#__codelineno-35-9\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"no\">TI_MODULE_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-10\"><a id=\"__codelineno-35-10\" name=\"__codelineno-35-10\" href=\"#__codelineno-35-10\"></a><span class=\"w\">    </span><span class=\"cm\">/* dtv[ti-&gt;ti_module] */</span>\n</span><span id=\"__span-35-11\"><a id=\"__codelineno-35-11\" name=\"__codelineno-35-11\" href=\"#__codelineno-35-11\"></a><span class=\"w\">    </span><span class=\"nf\">salq</span><span class=\"w\">    </span><span class=\"no\">$4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-35-12\"><a id=\"__codelineno-35-12\" name=\"__codelineno-35-12\" href=\"#__codelineno-35-12\"></a><span class=\"w\">    </span><span class=\"nf\">movq</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">%rdx</span><span class=\"p\">,</span><span class=\"nv\">%rax</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rax</span>\n</span><span id=\"__span-35-13\"><a id=\"__codelineno-35-13\" name=\"__codelineno-35-13\" href=\"#__codelineno-35-13\"></a>\n</span><span id=\"__span-35-14\"><a id=\"__codelineno-35-14\" name=\"__codelineno-35-14\" href=\"#__codelineno-35-14\"></a><span class=\"w\">    </span><span class=\"cm\">/* branch if val == TLS_DTV_UNALLOCATED */</span>\n</span><span id=\"__span-35-15\"><a id=\"__codelineno-35-15\" name=\"__codelineno-35-15\" href=\"#__codelineno-35-15\"></a><span class=\"w\">    </span><span class=\"nf\">cmp</span><span class=\"w\"> </span><span class=\"no\">$-1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-16\"><a id=\"__codelineno-35-16\" name=\"__codelineno-35-16\" href=\"#__codelineno-35-16\"></a><span class=\"w\">    </span><span class=\"nf\">je</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-35-17\"><a id=\"__codelineno-35-17\" name=\"__codelineno-35-17\" href=\"#__codelineno-35-17\"></a>\n</span><span id=\"__span-35-18\"><a id=\"__codelineno-35-18\" name=\"__codelineno-35-18\" href=\"#__codelineno-35-18\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">TI_OFFSET_OFFSET</span><span class=\"p\">(</span><span class=\"nv\">%rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%RAX_LP</span>\n</span><span id=\"__span-35-19\"><a id=\"__codelineno-35-19\" name=\"__codelineno-35-19\" href=\"#__codelineno-35-19\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-35-20\"><a id=\"__codelineno-35-20\" name=\"__codelineno-35-20\" href=\"#__codelineno-35-20\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-35-21\"><a id=\"__codelineno-35-21\" name=\"__codelineno-35-21\" href=\"#__codelineno-35-21\"></a><span class=\"w\">    </span><span class=\"cm\">/* slow path, stack alignment omitted */</span>\n</span><span id=\"__span-35-22\"><a id=\"__codelineno-35-22\" name=\"__codelineno-35-22\" href=\"#__codelineno-35-22\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\">    </span><span class=\"no\">__tls_get_addr_slow</span>\n</span><span id=\"__span-35-23\"><a id=\"__codelineno-35-23\" name=\"__codelineno-35-23\" href=\"#__codelineno-35-23\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span></code></pre></div>\n<p>\u5728 slow path \u4e2d\uff0c\u6700\u7ec8\u7531 <code>allocate_dtv_entry</code> \u51fd\u6570\u6765\u5206\u914d\u8fd9\u7247\u7a7a\u95f4\uff0c\u6ce8\u610f\u5230 TLS \u7a7a\u95f4\u53ef\u80fd\u6709\u5bf9\u9f50\u7684\u8981\u6c42\uff0c\u6240\u4ee5\u5b83\u5b9e\u9645\u4e0a\u8bb0\u5f55\u4e86\u4e24\u4e2a\u5730\u5740\uff0c\u4e00\u4e2a\u662f malloc \u5f97\u5230\u7684\u5730\u5740\uff08\u7528\u4e8e\u540e\u7eed\u7684 free \u8c03\u7528\uff09\uff0c\u4e00\u4e2a\u662f\u7ecf\u8fc7\u5bf9\u9f50\u540e\u7684\u5730\u5740\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-36-1\"><a id=\"__codelineno-36-1\" name=\"__codelineno-36-1\" href=\"#__codelineno-36-1\"></a><span class=\"cm\">/* Allocate one DTV entry.  */</span>\n</span><span id=\"__span-36-2\"><a id=\"__codelineno-36-2\" name=\"__codelineno-36-2\" href=\"#__codelineno-36-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span>\n</span><span id=\"__span-36-3\"><a id=\"__codelineno-36-3\" name=\"__codelineno-36-3\" href=\"#__codelineno-36-3\"></a><span class=\"n\">allocate_dtv_entry</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span>\n</span><span id=\"__span-36-4\"><a id=\"__codelineno-36-4\" name=\"__codelineno-36-4\" href=\"#__codelineno-36-4\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-36-5\"><a id=\"__codelineno-36-5\" name=\"__codelineno-36-5\" href=\"#__codelineno-36-5\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">powerof2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">alignment</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"k\">_Alignof</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">max_align_t</span><span class=\"p\">))</span>\n</span><span id=\"__span-36-6\"><a id=\"__codelineno-36-6\" name=\"__codelineno-36-6\" href=\"#__codelineno-36-6\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n</span><span id=\"__span-36-7\"><a id=\"__codelineno-36-7\" name=\"__codelineno-36-7\" href=\"#__codelineno-36-7\"></a><span class=\"w\">      </span><span class=\"cm\">/* The alignment is supported by malloc.  */</span>\n</span><span id=\"__span-36-8\"><a id=\"__codelineno-36-8\" name=\"__codelineno-36-8\" href=\"#__codelineno-36-8\"></a><span class=\"w\">      </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-36-9\"><a id=\"__codelineno-36-9\" name=\"__codelineno-36-9\" href=\"#__codelineno-36-9\"></a><span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">};</span>\n</span><span id=\"__span-36-10\"><a id=\"__codelineno-36-10\" name=\"__codelineno-36-10\" href=\"#__codelineno-36-10\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-36-11\"><a id=\"__codelineno-36-11\" name=\"__codelineno-36-11\" href=\"#__codelineno-36-11\"></a>\n</span><span id=\"__span-36-12\"><a id=\"__codelineno-36-12\" name=\"__codelineno-36-12\" href=\"#__codelineno-36-12\"></a><span class=\"w\">  </span><span class=\"cm\">/* Emulate memalign to by manually aligning a pointer returned by</span>\n</span><span id=\"__span-36-13\"><a id=\"__codelineno-36-13\" name=\"__codelineno-36-13\" href=\"#__codelineno-36-13\"></a><span class=\"cm\">     malloc.  First compute the size with an overflow check.  */</span>\n</span><span id=\"__span-36-14\"><a id=\"__codelineno-36-14\" name=\"__codelineno-36-14\" href=\"#__codelineno-36-14\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">alloc_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"p\">;</span>\n</span><span id=\"__span-36-15\"><a id=\"__codelineno-36-15\" name=\"__codelineno-36-15\" href=\"#__codelineno-36-15\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">alloc_size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span>\n</span><span id=\"__span-36-16\"><a id=\"__codelineno-36-16\" name=\"__codelineno-36-16\" href=\"#__codelineno-36-16\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n</span><span id=\"__span-36-17\"><a id=\"__codelineno-36-17\" name=\"__codelineno-36-17\" href=\"#__codelineno-36-17\"></a>\n</span><span id=\"__span-36-18\"><a id=\"__codelineno-36-18\" name=\"__codelineno-36-18\" href=\"#__codelineno-36-18\"></a><span class=\"w\">  </span><span class=\"cm\">/* Perform the allocation.  This is the pointer we need to free</span>\n</span><span id=\"__span-36-19\"><a id=\"__codelineno-36-19\" name=\"__codelineno-36-19\" href=\"#__codelineno-36-19\"></a><span class=\"cm\">     later.  */</span>\n</span><span id=\"__span-36-20\"><a id=\"__codelineno-36-20\" name=\"__codelineno-36-20\" href=\"#__codelineno-36-20\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">alloc_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-36-21\"><a id=\"__codelineno-36-21\" name=\"__codelineno-36-21\" href=\"#__codelineno-36-21\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-36-22\"><a id=\"__codelineno-36-22\" name=\"__codelineno-36-22\" href=\"#__codelineno-36-22\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n</span><span id=\"__span-36-23\"><a id=\"__codelineno-36-23\" name=\"__codelineno-36-23\" href=\"#__codelineno-36-23\"></a>\n</span><span id=\"__span-36-24\"><a id=\"__codelineno-36-24\" name=\"__codelineno-36-24\" href=\"#__codelineno-36-24\"></a><span class=\"w\">  </span><span class=\"cm\">/* Find the aligned position within the larger allocation.  */</span>\n</span><span id=\"__span-36-25\"><a id=\"__codelineno-36-25\" name=\"__codelineno-36-25\" href=\"#__codelineno-36-25\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">roundup</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">uintptr_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"p\">);</span>\n</span><span id=\"__span-36-26\"><a id=\"__codelineno-36-26\" name=\"__codelineno-36-26\" href=\"#__codelineno-36-26\"></a>\n</span><span id=\"__span-36-27\"><a id=\"__codelineno-36-27\" name=\"__codelineno-36-27\" href=\"#__codelineno-36-27\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">dtv_pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">to_free</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"p\">};</span>\n</span><span id=\"__span-36-28\"><a id=\"__codelineno-36-28\" name=\"__codelineno-36-28\" href=\"#__codelineno-36-28\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u89c1\u8fd9\u4e9b lazy \u5206\u914d\u7684 TLS \u7a7a\u95f4\u90fd\u662f\u653e\u5728\u5806\u4e0a\u7684\uff0c\u7531 malloc \u8fdb\u884c\u52a8\u6001\u5206\u914d\u3002\u800c\u53ef\u6267\u884c\u7a0b\u5e8f\u548c\u968f\u7740\u7a0b\u5e8f\u542f\u52a8\u800c\u81ea\u52a8\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u7684 TLS \u7a7a\u95f4\uff0c\u662f\u968f\u7740 TCB \u4e5f\u5c31\u662f <code>struct pthread</code> \u4e00\u8d77\u5206\u914d\u7684\u3002\u5bf9\u4e8e\u65b0\u521b\u5efa\u7684\u7ebf\u7a0b\u6765\u8bf4\uff0cTCB \u653e\u7f6e\u5728\u6808\u7684\u9876\u90e8\uff0c\u800c\u4e0d\u662f\u5728\u5806\u4e0a\uff0c\u6240\u4ee5\u8981\u6c42\u5927\u5c0f\u4e0d\u80fd\u52a8\u6001\u53d8\u5316\uff0c\u53ea\u6709 dtv \u6570\u7ec4\u7684\u6307\u9488\u4fdd\u5b58\u5728 <code>struct pthread</code> \u4e2d\uff0cdtv \u6570\u7ec4\u672c\u8eab\u662f\u653e\u5728\u5806\u4e0a\u7684\uff0c\u6839\u636e\u9700\u8981\u8fdb\u884c malloc/realloc\uff08\u89c1 <code>_dl_resize_dtv</code> \u51fd\u6570\uff09\u3002\u5bf9\u4e8e\u521d\u59cb\u7ebf\u7a0b\u6765\u8bf4\uff0cTCB \u662f\u901a\u8fc7 malloc \u6216\u8005 sbrk \u52a8\u6001\u5206\u914d\u7684\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://www.akkadia.org/drepper/tls.pdf\">ELF Handling For Thread-Local Storage</a></li>\n<li><a href=\"https://maskray.me/blog/2021-02-14-all-about-thread-local-storage\">All about thread-local storage</a></li>\n<li><a href=\"https://stackoverflow.com/questions/8482079/what-system-data-is-stored-on-the-stack\">What system data is stored on the stack</a></li>\n</ul>", "image": null, "date_modified": "2025-04-07T00:00:00+00:00", "authors": [], "tags": ["glibc", "linux", "software", "tls"]}, {"id": "https://jia.je/software/2025/03/30/glibc-allocator/", "url": "https://jia.je/software/2025/03/30/glibc-allocator/", "title": "glibc \u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"glibc-\u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76\">glibc \u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#glibc-\u5185\u5b58\u5206\u914d\u5668\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>malloc \u548c free \u65e5\u5e38\u7528\u7684\u5f88\u591a\uff0c\u4f46\u5b83\u5185\u90e8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f\u672c\u6587\u5bf9 glibc 2.31 \u7248\u672c\u7684\u5185\u5b58\u5206\u914d\u5668\u7684\u5b9e\u73b0\u8fdb\u884c\u63a2\u7a76\u3002</p>\n<!-- more -->\n\n<p>\u672c\u6587\u7684\u5b8c\u6574\u7248\u5185\u5bb9\u5df2\u7ecf\u6574\u5408\u5230<a href=\"/kb/software/glibc_allocator.html\">\u77e5\u8bc6\u5e93</a>\u4e2d\u3002</p>\n<h2 id=\"malloc\">malloc<a class=\"headerlink\" href=\"#malloc\" title=\"Permanent link\">&para;</a></h2>\n<p>glibc 2.31 \u662f ubuntu 20.04 \u6240\u4f7f\u7528\u7684 libc \u7248\u672c\uff0c\u9996\u5148\u6765\u5206\u6790\u5b83\u7684\u5b9e\u73b0\uff0c\u6e90\u7801\u53ef\u4ee5\u4ece <a href=\"https://github.com/bminor/glibc/tree/glibc-2.31\">glibc-2.31 tag</a> \u4e2d\u627e\u5230\u3002</p>\n<p>\u9996\u5148\u6765\u770b malloc \u51fd\u6570\uff0c\u5b83\u5b9e\u73b0\u5728 <code>malloc/malloc.c</code> \u7684 <a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3022\"><code>__libc_malloc</code></a> \u51fd\u6570\u5f53\u4e2d\uff0c\u5ffd\u7565 <code>__malloc_hook</code> \u548c\u4e00\u4e9b\u68c0\u67e5\uff0c\u9996\u5148\u53ef\u4ee5\u770b\u5230\u5b83\u6709\u4e00\u6bb5\u4ee3\u7801\uff0c\u4f7f\u7528\u4e86\u4e00\u4e2a\u53eb\u505a tcache \u7684\u6570\u636e\u7ed3\u6784\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"cm\">/* int_free also calls request2size, be careful to not pad twice.  */</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tbytes</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">checked_request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">tbytes</span><span class=\"p\">))</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"w\">    </span><span class=\"n\">__set_errno</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ENOMEM</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tbytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"n\">MAYBE_INIT_TCACHE</span><span class=\"w\"> </span><span class=\"p\">();</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"n\">DIAG_PUSH_NEEDS_COMMENT</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"n\">DIAG_POP_NEEDS_COMMENT</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<h2 id=\"tcache-thread-local-cache\">tcache (Thread Local Cache)<a class=\"headerlink\" href=\"#tcache-thread-local-cache\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u4ed4\u7ec6\u5730\u7814\u7a76 tcache \u7684\u7ed3\u6784\u3002\u9996\u5148\uff0c\u5b83\u662f\u4e00\u4e2a per-thread \u7684\u6570\u636e\u7ed3\u6784\uff0c\u610f\u5473\u7740\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u4efd tcache\uff0c\u4e0d\u9700\u8981\u4e0a\u9501\u5c31\u53ef\u4ee5\u8bbf\u95ee\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">__thread</span><span class=\"w\"> </span><span class=\"n\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u63a5\u4e0b\u6765\u770b\u5b83\u5177\u4f53\u4fdd\u5b58\u4e86\u4ec0\u4e48\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"cm\">/* We overlay this structure on the user-data portion of a chunk when</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"cm\">   the chunk is stored in the per-thread cache.  */</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a><span class=\"w\">  </span><span class=\"cm\">/* This field exists to detect double frees.  */</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_entry</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"cm\">/* There is one of these for each thread, which contains the</span>\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a><span class=\"cm\">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span>\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a><span class=\"cm\">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span>\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a><span class=\"cm\">   are redundant (we could have just counted the linked list each</span>\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a><span class=\"cm\">   time), this is for performance reasons.  */</span>\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span>\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a><span class=\"w\">  </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_perthread_struct</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-20\"><a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\" href=\"#__codelineno-2-20\"></a>\n</span><span id=\"__span-2-21\"><a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\" href=\"#__codelineno-2-21\"></a><span class=\"cm\">/* Caller must ensure that we know tc_idx is valid and there&#39;s room</span>\n</span><span id=\"__span-2-22\"><a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\" href=\"#__codelineno-2-22\"></a><span class=\"cm\">   for more chunks.  */</span>\n</span><span id=\"__span-2-23\"><a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\" href=\"#__codelineno-2-23\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">__always_inline</span><span class=\"w\"> </span><span class=\"kt\">void</span>\n</span><span id=\"__span-2-24\"><a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\" href=\"#__codelineno-2-24\"></a><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-25\"><a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\" href=\"#__codelineno-2-25\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-26\"><a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\" href=\"#__codelineno-2-26\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk</span><span class=\"p\">);</span>\n</span><span id=\"__span-2-27\"><a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\" href=\"#__codelineno-2-27\"></a>\n</span><span id=\"__span-2-28\"><a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\" href=\"#__codelineno-2-28\"></a><span class=\"w\">  </span><span class=\"cm\">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span>\n</span><span id=\"__span-2-29\"><a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\" href=\"#__codelineno-2-29\"></a><span class=\"cm\">     detect a double free.  */</span>\n</span><span id=\"__span-2-30\"><a id=\"__codelineno-2-30\" name=\"__codelineno-2-30\" href=\"#__codelineno-2-30\"></a><span class=\"w\">  </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-31\"><a id=\"__codelineno-2-31\" name=\"__codelineno-2-31\" href=\"#__codelineno-2-31\"></a>\n</span><span id=\"__span-2-32\"><a id=\"__codelineno-2-32\" name=\"__codelineno-2-32\" href=\"#__codelineno-2-32\"></a><span class=\"w\">  </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-33\"><a id=\"__codelineno-2-33\" name=\"__codelineno-2-33\" href=\"#__codelineno-2-33\"></a><span class=\"w\">  </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-34\"><a id=\"__codelineno-2-34\" name=\"__codelineno-2-34\" href=\"#__codelineno-2-34\"></a><span class=\"w\">  </span><span class=\"o\">++</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]);</span>\n</span><span id=\"__span-2-35\"><a id=\"__codelineno-2-35\" name=\"__codelineno-2-35\" href=\"#__codelineno-2-35\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-2-36\"><a id=\"__codelineno-2-36\" name=\"__codelineno-2-36\" href=\"#__codelineno-2-36\"></a>\n</span><span id=\"__span-2-37\"><a id=\"__codelineno-2-37\" name=\"__codelineno-2-37\" href=\"#__codelineno-2-37\"></a><span class=\"cm\">/* Caller must ensure that we know tc_idx is valid and there&#39;s</span>\n</span><span id=\"__span-2-38\"><a id=\"__codelineno-2-38\" name=\"__codelineno-2-38\" href=\"#__codelineno-2-38\"></a><span class=\"cm\">   available chunks to remove.  */</span>\n</span><span id=\"__span-2-39\"><a id=\"__codelineno-2-39\" name=\"__codelineno-2-39\" href=\"#__codelineno-2-39\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">__always_inline</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span>\n</span><span id=\"__span-2-40\"><a id=\"__codelineno-2-40\" name=\"__codelineno-2-40\" href=\"#__codelineno-2-40\"></a><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">)</span>\n</span><span id=\"__span-2-41\"><a id=\"__codelineno-2-41\" name=\"__codelineno-2-41\" href=\"#__codelineno-2-41\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-2-42\"><a id=\"__codelineno-2-42\" name=\"__codelineno-2-42\" href=\"#__codelineno-2-42\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">];</span>\n</span><span id=\"__span-2-43\"><a id=\"__codelineno-2-43\" name=\"__codelineno-2-43\" href=\"#__codelineno-2-43\"></a><span class=\"w\">  </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-44\"><a id=\"__codelineno-2-44\" name=\"__codelineno-2-44\" href=\"#__codelineno-2-44\"></a><span class=\"w\">  </span><span class=\"o\">--</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]);</span>\n</span><span id=\"__span-2-45\"><a id=\"__codelineno-2-45\" name=\"__codelineno-2-45\" href=\"#__codelineno-2-45\"></a><span class=\"w\">  </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-46\"><a id=\"__codelineno-2-46\" name=\"__codelineno-2-46\" href=\"#__codelineno-2-46\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">;</span>\n</span><span id=\"__span-2-47\"><a id=\"__codelineno-2-47\" name=\"__codelineno-2-47\" href=\"#__codelineno-2-47\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\u5b83\u6709\u4e24\u4e2a\u6210\u5458\uff0c\u628a tcache \u5206\u4e3a <code>TCACHE_MAX_BINS</code> \u8fd9\u4e48\u591a\u4e2a bin\uff0c\u6bcf\u4e2a bin \u5206\u522b\u6709\u4e00\u4e2a\uff1a</p>\n<ol>\n<li><code>counts[bin]</code>\uff1a\u8bb0\u5f55\u4e86\u8fd9\u4e2a bin \u4e2d\u7a7a\u95f2\u5757\u7684\u6570\u91cf\uff0c<code>tcache_put</code> \u7684\u65f6\u5019\u52a0\u4e00\uff0c<code>tcache_get</code> \u7684\u65f6\u5019\u51cf\u4e00</li>\n<li><code>entries[bin]</code>: \u6bcf\u4e2a bin \u7528\u4e00\u4e2a\u94fe\u8868\u4fdd\u5b58\u4e86\u7a7a\u95f2\u5757\uff0c\u94fe\u8868\u7684\u8282\u70b9\u7c7b\u578b\u662f <code>tcache_entry</code>\uff0c\u90a3\u4e48 <code>entries[bin]</code> \u4fdd\u5b58\u4e86\u94fe\u8868\u5934\u7684\u6307\u9488</li>\n</ol>\n<p>bin \u662f\u5185\u5b58\u5206\u914d\u5668\u7684\u4e00\u4e2a\u5e38\u89c1\u505a\u6cd5\uff0c\u628a\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\u5206 bin\uff0c\u4ece\u800c\u4fdd\u8bc1\u62ff\u5230\u7684\u7a7a\u95f2\u5757\u8db3\u591f\u5927\u3002\u63a5\u4e0b\u6765\u770b <code>tcache_put</code> \u662f\u5982\u4f55\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache \u4e2d\u7684\uff1a</p>\n<ol>\n<li>\u628a\u7a7a\u95f2\u5757\u5f3a\u5236\u8f6c\u6362\u4e3a <code>tcache_entry</code> \u7ed3\u6784\u4f53\u7c7b\u578b</li>\n<li>\u628a\u5b83\u7684 <code>key</code> \u5b57\u6bb5\u6307\u5411 tcache\uff0c\u7528\u6765\u8868\u793a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u5f53\u524d\u5728 <code>tcache</code> \u5f53\u4e2d\uff0c\u540e\u7eed\u7528\u5b83\u6765\u68c0\u6d4b double free</li>\n<li>\u4ee5\u65b0\u7684 <code>tcache_entry</code> \u4f5c\u4e3a\u94fe\u8868\u5934\uff0c\u63d2\u5165\u5230 tcache \u7684\u5bf9\u5e94\u7684 bin \u5f53\u4e2d\uff1a<code>entries[tc_idx]</code></li>\n<li>\u66f4\u65b0\u8fd9\u4e2a bin \u7684\u7a7a\u95f2\u5757\u4e2a\u6570\u5230 <code>count[tc_idx]</code> \u5f53\u4e2d</li>\n</ol>\n<p>\u53cd\u8fc7\u6765\uff0c<code>tcache_get</code> \u5219\u662f\u4ece tcache \u4e2d\u62ff\u51fa\u4e00\u4e2a\u7a7a\u95f2\u5757\uff1a</p>\n<ol>\n<li>\u4ece\u94fe\u8868\u5934 <code>entries[tc_idx]</code> \u53d6\u51fa\u4e00\u4e2a\u7a7a\u95f2\u5757\uff0c\u628a\u5b83\u4ece\u94fe\u8868\u4e2d\u5220\u9664\uff1a<code>entries[tc_idx] = e-&gt;next</code></li>\n<li>\u66f4\u65b0\u8fd9\u4e2a bin \u7684\u7a7a\u95f2\u5757\u4e2a\u6570\u5230 <code>count[tc_idx]</code> \u5f53\u4e2d</li>\n<li>\u628a\u5b83\u7684 <code>key</code> \u5b57\u6bb5\u6307\u5411 NULL\uff0c\u7528\u6765\u8868\u793a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u5f53\u524d\u4e0d\u5728 <code>tcache</code> \u5f53\u4e2d</li>\n<li>\u8fd4\u56de\u8fd9\u4e2a\u7a7a\u95f2\u5757\u7684\u5730\u5740</li>\n</ol>\n<h3 id=\"malloc_1\">malloc<a class=\"headerlink\" href=\"#malloc_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u56de\u5230 <code>malloc</code> \u7684\u5b9e\u73b0\uff0c\u5b83\u9996\u5148\u6839\u636e\u7528\u6237\u8981\u5206\u914d\u7684\u7a7a\u95f4\u5927\u5c0f\uff08<code>bytes</code>\uff09\uff0c\u8ba1\u7b97\u51fa\u5b9e\u9645\u9700\u8981\u5206\u914d\u7684\u5927\u5c0f\uff08<code>tbytes</code>\uff09\uff0c\u548c\u5bf9\u5e94\u7684 bin\uff08<code>tc_idx</code>\uff09\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"cm\">/* int_free also calls request2size, be careful to not pad twice.  */</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tbytes</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">checked_request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">tbytes</span><span class=\"p\">))</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"n\">__set_errno</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ENOMEM</span><span class=\"p\">);</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tbytes</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>checked_request2size</code> \u5b9e\u73b0\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"cp\">#define request2size(req)                                         \\</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"cp\">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \\</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"cp\">   MINSIZE :                                                      \\</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"cp\">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"cm\">/* Check if REQ overflows when padded and aligned and if the resulting value</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"cm\">   is less than PTRDIFF_T.  Returns TRUE and the requested size or MINSIZE in</span>\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a><span class=\"cm\">   case the value is less than MINSIZE on SZ or false if any of the previous</span>\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a><span class=\"cm\">   check fail.  */</span>\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"kt\">bool</span>\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a><span class=\"nf\">checked_request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">sz</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">__nonnull</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">PTRDIFF_MAX</span><span class=\"p\">))</span>\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"n\">sz</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">request2size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">);</span>\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u5b9e\u73b0\u7684\u5b9e\u9645\u4e0a\u662f\u628a\u7528\u6237\u8bf7\u6c42\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u52a0\u4e0a <code>SIZE_SZ</code>\uff08\u5373 <code>sizeof(size_t)</code>\uff09\uff0c\u5411\u4e0a\u53d6\u6574\u5230 <code>MALLOC_ALIGN_MASK</code> \u5bf9\u5e94\u7684 alignment\uff08<code>MALLOC_ALIGNMENT</code>\uff0c\u901a\u5e38\u662f <code>2 * SIZE_SZ</code>\uff09\u7684\u6574\u6570\u500d\u6570\uff0c\u518d\u548c <code>MINSIZE</code> \u53d6 max\u3002\u8fd9\u91cc\u8981\u52a0 <code>SIZE_SZ</code>\uff0c\u662f\u56e0\u4e3a malloc \u4f1a\u7ef4\u62a4\u88ab\u5206\u914d\u7684\u5757\u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u5305\u62ec\u5757\u7684\u5927\u5c0f\u548c\u4e00\u4e9b flag\uff0c\u540e\u7eed\u4f1a\u8be6\u7ec6\u8ba8\u8bba\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5206\u914d\u7684\u5b9e\u9645\u7a7a\u95f4\u4f1a\u6bd4\u7528\u6237\u8bf7\u6c42\u7684\u7a7a\u95f4\u8981\u66f4\u5927\u3002</p>\n<p>\u63a5\u7740\uff0c\u770b\u5b83\u662f\u5982\u4f55\u8ba1\u7b97\u51fa tcache index \u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"cm\">/* When &quot;x&quot; is from chunksize().  */</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"cp\"># define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4ece MINSIZE \u5f00\u59cb\uff0c\u4ee5 MALLOC_ALIGNMENT \u4e3a\u5355\u4f4d\uff0c\u6bcf\u4e2a bin \u5bf9\u5e94\u4e00\u4e2a\u7ecf\u8fc7 align \u4ee5\u540e\u7684\u53ef\u80fd\u7684\u5185\u5b58\u5757\u5927\u5c0f\u3002\u5f97\u5230 tcache index \u540e\uff0c\u68c0\u67e5\u5bf9\u5e94\u7684 bin \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff0c\u5982\u679c\u6709\uff0c\u5219\u76f4\u63a5\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0ctcache \u76f8\u5f53\u4e8e\u662f\u4e00\u4e2a per thread \u7684\u5c0f\u7f13\u5b58\uff0c\u8bb0\u5f55\u4e86\u6700\u8fd1\u91ca\u653e\u7684\u5185\u5b58\u5757\uff0c\u53ef\u4f9b malloc \u4f7f\u7528\u3002\u7531\u4e8e bin \u7684\u6570\u91cf\u6709\u9650\uff0c\u6240\u4ee5\u6bd4\u8f83\u5927\u7684\u5185\u5b58\u5206\u914d\u4e0d\u4f1a\u7ecf\u8fc7 tcache\u3002</p>\n<p>P.S. <code>calloc</code> \u4e0d\u4f1a\u4f7f\u7528 tcache\uff0c\u800c\u662f\u7528\u540e\u9762\u63d0\u5230\u7684 <code>_int_malloc</code> \u8fdb\u884c\u5404\u79cd\u5206\u914d\u3002</p>\n<h3 id=\"free\">free<a class=\"headerlink\" href=\"#free\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e2\u7136 malloc \u7528\u5230\u4e86 tcache\uff0c\u81ea\u7136 free \u5c31\u8981\u5f80\u91cc\u9762\u653e\u7a7a\u95f2\u5757\u4e86\uff0c\u76f8\u5173\u7684\u4ee3\u7801\u5728 <code>_int_free</code> \u51fd\u6570\u5f53\u4e2d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* Check to see if it&#39;s already in the tcache.  */</span>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"w\">    </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"w\">    </span><span class=\"cm\">/* This test succeeds on double free.  However, we don&#39;t 100%</span>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"cm\">       trust it (it also matches random payload data at a 1 in</span>\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a><span class=\"cm\">       2^&lt;size_t&gt; chance), so verify it&#39;s not an unlikely</span>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"cm\">       coincidence before aborting.  */</span>\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"p\">))</span>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a><span class=\"w\">        </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tmp</span><span class=\"p\">;</span>\n</span><span id=\"__span-7-14\"><a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\" href=\"#__codelineno-7-14\"></a><span class=\"w\">        </span><span class=\"n\">LIBC_PROBE</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">memory_tcache_double_free</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-15\"><a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\" href=\"#__codelineno-7-15\"></a><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tmp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">];</span>\n</span><span id=\"__span-7-16\"><a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\" href=\"#__codelineno-7-16\"></a><span class=\"w\">             </span><span class=\"n\">tmp</span><span class=\"p\">;</span>\n</span><span id=\"__span-7-17\"><a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\" href=\"#__codelineno-7-17\"></a><span class=\"w\">             </span><span class=\"n\">tmp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tmp</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-18\"><a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\" href=\"#__codelineno-7-18\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tmp</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-19\"><a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\" href=\"#__codelineno-7-19\"></a><span class=\"w\">            </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;free(): double free detected in tcache 2&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-20\"><a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\" href=\"#__codelineno-7-20\"></a><span class=\"w\">            </span><span class=\"cm\">/* If we get here, it was a coincidence.  We&#39;ve wasted a</span>\n</span><span id=\"__span-7-21\"><a id=\"__codelineno-7-21\" name=\"__codelineno-7-21\" href=\"#__codelineno-7-21\"></a><span class=\"cm\">               few cycles, but don&#39;t abort.  */</span>\n</span><span id=\"__span-7-22\"><a id=\"__codelineno-7-22\" name=\"__codelineno-7-22\" href=\"#__codelineno-7-22\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-7-23\"><a id=\"__codelineno-7-23\" name=\"__codelineno-7-23\" href=\"#__codelineno-7-23\"></a>\n</span><span id=\"__span-7-24\"><a id=\"__codelineno-7-24\" name=\"__codelineno-7-24\" href=\"#__codelineno-7-24\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span><span class=\"p\">)</span>\n</span><span id=\"__span-7-25\"><a id=\"__codelineno-7-25\" name=\"__codelineno-7-25\" href=\"#__codelineno-7-25\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-7-26\"><a id=\"__codelineno-7-26\" name=\"__codelineno-7-26\" href=\"#__codelineno-7-26\"></a><span class=\"w\">        </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-7-27\"><a id=\"__codelineno-7-27\" name=\"__codelineno-7-27\" href=\"#__codelineno-7-27\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span>\n</span><span id=\"__span-7-28\"><a id=\"__codelineno-7-28\" name=\"__codelineno-7-28\" href=\"#__codelineno-7-28\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-7-29\"><a id=\"__codelineno-7-29\" name=\"__codelineno-7-29\" href=\"#__codelineno-7-29\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u903b\u8f91\u4e5f\u4e0d\u590d\u6742\uff1a</p>\n<ol>\n<li>\u8ba1\u7b97 tcache index\uff0c\u627e\u5230\u5bf9\u5e94\u7684 bin</li>\n<li>\u68c0\u67e5\u5b83\u662f\u4e0d\u662f\u5df2\u7ecf\u88ab free \u8fc7\u4e86\uff0c\u5373 double free\uff1afree \u8fc7\u7684\u6307\u9488\uff0c\u5b83\u7684 key \u5b57\u6bb5\u5e94\u5f53\u6307\u5411 tcache\uff0c\u5982\u679c\u5b9e\u9645\u68c0\u6d4b\u5230\u662f\u8fd9\u6837\uff0c\u90a3\u5c31\u53bb tcache \u91cc\u904d\u5386\u94fe\u8868\uff0c\u68c0\u67e5\u662f\u4e0d\u662f\u771f\u7684\u5728\u91cc\u9762\uff0c\u5982\u679c\u662f\uff0c\u8bf4\u660e double free \u4e86\uff0c\u62a5\u9519</li>\n<li>\u5982\u679c\u5bf9\u5e94\u7684 bin \u7684\u94fe\u8868\u957f\u5ea6\u4e0d\u662f\u5f88\u957f\uff08\u9608\u503c\u662f <code>mp_.tcache_count</code>\uff0c\u53d6\u503c\u89c1\u540e\uff09\uff0c\u5219\u6dfb\u52a0\u5230\u94fe\u8868\u5934\u90e8\uff0c\u5b8c\u6210 free \u7684\u8fc7\u7a0b</li>\n</ol>\n<p>\u90a3\u4e48 tcache \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6709\u591a\u5927\u5462\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"cm\">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span>\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"cp\"># define TCACHE_MAX_BINS  64</span>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"cm\">/* This is another arbitrary limit, which tunables can change.  Each</span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"cm\">   tcache bin will hold at most this number of chunks.  */</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"cp\"># define TCACHE_FILL_COUNT 7</span>\n</span></code></pre></div>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b83\u6709 64 \u4e2a bin\uff0c\u6bcf\u4e2a bin \u7684\u94fe\u8868\u6700\u591a 7 \u4e2a\u7a7a\u95f2\u5757\u3002</p>\n<p>\u5728 64 \u4f4d\u4e0b\uff0c\u8fd9 64 \u4e2a bin \u5bf9\u5e94\u7684\u5757\u5927\u5c0f\u662f\u4ece 32 \u5b57\u8282\u5230 1040 \u5b57\u8282\uff0c\u6bcf 16 \u5b57\u8282\u4e00\u4e2a bin\uff08<code>(1040 - 32) / 16 + 1 = 64</code>\uff09\u3002\u90a3\u4e48\uff0c<code>malloc(1032)</code> \u6216\u66f4\u5c0f\u7684\u5206\u914d\u4f1a\u7ecf\u8fc7 tcache\uff0c\u800c <code>malloc(1033)</code> \u6216\u66f4\u5927\u7684\u5206\u914d\u5219\u4e0d\u4f1a\u3002</p>\n<h3 id=\"\u5b9e\u9a8c\">\u5b9e\u9a8c<a class=\"headerlink\" href=\"#\u5b9e\u9a8c\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u6765\u5199\u4e00\u6bb5\u7a0b\u5e8f\u6765\u89c2\u5bdf tcache \u7684\u884c\u4e3a\uff0c\u8003\u8651\u5230\u4ece\u94fe\u8868\u5934\u90e8\u63d2\u5165\u548c\u5220\u9664\u662f\u540e\u8fdb\u5148\u51fa\uff08LIFO\uff09\uff0c\u76f8\u5f53\u4e8e\u662f\u4e00\u4e2a\u6808\uff0c\u6240\u4ee5\u5206\u914d\u4e24\u4e2a\u5927\u5c0f\u76f8\u540c\u7684\u5757\uff0c\u91ca\u653e\u540e\u518d\u5206\u914d\u76f8\u540c\u5927\u5c0f\u7684\u5757\uff0c\u5f97\u5230\u7684\u6307\u9488\u7684\u987a\u5e8f\u5e94\u8be5\u662f\u53cd\u8fc7\u6765\u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a>\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-8\"><a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\" href=\"#__codelineno-9-8\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-9\"><a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\" href=\"#__codelineno-9-9\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-10\"><a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\" href=\"#__codelineno-9-10\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-11\"><a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\" href=\"#__codelineno-9-11\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"p\">);</span>\n</span><span id=\"__span-9-12\"><a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\" href=\"#__codelineno-9-12\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8f93\u51fa\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"n\">p1</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732a0</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732d0</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732d0</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"o\">=</span><span class=\"mh\">0x55fb2f9732a0</span>\n</span></code></pre></div>\n<p>\u7ed3\u679c\u7b26\u5408\u9884\u671f\uff0ctcache \u7684\u5185\u90e8\u72b6\u6001\u53d8\u5316\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li><code>free(p1)</code>\uff1ap1 \u53d8\u6210\u94fe\u8868\u7684\u5934\u90e8</li>\n<li><code>free(p2)</code>\uff1ap2 \u53d8\u6210\u94fe\u8868\u7684\u5934\u90e8\uff0cnext \u6307\u9488\u6307\u5411 p1</li>\n<li><code>p3 = malloc(32)</code>: p2 \u662f\u94fe\u8868\u7684\u5934\u90e8\uff0c\u6240\u4ee5\u88ab\u5206\u914d\u7ed9 p3\uff0c\u4e4b\u540e p1 \u6210\u4e3a\u94fe\u8868\u7684\u5934\u90e8</li>\n<li><code>p4 = malloc(32)</code>: p1 \u662f\u94fe\u8868\u7684\u5934\u90e8\uff0c\u6240\u4ee5\u88ab\u5206\u914d\u7ed9 p4</li>\n</ol>\n<p>\u5982\u679c\u4fee\u6539\u5206\u914d\u7684\u5927\u5c0f\uff0c\u8ba9\u5b83\u4eec\u88ab\u653e\u5230\u4e0d\u540c\u7684 bin\uff0c\u5c31\u4e0d\u4f1a\u51fa\u73b0\u987a\u5e8f\u98a0\u5012\u7684\u60c5\u51b5\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a>\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">48</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">48</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"p\">);</span>\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8f93\u51fa\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a><span class=\"n\">p1</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2a0</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2d0</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2a0</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"o\">=</span><span class=\"mh\">0x5638e68db2d0</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230 p3 \u7b49\u4e8e p1\uff0cp4 \u7b49\u4e8e p2\u3002\u6b64\u65f6 p1 \u548c p3 \u5c5e\u4e8e\u540c\u4e00\u4e2a bin\uff0c\u800c p2 \u548c p4 \u5c5e\u4e8e\u53e6\u4e00\u4e2a bin\u3002</p>\n<p>\u65e2\u7136\u6211\u4eec\u77e5\u9053\u4e86 tcache \u7684\u5185\u90e8\u6784\u9020\uff0c\u6211\u4eec\u53ef\u4ee5\u5199\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u9996\u5148\u5f97\u5230 tcache \u7684\u5730\u5740\uff0c\u518d\u6253\u5370\u51fa\u6bcf\u6b21 malloc/free \u4e4b\u540e\u7684\u72b6\u6001\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdint.h&gt;</span>\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-13-3\"><a id=\"__codelineno-13-3\" name=\"__codelineno-13-3\" href=\"#__codelineno-13-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-13-4\"><a id=\"__codelineno-13-4\" name=\"__codelineno-13-4\" href=\"#__codelineno-13-4\"></a>\n</span><span id=\"__span-13-5\"><a id=\"__codelineno-13-5\" name=\"__codelineno-13-5\" href=\"#__codelineno-13-5\"></a><span class=\"cp\">#define TCACHE_MAX_BINS 64</span>\n</span><span id=\"__span-13-6\"><a id=\"__codelineno-13-6\" name=\"__codelineno-13-6\" href=\"#__codelineno-13-6\"></a>\n</span><span id=\"__span-13-7\"><a id=\"__codelineno-13-7\" name=\"__codelineno-13-7\" href=\"#__codelineno-13-7\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-8\"><a id=\"__codelineno-13-8\" name=\"__codelineno-13-8\" href=\"#__codelineno-13-8\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-9\"><a id=\"__codelineno-13-9\" name=\"__codelineno-13-9\" href=\"#__codelineno-13-9\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-10\"><a id=\"__codelineno-13-10\" name=\"__codelineno-13-10\" href=\"#__codelineno-13-10\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_entry</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-11\"><a id=\"__codelineno-13-11\" name=\"__codelineno-13-11\" href=\"#__codelineno-13-11\"></a>\n</span><span id=\"__span-13-12\"><a id=\"__codelineno-13-12\" name=\"__codelineno-13-12\" href=\"#__codelineno-13-12\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-13\"><a id=\"__codelineno-13-13\" name=\"__codelineno-13-13\" href=\"#__codelineno-13-13\"></a><span class=\"w\">  </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-13-14\"><a id=\"__codelineno-13-14\" name=\"__codelineno-13-14\" href=\"#__codelineno-13-14\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-13-15\"><a id=\"__codelineno-13-15\" name=\"__codelineno-13-15\" href=\"#__codelineno-13-15\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">tcache_perthread_struct</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-16\"><a id=\"__codelineno-13-16\" name=\"__codelineno-13-16\" href=\"#__codelineno-13-16\"></a>\n</span><span id=\"__span-13-17\"><a id=\"__codelineno-13-17\" name=\"__codelineno-13-17\" href=\"#__codelineno-13-17\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tcache</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-18\"><a id=\"__codelineno-13-18\" name=\"__codelineno-13-18\" href=\"#__codelineno-13-18\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">TCACHE_MAX_BINS</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-19\"><a id=\"__codelineno-13-19\" name=\"__codelineno-13-19\" href=\"#__codelineno-13-19\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-20\"><a id=\"__codelineno-13-20\" name=\"__codelineno-13-20\" href=\"#__codelineno-13-20\"></a><span class=\"w\">      </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span>\n</span><span id=\"__span-13-21\"><a id=\"__codelineno-13-21\" name=\"__codelineno-13-21\" href=\"#__codelineno-13-21\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;tcache bin #%d: %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-22\"><a id=\"__codelineno-13-22\" name=\"__codelineno-13-22\" href=\"#__codelineno-13-22\"></a><span class=\"w\">      </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-23\"><a id=\"__codelineno-13-23\" name=\"__codelineno-13-23\" href=\"#__codelineno-13-23\"></a><span class=\"w\">      </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-24\"><a id=\"__codelineno-13-24\" name=\"__codelineno-13-24\" href=\"#__codelineno-13-24\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot; -&gt; %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-25\"><a id=\"__codelineno-13-25\" name=\"__codelineno-13-25\" href=\"#__codelineno-13-25\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-26\"><a id=\"__codelineno-13-26\" name=\"__codelineno-13-26\" href=\"#__codelineno-13-26\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-13-27\"><a id=\"__codelineno-13-27\" name=\"__codelineno-13-27\" href=\"#__codelineno-13-27\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-28\"><a id=\"__codelineno-13-28\" name=\"__codelineno-13-28\" href=\"#__codelineno-13-28\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-13-29\"><a id=\"__codelineno-13-29\" name=\"__codelineno-13-29\" href=\"#__codelineno-13-29\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-13-30\"><a id=\"__codelineno-13-30\" name=\"__codelineno-13-30\" href=\"#__codelineno-13-30\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-13-31\"><a id=\"__codelineno-13-31\" name=\"__codelineno-13-31\" href=\"#__codelineno-13-31\"></a>\n</span><span id=\"__span-13-32\"><a id=\"__codelineno-13-32\" name=\"__codelineno-13-32\" href=\"#__codelineno-13-32\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-13-33\"><a id=\"__codelineno-13-33\" name=\"__codelineno-13-33\" href=\"#__codelineno-13-33\"></a><span class=\"w\">  </span><span class=\"c1\">// leak tcache address</span>\n</span><span id=\"__span-13-34\"><a id=\"__codelineno-13-34\" name=\"__codelineno-13-34\" href=\"#__codelineno-13-34\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">128</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-35\"><a id=\"__codelineno-13-35\" name=\"__codelineno-13-35\" href=\"#__codelineno-13-35\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p0</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-36\"><a id=\"__codelineno-13-36\" name=\"__codelineno-13-36\" href=\"#__codelineno-13-36\"></a><span class=\"w\">  </span><span class=\"n\">tcache_entry</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p0</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-37\"><a id=\"__codelineno-13-37\" name=\"__codelineno-13-37\" href=\"#__codelineno-13-37\"></a><span class=\"w\">  </span><span class=\"n\">tcache_perthread_struct</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"o\">-&gt;</span><span class=\"n\">key</span><span class=\"p\">;</span>\n</span><span id=\"__span-13-38\"><a id=\"__codelineno-13-38\" name=\"__codelineno-13-38\" href=\"#__codelineno-13-38\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;tcache is at %p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-39\"><a id=\"__codelineno-13-39\" name=\"__codelineno-13-39\" href=\"#__codelineno-13-39\"></a><span class=\"w\">  </span><span class=\"c1\">// clear tcache</span>\n</span><span id=\"__span-13-40\"><a id=\"__codelineno-13-40\" name=\"__codelineno-13-40\" href=\"#__codelineno-13-40\"></a><span class=\"w\">  </span><span class=\"n\">p0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">128</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-41\"><a id=\"__codelineno-13-41\" name=\"__codelineno-13-41\" href=\"#__codelineno-13-41\"></a>\n</span><span id=\"__span-13-42\"><a id=\"__codelineno-13-42\" name=\"__codelineno-13-42\" href=\"#__codelineno-13-42\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-43\"><a id=\"__codelineno-13-43\" name=\"__codelineno-13-43\" href=\"#__codelineno-13-43\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-44\"><a id=\"__codelineno-13-44\" name=\"__codelineno-13-44\" href=\"#__codelineno-13-44\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-45\"><a id=\"__codelineno-13-45\" name=\"__codelineno-13-45\" href=\"#__codelineno-13-45\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after free(p1):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-46\"><a id=\"__codelineno-13-46\" name=\"__codelineno-13-46\" href=\"#__codelineno-13-46\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-47\"><a id=\"__codelineno-13-47\" name=\"__codelineno-13-47\" href=\"#__codelineno-13-47\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-48\"><a id=\"__codelineno-13-48\" name=\"__codelineno-13-48\" href=\"#__codelineno-13-48\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after free(p2):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-49\"><a id=\"__codelineno-13-49\" name=\"__codelineno-13-49\" href=\"#__codelineno-13-49\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-50\"><a id=\"__codelineno-13-50\" name=\"__codelineno-13-50\" href=\"#__codelineno-13-50\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-51\"><a id=\"__codelineno-13-51\" name=\"__codelineno-13-51\" href=\"#__codelineno-13-51\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after malloc(p3):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-52\"><a id=\"__codelineno-13-52\" name=\"__codelineno-13-52\" href=\"#__codelineno-13-52\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-53\"><a id=\"__codelineno-13-53\" name=\"__codelineno-13-53\" href=\"#__codelineno-13-53\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-54\"><a id=\"__codelineno-13-54\" name=\"__codelineno-13-54\" href=\"#__codelineno-13-54\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;after malloc(p4):</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-55\"><a id=\"__codelineno-13-55\" name=\"__codelineno-13-55\" href=\"#__codelineno-13-55\"></a><span class=\"w\">  </span><span class=\"n\">dump_tcache</span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-56\"><a id=\"__codelineno-13-56\" name=\"__codelineno-13-56\" href=\"#__codelineno-13-56\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"p\">);</span>\n</span><span id=\"__span-13-57\"><a id=\"__codelineno-13-57\" name=\"__codelineno-13-57\" href=\"#__codelineno-13-57\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8fd0\u884c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310010</span>\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p1</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-3\"><a id=\"__codelineno-14-3\" name=\"__codelineno-14-3\" href=\"#__codelineno-14-3\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310740</span>\n</span><span id=\"__span-14-4\"><a id=\"__codelineno-14-4\" name=\"__codelineno-14-4\" href=\"#__codelineno-14-4\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">p2</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-5\"><a id=\"__codelineno-14-5\" name=\"__codelineno-14-5\" href=\"#__codelineno-14-5\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310770</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310740</span>\n</span><span id=\"__span-14-6\"><a id=\"__codelineno-14-6\" name=\"__codelineno-14-6\" href=\"#__codelineno-14-6\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">p3</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-7\"><a id=\"__codelineno-14-7\" name=\"__codelineno-14-7\" href=\"#__codelineno-14-7\"></a><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x558f39310740</span>\n</span><span id=\"__span-14-8\"><a id=\"__codelineno-14-8\" name=\"__codelineno-14-8\" href=\"#__codelineno-14-8\"></a><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">p4</span><span class=\"p\">)</span><span class=\"o\">:</span>\n</span><span id=\"__span-14-9\"><a id=\"__codelineno-14-9\" name=\"__codelineno-14-9\" href=\"#__codelineno-14-9\"></a><span class=\"n\">p1</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310740</span><span class=\"w\"> </span><span class=\"n\">p2</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310770</span><span class=\"w\"> </span><span class=\"n\">p3</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310770</span><span class=\"w\"> </span><span class=\"n\">p4</span><span class=\"o\">=</span><span class=\"mh\">0x558f39310740</span>\n</span></code></pre></div>\n<p>\u6253\u5370\u51fa\u6765\u7684\u7ed3\u679c\u548c\u9884\u671f\u4e00\u81f4\u3002</p>\n<p>\u63a5\u4e0b\u6765\u7ee7\u7eed\u5206\u6790 malloc \u7684\u540e\u7eed\u4ee3\u7801\u3002</p>\n<h2 id=\"\u56de\u5230-__libc_malloc\">\u56de\u5230 <code>__libc_malloc</code><a class=\"headerlink\" href=\"#\u56de\u5230-__libc_malloc\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5982\u679c malloc \u6ca1\u6709\u547d\u4e2d tcache\uff0c\u6216\u8005 free \u6ca1\u6709\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache \u5f53\u4e2d\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u4e8b\u60c5\u5462\uff1f\u63a5\u4e0b\u6765\u5f80\u540e\u770b\uff0c\u9996\u5148\u662f <code>__libc_malloc</code> \u7684\u540e\u7eed\u5b9e\u73b0\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_int_malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a><span class=\"w\">    </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-15-5\"><a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\" href=\"#__codelineno-15-5\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-15-6\"><a id=\"__codelineno-15-6\" name=\"__codelineno-15-6\" href=\"#__codelineno-15-6\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-15-7\"><a id=\"__codelineno-15-7\" name=\"__codelineno-15-7\" href=\"#__codelineno-15-7\"></a>\n</span><span id=\"__span-15-8\"><a id=\"__codelineno-15-8\" name=\"__codelineno-15-8\" href=\"#__codelineno-15-8\"></a><span class=\"n\">arena_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ar_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-15-9\"><a id=\"__codelineno-15-9\" name=\"__codelineno-15-9\" href=\"#__codelineno-15-9\"></a>\n</span><span id=\"__span-15-10\"><a id=\"__codelineno-15-10\" name=\"__codelineno-15-10\" href=\"#__codelineno-15-10\"></a><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_int_malloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ar_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u51fa\u73b0\u4e86 arena \u7684\u6982\u5ff5\uff1a\u591a\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u63d0\u5347\u6027\u80fd\uff0c\u540c\u65f6\u7528\u591a\u4e2a arena\uff0c\u6bcf\u4e2a arena \u7528\u4e00\u628a\u9501\u6765\u4fdd\u8bc1\u591a\u7ebf\u7a0b\u5b89\u5168\uff0c\u4ece\u800c\u4f7f\u5f97\u591a\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u540c\u65f6\u4ece\u4e0d\u540c\u7684 arena \u4e2d\u5206\u914d\u5185\u5b58\u3002\u8fd9\u91cc\u5148\u4e0d\u8ba8\u8bba\u591a\u7ebf\u7a0b\u7684\u60c5\u51b5\uff0c\u5148\u5047\u8bbe\u5728\u5355\u7ebf\u7a0b\u7a0b\u5e8f\u4e0b\uff0c\u5168\u5c40\u53ea\u7528\u4e00\u4e2a arena\uff1a<code>main_arena</code>\uff0c\u7136\u540e\u4ece\u91cc\u9762\u5206\u914d\u5185\u5b58\u3002\u63a5\u4e0b\u6765\u770b <code>_int_malloc</code> \u7684\u5185\u90e8\u5b9e\u73b0\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u6839\u636e\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\u8fdb\u5165\u4e86\u4e0d\u540c\u7684\u5904\u7406\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-16-1\"><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\" href=\"#__codelineno-16-1\"></a><span class=\"c1\">// in _int_malloc</span>\n</span><span id=\"__span-16-2\"><a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\" href=\"#__codelineno-16-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">get_max_fast</span><span class=\"w\"> </span><span class=\"p\">()))</span>\n</span><span id=\"__span-16-3\"><a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\" href=\"#__codelineno-16-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-4\"><a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\" href=\"#__codelineno-16-4\"></a><span class=\"w\">    </span><span class=\"c1\">// fast bin handling</span>\n</span><span id=\"__span-16-5\"><a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\" href=\"#__codelineno-16-5\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-16-6\"><a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\" href=\"#__codelineno-16-6\"></a>\n</span><span id=\"__span-16-7\"><a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\" href=\"#__codelineno-16-7\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-16-8\"><a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\" href=\"#__codelineno-16-8\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-9\"><a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\" href=\"#__codelineno-16-9\"></a><span class=\"w\">    </span><span class=\"c1\">// small bin handling</span>\n</span><span id=\"__span-16-10\"><a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\" href=\"#__codelineno-16-10\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-16-11\"><a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\" href=\"#__codelineno-16-11\"></a><span class=\"k\">else</span>\n</span><span id=\"__span-16-12\"><a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\" href=\"#__codelineno-16-12\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-13\"><a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\" href=\"#__codelineno-16-13\"></a><span class=\"w\">    </span><span class=\"c1\">// consolidate fast bins to unsorted bins</span>\n</span><span id=\"__span-16-14\"><a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\" href=\"#__codelineno-16-14\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-16-15\"><a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\" href=\"#__codelineno-16-15\"></a>\n</span><span id=\"__span-16-16\"><a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\" href=\"#__codelineno-16-16\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(;;</span><span class=\"w\"> </span><span class=\"p\">)</span>\n</span><span id=\"__span-16-17\"><a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\" href=\"#__codelineno-16-17\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-16-18\"><a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\" href=\"#__codelineno-16-18\"></a><span class=\"w\">    </span><span class=\"c1\">// process unsorted bins</span>\n</span><span id=\"__span-16-19\"><a id=\"__codelineno-16-19\" name=\"__codelineno-16-19\" href=\"#__codelineno-16-19\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>malloc \u628a\u7a7a\u95f2\u7684\u5757\u5206\u6210\u56db\u79cd\u7c7b\u578b\u6765\u4fdd\u5b58\uff1a</p>\n<ol>\n<li>fast bin: \u7c7b\u4f3c\u524d\u9762\u7684 tcache bin\uff0c\u628a\u5927\u5c0f\u76f8\u540c\u7684\u7a7a\u95f2\u5757\u653e\u5230\u94fe\u8868\u4e2d\uff0c\u518d\u7ef4\u62a4\u591a\u4e2a\u5bf9\u5e94\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u7684\u94fe\u8868\u5934\u6307\u9488\uff0c\u91c7\u7528\u5355\u5411\u94fe\u8868\u7ef4\u62a4</li>\n<li>small bin\uff1asmall bin \u4e5f\u4f1a\u628a\u76f8\u540c\u7684\u7a7a\u95f2\u5757\u653e\u5728\u94fe\u8868\u4e2d\uff0c\u4f46\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u4f1a\u88ab\u5408\u5e76\u4e3a\u66f4\u5927\u7684\u7a7a\u95f2\u5757\uff0c\u91c7\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4</li>\n<li>large bin\uff1alarge bin \u53ef\u80fd\u4fdd\u5b58\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u91c7\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4</li>\n<li>unsorted bin\uff1a\u8fd1\u671f\u88ab free \u7684\u7a7a\u95f2\u5757\uff0c\u5982\u679c\u6ca1\u6709\u4fdd\u5b58\u5230 tcache\uff0c\u4f1a\u88ab\u653e\u5230 unsorted bin \u5f53\u4e2d\uff0c\u7559\u5f85\u540e\u7eed\u7684\u5904\u7406</li>\n</ol>\n<p>\u5728\u8ba8\u8bba\u8fd9\u4e9b bin \u7684\u7ef4\u62a4\u65b9\u5f0f\u4e4b\u524d\uff0c\u9996\u5148\u8981\u77e5\u9053 glibc \u662f\u600e\u4e48\u7ef4\u62a4\u5757\u7684\uff1a\u7a7a\u95f2\u7684\u65f6\u5019\u662f\u4ec0\u4e48\u5e03\u5c40\uff0c\u88ab\u5206\u914d\u7684\u65f6\u5019\u53c8\u662f\u4ec0\u4e48\u5e03\u5c40\uff1f</p>\n<h2 id=\"\u5757\u5e03\u5c40\">\u5757\u5e03\u5c40<a class=\"headerlink\" href=\"#\u5757\u5e03\u5c40\" title=\"Permanent link\">&para;</a></h2>\n<p>glibc \u6bcf\u4e2a\u7a7a\u95f2\u5757\uff08chunk\uff09\u5bf9\u5e94\u4e86\u4e0b\u9762\u7684\u7ed3\u6784\u4f53 <code>malloc_chunk</code>\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-17-1\"><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\" href=\"#__codelineno-17-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-2\"><a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\" href=\"#__codelineno-17-2\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\">      </span><span class=\"n\">mchunk_prev_size</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"cm\">/* Size of previous chunk (if free).  */</span>\n</span><span id=\"__span-17-3\"><a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\" href=\"#__codelineno-17-3\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\">      </span><span class=\"n\">mchunk_size</span><span class=\"p\">;</span><span class=\"w\">       </span><span class=\"cm\">/* Size in bytes, including overhead. */</span>\n</span><span id=\"__span-17-4\"><a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\" href=\"#__codelineno-17-4\"></a>\n</span><span id=\"__span-17-5\"><a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\" href=\"#__codelineno-17-5\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span><span class=\"w\">         </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-17-6\"><a id=\"__codelineno-17-6\" name=\"__codelineno-17-6\" href=\"#__codelineno-17-6\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-7\"><a id=\"__codelineno-17-7\" name=\"__codelineno-17-7\" href=\"#__codelineno-17-7\"></a>\n</span><span id=\"__span-17-8\"><a id=\"__codelineno-17-8\" name=\"__codelineno-17-8\" href=\"#__codelineno-17-8\"></a><span class=\"w\">  </span><span class=\"cm\">/* Only used for large blocks: pointer to next larger size.  */</span>\n</span><span id=\"__span-17-9\"><a id=\"__codelineno-17-9\" name=\"__codelineno-17-9\" href=\"#__codelineno-17-9\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-17-10\"><a id=\"__codelineno-17-10\" name=\"__codelineno-17-10\" href=\"#__codelineno-17-10\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-11\"><a id=\"__codelineno-17-11\" name=\"__codelineno-17-11\" href=\"#__codelineno-17-11\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u5b57\u6bb5\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u76f8\u90bb\u7684\u524d\u4e00\u4e2a\u7a7a\u95f2\u5757\u7684\u5927\u5c0f <code>mchunk_prev_size</code>\uff0c\u8bb0\u5f55\u5b83\u662f\u4e3a\u4e86\u65b9\u4fbf\u627e\u5230\u524d\u4e00\u4e2a\u7a7a\u95f2\u5757\u7684\u5f00\u5934\uff0c\u8fd9\u6837\u5408\u5e76\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u5c31\u5f88\u7b80\u5355</li>\n<li>\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u5927\u5c0f <code>mchunk_size</code>\uff0c\u7531\u4e8e\u5757\u7684\u5927\u5c0f\u662f\u5bf9\u9f50\u7684\uff0c\u6240\u4ee5\u5b83\u7684\u4f4e\u4f4d\u88ab\u7528\u6765\u8bb0\u5f55 flag</li>\n<li><code>fd</code> \u548c <code>bk</code>\uff1asmall bin \u548c large bin \u9700\u8981\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\u7a7a\u95f2\u5757\uff0c\u6307\u9488\u5c31\u4fdd\u5b58\u5728\u8fd9\u91cc</li>\n<li><code>fd_nextsize</code> \u548c <code>bk_next_size</code>\uff1alarge bin \u9700\u8981\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u65b9\u4fbf\u627e\u5230\u5408\u9002\u5927\u5c0f\u7684\u7a7a\u95f2\u5757</li>\n</ol>\n<p>\u8fd9\u662f\u7a7a\u95f2\u5757\u7684\u5185\u5b58\u5e03\u5c40\uff0c\u90a3\u4e48\u88ab\u5206\u914d\u7684\u5185\u5b58\u5462\uff1f\u88ab\u5206\u914d\u7684\u5185\u5b58\uff0c\u76f8\u5f53\u4e8e\u662f\u5982\u4e0b\u7684\u7ed3\u6784\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-18-1\"><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\" href=\"#__codelineno-18-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-18-2\"><a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\" href=\"#__codelineno-18-2\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\">      </span><span class=\"n\">mchunk_size</span><span class=\"p\">;</span><span class=\"w\">       </span><span class=\"cm\">/* Size in bytes, including overhead. */</span>\n</span><span id=\"__span-18-3\"><a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\" href=\"#__codelineno-18-3\"></a><span class=\"w\">  </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">payload</span><span class=\"p\">[];</span><span class=\"w\">                         </span><span class=\"cm\">/* malloc() returns pointer to payload */</span>\n</span><span id=\"__span-18-4\"><a id=\"__codelineno-18-4\" name=\"__codelineno-18-4\" href=\"#__codelineno-18-4\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c<code>malloc()</code> \u8fd4\u56de\u7684\u5730\u5740\uff0c\u7b49\u4e8e\u7a7a\u95f2\u5757\u91cc <code>fd</code> \u6240\u5728\u7684\u4f4d\u7f6e\u3002\u88ab\u5206\u914d\u7684\u5757\uff0c\u9664\u4e86\u7528\u6237\u8bf7\u6c42\u7684\u7a7a\u95f4\u4ee5\u5916\uff0c\u53ea\u6709\u524d\u9762\u7684 <code>sizeof(size_t)</code> \u5927\u5c0f\u7684\u7a7a\u95f4\u662f\u5185\u5b58\u5206\u914d\u5668\u5e26\u6765\u7684\u7a7a\u95f4\u5f00\u9500\u3002\u5757\u88ab\u91ca\u653e\u4ee5\u540e\uff0c\u5b83\u88ab\u91cd\u65b0\u89e3\u91ca\u6210 <code>malloc_chunk</code> \u7ed3\u6784\u4f53\uff08\u6ce8\u610f\u5b83\u4eec\u7684\u8d77\u59cb\u5730\u5740\u4e0d\u540c\uff0c<code>malloc_chunk</code> \u7684\u5730\u5740\u662f malloc \u8fd4\u56de\u7684 <code>payload</code> \u5730\u5740\u51cf\u53bb <code>2 * sizeof(size_t)</code>\uff0c\u5bf9\u5e94 <code>mchunk_prev_size</code> \u548c <code>mchunk_size</code> \u4e24\u4e2a\u5b57\u6bb5\uff09\u3002\u4e8b\u5b9e\u4e0a\uff0c<code>mchunk_prev_size</code> \u4fdd\u5b58\u5728\u7528\u6237\u8bf7\u6c42\u7684\u7a7a\u95f4\u7684\u6700\u540e\u51e0\u4e2a\u5b57\u8282\u3002\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-19-1\"><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\" href=\"#__codelineno-19-1\"></a> in-use chunk         free chunk\n</span><span id=\"__span-19-2\"><a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\" href=\"#__codelineno-19-2\"></a>+-------------+      +------------------+\n</span><span id=\"__span-19-3\"><a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\" href=\"#__codelineno-19-3\"></a>| mchunk_size |      | mchunk_size      |\n</span><span id=\"__span-19-4\"><a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\" href=\"#__codelineno-19-4\"></a>+-------------+      +------------------+\n</span><span id=\"__span-19-5\"><a id=\"__codelineno-19-5\" name=\"__codelineno-19-5\" href=\"#__codelineno-19-5\"></a>| payload     |      | fd               |\n</span><span id=\"__span-19-6\"><a id=\"__codelineno-19-6\" name=\"__codelineno-19-6\" href=\"#__codelineno-19-6\"></a>|             |      +------------------+\n</span><span id=\"__span-19-7\"><a id=\"__codelineno-19-7\" name=\"__codelineno-19-7\" href=\"#__codelineno-19-7\"></a>|             |      | bk               |\n</span><span id=\"__span-19-8\"><a id=\"__codelineno-19-8\" name=\"__codelineno-19-8\" href=\"#__codelineno-19-8\"></a>|             |      +------------------+\n</span><span id=\"__span-19-9\"><a id=\"__codelineno-19-9\" name=\"__codelineno-19-9\" href=\"#__codelineno-19-9\"></a>|             |      | fd_nextsize      |\n</span><span id=\"__span-19-10\"><a id=\"__codelineno-19-10\" name=\"__codelineno-19-10\" href=\"#__codelineno-19-10\"></a>|             | ---&gt; +------------------+\n</span><span id=\"__span-19-11\"><a id=\"__codelineno-19-11\" name=\"__codelineno-19-11\" href=\"#__codelineno-19-11\"></a>|             |      | bk_nextsize      |\n</span><span id=\"__span-19-12\"><a id=\"__codelineno-19-12\" name=\"__codelineno-19-12\" href=\"#__codelineno-19-12\"></a>|             |      +------------------+\n</span><span id=\"__span-19-13\"><a id=\"__codelineno-19-13\" name=\"__codelineno-19-13\" href=\"#__codelineno-19-13\"></a>|             |      | unused           |\n</span><span id=\"__span-19-14\"><a id=\"__codelineno-19-14\" name=\"__codelineno-19-14\" href=\"#__codelineno-19-14\"></a>|             |      |                  |\n</span><span id=\"__span-19-15\"><a id=\"__codelineno-19-15\" name=\"__codelineno-19-15\" href=\"#__codelineno-19-15\"></a>|             |      |                  |\n</span><span id=\"__span-19-16\"><a id=\"__codelineno-19-16\" name=\"__codelineno-19-16\" href=\"#__codelineno-19-16\"></a>|             |      |                  |\n</span><span id=\"__span-19-17\"><a id=\"__codelineno-19-17\" name=\"__codelineno-19-17\" href=\"#__codelineno-19-17\"></a>|             |      +------------------+\n</span><span id=\"__span-19-18\"><a id=\"__codelineno-19-18\" name=\"__codelineno-19-18\" href=\"#__codelineno-19-18\"></a>|             |      | mchunk_prev_size |\n</span><span id=\"__span-19-19\"><a id=\"__codelineno-19-19\" name=\"__codelineno-19-19\" href=\"#__codelineno-19-19\"></a>+-------------+      +------------------+\n</span></code></pre></div>\n<p>\u56e0\u6b64\u4e3a\u4e86\u5728 payload \u548c <code>malloc_chunk</code> \u6307\u9488\u4e4b\u95f4\u8f6c\u6362\uff0c\u4ee3\u7801\u4e2d\u8bbe\u8ba1\u4e86\u4e24\u4e2a\u5b8f\u6765\u7b80\u5316\u6307\u9488\u8fd0\u7b97\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-20-1\"><a id=\"__codelineno-20-1\" name=\"__codelineno-20-1\" href=\"#__codelineno-20-1\"></a><span class=\"cm\">/* conversion from malloc headers to user pointers, and back */</span>\n</span><span id=\"__span-20-2\"><a id=\"__codelineno-20-2\" name=\"__codelineno-20-2\" href=\"#__codelineno-20-2\"></a>\n</span><span id=\"__span-20-3\"><a id=\"__codelineno-20-3\" name=\"__codelineno-20-3\" href=\"#__codelineno-20-3\"></a><span class=\"cp\">#define chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span>\n</span><span id=\"__span-20-4\"><a id=\"__codelineno-20-4\" name=\"__codelineno-20-4\" href=\"#__codelineno-20-4\"></a><span class=\"cp\">#define mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span>\n</span></code></pre></div>\n<p>\u77e5\u9053\u4e86\u7a7a\u95f2\u5757\u7684\u7ef4\u62a4\u65b9\u5f0f\uff0c\u7531\u4e8e\u5404\u4e2a bin \u7ef4\u62a4\u7684\u5c31\u662f\u8fd9\u4e9b\u7a7a\u95f2\u5757\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u5206\u522b\u770b\u8fd9\u51e0\u79cd bin \u7684\u7ef4\u62a4\u65b9\u5f0f\u3002</p>\n<h2 id=\"fast-bin\">fast bin<a class=\"headerlink\" href=\"#fast-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>fast bin \u7684\u7ef4\u62a4\u65b9\u5f0f\u548c tcache \u7c7b\u4f3c\uff0c\u5b83\u628a\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u6309\u7167\u5927\u5c0f\u5206\u6210\u591a\u4e2a bin\uff0c\u6bcf\u4e2a bin \u8bb0\u5f55\u5728\u4e00\u4e2a\u5355\u5411\u94fe\u8868\u5f53\u4e2d\uff0c\u7136\u540e\u7528\u4e00\u4e2a\u6570\u7ec4\u8bb0\u5f55\u5404\u79cd bin \u5927\u5c0f\u7684\u94fe\u8868\u5934\uff0c\u8fd9\u91cc\u76f4\u63a5\u7528\u7684\u5c31\u662f <code>malloc_chunk</code> \u6307\u9488\u6570\u7ec4\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-21-1\"><a id=\"__codelineno-21-1\" name=\"__codelineno-21-1\" href=\"#__codelineno-21-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">mfastbinptr</span><span class=\"p\">;</span>\n</span><span id=\"__span-21-2\"><a id=\"__codelineno-21-2\" name=\"__codelineno-21-2\" href=\"#__codelineno-21-2\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span>\n</span><span id=\"__span-21-3\"><a id=\"__codelineno-21-3\" name=\"__codelineno-21-3\" href=\"#__codelineno-21-3\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-21-4\"><a id=\"__codelineno-21-4\" name=\"__codelineno-21-4\" href=\"#__codelineno-21-4\"></a><span class=\"w\">  </span><span class=\"cm\">/* other fields are omitted */</span>\n</span><span id=\"__span-21-5\"><a id=\"__codelineno-21-5\" name=\"__codelineno-21-5\" href=\"#__codelineno-21-5\"></a><span class=\"w\">  </span><span class=\"cm\">/* Fastbins */</span>\n</span><span id=\"__span-21-6\"><a id=\"__codelineno-21-6\" name=\"__codelineno-21-6\" href=\"#__codelineno-21-6\"></a><span class=\"w\">  </span><span class=\"n\">mfastbinptr</span><span class=\"w\"> </span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">NFASTBINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-21-7\"><a id=\"__codelineno-21-7\" name=\"__codelineno-21-7\" href=\"#__codelineno-21-7\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5728 64 \u4f4d\u4e0b\uff0c\u9ed8\u8ba4 <code>NFASTBINS</code> \u7b49\u4e8e 10\uff0c\u8ba1\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u6700\u5927\u7684\u7531 fast bin \u7ba1\u7406\u7684\u5757\u5927\u5c0f\u7b49\u4e8e <code>80 * sizeof(size_t) / 4 + sizeof(size_t)</code> \u5411\u4e0a\u53d6\u6574\u5230 16 \u7684\u500d\u6570\uff0c\u5728 64 \u4f4d\u673a\u5668\u4e0a\u7b49\u4e8e 176 \u5b57\u8282</li>\n<li>\u5206\u914d\u7c92\u5ea6\u4ece\u6700\u5c0f\u7684 32 \u5b57\u8282\u5230\u6700\u5927\u7684 176 \u5b57\u8282\uff0c\u6bcf 16 \u5b57\u8282\u4e00\u4e2a bin\uff0c\u4e00\u5171\u6709 10 \u4e2a bin\uff08<code>(176 - 32) / 16 + 1 = 10</code>\uff09</li>\n</ol>\n<p>\u4e0d\u8fc7\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cfast bin \u7ba1\u7406\u7684\u5757\u5927\u5c0f\u901a\u8fc7 <code>set_max_fast(DEFAULT_MXFAST)</code> \u88ab\u9650\u5236\u5728 <code>DEFAULT_MXFAST</code> \u9644\u8fd1\uff0c\u8fd9\u4e2a\u503c\u7b49\u4e8e <code>64 * sizeof(size_t) / 4</code>\uff0c\u52a0\u4e0a <code>sizeof(size_t)</code> \u518d\u5411\u4e0b\u53d6\u6574\u5230 16 \u7684\u500d\u6570\uff0c\u5c31\u662f 128 \u5b57\u8282\u3002\u6b64\u65f6\uff0c\u53ea\u6709\u524d 7 \u4e2a bin \u53ef\u4ee5\u88ab\u7528\u5230\uff0832 \u5b57\u8282\u5230 128 \u5b57\u8282\uff0c\u6bcf 16 \u5b57\u8282\u4e00\u4e2a bin\uff0c<code>(128 - 32) / 16 + 1 = 7</code>\uff09\uff0c\u5373 <code>malloc(120)</code> \u6216\u66f4\u5c0f\u7684\u5206\u914d\u4f1a\u4fdd\u5b58\u5230 fast bin \u4e2d\uff0c<code>malloc(121)</code> \u6216\u66f4\u5927\u7684\u5206\u914d\u5219\u4e0d\u4f1a\u3002</p>\n<h3 id=\"malloc_2\">malloc<a class=\"headerlink\" href=\"#malloc_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5206\u914d\u7684\u65f6\u5019\uff0c\u548c tcache \u7c7b\u4f3c\uff0c\u4e5f\u662f\u8ba1\u7b97\u51fa fastbin \u7684 index\uff0c\u7136\u540e\u53bb\u627e\u5bf9\u5e94\u7684\u94fe\u8868\uff0c\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u5219\u4ece\u94fe\u8868\u5934\u53d6\u51fa\u7a7a\u95f2\u5757\u7528\u4e8e\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-22-1\"><a id=\"__codelineno-22-1\" name=\"__codelineno-22-1\" href=\"#__codelineno-22-1\"></a><span class=\"cp\">#define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span>\n</span><span id=\"__span-22-2\"><a id=\"__codelineno-22-2\" name=\"__codelineno-22-2\" href=\"#__codelineno-22-2\"></a>\n</span><span id=\"__span-22-3\"><a id=\"__codelineno-22-3\" name=\"__codelineno-22-3\" href=\"#__codelineno-22-3\"></a><span class=\"cm\">/* offset 2 to use otherwise unindexable first 2 bins */</span>\n</span><span id=\"__span-22-4\"><a id=\"__codelineno-22-4\" name=\"__codelineno-22-4\" href=\"#__codelineno-22-4\"></a><span class=\"cp\">#define fastbin_index(sz) \\</span>\n</span><span id=\"__span-22-5\"><a id=\"__codelineno-22-5\" name=\"__codelineno-22-5\" href=\"#__codelineno-22-5\"></a><span class=\"cp\">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>\n</span><span id=\"__span-22-6\"><a id=\"__codelineno-22-6\" name=\"__codelineno-22-6\" href=\"#__codelineno-22-6\"></a>\n</span><span id=\"__span-22-7\"><a id=\"__codelineno-22-7\" name=\"__codelineno-22-7\" href=\"#__codelineno-22-7\"></a><span class=\"c1\">// in _int_malloc, allocate using fastbin</span>\n</span><span id=\"__span-22-8\"><a id=\"__codelineno-22-8\" name=\"__codelineno-22-8\" href=\"#__codelineno-22-8\"></a><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fastbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-9\"><a id=\"__codelineno-22-9\" name=\"__codelineno-22-9\" href=\"#__codelineno-22-9\"></a><span class=\"n\">mfastbinptr</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-10\"><a id=\"__codelineno-22-10\" name=\"__codelineno-22-10\" href=\"#__codelineno-22-10\"></a><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-11\"><a id=\"__codelineno-22-11\" name=\"__codelineno-22-11\" href=\"#__codelineno-22-11\"></a><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-12\"><a id=\"__codelineno-22-12\" name=\"__codelineno-22-12\" href=\"#__codelineno-22-12\"></a>\n</span><span id=\"__span-22-13\"><a id=\"__codelineno-22-13\" name=\"__codelineno-22-13\" href=\"#__codelineno-22-13\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-14\"><a id=\"__codelineno-22-14\" name=\"__codelineno-22-14\" href=\"#__codelineno-22-14\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-15\"><a id=\"__codelineno-22-15\" name=\"__codelineno-22-15\" href=\"#__codelineno-22-15\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-16\"><a id=\"__codelineno-22-16\" name=\"__codelineno-22-16\" href=\"#__codelineno-22-16\"></a><span class=\"w\">      </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-17\"><a id=\"__codelineno-22-17\" name=\"__codelineno-22-17\" href=\"#__codelineno-22-17\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-22-18\"><a id=\"__codelineno-22-18\" name=\"__codelineno-22-18\" href=\"#__codelineno-22-18\"></a><span class=\"w\">      </span><span class=\"n\">REMOVE_FB</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-19\"><a id=\"__codelineno-22-19\" name=\"__codelineno-22-19\" href=\"#__codelineno-22-19\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_likely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">))</span>\n</span><span id=\"__span-22-20\"><a id=\"__codelineno-22-20\" name=\"__codelineno-22-20\" href=\"#__codelineno-22-20\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-21\"><a id=\"__codelineno-22-21\" name=\"__codelineno-22-21\" href=\"#__codelineno-22-21\"></a><span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">victim_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fastbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">));</span>\n</span><span id=\"__span-22-22\"><a id=\"__codelineno-22-22\" name=\"__codelineno-22-22\" href=\"#__codelineno-22-22\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__builtin_expect</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim_idx</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n</span><span id=\"__span-22-23\"><a id=\"__codelineno-22-23\" name=\"__codelineno-22-23\" href=\"#__codelineno-22-23\"></a><span class=\"w\">          </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): memory corruption (fast)&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-24\"><a id=\"__codelineno-22-24\" name=\"__codelineno-22-24\" href=\"#__codelineno-22-24\"></a><span class=\"w\">        </span><span class=\"n\">check_remalloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-25\"><a id=\"__codelineno-22-25\" name=\"__codelineno-22-25\" href=\"#__codelineno-22-25\"></a><span class=\"w\">        </span><span class=\"cm\">/* While we&#39;re here, if we see other chunks of the same size,</span>\n</span><span id=\"__span-22-26\"><a id=\"__codelineno-22-26\" name=\"__codelineno-22-26\" href=\"#__codelineno-22-26\"></a><span class=\"cm\">          stash them in the tcache.  */</span>\n</span><span id=\"__span-22-27\"><a id=\"__codelineno-22-27\" name=\"__codelineno-22-27\" href=\"#__codelineno-22-27\"></a><span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-28\"><a id=\"__codelineno-22-28\" name=\"__codelineno-22-28\" href=\"#__codelineno-22-28\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-29\"><a id=\"__codelineno-22-29\" name=\"__codelineno-22-29\" href=\"#__codelineno-22-29\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-30\"><a id=\"__codelineno-22-30\" name=\"__codelineno-22-30\" href=\"#__codelineno-22-30\"></a><span class=\"w\">            </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-31\"><a id=\"__codelineno-22-31\" name=\"__codelineno-22-31\" href=\"#__codelineno-22-31\"></a>\n</span><span id=\"__span-22-32\"><a id=\"__codelineno-22-32\" name=\"__codelineno-22-32\" href=\"#__codelineno-22-32\"></a><span class=\"w\">            </span><span class=\"cm\">/* While bin not empty and tcache not full, copy chunks.  */</span>\n</span><span id=\"__span-22-33\"><a id=\"__codelineno-22-33\" name=\"__codelineno-22-33\" href=\"#__codelineno-22-33\"></a><span class=\"w\">            </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span>\n</span><span id=\"__span-22-34\"><a id=\"__codelineno-22-34\" name=\"__codelineno-22-34\" href=\"#__codelineno-22-34\"></a><span class=\"w\">                  </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-35\"><a id=\"__codelineno-22-35\" name=\"__codelineno-22-35\" href=\"#__codelineno-22-35\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-36\"><a id=\"__codelineno-22-36\" name=\"__codelineno-22-36\" href=\"#__codelineno-22-36\"></a><span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-22-37\"><a id=\"__codelineno-22-37\" name=\"__codelineno-22-37\" href=\"#__codelineno-22-37\"></a><span class=\"w\">                  </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-38\"><a id=\"__codelineno-22-38\" name=\"__codelineno-22-38\" href=\"#__codelineno-22-38\"></a><span class=\"w\">                </span><span class=\"k\">else</span>\n</span><span id=\"__span-22-39\"><a id=\"__codelineno-22-39\" name=\"__codelineno-22-39\" href=\"#__codelineno-22-39\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-22-40\"><a id=\"__codelineno-22-40\" name=\"__codelineno-22-40\" href=\"#__codelineno-22-40\"></a><span class=\"w\">                    </span><span class=\"n\">REMOVE_FB</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-41\"><a id=\"__codelineno-22-41\" name=\"__codelineno-22-41\" href=\"#__codelineno-22-41\"></a><span class=\"w\">                    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">))</span>\n</span><span id=\"__span-22-42\"><a id=\"__codelineno-22-42\" name=\"__codelineno-22-42\" href=\"#__codelineno-22-42\"></a><span class=\"w\">                      </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-43\"><a id=\"__codelineno-22-43\" name=\"__codelineno-22-43\" href=\"#__codelineno-22-43\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-44\"><a id=\"__codelineno-22-44\" name=\"__codelineno-22-44\" href=\"#__codelineno-22-44\"></a><span class=\"w\">                </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-45\"><a id=\"__codelineno-22-45\" name=\"__codelineno-22-45\" href=\"#__codelineno-22-45\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-46\"><a id=\"__codelineno-22-46\" name=\"__codelineno-22-46\" href=\"#__codelineno-22-46\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-47\"><a id=\"__codelineno-22-47\" name=\"__codelineno-22-47\" href=\"#__codelineno-22-47\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-48\"><a id=\"__codelineno-22-48\" name=\"__codelineno-22-48\" href=\"#__codelineno-22-48\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-22-49\"><a id=\"__codelineno-22-49\" name=\"__codelineno-22-49\" href=\"#__codelineno-22-49\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-22-50\"><a id=\"__codelineno-22-50\" name=\"__codelineno-22-50\" href=\"#__codelineno-22-50\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-22-51\"><a id=\"__codelineno-22-51\" name=\"__codelineno-22-51\" href=\"#__codelineno-22-51\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 <code>fastbin_index (nb)</code> \u6839\u636e\u5757\u7684\u5927\u5c0f\u8ba1\u7b97\u51fa fast bin \u7684 index\uff0c\u7136\u540e <code>fastbin (av, idx)</code> \u5bf9\u5e94 fast bin \u7684\u94fe\u8868\u5934\u6307\u9488</li>\n<li>\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u8bf4\u660e\u53ef\u4ee5\u4ece fast bin \u5206\u914d\u7a7a\u95f2\u5757\uff0c\u6b64\u65f6\u5c31\u628a\u94fe\u8868\u5934\u7684\u7ed3\u70b9\u5f39\u51fa\uff1a<code>*fb = victim-&gt;fd</code>\uff08\u5355\u7ebf\u7a0b\uff09\u6216 <code>REMOVE_FB (fb, pp, victim)</code>\uff08\u591a\u7ebf\u7a0b\uff09\uff1b\u53ea\u7528\u5230\u4e86\u5355\u5411\u94fe\u8868\u7684 <code>fd</code> \u6307\u9488\uff0c\u5176\u4f59\u7684\u5b57\u6bb5\u6ca1\u6709\u7528\u5230</li>\n<li>\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u5b89\u5168\u68c0\u67e5\uff1a<code>__builtin_expect</code> \u548c <code>check_remalloced_chunk</code></li>\n<li>\u68c0\u67e5 tcache \u5bf9\u5e94\u7684 bin\uff0c\u5982\u679c\u5b83\u8fd8\u6ca1\u6709\u6ee1\uff0c\u5c31\u628a fast bin \u94fe\u8868\u4e2d\u7684\u5143\u7d20\u632a\u5230 tcache \u5f53\u4e2d</li>\n<li>\u628a payload \u5730\u5740\u901a\u8fc7 <code>chunk2mem</code> \u8ba1\u7b97\u51fa\u6765\uff0c\u8fd4\u56de\u7ed9 malloc \u8c03\u7528\u8005</li>\n<li>\u8c03\u7528 <code>alloc_perturb</code> \u5f80\u65b0\u5206\u914d\u7684\u7a7a\u95f4\u5185\u5199\u5165\u5783\u573e\u6570\u636e\uff08\u53ef\u9009\uff09\uff0c\u907f\u514d\u6cc4\u9732\u4e4b\u524d\u7684\u6570\u636e</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6bd4\u8f83\u7b80\u5355\uff0c\u548c tcache \u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u5b83\u4ece thread local \u7684 tcache \u6539\u6210\u4e86\u652f\u6301\u591a\u7ebf\u7a0b\u7684\u7248\u672c\uff0c\u540c\u65f6\u4e3a\u4e86\u652f\u6301\u591a\u7ebf\u7a0b\u8bbf\u95ee\uff0c\u4f7f\u7528 CAS \u539f\u5b50\u6307\u4ee4\u6765\u66f4\u65b0\u94fe\u8868\u5934\u90e8\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-23-1\"><a id=\"__codelineno-23-1\" name=\"__codelineno-23-1\" href=\"#__codelineno-23-1\"></a><span class=\"cp\">#define REMOVE_FB(fb, victim, pp) \\</span>\n</span><span id=\"__span-23-2\"><a id=\"__codelineno-23-2\" name=\"__codelineno-23-2\" href=\"#__codelineno-23-2\"></a><span class=\"cp\">  do                              \\</span>\n</span><span id=\"__span-23-3\"><a id=\"__codelineno-23-3\" name=\"__codelineno-23-3\" href=\"#__codelineno-23-3\"></a><span class=\"cp\">    {                             \\</span>\n</span><span id=\"__span-23-4\"><a id=\"__codelineno-23-4\" name=\"__codelineno-23-4\" href=\"#__codelineno-23-4\"></a><span class=\"cp\">      victim = pp;                \\</span>\n</span><span id=\"__span-23-5\"><a id=\"__codelineno-23-5\" name=\"__codelineno-23-5\" href=\"#__codelineno-23-5\"></a><span class=\"cp\">      if (victim == NULL)         \\</span>\n</span><span id=\"__span-23-6\"><a id=\"__codelineno-23-6\" name=\"__codelineno-23-6\" href=\"#__codelineno-23-6\"></a><span class=\"cp\">        break;                    \\</span>\n</span><span id=\"__span-23-7\"><a id=\"__codelineno-23-7\" name=\"__codelineno-23-7\" href=\"#__codelineno-23-7\"></a><span class=\"cp\">    }                             \\</span>\n</span><span id=\"__span-23-8\"><a id=\"__codelineno-23-8\" name=\"__codelineno-23-8\" href=\"#__codelineno-23-8\"></a><span class=\"cp\">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) != victim);</span>\n</span></code></pre></div>\n<p>\u6b63\u56e0\u5982\u6b64\uff0c\u8fd9\u4e2a\u5206\u914d\u8fc7\u7a0b\u624d\u80fd\u505a\u5230\u6bd4\u8f83\u5feb\uff0c\u6240\u4ee5\u8fd9\u6837\u7684\u5206\u914d\u65b9\u6cd5\u53eb\u505a fast bin\u3002</p>\n<h3 id=\"free_1\">free<a class=\"headerlink\" href=\"#free_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u5206\u6790\u4e00\u4e0b free \u7684\u65f6\u5019\uff0c\u7a7a\u95f2\u5757\u662f\u5982\u4f55\u8fdb\u5165 fast bin \u7684\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-24-1\"><a id=\"__codelineno-24-1\" name=\"__codelineno-24-1\" href=\"#__codelineno-24-1\"></a><span class=\"c1\">// in _int_free, after tcache handling</span>\n</span><span id=\"__span-24-2\"><a id=\"__codelineno-24-2\" name=\"__codelineno-24-2\" href=\"#__codelineno-24-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)(</span><span class=\"n\">get_max_fast</span><span class=\"w\"> </span><span class=\"p\">()))</span>\n</span><span id=\"__span-24-3\"><a id=\"__codelineno-24-3\" name=\"__codelineno-24-3\" href=\"#__codelineno-24-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-24-4\"><a id=\"__codelineno-24-4\" name=\"__codelineno-24-4\" href=\"#__codelineno-24-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* check omitted */</span>\n</span><span id=\"__span-24-5\"><a id=\"__codelineno-24-5\" name=\"__codelineno-24-5\" href=\"#__codelineno-24-5\"></a><span class=\"w\">    </span><span class=\"n\">free_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk2mem</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">SIZE_SZ</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-6\"><a id=\"__codelineno-24-6\" name=\"__codelineno-24-6\" href=\"#__codelineno-24-6\"></a>\n</span><span id=\"__span-24-7\"><a id=\"__codelineno-24-7\" name=\"__codelineno-24-7\" href=\"#__codelineno-24-7\"></a><span class=\"w\">    </span><span class=\"n\">atomic_store_relaxed</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">have_fastchunks</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-8\"><a id=\"__codelineno-24-8\" name=\"__codelineno-24-8\" href=\"#__codelineno-24-8\"></a><span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fastbin_index</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-9\"><a id=\"__codelineno-24-9\" name=\"__codelineno-24-9\" href=\"#__codelineno-24-9\"></a><span class=\"w\">    </span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-10\"><a id=\"__codelineno-24-10\" name=\"__codelineno-24-10\" href=\"#__codelineno-24-10\"></a>\n</span><span id=\"__span-24-11\"><a id=\"__codelineno-24-11\" name=\"__codelineno-24-11\" href=\"#__codelineno-24-11\"></a><span class=\"w\">    </span><span class=\"cm\">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span>\n</span><span id=\"__span-24-12\"><a id=\"__codelineno-24-12\" name=\"__codelineno-24-12\" href=\"#__codelineno-24-12\"></a><span class=\"w\">    </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-13\"><a id=\"__codelineno-24-13\" name=\"__codelineno-24-13\" href=\"#__codelineno-24-13\"></a>\n</span><span id=\"__span-24-14\"><a id=\"__codelineno-24-14\" name=\"__codelineno-24-14\" href=\"#__codelineno-24-14\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">SINGLE_THREAD_P</span><span class=\"p\">)</span>\n</span><span id=\"__span-24-15\"><a id=\"__codelineno-24-15\" name=\"__codelineno-24-15\" href=\"#__codelineno-24-15\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-24-16\"><a id=\"__codelineno-24-16\" name=\"__codelineno-24-16\" href=\"#__codelineno-24-16\"></a><span class=\"w\">        </span><span class=\"cm\">/* Check that the top of the bin is not the record we are going to</span>\n</span><span id=\"__span-24-17\"><a id=\"__codelineno-24-17\" name=\"__codelineno-24-17\" href=\"#__codelineno-24-17\"></a><span class=\"cm\">          add (i.e., double free).  */</span>\n</span><span id=\"__span-24-18\"><a id=\"__codelineno-24-18\" name=\"__codelineno-24-18\" href=\"#__codelineno-24-18\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__builtin_expect</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n</span><span id=\"__span-24-19\"><a id=\"__codelineno-24-19\" name=\"__codelineno-24-19\" href=\"#__codelineno-24-19\"></a><span class=\"w\">          </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;double free or corruption (fasttop)&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-20\"><a id=\"__codelineno-24-20\" name=\"__codelineno-24-20\" href=\"#__codelineno-24-20\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-21\"><a id=\"__codelineno-24-21\" name=\"__codelineno-24-21\" href=\"#__codelineno-24-21\"></a><span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-22\"><a id=\"__codelineno-24-22\" name=\"__codelineno-24-22\" href=\"#__codelineno-24-22\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-24-23\"><a id=\"__codelineno-24-23\" name=\"__codelineno-24-23\" href=\"#__codelineno-24-23\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-24-24\"><a id=\"__codelineno-24-24\" name=\"__codelineno-24-24\" href=\"#__codelineno-24-24\"></a><span class=\"w\">      </span><span class=\"k\">do</span>\n</span><span id=\"__span-24-25\"><a id=\"__codelineno-24-25\" name=\"__codelineno-24-25\" href=\"#__codelineno-24-25\"></a><span class=\"w\">        </span><span class=\"p\">{</span>\n</span><span id=\"__span-24-26\"><a id=\"__codelineno-24-26\" name=\"__codelineno-24-26\" href=\"#__codelineno-24-26\"></a><span class=\"w\">          </span><span class=\"cm\">/* Check that the top of the bin is not the record we are going to</span>\n</span><span id=\"__span-24-27\"><a id=\"__codelineno-24-27\" name=\"__codelineno-24-27\" href=\"#__codelineno-24-27\"></a><span class=\"cm\">            add (i.e., double free).  */</span>\n</span><span id=\"__span-24-28\"><a id=\"__codelineno-24-28\" name=\"__codelineno-24-28\" href=\"#__codelineno-24-28\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__builtin_expect</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n</span><span id=\"__span-24-29\"><a id=\"__codelineno-24-29\" name=\"__codelineno-24-29\" href=\"#__codelineno-24-29\"></a><span class=\"w\">            </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;double free or corruption (fasttop)&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-30\"><a id=\"__codelineno-24-30\" name=\"__codelineno-24-30\" href=\"#__codelineno-24-30\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">;</span>\n</span><span id=\"__span-24-31\"><a id=\"__codelineno-24-31\" name=\"__codelineno-24-31\" href=\"#__codelineno-24-31\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-24-32\"><a id=\"__codelineno-24-32\" name=\"__codelineno-24-32\" href=\"#__codelineno-24-32\"></a><span class=\"w\">      </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">catomic_compare_and_exchange_val_rel</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"p\">))</span>\n</span><span id=\"__span-24-33\"><a id=\"__codelineno-24-33\" name=\"__codelineno-24-33\" href=\"#__codelineno-24-33\"></a><span class=\"w\">              </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">old2</span><span class=\"p\">);</span>\n</span><span id=\"__span-24-34\"><a id=\"__codelineno-24-34\" name=\"__codelineno-24-34\" href=\"#__codelineno-24-34\"></a>\n</span><span id=\"__span-24-35\"><a id=\"__codelineno-24-35\" name=\"__codelineno-24-35\" href=\"#__codelineno-24-35\"></a><span class=\"w\">    </span><span class=\"cm\">/* check omitted */</span>\n</span><span id=\"__span-24-36\"><a id=\"__codelineno-24-36\" name=\"__codelineno-24-36\" href=\"#__codelineno-24-36\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u7684\u903b\u8f91\u5f88\u7b80\u5355\uff1a\u5982\u679c\u5927\u5c0f\u5408\u9002\uff0c\u5c31\u76f4\u63a5\u6dfb\u52a0\u5230 fast bin \u7684\u94fe\u8868\u5934\u91cc\uff0c\u6ca1\u6709 tcache \u90a3\u6837\u7684\u957f\u5ea6\u9650\u5236\uff0c\u591a\u7ebf\u7a0b\u573a\u666f\u4e0b\u4f9d\u7136\u662f\u7528 CAS \u6765\u5b9e\u73b0\u539f\u5b50\u7684\u94fe\u8868\u63d2\u5165\u3002</p>\n<p>\u76f8\u6bd4 tcache\uff0cfast bin \u7684 double free \u68c0\u67e5\u66f4\u52a0\u7b80\u964b\uff1a\u5b83\u53ea\u80fd\u9632\u62a4\u8fde\u7eed\u4e24\u6b21 free \u540c\u4e00\u4e2a\u5757\uff0c\u53ea\u5224\u65ad\u4e86\u8981\u63d2\u5165\u94fe\u8868\u7684\u5757\u662f\u5426\u5728\u94fe\u8868\u5934\uff0c\u800c\u4e0d\u4f1a\u68c0\u67e5\u662f\u5426\u5728\u94fe\u8868\u4e2d\u95f4\u3002</p>\n<h3 id=\"\u5b9e\u9a8c_1\">\u5b9e\u9a8c<a class=\"headerlink\" href=\"#\u5b9e\u9a8c_1\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u5199\u4e00\u6bb5\u4ee3\u7801\u6765\u89c2\u5bdf fast bin \u7684\u66f4\u65b0\u8fc7\u7a0b\uff1a</p>\n<ol>\n<li>\u7531\u4e8e fastbin \u4fdd\u5b58\u5728 <code>main_arena</code> \u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u627e\u5230 <code>main_arena</code> \u7684\u8fd0\u884c\u65f6\u5730\u5740</li>\n<li><code>main_arena</code> \u4e0d\u5728 libc \u7b26\u53f7\u8868\u4e2d\uff0c\u4e0d\u80fd\u76f4\u63a5\u627e\u5230\u5b83\u7684\u5730\u5740\uff0c\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7 libc \u7684\u8c03\u8bd5\u7b26\u53f7\uff0c\u627e\u5230\u5b83\u76f8\u5bf9 image base \u7684 offset \u662f <code>0x1ecb80</code></li>\n<li>\u518d\u627e\u4e00\u4e2a\u5728\u7b26\u53f7\u8868\u4e2d\u7684\u7b26\u53f7 <code>_IO_2_1_stdout_</code>\uff0c\u5b83\u76f8\u5bf9 image base \u7684 offset \u662f <code>0x1ed6a0</code></li>\n<li>\u6839\u636e\u4ee5\u4e0a\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u627e\u5230 libc \u7684 image base \u5730\u5740\uff0c\u4ece\u800c\u63a8\u65ad <code>main_arena</code> \u7684\u5730\u5740\uff0c\u8fdb\u800c\u627e\u5230\u6240\u6709\u7684 fast bin</li>\n<li>\u4e0b\u9762\u5199\u4e00\u6bb5\u4ee3\u7801\uff0c\u89c2\u5bdf\u7a7a\u95f2\u5757\u8fdb\u5165 fast bin \u7684\u8fc7\u7a0b</li>\n</ol>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-25-1\"><a id=\"__codelineno-25-1\" name=\"__codelineno-25-1\" href=\"#__codelineno-25-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stddef.h&gt;</span>\n</span><span id=\"__span-25-2\"><a id=\"__codelineno-25-2\" name=\"__codelineno-25-2\" href=\"#__codelineno-25-2\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdint.h&gt;</span>\n</span><span id=\"__span-25-3\"><a id=\"__codelineno-25-3\" name=\"__codelineno-25-3\" href=\"#__codelineno-25-3\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-25-4\"><a id=\"__codelineno-25-4\" name=\"__codelineno-25-4\" href=\"#__codelineno-25-4\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n</span><span id=\"__span-25-5\"><a id=\"__codelineno-25-5\" name=\"__codelineno-25-5\" href=\"#__codelineno-25-5\"></a>\n</span><span id=\"__span-25-6\"><a id=\"__codelineno-25-6\" name=\"__codelineno-25-6\" href=\"#__codelineno-25-6\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-7\"><a id=\"__codelineno-25-7\" name=\"__codelineno-25-7\" href=\"#__codelineno-25-7\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">mchunk_prev_size</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Size of previous chunk (if free).  */</span>\n</span><span id=\"__span-25-8\"><a id=\"__codelineno-25-8\" name=\"__codelineno-25-8\" href=\"#__codelineno-25-8\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">mchunk_size</span><span class=\"p\">;</span><span class=\"w\">      </span><span class=\"cm\">/* Size in bytes, including overhead. */</span>\n</span><span id=\"__span-25-9\"><a id=\"__codelineno-25-9\" name=\"__codelineno-25-9\" href=\"#__codelineno-25-9\"></a>\n</span><span id=\"__span-25-10\"><a id=\"__codelineno-25-10\" name=\"__codelineno-25-10\" href=\"#__codelineno-25-10\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fd</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-25-11\"><a id=\"__codelineno-25-11\" name=\"__codelineno-25-11\" href=\"#__codelineno-25-11\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-12\"><a id=\"__codelineno-25-12\" name=\"__codelineno-25-12\" href=\"#__codelineno-25-12\"></a>\n</span><span id=\"__span-25-13\"><a id=\"__codelineno-25-13\" name=\"__codelineno-25-13\" href=\"#__codelineno-25-13\"></a><span class=\"w\">  </span><span class=\"cm\">/* Only used for large blocks: pointer to next larger size.  */</span>\n</span><span id=\"__span-25-14\"><a id=\"__codelineno-25-14\" name=\"__codelineno-25-14\" href=\"#__codelineno-25-14\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* double links -- used only if free. */</span>\n</span><span id=\"__span-25-15\"><a id=\"__codelineno-25-15\" name=\"__codelineno-25-15\" href=\"#__codelineno-25-15\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-16\"><a id=\"__codelineno-25-16\" name=\"__codelineno-25-16\" href=\"#__codelineno-25-16\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-25-17\"><a id=\"__codelineno-25-17\" name=\"__codelineno-25-17\" href=\"#__codelineno-25-17\"></a>\n</span><span id=\"__span-25-18\"><a id=\"__codelineno-25-18\" name=\"__codelineno-25-18\" href=\"#__codelineno-25-18\"></a><span class=\"cm\">/* offset 2 to use otherwise unindexable first 2 bins */</span>\n</span><span id=\"__span-25-19\"><a id=\"__codelineno-25-19\" name=\"__codelineno-25-19\" href=\"#__codelineno-25-19\"></a><span class=\"cp\">#define fastbin_index(sz) ((((unsigned int)(sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>\n</span><span id=\"__span-25-20\"><a id=\"__codelineno-25-20\" name=\"__codelineno-25-20\" href=\"#__codelineno-25-20\"></a>\n</span><span id=\"__span-25-21\"><a id=\"__codelineno-25-21\" name=\"__codelineno-25-21\" href=\"#__codelineno-25-21\"></a><span class=\"cp\">#define INTERNAL_SIZE_T size_t</span>\n</span><span id=\"__span-25-22\"><a id=\"__codelineno-25-22\" name=\"__codelineno-25-22\" href=\"#__codelineno-25-22\"></a>\n</span><span id=\"__span-25-23\"><a id=\"__codelineno-25-23\" name=\"__codelineno-25-23\" href=\"#__codelineno-25-23\"></a><span class=\"cm\">/* MALLOC_ALIGNMENT equals to 16 on 64-bit */</span>\n</span><span id=\"__span-25-24\"><a id=\"__codelineno-25-24\" name=\"__codelineno-25-24\" href=\"#__codelineno-25-24\"></a><span class=\"cp\">#define MALLOC_ALIGNMENT                                                       \\</span>\n</span><span id=\"__span-25-25\"><a id=\"__codelineno-25-25\" name=\"__codelineno-25-25\" href=\"#__codelineno-25-25\"></a><span class=\"cp\">  (2 * SIZE_SZ &lt; __alignof__(long double) ? __alignof__(long double)           \\</span>\n</span><span id=\"__span-25-26\"><a id=\"__codelineno-25-26\" name=\"__codelineno-25-26\" href=\"#__codelineno-25-26\"></a><span class=\"cp\">                                          : 2 * SIZE_SZ)</span>\n</span><span id=\"__span-25-27\"><a id=\"__codelineno-25-27\" name=\"__codelineno-25-27\" href=\"#__codelineno-25-27\"></a>\n</span><span id=\"__span-25-28\"><a id=\"__codelineno-25-28\" name=\"__codelineno-25-28\" href=\"#__codelineno-25-28\"></a><span class=\"cm\">/* The corresponding word size.  */</span>\n</span><span id=\"__span-25-29\"><a id=\"__codelineno-25-29\" name=\"__codelineno-25-29\" href=\"#__codelineno-25-29\"></a><span class=\"cm\">/* SIZE_SZ equals to 8 on 64-bit */</span>\n</span><span id=\"__span-25-30\"><a id=\"__codelineno-25-30\" name=\"__codelineno-25-30\" href=\"#__codelineno-25-30\"></a><span class=\"cp\">#define SIZE_SZ (sizeof(INTERNAL_SIZE_T))</span>\n</span><span id=\"__span-25-31\"><a id=\"__codelineno-25-31\" name=\"__codelineno-25-31\" href=\"#__codelineno-25-31\"></a>\n</span><span id=\"__span-25-32\"><a id=\"__codelineno-25-32\" name=\"__codelineno-25-32\" href=\"#__codelineno-25-32\"></a><span class=\"cm\">/* The corresponding bit mask value.  */</span>\n</span><span id=\"__span-25-33\"><a id=\"__codelineno-25-33\" name=\"__codelineno-25-33\" href=\"#__codelineno-25-33\"></a><span class=\"cm\">/* MALLOC_ALIGN_MASK equals to 15 on 64-bit */</span>\n</span><span id=\"__span-25-34\"><a id=\"__codelineno-25-34\" name=\"__codelineno-25-34\" href=\"#__codelineno-25-34\"></a><span class=\"cp\">#define MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span>\n</span><span id=\"__span-25-35\"><a id=\"__codelineno-25-35\" name=\"__codelineno-25-35\" href=\"#__codelineno-25-35\"></a>\n</span><span id=\"__span-25-36\"><a id=\"__codelineno-25-36\" name=\"__codelineno-25-36\" href=\"#__codelineno-25-36\"></a><span class=\"cm\">/* The smallest possible chunk */</span>\n</span><span id=\"__span-25-37\"><a id=\"__codelineno-25-37\" name=\"__codelineno-25-37\" href=\"#__codelineno-25-37\"></a><span class=\"cm\">/* MIN_CHUNK_SIZE equals to 32 on 64-bit */</span>\n</span><span id=\"__span-25-38\"><a id=\"__codelineno-25-38\" name=\"__codelineno-25-38\" href=\"#__codelineno-25-38\"></a><span class=\"cp\">#define MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</span>\n</span><span id=\"__span-25-39\"><a id=\"__codelineno-25-39\" name=\"__codelineno-25-39\" href=\"#__codelineno-25-39\"></a>\n</span><span id=\"__span-25-40\"><a id=\"__codelineno-25-40\" name=\"__codelineno-25-40\" href=\"#__codelineno-25-40\"></a><span class=\"cm\">/* The smallest size we can malloc is an aligned minimal chunk */</span>\n</span><span id=\"__span-25-41\"><a id=\"__codelineno-25-41\" name=\"__codelineno-25-41\" href=\"#__codelineno-25-41\"></a><span class=\"cm\">/* MINSIZE equals to 32 on 64-bit */</span>\n</span><span id=\"__span-25-42\"><a id=\"__codelineno-25-42\" name=\"__codelineno-25-42\" href=\"#__codelineno-25-42\"></a><span class=\"cp\">#define MINSIZE                                                                \\</span>\n</span><span id=\"__span-25-43\"><a id=\"__codelineno-25-43\" name=\"__codelineno-25-43\" href=\"#__codelineno-25-43\"></a><span class=\"cp\">  (unsigned long)(((MIN_CHUNK_SIZE + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span>\n</span><span id=\"__span-25-44\"><a id=\"__codelineno-25-44\" name=\"__codelineno-25-44\" href=\"#__codelineno-25-44\"></a>\n</span><span id=\"__span-25-45\"><a id=\"__codelineno-25-45\" name=\"__codelineno-25-45\" href=\"#__codelineno-25-45\"></a><span class=\"cm\">/* equivalent to max(alignUp(req + SIZE_SZ, MALLOC_ALIGNMENT), MINSIZE) */</span>\n</span><span id=\"__span-25-46\"><a id=\"__codelineno-25-46\" name=\"__codelineno-25-46\" href=\"#__codelineno-25-46\"></a><span class=\"cp\">#define request2size(req)                                                      \\</span>\n</span><span id=\"__span-25-47\"><a id=\"__codelineno-25-47\" name=\"__codelineno-25-47\" href=\"#__codelineno-25-47\"></a><span class=\"cp\">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                             \\</span>\n</span><span id=\"__span-25-48\"><a id=\"__codelineno-25-48\" name=\"__codelineno-25-48\" href=\"#__codelineno-25-48\"></a><span class=\"cp\">       ? MINSIZE                                                               \\</span>\n</span><span id=\"__span-25-49\"><a id=\"__codelineno-25-49\" name=\"__codelineno-25-49\" href=\"#__codelineno-25-49\"></a><span class=\"cp\">       : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span>\n</span><span id=\"__span-25-50\"><a id=\"__codelineno-25-50\" name=\"__codelineno-25-50\" href=\"#__codelineno-25-50\"></a>\n</span><span id=\"__span-25-51\"><a id=\"__codelineno-25-51\" name=\"__codelineno-25-51\" href=\"#__codelineno-25-51\"></a><span class=\"cm\">/* MAX_FAST_SIZE equals to 160 on 64-bit */</span>\n</span><span id=\"__span-25-52\"><a id=\"__codelineno-25-52\" name=\"__codelineno-25-52\" href=\"#__codelineno-25-52\"></a><span class=\"cp\">#define MAX_FAST_SIZE (80 * SIZE_SZ / 4)</span>\n</span><span id=\"__span-25-53\"><a id=\"__codelineno-25-53\" name=\"__codelineno-25-53\" href=\"#__codelineno-25-53\"></a>\n</span><span id=\"__span-25-54\"><a id=\"__codelineno-25-54\" name=\"__codelineno-25-54\" href=\"#__codelineno-25-54\"></a><span class=\"cm\">/* NFASTBINS equals to 10 on 64-bit */</span>\n</span><span id=\"__span-25-55\"><a id=\"__codelineno-25-55\" name=\"__codelineno-25-55\" href=\"#__codelineno-25-55\"></a><span class=\"cp\">#define NFASTBINS (fastbin_index(request2size(MAX_FAST_SIZE)) + 1)</span>\n</span><span id=\"__span-25-56\"><a id=\"__codelineno-25-56\" name=\"__codelineno-25-56\" href=\"#__codelineno-25-56\"></a>\n</span><span id=\"__span-25-57\"><a id=\"__codelineno-25-57\" name=\"__codelineno-25-57\" href=\"#__codelineno-25-57\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-58\"><a id=\"__codelineno-25-58\" name=\"__codelineno-25-58\" href=\"#__codelineno-25-58\"></a><span class=\"w\">  </span><span class=\"cm\">/* Serialize access.  */</span>\n</span><span id=\"__span-25-59\"><a id=\"__codelineno-25-59\" name=\"__codelineno-25-59\" href=\"#__codelineno-25-59\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">mutex</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-60\"><a id=\"__codelineno-25-60\" name=\"__codelineno-25-60\" href=\"#__codelineno-25-60\"></a><span class=\"w\">  </span><span class=\"cm\">/* Flags (formerly in max_fast).  */</span>\n</span><span id=\"__span-25-61\"><a id=\"__codelineno-25-61\" name=\"__codelineno-25-61\" href=\"#__codelineno-25-61\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-62\"><a id=\"__codelineno-25-62\" name=\"__codelineno-25-62\" href=\"#__codelineno-25-62\"></a><span class=\"w\">  </span><span class=\"cm\">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>\n</span><span id=\"__span-25-63\"><a id=\"__codelineno-25-63\" name=\"__codelineno-25-63\" href=\"#__codelineno-25-63\"></a><span class=\"w\">  </span><span class=\"cm\">/* Note this is a bool but not all targets support atomics on booleans.  */</span>\n</span><span id=\"__span-25-64\"><a id=\"__codelineno-25-64\" name=\"__codelineno-25-64\" href=\"#__codelineno-25-64\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">have_fastchunks</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-65\"><a id=\"__codelineno-25-65\" name=\"__codelineno-25-65\" href=\"#__codelineno-25-65\"></a><span class=\"w\">  </span><span class=\"cm\">/* Fastbins */</span>\n</span><span id=\"__span-25-66\"><a id=\"__codelineno-25-66\" name=\"__codelineno-25-66\" href=\"#__codelineno-25-66\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">NFASTBINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-25-67\"><a id=\"__codelineno-25-67\" name=\"__codelineno-25-67\" href=\"#__codelineno-25-67\"></a><span class=\"p\">};</span>\n</span><span id=\"__span-25-68\"><a id=\"__codelineno-25-68\" name=\"__codelineno-25-68\" href=\"#__codelineno-25-68\"></a>\n</span><span id=\"__span-25-69\"><a id=\"__codelineno-25-69\" name=\"__codelineno-25-69\" href=\"#__codelineno-25-69\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">dump_fastbin</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-70\"><a id=\"__codelineno-25-70\" name=\"__codelineno-25-70\" href=\"#__codelineno-25-70\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">libc_base</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mh\">0x1ed6a0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// offset of _IO_2_1_stdout_</span>\n</span><span id=\"__span-25-71\"><a id=\"__codelineno-25-71\" name=\"__codelineno-25-71\" href=\"#__codelineno-25-71\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">=</span>\n</span><span id=\"__span-25-72\"><a id=\"__codelineno-25-72\" name=\"__codelineno-25-72\" href=\"#__codelineno-25-72\"></a><span class=\"w\">      </span><span class=\"n\">libc_base</span><span class=\"w\"> </span><span class=\"o\">+</span>\n</span><span id=\"__span-25-73\"><a id=\"__codelineno-25-73\" name=\"__codelineno-25-73\" href=\"#__codelineno-25-73\"></a><span class=\"w\">      </span><span class=\"mh\">0x1ecb80</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// offset of main_arena</span>\n</span><span id=\"__span-25-74\"><a id=\"__codelineno-25-74\" name=\"__codelineno-25-74\" href=\"#__codelineno-25-74\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">NFASTBINS</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-75\"><a id=\"__codelineno-25-75\" name=\"__codelineno-25-75\" href=\"#__codelineno-25-75\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">main_arena</span><span class=\"o\">-&gt;</span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-76\"><a id=\"__codelineno-25-76\" name=\"__codelineno-25-76\" href=\"#__codelineno-25-76\"></a><span class=\"w\">      </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">main_arena</span><span class=\"o\">-&gt;</span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span>\n</span><span id=\"__span-25-77\"><a id=\"__codelineno-25-77\" name=\"__codelineno-25-77\" href=\"#__codelineno-25-77\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbin #%d: %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-78\"><a id=\"__codelineno-25-78\" name=\"__codelineno-25-78\" href=\"#__codelineno-25-78\"></a><span class=\"w\">      </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-79\"><a id=\"__codelineno-25-79\" name=\"__codelineno-25-79\" href=\"#__codelineno-25-79\"></a><span class=\"w\">      </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-80\"><a id=\"__codelineno-25-80\" name=\"__codelineno-25-80\" href=\"#__codelineno-25-80\"></a><span class=\"w\">        </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot; -&gt; %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-81\"><a id=\"__codelineno-25-81\" name=\"__codelineno-25-81\" href=\"#__codelineno-25-81\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-82\"><a id=\"__codelineno-25-82\" name=\"__codelineno-25-82\" href=\"#__codelineno-25-82\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-83\"><a id=\"__codelineno-25-83\" name=\"__codelineno-25-83\" href=\"#__codelineno-25-83\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-84\"><a id=\"__codelineno-25-84\" name=\"__codelineno-25-84\" href=\"#__codelineno-25-84\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-85\"><a id=\"__codelineno-25-85\" name=\"__codelineno-25-85\" href=\"#__codelineno-25-85\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-86\"><a id=\"__codelineno-25-86\" name=\"__codelineno-25-86\" href=\"#__codelineno-25-86\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-25-87\"><a id=\"__codelineno-25-87\" name=\"__codelineno-25-87\" href=\"#__codelineno-25-87\"></a>\n</span><span id=\"__span-25-88\"><a id=\"__codelineno-25-88\" name=\"__codelineno-25-88\" href=\"#__codelineno-25-88\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-89\"><a id=\"__codelineno-25-89\" name=\"__codelineno-25-89\" href=\"#__codelineno-25-89\"></a><span class=\"w\">  </span><span class=\"c1\">// use 10 malloc + free, the first 7 blocks will be saved in tcache, the rest</span>\n</span><span id=\"__span-25-90\"><a id=\"__codelineno-25-90\" name=\"__codelineno-25-90\" href=\"#__codelineno-25-90\"></a><span class=\"w\">  </span><span class=\"c1\">// ones will go to fastbin</span>\n</span><span id=\"__span-25-91\"><a id=\"__codelineno-25-91\" name=\"__codelineno-25-91\" href=\"#__codelineno-25-91\"></a><span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"mi\">10</span><span class=\"p\">];</span>\n</span><span id=\"__span-25-92\"><a id=\"__codelineno-25-92\" name=\"__codelineno-25-92\" href=\"#__codelineno-25-92\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;allocate 10 pointers:&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-93\"><a id=\"__codelineno-25-93\" name=\"__codelineno-25-93\" href=\"#__codelineno-25-93\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-94\"><a id=\"__codelineno-25-94\" name=\"__codelineno-25-94\" href=\"#__codelineno-25-94\"></a><span class=\"w\">    </span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-95\"><a id=\"__codelineno-25-95\" name=\"__codelineno-25-95\" href=\"#__codelineno-25-95\"></a><span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot; %p&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-96\"><a id=\"__codelineno-25-96\" name=\"__codelineno-25-96\" href=\"#__codelineno-25-96\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-97\"><a id=\"__codelineno-25-97\" name=\"__codelineno-25-97\" href=\"#__codelineno-25-97\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-98\"><a id=\"__codelineno-25-98\" name=\"__codelineno-25-98\" href=\"#__codelineno-25-98\"></a>\n</span><span id=\"__span-25-99\"><a id=\"__codelineno-25-99\" name=\"__codelineno-25-99\" href=\"#__codelineno-25-99\"></a><span class=\"w\">  </span><span class=\"c1\">// now one ptr goes to fastbin</span>\n</span><span id=\"__span-25-100\"><a id=\"__codelineno-25-100\" name=\"__codelineno-25-100\" href=\"#__codelineno-25-100\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-25-101\"><a id=\"__codelineno-25-101\" name=\"__codelineno-25-101\" href=\"#__codelineno-25-101\"></a><span class=\"w\">    </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-102\"><a id=\"__codelineno-25-102\" name=\"__codelineno-25-102\" href=\"#__codelineno-25-102\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-25-103\"><a id=\"__codelineno-25-103\" name=\"__codelineno-25-103\" href=\"#__codelineno-25-103\"></a>\n</span><span id=\"__span-25-104\"><a id=\"__codelineno-25-104\" name=\"__codelineno-25-104\" href=\"#__codelineno-25-104\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbins after 8 pointers freed:</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-105\"><a id=\"__codelineno-25-105\" name=\"__codelineno-25-105\" href=\"#__codelineno-25-105\"></a><span class=\"w\">  </span><span class=\"n\">dump_fastbin</span><span class=\"p\">();</span>\n</span><span id=\"__span-25-106\"><a id=\"__codelineno-25-106\" name=\"__codelineno-25-106\" href=\"#__codelineno-25-106\"></a>\n</span><span id=\"__span-25-107\"><a id=\"__codelineno-25-107\" name=\"__codelineno-25-107\" href=\"#__codelineno-25-107\"></a><span class=\"w\">  </span><span class=\"c1\">// free the 9th one</span>\n</span><span id=\"__span-25-108\"><a id=\"__codelineno-25-108\" name=\"__codelineno-25-108\" href=\"#__codelineno-25-108\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"mi\">8</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-109\"><a id=\"__codelineno-25-109\" name=\"__codelineno-25-109\" href=\"#__codelineno-25-109\"></a>\n</span><span id=\"__span-25-110\"><a id=\"__codelineno-25-110\" name=\"__codelineno-25-110\" href=\"#__codelineno-25-110\"></a><span class=\"w\">  </span><span class=\"c1\">// two pointers in the fastbin</span>\n</span><span id=\"__span-25-111\"><a id=\"__codelineno-25-111\" name=\"__codelineno-25-111\" href=\"#__codelineno-25-111\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbins after 9 pointers freed:</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-112\"><a id=\"__codelineno-25-112\" name=\"__codelineno-25-112\" href=\"#__codelineno-25-112\"></a><span class=\"w\">  </span><span class=\"n\">dump_fastbin</span><span class=\"p\">();</span>\n</span><span id=\"__span-25-113\"><a id=\"__codelineno-25-113\" name=\"__codelineno-25-113\" href=\"#__codelineno-25-113\"></a>\n</span><span id=\"__span-25-114\"><a id=\"__codelineno-25-114\" name=\"__codelineno-25-114\" href=\"#__codelineno-25-114\"></a><span class=\"w\">  </span><span class=\"c1\">// free the 10th one</span>\n</span><span id=\"__span-25-115\"><a id=\"__codelineno-25-115\" name=\"__codelineno-25-115\" href=\"#__codelineno-25-115\"></a><span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">ptrs</span><span class=\"p\">[</span><span class=\"mi\">9</span><span class=\"p\">]);</span>\n</span><span id=\"__span-25-116\"><a id=\"__codelineno-25-116\" name=\"__codelineno-25-116\" href=\"#__codelineno-25-116\"></a>\n</span><span id=\"__span-25-117\"><a id=\"__codelineno-25-117\" name=\"__codelineno-25-117\" href=\"#__codelineno-25-117\"></a><span class=\"w\">  </span><span class=\"c1\">// three pointers in the fastbin</span>\n</span><span id=\"__span-25-118\"><a id=\"__codelineno-25-118\" name=\"__codelineno-25-118\" href=\"#__codelineno-25-118\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;fastbins after 10 pointers freed:</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-25-119\"><a id=\"__codelineno-25-119\" name=\"__codelineno-25-119\" href=\"#__codelineno-25-119\"></a><span class=\"w\">  </span><span class=\"n\">dump_fastbin</span><span class=\"p\">();</span>\n</span><span id=\"__span-25-120\"><a id=\"__codelineno-25-120\" name=\"__codelineno-25-120\" href=\"#__codelineno-25-120\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-25-121\"><a id=\"__codelineno-25-121\" name=\"__codelineno-25-121\" href=\"#__codelineno-25-121\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8f93\u51fa\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-26-1\"><a id=\"__codelineno-26-1\" name=\"__codelineno-26-1\" href=\"#__codelineno-26-1\"></a><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d6b0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d6e0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d710</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d740</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d770</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7a0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7d0</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d800</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d830</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d860</span>\n</span><span id=\"__span-26-2\"><a id=\"__codelineno-26-2\" name=\"__codelineno-26-2\" href=\"#__codelineno-26-2\"></a><span class=\"n\">fastbins</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"w\"> </span><span class=\"n\">freed</span><span class=\"o\">:</span>\n</span><span id=\"__span-26-3\"><a id=\"__codelineno-26-3\" name=\"__codelineno-26-3\" href=\"#__codelineno-26-3\"></a><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7f0</span>\n</span><span id=\"__span-26-4\"><a id=\"__codelineno-26-4\" name=\"__codelineno-26-4\" href=\"#__codelineno-26-4\"></a><span class=\"n\">fastbins</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"w\"> </span><span class=\"n\">freed</span><span class=\"o\">:</span>\n</span><span id=\"__span-26-5\"><a id=\"__codelineno-26-5\" name=\"__codelineno-26-5\" href=\"#__codelineno-26-5\"></a><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d820</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7f0</span>\n</span><span id=\"__span-26-6\"><a id=\"__codelineno-26-6\" name=\"__codelineno-26-6\" href=\"#__codelineno-26-6\"></a><span class=\"n\">fastbins</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">pointers</span><span class=\"w\"> </span><span class=\"n\">freed</span><span class=\"o\">:</span>\n</span><span id=\"__span-26-7\"><a id=\"__codelineno-26-7\" name=\"__codelineno-26-7\" href=\"#__codelineno-26-7\"></a><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d850</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d820</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x563bd918d7f0</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u4ee3\u7801\u5148\u5206\u914d\u4e86\u5341\u4e2a\u5757\uff0c\u518d\u6309\u987a\u5e8f\u91ca\u653e\uff0c\u90a3\u4e48\u524d\u4e03\u4e2a\u5757\u4f1a\u8fdb\u5165 tcache\uff0c\u5269\u4e0b\u7684\u4e09\u4e2a\u5757\u5219\u8fdb\u5165\u4e86\u540c\u4e00\u4e2a fast bin\uff0c\u5e76\u4e14\u540e\u91ca\u653e\u7684\u4f1a\u5728\u94fe\u8868\u7684\u5f00\u5934\u3002\u6ce8\u610f fast bin \u94fe\u8868\u91cc\u7684\u5730\u5740\u6253\u5370\u7684\u662f chunk \u5730\u5740\uff0c\u800c\u7528 <code>malloc</code> \u5206\u914d\u7684\u5730\u5740\u6307\u5411\u7684\u662f payload \u90e8\u5206\uff0c\u4e8c\u8005\u5dee\u4e86 16 \u5b57\u8282\uff0c\u6700\u7ec8 fast bin \u5c31\u662f\u628a\u5341\u4e2a\u5757\u91cc\u6700\u540e\u4e09\u4e2a\u5757\u7528\u94fe\u8868\u4e32\u8d77\u6765\u3002\u7531\u4e8e\u603b\u662f\u5f80\u94fe\u8868\u7684\u5934\u90e8\u63d2\u5165\u7a7a\u95f2\u5757\uff0c\u6240\u4ee5\u540e\u91ca\u653e\u7684\u5757\u51fa\u73b0\u5728\u9760\u524d\u7684\u4f4d\u7f6e\u3002</p>\n<h2 id=\"small-bin\">small bin<a class=\"headerlink\" href=\"#small-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5206\u6790\u5b8c fast bin\uff0c\u63a5\u4e0b\u6765\u6765\u770b small bin\u3002small bin \u6bcf\u4e2a bin \u5185\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u662f\u76f8\u540c\u7684\uff0c\u5e76\u4e14\u4e5f\u662f\u4ee5\u94fe\u8868\u7684\u65b9\u5f0f\u7ec4\u7ec7\uff0c\u53ea\u4e0d\u8fc7\u7528\u7684\u662f\u53cc\u5411\u94fe\u8868\u3002</p>\n<h3 id=\"malloc_3\">malloc<a class=\"headerlink\" href=\"#malloc_3\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf <code>_int_malloc</code> \u662f\u600e\u4e48\u4f7f\u7528 small bin \u7684\u3002\u524d\u9762\u63d0\u5230\uff0c<code>_int_malloc</code> \u9996\u5148\u4f1a\u5c1d\u8bd5\u5728 fast bin \u4e2d\u5206\u914d\uff0c\u5982\u679c\u5206\u914d\u5931\u8d25\uff0c\u6216\u8005\u5927\u5c0f\u8d85\u51fa\u4e86 fast bin \u7684\u8303\u56f4\uff0c\u63a5\u4e0b\u6765\u4f1a\u5c1d\u8bd5\u5728 small bin \u4e2d\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-27-1\"><a id=\"__codelineno-27-1\" name=\"__codelineno-27-1\" href=\"#__codelineno-27-1\"></a><span class=\"c1\">// in _int_malloc</span>\n</span><span id=\"__span-27-2\"><a id=\"__codelineno-27-2\" name=\"__codelineno-27-2\" href=\"#__codelineno-27-2\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-27-3\"><a id=\"__codelineno-27-3\" name=\"__codelineno-27-3\" href=\"#__codelineno-27-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-4\"><a id=\"__codelineno-27-4\" name=\"__codelineno-27-4\" href=\"#__codelineno-27-4\"></a><span class=\"w\">    </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">smallbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-5\"><a id=\"__codelineno-27-5\" name=\"__codelineno-27-5\" href=\"#__codelineno-27-5\"></a><span class=\"w\">    </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-6\"><a id=\"__codelineno-27-6\" name=\"__codelineno-27-6\" href=\"#__codelineno-27-6\"></a>\n</span><span id=\"__span-27-7\"><a id=\"__codelineno-27-7\" name=\"__codelineno-27-7\" href=\"#__codelineno-27-7\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-8\"><a id=\"__codelineno-27-8\" name=\"__codelineno-27-8\" href=\"#__codelineno-27-8\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-9\"><a id=\"__codelineno-27-9\" name=\"__codelineno-27-9\" href=\"#__codelineno-27-9\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-10\"><a id=\"__codelineno-27-10\" name=\"__codelineno-27-10\" href=\"#__codelineno-27-10\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">))</span>\n</span><span id=\"__span-27-11\"><a id=\"__codelineno-27-11\" name=\"__codelineno-27-11\" href=\"#__codelineno-27-11\"></a><span class=\"w\">          </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): smallbin double linked list corrupted&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-12\"><a id=\"__codelineno-27-12\" name=\"__codelineno-27-12\" href=\"#__codelineno-27-12\"></a><span class=\"w\">        </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-13\"><a id=\"__codelineno-27-13\" name=\"__codelineno-27-13\" href=\"#__codelineno-27-13\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-14\"><a id=\"__codelineno-27-14\" name=\"__codelineno-27-14\" href=\"#__codelineno-27-14\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-15\"><a id=\"__codelineno-27-15\" name=\"__codelineno-27-15\" href=\"#__codelineno-27-15\"></a>\n</span><span id=\"__span-27-16\"><a id=\"__codelineno-27-16\" name=\"__codelineno-27-16\" href=\"#__codelineno-27-16\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-17\"><a id=\"__codelineno-27-17\" name=\"__codelineno-27-17\" href=\"#__codelineno-27-17\"></a><span class=\"w\">          </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-18\"><a id=\"__codelineno-27-18\" name=\"__codelineno-27-18\" href=\"#__codelineno-27-18\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-19\"><a id=\"__codelineno-27-19\" name=\"__codelineno-27-19\" href=\"#__codelineno-27-19\"></a><span class=\"w\">        </span><span class=\"cm\">/* While we&#39;re here, if we see other chunks of the same size,</span>\n</span><span id=\"__span-27-20\"><a id=\"__codelineno-27-20\" name=\"__codelineno-27-20\" href=\"#__codelineno-27-20\"></a><span class=\"cm\">           stash them in the tcache.  */</span>\n</span><span id=\"__span-27-21\"><a id=\"__codelineno-27-21\" name=\"__codelineno-27-21\" href=\"#__codelineno-27-21\"></a><span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">csize2tidx</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-22\"><a id=\"__codelineno-27-22\" name=\"__codelineno-27-22\" href=\"#__codelineno-27-22\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_bins</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-23\"><a id=\"__codelineno-27-23\" name=\"__codelineno-27-23\" href=\"#__codelineno-27-23\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-24\"><a id=\"__codelineno-27-24\" name=\"__codelineno-27-24\" href=\"#__codelineno-27-24\"></a><span class=\"w\">            </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-25\"><a id=\"__codelineno-27-25\" name=\"__codelineno-27-25\" href=\"#__codelineno-27-25\"></a>\n</span><span id=\"__span-27-26\"><a id=\"__codelineno-27-26\" name=\"__codelineno-27-26\" href=\"#__codelineno-27-26\"></a><span class=\"w\">            </span><span class=\"cm\">/* While bin not empty and tcache not full, copy chunks over.  */</span>\n</span><span id=\"__span-27-27\"><a id=\"__codelineno-27-27\" name=\"__codelineno-27-27\" href=\"#__codelineno-27-27\"></a><span class=\"w\">            </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span>\n</span><span id=\"__span-27-28\"><a id=\"__codelineno-27-28\" name=\"__codelineno-27-28\" href=\"#__codelineno-27-28\"></a><span class=\"w\">                   </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-29\"><a id=\"__codelineno-27-29\" name=\"__codelineno-27-29\" href=\"#__codelineno-27-29\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-30\"><a id=\"__codelineno-27-30\" name=\"__codelineno-27-30\" href=\"#__codelineno-27-30\"></a><span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-31\"><a id=\"__codelineno-27-31\" name=\"__codelineno-27-31\" href=\"#__codelineno-27-31\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-27-32\"><a id=\"__codelineno-27-32\" name=\"__codelineno-27-32\" href=\"#__codelineno-27-32\"></a><span class=\"w\">                    </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tc_victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-33\"><a id=\"__codelineno-27-33\" name=\"__codelineno-27-33\" href=\"#__codelineno-27-33\"></a><span class=\"w\">                    </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-34\"><a id=\"__codelineno-27-34\" name=\"__codelineno-27-34\" href=\"#__codelineno-27-34\"></a><span class=\"w\">                    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-27-35\"><a id=\"__codelineno-27-35\" name=\"__codelineno-27-35\" href=\"#__codelineno-27-35\"></a><span class=\"w\">                      </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-36\"><a id=\"__codelineno-27-36\" name=\"__codelineno-27-36\" href=\"#__codelineno-27-36\"></a><span class=\"w\">                    </span><span class=\"n\">bin</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-37\"><a id=\"__codelineno-27-37\" name=\"__codelineno-27-37\" href=\"#__codelineno-27-37\"></a><span class=\"w\">                    </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-38\"><a id=\"__codelineno-27-38\" name=\"__codelineno-27-38\" href=\"#__codelineno-27-38\"></a>\n</span><span id=\"__span-27-39\"><a id=\"__codelineno-27-39\" name=\"__codelineno-27-39\" href=\"#__codelineno-27-39\"></a><span class=\"w\">                    </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-40\"><a id=\"__codelineno-27-40\" name=\"__codelineno-27-40\" href=\"#__codelineno-27-40\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-41\"><a id=\"__codelineno-27-41\" name=\"__codelineno-27-41\" href=\"#__codelineno-27-41\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-42\"><a id=\"__codelineno-27-42\" name=\"__codelineno-27-42\" href=\"#__codelineno-27-42\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-43\"><a id=\"__codelineno-27-43\" name=\"__codelineno-27-43\" href=\"#__codelineno-27-43\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-44\"><a id=\"__codelineno-27-44\" name=\"__codelineno-27-44\" href=\"#__codelineno-27-44\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-27-45\"><a id=\"__codelineno-27-45\" name=\"__codelineno-27-45\" href=\"#__codelineno-27-45\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-27-46\"><a id=\"__codelineno-27-46\" name=\"__codelineno-27-46\" href=\"#__codelineno-27-46\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-27-47\"><a id=\"__codelineno-27-47\" name=\"__codelineno-27-47\" href=\"#__codelineno-27-47\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 <code>in_smallbin_range (nb)</code> \u68c0\u67e5\u5757\u7684\u5927\u5c0f\u662f\u5426\u5e94\u8be5\u653e\u5230 small bin \u5f53\u4e2d</li>\n<li>\u4f7f\u7528 <code>smallbin_index (nb)</code> \u6839\u636e\u5757\u7684\u5927\u5c0f\u8ba1\u7b97\u51fa small bin \u7684 index\uff0c\u7136\u540e <code>bin_at (av, idx)</code> \u5bf9\u5e94 small bin \u7684\u94fe\u8868\u5c3e\u90e8\u7684\u54e8\u5175\uff0c\u8fd9\u4e2a\u53cc\u5411\u94fe\u8868\u6709\u4e14\u53ea\u6709\u4e00\u4e2a\u54e8\u5175\uff0c\u8fd9\u4e2a\u54e8\u5175\u5c31\u653e\u5728 small bin \u6570\u7ec4\u5f53\u4e2d</li>\n<li>\u627e\u5230\u54e8\u5175\u7ed3\u70b9\u7684\u524d\u9a71\u7ed3\u70b9 <code>last (bin)</code>\uff0c\u5982\u679c\u94fe\u8868\u4e3a\u7a7a\uff0c\u90a3\u4e48\u54e8\u5175\u7684\u524d\u9a71\u7ed3\u70b9\u5c31\u662f\u5b83\u81ea\u5df1\uff1b\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u90a3\u4e48\u54e8\u5175\u7684\u524d\u9a71\u7ed3\u70b9\u5c31\u662f\u94fe\u8868\u91cc\u7684\u6700\u540e\u4e00\u4e2a\u7ed3\u70b9\uff0c\u628a\u5b83\u8d4b\u503c\u7ed9 <code>victim</code></li>\n<li>\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u6807\u8bb0\u4e3a\u6b63\u5728\u4f7f\u7528\uff1a<code>set_inuse_bit_at_offset (victim, nb)</code></li>\n<li>\u628a <code>victim</code> \u4ece\u94fe\u8868\u91cc\u5220\u9664\uff1a<code>bck = victim-&gt;bk; bin-&gt;bk = bck; bck-&gt;fd = bin;</code>\uff0c\u5178\u578b\u7684\u53cc\u5411\u94fe\u8868\u7684\u7ed3\u70b9\u5220\u9664\u8fc7\u7a0b\uff0c\u7ef4\u62a4 <code>victim</code> \u524d\u9a71\u7ed3\u70b9\u7684\u540e\u7ee7\u6307\u9488\uff0c\u7ef4\u62a4\u54e8\u5175 <code>bin</code> \u7684\u524d\u9a71\u6307\u9488</li>\n<li>\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u5b89\u5168\u68c0\u67e5\uff1a<code>check_malloced_chunk</code></li>\n<li>\u68c0\u67e5 tcache \u5bf9\u5e94\u7684 bin\uff0c\u5982\u679c\u5b83\u8fd8\u6ca1\u6709\u6ee1\uff0c\u5c31\u628a small bin \u94fe\u8868\u4e2d\u7684\u5143\u7d20\u632a\u5230 tcache \u5f53\u4e2d</li>\n<li>\u628a payload \u5730\u5740\u901a\u8fc7 <code>chunk2mem</code> \u8ba1\u7b97\u51fa\u6765\uff0c\u8fd4\u56de\u7ed9 malloc \u8c03\u7528\u8005</li>\n<li>\u8c03\u7528 <code>alloc_perturb</code> \u5f80\u65b0\u5206\u914d\u7684\u7a7a\u95f4\u5185\u5199\u5165\u5783\u573e\u6570\u636e\uff08\u53ef\u9009\uff09\uff0c\u907f\u514d\u6cc4\u9732\u4e4b\u524d\u7684\u6570\u636e</li>\n</ol>\n<p>\u5176\u5b9e\u73b0\u8fc7\u7a0b\u548c fast bin \u5f88\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u628a\u5355\u5411\u94fe\u8868\u6539\u6210\u4e86\u53cc\u5411\uff0c\u5e76\u4e14\u5f15\u5165\u4e86\u54e8\u5175\u7ed3\u70b9\uff0c\u8fd9\u4e2a\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7ed3\u6784\u7684 bins \u6570\u7ec4\u5f53\u4e2d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-28-1\"><a id=\"__codelineno-28-1\" name=\"__codelineno-28-1\" href=\"#__codelineno-28-1\"></a><span class=\"cp\">#define NSMALLBINS         64</span>\n</span><span id=\"__span-28-2\"><a id=\"__codelineno-28-2\" name=\"__codelineno-28-2\" href=\"#__codelineno-28-2\"></a><span class=\"cm\">/* SMALLBIN_WIDTH equals to 16 on 64-bit */</span>\n</span><span id=\"__span-28-3\"><a id=\"__codelineno-28-3\" name=\"__codelineno-28-3\" href=\"#__codelineno-28-3\"></a><span class=\"cp\">#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span>\n</span><span id=\"__span-28-4\"><a id=\"__codelineno-28-4\" name=\"__codelineno-28-4\" href=\"#__codelineno-28-4\"></a><span class=\"cm\">/* SMALLBIN_CORRECTION equals to 0 on 64-bit */</span>\n</span><span id=\"__span-28-5\"><a id=\"__codelineno-28-5\" name=\"__codelineno-28-5\" href=\"#__codelineno-28-5\"></a><span class=\"cp\">#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span>\n</span><span id=\"__span-28-6\"><a id=\"__codelineno-28-6\" name=\"__codelineno-28-6\" href=\"#__codelineno-28-6\"></a>\n</span><span id=\"__span-28-7\"><a id=\"__codelineno-28-7\" name=\"__codelineno-28-7\" href=\"#__codelineno-28-7\"></a><span class=\"cm\">/* MIN_LARGE_SIZE equals to 1024 on 64-bit */</span>\n</span><span id=\"__span-28-8\"><a id=\"__codelineno-28-8\" name=\"__codelineno-28-8\" href=\"#__codelineno-28-8\"></a><span class=\"cp\">#define MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span>\n</span><span id=\"__span-28-9\"><a id=\"__codelineno-28-9\" name=\"__codelineno-28-9\" href=\"#__codelineno-28-9\"></a>\n</span><span id=\"__span-28-10\"><a id=\"__codelineno-28-10\" name=\"__codelineno-28-10\" href=\"#__codelineno-28-10\"></a><span class=\"cm\">/* equivalent to (sz &lt; 1024) on 64-bit */</span>\n</span><span id=\"__span-28-11\"><a id=\"__codelineno-28-11\" name=\"__codelineno-28-11\" href=\"#__codelineno-28-11\"></a><span class=\"cp\">#define in_smallbin_range(sz)  \\</span>\n</span><span id=\"__span-28-12\"><a id=\"__codelineno-28-12\" name=\"__codelineno-28-12\" href=\"#__codelineno-28-12\"></a><span class=\"cp\">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span>\n</span><span id=\"__span-28-13\"><a id=\"__codelineno-28-13\" name=\"__codelineno-28-13\" href=\"#__codelineno-28-13\"></a>\n</span><span id=\"__span-28-14\"><a id=\"__codelineno-28-14\" name=\"__codelineno-28-14\" href=\"#__codelineno-28-14\"></a><span class=\"cm\">/* equivalent to (sz &gt;&gt; 4) on 64-bit */</span>\n</span><span id=\"__span-28-15\"><a id=\"__codelineno-28-15\" name=\"__codelineno-28-15\" href=\"#__codelineno-28-15\"></a><span class=\"cp\">#define smallbin_index(sz) \\</span>\n</span><span id=\"__span-28-16\"><a id=\"__codelineno-28-16\" name=\"__codelineno-28-16\" href=\"#__codelineno-28-16\"></a><span class=\"cp\">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\\</span>\n</span><span id=\"__span-28-17\"><a id=\"__codelineno-28-17\" name=\"__codelineno-28-17\" href=\"#__codelineno-28-17\"></a><span class=\"cp\">   + SMALLBIN_CORRECTION)</span>\n</span><span id=\"__span-28-18\"><a id=\"__codelineno-28-18\" name=\"__codelineno-28-18\" href=\"#__codelineno-28-18\"></a>\n</span><span id=\"__span-28-19\"><a id=\"__codelineno-28-19\" name=\"__codelineno-28-19\" href=\"#__codelineno-28-19\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_chunk</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mchunkptr</span><span class=\"p\">;</span>\n</span><span id=\"__span-28-20\"><a id=\"__codelineno-28-20\" name=\"__codelineno-28-20\" href=\"#__codelineno-28-20\"></a>\n</span><span id=\"__span-28-21\"><a id=\"__codelineno-28-21\" name=\"__codelineno-28-21\" href=\"#__codelineno-28-21\"></a><span class=\"cm\">/* addressing -- note that bin_at(0) does not exist */</span>\n</span><span id=\"__span-28-22\"><a id=\"__codelineno-28-22\" name=\"__codelineno-28-22\" href=\"#__codelineno-28-22\"></a><span class=\"cp\">#define bin_at(m, i) \\</span>\n</span><span id=\"__span-28-23\"><a id=\"__codelineno-28-23\" name=\"__codelineno-28-23\" href=\"#__codelineno-28-23\"></a><span class=\"cp\">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))                              \\</span>\n</span><span id=\"__span-28-24\"><a id=\"__codelineno-28-24\" name=\"__codelineno-28-24\" href=\"#__codelineno-28-24\"></a><span class=\"cp\">             - offsetof (struct malloc_chunk, fd))</span>\n</span><span id=\"__span-28-25\"><a id=\"__codelineno-28-25\" name=\"__codelineno-28-25\" href=\"#__codelineno-28-25\"></a>\n</span><span id=\"__span-28-26\"><a id=\"__codelineno-28-26\" name=\"__codelineno-28-26\" href=\"#__codelineno-28-26\"></a><span class=\"cp\">#define NBINS             128</span>\n</span><span id=\"__span-28-27\"><a id=\"__codelineno-28-27\" name=\"__codelineno-28-27\" href=\"#__codelineno-28-27\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span>\n</span><span id=\"__span-28-28\"><a id=\"__codelineno-28-28\" name=\"__codelineno-28-28\" href=\"#__codelineno-28-28\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-28-29\"><a id=\"__codelineno-28-29\" name=\"__codelineno-28-29\" href=\"#__codelineno-28-29\"></a><span class=\"w\">  </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-28-30\"><a id=\"__codelineno-28-30\" name=\"__codelineno-28-30\" href=\"#__codelineno-28-30\"></a><span class=\"w\">  </span><span class=\"cm\">/* Normal bins packed as described above */</span>\n</span><span id=\"__span-28-31\"><a id=\"__codelineno-28-31\" name=\"__codelineno-28-31\" href=\"#__codelineno-28-31\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">bins</span><span class=\"p\">[</span><span class=\"n\">NBINS</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-28-32\"><a id=\"__codelineno-28-32\" name=\"__codelineno-28-32\" href=\"#__codelineno-28-32\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4e4d\u4e00\u770b\u4f1a\u89c9\u5f97\u5f88\u5947\u602a\uff0c\u8fd9\u91cc <code>NBINS * 2 - 2</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f<code>mchunkptr</code> \u662f\u4e2a\u6307\u9488\u7c7b\u578b\uff0c\u90a3\u5b83\u6307\u5411\u7684\u6570\u636e\u5b58\u5728\u54ea\uff1f\u5176\u5b9e\u8fd9\u91cc\u7528\u4e86\u4e00\u4e2a\u5c0f\u7684 trick\uff1a</p>\n<ol>\n<li>\u4e0d\u53bb\u770b bins \u5143\u7d20\u7684\u7c7b\u578b\uff0c\u53ea\u8003\u8651\u5b83\u7684\u5143\u7d20\u7684\u5927\u5c0f\uff0c\u6bcf\u4e2a\u5143\u7d20\u5927\u5c0f\u662f <code>sizeof(size_t)</code>\uff0c\u4e00\u5171\u6709 <code>NBINS * 2 - 2</code> \u4e2a\u5143\u7d20</li>\n<li>\u800c\u6bcf\u4e2a bin \u5bf9\u5e94\u4e00\u4e2a\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\uff0c\u7531\u4e8e\u662f\u53cc\u5411\u94fe\u8868\uff0c\u54e8\u5175\u7ed3\u70b9\u4e5f\u6ca1\u6709\u6570\u636e\uff0c\u53ea\u9700\u8981\u4fdd\u5b58\u524d\u9a71\u548c\u540e\u7ee7\u4e24\u4e2a\u6307\u9488\uff0c\u5373\u6bcf\u4e2a bin \u53ea\u9700\u8981\u5b58\u4e24\u4e2a\u6307\u9488\u7684\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f <code>2 * sizeof(size_t)</code></li>\n<li>\u6b63\u597d <code>bins</code> \u6570\u7ec4\u7ed9\u6bcf\u4e2a bin \u7559\u51fa\u4e86 <code>2 * sizeof(size_t)</code> \u7684\u7a7a\u95f4\uff08bin 0 \u9664\u5916\uff0c\u8fd9\u4e2a bin \u4e0d\u5b58\u5728\uff09\uff0c\u6240\u4ee5\u5b9e\u9645\u4e0a\u8fd9\u4e9b\u54e8\u5175\u7ed3\u70b9\u7684\u524d\u9a71\u548c\u540e\u7ee7\u6307\u9488\u5c31\u4fdd\u5b58\u5728 <code>bins</code> \u6570\u7ec4\u91cc\uff0c\u6309\u987a\u5e8f\u4fdd\u5b58\uff0c\u9996\u5148\u662f bin 1 \u7684\u524d\u9a71\uff0c\u7136\u540e\u662f bin 1 \u7684\u540e\u7ee7\uff0c\u63a5\u7740\u662f bin 2 \u7684\u524d\u9a71\uff0c\u4f9d\u6b64\u7c7b\u63a8</li>\n<li>\u867d\u7136\u7a7a\u95f4\u5bf9\u4e0a\u4e86\uff0c\u4f46\u662f\u4e3a\u4e86\u65b9\u4fbf\u4f7f\u7528\uff0c\u4ee3\u7801\u91cc\u7528 <code>bin_at</code> \u5b8f\u6765\u8ba1\u7b97\u51fa\u4e00\u4e2a <code>malloc_chunk</code> \u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c\u800c\u5df2\u77e5 bins \u6570\u7ec4\u53ea\u4fdd\u5b58\u4e86 <code>fd</code> \u548c <code>bk</code> \u4e24\u4e2a\u6307\u9488\uff0c\u5e76\u4e14 bin \u7684\u4e0b\u6807\u4ece 1 \u5f00\u59cb\uff0c\u6240\u4ee5 bin i \u7684 <code>fd</code> \u6307\u9488\u5730\u5740\u5c31\u662f <code>(char *) &amp;((m)-&gt;bins[((i) - 1) * 2])</code>\uff0c\u518d\u51cf\u53bb <code>malloc_chunk</code> \u7ed3\u6784\u4f53\u4e2d <code>fd</code> \u6210\u5458\u7684\u504f\u79fb\uff0c\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a <code>malloc_chunk</code> \u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c\u5f53\u7136\u4e86\uff0c\u8fd9\u4e2a\u7ed3\u6784\u4f53\u53ea\u6709 <code>fd</code> \u548c <code>bk</code> \u4e24\u4e2a\u5b57\u6bb5\u662f\u5408\u6cd5\u7684\uff0c\u5176\u4ed6\u5b57\u6bb5\u5982\u679c\u8bbf\u95ee\u4e86\uff0c\u5c31\u4f1a\u8bbf\u95ee\u5230\u5176\u4ed6 bin \u90a3\u91cc\u53bb</li>\n</ol>\n<p>\u629b\u5f00\u8fd9\u4e9b trick\uff0c\u5176\u5b9e\u5c31\u7b49\u4ef7\u4e8e\u7528\u4e00\u4e2a\u6570\u7ec4\u4fdd\u5b58\u4e86\u6bcf\u4e2a bin \u7684 <code>fd</code> \u548c <code>bk</code> \u6307\u9488\uff0c\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u8981\u5f3a\u884c\u8f6c\u6362\u6210 <code>malloc_chunk</code> \u7c7b\u578b\u7684\u6307\u9488\uff0c\u53ef\u80fd\u662f\u4e3a\u4e86\u65b9\u4fbf\u4ee3\u7801\u7684\u7f16\u5199\uff0c\u4e0d\u9700\u8981\u533a\u5206\u7a7a\u95f2\u5757\u7684\u7ed3\u70b9\u548c\u54e8\u5175\u7ed3\u70b9\u3002</p>\n<p>\u6b64\u5916\uff0csmall bin \u7684\u5904\u7406\u91cc\u8fd8\u591a\u4e86\u4e00\u6b21 <code>set_inuse_bit_at_offset (victim, nb)</code>\uff0c\u5b83\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-29-1\"><a id=\"__codelineno-29-1\" name=\"__codelineno-29-1\" href=\"#__codelineno-29-1\"></a><span class=\"cp\">#define set_inuse_bit_at_offset(p, s)                                              \\</span>\n</span><span id=\"__span-29-2\"><a id=\"__codelineno-29-2\" name=\"__codelineno-29-2\" href=\"#__codelineno-29-2\"></a><span class=\"cp\">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size |= PREV_INUSE)</span>\n</span></code></pre></div>\n<p>\u4e4d\u4e00\u770b\u4f1a\u89c9\u5f97\u5f88\u5947\u602a\uff0c\u8fd9\u4e2a\u8bbf\u95ee\u4e0d\u662f\u8d8a\u754c\u4e86\u5417\uff1f\u5176\u5b9e\u8fd9\u4e2a\u5c31\u662f\u8de8\u8fc7\u5f53\u524d\u7684 chunk\uff0c\u8bbf\u95ee\u76f8\u90bb\u7684\u4e0b\u4e00\u4e2a chunk\uff0c\u5728\u5b83\u7684 <code>mchunk_size</code> \u5b57\u6bb5\u4e0a\u6253\u6807\u8bb0\uff0c\u8868\u793a\u5b83\u7684\u524d\u4e00\u4e2a chunk \u5df2\u7ecf\u88ab\u5360\u7528\u3002\u524d\u9762\u63d0\u5230\u8fc7\uff0c<code>mchunk_size</code> \u540c\u65f6\u4fdd\u5b58\u4e86 chunk \u7684\u5927\u5c0f\u548c\u4e00\u4e9b flag\uff0c\u7531\u4e8e chunk \u7684\u5927\u5c0f\u81f3\u5c11\u662f 8 \u5b57\u8282\u5bf9\u9f50\u7684\uff0832 \u4f4d\u7cfb\u7edf\u4e0a\uff09\uff0c\u6240\u4ee5\u6700\u4f4e\u7684 3 \u4f4d\u5c31\u88ab\u62ff\u6765\u4fdd\u5b58\u5982\u4e0b\u7684 flag\uff1a</p>\n<ol>\n<li><code>PREV_INUSE(0x1)</code>: \u524d\u4e00\u4e2a chunk \u5df2\u7ecf\u88ab\u5206\u914d</li>\n<li><code>IS_MAPPED(0x2)</code>\uff1a\u5f53\u524d chunk \u7684\u5185\u5b58\u6765\u81ea\u4e8e mmap</li>\n<li><code>NON_MAIN_ARENA(0x4)</code>\uff1a\u5f53\u524d chunk \u6765\u81ea\u4e8e main arena \u4ee5\u5916\u7684\u5176\u4ed6 arena</li>\n</ol>\n<p>\u5728\u8fd9\u91cc\uff0c\u5c31\u662f\u8bbe\u7f6e\u4e86 <code>PREV_INUSE</code> flag\uff0c\u65b9\u4fbf\u540e\u7eed\u7684\u76f8\u90bb\u5757\u7684\u5408\u5e76\u3002</p>\n<p>\u53ef\u4ee5\u6ce8\u610f\u5230\uff0csmall bin \u7684\u5206\u914d\u8303\u56f4\u662f <code>nb &lt; MIN_LARGE_SIZE</code>\uff0c\u56e0\u6b64\u5728 64 \u4f4d\u4e0a\uff0c<code>malloc(1000)</code> \u6216\u66f4\u5c0f\u7684\u5206\u914d\u4f1a\u88ab small bin \u5206\u914d\uff0c\u800c <code>malloc(1001)</code> \u6216\u66f4\u5927\u7684\u5206\u914d\u5219\u4e0d\u53ef\u4ee5\u3002</p>\n<h3 id=\"free_2\">free<a class=\"headerlink\" href=\"#free_2\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u8bb2\u8ff0 small bin \u5728 free \u4e2d\u7684\u5b9e\u73b0\u4e4b\u524d\uff0c\u5148\u8ba8\u8bba <code>_int_malloc</code> \u7684\u540e\u7eed\u903b\u8f91\uff0c\u6700\u540e\u518d\u56de\u8fc7\u5934\u6765\u770b free \u7684\u90e8\u5206\u3002</p>\n<h2 id=\"consolidate\">consolidate<a class=\"headerlink\" href=\"#consolidate\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5f53\u8981\u5206\u914d\u7684\u5757\u7ecf\u8fc7 fast bin \u548c small bin \u4e24\u6bb5\u903b\u8f91\u90fd\u6ca1\u80fd\u5206\u914d\u6210\u529f\uff0c\u5e76\u4e14\u8981\u5206\u914d\u7684\u5757\u6bd4\u8f83\u5927\u7684\u65f6\u5019\uff08<code>!in_small_range (nb)</code>\uff09\uff0c\u4f1a\u8fdb\u884c\u4e00\u6b21 <code>malloc_consolidate</code> \u8c03\u7528\uff0c\u8fd9\u4e2a\u51fd\u6570\u4f1a\u5c1d\u8bd5\u5bf9 fast bin \u4e2d\u7684\u7a7a\u95f2\u5757\u8fdb\u884c\u5408\u5e76\uff0c\u7136\u540e\u628a\u65b0\u7684\u5757\u63d2\u5165\u5230 unsorted bin \u5f53\u4e2d\u3002\u5b83\u7684\u5b9e\u73b0\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-30-1\"><a id=\"__codelineno-30-1\" name=\"__codelineno-30-1\" href=\"#__codelineno-30-1\"></a><span class=\"n\">unsorted_bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-2\"><a id=\"__codelineno-30-2\" name=\"__codelineno-30-2\" href=\"#__codelineno-30-2\"></a><span class=\"n\">maxfb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NFASTBINS</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-3\"><a id=\"__codelineno-30-3\" name=\"__codelineno-30-3\" href=\"#__codelineno-30-3\"></a><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">fastbin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-4\"><a id=\"__codelineno-30-4\" name=\"__codelineno-30-4\" href=\"#__codelineno-30-4\"></a><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-5\"><a id=\"__codelineno-30-5\" name=\"__codelineno-30-5\" href=\"#__codelineno-30-5\"></a><span class=\"w\">  </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">atomic_exchange_acq</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-6\"><a id=\"__codelineno-30-6\" name=\"__codelineno-30-6\" href=\"#__codelineno-30-6\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-7\"><a id=\"__codelineno-30-7\" name=\"__codelineno-30-7\" href=\"#__codelineno-30-7\"></a><span class=\"w\">    </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-8\"><a id=\"__codelineno-30-8\" name=\"__codelineno-30-8\" href=\"#__codelineno-30-8\"></a><span class=\"w\">      </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-30-9\"><a id=\"__codelineno-30-9\" name=\"__codelineno-30-9\" href=\"#__codelineno-30-9\"></a>\n</span><span id=\"__span-30-10\"><a id=\"__codelineno-30-10\" name=\"__codelineno-30-10\" href=\"#__codelineno-30-10\"></a><span class=\"w\">      </span><span class=\"n\">check_inuse_chunk</span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-11\"><a id=\"__codelineno-30-11\" name=\"__codelineno-30-11\" href=\"#__codelineno-30-11\"></a><span class=\"w\">      </span><span class=\"n\">nextp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-12\"><a id=\"__codelineno-30-12\" name=\"__codelineno-30-12\" href=\"#__codelineno-30-12\"></a>\n</span><span id=\"__span-30-13\"><a id=\"__codelineno-30-13\" name=\"__codelineno-30-13\" href=\"#__codelineno-30-13\"></a><span class=\"w\">      </span><span class=\"cm\">/* Slightly streamlined version of consolidation code in free() */</span>\n</span><span id=\"__span-30-14\"><a id=\"__codelineno-30-14\" name=\"__codelineno-30-14\" href=\"#__codelineno-30-14\"></a><span class=\"w\">      </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-15\"><a id=\"__codelineno-30-15\" name=\"__codelineno-30-15\" href=\"#__codelineno-30-15\"></a><span class=\"w\">      </span><span class=\"n\">nextchunk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-16\"><a id=\"__codelineno-30-16\" name=\"__codelineno-30-16\" href=\"#__codelineno-30-16\"></a><span class=\"w\">      </span><span class=\"n\">nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-17\"><a id=\"__codelineno-30-17\" name=\"__codelineno-30-17\" href=\"#__codelineno-30-17\"></a>\n</span><span id=\"__span-30-18\"><a id=\"__codelineno-30-18\" name=\"__codelineno-30-18\" href=\"#__codelineno-30-18\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">prev_inuse</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-19\"><a id=\"__codelineno-30-19\" name=\"__codelineno-30-19\" href=\"#__codelineno-30-19\"></a><span class=\"w\">        </span><span class=\"n\">prevsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">prev_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-20\"><a id=\"__codelineno-30-20\" name=\"__codelineno-30-20\" href=\"#__codelineno-30-20\"></a><span class=\"w\">        </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">prevsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-21\"><a id=\"__codelineno-30-21\" name=\"__codelineno-30-21\" href=\"#__codelineno-30-21\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"p\">((</span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">prevsize</span><span class=\"p\">));</span>\n</span><span id=\"__span-30-22\"><a id=\"__codelineno-30-22\" name=\"__codelineno-30-22\" href=\"#__codelineno-30-22\"></a><span class=\"w\">        </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-30-23\"><a id=\"__codelineno-30-23\" name=\"__codelineno-30-23\" href=\"#__codelineno-30-23\"></a><span class=\"w\">        </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-24\"><a id=\"__codelineno-30-24\" name=\"__codelineno-30-24\" href=\"#__codelineno-30-24\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-25\"><a id=\"__codelineno-30-25\" name=\"__codelineno-30-25\" href=\"#__codelineno-30-25\"></a>\n</span><span id=\"__span-30-26\"><a id=\"__codelineno-30-26\" name=\"__codelineno-30-26\" href=\"#__codelineno-30-26\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-27\"><a id=\"__codelineno-30-27\" name=\"__codelineno-30-27\" href=\"#__codelineno-30-27\"></a><span class=\"w\">        </span><span class=\"n\">nextinuse</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inuse_bit_at_offset</span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nextsize</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-28\"><a id=\"__codelineno-30-28\" name=\"__codelineno-30-28\" href=\"#__codelineno-30-28\"></a>\n</span><span id=\"__span-30-29\"><a id=\"__codelineno-30-29\" name=\"__codelineno-30-29\" href=\"#__codelineno-30-29\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">nextinuse</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-30\"><a id=\"__codelineno-30-30\" name=\"__codelineno-30-30\" href=\"#__codelineno-30-30\"></a><span class=\"w\">          </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-31\"><a id=\"__codelineno-30-31\" name=\"__codelineno-30-31\" href=\"#__codelineno-30-31\"></a><span class=\"w\">          </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nextchunk</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-32\"><a id=\"__codelineno-30-32\" name=\"__codelineno-30-32\" href=\"#__codelineno-30-32\"></a><span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span>\n</span><span id=\"__span-30-33\"><a id=\"__codelineno-30-33\" name=\"__codelineno-30-33\" href=\"#__codelineno-30-33\"></a><span class=\"w\">          </span><span class=\"n\">clear_inuse_bit_at_offset</span><span class=\"p\">(</span><span class=\"n\">nextchunk</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-34\"><a id=\"__codelineno-30-34\" name=\"__codelineno-30-34\" href=\"#__codelineno-30-34\"></a>\n</span><span id=\"__span-30-35\"><a id=\"__codelineno-30-35\" name=\"__codelineno-30-35\" href=\"#__codelineno-30-35\"></a><span class=\"w\">        </span><span class=\"n\">first_unsorted</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_bin</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-36\"><a id=\"__codelineno-30-36\" name=\"__codelineno-30-36\" href=\"#__codelineno-30-36\"></a><span class=\"w\">        </span><span class=\"n\">unsorted_bin</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-37\"><a id=\"__codelineno-30-37\" name=\"__codelineno-30-37\" href=\"#__codelineno-30-37\"></a><span class=\"w\">        </span><span class=\"n\">first_unsorted</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-38\"><a id=\"__codelineno-30-38\" name=\"__codelineno-30-38\" href=\"#__codelineno-30-38\"></a>\n</span><span id=\"__span-30-39\"><a id=\"__codelineno-30-39\" name=\"__codelineno-30-39\" href=\"#__codelineno-30-39\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-40\"><a id=\"__codelineno-30-40\" name=\"__codelineno-30-40\" href=\"#__codelineno-30-40\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-41\"><a id=\"__codelineno-30-41\" name=\"__codelineno-30-41\" href=\"#__codelineno-30-41\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-42\"><a id=\"__codelineno-30-42\" name=\"__codelineno-30-42\" href=\"#__codelineno-30-42\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-43\"><a id=\"__codelineno-30-43\" name=\"__codelineno-30-43\" href=\"#__codelineno-30-43\"></a>\n</span><span id=\"__span-30-44\"><a id=\"__codelineno-30-44\" name=\"__codelineno-30-44\" href=\"#__codelineno-30-44\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-45\"><a id=\"__codelineno-30-45\" name=\"__codelineno-30-45\" href=\"#__codelineno-30-45\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_bin</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-46\"><a id=\"__codelineno-30-46\" name=\"__codelineno-30-46\" href=\"#__codelineno-30-46\"></a><span class=\"w\">        </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">first_unsorted</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-47\"><a id=\"__codelineno-30-47\" name=\"__codelineno-30-47\" href=\"#__codelineno-30-47\"></a><span class=\"w\">        </span><span class=\"n\">set_foot</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-48\"><a id=\"__codelineno-30-48\" name=\"__codelineno-30-48\" href=\"#__codelineno-30-48\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-49\"><a id=\"__codelineno-30-49\" name=\"__codelineno-30-49\" href=\"#__codelineno-30-49\"></a>\n</span><span id=\"__span-30-50\"><a id=\"__codelineno-30-50\" name=\"__codelineno-30-50\" href=\"#__codelineno-30-50\"></a><span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-30-51\"><a id=\"__codelineno-30-51\" name=\"__codelineno-30-51\" href=\"#__codelineno-30-51\"></a><span class=\"w\">        </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-52\"><a id=\"__codelineno-30-52\" name=\"__codelineno-30-52\" href=\"#__codelineno-30-52\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-53\"><a id=\"__codelineno-30-53\" name=\"__codelineno-30-53\" href=\"#__codelineno-30-53\"></a><span class=\"w\">        </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-30-54\"><a id=\"__codelineno-30-54\" name=\"__codelineno-30-54\" href=\"#__codelineno-30-54\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-55\"><a id=\"__codelineno-30-55\" name=\"__codelineno-30-55\" href=\"#__codelineno-30-55\"></a>\n</span><span id=\"__span-30-56\"><a id=\"__codelineno-30-56\" name=\"__codelineno-30-56\" href=\"#__codelineno-30-56\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nextp</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-30-57\"><a id=\"__codelineno-30-57\" name=\"__codelineno-30-57\" href=\"#__codelineno-30-57\"></a>\n</span><span id=\"__span-30-58\"><a id=\"__codelineno-30-58\" name=\"__codelineno-30-58\" href=\"#__codelineno-30-58\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-30-59\"><a id=\"__codelineno-30-59\" name=\"__codelineno-30-59\" href=\"#__codelineno-30-59\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fb</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">maxfb</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<ol>\n<li>\u7b2c\u4e00\u5c42\u5faa\u73af\uff0c\u904d\u5386\u6bcf\u4e2a\u975e\u7a7a\u7684 fast bin\uff0c\u8fdb\u884c\u4e0b\u5217\u64cd\u4f5c</li>\n<li>\u7b2c\u4e8c\u5c42\u5faa\u73af\uff0c\u6bcf\u4e2a\u975e\u7a7a\u7684 fast bin \u6709\u4e00\u4e2a\u5355\u5411\u94fe\u8868\uff0c\u6cbf\u7740\u94fe\u8868\u8fdb\u884c\u8fed\u4ee3\uff0c\u904d\u5386\u94fe\u8868\u4e0a\u7684\u6bcf\u4e2a\u7a7a\u95f2\u5757\uff0c\u8fdb\u884c\u4e0b\u5217\u64cd\u4f5c</li>\n<li>\u5faa\u73af\u5185\u90e8\uff0c\u68c0\u67e5\u5f53\u524d\u7a7a\u95f2\u5757\u80fd\u5426\u548c\u524d\u540e\u7684\u7a7a\u95f2\u5757\u5408\u5e76</li>\n<li>\u9996\u5148\u68c0\u67e5\u5728\u5b83\u524d\u9762\uff08\u5730\u5740\u66f4\u4f4e\u7684\uff09\u76f8\u90bb\u7684\u5757\u662f\u5426\u7a7a\u95f2\uff1a\u5982\u679c <code>PREV_INUSE</code> \u6ca1\u6709\u88ab\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>mchunk_prev_size</code> \u627e\u5230\u524d\u9762\u76f8\u90bb\u7684\u5757\u7684\u5f00\u5934\uff0c\u7136\u540e\u628a\u4e24\u4e2a\u5757\u5408\u5e76\u8d77\u6765\uff1b\u5982\u679c\u524d\u9762\u76f8\u90bb\u7684\u5757\u5df2\u7ecf\u5728\u67d0\u4e2a\u53cc\u5411\u94fe\u8868\u5f53\u4e2d\uff08\u4f8b\u5982 small bin\uff09\uff0c\u628a\u5b83\u4ece\u53cc\u5411\u94fe\u8868\u4e2d\u5220\u9664\uff1a<code>unlink_chunk (av, p);</code>\uff1b\u4e3a\u4ec0\u4e48\u524d\u9762\u8981\u7528\u53cc\u5411\u94fe\u8868\uff0c\u4e5f\u662f\u4e3a\u4e86\u5728\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u4ece\u94fe\u8868\u4e2d\u95f4\u5220\u9664\u4e00\u4e2a\u7ed3\u70b9</li>\n<li>\u63a5\u7740\u68c0\u67e5\u5728\u5b83\u540e\u9762\uff08\u5730\u5740\u66f4\u9ad8\u7684\uff09\u76f8\u90bb\u7684\u5757\u662f\u5426\u7a7a\u95f2\uff1a\u6839\u636e\u81ea\u5df1\u7684 size\uff0c\u8ba1\u7b97\u51fa\u4e0b\u4e00\u4e2a\u5757\u7684\u5730\u5740\uff0c\u5f97\u5230\u4e0b\u4e00\u4e2a\u5757\u7684\u5927\u5c0f\uff0c\u518d\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5757\u7684\u4e0b\u4e00\u4e2a\u5757\uff0c\u6839\u636e\u5b83\u7684 <code>PREV_INUSE</code>\uff0c\u5224\u65ad\u4e0b\u4e00\u4e2a\u5757\u662f\u5426\u7a7a\u95f2\uff1b\u5982\u679c\u7a7a\u95f2\uff0c\u90a3\u5c31\u628a\u4e0b\u4e00\u4e2a\u5757\u4e5f\u5408\u5e76\u8fdb\u6765\uff0c\u540c\u7406\u4e5f\u8981\u628a\u5b83\u4ece\u53cc\u5411\u94fe\u8868\u4e2d\u5220\u9664\uff1a<code>unlink_chunk (av, nextchunk);</code>\uff1b\u4ee3\u7801\u4e2d\u8fd8\u6709\u5bf9 top chunk \u7684\u7279\u6b8a\u5904\u7406\uff0c\u8fd9\u91cc\u5148\u7565\u8fc7</li>\n<li>\u5408\u5e76\u5b8c\u6210\u4ee5\u540e\uff0c\u628a\u5f53\u524d\u7684\u7a7a\u95f2\u5757\u653e\u5230 unsorted bin \u5f53\u4e2d\uff0c\u4e5f\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u53cc\u5411\u94fe\u8868\u5411\u94fe\u8868\u5934\u7684\u63d2\u5165\u7b97\u6cd5\uff1a<code>first_unsorted = unsorted_bin-&gt;fd; unsorted_bin-&gt;fd = p; first_unsorted-&gt;bk = p; p-&gt;bk = unsorted_bin; p-&gt;fd = first_unsorted;</code></li>\n</ol>\n<p><code>unlink_chunk</code> \u7684\u5b9e\u73b0\u5c31\u662f\u7ecf\u5178\u7684\u53cc\u5411\u94fe\u8868\u5220\u9664\u7ed3\u70b9\u7684\u7b97\u6cd5\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-31-1\"><a id=\"__codelineno-31-1\" name=\"__codelineno-31-1\" href=\"#__codelineno-31-1\"></a><span class=\"cm\">/* Take a chunk off a bin list.  */</span>\n</span><span id=\"__span-31-2\"><a id=\"__codelineno-31-2\" name=\"__codelineno-31-2\" href=\"#__codelineno-31-2\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span>\n</span><span id=\"__span-31-3\"><a id=\"__codelineno-31-3\" name=\"__codelineno-31-3\" href=\"#__codelineno-31-3\"></a><span class=\"nf\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">mstate</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-4\"><a id=\"__codelineno-31-4\" name=\"__codelineno-31-4\" href=\"#__codelineno-31-4\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-31-5\"><a id=\"__codelineno-31-5\" name=\"__codelineno-31-5\" href=\"#__codelineno-31-5\"></a><span class=\"w\">  </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-31-6\"><a id=\"__codelineno-31-6\" name=\"__codelineno-31-6\" href=\"#__codelineno-31-6\"></a>\n</span><span id=\"__span-31-7\"><a id=\"__codelineno-31-7\" name=\"__codelineno-31-7\" href=\"#__codelineno-31-7\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-8\"><a id=\"__codelineno-31-8\" name=\"__codelineno-31-8\" href=\"#__codelineno-31-8\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-9\"><a id=\"__codelineno-31-9\" name=\"__codelineno-31-9\" href=\"#__codelineno-31-9\"></a>\n</span><span id=\"__span-31-10\"><a id=\"__codelineno-31-10\" name=\"__codelineno-31-10\" href=\"#__codelineno-31-10\"></a><span class=\"w\">  </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-31-11\"><a id=\"__codelineno-31-11\" name=\"__codelineno-31-11\" href=\"#__codelineno-31-11\"></a>\n</span><span id=\"__span-31-12\"><a id=\"__codelineno-31-12\" name=\"__codelineno-31-12\" href=\"#__codelineno-31-12\"></a><span class=\"w\">  </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-13\"><a id=\"__codelineno-31-13\" name=\"__codelineno-31-13\" href=\"#__codelineno-31-13\"></a><span class=\"w\">  </span><span class=\"n\">bk</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-14\"><a id=\"__codelineno-31-14\" name=\"__codelineno-31-14\" href=\"#__codelineno-31-14\"></a><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-15\"><a id=\"__codelineno-31-15\" name=\"__codelineno-31-15\" href=\"#__codelineno-31-15\"></a><span class=\"w\">    </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-16\"><a id=\"__codelineno-31-16\" name=\"__codelineno-31-16\" href=\"#__codelineno-31-16\"></a><span class=\"w\">      </span><span class=\"cm\">/* malloc check omitted */</span>\n</span><span id=\"__span-31-17\"><a id=\"__codelineno-31-17\" name=\"__codelineno-31-17\" href=\"#__codelineno-31-17\"></a>\n</span><span id=\"__span-31-18\"><a id=\"__codelineno-31-18\" name=\"__codelineno-31-18\" href=\"#__codelineno-31-18\"></a><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-19\"><a id=\"__codelineno-31-19\" name=\"__codelineno-31-19\" href=\"#__codelineno-31-19\"></a><span class=\"w\">        </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-20\"><a id=\"__codelineno-31-20\" name=\"__codelineno-31-20\" href=\"#__codelineno-31-20\"></a><span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">)</span>\n</span><span id=\"__span-31-21\"><a id=\"__codelineno-31-21\" name=\"__codelineno-31-21\" href=\"#__codelineno-31-21\"></a><span class=\"w\">            </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-22\"><a id=\"__codelineno-31-22\" name=\"__codelineno-31-22\" href=\"#__codelineno-31-22\"></a><span class=\"w\">          </span><span class=\"k\">else</span>\n</span><span id=\"__span-31-23\"><a id=\"__codelineno-31-23\" name=\"__codelineno-31-23\" href=\"#__codelineno-31-23\"></a><span class=\"w\">            </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-24\"><a id=\"__codelineno-31-24\" name=\"__codelineno-31-24\" href=\"#__codelineno-31-24\"></a><span class=\"w\">              </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-25\"><a id=\"__codelineno-31-25\" name=\"__codelineno-31-25\" href=\"#__codelineno-31-25\"></a><span class=\"w\">              </span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-26\"><a id=\"__codelineno-31-26\" name=\"__codelineno-31-26\" href=\"#__codelineno-31-26\"></a><span class=\"w\">              </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-27\"><a id=\"__codelineno-31-27\" name=\"__codelineno-31-27\" href=\"#__codelineno-31-27\"></a><span class=\"w\">              </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-28\"><a id=\"__codelineno-31-28\" name=\"__codelineno-31-28\" href=\"#__codelineno-31-28\"></a><span class=\"w\">            </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-29\"><a id=\"__codelineno-31-29\" name=\"__codelineno-31-29\" href=\"#__codelineno-31-29\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-30\"><a id=\"__codelineno-31-30\" name=\"__codelineno-31-30\" href=\"#__codelineno-31-30\"></a><span class=\"w\">      </span><span class=\"k\">else</span>\n</span><span id=\"__span-31-31\"><a id=\"__codelineno-31-31\" name=\"__codelineno-31-31\" href=\"#__codelineno-31-31\"></a><span class=\"w\">        </span><span class=\"p\">{</span>\n</span><span id=\"__span-31-32\"><a id=\"__codelineno-31-32\" name=\"__codelineno-31-32\" href=\"#__codelineno-31-32\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-33\"><a id=\"__codelineno-31-33\" name=\"__codelineno-31-33\" href=\"#__codelineno-31-33\"></a><span class=\"w\">          </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-31-34\"><a id=\"__codelineno-31-34\" name=\"__codelineno-31-34\" href=\"#__codelineno-31-34\"></a><span class=\"w\">        </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-35\"><a id=\"__codelineno-31-35\" name=\"__codelineno-31-35\" href=\"#__codelineno-31-35\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-31-36\"><a id=\"__codelineno-31-36\" name=\"__codelineno-31-36\" href=\"#__codelineno-31-36\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u7684 <code>fd_nextsize</code> \u548c <code>bk_nextsize</code> \u5b57\u6bb5\u9002\u7528\u4e8e large bin\uff0c\u540e\u9762\u4f1a\u8ba8\u8bba\u8fd9\u4e2a\u53cc\u5411\u94fe\u8868\u7684\u7ec6\u8282\u3002</p>\n<p>\u56e0\u6b64 unsorted bin \u4fdd\u5b58\u4e86\u4e00\u4e9b\u4ece fast bin \u5408\u5e76\u800c\u6765\u7684\u4e00\u4e9b\u5757\uff0c\u7531\u4e8e unsorted bin \u53ea\u6709\u4e00\u4e2a\uff0c\u6240\u4ee5\u5b83\u91cc\u9762\u4f1a\u4fdd\u5b58\u5404\u79cd\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u3002\u5b9e\u9645\u4e0a\uff0cunsorted bin \u5360\u7528\u7684\u5c31\u662f <code>malloc_state</code> \u7ed3\u6784\u4e2d\u7684 bin 1\uff0c\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\uff0c\u5757\u7684\u5927\u5c0f\u81f3\u5c11\u662f 32\uff0c\u800c\u5927\u5c0f\u4e3a 32 \u7684\u5757\uff0c\u5bf9\u5e94\u7684 small bin index \u662f 2\uff0c\u8bf4\u660e 1 \u6ca1\u6709\u88ab\u7528\u5230\uff0c\u5176\u5b9e\u5c31\u662f\u7559\u7ed9 unsorted bin \u7528\u7684\u3002\u5728 64 \u4f4d\u7cfb\u7edf\u4e0b\uff0c<code>malloc_state</code> \u7684 127 \u4e2a bin \u5206\u914d\u5982\u4e0b\uff1a</p>\n<ol>\n<li>bin 1 \u662f unsorted bin</li>\n<li>bin 2 \u5230 bin 63 \u662f small bin</li>\n<li>bin 64 \u5230 bin 126 \u662f large bin</li>\n</ol>\n<p>bin 127 \u6ca1\u6709\u7528\u5230\u3002</p>\n<p>\u7ecf\u8fc7\u8fd9\u6b21\u5408\u5e76\u4e4b\u540e\uff0c\u63a5\u4e0b\u6765 <code>_int_malloc</code> \u5c1d\u8bd5\u4ece unsorted bin \u548c large bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\u3002</p>\n<h2 id=\"\u518d\u6b21\u56de\u5230-__libc_malloc\">\u518d\u6b21\u56de\u5230 <code>__libc_malloc</code><a class=\"headerlink\" href=\"#\u518d\u6b21\u56de\u5230-__libc_malloc\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\uff0c<code>_int_malloc</code> \u6709\u4e00\u5927\u6bb5\u4ee3\u7801\u6765\u8fdb\u884c\u540e\u7eed\u7684\u5185\u5b58\u5206\u914d\uff0c\u5927\u6982\u6b65\u9aa4\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u628a unsorted bin \u4e2d\u7684\u7a7a\u95f2\u5757\u7684\u5904\u7406\uff0c\u653e\u5230 small bin \u6216\u8005 large bin \u4e2d\uff0c\u540c\u65f6\u5982\u679c\u6709\u5408\u9002\u7684\u5757\uff0c\u5c31\u5206\u914d\u7ed9 malloc \u7684\u8c03\u7528\u8005</li>\n<li>\u5982\u679c\u8fd8\u662f\u6ca1\u6709\u627e\u5230\u5408\u9002\u5927\u5c0f\u7684\u5757\uff0c\u5c31\u5728 large bin \u91cc\u5bfb\u627e\u7a7a\u95f2\u5757\u6765\u5206\u914d\uff1b\u5982\u679c\u627e\u4e0d\u5230\u5408\u9002\u5927\u5c0f\u7684\u5757\uff0c\u8fdb\u884c consolidate\uff0c\u5c1d\u8bd5\u66f4\u591a\u7684\u5408\u5e76\uff0c\u5f97\u5230\u66f4\u5927\u7684\u5757\uff1b\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\u591a\u6b21</li>\n<li>\u5982\u679c\u8fd8\u662f\u627e\u4e0d\u5230\u5408\u9002\u7684\u5757\uff0c\u5c31\u4ece\u5806\u9876\u5206\u914d\u65b0\u7684\u5757\uff0c\u5982\u679c\u5806\u5df2\u7ecf\u6ee1\u4e86\uff0c\u8fd8\u9700\u8981\u53bb\u6269\u5927\u5806\uff0c\u6216\u8005\u76f4\u63a5\u7528 mmap \u5206\u914d\u4e00\u7247\u5185\u5b58</li>\n</ol>\n<p>\u73b0\u5728\u5206\u6b65\u9aa4\u89c2\u5bdf\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u9996\u5148\u89c2\u5bdf unsorted bin \u7684\u5904\u7406\u3002</p>\n<h2 id=\"unsorted-bin\">unsorted bin<a class=\"headerlink\" href=\"#unsorted-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u662f unsorted bin \u7684\u7a7a\u95f2\u5757\u7684\u5904\u7406\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-32-1\"><a id=\"__codelineno-32-1\" name=\"__codelineno-32-1\" href=\"#__codelineno-32-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">iters</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-2\"><a id=\"__codelineno-32-2\" name=\"__codelineno-32-2\" href=\"#__codelineno-32-2\"></a><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-3\"><a id=\"__codelineno-32-3\" name=\"__codelineno-32-3\" href=\"#__codelineno-32-3\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-4\"><a id=\"__codelineno-32-4\" name=\"__codelineno-32-4\" href=\"#__codelineno-32-4\"></a><span class=\"w\">    </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-5\"><a id=\"__codelineno-32-5\" name=\"__codelineno-32-5\" href=\"#__codelineno-32-5\"></a><span class=\"w\">    </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-6\"><a id=\"__codelineno-32-6\" name=\"__codelineno-32-6\" href=\"#__codelineno-32-6\"></a><span class=\"w\">    </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-7\"><a id=\"__codelineno-32-7\" name=\"__codelineno-32-7\" href=\"#__codelineno-32-7\"></a>\n</span><span id=\"__span-32-8\"><a id=\"__codelineno-32-8\" name=\"__codelineno-32-8\" href=\"#__codelineno-32-8\"></a><span class=\"w\">    </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-9\"><a id=\"__codelineno-32-9\" name=\"__codelineno-32-9\" href=\"#__codelineno-32-9\"></a>\n</span><span id=\"__span-32-10\"><a id=\"__codelineno-32-10\" name=\"__codelineno-32-10\" href=\"#__codelineno-32-10\"></a><span class=\"w\">    </span><span class=\"cm\">/*</span>\n</span><span id=\"__span-32-11\"><a id=\"__codelineno-32-11\" name=\"__codelineno-32-11\" href=\"#__codelineno-32-11\"></a><span class=\"cm\">       If a small request, try to use last remainder if it is the</span>\n</span><span id=\"__span-32-12\"><a id=\"__codelineno-32-12\" name=\"__codelineno-32-12\" href=\"#__codelineno-32-12\"></a><span class=\"cm\">       only chunk in unsorted bin.  This helps promote locality for</span>\n</span><span id=\"__span-32-13\"><a id=\"__codelineno-32-13\" name=\"__codelineno-32-13\" href=\"#__codelineno-32-13\"></a><span class=\"cm\">       runs of consecutive small requests. This is the only</span>\n</span><span id=\"__span-32-14\"><a id=\"__codelineno-32-14\" name=\"__codelineno-32-14\" href=\"#__codelineno-32-14\"></a><span class=\"cm\">       exception to best-fit, and applies only when there is</span>\n</span><span id=\"__span-32-15\"><a id=\"__codelineno-32-15\" name=\"__codelineno-32-15\" href=\"#__codelineno-32-15\"></a><span class=\"cm\">       no exact fit for a small chunk.</span>\n</span><span id=\"__span-32-16\"><a id=\"__codelineno-32-16\" name=\"__codelineno-32-16\" href=\"#__codelineno-32-16\"></a><span class=\"cm\">     */</span>\n</span><span id=\"__span-32-17\"><a id=\"__codelineno-32-17\" name=\"__codelineno-32-17\" href=\"#__codelineno-32-17\"></a>\n</span><span id=\"__span-32-18\"><a id=\"__codelineno-32-18\" name=\"__codelineno-32-18\" href=\"#__codelineno-32-18\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n</span><span id=\"__span-32-19\"><a id=\"__codelineno-32-19\" name=\"__codelineno-32-19\" href=\"#__codelineno-32-19\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n</span><span id=\"__span-32-20\"><a id=\"__codelineno-32-20\" name=\"__codelineno-32-20\" href=\"#__codelineno-32-20\"></a><span class=\"w\">        </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">last_remainder</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span>\n</span><span id=\"__span-32-21\"><a id=\"__codelineno-32-21\" name=\"__codelineno-32-21\" href=\"#__codelineno-32-21\"></a><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-22\"><a id=\"__codelineno-32-22\" name=\"__codelineno-32-22\" href=\"#__codelineno-32-22\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-23\"><a id=\"__codelineno-32-23\" name=\"__codelineno-32-23\" href=\"#__codelineno-32-23\"></a><span class=\"w\">        </span><span class=\"cm\">/* split and reattach remainder */</span>\n</span><span id=\"__span-32-24\"><a id=\"__codelineno-32-24\" name=\"__codelineno-32-24\" href=\"#__codelineno-32-24\"></a><span class=\"w\">        </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-25\"><a id=\"__codelineno-32-25\" name=\"__codelineno-32-25\" href=\"#__codelineno-32-25\"></a><span class=\"w\">        </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-26\"><a id=\"__codelineno-32-26\" name=\"__codelineno-32-26\" href=\"#__codelineno-32-26\"></a><span class=\"w\">        </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-27\"><a id=\"__codelineno-32-27\" name=\"__codelineno-32-27\" href=\"#__codelineno-32-27\"></a><span class=\"w\">        </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">last_remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-28\"><a id=\"__codelineno-32-28\" name=\"__codelineno-32-28\" href=\"#__codelineno-32-28\"></a><span class=\"w\">        </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-29\"><a id=\"__codelineno-32-29\" name=\"__codelineno-32-29\" href=\"#__codelineno-32-29\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-30\"><a id=\"__codelineno-32-30\" name=\"__codelineno-32-30\" href=\"#__codelineno-32-30\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-31\"><a id=\"__codelineno-32-31\" name=\"__codelineno-32-31\" href=\"#__codelineno-32-31\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-32\"><a id=\"__codelineno-32-32\" name=\"__codelineno-32-32\" href=\"#__codelineno-32-32\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-33\"><a id=\"__codelineno-32-33\" name=\"__codelineno-32-33\" href=\"#__codelineno-32-33\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-34\"><a id=\"__codelineno-32-34\" name=\"__codelineno-32-34\" href=\"#__codelineno-32-34\"></a>\n</span><span id=\"__span-32-35\"><a id=\"__codelineno-32-35\" name=\"__codelineno-32-35\" href=\"#__codelineno-32-35\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-32-36\"><a id=\"__codelineno-32-36\" name=\"__codelineno-32-36\" href=\"#__codelineno-32-36\"></a><span class=\"w\">                  </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-37\"><a id=\"__codelineno-32-37\" name=\"__codelineno-32-37\" href=\"#__codelineno-32-37\"></a><span class=\"w\">        </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-38\"><a id=\"__codelineno-32-38\" name=\"__codelineno-32-38\" href=\"#__codelineno-32-38\"></a><span class=\"w\">        </span><span class=\"n\">set_foot</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-39\"><a id=\"__codelineno-32-39\" name=\"__codelineno-32-39\" href=\"#__codelineno-32-39\"></a>\n</span><span id=\"__span-32-40\"><a id=\"__codelineno-32-40\" name=\"__codelineno-32-40\" href=\"#__codelineno-32-40\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-41\"><a id=\"__codelineno-32-41\" name=\"__codelineno-32-41\" href=\"#__codelineno-32-41\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-42\"><a id=\"__codelineno-32-42\" name=\"__codelineno-32-42\" href=\"#__codelineno-32-42\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-43\"><a id=\"__codelineno-32-43\" name=\"__codelineno-32-43\" href=\"#__codelineno-32-43\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-44\"><a id=\"__codelineno-32-44\" name=\"__codelineno-32-44\" href=\"#__codelineno-32-44\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-45\"><a id=\"__codelineno-32-45\" name=\"__codelineno-32-45\" href=\"#__codelineno-32-45\"></a>\n</span><span id=\"__span-32-46\"><a id=\"__codelineno-32-46\" name=\"__codelineno-32-46\" href=\"#__codelineno-32-46\"></a><span class=\"w\">    </span><span class=\"cm\">/* remove from unsorted list */</span>\n</span><span id=\"__span-32-47\"><a id=\"__codelineno-32-47\" name=\"__codelineno-32-47\" href=\"#__codelineno-32-47\"></a><span class=\"w\">    </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-48\"><a id=\"__codelineno-32-48\" name=\"__codelineno-32-48\" href=\"#__codelineno-32-48\"></a><span class=\"w\">    </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-49\"><a id=\"__codelineno-32-49\" name=\"__codelineno-32-49\" href=\"#__codelineno-32-49\"></a><span class=\"w\">    </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-50\"><a id=\"__codelineno-32-50\" name=\"__codelineno-32-50\" href=\"#__codelineno-32-50\"></a>\n</span><span id=\"__span-32-51\"><a id=\"__codelineno-32-51\" name=\"__codelineno-32-51\" href=\"#__codelineno-32-51\"></a><span class=\"w\">    </span><span class=\"cm\">/* Take now instead of binning if exact fit */</span>\n</span><span id=\"__span-32-52\"><a id=\"__codelineno-32-52\" name=\"__codelineno-32-52\" href=\"#__codelineno-32-52\"></a>\n</span><span id=\"__span-32-53\"><a id=\"__codelineno-32-53\" name=\"__codelineno-32-53\" href=\"#__codelineno-32-53\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-54\"><a id=\"__codelineno-32-54\" name=\"__codelineno-32-54\" href=\"#__codelineno-32-54\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-55\"><a id=\"__codelineno-32-55\" name=\"__codelineno-32-55\" href=\"#__codelineno-32-55\"></a><span class=\"w\">        </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-56\"><a id=\"__codelineno-32-56\" name=\"__codelineno-32-56\" href=\"#__codelineno-32-56\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-57\"><a id=\"__codelineno-32-57\" name=\"__codelineno-32-57\" href=\"#__codelineno-32-57\"></a><span class=\"w\">          </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-58\"><a id=\"__codelineno-32-58\" name=\"__codelineno-32-58\" href=\"#__codelineno-32-58\"></a><span class=\"w\">        </span><span class=\"cm\">/* Fill cache first, return to user only if cache fills.</span>\n</span><span id=\"__span-32-59\"><a id=\"__codelineno-32-59\" name=\"__codelineno-32-59\" href=\"#__codelineno-32-59\"></a><span class=\"cm\">           We may return one of these chunks later.  */</span>\n</span><span id=\"__span-32-60\"><a id=\"__codelineno-32-60\" name=\"__codelineno-32-60\" href=\"#__codelineno-32-60\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tcache_nb</span>\n</span><span id=\"__span-32-61\"><a id=\"__codelineno-32-61\" name=\"__codelineno-32-61\" href=\"#__codelineno-32-61\"></a><span class=\"w\">            </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache</span><span class=\"o\">-&gt;</span><span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">tc_idx</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_count</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-62\"><a id=\"__codelineno-32-62\" name=\"__codelineno-32-62\" href=\"#__codelineno-32-62\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-63\"><a id=\"__codelineno-32-63\" name=\"__codelineno-32-63\" href=\"#__codelineno-32-63\"></a><span class=\"w\">            </span><span class=\"n\">tcache_put</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-64\"><a id=\"__codelineno-32-64\" name=\"__codelineno-32-64\" href=\"#__codelineno-32-64\"></a><span class=\"w\">            </span><span class=\"n\">return_cached</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-65\"><a id=\"__codelineno-32-65\" name=\"__codelineno-32-65\" href=\"#__codelineno-32-65\"></a><span class=\"w\">            </span><span class=\"k\">continue</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-66\"><a id=\"__codelineno-32-66\" name=\"__codelineno-32-66\" href=\"#__codelineno-32-66\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-67\"><a id=\"__codelineno-32-67\" name=\"__codelineno-32-67\" href=\"#__codelineno-32-67\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-68\"><a id=\"__codelineno-32-68\" name=\"__codelineno-32-68\" href=\"#__codelineno-32-68\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-69\"><a id=\"__codelineno-32-69\" name=\"__codelineno-32-69\" href=\"#__codelineno-32-69\"></a><span class=\"w\">            </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-70\"><a id=\"__codelineno-32-70\" name=\"__codelineno-32-70\" href=\"#__codelineno-32-70\"></a><span class=\"w\">            </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-71\"><a id=\"__codelineno-32-71\" name=\"__codelineno-32-71\" href=\"#__codelineno-32-71\"></a><span class=\"w\">            </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-72\"><a id=\"__codelineno-32-72\" name=\"__codelineno-32-72\" href=\"#__codelineno-32-72\"></a><span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-73\"><a id=\"__codelineno-32-73\" name=\"__codelineno-32-73\" href=\"#__codelineno-32-73\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-74\"><a id=\"__codelineno-32-74\" name=\"__codelineno-32-74\" href=\"#__codelineno-32-74\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-75\"><a id=\"__codelineno-32-75\" name=\"__codelineno-32-75\" href=\"#__codelineno-32-75\"></a>\n</span><span id=\"__span-32-76\"><a id=\"__codelineno-32-76\" name=\"__codelineno-32-76\" href=\"#__codelineno-32-76\"></a><span class=\"w\">    </span><span class=\"cm\">/* place chunk in bin */</span>\n</span><span id=\"__span-32-77\"><a id=\"__codelineno-32-77\" name=\"__codelineno-32-77\" href=\"#__codelineno-32-77\"></a>\n</span><span id=\"__span-32-78\"><a id=\"__codelineno-32-78\" name=\"__codelineno-32-78\" href=\"#__codelineno-32-78\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-79\"><a id=\"__codelineno-32-79\" name=\"__codelineno-32-79\" href=\"#__codelineno-32-79\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-80\"><a id=\"__codelineno-32-80\" name=\"__codelineno-32-80\" href=\"#__codelineno-32-80\"></a><span class=\"w\">        </span><span class=\"n\">victim_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">smallbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-81\"><a id=\"__codelineno-32-81\" name=\"__codelineno-32-81\" href=\"#__codelineno-32-81\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim_index</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-82\"><a id=\"__codelineno-32-82\" name=\"__codelineno-32-82\" href=\"#__codelineno-32-82\"></a><span class=\"w\">        </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-83\"><a id=\"__codelineno-32-83\" name=\"__codelineno-32-83\" href=\"#__codelineno-32-83\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-84\"><a id=\"__codelineno-32-84\" name=\"__codelineno-32-84\" href=\"#__codelineno-32-84\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-85\"><a id=\"__codelineno-32-85\" name=\"__codelineno-32-85\" href=\"#__codelineno-32-85\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-86\"><a id=\"__codelineno-32-86\" name=\"__codelineno-32-86\" href=\"#__codelineno-32-86\"></a><span class=\"w\">        </span><span class=\"n\">victim_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-87\"><a id=\"__codelineno-32-87\" name=\"__codelineno-32-87\" href=\"#__codelineno-32-87\"></a><span class=\"w\">        </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim_index</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-88\"><a id=\"__codelineno-32-88\" name=\"__codelineno-32-88\" href=\"#__codelineno-32-88\"></a><span class=\"w\">        </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-89\"><a id=\"__codelineno-32-89\" name=\"__codelineno-32-89\" href=\"#__codelineno-32-89\"></a>\n</span><span id=\"__span-32-90\"><a id=\"__codelineno-32-90\" name=\"__codelineno-32-90\" href=\"#__codelineno-32-90\"></a><span class=\"w\">        </span><span class=\"cm\">/* maintain large bins in sorted order */</span>\n</span><span id=\"__span-32-91\"><a id=\"__codelineno-32-91\" name=\"__codelineno-32-91\" href=\"#__codelineno-32-91\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-92\"><a id=\"__codelineno-32-92\" name=\"__codelineno-32-92\" href=\"#__codelineno-32-92\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-93\"><a id=\"__codelineno-32-93\" name=\"__codelineno-32-93\" href=\"#__codelineno-32-93\"></a><span class=\"w\">            </span><span class=\"cm\">/* Or with inuse bit to speed comparisons */</span>\n</span><span id=\"__span-32-94\"><a id=\"__codelineno-32-94\" name=\"__codelineno-32-94\" href=\"#__codelineno-32-94\"></a><span class=\"w\">            </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">|=</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-95\"><a id=\"__codelineno-32-95\" name=\"__codelineno-32-95\" href=\"#__codelineno-32-95\"></a><span class=\"w\">            </span><span class=\"cm\">/* if smaller than smallest, bypass loop below */</span>\n</span><span id=\"__span-32-96\"><a id=\"__codelineno-32-96\" name=\"__codelineno-32-96\" href=\"#__codelineno-32-96\"></a><span class=\"w\">            </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-97\"><a id=\"__codelineno-32-97\" name=\"__codelineno-32-97\" href=\"#__codelineno-32-97\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-98\"><a id=\"__codelineno-32-98\" name=\"__codelineno-32-98\" href=\"#__codelineno-32-98\"></a><span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-99\"><a id=\"__codelineno-32-99\" name=\"__codelineno-32-99\" href=\"#__codelineno-32-99\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-100\"><a id=\"__codelineno-32-100\" name=\"__codelineno-32-100\" href=\"#__codelineno-32-100\"></a><span class=\"w\">                </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-101\"><a id=\"__codelineno-32-101\" name=\"__codelineno-32-101\" href=\"#__codelineno-32-101\"></a><span class=\"w\">                </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-102\"><a id=\"__codelineno-32-102\" name=\"__codelineno-32-102\" href=\"#__codelineno-32-102\"></a>\n</span><span id=\"__span-32-103\"><a id=\"__codelineno-32-103\" name=\"__codelineno-32-103\" href=\"#__codelineno-32-103\"></a><span class=\"w\">                </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-104\"><a id=\"__codelineno-32-104\" name=\"__codelineno-32-104\" href=\"#__codelineno-32-104\"></a><span class=\"w\">                </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-105\"><a id=\"__codelineno-32-105\" name=\"__codelineno-32-105\" href=\"#__codelineno-32-105\"></a><span class=\"w\">                </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-106\"><a id=\"__codelineno-32-106\" name=\"__codelineno-32-106\" href=\"#__codelineno-32-106\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-107\"><a id=\"__codelineno-32-107\" name=\"__codelineno-32-107\" href=\"#__codelineno-32-107\"></a><span class=\"w\">            </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-108\"><a id=\"__codelineno-32-108\" name=\"__codelineno-32-108\" href=\"#__codelineno-32-108\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-109\"><a id=\"__codelineno-32-109\" name=\"__codelineno-32-109\" href=\"#__codelineno-32-109\"></a><span class=\"w\">                </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-110\"><a id=\"__codelineno-32-110\" name=\"__codelineno-32-110\" href=\"#__codelineno-32-110\"></a><span class=\"w\">                </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-111\"><a id=\"__codelineno-32-111\" name=\"__codelineno-32-111\" href=\"#__codelineno-32-111\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-112\"><a id=\"__codelineno-32-112\" name=\"__codelineno-32-112\" href=\"#__codelineno-32-112\"></a><span class=\"w\">                    </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-113\"><a id=\"__codelineno-32-113\" name=\"__codelineno-32-113\" href=\"#__codelineno-32-113\"></a><span class=\"w\">                    </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chunk_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">));</span>\n</span><span id=\"__span-32-114\"><a id=\"__codelineno-32-114\" name=\"__codelineno-32-114\" href=\"#__codelineno-32-114\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-115\"><a id=\"__codelineno-32-115\" name=\"__codelineno-32-115\" href=\"#__codelineno-32-115\"></a>\n</span><span id=\"__span-32-116\"><a id=\"__codelineno-32-116\" name=\"__codelineno-32-116\" href=\"#__codelineno-32-116\"></a><span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">size</span>\n</span><span id=\"__span-32-117\"><a id=\"__codelineno-32-117\" name=\"__codelineno-32-117\" href=\"#__codelineno-32-117\"></a><span class=\"w\">                    </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"p\">))</span>\n</span><span id=\"__span-32-118\"><a id=\"__codelineno-32-118\" name=\"__codelineno-32-118\" href=\"#__codelineno-32-118\"></a><span class=\"w\">                  </span><span class=\"cm\">/* Always insert in the second position.  */</span>\n</span><span id=\"__span-32-119\"><a id=\"__codelineno-32-119\" name=\"__codelineno-32-119\" href=\"#__codelineno-32-119\"></a><span class=\"w\">                  </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-120\"><a id=\"__codelineno-32-120\" name=\"__codelineno-32-120\" href=\"#__codelineno-32-120\"></a><span class=\"w\">                </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-121\"><a id=\"__codelineno-32-121\" name=\"__codelineno-32-121\" href=\"#__codelineno-32-121\"></a><span class=\"w\">                  </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-122\"><a id=\"__codelineno-32-122\" name=\"__codelineno-32-122\" href=\"#__codelineno-32-122\"></a><span class=\"w\">                    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-123\"><a id=\"__codelineno-32-123\" name=\"__codelineno-32-123\" href=\"#__codelineno-32-123\"></a><span class=\"w\">                    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-124\"><a id=\"__codelineno-32-124\" name=\"__codelineno-32-124\" href=\"#__codelineno-32-124\"></a><span class=\"w\">                    </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-125\"><a id=\"__codelineno-32-125\" name=\"__codelineno-32-125\" href=\"#__codelineno-32-125\"></a><span class=\"w\">                    </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-126\"><a id=\"__codelineno-32-126\" name=\"__codelineno-32-126\" href=\"#__codelineno-32-126\"></a><span class=\"w\">                    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-127\"><a id=\"__codelineno-32-127\" name=\"__codelineno-32-127\" href=\"#__codelineno-32-127\"></a><span class=\"w\">                  </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-128\"><a id=\"__codelineno-32-128\" name=\"__codelineno-32-128\" href=\"#__codelineno-32-128\"></a><span class=\"w\">                </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-129\"><a id=\"__codelineno-32-129\" name=\"__codelineno-32-129\" href=\"#__codelineno-32-129\"></a><span class=\"w\">                </span><span class=\"cm\">/* malloc checks omitted */</span>\n</span><span id=\"__span-32-130\"><a id=\"__codelineno-32-130\" name=\"__codelineno-32-130\" href=\"#__codelineno-32-130\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-131\"><a id=\"__codelineno-32-131\" name=\"__codelineno-32-131\" href=\"#__codelineno-32-131\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-132\"><a id=\"__codelineno-32-132\" name=\"__codelineno-32-132\" href=\"#__codelineno-32-132\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-32-133\"><a id=\"__codelineno-32-133\" name=\"__codelineno-32-133\" href=\"#__codelineno-32-133\"></a><span class=\"w\">          </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-134\"><a id=\"__codelineno-32-134\" name=\"__codelineno-32-134\" href=\"#__codelineno-32-134\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-135\"><a id=\"__codelineno-32-135\" name=\"__codelineno-32-135\" href=\"#__codelineno-32-135\"></a>\n</span><span id=\"__span-32-136\"><a id=\"__codelineno-32-136\" name=\"__codelineno-32-136\" href=\"#__codelineno-32-136\"></a><span class=\"w\">    </span><span class=\"n\">mark_bin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim_index</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-137\"><a id=\"__codelineno-32-137\" name=\"__codelineno-32-137\" href=\"#__codelineno-32-137\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-138\"><a id=\"__codelineno-32-138\" name=\"__codelineno-32-138\" href=\"#__codelineno-32-138\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-139\"><a id=\"__codelineno-32-139\" name=\"__codelineno-32-139\" href=\"#__codelineno-32-139\"></a><span class=\"w\">    </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-140\"><a id=\"__codelineno-32-140\" name=\"__codelineno-32-140\" href=\"#__codelineno-32-140\"></a><span class=\"w\">    </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-141\"><a id=\"__codelineno-32-141\" name=\"__codelineno-32-141\" href=\"#__codelineno-32-141\"></a>\n</span><span id=\"__span-32-142\"><a id=\"__codelineno-32-142\" name=\"__codelineno-32-142\" href=\"#__codelineno-32-142\"></a><span class=\"w\">    </span><span class=\"cm\">/* If we&#39;ve processed as many chunks as we&#39;re allowed while</span>\n</span><span id=\"__span-32-143\"><a id=\"__codelineno-32-143\" name=\"__codelineno-32-143\" href=\"#__codelineno-32-143\"></a><span class=\"cm\">       filling the cache, return one of the cached ones.  */</span>\n</span><span id=\"__span-32-144\"><a id=\"__codelineno-32-144\" name=\"__codelineno-32-144\" href=\"#__codelineno-32-144\"></a><span class=\"w\">    </span><span class=\"o\">++</span><span class=\"n\">tcache_unsorted_count</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-145\"><a id=\"__codelineno-32-145\" name=\"__codelineno-32-145\" href=\"#__codelineno-32-145\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">return_cached</span>\n</span><span id=\"__span-32-146\"><a id=\"__codelineno-32-146\" name=\"__codelineno-32-146\" href=\"#__codelineno-32-146\"></a><span class=\"w\">        </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_unsorted_limit</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</span><span id=\"__span-32-147\"><a id=\"__codelineno-32-147\" name=\"__codelineno-32-147\" href=\"#__codelineno-32-147\"></a><span class=\"w\">        </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">tcache_unsorted_count</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">mp_</span><span class=\"p\">.</span><span class=\"n\">tcache_unsorted_limit</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-148\"><a id=\"__codelineno-32-148\" name=\"__codelineno-32-148\" href=\"#__codelineno-32-148\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-32-149\"><a id=\"__codelineno-32-149\" name=\"__codelineno-32-149\" href=\"#__codelineno-32-149\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">tcache_get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tc_idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-32-150\"><a id=\"__codelineno-32-150\" name=\"__codelineno-32-150\" href=\"#__codelineno-32-150\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-32-151\"><a id=\"__codelineno-32-151\" name=\"__codelineno-32-151\" href=\"#__codelineno-32-151\"></a>\n</span><span id=\"__span-32-152\"><a id=\"__codelineno-32-152\" name=\"__codelineno-32-152\" href=\"#__codelineno-32-152\"></a><span class=\"cp\">#define MAX_ITERS       10000</span>\n</span><span id=\"__span-32-153\"><a id=\"__codelineno-32-153\" name=\"__codelineno-32-153\" href=\"#__codelineno-32-153\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">++</span><span class=\"n\">iters</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">MAX_ITERS</span><span class=\"p\">)</span>\n</span><span id=\"__span-32-154\"><a id=\"__codelineno-32-154\" name=\"__codelineno-32-154\" href=\"#__codelineno-32-154\"></a><span class=\"w\">      </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</span><span id=\"__span-32-155\"><a id=\"__codelineno-32-155\" name=\"__codelineno-32-155\" href=\"#__codelineno-32-155\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5b83\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u904d\u5386 unsorted bin \u53cc\u5411\u94fe\u8868\uff0c\u4ece\u54e8\u5175\u7ed3\u70b9\u5f00\u59cb\uff0c\u4ece\u540e\u5f80\u524d\u904d\u5386\u7a7a\u95f2\u5757</li>\n<li>fast path \u903b\u8f91\uff1a\u5982\u679c\u8981\u7533\u8bf7\u7684\u5757\u6bd4\u5f53\u524d\u7a7a\u95f2\u5757\u5c0f\uff0c\u5e76\u4e14\u5f53\u524d\u7a7a\u95f2\u5757\u53ef\u4ee5\u62c6\u5206\uff0c\u90a3\u5c31\u62c6\u5206\u5f53\u524d\u7684\u7a7a\u95f2\u5757\uff0c\u7136\u540e\u76f4\u63a5\u5206\u914d\u62c6\u5206\u540e\u7684\u7a7a\u95f2\u5757</li>\n<li>\u5982\u679c\u8981\u7533\u8bf7\u7684\u5757\u7684\u5927\u5c0f\u548c\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u76f8\u540c\uff0c\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache\uff0c\u6216\u8005\u76f4\u63a5\u5206\u914d\u8fd9\u4e2a\u7a7a\u95f2\u5757</li>\n<li>\u628a\u5f53\u524d\u7a7a\u95f2\u5757\u6839\u636e\u5927\u5c0f\uff0c\u5206\u53d1\u5230 small bin \u6216\u8005 large bin</li>\n<li>\u5982\u679c tcache \u4e2d\u6709\u5408\u9002\u7684\u7a7a\u95f2\u5757\uff0c\u5c31\u5206\u914d\u5b83</li>\n</ol>\n<p>\u7531\u6b64\u53ef\u89c1\uff0cunsorted bin \u4e2d\u7684\u7a7a\u95f2\u5757\u5728 malloc \u7684\u65f6\u5019\u4f1a\u88ab\u5206\u6d3e\u5230\u5bf9\u5e94\u7684 small bin \u6216\u8005 large bin \u5f53\u4e2d\u3002small bin \u7684\u5904\u7406\u6bd4\u8f83\u7b80\u5355\uff0c\u56e0\u4e3a\u6bcf\u4e2a bin \u7684\u5757\u5927\u5c0f\u90fd\u76f8\u540c\uff0c\u76f4\u63a5\u52a0\u5165\u5230\u53cc\u5411\u94fe\u8868\u5373\u53ef\u3002large bin \u7684\u5904\u7406\u5219\u6bd4\u8f83\u590d\u6742\uff0c\u4e0b\u9762\u4e3b\u8981\u6765\u5206\u6790 large bin \u7684\u7ed3\u6784\u3002</p>\n<h2 id=\"large-bin\">large bin<a class=\"headerlink\" href=\"#large-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>large bin \u548c\u5176\u4ed6 bin \u7684\u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8e\uff0c\u5b83\u6bcf\u4e2a bin \u7684\u5927\u5c0f\u4e0d\u662f\u4e00\u4e2a\u56fa\u5b9a\u7684\u503c\uff0c\u800c\u662f\u4e00\u4e2a\u8303\u56f4\u3002\u5728 64 \u4f4d\u4e0b\uff0cbin 64 \u5230 bin 127 \u5bf9\u5e94\u7684\u5757\u5927\u5c0f\u8303\u56f4\uff1a</p>\n<ol>\n<li>bin 64 \u5230 bin 96: \u4ece 1024 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 64 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 64 \u5bf9\u5e94 1024-1087 \u5b57\u8282\u8303\u56f4\uff0cbin 96 \u5bf9\u5e94 3072-3135 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 97 \u5230 bin 111: \u4ece 3136 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 512 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 97 \u5bf9\u5e94 3136-3583 \u5b57\u8282\u8303\u56f4\uff08\u6ca1\u6709\u6db5\u76d6 512 \u5b57\u8282\u662f\u56e0\u4e3a\u5bf9\u9f50\u95ee\u9898\uff0c\u5176\u4ed6\u7684\u90fd\u662f\u6db5\u76d6 512 \u5b57\u8282\uff09\uff0cbin 111 \u5bf9\u5e94 10240-10751 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 112 \u5230 bin 119: \u4ece 10752 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 4096 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 112 \u5bf9\u5e94 10752-12287 \u5b57\u8282\u8303\u56f4\uff08\u6ca1\u6709\u6db5\u76d6 4096 \u5b57\u8282\u662f\u56e0\u4e3a\u5bf9\u9f50\u95ee\u9898\uff0c\u5176\u4ed6\u7684\u90fd\u662f\u6db5\u76d6 4096 \u5b57\u8282\uff09\uff0cbin 119 \u5bf9\u5e94 36864-40959 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 120 \u5230 bin 123: \u4ece 40960 \u5b57\u8282\u5f00\u59cb\uff0c\u6bcf\u4e2a bin \u8986\u76d6 32768 \u5b57\u8282\u7684\u957f\u5ea6\u8303\u56f4\uff0c\u4f8b\u5982 bin 120 \u5bf9\u5e94 40960-65535 \u5b57\u8282\u8303\u56f4\uff08\u6ca1\u6709\u6db5\u76d6 32768 \u5b57\u8282\u662f\u56e0\u4e3a\u5bf9\u9f50\u95ee\u9898\uff0c\u5176\u4ed6\u7684\u90fd\u662f\u6db5\u76d6 32768 \u5b57\u8282\uff09\uff0cbin 123 \u5bf9\u5e94 131072-163839 \u5b57\u8282\u8303\u56f4</li>\n<li>bin 124: 163840-262143 \u5171 98304 \u4e2a\u5b57\u8282\u7684\u8303\u56f4</li>\n<li>bin 125: 262144-524287 \u5171 262144 \u4e2a\u5b57\u8282\u7684\u8303\u56f4</li>\n<li>bin 126: 524288 \u6216\u66f4\u957f</li>\n</ol>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u6bd4\u8f83\u77ed\u7684\u957f\u5ea6\u8303\u56f4\u7ed9\u7684 bin \u4e5f\u6bd4\u8f83\u591a\uff0c\u540e\u9762\u5219\u66f4\u52a0\u7a00\u758f\u3002\u4e0a\u8ff0\u5404\u4e2a bin \u7684\u5927\u5c0f\u8303\u56f4\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u4ee3\u7801\u6253\u5370\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-33-1\"><a id=\"__codelineno-33-1\" name=\"__codelineno-33-1\" href=\"#__codelineno-33-1\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n</span><span id=\"__span-33-2\"><a id=\"__codelineno-33-2\" name=\"__codelineno-33-2\" href=\"#__codelineno-33-2\"></a><span class=\"cp\">#define largebin_index_64(sz)                                                  \\</span>\n</span><span id=\"__span-33-3\"><a id=\"__codelineno-33-3\" name=\"__codelineno-33-3\" href=\"#__codelineno-33-3\"></a><span class=\"cp\">  (((((unsigned long)(sz)) &gt;&gt; 6) &lt;= 48)                                        \\</span>\n</span><span id=\"__span-33-4\"><a id=\"__codelineno-33-4\" name=\"__codelineno-33-4\" href=\"#__codelineno-33-4\"></a><span class=\"cp\">       ? 48 + (((unsigned long)(sz)) &gt;&gt; 6)                                     \\</span>\n</span><span id=\"__span-33-5\"><a id=\"__codelineno-33-5\" name=\"__codelineno-33-5\" href=\"#__codelineno-33-5\"></a><span class=\"cp\">       : ((((unsigned long)(sz)) &gt;&gt; 9) &lt;= 20)                                  \\</span>\n</span><span id=\"__span-33-6\"><a id=\"__codelineno-33-6\" name=\"__codelineno-33-6\" href=\"#__codelineno-33-6\"></a><span class=\"cp\">             ? 91 + (((unsigned long)(sz)) &gt;&gt; 9)                               \\</span>\n</span><span id=\"__span-33-7\"><a id=\"__codelineno-33-7\" name=\"__codelineno-33-7\" href=\"#__codelineno-33-7\"></a><span class=\"cp\">             : ((((unsigned long)(sz)) &gt;&gt; 12) &lt;= 10)                           \\</span>\n</span><span id=\"__span-33-8\"><a id=\"__codelineno-33-8\" name=\"__codelineno-33-8\" href=\"#__codelineno-33-8\"></a><span class=\"cp\">                   ? 110 + (((unsigned long)(sz)) &gt;&gt; 12)                       \\</span>\n</span><span id=\"__span-33-9\"><a id=\"__codelineno-33-9\" name=\"__codelineno-33-9\" href=\"#__codelineno-33-9\"></a><span class=\"cp\">                   : ((((unsigned long)(sz)) &gt;&gt; 15) &lt;= 4)                      \\</span>\n</span><span id=\"__span-33-10\"><a id=\"__codelineno-33-10\" name=\"__codelineno-33-10\" href=\"#__codelineno-33-10\"></a><span class=\"cp\">                         ? 119 + (((unsigned long)(sz)) &gt;&gt; 15)                 \\</span>\n</span><span id=\"__span-33-11\"><a id=\"__codelineno-33-11\" name=\"__codelineno-33-11\" href=\"#__codelineno-33-11\"></a><span class=\"cp\">                         : ((((unsigned long)(sz)) &gt;&gt; 18) &lt;= 2)                \\</span>\n</span><span id=\"__span-33-12\"><a id=\"__codelineno-33-12\" name=\"__codelineno-33-12\" href=\"#__codelineno-33-12\"></a><span class=\"cp\">                               ? 124 + (((unsigned long)(sz)) &gt;&gt; 18)           \\</span>\n</span><span id=\"__span-33-13\"><a id=\"__codelineno-33-13\" name=\"__codelineno-33-13\" href=\"#__codelineno-33-13\"></a><span class=\"cp\">                               : 126)</span>\n</span><span id=\"__span-33-14\"><a id=\"__codelineno-33-14\" name=\"__codelineno-33-14\" href=\"#__codelineno-33-14\"></a>\n</span><span id=\"__span-33-15\"><a id=\"__codelineno-33-15\" name=\"__codelineno-33-15\" href=\"#__codelineno-33-15\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-33-16\"><a id=\"__codelineno-33-16\" name=\"__codelineno-33-16\" href=\"#__codelineno-33-16\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index_64</span><span class=\"p\">(</span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-17\"><a id=\"__codelineno-33-17\" name=\"__codelineno-33-17\" href=\"#__codelineno-33-17\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">;</span>\n</span><span id=\"__span-33-18\"><a id=\"__codelineno-33-18\" name=\"__codelineno-33-18\" href=\"#__codelineno-33-18\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1000000</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-33-19\"><a id=\"__codelineno-33-19\" name=\"__codelineno-33-19\" href=\"#__codelineno-33-19\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">largebin_index_64</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-33-20\"><a id=\"__codelineno-33-20\" name=\"__codelineno-33-20\" href=\"#__codelineno-33-20\"></a><span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;%d-%d: %d, length %d</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-21\"><a id=\"__codelineno-33-21\" name=\"__codelineno-33-21\" href=\"#__codelineno-33-21\"></a><span class=\"w\">      </span><span class=\"n\">last_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span>\n</span><span id=\"__span-33-22\"><a id=\"__codelineno-33-22\" name=\"__codelineno-33-22\" href=\"#__codelineno-33-22\"></a><span class=\"w\">      </span><span class=\"n\">last_bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index_64</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-23\"><a id=\"__codelineno-33-23\" name=\"__codelineno-33-23\" href=\"#__codelineno-33-23\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-33-24\"><a id=\"__codelineno-33-24\" name=\"__codelineno-33-24\" href=\"#__codelineno-33-24\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-33-25\"><a id=\"__codelineno-33-25\" name=\"__codelineno-33-25\" href=\"#__codelineno-33-25\"></a><span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;%d-inf: %d</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">last_bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-33-26\"><a id=\"__codelineno-33-26\" name=\"__codelineno-33-26\" href=\"#__codelineno-33-26\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</span><span id=\"__span-33-27\"><a id=\"__codelineno-33-27\" name=\"__codelineno-33-27\" href=\"#__codelineno-33-27\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u56e0\u6b64 large bin \u91cc\u9762\u4f1a\u6709\u4e0d\u540c chunk \u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u3002\u4e3a\u4e86\u5feb\u901f\u5730\u5bfb\u627e\u60f3\u8981\u7684\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0clarge bin \u4e2d\u7a7a\u95f2\u5757\u6309\u7167\u4ece\u5927\u5230\u5c0f\u7684\u987a\u5e8f\u7ec4\u6210\u94fe\u8868\uff0c\u540c\u65f6\u901a\u8fc7 <code>fd_nextsize</code> \u548c <code>bk_nextsize</code> \u628a\u6bcf\u79cd\u5927\u5c0f\u51fa\u73b0\u7684\u7b2c\u4e00\u4e2a\u5757\u7ec4\u6210\u53cc\u5411\u94fe\u8868\u3002\u5927\u81f4\u7684\u8fde\u63a5\u65b9\u5f0f\u5982\u4e0b\uff0c\u53c2\u8003\u4e86 <a href=\"https://sourceware.org/glibc/wiki/MallocInternals\">Malloc Internals</a> \u7ed9\u7684\u793a\u4f8b\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-34-1\"><a id=\"__codelineno-34-1\" name=\"__codelineno-34-1\" href=\"#__codelineno-34-1\"></a>  bins[id]      chunk A              chunk B              chunk C\n</span><span id=\"__span-34-2\"><a id=\"__codelineno-34-2\" name=\"__codelineno-34-2\" href=\"#__codelineno-34-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-3\"><a id=\"__codelineno-34-3\" name=\"__codelineno-34-3\" href=\"#__codelineno-34-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1040     |\n</span><span id=\"__span-34-4\"><a id=\"__codelineno-34-4\" name=\"__codelineno-34-4\" href=\"#__codelineno-34-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-5\"><a id=\"__codelineno-34-5\" name=\"__codelineno-34-5\" href=\"#__codelineno-34-5\"></a>| bk = C   |  | fd = B          |  | fd = C          |  | fd = bins[id]   |\n</span><span id=\"__span-34-6\"><a id=\"__codelineno-34-6\" name=\"__codelineno-34-6\" href=\"#__codelineno-34-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-7\"><a id=\"__codelineno-34-7\" name=\"__codelineno-34-7\" href=\"#__codelineno-34-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |\n</span><span id=\"__span-34-8\"><a id=\"__codelineno-34-8\" name=\"__codelineno-34-8\" href=\"#__codelineno-34-8\"></a>              +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-34-9\"><a id=\"__codelineno-34-9\" name=\"__codelineno-34-9\" href=\"#__codelineno-34-9\"></a>              | fd_nextsize = C |                       | fd_nextsize = A |\n</span><span id=\"__span-34-10\"><a id=\"__codelineno-34-10\" name=\"__codelineno-34-10\" href=\"#__codelineno-34-10\"></a>              +-----------------+                       +-----------------+\n</span><span id=\"__span-34-11\"><a id=\"__codelineno-34-11\" name=\"__codelineno-34-11\" href=\"#__codelineno-34-11\"></a>              | bk_nextsize = C |                       | bk_nextsize = A |\n</span><span id=\"__span-34-12\"><a id=\"__codelineno-34-12\" name=\"__codelineno-34-12\" href=\"#__codelineno-34-12\"></a>              +-----------------+                       +-----------------+\n</span></code></pre></div>\n<p>\u5373\u6240\u6709\u7684\u7a7a\u95f2\u5757\u52a0\u54e8\u5175\u7ec4\u6210\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u4ece\u5927\u5230\u5c0f\u6309\u7167 <code>A -&gt; B -&gt; C</code> \u7684\u987a\u5e8f\u8fde\u63a5\uff1b\u7136\u540e\u6bcf\u79cd\u5927\u5c0f\u7684\u7b2c\u4e00\u4e2a\u5757 <code>A</code> \u548c <code>C</code> \u5355\u72ec\u5728\u4e00\u4e2a nextsize \u94fe\u8868\u5f53\u4e2d\u3002</p>\n<p>\u56e0\u6b64\u5728\u63d2\u5165 large bin \u7684\u65f6\u5019\uff0c\u5206\u5982\u4e0b\u51e0\u79cd\u60c5\u51b5\uff1a</p>\n<p>\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u5982\u679c\u65b0\u63d2\u5165\u7684\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u6bd4\u76ee\u524d\u5df2\u6709\u7a7a\u95f2\u5757\u90fd\u5c0f\uff0c\u5219\u76f4\u63a5\u63d2\u5165\u5230\u7a7a\u95f2\u5757\u548c nextsize \u94fe\u8868\u7684\u5c3e\u90e8\u3002\u4f8b\u5982\u8981\u63d2\u5165\u4e00\u4e2a <code>size = 1024</code> \u7684\u7a7a\u95f2\u5757 D\uff0c\u63d2\u5165\u540e\u72b6\u6001\u4e3a\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-35-1\"><a id=\"__codelineno-35-1\" name=\"__codelineno-35-1\" href=\"#__codelineno-35-1\"></a>  bins[id]      chunk A              chunk B              chunk C              chunk D          \n</span><span id=\"__span-35-2\"><a id=\"__codelineno-35-2\" name=\"__codelineno-35-2\" href=\"#__codelineno-35-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-3\"><a id=\"__codelineno-35-3\" name=\"__codelineno-35-3\" href=\"#__codelineno-35-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1040     |  | size = 1024     |\n</span><span id=\"__span-35-4\"><a id=\"__codelineno-35-4\" name=\"__codelineno-35-4\" href=\"#__codelineno-35-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-5\"><a id=\"__codelineno-35-5\" name=\"__codelineno-35-5\" href=\"#__codelineno-35-5\"></a>| bk = D   |  | fd = B          |  | fd = C          |  | fd = D          |  | fd = bins[id]   |\n</span><span id=\"__span-35-6\"><a id=\"__codelineno-35-6\" name=\"__codelineno-35-6\" href=\"#__codelineno-35-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-7\"><a id=\"__codelineno-35-7\" name=\"__codelineno-35-7\" href=\"#__codelineno-35-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |  | bk = C          |\n</span><span id=\"__span-35-8\"><a id=\"__codelineno-35-8\" name=\"__codelineno-35-8\" href=\"#__codelineno-35-8\"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-35-9\"><a id=\"__codelineno-35-9\" name=\"__codelineno-35-9\" href=\"#__codelineno-35-9\"></a>              | fd_nextsize = C |                       | fd_nextsize = D |  | fd_nextsize = A |\n</span><span id=\"__span-35-10\"><a id=\"__codelineno-35-10\" name=\"__codelineno-35-10\" href=\"#__codelineno-35-10\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span><span id=\"__span-35-11\"><a id=\"__codelineno-35-11\" name=\"__codelineno-35-11\" href=\"#__codelineno-35-11\"></a>              | bk_nextsize = D |                       | bk_nextsize = A |  | bk_nextsize = C |\n</span><span id=\"__span-35-12\"><a id=\"__codelineno-35-12\" name=\"__codelineno-35-12\" href=\"#__codelineno-35-12\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span></code></pre></div>\n<p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u5728\u904d\u5386 nextsize \u94fe\u8868\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u5df2\u7ecf\u6709\u5927\u5c0f\u76f8\u540c\u7684\u5757\uff0c\u90a3\u5c31\u628a\u65b0\u7684\u5757\u63d2\u5165\u5230\u5b83\u7684\u540e\u9762\u3002\u4f8b\u5982\u8981\u63d2\u5165\u4e00\u4e2a <code>size = 1072</code> \u7684\u7a7a\u95f2\u5757 D\uff0c\u901a\u8fc7\u904d\u5386 nextsize \u94fe\u8868\u627e\u5230\u4e86 A\uff0c\u63d2\u5165\u4e4b\u540e\u7684\u72b6\u6001\u4e3a\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-36-1\"><a id=\"__codelineno-36-1\" name=\"__codelineno-36-1\" href=\"#__codelineno-36-1\"></a>  bins[id]      chunk A              chunk D              chunk B              chunk C          \n</span><span id=\"__span-36-2\"><a id=\"__codelineno-36-2\" name=\"__codelineno-36-2\" href=\"#__codelineno-36-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-3\"><a id=\"__codelineno-36-3\" name=\"__codelineno-36-3\" href=\"#__codelineno-36-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1072     |  | size = 1040     |\n</span><span id=\"__span-36-4\"><a id=\"__codelineno-36-4\" name=\"__codelineno-36-4\" href=\"#__codelineno-36-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-5\"><a id=\"__codelineno-36-5\" name=\"__codelineno-36-5\" href=\"#__codelineno-36-5\"></a>| bk = C   |  | fd = D          |  | fd = B          |  | fd = C          |  | fd = bins[id]   |\n</span><span id=\"__span-36-6\"><a id=\"__codelineno-36-6\" name=\"__codelineno-36-6\" href=\"#__codelineno-36-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-7\"><a id=\"__codelineno-36-7\" name=\"__codelineno-36-7\" href=\"#__codelineno-36-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = D          |  | bk = C          |\n</span><span id=\"__span-36-8\"><a id=\"__codelineno-36-8\" name=\"__codelineno-36-8\" href=\"#__codelineno-36-8\"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-36-9\"><a id=\"__codelineno-36-9\" name=\"__codelineno-36-9\" href=\"#__codelineno-36-9\"></a>              | fd_nextsize = C |                                            | fd_nextsize = A |\n</span><span id=\"__span-36-10\"><a id=\"__codelineno-36-10\" name=\"__codelineno-36-10\" href=\"#__codelineno-36-10\"></a>              +-----------------+                                            +-----------------+\n</span><span id=\"__span-36-11\"><a id=\"__codelineno-36-11\" name=\"__codelineno-36-11\" href=\"#__codelineno-36-11\"></a>              | bk_nextsize = C |                                            | bk_nextsize = A |\n</span><span id=\"__span-36-12\"><a id=\"__codelineno-36-12\" name=\"__codelineno-36-12\" href=\"#__codelineno-36-12\"></a>              +-----------------+                                            +-----------------+\n</span></code></pre></div>\n<p>\u7b2c\u4e09\u79cd\u60c5\u51b5\uff0c\u5728\u904d\u5386 nextsize \u94fe\u8868\u8fc7\u7a0b\u4e2d\uff0c\u6ca1\u6709\u5927\u5c0f\u76f8\u540c\u7684\u5757\uff0c\u90a3\u5c31\u6309\u7167\u4ece\u5927\u5230\u5c0f\u7684\u987a\u5e8f\u63d2\u5165\u5230\u5408\u9002\u7684\u4f4d\u7f6e\u3002\u4f8b\u5982\u8981\u63d2\u5165\u4e00\u4e2a <code>size = 1056</code> \u7684\u7a7a\u95f2\u5757 D\uff0c\u901a\u8fc7\u904d\u5386 nextsize \u94fe\u8868\u627e\u5230\u4e86 A \u548c C\uff0c\u63d2\u5165\u4e4b\u540e\u7684\u72b6\u6001\u4e3a\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-37-1\"><a id=\"__codelineno-37-1\" name=\"__codelineno-37-1\" href=\"#__codelineno-37-1\"></a>  bins[id]      chunk A              chunk B              chunk D              chunk C          \n</span><span id=\"__span-37-2\"><a id=\"__codelineno-37-2\" name=\"__codelineno-37-2\" href=\"#__codelineno-37-2\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-3\"><a id=\"__codelineno-37-3\" name=\"__codelineno-37-3\" href=\"#__codelineno-37-3\"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1056     |  | size = 1040     |\n</span><span id=\"__span-37-4\"><a id=\"__codelineno-37-4\" name=\"__codelineno-37-4\" href=\"#__codelineno-37-4\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-5\"><a id=\"__codelineno-37-5\" name=\"__codelineno-37-5\" href=\"#__codelineno-37-5\"></a>| bk = D   |  | fd = B          |  | fd = D          |  | fd = C          |  | fd = bins[id]   |\n</span><span id=\"__span-37-6\"><a id=\"__codelineno-37-6\" name=\"__codelineno-37-6\" href=\"#__codelineno-37-6\"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-7\"><a id=\"__codelineno-37-7\" name=\"__codelineno-37-7\" href=\"#__codelineno-37-7\"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |  | bk = D          |\n</span><span id=\"__span-37-8\"><a id=\"__codelineno-37-8\" name=\"__codelineno-37-8\" href=\"#__codelineno-37-8\"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+\n</span><span id=\"__span-37-9\"><a id=\"__codelineno-37-9\" name=\"__codelineno-37-9\" href=\"#__codelineno-37-9\"></a>              | fd_nextsize = D |                       | fd_nextsize = C |  | fd_nextsize = A |\n</span><span id=\"__span-37-10\"><a id=\"__codelineno-37-10\" name=\"__codelineno-37-10\" href=\"#__codelineno-37-10\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span><span id=\"__span-37-11\"><a id=\"__codelineno-37-11\" name=\"__codelineno-37-11\" href=\"#__codelineno-37-11\"></a>              | bk_nextsize = C |                       | bk_nextsize = A |  | bk_nextsize = D |\n</span><span id=\"__span-37-12\"><a id=\"__codelineno-37-12\" name=\"__codelineno-37-12\" href=\"#__codelineno-37-12\"></a>              +-----------------+                       +-----------------+  +-----------------+\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u4fdd\u8bc1\u4e86\u63d2\u5165\u4ee5\u540e\u7684 large bin\uff0c\u4f9d\u7136\u6ee1\u8db3\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\uff0c\u5e76\u4e14\u6bcf\u79cd\u5927\u5c0f\u7684\u7b2c\u4e00\u4e2a\u5757\u7ec4\u6210 nextsize \u94fe\u8868\u7684\u6027\u8d28\u3002</p>\n<h3 id=\"malloc_4\">malloc<a class=\"headerlink\" href=\"#malloc_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u7740\u56de\u5230 <code>_libc_malloc</code>\u3002\u524d\u9762\u63d0\u5230\uff0cunsorted bin \u4e2d\u7a7a\u95f2\u5757\u5df2\u7ecf\u88ab\u632a\u5230\u4e86 small bin \u6216\u8005 large bin\uff0c\u5e76\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u628a\u5408\u9002\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u76f4\u63a5\u5206\u914d\u3002\u5982\u679c\u8fd8\u662f\u6ca1\u6709\u5206\u914d\u6210\u529f\uff0c\u63a5\u4e0b\u6765\u5c31\u8981\u5728 large bin \u91cc\u5bfb\u627e\u4e00\u4e2a\u5757\u6765\u5206\u914d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-38-1\"><a id=\"__codelineno-38-1\" name=\"__codelineno-38-1\" href=\"#__codelineno-38-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-2\"><a id=\"__codelineno-38-2\" name=\"__codelineno-38-2\" href=\"#__codelineno-38-2\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-3\"><a id=\"__codelineno-38-3\" name=\"__codelineno-38-3\" href=\"#__codelineno-38-3\"></a><span class=\"w\">    </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-4\"><a id=\"__codelineno-38-4\" name=\"__codelineno-38-4\" href=\"#__codelineno-38-4\"></a>\n</span><span id=\"__span-38-5\"><a id=\"__codelineno-38-5\" name=\"__codelineno-38-5\" href=\"#__codelineno-38-5\"></a><span class=\"w\">    </span><span class=\"cm\">/* skip scan if empty or largest chunk is too small */</span>\n</span><span id=\"__span-38-6\"><a id=\"__codelineno-38-6\" name=\"__codelineno-38-6\" href=\"#__codelineno-38-6\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bin</span>\n</span><span id=\"__span-38-7\"><a id=\"__codelineno-38-7\" name=\"__codelineno-38-7\" href=\"#__codelineno-38-7\"></a><span class=\"w\">        </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-8\"><a id=\"__codelineno-38-8\" name=\"__codelineno-38-8\" href=\"#__codelineno-38-8\"></a><span class=\"w\">          </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-9\"><a id=\"__codelineno-38-9\" name=\"__codelineno-38-9\" href=\"#__codelineno-38-9\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-10\"><a id=\"__codelineno-38-10\" name=\"__codelineno-38-10\" href=\"#__codelineno-38-10\"></a><span class=\"w\">        </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-11\"><a id=\"__codelineno-38-11\" name=\"__codelineno-38-11\" href=\"#__codelineno-38-11\"></a><span class=\"w\">        </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">&lt;</span>\n</span><span id=\"__span-38-12\"><a id=\"__codelineno-38-12\" name=\"__codelineno-38-12\" href=\"#__codelineno-38-12\"></a><span class=\"w\">                </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">)))</span>\n</span><span id=\"__span-38-13\"><a id=\"__codelineno-38-13\" name=\"__codelineno-38-13\" href=\"#__codelineno-38-13\"></a><span class=\"w\">          </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-14\"><a id=\"__codelineno-38-14\" name=\"__codelineno-38-14\" href=\"#__codelineno-38-14\"></a>\n</span><span id=\"__span-38-15\"><a id=\"__codelineno-38-15\" name=\"__codelineno-38-15\" href=\"#__codelineno-38-15\"></a><span class=\"w\">        </span><span class=\"cm\">/* Avoid removing the first entry for a size so that the skip</span>\n</span><span id=\"__span-38-16\"><a id=\"__codelineno-38-16\" name=\"__codelineno-38-16\" href=\"#__codelineno-38-16\"></a><span class=\"cm\">           list does not have to be rerouted.  */</span>\n</span><span id=\"__span-38-17\"><a id=\"__codelineno-38-17\" name=\"__codelineno-38-17\" href=\"#__codelineno-38-17\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-18\"><a id=\"__codelineno-38-18\" name=\"__codelineno-38-18\" href=\"#__codelineno-38-18\"></a><span class=\"w\">            </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-19\"><a id=\"__codelineno-38-19\" name=\"__codelineno-38-19\" href=\"#__codelineno-38-19\"></a><span class=\"w\">              </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">chunksize_nomask</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-20\"><a id=\"__codelineno-38-20\" name=\"__codelineno-38-20\" href=\"#__codelineno-38-20\"></a><span class=\"w\">          </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-21\"><a id=\"__codelineno-38-21\" name=\"__codelineno-38-21\" href=\"#__codelineno-38-21\"></a>\n</span><span id=\"__span-38-22\"><a id=\"__codelineno-38-22\" name=\"__codelineno-38-22\" href=\"#__codelineno-38-22\"></a><span class=\"w\">        </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-23\"><a id=\"__codelineno-38-23\" name=\"__codelineno-38-23\" href=\"#__codelineno-38-23\"></a><span class=\"w\">        </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-24\"><a id=\"__codelineno-38-24\" name=\"__codelineno-38-24\" href=\"#__codelineno-38-24\"></a>\n</span><span id=\"__span-38-25\"><a id=\"__codelineno-38-25\" name=\"__codelineno-38-25\" href=\"#__codelineno-38-25\"></a><span class=\"w\">        </span><span class=\"cm\">/* Exhaust */</span>\n</span><span id=\"__span-38-26\"><a id=\"__codelineno-38-26\" name=\"__codelineno-38-26\" href=\"#__codelineno-38-26\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-27\"><a id=\"__codelineno-38-27\" name=\"__codelineno-38-27\" href=\"#__codelineno-38-27\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-28\"><a id=\"__codelineno-38-28\" name=\"__codelineno-38-28\" href=\"#__codelineno-38-28\"></a><span class=\"w\">            </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-29\"><a id=\"__codelineno-38-29\" name=\"__codelineno-38-29\" href=\"#__codelineno-38-29\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-38-30\"><a id=\"__codelineno-38-30\" name=\"__codelineno-38-30\" href=\"#__codelineno-38-30\"></a><span class=\"w\">              </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-31\"><a id=\"__codelineno-38-31\" name=\"__codelineno-38-31\" href=\"#__codelineno-38-31\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-32\"><a id=\"__codelineno-38-32\" name=\"__codelineno-38-32\" href=\"#__codelineno-38-32\"></a><span class=\"w\">        </span><span class=\"cm\">/* Split */</span>\n</span><span id=\"__span-38-33\"><a id=\"__codelineno-38-33\" name=\"__codelineno-38-33\" href=\"#__codelineno-38-33\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-38-34\"><a id=\"__codelineno-38-34\" name=\"__codelineno-38-34\" href=\"#__codelineno-38-34\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-35\"><a id=\"__codelineno-38-35\" name=\"__codelineno-38-35\" href=\"#__codelineno-38-35\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-36\"><a id=\"__codelineno-38-36\" name=\"__codelineno-38-36\" href=\"#__codelineno-38-36\"></a><span class=\"w\">            </span><span class=\"cm\">/* We cannot assume the unsorted list is empty and therefore</span>\n</span><span id=\"__span-38-37\"><a id=\"__codelineno-38-37\" name=\"__codelineno-38-37\" href=\"#__codelineno-38-37\"></a><span class=\"cm\">               have to perform a complete insert here.  */</span>\n</span><span id=\"__span-38-38\"><a id=\"__codelineno-38-38\" name=\"__codelineno-38-38\" href=\"#__codelineno-38-38\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-39\"><a id=\"__codelineno-38-39\" name=\"__codelineno-38-39\" href=\"#__codelineno-38-39\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-40\"><a id=\"__codelineno-38-40\" name=\"__codelineno-38-40\" href=\"#__codelineno-38-40\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-41\"><a id=\"__codelineno-38-41\" name=\"__codelineno-38-41\" href=\"#__codelineno-38-41\"></a><span class=\"w\">              </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): corrupted unsorted chunks&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-42\"><a id=\"__codelineno-38-42\" name=\"__codelineno-38-42\" href=\"#__codelineno-38-42\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-43\"><a id=\"__codelineno-38-43\" name=\"__codelineno-38-43\" href=\"#__codelineno-38-43\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-44\"><a id=\"__codelineno-38-44\" name=\"__codelineno-38-44\" href=\"#__codelineno-38-44\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-45\"><a id=\"__codelineno-38-45\" name=\"__codelineno-38-45\" href=\"#__codelineno-38-45\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-46\"><a id=\"__codelineno-38-46\" name=\"__codelineno-38-46\" href=\"#__codelineno-38-46\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"p\">))</span>\n</span><span id=\"__span-38-47\"><a id=\"__codelineno-38-47\" name=\"__codelineno-38-47\" href=\"#__codelineno-38-47\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-38-48\"><a id=\"__codelineno-38-48\" name=\"__codelineno-38-48\" href=\"#__codelineno-38-48\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-49\"><a id=\"__codelineno-38-49\" name=\"__codelineno-38-49\" href=\"#__codelineno-38-49\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-50\"><a id=\"__codelineno-38-50\" name=\"__codelineno-38-50\" href=\"#__codelineno-38-50\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-51\"><a id=\"__codelineno-38-51\" name=\"__codelineno-38-51\" href=\"#__codelineno-38-51\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-38-52\"><a id=\"__codelineno-38-52\" name=\"__codelineno-38-52\" href=\"#__codelineno-38-52\"></a><span class=\"w\">                      </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-38-53\"><a id=\"__codelineno-38-53\" name=\"__codelineno-38-53\" href=\"#__codelineno-38-53\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-54\"><a id=\"__codelineno-38-54\" name=\"__codelineno-38-54\" href=\"#__codelineno-38-54\"></a><span class=\"w\">            </span><span class=\"n\">set_foot</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-55\"><a id=\"__codelineno-38-55\" name=\"__codelineno-38-55\" href=\"#__codelineno-38-55\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-56\"><a id=\"__codelineno-38-56\" name=\"__codelineno-38-56\" href=\"#__codelineno-38-56\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-57\"><a id=\"__codelineno-38-57\" name=\"__codelineno-38-57\" href=\"#__codelineno-38-57\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-58\"><a id=\"__codelineno-38-58\" name=\"__codelineno-38-58\" href=\"#__codelineno-38-58\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-38-59\"><a id=\"__codelineno-38-59\" name=\"__codelineno-38-59\" href=\"#__codelineno-38-59\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-38-60\"><a id=\"__codelineno-38-60\" name=\"__codelineno-38-60\" href=\"#__codelineno-38-60\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-38-61\"><a id=\"__codelineno-38-61\" name=\"__codelineno-38-61\" href=\"#__codelineno-38-61\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4ece large bin \u5206\u914d\u7a7a\u95f2\u5757\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u6839\u636e\u5927\u5c0f\u627e\u5230\u5bf9\u5e94\u7684 large bin</li>\n<li>\u5982\u679c large bin \u4e2d\u6700\u5927\u7684\u7a7a\u95f2\u5757\u8db3\u591f\u5927\uff0c\u904d\u5386 nextsize \u94fe\u8868\uff0c\u627e\u5230\u4e00\u4e2a\u6bd4\u8981\u5206\u914d\u7684\u5927\u5c0f\u66f4\u5927\u7684\u6700\u5c0f\u7684\u7a7a\u95f2\u5757</li>\n<li>\u4e3a\u4e86\u907f\u514d\u66f4\u65b0 nextsize \u94fe\u8868\uff0c\u5982\u679c\u5f53\u524d\u5757\u5927\u5c0f\u5bf9\u5e94\u4e86\u4e0d\u6b62\u4e00\u4e2a\u7a7a\u95f2\u5757\uff0c\u90a3\u5c31\u53d6\u7b2c\u4e8c\u4e2a\u7a7a\u95f2\u5757\uff0c\u8fd9\u6837\u5c31\u4e0d\u7528\u66f4\u65b0 nextsize \u94fe\u8868</li>\n<li>\u8ba1\u7b97\u7a7a\u95f2\u5757\u5927\u5c0f\u548c\u8981\u5206\u914d\u7684\u5927\u5c0f\u7684\u5dee\u503c\uff0c\u5982\u679c\u5dee\u503c\u592a\u5c0f\uff0c\u591a\u4f59\u7684\u90e8\u5206\u5c31\u76f4\u63a5\u6d6a\u8d39\uff1b\u5982\u679c\u5dee\u7684\u7a7a\u95f4\u8fd8\u80fd\u653e\u4e0b\u4e00\u4e2a chunk\uff0c\u5c31\u8fdb\u884c\u62c6\u5206\uff0c\u628a\u62c6\u51fa\u6765\u7684\u5269\u4e0b\u7684\u90e8\u5206\u653e\u5230 unsorted bin \u4e2d</li>\n<li>\u8ba1\u7b97 payload \u5730\u5740\uff0c\u8fdb\u884c\u53ef\u9009\u7684 perturb\uff0c\u5b8c\u6210\u5206\u914d</li>\n</ol>\n<h2 id=\"\u5bfb\u627e\u66f4\u5927\u7684-bin\">\u5bfb\u627e\u66f4\u5927\u7684 bin<a class=\"headerlink\" href=\"#\u5bfb\u627e\u66f4\u5927\u7684-bin\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5982\u679c\u5728\u5f53\u524d bin \u5185\u8fd8\u662f\u627e\u4e0d\u5230\u7a7a\u95f2\u5757\uff0c\u90a3\u5c31\u53ea\u80fd\u4ece\u66f4\u5927\u7684 bin \u91cc\u5bfb\u627e\u7a7a\u95f2\u5757\u4e86\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-39-1\"><a id=\"__codelineno-39-1\" name=\"__codelineno-39-1\" href=\"#__codelineno-39-1\"></a><span class=\"o\">++</span><span class=\"n\">idx</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-2\"><a id=\"__codelineno-39-2\" name=\"__codelineno-39-2\" href=\"#__codelineno-39-2\"></a><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-3\"><a id=\"__codelineno-39-3\" name=\"__codelineno-39-3\" href=\"#__codelineno-39-3\"></a><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">idx2block</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-4\"><a id=\"__codelineno-39-4\" name=\"__codelineno-39-4\" href=\"#__codelineno-39-4\"></a><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">block</span><span class=\"p\">];</span>\n</span><span id=\"__span-39-5\"><a id=\"__codelineno-39-5\" name=\"__codelineno-39-5\" href=\"#__codelineno-39-5\"></a><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">idx2bit</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">idx</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-6\"><a id=\"__codelineno-39-6\" name=\"__codelineno-39-6\" href=\"#__codelineno-39-6\"></a>\n</span><span id=\"__span-39-7\"><a id=\"__codelineno-39-7\" name=\"__codelineno-39-7\" href=\"#__codelineno-39-7\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(;;</span><span class=\"w\"> </span><span class=\"p\">)</span>\n</span><span id=\"__span-39-8\"><a id=\"__codelineno-39-8\" name=\"__codelineno-39-8\" href=\"#__codelineno-39-8\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-9\"><a id=\"__codelineno-39-9\" name=\"__codelineno-39-9\" href=\"#__codelineno-39-9\"></a><span class=\"w\">    </span><span class=\"cm\">/* Skip rest of block if there are no more set bits in this block.  */</span>\n</span><span id=\"__span-39-10\"><a id=\"__codelineno-39-10\" name=\"__codelineno-39-10\" href=\"#__codelineno-39-10\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-11\"><a id=\"__codelineno-39-11\" name=\"__codelineno-39-11\" href=\"#__codelineno-39-11\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-12\"><a id=\"__codelineno-39-12\" name=\"__codelineno-39-12\" href=\"#__codelineno-39-12\"></a><span class=\"w\">        </span><span class=\"k\">do</span>\n</span><span id=\"__span-39-13\"><a id=\"__codelineno-39-13\" name=\"__codelineno-39-13\" href=\"#__codelineno-39-13\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-14\"><a id=\"__codelineno-39-14\" name=\"__codelineno-39-14\" href=\"#__codelineno-39-14\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">++</span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">BINMAPSIZE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"cm\">/* out of bins */</span>\n</span><span id=\"__span-39-15\"><a id=\"__codelineno-39-15\" name=\"__codelineno-39-15\" href=\"#__codelineno-39-15\"></a><span class=\"w\">              </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">use_top</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-16\"><a id=\"__codelineno-39-16\" name=\"__codelineno-39-16\" href=\"#__codelineno-39-16\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-17\"><a id=\"__codelineno-39-17\" name=\"__codelineno-39-17\" href=\"#__codelineno-39-17\"></a><span class=\"w\">        </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">block</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-18\"><a id=\"__codelineno-39-18\" name=\"__codelineno-39-18\" href=\"#__codelineno-39-18\"></a>\n</span><span id=\"__span-39-19\"><a id=\"__codelineno-39-19\" name=\"__codelineno-39-19\" href=\"#__codelineno-39-19\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bin_at</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">BINMAPSHIFT</span><span class=\"p\">));</span>\n</span><span id=\"__span-39-20\"><a id=\"__codelineno-39-20\" name=\"__codelineno-39-20\" href=\"#__codelineno-39-20\"></a><span class=\"w\">        </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-21\"><a id=\"__codelineno-39-21\" name=\"__codelineno-39-21\" href=\"#__codelineno-39-21\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-22\"><a id=\"__codelineno-39-22\" name=\"__codelineno-39-22\" href=\"#__codelineno-39-22\"></a>\n</span><span id=\"__span-39-23\"><a id=\"__codelineno-39-23\" name=\"__codelineno-39-23\" href=\"#__codelineno-39-23\"></a><span class=\"w\">    </span><span class=\"cm\">/* Advance to bin with set bit. There must be one. */</span>\n</span><span id=\"__span-39-24\"><a id=\"__codelineno-39-24\" name=\"__codelineno-39-24\" href=\"#__codelineno-39-24\"></a><span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-25\"><a id=\"__codelineno-39-25\" name=\"__codelineno-39-25\" href=\"#__codelineno-39-25\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-26\"><a id=\"__codelineno-39-26\" name=\"__codelineno-39-26\" href=\"#__codelineno-39-26\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">next_bin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-27\"><a id=\"__codelineno-39-27\" name=\"__codelineno-39-27\" href=\"#__codelineno-39-27\"></a><span class=\"w\">        </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-28\"><a id=\"__codelineno-39-28\" name=\"__codelineno-39-28\" href=\"#__codelineno-39-28\"></a><span class=\"w\">        </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-29\"><a id=\"__codelineno-39-29\" name=\"__codelineno-39-29\" href=\"#__codelineno-39-29\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-30\"><a id=\"__codelineno-39-30\" name=\"__codelineno-39-30\" href=\"#__codelineno-39-30\"></a>\n</span><span id=\"__span-39-31\"><a id=\"__codelineno-39-31\" name=\"__codelineno-39-31\" href=\"#__codelineno-39-31\"></a><span class=\"w\">    </span><span class=\"cm\">/* Inspect the bin. It is likely to be non-empty */</span>\n</span><span id=\"__span-39-32\"><a id=\"__codelineno-39-32\" name=\"__codelineno-39-32\" href=\"#__codelineno-39-32\"></a><span class=\"w\">    </span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-33\"><a id=\"__codelineno-39-33\" name=\"__codelineno-39-33\" href=\"#__codelineno-39-33\"></a>\n</span><span id=\"__span-39-34\"><a id=\"__codelineno-39-34\" name=\"__codelineno-39-34\" href=\"#__codelineno-39-34\"></a><span class=\"w\">    </span><span class=\"cm\">/*  If a false alarm (empty bin), clear the bit. */</span>\n</span><span id=\"__span-39-35\"><a id=\"__codelineno-39-35\" name=\"__codelineno-39-35\" href=\"#__codelineno-39-35\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-36\"><a id=\"__codelineno-39-36\" name=\"__codelineno-39-36\" href=\"#__codelineno-39-36\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-37\"><a id=\"__codelineno-39-37\" name=\"__codelineno-39-37\" href=\"#__codelineno-39-37\"></a><span class=\"w\">        </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">block</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">&amp;=</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"n\">bit</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Write through */</span>\n</span><span id=\"__span-39-38\"><a id=\"__codelineno-39-38\" name=\"__codelineno-39-38\" href=\"#__codelineno-39-38\"></a><span class=\"w\">        </span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">next_bin</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-39\"><a id=\"__codelineno-39-39\" name=\"__codelineno-39-39\" href=\"#__codelineno-39-39\"></a><span class=\"w\">        </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-40\"><a id=\"__codelineno-39-40\" name=\"__codelineno-39-40\" href=\"#__codelineno-39-40\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-41\"><a id=\"__codelineno-39-41\" name=\"__codelineno-39-41\" href=\"#__codelineno-39-41\"></a>\n</span><span id=\"__span-39-42\"><a id=\"__codelineno-39-42\" name=\"__codelineno-39-42\" href=\"#__codelineno-39-42\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-39-43\"><a id=\"__codelineno-39-43\" name=\"__codelineno-39-43\" href=\"#__codelineno-39-43\"></a><span class=\"w\">      </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-44\"><a id=\"__codelineno-39-44\" name=\"__codelineno-39-44\" href=\"#__codelineno-39-44\"></a><span class=\"w\">        </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-45\"><a id=\"__codelineno-39-45\" name=\"__codelineno-39-45\" href=\"#__codelineno-39-45\"></a>\n</span><span id=\"__span-39-46\"><a id=\"__codelineno-39-46\" name=\"__codelineno-39-46\" href=\"#__codelineno-39-46\"></a><span class=\"w\">        </span><span class=\"cm\">/*  We know the first chunk in this bin is big enough to use. */</span>\n</span><span id=\"__span-39-47\"><a id=\"__codelineno-39-47\" name=\"__codelineno-39-47\" href=\"#__codelineno-39-47\"></a><span class=\"w\">        </span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">));</span>\n</span><span id=\"__span-39-48\"><a id=\"__codelineno-39-48\" name=\"__codelineno-39-48\" href=\"#__codelineno-39-48\"></a>\n</span><span id=\"__span-39-49\"><a id=\"__codelineno-39-49\" name=\"__codelineno-39-49\" href=\"#__codelineno-39-49\"></a><span class=\"w\">        </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-50\"><a id=\"__codelineno-39-50\" name=\"__codelineno-39-50\" href=\"#__codelineno-39-50\"></a>\n</span><span id=\"__span-39-51\"><a id=\"__codelineno-39-51\" name=\"__codelineno-39-51\" href=\"#__codelineno-39-51\"></a><span class=\"w\">        </span><span class=\"cm\">/* unlink */</span>\n</span><span id=\"__span-39-52\"><a id=\"__codelineno-39-52\" name=\"__codelineno-39-52\" href=\"#__codelineno-39-52\"></a><span class=\"w\">        </span><span class=\"n\">unlink_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-53\"><a id=\"__codelineno-39-53\" name=\"__codelineno-39-53\" href=\"#__codelineno-39-53\"></a>\n</span><span id=\"__span-39-54\"><a id=\"__codelineno-39-54\" name=\"__codelineno-39-54\" href=\"#__codelineno-39-54\"></a><span class=\"w\">        </span><span class=\"cm\">/* Exhaust */</span>\n</span><span id=\"__span-39-55\"><a id=\"__codelineno-39-55\" name=\"__codelineno-39-55\" href=\"#__codelineno-39-55\"></a><span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-56\"><a id=\"__codelineno-39-56\" name=\"__codelineno-39-56\" href=\"#__codelineno-39-56\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-57\"><a id=\"__codelineno-39-57\" name=\"__codelineno-39-57\" href=\"#__codelineno-39-57\"></a><span class=\"w\">            </span><span class=\"n\">set_inuse_bit_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-58\"><a id=\"__codelineno-39-58\" name=\"__codelineno-39-58\" href=\"#__codelineno-39-58\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"p\">)</span>\n</span><span id=\"__span-39-59\"><a id=\"__codelineno-39-59\" name=\"__codelineno-39-59\" href=\"#__codelineno-39-59\"></a><span class=\"w\">              </span><span class=\"n\">set_non_main_arena</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-60\"><a id=\"__codelineno-39-60\" name=\"__codelineno-39-60\" href=\"#__codelineno-39-60\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-61\"><a id=\"__codelineno-39-61\" name=\"__codelineno-39-61\" href=\"#__codelineno-39-61\"></a>\n</span><span id=\"__span-39-62\"><a id=\"__codelineno-39-62\" name=\"__codelineno-39-62\" href=\"#__codelineno-39-62\"></a><span class=\"w\">        </span><span class=\"cm\">/* Split */</span>\n</span><span id=\"__span-39-63\"><a id=\"__codelineno-39-63\" name=\"__codelineno-39-63\" href=\"#__codelineno-39-63\"></a><span class=\"w\">        </span><span class=\"k\">else</span>\n</span><span id=\"__span-39-64\"><a id=\"__codelineno-39-64\" name=\"__codelineno-39-64\" href=\"#__codelineno-39-64\"></a><span class=\"w\">          </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-65\"><a id=\"__codelineno-39-65\" name=\"__codelineno-39-65\" href=\"#__codelineno-39-65\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-66\"><a id=\"__codelineno-39-66\" name=\"__codelineno-39-66\" href=\"#__codelineno-39-66\"></a>\n</span><span id=\"__span-39-67\"><a id=\"__codelineno-39-67\" name=\"__codelineno-39-67\" href=\"#__codelineno-39-67\"></a><span class=\"w\">            </span><span class=\"cm\">/* We cannot assume the unsorted list is empty and therefore</span>\n</span><span id=\"__span-39-68\"><a id=\"__codelineno-39-68\" name=\"__codelineno-39-68\" href=\"#__codelineno-39-68\"></a><span class=\"cm\">               have to perform a complete insert here.  */</span>\n</span><span id=\"__span-39-69\"><a id=\"__codelineno-39-69\" name=\"__codelineno-39-69\" href=\"#__codelineno-39-69\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsorted_chunks</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-70\"><a id=\"__codelineno-39-70\" name=\"__codelineno-39-70\" href=\"#__codelineno-39-70\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-71\"><a id=\"__codelineno-39-71\" name=\"__codelineno-39-71\" href=\"#__codelineno-39-71\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">))</span>\n</span><span id=\"__span-39-72\"><a id=\"__codelineno-39-72\" name=\"__codelineno-39-72\" href=\"#__codelineno-39-72\"></a><span class=\"w\">              </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): corrupted unsorted chunks 2&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-73\"><a id=\"__codelineno-39-73\" name=\"__codelineno-39-73\" href=\"#__codelineno-39-73\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bck</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-74\"><a id=\"__codelineno-39-74\" name=\"__codelineno-39-74\" href=\"#__codelineno-39-74\"></a><span class=\"w\">            </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-75\"><a id=\"__codelineno-39-75\" name=\"__codelineno-39-75\" href=\"#__codelineno-39-75\"></a><span class=\"w\">            </span><span class=\"n\">bck</span><span class=\"o\">-&gt;</span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-76\"><a id=\"__codelineno-39-76\" name=\"__codelineno-39-76\" href=\"#__codelineno-39-76\"></a><span class=\"w\">            </span><span class=\"n\">fwd</span><span class=\"o\">-&gt;</span><span class=\"n\">bk</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-77\"><a id=\"__codelineno-39-77\" name=\"__codelineno-39-77\" href=\"#__codelineno-39-77\"></a>\n</span><span id=\"__span-39-78\"><a id=\"__codelineno-39-78\" name=\"__codelineno-39-78\" href=\"#__codelineno-39-78\"></a><span class=\"w\">            </span><span class=\"cm\">/* advertise as last remainder */</span>\n</span><span id=\"__span-39-79\"><a id=\"__codelineno-39-79\" name=\"__codelineno-39-79\" href=\"#__codelineno-39-79\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-39-80\"><a id=\"__codelineno-39-80\" name=\"__codelineno-39-80\" href=\"#__codelineno-39-80\"></a><span class=\"w\">              </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">last_remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-81\"><a id=\"__codelineno-39-81\" name=\"__codelineno-39-81\" href=\"#__codelineno-39-81\"></a><span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder_size</span><span class=\"p\">))</span>\n</span><span id=\"__span-39-82\"><a id=\"__codelineno-39-82\" name=\"__codelineno-39-82\" href=\"#__codelineno-39-82\"></a><span class=\"w\">              </span><span class=\"p\">{</span>\n</span><span id=\"__span-39-83\"><a id=\"__codelineno-39-83\" name=\"__codelineno-39-83\" href=\"#__codelineno-39-83\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">fd_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-84\"><a id=\"__codelineno-39-84\" name=\"__codelineno-39-84\" href=\"#__codelineno-39-84\"></a><span class=\"w\">                </span><span class=\"n\">remainder</span><span class=\"o\">-&gt;</span><span class=\"n\">bk_nextsize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-85\"><a id=\"__codelineno-39-85\" name=\"__codelineno-39-85\" href=\"#__codelineno-39-85\"></a><span class=\"w\">              </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-86\"><a id=\"__codelineno-39-86\" name=\"__codelineno-39-86\" href=\"#__codelineno-39-86\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-39-87\"><a id=\"__codelineno-39-87\" name=\"__codelineno-39-87\" href=\"#__codelineno-39-87\"></a><span class=\"w\">                      </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-39-88\"><a id=\"__codelineno-39-88\" name=\"__codelineno-39-88\" href=\"#__codelineno-39-88\"></a><span class=\"w\">            </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-89\"><a id=\"__codelineno-39-89\" name=\"__codelineno-39-89\" href=\"#__codelineno-39-89\"></a><span class=\"w\">            </span><span class=\"n\">set_foot</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-90\"><a id=\"__codelineno-39-90\" name=\"__codelineno-39-90\" href=\"#__codelineno-39-90\"></a><span class=\"w\">          </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-91\"><a id=\"__codelineno-39-91\" name=\"__codelineno-39-91\" href=\"#__codelineno-39-91\"></a><span class=\"w\">        </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-92\"><a id=\"__codelineno-39-92\" name=\"__codelineno-39-92\" href=\"#__codelineno-39-92\"></a><span class=\"w\">        </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-93\"><a id=\"__codelineno-39-93\" name=\"__codelineno-39-93\" href=\"#__codelineno-39-93\"></a><span class=\"w\">        </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-39-94\"><a id=\"__codelineno-39-94\" name=\"__codelineno-39-94\" href=\"#__codelineno-39-94\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-39-95\"><a id=\"__codelineno-39-95\" name=\"__codelineno-39-95\" href=\"#__codelineno-39-95\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-39-96\"><a id=\"__codelineno-39-96\" name=\"__codelineno-39-96\" href=\"#__codelineno-39-96\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4e3a\u4e86\u8df3\u8fc7\u7a7a\u7684 bin\uff0c\u7ef4\u62a4\u4e86\u4e00\u4e2a bitmap\uff0c\u8bb0\u5f55\u54ea\u4e9b bin \u4f1a\u6709\u5185\u5bb9\u3002\u627e\u5230\u4e00\u4e2a\u975e\u7a7a\u7684 bin \u4ee5\u540e\uff0c\u5b83\u7684\u5927\u5c0f\u80af\u5b9a\u662f\u8db3\u591f\u5206\u914d\u7684\uff0c\u63a5\u4e0b\u6765\u5c31\u548c\u4e4b\u524d\u4e00\u6837\uff0c\u8981\u4e48\u820d\u5f03\u591a\u4f59\u7684\u7a7a\u95f4\uff0c\u8981\u4e48\u628a\u591a\u4f59\u7684\u7a7a\u95f4\u505a\u6210\u4e00\u4e2a chunk\uff0c\u63d2\u5165\u5230 unsorted bin \u5f53\u4e2d\u3002</p>\n<p>\u5982\u679c\u6240\u6709 bin \u90fd\u7a7a\u4e86\uff0c\u8bf4\u660e\u6ca1\u6709\u53ef\u4ee5\u5206\u914d\u7684\u53ef\u80fd\u4e86\uff0c\u5c31\u8df3\u8f6c\u5230 <code>use_top</code> \u903b\u8f91\u3002</p>\n<h2 id=\"top-chunk-\u5206\u914d\">top chunk \u5206\u914d<a class=\"headerlink\" href=\"#top-chunk-\u5206\u914d\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5982\u679c\u5df2\u6709\u7684 bin \u90fd\u65e0\u6cd5\u5206\u914d\u4e86\uff0c\u5c31\u5c1d\u8bd5\u62c6\u5206 top chunk \u6765\u8fdb\u884c\u5206\u914d\u3002top chunk \u6307\u7684\u662f\u5f53\u524d\u5806\u91cc\u5730\u5740\u6700\u9ad8\u7684\u90a3\u4e2a chunk\uff0c\u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3a\u672a\u5206\u914d\u7684\u90e8\u5206\u3002\u5206\u914d\u7684\u903b\u8f91\u5982\u4e0b\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-40-1\"><a id=\"__codelineno-40-1\" name=\"__codelineno-40-1\" href=\"#__codelineno-40-1\"></a><span class=\"nl\">use_top</span><span class=\"p\">:</span>\n</span><span id=\"__span-40-2\"><a id=\"__codelineno-40-2\" name=\"__codelineno-40-2\" href=\"#__codelineno-40-2\"></a><span class=\"n\">victim</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-3\"><a id=\"__codelineno-40-3\" name=\"__codelineno-40-3\" href=\"#__codelineno-40-3\"></a><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunksize</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-4\"><a id=\"__codelineno-40-4\" name=\"__codelineno-40-4\" href=\"#__codelineno-40-4\"></a>\n</span><span id=\"__span-40-5\"><a id=\"__codelineno-40-5\" name=\"__codelineno-40-5\" href=\"#__codelineno-40-5\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__glibc_unlikely</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">system_mem</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-6\"><a id=\"__codelineno-40-6\" name=\"__codelineno-40-6\" href=\"#__codelineno-40-6\"></a><span class=\"w\">  </span><span class=\"n\">malloc_printerr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">&quot;malloc(): corrupted top size&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-7\"><a id=\"__codelineno-40-7\" name=\"__codelineno-40-7\" href=\"#__codelineno-40-7\"></a>\n</span><span id=\"__span-40-8\"><a id=\"__codelineno-40-8\" name=\"__codelineno-40-8\" href=\"#__codelineno-40-8\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">long</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">MINSIZE</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-9\"><a id=\"__codelineno-40-9\" name=\"__codelineno-40-9\" href=\"#__codelineno-40-9\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-40-10\"><a id=\"__codelineno-40-10\" name=\"__codelineno-40-10\" href=\"#__codelineno-40-10\"></a><span class=\"w\">    </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-11\"><a id=\"__codelineno-40-11\" name=\"__codelineno-40-11\" href=\"#__codelineno-40-11\"></a><span class=\"w\">    </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk_at_offset</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-12\"><a id=\"__codelineno-40-12\" name=\"__codelineno-40-12\" href=\"#__codelineno-40-12\"></a><span class=\"w\">    </span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">top</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-13\"><a id=\"__codelineno-40-13\" name=\"__codelineno-40-13\" href=\"#__codelineno-40-13\"></a><span class=\"w\">    </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n</span><span id=\"__span-40-14\"><a id=\"__codelineno-40-14\" name=\"__codelineno-40-14\" href=\"#__codelineno-40-14\"></a><span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_arena</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">NON_MAIN_ARENA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">));</span>\n</span><span id=\"__span-40-15\"><a id=\"__codelineno-40-15\" name=\"__codelineno-40-15\" href=\"#__codelineno-40-15\"></a><span class=\"w\">    </span><span class=\"n\">set_head</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">remainder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remainder_size</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PREV_INUSE</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-16\"><a id=\"__codelineno-40-16\" name=\"__codelineno-40-16\" href=\"#__codelineno-40-16\"></a>\n</span><span id=\"__span-40-17\"><a id=\"__codelineno-40-17\" name=\"__codelineno-40-17\" href=\"#__codelineno-40-17\"></a><span class=\"w\">    </span><span class=\"n\">check_malloced_chunk</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">victim</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-18\"><a id=\"__codelineno-40-18\" name=\"__codelineno-40-18\" href=\"#__codelineno-40-18\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">chunk2mem</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">victim</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-19\"><a id=\"__codelineno-40-19\" name=\"__codelineno-40-19\" href=\"#__codelineno-40-19\"></a><span class=\"w\">    </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-20\"><a id=\"__codelineno-40-20\" name=\"__codelineno-40-20\" href=\"#__codelineno-40-20\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-21\"><a id=\"__codelineno-40-21\" name=\"__codelineno-40-21\" href=\"#__codelineno-40-21\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-40-22\"><a id=\"__codelineno-40-22\" name=\"__codelineno-40-22\" href=\"#__codelineno-40-22\"></a>\n</span><span id=\"__span-40-23\"><a id=\"__codelineno-40-23\" name=\"__codelineno-40-23\" href=\"#__codelineno-40-23\"></a><span class=\"cm\">/* When we are using atomic ops to free fast chunks we can get</span>\n</span><span id=\"__span-40-24\"><a id=\"__codelineno-40-24\" name=\"__codelineno-40-24\" href=\"#__codelineno-40-24\"></a><span class=\"cm\">   here for all block sizes.  */</span>\n</span><span id=\"__span-40-25\"><a id=\"__codelineno-40-25\" name=\"__codelineno-40-25\" href=\"#__codelineno-40-25\"></a><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">atomic_load_relaxed</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">av</span><span class=\"o\">-&gt;</span><span class=\"n\">have_fastchunks</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-26\"><a id=\"__codelineno-40-26\" name=\"__codelineno-40-26\" href=\"#__codelineno-40-26\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-40-27\"><a id=\"__codelineno-40-27\" name=\"__codelineno-40-27\" href=\"#__codelineno-40-27\"></a><span class=\"w\">    </span><span class=\"n\">malloc_consolidate</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-28\"><a id=\"__codelineno-40-28\" name=\"__codelineno-40-28\" href=\"#__codelineno-40-28\"></a><span class=\"w\">    </span><span class=\"cm\">/* restore original bin index */</span>\n</span><span id=\"__span-40-29\"><a id=\"__codelineno-40-29\" name=\"__codelineno-40-29\" href=\"#__codelineno-40-29\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">in_smallbin_range</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">))</span>\n</span><span id=\"__span-40-30\"><a id=\"__codelineno-40-30\" name=\"__codelineno-40-30\" href=\"#__codelineno-40-30\"></a><span class=\"w\">      </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">smallbin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-31\"><a id=\"__codelineno-40-31\" name=\"__codelineno-40-31\" href=\"#__codelineno-40-31\"></a><span class=\"w\">    </span><span class=\"k\">else</span>\n</span><span id=\"__span-40-32\"><a id=\"__codelineno-40-32\" name=\"__codelineno-40-32\" href=\"#__codelineno-40-32\"></a><span class=\"w\">      </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">largebin_index</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-33\"><a id=\"__codelineno-40-33\" name=\"__codelineno-40-33\" href=\"#__codelineno-40-33\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-40-34\"><a id=\"__codelineno-40-34\" name=\"__codelineno-40-34\" href=\"#__codelineno-40-34\"></a>\n</span><span id=\"__span-40-35\"><a id=\"__codelineno-40-35\" name=\"__codelineno-40-35\" href=\"#__codelineno-40-35\"></a><span class=\"cm\">/*</span>\n</span><span id=\"__span-40-36\"><a id=\"__codelineno-40-36\" name=\"__codelineno-40-36\" href=\"#__codelineno-40-36\"></a><span class=\"cm\">   Otherwise, relay to handle system-dependent cases</span>\n</span><span id=\"__span-40-37\"><a id=\"__codelineno-40-37\" name=\"__codelineno-40-37\" href=\"#__codelineno-40-37\"></a><span class=\"cm\"> */</span>\n</span><span id=\"__span-40-38\"><a id=\"__codelineno-40-38\" name=\"__codelineno-40-38\" href=\"#__codelineno-40-38\"></a><span class=\"k\">else</span>\n</span><span id=\"__span-40-39\"><a id=\"__codelineno-40-39\" name=\"__codelineno-40-39\" href=\"#__codelineno-40-39\"></a><span class=\"w\">  </span><span class=\"p\">{</span>\n</span><span id=\"__span-40-40\"><a id=\"__codelineno-40-40\" name=\"__codelineno-40-40\" href=\"#__codelineno-40-40\"></a><span class=\"w\">    </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sysmalloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">nb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">av</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-41\"><a id=\"__codelineno-40-41\" name=\"__codelineno-40-41\" href=\"#__codelineno-40-41\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n</span><span id=\"__span-40-42\"><a id=\"__codelineno-40-42\" name=\"__codelineno-40-42\" href=\"#__codelineno-40-42\"></a><span class=\"w\">      </span><span class=\"n\">alloc_perturb</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">);</span>\n</span><span id=\"__span-40-43\"><a id=\"__codelineno-40-43\" name=\"__codelineno-40-43\" href=\"#__codelineno-40-43\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n</span><span id=\"__span-40-44\"><a id=\"__codelineno-40-44\" name=\"__codelineno-40-44\" href=\"#__codelineno-40-44\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5982\u679c top chunk \u7684\u7a7a\u95f4\u591f\u5927\uff0c\u90a3\u5c31\u5bf9 top chunk \u8fdb\u884c\u62c6\u5206\uff0c\u4f4e\u5730\u5740\u7684\u90e8\u5206\u5206\u914d\u51fa\u53bb\uff0c\u5269\u4e0b\u7684\u90e8\u5206\u6210\u4e3a\u65b0\u7684 top chunk\u3002\u5982\u679c top chunk \u4e0d\u591f\u5927\uff0c\u5e76\u4e14 fast bin \u8fd8\u6709\u7a7a\u95f4\uff0c\u90a3\u5c31\u518d\u6323\u624e\u4e00\u4e0b\uff0cconsolidate \u4e00\u4e0b\uff0c\u91cd\u65b0\u5206\u914d\u4e00\u6b21\u3002\u5982\u679c\u8fd9\u4e9b\u65b9\u6cd5\u90fd\u5931\u8d25\u4e86\uff0c\u90a3\u5c31\u8c03\u7528 sysmalloc\uff0c\u901a\u8fc7 mmap \u6216\u8005 sbrk \u7b49\u65b9\u5f0f\u6765\u5206\u914d\u65b0\u7684\u7a7a\u95f4\u3002</p>\n<p>\u524d\u9762\u5728\u8ba8\u8bba consolidate \u7684\u65f6\u5019\uff0c\u8df3\u8fc7\u4e86\u5bf9 top chunk \u7684\u7279\u6b8a\u5904\u7406\u3002\u5176\u5b9e\uff0ctop chunk \u7684\u7279\u6b8a\u5904\u7406\u4e5f\u5f88\u7b80\u5355\uff0c\u5982\u679c\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u4e0b\u4e00\u4e2a\u5757\u5c31\u662f top chunk\uff0c\u90a3\u5c31\u628a\u5f53\u524d\u7a7a\u95f2\u5757\u5408\u5e76\u5230 top chunk \u5373\u53ef\u3002</p>\n<h2 id=\"free_3\">free<a class=\"headerlink\" href=\"#free_3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u628a malloc \u7684\u6d41\u7a0b\u57fa\u672c\u5206\u6790\u5b8c\u4e86\uff0c\u63a5\u4e0b\u6765\u5206\u6790\u4e00\u4e0b free \u7684\u903b\u8f91\uff0c\u5b83\u505a\u7684\u4e8b\u60c5\u5305\u62ec\uff1a</p>\n<ol>\n<li>\u524d\u9762\u5df2\u7ecf\u5206\u6790\u8fc7\uff0c\u5982\u679c tcache \u5bf9\u5e94\u7684 bin \u5b58\u5728\u4e14\u975e\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u63d2\u5165\u5230 tcache \u7684\u94fe\u8868\u5934</li>\n<li>\u5982\u679c\u5b58\u5728\u5bf9\u5e94\u7684 fast bin\uff0c\u5219\u63d2\u5165\u7a7a\u95f2\u5757\u5230 fast bin \u5bf9\u5e94\u94fe\u8868\u7684\u5934\u90e8</li>\n<li>\u5c1d\u8bd5\u548c\u5b83\u524d\u540e\u7684\u7a7a\u95f2\u5757\u8fdb\u884c\u5408\u5e76\uff0c\u5b9e\u73b0\u548c\u524d\u9762 consolidate \u7c7b\u4f3c\uff0c\u5408\u5e76\u540e\u8fdb\u5165 unsorted bin</li>\n<li>\u5982\u679c\u91ca\u653e\u7684\u5185\u5b58\u6bd4\u8f83\u591a\uff0c\u68c0\u67e5 top chunk \u5927\u5c0f\uff0c\u5982\u679c\u5269\u4f59\u7684\u7a7a\u95f4\u6bd4\u8f83\u591a\uff0c\u5219\u5f52\u8fd8\u4e00\u90e8\u5206\u5185\u5b58\u7ed9\u64cd\u4f5c\u7cfb\u7edf</li>\n<li>\u5bf9\u4e8e mmap \u5206\u914d\u7684\u5185\u5b58\uff0c\u7528 munmap \u91ca\u653e\u6389</li>\n</ol>\n<p>\u7531\u4e8e free \u7684\u5b9e\u73b0\u76f8\u5bf9\u7b80\u5355\uff0c\u5728\u8fd9\u91cc\u5c31\u4e0d\u8be6\u7ec6\u89e3\u6790\u4e86\uff0c\u6bd4\u8f83\u8be6\u7ec6\u7684\u5b9e\u73b0\u5206\u6790\u89c1\u540e\u3002</p>\n<h2 id=\"realloc\">realloc<a class=\"headerlink\" href=\"#realloc\" title=\"Permanent link\">&para;</a></h2>\n<p>realloc \u7684\u5b9e\u73b0\u5728 <code>__libc_realloc</code> \u5f53\u4e2d\uff0c\u5b83\u7684\u5b9e\u73b0\u6bd4\u8f83\u7b80\u5355\uff1a</p>\n<ol>\n<li>\u5982\u679c\u91cd\u65b0\u5206\u914d\u7684\u5927\u5c0f\u662f 0\uff0crealloc \u7b49\u4ef7\u4e3a free\uff0c\u5c31\u8c03\u7528 free</li>\n<li>\u5982\u679c\u65e7\u6307\u9488\u662f NULL\uff0crealloc \u7b49\u4ef7\u4e3a malloc\uff0c\u5c31\u8c03\u7528 malloc</li>\n<li>\u5982\u679c\u76f4\u63a5\u662f mmap \u51fa\u6765\u7684\u5757\uff0c\u5229\u7528 mremap \u6765\u6269\u5c55\u7a7a\u95f4</li>\n<li>\u5982\u679c\u662f\u8981\u7533\u8bf7\u66f4\u5c11\u7684\u5185\u5b58\uff0c\u628a\u591a\u51fa\u6765\u7684\u90e8\u5206\u62c6\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u5757\uff0c\u7136\u540e free \u6389\u5b83</li>\n<li>\u5982\u679c\u662f\u8981\u7533\u8bf7\u66f4\u591a\u7684\u5185\u5b58\uff0c\u5c1d\u8bd5\u4ece\u5185\u5b58\u66f4\u9ad8\u5730\u5740\u7684\u76f8\u90bb\u5757\u83b7\u53d6\u7a7a\u95f4\uff0c\u5982\u679c\u6709\u7684\u8bdd\uff0c\u5408\u5e76\u4e24\u4e2a\u5757\uff0c\u7136\u540e\u628a\u591a\u4f59\u7684\u7a7a\u95f4\u62c6\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u5757\uff0c\u7136\u540e free \u6389\u5b83\uff1b\u5982\u679c\u5185\u5b58\u66f4\u9ad8\u5730\u5740\u7684\u76f8\u90bb\u5757\u5df2\u7ecf\u88ab\u5360\u7528\uff0c\u5c31\u91cd\u65b0 malloc \u4e00\u4e2a\u5757\uff0c\u7528 memcpy \u628a\u6570\u636e\u62f7\u8d1d\u8fc7\u53bb\uff0c\u518d free \u6389\u65e7\u7684\u5185\u5b58</li>\n</ol>\n<h2 id=\"calloc\">calloc<a class=\"headerlink\" href=\"#calloc\" title=\"Permanent link\">&para;</a></h2>\n<p>calloc \u7684\u5b9e\u73b0\u5728 <code>__libc_calloc</code> \u5f53\u4e2d\uff0c\u5b83\u7684\u8bed\u4e49\u76f8\u6bd4 malloc \u591a\u4e86\u4e00\u4e2a\u6e05\u96f6\uff0c\u6240\u4ee5\u5b83\u7684\u5b9e\u73b0\u4e5f\u4e0d\u590d\u6742\uff1a</p>\n<ol>\n<li>\u5982\u679c top chunk \u8fd8\u6709\u7a7a\u95f4\uff0c\u5e76\u4e14 top chunk \u7684\u6570\u636e\u5df2\u7ecf\u88ab\u6e05\u96f6\uff0c\u5219\u4f18\u5148\u4ece top chunk \u5206\u914d\u7a7a\u95f4\uff0c\u907f\u514d\u4e86 memset \u7684\u5f00\u9500</li>\n<li>fallback \u5230 <code>_int_malloc</code> \u8fdb\u884c\u5185\u5b58\u5206\u914d\uff0c\u5206\u914d\u6210\u529f\u540e\uff0c\u518d memset \u6e05\u96f6</li>\n</ol>\n<h2 id=\"arena-\u548c-heap\">arena \u548c heap<a class=\"headerlink\" href=\"#arena-\u548c-heap\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u9762\u8ba8\u8bba\u4e86\u5404\u79cd chunk \u5728\u5185\u5b58\u5206\u914d\u5668\u5185\u90e8\u6d41\u8f6c\u7684\u60c5\u51b5\uff0c\u4f46\u5e76\u6ca1\u6709\u8ba8\u8bba\u8fd9\u4e9b\u7a7a\u95f4\u662f\u600e\u4e48\u4ece\u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u800c\u6765\u7684\uff0c\u53c8\u662f\u600e\u4e48\u7ef4\u62a4\u7684\u3002glibc \u5185\u5b58\u5206\u914d\u5668\u5b9e\u9645\u4e0a\u8bbe\u8ba1\u4e86\u4e24\u4e2a\u5c42\u6b21\uff1a</p>\n<ol>\n<li>arena \u5c42\u6b21\uff1a\u5bf9\u5e94\u9501\u7684\u7c92\u5ea6\uff0c\u4e00\u4e2a arena \u53ef\u4ee5\u5bf9\u5e94\u591a\u4e2a heap\uff0c\u6709\u4e00\u4e2a\u7279\u6b8a\u7684 arena \u662f main_arena\uff1barena \u7684\u6570\u91cf\u6709\u9650\u5236\uff0c\u5728 64 \u4f4d\u7cfb\u7edf\u4e0b\u9ed8\u8ba4\u7684\u6570\u91cf\u9650\u5236\u662f\u5904\u7406\u5668\u6838\u5fc3\u6570\u7684 8 \u500d\uff0c\u907f\u514d\u51fa\u73b0\u592a\u591a\u7684\u5185\u5b58\u788e\u7247</li>\n<li>heap \u5c42\u6b21\uff1a\u6bcf\u4e2a heap \u5927\u5c0f\u6709\u4e0a\u9650\uff1a<code>1024 * 1024</code> \u5b57\u8282\uff0c\u4e5f\u5c31\u662f 1MB\uff1b\u5f53 arena \u9700\u8981\u66f4\u591a\u7a7a\u95f4\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5206\u914d\u65b0\u7684 heap\uff1barena \u81ea\u8eab\u5c31\u4fdd\u5b58\u5728 arena \u7684\u7b2c\u4e00\u4e2a heap \u5185\u90e8\u7684\u7a7a\u95f4\uff0c\u540c\u4e00\u4e2a arena \u7684\u591a\u4e2a heap \u4e4b\u95f4\u901a\u5355\u5411\u94fe\u8868\u8fde\u63a5\u8d77\u6765\uff1barena \u7684 top chunk \u6307\u5411\u6700\u540e\u4e00\u4e2a\u521b\u5efa\u7684 heap \u7684\u9876\u90e8\u7684\u7a7a\u95f2\u5757</li>\n</ol>\n<p>arena \u7684\u7ed3\u6784\u5c31\u662f\u524d\u9762\u770b\u5230\u7684 <code>malloc_state</code>\uff0c\u5305\u62ec\u5982\u4e0b\u5b57\u6bb5\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-41-1\"><a id=\"__codelineno-41-1\" name=\"__codelineno-41-1\" href=\"#__codelineno-41-1\"></a><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span>\n</span><span id=\"__span-41-2\"><a id=\"__codelineno-41-2\" name=\"__codelineno-41-2\" href=\"#__codelineno-41-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-41-3\"><a id=\"__codelineno-41-3\" name=\"__codelineno-41-3\" href=\"#__codelineno-41-3\"></a><span class=\"w\">  </span><span class=\"cm\">/* Serialize access.  */</span>\n</span><span id=\"__span-41-4\"><a id=\"__codelineno-41-4\" name=\"__codelineno-41-4\" href=\"#__codelineno-41-4\"></a><span class=\"w\">  </span><span class=\"n\">__libc_lock_define</span><span class=\"w\"> </span><span class=\"p\">(,</span><span class=\"w\"> </span><span class=\"n\">mutex</span><span class=\"p\">);</span>\n</span><span id=\"__span-41-5\"><a id=\"__codelineno-41-5\" name=\"__codelineno-41-5\" href=\"#__codelineno-41-5\"></a>\n</span><span id=\"__span-41-6\"><a id=\"__codelineno-41-6\" name=\"__codelineno-41-6\" href=\"#__codelineno-41-6\"></a><span class=\"w\">  </span><span class=\"cm\">/* Flags (formerly in max_fast).  */</span>\n</span><span id=\"__span-41-7\"><a id=\"__codelineno-41-7\" name=\"__codelineno-41-7\" href=\"#__codelineno-41-7\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-8\"><a id=\"__codelineno-41-8\" name=\"__codelineno-41-8\" href=\"#__codelineno-41-8\"></a>\n</span><span id=\"__span-41-9\"><a id=\"__codelineno-41-9\" name=\"__codelineno-41-9\" href=\"#__codelineno-41-9\"></a><span class=\"w\">  </span><span class=\"cm\">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>\n</span><span id=\"__span-41-10\"><a id=\"__codelineno-41-10\" name=\"__codelineno-41-10\" href=\"#__codelineno-41-10\"></a><span class=\"w\">  </span><span class=\"cm\">/* Note this is a bool but not all targets support atomics on booleans.  */</span>\n</span><span id=\"__span-41-11\"><a id=\"__codelineno-41-11\" name=\"__codelineno-41-11\" href=\"#__codelineno-41-11\"></a><span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">have_fastchunks</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-12\"><a id=\"__codelineno-41-12\" name=\"__codelineno-41-12\" href=\"#__codelineno-41-12\"></a>\n</span><span id=\"__span-41-13\"><a id=\"__codelineno-41-13\" name=\"__codelineno-41-13\" href=\"#__codelineno-41-13\"></a><span class=\"w\">  </span><span class=\"cm\">/* Fastbins */</span>\n</span><span id=\"__span-41-14\"><a id=\"__codelineno-41-14\" name=\"__codelineno-41-14\" href=\"#__codelineno-41-14\"></a><span class=\"w\">  </span><span class=\"n\">mfastbinptr</span><span class=\"w\"> </span><span class=\"n\">fastbinsY</span><span class=\"p\">[</span><span class=\"n\">NFASTBINS</span><span class=\"p\">];</span>\n</span><span id=\"__span-41-15\"><a id=\"__codelineno-41-15\" name=\"__codelineno-41-15\" href=\"#__codelineno-41-15\"></a>\n</span><span id=\"__span-41-16\"><a id=\"__codelineno-41-16\" name=\"__codelineno-41-16\" href=\"#__codelineno-41-16\"></a><span class=\"w\">  </span><span class=\"cm\">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>\n</span><span id=\"__span-41-17\"><a id=\"__codelineno-41-17\" name=\"__codelineno-41-17\" href=\"#__codelineno-41-17\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">top</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-18\"><a id=\"__codelineno-41-18\" name=\"__codelineno-41-18\" href=\"#__codelineno-41-18\"></a>\n</span><span id=\"__span-41-19\"><a id=\"__codelineno-41-19\" name=\"__codelineno-41-19\" href=\"#__codelineno-41-19\"></a><span class=\"w\">  </span><span class=\"cm\">/* The remainder from the most recent split of a small request */</span>\n</span><span id=\"__span-41-20\"><a id=\"__codelineno-41-20\" name=\"__codelineno-41-20\" href=\"#__codelineno-41-20\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">last_remainder</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-21\"><a id=\"__codelineno-41-21\" name=\"__codelineno-41-21\" href=\"#__codelineno-41-21\"></a>\n</span><span id=\"__span-41-22\"><a id=\"__codelineno-41-22\" name=\"__codelineno-41-22\" href=\"#__codelineno-41-22\"></a><span class=\"w\">  </span><span class=\"cm\">/* Normal bins packed as described above */</span>\n</span><span id=\"__span-41-23\"><a id=\"__codelineno-41-23\" name=\"__codelineno-41-23\" href=\"#__codelineno-41-23\"></a><span class=\"w\">  </span><span class=\"n\">mchunkptr</span><span class=\"w\"> </span><span class=\"n\">bins</span><span class=\"p\">[</span><span class=\"n\">NBINS</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">];</span>\n</span><span id=\"__span-41-24\"><a id=\"__codelineno-41-24\" name=\"__codelineno-41-24\" href=\"#__codelineno-41-24\"></a>\n</span><span id=\"__span-41-25\"><a id=\"__codelineno-41-25\" name=\"__codelineno-41-25\" href=\"#__codelineno-41-25\"></a><span class=\"w\">  </span><span class=\"cm\">/* Bitmap of bins */</span>\n</span><span id=\"__span-41-26\"><a id=\"__codelineno-41-26\" name=\"__codelineno-41-26\" href=\"#__codelineno-41-26\"></a><span class=\"w\">  </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">binmap</span><span class=\"p\">[</span><span class=\"n\">BINMAPSIZE</span><span class=\"p\">];</span>\n</span><span id=\"__span-41-27\"><a id=\"__codelineno-41-27\" name=\"__codelineno-41-27\" href=\"#__codelineno-41-27\"></a>\n</span><span id=\"__span-41-28\"><a id=\"__codelineno-41-28\" name=\"__codelineno-41-28\" href=\"#__codelineno-41-28\"></a><span class=\"w\">  </span><span class=\"cm\">/* Linked list */</span>\n</span><span id=\"__span-41-29\"><a id=\"__codelineno-41-29\" name=\"__codelineno-41-29\" href=\"#__codelineno-41-29\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-30\"><a id=\"__codelineno-41-30\" name=\"__codelineno-41-30\" href=\"#__codelineno-41-30\"></a>\n</span><span id=\"__span-41-31\"><a id=\"__codelineno-41-31\" name=\"__codelineno-41-31\" href=\"#__codelineno-41-31\"></a><span class=\"w\">  </span><span class=\"cm\">/* Linked list for free arenas.  Access to this field is serialized</span>\n</span><span id=\"__span-41-32\"><a id=\"__codelineno-41-32\" name=\"__codelineno-41-32\" href=\"#__codelineno-41-32\"></a><span class=\"cm\">     by free_list_lock in arena.c.  */</span>\n</span><span id=\"__span-41-33\"><a id=\"__codelineno-41-33\" name=\"__codelineno-41-33\" href=\"#__codelineno-41-33\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">malloc_state</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">next_free</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-34\"><a id=\"__codelineno-41-34\" name=\"__codelineno-41-34\" href=\"#__codelineno-41-34\"></a>\n</span><span id=\"__span-41-35\"><a id=\"__codelineno-41-35\" name=\"__codelineno-41-35\" href=\"#__codelineno-41-35\"></a><span class=\"w\">  </span><span class=\"cm\">/* Number of threads attached to this arena.  0 if the arena is on</span>\n</span><span id=\"__span-41-36\"><a id=\"__codelineno-41-36\" name=\"__codelineno-41-36\" href=\"#__codelineno-41-36\"></a><span class=\"cm\">     the free list.  Access to this field is serialized by</span>\n</span><span id=\"__span-41-37\"><a id=\"__codelineno-41-37\" name=\"__codelineno-41-37\" href=\"#__codelineno-41-37\"></a><span class=\"cm\">     free_list_lock in arena.c.  */</span>\n</span><span id=\"__span-41-38\"><a id=\"__codelineno-41-38\" name=\"__codelineno-41-38\" href=\"#__codelineno-41-38\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\"> </span><span class=\"n\">attached_threads</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-39\"><a id=\"__codelineno-41-39\" name=\"__codelineno-41-39\" href=\"#__codelineno-41-39\"></a>\n</span><span id=\"__span-41-40\"><a id=\"__codelineno-41-40\" name=\"__codelineno-41-40\" href=\"#__codelineno-41-40\"></a><span class=\"w\">  </span><span class=\"cm\">/* Memory allocated from the system in this arena.  */</span>\n</span><span id=\"__span-41-41\"><a id=\"__codelineno-41-41\" name=\"__codelineno-41-41\" href=\"#__codelineno-41-41\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\"> </span><span class=\"n\">system_mem</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-42\"><a id=\"__codelineno-41-42\" name=\"__codelineno-41-42\" href=\"#__codelineno-41-42\"></a><span class=\"w\">  </span><span class=\"n\">INTERNAL_SIZE_T</span><span class=\"w\"> </span><span class=\"n\">max_system_mem</span><span class=\"p\">;</span>\n</span><span id=\"__span-41-43\"><a id=\"__codelineno-41-43\" name=\"__codelineno-41-43\" href=\"#__codelineno-41-43\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u5f88\u591a\u5b57\u6bb5\u5728\u4e4b\u524d\u5df2\u7ecf\u89c1\u8fc7\u4e86\uff0c\u6bd4\u5982\uff1a</p>\n<ol>\n<li><code>mutex</code>\uff1aarena \u7684\u4e92\u65a5\u9501</li>\n<li><code>have_fastchunks</code>\uff1a\u8bb0\u5f55 fast bin \u4e2d\u662f\u5426\u8fd8\u6709\u7a7a\u95f2\u5757\uff0c\u7528\u4e8e\u5224\u65ad\u662f\u5426\u9700\u8981 consolidate</li>\n<li><code>fastbinsY</code>\uff1a\u4fdd\u5b58 fast bin \u6bcf\u4e2a bin \u7684\u5934\u6307\u9488\u7684\u6570\u7ec4</li>\n<li><code>top</code>\uff1a\u6307\u5411 top chunk</li>\n<li><code>last_remainder</code>\uff1a\u6307\u5411\u6700\u8fd1\u4e00\u6b21 split \u51fa\u6765\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u4e8e\u8bbf\u5b58\u5c40\u90e8\u6027\u4f18\u5316</li>\n<li><code>bins</code>\uff1a\u4fdd\u5b58 unsorted bin\uff0csmall bin \u548c large bin \u5404\u4e2a\u53cc\u5411\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u7684 <code>fd</code> \u548c <code>bk</code> \u6307\u9488</li>\n<li><code>binmap</code>\uff1a\u8bb0\u5f55\u54ea\u4e9b small \u6216 large bin \u91cc\u9762\u6709\u7a7a\u95f2\u5757\uff0c\u7528\u4e8e\u52a0\u901f\u5bfb\u627e\u4e0b\u4e00\u4e2a\u6709\u7a7a\u95f2\u5757\u7684 bin</li>\n</ol>\n<p>\u4e4b\u524d\u6ca1\u6709\u6d89\u53ca\u5230\u7684\u5b57\u6bb5\u5305\u62ec\uff1a</p>\n<ol>\n<li><code>flags</code>: \u7ef4\u62a4 <code>NONCONTIGUOUS_BIT</code> \u6807\u8bb0\uff0c\u5373 arena \u6240\u4f7f\u7528\u7684\u5185\u5b58\u662f\u5426\u662f\u8fde\u7eed\u7684\uff0c\u4f8b\u5982\u7528 sbrk \u5206\u914d\u51fa\u6765\u7684\u5185\u5b58\u662f\u8fde\u7eed\u7684\uff0c\u7528 mmap \u5219\u4e0d\u662f</li>\n<li><code>next</code>: \u7ef4\u62a4\u6240\u6709 arena \u7684\u5355\u5411\u94fe\u8868\uff0c\u94fe\u8868\u5934\u5c31\u662f <code>main_arena</code></li>\n<li><code>next_free</code>: \u7ef4\u62a4\u6240\u6709\u7a7a\u95f2\u7684 arena \u7684\u5355\u5411\u94fe\u8868 free list\uff0c\u94fe\u8868\u5934\u4fdd\u5b58\u5728 <code>static mstate free_list</code></li>\n<li><code>attached_threads</code>: \u8bb0\u5f55\u6709\u591a\u5c11\u4e2a\u7ebf\u7a0b\u4f1a\u4f7f\u7528\u8fd9\u4e2a arena\uff0c\u7c7b\u4f3c\u4e8e\u4e00\u79cd\u5f15\u7528\u8ba1\u6570\uff0c\u5f53\u5b83\u51cf\u5230\u96f6\u7684\u65f6\u5019\uff0c\u610f\u5473\u7740 arena \u53ef\u4ee5\u88ab\u91ca\u653e\u5230 free list \u4e86</li>\n<li><code>system_mem</code>: \u8bb0\u5f55\u5b83\u4ece\u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u4e86\u591a\u5c11\u7684\u5185\u5b58\u7684\u5927\u5c0f</li>\n<li><code>max_system_mem</code>\uff1a\u8bb0\u5f55\u5b83\u5386\u53f2\u4e0a\u4ece\u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u6700\u591a\u7684\u5185\u5b58\u7684\u5927\u5c0f</li>\n</ol>\n<p>\u53ef\u89c1 arena \u7684\u7ed3\u6784\u8fd8\u662f\u6bd4\u8f83\u7b80\u5355\u7684\uff0c\u63a5\u4e0b\u6765\u5206\u6790 heap \u7684\u7ed3\u6784\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-42-1\"><a id=\"__codelineno-42-1\" name=\"__codelineno-42-1\" href=\"#__codelineno-42-1\"></a><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">_heap_info</span>\n</span><span id=\"__span-42-2\"><a id=\"__codelineno-42-2\" name=\"__codelineno-42-2\" href=\"#__codelineno-42-2\"></a><span class=\"p\">{</span>\n</span><span id=\"__span-42-3\"><a id=\"__codelineno-42-3\" name=\"__codelineno-42-3\" href=\"#__codelineno-42-3\"></a><span class=\"w\">  </span><span class=\"n\">mstate</span><span class=\"w\"> </span><span class=\"n\">ar_ptr</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Arena for this heap. */</span>\n</span><span id=\"__span-42-4\"><a id=\"__codelineno-42-4\" name=\"__codelineno-42-4\" href=\"#__codelineno-42-4\"></a><span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">_heap_info</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">prev</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Previous heap. */</span>\n</span><span id=\"__span-42-5\"><a id=\"__codelineno-42-5\" name=\"__codelineno-42-5\" href=\"#__codelineno-42-5\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">;</span><span class=\"w\">   </span><span class=\"cm\">/* Current size in bytes. */</span>\n</span><span id=\"__span-42-6\"><a id=\"__codelineno-42-6\" name=\"__codelineno-42-6\" href=\"#__codelineno-42-6\"></a><span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">mprotect_size</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"cm\">/* Size in bytes that has been mprotected</span>\n</span><span id=\"__span-42-7\"><a id=\"__codelineno-42-7\" name=\"__codelineno-42-7\" href=\"#__codelineno-42-7\"></a><span class=\"cm\">                           PROT_READ|PROT_WRITE.  */</span>\n</span><span id=\"__span-42-8\"><a id=\"__codelineno-42-8\" name=\"__codelineno-42-8\" href=\"#__codelineno-42-8\"></a><span class=\"w\">  </span><span class=\"cm\">/* Make sure the following data is properly aligned, particularly</span>\n</span><span id=\"__span-42-9\"><a id=\"__codelineno-42-9\" name=\"__codelineno-42-9\" href=\"#__codelineno-42-9\"></a><span class=\"cm\">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span>\n</span><span id=\"__span-42-10\"><a id=\"__codelineno-42-10\" name=\"__codelineno-42-10\" href=\"#__codelineno-42-10\"></a><span class=\"cm\">     MALLOC_ALIGNMENT. */</span>\n</span><span id=\"__span-42-11\"><a id=\"__codelineno-42-11\" name=\"__codelineno-42-11\" href=\"#__codelineno-42-11\"></a><span class=\"w\">  </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">pad</span><span class=\"p\">[</span><span class=\"mi\">-6</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">SIZE_SZ</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">MALLOC_ALIGN_MASK</span><span class=\"p\">];</span>\n</span><span id=\"__span-42-12\"><a id=\"__codelineno-42-12\" name=\"__codelineno-42-12\" href=\"#__codelineno-42-12\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">heap_info</span><span class=\"p\">;</span>\n</span></code></pre></div>\n<p>\u5b57\u6bb5\u5982\u4e0b\uff1a</p>\n<ol>\n<li><code>ar_ptr</code>\uff1a\u6307\u5411 heap \u6240\u5c5e\u7684 arena</li>\n<li><code>prev</code>\uff1a\u6307\u5411\u524d\u4e00\u4e2a heap\uff0c\u7ec4\u6210\u4e00\u4e2a heap \u7684\u5355\u5411\u94fe\u8868\uff0c\u65b0\u6dfb\u52a0\u7684 heap \u653e\u5230\u94fe\u8868\u7684\u5c3e\u90e8</li>\n<li><code>size</code>: heap \u7684\u5927\u5c0f</li>\n<li><code>mprotect_size</code>: heap \u88ab\u8bbe\u7f6e\u4e3a\u53ef\u8bfb\u5199\u7684\u90e8\u5206\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u4e5f\u5c31\u662f heap \u7684\u6d3b\u8dc3\u90e8\u5206\u5927\u5c0f\uff0c\u5bf9\u9f50\u5230\u9875\u7684\u8fb9\u754c\uff1b\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cheap \u7684\u672a\u5206\u914d\u7a7a\u95f4\u88ab\u6620\u5c04\u4e3a\u4e0d\u53ef\u8bfb\u4e0d\u53ef\u5199\u4e0d\u53ef\u6267\u884c\u7684\u5c5e\u6027</li>\n<li><code>pad</code>: \u6dfb\u52a0 padding\uff0c\u4fdd\u8bc1\u5b83\u7684\u5927\u5c0f\u662f <code>MALLOC_ALIGNMENT</code> \u7684\u500d\u6570</li>\n</ol>\n<p>\u524d\u9762\u63d0\u5230\u8fc7\uff0carena \u7684\u7a7a\u95f4\u4f1a\u590d\u7528\u5b83\u7684\u7b2c\u4e00\u4e2a heap \u7684\u7a7a\u95f4\uff0c\u7d27\u63a5\u7740\u653e\u5728 <code>heap_info</code> \u7ed3\u6784\u4f53\u7684\u540e\u9762\u3002\u8fd9\u4e2a <code>heap_info</code> \u7ed3\u6784\u4f53\u5c31\u653e\u5728 heap \u6240\u7528\u7a7a\u95f4\u7684\u5f00\u5934\u3002</p>\n<p>heap \u6709\u4e00\u4e2a\u7279\u6027\uff0c\u5c31\u662f\u5b83\u7684\u8d77\u59cb\u5730\u5740\uff0c\u4e00\u5b9a\u662f\u5bf9\u9f50\u5230 <code>HEAP_MAX_SIZE</code>\uff08\u9ed8\u8ba4\u662f 64MB\uff09\u7684\u6574\u6570\u500d\u6570\uff0c\u5e76\u4e14\u5b83\u7684\u5927\u5c0f\u4e5f\u4e0d\u4f1a\u8d85\u8fc7 <code>HEAP_MAX_SIZE</code>\uff0c\u6240\u4ee5\u5982\u679c\u8981\u77e5\u9053\u67d0\u4e2a chunk \u5c5e\u4e8e\u54ea\u4e2a heap\uff0c\u53ea\u9700\u8981\u5411\u4e0b\u53d6\u6574\u5230 <code>HEAP_MAX_SIZE</code> \u7684\u500d\u6570\u5373\u53ef\u3002\u5982\u679c\u8981\u77e5\u9053\u67d0\u4e2a chunk \u5c5e\u4e8e\u54ea\u4e2a arena\uff0c\u5c31\u5148\u627e\u5230 heap\uff0c\u518d\u4ece heap_info \u83b7\u53d6 ar_ptr \u5c31\u53ef\u4ee5\u4e86\u3002</p>\n<p>\u6bd4\u8f83\u6709\u610f\u601d\u7684\u4e00\u4e2a\u70b9\u662f\uff0cheap \u4fdd\u5b58\u4e86 arena \u7684\u6307\u9488\uff0c\u4f46\u662f\u53cd\u8fc7\u6765\uff0carena \u5e76\u6ca1\u6709\u4fdd\u5b58 heap \u7684\u6307\u9488\uff0c\u90a3\u4e48\u600e\u4e48\u4ece arena \u627e\u5230\u5c5e\u4e8e\u8fd9\u4e2a arena \u7684\u6240\u6709 heap \u5462\uff1f\u8fd9\u4f1a\u7528\u5230\u4e00\u4e2a\u6027\u8d28\uff1aarena \u7684 top \u6c38\u8fdc\u6307\u5411\u6700\u65b0\u7684\u4e00\u4e2a heap \u7684\u5730\u5740\u6700\u9ad8\u7684\u7a7a\u95f2\u5757\uff0c\u800c\u8fd9\u4e2a\u6700\u65b0\u7684 heap \u6b63\u597d\u5904\u4e8e heap \u94fe\u8868\u7684\u5c3e\u90e8\uff0c\u6240\u4ee5\u5982\u679c\u8981\u904d\u5386 arena \u91cc\u7684 heap\uff0c\u53ea\u9700\u8981\uff1a</p>\n<ol>\n<li>\u83b7\u53d6 arena \u7684 top \u6307\u9488</li>\n<li>\u628a top \u6307\u9488\u5411\u4e0b\u53d6\u6574\u5230 <code>HEAP_MAX_SIZE</code> \u7684\u6574\u500d\u6570\uff0c\u5f97\u5230 top \u6240\u5728 heap \u7684 heap_info \u6307\u9488</li>\n<li>\u6cbf\u7740 heap_info \u7684 prev \u6307\u9488\u5411\u524d\u8d70\uff0c\u4e00\u76f4\u904d\u5386\uff0c\u76f4\u5230 prev \u6307\u9488\u4e3a NULL \u4e3a\u6b62</li>\n</ol>\n<p>\u6240\u4ee5 top \u6307\u9488\u4e5f\u5145\u5f53\u4e86 heap \u94fe\u8868\u7684\u5c3e\u6307\u9488\u7684\u4f5c\u7528\u3002</p>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf arena \u548c heap \u662f\u600e\u4e48\u521d\u59cb\u5316\u7684\u3002</p>\n<p>main arena \u662f\u7279\u6b8a\u7684\uff0c\u56e0\u4e3a\u5b83\u76f4\u63a5\u4fdd\u5b58\u5728 glibc \u7684 data \u6bb5\u5f53\u4e2d\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u52a8\u6001\u5206\u914d\uff0c\u5e76\u4e14 main arena \u7684\u6570\u636e\u662f\u901a\u8fc7 sbrk \u4ece\u7cfb\u7edf\u5206\u914d\u7684\uff0c\u5b83\u7684\u7ef4\u62a4\u903b\u8f91\u5728 <code>sysmalloc</code> \u51fd\u6570\u4e2d\u5b9e\u73b0\uff1a\u5f53 malloc \u5c1d\u8bd5\u5404\u79cd\u529e\u6cd5\u90fd\u627e\u4e0d\u5230\u7a7a\u95f4\u5206\u914d\u65f6\uff0c\u5c31\u4f1a\u8c03\u7528 <code>sysmalloc</code> \u6765\u6269\u5c55 top chunk \u5e76\u4ece top chunk \u4e2d\u5206\u914d\u65b0\u7684\u5757\u3002\u5f53 <code>sysmalloc</code> \u9047\u5230 main arena \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u5c1d\u8bd5\u7528 sbrk \u6269\u5c55\u5806\u7684\u5927\u5c0f\uff0c\u4ece\u800c\u6269\u5927 top chunk\u3002\u5f53\u7136\u4e86\uff0csbrk \u53ef\u80fd\u4f1a\u5931\u8d25\uff0c\u8fd9\u4e2a\u65f6\u5019 main arena \u4e5f\u4f1a\u901a\u8fc7 mmap \u6765\u5206\u914d\u66f4\u591a\u7684\u5185\u5b58\u3002</p>\n<p>\u5176\u4ed6\u7684 arena \u5219\u662f\u901a\u8fc7 <code>_int_new_arena</code> \u5206\u914d\u7684\uff0c\u5b83\u7684\u6d41\u7a0b\u662f\uff1a</p>\n<ol>\n<li>\u8c03\u7528 <code>new_heap</code> \u521b\u5efa\u4e00\u4e2a\u5806\uff0c\u81f3\u5c11\u80fd\u591f\u653e <code>heap_info</code> \u548c <code>malloc_state</code> \u7684\u7a7a\u95f4</li>\n<li>\u8fd9\u6bb5\u7a7a\u95f4\u7684\u5f00\u5934\u5c31\u662f <code>heap_info</code>\uff0c\u7d27\u968f\u5176\u540e\u5c31\u662f arena \u81ea\u5df1\u7684 <code>malloc_state</code>\uff0c\u7136\u540e\u628a top chunk \u6307\u5411 <code>malloc_state</code> \u540e\u9762\u7684\u7a7a\u95f2\u7a7a\u95f4</li>\n</ol>\n<p><code>new_heap</code> \u5219\u662f\u4f1a\u901a\u8fc7 <code>mmap</code> \u5411\u64cd\u4f5c\u7cfb\u7edf\u7533\u8bf7\u5185\u5b58\u3002\u56e0\u6b64\u9664\u4e86 main_arena \u4ee5\u5916\uff0c\u6240\u6709\u7684 arena \u7684 heap \u90fd\u4f1a\u653e\u5728 mmap \u51fa\u6765\u7684\u7a7a\u95f4\u91cc\u3002</p>\n<p>\u4e8e\u662f <code>sysmalloc</code> \u8981\u505a\u7684\u4e8b\u60c5\u4e5f\u6bd4\u8f83\u6e05\u6670\u4e86\uff0c\u5b83\u8981\u505a\u7684\u5c31\u662f\uff0c\u5728 top chunk \u4e0d\u591f\u5927\u7684\u65f6\u5019\uff0c\u5206\u914d\u66f4\u591a\u7a7a\u95f4\u7ed9 top chunk\uff1a</p>\n<ol>\n<li>\u5982\u679c\u8981\u5206\u914d\u7684\u5757\u7279\u522b\u5927\uff0c\u8d85\u51fa\u4e86\u9608\u503c <code>mmap_threshold</code>\uff0c\u5c31\u76f4\u63a5\u7528 mmap \u7533\u8bf7\u5185\u5b58</li>\n<li>\u5982\u679c\u4e0d\u662f main arena\uff0c\u5c31\u5c1d\u8bd5\u6269\u5927 top \u6240\u5728\u7684 heap\uff1aheap \u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u867d\u7136\u4f1a mmap \u4e00\u4e2a <code>HEAP_MAX_SIZE</code> \u5927\u5c0f\u7684\u5185\u5b58\uff0c\u4f46\u5927\u90e8\u5206\u7a7a\u95f4\u90fd\u88ab\u6620\u5c04\u4e3a\u4e0d\u53ef\u8bfb\u4e0d\u53ef\u5199\u4e0d\u53ef\u6267\u884c\uff1b\u6240\u4ee5\u6269\u5927 heap\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u628a\u8981\u7528\u7684\u90e8\u5206\u901a\u8fc7 mprotect \u6dfb\u52a0\u53ef\u8bfb\u548c\u53ef\u5199\u7684\u6743\u9650\uff1b\u5982\u679c heap \u8fbe\u5230\u4e86\u5927\u5c0f\u7684\u4e0a\u9650\uff0c\u90a3\u5c31\u65b0\u5efa\u4e00\u4e2a heap\uff0c\u628a top chunk \u653e\u5230\u65b0\u7684 heap \u4e0a\u53bb</li>\n<li>\u5982\u679c\u662f main arena\uff0c\u5c31\u7528 sbrk \u6269\u5927 top chunk\uff1b\u5982\u679c\u6269\u5927\u5931\u8d25\uff0c\u90a3\u5c31\u7528 mmap \u6765\u5206\u914d\u5185\u5b58</li>\n</ol>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u7ed3\u6784\">\u7ed3\u6784<a class=\"headerlink\" href=\"#\u7ed3\u6784\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5230\u8fd9\u91cc\u5c31\u57fa\u672c\u628a glibc \u7684\u5185\u5b58\u5206\u914d\u5668\u5206\u6790\u5f97\u5dee\u4e0d\u591a\u4e86\u3002glibc \u628a\u7a7a\u95f2\u5757\u653e\u5728\u5982\u4e0b\u56db\u79cd bin \u5185\uff1a</p>\n<ol>\n<li>fast bin: \u6bcf\u4e2a bin \u5bf9\u5e94\u56fa\u5b9a\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u5355\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u94fe\u8868\u5934\u6307\u9488\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>fastbinsY</code> \u6210\u5458</li>\n<li>unsorted bin: \u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u7ef4\u62a4\u4e00\u4e9b\u521a\u88ab free \u7684\u7a7a\u95f2\u5757\uff0c\u65e0\u5927\u5c0f\u8981\u6c42\uff0c\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>bins</code> \u6210\u5458\u521a\u5f00\u5934</li>\n<li>small bin: \u6bcf\u4e2a bin \u5bf9\u5e94\u56fa\u5b9a\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>bins</code> \u6210\u5458\uff0c\u7d27\u63a5\u5728 unsorted bin \u540e\u9762</li>\n<li>large bin: \u6bcf\u4e2a bin \u5bf9\u5e94\u4e00\u6bb5\u5927\u5c0f\u8303\u56f4\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u53cc\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u6309\u7167\u5757\u5927\u5c0f\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\uff0c\u6bcf\u4e2a\u5927\u5c0f\u7684\u7b2c\u4e00\u4e2a\u7a7a\u95f2\u5757\u5728 nextsize \u53cc\u5411\u94fe\u8868\u5f53\u4e2d\uff0c\u94fe\u8868\u7684\u54e8\u5175\u7ed3\u70b9\u4fdd\u5b58\u5728 <code>malloc_state</code> \u7684 <code>bins</code> \u6210\u5458\u4e2d\uff0c\u7d27\u63a5\u5728 small bin \u540e\u9762</li>\n</ol>\n<p>\u9664\u4e86\u8fd9\u56db\u79cd bin \u4ee5\u5916\uff0c\u8fd8\u6709\u4e00\u4e2a per thread \u7684 tcache \u673a\u5236\uff0c\u7ed3\u6784\u548c fast bin \u7c7b\u4f3c\uff0c\u6bcf\u4e2a bin \u5bf9\u5e94\u56fa\u5b9a\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\uff0c\u7528\u5355\u5411\u94fe\u8868\u7ef4\u62a4\uff0c\u94fe\u8868\u5934\u6307\u9488\u4fdd\u5b58\u5728 <code>tcache</code> \u7684 <code>entries</code> \u6210\u5458\u3002</p>\n<p>\u5185\u5b58\u5728\u5206\u914d\u5668\u4e2d\u6d41\u8f6c\u7684\u8fc7\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u4e00\u5f00\u59cb\u4ece top chunk \u5f53\u4e2d\u88ab\u5206\u914d\u51fa\u6765</li>\n<li>\u88ab free \u4e86\u4ee5\u540e\uff0c\u8fdb\u5165 tcache\uff0c\u6216\u8005 fast bin\uff0c\u6216\u8005\u5408\u5e76\u540e\u653e\u5230 unsorted bin\uff0c\u6216\u8005\u5408\u5e76\u5230 top chunk</li>\n<li>\u5728 malloc \u7684\u65f6\u5019\uff0c\u4ece tcache \u6216\u8005 fast bin \u5206\u914d\uff0c\u53c8\u6216\u8005\u4ece unsorted bin \u4e2d\u53d6\u51fa\uff0c\u653e\u5230 small bin \u6216 large bin\uff0c\u4e2d\u9014\u53ef\u80fd\u88ab\u5206\u914d\u3001\u62c6\u5206\u6216\u8005\u5408\u5e76</li>\n</ol>\n<pre class=\"mermaid\"><code>flowchart TD\n    top_chunk[top chunk]\n    user[user allocated]\n    tcache\n    fast_bin[fast bin]\n    small_bin[small bin]\n    large_bin[large bin]\n    unsorted_bin[unsorted bin]\n\n    top_chunk --&gt;|malloc| user\n    tcache --&gt;|malloc| user\n    fast_bin --&gt;|malloc| user\n    fast_bin --&gt;|malloc| tcache\n    fast_bin --&gt;|consolidate| unsorted_bin\n    fast_bin --&gt;|consolidate| top_chunk\n    small_bin --&gt;|malloc| user\n    small_bin --&gt;|malloc| tcache\n    large_bin --&gt;|malloc| user\n    large_bin --&gt;|malloc| unsorted_bin\n    unsorted_bin --&gt;|malloc| user\n    unsorted_bin --&gt;|malloc| tcache\n    unsorted_bin --&gt;|malloc| small_bin\n    unsorted_bin --&gt;|malloc| large_bin\n\n    user --&gt;|free| tcache\n    user --&gt;|free| fast_bin\n    user --&gt;|free| unsorted_bin\n    user --&gt;|free| top_chunk\n    small_bin --&gt;|free| unsorted_bin\n    large_bin --&gt;|free| unsorted_bin</code></pre>\n<h3 id=\"malloc_5\">malloc<a class=\"headerlink\" href=\"#malloc_5\" title=\"Permanent link\">&para;</a></h3>\n<p>malloc \u7684\u5b8c\u6574\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a</p>\n<pre class=\"mermaid\"><code>---\nconfig:\n  theme: base\n  themeVariables:\n    fontSize: \"30px\"\n---\nflowchart TD\n    malloc[malloc \u5165\u53e3\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3022\"&gt;malloc.c:3022&lt;/a&gt;\uff09]\n    tcache[\u5c1d\u8bd5\u4ece tcache \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3047\"&gt;malloc.c:3047&lt;/a&gt;\uff09]\n    fastbin[\u5c1d\u8bd5\u4ece fast bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3577\"&gt;malloc.c:3577&lt;/a&gt;\uff09]\n    fastbin_migrate[\u5982\u679c fast bin \u8fd8\u6709\u7a7a\u95f2\u5757\u4e14 tcache \u6ca1\u6709\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u4ece fast bin \u632a\u5230 tcache\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3596\"&gt;malloc.c:3596&lt;/a&gt;\uff09]\n    smallbin[\u5c1d\u8bd5\u4ece small bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3635\"&gt;malloc.c:3635&lt;/a&gt;\uff09]\n    smallbin_migrate[\u5982\u679c small bin \u8fd8\u6709\u7a7a\u95f2\u5757\u4e14 tcache \u6ca1\u6709\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u4ece small bin \u632a\u5230 tcache\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3652\"&gt;malloc.c:3652&lt;/a&gt;\uff09]\n    malloc_ret[malloc \u7ed3\u675f]\n    consolidate[consolidate\uff1a\u904d\u5386 fast bin\uff0c\u628a\u7a7a\u95f2\u5757\u548c\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u5408\u5e76\uff0c\u63d2\u5165\u5230 unsorted bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4440\"&gt;malloc.c:4440&lt;/a&gt;\uff09]\n    consolidate_2[consolidate\uff1a\u904d\u5386 fast bin\uff0c\u628a\u7a7a\u95f2\u5757\u548c\u76f8\u90bb\u7684\u7a7a\u95f2\u5757\u5408\u5e76\uff0c\u63d2\u5165\u5230 unsorted bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4440\"&gt;malloc.c:4440&lt;/a&gt;\uff09]\n    check_large[\u5757\u5927\u5c0f\u662f\u5426\u5bf9\u5e94 large bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3695\"&gt;malloc.c:3695&lt;/a&gt;\uff09]\n    loop[\u5f00\u59cb\u5faa\u73af\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3725\"&gt;malloc.c:3725&lt;/a&gt;\uff09]\n    unsorted_bin[\u904d\u5386 unsorted bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3728\"&gt;malloc.c:3728&lt;/a&gt;\uff09]\n    remainder[\u5185\u5b58\u5c40\u90e8\u6027\u4f18\u5316\uff1a\u6700\u8fd1\u4e00\u6b21 split \u51fa\u6765\u7684 chunk \u662f\u5426\u6709\u8db3\u591f\u7684\u7a7a\u95f4\u5206\u914d\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3756\"&gt;malloc.c:3756&lt;/a&gt;\uff09]\n    remainder_success[\u62c6\u5206\u8fd9\u4e2a chunk \u4ee5\u5b8c\u6210\u5206\u914d\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3761\"&gt;malloc.c:3761&lt;/a&gt;\uff09]\n    remove_unsorted_bin[\u628a\u5f53\u524d chunk \u4ece unsorted bin \u4e2d\u5220\u9664\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3784\"&gt;malloc.c:3784&lt;/a&gt;\uff09]\n    check_same_size[\u5f53\u524d\u7a7a\u95f2\u5757\u5927\u5c0f\u548c\u8981\u5206\u914d\u7684\u5927\u5c0f\u662f\u5426\u76f8\u540c\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3792\"&gt;malloc.c:3792&lt;/a&gt;\uff09]\n    check_tcache_full[tcache bin \u662f\u5426\u5df2\u6ee1\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3800\"&gt;malloc.c:3800&lt;/a&gt;\uff09]\n    alloc_now[\u5206\u914d\u5f53\u524d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3807\"&gt;malloc.c:3807&lt;/a&gt;\uff09]\n    move_to_tcache[\u628a\u5f53\u524d\u7a7a\u95f2\u5757\u632a\u5230 tcache\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3803\"&gt;malloc.c:3803&lt;/a&gt;\uff09]\n    move_to_bin[\u6839\u636e\u5f53\u524d\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\uff0c\u632a\u5230 small bin \u6216 large bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3821\"&gt;malloc.c:3821&lt;/a&gt;\uff09]\n    check_tcache[\u68c0\u67e5 tcache \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3891\"&gt;malloc.c:3891&lt;/a&gt;\uff09]\n    alloc_tcache[\u4ece tcache \u5206\u914d\u7a7a\u95f2\u5757]\n    unsorted_bin_exit[\u68c0\u67e5 tcache \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3906\"&gt;malloc.c:3906&lt;/a&gt;\uff09]\n    check_large_alloc[\u5757\u5927\u5c0f\u662f\u5426\u5bf9\u5e94 large bin\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3917\"&gt;malloc.c:3917&lt;/a&gt;\uff09]\n    alloc_large[\u5c1d\u8bd5\u4ece large bin \u4e2d\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3922\"&gt;malloc.c:3922&lt;/a&gt;\uff09]\n    alloc_larger[\u904d\u5386\u66f4\u5927\u7684 bin\uff0c\u5c1d\u8bd5\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3990\"&gt;malloc.c:3990&lt;/a&gt;\uff09]\n    alloc_top[\u5c1d\u8bd5\u4ece top chunk \u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4087\"&gt;malloc.c:4087&lt;/a&gt;\uff09]\n    alloc_system[\u4ece\u7cfb\u7edf\u8bf7\u6c42\u66f4\u591a\u5185\u5b58\u6765\u5206\u914d\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4139\"&gt;malloc.c:4139&lt;/a&gt;\uff09]\n    check_fast[fast bin \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff08&lt;a href=\"https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4126\"&gt;malloc.c:4126&lt;/a&gt;\uff09]\n\n    malloc --&gt; tcache\n    tcache --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    tcache --&gt;|\u5206\u914d\u5931\u8d25| fastbin\n    fastbin --&gt;|\u5206\u914d\u5931\u8d25| smallbin\n    fastbin --&gt;|\u5206\u914d\u6210\u529f| fastbin_migrate \n    fastbin_migrate --&gt; malloc_ret\n    smallbin --&gt;|\u5206\u914d\u6210\u529f| smallbin_migrate\n    smallbin_migrate --&gt; malloc_ret\n    smallbin --&gt;|\u5206\u914d\u5931\u8d25| check_large\n    check_large --&gt;|\u662f| consolidate\n    check_large --&gt;|\u5426| loop\n    consolidate --&gt; loop\n    loop --&gt; unsorted_bin\n    unsorted_bin --&gt;|unsorted bin \u975e\u7a7a\uff0c\u6216\u8005\u5faa\u73af\u6b21\u6570\u4e0d\u8db3 10000 \u6b21| remainder\n    remainder --&gt;|\u662f| remainder_success\n    remainder_success --&gt; malloc_ret\n    remainder --&gt;|\u5426| remove_unsorted_bin\n    remove_unsorted_bin --&gt; check_same_size\n    check_same_size --&gt;|\u662f| check_tcache_full\n    check_tcache_full --&gt;|\u5426| move_to_tcache\n    check_tcache_full --&gt; |\u662f| alloc_now\n    alloc_now --&gt; malloc_ret\n    move_to_tcache --&gt; unsorted_bin\n    check_same_size --&gt;|\u5426| move_to_bin\n    move_to_bin --&gt; check_tcache\n    check_tcache --&gt;|\u662f| alloc_tcache\n    alloc_tcache --&gt; malloc_ret\n    check_tcache --&gt;|\u5426| unsorted_bin\n    unsorted_bin --&gt;|unsorted bin \u5df2\u7a7a\uff0c\u6216\u8005\u5faa\u73af\u6b21\u6570\u8d85\u8fc7 10000 \u6b21| unsorted_bin_exit\n    unsorted_bin_exit --&gt;|\u662f| alloc_tcache\n    unsorted_bin_exit --&gt;|\u5426| check_large_alloc\n    check_large_alloc --&gt;|\u662f| alloc_large\n    alloc_large --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    alloc_large --&gt;|\u5206\u914d\u5931\u8d25| alloc_larger\n    check_large_alloc --&gt;|\u5426| alloc_larger\n    alloc_larger --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    alloc_larger --&gt;|\u5206\u914d\u5931\u8d25| alloc_top\n    alloc_top --&gt;|\u5206\u914d\u6210\u529f| malloc_ret\n    alloc_top --&gt;|\u5206\u914d\u5931\u8d25| check_fast\n    check_fast --&gt;|\u662f| consolidate_2\n    consolidate_2 --&gt; loop\n    check_fast --&gt;|\u5426| alloc_system\n    alloc_system --&gt; malloc_ret</code></pre>\n<p>\u524d\u9762\u5206\u6bb5\u6574\u7406\u4e86 malloc \u7684\u5b9e\u73b0\uff0c\u5728\u8fd9\u91cc\u5217\u51fa\u5b8c\u6574\u7684 malloc \u6d41\u7a0b\uff1a</p>\n<ol>\n<li>malloc \u7684\u5165\u53e3\u662f <code>__libc_malloc (size_t bytes)</code> \u51fd\u6570</li>\n<li>\u5982\u679c\u914d\u7f6e\u4e86 malloc hook\uff0c\u5219\u8c03\u7528 malloc hook\uff0c\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c</li>\n<li>\u6839\u636e\u7528\u6237\u4f20\u5165\u7684 malloc \u7684\u5b57\u8282\u6570\uff08<code>bytes</code>\uff09\uff0c\u7528 <code>checked_request2size</code> \u8ba1\u7b97\u51fa\u5b9e\u9645\u7684 chunk \u5927\u5c0f\uff0c\u7b97\u6cd5\u662f\u5148\u52a0\u4e0a <code>sizeof(size_t)</code>\uff08\u7ed9 <code>mchunk_size</code> \u9884\u7559\u7a7a\u95f4\uff09\uff0c\u7136\u540e\u5411\u4e0a\u5bf9\u9f50\u5230 <code>MALLOC_ALIGNMENT</code>\uff08\u901a\u5e38\u662f <code>2 * sizeof(size_t)</code>\uff09\u7684\u500d\u6570\uff0c\u518d\u548c <code>MINSIZE</code> \u53d6 max\uff0c\u5176\u4e2d <code>MINSIZE</code> \u901a\u5e38\u662f <code>4 * sizeof(size_t)</code>\uff0c\u56e0\u4e3a\u7a7a\u95f2\u5757\u81f3\u5c11\u8981\u4fdd\u5b58\u4e24\u4e2a size \u52a0\u4e0a\u53cc\u5411\u94fe\u8868\u7684 <code>fd</code> \u548c <code>bk</code> \u6307\u9488</li>\n<li>\u5982\u679c tcache \u8fd8\u6ca1\u521d\u59cb\u5316\uff0c\u5c31\u521d\u59cb\u5316 tcache</li>\n<li>\u6839\u636e chunk \u5927\u5c0f\uff0c\u8ba1\u7b97 tcache index\uff0c\u68c0\u67e5\u5bf9\u5e94\u7684 bin \u662f\u5426\u6709\u7a7a\u95f2\u5757\uff1b\u5982\u679c\u6709\uff0c\u76f4\u63a5\u5206\u914d\u7a7a\u95f2\u5757\u5e76\u8fd4\u56de</li>\n<li>\u63a5\u7740\u83b7\u53d6\u4e00\u4e2a arena\uff0c\u5982\u6709\u5fc5\u8981\uff0c\u83b7\u53d6 arena \u7684\u9501\uff1b\u5728\u5355\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u4e00\u4e2a main_arena\uff1b\u591a\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u6709\u4e00\u4e2a\u9ed8\u8ba4\u7684 arena \u6307\u9488\uff08<code>static __thread mstate thread_arena</code>\uff09\uff0c\u5728\u9047\u5230 lock contention \u7684\u65f6\u5019\u53ef\u4ee5\u52a8\u6001\u5207\u6362</li>\n<li>\u8fdb\u5165 <code>_int_malloc</code> \u4ece arena \u4e2d\u5206\u914d\u4e00\u4e2a chunk\uff0c\u5206\u914d\u5b8c\u6210\u540e\u91ca\u653e arena \u7684\u9501</li>\n<li>\u63a5\u7740\u5206\u6790 <code>_int_malloc</code> \u7684\u5b9e\u73b0\uff0c\u9664 tcache \u4ee5\u5916\u7684\u5927\u90e8\u5206\u903b\u8f91\u90fd\u5728 <code>_int_malloc</code> \u51fd\u6570\u4e2d</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 fast bin \u7684\u5757\u5927\u5c0f\uff0c\u5728\u5bf9\u5e94\u7684 fast bin \u7684\u5355\u5411\u94fe\u8868\u4e2d\u5bfb\u627e\u7a7a\u95f2\u5757\uff1b\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u5219\u53d6\u51fa\u94fe\u8868\u5934\u7684\u7a7a\u95f2\u5757\uff0c\u4f5c\u4e3a\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u63a5\u7740\u628a fast bin \u94fe\u8868\u4e0a\u5269\u4f59\u7684\u7a7a\u95f2\u5757\u632a\u5230 tcache \u5f53\u4e2d\uff0c\u76f4\u5230 fast bin \u94fe\u8868\u7a7a\u6216\u8005 tcache \u6ee1\u4e3a\u6b62\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 small bin \u7684\u5757\u5927\u5c0f\uff0c\u5728\u5bf9\u5e94\u7684 small bin \u7684\u53cc\u5411\u94fe\u8868\u4e2d\u5bfb\u627e\u7a7a\u95f2\u5757\uff1b\u5982\u679c\u94fe\u8868\u975e\u7a7a\uff0c\u5219\u53d6\u51fa\u94fe\u8868\u5c3e\u7684\u7a7a\u95f2\u5757\uff0c\u4f5c\u4e3a\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u63a5\u7740\u628a small bin \u94fe\u8868\u4e0a\u5269\u4f59\u7684\u7a7a\u95f2\u5757\u632a\u5230 tcache \u5f53\u4e2d\uff0c\u76f4\u5230 small bin \u94fe\u8868\u7a7a\u6216\u8005 tcache \u6ee1\u4e3a\u6b62\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 large bin \u7684\u5757\u5927\u5c0f\uff0c\u5219\u8fdb\u884c\u4e00\u6b21 malloc_consolidate\uff1a\u904d\u5386 fast bin \u6bcf\u4e00\u4e2a bin \u7684\u6bcf\u4e00\u4e2a\u7a7a\u95f2\u5757\uff0c\u5c1d\u8bd5\u628a\u5b83\u548c\u5185\u5b58\u4e0a\u76f8\u90bb\u7684\u524d\u540e\u7a7a\u95f2\u5757\u5408\u5e76\uff0c\u5408\u5e76\u540e\u7684\u7a7a\u95f2\u5757\u653e\u5165 unsorted bin\uff1b\u7279\u522b\u5730\uff0c\u5982\u679c\u7a7a\u95f2\u5757\u548c top chunk \u76f8\u90bb\uff0c\u5c31\u4f1a\u76f4\u63a5\u5408\u5e76\u5230 top chunk\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u628a\u7a7a\u95f2\u5757\u653e\u5165 unsorted bin</li>\n<li>\u5f00\u59cb\u4e00\u4e2a\u5927\u7684\u65e0\u9650\u5faa\u73af <code>for (;;)</code>\uff0c\u5982\u679c\u540e\u7eed\u5c1d\u8bd5\u5404\u79cd\u65b9\u5f0f\u90fd\u5206\u914d\u4e0d\u6210\u529f\uff0c\u4f46\u662f fast bin \u8fd8\u6709\u7a7a\u95f2\u5757\uff0c\u5728 malloc_consolidate \u540e\u4f1a\u4ece\u8fd9\u91cc\u5f00\u59cb\u518d\u5c1d\u8bd5\u4e00\u6b21\u5206\u914d</li>\n<li>\u904d\u5386 unsorted bin\uff0c\u6700\u591a\u5904\u7406 10000 \u4e2a\u7a7a\u95f2\u5757\uff1a<ol>\n<li>\u5982\u679c\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u5bf9\u5e94 small bin\uff0c\u5e76\u4e14\u5b83\u662f\u6700\u8fd1\u521a split \u51fa\u6765\u7684\u7a7a\u95f2\u5757\uff0c\u5e76\u4e14\u53ef\u4ee5\u653e\u5f97\u4e0b\u8981\u5206\u914d\u7684\u5757\uff0c\u5c31\u539f\u5730\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u5219\u653e\u56de\u5230 unsorted bin\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u628a\u7a7a\u95f2\u5757\u4ece unsorted bin \u94fe\u8868\u4e2d\u5220\u9664</li>\n<li>\u5982\u679c\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u6b63\u597d\u662f\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\uff0c\u5224\u65ad tcache \u662f\u5426\u8fd8\u6709\u7a7a\u95f4\uff1b\u5982\u679c tcache \u5df2\u7ecf\u6ee1\u4e86\uff0c\u76f4\u63a5\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u4f5c\u4e3a\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f\uff1b\u5982\u679c tcache \u8fd8\u6ca1\u6ee1\uff0c\u5219\u5148\u628a\u7a7a\u95f2\u5757\u632a\u5230 tcache \u5f53\u4e2d\uff0c\u7ee7\u7eed\u5904\u7406 unsorted bin \u7684\u5176\u4ed6\u7a7a\u95f2\u5757\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u5c3d\u91cf\u628a tcache \u586b\u6ee1</li>\n<li>\u6839\u636e\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\uff0c\u63d2\u5165\u5230\u5bf9\u5e94\u7684 small bin \u6216\u8005 large bin \u5f53\u4e2d</li>\n<li>\u8bb0\u5f55\u63d2\u5165\u5230 small bin \u6216\u8005 large bin \u7684\u7a7a\u95f2\u5757\u4e2a\u6570\uff0c\u5982\u679c\u8d85\u8fc7\u4e86\u9608\u503c\uff0c\u5e76\u4e14\u4e4b\u524d\u5df2\u7ecf\u627e\u5230\u4e00\u4e2a\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u6b63\u597d\u662f\u8981\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\uff0c\u540c\u65f6\u632a\u5230\u4e86 tcache \u5f53\u4e2d\uff0c\u5219\u7acb\u5373\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u4ece tcache \u4e2d\u53d6\u51fa\u5e76\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f\uff1b\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u907f\u514d\u5904\u7406\u592a\u591a\u65e0\u5173\u7684 unsorted bin \u4e2d\u7684\u7a7a\u95f2\u5757\uff0c\u5bfc\u81f4 malloc \u8c03\u7528\u65f6\u95f4\u8fc7\u957f</li>\n</ol>\n</li>\n<li>\u5982\u679c\u5728\u904d\u5386 unsorted bin \u8fc7\u7a0b\u4e2d\u627e\u5230\u4e86\u548c\u8981\u5206\u914d\u7684\u5757\u4e00\u6837\u5927\u7684\u7a7a\u95f2\u5757\uff0c\u90a3\u4e48\u8fd9\u4e2a\u7a7a\u95f2\u5757\u5df2\u7ecf\u5728 tcache \u5f53\u4e2d\u4e86\uff0c\u5219\u7acb\u5373\u628a\u8fd9\u4e2a\u7a7a\u95f2\u5757\u4ece tcache \u4e2d\u53d6\u51fa\u5e76\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5c5e\u4e8e large bin \u7684\u5757\u5927\u5c0f\uff0c\u5219\u627e\u5230\u5bf9\u5e94\u7684 large bin\uff0c\u4ece\u5c0f\u5230\u5927\u901a\u8fc7 nextsize \u94fe\u8868\u904d\u5386 large bin \u4e2d\u7684\u7a7a\u95f2\u5757\uff0c\u627e\u5230\u4e00\u4e2a\u8db3\u591f\u5927\u7684\u7a7a\u95f2\u5757\uff0c\u5bf9\u5b83\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u5219\u653e\u56de\u5230 unsorted bin\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u6839\u636e chunk size \u5927\u5c0f\uff0c\u627e\u5230\u5bf9\u5e94\u7684 small bin \u6216\u8005 large bin\uff0c\u7136\u540e\u4ece\u5c0f\u5230\u5927\u904d\u5386\u5404\u4e2a bin\uff08\u53ef\u80fd\u4ece small bin \u4e00\u8def\u904d\u5386\u5230 large bin\uff09\uff0c\u901a\u8fc7 bitmap \u8df3\u8fc7\u90a3\u4e9b\u7a7a\u7684 bin\uff0c\u627e\u5230\u7b2c\u4e00\u4e2a\u975e\u7a7a\u7684 bin \u7684\u7a7a\u95f2\u5757\uff0c\u5bf9\u5b83\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u5219\u653e\u56de\u5230 unsorted bin\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5982\u679c top chunk \u8db3\u591f\u5927\uff0c\u5219\u5bf9\u5b83\u8fdb\u884c\u62c6\u5206\uff0c\u524d\u9762\u7684\u90e8\u5206\u662f\u5206\u914d\u7ed9 malloc \u8c03\u7528\u8005\u7684\u5757\uff0c\u540e\u9762\u7684\u90e8\u5206\u6210\u4e3a\u65b0\u7684 top chunk\uff0c\u7136\u540e\u51fd\u6570\u7ed3\u675f</li>\n<li>\u5982\u679c\u6b64\u65f6 fast bin \u6709\u7a7a\u95f2\u5757\uff0c\u8c03\u7528 malloc_consolidate\uff0c\u7136\u540e\u56de\u5230\u65e0\u9650\u5faa\u73af\u7684\u5f00\u5934\u518d\u5c1d\u8bd5\u4e00\u6b21\u5206\u914d</li>\n<li>\u6700\u540e\u7684\u515c\u5e95\u5206\u914d\u65b9\u6cd5\uff1a\u8c03\u7528 <code>sysmalloc</code>\uff0c\u901a\u8fc7 mmap \u6216 sbrk \u5411\u64cd\u4f5c\u7cfb\u7edf\u7533\u8bf7\u66f4\u591a\u7684\u5185\u5b58</li>\n</ol>\n<h3 id=\"free_4\">free<a class=\"headerlink\" href=\"#free_4\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u8fd9\u91cc\u5217\u51fa\u5b8c\u6574\u7684 free \u6d41\u7a0b\uff1a</p>\n<ol>\n<li>free \u7684\u5165\u53e3\u662f <code>__libc_free (void *mem)</code> \u51fd\u6570</li>\n<li>\u5982\u679c\u914d\u7f6e\u4e86 free hook\uff0c\u5219\u8c03\u7528 free hook\uff0c\u76f4\u63a5\u8fd4\u56de</li>\n<li>\u5982\u679c\u662f\u8c03\u7528 <code>free(NULL)</code>\uff0c\u76f4\u63a5\u8fd4\u56de</li>\n<li>\u68c0\u67e5 <code>mchunk_size</code> \u7684 <code>IS_MAPPED</code> \u5b57\u6bb5\uff0c\u5982\u679c\u5b83\u4e4b\u524d\u662f\u901a\u8fc7 mmap \u5206\u914d\u7684\uff0c\u90a3\u4e48\u5bf9\u5b83\u8fdb\u884c munmap\uff0c\u7136\u540e\u8fd4\u56de</li>\n<li>\u5982\u679c tcache \u8fd8\u6ca1\u521d\u59cb\u5316\uff0c\u5c31\u521d\u59cb\u5316 tcache</li>\n<li>\u627e\u5230\u8fd9\u4e2a chunk \u4ece\u54ea\u4e2a arena \u5206\u914d\u7684\uff1a\u68c0\u67e5 <code>mchunk_size</code> \u7684 <code>NON_MAIN_ARENA</code> \u5b57\u6bb5\uff0c\u5982\u679c\u5b83\u4e0d\u662f\u4ece main arena \u5206\u914d\u7684\uff0c\u5219\u6839\u636e chunk \u7684\u5730\u5740\uff0c\u627e\u5230 heap \u7684\u5730\u5740\uff08heap \u7684\u5927\u5c0f\u662f\u6709\u4e0a\u9650\u7684\uff0c\u5e76\u4e14 heap \u7684\u8d77\u59cb\u5730\u5740\u662f\u5bf9\u9f50\u5230 <code>HEAP_MAX_SIZE</code> \u7684\u6574\u500d\u6570\u8fb9\u754c\u7684\uff09\uff0c\u518d\u6839\u636e heap \u5f00\u5934\u7684 heap_info \u627e\u5230 arena \u7684\u5730\u5740</li>\n<li>\u8fdb\u5165 <code>_int_free</code>\uff0c\u63a5\u7740\u5206\u6790 <code>_int_free</code> \u7684\u5b9e\u73b0</li>\n<li>\u6839\u636e chunk size \u627e\u5230\u5bf9\u5e94\u7684 tcache bin\uff0c\u5982\u679c\u5b83\u8fd8\u6ca1\u6709\u6ee1\uff0c\u5219\u628a\u7a7a\u95f2\u5757\u653e\u5230 tcache \u5f53\u4e2d\uff0c\u7136\u540e\u8fd4\u56de</li>\n<li>\u5224\u65ad chunk size \u5927\u5c0f\uff0c\u5982\u679c\u5bf9\u5e94 fast bin \u7684\u5757\u5927\u5c0f\uff0c\u628a\u7a7a\u95f2\u5757\u653e\u5230\u5bf9\u5e94\u7684 fast bin \u7684\u5355\u5411\u94fe\u8868\u4e2d\uff0c\u7136\u540e\u8fd4\u56de\uff1b\u6ce8\u610f\u6b64\u65f6\u6ca1\u6709\u83b7\u53d6 arena \u7684\u9501\uff0c\u6240\u4ee5 fast bin \u7684\u64cd\u4f5c\u4f1a\u7528\u5230\u539f\u5b50\u6307\u4ee4\uff0c\u540c\u7406 malloc \u4e2d\u5bf9 fast bin \u7684\u64cd\u4f5c\u4e5f\u8981\u7528\u5230\u539f\u5b50\u6307\u4ee4\uff0c\u5373\u4f7f malloc \u6301\u6709\u4e86 arena \u7684\u9501</li>\n<li>\u83b7\u53d6 arena \u7684\u9501\uff0c\u5c1d\u8bd5\u628a\u7a7a\u95f2\u5757\u548c\u5728\u5185\u5b58\u4e2d\u76f8\u90bb\u7684\u524d\u540e\u7a7a\u95f2\u5757\u8fdb\u884c\u5408\u5e76\uff0c\u5408\u5e76\u540e\u7684\u7a7a\u95f2\u5757\u653e\u5165 unsorted bin\uff1b\u5408\u5e76\u65f6\uff0c\u5982\u679c\u88ab\u5408\u5e76\u7684\u7a7a\u95f2\u5757\u5df2\u7ecf\u5728 small bin \u6216\u8005 large bin \u5f53\u4e2d\uff0c\u5229\u7528\u53cc\u5411\u94fe\u8868\u7684\u7279\u6027\uff0c\u628a\u5b83\u4ece\u53cc\u5411\u94fe\u8868\u4e2d\u5220\u9664\uff1b\u5982\u679c\u548c top chunk \u76f8\u90bb\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u5408\u5e76\u5230 top chunk \u4e0a\uff0c\u7136\u540e\u8fd4\u56de</li>\n<li>\u5982\u679c\u91ca\u653e\u7684\u5757\u6bd4\u8f83\u5927\uff0c\u8d85\u8fc7\u4e86\u9608\u503c\uff0c\u5219\u89e6\u53d1\u4e00\u6b21 malloc_consolidate</li>\n</ol>\n<h2 id=\"\u5404\u79cd\u5e38\u91cf\u7684\u9ed8\u8ba4\u503c\">\u5404\u79cd\u5e38\u91cf\u7684\u9ed8\u8ba4\u503c<a class=\"headerlink\" href=\"#\u5404\u79cd\u5e38\u91cf\u7684\u9ed8\u8ba4\u503c\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0b\u9762\u7ed9\u51fa glibc \u5185\u5b58\u5206\u914d\u5668\u5404\u5e38\u91cf\u5728 64 \u4f4d\u4e0b\u7684\u9ed8\u8ba4\u503c\uff1a</p>\n<ol>\n<li><code>MALLOC_ALIGNMENT = max(2 * SIZE_SZ, __alignof__ (long double))</code> \u7b49\u4e8e 16</li>\n<li><code>MIN_CHUNK_SIZE = offsetof(struct malloc_chunk, fd_nextsize)</code> \u7b49\u4e8e 32</li>\n<li><code>MINSIZE = alignUp(MIN_CHUNK_SIZE, MALLOC_ALIGNMENT)</code> \u7b49\u4e8e 32</li>\n<li><code>MAX_FAST_SIZE = 80 * SIZE_SZ / 4</code> \u7b49\u4e8e 160</li>\n<li><code>NSMALLBINS = 64</code></li>\n<li><code>MIN_LARGE_SIZE = (NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH</code> \u7b49\u4e8e 1024</li>\n<li><code>DEFAULT_MMAP_THRESHOLD_MIN = 128 * 1024</code> \u5373 128KB</li>\n<li><code>DEFAULT_MMAP_THRESHOLD_MAX = 4 * 1024 * 1024 * sizeof(long)</code> \u5373 32MB</li>\n<li><code>HEAP_MIN_SIZE = 32 * 1024</code> \u5373 32KB</li>\n<li><code>HEAP_MAX_SIZE = 2 * DEFAULT_MMAP_THRESHOLD_MAX</code> \u5373 64MB</li>\n<li><code>TCACHE_MAX_BINS = 64</code></li>\n<li><code>TCACHE_FILL_COUNT = 7</code></li>\n<li><code>NFASTBINS = fastbin_index(request2size(MAX_FAST_SIZE)) + 1</code> \u5373 10</li>\n<li><code>NBINS = 128</code></li>\n<li><code>DEFAULT_MXFAST = 64 * sizeof(size_t) / 4</code> \u5373 128</li>\n</ol>\n<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5404\u4e2a bin \u8d1f\u8d23\u7684\u5757\u5927\u5c0f\u8303\u56f4\uff1a</p>\n<ol>\n<li>tcache: \u5757\u5927\u5c0f\u4e0d\u8d85\u8fc7 1040 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(1032)</code> \u6216\u66f4\u5c0f</li>\n<li>fast bin: \u5757\u5927\u5c0f\u4e0d\u8d85\u8fc7 128 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(120)</code> \u6216\u66f4\u5c0f</li>\n<li>small bin: \u5757\u5927\u5c0f\u4e0d\u8d85\u8fc7 1008 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(1000)</code> \u6216\u66f4\u5c0f</li>\n<li>large bin: \u5757\u5927\u5c0f\u4e0d\u5c0f\u4e8e 1024 \u5b57\u8282\uff0c\u4e0d\u8d85\u8fc7 131056 \u5b57\u8282\uff0c\u5bf9\u5e94 <code>malloc(1001)</code> \u5230 <code>malloc(131048)</code> \u7684\u8303\u56f4\uff0c\u66f4\u5927\u7684\u5185\u5b58\u5206\u914d\u4f1a\u76f4\u63a5\u8d70 mmap</li>\n</ol>\n<h2 id=\"\u6027\u80fd\u4f18\u5316\">\u6027\u80fd\u4f18\u5316<a class=\"headerlink\" href=\"#\u6027\u80fd\u4f18\u5316\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b glibc \u5185\u5b58\u5206\u914d\u5668\u7684\u5404\u79cd\u6027\u80fd\u4f18\u5316\u7279\u6027\uff1a</p>\n<ol>\n<li>tcache \u4f5c\u4e3a\u4e00\u4e2a thread local \u7684\u7ed3\u6784\uff0c\u4e0d\u9700\u8981\u9501\uff0c\u6027\u80fd\u662f\u6700\u597d\u7684\uff0c\u6240\u4ee5\u5c3d\u91cf\u628a\u7a7a\u95f2\u5757\u90fd\u4e22\u5230 tcache \u91cc\u9762\uff0c\u65e0\u8bba\u662f\u521a free \u7684\u7a7a\u95f2\u5757\uff0c\u8fd8\u662f\u5728 malloc \u8fc7\u7a0b\u4e2d\uff0c\u987a\u5e26\u628a\u4e00\u4e9b\u7a7a\u95f2\u5757\u4ece fast bin \u6216\u8005 small bin \u4e22\u5230 tcache \u91cc\uff0c\u8fd9\u6837\u4e5f\u51cf\u5c11\u4e86 lock arena \u7684\u6b21\u6570</li>\n<li>fast bin \u867d\u7136\u4e0d\u518d\u662f thread local\uff0c\u4f46\u5b83\u5728 free \u8def\u5f84\u4e0a\u4f7f\u7528\u539f\u5b50\u6307\u4ee4\u6765\u4ee3\u66ff\u9501\uff0c\u4f7f\u5f97 free \u5728\u5f88\u591a\u65f6\u5019\u4e0d\u9700\u8981\u83b7\u53d6 arena \u7684\u9501\uff1b\u800c\u628a fast bin \u7684\u7a7a\u95f2\u5757\u7684\u5408\u5e76\u64cd\u4f5c\u632a\u5230 malloc \u4e2d\u8fdb\u884c\uff0c\u6b64\u65f6 arena \u7684\u9501\u662f lock \u72b6\u6001\uff0c\u5c3d\u91cf\u5728\u4e00\u6b21 lock \u7684\u4e34\u754c\u533a\u91cc\u505a\u66f4\u591a\u7684\u4e8b\u60c5\uff0c\u51cf\u5c11 lock \u7684\u6b21\u6570</li>\n<li>small bin \u548c large bin \u7684\u533a\u5206\uff0c\u4e3b\u8981\u662f\u8003\u8651\u5230\u4e86\u5206\u914d\u7684\u5757\u7684\u5927\u5c0f\u5206\u5e03\uff0c\u8d8a\u5927\u503e\u5411\u4e8e\u8d8a\u7a00\u758f\uff1b\u4ee3\u4ef7\u662f large bin \u9700\u8981\u989d\u5916\u7ef4\u62a4 nextsize \u94fe\u8868\u6765\u5feb\u901f\u5730\u5bfb\u627e\u4e0d\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757</li>\n<li>\u5728\u56de\u6536 unsorted bin \u7684\u65f6\u5019\uff0c\u4f1a\u8fdb\u884c\u4e00\u4e2a\u5185\u5b58\u5c40\u90e8\u6027\u4f18\u5316\uff0c\u5373\u503e\u5411\u4e8e\u8fde\u7eed\u5730\u4ece\u540c\u4e00\u4e2a\u5757\u4e2d\u5207\u51fa\u5c0f\u5757\u7528\u4e8e\u5206\u914d\uff0c\u9002\u5408\u5728\u5faa\u73af\u4e2d\u5206\u914d\u5185\u5b58\u7684\u573a\u666f</li>\n<li>\u56de\u6536 unsorted bin \u65f6\uff0c\u5982\u679c\u9047\u5230\u4e86\u6b63\u597d\u548c\u8981\u5206\u914d\u7684\u5757\u5927\u5c0f\u76f8\u540c\u7684\u7a7a\u95f2\u5757\u65f6\uff0c\u5148\u4e0d\u6025\u7740\u5206\u914d\uff0c\u800c\u662f\u4e22\u5230 tcache \u4e2d\uff0c\u7136\u540e\u7ee7\u7eed\u5f80\u524d\u56de\u6536\u82e5\u5e72\u4e2a\u7a7a\u95f2\u5757\uff0c\u76f4\u5230 tcache \u6ee1\u4e86\u6216\u8005\u9047\u5230\u4e86\u8db3\u591f\u591a\u7684\u5927\u5c0f\u4e0d\u540c\u7684\u7a7a\u95f2\u5757\u4e3a\u6b62\uff1a\u8fd9\u662f\u5229\u7528\u4e86 unsorted bin \u4e2d\u7a7a\u95f2\u5757\u5927\u5c0f\u7684\u5c40\u90e8\u6027\uff0c\u6709\u673a\u4f1a\u628a\u4e00\u7cfb\u5217\u8fde\u7eed\u7684\u76f8\u540c\u5927\u5c0f\u7684\u7a7a\u95f2\u5757\u62ff\u5230 tcache \u5f53\u4e2d\uff0c\u5e76\u4e14\u9650\u5236\u4e86\u641c\u7d22\u7684\u957f\u5ea6\uff0c\u907f\u514d\u5e26\u6765\u8fc7\u591a\u989d\u5916\u7684\u5ef6\u8fdf</li>\n<li>\u5982\u679c\u5c1d\u8bd5\u4e86 unsorted bin\u3001small bin\u3001large bin \u548c top chunk \u90fd\u65e0\u6cd5\u5206\u914d\uff0c\u6700\u540e\u518d\u68c0\u67e5\u4e00\u6b21 fast bin \u662f\u5426\u4e3a\u7a7a\uff0c\u5982\u679c\u662f\u7a7a\u7684\uff0c\u5219\u8fdb\u884c\u4e00\u6b21 consolidate\uff0c\u628a fast bin \u91cc\u7684\u7a7a\u95f2\u5757\u4e22\u5230 unsorted bin \u4e2d\uff0c\u518d\u91cd\u65b0\u5c1d\u8bd5\u5206\u914d\u4e00\u6b21\uff1a\u6ce8\u610f\u8fd9\u6574\u4e2a\u8fc7\u7a0b malloc \u90fd\u662f\u6301\u6709 arena \u9501\u7684\uff0c\u800c fast bin \u5728 free \u4e2d\u7684\u5199\u5165\u662f\u4e0d\u9700\u8981\u6301\u6709 arena \u9501\u7684\uff0c\u800c\u662f\u76f4\u63a5\u7528\u539f\u5b50\u6307\u4ee4\u66f4\u65b0\uff0c\u6240\u4ee5\u8fd9\u662f\u8003\u8651\u5230\u5176\u4ed6\u7ebf\u7a0b\u5728\u540c\u65f6\u5f80\u540c\u4e00\u4e2a arena free \u7684\u60c5\u51b5</li>\n<li>\u5728\u5408\u5e76\u76f8\u90bb\u7a7a\u95f2\u5757\u7684\u65f6\u5019\uff0c\u88ab\u5408\u5e76\u7684\u7a7a\u95f2\u5757\u53ef\u80fd\u5df2\u7ecf\u5728 unsorted bin\u3001small bin \u6216\u8005 large bin \u5f53\u4e2d\uff0c\u4e3a\u4e86\u80fd\u591f\u628a\u7a7a\u95f2\u5757\u4ece\u8fd9\u4e9b bin \u91cc\u5220\u9664\uff0c\u7528\u53cc\u5411\u94fe\u8868\u6765\u5b9e\u73b0 O(1) \u65f6\u95f4\u7684\u5220\u9664</li>\n</ol>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://sourceware.org/glibc/wiki/MallocInternals\">Malloc Internals</a></li>\n</ul>", "image": null, "date_modified": "2025-03-30T00:00:00+00:00", "authors": [], "tags": ["allocator", "glibc", "linux", "malloc", "software"]}, {"id": "https://jia.je/software/2025/03/06/android-runtime-interpreter/", "url": "https://jia.je/software/2025/03/06/android-runtime-interpreter/", "title": "Android Runtime \u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"android-runtime-\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76\">Android Runtime \u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#android-runtime-\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728 <a href=\"../../01/v8-ignition-internals/\">V8 Ignition \u89e3\u91ca\u5668\u7684\u5185\u90e8\u5b9e\u73b0\u63a2\u7a76</a> \u4e2d\u63a2\u7a76\u4e86 JavaScript \u5f15\u64ce V8 \u7684\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\uff0c\u63a5\u4e0b\u6765\u5206\u6790\u4e00\u4e0b Android Runtime (ART) \u7684\u89e3\u91ca\u5668\uff0c\u5176\u539f\u7406\u4e5f\u662f\u7c7b\u4f3c\u7684\u3002\u672c\u535a\u5ba2\u5728 ARM64 Ubuntu 24.04 \u5e73\u53f0\u4e0a\u9488\u5bf9 <a href=\"https://android.googlesource.com/platform/art/+/refs/tags/android-15.0.0_r1/runtime/interpreter/\">Android Runtime (ART) 15.0.0 r1</a> \u7248\u672c\u8fdb\u884c\u5206\u6790\u3002</p>\n<!-- more -->\n\n<h2 id=\"dalvik-bytecode\">Dalvik Bytecode<a class=\"headerlink\" href=\"#dalvik-bytecode\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5728\u5206\u6790\u89e3\u91ca\u5668\u7684\u4ee3\u7801\u524d\uff0c\u9700\u8981\u5148\u4e86\u89e3\u4e00\u4e0b\u89e3\u91ca\u5668\u7684\u8f93\u5165\uff0c\u4e5f\u5c31\u662f\u5b83\u6267\u884c\u7684\u5b57\u8282\u7801\u683c\u5f0f\u662f\u4ec0\u4e48\u3002Android Runtime \u7ee7\u627f\u548c\u53d1\u5c55\u4e86 <a href=\"https://source.android.com/docs/core/runtime/dalvik-bytecode\">Dalvik VM \u7684\u5b57\u8282\u7801 Dalvik Bytecode</a> \u683c\u5f0f\uff0c\u56e0\u6b64\u5728\u6253\u5305 Android \u5e94\u7528\u7684\u65f6\u5019\uff0cJava \u4ee3\u7801\u6700\u7ec8\u4f1a\u88ab\u7ffb\u8bd1\u6210 Dalvik Bytecode\u3002</p>\n<p>\u63a5\u4e0b\u6765\u6765\u5b9e\u8df5\u4e00\u4e0b\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u4ece Java \u4ee3\u7801\u5230 Dalvik Bytecode\uff1a</p>\n<p>\u7b2c\u4e00\u6b65\u662f\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u7684 Java \u7a0b\u5e8f\u5982\u4e0b\uff0c\u4fdd\u5b58\u5230 <code>MainActivity.java</code>\uff1a</p>\n<div class=\"language-java highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"kd\">public</span><span class=\"w\"> </span><span class=\"kd\">class</span> <span class=\"nc\">MainActivity</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"kd\">public</span><span class=\"w\"> </span><span class=\"kd\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"n\">String</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"w\">        </span><span class=\"n\">System</span><span class=\"p\">.</span><span class=\"na\">out</span><span class=\"p\">.</span><span class=\"na\">println</span><span class=\"p\">(</span><span class=\"s\">&quot;Hello, world!&quot;</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"w\">    </span><span class=\"kd\">public</span><span class=\"w\"> </span><span class=\"kd\">static</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">;</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u9996\u5148\u7528 <code>javac MainActivity.java</code> \u547d\u4ee4\u628a\u6e90\u7801\u7f16\u8bd1\u5230 Java Bytecode\u3002\u53ef\u4ee5\u7528 <code>javap -c MainActivity.class</code> \u67e5\u770b\u751f\u6210\u7684 Java Bytecode\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>Compiled from &quot;MainActivity.java&quot;\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>public class MainActivity {\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>  public MainActivity();\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>    Code:\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>       0: aload_0\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>       4: return\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a>  public static void main(java.lang.String[]);\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a>    Code:\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a>       0: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a>       3: ldc           #13                 // String Hello, world!\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a>       5: invokevirtual #15                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a>       8: return\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a>  public static int add(int, int);\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a>    Code:\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a>       0: iload_0\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a>       1: iload_1\n</span><span id=\"__span-1-20\"><a id=\"__codelineno-1-20\" name=\"__codelineno-1-20\" href=\"#__codelineno-1-20\"></a>       2: iadd\n</span><span id=\"__span-1-21\"><a id=\"__codelineno-1-21\" name=\"__codelineno-1-21\" href=\"#__codelineno-1-21\"></a>       3: ireturn\n</span><span id=\"__span-1-22\"><a id=\"__codelineno-1-22\" name=\"__codelineno-1-22\" href=\"#__codelineno-1-22\"></a>}\n</span></code></pre></div>\n<p>Java Bytecode \u662f\u4e2a\u5178\u578b\u7684\u6808\u5f0f\u5b57\u8282\u7801\uff0c\u56e0\u6b64\u4ece <code>int add(int, int)</code> \u51fd\u6570\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u5206\u522b\u538b\u6808\u7b2c\u96f6\u4e2a\u548c\u7b2c\u4e00\u4e2a\u5c40\u90e8\u904d\u53d8\u91cf\uff08\u5373\u53c2\u6570 <code>a</code> \u548c <code>b</code>\uff09\uff0c\u7136\u540e\u7528 <code>iadd</code> \u6307\u4ee4\u4ece\u6808\u9876\u5f39\u51fa\u4e24\u4e2a\u5143\u7d20\uff0c\u6c42\u548c\u540e\u518d\u628a\u7ed3\u679c\u538b\u6808\u3002</p>\n<p>\u63a5\u7740\uff0c\u7528 Android SDK \u7684 Build Tools \u63d0\u4f9b\u7684\u547d\u4ee4 <code>d8</code> \u6765\u628a\u5b83\u8f6c\u6362\u4e3a Dalvik Bytecode\u3002\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u5b89\u88c5 Android SDK\uff0c\u53ef\u4ee5\u6309\u7167 <a href=\"https://developer.android.com/tools/sdkmanager\">sdkmanager \u6587\u6863</a> \u6765\u5b89\u88c5 sdkmanager\uff0c\u518d\u7528 sdkmanager \u5b89\u88c5\u8f83\u65b0\u7248\u672c\u7684 <code>build-tools</code>\u3002\u8f6c\u6362\u7684\u547d\u4ee4\u4e3a <code>$ANDROID_HOME/build-tools/$VERSION/d8 MainActivity.class</code>\uff0c\u7ed3\u679c\u4f1a\u4fdd\u5b58\u5728\u5f53\u524d\u76ee\u5f55\u7684 <code>classes.dex</code> \u6587\u4ef6\u5185\u3002\u63a5\u7740\u53ef\u4ee5\u7528 <code>$ANDROID_HOME/build-tools/$VERSION/dexdump -d classes.dex</code> \u6765\u67e5\u770b Dalvik Bytecode\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>Processing &#39;classes.dex&#39;...\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>Opened &#39;classes.dex&#39;, DEX version &#39;035&#39;\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>Class #0            -\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>  Class descriptor  : &#39;LMainActivity;&#39;\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a>  Access flags      : 0x0001 (PUBLIC)\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a>  Superclass        : &#39;Ljava/lang/Object;&#39;\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a>  Interfaces        -\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a>  Static fields     -\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>  Instance fields   -\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a>  Direct methods    -\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a>    #0              : (in LMainActivity;)\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a>      name          : &#39;&lt;init&gt;&#39;\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a>      type          : &#39;()V&#39;\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a>      access        : 0x10001 (PUBLIC CONSTRUCTOR)\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a>      code          -\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a>      registers     : 1\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a>      ins           : 1\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a>      outs          : 1\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a>      insns size    : 4 16-bit code units\n</span><span id=\"__span-2-20\"><a id=\"__codelineno-2-20\" name=\"__codelineno-2-20\" href=\"#__codelineno-2-20\"></a>00016c:                                        |[00016c] MainActivity.&lt;init&gt;:()V\n</span><span id=\"__span-2-21\"><a id=\"__codelineno-2-21\" name=\"__codelineno-2-21\" href=\"#__codelineno-2-21\"></a>00017c: 7010 0400 0000                         |0000: invoke-direct {v0}, Ljava/lang/Object;.&lt;init&gt;:()V // method@0004\n</span><span id=\"__span-2-22\"><a id=\"__codelineno-2-22\" name=\"__codelineno-2-22\" href=\"#__codelineno-2-22\"></a>000182: 0e00                                   |0003: return-void\n</span><span id=\"__span-2-23\"><a id=\"__codelineno-2-23\" name=\"__codelineno-2-23\" href=\"#__codelineno-2-23\"></a>      catches       : (none)\n</span><span id=\"__span-2-24\"><a id=\"__codelineno-2-24\" name=\"__codelineno-2-24\" href=\"#__codelineno-2-24\"></a>      positions     :\n</span><span id=\"__span-2-25\"><a id=\"__codelineno-2-25\" name=\"__codelineno-2-25\" href=\"#__codelineno-2-25\"></a>        0x0000 line=1\n</span><span id=\"__span-2-26\"><a id=\"__codelineno-2-26\" name=\"__codelineno-2-26\" href=\"#__codelineno-2-26\"></a>      locals        :\n</span><span id=\"__span-2-27\"><a id=\"__codelineno-2-27\" name=\"__codelineno-2-27\" href=\"#__codelineno-2-27\"></a>        0x0000 - 0x0004 reg=0 this LMainActivity;\n</span><span id=\"__span-2-28\"><a id=\"__codelineno-2-28\" name=\"__codelineno-2-28\" href=\"#__codelineno-2-28\"></a>\n</span><span id=\"__span-2-29\"><a id=\"__codelineno-2-29\" name=\"__codelineno-2-29\" href=\"#__codelineno-2-29\"></a>    #1              : (in LMainActivity;)\n</span><span id=\"__span-2-30\"><a id=\"__codelineno-2-30\" name=\"__codelineno-2-30\" href=\"#__codelineno-2-30\"></a>      name          : &#39;add&#39;\n</span><span id=\"__span-2-31\"><a id=\"__codelineno-2-31\" name=\"__codelineno-2-31\" href=\"#__codelineno-2-31\"></a>      type          : &#39;(II)I&#39;\n</span><span id=\"__span-2-32\"><a id=\"__codelineno-2-32\" name=\"__codelineno-2-32\" href=\"#__codelineno-2-32\"></a>      access        : 0x0009 (PUBLIC STATIC)\n</span><span id=\"__span-2-33\"><a id=\"__codelineno-2-33\" name=\"__codelineno-2-33\" href=\"#__codelineno-2-33\"></a>      code          -\n</span><span id=\"__span-2-34\"><a id=\"__codelineno-2-34\" name=\"__codelineno-2-34\" href=\"#__codelineno-2-34\"></a>      registers     : 2\n</span><span id=\"__span-2-35\"><a id=\"__codelineno-2-35\" name=\"__codelineno-2-35\" href=\"#__codelineno-2-35\"></a>      ins           : 2\n</span><span id=\"__span-2-36\"><a id=\"__codelineno-2-36\" name=\"__codelineno-2-36\" href=\"#__codelineno-2-36\"></a>      outs          : 0\n</span><span id=\"__span-2-37\"><a id=\"__codelineno-2-37\" name=\"__codelineno-2-37\" href=\"#__codelineno-2-37\"></a>      insns size    : 2 16-bit code units\n</span><span id=\"__span-2-38\"><a id=\"__codelineno-2-38\" name=\"__codelineno-2-38\" href=\"#__codelineno-2-38\"></a>000158:                                        |[000158] MainActivity.add:(II)I\n</span><span id=\"__span-2-39\"><a id=\"__codelineno-2-39\" name=\"__codelineno-2-39\" href=\"#__codelineno-2-39\"></a>000168: b010                                   |0000: add-int/2addr v0, v1\n</span><span id=\"__span-2-40\"><a id=\"__codelineno-2-40\" name=\"__codelineno-2-40\" href=\"#__codelineno-2-40\"></a>00016a: 0f00                                   |0001: return v0\n</span><span id=\"__span-2-41\"><a id=\"__codelineno-2-41\" name=\"__codelineno-2-41\" href=\"#__codelineno-2-41\"></a>      catches       : (none)\n</span><span id=\"__span-2-42\"><a id=\"__codelineno-2-42\" name=\"__codelineno-2-42\" href=\"#__codelineno-2-42\"></a>      positions     :\n</span><span id=\"__span-2-43\"><a id=\"__codelineno-2-43\" name=\"__codelineno-2-43\" href=\"#__codelineno-2-43\"></a>        0x0000 line=7\n</span><span id=\"__span-2-44\"><a id=\"__codelineno-2-44\" name=\"__codelineno-2-44\" href=\"#__codelineno-2-44\"></a>      locals        :\n</span><span id=\"__span-2-45\"><a id=\"__codelineno-2-45\" name=\"__codelineno-2-45\" href=\"#__codelineno-2-45\"></a>        0x0000 - 0x0002 reg=0 (null) I\n</span><span id=\"__span-2-46\"><a id=\"__codelineno-2-46\" name=\"__codelineno-2-46\" href=\"#__codelineno-2-46\"></a>        0x0000 - 0x0002 reg=1 (null) I\n</span><span id=\"__span-2-47\"><a id=\"__codelineno-2-47\" name=\"__codelineno-2-47\" href=\"#__codelineno-2-47\"></a>\n</span><span id=\"__span-2-48\"><a id=\"__codelineno-2-48\" name=\"__codelineno-2-48\" href=\"#__codelineno-2-48\"></a>    #2              : (in LMainActivity;)\n</span><span id=\"__span-2-49\"><a id=\"__codelineno-2-49\" name=\"__codelineno-2-49\" href=\"#__codelineno-2-49\"></a>      name          : &#39;main&#39;\n</span><span id=\"__span-2-50\"><a id=\"__codelineno-2-50\" name=\"__codelineno-2-50\" href=\"#__codelineno-2-50\"></a>      type          : &#39;([Ljava/lang/String;)V&#39;\n</span><span id=\"__span-2-51\"><a id=\"__codelineno-2-51\" name=\"__codelineno-2-51\" href=\"#__codelineno-2-51\"></a>      access        : 0x0009 (PUBLIC STATIC)\n</span><span id=\"__span-2-52\"><a id=\"__codelineno-2-52\" name=\"__codelineno-2-52\" href=\"#__codelineno-2-52\"></a>      code          -\n</span><span id=\"__span-2-53\"><a id=\"__codelineno-2-53\" name=\"__codelineno-2-53\" href=\"#__codelineno-2-53\"></a>      registers     : 2\n</span><span id=\"__span-2-54\"><a id=\"__codelineno-2-54\" name=\"__codelineno-2-54\" href=\"#__codelineno-2-54\"></a>      ins           : 1\n</span><span id=\"__span-2-55\"><a id=\"__codelineno-2-55\" name=\"__codelineno-2-55\" href=\"#__codelineno-2-55\"></a>      outs          : 2\n</span><span id=\"__span-2-56\"><a id=\"__codelineno-2-56\" name=\"__codelineno-2-56\" href=\"#__codelineno-2-56\"></a>      insns size    : 8 16-bit code units\n</span><span id=\"__span-2-57\"><a id=\"__codelineno-2-57\" name=\"__codelineno-2-57\" href=\"#__codelineno-2-57\"></a>000184:                                        |[000184] MainActivity.main:([Ljava/lang/String;)V\n</span><span id=\"__span-2-58\"><a id=\"__codelineno-2-58\" name=\"__codelineno-2-58\" href=\"#__codelineno-2-58\"></a>000194: 6201 0000                              |0000: sget-object v1, Ljava/lang/System;.out:Ljava/io/PrintStream; // field@0000\n</span><span id=\"__span-2-59\"><a id=\"__codelineno-2-59\" name=\"__codelineno-2-59\" href=\"#__codelineno-2-59\"></a>000198: 1a00 0100                              |0002: const-string v0, &quot;Hello, world!&quot; // string@0001\n</span><span id=\"__span-2-60\"><a id=\"__codelineno-2-60\" name=\"__codelineno-2-60\" href=\"#__codelineno-2-60\"></a>00019c: 6e20 0300 0100                         |0004: invoke-virtual {v1, v0}, Ljava/io/PrintStream;.println:(Ljava/lang/String;)V // method@0003\n</span><span id=\"__span-2-61\"><a id=\"__codelineno-2-61\" name=\"__codelineno-2-61\" href=\"#__codelineno-2-61\"></a>0001a2: 0e00                                   |0007: return-void\n</span><span id=\"__span-2-62\"><a id=\"__codelineno-2-62\" name=\"__codelineno-2-62\" href=\"#__codelineno-2-62\"></a>      catches       : (none)\n</span><span id=\"__span-2-63\"><a id=\"__codelineno-2-63\" name=\"__codelineno-2-63\" href=\"#__codelineno-2-63\"></a>      positions     :\n</span><span id=\"__span-2-64\"><a id=\"__codelineno-2-64\" name=\"__codelineno-2-64\" href=\"#__codelineno-2-64\"></a>        0x0000 line=3\n</span><span id=\"__span-2-65\"><a id=\"__codelineno-2-65\" name=\"__codelineno-2-65\" href=\"#__codelineno-2-65\"></a>        0x0007 line=4\n</span><span id=\"__span-2-66\"><a id=\"__codelineno-2-66\" name=\"__codelineno-2-66\" href=\"#__codelineno-2-66\"></a>      locals        :\n</span><span id=\"__span-2-67\"><a id=\"__codelineno-2-67\" name=\"__codelineno-2-67\" href=\"#__codelineno-2-67\"></a>        0x0000 - 0x0008 reg=1 (null) [Ljava/lang/String;\n</span><span id=\"__span-2-68\"><a id=\"__codelineno-2-68\" name=\"__codelineno-2-68\" href=\"#__codelineno-2-68\"></a>\n</span><span id=\"__span-2-69\"><a id=\"__codelineno-2-69\" name=\"__codelineno-2-69\" href=\"#__codelineno-2-69\"></a>  Virtual methods   -\n</span><span id=\"__span-2-70\"><a id=\"__codelineno-2-70\" name=\"__codelineno-2-70\" href=\"#__codelineno-2-70\"></a>  source_file_idx   : 9 (MainActivity.java)\n</span></code></pre></div>\n<p>\u5bf9\u6bd4 Java Bytecode\uff0c\u5728 Dalvik Bytecode \u91cc\u7684 <code>add</code> \u51fd\u6570\u7684\u5b9e\u73b0\u5c31\u5927\u4e0d\u76f8\u540c\u4e86\uff1a</p>\n<ol>\n<li><code>add-int/2addr v0, v1</code>: \u6c42\u5bc4\u5b58\u5668 <code>v1</code> \u548c\u5bc4\u5b58\u5668 <code>v0</code> \u4e4b\u548c\uff0c\u5728\u8fd9\u91cc\u5c31\u5bf9\u5e94 <code>a</code> \u548c <code>b</code> \u4e24\u4e2a\u53c2\u6570\uff0c\u7ed3\u679c\u5199\u5230 <code>v0</code> \u5bc4\u5b58\u5668\u5f53\u4e2d</li>\n<li><code>return v0</code>: \u4ee5\u5bc4\u5b58\u5668 <code>v0</code> \u4e3a\u8fd4\u56de\u503c\uff0c\u7ed3\u675f\u5f53\u524d\u51fd\u6570</li>\n</ol>\n<p>\u53ef\u89c1 Dalvik Bytecode \u91c7\u7528\u7684\u662f\u7c7b\u4f3c V8 \u7684\u57fa\u4e8e\u5bc4\u5b58\u5668\u7684\u5b57\u8282\u7801\uff0c\u4e0d\u8fc7\u6ca1\u6709 V8 \u7684 <code>accumulator</code>\u3002</p>\n<p>Dalvik Bytecode \u7684\u5b8c\u6574\u5217\u8868\u89c1 <a href=\"https://source.android.com/docs/core/runtime/dalvik-bytecode\">Dalvik bytecode format</a>\uff0c\u5b83\u7684\u683c\u5f0f\u57fa\u672c\u4e0a\u662f\u4e24\u4e2a\u5b57\u8282\u4e3a\u4e00\u7ec4\uff0c\u6bcf\u7ec4\u91cc\u7b2c\u4e00\u4e2a\u5b57\u8282\u4ee3\u8868 Op \u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u8282\u4ee3\u8868\u53c2\u6570\uff0c\u6709\u4e00\u4e9b Op \u540e\u9762\u8fd8\u4f1a\u5e26\u6709\u591a\u7ec4\u53c2\u6570\u3002</p>\n<p>\u4f8b\u5982\u4e0a\u9762\u7684 <code>add-int/2addr vA, vB</code> \u6307\u4ee4\u7684\u7f16\u7801\u662f\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u5b57\u8282\u662f <code>0xb0</code>\uff0c\u8868\u793a\u8fd9\u662f\u4e00\u4e2a <code>add-int/2addr</code> Op</li>\n<li>\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5171 8 \u4f4d\uff0c\u4f4e 4 \u4f4d\u7f16\u7801\u4e86 <code>vA</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>A</code>\uff0c\u9ad8 4 \u4f4d\u7f16\u7801\u4e86 <code>vB</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>B</code></li>\n</ol>\n<p>\u6240\u4ee5 <code>add-int/2addr v0, v1</code> \u7684\u7f16\u7801\u5c31\u662f <code>0xb0, 0 | (1 &lt;&lt; 4)</code> \u5373 <code>0xb0, 0x10</code>\u3002\u56e0\u4e3a\u5b58\u5f97\u5f88\u7d27\u51d1\uff0c\u5bc4\u5b58\u5668\u7f16\u53f7\u53ea\u6709 4 \u4f4d\uff0c\u6240\u4ee5\u8fd9\u4e2a Op \u7684\u64cd\u4f5c\u6570\u4e0d\u80fd\u8bbf\u95ee v16 \u6216\u66f4\u9ad8\u7684\u5bc4\u5b58\u5668\u3002</p>\n<p><code>return vAA</code> \u6307\u4ee4\u7684\u7f16\u7801\u7c7b\u4f3c\uff0c\u4e0d\u8fc7\u56e0\u4e3a\u53ea\u9700\u8981\u7f16\u7801\u4e00\u4e2a\u64cd\u4f5c\u6570\uff0c\u6240\u4ee5\u6709 8 \u4f4d\u53ef\u4ee5\u7f16\u7801\u8fd4\u56de\u503c\u7528\u54ea\u4e2a\u5bc4\u5b58\u5668\uff1b\u4e3a\u4e86\u533a\u5206\u662f 4 \u4f4d\u7684\u7f16\u7801\u8fd8\u662f 8 \u4f4d\u7684\u7f16\u7801\uff0c\u8fd9\u91cc\u7528 <code>vAA</code> \u8868\u793a\u53ef\u4ee5\u7528 8 \u4f4d\u6765\u8bb0\u5f55\u5bc4\u5b58\u5668\u7f16\u53f7\u3002<code>return vAA</code> \u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u662f <code>0x0f</code> \u8868\u793a Op \u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5c31\u662f\u5bc4\u5b58\u5668\u7f16\u53f7 <code>A</code>\u3002\u4e0a\u9762\u51fa\u73b0\u7684 <code>return v0</code> \u7684\u7f16\u7801\u5c31\u662f <code>0x0f, 0x00</code>\u3002</p>\n<p>\u4e00\u4e9b\u6bd4\u8f83\u590d\u6742\u7684 Op \u4f1a\u9644\u5e26\u66f4\u591a\u7684\u53c2\u6570\uff0c\u6b64\u65f6\u7f16\u7801\u5c31\u53ef\u80fd\u6d89\u53ca\u5230\u66f4\u591a\u7684\u5b57\u8282\u3002\u6bd4\u5982 <code>invoke-virtual {vC, vD, vE, vF, vG}, meth@BBBB</code>\uff0c\u53ef\u4ee5\u643a\u5e26\u53ef\u53d8\u4e2a\u5bc4\u5b58\u5668\u53c2\u6570\uff0c\u5728\u7f16\u7801\u7684\u65f6\u5019\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u4e2a\u5b57\u8282 <code>0x6e</code> \u8868\u793a\u8fd9\u662f\u4e00\u4e2a <code>invoke-virtual</code> Op</li>\n<li>\u7b2c\u4e8c\u4e2a\u5b57\u8282\u7684\u9ad8 4 \u4f4d\u8bb0\u5f55\u4e86\u53c2\u6570\u4e2a\u6570</li>\n<li>\u7b2c\u4e09\u548c\u7b2c\u56db\u4e2a\u5b57\u8282\u5171 16 \u4f4d\uff0c\u8bb0\u5f55\u4e86\u8981\u8c03\u7528\u7684\u51fd\u6570\u7684 index\uff0c\u8fd9\u4e2a index \u4f1a\u88ab\u62ff\u6765\u7d22\u5f15 DEX \u7684 method_ids \u8868</li>\n<li>\u7b2c\u4e94\u548c\u7b2c\u516d\u4e2a\u5b57\u8282\u5171 16 \u4f4d\uff0c\u914d\u5408\u7b2c\u4e8c\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff0c\u6700\u591a\u53ef\u4ee5\u4f20\u9012 5 \u4e2a\u5bc4\u5b58\u5668\u53c2\u6570\uff0c\u6bcf\u4e2a\u5bc4\u5b58\u5668\u53c2\u6570 4 \u4f4d</li>\n</ol>\n<p>\u56e0\u6b64\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c<code>invoke-virtual {v1, v0}, Ljava/io/PrintStream;.println:(Ljava/lang/String;)V // method@0003</code> \u88ab\u7f16\u7801\u4e3a\uff1a<code>0x6e, 0x20, 0x03, 0x00, 0x01, 0x00</code>\u3002\u53e6\u5916\u6784\u9020\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff0c\u628a\u4e94\u4e2a\u53c2\u6570\u90fd\u7528\u4e0a\uff1a<code>invoke-virtual {v1, v4, v0, v2, v3}, LMainActivity;.add4:(IIII)I // method@0002</code> \u88ab\u7f16\u7801\u4e3a <code>0x6e, 0x53, 0x02, 0x00, 0x41, 0x20</code>\uff0c\u53ef\u4ee5\u770b\u5230\u4e94\u4e2a\u53c2\u6570\u7684\u7f16\u7801\u987a\u5e8f\u662f\u7b2c\u4e94\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff08<code>v1</code>\uff09\u548c\u9ad8 4 \u4f4d\uff08<code>v4</code>\uff09\uff0c\u7b2c\u516d\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff08<code>v0</code>\uff09\u548c\u9ad8 4 \u4f4d\uff08<code>v2</code>\uff09\uff0c\u6700\u540e\u662f\u7b2c\u4e8c\u4e2a\u5b57\u8282\u7684\u4f4e 4 \u4f4d\uff08<code>v3</code>\uff09\u3002</p>\n<p>\u4e86\u89e3\u4e86 Dalvik Bytecode \u7684\u7ed3\u6784\uff0c\u63a5\u4e0b\u6765\u89c2\u5bdf\u5b83\u662f\u600e\u4e48\u88ab\u89e3\u91ca\u6267\u884c\u7684\u3002</p>\n<h2 id=\"\u89e3\u91ca\u5668\">\u89e3\u91ca\u5668<a class=\"headerlink\" href=\"#\u89e3\u91ca\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>Android Runtime (ART) \u7684\u89e3\u91ca\u5668\u653e\u5728 <code>runtime/interpreter</code> \u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8fdb\u884c\u4e00\u4e9b<a href=\"https://stackoverflow.com/questions/22187630/what-does-mterp-mean\">\u8003\u53e4</a>\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u662f\u4ece\u66f4\u65e9\u7684 Dalvik VM \u6765\u7684\u3002\u5b83\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u89e3\u91ca\u5668\u5b9e\u73b0\uff1a</p>\n<p>\u7b2c\u4e00\u4e2a\u89e3\u91ca\u5668\u57fa\u4e8e switch-case \u7684 C++ \u4ee3\u7801\u5b9e\u73b0\uff0c\u5176\u9010\u4e2a\u904d\u5386 Op\uff0c\u6839\u636e Op \u7684\u7c7b\u578b Opcode \u6267\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\uff0c\u7c7b\u4f3c\u4e0b\u9762\u7684\u4ee3\u7801\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">  </span><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">op</span><span class=\"p\">.</span><span class=\"n\">opcode</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"no\">op_add</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">      </span><span class=\"c1\">// implement add here</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">      </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"c1\">// ... other opcode handlers</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u7b2c\u4e8c\u4e2a\u89e3\u91ca\u5668\u4ee5 <a href=\"https://en.wikipedia.org/wiki/Threaded_code#Token_threading\">Token threading</a> \u7684\u65b9\u5f0f\u5b9e\u73b0\uff0c\u6bcf\u79cd Op \u5bf9\u5e94\u4e00\u6bb5\u4ee3\u7801\u3002\u8fd9\u6bb5\u4ee3\u7801\u5728\u5b8c\u6210 Op \u7684\u64cd\u4f5c\u540e\uff0c\u8bfb\u53d6\u4e0b\u4e00\u4e2a Op\uff0c\u518d\u95f4\u63a5\u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a Op \u5bf9\u5e94\u7684\u4ee3\u7801\u3002\u5176\u5de5\u4f5c\u539f\u7406\u7c7b\u4f3c\u4e0b\u9762\u7684\u4ee3\u7801\uff0c\u8fd9\u91cc <a href=\"https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html\"><code>goto *</code></a> \u662f GNU C \u7684\u6269\u5c55\uff0c\u5bf9\u5e94\u95f4\u63a5\u8df3\u8f6c\u6307\u4ee4\uff0c\u5176\u76ee\u7684\u5730\u5740\u53d6\u51b3\u4e8e <code>handlers[next_opcode]</code> \u7684\u503c\uff0c\u610f\u601d\u662f\u6839\u636e\u4e0b\u4e00\u4e2a op \u7684 Opcode\uff0c\u627e\u5230\u5bf9\u5e94\u7684 handler\uff0c\u76f4\u63a5\u8df3\u8f6c\u8fc7\u53bb\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"w\">  </span><span class=\"c1\">// op handlers array</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"w\">  </span><span class=\"n\">handlers</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"o\">&amp;</span><span class=\"n\">op_add</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">op_sub</span><span class=\"p\">};</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a><span class=\"nl\">op_add</span><span class=\"p\">:</span>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"w\">  </span><span class=\"c1\">// implement add here</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"w\">  </span><span class=\"c1\">// read next opcode here</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"w\">  </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">handlers</span><span class=\"p\">[</span><span class=\"n\">next_opcode</span><span class=\"p\">];</span>\n</span></code></pre></div>\n<p>\u5b9e\u9645\u5b9e\u73b0\u7684\u65f6\u5019\u66f4\u8fdb\u4e00\u6b65\uff0c\u7528\u6c47\u7f16\u5b9e\u73b0\u5404\u4e2a op handler\uff0c\u5e76\u628a handler \u653e\u5728\u4e86 128 \u5b57\u8282\u5bf9\u9f50\u7684\u4f4d\u7f6e\uff0c\u4fdd\u8bc1\u6bcf\u4e2a handler \u4e0d\u8d85\u8fc7 128 \u4e2a\u5b57\u8282\uff0c\u4ece\u800c\u628a\u8bfb\u53d6 <code>handlers</code> \u6570\u7ec4\u518d\u8df3\u8f6c\u7684 <code>goto *</code> \u6539\u6210\u4e86\u7528\u4e58\u6cd5\u548c\u52a0\u6cd5\u8ba1\u7b97\u51fa handler \u7684\u5730\u5740\u518d\u8df3\u8f6c\uff08computed goto\uff09\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"nl\">handlers_begin:</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"nl\">op_add:</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\">  </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"mi\">128</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"w\">  </span><span class=\"c1\"># implement add here</span>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a><span class=\"w\">  </span><span class=\"c1\"># read next opcode here</span>\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a><span class=\"w\">  </span><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"no\">to</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">handlers_begin</span><span class=\"w\"> </span><span class=\"err\">+</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"no\">next_opcode</span><span class=\"p\">)</span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a><span class=\"nl\">op_sub:</span>\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a><span class=\"w\">  </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"mi\">128</span>\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a><span class=\"w\">  </span><span class=\"c1\"># implement add here</span>\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a><span class=\"w\">  </span><span class=\"c1\"># read next opcode here</span>\n</span><span id=\"__span-5-12\"><a id=\"__codelineno-5-12\" name=\"__codelineno-5-12\" href=\"#__codelineno-5-12\"></a><span class=\"w\">  </span><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"no\">to</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"no\">handlers_begin</span><span class=\"w\"> </span><span class=\"err\">+</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"no\">next_opcode</span><span class=\"p\">)</span><span class=\"c1\">;</span>\n</span></code></pre></div>\n<p>\u4e0b\u9762\u7ed3\u5408\u6e90\u7801\u6765\u5177\u4f53\u5206\u6790\u8fd9\u4e24\u79cd\u89e3\u91ca\u5668\u7684\u5b9e\u73b0\u3002</p>\n<h3 id=\"\u57fa\u4e8e-switch-case-\u7684\u89e3\u91ca\u5668\">\u57fa\u4e8e switch-case \u7684\u89e3\u91ca\u5668<a class=\"headerlink\" href=\"#\u57fa\u4e8e-switch-case-\u7684\u89e3\u91ca\u5668\" title=\"Permanent link\">&para;</a></h3>\n<p>\u76ee\u524d Android Runtime \u5305\u62ec\u4e00\u4e2a\u57fa\u4e8e switch-case \u7684\u89e3\u91ca\u5668\uff0c\u5b9e\u73b0\u5728 <code>runtime/interpreter/interpreter_switch_impl-inl.h</code> \u6587\u4ef6\u5f53\u4e2d\uff0c\u5b83\u7684\u6838\u5fc3\u903b\u8f91\u5c31\u662f\u4e00\u4e2a\u5faa\u73af\u5957 switch-case\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"w\">  </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nb\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"w\">    </span><span class=\"n\">dex_pc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">GetDexPc</span><span class=\"p\">(</span><span class=\"n\">insns</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"w\">    </span><span class=\"n\">shadow_frame</span><span class=\"p\">.</span><span class=\"n\">SetDexPC</span><span class=\"p\">(</span><span class=\"n\">dex_pc</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"w\">    </span><span class=\"n\">TraceExecution</span><span class=\"p\">(</span><span class=\"n\">shadow_frame</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dex_pc</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"w\">    </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">inst_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Fetch16</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-7\"><a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\" href=\"#__codelineno-6-7\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n</span><span id=\"__span-6-8\"><a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\" href=\"#__codelineno-6-8\"></a><span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Moved outside to keep frames small under asan.</span>\n</span><span id=\"__span-6-9\"><a id=\"__codelineno-6-9\" name=\"__codelineno-6-9\" href=\"#__codelineno-6-9\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">InstructionHandler</span><span class=\"o\">&lt;</span><span class=\"n\">transaction_active</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInvalidFormat</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n</span><span id=\"__span-6-10\"><a id=\"__codelineno-6-10\" name=\"__codelineno-6-10\" href=\"#__codelineno-6-10\"></a><span class=\"w\">            </span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">instrumentation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shadow_frame</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dex_pc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"p\">).</span>\n</span><span id=\"__span-6-11\"><a id=\"__codelineno-6-11\" name=\"__codelineno-6-11\" href=\"#__codelineno-6-11\"></a><span class=\"w\">            </span><span class=\"n\">Preamble</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-12\"><a id=\"__codelineno-6-12\" name=\"__codelineno-6-12\" href=\"#__codelineno-6-12\"></a><span class=\"w\">      </span><span class=\"n\">DCHECK_EQ</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"o\">-&gt;</span><span class=\"n\">IsExceptionPending</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Opcode</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">MOVE_EXCEPTION</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-13\"><a id=\"__codelineno-6-13\" name=\"__codelineno-6-13\" href=\"#__codelineno-6-13\"></a><span class=\"w\">      </span><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Opcode</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-14\"><a id=\"__codelineno-6-14\" name=\"__codelineno-6-14\" href=\"#__codelineno-6-14\"></a><span class=\"cp\">#define OPCODE_CASE(OPCODE, OPCODE_NAME, NAME, FORMAT, i, a, e, v)                                \\</span>\n</span><span id=\"__span-6-15\"><a id=\"__codelineno-6-15\" name=\"__codelineno-6-15\" href=\"#__codelineno-6-15\"></a><span class=\"cp\">        case OPCODE: {                                                                            \\</span>\n</span><span id=\"__span-6-16\"><a id=\"__codelineno-6-16\" name=\"__codelineno-6-16\" href=\"#__codelineno-6-16\"></a><span class=\"cp\">          next = inst-&gt;RelativeAt(Instruction::SizeInCodeUnits(Instruction::FORMAT));             \\</span>\n</span><span id=\"__span-6-17\"><a id=\"__codelineno-6-17\" name=\"__codelineno-6-17\" href=\"#__codelineno-6-17\"></a><span class=\"cp\">          success = OP_##OPCODE_NAME&lt;transaction_active&gt;(                                         \\</span>\n</span><span id=\"__span-6-18\"><a id=\"__codelineno-6-18\" name=\"__codelineno-6-18\" href=\"#__codelineno-6-18\"></a><span class=\"cp\">              ctx, instrumentation, self, shadow_frame, dex_pc, inst, inst_data, next, exit);     \\</span>\n</span><span id=\"__span-6-19\"><a id=\"__codelineno-6-19\" name=\"__codelineno-6-19\" href=\"#__codelineno-6-19\"></a><span class=\"cp\">          if (success &amp;&amp; LIKELY(!interpret_one_instruction)) {                                    \\</span>\n</span><span id=\"__span-6-20\"><a id=\"__codelineno-6-20\" name=\"__codelineno-6-20\" href=\"#__codelineno-6-20\"></a><span class=\"cp\">            continue;                                                                             \\</span>\n</span><span id=\"__span-6-21\"><a id=\"__codelineno-6-21\" name=\"__codelineno-6-21\" href=\"#__codelineno-6-21\"></a><span class=\"cp\">          }                                                                                       \\</span>\n</span><span id=\"__span-6-22\"><a id=\"__codelineno-6-22\" name=\"__codelineno-6-22\" href=\"#__codelineno-6-22\"></a><span class=\"cp\">          break;                                                                                  \\</span>\n</span><span id=\"__span-6-23\"><a id=\"__codelineno-6-23\" name=\"__codelineno-6-23\" href=\"#__codelineno-6-23\"></a><span class=\"cp\">        }</span>\n</span><span id=\"__span-6-24\"><a id=\"__codelineno-6-24\" name=\"__codelineno-6-24\" href=\"#__codelineno-6-24\"></a><span class=\"w\">  </span><span class=\"n\">DEX_INSTRUCTION_LIST</span><span class=\"p\">(</span><span class=\"n\">OPCODE_CASE</span><span class=\"p\">)</span>\n</span><span id=\"__span-6-25\"><a id=\"__codelineno-6-25\" name=\"__codelineno-6-25\" href=\"#__codelineno-6-25\"></a><span class=\"cp\">#undef OPCODE_CASE</span>\n</span><span id=\"__span-6-26\"><a id=\"__codelineno-6-26\" name=\"__codelineno-6-26\" href=\"#__codelineno-6-26\"></a><span class=\"w\">      </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-27\"><a id=\"__codelineno-6-27\" name=\"__codelineno-6-27\" href=\"#__codelineno-6-27\"></a><span class=\"w\">    </span><span class=\"p\">}</span>\n</span><span id=\"__span-6-28\"><a id=\"__codelineno-6-28\" name=\"__codelineno-6-28\" href=\"#__codelineno-6-28\"></a><span class=\"w\">    </span><span class=\"c1\">// exit condition handling omitted</span>\n</span><span id=\"__span-6-29\"><a id=\"__codelineno-6-29\" name=\"__codelineno-6-29\" href=\"#__codelineno-6-29\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86 <a href=\"https://en.wikipedia.org/wiki/X_macro\">X macro</a> \u7684\u7f16\u7a0b\u6280\u5de7\uff1a\u5982\u679c\u4f60\u9700\u8981\u5728\u4e0d\u540c\u7684\u5730\u65b9\u91cd\u590d\u51fa\u73b0\u540c\u4e00\u4e2a list\uff0c\u6bd4\u5982\u5728\u8fd9\u91cc\uff0c\u5c31\u662f\u6240\u6709\u53ef\u80fd\u7684 Opcode \u7c7b\u578b\uff0c\u4f60\u53ef\u4ee5\u5728\u4e00\u4e2a\u5934\u6587\u4ef6\u4e2d\u7528\u4e00\u4e2a\u5b8f\uff0c\u4ee5\u53e6\u4e00\u4e2a\u5b8f\u4e3a\u53c2\u6570\u53bb\u5217\u51fa\u6765\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"c1\">// V(opcode, instruction_code, name, format, index, flags, extended_flags, verifier_flags);</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"cp\">#define DEX_INSTRUCTION_LIST(V) \\</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"cp\">  V(0x00, NOP, &quot;nop&quot;, k10x, kIndexNone, kContinue, 0, kVerifyNothing) \\</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"cp\">  V(0x01, MOVE, &quot;move&quot;, k12x, kIndexNone, kContinue, 0, kVerifyRegA | kVerifyRegB) \\</span>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"cp\">  </span><span class=\"c1\">// omitted</span>\n</span></code></pre></div>\n<p>\u8fd9\u4e2a\u5b8f\u5b9a\u4e49\u5728 <code>libdexfile/dex/dex_instruction_list.h</code> \u5934\u6587\u4ef6\u5f53\u4e2d\u3002\u5728\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e34\u65f6\u5b9a\u4e49\u4e00\u4e2a\u5b8f\uff0c\u7136\u540e\u628a\u65b0\u5b9a\u4e49\u7684\u5b8f\u4f20\u5165 <code>DEX_INSTRUCTION_LIST</code> \u7684\u53c2\u6570\u5373\u53ef\u3002\u4f8b\u5982\u8981\u751f\u6210\u4e00\u4e2a\u6570\u7ec4\uff0c\u8bb0\u5f55\u6240\u6709\u7684 op \u540d\u5b57\uff0c\u53ef\u4ee5\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a><span class=\"c1\">// taken from libdexfile/dex/dex_instruction.cc</span>\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInstructionNames</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a><span class=\"cp\">#define INSTRUCTION_NAME(o, c, pname, f, i, a, e, v) pname,</span>\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&quot;dex_instruction_list.h&quot;</span>\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a><span class=\"w\">  </span><span class=\"n\">DEX_INSTRUCTION_LIST</span><span class=\"p\">(</span><span class=\"n\">INSTRUCTION_NAME</span><span class=\"p\">)</span>\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a><span class=\"cp\">#undef DEX_INSTRUCTION_LIST</span>\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a><span class=\"cp\">#undef INSTRUCTION_NAME</span>\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u8fd9\u6bb5\u4ee3\u7801\u7ecf\u8fc7 C \u9884\u5904\u7406\u5668\uff0c\u9996\u5148\u4f1a\u88ab\u5c55\u5f00\u4e3a\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInstructionNames</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"cp\">#define INSTRUCTION_NAME(o, c, pname, f, i, a, e, v) pname,</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"w\">  </span><span class=\"n\">INSTRUCTION_NAME</span><span class=\"p\">(</span><span class=\"mh\">0x00</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NOP</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;nop&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">k10x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kIndexNone</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kContinue</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kVerifyNothing</span><span class=\"p\">)</span><span class=\"w\"> </span>\\\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a><span class=\"w\">  </span><span class=\"n\">INSTRUCTION_NAME</span><span class=\"p\">(</span><span class=\"mh\">0x01</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">MOVE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;move&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">k12x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kIndexNone</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kContinue</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kVerifyRegA</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">kVerifyRegB</span><span class=\"p\">)</span><span class=\"w\"> </span>\\\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a><span class=\"w\">  </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a><span class=\"cp\">#undef INSTRUCTION_NAME</span>\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u7ee7\u7eed\u5c55\u5f00\uff0c\u5c31\u5f97\u5230\u4e86\u60f3\u8981\u7559\u4e0b\u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-10-1\"><a id=\"__codelineno-10-1\" name=\"__codelineno-10-1\" href=\"#__codelineno-10-1\"></a><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">kInstructionNames</span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-10-2\"><a id=\"__codelineno-10-2\" name=\"__codelineno-10-2\" href=\"#__codelineno-10-2\"></a><span class=\"w\">  </span><span class=\"s\">&quot;nop&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-10-3\"><a id=\"__codelineno-10-3\" name=\"__codelineno-10-3\" href=\"#__codelineno-10-3\"></a><span class=\"w\">  </span><span class=\"s\">&quot;move&quot;</span><span class=\"p\">,</span>\n</span><span id=\"__span-10-4\"><a id=\"__codelineno-10-4\" name=\"__codelineno-10-4\" href=\"#__codelineno-10-4\"></a><span class=\"w\">  </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-10-5\"><a id=\"__codelineno-10-5\" name=\"__codelineno-10-5\" href=\"#__codelineno-10-5\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u56de\u5230 switch-case \u7684\u5730\u65b9\uff0c\u53ef\u4ee5\u9884\u89c1\u5230\uff0c\u9884\u5904\u7406\u4f1a\u751f\u6210\u7684\u4ee3\u7801\u5927\u6982\u662f\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-11-1\"><a id=\"__codelineno-11-1\" name=\"__codelineno-11-1\" href=\"#__codelineno-11-1\"></a><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">Opcode</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-11-2\"><a id=\"__codelineno-11-2\" name=\"__codelineno-11-2\" href=\"#__codelineno-11-2\"></a><span class=\"w\">  </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"mh\">0x00</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">                                                                            </span>\\\n</span><span id=\"__span-11-3\"><a id=\"__codelineno-11-3\" name=\"__codelineno-11-3\" href=\"#__codelineno-11-3\"></a><span class=\"w\">    </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">-&gt;</span><span class=\"n\">RelativeAt</span><span class=\"p\">(</span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">SizeInCodeUnits</span><span class=\"p\">(</span><span class=\"n\">Instruction</span><span class=\"o\">::</span><span class=\"n\">k10x</span><span class=\"p\">));</span><span class=\"w\">             </span>\\\n</span><span id=\"__span-11-4\"><a id=\"__codelineno-11-4\" name=\"__codelineno-11-4\" href=\"#__codelineno-11-4\"></a><span class=\"w\">    </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">OP_NOP</span><span class=\"o\">&lt;</span><span class=\"n\">transaction_active</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"w\">                                                 </span>\\\n</span><span id=\"__span-11-5\"><a id=\"__codelineno-11-5\" name=\"__codelineno-11-5\" href=\"#__codelineno-11-5\"></a><span class=\"w\">        </span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">instrumentation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">shadow_frame</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dex_pc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inst_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"p\">);</span><span class=\"w\">   </span>\\\n</span><span id=\"__span-11-6\"><a id=\"__codelineno-11-6\" name=\"__codelineno-11-6\" href=\"#__codelineno-11-6\"></a><span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">LIKELY</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">interpret_one_instruction</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">                                  </span>\\\n</span><span id=\"__span-11-7\"><a id=\"__codelineno-11-7\" name=\"__codelineno-11-7\" href=\"#__codelineno-11-7\"></a><span class=\"w\">      </span><span class=\"k\">continue</span><span class=\"p\">;</span><span class=\"w\">                                                                           </span>\\\n</span><span id=\"__span-11-8\"><a id=\"__codelineno-11-8\" name=\"__codelineno-11-8\" href=\"#__codelineno-11-8\"></a><span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\">                                                                                     </span>\\\n</span><span id=\"__span-11-9\"><a id=\"__codelineno-11-9\" name=\"__codelineno-11-9\" href=\"#__codelineno-11-9\"></a><span class=\"w\">    </span><span class=\"k\">break</span><span class=\"p\">;</span><span class=\"w\">                                                                                </span>\\\n</span><span id=\"__span-11-10\"><a id=\"__codelineno-11-10\" name=\"__codelineno-11-10\" href=\"#__codelineno-11-10\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-11-11\"><a id=\"__codelineno-11-11\" name=\"__codelineno-11-11\" href=\"#__codelineno-11-11\"></a><span class=\"w\">  </span><span class=\"c1\">// omitted</span>\n</span><span id=\"__span-11-12\"><a id=\"__codelineno-11-12\" name=\"__codelineno-11-12\" href=\"#__codelineno-11-12\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>next = inst-&gt;RelativeAt(Instruction::SizeInCodeUnits(Instruction::k10x));</code> \u8bed\u53e5\u6839\u636e\u5f53\u524d Op \u7c7b\u578b\u8ba1\u7b97\u51fa\u5b83\u4f1a\u5360\u7528\u591a\u5c11\u4e2a\u5b57\u8282\uff0c\u4ece\u800c\u5f97\u5230\u4e0b\u4e00\u4e2a Op \u7684\u5730\u5740\u3002\u4e4b\u540e\u5c31\u662f\u8c03\u7528 <code>OP_NOP</code> \u51fd\u6570\u6765\u8fdb\u884c\u5b9e\u9645\u7684\u64cd\u4f5c\u4e86\u3002\u5f53\u7136\u4e86\uff0c\u8fd9\u4e2a\u5b9e\u9645\u7684\u64cd\u4f5c\uff0c\u8fd8\u662f\u9700\u8981\u5f00\u53d1\u8005\u53bb\u624b\u52a8\u5b9e\u73b0\uff08<code>OP_NOP</code> \u51fd\u6570\u4f1a\u8c03\u7528\u4e0b\u9762\u7684 <code>NOP</code> \u51fd\u6570\uff09\uff1a</p>\n<div class=\"language-c++ highlight\"><pre><span></span><code><span id=\"__span-12-1\"><a id=\"__codelineno-12-1\" name=\"__codelineno-12-1\" href=\"#__codelineno-12-1\"></a><span class=\"n\">HANDLER_ATTRIBUTES</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">NOP</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-12-2\"><a id=\"__codelineno-12-2\" name=\"__codelineno-12-2\" href=\"#__codelineno-12-2\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-3\"><a id=\"__codelineno-12-3\" name=\"__codelineno-12-3\" href=\"#__codelineno-12-3\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-12-4\"><a id=\"__codelineno-12-4\" name=\"__codelineno-12-4\" href=\"#__codelineno-12-4\"></a>\n</span><span id=\"__span-12-5\"><a id=\"__codelineno-12-5\" name=\"__codelineno-12-5\" href=\"#__codelineno-12-5\"></a><span class=\"n\">HANDLER_ATTRIBUTES</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">MOVE</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-12-6\"><a id=\"__codelineno-12-6\" name=\"__codelineno-12-6\" href=\"#__codelineno-12-6\"></a><span class=\"w\">  </span><span class=\"n\">SetVReg</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">GetVReg</span><span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">()));</span>\n</span><span id=\"__span-12-7\"><a id=\"__codelineno-12-7\" name=\"__codelineno-12-7\" href=\"#__codelineno-12-7\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-8\"><a id=\"__codelineno-12-8\" name=\"__codelineno-12-8\" href=\"#__codelineno-12-8\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-12-9\"><a id=\"__codelineno-12-9\" name=\"__codelineno-12-9\" href=\"#__codelineno-12-9\"></a>\n</span><span id=\"__span-12-10\"><a id=\"__codelineno-12-10\" name=\"__codelineno-12-10\" href=\"#__codelineno-12-10\"></a><span class=\"n\">HANDLER_ATTRIBUTES</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">ADD_INT</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-12-11\"><a id=\"__codelineno-12-11\" name=\"__codelineno-12-11\" href=\"#__codelineno-12-11\"></a><span class=\"w\">  </span><span class=\"n\">SetVReg</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">SafeAdd</span><span class=\"p\">(</span><span class=\"n\">GetVReg</span><span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">()),</span><span class=\"w\"> </span><span class=\"n\">GetVReg</span><span class=\"p\">(</span><span class=\"n\">C</span><span class=\"p\">())));</span>\n</span><span id=\"__span-12-12\"><a id=\"__codelineno-12-12\" name=\"__codelineno-12-12\" href=\"#__codelineno-12-12\"></a><span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">;</span>\n</span><span id=\"__span-12-13\"><a id=\"__codelineno-12-13\" name=\"__codelineno-12-13\" href=\"#__codelineno-12-13\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<h3 id=\"\u57fa\u4e8e-token-threading-\u7684\u89e3\u91ca\u5668-mterp-nterp\">\u57fa\u4e8e token threading \u7684\u89e3\u91ca\u5668 mterp (nterp)<a class=\"headerlink\" href=\"#\u57fa\u4e8e-token-threading-\u7684\u89e3\u91ca\u5668-mterp-nterp\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7b2c\u4e8c\u4e2a\u89e3\u91ca\u5668\u5219\u662f\u57fa\u4e8e token threading \u7684\u89e3\u91ca\u5668\uff0c\u5b83\u7684\u6e90\u7801\u5728 <code>runtime/interpreter/mterp</code> \u76ee\u5f55\u4e0b\u3002\u7531\u4e8e\u8fd9\u4e9b\u4ee3\u7801\u662f\u7528\u6c47\u7f16\u5199\u7684\uff0c\u76f4\u63a5\u5199\u4f1a\u6709\u5f88\u591a\u91cd\u590d\u7684\u90e8\u5206\u3002\u4e3a\u4e86\u907f\u514d\u91cd\u590d\u7684\u4ee3\u7801\uff0c\u76ee\u524d\u7684\u89e3\u91ca\u5668 mterp (\u73b0\u5728\u53eb nterp) \u7528 Python \u811a\u672c\u6765\u751f\u6210\u6700\u7ec8\u7684\u6c47\u7f16\u4ee3\u7801\u3002\u8981\u751f\u6210\u5b83\uff0c\u4e5f\u5f88\u7b80\u5355\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-13-1\"><a id=\"__codelineno-13-1\" name=\"__codelineno-13-1\" href=\"#__codelineno-13-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>runtime/interpreter/mterp\n</span><span id=\"__span-13-2\"><a id=\"__codelineno-13-2\" name=\"__codelineno-13-2\" href=\"#__codelineno-13-2\"></a>./gen_mterp.py<span class=\"w\"> </span>mterp_arm64ng.S<span class=\"w\"> </span>arm64ng/*.S\n</span></code></pre></div>\n<p>\u8fd9\u4e2a\u811a\u672c\u662f\u5e73\u53f0\u65e0\u5173\u7684\uff0c\u4f8b\u5982\u5982\u679c\u8981\u751f\u6210 amd64 \u5e73\u53f0\u7684\u6c47\u7f16\uff0c\u53ea\u9700\u8981\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-14-1\"><a id=\"__codelineno-14-1\" name=\"__codelineno-14-1\" href=\"#__codelineno-14-1\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>runtime/interpreter/mterp\n</span><span id=\"__span-14-2\"><a id=\"__codelineno-14-2\" name=\"__codelineno-14-2\" href=\"#__codelineno-14-2\"></a>./gen_mterp.py<span class=\"w\"> </span>mterp_x86_64ng.S<span class=\"w\"> </span>x86_64ng/*.S\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u770b\u5230\u5b8c\u6574\u7684\u6c47\u7f16\u4ee3\u7801\u4e86\uff0c\u540e\u7eed\u7684\u5206\u6790\u90fd\u4f1a\u57fa\u4e8e\u8fd9\u4efd\u6c47\u7f16\u4ee3\u7801\u3002\u5982\u679c\u8bfb\u8005\u5bf9 amd64 \u6c47\u7f16\u6bd4\u8f83\u719f\u6089\uff0c\u4e5f\u53ef\u4ee5\u5728\u672c\u5730\u751f\u6210\u4e00\u4efd amd64 \u7684\u6c47\u7f16\u518d\u7ed3\u5408\u672c\u6587\u8fdb\u884c\u7406\u89e3\u3002</p>\n<p>\u4e0a\u9762\u63d0\u5230\u8fc7 <code>add-int/2addr vA, vB</code> \u8fd9\u4e2a\u505a\u6574\u6570\u52a0\u6cd5\u7684 Op\uff0c\u76f4\u63a5\u5728\u751f\u6210\u7684\u6c47\u7f16\u4e2d\uff0c\u627e\u5230\u5b83\u5bf9\u5e94\u7684\u4ee3\u7801\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-15-1\"><a id=\"__codelineno-15-1\" name=\"__codelineno-15-1\" href=\"#__codelineno-15-1\"></a><span class=\"w\">    </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"no\">NTERP_HANDLER_SIZE</span>\n</span><span id=\"__span-15-2\"><a id=\"__codelineno-15-2\" name=\"__codelineno-15-2\" href=\"#__codelineno-15-2\"></a><span class=\"nl\">.L_op_add_int_2addr:</span><span class=\"w\"> </span><span class=\"cm\">/* 0xb0 */</span>\n</span><span id=\"__span-15-3\"><a id=\"__codelineno-15-3\" name=\"__codelineno-15-3\" href=\"#__codelineno-15-3\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-15-4\"><a id=\"__codelineno-15-4\" name=\"__codelineno-15-4\" href=\"#__codelineno-15-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* binop/2addr vA, vB */</span>\n</span><span id=\"__span-15-5\"><a id=\"__codelineno-15-5\" name=\"__codelineno-15-5\" href=\"#__codelineno-15-5\"></a><span class=\"w\">    </span><span class=\"nf\">lsr</span><span class=\"w\">     </span><span class=\"no\">w3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">wINST</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#12</span><span class=\"w\">              </span><span class=\"c1\">// w3&lt;- B</span>\n</span><span id=\"__span-15-6\"><a id=\"__codelineno-15-6\" name=\"__codelineno-15-6\" href=\"#__codelineno-15-6\"></a><span class=\"w\">    </span><span class=\"nf\">ubfx</span><span class=\"w\">    </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">wINST</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#4</span><span class=\"w\">           </span><span class=\"c1\">// w9&lt;- A</span>\n</span><span id=\"__span-15-7\"><a id=\"__codelineno-15-7\" name=\"__codelineno-15-7\" href=\"#__codelineno-15-7\"></a><span class=\"w\">    </span><span class=\"nf\">GET_VREG</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w3</span><span class=\"w\">                     </span><span class=\"c1\">// w1&lt;- vB</span>\n</span><span id=\"__span-15-8\"><a id=\"__codelineno-15-8\" name=\"__codelineno-15-8\" href=\"#__codelineno-15-8\"></a><span class=\"w\">    </span><span class=\"nf\">GET_VREG</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"w\">                     </span><span class=\"c1\">// w0&lt;- vA</span>\n</span><span id=\"__span-15-9\"><a id=\"__codelineno-15-9\" name=\"__codelineno-15-9\" href=\"#__codelineno-15-9\"></a><span class=\"w\">    </span><span class=\"nf\">FETCH_ADVANCE_INST</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">                </span><span class=\"c1\">// advance rPC, load rINST</span>\n</span><span id=\"__span-15-10\"><a id=\"__codelineno-15-10\" name=\"__codelineno-15-10\" href=\"#__codelineno-15-10\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\">     </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"w\">                  </span><span class=\"c1\">// w0&lt;- op, w0-w3 changed</span>\n</span><span id=\"__span-15-11\"><a id=\"__codelineno-15-11\" name=\"__codelineno-15-11\" href=\"#__codelineno-15-11\"></a><span class=\"w\">    </span><span class=\"nf\">GET_INST_OPCODE</span><span class=\"w\"> </span><span class=\"no\">ip</span><span class=\"w\">                  </span><span class=\"c1\">// extract opcode from rINST</span>\n</span><span id=\"__span-15-12\"><a id=\"__codelineno-15-12\" name=\"__codelineno-15-12\" href=\"#__codelineno-15-12\"></a><span class=\"w\">    </span><span class=\"nf\">SET_VREG</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"w\">                     </span><span class=\"c1\">// vAA&lt;- w0</span>\n</span><span id=\"__span-15-13\"><a id=\"__codelineno-15-13\" name=\"__codelineno-15-13\" href=\"#__codelineno-15-13\"></a><span class=\"w\">    </span><span class=\"nf\">GOTO_OPCODE</span><span class=\"w\"> </span><span class=\"no\">ip</span><span class=\"w\">                      </span><span class=\"c1\">// jump to next instruction</span>\n</span><span id=\"__span-15-14\"><a id=\"__codelineno-15-14\" name=\"__codelineno-15-14\" href=\"#__codelineno-15-14\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span></code></pre></div>\n<p>\u5176\u4e2d <code>wINST</code> \u8868\u793a\u5f53\u524d Op \u7684\u524d\u4e24\u4e2a\u5b57\u8282\u7684\u5185\u5bb9\uff0c\u524d\u9762\u63d0\u5230\uff0c<code>add-int/2addr vA, vB</code> \u7f16\u7801\u4e3a\u4e24\u4e2a\u5b57\u8282\uff0c\u7b2c\u4e00\u4e2a\u5b57\u8282\u662f\u56fa\u5b9a\u7684 <code>0xb0</code>\uff0c\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5171 8 \u4f4d\uff0c\u4f4e 4 \u4f4d\u7f16\u7801\u4e86 <code>vA</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>A</code>\uff0c\u9ad8 4 \u4f4d\u7f16\u7801\u4e86 <code>vB</code> \u7684\u5bc4\u5b58\u5668\u7f16\u53f7 <code>B</code>\u3002\u7531\u4e8e\u8fd9\u662f\u5c0f\u7aef\u5e8f\u7684\u5904\u7406\u5668\uff0c\u90a3\u4e48\u89e3\u91ca\u4e3a 16 \u4f4d\u6574\u6570\uff0c\u4ece\u9ad8\u4f4d\u5230\u4f4e\u4f4d\u4f9d\u6b21\u662f\uff1a4 \u4f4d\u7684 <code>B</code>\uff0c4 \u4f4d\u7684 <code>A</code> \u548c 8 \u4f4d\u7684 <code>0xb0</code>\u3002\u77e5\u9053\u8fd9\u4e2a\u80cc\u666f\u4ee5\u540e\uff0c\u518d\u6765\u5206\u6790\u6bcf\u6761\u6307\u4ee4\u505a\u7684\u4e8b\u60c5\uff0c\u5c31\u5f88\u6e05\u6670\uff1a</p>\n<ol>\n<li><code>lsr w3, wINST, #12</code>\uff1a\u6c42 <code>wINST</code> \u53f3\u79fb\u52a8 12 \u4f4d\uff0c\u5f97\u5230\u4e86 <code>B</code></li>\n<li><code>ubfx w9, wINST, #8, #4</code>: <code>ubfx</code> \u662f Bit Extract \u6307\u4ee4\uff0c\u8fd9\u91cc\u7684\u610f\u601d\u662f\u4ece <code>wINST</code> \u7b2c 8 \u4f4d\u5f00\u59cb\u53d6 4 \u4f4d\u6570\u636e\u51fa\u6765\uff0c\u4e5f\u5c31\u662f <code>A</code></li>\n<li><code>GET_VREG w1, w3</code>: \u8bfb\u53d6\u5bc4\u5b58\u5668\u7f16\u53f7\u4e3a <code>w3</code> \u7684\u503c\uff0c\u5199\u5230 <code>w1</code> \u5f53\u4e2d\uff0c\u7ed3\u5408\u7b2c\u4e00\u6761\u6307\u4ee4\uff0c\u53ef\u77e5\u6b64\u65f6 <code>w1</code> \u7b49\u4e8e <code>B</code> \u5bc4\u5b58\u5668\u7684\u503c</li>\n<li><code>GET_VREG w0, w9</code>: \u8bfb\u53d6\u5bc4\u5b58\u5668\u7f16\u53f7\u4e3a <code>w9</code> \u7684\u503c\uff0c\u5199\u5230 <code>w0</code> \u5f53\u4e2d\uff0c\u7ed3\u5408\u7b2c\u4e8c\u6761\u6307\u4ee4\uff0c\u53ef\u77e5\u6b64\u65f6 <code>w0</code> \u7b49\u4e8e <code>A</code> \u5bc4\u5b58\u5668\u7684\u503c</li>\n<li><code>FETCH_ADVANCE_INST 1</code>: \u628a \"PC\" \u5f80\u524d\u79fb\u52a8 1 \u4e2a\u5355\u4f4d\u7684\u8ddd\u79bb\uff0c\u4e5f\u5c31\u662f\u4e24\u4e2a\u5b57\u8282\uff0c\u5e76\u8bfb\u53d6\u4e0b\u4e00\u4e2a Op \u5230 <code>rINST</code> \u5f53\u4e2d</li>\n<li><code>add w0, w0, w1</code>: \u8fdb\u884c\u5b9e\u9645\u7684\u6574\u6570\u52a0\u6cd5\u8fd0\u7b97\uff0c\u7ed3\u679c\u4fdd\u5b58\u5728 <code>w0</code> \u5f53\u4e2d</li>\n<li><code>GET_INST_OPCODE ip</code>: \u6839\u636e\u7b2c\u4e94\u6761\u6307\u4ee4\u8bfb\u53d6\u7684\u4e0b\u4e00\u4e2a Op \u7684\u503c <code>rINST</code>\uff0c\u89e3\u6790\u51fa\u5b83\u7684 Opcode</li>\n<li><code>SET_VREG w0, w9</code>: \u628a\u6574\u6570\u52a0\u6cd5\u7684\u7ed3\u679c\u5199\u56de\u5230\u5bc4\u5b58\u5668\u7f16\u53f7\u4e3a <code>w9</code> \u7684\u5bc4\u5b58\u5668\u5f53\u4e2d\uff0c\u7ed3\u5408\u7b2c\u4e8c\u6761\u6307\u4ee4\uff0c\u53ef\u77e5\u5199\u5165\u7684\u662f <code>A</code> \u5bc4\u5b58\u5668</li>\n<li><code>GOTO_OPCODE ip</code>: \u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a Op \u5bf9\u5e94\u7684 handler</li>\n</ol>\n<p>\u6574\u4f53\u4ee3\u7801\u8fd8\u662f\u6bd4\u8f83\u6e05\u6670\u7684\uff0c\u53ea\u662f\u8bf4\u628a\u8ba1\u7b97 <code>A + B</code> \u5199\u5165 <code>A</code> \u7684\u8fc7\u7a0b\u548c\u8bfb\u53d6\u4e0b\u4e00\u4e2a Op \u5e76\u8df3\u8f6c\u7684\u903b\u8f91\u7a7f\u63d2\u4e86\u8d77\u6765\uff0c\u624b\u52a8\u505a\u4e86\u4e00\u6b21\u5bc4\u5b58\u5668\u8c03\u5ea6\u3002\u90a3\u4e48\u8fd9\u4e9b <code>GET_REG</code> \u548c <code>FETCH_ADVANCE_INST</code> \u7b49\u7b49\u5177\u4f53\u53c8\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u5462\uff1f\u4e0b\u9762\u628a\u5b8f\u5c55\u5f00\u540e\u7684\u4ee3\u7801\u8d34\u51fa\u6765\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-16-1\"><a id=\"__codelineno-16-1\" name=\"__codelineno-16-1\" href=\"#__codelineno-16-1\"></a><span class=\"w\">    </span><span class=\"na\">.balign</span><span class=\"w\"> </span><span class=\"no\">NTERP_HANDLER_SIZE</span>\n</span><span id=\"__span-16-2\"><a id=\"__codelineno-16-2\" name=\"__codelineno-16-2\" href=\"#__codelineno-16-2\"></a><span class=\"nl\">.L_op_add_int_2addr:</span><span class=\"w\"> </span><span class=\"cm\">/* 0xb0 */</span>\n</span><span id=\"__span-16-3\"><a id=\"__codelineno-16-3\" name=\"__codelineno-16-3\" href=\"#__codelineno-16-3\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span><span id=\"__span-16-4\"><a id=\"__codelineno-16-4\" name=\"__codelineno-16-4\" href=\"#__codelineno-16-4\"></a><span class=\"w\">    </span><span class=\"cm\">/* binop/2addr vA, vB */</span>\n</span><span id=\"__span-16-5\"><a id=\"__codelineno-16-5\" name=\"__codelineno-16-5\" href=\"#__codelineno-16-5\"></a>\n</span><span id=\"__span-16-6\"><a id=\"__codelineno-16-6\" name=\"__codelineno-16-6\" href=\"#__codelineno-16-6\"></a><span class=\"w\">    </span><span class=\"c1\">// wINST is w23, the first 16-bit code unit of current instruction</span>\n</span><span id=\"__span-16-7\"><a id=\"__codelineno-16-7\" name=\"__codelineno-16-7\" href=\"#__codelineno-16-7\"></a><span class=\"w\">    </span><span class=\"c1\">// lsr     w3, wINST, #12              // w3&lt;- B</span>\n</span><span id=\"__span-16-8\"><a id=\"__codelineno-16-8\" name=\"__codelineno-16-8\" href=\"#__codelineno-16-8\"></a><span class=\"w\">    </span><span class=\"nf\">lsr</span><span class=\"w\"> </span><span class=\"no\">w3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#12</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-9\"><a id=\"__codelineno-16-9\" name=\"__codelineno-16-9\" href=\"#__codelineno-16-9\"></a><span class=\"w\">    </span><span class=\"c1\">// ubfx    w9, wINST, #8, #4           // w9&lt;- A</span>\n</span><span id=\"__span-16-10\"><a id=\"__codelineno-16-10\" name=\"__codelineno-16-10\" href=\"#__codelineno-16-10\"></a><span class=\"w\">    </span><span class=\"nf\">ubfx</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#4</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-11\"><a id=\"__codelineno-16-11\" name=\"__codelineno-16-11\" href=\"#__codelineno-16-11\"></a>\n</span><span id=\"__span-16-12\"><a id=\"__codelineno-16-12\" name=\"__codelineno-16-12\" href=\"#__codelineno-16-12\"></a><span class=\"w\">    </span><span class=\"c1\">// virtual registers are stored relative to xFP(x29), the interpreted frame pointer, used for accessing locals and args</span>\n</span><span id=\"__span-16-13\"><a id=\"__codelineno-16-13\" name=\"__codelineno-16-13\" href=\"#__codelineno-16-13\"></a><span class=\"w\">    </span><span class=\"c1\">// GET_VREG w1, w3                     // w1&lt;- vB</span>\n</span><span id=\"__span-16-14\"><a id=\"__codelineno-16-14\" name=\"__codelineno-16-14\" href=\"#__codelineno-16-14\"></a><span class=\"w\">    </span><span class=\"nf\">ldr</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-15\"><a id=\"__codelineno-16-15\" name=\"__codelineno-16-15\" href=\"#__codelineno-16-15\"></a><span class=\"w\">    </span><span class=\"c1\">// GET_VREG w0, w9                     // w0&lt;- vA</span>\n</span><span id=\"__span-16-16\"><a id=\"__codelineno-16-16\" name=\"__codelineno-16-16\" href=\"#__codelineno-16-16\"></a><span class=\"w\">    </span><span class=\"nf\">ldr</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-17\"><a id=\"__codelineno-16-17\" name=\"__codelineno-16-17\" href=\"#__codelineno-16-17\"></a>\n</span><span id=\"__span-16-18\"><a id=\"__codelineno-16-18\" name=\"__codelineno-16-18\" href=\"#__codelineno-16-18\"></a><span class=\"w\">    </span><span class=\"c1\">// xPC(x22) is the interpreted program counter, used for fetching instructions</span>\n</span><span id=\"__span-16-19\"><a id=\"__codelineno-16-19\" name=\"__codelineno-16-19\" href=\"#__codelineno-16-19\"></a><span class=\"w\">    </span><span class=\"c1\">// FETCH_ADVANCE_INST 1                // advance rPC, load rINST</span>\n</span><span id=\"__span-16-20\"><a id=\"__codelineno-16-20\" name=\"__codelineno-16-20\" href=\"#__codelineno-16-20\"></a><span class=\"w\">    </span><span class=\"c1\">// a pre-index load instruction that both reads wINST from memory and increments xPC(x22) by 2</span>\n</span><span id=\"__span-16-21\"><a id=\"__codelineno-16-21\" name=\"__codelineno-16-21\" href=\"#__codelineno-16-21\"></a><span class=\"w\">    </span><span class=\"nf\">ldrh</span><span class=\"w\"> </span><span class=\"no\">w23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x22</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]!</span>\n</span><span id=\"__span-16-22\"><a id=\"__codelineno-16-22\" name=\"__codelineno-16-22\" href=\"#__codelineno-16-22\"></a>\n</span><span id=\"__span-16-23\"><a id=\"__codelineno-16-23\" name=\"__codelineno-16-23\" href=\"#__codelineno-16-23\"></a><span class=\"w\">    </span><span class=\"c1\">// add     w0, w0, w1                  // w0&lt;- op, w0-w3 changed</span>\n</span><span id=\"__span-16-24\"><a id=\"__codelineno-16-24\" name=\"__codelineno-16-24\" href=\"#__codelineno-16-24\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w1</span><span class=\"w\"> </span>\n</span><span id=\"__span-16-25\"><a id=\"__codelineno-16-25\" name=\"__codelineno-16-25\" href=\"#__codelineno-16-25\"></a>\n</span><span id=\"__span-16-26\"><a id=\"__codelineno-16-26\" name=\"__codelineno-16-26\" href=\"#__codelineno-16-26\"></a><span class=\"w\">    </span><span class=\"c1\">// ip(x16) is a scratch register, used to store the first byte (opcode) of wINST</span>\n</span><span id=\"__span-16-27\"><a id=\"__codelineno-16-27\" name=\"__codelineno-16-27\" href=\"#__codelineno-16-27\"></a><span class=\"w\">    </span><span class=\"c1\">// GET_INST_OPCODE ip                  // extract opcode from rINST</span>\n</span><span id=\"__span-16-28\"><a id=\"__codelineno-16-28\" name=\"__codelineno-16-28\" href=\"#__codelineno-16-28\"></a><span class=\"w\">    </span><span class=\"nf\">and</span><span class=\"w\"> </span><span class=\"no\">x16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0xff</span>\n</span><span id=\"__span-16-29\"><a id=\"__codelineno-16-29\" name=\"__codelineno-16-29\" href=\"#__codelineno-16-29\"></a>\n</span><span id=\"__span-16-30\"><a id=\"__codelineno-16-30\" name=\"__codelineno-16-30\" href=\"#__codelineno-16-30\"></a><span class=\"w\">    </span><span class=\"c1\">// save addition result to virtual register, which is relative to xFP(x29)</span>\n</span><span id=\"__span-16-31\"><a id=\"__codelineno-16-31\" name=\"__codelineno-16-31\" href=\"#__codelineno-16-31\"></a><span class=\"w\">    </span><span class=\"c1\">// also set its object references to zero, which is relative to xREFS(x25)</span>\n</span><span id=\"__span-16-32\"><a id=\"__codelineno-16-32\" name=\"__codelineno-16-32\" href=\"#__codelineno-16-32\"></a><span class=\"w\">    </span><span class=\"c1\">// SET_VREG w0, w9                     // vAA&lt;- w0</span>\n</span><span id=\"__span-16-33\"><a id=\"__codelineno-16-33\" name=\"__codelineno-16-33\" href=\"#__codelineno-16-33\"></a><span class=\"w\">    </span><span class=\"nf\">str</span><span class=\"w\"> </span><span class=\"no\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span>\n</span><span id=\"__span-16-34\"><a id=\"__codelineno-16-34\" name=\"__codelineno-16-34\" href=\"#__codelineno-16-34\"></a><span class=\"w\">    </span><span class=\"nf\">str</span><span class=\"w\"> </span><span class=\"no\">wzr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x25</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">w9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">uxtw</span><span class=\"w\"> </span><span class=\"mi\">#2</span><span class=\"p\">]</span>\n</span><span id=\"__span-16-35\"><a id=\"__codelineno-16-35\" name=\"__codelineno-16-35\" href=\"#__codelineno-16-35\"></a>\n</span><span id=\"__span-16-36\"><a id=\"__codelineno-16-36\" name=\"__codelineno-16-36\" href=\"#__codelineno-16-36\"></a><span class=\"w\">    </span><span class=\"c1\">// now x16 saves the opcode, and xIBASE(x24) interpreted instruction base pointer, used for computed goto</span>\n</span><span id=\"__span-16-37\"><a id=\"__codelineno-16-37\" name=\"__codelineno-16-37\" href=\"#__codelineno-16-37\"></a><span class=\"w\">    </span><span class=\"c1\">// for opcode #k, the handler address of it would be `xIBASE + k * 128`</span>\n</span><span id=\"__span-16-38\"><a id=\"__codelineno-16-38\" name=\"__codelineno-16-38\" href=\"#__codelineno-16-38\"></a><span class=\"w\">    </span><span class=\"c1\">// GOTO_OPCODE ip                      // jump to next instruction</span>\n</span><span id=\"__span-16-39\"><a id=\"__codelineno-16-39\" name=\"__codelineno-16-39\" href=\"#__codelineno-16-39\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">x16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">lsl</span><span class=\"w\"> </span><span class=\"mi\">#7</span>\n</span><span id=\"__span-16-40\"><a id=\"__codelineno-16-40\" name=\"__codelineno-16-40\" href=\"#__codelineno-16-40\"></a><span class=\"w\">    </span><span class=\"nf\">br</span><span class=\"w\"> </span><span class=\"no\">x16</span>\n</span><span id=\"__span-16-41\"><a id=\"__codelineno-16-41\" name=\"__codelineno-16-41\" href=\"#__codelineno-16-41\"></a><span class=\"w\">    </span><span class=\"cm\">/* omitted */</span>\n</span></code></pre></div>\n<p>\u5404\u4e2a\u5bc4\u5b58\u5668\u7684\u542b\u4e49\u5df2\u7ecf\u5728\u4e0a\u9762\u7684\u6ce8\u91ca\u4e2d\u5199\u51fa\uff0c\u6bd4\u5982 <code>w23</code> \u8bb0\u5f55\u4e86\u5f53\u524d Op \u7684\u524d 16 \u4f4d\u7684\u5185\u5bb9\uff0c<code>x29</code> \u8bb0\u5f55\u4e86\u5f53\u524d\u7684 frame pointer\uff0c\u901a\u8fc7\u5b83\u53ef\u4ee5\u8bbf\u95ee\u5404\u4e2a virtual register\uff1b<code>x11</code> \u662f PC\uff0c\u8bb0\u5f55\u4e86\u6b63\u5728\u6267\u884c\u7684 Op \u7684\u5730\u5740\uff1b<code>x24</code> \u8bb0\u5f55\u4e86\u8fd9\u4e9b op handler \u7684\u8d77\u59cb\u5730\u5740\uff0c\u7531\u4e8e\u6bcf\u4e2a handler \u90fd\u4e0d\u8d85\u8fc7 128 \u5b57\u8282\uff0c\u4e14\u90fd\u5bf9\u9f50\u5230 128 \u5b57\u8282\u8fb9\u754c\uff08<code>.balign NTERP_HANDLER_SIZE</code>\uff09\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u7b80\u5355\u7684\u8fd0\u7b97 <code>xIBASE + opcode * 128</code> \u5373\u53ef\u627e\u5230\u4e0b\u4e00\u4e2a op \u7684 handler \u5730\u5740\uff0c\u4e0d\u9700\u8981\u518d\u8fdb\u884c\u4e00\u6b21\u8bbf\u5b58\u3002</p>\n<p>\u5982\u679c\u8981\u6bd4\u8f83\u4e00\u4e0b Android Runtime \u7684 mterp (nterp) \u548c <a href=\"../../01/v8-ignition-internals/\">V8 \u7684 Ignition \u89e3\u91ca\u5668</a>\u7684\u5b9e\u73b0\uff0c\u6709\u5982\u4e0b\u51e0\u70b9\u76f8\u540c\u4e0e\u4e0d\u540c\uff1a</p>\n<ol>\n<li>\u4e24\u8005\u90fd\u91c7\u7528\u4e86 token threading \u7684\u65b9\u6cd5\uff0c\u5373\u5728\u4e00\u4e2a Op \u5904\u7406\u5b8c\u6210\u4ee5\u540e\uff0c\u8ba1\u7b97\u51fa\u4e0b\u4e00\u4e2a Op \u7684 handler \u7684\u5730\u5740\uff0c\u8df3\u8f6c\u8fc7\u53bb</li>\n<li>V8 \u7684 op handler \u662f\u52a8\u6001\u751f\u6210\u7684\uff08<code>mksnapshot</code> \u9636\u6bb5\uff09\uff0c\u957f\u5ea6\u6ca1\u6709\u9650\u5236\uff0c\u5141\u8bb8\u751f\u6210\u6bd4\u8f83\u590d\u6742\u7684\u6c47\u7f16\uff0c\u4f46\u5982\u679c\u6c47\u7f16\u6bd4\u8f83\u77ed\uff08\u6bd4\u5982 release \u6a21\u5f0f\u4e0b\uff09\uff0c\u4e5f\u53ef\u4ee5\u8282\u7701\u4e00\u4e9b\u5185\u5b58\uff1b\u4ee3\u4ef7\u662f\u9700\u8981\u4e00\u6b21\u989d\u5916\u7684\u5bf9 dispatch table \u7684\u8bbf\u5b58\uff0c\u6765\u627e\u5230 opcode \u5bf9\u5e94\u7684 handler</li>\n<li>mterp \u7684 op handler \u5bf9\u9f50\u5230 128B \u8fb9\u754c\uff0c\u5e26\u6765\u7684\u597d\u5904\u662f\u4e0d\u9700\u8981\u8bbf\u95ee dispatch table\uff0c\u76f4\u63a5\u6839\u636e opcode \u8ba1\u7b97\u5730\u5740\u5373\u53ef\uff0c\u4e0d\u8fc7\u7531\u4e8e\u5f88\u591a handler \u5f88\u77ed\uff0c\u53ef\u80fd\u53ea\u6709\u5341\u6761\u6307\u4ee4\u5de6\u53f3\uff0c\u5c31\u4f1a\u6d6a\u8d39\u4e86\u4e00\u4e9b\u5185\u5b58</li>\n<li>V8 \u6ca1\u6709 handler \u957f\u5ea6\u7684\u9650\u5236\uff0c\u6240\u4ee5\u9488\u5bf9\u4e00\u4e9b\u5e38\u89c1\u7684 Op \u505a\u4e86\u4f18\u5316\uff08Short Star\uff09\uff0c\u53ef\u4ee5\u51cf\u5c11\u4e00\u4e9b\u8df3\u8f6c\u7684\u5f00\u9500</li>\n<li>V8 \u5728\u533a\u5206 Smi(Small integer) \u548c\u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u505a\u6cd5\u662f\u5728 LSB \u4e0a\u6253\u6807\u8bb0\uff1a0 \u8868\u793a Smi\uff0c1 \u8868\u793a\u5bf9\u8c61\uff1bmterp \u5219\u4e0d\u540c\uff0c\u5b83\u7ed9\u6bcf\u4e2a\u865a\u62df\u5bc4\u5b58\u5668\u7ef4\u62a4\u4e86\u4e24\u4e2a 32 \u4f4d\u7684\u503c\uff1a\u4e00\u4e2a\u4fdd\u5b58\u5728 xFP \u6307\u5411\u7684\u6570\u7ec4\u5f53\u4e2d\uff0c\u8bb0\u5f55\u7684\u662f\u5b83\u7684\u5b9e\u9645\u7684\u503c\uff0c\u6bd4\u5982 int \u7684\u503c\uff0c\u6216\u8005\u5bf9\u8c61\u7684\u5f15\u7528\uff1b\u53e6\u4e00\u4e2a\u4fdd\u5b58\u5728 xREFS \u6307\u5411\u7684\u6570\u7ec4\u5f53\u4e2d\uff0c\u8bb0\u5f55\u7684\u662f\u5b83\u5f15\u7528\u7684\u5bf9\u8c61\uff0c\u5982\u679c\u4e0d\u662f\u5bf9\u8c61\uff0c\u5219\u8bb0\u5f55\u7684\u662f 0</li>\n</ol>\n<p>\u9664\u4e86\u4ee5\u4e0a\u5217\u4e3e\u7684\u4e0d\u540c\u7684\u5730\u65b9\u4ee5\u5916\uff0c\u5176\u5b9e\u6574\u4f53\u6765\u770b\u662f\u5341\u5206\u7c7b\u4f3c\u7684\uff0c\u4e0b\u9762\u662f\u4e8c\u8005\u5b9e\u73b0\u628a\u6574\u6570\u52a0\u8f7d\u5230\u5bc4\u5b58\u5668\uff08<code>const/4 vA, #+B</code> \u548c <code>LdaSmi</code>\uff09\u7684\u6c47\u7f16\u7684\u5bf9\u6bd4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>mterp (nterp)</th>\n<th>Ignition</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Extract Dest Register</td>\n<td><code>ubfx w0, w23, #8, #4</code></td>\n<td>N/A (destination is always the accumulator)</td>\n</tr>\n<tr>\n<td>Extract Const Integer</td>\n<td><code>sbfx w1, w23, #12, #4</code></td>\n<td><code>add x1, x19, #1; ldrsb w1, [x20, x1]</code></td>\n</tr>\n<tr>\n<td>Read Next Op</td>\n<td><code>ldrh w23, [x22, #2]!</code></td>\n<td><code>add x19, x19, #2; ldrb w3, [x20, x19]</code></td>\n</tr>\n<tr>\n<td>Save Result</td>\n<td><code>str w1, [x29, w0, uxtw #2]; str wzr, [x25, w0, uxtw #2]</code></td>\n<td><code>add w0, w1, w1</code></td>\n</tr>\n<tr>\n<td>Computed Goto</td>\n<td><code>and x16, x23, 0xff; add x16, x24, x16, lsl #7; br x16</code></td>\n<td><code>ldr x2, [x21, x3, lsl #3]; mov x17, x2; br x2</code></td>\n</tr>\n</tbody>\n</table>\n<p>\u5728\u5bc4\u5b58\u5668\u7684\u7ea6\u5b9a\u548c\u4f7f\u7528\u4e0a\u7684\u533a\u522b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Purpose</th>\n<th>mterp (nterp)</th>\n<th>Ignition</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Intepreter PC</td>\n<td>base + offset in <code>x22</code></td>\n<td>base in <code>x20</code>, offset in <code>x19</code></td>\n</tr>\n<tr>\n<td>Virtual Register</td>\n<td>relative to <code>x29</code></td>\n<td>relative to <code>fp</code></td>\n</tr>\n<tr>\n<td>Dispatch Table</td>\n<td>computed from <code>x24</code></td>\n<td>saved in <code>x21</code></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"lua-\u89e3\u91ca\u5668\">Lua \u89e3\u91ca\u5668<a class=\"headerlink\" href=\"#lua-\u89e3\u91ca\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>\u65e2\u7136\u5df2\u7ecf\u5206\u6790\u4e86 <a href=\"../../01/v8-ignition-internals/\">V8</a> \u548c Android Runtime \u7684\u89e3\u91ca\u5668\uff0c\u4e5f\u6765\u7b80\u5355\u770b\u4e00\u4e0b <a href=\"https://www.lua.org/\">Lua</a> \u7684\u89e3\u91ca\u5668\u5b9e\u73b0\u3002\u5b83\u5199\u7684\u975e\u5e38\u7b80\u5355\uff0c\u6838\u5fc3\u4ee3\u7801\u5c31\u5728 <code>lvm.c</code> \u5f53\u4e2d\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-17-1\"><a id=\"__codelineno-17-1\" name=\"__codelineno-17-1\" href=\"#__codelineno-17-1\"></a><span class=\"n\">vmdispatch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">GET_OPCODE</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-2\"><a id=\"__codelineno-17-2\" name=\"__codelineno-17-2\" href=\"#__codelineno-17-2\"></a><span class=\"w\">  </span><span class=\"n\">vmcase</span><span class=\"p\">(</span><span class=\"n\">OP_MOVE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-3\"><a id=\"__codelineno-17-3\" name=\"__codelineno-17-3\" href=\"#__codelineno-17-3\"></a><span class=\"w\">    </span><span class=\"n\">StkId</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RA</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-4\"><a id=\"__codelineno-17-4\" name=\"__codelineno-17-4\" href=\"#__codelineno-17-4\"></a><span class=\"w\">    </span><span class=\"n\">setobjs2s</span><span class=\"p\">(</span><span class=\"n\">L</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">RB</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span>\n</span><span id=\"__span-17-5\"><a id=\"__codelineno-17-5\" name=\"__codelineno-17-5\" href=\"#__codelineno-17-5\"></a><span class=\"w\">    </span><span class=\"n\">vmbreak</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-6\"><a id=\"__codelineno-17-6\" name=\"__codelineno-17-6\" href=\"#__codelineno-17-6\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-17-7\"><a id=\"__codelineno-17-7\" name=\"__codelineno-17-7\" href=\"#__codelineno-17-7\"></a><span class=\"w\">  </span><span class=\"n\">vmcase</span><span class=\"p\">(</span><span class=\"n\">OP_LOADI</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-17-8\"><a id=\"__codelineno-17-8\" name=\"__codelineno-17-8\" href=\"#__codelineno-17-8\"></a><span class=\"w\">    </span><span class=\"n\">StkId</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RA</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-9\"><a id=\"__codelineno-17-9\" name=\"__codelineno-17-9\" href=\"#__codelineno-17-9\"></a><span class=\"w\">    </span><span class=\"n\">lua_Integer</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GETARG_sBx</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-10\"><a id=\"__codelineno-17-10\" name=\"__codelineno-17-10\" href=\"#__codelineno-17-10\"></a><span class=\"w\">    </span><span class=\"n\">setivalue</span><span class=\"p\">(</span><span class=\"n\">s2v</span><span class=\"p\">(</span><span class=\"n\">ra</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">);</span>\n</span><span id=\"__span-17-11\"><a id=\"__codelineno-17-11\" name=\"__codelineno-17-11\" href=\"#__codelineno-17-11\"></a><span class=\"w\">    </span><span class=\"n\">vmbreak</span><span class=\"p\">;</span>\n</span><span id=\"__span-17-12\"><a id=\"__codelineno-17-12\" name=\"__codelineno-17-12\" href=\"#__codelineno-17-12\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-17-13\"><a id=\"__codelineno-17-13\" name=\"__codelineno-17-13\" href=\"#__codelineno-17-13\"></a><span class=\"w\">  </span><span class=\"c1\">// ...</span>\n</span><span id=\"__span-17-14\"><a id=\"__codelineno-17-14\" name=\"__codelineno-17-14\" href=\"#__codelineno-17-14\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u628a <code>switch</code>\u3001<code>case</code> \u548c <code>break</code> \u66ff\u6362\u6210\u4e86\u4e09\u4e2a\u5b8f <code>vmdispatch</code>\u3001<code>vmcase</code> \u548c <code>vmbreak</code>\u3002\u63a5\u4e0b\u6765\u770b\u5b83\u53ef\u80fd\u7684\u5b9a\u4e49\uff0c\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\u7f16\u8bd1\u5668\u4e0d\u652f\u6301 <code>goto *</code> \u8bed\u6cd5\uff0c\u6b64\u65f6\u5c31\u76f4\u63a5\u5c55\u5f00\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-18-1\"><a id=\"__codelineno-18-1\" name=\"__codelineno-18-1\" href=\"#__codelineno-18-1\"></a><span class=\"cp\">#define vmdispatch(o) switch(o)</span>\n</span><span id=\"__span-18-2\"><a id=\"__codelineno-18-2\" name=\"__codelineno-18-2\" href=\"#__codelineno-18-2\"></a><span class=\"cp\">#define vmcase(l) case l:</span>\n</span><span id=\"__span-18-3\"><a id=\"__codelineno-18-3\" name=\"__codelineno-18-3\" href=\"#__codelineno-18-3\"></a><span class=\"cp\">#define vmbreak break</span>\n</span></code></pre></div>\n<p>\u5982\u679c\u7f16\u8bd1\u5668\u652f\u6301 <code>goto *</code> \u8bed\u6cd5\uff0c\u5219\u5c55\u5f00\u6210\u5bf9\u5e94\u7684 <code>computed goto</code> \u5f62\u5f0f\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-19-1\"><a id=\"__codelineno-19-1\" name=\"__codelineno-19-1\" href=\"#__codelineno-19-1\"></a><span class=\"cp\">#define vmdispatch(x) goto *disptab[x];</span>\n</span><span id=\"__span-19-2\"><a id=\"__codelineno-19-2\" name=\"__codelineno-19-2\" href=\"#__codelineno-19-2\"></a><span class=\"cp\">#define vmcase(l) L_##l:</span>\n</span><span id=\"__span-19-3\"><a id=\"__codelineno-19-3\" name=\"__codelineno-19-3\" href=\"#__codelineno-19-3\"></a><span class=\"cp\">#define vmbreak mfetch(); vmdispatch(GET_OPCODE(i));</span>\n</span><span id=\"__span-19-4\"><a id=\"__codelineno-19-4\" name=\"__codelineno-19-4\" href=\"#__codelineno-19-4\"></a>\n</span><span id=\"__span-19-5\"><a id=\"__codelineno-19-5\" name=\"__codelineno-19-5\" href=\"#__codelineno-19-5\"></a><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">disptab</span><span class=\"p\">[</span><span class=\"n\">NUM_OPCODES</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-19-6\"><a id=\"__codelineno-19-6\" name=\"__codelineno-19-6\" href=\"#__codelineno-19-6\"></a><span class=\"w\">  </span><span class=\"o\">&amp;&amp;</span><span class=\"n\">L_OP_MOVE</span><span class=\"p\">,</span>\n</span><span id=\"__span-19-7\"><a id=\"__codelineno-19-7\" name=\"__codelineno-19-7\" href=\"#__codelineno-19-7\"></a><span class=\"w\">  </span><span class=\"o\">&amp;&amp;</span><span class=\"n\">L_OP_LOADI</span><span class=\"p\">,</span>\n</span><span id=\"__span-19-8\"><a id=\"__codelineno-19-8\" name=\"__codelineno-19-8\" href=\"#__codelineno-19-8\"></a><span class=\"w\">  </span><span class=\"c1\">// ...</span>\n</span><span id=\"__span-19-9\"><a id=\"__codelineno-19-9\" name=\"__codelineno-19-9\" href=\"#__codelineno-19-9\"></a><span class=\"p\">};</span>\n</span></code></pre></div>\n<p>\u548c\u4e4b\u524d\u5199\u7684\u89e3\u91ca\u5668\u7684\u4e0d\u540c\u5b9e\u73b0\u65b9\u6cd5\u5bf9\u5e94\uff0c\u5c31\u4e0d\u591a\u9610\u8ff0\u4e86\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/22187630/what-does-mterp-mean\">What does mterp mean?</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/523692715\">Android 11 \u65b0\u5f15\u5165\u7684 Dalvik \u5b57\u8282\u7801\u89e3\u91ca\u5668 Nterp</a></li>\n</ul>", "image": null, "date_modified": "2025-03-06T00:00:00+00:00", "authors": [], "tags": ["android", "art", "interpreter", "linux", "runtime", "software"]}, {"id": "https://jia.je/software/2025/03/01/v8-ignition-internals/", "url": "https://jia.je/software/2025/03/01/v8-ignition-internals/", "title": "V8 Ignition \u89e3\u91ca\u5668\u7684\u5185\u90e8\u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"v8-ignition-\u89e3\u91ca\u5668\u7684\u5185\u90e8\u5b9e\u73b0\u63a2\u7a76\">V8 Ignition \u89e3\u91ca\u5668\u7684\u5185\u90e8\u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#v8-ignition-\u89e3\u91ca\u5668\u7684\u5185\u90e8\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>V8 \u662f\u4e00\u4e2a\u5f88\u5e38\u89c1\u7684 JavaScript \u5f15\u64ce\uff0c\u8fd0\u884c\u5728\u5f88\u591a\u7684\u8bbe\u5907\u4e0a\uff0c\u56e0\u6b64\u60f3\u63a2\u7a76\u4e00\u4e0b\u5b83\u5185\u90e8\u7684\u90e8\u5206\u5b9e\u73b0\u3002\u672c\u535a\u5ba2\u5728 ARM64 Ubuntu 24.04 \u5e73\u53f0\u4e0a\u9488\u5bf9 <a href=\"https://chromium.googlesource.com/v8/v8.git/+/6f774f929205be0a49cf861b8d73a92655e1dd36\">V8 12.8.374.31</a> \u7248\u672c\u8fdb\u884c\u5206\u6790\u3002\u672c\u535a\u5ba2\u4e3b\u8981\u5206\u6790\u4e86 V8 \u7684 Ignition \u89e3\u91ca\u5668\u7684\u89e3\u91ca\u6267\u884c\u90e8\u5206\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u7f16\u8bd1-v8\">\u7f16\u8bd1 V8<a class=\"headerlink\" href=\"#\u7f16\u8bd1-v8\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u7b80\u5355\u8fc7\u4e00\u4e0b v8 \u7684\u6e90\u7801\u83b7\u53d6\u4ee5\u53ca\u7f16\u8bd1\u6d41\u7a0b\uff0c\u4e3b\u8981\u53c2\u8003\u4e86 <a href=\"https://v8.dev/docs/source-code\">Checking out the V8 source code</a> \u548c <a href=\"https://v8.dev/docs/compile-arm64\">Compiling on Arm64 Linux</a>:</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\"># setup depot_tools</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>~\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>git<span class=\"w\"> </span>clone<span class=\"w\"> </span>https://chromium.googlesource.com/chromium/tools/depot_tools.git\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">PATH</span><span class=\"o\">=</span><span class=\"nv\">$PWD</span>/depot_tools:<span class=\"nv\">$PATH</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"c1\"># clone v8 repos</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>mkdir<span class=\"w\"> </span>~/v8\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>~/v8\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>fetch<span class=\"w\"> </span>v8\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"nb\">cd</span><span class=\"w\"> </span>v8\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"c1\"># switch to specified tag</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span><span class=\"m\">12</span>.8.374.31\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a>gclient<span class=\"w\"> </span>sync<span class=\"w\"> </span>--verbose\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"c1\"># install dependencies</span>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a>./build/install-build-deps.sh\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"c1\"># install llvm 19</span>\n</span><span id=\"__span-0-20\"><a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\" href=\"#__codelineno-0-20\"></a>wget<span class=\"w\"> </span>https://mirrors.tuna.tsinghua.edu.cn/llvm-apt/llvm.sh\n</span><span id=\"__span-0-21\"><a id=\"__codelineno-0-21\" name=\"__codelineno-0-21\" href=\"#__codelineno-0-21\"></a>chmod<span class=\"w\"> </span>+x<span class=\"w\"> </span>llvm.sh\n</span><span id=\"__span-0-22\"><a id=\"__codelineno-0-22\" name=\"__codelineno-0-22\" href=\"#__codelineno-0-22\"></a>sudo<span class=\"w\"> </span>./llvm.sh<span class=\"w\"> </span><span class=\"m\">19</span><span class=\"w\"> </span>-m<span class=\"w\"> </span>https://mirrors.tuna.tsinghua.edu.cn/llvm-apt\n</span><span id=\"__span-0-23\"><a id=\"__codelineno-0-23\" name=\"__codelineno-0-23\" href=\"#__codelineno-0-23\"></a>rm<span class=\"w\"> </span>llvm.sh\n</span><span id=\"__span-0-24\"><a id=\"__codelineno-0-24\" name=\"__codelineno-0-24\" href=\"#__codelineno-0-24\"></a>sudo<span class=\"w\"> </span>apt<span class=\"w\"> </span>install<span class=\"w\"> </span>-y<span class=\"w\"> </span>lld<span class=\"w\"> </span>clang-19\n</span><span id=\"__span-0-25\"><a id=\"__codelineno-0-25\" name=\"__codelineno-0-25\" href=\"#__codelineno-0-25\"></a>\n</span><span id=\"__span-0-26\"><a id=\"__codelineno-0-26\" name=\"__codelineno-0-26\" href=\"#__codelineno-0-26\"></a><span class=\"c1\"># fix incompatibilities with system clang 19</span>\n</span><span id=\"__span-0-27\"><a id=\"__codelineno-0-27\" name=\"__codelineno-0-27\" href=\"#__codelineno-0-27\"></a>sed<span class=\"w\"> </span>-i<span class=\"w\"> </span><span class=\"s2\">&quot;s/-Wno-missing-template-arg-list-after-template-kw//&quot;</span><span class=\"w\"> </span>build/config/compiler/BUILD.gn\n</span><span id=\"__span-0-28\"><a id=\"__codelineno-0-28\" name=\"__codelineno-0-28\" href=\"#__codelineno-0-28\"></a>\n</span><span id=\"__span-0-29\"><a id=\"__codelineno-0-29\" name=\"__codelineno-0-29\" href=\"#__codelineno-0-29\"></a><span class=\"c1\"># compile v8 using system clang 19</span>\n</span><span id=\"__span-0-30\"><a id=\"__codelineno-0-30\" name=\"__codelineno-0-30\" href=\"#__codelineno-0-30\"></a><span class=\"c1\"># for amd64: use x64.optdebug instead of arm64.optdebug</span>\n</span><span id=\"__span-0-31\"><a id=\"__codelineno-0-31\" name=\"__codelineno-0-31\" href=\"#__codelineno-0-31\"></a>tools/dev/gm.py<span class=\"w\"> </span>arm64.optdebug<span class=\"w\"> </span>--progress<span class=\"o\">=</span>verbose\n</span><span id=\"__span-0-32\"><a id=\"__codelineno-0-32\" name=\"__codelineno-0-32\" href=\"#__codelineno-0-32\"></a>\n</span><span id=\"__span-0-33\"><a id=\"__codelineno-0-33\" name=\"__codelineno-0-33\" href=\"#__codelineno-0-33\"></a><span class=\"c1\"># d8 is compiled successfully at</span>\n</span><span id=\"__span-0-34\"><a id=\"__codelineno-0-34\" name=\"__codelineno-0-34\" href=\"#__codelineno-0-34\"></a>./out/arm64.optdebug/d8\n</span></code></pre></div>\n<p>\u5982\u679c\u4e0d\u60f3\u7f16\u8bd1 V8\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7528 Node.JS \u6765\u4ee3\u66ff <code>d8</code>\u3002\u4e0d\u8fc7 Node.JS \u4f1a\u52a0\u8f7d\u5f88\u591a JS \u4ee3\u7801\uff0c\u4f7f\u5f97\u8f93\u51fa\u66f4\u52a0\u590d\u6742\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u624b\u52a8\u8fc7\u6ee4\u4e00\u4e9b\u8f93\u51fa\uff0c\u6216\u8005\u901a\u8fc7\u547d\u4ee4\u884c\u8bbe\u7f6e\u4e00\u4e9b\u6253\u5370\u65e5\u5fd7\u7684\u8fc7\u6ee4\u5668\u3002\u53e6\u5916\uff0c\u540e\u9762\u6709\u4e00\u4e9b\u6df1\u5165\u7684\u8c03\u8bd5\u4fe1\u606f\uff0c\u9700\u8981\u624b\u52a8\u7f16\u8bd1 V8 \u624d\u80fd\u6253\u5f00\uff0c\u56e0\u6b64\u8fd8\u662f\u5efa\u8bae\u8bfb\u8005\u4e0a\u624b\u81ea\u5df1\u7f16\u8bd1\u4e00\u4e2a V8\u3002</p>\n<p>\u5728 AMD64 \u4e0a\uff0c\u9ed8\u8ba4\u4f1a\u4f7f\u7528 V8 \u81ea\u5e26\u7684 LLVM \u7248\u672c\u6765\u7f16\u8bd1\uff0c\u6b64\u65f6\u5c31\u4e0d\u9700\u8981\u989d\u5916\u5b89\u88c5 LLVM 19\uff0c\u4e5f\u4e0d\u9700\u8981\u4fee\u6539 <code>v8/build/config/compiler/BUILD.gn</code>\u3002</p>\n<h2 id=\"\u89e3\u91ca\u5668\u548c\u7f16\u8bd1\u5668\">\u89e3\u91ca\u5668\u548c\u7f16\u8bd1\u5668<a class=\"headerlink\" href=\"#\u89e3\u91ca\u5668\u548c\u7f16\u8bd1\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>\u901a\u8fc7 V8 \u7684\u6587\u6863\u53ef\u4ee5\u770b\u5230\uff0cV8 \u4e00\u5171\u6709\u8fd9\u4e9b\u89e3\u91ca\u5668\u6216\u7f16\u8bd1\u5668\uff0c\u6309\u7167\u5176\u4f18\u5316\u7b49\u7ea7\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\uff1a</p>\n<ol>\n<li><a href=\"https://v8.dev/docs/ignition\">Ignition</a>: \u89e3\u91ca\u5668</li>\n<li><a href=\"https://v8.dev/blog/sparkplug\">SparkPlug</a>: \u4e0d\u4f18\u5316\u7684\u5feb\u901f\u7f16\u8bd1\u5668\uff0c\u8ffd\u6c42\u5feb\u7684\u7f16\u8bd1\u901f\u5ea6</li>\n<li><a href=\"https://v8.dev/blog/maglev\">Maglev</a>\uff1a\u505a\u4f18\u5316\u7684\u7f16\u8bd1\u5668\uff0c\u5bfb\u6c42\u7f16\u8bd1\u901f\u5ea6\u548c\u7f16\u8bd1\u8d28\u91cf\u7684\u5e73\u8861</li>\n<li><a href=\"https://v8.dev/docs/turbofan\">TurboFan</a>\uff1a\u505a\u4f18\u5316\u7684\u7f16\u8bd1\u5668\uff0c\u5bfb\u6c42\u66f4\u597d\u7684\u7f16\u8bd1\u8d28\u91cf</li>\n</ol>\n<p>\u5728 JS \u7684\u4f7f\u7528\u573a\u666f\uff0c\u4e0d\u540c\u4ee3\u7801\u88ab\u8c03\u7528\u7684\u6b21\u6570\u4ee5\u53ca\u5bf9\u53ca\u65f6\u6027\u7684\u9700\u6c42\u5dee\u522b\u5f88\u5927\uff0c\u4e3a\u4e86\u9002\u5e94\u4e0d\u540c\u7684\u573a\u666f\uff0cV8 \u8bbe\u8ba1\u4e86\u8fd9\u4e9b\u89e3\u91ca\u5668\u548c\u7f16\u8bd1\u5668\u6765\u63d0\u5347\u6574\u4f53\u7684\u6027\u80fd\uff1a\u6267\u884c\u6b21\u6570\u5c11\u7684\u4ee3\u7801\uff0c\u503e\u5411\u4e8e\u7528\u66f4\u4f4e\u4f18\u5316\u7b49\u7ea7\u7684\u89e3\u91ca\u5668\u6216\u7f16\u8bd1\u5668\uff0c\u8ffd\u6c42\u66f4\u4f4e\u7684\u4f18\u5316\u5f00\u9500\uff1b\u6267\u884c\u6b21\u6570\u591a\u7684\u4ee3\u7801\uff0c\u5f53\u7f16\u8bd1\u4f18\u5316\u65f6\u95f4\u4e0d\u518d\u6210\u4e3a\u74f6\u9888\uff0c\u5219\u503e\u5411\u4e8e\u7528\u66f4\u9ad8\u4f18\u5316\u7b49\u7ea7\u7684\u7f16\u8bd1\u5668\uff0c\u8ffd\u6c42\u66f4\u9ad8\u7684\u6267\u884c\u6027\u80fd\u3002</p>\n<h2 id=\"ignition-\u89e3\u91ca\u5668\">Ignition \u89e3\u91ca\u5668<a class=\"headerlink\" href=\"#ignition-\u89e3\u91ca\u5668\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u5206\u6790\u6837\u4f8b-js-\u4ee3\u7801\">\u5206\u6790\u6837\u4f8b JS \u4ee3\u7801<a class=\"headerlink\" href=\"#\u5206\u6790\u6837\u4f8b-js-\u4ee3\u7801\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u6765\u89c2\u5bdf\u4e00\u4e0b Ignition \u89e3\u91ca\u5668\u7684\u5de5\u4f5c\u6d41\u7a0b\u3002\u5199\u4e00\u6bb5\u7b80\u5355\u7684 JS \u4ee3\u7801\uff1a</p>\n<div class=\"language-js highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"kd\">function</span><span class=\"w\"> </span><span class=\"nx\">add</span><span class=\"p\">(</span><span class=\"nx\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nx\">a</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nx\">b</span><span class=\"p\">;</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"p\">}</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"nx\">add</span><span class=\"p\">(</span><span class=\"mf\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">2</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u4fdd\u5b58\u4e3a <code>test.js</code>\uff0c\u8fd0\u884c <code>./out/arm64.optdebug/d8 --print-ast --print-bytecode test.js</code> \u4ee5\u6253\u5370\u5b83\u7684 AST \u4ee5\u53ca Bytecode:</p>\n<p>\u9996\u5148\u5f00\u59cb\u7684\u662f top level \u7684 AST \u4ee5\u53ca Bytecode\uff0c\u5b83\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff1a\u58f0\u660e\u4e00\u4e2a\u51fd\u6570 add\uff0c\u7136\u540e\u4ee5\u53c2\u6570 <code>(1, 2)</code> \u6765\u8c03\u7528\u5b83\u3002</p>\n<p>top level AST:</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>[generating bytecode for function: ]\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>--- AST ---\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>FUNC at 0\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>. KIND 0\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a>. LITERAL ID 0\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a>. SUSPEND COUNT 0\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a>. NAME &quot;&quot;\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a>. INFERRED NAME &quot;&quot;\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a>. DECLS\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a>. . FUNCTION &quot;add&quot; = function add\n</span><span id=\"__span-2-11\"><a id=\"__codelineno-2-11\" name=\"__codelineno-2-11\" href=\"#__codelineno-2-11\"></a>. EXPRESSION STATEMENT at 42\n</span><span id=\"__span-2-12\"><a id=\"__codelineno-2-12\" name=\"__codelineno-2-12\" href=\"#__codelineno-2-12\"></a>. . kAssign at -1\n</span><span id=\"__span-2-13\"><a id=\"__codelineno-2-13\" name=\"__codelineno-2-13\" href=\"#__codelineno-2-13\"></a>. . . VAR PROXY local[0] (0xc28698556308) (mode = TEMPORARY, assigned = true) &quot;.result&quot;\n</span><span id=\"__span-2-14\"><a id=\"__codelineno-2-14\" name=\"__codelineno-2-14\" href=\"#__codelineno-2-14\"></a>. . . CALL\n</span><span id=\"__span-2-15\"><a id=\"__codelineno-2-15\" name=\"__codelineno-2-15\" href=\"#__codelineno-2-15\"></a>. . . . VAR PROXY unallocated (0xc28698556200) (mode = VAR, assigned = true) &quot;add&quot;\n</span><span id=\"__span-2-16\"><a id=\"__codelineno-2-16\" name=\"__codelineno-2-16\" href=\"#__codelineno-2-16\"></a>. . . . LITERAL 1\n</span><span id=\"__span-2-17\"><a id=\"__codelineno-2-17\" name=\"__codelineno-2-17\" href=\"#__codelineno-2-17\"></a>. . . . LITERAL 2\n</span><span id=\"__span-2-18\"><a id=\"__codelineno-2-18\" name=\"__codelineno-2-18\" href=\"#__codelineno-2-18\"></a>. RETURN at -1\n</span><span id=\"__span-2-19\"><a id=\"__codelineno-2-19\" name=\"__codelineno-2-19\" href=\"#__codelineno-2-19\"></a>. . VAR PROXY local[0] (0xc28698556308) (mode = TEMPORARY, assigned = true) &quot;.result&quot;\n</span></code></pre></div>\n<p>\u9996\u5148\u58f0\u660e\u4e86\u4e00\u4e2a <code>add</code> \u51fd\u6570\uff0c\u7136\u540e\u4ee5 <code>1</code> \u548c <code>2</code> \u4e24\u4e2a\u53c2\u6570\u8c03\u7528 <code>add</code> \u51fd\u6570\uff0c\u628a\u7ed3\u679c\u7ed1\u5b9a\u7ed9\u5c40\u90e8\u53d8\u91cf <code>.result</code>\uff0c\u6700\u540e\u4ee5 <code>.result</code> \u4e3a\u7ed3\u679c\u8fd4\u56de\u3002\u63a5\u4e0b\u6765\u770b\u5b83\u4f1a\u88ab\u7ffb\u8bd1\u6210\u4ec0\u4e48\u5b57\u8282\u7801\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a>[generated bytecode for function:  (0x1f8e002988f5 &lt;SharedFunctionInfo&gt;)]\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a>Bytecode length: 28\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a>Parameter count 1\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a>Register count 4\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a>Frame size 32\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a>         0x304700040048 @    0 : 13 00             LdaConstant [0]\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a>         0x30470004004a @    2 : c9                Star1\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a>         0x30470004004b @    3 : 19 fe f7          Mov &lt;closure&gt;, r2\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a>         0x30470004004e @    6 : 68 63 01 f8 02    CallRuntime [DeclareGlobals], r1-r2\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a>         0x304700040053 @   11 : 21 01 00          LdaGlobal [1], [0]\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a>         0x304700040056 @   14 : c9                Star1\n</span><span id=\"__span-3-12\"><a id=\"__codelineno-3-12\" name=\"__codelineno-3-12\" href=\"#__codelineno-3-12\"></a>         0x304700040057 @   15 : 0d 01             LdaSmi [1]\n</span><span id=\"__span-3-13\"><a id=\"__codelineno-3-13\" name=\"__codelineno-3-13\" href=\"#__codelineno-3-13\"></a>         0x304700040059 @   17 : c8                Star2\n</span><span id=\"__span-3-14\"><a id=\"__codelineno-3-14\" name=\"__codelineno-3-14\" href=\"#__codelineno-3-14\"></a>         0x30470004005a @   18 : 0d 02             LdaSmi [2]\n</span><span id=\"__span-3-15\"><a id=\"__codelineno-3-15\" name=\"__codelineno-3-15\" href=\"#__codelineno-3-15\"></a>         0x30470004005c @   20 : c7                Star3\n</span><span id=\"__span-3-16\"><a id=\"__codelineno-3-16\" name=\"__codelineno-3-16\" href=\"#__codelineno-3-16\"></a>         0x30470004005d @   21 : 66 f8 f7 f6 02    CallUndefinedReceiver2 r1, r2, r3, [2]\n</span><span id=\"__span-3-17\"><a id=\"__codelineno-3-17\" name=\"__codelineno-3-17\" href=\"#__codelineno-3-17\"></a>         0x304700040062 @   26 : ca                Star0\n</span><span id=\"__span-3-18\"><a id=\"__codelineno-3-18\" name=\"__codelineno-3-18\" href=\"#__codelineno-3-18\"></a>         0x304700040063 @   27 : af                Return\n</span><span id=\"__span-3-19\"><a id=\"__codelineno-3-19\" name=\"__codelineno-3-19\" href=\"#__codelineno-3-19\"></a>Constant pool (size = 2)\n</span><span id=\"__span-3-20\"><a id=\"__codelineno-3-20\" name=\"__codelineno-3-20\" href=\"#__codelineno-3-20\"></a>0x304700040011: [TrustedFixedArray]\n</span><span id=\"__span-3-21\"><a id=\"__codelineno-3-21\" name=\"__codelineno-3-21\" href=\"#__codelineno-3-21\"></a> - map: 0x1f8e00000595 &lt;Map(TRUSTED_FIXED_ARRAY_TYPE)&gt;\n</span><span id=\"__span-3-22\"><a id=\"__codelineno-3-22\" name=\"__codelineno-3-22\" href=\"#__codelineno-3-22\"></a> - length: 2\n</span><span id=\"__span-3-23\"><a id=\"__codelineno-3-23\" name=\"__codelineno-3-23\" href=\"#__codelineno-3-23\"></a>           0: 0x1f8e00298945 &lt;FixedArray[2]&gt;\n</span><span id=\"__span-3-24\"><a id=\"__codelineno-3-24\" name=\"__codelineno-3-24\" href=\"#__codelineno-3-24\"></a>           1: 0x1f8e000041dd &lt;String[3]: #add&gt;\n</span><span id=\"__span-3-25\"><a id=\"__codelineno-3-25\" name=\"__codelineno-3-25\" href=\"#__codelineno-3-25\"></a>Handler Table (size = 0)\n</span><span id=\"__span-3-26\"><a id=\"__codelineno-3-26\" name=\"__codelineno-3-26\" href=\"#__codelineno-3-26\"></a>Source Position Table (size = 0)\n</span></code></pre></div>\n<p>V8 \u7684\u5b57\u8282\u7801\u91c7\u7528\u7684\u662f\u57fa\u4e8e\u5bc4\u5b58\u5668\u7684\u6267\u884c\u6a21\u578b\uff0c\u800c\u975e\u5176\u4ed6\u5f88\u591a\u5b57\u8282\u7801\u4f1a\u91c7\u7528\u7684\u6808\u5f0f\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u6bcf\u4e2a\u51fd\u6570\u6709\u81ea\u5df1\u7684\u82e5\u5e72\u4e2a\u5bc4\u5b58\u5668\u53ef\u4f9b\u64cd\u4f5c\u3002\u6bcf\u6761\u5b57\u8282\u7801\u5206\u4e3a Opcode\uff08\u8868\u793a\u8fd9\u6761\u5b57\u8282\u7801\u8981\u8fdb\u884c\u7684\u64cd\u4f5c\uff09\u548c\u64cd\u4f5c\u6570\u4e24\u90e8\u5206\u3002\u51fd\u6570\u5f00\u5934\u7684 <code>Register count 4</code> \u8868\u660e\u8be5\u51fd\u6570\u6709\u56db\u4e2a\u5bc4\u5b58\u5668\uff1a<code>r0-r3</code>\uff0c\u6b64\u5916\u8fd8\u6709\u4e00\u4e2a\u7279\u6b8a\u7684 <code>accumulator</code> \u5bc4\u5b58\u5668\uff0c\u5b83\u4e00\u822c\u4e0d\u4f1a\u51fa\u73b0\u5728\u64cd\u4f5c\u6570\u5217\u8868\u4e2d\uff0c\u800c\u662f\u9690\u542b\u5728 Opcode \u5185\uff08<code>Lda/Sta</code>\uff09\u3002</p>\n<p>\u5b8c\u6574\u7684 Opcode \u5217\u8868\u53ef\u4ee5\u5728 <code>v8/src/interpreter/bytecodes.h</code> \u4e2d\u627e\u5230\uff0c\u5bf9\u5e94\u7684\u5b9e\u73b0\u53ef\u4ee5\u5728 <code>v8/src/interpreter/interpreter-generator.cc</code> \u4e2d\u627e\u5230\u3002</p>\n<p>\u4e0a\u8ff0\u5b57\u8282\u7801\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u7b2c\u4e00\u90e8\u5206\u662f\u58f0\u660e <code>add</code> \u51fd\u6570\uff1a</p>\n<ol>\n<li><code>LdaConstant [0]</code>: \u628a Constant Pool \u7684\u7b2c 0 \u9879\u4e5f\u5c31\u662f <code>FixedArray[2]</code> \u5199\u5165 <code>accumulator</code> \u5bc4\u5b58\u5668\u5f53\u4e2d</li>\n<li><code>Star1</code>: \u628a <code>accumulator</code> \u5bc4\u5b58\u5668\u7684\u503c\u62f7\u8d1d\u5230 <code>r1</code> \u5bc4\u5b58\u5668\uff0c\u7ed3\u5408\u4e0a\u4e00\u6761\u5b57\u8282\u7801\uff0c\u5c31\u662f\u8bbe\u7f6e <code>r1 = FixedArray[2]</code></li>\n<li><code>Mov &lt;closure&gt;, r2</code>: \u628a <code>&lt;closure&gt;</code> \u62f7\u8d1d\u5230 <code>r2</code> \u5bc4\u5b58\u5668\uff0c\u731c\u6d4b\u8fd9\u91cc\u7684 <code>&lt;closure&gt;</code> \u5bf9\u5e94\u7684\u662f <code>add</code> \u51fd\u6570</li>\n<li><code>CallRuntime [DeclareGlobals], r1-r2</code>: \u8c03\u7528\u8fd0\u884c\u65f6\u7684 <code>DeclareGlobals</code> \u51fd\u6570\uff0c\u5e76\u4f20\u9012\u4e24\u4e2a\u53c2\u6570\uff0c\u5206\u522b\u662f <code>r1</code> \u548c <code>r2</code>\uff1b\u6709\u610f\u601d\u7684\u662f\uff0c<code>CallRuntime</code> \u7684\u53c2\u6570\u5fc5\u987b\u4fdd\u5b58\u5728\u8fde\u7eed\u7684\u5bc4\u5b58\u5668\u5f53\u4e2d\uff0c\u731c\u6d4b\u662f\u4e3a\u4e86\u8282\u7701\u7f16\u7801\u7a7a\u95f4</li>\n</ol>\n<p>\u81f3\u6b64\uff0c<code>add</code> \u51fd\u6570\u5c31\u58f0\u660e\u5b8c\u6210\u4e86\u3002\u63a5\u4e0b\u6765\uff0c\u5c31\u8981\u5b9e\u73b0 <code>add(1, 2)</code> \u7684\u8c03\u7528\uff1a</p>\n<ol>\n<li><code>LdaGlobal [1], [0]</code>: \u628a Constant Pool \u7684\u7b2c 1 \u9879\u4e5f\u5c31\u662f <code>\"add\"</code> \u8fd9\u4e2a\u5b57\u7b26\u4e32\u5199\u5165 <code>accumulator</code>\uff0c\u6700\u540e\u7684 <code>[0]</code> \u548c FeedBackVector \u6709\u5173\uff0c\u76ee\u524d\u5148\u5ffd\u7565</li>\n<li><code>Star1</code>:  \u628a <code>accumulator</code> \u5bc4\u5b58\u5668\u7684\u503c\u62f7\u8d1d\u5230 <code>r1</code> \u5bc4\u5b58\u5668\uff0c\u7ed3\u5408\u4e0a\u4e00\u6761\u5b57\u8282\u7801\uff0c\u5c31\u662f\u8bbe\u7f6e <code>r1 = \"add\"</code></li>\n<li><code>LdaSmi [1]</code>: \u628a\u5c0f\u6574\u6570\uff08Small integer, Smi\uff09<code>1</code> \u5199\u5165 <code>accumulator</code></li>\n<li><code>Star2</code>:  \u628a <code>accumulator</code> \u5bc4\u5b58\u5668\u7684\u503c\u62f7\u8d1d\u5230 <code>r2</code> \u5bc4\u5b58\u5668\uff0c\u7ed3\u5408\u4e0a\u4e00\u6761\u5b57\u8282\u7801\uff0c\u5c31\u662f\u8bbe\u7f6e <code>r2 = 1</code></li>\n<li><code>LdaSmi [2]</code>: \u628a\u5c0f\u6574\u6570\uff08Small integer, Smi\uff09<code>2</code> \u5199\u5165 <code>accumulator</code></li>\n<li><code>Star3</code>:  \u628a <code>accumulator</code> \u5bc4\u5b58\u5668\u7684\u503c\u62f7\u8d1d\u5230 <code>r3</code> \u5bc4\u5b58\u5668\uff0c\u7ed3\u5408\u4e0a\u4e00\u6761\u5b57\u8282\u7801\uff0c\u5c31\u662f\u8bbe\u7f6e <code>r3 = 2</code></li>\n<li><code>CallUndefinedReceiver2 r1, r2, r3, [2]</code>: \u6839\u636e <code>r1</code> \u8c03\u7528\u4e00\u4e2a\u51fd\u6570\uff0c\u5e76\u4f20\u9012\u4e24\u4e2a\u53c2\u6570 <code>r2, r3</code>\uff08\u51fd\u6570\u540d\u79f0\u6700\u540e\u7684 <code>2</code> \u8868\u793a\u6709\u4e24\u4e2a\u53c2\u6570\uff09\uff0c\u6700\u540e\u7684 <code>[2]</code> \u4e5f\u548c FeedBackVector \u6709\u5173</li>\n</ol>\n<p>\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u51fd\u6570\u8c03\u7528\u3002</p>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf <code>add</code> \u51fd\u6570\u7684 AST\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>[generating bytecode for function: add]\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a>--- AST ---\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a>FUNC at 12\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a>. KIND 0\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a>. LITERAL ID 1\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a>. SUSPEND COUNT 0\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a>. NAME &quot;add&quot;\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a>. INFERRED NAME &quot;&quot;\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a>. PARAMS\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a>. . VAR (0xc50512445280) (mode = VAR, assigned = false) &quot;a&quot;\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a>. . VAR (0xc50512445300) (mode = VAR, assigned = false) &quot;b&quot;\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a>. DECLS\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a>. . VARIABLE (0xc50512445280) (mode = VAR, assigned = false) &quot;a&quot;\n</span><span id=\"__span-4-14\"><a id=\"__codelineno-4-14\" name=\"__codelineno-4-14\" href=\"#__codelineno-4-14\"></a>. . VARIABLE (0xc50512445300) (mode = VAR, assigned = false) &quot;b&quot;\n</span><span id=\"__span-4-15\"><a id=\"__codelineno-4-15\" name=\"__codelineno-4-15\" href=\"#__codelineno-4-15\"></a>. RETURN at 25\n</span><span id=\"__span-4-16\"><a id=\"__codelineno-4-16\" name=\"__codelineno-4-16\" href=\"#__codelineno-4-16\"></a>. . kAdd at 34\n</span><span id=\"__span-4-17\"><a id=\"__codelineno-4-17\" name=\"__codelineno-4-17\" href=\"#__codelineno-4-17\"></a>. . . VAR PROXY parameter[0] (0xc50512445280) (mode = VAR, assigned = false) &quot;a&quot;\n</span><span id=\"__span-4-18\"><a id=\"__codelineno-4-18\" name=\"__codelineno-4-18\" href=\"#__codelineno-4-18\"></a>. . . VAR PROXY parameter[1] (0xc50512445300) (mode = VAR, assigned = false) &quot;b&quot;\n</span></code></pre></div>\n<p><code>add</code> \u51fd\u6570\u7684 AST \u6bd4\u8f83\u76f4\u63a5\uff0c<code>a + b</code> \u76f4\u63a5\u5bf9\u5e94\u4e86 <code>kAdd</code> \u7ed3\u70b9\uff0c\u76f4\u63a5\u4f5c\u4e3a\u8fd4\u56de\u503c\u3002</p>\n<p>\u63a5\u4e0b\u6765\u89c2\u5bdf <code>add</code> \u7684 Bytecode\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a>[generated bytecode for function: add (0x10c700298955 &lt;SharedFunctionInfo add&gt;)]\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a>Bytecode length: 6\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a>Parameter count 3\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a>Register count 0\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a>Frame size 0\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>         0x6ed0004008c @    0 : 0b 04             Ldar a1\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>         0x6ed0004008e @    2 : 3b 03 00          Add a0, [0]\n</span><span id=\"__span-5-8\"><a id=\"__codelineno-5-8\" name=\"__codelineno-5-8\" href=\"#__codelineno-5-8\"></a>         0x6ed00040091 @    5 : af                Return\n</span><span id=\"__span-5-9\"><a id=\"__codelineno-5-9\" name=\"__codelineno-5-9\" href=\"#__codelineno-5-9\"></a>Constant pool (size = 0)\n</span><span id=\"__span-5-10\"><a id=\"__codelineno-5-10\" name=\"__codelineno-5-10\" href=\"#__codelineno-5-10\"></a>Handler Table (size = 0)\n</span><span id=\"__span-5-11\"><a id=\"__codelineno-5-11\" name=\"__codelineno-5-11\" href=\"#__codelineno-5-11\"></a>Source Position Table (size = 0)\n</span></code></pre></div>\n<ol>\n<li><code>Ldar a1</code>: \u628a\u7b2c\u4e8c\u4e2a\u53c2\u6570 <code>a1</code> \u4e5f\u5c31\u662f <code>b</code> \u5199\u5165 <code>accumulator</code> \u5bc4\u5b58\u5668</li>\n<li><code>Add a0, [0]</code>: \u6c42\u7b2c\u4e00\u4e2a\u53c2\u6570 <code>a0</code> \u4e5f\u5c31\u662f <code>a</code> \u4e0e <code>accumulator</code> \u5bc4\u5b58\u5668\u7684\u548c\uff0c\u5199\u5165\u5230 <code>accumulator</code> \u5bc4\u5b58\u5668\u5f53\u4e2d\uff0c\u7ed3\u5408\u4e0a\u4e00\u6761 Bytecode\uff0c\u5c31\u662f <code>accumulator = a0 + a1</code>\uff1b<code>[0]</code> \u548c FeedBackVector \u6709\u5173</li>\n<li><code>Return</code>: \u628a <code>accumulator</code> \u4e2d\u7684\u503c\u4f5c\u4e3a\u8fd4\u56de\u503c\uff0c\u7ed3\u675f\u51fd\u6570\u8c03\u7528</li>\n</ol>\n<p>\u7b80\u5355\u5c0f\u7ed3\u4e00\u4e0b V8 \u7684\u5b57\u8282\u7801\uff1a</p>\n<ol>\n<li>\u6709\u82e5\u5e72\u4e2a\u5c40\u90e8\u7684\u5bc4\u5b58\u5668\uff0c\u5728\u64cd\u4f5c\u6570\u4e2d\u4ee5 <code>rn</code> \u7684\u5f62\u5f0f\u51fa\u73b0\uff0c<code>n</code> \u662f\u5bc4\u5b58\u5668\u7f16\u53f7</li>\n<li>\u6709 <code>accumulator</code> \u5c40\u90e8\u5bc4\u5b58\u5668\uff0c\u4f5c\u4e3a\u90e8\u5206\u5b57\u8282\u7801\u7684\u9690\u542b\u8f93\u5165\u6216\u8f93\u51fa\uff08<code>Add</code>\uff09</li>\n<li>\u6709\u82e5\u5e72\u4e2a\u53c2\u6570\uff0c\u5728\u64cd\u4f5c\u6570\u4e2d\u4ee5 <code>an</code> \u7684\u5f62\u5f0f\u51fa\u73b0\uff0c<code>n</code> \u662f\u53c2\u6570\u7f16\u53f7</li>\n<li>\u64cd\u4f5c\u6570\u8fd8\u53ef\u4ee5\u51fa\u73b0\u7acb\u5373\u6570\u53c2\u6570 <code>[imm]</code>\uff0c\u53ef\u80fd\u662f\u6574\u6570\u5b57\u9762\u91cf\uff08<code>LdaSmi</code>\uff09\uff0c\u53ef\u80fd\u662f\u4e0b\u6807\uff08<code>LdaConstant</code>\uff09\uff0c\u4e5f\u53ef\u80fd\u662f FeedBackVector \u7684 slot</li>\n</ol>\n<p>\u6709\u4e86\u5b57\u8282\u7801\u4ee5\u540e\uff0c\u63a5\u4e0b\u6765\u89c2\u5bdf Ignition \u5177\u4f53\u662f\u600e\u4e48\u89e3\u91ca\u6267\u884c\u8fd9\u4e9b\u5b57\u8282\u7801\u7684\u3002</p>\n<h3 id=\"\u89e3\u91ca\u6267\u884c\">\u89e3\u91ca\u6267\u884c<a class=\"headerlink\" href=\"#\u89e3\u91ca\u6267\u884c\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u5b9e\u9645\u6267\u884c\u8fd9\u4e9b\u5b57\u8282\u7801\uff0cIgnition \u7684\u505a\u6cd5\u662f\uff1a</p>\n<ol>\n<li>\u7ed9\u6bcf\u79cd\u53ef\u80fd\u7684 Opcode \u751f\u6210\u4e00\u6bb5\u4e8c\u8fdb\u5236\u4ee3\u7801\uff0c\u8fd9\u6bb5\u4ee3\u7801\u4f1a\u5b9e\u73b0\u8fd9\u4e2a Opcode \u7684\u529f\u80fd</li>\n<li>\u5728\u8fd0\u884c\u65f6\u7ef4\u62a4\u4e00\u4e2a dispatch table\uff0c\u7ef4\u62a4\u4e86 Opcode \u5230\u4e8c\u8fdb\u5236\u4ee3\u7801\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb</li>\n<li>\u5728\u6bcf\u6bb5\u4ee3\u7801\u7684\u7ed3\u5c3e\uff0c\u627e\u5230\u4e0b\u4e00\u4e2a Opcode \u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\uff0c\u7136\u540e\u8df3\u8f6c\u8fc7\u53bb</li>\n<li>\u8c03\u7528\u51fd\u6570\u65f6\uff0c\u5148\u505a\u4e00\u7cfb\u5217\u7684\u51c6\u5907\uff0c\u627e\u5230\u51fd\u6570\u7b2c\u4e00\u4e2a\u5b57\u8282\u7801\u7684 Opcode \u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\uff0c\u8df3\u8f6c\u8fc7\u53bb</li>\n</ol>\n<p>\u7531\u4e8e Opcode \u7684\u79cd\u7c7b\u662f\u56fa\u5b9a\u7684\uff0c\u6240\u4ee5\u5b9e\u9645\u8fd0\u884c V8 \u7684\u65f6\u5019\uff0c\u8fd9\u4e9b\u4ee3\u7801\u5df2\u7ecf\u7f16\u8bd1\u597d\u4e86\uff0c\u53ea\u9700\u8981\u5728\u8fd0\u884c\u65f6\u521d\u59cb\u5316\u5bf9\u5e94\u7684\u6570\u636e\u7ed3\u6784\u5373\u53ef\u3002\u8fd9\u4e2a\u4ee3\u7801\u7684\u751f\u6210\u548c\u7f16\u8bd1\u8fc7\u7a0b\uff0c\u4e5f\u4e0d\u662f\u7531 C++ \u7f16\u8bd1\u5668\u505a\u7684\uff0c\u800c\u662f\u6709\u4e00\u4e2a <code>mksnapshot</code> \u547d\u4ee4\u6765\u5b8c\u6210\u521d\u59cb\u5316\uff0c\u4f60\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u628a\u8fd9\u4e9b Opcode \u5bf9\u5e94\u7684\u6c47\u7f16\u6307\u4ee4\u90fd\u9884\u5148\u751f\u6210\u597d\uff0c\u8fd0\u884c\u65f6\u76f4\u63a5\u52a0\u8f7d\u5373\u53ef\u3002</p>\n<p>\u9996\u5148\u6765\u770b Ignition \u7684\u600e\u4e48\u5b9e\u73b0\u5404\u79cd Opcode \u7684\uff0c\u4ee5 <code>LdaSmi</code> \u4e3a\u4f8b\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u5c0f\u7684\u628a\u7acb\u5373\u6570\uff08Smi=Small integer\uff09\u5199\u5165\u5230 <code>accumulator</code> \u5f53\u4e2d\uff0c\u8fd9\u6bb5\u5728 <code>v8/src/interpreter/interpreter-generator.cc</code> \u7684\u4ee3\u7801\u5b9e\u73b0\u4e86\u8fd9\u4e2a\u903b\u8f91\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"c1\">// LdaSmi &lt;imm&gt;</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a><span class=\"c1\">//</span>\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"c1\">// Load an integer literal into the accumulator as a Smi.</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a><span class=\"n\">IGNITION_HANDLER</span><span class=\"p\">(</span><span class=\"n\">LdaSmi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">InterpreterAssembler</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"w\">  </span><span class=\"n\">TNode</span><span class=\"o\">&lt;</span><span class=\"n\">Smi</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">smi_int</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">BytecodeOperandImmSmi</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a><span class=\"w\">  </span><span class=\"n\">SetAccumulator</span><span class=\"p\">(</span><span class=\"n\">smi_int</span><span class=\"p\">);</span>\n</span><span id=\"__span-6-7\"><a id=\"__codelineno-6-7\" name=\"__codelineno-6-7\" href=\"#__codelineno-6-7\"></a><span class=\"w\">  </span><span class=\"n\">Dispatch</span><span class=\"p\">();</span>\n</span><span id=\"__span-6-8\"><a id=\"__codelineno-6-8\" name=\"__codelineno-6-8\" href=\"#__codelineno-6-8\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u903b\u8f91\u5e76\u4e0d\u590d\u6742\uff0c\u5c31\u662f\u53d6\u4e86\u7b2c\u4e00\u4e2a\u7acb\u5373\u6570\u64cd\u4f5c\u6570\uff0c\u8bbe\u7f6e\u5230\u4e86 <code>accumulator</code>\uff0c\u6700\u540e\u8c03\u7528 <code>Dispatch</code>\uff0c\u4e5f\u5c31\u662f\u8bfb\u53d6\u4e0b\u4e00\u4e2a Opcode \u5bf9\u5e94\u7684\u6c47\u7f16\u6307\u4ee4\u7136\u540e\u8df3\u8f6c\u3002\u63a5\u4e0b\u6765\u770b\u8fd9\u51e0\u4e2a\u6b65\u9aa4\u5728\u6c47\u7f16\u4e0a\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u3002</p>\n<p>\u4e3a\u4e86\u67e5\u770b Ignition \u5bf9\u5404\u79cd Opcode \u5177\u4f53\u751f\u6210\u4e86\u4ec0\u4e48\u6837\u7684\u6c47\u7f16\u6307\u4ee4\uff0c\u53ef\u4ee5\u7528 <code>./out/arm64.optdebug/mksnapshot --trace-ignition-codegen --code-comments</code> \u547d\u4ee4\u67e5\u770b\uff0c\u4e0b\u9762\u5217\u51fa\u4e86 <code>LdaSmi</code> \u8fd9\u4e2a Opcode \u5bf9\u5e94\u7684\u6c47\u7f16\uff0c\u7531\u4e8e\u8fd9\u6bb5\u6c47\u7f16\u6709\u70b9\u957f\uff0c\u5177\u4f53\u505a\u7684\u4e8b\u60c5\u548c\u5bf9\u5e94\u7684\u6e90\u7801\u5df2\u7ecf\u901a\u8fc7\u6ce8\u91ca\u6807\u6ce8\u51fa\u6765\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a>kind = BYTECODE_HANDLER\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a>name = LdaSmi\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a>compiler = turbofan\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a>address = 0x31a000906fd\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a>Instructions (size = 324)\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a># \u5728\u4ee3\u7801\u7684\u5f00\u5934\uff0c\u68c0\u67e5\u5bc4\u5b58\u5668\u662f\u5426\u6b63\u786e\uff0c\u5373 x2 \u662f\u5426\u4fdd\u5b58\u4e86\u5f53\u524d\u4ee3\u7801\u6bb5\u7684\u5f00\u59cb\u5730\u5740\uff0c\u5bf9\u5e94\u7684\u6e90\u7801\uff1a\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a># v8/src/compiler/backend/arm64/code-generator-arm64.cc CodeGenerator::AssembleCodeStartRegisterCheck():\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a>#   UseScratchRegisterScope temps(masm());\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a>#   Register scratch = temps.AcquireX();\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a>#   __ ComputeCodeStartAddress(scratch); // becomes x16 in the following code\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a>#   __ cmp(scratch, kJavaScriptCallCodeStartRegister);\n</span><span id=\"__span-7-14\"><a id=\"__codelineno-7-14\" name=\"__codelineno-7-14\" href=\"#__codelineno-7-14\"></a>#   __ Assert(eq, AbortReason::kWrongFunctionCodeStart);\n</span><span id=\"__span-7-15\"><a id=\"__codelineno-7-15\" name=\"__codelineno-7-15\" href=\"#__codelineno-7-15\"></a># \u5176\u4e2d kJavaScriptCallCodeStartRegister \u5b9a\u4e49\u5728 v8/src/codegen/arm64/register-arm64.h\uff1a\n</span><span id=\"__span-7-16\"><a id=\"__codelineno-7-16\" name=\"__codelineno-7-16\" href=\"#__codelineno-7-16\"></a># constexpr Register kJavaScriptCallCodeStartRegister = x2;\n</span><span id=\"__span-7-17\"><a id=\"__codelineno-7-17\" name=\"__codelineno-7-17\" href=\"#__codelineno-7-17\"></a>\n</span><span id=\"__span-7-18\"><a id=\"__codelineno-7-18\" name=\"__codelineno-7-18\" href=\"#__codelineno-7-18\"></a>                  [ Frame: MANUAL\n</span><span id=\"__span-7-19\"><a id=\"__codelineno-7-19\" name=\"__codelineno-7-19\" href=\"#__codelineno-7-19\"></a>                  -- Prologue: check code start register -- - AssembleCode@../../src/compiler/backend/code-generator.cc:232\n</span><span id=\"__span-7-20\"><a id=\"__codelineno-7-20\" name=\"__codelineno-7-20\" href=\"#__codelineno-7-20\"></a>0xc6ccfe4a8b00     0  10000010       adr x16, #+0x0 (addr 0xc6ccfe4a8b00)\n</span><span id=\"__span-7-21\"><a id=\"__codelineno-7-21\" name=\"__codelineno-7-21\" href=\"#__codelineno-7-21\"></a>0xc6ccfe4a8b04     4  eb02021f       cmp x16, x2\n</span><span id=\"__span-7-22\"><a id=\"__codelineno-7-22\" name=\"__codelineno-7-22\" href=\"#__codelineno-7-22\"></a>0xc6ccfe4a8b08     8  54000080       b.eq #+0x10 (addr 0xc6ccfe4a8b18)\n</span><span id=\"__span-7-23\"><a id=\"__codelineno-7-23\" name=\"__codelineno-7-23\" href=\"#__codelineno-7-23\"></a>                    [  - Abort@../../src/codegen/arm64/macro-assembler-arm64.cc:4008\n</span><span id=\"__span-7-24\"><a id=\"__codelineno-7-24\" name=\"__codelineno-7-24\" href=\"#__codelineno-7-24\"></a>                  Abort message:  - Abort@../../src/codegen/arm64/macro-assembler-arm64.cc:4010\n</span><span id=\"__span-7-25\"><a id=\"__codelineno-7-25\" name=\"__codelineno-7-25\" href=\"#__codelineno-7-25\"></a>                  Wrong value in code start register passed - Abort@../../src/codegen/arm64/macro-assembler-arm64.cc:4011\n</span><span id=\"__span-7-26\"><a id=\"__codelineno-7-26\" name=\"__codelineno-7-26\" href=\"#__codelineno-7-26\"></a>0xc6ccfe4a8b0c     c  d2801081       movz x1, #0x84\n</span><span id=\"__span-7-27\"><a id=\"__codelineno-7-27\" name=\"__codelineno-7-27\" href=\"#__codelineno-7-27\"></a>                      [ Frame: NO_FRAME_TYPE\n</span><span id=\"__span-7-28\"><a id=\"__codelineno-7-28\" name=\"__codelineno-7-28\" href=\"#__codelineno-7-28\"></a>                        [  - EntryFromBuiltinAsOperand@../../src/codegen/arm64/macro-assembler-arm64.cc:2377\n</span><span id=\"__span-7-29\"><a id=\"__codelineno-7-29\" name=\"__codelineno-7-29\" href=\"#__codelineno-7-29\"></a>                        ]\n</span><span id=\"__span-7-30\"><a id=\"__codelineno-7-30\" name=\"__codelineno-7-30\" href=\"#__codelineno-7-30\"></a>0xc6ccfe4a8b10    10  f96a3750       ldr x16, [x26, #21608]\n</span><span id=\"__span-7-31\"><a id=\"__codelineno-7-31\" name=\"__codelineno-7-31\" href=\"#__codelineno-7-31\"></a>0xc6ccfe4a8b14    14  d63f0200       blr x16\n</span><span id=\"__span-7-32\"><a id=\"__codelineno-7-32\" name=\"__codelineno-7-32\" href=\"#__codelineno-7-32\"></a>                      ]\n</span><span id=\"__span-7-33\"><a id=\"__codelineno-7-33\" name=\"__codelineno-7-33\" href=\"#__codelineno-7-33\"></a>                    ]\n</span><span id=\"__span-7-34\"><a id=\"__codelineno-7-34\" name=\"__codelineno-7-34\" href=\"#__codelineno-7-34\"></a>\n</span><span id=\"__span-7-35\"><a id=\"__codelineno-7-35\" name=\"__codelineno-7-35\" href=\"#__codelineno-7-35\"></a># \u6808\u5bf9\u9f50\u68c0\u67e5\uff0c\u5b9a\u4e49\u5728\uff1a\n</span><span id=\"__span-7-36\"><a id=\"__codelineno-7-36\" name=\"__codelineno-7-36\" href=\"#__codelineno-7-36\"></a># v8/src/codegen/arm64/macro-assembler-arm64.cc MacroAssembler::AssertSpAligned():\n</span><span id=\"__span-7-37\"><a id=\"__codelineno-7-37\" name=\"__codelineno-7-37\" href=\"#__codelineno-7-37\"></a>#   if (!v8_flags.debug_code) return;\n</span><span id=\"__span-7-38\"><a id=\"__codelineno-7-38\" name=\"__codelineno-7-38\" href=\"#__codelineno-7-38\"></a>#   ASM_CODE_COMMENT(this);\n</span><span id=\"__span-7-39\"><a id=\"__codelineno-7-39\" name=\"__codelineno-7-39\" href=\"#__codelineno-7-39\"></a>#   HardAbortScope hard_abort(this);  // Avoid calls to Abort.\n</span><span id=\"__span-7-40\"><a id=\"__codelineno-7-40\" name=\"__codelineno-7-40\" href=\"#__codelineno-7-40\"></a>#   // Arm64 requires the stack pointer to be 16-byte aligned prior to address\n</span><span id=\"__span-7-41\"><a id=\"__codelineno-7-41\" name=\"__codelineno-7-41\" href=\"#__codelineno-7-41\"></a>#   // calculation.\n</span><span id=\"__span-7-42\"><a id=\"__codelineno-7-42\" name=\"__codelineno-7-42\" href=\"#__codelineno-7-42\"></a>#   UseScratchRegisterScope scope(this);\n</span><span id=\"__span-7-43\"><a id=\"__codelineno-7-43\" name=\"__codelineno-7-43\" href=\"#__codelineno-7-43\"></a>#   Register temp = scope.AcquireX(); // becomes x16 in the following code\n</span><span id=\"__span-7-44\"><a id=\"__codelineno-7-44\" name=\"__codelineno-7-44\" href=\"#__codelineno-7-44\"></a>#   Mov(temp, sp);\n</span><span id=\"__span-7-45\"><a id=\"__codelineno-7-45\" name=\"__codelineno-7-45\" href=\"#__codelineno-7-45\"></a>#   Tst(temp, 15);\n</span><span id=\"__span-7-46\"><a id=\"__codelineno-7-46\" name=\"__codelineno-7-46\" href=\"#__codelineno-7-46\"></a>#   Check(eq, AbortReason::kUnexpectedStackPointer);\n</span><span id=\"__span-7-47\"><a id=\"__codelineno-7-47\" name=\"__codelineno-7-47\" href=\"#__codelineno-7-47\"></a>\n</span><span id=\"__span-7-48\"><a id=\"__codelineno-7-48\" name=\"__codelineno-7-48\" href=\"#__codelineno-7-48\"></a>                  -- B0 start (construct frame) --\n</span><span id=\"__span-7-49\"><a id=\"__codelineno-7-49\" name=\"__codelineno-7-49\" href=\"#__codelineno-7-49\"></a>                    [  - AssertSpAligned@../../src/codegen/arm64/macro-assembler-arm64.cc:1590\n</span><span id=\"__span-7-50\"><a id=\"__codelineno-7-50\" name=\"__codelineno-7-50\" href=\"#__codelineno-7-50\"></a>0xc6ccfe4a8b18    18  910003f0       mov x16, sp\n</span><span id=\"__span-7-51\"><a id=\"__codelineno-7-51\" name=\"__codelineno-7-51\" href=\"#__codelineno-7-51\"></a>                      [  - LogicalMacro@../../src/codegen/arm64/macro-assembler-arm64.cc:197\n</span><span id=\"__span-7-52\"><a id=\"__codelineno-7-52\" name=\"__codelineno-7-52\" href=\"#__codelineno-7-52\"></a>0xc6ccfe4a8b1c    1c  f2400e1f       tst x16, #0xf\n</span><span id=\"__span-7-53\"><a id=\"__codelineno-7-53\" name=\"__codelineno-7-53\" href=\"#__codelineno-7-53\"></a>                      ]\n</span><span id=\"__span-7-54\"><a id=\"__codelineno-7-54\" name=\"__codelineno-7-54\" href=\"#__codelineno-7-54\"></a>0xc6ccfe4a8b20    20  54000080       b.eq #+0x10 (addr 0xc6ccfe4a8b30)\n</span><span id=\"__span-7-55\"><a id=\"__codelineno-7-55\" name=\"__codelineno-7-55\" href=\"#__codelineno-7-55\"></a>                      [  - Abort@../../src/codegen/arm64/macro-assembler-arm64.cc:4008\n</span><span id=\"__span-7-56\"><a id=\"__codelineno-7-56\" name=\"__codelineno-7-56\" href=\"#__codelineno-7-56\"></a>                  Abort message:  - Abort@../../src/codegen/arm64/macro-assembler-arm64.cc:4010\n</span><span id=\"__span-7-57\"><a id=\"__codelineno-7-57\" name=\"__codelineno-7-57\" href=\"#__codelineno-7-57\"></a>                  The stack pointer is not the expected value - Abort@../../src/codegen/arm64/macro-assembler-arm64.cc:4011\n</span><span id=\"__span-7-58\"><a id=\"__codelineno-7-58\" name=\"__codelineno-7-58\" href=\"#__codelineno-7-58\"></a>                        [ Frame: NO_FRAME_TYPE\n</span><span id=\"__span-7-59\"><a id=\"__codelineno-7-59\" name=\"__codelineno-7-59\" href=\"#__codelineno-7-59\"></a>0xc6ccfe4a8b24    24  52800780       movz w0, #0x3c\n</span><span id=\"__span-7-60\"><a id=\"__codelineno-7-60\" name=\"__codelineno-7-60\" href=\"#__codelineno-7-60\"></a>0xc6ccfe4a8b28    28  f94e7750       ldr x16, [x26, #7400]\n</span><span id=\"__span-7-61\"><a id=\"__codelineno-7-61\" name=\"__codelineno-7-61\" href=\"#__codelineno-7-61\"></a>0xc6ccfe4a8b2c    2c  d63f0200       blr x16\n</span><span id=\"__span-7-62\"><a id=\"__codelineno-7-62\" name=\"__codelineno-7-62\" href=\"#__codelineno-7-62\"></a>                        ]\n</span><span id=\"__span-7-63\"><a id=\"__codelineno-7-63\" name=\"__codelineno-7-63\" href=\"#__codelineno-7-63\"></a>                      ]\n</span><span id=\"__span-7-64\"><a id=\"__codelineno-7-64\" name=\"__codelineno-7-64\" href=\"#__codelineno-7-64\"></a>                    ]\n</span><span id=\"__span-7-65\"><a id=\"__codelineno-7-65\" name=\"__codelineno-7-65\" href=\"#__codelineno-7-65\"></a>\n</span><span id=\"__span-7-66\"><a id=\"__codelineno-7-66\" name=\"__codelineno-7-66\" href=\"#__codelineno-7-66\"></a># \u6784\u5efa\u6808\u5e27\n</span><span id=\"__span-7-67\"><a id=\"__codelineno-7-67\" name=\"__codelineno-7-67\" href=\"#__codelineno-7-67\"></a># \u6784\u5efa\u5b8c\u6210\u540e\u4f1a\u5f97\u5230\uff1asp = prev sp - 64, fp = sp + 48\n</span><span id=\"__span-7-68\"><a id=\"__codelineno-7-68\" name=\"__codelineno-7-68\" href=\"#__codelineno-7-68\"></a>#\n</span><span id=\"__span-7-69\"><a id=\"__codelineno-7-69\" name=\"__codelineno-7-69\" href=\"#__codelineno-7-69\"></a># \u6808\u5e27\u7684\u793a\u610f\u56fe, \u6bcf\u4e00\u4e2a\u65b9\u6846\u8868\u793a 8 \u5b57\u8282\u7684\u5185\u5b58:\n</span><span id=\"__span-7-70\"><a id=\"__codelineno-7-70\" name=\"__codelineno-7-70\" href=\"#__codelineno-7-70\"></a># sp + 64   +------------+\n</span><span id=\"__span-7-71\"><a id=\"__codelineno-7-71\" name=\"__codelineno-7-71\" href=\"#__codelineno-7-71\"></a>#           | lr         |  &lt;= lr \u662f link register \u7684\u7f29\u5199\uff0c\u8868\u793a\u8fd4\u56de\u5730\u5740\n</span><span id=\"__span-7-72\"><a id=\"__codelineno-7-72\" name=\"__codelineno-7-72\" href=\"#__codelineno-7-72\"></a># sp + 56   +------------+\n</span><span id=\"__span-7-73\"><a id=\"__codelineno-7-73\" name=\"__codelineno-7-73\" href=\"#__codelineno-7-73\"></a>#           | prev fp    |  &lt;= \u4fdd\u5b58\u4e86\u8c03\u7528\u524d\u7684 fp (frame pointer)\n</span><span id=\"__span-7-74\"><a id=\"__codelineno-7-74\" name=\"__codelineno-7-74\" href=\"#__codelineno-7-74\"></a># sp + 48   +------------+  &lt;= \u65b0\u7684 fp (frame pointer) \u6307\u5411\u8fd9\u91cc\n</span><span id=\"__span-7-75\"><a id=\"__codelineno-7-75\" name=\"__codelineno-7-75\" href=\"#__codelineno-7-75\"></a>#           | x16 (0x22) |\n</span><span id=\"__span-7-76\"><a id=\"__codelineno-7-76\" name=\"__codelineno-7-76\" href=\"#__codelineno-7-76\"></a># sp + 40   +------------+\n</span><span id=\"__span-7-77\"><a id=\"__codelineno-7-77\" name=\"__codelineno-7-77\" href=\"#__codelineno-7-77\"></a>#           | x20        |  &lt;= bytecode array register\n</span><span id=\"__span-7-78\"><a id=\"__codelineno-7-78\" name=\"__codelineno-7-78\" href=\"#__codelineno-7-78\"></a># sp + 32   +------------+\n</span><span id=\"__span-7-79\"><a id=\"__codelineno-7-79\" name=\"__codelineno-7-79\" href=\"#__codelineno-7-79\"></a>#           | x21        |  &lt;= dispatch table register\n</span><span id=\"__span-7-80\"><a id=\"__codelineno-7-80\" name=\"__codelineno-7-80\" href=\"#__codelineno-7-80\"></a># sp + 24   +------------+\n</span><span id=\"__span-7-81\"><a id=\"__codelineno-7-81\" name=\"__codelineno-7-81\" href=\"#__codelineno-7-81\"></a>#           | x19        |  &lt;= bytecode offset register\uff0c\u8bb0\u5f55\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684 bytecode \u5728 bytecode array \u4e2d\u7684\u504f\u79fb\n</span><span id=\"__span-7-82\"><a id=\"__codelineno-7-82\" name=\"__codelineno-7-82\" href=\"#__codelineno-7-82\"></a># sp + 16   +------------+\n</span><span id=\"__span-7-83\"><a id=\"__codelineno-7-83\" name=\"__codelineno-7-83\" href=\"#__codelineno-7-83\"></a>#           | x0         |  &lt;= accumulator register\n</span><span id=\"__span-7-84\"><a id=\"__codelineno-7-84\" name=\"__codelineno-7-84\" href=\"#__codelineno-7-84\"></a># sp + 8    +------------+\n</span><span id=\"__span-7-85\"><a id=\"__codelineno-7-85\" name=\"__codelineno-7-85\" href=\"#__codelineno-7-85\"></a>#           |            |\n</span><span id=\"__span-7-86\"><a id=\"__codelineno-7-86\" name=\"__codelineno-7-86\" href=\"#__codelineno-7-86\"></a># sp        +------------+  &lt;= \u65b0\u7684 sp (stack pointer) \u6307\u5411\u8fd9\u91cc\n</span><span id=\"__span-7-87\"><a id=\"__codelineno-7-87\" name=\"__codelineno-7-87\" href=\"#__codelineno-7-87\"></a>#\n</span><span id=\"__span-7-88\"><a id=\"__codelineno-7-88\" name=\"__codelineno-7-88\" href=\"#__codelineno-7-88\"></a># \u8fd9\u4e9b\u5bc4\u5b58\u5668\u5b9a\u4e49\u5728 v8/src/codegen/arm64/register-arm64.h \u5f53\u4e2d\uff1a\n</span><span id=\"__span-7-89\"><a id=\"__codelineno-7-89\" name=\"__codelineno-7-89\" href=\"#__codelineno-7-89\"></a># constexpr Register kInterpreterAccumulatorRegister = x0;\n</span><span id=\"__span-7-90\"><a id=\"__codelineno-7-90\" name=\"__codelineno-7-90\" href=\"#__codelineno-7-90\"></a># constexpr Register kInterpreterBytecodeOffsetRegister = x19;\n</span><span id=\"__span-7-91\"><a id=\"__codelineno-7-91\" name=\"__codelineno-7-91\" href=\"#__codelineno-7-91\"></a># constexpr Register kInterpreterBytecodeArrayRegister = x20;\n</span><span id=\"__span-7-92\"><a id=\"__codelineno-7-92\" name=\"__codelineno-7-92\" href=\"#__codelineno-7-92\"></a># constexpr Register kInterpreterDispatchTableRegister = x21;\n</span><span id=\"__span-7-93\"><a id=\"__codelineno-7-93\" name=\"__codelineno-7-93\" href=\"#__codelineno-7-93\"></a>\n</span><span id=\"__span-7-94\"><a id=\"__codelineno-7-94\" name=\"__codelineno-7-94\" href=\"#__codelineno-7-94\"></a>0xc6ccfe4a8b30    30  d2800450       movz x16, #0x22\n</span><span id=\"__span-7-95\"><a id=\"__codelineno-7-95\" name=\"__codelineno-7-95\" href=\"#__codelineno-7-95\"></a>0xc6ccfe4a8b34    34  a9be43ff       stp xzr, x16, [sp, #-32]!\n</span><span id=\"__span-7-96\"><a id=\"__codelineno-7-96\" name=\"__codelineno-7-96\" href=\"#__codelineno-7-96\"></a>0xc6ccfe4a8b38    38  a9017bfd       stp fp, lr, [sp, #16]\n</span><span id=\"__span-7-97\"><a id=\"__codelineno-7-97\" name=\"__codelineno-7-97\" href=\"#__codelineno-7-97\"></a>0xc6ccfe4a8b3c    3c  910043fd       add fp, sp, #0x10 (16)\n</span><span id=\"__span-7-98\"><a id=\"__codelineno-7-98\" name=\"__codelineno-7-98\" href=\"#__codelineno-7-98\"></a>0xc6ccfe4a8b40    40  d10083ff       sub sp, sp, #0x20 (32)\n</span><span id=\"__span-7-99\"><a id=\"__codelineno-7-99\" name=\"__codelineno-7-99\" href=\"#__codelineno-7-99\"></a>0xc6ccfe4a8b44    44  f90013f4       str x20, [sp, #32]\n</span><span id=\"__span-7-100\"><a id=\"__codelineno-7-100\" name=\"__codelineno-7-100\" href=\"#__codelineno-7-100\"></a>0xc6ccfe4a8b48    48  f9000ff5       str x21, [sp, #24]\n</span><span id=\"__span-7-101\"><a id=\"__codelineno-7-101\" name=\"__codelineno-7-101\" href=\"#__codelineno-7-101\"></a>0xc6ccfe4a8b4c    4c  f90007e0       str x0, [sp, #8]\n</span><span id=\"__span-7-102\"><a id=\"__codelineno-7-102\" name=\"__codelineno-7-102\" href=\"#__codelineno-7-102\"></a>0xc6ccfe4a8b50    50  f9000bf3       str x19, [sp, #16]\n</span><span id=\"__span-7-103\"><a id=\"__codelineno-7-103\" name=\"__codelineno-7-103\" href=\"#__codelineno-7-103\"></a>\n</span><span id=\"__span-7-104\"><a id=\"__codelineno-7-104\" name=\"__codelineno-7-104\" href=\"#__codelineno-7-104\"></a># \u8c03\u7528\u4e86\u672a\u77e5\u7684 C \u51fd\u6570\n</span><span id=\"__span-7-105\"><a id=\"__codelineno-7-105\" name=\"__codelineno-7-105\" href=\"#__codelineno-7-105\"></a>0xc6ccfe4a8b54    54  d28042c1       movz x1, #0x216\n</span><span id=\"__span-7-106\"><a id=\"__codelineno-7-106\" name=\"__codelineno-7-106\" href=\"#__codelineno-7-106\"></a>                    [  - LoadFromConstantsTable@../../src/codegen/arm64/macro-assembler-arm64.cc:2166\n</span><span id=\"__span-7-107\"><a id=\"__codelineno-7-107\" name=\"__codelineno-7-107\" href=\"#__codelineno-7-107\"></a>                      [  - LoadRoot@../../src/codegen/arm64/macro-assembler-arm64.cc:1954\n</span><span id=\"__span-7-108\"><a id=\"__codelineno-7-108\" name=\"__codelineno-7-108\" href=\"#__codelineno-7-108\"></a>0xc6ccfe4a8b58    58  f94d5f42       ldr x2, [x26, #6840]\n</span><span id=\"__span-7-109\"><a id=\"__codelineno-7-109\" name=\"__codelineno-7-109\" href=\"#__codelineno-7-109\"></a>                      ]\n</span><span id=\"__span-7-110\"><a id=\"__codelineno-7-110\" name=\"__codelineno-7-110\" href=\"#__codelineno-7-110\"></a>                      [  - DecompressTagged@../../src/codegen/arm64/macro-assembler-arm64.cc:3448\n</span><span id=\"__span-7-111\"><a id=\"__codelineno-7-111\" name=\"__codelineno-7-111\" href=\"#__codelineno-7-111\"></a>0xc6ccfe4a8b5c    5c  d28bcef0       movz x16, #0x5e77\n</span><span id=\"__span-7-112\"><a id=\"__codelineno-7-112\" name=\"__codelineno-7-112\" href=\"#__codelineno-7-112\"></a>0xc6ccfe4a8b60    60  b8706842       ldr w2, [x2, x16]\n</span><span id=\"__span-7-113\"><a id=\"__codelineno-7-113\" name=\"__codelineno-7-113\" href=\"#__codelineno-7-113\"></a>0xc6ccfe4a8b64    64  8b020382       add x2, x28, x2\n</span><span id=\"__span-7-114\"><a id=\"__codelineno-7-114\" name=\"__codelineno-7-114\" href=\"#__codelineno-7-114\"></a>                      ]\n</span><span id=\"__span-7-115\"><a id=\"__codelineno-7-115\" name=\"__codelineno-7-115\" href=\"#__codelineno-7-115\"></a>                    ]\n</span><span id=\"__span-7-116\"><a id=\"__codelineno-7-116\" name=\"__codelineno-7-116\" href=\"#__codelineno-7-116\"></a>0xc6ccfe4a8b68    68  aa1403e0       mov x0, x20\n</span><span id=\"__span-7-117\"><a id=\"__codelineno-7-117\" name=\"__codelineno-7-117\" href=\"#__codelineno-7-117\"></a>0xc6ccfe4a8b6c    6c  f94ecf50       ldr x16, [x26, #7576]\n</span><span id=\"__span-7-118\"><a id=\"__codelineno-7-118\" name=\"__codelineno-7-118\" href=\"#__codelineno-7-118\"></a>                    [  - CallCFunction@../../src/codegen/arm64/macro-assembler-arm64.cc:2106\n</span><span id=\"__span-7-119\"><a id=\"__codelineno-7-119\" name=\"__codelineno-7-119\" href=\"#__codelineno-7-119\"></a>0xc6ccfe4a8b70    70  10000068       adr x8, #+0xc (addr 0xc6ccfe4a8b7c)\n</span><span id=\"__span-7-120\"><a id=\"__codelineno-7-120\" name=\"__codelineno-7-120\" href=\"#__codelineno-7-120\"></a>0xc6ccfe4a8b74    74  a93f235d       stp fp, x8, [x26, #-16]\n</span><span id=\"__span-7-121\"><a id=\"__codelineno-7-121\" name=\"__codelineno-7-121\" href=\"#__codelineno-7-121\"></a>0xc6ccfe4a8b78    78  d63f0200       blr x16\n</span><span id=\"__span-7-122\"><a id=\"__codelineno-7-122\" name=\"__codelineno-7-122\" href=\"#__codelineno-7-122\"></a>0xc6ccfe4a8b7c    7c  f81f035f       stur xzr, [x26, #-16]\n</span><span id=\"__span-7-123\"><a id=\"__codelineno-7-123\" name=\"__codelineno-7-123\" href=\"#__codelineno-7-123\"></a>                    ]\n</span><span id=\"__span-7-124\"><a id=\"__codelineno-7-124\" name=\"__codelineno-7-124\" href=\"#__codelineno-7-124\"></a>0xc6ccfe4a8b80    80  d2800001       movz x1, #0x0\n</span><span id=\"__span-7-125\"><a id=\"__codelineno-7-125\" name=\"__codelineno-7-125\" href=\"#__codelineno-7-125\"></a>                    [  - LoadFromConstantsTable@../../src/codegen/arm64/macro-assembler-arm64.cc:2166\n</span><span id=\"__span-7-126\"><a id=\"__codelineno-7-126\" name=\"__codelineno-7-126\" href=\"#__codelineno-7-126\"></a>                      [  - LoadRoot@../../src/codegen/arm64/macro-assembler-arm64.cc:1954\n</span><span id=\"__span-7-127\"><a id=\"__codelineno-7-127\" name=\"__codelineno-7-127\" href=\"#__codelineno-7-127\"></a>0xc6ccfe4a8b84    84  f94d5f42       ldr x2, [x26, #6840]\n</span><span id=\"__span-7-128\"><a id=\"__codelineno-7-128\" name=\"__codelineno-7-128\" href=\"#__codelineno-7-128\"></a>                      ]\n</span><span id=\"__span-7-129\"><a id=\"__codelineno-7-129\" name=\"__codelineno-7-129\" href=\"#__codelineno-7-129\"></a>                      [  - DecompressTagged@../../src/codegen/arm64/macro-assembler-arm64.cc:3448\n</span><span id=\"__span-7-130\"><a id=\"__codelineno-7-130\" name=\"__codelineno-7-130\" href=\"#__codelineno-7-130\"></a>0xc6ccfe4a8b88    88  d28bcf70       movz x16, #0x5e7b\n</span><span id=\"__span-7-131\"><a id=\"__codelineno-7-131\" name=\"__codelineno-7-131\" href=\"#__codelineno-7-131\"></a>0xc6ccfe4a8b8c    8c  b8706842       ldr w2, [x2, x16]\n</span><span id=\"__span-7-132\"><a id=\"__codelineno-7-132\" name=\"__codelineno-7-132\" href=\"#__codelineno-7-132\"></a>0xc6ccfe4a8b90    90  8b020382       add x2, x28, x2\n</span><span id=\"__span-7-133\"><a id=\"__codelineno-7-133\" name=\"__codelineno-7-133\" href=\"#__codelineno-7-133\"></a>                      ]\n</span><span id=\"__span-7-134\"><a id=\"__codelineno-7-134\" name=\"__codelineno-7-134\" href=\"#__codelineno-7-134\"></a>                    ]\n</span><span id=\"__span-7-135\"><a id=\"__codelineno-7-135\" name=\"__codelineno-7-135\" href=\"#__codelineno-7-135\"></a>0xc6ccfe4a8b94    94  f94007e0       ldr x0, [sp, #8]\n</span><span id=\"__span-7-136\"><a id=\"__codelineno-7-136\" name=\"__codelineno-7-136\" href=\"#__codelineno-7-136\"></a>0xc6ccfe4a8b98    98  f94ecf50       ldr x16, [x26, #7576]\n</span><span id=\"__span-7-137\"><a id=\"__codelineno-7-137\" name=\"__codelineno-7-137\" href=\"#__codelineno-7-137\"></a>                    [  - CallCFunction@../../src/codegen/arm64/macro-assembler-arm64.cc:2106\n</span><span id=\"__span-7-138\"><a id=\"__codelineno-7-138\" name=\"__codelineno-7-138\" href=\"#__codelineno-7-138\"></a>0xc6ccfe4a8b9c    9c  10000068       adr x8, #+0xc (addr 0xc6ccfe4a8ba8)\n</span><span id=\"__span-7-139\"><a id=\"__codelineno-7-139\" name=\"__codelineno-7-139\" href=\"#__codelineno-7-139\"></a>0xc6ccfe4a8ba0    a0  a93f235d       stp fp, x8, [x26, #-16]\n</span><span id=\"__span-7-140\"><a id=\"__codelineno-7-140\" name=\"__codelineno-7-140\" href=\"#__codelineno-7-140\"></a>0xc6ccfe4a8ba4    a4  d63f0200       blr x16\n</span><span id=\"__span-7-141\"><a id=\"__codelineno-7-141\" name=\"__codelineno-7-141\" href=\"#__codelineno-7-141\"></a>0xc6ccfe4a8ba8    a8  f81f035f       stur xzr, [x26, #-16]\n</span><span id=\"__span-7-142\"><a id=\"__codelineno-7-142\" name=\"__codelineno-7-142\" href=\"#__codelineno-7-142\"></a>                    ]\n</span><span id=\"__span-7-143\"><a id=\"__codelineno-7-143\" name=\"__codelineno-7-143\" href=\"#__codelineno-7-143\"></a>\n</span><span id=\"__span-7-144\"><a id=\"__codelineno-7-144\" name=\"__codelineno-7-144\" href=\"#__codelineno-7-144\"></a># \u4ece\u8fd9\u91cc\u5f00\u59cb\u5b9e\u73b0 LdaSmi \u7684\u8bed\u4e49\n</span><span id=\"__span-7-145\"><a id=\"__codelineno-7-145\" name=\"__codelineno-7-145\" href=\"#__codelineno-7-145\"></a># \u4ece\u524d\u9762\u7684\u5206\u6790\u53ef\u4ee5\u770b\u5230 LdaSmi \u7531\u4e24\u4e2a\u5b57\u8282\u7ec4\u6210\uff1a\n</span><span id=\"__span-7-146\"><a id=\"__codelineno-7-146\" name=\"__codelineno-7-146\" href=\"#__codelineno-7-146\"></a># 1. \u7b2c\u4e00\u4e2a\u5b57\u8282\u662f 0x0d\uff0c\u8868\u793a\u8fd9\u662f\u4e00\u6761 LdaSmi\n</span><span id=\"__span-7-147\"><a id=\"__codelineno-7-147\" name=\"__codelineno-7-147\" href=\"#__codelineno-7-147\"></a># 2. \u7b2c\u4e8c\u4e2a\u5b57\u8282\u5c31\u662f\u8981\u52a0\u8f7d\u5230 `accumulator` \u7684\u5c0f\u6574\u6570\n</span><span id=\"__span-7-148\"><a id=\"__codelineno-7-148\" name=\"__codelineno-7-148\" href=\"#__codelineno-7-148\"></a># \u5982\uff1a0d 01 \u5bf9\u5e94 LdaSmi [1]\uff0c0d 02 \u5bf9\u5e94 LdaSmi [2]\n</span><span id=\"__span-7-149\"><a id=\"__codelineno-7-149\" name=\"__codelineno-7-149\" href=\"#__codelineno-7-149\"></a># \u6240\u4ee5\uff0c\u4e3a\u4e86\u5b9e\u73b0 LdaSmi\uff0c\u9700\u8981\u4ece bytecode array \u4e2d\u8bfb\u53d6 LdaSmi \u5b57\u8282\u7801\u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\uff0c\n</span><span id=\"__span-7-150\"><a id=\"__codelineno-7-150\" name=\"__codelineno-7-150\" href=\"#__codelineno-7-150\"></a># \u4fdd\u5b58\u5230 `accumulator` \u5bc4\u5b58\u5668\u5f53\u4e2d\n</span><span id=\"__span-7-151\"><a id=\"__codelineno-7-151\" name=\"__codelineno-7-151\" href=\"#__codelineno-7-151\"></a># \u4e0b\u9762\u4e00\u6761\u4e00\u6761\u5730\u5206\u6790\u6307\u4ee4\u5728\u505a\u7684\u4e8b\u60c5\uff1a\n</span><span id=\"__span-7-152\"><a id=\"__codelineno-7-152\" name=\"__codelineno-7-152\" href=\"#__codelineno-7-152\"></a># 1. \u4ece sp + 16 \u5730\u5740\u8bfb\u53d6 bytecode offset \u5bc4\u5b58\u5668\u7684\u503c\u5230 x3\uff0c\n</span><span id=\"__span-7-153\"><a id=\"__codelineno-7-153\" name=\"__codelineno-7-153\" href=\"#__codelineno-7-153\"></a>#    \u5b83\u8bb0\u5f55\u4e86 LdaSmi \u76f8\u5bf9 bytecode array \u7684\u504f\u79fb\n</span><span id=\"__span-7-154\"><a id=\"__codelineno-7-154\" name=\"__codelineno-7-154\" href=\"#__codelineno-7-154\"></a>0xc6ccfe4a8bac    ac  f9400be3       ldr x3, [sp, #16]\n</span><span id=\"__span-7-155\"><a id=\"__codelineno-7-155\" name=\"__codelineno-7-155\" href=\"#__codelineno-7-155\"></a># 2. \u8ba1\u7b97 x3 + 1 \u7684\u503c\u5e76\u5199\u5165 x4\uff0c\u5f97\u5230 LdaSmi \u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\u76f8\u5bf9 bytecode array \u7684\u504f\u79fb\n</span><span id=\"__span-7-156\"><a id=\"__codelineno-7-156\" name=\"__codelineno-7-156\" href=\"#__codelineno-7-156\"></a>0xc6ccfe4a8bb0    b0  91000464       add x4, x3, #0x1 (1)\n</span><span id=\"__span-7-157\"><a id=\"__codelineno-7-157\" name=\"__codelineno-7-157\" href=\"#__codelineno-7-157\"></a># 3. \u4ece sp + 32 \u5730\u5740\u8bfb\u53d6 bytecode array \u5bc4\u5b58\u5668\u7684\u503c\u5230 x20\n</span><span id=\"__span-7-158\"><a id=\"__codelineno-7-158\" name=\"__codelineno-7-158\" href=\"#__codelineno-7-158\"></a>0xc6ccfe4a8bb4    b4  f94013f4       ldr x20, [sp, #32]\n</span><span id=\"__span-7-159\"><a id=\"__codelineno-7-159\" name=\"__codelineno-7-159\" href=\"#__codelineno-7-159\"></a># 4. \u4ece x20 + x4 \u5730\u5740\u8bfb\u53d6 LdaSmi \u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5230 x4\uff0c\u4e5f\u5c31\u662f\u8981\u52a0\u8f7d\u5230 `accumulator` \u7684\u503c\uff0c\n</span><span id=\"__span-7-160\"><a id=\"__codelineno-7-160\" name=\"__codelineno-7-160\" href=\"#__codelineno-7-160\"></a>#    \u4e4b\u540e x4 \u7684\u503c\u4f1a\u5199\u5165\u5230 x0\uff0c\u4e5f\u5c31\u662f `accumulator` \u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\n</span><span id=\"__span-7-161\"><a id=\"__codelineno-7-161\" name=\"__codelineno-7-161\" href=\"#__codelineno-7-161\"></a>0xc6ccfe4a8bb8    b8  38e46a84       ldrsb w4, [x20, x4]\n</span><span id=\"__span-7-162\"><a id=\"__codelineno-7-162\" name=\"__codelineno-7-162\" href=\"#__codelineno-7-162\"></a>\n</span><span id=\"__span-7-163\"><a id=\"__codelineno-7-163\" name=\"__codelineno-7-163\" href=\"#__codelineno-7-163\"></a># Dispatch: \u627e\u5230\u4e0b\u4e00\u4e2a Opcode \u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5165\u53e3\uff0c\u7136\u540e\u8df3\u8f6c\u8fc7\u53bb\n</span><span id=\"__span-7-164\"><a id=\"__codelineno-7-164\" name=\"__codelineno-7-164\" href=\"#__codelineno-7-164\"></a>                  ========= Dispatch - Dispatch@../../src/interpreter/interpreter-assembler.cc:1278 - AssembleArchInstruction@../../src/compiler/backend/arm64/code-generator-arm64.cc:978\n</span><span id=\"__span-7-165\"><a id=\"__codelineno-7-165\" name=\"__codelineno-7-165\" href=\"#__codelineno-7-165\"></a># x3 \u662f LdaSmi \u5f53\u524d\u6240\u5728\u7684 bytecode offset\uff0c\u52a0 2 \u662f\u56e0\u4e3a LdaSmi \u5360\u7528\u4e86\u4e24\u4e2a\u5b57\u8282\n</span><span id=\"__span-7-166\"><a id=\"__codelineno-7-166\" name=\"__codelineno-7-166\" href=\"#__codelineno-7-166\"></a># x19 = x3 + 2\uff0c\u5c31\u662f bytecode offset \u524d\u8fdb\u4e24\u4e2a\u5b57\u8282\uff0c\u6307\u5411\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\n</span><span id=\"__span-7-167\"><a id=\"__codelineno-7-167\" name=\"__codelineno-7-167\" href=\"#__codelineno-7-167\"></a>0xc6ccfe4a8bbc    bc  91000873       add x19, x3, #0x2 (2)\n</span><span id=\"__span-7-168\"><a id=\"__codelineno-7-168\" name=\"__codelineno-7-168\" href=\"#__codelineno-7-168\"></a># x20 \u662f bytecode array\uff0c\u4ece bytecode array \u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5230 x3 \u5bc4\u5b58\u5668\n</span><span id=\"__span-7-169\"><a id=\"__codelineno-7-169\" name=\"__codelineno-7-169\" href=\"#__codelineno-7-169\"></a>0xc6ccfe4a8bc0    c0  38736a83       ldrb w3, [x20, x19]\n</span><span id=\"__span-7-170\"><a id=\"__codelineno-7-170\" name=\"__codelineno-7-170\" href=\"#__codelineno-7-170\"></a>\n</span><span id=\"__span-7-171\"><a id=\"__codelineno-7-171\" name=\"__codelineno-7-171\" href=\"#__codelineno-7-171\"></a># \u63a5\u4e0b\u6765\u68c0\u67e5\u5728 x3 \u5bc4\u5b58\u5668\u5f53\u4e2d\u7684\u5b57\u8282\u7801\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\uff08Opcode\uff09\uff0c\u5982\u679c\u5b83\uff1a\n</span><span id=\"__span-7-172\"><a id=\"__codelineno-7-172\" name=\"__codelineno-7-172\" href=\"#__codelineno-7-172\"></a># 1. \u5c0f\u4e8e 187(kFirstShortStar)\uff0c\u8bf4\u660e\u5b83\u4e0d\u662f\u7279\u6b8a\u7684 Short Star (Star0-Star15) \u5b57\u8282\u7801\n</span><span id=\"__span-7-173\"><a id=\"__codelineno-7-173\" name=\"__codelineno-7-173\" href=\"#__codelineno-7-173\"></a># 2. \u4ecb\u4e8e 187(kFirstShortStar) \u548c 202(kLastShortStar) \u4e4b\u95f4\uff0c\u8bf4\u660e\u5b83\u662f\u7279\u6b8a\u7684 Short Star (Star0-Star15) \u5b57\u8282\u7801\n</span><span id=\"__span-7-174\"><a id=\"__codelineno-7-174\" name=\"__codelineno-7-174\" href=\"#__codelineno-7-174\"></a># 3. \u5982\u679c\u5927\u4e8e 202(kLastShortStar)\uff0c\u8bf4\u660e\u5b83\u662f\u975e\u6cd5\u7684\u5b57\u8282\u7801\n</span><span id=\"__span-7-175\"><a id=\"__codelineno-7-175\" name=\"__codelineno-7-175\" href=\"#__codelineno-7-175\"></a>\n</span><span id=\"__span-7-176\"><a id=\"__codelineno-7-176\" name=\"__codelineno-7-176\" href=\"#__codelineno-7-176\"></a># \u5982\u679c x3 \u5bc4\u5b58\u5668\u5927\u4e8e\u6216\u7b49\u4e8e 187\uff0c\u8bf4\u660e\u8fd9\u4e2a\u5b57\u8282\u7801\u53ef\u80fd\u662f Short Star \u5b57\u8282\u7801\uff0c\u5c31\u8df3\u8f6c\u5230\u540e\u9762\u7684 B2\n</span><span id=\"__span-7-177\"><a id=\"__codelineno-7-177\" name=\"__codelineno-7-177\" href=\"#__codelineno-7-177\"></a>0xc6ccfe4a8bc4    c4  7102ec7f       cmp w3, #0xbb (187)\n</span><span id=\"__span-7-178\"><a id=\"__codelineno-7-178\" name=\"__codelineno-7-178\" href=\"#__codelineno-7-178\"></a>0xc6ccfe4a8bc8    c8  54000102       b.hs #+0x20 (addr 0xc6ccfe4a8be8)\n</span><span id=\"__span-7-179\"><a id=\"__codelineno-7-179\" name=\"__codelineno-7-179\" href=\"#__codelineno-7-179\"></a>                  -- B1 start --\n</span><span id=\"__span-7-180\"><a id=\"__codelineno-7-180\" name=\"__codelineno-7-180\" href=\"#__codelineno-7-180\"></a># \u6b64\u65f6 x3 \u5c0f\u4e8e 187\n</span><span id=\"__span-7-181\"><a id=\"__codelineno-7-181\" name=\"__codelineno-7-181\" href=\"#__codelineno-7-181\"></a># \u4ece\u6808\u4e0a\u8bfb\u53d6 x21 \u5373 dispatch table register\n</span><span id=\"__span-7-182\"><a id=\"__codelineno-7-182\" name=\"__codelineno-7-182\" href=\"#__codelineno-7-182\"></a>0xc6ccfe4a8bcc    cc  f9400ff5       ldr x21, [sp, #24]\n</span><span id=\"__span-7-183\"><a id=\"__codelineno-7-183\" name=\"__codelineno-7-183\" href=\"#__codelineno-7-183\"></a># \u4ece dispatch table\uff0c\u4ee5 x3 \u4e3a\u4e0b\u6807\uff0c\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-7-184\"><a id=\"__codelineno-7-184\" name=\"__codelineno-7-184\" href=\"#__codelineno-7-184\"></a>0xc6ccfe4a8bd0    d0  f8637aa2       ldr x2, [x21, x3, lsl #3]\n</span><span id=\"__span-7-185\"><a id=\"__codelineno-7-185\" name=\"__codelineno-7-185\" href=\"#__codelineno-7-185\"></a># \u628a\u4e4b\u524d LdaSmi \u8ba1\u7b97\u5f97\u5230\u7684 x4 \u5bc4\u5b58\u5668\u5199\u5230 `accumulator` \u5373 x0 \u5bc4\u5b58\u5668\u5f53\u4e2d\n</span><span id=\"__span-7-186\"><a id=\"__codelineno-7-186\" name=\"__codelineno-7-186\" href=\"#__codelineno-7-186\"></a># \u8fd9\u91cc x0 = 2 * x4\uff0c\u662f\u56e0\u4e3a v8 \u7528\u6700\u4f4e\u4f4d\u8868\u793a\u8fd9\u662f\u4e00\u4e2a Smi\uff08\u7528 0 \u8868\u793a\uff09\u8fd8\u662f\u4e00\u4e2a\u6307\u9488\uff08\u7528 1 \u8868\u793a\uff09\n</span><span id=\"__span-7-187\"><a id=\"__codelineno-7-187\" name=\"__codelineno-7-187\" href=\"#__codelineno-7-187\"></a>0xc6ccfe4a8bd4    d4  0b040080       add w0, w4, w4\n</span><span id=\"__span-7-188\"><a id=\"__codelineno-7-188\" name=\"__codelineno-7-188\" href=\"#__codelineno-7-188\"></a># \u6062\u590d\u8c03\u7528\u51fd\u6570\u524d\u7684\u65e7 fp \u548c lr\n</span><span id=\"__span-7-189\"><a id=\"__codelineno-7-189\" name=\"__codelineno-7-189\" href=\"#__codelineno-7-189\"></a>0xc6ccfe4a8bd8    d8  a9407bbd       ldp fp, lr, [fp]\n</span><span id=\"__span-7-190\"><a id=\"__codelineno-7-190\" name=\"__codelineno-7-190\" href=\"#__codelineno-7-190\"></a># \u6062\u590d\u8c03\u7528\u51fd\u6570\u524d\u7684\u65e7 sp\n</span><span id=\"__span-7-191\"><a id=\"__codelineno-7-191\" name=\"__codelineno-7-191\" href=\"#__codelineno-7-191\"></a>0xc6ccfe4a8bdc    dc  910103ff       add sp, sp, #0x40 (64)\n</span><span id=\"__span-7-192\"><a id=\"__codelineno-7-192\" name=\"__codelineno-7-192\" href=\"#__codelineno-7-192\"></a># \u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\u5df2\u7ecf\u4fdd\u5b58\u5728 x2 \u5bc4\u5b58\u5668\u5f53\u4e2d\uff0c\u8df3\u8f6c\u8fc7\u53bb\n</span><span id=\"__span-7-193\"><a id=\"__codelineno-7-193\" name=\"__codelineno-7-193\" href=\"#__codelineno-7-193\"></a>0xc6ccfe4a8be0    e0  aa0203f1       mov x17, x2\n</span><span id=\"__span-7-194\"><a id=\"__codelineno-7-194\" name=\"__codelineno-7-194\" href=\"#__codelineno-7-194\"></a>0xc6ccfe4a8be4    e4  d61f0220       br x17\n</span><span id=\"__span-7-195\"><a id=\"__codelineno-7-195\" name=\"__codelineno-7-195\" href=\"#__codelineno-7-195\"></a>\n</span><span id=\"__span-7-196\"><a id=\"__codelineno-7-196\" name=\"__codelineno-7-196\" href=\"#__codelineno-7-196\"></a>                  -- B2 start --\n</span><span id=\"__span-7-197\"><a id=\"__codelineno-7-197\" name=\"__codelineno-7-197\" href=\"#__codelineno-7-197\"></a>                  [ Assert: UintPtrGreaterThanOrEqual(opcode, UintPtrConstant(static_cast&lt;int&gt;( Bytecode::kFirstShortStar))) - StoreRegisterForShortStar@../../src/interpreter/interpreter-assembler.cc:310 - AssembleArchInstruction@../../src/compiler/backend/arm64/code-generator-arm64.cc:978\n</span><span id=\"__span-7-198\"><a id=\"__codelineno-7-198\" name=\"__codelineno-7-198\" href=\"#__codelineno-7-198\"></a>                  ] Assert - AssembleArchInstruction@../../src/compiler/backend/arm64/code-generator-arm64.cc:978\n</span><span id=\"__span-7-199\"><a id=\"__codelineno-7-199\" name=\"__codelineno-7-199\" href=\"#__codelineno-7-199\"></a>                  [ Assert: UintPtrLessThanOrEqual( opcode, UintPtrConstant(static_cast&lt;int&gt;(Bytecode::kLastShortStar))) - StoreRegisterForShortStar@../../src/interpreter/interpreter-assembler.cc:314 - AssembleArchInstruction@../../src/compiler/backend/arm64/code-generator-arm64.cc:978\n</span><span id=\"__span-7-200\"><a id=\"__codelineno-7-200\" name=\"__codelineno-7-200\" href=\"#__codelineno-7-200\"></a># \u6b64\u65f6 x3 \u5927\u4e8e\u6216\u7b49\u4e8e 187\n</span><span id=\"__span-7-201\"><a id=\"__codelineno-7-201\" name=\"__codelineno-7-201\" href=\"#__codelineno-7-201\"></a># \u8fdb\u4e00\u6b65\u5224\u65ad x3 \u662f\u5426\u5927\u4e8e 202\uff0c\u5982\u679c\u5927\u4e8e\uff0c\u5219\u8df3\u8f6c\u5230\u540e\u9762\u7684 B3\n</span><span id=\"__span-7-202\"><a id=\"__codelineno-7-202\" name=\"__codelineno-7-202\" href=\"#__codelineno-7-202\"></a>0xc6ccfe4a8be8    e8  7103287f       cmp w3, #0xca (202)\n</span><span id=\"__span-7-203\"><a id=\"__codelineno-7-203\" name=\"__codelineno-7-203\" href=\"#__codelineno-7-203\"></a>0xc6ccfe4a8bec    ec  540001c8       b.hi #+0x38 (addr 0xc6ccfe4a8c24)\n</span><span id=\"__span-7-204\"><a id=\"__codelineno-7-204\" name=\"__codelineno-7-204\" href=\"#__codelineno-7-204\"></a>\n</span><span id=\"__span-7-205\"><a id=\"__codelineno-7-205\" name=\"__codelineno-7-205\" href=\"#__codelineno-7-205\"></a>                  -- B4 start --\n</span><span id=\"__span-7-206\"><a id=\"__codelineno-7-206\" name=\"__codelineno-7-206\" href=\"#__codelineno-7-206\"></a># \u6b64\u65f6 x3 \u4ecb\u4e8e 187 \u548c 202 \u4e4b\u95f4\uff0c\u662f\u4e00\u4e2a Short Star\n</span><span id=\"__span-7-207\"><a id=\"__codelineno-7-207\" name=\"__codelineno-7-207\" href=\"#__codelineno-7-207\"></a># Short Star \u505a\u7684\u4e8b\u60c5\u5c31\u662f\u628a `accumulator` \u5bc4\u5b58\u5668\u7684\u503c\u590d\u5236\u5230 r0-r15 \u5f53\u4e2d\u6307\u5b9a\u7684\u5bc4\u5b58\u5668\n</span><span id=\"__span-7-208\"><a id=\"__codelineno-7-208\" name=\"__codelineno-7-208\" href=\"#__codelineno-7-208\"></a># \u6240\u4ee5\u76f4\u63a5\u5728\u8fd9\u91cc\u5b9e\u73b0\u4e86 Short Star \u7684\u8bed\u4e49\uff0c\u800c\u4e0d\u662f\u5355\u72ec\u8dd1\u4e00\u6bb5\u4ee3\u7801\u53bb\u6267\u884c\u5b83\n</span><span id=\"__span-7-209\"><a id=\"__codelineno-7-209\" name=\"__codelineno-7-209\" href=\"#__codelineno-7-209\"></a># \u7531\u4e8e r0-r15 \u5bc4\u5b58\u5668\u4fdd\u5b58\u5728\u6808\u4e0a\uff0c\u6240\u4ee5\u901a\u8fc7 x3 \u8ba1\u7b97\u51fa Short Star \u8981\u5199\u5230\u54ea\u4e2a\u5bc4\u5b58\u5668\n</span><span id=\"__span-7-210\"><a id=\"__codelineno-7-210\" name=\"__codelineno-7-210\" href=\"#__codelineno-7-210\"></a># \u8fdb\u800c\u76f4\u63a5\u8ba1\u7b97\u8981\u5199\u5230\u7684\u6808\u7684\u5730\u5740\u7684\u504f\u79fb\n</span><span id=\"__span-7-211\"><a id=\"__codelineno-7-211\" name=\"__codelineno-7-211\" href=\"#__codelineno-7-211\"></a># \u5bfb\u627e\u4e00\u4e2a\u901a\u9879\u516c\u5f0f\uff0c\u627e\u5230 Star0-Star15 \u8981\u5199\u5165\u7684\u5730\u5740\uff1a\n</span><span id=\"__span-7-212\"><a id=\"__codelineno-7-212\" name=\"__codelineno-7-212\" href=\"#__codelineno-7-212\"></a># Star0(202): r0 \u7684\u4f4d\u7f6e\u5728\u6808\u9876\u518d\u5f80\u4e0b\u7684 8 \u5b57\u8282\uff0c\u5373 fp \u51cf\u53bb 56\n</span><span id=\"__span-7-213\"><a id=\"__codelineno-7-213\" name=\"__codelineno-7-213\" href=\"#__codelineno-7-213\"></a># Star0(187): r15 \u7684\u4f4d\u7f6e\u5728\u6808\u9876\u518d\u5f80\u4e0b\u7684 8*16 \u5b57\u8282\uff0c\u5373 fp \u51cf\u53bb 176\n</span><span id=\"__span-7-214\"><a id=\"__codelineno-7-214\" name=\"__codelineno-7-214\" href=\"#__codelineno-7-214\"></a># \u76f8\u5bf9 fp \u7684\u504f\u79fb\u91cf\u5c31\u7b49\u4e8e x3 * 8 - 1672\n</span><span id=\"__span-7-215\"><a id=\"__codelineno-7-215\" name=\"__codelineno-7-215\" href=\"#__codelineno-7-215\"></a># \u4ece\u800c\u5f97\u5230\u4e0b\u9762\u7684\u4ee3\u7801\uff1a\n</span><span id=\"__span-7-216\"><a id=\"__codelineno-7-216\" name=\"__codelineno-7-216\" href=\"#__codelineno-7-216\"></a># \u8ba1\u7b97 x3 = x3 * 8\n</span><span id=\"__span-7-217\"><a id=\"__codelineno-7-217\" name=\"__codelineno-7-217\" href=\"#__codelineno-7-217\"></a>0xc6ccfe4a8bf0    f0  d37df063       lsl x3, x3, #3\n</span><span id=\"__span-7-218\"><a id=\"__codelineno-7-218\" name=\"__codelineno-7-218\" href=\"#__codelineno-7-218\"></a># \u628a\u4e4b\u524d LdaSmi \u8ba1\u7b97\u5f97\u5230\u7684 x4 \u5bc4\u5b58\u5668\u5199\u5230 `accumulator` \u5373 x0 \u5bc4\u5b58\u5668\u5f53\u4e2d\n</span><span id=\"__span-7-219\"><a id=\"__codelineno-7-219\" name=\"__codelineno-7-219\" href=\"#__codelineno-7-219\"></a># \u8fd9\u91cc x0 = 2 * x4\uff0c\u662f\u56e0\u4e3a v8 \u7528\u6700\u4f4e\u4f4d\u8868\u793a\u8fd9\u662f\u4e00\u4e2a Smi\uff08\u7528 0 \u8868\u793a\uff09\u8fd8\u662f\u4e00\u4e2a\u6307\u9488\uff08\u7528 1 \u8868\u793a\uff09\n</span><span id=\"__span-7-220\"><a id=\"__codelineno-7-220\" name=\"__codelineno-7-220\" href=\"#__codelineno-7-220\"></a>0xc6ccfe4a8bf4    f4  0b040080       add w0, w4, w4\n</span><span id=\"__span-7-221\"><a id=\"__codelineno-7-221\" name=\"__codelineno-7-221\" href=\"#__codelineno-7-221\"></a>                  ] Assert - AssembleArchInstruction@../../src/compiler/backend/arm64/code-generator-arm64.cc:978\n</span><span id=\"__span-7-222\"><a id=\"__codelineno-7-222\" name=\"__codelineno-7-222\" href=\"#__codelineno-7-222\"></a># \u8ba1\u7b97 x3 = x3 - 1672\uff0c\u5c31\u5f97\u5230\u4e86\u76f8\u5bf9 fp \u7684\u504f\u79fb\u91cf\n</span><span id=\"__span-7-223\"><a id=\"__codelineno-7-223\" name=\"__codelineno-7-223\" href=\"#__codelineno-7-223\"></a>0xc6ccfe4a8bf8    f8  d11a2063       sub x3, x3, #0x688 (1672)\n</span><span id=\"__span-7-224\"><a id=\"__codelineno-7-224\" name=\"__codelineno-7-224\" href=\"#__codelineno-7-224\"></a># \u4ece fp \u7684\u5730\u5740\u8bfb\u53d6\u51fd\u6570\u8c03\u7528\u524d\u7684 fp\n</span><span id=\"__span-7-225\"><a id=\"__codelineno-7-225\" name=\"__codelineno-7-225\" href=\"#__codelineno-7-225\"></a>0xc6ccfe4a8bfc    fc  f94003a4       ldr x4, [fp]\n</span><span id=\"__span-7-226\"><a id=\"__codelineno-7-226\" name=\"__codelineno-7-226\" href=\"#__codelineno-7-226\"></a># \u628a `accumulator` \u5199\u5165\u5230\u76f8\u5bf9\u51fd\u6570\u8c03\u7528\u524d\u7684 fp \u7684\u5bf9\u5e94\u4f4d\u7f6e\n</span><span id=\"__span-7-227\"><a id=\"__codelineno-7-227\" name=\"__codelineno-7-227\" href=\"#__codelineno-7-227\"></a>0xc6ccfe4a8c00   100  f8236880       str x0, [x4, x3]\n</span><span id=\"__span-7-228\"><a id=\"__codelineno-7-228\" name=\"__codelineno-7-228\" href=\"#__codelineno-7-228\"></a>\n</span><span id=\"__span-7-229\"><a id=\"__codelineno-7-229\" name=\"__codelineno-7-229\" href=\"#__codelineno-7-229\"></a># \u4e0b\u9762\u5c31\u662f Dispatch \u903b\u8f91\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21\u662f\u6267\u884c\u5b8c Short Star \u5b57\u8282\u7801\u540e\u7684 Dispatch\n</span><span id=\"__span-7-230\"><a id=\"__codelineno-7-230\" name=\"__codelineno-7-230\" href=\"#__codelineno-7-230\"></a># x19 = x3 + 1\uff0c\u5c31\u662f bytecode offset \u524d\u8fdb\u4e00\u4e2a\u5b57\u8282\uff0c\u6307\u5411\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\n</span><span id=\"__span-7-231\"><a id=\"__codelineno-7-231\" name=\"__codelineno-7-231\" href=\"#__codelineno-7-231\"></a>0xc6ccfe4a8c04   104  91000673       add x19, x19, #0x1 (1)\n</span><span id=\"__span-7-232\"><a id=\"__codelineno-7-232\" name=\"__codelineno-7-232\" href=\"#__codelineno-7-232\"></a># x20 \u662f bytecode array\uff0c\u4ece bytecode array \u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5230 x3 \u5bc4\u5b58\u5668\n</span><span id=\"__span-7-233\"><a id=\"__codelineno-7-233\" name=\"__codelineno-7-233\" href=\"#__codelineno-7-233\"></a>0xc6ccfe4a8c08   108  38736a83       ldrb w3, [x20, x19]\n</span><span id=\"__span-7-234\"><a id=\"__codelineno-7-234\" name=\"__codelineno-7-234\" href=\"#__codelineno-7-234\"></a># \u4ece\u6808\u4e0a\u8bfb\u53d6 x21 \u5373 dispatch table register\n</span><span id=\"__span-7-235\"><a id=\"__codelineno-7-235\" name=\"__codelineno-7-235\" href=\"#__codelineno-7-235\"></a>0xc6ccfe4a8c0c   10c  f9400ff5       ldr x21, [sp, #24]\n</span><span id=\"__span-7-236\"><a id=\"__codelineno-7-236\" name=\"__codelineno-7-236\" href=\"#__codelineno-7-236\"></a># \u4ece dispatch table\uff0c\u4ee5 x3 \u4e3a\u4e0b\u6807\uff0c\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-7-237\"><a id=\"__codelineno-7-237\" name=\"__codelineno-7-237\" href=\"#__codelineno-7-237\"></a>0xc6ccfe4a8c10   110  f8637aa2       ldr x2, [x21, x3, lsl #3]\n</span><span id=\"__span-7-238\"><a id=\"__codelineno-7-238\" name=\"__codelineno-7-238\" href=\"#__codelineno-7-238\"></a># \u6062\u590d\u8c03\u7528\u51fd\u6570\u524d\u7684\u65e7 fp \u548c lr\n</span><span id=\"__span-7-239\"><a id=\"__codelineno-7-239\" name=\"__codelineno-7-239\" href=\"#__codelineno-7-239\"></a>0xc6ccfe4a8c14   114  a9407bbd       ldp fp, lr, [fp]\n</span><span id=\"__span-7-240\"><a id=\"__codelineno-7-240\" name=\"__codelineno-7-240\" href=\"#__codelineno-7-240\"></a># \u6062\u590d\u8c03\u7528\u51fd\u6570\u524d\u7684\u65e7 sp\n</span><span id=\"__span-7-241\"><a id=\"__codelineno-7-241\" name=\"__codelineno-7-241\" href=\"#__codelineno-7-241\"></a>0xc6ccfe4a8c18   118  910103ff       add sp, sp, #0x40 (64)\n</span><span id=\"__span-7-242\"><a id=\"__codelineno-7-242\" name=\"__codelineno-7-242\" href=\"#__codelineno-7-242\"></a># \u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\u5df2\u7ecf\u4fdd\u5b58\u5728 x2 \u5bc4\u5b58\u5668\u5f53\u4e2d\uff0c\u8df3\u8f6c\u8fc7\u53bb\n</span><span id=\"__span-7-243\"><a id=\"__codelineno-7-243\" name=\"__codelineno-7-243\" href=\"#__codelineno-7-243\"></a>0xc6ccfe4a8c1c   11c  aa0203f1       mov x17, x2\n</span><span id=\"__span-7-244\"><a id=\"__codelineno-7-244\" name=\"__codelineno-7-244\" href=\"#__codelineno-7-244\"></a>0xc6ccfe4a8c20   120  d61f0220       br x17\n</span><span id=\"__span-7-245\"><a id=\"__codelineno-7-245\" name=\"__codelineno-7-245\" href=\"#__codelineno-7-245\"></a>                  -- B5 start (no frame) --\n</span><span id=\"__span-7-246\"><a id=\"__codelineno-7-246\" name=\"__codelineno-7-246\" href=\"#__codelineno-7-246\"></a>\n</span><span id=\"__span-7-247\"><a id=\"__codelineno-7-247\" name=\"__codelineno-7-247\" href=\"#__codelineno-7-247\"></a>                  -- B3 start (deferred) --\n</span><span id=\"__span-7-248\"><a id=\"__codelineno-7-248\" name=\"__codelineno-7-248\" href=\"#__codelineno-7-248\"></a># \u6b64\u65f6 x3 \u5927\u4e8e 202\uff0c\u4e3a\u975e\u6cd5\u5b57\u8282\u7801\uff0c\u8df3\u8f6c\u5230\u9519\u8bef\u5904\u7406\u7684\u903b\u8f91\n</span><span id=\"__span-7-249\"><a id=\"__codelineno-7-249\" name=\"__codelineno-7-249\" href=\"#__codelineno-7-249\"></a>                    [  - LoadFromConstantsTable@../../src/codegen/arm64/macro-assembler-arm64.cc:2166\n</span><span id=\"__span-7-250\"><a id=\"__codelineno-7-250\" name=\"__codelineno-7-250\" href=\"#__codelineno-7-250\"></a>                      [  - LoadRoot@../../src/codegen/arm64/macro-assembler-arm64.cc:1954\n</span><span id=\"__span-7-251\"><a id=\"__codelineno-7-251\" name=\"__codelineno-7-251\" href=\"#__codelineno-7-251\"></a>0xc6ccfe4a8c24   124  f94d5f41       ldr x1, [x26, #6840]\n</span><span id=\"__span-7-252\"><a id=\"__codelineno-7-252\" name=\"__codelineno-7-252\" href=\"#__codelineno-7-252\"></a>                      ]\n</span><span id=\"__span-7-253\"><a id=\"__codelineno-7-253\" name=\"__codelineno-7-253\" href=\"#__codelineno-7-253\"></a>                      [  - DecompressTagged@../../src/codegen/arm64/macro-assembler-arm64.cc:3448\n</span><span id=\"__span-7-254\"><a id=\"__codelineno-7-254\" name=\"__codelineno-7-254\" href=\"#__codelineno-7-254\"></a>0xc6ccfe4a8c28   128  d28bd170       movz x16, #0x5e8b\n</span><span id=\"__span-7-255\"><a id=\"__codelineno-7-255\" name=\"__codelineno-7-255\" href=\"#__codelineno-7-255\"></a>0xc6ccfe4a8c2c   12c  b8706821       ldr w1, [x1, x16]\n</span><span id=\"__span-7-256\"><a id=\"__codelineno-7-256\" name=\"__codelineno-7-256\" href=\"#__codelineno-7-256\"></a>0xc6ccfe4a8c30   130  8b010381       add x1, x28, x1\n</span><span id=\"__span-7-257\"><a id=\"__codelineno-7-257\" name=\"__codelineno-7-257\" href=\"#__codelineno-7-257\"></a>                      ]\n</span><span id=\"__span-7-258\"><a id=\"__codelineno-7-258\" name=\"__codelineno-7-258\" href=\"#__codelineno-7-258\"></a>                    ]\n</span><span id=\"__span-7-259\"><a id=\"__codelineno-7-259\" name=\"__codelineno-7-259\" href=\"#__codelineno-7-259\"></a>                    [ Frame: NO_FRAME_TYPE\n</span><span id=\"__span-7-260\"><a id=\"__codelineno-7-260\" name=\"__codelineno-7-260\" href=\"#__codelineno-7-260\"></a>                      [ Inlined  Trampoline for call to AbortCSADcheck - CallBuiltin@../../src/codegen/arm64/macro-assembler-arm64.cc:2391\n</span><span id=\"__span-7-261\"><a id=\"__codelineno-7-261\" name=\"__codelineno-7-261\" href=\"#__codelineno-7-261\"></a>0xc6ccfe4a8c34   134  96a4e10b       bl #-0x56c7bd4 (addr 0xc6ccf8de1060)    ;; code: Builtin::AbortCSADcheck\n</span><span id=\"__span-7-262\"><a id=\"__codelineno-7-262\" name=\"__codelineno-7-262\" href=\"#__codelineno-7-262\"></a>                      ]\n</span><span id=\"__span-7-263\"><a id=\"__codelineno-7-263\" name=\"__codelineno-7-263\" href=\"#__codelineno-7-263\"></a>                    ]\n</span><span id=\"__span-7-264\"><a id=\"__codelineno-7-264\" name=\"__codelineno-7-264\" href=\"#__codelineno-7-264\"></a>0xc6ccfe4a8c38   138  d4200000       brk #0x0\n</span><span id=\"__span-7-265\"><a id=\"__codelineno-7-265\" name=\"__codelineno-7-265\" href=\"#__codelineno-7-265\"></a>0xc6ccfe4a8c3c   13c  d4200000       brk #0x0\n</span><span id=\"__span-7-266\"><a id=\"__codelineno-7-266\" name=\"__codelineno-7-266\" href=\"#__codelineno-7-266\"></a>0xc6ccfe4a8c40   140  d503201f       nop\n</span><span id=\"__span-7-267\"><a id=\"__codelineno-7-267\" name=\"__codelineno-7-267\" href=\"#__codelineno-7-267\"></a>                  ;;; Safepoint table. - Emit@../../src/codegen/safepoint-table.cc:187\n</span><span id=\"__span-7-268\"><a id=\"__codelineno-7-268\" name=\"__codelineno-7-268\" href=\"#__codelineno-7-268\"></a>                  ]\n</span><span id=\"__span-7-269\"><a id=\"__codelineno-7-269\" name=\"__codelineno-7-269\" href=\"#__codelineno-7-269\"></a>\n</span><span id=\"__span-7-270\"><a id=\"__codelineno-7-270\" name=\"__codelineno-7-270\" href=\"#__codelineno-7-270\"></a>External Source positions:\n</span><span id=\"__span-7-271\"><a id=\"__codelineno-7-271\" name=\"__codelineno-7-271\" href=\"#__codelineno-7-271\"></a> pc offset  fileid  line\n</span><span id=\"__span-7-272\"><a id=\"__codelineno-7-272\" name=\"__codelineno-7-272\" href=\"#__codelineno-7-272\"></a>        b4       380        72\n</span><span id=\"__span-7-273\"><a id=\"__codelineno-7-273\" name=\"__codelineno-7-273\" href=\"#__codelineno-7-273\"></a>\n</span><span id=\"__span-7-274\"><a id=\"__codelineno-7-274\" name=\"__codelineno-7-274\" href=\"#__codelineno-7-274\"></a>\n</span><span id=\"__span-7-275\"><a id=\"__codelineno-7-275\" name=\"__codelineno-7-275\" href=\"#__codelineno-7-275\"></a>Safepoints (entries = 2, byte size = 12)\n</span><span id=\"__span-7-276\"><a id=\"__codelineno-7-276\" name=\"__codelineno-7-276\" href=\"#__codelineno-7-276\"></a>0xc6ccfe4a8b7c     7c  slots (sp-&gt;fp): 01001000\n</span><span id=\"__span-7-277\"><a id=\"__codelineno-7-277\" name=\"__codelineno-7-277\" href=\"#__codelineno-7-277\"></a>0xc6ccfe4a8ba8     a8  slots (sp-&gt;fp): 00001000\n</span><span id=\"__span-7-278\"><a id=\"__codelineno-7-278\" name=\"__codelineno-7-278\" href=\"#__codelineno-7-278\"></a>\n</span><span id=\"__span-7-279\"><a id=\"__codelineno-7-279\" name=\"__codelineno-7-279\" href=\"#__codelineno-7-279\"></a>RelocInfo (size = 3)\n</span><span id=\"__span-7-280\"><a id=\"__codelineno-7-280\" name=\"__codelineno-7-280\" href=\"#__codelineno-7-280\"></a>0xc6ccfe4a8c34  code target (BUILTIN AbortCSADcheck)  (0xc6ccf8de1060)\n</span></code></pre></div>\n<p>\u4e3a\u4e86\u7b80\u5316\u4ee3\u7801\uff0c\u5173\u95ed\u4e86 control flow integrity \u76f8\u5173\u7684\u4ee3\u7801\u751f\u6210\uff0c\u5177\u4f53\u65b9\u6cd5\u662f\u8fd0\u884c <code>gn args out/arm64.optdebug</code>\uff0c\u8ffd\u52a0\u4e00\u884c <code>v8_control_flow_integrity = false</code>\uff0c\u518d\u91cd\u65b0 <code>autoninja -C out/arm64.optdebug d8</code>\u3002</p>\n<p>\u4ee5\u4e0a\u662f debug \u6a21\u5f0f\u4e0b\u751f\u6210\u7684\u4ee3\u7801\uff0c\u591a\u4e86\u5f88\u591a\u68c0\u67e5\uff1b\u5982\u679c\u5728 release \u6a21\u5f0f\u4e0b\uff0c\u53ef\u4ee5\u89c2\u5bdf\u5230\u66f4\u4f18\u7684\u6307\u4ee4\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a>kind = BYTECODE_HANDLER\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a>name = LdaSmi\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a>compiler = turbofan\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a>address = 0x31a000462bd\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a>\n</span><span id=\"__span-8-6\"><a id=\"__codelineno-8-6\" name=\"__codelineno-8-6\" href=\"#__codelineno-8-6\"></a>Instructions (size = 80)\n</span><span id=\"__span-8-7\"><a id=\"__codelineno-8-7\" name=\"__codelineno-8-7\" href=\"#__codelineno-8-7\"></a># \u4ece\u8fd9\u91cc\u5f00\u59cb\u5b9e\u73b0 LdaSmi \u7684\u8bed\u4e49\n</span><span id=\"__span-8-8\"><a id=\"__codelineno-8-8\" name=\"__codelineno-8-8\" href=\"#__codelineno-8-8\"></a># \u8ba1\u7b97 x19 + 1 \u7684\u503c\u5e76\u5199\u5165 x1\uff0c\u5f97\u5230 LdaSmi \u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\u76f8\u5bf9 bytecode array \u7684\u504f\u79fb\n</span><span id=\"__span-8-9\"><a id=\"__codelineno-8-9\" name=\"__codelineno-8-9\" href=\"#__codelineno-8-9\"></a>0xc903f8193400     0  91000661       add x1, x19, #0x1 (1)\n</span><span id=\"__span-8-10\"><a id=\"__codelineno-8-10\" name=\"__codelineno-8-10\" href=\"#__codelineno-8-10\"></a># \u4ece x20 + x1 \u5730\u5740\u8bfb\u53d6 LdaSmi \u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5230 x1\uff0c\u4e5f\u5c31\u662f\u8981\u52a0\u8f7d\u5230 `accumulator` \u7684\u503c\uff0c\n</span><span id=\"__span-8-11\"><a id=\"__codelineno-8-11\" name=\"__codelineno-8-11\" href=\"#__codelineno-8-11\"></a># \u4e4b\u540e x1 \u7684\u503c\u4f1a\u5199\u5165\u5230 x0\uff0c\u4e5f\u5c31\u662f `accumulator` \u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\n</span><span id=\"__span-8-12\"><a id=\"__codelineno-8-12\" name=\"__codelineno-8-12\" href=\"#__codelineno-8-12\"></a>0xc903f8193404     4  38e16a81       ldrsb w1, [x20, x1]\n</span><span id=\"__span-8-13\"><a id=\"__codelineno-8-13\" name=\"__codelineno-8-13\" href=\"#__codelineno-8-13\"></a>\n</span><span id=\"__span-8-14\"><a id=\"__codelineno-8-14\" name=\"__codelineno-8-14\" href=\"#__codelineno-8-14\"></a># Dispatch: \u627e\u5230\u4e0b\u4e00\u4e2a Opcode \u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5165\u53e3\uff0c\u7136\u540e\u8df3\u8f6c\u8fc7\u53bb\n</span><span id=\"__span-8-15\"><a id=\"__codelineno-8-15\" name=\"__codelineno-8-15\" href=\"#__codelineno-8-15\"></a># x19 = x19 + 2\uff0c\u5c31\u662f bytecode offset \u524d\u8fdb\u4e24\u4e2a\u5b57\u8282\uff0c\u6307\u5411\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\n</span><span id=\"__span-8-16\"><a id=\"__codelineno-8-16\" name=\"__codelineno-8-16\" href=\"#__codelineno-8-16\"></a>0xc903f8193408     8  91000a73       add x19, x19, #0x2 (2)\n</span><span id=\"__span-8-17\"><a id=\"__codelineno-8-17\" name=\"__codelineno-8-17\" href=\"#__codelineno-8-17\"></a># x20 \u662f bytecode array\uff0c\u4ece bytecode array \u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5230 x3 \u5bc4\u5b58\u5668\n</span><span id=\"__span-8-18\"><a id=\"__codelineno-8-18\" name=\"__codelineno-8-18\" href=\"#__codelineno-8-18\"></a>0xc903f819340c     c  38736a83       ldrb w3, [x20, x19]\n</span><span id=\"__span-8-19\"><a id=\"__codelineno-8-19\" name=\"__codelineno-8-19\" href=\"#__codelineno-8-19\"></a>\n</span><span id=\"__span-8-20\"><a id=\"__codelineno-8-20\" name=\"__codelineno-8-20\" href=\"#__codelineno-8-20\"></a># \u8ba1\u7b97 x4 = x3 * 8\uff0c\u4e5f\u5c31\u662f dispatch table \u4e2d\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u5730\u5740\u7684\u5b57\u8282\u504f\u79fb\n</span><span id=\"__span-8-21\"><a id=\"__codelineno-8-21\" name=\"__codelineno-8-21\" href=\"#__codelineno-8-21\"></a>0xc903f8193410    10  d37df064       lsl x4, x3, #3\n</span><span id=\"__span-8-22\"><a id=\"__codelineno-8-22\" name=\"__codelineno-8-22\" href=\"#__codelineno-8-22\"></a># \u628a\u4e4b\u524d LdaSmi \u8ba1\u7b97\u5f97\u5230\u7684 x1 \u5bc4\u5b58\u5668\u5199\u5230 `accumulator` \u5373 x0 \u5bc4\u5b58\u5668\u5f53\u4e2d\n</span><span id=\"__span-8-23\"><a id=\"__codelineno-8-23\" name=\"__codelineno-8-23\" href=\"#__codelineno-8-23\"></a># \u8fd9\u91cc x0 = 2 * x1\uff0c\u662f\u56e0\u4e3a v8 \u7528\u6700\u4f4e\u4f4d\u8868\u793a\u8fd9\u662f\u4e00\u4e2a Smi\uff08\u7528 0 \u8868\u793a\uff09\u8fd8\u662f\u4e00\u4e2a\u6307\u9488\uff08\u7528 1 \u8868\u793a\uff09\n</span><span id=\"__span-8-24\"><a id=\"__codelineno-8-24\" name=\"__codelineno-8-24\" href=\"#__codelineno-8-24\"></a>0xc903f8193414    14  0b010020       add w0, w1, w1\n</span><span id=\"__span-8-25\"><a id=\"__codelineno-8-25\" name=\"__codelineno-8-25\" href=\"#__codelineno-8-25\"></a># \u5982\u679c x3 \u5bc4\u5b58\u5668\u5927\u4e8e\u6216\u7b49\u4e8e 187\uff0c\u8bf4\u660e\u8fd9\u4e2a\u5b57\u8282\u7801\u53ef\u80fd\u662f Short Star \u5b57\u8282\u7801\uff0c\u5c31\u8df3\u8f6c\u5230\u540e\u9762\u7684 0xc903f819342c \u5730\u5740\n</span><span id=\"__span-8-26\"><a id=\"__codelineno-8-26\" name=\"__codelineno-8-26\" href=\"#__codelineno-8-26\"></a>0xc903f8193418    18  7102ec7f       cmp w3, #0xbb (187)\n</span><span id=\"__span-8-27\"><a id=\"__codelineno-8-27\" name=\"__codelineno-8-27\" href=\"#__codelineno-8-27\"></a>0xc903f819341c    1c  54000082       b.hs #+0x10 (addr 0xc903f819342c)\n</span><span id=\"__span-8-28\"><a id=\"__codelineno-8-28\" name=\"__codelineno-8-28\" href=\"#__codelineno-8-28\"></a># \u5982\u679c\u6ca1\u6709\u8df3\u8f6c\uff0c\u6b64\u65f6 x3 \u5bc4\u5b58\u5668\u5c0f\u4e8e 187\n</span><span id=\"__span-8-29\"><a id=\"__codelineno-8-29\" name=\"__codelineno-8-29\" href=\"#__codelineno-8-29\"></a># \u4ece dispatch table\uff0c\u4ee5 x3 \u4e3a\u4e0b\u6807\uff08x4 = x3 * 8\uff09\uff0c\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-8-30\"><a id=\"__codelineno-8-30\" name=\"__codelineno-8-30\" href=\"#__codelineno-8-30\"></a>0xc903f8193420    20  f8646aa2       ldr x2, [x21, x4]\n</span><span id=\"__span-8-31\"><a id=\"__codelineno-8-31\" name=\"__codelineno-8-31\" href=\"#__codelineno-8-31\"></a># \u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-8-32\"><a id=\"__codelineno-8-32\" name=\"__codelineno-8-32\" href=\"#__codelineno-8-32\"></a>0xc903f8193424    24  aa0203f1       mov x17, x2\n</span><span id=\"__span-8-33\"><a id=\"__codelineno-8-33\" name=\"__codelineno-8-33\" href=\"#__codelineno-8-33\"></a>0xc903f8193428    28  d61f0220       br x17\n</span><span id=\"__span-8-34\"><a id=\"__codelineno-8-34\" name=\"__codelineno-8-34\" href=\"#__codelineno-8-34\"></a>\n</span><span id=\"__span-8-35\"><a id=\"__codelineno-8-35\" name=\"__codelineno-8-35\" href=\"#__codelineno-8-35\"></a># \u5b9e\u73b0 Short Star \u5b57\u8282\u7801\n</span><span id=\"__span-8-36\"><a id=\"__codelineno-8-36\" name=\"__codelineno-8-36\" href=\"#__codelineno-8-36\"></a># \u8ba1\u7b97\u51fa\u8981\u5199\u5165\u7684 r0-r15 \u5bc4\u5b58\u5668\u76f8\u5bf9 fp \u7684\u504f\u79fb\u91cf x3 * 8 - 1672\n</span><span id=\"__span-8-37\"><a id=\"__codelineno-8-37\" name=\"__codelineno-8-37\" href=\"#__codelineno-8-37\"></a># \u8fd9\u4e2a\u504f\u79fb\u91cf\u7684\u8ba1\u7b97\u516c\u5f0f\u5728\u524d\u9762\u63a8\u5bfc\u8fc7\uff0c\u6b64\u65f6 x4 \u7b49\u4e8e x3 * 8\n</span><span id=\"__span-8-38\"><a id=\"__codelineno-8-38\" name=\"__codelineno-8-38\" href=\"#__codelineno-8-38\"></a>0xc903f819342c    2c  d11a2081       sub x1, x4, #0x688 (1672)\n</span><span id=\"__span-8-39\"><a id=\"__codelineno-8-39\" name=\"__codelineno-8-39\" href=\"#__codelineno-8-39\"></a>0xc903f8193430    30  aa1d03e3       mov x3, fp\n</span><span id=\"__span-8-40\"><a id=\"__codelineno-8-40\" name=\"__codelineno-8-40\" href=\"#__codelineno-8-40\"></a># \u628a `accumulator` \u5199\u5165\u5230\u76f8\u5bf9 fp \u7684\u5bf9\u5e94\u4f4d\u7f6e\n</span><span id=\"__span-8-41\"><a id=\"__codelineno-8-41\" name=\"__codelineno-8-41\" href=\"#__codelineno-8-41\"></a>0xc903f8193434    34  f8216860       str x0, [x3, x1]\n</span><span id=\"__span-8-42\"><a id=\"__codelineno-8-42\" name=\"__codelineno-8-42\" href=\"#__codelineno-8-42\"></a>\n</span><span id=\"__span-8-43\"><a id=\"__codelineno-8-43\" name=\"__codelineno-8-43\" href=\"#__codelineno-8-43\"></a># \u4e0b\u9762\u5c31\u662f Dispatch \u903b\u8f91\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21\u662f\u6267\u884c\u5b8c Short Star \u5b57\u8282\u7801\u540e\u7684 Dispatch\n</span><span id=\"__span-8-44\"><a id=\"__codelineno-8-44\" name=\"__codelineno-8-44\" href=\"#__codelineno-8-44\"></a># x19 = x19 + 1\uff0c\u5c31\u662f bytecode offset \u524d\u8fdb\u4e00\u4e2a\u5b57\u8282\uff0c\u6307\u5411\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\n</span><span id=\"__span-8-45\"><a id=\"__codelineno-8-45\" name=\"__codelineno-8-45\" href=\"#__codelineno-8-45\"></a>0xc903f8193438    38  91000673       add x19, x19, #0x1 (1)\n</span><span id=\"__span-8-46\"><a id=\"__codelineno-8-46\" name=\"__codelineno-8-46\" href=\"#__codelineno-8-46\"></a># x20 \u662f bytecode array\uff0c\u4ece bytecode array \u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5230 x1 \u5bc4\u5b58\u5668\n</span><span id=\"__span-8-47\"><a id=\"__codelineno-8-47\" name=\"__codelineno-8-47\" href=\"#__codelineno-8-47\"></a>0xc903f819343c    3c  38736a81       ldrb w1, [x20, x19]\n</span><span id=\"__span-8-48\"><a id=\"__codelineno-8-48\" name=\"__codelineno-8-48\" href=\"#__codelineno-8-48\"></a># \u4ece dispatch table\uff0c\u4ee5 x1 \u4e3a\u4e0b\u6807\uff0c\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-8-49\"><a id=\"__codelineno-8-49\" name=\"__codelineno-8-49\" href=\"#__codelineno-8-49\"></a>0xc903f8193440    40  f8617aa2       ldr x2, [x21, x1, lsl #3]\n</span><span id=\"__span-8-50\"><a id=\"__codelineno-8-50\" name=\"__codelineno-8-50\" href=\"#__codelineno-8-50\"></a># \u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-8-51\"><a id=\"__codelineno-8-51\" name=\"__codelineno-8-51\" href=\"#__codelineno-8-51\"></a>0xc903f8193444    44  aa0203f1       mov x17, x2\n</span><span id=\"__span-8-52\"><a id=\"__codelineno-8-52\" name=\"__codelineno-8-52\" href=\"#__codelineno-8-52\"></a>0xc903f8193448    48  d61f0220       br x17\n</span><span id=\"__span-8-53\"><a id=\"__codelineno-8-53\" name=\"__codelineno-8-53\" href=\"#__codelineno-8-53\"></a>0xc903f819344c    4c  d503201f       nop\n</span></code></pre></div>\n<p>\u53ef\u89c1 release \u6a21\u5f0f\u4e0b\u7684\u4ee3\u7801\u8fd8\u662f\u7b80\u5355\u4e86\u8bb8\u591a\uff0c\u4fdd\u8bc1\u4e86\u6027\u80fd\u3002</p>\n<p>\u6709\u7684 Opcode \u540e\u9762\u4e0d\u4f1a\u7d27\u63a5\u7740\u51fa\u73b0 Short Star\uff0c\u6b64\u65f6 Dispatch \u4f1a\u51cf\u5c11\u4e00\u6b21\u7279\u5224\uff0c\u4ee3\u7801\u66f4\u52a0\u7b80\u5355\uff0c\u4ee5 <code>Ldar</code> \u4e3a\u4f8b\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a>kind = BYTECODE_HANDLER\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a>name = Ldar\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a>compiler = turbofan\n</span><span id=\"__span-9-4\"><a id=\"__codelineno-9-4\" name=\"__codelineno-9-4\" href=\"#__codelineno-9-4\"></a>address = 0x31a00046245\n</span><span id=\"__span-9-5\"><a id=\"__codelineno-9-5\" name=\"__codelineno-9-5\" href=\"#__codelineno-9-5\"></a>\n</span><span id=\"__span-9-6\"><a id=\"__codelineno-9-6\" name=\"__codelineno-9-6\" href=\"#__codelineno-9-6\"></a>Instructions (size = 44)\n</span><span id=\"__span-9-7\"><a id=\"__codelineno-9-7\" name=\"__codelineno-9-7\" href=\"#__codelineno-9-7\"></a># Ldar \u7684\u8bed\u4e49\u662f\uff0c\u628a\u6307\u5b9a\u53c2\u6570\u5bc4\u5b58\u5668\u7684\u503c\u5199\u5165\u5230 `accumulator` \u5f53\u4e2d\n</span><span id=\"__span-9-8\"><a id=\"__codelineno-9-8\" name=\"__codelineno-9-8\" href=\"#__codelineno-9-8\"></a># \u53c2\u6570\u5bc4\u5b58\u5668\u7684\u4f4d\u7f6e\u8bb0\u5f55\u5728 Ldar \u5b57\u8282\u7801\u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\u4e2d\n</span><span id=\"__span-9-9\"><a id=\"__codelineno-9-9\" name=\"__codelineno-9-9\" href=\"#__codelineno-9-9\"></a># \u5982\uff1a0b 04 \u5bf9\u5e94 Ldar a1\n</span><span id=\"__span-9-10\"><a id=\"__codelineno-9-10\" name=\"__codelineno-9-10\" href=\"#__codelineno-9-10\"></a># \u8ba1\u7b97 x19 + 1 \u7684\u503c\u5e76\u5199\u5165 x1\uff0c\u5f97\u5230 Ldar \u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\u76f8\u5bf9 bytecode array \u7684\u504f\u79fb\n</span><span id=\"__span-9-11\"><a id=\"__codelineno-9-11\" name=\"__codelineno-9-11\" href=\"#__codelineno-9-11\"></a>0xc903f8193320     0  91000661       add x1, x19, #0x1 (1)\n</span><span id=\"__span-9-12\"><a id=\"__codelineno-9-12\" name=\"__codelineno-9-12\" href=\"#__codelineno-9-12\"></a># \u4ece x20 + x1 \u5730\u5740\u8bfb\u53d6 Ldar \u7684\u7b2c\u4e8c\u4e2a\u5b57\u8282\u5230 x1\uff0c\u4e5f\u5c31\u662f\u53c2\u6570\u5bc4\u5b58\u5668\u76f8\u5bf9 fp \u7684\u4e0b\u6807\n</span><span id=\"__span-9-13\"><a id=\"__codelineno-9-13\" name=\"__codelineno-9-13\" href=\"#__codelineno-9-13\"></a>0xc903f8193324     4  38a16a81       ldrsb x1, [x20, x1]\n</span><span id=\"__span-9-14\"><a id=\"__codelineno-9-14\" name=\"__codelineno-9-14\" href=\"#__codelineno-9-14\"></a># \u76f8\u5bf9 fp \u4ee5 x1 \u4e3a\u4e0b\u6807\uff0c\u8bfb\u53d6\u53c2\u6570\u5bc4\u5b58\u5668\u7684\u503c\u5230 x1 \u5bc4\u5b58\u5668\n</span><span id=\"__span-9-15\"><a id=\"__codelineno-9-15\" name=\"__codelineno-9-15\" href=\"#__codelineno-9-15\"></a>0xc903f8193328     8  aa1d03e3       mov x3, fp\n</span><span id=\"__span-9-16\"><a id=\"__codelineno-9-16\" name=\"__codelineno-9-16\" href=\"#__codelineno-9-16\"></a>0xc903f819332c     c  f8617861       ldr x1, [x3, x1, lsl #3]\n</span><span id=\"__span-9-17\"><a id=\"__codelineno-9-17\" name=\"__codelineno-9-17\" href=\"#__codelineno-9-17\"></a># Dispatch: \u627e\u5230\u4e0b\u4e00\u4e2a Opcode \u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5165\u53e3\uff0c\u7136\u540e\u8df3\u8f6c\u8fc7\u53bb\n</span><span id=\"__span-9-18\"><a id=\"__codelineno-9-18\" name=\"__codelineno-9-18\" href=\"#__codelineno-9-18\"></a># x19 = x19 + 2\uff0c\u5c31\u662f bytecode offset \u524d\u8fdb\u4e24\u4e2a\u5b57\u8282\uff0c\u6307\u5411\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\n</span><span id=\"__span-9-19\"><a id=\"__codelineno-9-19\" name=\"__codelineno-9-19\" href=\"#__codelineno-9-19\"></a>0xc903f8193330    10  91000a73       add x19, x19, #0x2 (2)\n</span><span id=\"__span-9-20\"><a id=\"__codelineno-9-20\" name=\"__codelineno-9-20\" href=\"#__codelineno-9-20\"></a># x20 \u662f bytecode array\uff0c\u4ece bytecode array \u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5230 x3 \u5bc4\u5b58\u5668\n</span><span id=\"__span-9-21\"><a id=\"__codelineno-9-21\" name=\"__codelineno-9-21\" href=\"#__codelineno-9-21\"></a>0xc903f8193334    14  38736a83       ldrb w3, [x20, x19]\n</span><span id=\"__span-9-22\"><a id=\"__codelineno-9-22\" name=\"__codelineno-9-22\" href=\"#__codelineno-9-22\"></a># \u4ece dispatch table\uff0c\u4ee5 x3 \u4e3a\u4e0b\u6807\uff0c\u8bfb\u53d6\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-9-23\"><a id=\"__codelineno-9-23\" name=\"__codelineno-9-23\" href=\"#__codelineno-9-23\"></a>0xc903f8193338    18  f8637aa2       ldr x2, [x21, x3, lsl #3]\n</span><span id=\"__span-9-24\"><a id=\"__codelineno-9-24\" name=\"__codelineno-9-24\" href=\"#__codelineno-9-24\"></a># \u628a\u53c2\u6570\u5bc4\u5b58\u5668\u7684\u503c\u5199\u5165\u5230 `accumulator` \u4e5f\u5c31\u662f x0 \u5f53\u4e2d\n</span><span id=\"__span-9-25\"><a id=\"__codelineno-9-25\" name=\"__codelineno-9-25\" href=\"#__codelineno-9-25\"></a>0xc903f819333c    1c  aa0103e0       mov x0, x1\n</span><span id=\"__span-9-26\"><a id=\"__codelineno-9-26\" name=\"__codelineno-9-26\" href=\"#__codelineno-9-26\"></a># \u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740\n</span><span id=\"__span-9-27\"><a id=\"__codelineno-9-27\" name=\"__codelineno-9-27\" href=\"#__codelineno-9-27\"></a>0xc903f8193340    20  aa0203f1       mov x17, x2\n</span><span id=\"__span-9-28\"><a id=\"__codelineno-9-28\" name=\"__codelineno-9-28\" href=\"#__codelineno-9-28\"></a>0xc903f8193344    24  d61f0220       br x17\n</span><span id=\"__span-9-29\"><a id=\"__codelineno-9-29\" name=\"__codelineno-9-29\" href=\"#__codelineno-9-29\"></a>0xc903f8193348    28  d503201f       nop\n</span></code></pre></div>\n<p>\u5c0f\u7ed3\u4e00\u4e0b\uff1a</p>\n<ol>\n<li>Ignition \u7ed9\u6bcf\u79cd\u53ef\u80fd\u7684 Opcode \u7c7b\u578b\u751f\u6210\u4e00\u6bb5\u4ee3\u7801</li>\n<li>\u8fd9\u6bb5\u4ee3\u7801\u4f1a\u8fdb\u884c\u4e00\u4e9b\u68c0\u67e5\uff08\u4ec5 Debug \u6a21\u5f0f\u4e0b\uff09\uff0c\u7136\u540e\u5728\u6c47\u7f16\u91cc\u5b9e\u73b0\u8fd9\u4e2a\u5b57\u8282\u7801\u7684\u529f\u80fd</li>\n<li>\u6267\u884c\u5b8c\u5b57\u8282\u7801\u540e\uff0c\u8fdb\u5165 Dispatch \u903b\u8f91\uff0c\u5bfb\u627e\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740</li>\n<li>\u7279\u522b\u5730\uff0c\u5982\u679c\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u662f Short Star (Star0-Star15)\uff0c\u56e0\u4e3a\u5b83\u6bd4\u8f83\u7b80\u5355\u548c\u5e38\u89c1\uff0c\u5c31\u76f4\u63a5\u6267\u884c\u5b83\uff0c\u6267\u884c\u5b8c\u518d\u91cd\u65b0\u5bfb\u627e\u518d\u4e0b\u4e00\u4e2a\u5b57\u8282\u7801\u5bf9\u5e94\u7684\u4ee3\u7801\u7684\u5730\u5740</li>\n<li>\u8fd9\u4e9b Opcode \u5bf9\u5e94\u7684\u4ee3\u7801\u4f1a\u5728 v8 \u7f16\u8bd1\u8fc7\u7a0b\u4e2d\u901a\u8fc7 <code>mksnapshot</code> \u547d\u4ee4\u4e00\u6b21\u6027\u751f\u6210\u597d\uff0c\u8fd0\u884c\u65f6\u76f4\u63a5\u590d\u7528\uff0c\u4e0d\u7528\u91cd\u65b0\u751f\u6210</li>\n<li>V8 \u7684\u503c\u7684\u6700\u4f4e\u4f4d\u6807\u8bc6\u4e86\u5b83\u7684\u7c7b\u578b\uff1a0 \u8868\u793a Smi\uff0c1 \u8868\u793a\u6307\u9488\uff0c\u56e0\u6b64\u5728\u5b58\u50a8 Smi \u7684\u65f6\u5019\uff0c\u5bc4\u5b58\u5668\u91cc\u4fdd\u5b58\u7684\u662f\u5b9e\u9645\u503c\u7684\u4e24\u500d\uff0c\u8fd9\u6837\u6700\u4f4e\u4f4d\u5c31\u662f 0</li>\n</ol>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://v8.dev/blog/ignition-interpreter\">Firing up the Ignition interpreter</a></li>\n<li><a href=\"https://stackoverflow.com/questions/73337772/how-to-get-node-js-to-trace-ignition-within-v8-with-trace-ignition\">How to get Node.js to trace ignition within v8? with --trace-ignition</a></li>\n<li><a href=\"https://dynamic-languages-symposium.org/dls-16/program/media/McIlroy_2016_IgnitionJumpStartingAnInterpreterForV8_Dls.pdf\">Ignition: Jump-starting an Interpreter for V8</a></li>\n<li><a href=\"https://docs.google.com/document/d/11T2CRex9hXxoJwbYqVQ32yIPMh0uouUZLdyrtmMoL44\">Ignition: V8 Interpreter</a></li>\n<li><a href=\"https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/\">Introduction to TurboFan</a></li>\n<li><a href=\"https://www.alibabacloud.com/blog/javascript-bytecode-v8-ignition-instructions_599188\">JavaScript Bytecode \u2013 v8 Ignition Instructions</a></li>\n<li><a href=\"https://medium.com/dailyjs/understanding-v8s-bytecode-317d46c94775\">Understanding V8\u2019s Bytecode</a></li>\n<li><a href=\"Documentation\">V8 Documentation</a></li>\n<li><a href=\"https://v8.dev/docs/ignition\">V8 Ignition</a></li>\n<li><a href=\"https://v8.dev/docs/turbofan\">V8 TurboFan</a></li>\n<li><a href=\"https://v8.github.io/tools/v13.4/turbolizer/index.html\">V8 Turbolizer v13.4</a></li>\n<li><a href=\"https://benediktmeurer.de/2017/03/01/v8-behind-the-scenes-february-edition\">V8: Behind the Scenes (February Edition feat. A tale of TurboFan)</a></li>\n<li><a href=\"https://github.com/danbev/learning-v8\">danbev/learning-v8</a></li>\n<li><a href=\"https://medium.com/fhinkel/v8-internals-how-small-is-a-small-integer-e0badc18b6da\">V8 Internals: How Small is a \u201cSmall Integer?\u201d</a></li>\n</ul>", "image": null, "date_modified": "2025-03-01T00:00:00+00:00", "authors": [], "tags": ["aot", "javascript", "jit", "js", "linux", "software", "v8"]}, {"id": "https://jia.je/software/2025/02/04/feishu-dump-calendar/", "url": "https://jia.je/software/2025/02/04/feishu-dump-calendar/", "title": "\u5bfc\u51fa\u98de\u4e66\u65e5\u5386\u4e3a iCalendar \u683c\u5f0f", "content_html": "<h1 id=\"\u5bfc\u51fa\u98de\u4e66\u65e5\u5386\u4e3a-icalendar-\u683c\u5f0f\">\u5bfc\u51fa\u98de\u4e66\u65e5\u5386\u4e3a iCalendar \u683c\u5f0f<a class=\"headerlink\" href=\"#\u5bfc\u51fa\u98de\u4e66\u65e5\u5386\u4e3a-icalendar-\u683c\u5f0f\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e4b\u524d\u7528\u4e86\u4e00\u6bb5\u65f6\u95f4\u98de\u4e66\u65e5\u5386\uff0c\u60f3\u8981\u628a\u65e5\u5386\u91cc\u7684\u4e8b\u4ef6\u5bfc\u51fa\u6765\u5907\u4efd\uff0c\u4f46\u662f\u53d1\u73b0\u98de\u4e66\u81ea\u5df1\u7684\u5bfc\u51fa\u529f\u80fd\u592a\u5f31\uff0c\u56e0\u6b64\u53c2\u8003 <a href=\"https://xuanwo.io/reports/2023-35/\">\u4ece\u98de\u4e66\u5bfc\u51fa\u65e5\u5386\u5230 Fastmail - Xuanwo's Blog</a> \u8fdb\u884c\u4e86\u5bfc\u51fa\u7684\u5c1d\u8bd5\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5bfc\u51fa\u65b9\u6cd5\">\u5bfc\u51fa\u65b9\u6cd5<a class=\"headerlink\" href=\"#\u5bfc\u51fa\u65b9\u6cd5\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0a\u9762\u63d0\u5230\u7684\u6587\u7ae0\uff0c\u662f\u901a\u8fc7 CalDAV \u7684\u65b9\u5f0f\u8fdb\u884c\u7684\u65e5\u5386\u540c\u6b65\u3002\u56e0\u6b64\u6211\u7b2c\u4e00\u6b65\u4e5f\u662f\u914d\u7f6e\u98de\u4e66\u7684 CalDAV \u670d\u52a1\uff1a</p>\n<ol>\n<li>\u6253\u5f00\u98de\u4e66\u5ba2\u6237\u7aef</li>\n<li>\u70b9\u51fb\u8bbe\u7f6e</li>\n<li>\u70b9\u51fb\u65e5\u5386</li>\n<li>\u8bbe\u7f6e CalDAV \u540c\u6b65</li>\n</ol>\n<p>\u6309\u7167\u754c\u9762\u6240\u793a\uff0c\u914d\u7f6e CalDAV \u540c\u6b65\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u7528\u4e8e CalDAV \u7684\u57df\u540d\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u4e86\u3002\u5982\u679c\u53ea\u662f\u8981\u8ba2\u9605\uff0c\u90a3\u4e48\u5230\u8fd9\u4e00\u6b65\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u7528 CalDAV \u5ba2\u6237\u7aef\u6765\u540c\u6b65\u4e86\u3002\u4f46\u6211\u60f3\u8fdb\u4e00\u6b65\u5f97\u5230 iCalendar \u683c\u5f0f\u7684\u65e5\u5386\u6587\u4ef6\u3002</p>\n<p>\u4e8e\u662f\u6211\u53c2\u8003\u4e86\u4e0a\u8ff0\u6587\u7ae0\u7684\u8bc4\u8bba\u533a\u7684\u505a\u6cd5\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>@jason5ng32 jason5ng32\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>Oct 28, 2024\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a>\u5206\u4eab\u4e00\u4e0b\u6211\u7684\u65b9\u6cd5\uff1a\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a>1. \u5728\u670d\u52a1\u5668\u4e0a\u5b89\u88c5 vdirsyncer \uff0c\u8fd9\u4e2a\u5de5\u5177\u53ef\u4ee5\u540c\u6b65 CalDAV \u7684\u5185\u5bb9\uff0c\u5728\u540c\u6b65\u8bbe\u7f6e\u91cc\uff0c\u4e0d\u9700\u8981\u5148\u627e\u5230 UUID\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528\u98de\u4e66\u63d0\u4f9b\u7684 URL\u3002\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a>2. \u5199\u4e00\u4e2a Python \u811a\u672c\uff0c\u5c06 vdirsyncer \u540c\u6b65\u7684\u5185\u5bb9\u5408\u5e76\u6210\u5355\u4e00\u7684 ics \u6587\u4ef6\u3002\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a>3. \u5c06 ics \u6587\u4ef6\u653e\u5230\u4e00\u4e2a\u5730\u5740\u7a0d\u5fae\u590d\u6742\u4e00\u70b9\u7684 http \u76ee\u5f55\u91cc\uff0c\u53ef\u4ee5\u5916\u90e8\u8bbf\u95ee\u3002\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a>4. \u5199\u4e00\u4e2a run.sh \u811a\u672c\uff0c\u901a\u8fc7 crontab \u6bcf 10 \u5206\u949f\u6267\u884c\u4e00\u6b21 vdirsyncer \u540c\u6b65\u548c\u65e5\u5386\u6587\u4ef6\u5408\u6210\u3002\n</span></code></pre></div>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u7528 vdirsyncer \u628a\u65e5\u5386\u540c\u6b65\u5230\u672c\u5730\uff0c\u518d\u8f6c\u6362\u4e3a iCalendar \u683c\u5f0f\u7684\u65e5\u5386\u6587\u4ef6\u3002\u53c2\u8003 <a href=\"https://vdirsyncer.pimutils.org/en/stable/installation.html#installation\">vdirsyncer</a> \u6587\u6863\uff0c\u8fd9\u4ef6\u4e8b\u60c5\u5e76\u4e0d\u590d\u6742\uff1a</p>\n<ol>\n<li>\u6309\u7167 vdirsyncer: <code>pip3 install vdirsyncer</code></li>\n<li>\u7f16\u8f91 <code>~/.vdirsyncer/config</code>\uff0c\u586b\u5165\u5728\u98de\u4e66\u5904\u5f97\u5230\u7684\u7528\u6237\u5bc6\u7801\uff1a\n    <div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>[general]\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>status_path = &quot;~/.vdirsyncer/status/&quot;\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>[pair my_contacts]\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>a = &quot;my_contacts_local&quot;\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>b = &quot;my_contacts_remote&quot;\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>collections = [&quot;from a&quot;, &quot;from b&quot;]\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a>[storage my_contacts_local]\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a>type = &quot;filesystem&quot;\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a>path = &quot;~/.contacts/&quot;\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a>fileext = &quot;.ics&quot;\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a>[storage my_contacts_remote]\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a>type = &quot;caldav&quot;\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a>url = &quot;https://caldav.feishu.cn&quot;\n</span><span id=\"__span-1-18\"><a id=\"__codelineno-1-18\" name=\"__codelineno-1-18\" href=\"#__codelineno-1-18\"></a>username = &quot;REDACTED&quot;\n</span><span id=\"__span-1-19\"><a id=\"__codelineno-1-19\" name=\"__codelineno-1-19\" href=\"#__codelineno-1-19\"></a>password = &quot;REDACTED&quot;\n</span></code></pre></div></li>\n<li>\u914d\u7f6e\u597d\u4ee5\u540e\uff0c\u8fdb\u884c\u540c\u6b65\uff1a<code>vdirsyncer discover &amp;&amp; vdirsyncer sync</code></li>\n</ol>\n<p>\u6b64\u65f6\u5728 <code>~/.contacts</code> \u76ee\u5f55\u4e0b\uff0c\u5df2\u7ecf\u80fd\u770b\u5230\u5f88\u591a\u4e2a ics \u6587\u4ef6\u4e86\uff0c\u6bcf\u4e2a ics \u6587\u4ef6\u5bf9\u5e94\u4e86\u65e5\u5386\u4e2d\u7684\u4e00\u4e2a\u4e8b\u4ef6\u3002\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e9b\u6587\u4ef6\u5c31\u5df2\u7ecf\u662f iCalendar \u683c\u5f0f\u4e86\uff0c\u53ea\u4e0d\u8fc7\u6bcf\u4e2a\u6587\u4ef6\u53ea\u6709\u4e00\u4e2a\u4e8b\u4ef6\u3002</p>\n<p>\u4e3a\u4e86\u8ba9\u4e00\u4e2a <code>.ics</code> \u6587\u4ef6\u5305\u62ec\u65e5\u5386\u7684\u6240\u6709\u4e8b\u4ef6\uff0c\u5199\u4e86\u4e00\u4e2a\u811a\u672c\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u5904\u7406\u6bcf\u4e2a ics \u6587\u4ef6\uff0c\u53bb\u6389\u6bcf\u4e2a\u6587\u4ef6\u5f00\u5934\u7ed3\u5c3e\u7684 <code>BEGIN:VCALENDAR</code> \u548c <code>END:VCALENDAR</code>\uff0c\u628a\u4e2d\u95f4\u7684\u90e8\u5206\u62fc\u8d77\u6765\uff0c\u6700\u540e\u518d\u52a0\u4e0a\u5f00\u5934\u7ed3\u5c3e\uff1a</p>\n<div class=\"language-python highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">sys</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"n\">all_lines</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"n\">all_lines</span> <span class=\"o\">+=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;BEGIN:VCALENDAR&quot;</span><span class=\"p\">]</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:]:</span>\n</span><span id=\"__span-2-6\"><a id=\"__codelineno-2-6\" name=\"__codelineno-2-6\" href=\"#__codelineno-2-6\"></a>    <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">()</span>\n</span><span id=\"__span-2-7\"><a id=\"__codelineno-2-7\" name=\"__codelineno-2-7\" href=\"#__codelineno-2-7\"></a>    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"n\">content</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">()</span>\n</span><span id=\"__span-2-8\"><a id=\"__codelineno-2-8\" name=\"__codelineno-2-8\" href=\"#__codelineno-2-8\"></a>    <span class=\"n\">all_lines</span> <span class=\"o\">+=</span> <span class=\"n\">lines</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span id=\"__span-2-9\"><a id=\"__codelineno-2-9\" name=\"__codelineno-2-9\" href=\"#__codelineno-2-9\"></a><span class=\"n\">all_lines</span> <span class=\"o\">+=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;END:VCALENDAR&quot;</span><span class=\"p\">]</span>\n</span><span id=\"__span-2-10\"><a id=\"__codelineno-2-10\" name=\"__codelineno-2-10\" href=\"#__codelineno-2-10\"></a><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">all_lines</span><span class=\"p\">))</span>\n</span></code></pre></div>\n<p>\u8fd0\u884c\u4e0a\u8ff0\u811a\u672c\uff1a<code>python3 dump.py ~/.contacts/*/*.ics &gt; dump.ics</code>\uff0c\u8fd9\u6837\u5f97\u5230\u7684 <code>.ics</code> \u6587\u4ef6\u5c31\u53ef\u4ee5\u76f4\u63a5\u5bfc\u5165\u5230\u65e5\u5386\u8f6f\u4ef6\u4e86\u3002</p>\n<p>UPDATE: \u6211\u5728\u4e4b\u524d\u5199\u7684\u98de\u4e66\u6587\u6863\u5907\u4efd\u5de5\u5177 <a href=\"https://github.com/jiegec/feishu-backup\">feishu-backup</a> \u7684\u57fa\u7840\u4e0a\uff0c\u6dfb\u52a0\u4e86\u98de\u4e66\u65e5\u5386\u7684\u5bfc\u51fa\u529f\u80fd\uff0c\u628a\u539f\u59cb\u7684 json \u4fdd\u5b58\u4e0b\u6765\uff0c\u5e76\u8f6c\u6362\u5f97\u5230 iCalendar \u683c\u5f0f\u7684 <code>.ics</code> \u6587\u4ef6\u3002</p>\n<h2 id=\"\u5bfc\u51fa-icloud-\u56fd\u533a\u7684\u65e5\u5386\u548c\u8054\u7cfb\u4eba\">\u5bfc\u51fa iCloud \u56fd\u533a\u7684\u65e5\u5386\u548c\u8054\u7cfb\u4eba<a class=\"headerlink\" href=\"#\u5bfc\u51fa-icloud-\u56fd\u533a\u7684\u65e5\u5386\u548c\u8054\u7cfb\u4eba\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9664\u4e86\u5bfc\u51fa\u98de\u4e66\u7684\u65e5\u5386\uff0c\u4e5f\u53ef\u4ee5\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u5bfc\u51fa iCloud \u56fd\u533a\u7684\u65e5\u5386\uff1a\u628a url \u6539\u6210 <code>\"https://caldav.icloud.com.cn\"</code>\uff0c\u5728 Apple ID \u4e0a\u751f\u6210 App \u5bc6\u7801\uff0c\u586b\u5165\u4e0a\u9762\u7684 password\uff0c\u518d\u628a\u90ae\u7bb1\u5199\u5230 username \u5373\u53ef\u3002</p>\n<p>\u66f4\u8fdb\u4e00\u6b65\uff0c\u4e5f\u53ef\u4ee5\u5bfc\u51fa iCloud \u56fd\u533a\u7684\u8054\u7cfb\u4eba\uff1a</p>\n<ol>\n<li>\u628a\u914d\u7f6e\u4e2d <code>fileext = \".ics\"</code> \u6539\u6210 <code>fileext = \".vcf\"</code>\uff0c\u56e0\u4e3a\u8054\u7cfb\u4eba\u7684\u683c\u5f0f\u662f <a href=\"https://en.wikipedia.org/wiki/VCard\">vCard</a>\uff0c\u5176\u6587\u4ef6\u540d\u540e\u7f00\u662f <code>.vcf</code></li>\n<li>\u628a <code>type = \"caldav\"</code> \u6539\u6210 <code>type = \"carddav\"</code>\uff0c\u628a <code>url = \"https://caldav.icloud.com.cn</code> \u6539\u6210 <code>url = \"https://contacts.icloud.com.cn\"</code>\uff0c\u8868\u793a\u540c\u6b65\u8054\u7cfb\u4eba\u800c\u4e0d\u662f\u65e5\u5386</li>\n</ol>\n<p>\u5982\u679c\u65e2\u8981\u540c\u6b65\u65e5\u5386\uff0c\u53c8\u8981\u540c\u6b65\u8054\u7cfb\u4eba\uff0c\u6216\u8005\u9700\u8981\u540c\u6b65\u6765\u81ea\u4e0d\u540c\u6765\u6e90\u7684\u65e5\u5386\uff0c\u5efa\u8bae\u628a status \u548c storage local \u653e\u5230\u4e0d\u540c\u7684\u76ee\u5f55\u4e0b\uff0c\u907f\u514d\u51fa\u73b0\u51b2\u7a81\u3002</p>", "image": null, "date_modified": "2025-02-04T00:00:00+00:00", "authors": [], "tags": ["calendar", "feishu", "software"]}, {"id": "https://jia.je/hardware/2025/01/12/intel_gracemont/", "url": "https://jia.je/hardware/2025/01/12/intel_gracemont/", "title": "Intel Gracemont \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"intel-gracemont-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Intel Gracemont \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#intel-gracemont-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p><a href=\"../../10/intel_golden_cove/\">\u4e4b\u524d</a> \u6d4b\u8bd5\u4e86 Intel Alder Lake \u7684 P \u6838\u5fae\u67b6\u6784\uff0c\u8fd9\u6b21\u5c31\u6765\u6d4b\u4e00\u4e0b Alder Lake \u7684 E \u6838\u5fae\u67b6\u6784 Gracemont\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel \u5173\u4e8e Gracemont \u5fae\u67b6\u6784\u6709\u8fd9\u4e9b\u5b98\u65b9\u7684\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://ieeexplore.ieee.org/document/9747991\">Intel Alder Lake CPU Architectures</a></li>\n<li><a href=\"https://hc33.hotchips.org/assets/program/conference/day1/HC2021.C1.1%20Intel%20Efraim%20Rotem.pdf\">Alder Lake Architecture on Hot Chips 33</a></li>\n<li><a href=\"https://www.intel.com/content/www/us/en/content-details/671488/intel-64-and-ia-32-architectures-optimization-reference-manual-volume-1.html\">Intel 64 and IA-32 Architectures Optimization Reference Manual Volume 1</a></li>\n</ul>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Gracemont \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://chipsandcheese.com/2021/12/21/gracemont-revenge-of-the-atom-cores/\">Gracemont: Revenge of the Atom Cores</a></li>\n<li><a href=\"https://fuse.wikichip.org/news/6102/intels-gracemont-small-core-eclipses-last-gen-big-core-performance/\">Intel\u2019s Gracemont Small Core Eclipses Last-Gen Big Core Performance</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel Gracemont \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"fetch\">Fetch<a class=\"headerlink\" href=\"#fetch\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>2x 32B/cycle</li>\n</ul>\n<p>Gracemont \u7684 Clustered Decode \u67b6\u6784\u6bd4\u8f83\u7279\u522b\uff0c\u76ee\u524d\u6ca1\u6709\u627e\u5230\u65b9\u6cd5\u53bb\u8bc1\u5b9e\u5b83\u7684 Fetch \u5e26\u5bbd\uff0c\u540e\u7eed\u5982\u679c\u627e\u5230\u4e86\u66f4\u597d\u7684\u65b9\u6cd5\uff0c\u518d\u6d4b\u8fd9\u4e2a\u7279\u6027\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>2x 3-wide</li>\n</ul>\n<p>Gracemont \u7684 Clustered Decode \u67b6\u6784\u6bd4\u8f83\u7279\u522b\uff0c\u76ee\u524d\u6ca1\u6709\u627e\u5230\u65b9\u6cd5\u53bb\u786e\u8ba4\u5b83 2x 3-wide \u7684 Decode \u5e26\u5bbd\uff0c\u540e\u7eed\u5982\u679c\u627e\u5230\u4e86\u66f4\u597d\u7684\u65b9\u6cd5\uff0c\u518d\u6d4b\u8fd9\u4e2a\u7279\u6027\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>64KB</strong></li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 4 \u5b57\u8282 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b\u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 64 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 5 IPC\uff0c\u4e4b\u540e\u5219\u964d\u5230 3.25 IPC\uff0c\u8fd9\u91cc\u7684 64 KB \u5c31\u5bf9\u5e94\u4e86 L1 ICache \u7684\u5bb9\u91cf\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>64 entries</strong>, fully associative</li>\n</ul>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 jmp \u6307\u4ee4\uff0c\u4f7f\u5f97 jmp \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_itlb_size.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 64 \u4e2a Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 64 \u7684 L1 ITLB \u5bb9\u91cf\u3002\u8fc7\u4e86\u62d0\u70b9\u540e\uff0c\u6bcf\u6b21 jmp \u7684\u65f6\u95f4\u5ef6\u957f\u5230\u4e86 16 \u4e2a\u5468\u671f\u5de6\u53f3\uff0c\u5305\u62ec\u4e86 L2 TLB \u5230 L1 ITLB \u7684 refill \u65f6\u95f4\u3002</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u7528\u4e4b\u524d\u8bbe\u8ba1\u7684 Return Stack \u6d4b\u8bd5\u4ee3\u7801\u6765\u6d4b\u8bd5 Gracemont\uff0c\u5b83\u7684 call/ret \u662f\u6210\u5bf9\u7684\uff0c\u4e5f\u5c31\u662f ret \u7684\u8fd4\u56de\u5730\u5740\u4e0d\u53d8\uff0c\u79f0\u8fd9\u4e2a\u7248\u672c\u4e3a A\u3002\u6b64\u65f6\u53d1\u73b0\u4e0d\u540c\u8c03\u7528\u6df1\u5ea6\u4e0b\uff0c\u90fd\u80fd\u505a\u5230 2 cycle \u6bcf call/ret \u5bf9\uff0c\u6ca1\u6709\u89c2\u5bdf\u5230\u6027\u80fd\u7684\u4e0b\u964d\uff0c\u8bf4\u660e\u6b64\u65f6 Return Stack \u5e76\u6ca1\u6709\u4ecb\u5165\uff0c\u5e94\u8be5\u662f\u7531 BTB \u63d0\u4f9b\u4e86\u9884\u6d4b\u3002\u4e0b\u9762\u662f A \u7248\u672c\u4ee3\u7801\u5728 Gracemont \u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_rs_size_1.png\" /></p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4fee\u6539\u4ee3\u7801\uff0c\u5728\u51fd\u6570\u91cc\u6784\u9020\u4e24\u4e2a call \u53bb\u8c03\u7528\u540c\u4e00\u4e2a\u51fd\u6570\uff0c\u8fd9\u6837 ret \u7684\u8fd4\u56de\u5730\u5740\u5c31\u4f1a\u53d8\u5316\u4e86\uff0c\u79f0\u8fd9\u4e2a\u7248\u672c\u4e3a B\u3002\u8fd9\u65f6\u5019\u8dd1\u51fa\u6765\u7684\u7ed3\u679c\u6bd4\u8f83\u5947\u602a\uff0c\u5468\u671f\u6570\u5feb\u901f\u4e0a\u5347\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_rs_size_2.png\" /></p>\n<p>\u540c\u6837\u7684 B \u7248\u672c\u4ee3\u7801\u5728 AMD Zen3 \u548c Apple Firestorm \u7684\u5904\u7406\u5668\u4e0a\uff0c\u53ef\u4ee5\u89c2\u5bdf\u5230\u5728\u7b26\u5408\u9884\u671f\u7684 Return Stack \u5927\u5c0f\u5904\u51fa\u73b0\u6027\u80fd\u62d0\u70b9\uff0c\u548c A \u7248\u672c\u4ee3\u7801\u5f97\u5230\u7684\u7ed3\u8bba\u4e00\u81f4\u3002\u800c B \u7248\u672c\u4ee3\u7801\u5728 Golden Cove \u4e0a\uff0c\u4f1a\u89c2\u5bdf\u5230\u5728 6 \u7684\u9644\u8fd1\u6709\u4e00\u4e2a\u6027\u80fd\u4e0b\u964d\u5982\u4e0b\u56fe\uff0c\u4f46\u4e4b\u524d\u7528 <a href=\"../../10/intel_golden_cove/\">A \u7248\u672c\u4ee3\u7801\u6d4b\u5f97\u7684\u62d0\u70b9\u4e3a 20</a>:</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_rs_size_golden_cove.png\" /></p>\n<p>\u8fd9\u4e2a\u533a\u522b\u80cc\u540e\u7684\u539f\u56e0\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u5206\u6790\u3002\u4e0b\u9762\u662f\u4e24\u4e2a\u7248\u672c\u7684\u6c47\u7f16\u4ee3\u7801\u7684\u5bf9\u6bd4\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\"># version A</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"nl\">func_n:</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">func_</span><span class=\"p\">{</span><span class=\"no\">n-1</span><span class=\"p\">}</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"c1\"># version B, generate two alternating call sites</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"nl\">func_n:</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"w\">    </span><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"w\">    </span><span class=\"nf\">and</span><span class=\"w\"> </span><span class=\"no\">$1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"w\">    </span><span class=\"nf\">je</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"no\">f</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">func_</span><span class=\"p\">{</span><span class=\"no\">n-1</span><span class=\"p\">}</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"w\">    </span><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"no\">f</span>\n</span><span id=\"__span-0-14\"><a id=\"__codelineno-0-14\" name=\"__codelineno-0-14\" href=\"#__codelineno-0-14\"></a>\n</span><span id=\"__span-0-15\"><a id=\"__codelineno-0-15\" name=\"__codelineno-0-15\" href=\"#__codelineno-0-15\"></a><span class=\"err\">2:</span>\n</span><span id=\"__span-0-16\"><a id=\"__codelineno-0-16\" name=\"__codelineno-0-16\" href=\"#__codelineno-0-16\"></a><span class=\"w\">    </span><span class=\"nf\">call</span><span class=\"w\"> </span><span class=\"no\">func_</span><span class=\"p\">{</span><span class=\"no\">n-1</span><span class=\"p\">}</span>\n</span><span id=\"__span-0-17\"><a id=\"__codelineno-0-17\" name=\"__codelineno-0-17\" href=\"#__codelineno-0-17\"></a><span class=\"w\">    </span><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"no\">f</span>\n</span><span id=\"__span-0-18\"><a id=\"__codelineno-0-18\" name=\"__codelineno-0-18\" href=\"#__codelineno-0-18\"></a>\n</span><span id=\"__span-0-19\"><a id=\"__codelineno-0-19\" name=\"__codelineno-0-19\" href=\"#__codelineno-0-19\"></a><span class=\"err\">3:</span>\n</span><span id=\"__span-0-20\"><a id=\"__codelineno-0-20\" name=\"__codelineno-0-20\" href=\"#__codelineno-0-20\"></a><span class=\"w\">    </span><span class=\"nf\">ret</span>\n</span></code></pre></div>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"rename\">Rename<a class=\"headerlink\" href=\"#rename\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>5-wide</strong></li>\n</ul>\n<p>\u5728\u5148\u524d\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\u7684\u65f6\u5019\uff0c\u89c2\u5bdf\u5230\u7684\u6700\u5927\u7684 IPC \u5c31\u662f 5\uff0c\u6b64\u65f6\u6d4b\u5f97\u7684\u74f6\u9888\u5728\u4e8e Rename \u5bbd\u5ea6\uff0c\u5bf9\u5e94 5-wide Rename\u3002</p>\n<h3 id=\"execution-units\">Execution Units<a class=\"headerlink\" href=\"#execution-units\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>6 alu ports: 0/1/2/3/30/31<ul>\n<li>P0: ALU/SHIFT</li>\n<li>P1: ALU/SHIFT/MUL/DIV</li>\n<li>P2: ALU/SHIFT/MUL/DIV</li>\n<li>P3: ALU/SHIFT</li>\n<li>P30: JMP</li>\n<li>P31: JMP</li>\n</ul>\n</li>\n<li>3 simd ports: 20/21/22<ul>\n<li>P20: SALU/SIMUL/FMUL/FADD/FDIV/AES/SHA</li>\n<li>P21: SALU/FMUL/FADD/AES</li>\n<li>P22: SALU</li>\n</ul>\n</li>\n<li>2 load ports: 10/11</li>\n<li>2 store address ports: 12/13</li>\n<li>2 store data ports: 8/9</li>\n<li>2 simd store data ports: 28/29</li>\n<li>ports 10/11/12/13 shares a reservation station</li>\n<li>ports 8/9/30/31 shares a reservation station</li>\n<li>ports 28/29 shares a reservation station</li>\n<li>ports 20/21/22 shares a reservation station</li>\n</ul>\n<p>\u5b9e\u6d4b\u5404\u7c7b\u6307\u4ee4\u7684\u541e\u5410\uff1a</p>\n<ul>\n<li>NOP: 5 IPC</li>\n<li>ALU: 4 IPC</li>\n</ul>\n<h3 id=\"lsu\">LSU<a class=\"headerlink\" href=\"#lsu\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>2x 16B Load/cycle, 2x 16B Store/cycle</strong></li>\n<li><strong>Load latency 3-4 cycle</strong></li>\n</ul>\n<h4 id=\"load-store-\u5e26\u5bbd\">Load Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#load-store-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>2x 128b Load</li>\n<li>2x 128b Load + 2x 128b Store</li>\n<li>2x 128b Store</li>\n<li>1x 256b Load</li>\n<li>1x 256b Load + 1x 256b Store</li>\n<li>1x 256b Store</li>\n</ul>\n<p>\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 32B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 32B/cyc\uff0c\u4e8c\u8005\u53ef\u4ee5\u540c\u65f6\u8fbe\u5230\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Loads that forward from stores can do so in the same load to use latency as cache hits for\ncases where the store's address is known, and the store data is available.</li>\n</ul>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0cGracemont \u4e0a\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>{0}</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>{0}</td>\n<td>{0}</td>\n<td>{0}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>{0}</td>\n<td>{0}</td>\n<td>{0,4}</td>\n<td>{0}</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cGracemont \u5728 Store \u5305\u542b Load \u4e14\u5730\u5740\u76f8\u540c\u65f6\u53ef\u4ee5\u8f6c\u53d1\u3002\u7279\u522b\u5730\uff0c\u9488\u5bf9 64b Store \u5230 32b Load \u8f6c\u53d1\u8fd8\u5141\u8bb8 y-x=4\u3002\u5404\u79cd\u60c5\u51b5\u4e0b\u7684 CPI\uff1a</p>\n<ul>\n<li>\u8f6c\u53d1\u6210\u529f\u65f6\uff0cCPI \u6bd4\u8f83\u590d\u6742\uff0c\u6709\u7684\u60c5\u51b5\u662f\u4ecb\u4e8e 0.5 \u5230 2 \u4e4b\u95f4\uff0c\u6709\u65f6\u5019\u53c8\u662f\u4ecb\u4e8e 2 \u5230 4 \u4e4b\u95f4\uff0c\u6709\u65f6\u5019\u662f 6</li>\n<li>\u91cd\u5408\u4f46\u4e0d\u80fd\u8f6c\u53d1\u65f6\uff0cCPI \u7b49\u4e8e 11\uff0c\u7279\u6b8a\u60c5\u51b5\u4e0b\u8fd8\u51fa\u73b0\u4e86 28.5</li>\n</ul>\n<p>\u4e0d\u652f\u6301\u591a\u4e2a Store \u5bf9\u540c\u4e00\u4e2a Load \u7684\u8f6c\u53d1\u3002\u8de8\u7f13\u5b58\u884c\u65f6\u4e0d\u80fd\u8f6c\u53d1\u3002</p>\n<p>\u5373\u4f7f Load \u548c Store \u4e0d\u91cd\u5408\uff0c\u4f46\u5728\u4e00\u5b9a\u60c5\u51b5\u4e0b\uff0c\u4e5f\u4f1a\u51fa\u73b0 CPI \u7b49\u4e8e 11 \u7684\u60c5\u51b5\uff0c\u4f8b\u5982\uff1a</p>\n<ul>\n<li>\u5bf9\u5730\u5740 3 \u7684 16b Store \u8f6c\u53d1\u5230\u5730\u5740 0 \u7684 8b Load</li>\n<li>\u5bf9\u5730\u5740 1 \u7684 64b Store \u8f6c\u53d1\u5230\u5730\u5740 9/10/11 \u7684 64b Load</li>\n<li>\u5bf9\u5730\u5740 0 \u7684 8b Store \u8f6c\u53d1\u5230\u5730\u5740 1/2/3 \u7684 64b Load</li>\n<li>\u5bf9\u5730\u5740 0 \u7684 8b Store \u8f6c\u53d1\u5230\u5730\u5740 3 \u7684 16b Load</li>\n</ul>\n<p>\u5728\u4ee5\u4e0a\u51e0\u79cd\u60c5\u51b5\u4e0b\uff0cLoad \u548c Store \u8bbf\u95ee\u8303\u56f4\u5e76\u4e0d\u91cd\u5408\uff0c\u4f46\u6027\u80fd\u548c\u8bbf\u95ee\u8303\u56f4\u91cd\u5408\u4e14\u8f6c\u53d1\u5931\u8d25\u65f6\u76f8\u540c\uff08CPI \u7b49\u4e8e 11\uff09\uff0c\u7531\u6b64\u731c\u6d4b Gracemont \u5224\u65ad\u662f\u5426\u91cd\u5408\u662f\u4ee5\u5bf9\u9f50\u7684 4B \u4e3a\u7c92\u5ea6\uff0c\u5982\u679c Load \u548c Store \u8bbf\u95ee\u4e86\u76f8\u540c\u7684\u5bf9\u9f50\u7684 4B \u5757\uff0c\u5373\u4f7f\u4e0d\u91cd\u5408\uff0c\u4e00\u5b9a\u60c5\u51b5\u4e0b\u4e5f\u53ef\u80fd\u4f1a\u88ab\u5f53\u6210\u91cd\u5408\u7684\u60c5\u51b5\u6765\u5904\u7406\uff0c\u4f46\u7531\u4e8e\u5b9e\u9645\u4e0a\u5e76\u6ca1\u6709\u91cd\u5408\uff0c\u5c31\u6ca1\u6cd5\u8f6c\u53d1\uff0c\u6027\u80fd\u5c31\u6bd4\u8f83\u5dee\u3002</p>\n<p>\u5c0f\u7ed3\uff1aGracemont \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42 st \u5b8c\u5168\u5305\u542b ld \u4e14\u5730\u5740\u76f8\u540c\u4e14\u4e0d\u80fd\u8de8\u7f13\u5b58\u884c\uff1b\u7279\u522b\u5730\uff0c64b Store \u5230 32b Load \u8f6c\u53d1\u5141\u8bb8 y-x=4</li>\n<li>1 ld + 2+ st: \u4e0d\u652f\u6301</li>\n</ul>\n<h4 id=\"load-to-use-latency\">Load to Use Latency<a class=\"headerlink\" href=\"#load-to-use-latency\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6d4b\u8bd5\u4e0d\u540c\u573a\u666f\u4e0b\u7684 Load to Use Latency\uff1a</p>\n<ul>\n<li><code>mov 0(%rsi), %rsi</code>: 3 cycle\uff0c\u4f46\u5728\u8de8\u8d8a 64B \u7f13\u5b58\u884c\u8fb9\u754c\u65f6\u9000\u5316\u5230 11 cycle</li>\n<li><code>mov 8(%rsi), %rsi</code>: 3 cycle</li>\n<li><code>mov 0(%rsp, %rsi, 8), %rsi</code>: 4 cycle</li>\n<li><code>mov 0(%rsi, %rdx, 8), %rsi</code>: 4 cycle</li>\n<li>Load to ALU Latency: 4 cycle</li>\n</ul>\n<h3 id=\"l1-dcache\">L1 DCache<a class=\"headerlink\" href=\"#l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>32KB</li>\n<li>dual ported</li>\n</ul>\n<h3 id=\"l1-dtlb\">L1 DTLB<a class=\"headerlink\" href=\"#l1-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>32 entries, fully associative</li>\n</ul>\n<p>\u7528\u7c7b\u4f3c\u6d4b L1 DCache \u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u628a pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\u3002\u5947\u602a\u7684\u662f\uff0c\u867d\u7136\u5b98\u65b9\u4fe1\u606f\u5199\u7684\u662f 32-entry \u7684 L1 DTLB\uff0c\u4f46\u662f\u5b9e\u6d4b\u5b83\u6709 48-entry\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_dtlb_size.png\" /></p>\n<p>\u8fd9\u4e2a\u89c2\u5bdf\u548c <a href=\"https://chipsandcheese.com/p/meteor-lakes-e-cores-crestmont-makes-incremental-progress\">Meteor Lake\u2019s E-Cores: Crestmont Makes Incremental Progress</a> \u662f\u4e00\u81f4\u7684\uff0c\u6000\u7591\u662f Intel \u5199\u9519\u4e86\u6570\u636e\u3002</p>\n<h3 id=\"l2-tlb\">L2 TLB<a class=\"headerlink\" href=\"#l2-tlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>4-way <strong>2048</strong> entries for 4K/2M pages</li>\n<li>fully associative 8 entries for 1GB pages</li>\n<li>4 page walkers</li>\n</ul>\n<p>\u4f7f\u7528\u7c7b\u4f3c L1 DTLB \u7684\u65b9\u5f0f\u53bb\u6d4b\u8bd5 L2 TLB\uff0c\u5728 2048 \u9644\u8fd1\u89c2\u5bdf\u5230\u4e86\u62d0\u70b9\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_l2_dtlb_size.png\" /></p>\n<p>\u8fd9\u4e2a\u7ed3\u679c\u548c\u5b98\u65b9\u6570\u636e\u662f\u543b\u5408\u7684\u3002</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>2MB/4MB Shared among 4 cores</li>\n<li>64 B/cycle shared among 4 cores</li>\n<li>17 cycle latency</li>\n</ul>\n<h3 id=\"reorder-buffer\">ReOrder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>256 entries</strong></li>\n<li>8 wide retirement</li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 ROB \u7684\u5927\u5c0f\uff0c\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5f00\u59cb\u548c\u7ed3\u675f\u662f\u957f\u5ef6\u8fdf\u7684 long latency load\u3002\u4e2d\u95f4\u662f\u82e5\u5e72\u6761 NOP \u6307\u4ee4\uff0c\u5f53 NOP \u6307\u4ee4\u6bd4\u8f83\u5c11\u65f6\uff0c\u5faa\u73af\u7684\u65f6\u5019\u53d6\u51b3\u4e8e load \u6307\u4ee4\u7684\u65f6\u95f4\uff1b\u5f53 NOP \u6307\u4ee4\u6570\u91cf\u8fc7\u591a\uff0c\u586b\u6ee1\u4e86 ROB \u4ee5\u540e\uff0c\u5c31\u4f1a\u5bfc\u81f4 ROB \u65e0\u6cd5\u4fdd\u5b58\u5faa\u73af\u672b\u5c3e\u7684 load \u6307\u4ee4\uff0c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\u3002\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_gracemont_rob_size.png\" /></p>\n<p>\u5f53 NOP \u6570\u91cf\u8fbe\u5230 256 \u65f6\uff0c\u6027\u80fd\u5f00\u59cb\u6025\u5267\u4e0b\u6ed1\uff0c\u8bf4\u660e Golden Cove \u7684 ROB \u5927\u5c0f\u662f 256\u3002</p>", "image": null, "date_modified": "2025-01-12T00:00:00+00:00", "authors": [], "tags": ["alderlake", "cpu", "gracemont", "hardware", "intel", "performance", "uarch-review"]}, {"id": "https://jia.je/hardware/2025/01/10/intel_golden_cove/", "url": "https://jia.je/hardware/2025/01/10/intel_golden_cove/", "title": "Intel Golden Cove \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"intel-golden-cove-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Intel Golden Cove \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#intel-golden-cove-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u524d\u6bb5\u65f6\u95f4\u6d4b\u8bd5\u4e86 AMD/Apple/Qualcomm/ARM \u7684\u5904\u7406\u5668\u7684\u5fae\u67b6\u6784\uff0c\u81ea\u7136\u4e0d\u80fd\u6f0f\u4e86 Intel\u3002\u867d\u7136 Intel \u5df2\u7ecf\u51fa\u4e86 Redwood Cove \u548c Lion Cove\uff0c\u4f46\u624b\u4e0a\u6ca1\u6709\u8bbe\u5907\uff0c\u800c\u4e14 Golden Cove \u4e5f\u662f\u201c\u76f8\u5bf9\u6bd4\u8f83\u6210\u529f\u201d\uff08\u201c\u7f29\u7f38\u7684\u662f Raptor Cove\uff0c\u548c\u6211 Golden Cove \u6709\u4ec0\u4e48\u5173\u7cfb\uff0c\u867d\u7136\u5176\u5b9e Raptor Cove \u662f Golden Cove Refresh\u201d\uff09\u7684\u4e00\u4ee3\u5fae\u67b6\u6784\uff0c\u7528\u5728\u4e86 Alder Lake \u548c Sapphire Rapids \u4e0a\uff0c\u56e0\u6b64\u5c31\u6765\u5206\u6790\u5b83\uff0c\u540e\u7eed\u6709\u673a\u4f1a\u4e5f\u4f1a\u5206\u6790\u4e00\u4e0b\u5bf9\u5e94\u7684 E \u6838\u67b6\u6784 Gracemont\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel \u5173\u4e8e Golden Cove \u5fae\u67b6\u6784\u6709\u8fd9\u4e9b\u5b98\u65b9\u7684\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://ieeexplore.ieee.org/document/9747991\">Intel Alder Lake CPU Architectures</a></li>\n<li><a href=\"https://hc33.hotchips.org/assets/program/conference/day1/HC2021.C1.1%20Intel%20Efraim%20Rotem.pdf\">Alder Lake Architecture on Hot Chips 33</a></li>\n<li><a href=\"https://hc33.hotchips.org/assets/program/conference/day1/HC2021.C1.4%20Intel%20Arijit.pdf\">Sapphire Rapids on Hot Chips 33</a></li>\n<li><a href=\"https://www.intel.com/content/www/us/en/content-details/671488/intel-64-and-ia-32-architectures-optimization-reference-manual-volume-1.html\">Intel 64 and IA-32 Architectures Optimization Reference Manual Volume 1</a></li>\n</ul>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Golden Cove \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://chipsandcheese.com/2021/12/02/popping-the-hood-on-golden-cove/\">Popping the Hood on Golden Cove</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Golden_Cove\">Golden Cove</a></li>\n<li><a href=\"https://chipsandcheese.com/2023/01/15/golden-coves-vector-register-file-checking-with-official-spr-data/\">Golden Cove\u2019s Vector Register File: Checking with Official (SPR) Data</a></li>\n<li><a href=\"https://www.servethehome.com/4th-gen-intel-xeon-scalable-sapphire-rapids-leaps-forward/7/\">4th Gen Intel Xeon Scalable Sapphire Rapids Leaps Forward</a></li>\n<li><a href=\"https://fuse.wikichip.org/news/6111/intel-details-golden-cove-next-generation-big-core-for-client-and-server-socs/\">Intel Details Golden Cove: Next-Generation Big Core For Client and Server SoCs</a></li>\n<li><a href=\"https://chipsandcheese.com/2023/03/12/a-peek-at-sapphire-rapids/\">Sapphire Rapids: Golden Cove Hits Servers</a></li>\n<li><a href=\"https://chipsandcheese.com/2022/12/25/golden-coves-lopsided-vector-register-file/\">Golden Cove\u2019s Lopsided Vector Register File</a></li>\n<li><a href=\"https://indirector.cpusec.org/\">Indirector: High-Precision Branch Target Injection Attacks Exploiting the Indirect Branch Predictor</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel Golden Cove \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"fetch\">Fetch<a class=\"headerlink\" href=\"#fetch\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Legacy decode pipeline fetch bandwidth is increased from 16 to 32 bytes/cycle</li>\n</ul>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>The number of decoders is increased from 4 to 6</li>\n</ul>\n<h3 id=\"dsbuop-cache\">DSB/uOP Cache<a class=\"headerlink\" href=\"#dsbuop-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>The micro-op cache size is increased to hold 4,000 (\u6ce8\uff1a\u5e94\u8be5\u662f 4096) micro-ops,</li>\n<li>and its bandwidth is increased to deliver up to 8 micro-ops per cycle.</li>\n</ul>\n<p>Intel \u7684 uOP(Micro-OP) Cache \u79f0\u4e3a Decode Stream Buffer (DSB): <code>Decode Stream Buffer (DSB) is a Uop-cache that holds translations of previously fetched instructions that were decoded by the legacy x86 decode pipeline (MITE).</code>\u3002</p>\n<p>uOP Cache \u7684\u7ec4\u7ec7\u65b9\u5f0f\u901a\u5e38\u662f\u7ec4\u76f8\u8fde\uff0c\u6bcf\u4e2a entry \u4fdd\u5b58\u4e86\u51e0\u6761 uOP\uff0c\u8fd9\u4e9b uOP \u5bf9\u5e94\u4e86\u539f\u6765\u6307\u4ee4\u6d41\u4e2d\u8fde\u7eed\u7684\u51e0\u6761\u6307\u4ee4\u3002</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 uOP Cache \u7684\u5927\u5c0f\uff0c\u6784\u9020\u4e0d\u540c\u5927\u5c0f\u7684\u5faa\u73af\uff0c\u5faa\u73af\u4f53\u662f\u590d\u5236\u82e5\u5e72\u4efd\u7684 <code>add %%rsi, %%rdx</code> \u6307\u4ee4\uff0c\u6700\u540e\u662f <code>dec + jnz</code> \u4f5c\u4e3a\u5faa\u73af\u7ed3\u5c3e\uff0c\u901a\u8fc7 <a href=\"https://perfmon-events.intel.com/index.html?pltfrm=ahybrid.html&amp;evnt=IDQ.DSB_UOPS\">IDQ.DSB_UOPS</a> \u6027\u80fd\u8ba1\u6570\u5668\u7edf\u8ba1\u6bcf\u6b21\u5faa\u73af\u6709\u591a\u5c11\u4e2a uOP \u6765\u81ea\u4e8e DSB \u4e5f\u5c31\u662f uOP Cache\uff0c\u53d1\u73b0\u5176\u6700\u5927\u503c\u4e3a 2800 \u5de6\u53f3\uff0c\u8ddd\u79bb 4K \u8fd8\u6709\u4e00\u5b9a\u7684\u8ddd\u79bb\u3002\u76ee\u524d\u8fd8\u6ca1\u6709\u627e\u5230\u4e00\u4e2a\u53ef\u4ee5\u7a33\u5b9a\u8dd1\u51fa 4K uOP \u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u4e0d\u77e5\u9053\u9047\u5230\u4e86\u4ec0\u4e48\u74f6\u9888\u3002</p>\n<p>\u8003\u8651\u5230 taken branch \u5728\u5178\u578b\u7684 uOP Cache \u8bbe\u8ba1\u4e2d\u4f1a\u7ed3\u675f\u4e00\u4e2a entry\uff0c\u628a\u5faa\u73af\u4f53\u6539\u6210\u82e5\u5e72\u6761 <code>jmp</code> \u6307\u4ee4\uff0c\u5e76\u4e14\u6bcf\u4e2a 64B \u7f13\u5b58\u884c\u53ea\u6709\u4e00\u6761 <code>jmp</code> \u6307\u4ee4\uff0c\u6b64\u65f6\u6bcf\u4e2a uOP entry \u53ea\u8bb0\u5f55\u4e00\u6761 <code>jmp</code> \u6307\u4ee4\u3002\u89c2\u5bdf\u5230\u6bcf\u6b21\u5faa\u73af\u6700\u591a 512 \u4e2a uOP \u6765\u81ea uOP Cache\uff0c\u90a3\u4e48 Golden Cove \u7684 uOP Cache \u5927\u6982\u5c31\u662f 512 \u4e2a entry\u3002\u5982\u679c\u6539\u6210\u6bcf 128B \u7f13\u5b58\u884c\u53ea\u6709\u4e00\u6761 <code>jmp</code> \u6307\u4ee4\uff0cuOP Cache \u5bb9\u91cf\u51cf\u5c11\u5230 256 \u4e2a entry\uff1b\u7ee7\u7eed\u589e\u52a0\u95f4\u8ddd\uff0c256B \u95f4\u8ddd\u5bf9\u5e94 128 \u4e2a entry\uff0c512B \u95f4\u8ddd\u5bf9\u5e94 64 \u4e2a entry\uff0c1024B \u95f4\u8ddd\u5bf9\u5e94 32 \u4e2a entry\uff0c2048B \u95f4\u8ddd\u5bf9\u5e94 16 \u4e2a entry\uff0c4096B \u95f4\u8ddd\u5bf9\u5e94 8 \u4e2a entry\uff0c\u7ee7\u7eed\u589e\u5927\u95f4\u8ddd\u540e\uff0centry \u6570\u7ef4\u6301\u4e2d 8 \u4e0d\u518d\u51cf\u5c11\uff0c\u610f\u5473\u7740 Golden Cove \u7684 uOP Cache \u662f 8 Way 64 Set \u4e00\u5171 512 Entry\uff0cIndex \u662f PC[11:6]\u3002</p>\n<p>\u90a3\u4e48\u6309\u7167\u5b98\u65b9\u4fe1\u606f\u6240\u8bf4\u7684 4K \u5bb9\u91cf\uff0c\u4e00\u5171 512 \u4e2a Entry\uff0c\u90a3\u4e48\u6bcf\u4e2a Entry \u5e94\u8be5\u80fd\u591f\u8bb0\u5f55\u6700\u591a 8 \u4e2a uOP\uff0c\u8fd9\u6b63\u597d\u4e5f\u5bf9\u5e94\u4e0a\u4e86 8 uOP \u7684\u541e\u5410\u3002</p>\n<p>\u6839\u636e\u524d\u4eba\u5728 Intel \u6bd4\u8f83\u8001\u7684\u5fae\u67b6\u6784\u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff08\u89c1 <a href=\"https://agner.org/optimize/microarchitecture.pdf\">The microarchitecture of Intel, AMD, and VIA CPUs</a>\uff09\u4ee5\u53ca Intel \u7684\u5b98\u65b9\u6587\u6863 Software Optimization Manual\uff08\u8fd9\u4e2a\u6587\u6863\u628a uOP Cache \u53eb\u505a Decoded ICache\uff09\uff0cIntel \u4e4b\u524d\u5f88\u591a\u4ee3\u5fae\u67b6\u6784\u7684 uOP Cache Entry \u7684\u6784\u9020\u6761\u4ef6\u662f\uff1a</p>\n<ol>\n<li>\u6bcf\u4e2a Entry \u80fd\u8bb0\u5f55\u7684 uOP \u4e2a\u6570\u6709\u4e0a\u9650\uff0c\u6700\u591a 6 uOP/Entry</li>\n<li>Entry \u4e0d\u80fd\u8de8\u8d8a 32B \u8fb9\u754c\uff0c\u53cd\u8fc7\u6765\uff0c\u4e00\u4e2a\u5bf9\u9f50\u7684 32B \u533a\u95f4\u53ea\u80fd\u5bf9\u5e94\u6700\u591a 3 \u4e2a Entry\uff0c\u7ed3\u5408\u7b2c\u4e00\u6761\uff0c\u5c31\u662f\u5bf9\u9f50\u7684 32B \u5757\u4e2d\u4e0d\u80fd\u8d85\u8fc7 <code>3*6=18</code> \u4e2a uOP\uff08<code>The Decoded ICache can hold only up to 18 micro-ops per each 32 byte aligned memory chunk</code>\uff09\uff1b\u5982\u679c\u6307\u4ee4\u8de8\u4e86 32B \u8fb9\u754c\uff0c\u5b83\u88ab\u7b97\u5728\u540e\u9762\u90a3\u4e2a 32B \u91cc\u9762</li>\n<li>\u6307\u4ee4\u9700\u8981\u5b8c\u6574\u5730\u51fa\u73b0\u5728\u4e00\u4e2a Entry \u4e2d\uff1a\u5982\u679c\u4e00\u6761\u6307\u4ee4\u9700\u8981\u7684\u7a7a\u95f4\u592a\u591a\uff0c\u5728\u5f53\u524d Entry \u7684\u5269\u4f59\u7a7a\u95f4\u5185\u653e\u4e0d\u4e0b\uff0c\u5c31\u9700\u8981\u53e6\u8d77\u4e00\u4e2a Entry</li>\n<li>\u65e0\u6761\u4ef6\u8df3\u8f6c\uff08\u6216\u8005\u88ab\u9884\u6d4b\u4e3a\u8981\u8df3\u8f6c\uff09\u7684\u6307\u4ee4\u4f1a\u7ed3\u675f\u4e00\u4e2a Entry\uff08<code>each unconditional branch is the last micro-op occupying a Decoded ICache Way</code>\uff09</li>\n<li>\u6bd4\u8f83\u5927\u7684\u7acb\u5373\u6570\u4e5f\u4f1a\u5360\u7528 uOP \u7a7a\u95f4\uff0c\u51cf\u5c11\u4e86\u5b9e\u9645\u80fd\u5b58\u653e\u7684 uOP \u6570\u91cf</li>\n<li>\u6bd4\u8f83\u590d\u6742\u7684\u9700\u8981\u5fae\u7801\uff08Microcoded uops\uff09\u7684\u6307\u4ee4\u4f1a\u5360\u7528\u4e00\u6574\u4e2a Entry</li>\n</ol>\n<p>\u4e0b\u9762\u6765\u5206\u6790 Golden Cove \u4e0a\u8fd9\u4e9b\u6784\u9020\u6761\u4ef6\u662f\u5426\u6709\u53d8\u5316\u3002\u53c2\u8003 <a href=\"https://ieeexplore.ieee.org/document/9499837\">I See Dead \u00b5ops: Leaking Secrets via Intel/AMD Micro-Op Caches</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e86\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u4f53\u7531 <code>4x 15-byte-nop + 1x 4-byte-nop</code> \u7ec4\u6210\uff0c\u8fd9\u6837\u7684 5 \u6761\u6307\u4ee4\u586b\u6ee1\u4e86\u5bf9\u9f50\u7684 64B\u3002\u5728 Golden Cove \u4e0a\u6d4b\u8bd5\uff0c\u53d1\u73b0\u4f9d\u7136\u53ef\u4ee5\u7528\u6ee1 512 \u4e2a Entry\uff0c\u5047\u5982 Entry \u4e0d\u80fd\u8de8\u8d8a 32B \u8fb9\u754c\uff0c\u90a3\u4e48\u8fd9 5 \u6761\u6307\u4ee4\u81f3\u5c11\u5c31\u8981 2 \u4e2a Entry\uff0c\u4f46\u5b9e\u9645\u4e0a\u53ea\u7528\u4e86 1 \u4e2a Entry\u3002\u8fd9\u8bf4\u660e Golden Cove \u4e0a uOP Cache Entry \u7684\u7b2c\u4e00\u6761\u9650\u5236\u4e2d\uff0cEntry \u4e0d\u80fd\u8de8\u8d8a\u7684\u8fb9\u754c\uff0c\u4ece 32B \u6269\u5927\u5230\u4e86 64B\uff0c\u6bd5\u7adf\u6bcf\u4e2a Entry \u80fd\u5b58\u7684 uOP \u6570\u91cf\u4e5f\u589e\u591a\u4e86\uff0c\u5982\u679c\u7ee7\u7eed\u9650\u5236 32B\uff0c\u6bcf\u4e2a Entry \u5c31\u5f88\u96be\u5b58\u6ee1 8 \u4e2a uOP \u4e86\u3002\u63a5\u4e0b\u6765\u6d4b\u8bd5\u5bf9\u9f50\u7684 64B \u5185\u53ef\u4ee5\u6700\u591a\u6709\u591a\u5c11\u4e2a entry\u3002</p>\n<p>\u628a\u5faa\u73af\u4f53\u6539\u6210\u6bcf\u5bf9\u9f50\u7684 64B \u5c31\u6709\u56db\u6761 jmp \u6307\u4ee4\uff0c\u524d\u4e00\u6761 jmp \u6307\u4ee4\u8df3\u8f6c\u5230\u540e\u4e00\u6761 jmp \u6307\u4ee4\uff0c\u6a21\u62df\u6bcf 64B \u6709\u56db\u4e2a Entry \u7684\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u7b2c 1 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 0B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230 64B \u5185 16B \u504f\u79fb\u5904</li>\n<li>\u7b2c 2 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 16B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230 64B \u5185 32B \u504f\u79fb\u5904</li>\n<li>\u7b2c 3 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 32B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230 64B \u5185 48B \u504f\u79fb\u5904</li>\n<li>\u7b2c 4 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 48B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a 64B \u7684\u5f00\u5934</li>\n</ol>\n<p>\u6d4b\u8bd5\u53d1\u73b0\u8fd9\u4e2a\u60c5\u51b5\u4e0b\u80fd\u8fbe\u5230 512 \u4e2a Entry\u3002\u8bf4\u660e\u5bf9\u9f50\u7684 64B \u5185\u81f3\u5c11\u53ef\u4ee5\u5b58 4 \u4e2a Entry\u3002</p>\n<p>\u8fdb\u4e00\u6b65\u6d4b\u8bd5\uff0c\u5982\u679c\u6bcf\u5bf9\u9f50\u7684 64B \u6709\u4e94\u6761 jmp \u6307\u4ee4\uff0c\u6a21\u62df\u6bcf 64B \u6709\u4e94\u4e2a Entry \u7684\u60c5\u51b5\uff1a</p>\n<ol>\n<li>\u7b2c 1 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 0B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230 64B \u5185 8B \u504f\u79fb\u5904</li>\n<li>\u7b2c 2 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 8B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230 64B \u5185 16B \u504f\u79fb\u5904</li>\n<li>\u7b2c 3 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 16B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230 64B \u5185 24B \u504f\u79fb\u5904</li>\n<li>\u7b2c 4 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 24B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230 64B \u5185 32B \u504f\u79fb\u5904</li>\n<li>\u7b2c 5 \u4e2a jmp \u653e\u5728 64B \u5185\u7684 32B \u504f\u79fb\u5904\uff0c\u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a 64B \u7684\u5f00\u5934</li>\n</ol>\n<p>\u53d1\u73b0\u6700\u9ad8\u7684 Entry \u6570\u53ea\u6709 480 \u5de6\u53f3\uff0c\u4e0d\u786e\u5b9a\u662f\u9047\u5230\u4e86\u4ec0\u4e48\u9650\u5236\uff0c\u5982\u679c\u5bf9\u9f50\u7684 64B \u5185\u4e0d\u80fd\u5b58 5 \u4e2a Entry\uff0c\u4e5f\u4e0d\u5e94\u8be5\u5f97\u5230 480 \u8fd9\u4e2a\u7ed3\u679c\u3002</p>\n<p>\u5982\u679c\u5355\u72ec\u53bb\u6d4b\u8bd5\u6bcf\u4e2a\u5bf9\u9f50\u7684 64B \u80fd\u7f13\u5b58\u591a\u5c11\u4e2a uOP\uff0c\u6bd4\u5982\u6bcf\u4e2a\u5bf9\u9f50\u7684 64B \u91cc\u7531\u82e5\u5e72\u6761 nop \u52a0\u6700\u540e\u4e00\u6761\u8df3\u5230\u4e0b\u4e00\u4e2a 64B \u5f00\u5934\u7684 jmp \u6307\u4ee4\u7ec4\u6210\uff0c\u4f1a\u53d1\u73b0\u5f53\u5bf9\u9f50\u7684 64B \u5185\u7684 uOP \u4e2a\u6570\u4ece 36 \u4e2a\u53d8\u6210 37 \u4e2a\u65f6\uff0cuOP Cache \u547d\u4e2d\u7387\u6025\u5267\u4e0b\u964d\u3002\u8fd9\u610f\u5473\u7740\uff0c\u6bcf\u5bf9\u9f50\u7684 64B \u5185\u4f9d\u7136\u4e0d\u80fd\u5b58\u8d85\u8fc7 36 \u4e2a uOP\u3002\u8fd9\u7c7b\u4f3c\u4e8e\u539f\u6765\u7684\u6bcf\u5bf9\u9f50\u7684 32B \u5185\u4e0d\u80fd\u5b58\u8d85\u8fc7 18 \u4e2a uOP\uff0c\u4f46\u7c92\u5ea6\u66f4\u7c97\uff0c\u5b9e\u9645\u4e0a\u66f4\u52a0\u5bbd\u677e\uff0c\u6bd4\u5982\u5bf9\u9f50\u7684 64B \u5185\u7684\u524d 32B \u53ef\u4ee5\u5168\u662f NOP \u6307\u4ee4\uff0c\u53ea\u8981 64B \u5185\u603b\u6570\u4e0d\u8d85\u8fc7 36 \u5c31\u53ef\u4ee5\u3002\u4f46\u6bd4\u8f83\u5947\u602a\u7684\u662f\uff0c36 uOP per 64B \u4e0d\u80fd\u6574\u9664 8 uOP/Entry\uff0c\u4e0d\u50cf\u539f\u6765\u7684 18 per 32B \u53ef\u4ee5\u6574\u9664 6 uOP/Entry\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>the iTLBs is doubled to hold <strong>256</strong> entries for 4-KB pages and 32 entries for 2/4 million pages</li>\n</ul>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 jmp \u6307\u4ee4\uff0c\u4f7f\u5f97 jmp \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 256 \u4e2a Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 256 \u7684 L1 ITLB \u5bb9\u91cf\u3002\u6ce8\u610f\u8981\u907f\u514d ICache \u548c BTB \u7684\u5bb9\u91cf\u6210\u4e3a\u74f6\u9888\uff0c\u628a jmp \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 Cache Line \u548c BTB entry \u4e0a\u3002</p>\n<p>\u8d85\u8fc7 256 \u4e2a Page \u4ee5\u540e\uff0c\u5982\u56fe\u6709\u5468\u671f\u6570\u7a81\u7136\u4e0b\u964d\u540e\u7f13\u6162\u4e0a\u5347\u7684\u60c5\u51b5\uff08\u4f8b\u5982\u6a2a\u5750\u6807 288-&gt;289\u3001320-&gt;321\u3001352-&gt;353\u3001384-&gt;385 \u7b49\uff0c\u4ee5 32 \u4e3a\u5468\u671f\uff09\uff0c\u80cc\u540e\u7684\u539f\u7406\u9700\u8981\u8fdb\u4e00\u6b65\u5206\u6790\u3002</p>\n<p>\u6269\u5927 jmp \u6307\u4ee4\u7684\u8ddd\u79bb\u518d\u6d4b\u8bd5\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6bcf 2/4 \u4e2a page \u653e\u4e00\u6761 jmp \u6307\u4ee4\uff0c\u5bb9\u91cf\u4e0d\u53d8\u8fd8\u662f 256 \u4e2a Page</li>\n<li>\u5982\u679c\u6539\u6210\u6bcf 8 \u4e2a page \u4e00\u6761 jmp \u6307\u4ee4\uff0c\u5bb9\u91cf\u4e0b\u964d\u5230 32 \u4e2a Page</li>\n<li>\u6bcf 16 \u4e2a page \u4e00\u6761 jmp\uff0c\u5bb9\u91cf\u4e0b\u964d\u5230 16 \u4e2a Page</li>\n<li>\u6bcf 32/64/128 \u4e2a page \u4e00\u6761 jmp \u6307\u4ee4\uff0c\u5bb9\u91cf\u662f 8 \u4e2a Page</li>\n</ul>\n<p>\u4ece\u8fd9\u4e2a\u7ed3\u679c\u6765\u770b\uff0cL1 ITLB \u5bf9\u4e8e 4K \u9875\u5e94\u8be5\u662f 32 Set 8 Way\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>32KB</strong></li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 4 \u5b57\u8282 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b\u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 32 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 6 IPC\uff0c\u4e4b\u540e\u5219\u964d\u5230 4 IPC\uff0c\u8fd9\u91cc\u7684 32 KB \u5c31\u5bf9\u5e94\u4e86 L1 ICache \u7684\u5bb9\u91cf\u3002</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\uff0c\u5f97\u5230\u4e0b\u9762\u7684\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 20 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 Return Stack \u6df1\u5ea6\u4e3a 20\u3002</p>\n<h3 id=\"instruction-decode-queue-idq--loop-stream-detector-lsd\">Instruction Decode Queue (IDQ) + Loop Stream Detector (LSD)<a class=\"headerlink\" href=\"#instruction-decode-queue-idq--loop-stream-detector-lsd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>The IDQ can hold <strong>144</strong> uops per logical processor in single thread mode, or 72 uops per thread when SMT is active.</li>\n</ul>\n<p>Golden Cove \u67b6\u6784\u9488\u5bf9\u5faa\u73af\u505a\u4e86\u4f18\u5316\uff0cLoop Stream Detector\uff08\u7b80\u79f0 LSD\uff09\u4f1a\u68c0\u6d4b\u5f53\u524d\u6307\u4ee4\u6d41\u662f\u5426\u5728\u4e00\u4e2a\u5faa\u73af\u5f53\u4e2d\uff0c\u5e76\u4e14\u5faa\u73af\u7684 uop \u4e0d\u8d85\u51fa Instruction Decode Queue(IDQ) \u7684\u5bb9\u91cf\uff0c\u90a3\u4e48 LSD \u4f1a\u628a Legacy decode pipeline(MITE) \u548c Decode stream buffer(DSB) \u5173\u6389\uff0c\u4e0d\u518d\u8ba9 IDQ \u7684\u6307\u4ee4\u51fa\u961f\uff0c\u800c\u662f\u76f4\u63a5\u5728 IDQ \u7684\u5185\u90e8\u5faa\u73af\u63d0\u4f9b\u6307\u4ee4\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u8282\u7701\u4e86\u5f88\u591a\u5904\u7406\u5668\u524d\u7aef\u7684\u529f\u8017\u3002</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 Instruction Decode Queue \u7684\u5927\u5c0f\uff0c\u6784\u9020\u4e0d\u540c\u5927\u5c0f\u7684\u5faa\u73af\uff0c\u5faa\u73af\u4f53\u662f\u590d\u5236\u82e5\u5e72\u4efd\u7684 <code>inc %rsi</code> \u6307\u4ee4\uff0c\u6700\u540e\u662f <code>dec + jnz</code> \u4f5c\u4e3a\u5faa\u73af\u7ed3\u5c3e\uff0c\u901a\u8fc7 <a href=\"https://perfmon-events.intel.com/index.html?pltfrm=ahybrid.html&amp;evnt=LSD.UOPS\">LSD.UOPS</a> \u6027\u80fd\u8ba1\u6570\u5668\u7edf\u8ba1\u6bcf\u6b21\u5faa\u73af\u6709\u591a\u5c11\u4e2a UOP \u6765\u81ea\u4e8e Loop Stream Detector \u673a\u5236\uff0c\u53d1\u73b0\u5176\u6700\u5927\u503c\u4e3a 144\uff0c\u8bf4\u660e Golden Cove \u7684 Loop Stream Detector \u53ef\u4ee5\u8bc6\u522b\u6700\u591a 144 \u4e2a uop \u7684\u5faa\u73af\u3002\u6b64\u65f6\u6bcf\u4e2a\u5faa\u73af\u8981\u6267\u884c 145 \u6761\u6307\u4ee4\uff0c\u6700\u540e\u7684 <code>dec + jnz</code> \u88ab\u878d\u5408\u6210\u4e86\u4e00\u4e2a uop\u3002</p>\n<p>\u5faa\u73af\u4f53\u4e2d\uff0c\u5982\u679c\u7528 <code>nop</code> \u6307\u4ee4\u6765\u586b\u5145\uff0c\u4f1a\u5f97\u5230 40 \u5de6\u53f3\u7684\u6bd4 144 \u5c0f\u5f97\u591a\u7684\u5bb9\u91cf\uff0c\u731c\u6d4b\u662f\u8fdb\u5165\u4e86\u4f4e\u529f\u8017\u6a21\u5f0f\u3002</p>\n<h3 id=\"conditional-branch-predictor\">Conditional Branch Predictor<a class=\"headerlink\" href=\"#conditional-branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53c2\u8003 <a href=\"https://cseweb.ucsd.edu/~dstefan/pubs/yavarzadeh:2023:half.pdf\">Half&amp;Half: Demystifying Intel\u2019s Directional Branch Predictors for Fast, Secure Partitioned Execution</a> \u8bba\u6587\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u6d4b\u51fa Golden Cove \u7684\u5206\u652f\u9884\u6d4b\u5668\u91c7\u7528\u7684\u5386\u53f2\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 388 \u4f4d\u7684 Path History Register\uff0c\u6bcf\u6b21\u6267\u884c taken branch \u65f6\u66f4\u65b0</li>\n<li>\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a<code>PHRnew = (PHRold &lt;&lt; 2) xor footprint</code></li>\n<li>footprint \u5171\u6709 16 \u4f4d\uff0c\u5176\u4e2d B \u4ee3\u8868\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0cT \u4ee3\u8868\u5206\u652f\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740\uff1a<ul>\n<li>footprint[0] = B[3] xor T[0]</li>\n<li>footprint[1] = B[4] xor T[1]</li>\n<li>footprint[2] = B[5]</li>\n<li>footprint[3] = B[6]</li>\n<li>footprint[4] = B[7]</li>\n<li>footprint[5] = B[8]</li>\n<li>footprint[6] = B[9]</li>\n<li>footprint[7] = B[10]</li>\n<li>footprint[8] = B[0] xor T[2]</li>\n<li>footprint[9] = B[1] xor T[3]</li>\n<li>footprint[10] = B[2] xor T[4]</li>\n<li>footprint[11] = B[11] xor T[5]</li>\n<li>footprint[12] = B[12]</li>\n<li>footprint[13] = B[13]</li>\n<li>footprint[14] = B[14]</li>\n<li>footprint[15] = B[15]</li>\n</ul>\n</li>\n</ol>\n<p>\u8fd9\u4e2a\u7ed3\u679c\u548c\u8bba\u6587\u662f\u4e00\u81f4\u7684\u3002\u5404\u5382\u5546\u5904\u7406\u5668\u7684 PHR \u66f4\u65b0\u89c4\u5219\u89c1 <a href=\"https://jia.je/cpu/cbp.html\">jiegec/cpu</a>\u3002</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"rename\">Rename<a class=\"headerlink\" href=\"#rename\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Rename/allocation width grows from 5 to 6 wide</li>\n</ul>\n<h3 id=\"execution-units\">Execution Units<a class=\"headerlink\" href=\"#execution-units\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>The number of execution ports goes from 10 to 12</li>\n<li>five LEA units as well as five integer ALUs</li>\n<li>three-cycle fast adders, with two cycles bypass between back-to-back floating-point ADD operations</li>\n<li>five alu/simd ports: 0/1/5/6/10<ul>\n<li>P0: ALU/LEA/Shift/JMP/FMA/ALU/Shift/fpDIV</li>\n<li>P1: ALU/LEA/Mul/iDIV/FMA/ALU/Shift/Shuffle/FADD</li>\n<li>P5: ALU/LEA/MulHi/FMA512/ALU/AMX/Shuffle/FADD</li>\n<li>P6: ALU/LEA/Shift/JMP</li>\n<li>P10: ALU/LEA</li>\n</ul>\n</li>\n<li>3 load ports: 2/3/11</li>\n<li>2 store address ports: 7/8</li>\n<li>2 store data ports: 4/9</li>\n</ul>\n<h3 id=\"lsu\">LSU<a class=\"headerlink\" href=\"#lsu\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Port 11 provides a third load port with a dedicated address-generation unit</li>\n<li>Load 64Bx2 or <strong>32Bx3</strong> per cycle</li>\n<li>Store 64Bx2 or 32Bx3 per cycle</li>\n<li>The L1 load to use latency is <strong>5</strong> cycles</li>\n</ul>\n<h4 id=\"load-store-\u5e26\u5bbd\">Load Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#load-store-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>3x 256b Load</li>\n<li>2x 256b Load + 2x 256b Store</li>\n<li>1x 256b Load + 2x 256b Store</li>\n<li>2x 256b Store</li>\n</ul>\n<p>\u56e0\u4e3a\u6d4b\u8bd5\u73af\u5883\u662f Client \u800c\u975e Server\uff0c\u6240\u4ee5 AVX512 \u88ab\u5c4f\u853d\u4e86\uff0c\u65e0\u6cd5\u6d4b\u8bd5 AVX512 \u7684\u8bfb\u5199\u5e26\u5bbd\u3002\u6b64\u65f6\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 96B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 64B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Partial store forwarding allowing forwarding data from store to load also when only part of the load was covered by the store (in case the load's offset matches the store's offset)</li>\n</ul>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0cGolden Cove \u4e0a\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[0,2]</td>\n<td>{0}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[0,6]</td>\n<td>[0,4]</td>\n<td>{0}</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cGolden Cove \u5728 Store \u5b8c\u5168\u5305\u542b Load \u7684\u60c5\u51b5\u4e0b\u90fd\u53ef\u4ee5\u8f6c\u53d1\uff0c\u6ca1\u6709\u989d\u5916\u7684\u5bf9\u9f50\u8981\u6c42\u3002\u4f46\u5f53 Load \u548c Store \u53ea\u6709\u90e8\u5206\u91cd\u5408\u65f6\uff0c\u5c31\u65e0\u6cd5\u8f6c\u53d1\uff0c\u8fd9\u548c\u5b98\u65b9\u4fe1\u606f\u6709\u6240\u51b2\u7a81\u3002\u4e24\u4e2a\u8fde\u7eed\u7684 32 \u4f4d\u7684 Store \u548c\u4e00\u4e2a 64 \u4f4d\u7684 Load \u91cd\u5408\u4e5f\u4e0d\u80fd\u8f6c\u53d1\u3002</p>\n<p>\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f\uff0c\u5728 y=x \u4e14\u4e0d\u8de8\u8d8a\u7f13\u5b58\u884c\u8fb9\u754c\u4e14\u6ee1\u8db3\u4e0b\u5217\u8981\u6c42\u7684\u60c5\u51b5\u4e0b\uff0cStore Forwarding \u4e0d\u4f1a\u6216\u53ea\u5e26\u6765\u5f88\u5c0f\u7684\u6027\u80fd\u635f\u5931\uff1a</p>\n<ul>\n<li>8b Store -&gt; 8b Load</li>\n<li>32b Store -&gt; 8b Load</li>\n<li>64b Store -&gt; 8b Load</li>\n<li>32b Store -&gt; 32b Load</li>\n<li>64b Store -&gt; 32b Load</li>\n<li>64b Store -&gt; 64b Load</li>\n</ul>\n<p>\u8003\u8651\u5230 y \u5fc5\u987b\u7b49\u4e8e x\uff0c\u4e5f\u5c31\u662f\u5730\u5740\u8981\u4e00\u6837\uff0c\u731c\u6d4b Golden Cove \u4f7f\u7528\u4e86\u7c7b\u4f3c Memory Renaming \u7684\u6280\u672f\u6765\u5b9e\u73b0\u8fd9\u4e2a\u6548\u679c\u3002\u5982\u679c\u662f\u8fde\u7eed\u4e24\u4e2a\u5bf9\u540c\u4e00\u4e2a\u5730\u5740\u7684 Store \u5bf9\u4e00\u4e2a Load \u7684\u8f6c\u53d1\uff0c\u6548\u679c\u548c\u53ea\u6709\u4e00\u4e2a Store \u662f\u4e00\u6837\u7684\u3002</p>\n<p>\u9664\u4e86\u4e0a\u8ff0\u60c5\u51b5\u4ee5\u5916\uff0cStore Forwarding \u6210\u529f\u65f6\u7684\u5ef6\u8fdf\u5728 5 \u4e2a\u5468\u671f\uff0c\u5931\u8d25\u5219\u8981 19 \u4e2a\u5468\u671f\u3002</p>\n<p>\u5c0f\u7ed3\uff1aGolden Cove \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42 st \u5305\u542b ld\uff0c\u7279\u522b\u5730\uff0c\u5730\u5740\u76f8\u540c\u65f6\uff0c\u6027\u80fd\u6700\u597d</li>\n<li>1 ld + 2+ st: \u4e0d\u652f\u6301</li>\n</ul>\n<h3 id=\"l1-dcache\">L1 DCache<a class=\"headerlink\" href=\"#l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>48KB</strong></li>\n</ul>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 48KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 48KB \u7684 L1 DCache \u5bb9\u91cf\u3002\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u5728 384KB\uff0c\u5bf9\u5e94\u7684\u662f L1 DTLB \u7684\u5bb9\u91cf\u3002</p>\n<h3 id=\"l1-dtlb\">L1 DTLB<a class=\"headerlink\" href=\"#l1-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>96-entry</strong> 6-way 4-KB-page TLB</li>\n<li>32-entry 4-way 2-MB/4-MB-page TLB</li>\n<li>8-entry 1-GB-page TLB for loads</li>\n<li>A 16-entry TLB for stores serves all page sizes</li>\n</ul>\n<p>\u7528\u7c7b\u4f3c\u6d4b L1 DCache \u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21 pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_dtlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 96 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 96 \u7684 L1 DTLB \u5bb9\u91cf\u3002\u6ca1\u6709\u8d85\u51fa L1 DTLB \u5bb9\u91cf\u524d\uff0cLoad to use latency \u662f 5 cycle\uff1b\u8d85\u51fa L1 DTLB \u5bb9\u91cf\u540e\uff0cLoad to use latency \u662f 12 cycle\uff0c\u8bf4\u660e L1 DTLB miss \u5e26\u6765\u4e86 7 cycle \u7684\u635f\u5931\u3002</p>\n<h3 id=\"l2-tlb\">L2 TLB<a class=\"headerlink\" href=\"#l2-tlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>2,048-entry second level TLB (STLB)</li>\n<li>4 page table walkers</li>\n</ul>\n<p>\u6cbf\u7528\u4e4b\u524d\u6d4b\u8bd5 L1 DTLB \u7684\u65b9\u6cd5\uff0c\u628a\u89c4\u6a21\u6269\u5927\u5230 L2 Unified TLB \u7684\u8303\u56f4\uff0c\u5c31\u53ef\u4ee5\u6d4b\u51fa\u6765 L2 Unified TLB \u7684\u5bb9\u91cf\uff0c\u4e0b\u9762\u662f Golden Cove \u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_l2tlb.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u662f 96 \u4e2a Page\uff0c\u5bf9\u5e94 L1 DTLB\uff0c\u6b64\u65f6 CPI \u4ece 5 \u63d0\u5347\u5230 12\uff1b\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u662f 768\uff0c\u5bf9\u5e94 L1 DCache\uff0c\u6b64\u65f6 CPI \u4ece 12 \u63d0\u5347\u5230 23\uff1b\u7b2c\u4e09\u4e2a\u62d0\u70b9\u662f 1600 \u5de6\u53f3\uff0c\u800c\u6ca1\u6709\u5230 2048\uff0c\u731c\u6d4b\u6709 QoS \u9650\u5236\u4e86\u6570\u636e\u5bf9 L2 TLB \u7684\u5360\u7528\u3002</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>1.25MB(Client)/2MB(Server)</li>\n<li>64 bytes/cycle</li>\n<li>15 cycle latency</li>\n</ul>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_l2c.png\" /></p>\n<ul>\n<li>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u5728 48KB\uff0c\u5bf9\u5e94 L1 DCache \u7684\u5bb9\u91cf\uff0cCPI \u4ece 5 \u63d0\u5347\u5230 16</li>\n<li>\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u5728 384KB\uff0c\u5bf9\u5e94 L1 DTLB \u7684\u5bb9\u91cf\uff0cCPI \u4ece 16 \u63d0\u5347\u5230 23</li>\n<li>\u7b2c\u4e09\u4e2a\u62d0\u70b9\u5728 1280KB\uff0c\u5bf9\u5e94 L2 Cache \u7684\u5bb9\u91cf</li>\n</ul>\n<h3 id=\"prefetcher\">Prefetcher<a class=\"headerlink\" href=\"#prefetcher\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"\u5b98\u65b9\u4fe1\u606f_1\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f_1\" title=\"Permanent link\">&para;</a></h4>\n<p>Intel Golden Cove \u7684\u5904\u7406\u5668\u901a\u8fc7 MSR 1A4H \u53ef\u4ee5\u914d\u7f6e\u5404\u4e2a\u9884\u53d6\u5668\uff08\u6765\u6e90\uff1aSoftware Developers Manual\uff0cMSRs Supported by 12th and 13th Generation Intel\u00ae Core\u2122 Processor P-core\uff09\uff1a</p>\n<ul>\n<li>MSR_1A4H[0]: the L2 hardware prefetcher, which fetches additional lines of code or data into the L2 cache.</li>\n<li>MSR_1A4H[1]: the L2 adjacent cache line prefetcher, which fetches the cache line that comprises a cache line pair (128 bytes). \u8fd9\u548c AMD \u7684 Up/Down Prefetcher \u5e94\u8be5\u662f\u4e00\u4e2a\u610f\u601d</li>\n<li>MSR_1A4H[5]: the L2 Adaptive Multipath Probability (AMP) prefetcher. \u8fd9\u4e2a\u5e94\u8be5\u5c5e\u4e8e Spatial Prefetcher</li>\n<li>MSR_1A4H[2]: the L1 data cache prefetcher, which fetches the next cache line into L1 data cache. \u8fd9\u4e2a\u5e94\u8be5\u5c5e\u4e8e Next Line Prefetcher</li>\n<li>MSR_1A4H[3]: the L1 data cache IP prefetcher, which uses sequential load history (based on instruction pointer of previous loads) to determine whether to prefetch additional lines.</li>\n</ul>\n<h4 id=\"\u9884\u53d6\u5ef6\u8fdf\">\u9884\u53d6\u5ef6\u8fdf<a class=\"headerlink\" href=\"#\u9884\u53d6\u5ef6\u8fdf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 Golden Cove \u4e0a\u6309 64B \u7684\u8df3\u6b65\u8fdb\u884c\u8bbf\u5b58\uff0c\u6d4b\u91cf\u6bcf\u6b21\u8bbf\u5b58\u7684\u5ef6\u8fdf\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_prefetcher_64b_stride.png\" /></p>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\u5728 48KB \u4e4b\u5185\u662f 5 cycle latency\uff0c\u5728 L2 Cache \u8303\u56f4\u5185\u662f 5-8 cycle latency\u3002</p>\n<p>\u5982\u679c\u901a\u8fc7 <code>wrmsr -p 0 0x1a4 0x8</code> \u628a <code>DCU_IP_PREFETCHER_DISABLE</code> \u8bbe\u4e3a 1\uff0c\u5373\u5173\u95ed L1 data cache IP prefetcher\uff0c\u518d\u5728 0 \u53f7\u6838\u5fc3\u4e0a\u91cd\u65b0\u8dd1\u4e0a\u9762\u7684\u6d4b\u8bd5\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_prefetcher_64b_stride_disable_prefetcher.png\" /></p>\n<p>\u5c31\u53ef\u4ee5\u770b\u5230 L2 Cache \u7684\u8303\u56f4\u5185\u7684\u6027\u80fd\u9000\u5316\u5230\u4e86 16 Cycle\uff0c\u548c\u968f\u673a pointer chasing \u4e00\u6837\u3002\u5173\u95ed\u5176\u4ed6\u7684 prefetcher \u5219\u6ca1\u6709\u8fd9\u4e2a\u73b0\u8c61\uff0c\u8bf4\u660e\u6b63\u662f L1 data cache IP prefetcher \u5b9e\u73b0\u4e86\u9488\u5bf9 L1 \u7684 Stride Prefetcher\u3002</p>\n<h4 id=\"\u9884\u53d6\u8ddd\u79bb\">\u9884\u53d6\u8ddd\u79bb<a class=\"headerlink\" href=\"#\u9884\u53d6\u8ddd\u79bb\" title=\"Permanent link\">&para;</a></h4>\n<p>\u66f4\u8fdb\u4e00\u6b65\uff0c\u53c2\u8003 <a href=\"https://abertschi.ch/blog/2022/prefetching/\">Battling the Prefetcher: Exploring Coffee Lake (Part 1)</a> \u7684\u65b9\u5f0f\uff0c\u7814\u7a76 Stride \u9884\u53d6\u5668\u7684\u884c\u4e3a\uff1a\u5206\u914d\u4e00\u7247\u5185\u5b58\uff0c\u628a\u6570\u636e\u4ece\u7f13\u5b58\u4e2d flush \u6389\uff0c\u518d\u6309\u7167\u7279\u5b9a\u7684\u8bbf\u5b58\u6a21\u5f0f\u8bbf\u95ee\uff0c\u89e6\u53d1\u9884\u53d6\u5668\uff0c\u6700\u540e\u6d4b\u91cf\u8bbf\u95ee\u6bcf\u4e2a\u7f13\u5b58\u884c\u7684\u65f6\u95f4\uff0c\u4ece\u800c\u5f97\u5230\u9884\u53d6\u5668\u9884\u53d6\u4e86\u54ea\u4e9b\u7f13\u5b58\u884c\u7684\u4fe1\u606f\u3002</p>\n<p>\u9996\u5148\u662f\u53ea\u8bbf\u95ee\u4e00\u4e2a cache line \u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u9664\u4e86\u5df2\u7ecf\u8bbf\u95ee\u8fc7\u7684 cache line\uff0c\u5176\u4ed6 cache line \u90fd\u51fa\u73b0\u4e86\u7f13\u5b58\u7f3a\u5931\uff0c\u8bf4\u660e\u6b64\u65f6\u9884\u53d6\u5668\u6ca1\u6709\u5728\u5de5\u4f5c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_prefetcher_1.png\" /></p>\n<p>\u63a5\u4e0b\u6765\uff0c\u6309\u7167\u56fa\u5b9a\u7684 stride \u8bbf\u95ee\u5404\u4e2a\u7f13\u5b58\u884c\uff0c\u53d1\u73b0\u5f53\u8bbf\u95ee\u4e86\u4e94\u4e2a cache line \u65f6\uff0c\u9884\u53d6\u5668\u4f1a\u6bd4\u8f83\u7a33\u5b9a\u5730\u9884\u53d6\u7b2c\u516d\u4e2a cache line\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_prefetcher_5.png\" /></p>\n<p>\u7ee7\u7eed\u589e\u52a0\u8bbf\u95ee\u6b21\u6570\uff0c\u53ef\u4ee5\u770b\u5230\u9884\u53d6\u5668\u603b\u662f\u4f1a\u9884\u53d6\u5c06\u8981\u8bbf\u95ee\u7684\u4e0b\u4e00\u4e2a cache line\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_prefetcher_13.png\" /></p>\n<p>\u5982\u679c\u901a\u8fc7 <code>wrmsr -p 0 0x1a4 0x8</code> \u628a <code>DCU_IP_PREFETCHER_DISABLE</code> \u8bbe\u4e3a 1\uff0c\u5373\u5173\u95ed L1 data cache IP prefetcher\uff0c\u5c31\u4f1a\u89c2\u5bdf\u5230\u4e0a\u8ff0 Stride \u9884\u53d6\u7684\u884c\u4e3a\u6d88\u5931\uff0c\u4e0d\u4f1a\u9884\u53d6\u5c06\u8981\u8bbf\u95ee\u7684\u4e0b\u4e00\u4e2a cache line\u3002</p>\n<p>\u628a\u76f8\u540c\u7684\u4ee3\u7801\u653e\u5230 Gracemont \u4e0a\u8fd0\u884c\uff0c\u4f1a\u770b\u5230\u5b83\u7684\u9884\u53d6\u5668\u4f1a\u9884\u53d6\u5c06\u8981\u8bbf\u95ee\u7684\u672a\u6765\u4e24\u4e2a cache line\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_prefetcher_gracemont_comparison.png\" /></p>\n<p>\u53ef\u89c1\u4e0d\u540c\u5fae\u67b6\u6784\u7684\u9884\u53d6\u5668\u7684\u7b56\u7565\u662f\u4e0d\u540c\u7684\u3002</p>\n<h3 id=\"reorder-buffer\">ReOrder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>512-entry</strong> reorder buffer</li>\n<li>8 wide retirement</li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 ROB \u7684\u5927\u5c0f\uff0c\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5f00\u59cb\u548c\u7ed3\u675f\u662f\u957f\u5ef6\u8fdf\u7684 long latency load\u3002\u4e2d\u95f4\u662f\u82e5\u5e72\u6761 NOP \u6307\u4ee4\uff0c\u5f53 NOP \u6307\u4ee4\u6bd4\u8f83\u5c11\u65f6\uff0c\u5faa\u73af\u7684\u65f6\u5019\u53d6\u51b3\u4e8e load \u6307\u4ee4\u7684\u65f6\u95f4\uff1b\u5f53 NOP \u6307\u4ee4\u6570\u91cf\u8fc7\u591a\uff0c\u586b\u6ee1\u4e86 ROB \u4ee5\u540e\uff0c\u5c31\u4f1a\u5bfc\u81f4 ROB \u65e0\u6cd5\u4fdd\u5b58\u5faa\u73af\u672b\u5c3e\u7684 load \u6307\u4ee4\uff0c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\u3002\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../intel_golden_cove_rob.png\" /></p>\n<p>\u5f53 NOP \u6570\u91cf\u8fbe\u5230 512 \u65f6\uff0c\u6027\u80fd\u5f00\u59cb\u6025\u5267\u4e0b\u6ed1\uff0c\u8bf4\u660e Golden Cove \u7684 ROB \u5927\u5c0f\u662f 512\u3002</p>", "image": null, "date_modified": "2025-01-10T00:00:00+00:00", "authors": [], "tags": ["alderlake", "cpu", "goldencove", "hardware", "intel", "performance", "uarch-review"]}, {"id": "https://jia.je/hardware/2024/12/27/cpu_uarch_reverse_engineering_methodology/", "url": "https://jia.je/hardware/2024/12/27/cpu_uarch_reverse_engineering_methodology/", "title": "CPU \u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66", "content_html": "<h1 id=\"cpu-\u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66\">CPU \u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66<a class=\"headerlink\" href=\"#cpu-\u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u505a\u4e86\u4e0d\u5c11\u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\uff0c\u5176\u4e2d\u6d89\u53ca\u5230\u4e86\u5f88\u591a\u7684 CPU \u5fae\u67b6\u6784\u7684\u9006\u5411\uff1a</p>\n<ul>\n<li><a href=\"../../../11/11/amd_zen5/\">AMD Zen 5 \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../11/07/arm_neoverse_v2/\">ARM Neoverse V2 \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../26/apple_m1/\">Apple M1 \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../../2025/01/10/intel_golden_cove/\">Intel Golden Cove \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../../2025/01/12/intel_gracemont/\">Intel Gracemont \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../../2025/04/23/intel_redwood_cove/\">Intel Redwood Cove \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n<li><a href=\"../../../09/01/qualcomm_oryon/\">Qualcomm Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b</a></li>\n</ul>\n<p>\u56e0\u6b64\u603b\u7ed3\u4e00\u4e0b CPU \u5fae\u67b6\u6784\u9006\u5411\u65b9\u6cd5\u5b66\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b9a\u4e49\">\u5b9a\u4e49<a class=\"headerlink\" href=\"#\u5b9a\u4e49\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u5b9a\u4e49\u4e00\u4e0b\uff1a\u4ec0\u4e48\u662f CPU \u5fae\u67b6\u6784\u9006\u5411\uff0c\u6211\u8ba4\u4e3a CPU \u5fae\u67b6\u6784\u9006\u5411\u5305\u62ec\u4e24\u90e8\u5206\u542b\u4e49\uff1a</p>\n<ol>\n<li>\u5728\u5df2\u7ecf\u77e5\u9053\u67d0 CPU \u5fae\u67b6\u6784\u91c7\u7528\u67d0\u79cd\u8bbe\u8ba1\uff0c\u53ea\u662f\u4e0d\u77e5\u9053\u5176\u8bbe\u8ba1\u53c2\u6570\u65f6\uff0c\u901a\u8fc7\u9006\u5411\uff0c\u5f97\u5230\u5b83\u7684\u8bbe\u8ba1\u53c2\u6570</li>\n<li>\u5728\u4e0d\u786e\u5b9a\u67d0 CPU \u5fae\u67b6\u6784\u91c7\u7528\u7684\u662f\u4ec0\u4e48\u8bbe\u8ba1\uff0c\u7ed9\u51fa\u4e00\u4e9b\u53ef\u80fd\u7684\u8bbe\u8ba1\uff0c\u901a\u8fc7\u9006\u5411\uff0c\u6392\u9664\u6216\u786e\u8ba4\u5176\u8bbe\u8ba1\uff0c\u518d\u8fdb\u4e00\u6b65\u627e\u5230\u5b83\u7684\u8bbe\u8ba1\u53c2\u6570</li>\n</ol>\n<p>\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5df2\u7ecf\u77e5\u9053\u67d0 CPU \u5fae\u67b6\u6784\u6709\u4e00\u4e2a\u7ec4\u76f8\u8fde\u7684 L1 DCache\uff0c\u4f46\u4e0d\u77e5\u9053\u5b83\u7684\u5bb9\u91cf\uff0c\u51e0\u8def\u7ec4\u76f8\u8fde\uff0c\u6b64\u65f6\u901a\u8fc7\u5fae\u67b6\u6784\u9006\u5411\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5f97\u5230\u5b83\u7684\u5bb9\u91cf\uff0c\u5177\u4f53\u662f\u51e0\u8def\u7ec4\u76f8\u8fde\uff0c\u8fdb\u4e00\u6b65\u53ef\u80fd\u628a\u5b83\u7684 Index \u51fd\u6570\u4e5f\u9006\u5411\u51fa\u6765\u3002\u8fd9\u662f\u7b2c\u4e00\u90e8\u5206\u542b\u4e49\u3002</p>\n<p>\u518d\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5df2\u7ecf\u77e5\u9053\u67d0 CPU \u5fae\u67b6\u6784\u6709\u4e00\u4e2a\u5206\u652f\u9884\u6d4b\u5668\uff0c\u4f46\u4e0d\u77e5\u9053\u5b83\u4f7f\u7528\u4e86\u4ec0\u4e48\u4fe1\u606f\u6765\u505a\u9884\u6d4b\uff0c\u53ef\u80fd\u7528\u4e86\u5206\u652f\u7684\u5730\u5740\uff0c\u53ef\u80fd\u7528\u4e86\u5206\u652f\u8981\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740\uff0c\u53ef\u80fd\u7528\u4e86\u5206\u652f\u7684\u65b9\u5411\uff0c\u8fd9\u65f6\u5019\u901a\u8fc7\u5fae\u67b6\u6784\u9006\u5411\u7684\u65b9\u6cd5\uff0c\u5bf9\u4e0d\u540c\u7684\u53ef\u80fd\u6027\u505a\u6392\u9664\uff0c\u627e\u5230\u771f\u6b63\u7684\u90a3\u4e00\u4e2a\u3002\u5982\u679c\u4e0d\u80fd\u6392\u9664\u5230\u53ea\u5269\u4e00\u4e2a\u53ef\u80fd\uff0c\u6216\u8005\u5168\u90e8\u53ef\u80fd\u90fd\u88ab\u6392\u9664\u6389\uff0c\u8bf4\u660e\u5b9e\u9645\u7684\u5fae\u67b6\u6784\u8bbe\u8ba1\u548c\u9884\u671f\u4e0d\u76f8\u7b26\u3002</p>\n<p>\u7b2c\u4e00\u90e8\u5206\u542b\u4e49\uff0c\u76ee\u524d\u5df2\u7ecf\u6709\u5927\u91cf\u7684\u6210\u719f\u7684 Microbenchmark\uff08\u9488\u5bf9\u5fae\u67b6\u6784 Microarchitecture \u8bbe\u8ba1\u7684 Benchmark\uff0c\u53eb\u505a Microbenchmark\uff09\u6765\u89e3\u51b3\uff0c\u5b83\u4eec\u9488\u5bf9\u5e38\u89c1\u7684\u5fae\u67b6\u6784\u8bbe\u8ba1\uff0c\u5b9e\u73b0\u4e86\u5bf9\u76f8\u5e94\u8bbe\u8ba1\u53c2\u6570\u7684\u9006\u5411\u7684 Microbenchmark\uff0c\u53ef\u4ee5\u5728\u5f88\u591a\u5e73\u53f0\u4e0a\u76f4\u63a5\u4f7f\u7528\u3002\u7b2c\u4e8c\u90e8\u5206\u542b\u4e49\uff0c\u76ee\u524d\u8fd8\u53ea\u80fd\u9010\u4e2a\u5206\u6790\uff0c\u53bb\u731c\u6d4b\u80cc\u540e\u7684\u8bbe\u8ba1\uff0c\u518d\u6839\u636e\u8bbe\u8ba1\u53bb\u6784\u9020\u5bf9\u5e94\u8be5\u8bbe\u8ba1\u7684 Microbenchmark\u3002</p>\n<p>\u4e0b\u9762\u4e3b\u8981\u6765\u4ecb\u7ecd\uff0c\u8bbe\u8ba1\u548c\u5b9e\u73b0 Microbenchmark \u7684\u65b9\u6cd5\u5b66\u3002</p>\n<h2 id=\"\u539f\u7406\">\u539f\u7406<a class=\"headerlink\" href=\"#\u539f\u7406\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9996\u5148\u8981\u4e86\u89e3 Microbenchmark \u7684\u539f\u7406\uff0c\u5b83\u7684\u6838\u5fc3\u601d\u8def\u5c31\u662f\uff0c\u901a\u8fc7\u6784\u9020\u7a0b\u5e8f\uff0c\u8ba9\u67d0\u4e2a\u5fae\u67b6\u6784\u90e8\u4ef6\u6210\u4e3a\u74f6\u9888\uff0c\u63a5\u7740\u5728\u60f3\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u7684\u7ef4\u5ea6\u4e0a\u8fdb\u884c\u626b\u63cf\uff0c\u901a\u8fc7\u67d0\u79cd\u6307\u6807\u6765\u53cd\u6620\u662f\u5426\u51fa\u73b0\u4e86\u74f6\u9888\uff0c\u901a\u8fc7\u74f6\u9888\u5bf9\u5e94\u7684\u8bbe\u8ba1\u53c2\u6570\uff0c\u5c31\u53ef\u4ee5\u9006\u5411\u51fa\u6765\u8bbe\u8ba1\u53c2\u6570\u7684\u53d6\u503c\u3002\u8fd9\u4e00\u6bb5\u6709\u70b9\u96be\u7406\u89e3\uff0c\u4e0b\u9762\u7ed9\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<p>\u6bd4\u5982\u8981\u6d4b\u8bd5\u7684\u662f L1 DCache \u7684\u5bb9\u91cf\uff0c\u90a3\u5c31\u5e0c\u671b L1 DCache \u7684\u5bb9\u91cf\u53d8\u6210\u74f6\u9888\u3002\u4e3a\u4e86\u8ba9\u5b83\u6210\u4e3a\u74f6\u9888\uff0c\u90a3\u5c31\u9700\u8981\u4e0d\u65ad\u5730\u8bbf\u95ee\u4e00\u7247\u5185\u5b58\uff0c\u5b83\u7684\u5927\u5c0f\u6bd4 L1 DCache \u8981\u66f4\u5927\uff0c\u8ba9 L1 DCache \u65e0\u6cd5\u5b8c\u6574\u4fdd\u5b58\u4e0b\u6765\uff0c\u51fa\u73b0\u7f13\u5b58\u7f3a\u5931\u3002\u4e3a\u4e86\u5224\u65ad\u7f13\u5b58\u7f3a\u5931\u662f\u5426\u51fa\u73b0\uff0c\u53ef\u4ee5\u901a\u8fc7\u65f6\u95f4\u6216\u5468\u671f\uff0c\u56e0\u4e3a\u7f13\u5b58\u7f3a\u5931\u80af\u5b9a\u4f1a\u5e26\u6765\u6027\u80fd\u635f\u5931\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u7f13\u5b58\u7f3a\u5931\u7684\u6027\u80fd\u8ba1\u6570\u5668\u3002\u65e2\u7136\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u662f L1 DCache \u7684\u5bb9\u91cf\uff0c\u90a3\u5c31\u5728\u5bb9\u91cf\u4e0a\u8fdb\u884c\u4e00\u4e2a\u626b\u63cf\uff1a\u5728\u5185\u5b58\u4e2d\u5f00\u8f9f\u4e0d\u540c\u5927\u5c0f\u7684\u6570\u7ec4\uff0c\u6bd4\u5982\u4e00\u4e2a\u662f 32KB\uff0c\u53e6\u4e00\u4e2a\u662f 64KB\uff0c\u6bcf\u6b21\u6d4b\u8bd5\u7684\u65f6\u5019\u53ea\u8bbf\u95ee\u5176\u4e2d\u4e00\u4e2a\u6570\u7ec4\u3002\u6bcf\u4e2a\u6570\u7ec4\u626b\u63cf\u8bbf\u95ee\u82e5\u5e72\u6b21\uff0c\u7136\u540e\u7edf\u8ba1\u603b\u65f6\u95f4\u6216\u5468\u671f\u6570\u6216\u7f13\u5b58\u7f3a\u5931\u6b21\u6570\u3002\u5047\u5982\u5b9e\u9645 L1 DCache \u5bb9\u91cf\u4ecb\u4e8e 32KB \u548c 64KB \u4e4b\u95f4\uff0c\u90a3\u4e48\u5e94\u8be5\u53ef\u4ee5\u89c2\u5bdf\u5230 64KB \u6570\u7ec4\u5927\u5c0f\u6d4b\u5f97\u7684\u6027\u80fd\u76f8\u6bd4 32KB \u6709\u660e\u663e\u4e0b\u964d\u3002\u5982\u679c\u628a\u6d4b\u8bd5\u7c92\u5ea6\u53d8\u7ec6\uff0c\u6bcf 1KB \u8bbe\u7f6e\u4e00\u4e2a\u6570\u7ec4\u5927\u5c0f\uff0c\u6700\u7ec8\u5c31\u53ef\u4ee5\u786e\u5b9a\u5b9e\u9645\u7684 L1 DCache \u5bb9\u91cf\u3002</p>\n<p>\u5728\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u91cc\uff0c\u6210\u4e3a\u74f6\u9888\u7684\u5fae\u67b6\u6784\u90e8\u4ef6\u662f L1 DCache\uff0c\u60f3\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u662f\u5b83\u7684\u5bb9\u91cf\uff0c\u53cd\u6620\u662f\u5426\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u6027\u80fd\u6216\u7f13\u5b58\u7f3a\u5931\u6b21\u6570\uff0c\u6784\u9020\u7684\u7a0b\u5e8f\u505a\u7684\u4e8b\u60c5\u662f\u4e0d\u65ad\u5730\u8bbf\u95ee\u4e00\u4e2a\u53ef\u53d8\u5927\u5c0f\u7684\u6570\u7ec4\uff0c\u5176\u4e2d\u6570\u7ec4\u5927\u5c0f\u548c\u60f3\u8981\u9006\u5411\u7684\u8bbe\u8ba1\u53c2\u6570\u662f\u6302\u94a9\u7684\u3002</p>\n<p>\u56e0\u6b64\u53ef\u4ee5\u603b\u7ed3\u51fa Microbenchmark \u8bbe\u8ba1\u7684\u51e0\u4e2a\u8981\u7d20\uff1a</p>\n<ol>\n<li>\u9488\u5bf9\u4ec0\u4e48\u5fae\u67b6\u6784\u90e8\u4ef6</li>\n<li>\u9488\u5bf9\u8be5\u90e8\u4ef6\u7684\u4ec0\u4e48\u8bbe\u8ba1\u53c2\u6570</li>\n<li>\u53cd\u6620\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u4ec0\u4e48</li>\n<li>\u5982\u4f55\u6784\u9020\u7a0b\u5e8f\u6765\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0</li>\n<li>\u7a0b\u5e8f\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0</li>\n<li>\u7a0b\u5e8f\u7684\u53c2\u6570\u5982\u4f55\u5bf9\u5e94\u5230\u8bbe\u8ba1\u53c2\u6570\u4e0a</li>\n</ol>\n<p>\u6bd4\u5982\u4e0a\u9762\u7684 L1 DCache \u5bb9\u91cf\u7684\u6d4b\u8bd5\u4e0a\uff0c\u8fd9\u51e0\u4e2a\u8981\u7d20\u7684\u56de\u7b54\u662f\uff1a</p>\n<ol>\n<li>\u9488\u5bf9\u4ec0\u4e48\u5fae\u67b6\u6784\u90e8\u4ef6\uff1aL1 DCache</li>\n<li>\u9488\u5bf9\u8be5\u90e8\u4ef6\u7684\u4ec0\u4e48\u8bbe\u8ba1\u53c2\u6570\uff1aL1 DCache \u7684\u5bb9\u91cf</li>\n<li>\u53cd\u6620\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u4ec0\u4e48\uff1a\u65f6\u95f4\uff0c\u5468\u671f\u6570\uff0c\u7f13\u5b58\u7f3a\u5931\u6b21\u6570</li>\n<li>\u5982\u4f55\u6784\u9020\u7a0b\u5e8f\u6765\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u5728\u5185\u5b58\u4e2d\u5f00\u8f9f\u6570\u7ec4\uff0c\u7136\u540e\u4e0d\u65ad\u5730\u626b\u63cf\u8bbf\u95ee</li>\n<li>\u7a0b\u5e8f\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u6570\u7ec4\u5927\u5c0f\u8d85\u8fc7 L1 DCache \u5bb9\u91cf</li>\n<li>\u7a0b\u5e8f\u7684\u53c2\u6570\u5982\u4f55\u5bf9\u5e94\u5230\u8bbe\u8ba1\u53c2\u6570\u4e0a\uff1a\u6570\u7ec4\u7684\u5927\u5c0f\u5bf9\u5e94\u5230 L1 DCache \u7684\u5bb9\u91cf</li>\n</ol>\n<p>\u5047\u5982\u8981\u8bbe\u8ba1\u4e00\u4e2a\u9488\u5bf9 ROB(ReOrder Buffer) \u5bb9\u91cf\u7684\u6d4b\u8bd5\uff0c\u601d\u8003\u540c\u6837\u7684\u8981\u7d20\uff1a</p>\n<ol>\n<li>\u9488\u5bf9\u4ec0\u4e48\u5fae\u67b6\u6784\u90e8\u4ef6\uff1aROB</li>\n<li>\u9488\u5bf9\u8be5\u90e8\u4ef6\u7684\u4ec0\u4e48\u8bbe\u8ba1\u53c2\u6570\uff1aROB \u80fd\u5bb9\u7eb3\u591a\u5c11\u6761\u6307\u4ee4</li>\n<li>\u53cd\u6620\u51fa\u73b0\u74f6\u9888\u7684\u6307\u6807\u662f\u4ec0\u4e48\uff1a\u65f6\u95f4\uff0c\u5468\u671f\u6570</li>\n<li>\u5982\u4f55\u6784\u9020\u7a0b\u5e8f\u6765\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u5728 ROB \u5f00\u5934\u548c\u7ed3\u5c3e\u5404\u653e\u4e00\u6761\u957f\u5ef6\u8fdf\u6307\u4ee4\uff0c\u4e2d\u95f4\u586b\u5145\u82e5\u5e72\u6761\u6307\u4ee4</li>\n<li>\u7a0b\u5e8f\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u5bfc\u81f4\u74f6\u9888\u51fa\u73b0\uff1a\u5982\u679c\u6307\u4ee4\u586b\u5145\u5f97\u8db3\u591f\u591a\uff0c\u5bfc\u81f4\u7ed3\u5c3e\u7684\u957f\u5ef6\u8fdf\u6307\u4ee4\u4e0d\u80fd\u8fdb\u5165 ROB\uff0c\u90a3\u4e48\u5b83\u65e0\u6cd5\u88ab\u9884\u6d4b\u6267\u884c</li>\n<li>\u7a0b\u5e8f\u7684\u53c2\u6570\u5982\u4f55\u5bf9\u5e94\u5230\u8bbe\u8ba1\u53c2\u6570\u4e0a\uff1a\u628a\u7ed3\u5c3e\u7684\u957f\u5ef6\u8fdf\u6307\u4ee4\u963b\u62e6\u5728 ROB \u4e4b\u5916\u65f6\uff0c\u5728 ROB \u4e2d\u7684\u6307\u4ee4\u6570</li>\n</ol>\n<p>\u601d\u8003\u660e\u767d\u8fd9\u4e9b\u8981\u7d20\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u600e\u4e48\u8bbe\u8ba1\u51fa\u4e00\u4e2a Microbenchmark \u4e86\u3002</p>\n<p>\u539f\u7406\u4ecb\u7ecd\u5b8c\u4e86\uff0c\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u7528\u7684\u65b9\u6cd5\u3002</p>\n<h2 id=\"\u6307\u6807\u7684\u83b7\u53d6\">\u6307\u6807\u7684\u83b7\u53d6<a class=\"headerlink\" href=\"#\u6307\u6807\u7684\u83b7\u53d6\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e0a\u9762\u63d0\u5230\uff0c\u4e3a\u4e86\u53cd\u6620\u51fa\u74f6\u9888\uff0c\u9700\u8981\u6709\u4e00\u4e2a\u6307\u6807\uff0c\u5b83\u6700\u597d\u80fd\u591f\u7cbe\u786e\u5730\u53cd\u6620\u51fa\u74f6\u9888\u7684\u53d1\u751f\u4e0e\u5426\uff0c\u540c\u65f6\u4e5f\u5c3d\u91cf\u8981\u51cf\u5c11\u566a\u58f0\u3002\u80fd\u7528\u7684\u6307\u6807\u4e0d\u591a\uff0c\u53ea\u6709\u4e24\u7c7b\uff1a</p>\n<ol>\n<li>\u65f6\u95f4\uff1a\u6700\u901a\u7528\uff0c\u6240\u6709\u5e73\u53f0\u90fd\u53ef\u4ee5\u7528\uff0c\u5728\u7a0b\u5e8f\u524d\u540e\u5404\u8bb0\u4e00\u6b21\u65f6\u95f4\uff0c\u53d6\u5dee</li>\n<li>\u6027\u80fd\u8ba1\u6570\u5668\uff1a\u4f7f\u7528\u8d77\u6765\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6709\u65f6\u9700\u8981 root \u6743\u9650\uff0c\u6216\u8005\u786c\u4ef6\u76f8\u5173\u4fe1\u606f\u4e0d\u516c\u5f00\uff0c\u53c8\u6216\u8005\u786c\u4ef6\u5c31\u6ca1\u6709\u5b9e\u73b0\u5bf9\u5e94\u7684\u6027\u80fd\u8ba1\u6570\u5668\u3002\u5404\u5e73\u53f0\u6027\u80fd\u8ba1\u6570\u5668\u53ef\u7528\u60c5\u51b5\uff1a<ol>\n<li>Windows\uff1a\u53ef\u7528\uff0c\u6709\u73b0\u6210 <a href=\"https://learn.microsoft.com/en-us/windows/win32/perfctrs/performance-counters-portal\">API</a></li>\n<li>macOS\uff1a\u53ef\u7528\uff0c<a href=\"https://gist.github.com/ibireme/173517c208c7dc333ba962c1f0d67d12\">\u6709\u9006\u5411\u51fa\u6765\u7684\u79c1\u6709\u6846\u67b6 API</a></li>\n<li>Linux\uff1a\u53ef\u7528\uff0c<a href=\"https://man7.org/linux/man-pages/man2/perf_event_open.2.html\">\u6709\u73b0\u6210 API</a></li>\n<li>iOS\uff1a\u5728 iOS \u5916\u53ef\u4ee5\u901a\u8fc7 Xcode Instruments \u8bbf\u95ee\u6240\u6709 PMU\uff0c\u4f46\u4e0d\u65b9\u4fbf\u81ea\u52a8\u5316\uff1b\u5728 iOS \u5185\u53ea\u80fd\u901a\u8fc7 <a href=\"https://github.com/Androp0v/PowerMetricsKit/blob/3be0fd2d61785d848a32b6f5ea59aacad7739909/Sources/SampleThreads/sample_threads.c#L23\">PROC_PIDTHREADCOUNTS</a> \u83b7\u5f97\u5468\u671f\u6570\u548c\u6307\u4ee4\u6570</li>\n<li>Android\uff1a\u9700\u8981 root \u6216\u901a\u8fc7 adb shell \u4f7f\u7528\uff0c\u6bd4\u8f83\u9ebb\u70e6\uff0c<a href=\"https://man7.org/linux/man-pages/man2/perf_event_open.2.html\">API</a> \u548c Linux \u4e00\u6837</li>\n<li>HarmonyOS NEXT\uff1a\u6ca1\u627e\u5230\u65b9\u6848</li>\n</ol>\n</li>\n</ol>\n<p>\u867d\u7136\u6d4b\u65f6\u95f4\u6700\u7b80\u5355\u4e5f\u6700\u901a\u7528\uff0c\u4f46\u5b83\u4f1a\u53d7\u5230\u9891\u7387\u6ce2\u52a8\u7684\u9650\u5236\uff0c\u5982\u679c\u5728\u8fd0\u884c\u6d4b\u8bd5\u7684\u65f6\u5019\uff0c\u9891\u7387\u5267\u70c8\u53d8\u5316\uff08\u7279\u522b\u662f\u624b\u673a\u5e73\u53f0\uff09\uff0c\u5f15\u5165\u4e86\u5927\u91cf\u566a\u58f0\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6709\u6548\u4fe1\u606f\u88ab\u6df9\u6ca1\u5728\u566a\u58f0\u5f53\u4e2d\u3002</p>\n<p>\u5176\u4e2d\u6027\u80fd\u8ba1\u6570\u5668\u662f\u6700\u4e3a\u7cbe\u786e\u7684\uff0c\u867d\u7136\u4f7f\u7528\u8d77\u6765\u8f83\u4e3a\u9ebb\u70e6\uff0c\u4f46\u4e5f\u786e\u5b9e\u652f\u6491\u4e86\u5f88\u591a\u66f4\u6df1\u5165\u7684 CPU \u5fae\u67b6\u6784\u7684\u9006\u5411\u3002\u5e0c\u671b\u786c\u4ef6\u5382\u5546\u770b\u5230\u8fd9\u7bc7\u6587\u7ae0\uff0c\u4e0d\u8981\u4e3a\u4e86\u907f\u514d\u9006\u5411\u628a\u6027\u80fd\u8ba1\u6570\u5668\u85cf\u8d77\u6765\uff1a\u56e0\u4e3a\u5b83\u5bf9\u4e8e\u5e94\u7528\u7684\u6027\u80fd\u5206\u6790\u771f\u7684\u5f88\u6709\u7528\u3002\u5177\u4f53\u600e\u4e48\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u53ef\u4ee5\u53c2\u8003\u4e00\u4e9b\u73b0\u6210\u7684 Microbenchmark \u6846\u67b6\u3002</p>\n<p>\u5728\u6709\u5f02\u6784\u6838\u7684\u5904\u7406\u5668\u4e0a\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6d4b\u8bd5\u7684\u662f\u9884\u671f\u5fae\u67b6\u6784\u7684\u6838\u5fc3\uff0c\u4e00\u822c\u8fd8\u4f1a\u914d\u5408\u7ed1\u6838\uff0c\u7ed1\u6838\u5728\u9664\u4e86 macOS \u548c iOS \u4ee5\u5916\u7684\u7cfb\u7edf\u90fd\u53ef\u4ee5\u76f4\u63a5\u6307\u5b9a\u7ed1\u54ea\u4e2a\u6838\u5fc3\uff0c\u800c macOS \u548c iOS \u53ea\u80fd\u901a\u8fc7\u6307\u5b9a QoS \u6765\u5efa\u8bae\u8c03\u5ea6\u5668\u8c03\u5ea6\u5230 P \u6838\u8fd8\u662f E \u6838\uff0c\u9996\u5148\u662f\u4e0d\u80fd\u786e\u5b9a\u662f\u54ea\u4e2a P \u6838\u6216\u54ea\u4e2a E \u6838\uff0c\u5176\u6b21\u8fd9\u53ea\u662f\u4e2a\u5efa\u8bae\uff0c\u5e76\u975e\u5f3a\u5236\u3002</p>\n<h2 id=\"\u5957\u8def\">\u5957\u8def<a class=\"headerlink\" href=\"#\u5957\u8def\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u4ecb\u7ecd\u4e00\u4e9b\u6784\u9020\u74f6\u9888\u7684\u4e00\u4e9b\u5e38\u89c1\u5957\u8def\uff1a</p>\n<ol>\n<li>\u6d4b\u8bd5\u5bb9\u91cf\uff08\u6bd4\u5982\u5404\u7ea7 I/D Cache \u548c TLB\uff09\uff1a\u6784\u9020\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u53bb\u628a\u5bb9\u91cf\u7528\u6ee1\uff0c\u5f53\u5bb9\u91cf\u88ab\u7528\u6ee1\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u89c2\u5bdf\u5230\u6027\u80fd\u4e0b\u964d</li>\n<li>\u6d4b\u8bd5\u5fae\u67b6\u6784\u961f\u5217\u6216 Buffer \u6df1\u5ea6\uff08\u6bd4\u5982 ROB\uff0c\u5bc4\u5b58\u5668\u5806\uff0c\u8c03\u5ea6\u961f\u5217\uff09\uff1a\u5728\u961f\u5217\u5f00\u5934\u901a\u8fc7\u6307\u4ee4\u5835\u4f4f\u961f\u5217\u7684\u51fa\u961f\uff0c\u63a5\u7740\u4e0d\u65ad\u5730\u5411\u961f\u5217\u4e2d\u5165\u961f\u65b0\u7684\u6307\u4ee4\uff0c\u5f53\u961f\u5217\u6ee1\u7684\u65f6\u5019\uff0c\u4e0d\u518d\u80fd\u591f\u5165\u961f\u65b0\u7684\u6307\u4ee4\uff0c\u6b64\u65f6\u518d\u5f15\u5165\u4e00\u4e9b\u539f\u6765\u4e0d\u4f1a\u88ab\u5835\u4f4f\u7684\u6307\u4ee4\uff0c\u73b0\u5728\u56e0\u4e3a\u961f\u5217\u88ab\u5835\u4f4f\u4e86\u800c\u8fdb\u4e0d\u53bb\uff0c\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d</li>\n<li>\u6d4b\u8bd5\u7ec4\u76f8\u8fde\u7ed3\u6784\uff08\u6bd4\u5982 BTB\uff0cCache \u7b49\u7ec4\u76f8\u8fde\u7ed3\u6784\uff09\uff1a\u7ec4\u76f8\u8fde\u7ed3\u6784\u4e0b\uff0c\u6bcf\u4e2a Index \u5185\u7684\u5bb9\u91cf\u662f\u56fa\u5b9a\u7684\uff0c\u901a\u8fc7\u6d4b\u8bd5\u5bb9\u91cf\uff0c\u53ef\u4ee5\u5f97\u5230\u6709\u591a\u5c11 Index \u88ab\u8986\u76d6\u4e86\uff0c\u5982\u679c\u901a\u8fc7\u4fee\u6539 Index \u51fd\u6570\u7684\u8f93\u5165\uff08\u6bd4\u5982 PC\uff09\uff0c\u4f7f\u5f97\u67d0\u4e9b Index \u65e0\u6cd5\u88ab\u8bbf\u95ee\u5230\uff0c\u5c31\u53ef\u4ee5\u89c2\u5bdf\u5230\u5bb9\u91cf\u4e0a\u7684\u51cf\u5c11\uff0c\u5e76\u4e14\u5b9e\u9645\u5bb9\u91cf\u4e5f\u53cd\u9988\u51fa\u4e86\u8fd8\u6709\u591a\u5c11 Index \u80fd\u591f\u88ab\u8bbf\u95ee\u5230\u7684\u4fe1\u606f</li>\n<li>\u6784\u9020 pointer chasing\uff1a\u4ee5 8B(\u5bf9\u5e94 64 \u4f4d\u6307\u9488)\u3001\u7f13\u5b58\u884c\u5927\u5c0f\u6216\u9875\u5927\u5c0f\u4e3a\u7c92\u5ea6\uff0c\u8fdb\u884c\u968f\u673a\u6253\u4e71\uff0c\u7136\u540e\u628a\u5b83\u4eec\u7528\u6307\u9488\u4e32\u8054\u8d77\u6765\uff0c\u524d\u4e00\u4e2a\u6307\u9488\u6307\u5411\u7684\u5185\u5b58\u4e2d\u4fdd\u5b58\u540e\u4e00\u4e2a\u6307\u9488\u7684\u5730\u5740</li>\n<li>\u6784\u9020\u957f\u5ef6\u8fdf\u6307\u4ee4\uff1a\u5728\u6d4b\u8bd5\u6307\u4ee4\u961f\u5217\u76f8\u5173\u7684\u573a\u666f\u4e0b\u5e38\u7528\uff0c\u901a\u5e38\u53ef\u4ee5\u7528 pointer chasing long latency load \u6216\u8005\u4e00\u6bb5\u5177\u6709\u4e32\u884c\u4f9d\u8d56\u7684\u6d6e\u70b9\u9664\u6cd5\u6216\u5f00\u6839\u6307\u4ee4\u6765\u5b9e\u73b0</li>\n</ol>\n<p>\u518d\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u89c1\u7684\u5751\uff1a</p>\n<ol>\n<li>\u5c3d\u91cf\u7528\u6c47\u7f16\u6765\u6784\u9020\u6d4b\u4f8b\uff0cC/C++ \u7f16\u8bd1\u5668\u53ef\u80fd\u4f1a\u5e26\u6765\u4e0d\u671f\u671b\u7684\u884c\u4e3a</li>\n<li>\u94fe\u63a5\u5668\u6709\u4e00\u4e9b\u884c\u4e3a\u53ef\u80fd\u662f\u9700\u8981\u907f\u514d\u7684\uff0c\u4f8b\u5982\u5b83\u53ef\u80fd\u4f1a\u4fee\u6539\u4e00\u4e9b\u6307\u4ee4</li>\n<li>\u94fe\u63a5\u5668\u8fd8\u53ef\u80fd\u6709\u4e00\u4e9b\u5c40\u9650\u6027\uff0c\u4f8b\u5982\u5b83\u4e0d\u652f\u6301\u5de8\u5927\u7684\u5bf9\u9f50</li>\n<li>Linux \u5185\u6838\u4f1a\u505a\u4f18\u5316\uff0c\u4f8b\u5982 Copy-on-Write \u548c Transparent Huge Page</li>\n</ol>\n<h2 id=\"\u73b0\u6210-microbenchmark\">\u73b0\u6210 Microbenchmark<a class=\"headerlink\" href=\"#\u73b0\u6210-microbenchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5b9e\u9645\u4e0a\uff0c\u73b0\u5728\u5df2\u7ecf\u6709\u5f88\u591a\u73b0\u6210\u7684 Microbenchmark\uff0c\u4ee5\u53ca\u4e00\u4e9b\u8bb0\u5f55\u4e86 Microbenchmark \u7684\u6587\u6863\uff1a</p>\n<ul>\n<li><a href=\"https://www.agner.org/optimize/\">https://www.agner.org/optimize/</a></li>\n<li><a href=\"https://github.com/clamchowder/Microbenchmarks/\">https://github.com/clamchowder/Microbenchmarks/</a></li>\n<li><a href=\"https://github.com/JamesAslan/MicroArchBench\">https://github.com/JamesAslan/MicroArchBench</a></li>\n<li><a href=\"https://github.com/name99-org/AArch64-Explore\">https://github.com/name99-org/AArch64-Explore</a></li>\n<li><a href=\"https://github.com/jiegec/cpu-micro-benchmarks\">https://github.com/jiegec/cpu-micro-benchmarks</a></li>\n</ul>\n<p>\u4ee5\u53ca\u4e00\u4e9b\u7528 Microbenchmark \u505a\u9006\u5411\u5e76\u516c\u5f00\u7684\u7f51\u7ad9\uff1a</p>\n<ul>\n<li><a href=\"https://chipsandcheese.com\">https://chipsandcheese.com</a></li>\n<li><a href=\"https://www.anandtech.com\">https://www.anandtech.com</a>\uff08\u53ef\u60dc\u4e0d\u518d\u66f4\u65b0\uff09</li>\n<li><a href=\"https://blog.hjc.im/\">https://blog.hjc.im/</a></li>\n<li><a href=\"https://www.zhihu.com/people/jamesaslan\">https://www.zhihu.com/people/jamesaslan</a></li>\n<li><a href=\"https://uops.info\">https://uops.info</a></li>\n<li>\u672c\u535a\u5ba2</li>\n</ul>\n<p>\u5982\u679c\u4f60\u60f3\u8981\u53bb\u9006\u5411\u67d0\u4e2a\u5fae\u67b6\u6784\u7684\u67d0\u4e2a\u90e8\u4ef6\uff0c\u4f46\u4e0d\u77e5\u9053\u600e\u4e48\u505a\uff0c\u4e0d\u59a8\u5728\u4e0a\u9762\u8fd9\u4e9b\u7f51\u7ad9\u4e0a\u5bfb\u627e\u4e00\u4e0b\uff0c\u662f\u4e0d\u662f\u5df2\u7ecf\u6709\u73b0\u6210\u7684\u5b9e\u73b0\u4e86\u3002</p>\n<p>\u5982\u679c\u4f60\u5bf9\u5982\u4f55\u7f16\u5199\u8fd9\u4e9b Microbenchmark \u4e0d\u611f\u5174\u8da3\uff0c\u4e5f\u53ef\u4ee5\u8bd5\u8bd5\u5728\u81ea\u5df1\u7535\u8111\u4e0a\u8fd0\u884c\u8fd9\u4e9b\u7a0b\u5e8f\uff0c\u6216\u8005\u76f4\u63a5\u9605\u8bfb\u5df2\u6709\u7684\u5206\u6790\u3002</p>", "image": null, "date_modified": "2024-12-27T00:00:00+00:00", "authors": [], "tags": ["cpu", "hardware", "uarch-review"]}, {"id": "https://jia.je/hardware/2024/12/26/apple_m1/", "url": "https://jia.je/hardware/2024/12/26/apple_m1/", "title": "Apple M1 (Firestorm &amp; Icestorm) \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"apple-m1-firestorm--icestorm-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Apple M1 (Firestorm &amp; Icestorm) \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#apple-m1-firestorm--icestorm-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u867d\u7136 Apple M1 \u5df2\u7ecf\u662f 2020 \u5e74\u7684\u5904\u7406\u5668\uff0c\u4f46\u5b83\u5bf9\u82f9\u679c\u81ea\u7814\u82af\u7247\u6765\u8bf4\u662f\u4e00\u4e2a\u91cc\u7a0b\u7891\uff0c\u8003\u8651\u5230 X Elite \u5904\u7406\u5668\u7684 Oryon \u5fae\u67b6\u6784\u548c Apple M1 \u6027\u80fd\u6838 Firestorm \u5fae\u67b6\u6784\u7684\u76f8\u4f3c\u6027\uff0c\u8fd8\u662f\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a Firestorm + Icestorm \u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002Apple A14 \u91c7\u7528\u4e86\u548c Apple M1 \u4e00\u6837\u7684\u5fae\u67b6\u6784\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>Apple M1 \u7684\u5b98\u65b9\u4fe1\u606f\u4e4f\u5584\u53ef\u9648\uff0c\u5173\u4e8e\u5fae\u67b6\u6784\u7684\u4fe1\u606f\u51e0\u4e4e\u4e3a\u96f6\uff0c\u4f46\u80fd\u4ece\u64cd\u4f5c\u7cfb\u7edf\u6c47\u62a5\u7684\u786c\u4ef6\u4fe1\u606f\u4e2d\u627e\u5230\u4e00\u4e9b\u5185\u5bb9\u3002</p>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Apple M1 \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://dougallj.github.io/applecpu/firestorm.html\">Apple Microarchitecture Research by Dougall Johnson</a></li>\n<li><a href=\"https://www.anandtech.com/show/16226/apple-silicon-m1-a14-deep-dive\">Apple Announces The Apple Silicon M1: Ditching x86 - What to Expect, Based on A14 - Anandtech</a></li>\n<li><a href=\"https://github.com/name99-org/AArch64-Explore\">Exploration of Apple CPUs</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/611213899\">Apple M1 Icestorm \u5fae\u67b6\u6784\u8bc4\u6d4b\uff08\u4e0a\uff09:\u91cd\u94f8\u5c0f\u6838\u8363\u5149</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/613097964\">Apple M1 Icestorm \u5fae\u67b6\u6784\uff08\u4e0b\uff09:\u91cd\u94f8\u5c0f\u6838\u8363\u5149</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/595582920\">\u82f9\u679c\u7684\u9ed1\u9b54\u6cd5\uff1fApple M1 \u7684\u6808\u64cd\u4f5c\u6d88\u9664\uff08\u4e0a\uff09</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/600349467\">\u82f9\u679c\u7684\u9ed1\u9b54\u6cd5\uff1f\uff08\u4e0b\uff09Apple M1 \u7684\u6808\u64cd\u4f5c\u6d88\u9664</a></li>\n<li><a href=\"https://github.com/dougallj/applecpu\">Apple Firestorm/Icestorm CPU microarchitecture docs</a></li>\n<li><a href=\"https://www.anandtech.com/show/16252/mac-mini-apple-m1-tested\">The 2020 Mac Mini Unleashed: Putting Apple Silicon M1 To The Test</a></li>\n<li><a href=\"https://github.com/name99-org/AArch64-Explore\">Exploration of Apple CPUs</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Apple Firestorm \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002Apple Icestorm \u5c1a\u672a\u8fdb\u884c\u6027\u80fd\u6d4b\u8bd5\u3002</p>\n<h2 id=\"\u73af\u5883\u51c6\u5907\">\u73af\u5883\u51c6\u5907<a class=\"headerlink\" href=\"#\u73af\u5883\u51c6\u5907\" title=\"Permanent link\">&para;</a></h2>\n<p>Apple M1 \u9884\u88c5\u7684\u662f macOS\uff0cmacOS \u7684\u7ed1\u6838\u53ea\u80fd\u7ed1\u5230 P \u6216\u8005 E\uff0c\u4e0d\u80fd\u5177\u4f53\u5230\u67d0\u4e00\u4e2a\u6838\u4e0a\uff1b\u5728 macOS \u4e0a\u53ef\u4ee5\u8bfb\u53d6 PMU\uff0c\u9700\u8981\u4f7f\u7528 kpep \u7684\u79c1\u6709\u6846\u67b6\uff0c\u4ee3\u7801\u53ef\u4ee5\u5728<a href=\"https://github.com/jiegec/cpu-micro-benchmarks\">\u8fd9\u91cc</a>\u627e\u5230\u3002</p>\n<p>\u5982\u679c\u60f3\u66f4\u65b9\u4fbf\u5730\u8fdb\u884c\u6d4b\u8bd5\uff0c\u5efa\u8bae\u5b89\u88c5 Asahi Linux \u7684\u5404\u79cd\u53d1\u884c\u7248\uff0c\u6b64\u65f6\u53ef\u4ee5\u5728 Linux \u4e0b\u81ea\u7531\u5730\u7ed1\u6838\uff0c\u4e5f\u53ef\u4ee5\u7528\u6807\u51c6\u7684\u65b9\u5f0f\u4f7f\u7528 PMU\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u53d6\u6307\">\u53d6\u6307<a class=\"headerlink\" href=\"#\u53d6\u6307\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u5b9e\u9645\u7684 Fetch \u5bbd\u5ea6\uff0c\u53c2\u8003 <a href=\"https://zhuanlan.zhihu.com/p/720136752\">\u5982\u4f55\u6d4b\u91cf\u771f\u6b63\u7684\u53d6\u6307\u5e26\u5bbd\uff08I-fetch width\uff09 - JamesAslan</a> \u6784\u9020\u4e86\u6d4b\u8bd5\u3002\u5176\u539f\u7406\u662f\u5f53 Fetch \u8981\u8de8\u9875\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u4e24\u4e2a\u76f8\u90bb\u9875\u53ef\u80fd\u6620\u5c04\u5230\u4e0d\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u5982\u679c\u8981\u652f\u6301\u5355\u5468\u671f\u8de8\u9875\u53d6\u6307\uff0c\u9700\u8981\u67e5\u8be2\u4e24\u6b21 ITLB\uff0c\u6216\u8005 ITLB \u9700\u8981\u628a\u76f8\u90bb\u4e24\u4e2a\u9875\u7684\u6620\u5c04\u5b58\u5728\u4e00\u8d77\u3002\u8fd9\u4e2a\u573a\u666f\u4e00\u822c\u6bd4\u8f83\u5c11\uff0c\u5904\u7406\u5668\u5f88\u5c11\u4f1a\u9488\u5bf9\u8fd9\u79cd\u7279\u6b8a\u60c5\u51b5\u505a\u4f18\u5316\uff0c\u4f46\u4e5f\u4e0d\u662f\u6ca1\u6709\u3002\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u628a\u5faa\u73af\u653e\u5728\u4e24\u4e2a\u9875\u7684\u8fb9\u754c\u4e0a\uff0c\u53d1\u73b0 Firestorm \u5fae\u67b6\u6784\u9047\u5230\u8de8\u9875\u7684\u53d6\u6307\u65f6\u786e\u5b9e\u4f1a\u62c6\u6210\u4e24\u4e2a\u5468\u671f\u6765\u8fdb\u884c\u3002\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u5728\u7b2c\u4e00\u4e2a\u9875\u7684\u6700\u540e\u56db\u4e2a\u5b57\u8282\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u4e0a\uff0c\u90a3\u4e48\u6bcf\u6b21\u5faa\u73af\u7684\u53d6\u6307\u65f6\u95f4\uff0c\u5c31\u662f\u4e00\u4e2a\u5468\u671f\uff08\u8bfb\u53d6\u7b2c\u4e00\u4e2a\u9875\u5185\u7684\u6307\u4ee4\uff09\u52a0\u4e0a\u7b2c\u4e8c\u4e2a\u9875\u5185\u6307\u4ee4\u9700\u8981 Fetch \u7684\u5468\u671f\u6570\uff0c\u591a\u7684\u8fd9\u4e00\u4e2a\u5468\u671f\u5c31\u8db3\u4ee5\u628a Fetch \u5bbd\u5ea6\u4ece\u540e\u7aef\u9650\u5236\u4e2d\u533a\u5206\u5f00\uff0c\u5b9e\u9a8c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_if_width.png\" /></p>\n<p>\u56fe\u4e2d\u84dd\u7ebf\uff08cross-page\uff09\u8868\u793a\u7684\u5c31\u662f\u4e0a\u9762\u6240\u8ff0\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u4e00\u4e2a\u9875\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u7684\u60c5\u51b5\uff0c\u6a2a\u5750\u6807\u662f\u7b2c\u4e8c\u4e2a\u9875\u5185\u7684\u6307\u4ee4\u6570\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u7684\u6307\u4ee4\u6570\u7b49\u4e8e\u6a2a\u5750\u6807 +1\u3002\u7eb5\u5750\u6807\u662f\u8fd0\u884c\u5f88\u591a\u6b21\u5faa\u73af\u7684\u603b cycle \u6570\u9664\u4ee5\u5faa\u73af\u6b21\u6570\uff0c\u4e5f\u5c31\u662f\u5e73\u5747\u6bcf\u6b21\u5faa\u73af\u8017\u8d39\u7684\u5468\u671f\u6570\u3002\u53ef\u4ee5\u770b\u5230\u6bcf 16 \u6761\u6307\u4ee4\u4f1a\u591a\u4e00\u4e2a\u5468\u671f\uff0c\u56e0\u6b64 Firestorm \u7684\u524d\u7aef\u53d6\u6307\u5bbd\u5ea6\u786e\u5b9e\u662f 16 \u6761\u6307\u4ee4\u3002\u4e3a\u4e86\u786e\u8ba4\u8fd9\u4e2a\u74f6\u9888\u662f\u7531\u53d6\u6307\u9020\u6210\u7684\uff0c\u53c8\u6784\u9020\u4e86\u4e00\u7ec4\u5b9e\u9a8c\uff0c\u628a\u5faa\u73af\u7684\u6240\u6709\u6307\u4ee4\u90fd\u653e\u5230\u4e00\u4e2a\u9875\u4e2d\uff0c\u8fd9\u4e2a\u65f6\u5019 Fetch \u4e0d\u518d\u6210\u4e3a\u74f6\u9888\uff08\u56fe\u4e2d aligned\uff09\uff0c\u4e24\u4e2a\u66f2\u7ebf\u7684\u5bf9\u6bd4\u53ef\u4ee5\u660e\u786e\u5730\u5f97\u51fa\u4e0a\u8ff0\u7ed3\u8bba\u3002</p>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 Icestorm\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_if_width.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u6bcf 8 \u6761\u6307\u4ee4\u4f1a\u591a\u4e00\u4e2a\u5468\u671f\uff0c\u610f\u5473\u7740 Icestorm \u7684\u524d\u7aef\u53d6\u6307\u5bbd\u5ea6\u4e3a 8 \u6761\u6307\u4ee4\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0cFirestorm \u5177\u6709 192KB L1 ICache\uff0cIcestorm \u5177\u6709 128KB L1 ICache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>hw.perflevel0.l1icachesize: 196608\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>hw.perflevel1.l1icachesize: 131072\n</span></code></pre></div>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b Firestorm \u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 192 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 8 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2.22 IPC\uff0c\u8fd9\u91cc\u7684 192 KB \u5c31\u5bf9\u5e94\u4e86 Firestorm \u7684 L1 ICache \u7684\u5bb9\u91cf\u3002\u867d\u7136 Fetch \u53ef\u4ee5\u6bcf\u5468\u671f 16 \u6761\u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u4e00\u6761 64B \u7684\u7f13\u5b58\u884c\uff0c\u7531\u4e8e\u540e\u7aef\u7684\u9650\u5236\uff0c\u53ea\u80fd\u89c2\u5bdf\u5230 8 \u7684 IPC\u3002</p>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 Icestorm\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 128 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 4 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2.10 IPC\uff0c\u8fd9\u91cc\u7684 128 KB \u5c31\u5bf9\u5e94\u4e86 Icestorm \u7684 L1 ICache \u7684\u5bb9\u91cf\u3002\u867d\u7136 Fetch \u53ef\u4ee5\u6bcf\u5468\u671f 8 \u6761\u6307\u4ee4\uff0c\u7531\u4e8e\u540e\u7aef\u7684\u9650\u5236\uff0c\u53ea\u80fd\u89c2\u5bdf\u5230 4 \u7684 IPC\u3002</p>\n<h3 id=\"btb\">BTB<a class=\"headerlink\" href=\"#btb\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"firestorm\">Firestorm<a class=\"headerlink\" href=\"#firestorm\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u5927\u91cf\u7684\u65e0\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff08B \u6307\u4ee4\uff09\uff0cBTB \u9700\u8981\u8bb0\u5f55\u8fd9\u4e9b\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\uff0c\u90a3\u4e48\u5982\u679c\u5206\u652f\u6570\u91cf\u8d85\u8fc7\u4e86 BTB \u7684\u5bb9\u91cf\uff0c\u6027\u80fd\u4f1a\u51fa\u73b0\u660e\u663e\u4e0b\u964d\u3002\u5f53\u628a\u5927\u91cf B \u6307\u4ee4\u7d27\u5bc6\u653e\u7f6e\uff0c\u4e5f\u5c31\u662f\u6bcf 4 \u5b57\u8282\u4e00\u6761 B \u6307\u4ee4\u65f6\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_btb_4b.png\" /></p>\n<p>\u53ef\u89c1\u5728 1024 \u4e2a\u5206\u652f\u4e4b\u5185\u53ef\u4ee5\u8fbe\u5230 1 \u7684 CPI\uff0c\u8d85\u8fc7 1024 \u4e2a\u5206\u652f\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u5e73\u53f0\uff0c\u4e00\u76f4\u5ef6\u7eed\u5230 49152 \u4e2a\u5206\u652f\u3002\u8d85\u51fa BTB \u5bb9\u91cf\u4ee5\u540e\uff0c\u5206\u652f\u9884\u6d4b\u65f6\uff0c\u65e0\u6cd5\u4ece BTB \u4e2d\u5f97\u5230\u54ea\u4e9b\u6307\u4ee4\u662f\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u53ea\u80fd\u7b49\u5230\u53d6\u6307\u751a\u81f3\u8bd1\u7801\u540e\u624d\u80fd\u540e\u77e5\u540e\u89c9\u5730\u53d1\u73b0\u8fd9\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u8fd9\u6837\u5c31\u51fa\u73b0\u4e86\u6027\u80fd\u635f\u5931\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u60c5\u51b5\u3002\u7b2c\u4e8c\u4e2a\u62d0\u70b9 49152\uff0c\u5bf9\u5e94\u7684\u662f\u6307\u4ee4 footprint \u8d85\u51fa L1 ICache \u7684\u60c5\u51b5\uff1aL1 ICache \u662f 192KB\uff0c\u6309\u7167\u6bcf 4 \u5b57\u8282\u4e00\u4e2a B \u6307\u4ee4\u8ba1\u7b97\uff0c\u6700\u591a\u53ef\u4ee5\u5b58\u653e 49152 \u6761 B \u6307\u4ee4\u3002</p>\n<p>\u964d\u4f4e\u5206\u652f\u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u5728 B \u6307\u4ee4\u4e4b\u95f4\u63d2\u5165 NOP \u6307\u4ee4\uff0c\u4f7f\u5f97\u6bcf 8 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_btb_8b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 CPI=1 \u7684\u62d0\u70b9\u524d\u79fb\u5230 1024 \u4e2a\u5206\u652f\uff0c\u540c\u65f6 CPI=3 \u7684\u5e73\u53f0\u7684\u62d0\u70b9\u4e5f\u524d\u79fb\u5230\u4e86 24576\u3002\u62d0\u70b9\u7684\u524d\u79fb\uff0c\u610f\u5473\u7740 BTB \u91c7\u7528\u4e86\u7ec4\u76f8\u8fde\u7684\u7ed3\u6784\uff0c\u5f53 B \u6307\u4ee4\u7684 PC \u7684\u90e8\u5206\u4f4e\u4f4d\u603b\u662f\u4e3a 0 \u65f6\uff0c\u7ec4\u76f8\u8fde\u7684 Index \u53ef\u80fd\u65e0\u6cd5\u53d6\u5230\u6240\u6709\u7684 Set\uff0c\u5bfc\u81f4\u8868\u73b0\u51fa\u6765\u7684 BTB \u5bb9\u91cf\u53ea\u6709\u90e8\u5206 Set\uff0c\u4f8b\u5982\u6b64\u5904\u5bb9\u91cf\u51cf\u534a\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u534a\u7684 Set \u88ab\u7528\u5230\u4e86\u3002</p>\n<p>\u5982\u679c\u8fdb\u4e00\u6b65\u964d\u4f4e B \u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u4f7f\u5f97\u5b83\u7684\u4f4e\u82e5\u5e72\u4f4d\u90fd\u7b49\u4e8e 0\uff0c\u6700\u7ec8 CPI=1 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 2 \u6761\u5206\u652f\uff0c\u6b64\u65f6\u5206\u652f\u7684\u95f4\u8ddd\u5927\u4e8e\u6216\u7b49\u4e8e 2048B\uff1bCPI=3 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 6 \u6761\u5206\u652f\uff0c\u6b64\u65f6\u5206\u652f\u7684\u95f4\u8ddd\u5927\u4e8e\u6216\u7b49\u4e8e 32KB\u3002\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\uff0c\u53ef\u4ee5\u8ba4\u4e3a Firestorm \u7684 BTB \u662f 512 Set 2 Way \u7684\u7ed3\u6784\uff0cIndex \u662f PC[10:2]\uff1b\u540c\u65f6\u4e5f\u4fa7\u9762\u4f50\u8bc1\u4e86 192KB L1 ICache \u662f 512 Set 6 Way\uff0cIndex \u662f PC[14:6]\u3002</p>\n<h4 id=\"icestorm\">Icestorm<a class=\"headerlink\" href=\"#icestorm\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u76f8\u540c\u7684\u65b9\u5f0f\u6d4b\u8bd5 Icestorm\uff0c\u9996\u5148\u7528 4B \u7684\u95f4\u8ddd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_4b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 1024 \u7684\u62d0\u70b9\uff0c1024 \u4e4b\u524d\u662f 1 IPC\uff0c\u4e4b\u540e\u589e\u52a0\u5230 3 IPC\u3002\u6bd4\u8f83\u5947\u602a\u7684\u662f\uff0c\u6ca1\u6709\u770b\u5230\u7b2c\u4e8c\u4e2a\u62d0\u70b9\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u5728 8B \u7684\u95f4\u8ddd\u4e0b\u663e\u73b0\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_8b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u524d\u79fb\u5230 512\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 16384\uff0c\u800c Icestorm \u7684 L1 ICache \u5bb9\u91cf\u662f 128KB\uff0c8B \u95f4\u8ddd\u4e0b\u6b63\u597d\u53ef\u4ee5\u4fdd\u5b58 16384 \u4e2a\u5206\u652f\u3002</p>\n<p>\u7528 16B \u95f4\u8ddd\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_16b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u524d\u79fb\u5230 256\uff0c\u7136\u540e\u51fa\u73b0\u4e86\u4e00\u4e2a 2 CPI \u7684\u65b0\u5e73\u53f0\uff0c2 CPI \u7684\u5e73\u53f0\u7684\u62d0\u70b9\u51fa\u73b0\u5728 2048\uff0c\u7b2c\u4e09\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 8192\uff0c\u5bf9\u5e94 L1 ICache \u5bb9\u91cf\u3002</p>\n<p>\u7528 32B \u95f4\u8ddd\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_32b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u5728 1024\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 4096\uff0c\u5bf9\u5e94 L1 ICache \u5bb9\u91cf\uff0c\u6ca1\u6709\u89c2\u5bdf\u5230 2 CPI\u3002</p>\n<p>\u7528 64B \u95f4\u8ddd\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_btb_64b.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u5728 512\uff0c\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u51fa\u73b0\u5728 2048\uff0c\u5bf9\u5e94 L1 ICache \u5bb9\u91cf\u3002</p>\n<p>Icestorm \u7684 BTB \u6d4b\u8bd5\u7ed3\u679c\u5e76\u4e0d\u50cf Firestorm \u90a3\u6837\u6709\u89c4\u5f8b\uff0c\u6839\u636e\u8fd9\u4e2a\u73b0\u8c61\uff0c\u7ed9\u51fa\u4e00\u4e9b\u731c\u6d4b\uff1a</p>\n<ol>\n<li>\u53ef\u80fd\u53ea\u6709\u4e00\u7ea7 BTB\uff0c\u4f46\u5b83\u7684 Index \u51fd\u6570\u8fdb\u884c\u4e86\u4e00\u4e9b Hash \u800c\u975e\u76f4\u63a5\u53d6 PC \u67d0\u51e0\u4f4d\uff0c\u4f7f\u5f97\u968f\u7740\u5206\u652f\u7684\u95f4\u8ddd\u589e\u5927\uff0cCPI=1 \u7684\u62d0\u70b9\u5e76\u975e\u5355\u8c03\u9012\u51cf\uff1b\u4f46\u8fd9\u65e0\u6cd5\u89e3\u91ca\u4e3a\u4f55 16B \u95f4\u8ddd\u65f6\u4f1a\u51fa\u73b0 2 CPI \u7684\u5e73\u53f0</li>\n<li>\u53ef\u80fd\u6709\u4e24\u7ea7 BTB\uff0c\u5b83\u4eec\u5e76\u975e\u7b80\u5355\u5730\u7ea7\u8054\uff0c\u800c\u662f\u901a\u8fc7\u4e0d\u540c\u7684\u7ec4\u7ec7\u65b9\u5f0f\uff0c\u5728\u4e0d\u540c\u7684\u533a\u95f4\u5185\u53d1\u6325\u4f5c\u7528</li>\n</ol>\n<p>\u9488\u5bf9 4B \u95f4\u8ddd\u6ca1\u6709\u51fa\u73b0 CPI&gt;3 \u7684\u60c5\u51b5\uff0c\u7ed9\u51fa\u4e00\u4e9b\u731c\u6d4b\uff1a</p>\n<ol>\n<li>\u6d4b\u8bd5\u89c4\u6a21\u4e0d\u591f\u5927\uff0c\u628a\u5206\u652f\u6570\u91cf\u7ee7\u7eed\u589e\u5927\uff0c\u624d\u80fd\u51fa\u73b0 CPI&gt;3 \u7684\u60c5\u51b5</li>\n<li>\u6307\u4ee4\u9884\u53d6\u5668\u5728\u5de5\u4f5c\uff0c\u5f53 footprint \u5927\u4e8e 128KB L1 ICache \u65f6\uff0c\u80fd\u63d0\u524d\u628a\u6307\u4ee4\u53d6\u8fdb\u6765</li>\n</ol>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 B \u6307\u4ee4\uff0c\u4f7f\u5f97 B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff0c\u5728 Firestorm \u4e0a\u8fdb\u884c\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_itlb.png\" /></p>\n<p>\u4ece 1 Cycle \u5230 3 Cycle \u7684\u589e\u52a0\u662f\u7531\u4e8e L1 BTB \u7684\u51b2\u7a81\u7f3a\u5931\uff0c\u4e4b\u540e\u5728 192 \u4e2a\u9875\u65f6\u4ece 3 Cycle \u5feb\u901f\u589e\u52a0\u5230 13 Cycle\uff0c\u5219\u5bf9\u5e94\u4e86 192 \u9879\u7684 L1 ITLB \u5bb9\u91cf\u3002</p>\n<p>\u5728 Icestorm \u4e0a\u91cd\u590d\u5b9e\u9a8c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_itlb.png\" /></p>\n<p>\u53ea\u6709\u4e00\u4e2a\u62d0\u70b9\uff0c\u5728 128 \u4e2a\u9875\u65f6\uff0c\u6027\u80fd\u4ece 1 Cycle \u4e0b\u964d\u5230 8 Cycle\uff0c\u610f\u5473 L1 ITLB \u5bb9\u91cf\u662f 128 \u9879\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece\u524d\u9762\u7684\u6d4b\u8bd5\u6765\u770b\uff0cFirestorm \u6700\u5927\u89c2\u5bdf\u5230 8 IPC\uff0cIcestorm \u6700\u5927\u89c2\u5bdf\u5230 4 IPC\uff0c\u90a3\u4e48 Decode \u5bbd\u5ea6\u4e5f\u81f3\u5c11\u662f\u8fd9\u4e48\u591a\uff0c\u6682\u65f6\u4e5f\u4e0d\u80fd\u6392\u9664\u6709\u66f4\u5927\u7684 Decode \u5bbd\u5ea6\u3002</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\uff0c\u5728 Firestorm \u4e0a\u5f97\u5230\u4e0b\u9762\u7684\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 50 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 Firestorm \u7684 Return Stack \u6df1\u5ea6\u4e3a 50\u3002\u5728 Icestorm \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 32 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 Icestorm \u7684 Return Stack \u6df1\u5ea6\u4e3a 32\u3002</p>\n<h3 id=\"conditional-branch-predictor\">Conditional Branch Predictor<a class=\"headerlink\" href=\"#conditional-branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53c2\u8003 <a href=\"https://arxiv.org/abs/2411.13900\">Dissecting Conditional Branch Predictors of Apple Firestorm and Qualcomm Oryon for Software Optimization and Architectural Analysis</a> \u8bba\u6587\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u6d4b\u51fa Firestorm \u7684\u5206\u652f\u9884\u6d4b\u5668\u91c7\u7528\u7684\u5386\u53f2\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 100 \u4f4d\u7684 Path History Register for Target(PHRT) \u4ee5\u53ca 28 \u4f4d\u7684 Path History Register for Branch(PHRB)\uff0c\u6bcf\u6b21\u6267\u884c taken branch \u65f6\u66f4\u65b0</li>\n<li>\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a<code>PHRTnew = (PHRTold &lt;&lt; 1) xor T[31:2], PHRBnew = (PHRBold &lt;&lt; 1) xor B[5:2]</code>\uff0c\u5176\u4e2d B \u4ee3\u8868\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0cT \u4ee3\u8868\u5206\u652f\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740</li>\n</ol>\n<p>Icestorm \u7684\u5206\u652f\u9884\u6d4b\u5668\u91c7\u7528\u7684\u5386\u53f2\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 60 \u4f4d\u7684 Path History Register for Target(PHRT) \u4ee5\u53ca 16 \u4f4d\u7684 Path History Register for Branch(PHRB)\uff0c\u6bcf\u6b21\u6267\u884c taken branch \u65f6\u66f4\u65b0</li>\n<li>\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a<code>PHRTnew = (PHRTold &lt;&lt; 1) xor T[47:2], PHRBnew = (PHRBold &lt;&lt; 1) xor B[5:2]</code>\uff0c\u5176\u4e2d B \u4ee3\u8868\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0cT \u4ee3\u8868\u5206\u652f\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740</li>\n</ol>\n<p>\u5404\u5382\u5546\u5904\u7406\u5668\u7684 PHR \u66f4\u65b0\u89c4\u5219\u89c1 <a href=\"https://jia.je/cpu/cbp.html\">jiegec/cpu</a>\u3002</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u7269\u7406\u5bc4\u5b58\u5668\u5806\">\u7269\u7406\u5bc4\u5b58\u5668\u5806<a class=\"headerlink\" href=\"#\u7269\u7406\u5bc4\u5b58\u5668\u5806\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u7269\u7406\u5bc4\u5b58\u5668\u5806\u7684\u5927\u5c0f\uff0c\u4e00\u822c\u4f1a\u7528\u4e24\u4e2a\u4f9d\u8d56\u94fe\u5f88\u957f\u7684\u64cd\u4f5c\u653e\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\uff0c\u4e2d\u95f4\u586b\u5165\u82e5\u5e72\u4e2a\u65e0\u5173\u7684\u6307\u4ee4\uff0c\u5e76\u4e14\u7528\u8fd9\u4e9b\u6307\u4ee4\u6765\u8017\u8d39\u7269\u7406\u5bc4\u5b58\u5668\u5806\u3002Firestorm \u6d4b\u8bd5\u7ed3\u679c\u89c1\u4e0b\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_prf.png\" /></p>\n<ul>\n<li>32b/64b int\uff1a\u6d4b\u8bd5 speculative 32/64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 362</li>\n<li>32b fp\uff1a\u6d4b\u8bd5 speculative 32 \u4f4d\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 382</li>\n<li>flags\uff1a\u6d4b\u8bd5 speculative NZCV \u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 123</li>\n</ul>\n<p>Icestorm \u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_prf.png\" /></p>\n<ul>\n<li>32b/64b int\uff1a\u6d4b\u8bd5 speculative 32/64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 78</li>\n<li>32b fp\uff1a\u6d4b\u8bd5 speculative 32 \u4f4d\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 382</li>\n<li>flags\uff1a\u6d4b\u8bd5 speculative NZCV \u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 75</li>\n</ul>\n<p>\u6ce8\u610f\u8fd9\u91cc\u6d4b\u8bd5\u7684\u90fd\u662f\u80fd\u591f\u7528\u4e8e\u9884\u6d4b\u6267\u884c\u7684\u5bc4\u5b58\u5668\u6570\u91cf\uff0c\u5b9e\u9645\u7684\u7269\u7406\u5bc4\u5b58\u5668\u5806\u8fd8\u9700\u8981\u4fdd\u5b58\u67b6\u6784\u5bc4\u5b58\u5668\u3002\u4f46\u5177\u4f53\u4fdd\u5b58\u591a\u5c11\u4e2a\u67b6\u6784\u5bc4\u5b58\u5668\u4e0d\u786e\u5b9a\uff0c\u4f46\u81f3\u5c11 32 \u4e2a\u6574\u6570\u901a\u7528\u5bc4\u5b58\u5668\u548c\u6d6e\u70b9\u5bc4\u5b58\u5668\u662f\u4e00\u5b9a\u6709\u7684\uff0c\u4f46\u53ef\u80fd\u8fd8\u6709\u4e00\u4e9b\u989d\u5916\u7684\u9700\u8981\u91cd\u547d\u540d\u7684\u72b6\u6001\u4e5f\u8981\u7b97\u8fdb\u6765\u3002</p>\n<h3 id=\"load-store-unit--l1-dcache\">Load Store Unit + L1 DCache<a class=\"headerlink\" href=\"#load-store-unit--l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"l1-dcache-\u5bb9\u91cf\">L1 DCache \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dcache-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0cFirestorm \u5177\u6709 128KB L1 DCache\uff0cIcestorm \u5177\u6709 64KB L1 DCache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>hw.perflevel0.l1dcachesize: 131072\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>hw.perflevel1.l1dcachesize: 65536\n</span></code></pre></div>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff0cFirestorm \u4e0a\u7684\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 128KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 128KB \u7684 L1 DCache \u5bb9\u91cf\u3002L1 DCache \u8303\u56f4\u5185\u5ef6\u8fdf\u662f 3 cycle\uff0c\u4e4b\u540e\u63d0\u5347\u5230 16 cycle\u3002</p>\n<p>Icestorm \u4e0a\u7684\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 64KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 64KB \u7684 L1 DCache \u5bb9\u91cf\u3002L1 DCache \u8303\u56f4\u5185\u5ef6\u8fdf\u662f 3 cycle\uff0c\u4e4b\u540e\u63d0\u5347\u5230 14 cycle\u3002</p>\n<h4 id=\"l1-dtlb-\u5bb9\u91cf\">L1 DTLB \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dtlb-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21 pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff0c\u5728 Firestorm \u4e0a\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_l1dtlb.png\" /></p>\n<p>\u4ece 160 \u4e2a\u9875\u5f00\u59cb\u6027\u80fd\u4e0b\u964d\uff0c\u5230 250 \u4e2a\u9875\u65f6\u6027\u80fd\u7a33\u5b9a\u5728 9 CPI\uff0c\u8ba4\u4e3a Firestorm \u7684 L1 DTLB \u6709 160 \u9879\u30029 CPI \u5305\u62ec\u4e86 L1 DTLB miss L2 TLB hit \u5e26\u6765\u7684\u989d\u5916\u5ef6\u8fdf\u3002</p>\n<p>\u5982\u679c\u6bcf\u4e24\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u5219\u62d0\u70b9\u524d\u79fb\u5230 80\uff1b\u6bcf\u56db\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 40\uff1b\u6bcf\u516b\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 20\uff1b\u6bcf 16 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u662f 10\uff1b\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 5\uff1b\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u4f9d\u7136\u662f 5\u3002\u8bf4\u660e Firestorm \u7684 L1 DTLB \u662f 5 \u8def\u7ec4\u76f8\u8fde\uff0c32 \u4e2a Set\uff0cIndex \u662f VA[18:14]\uff0c\u6ce8\u610f\u9875\u8868\u5927\u5c0f\u662f 16KB\u3002</p>\n<p>Icestorm:</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_l1dtlb.png\" /></p>\n<p>\u4ece 128 \u4e2a\u9875\u5f00\u59cb\u6027\u80fd\u4e0b\u964d\uff0c\u5230 160 \u4e2a\u9875\u65f6\u6027\u80fd\u7a33\u5b9a\u5728 10 CPI\uff0c\u8ba4\u4e3a Icestorm \u7684 L1 DTLB \u6709 128 \u9879\u300210 CPI \u5305\u62ec\u4e86 L1 DTLB miss L2 TLB hit \u5e26\u6765\u7684\u989d\u5916\u5ef6\u8fdf\u3002</p>\n<p>\u5982\u679c\u6bcf\u4e24\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u5219\u62d0\u70b9\u524d\u79fb\u5230 64\uff1b\u6bcf\u56db\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 32\uff1b\u6bcf\u516b\u4e2a\u9875\u653e\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 16\uff1b\u6bcf 16 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u662f 8\uff1b\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u53d8\u6210 4\uff1b\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0c\u62d0\u70b9\u4f9d\u7136\u662f 4\u3002\u8bf4\u660e Icestorm \u7684 L1 DTLB \u662f 4 \u8def\u7ec4\u76f8\u8fde\uff0c32 \u4e2a Set\uff0cIndex \u662f VA[18:14]\u3002</p>\n<h4 id=\"loadstore-\u5e26\u5bbd\">Load/Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#loadstore-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b Firestorm \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>3x 128b Load + 1x 128b Store</li>\n<li>2x 128b Load + 2x 128b Store</li>\n<li>1x 128b Load + 2x 128b Store</li>\n<li>2x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 48B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 32B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002</p>\n<p>\u5b9e\u6d4b Icestorm \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>2x 128b Load</li>\n<li>1x 128b Load + 1x 128b Store</li>\n<li>1x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 32B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 16B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002</p>\n<h4 id=\"memory-dependency-predictor\">Memory Dependency Predictor<a class=\"headerlink\" href=\"#memory-dependency-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u9884\u6d4b\u6267\u884c Load\uff0c\u9700\u8981\u4fdd\u8bc1 Load \u548c\u4e4b\u524d\u7684 Store \u8bbf\u95ee\u7684\u5185\u5b58\u6ca1\u6709 Overlap\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u9884\u6d4b\u5668\u6765\u9884\u6d4b Load \u548c Store \u4e4b\u524d\u5728\u5185\u5b58\u4e0a\u7684\u4f9d\u8d56\u3002\u53c2\u8003 <a href=\"https://blog.stuffedcow.net/2014/01/x86-memory-disambiguation/\">Store-to-Load Forwarding and Memory Disambiguation in x86 Processors</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e24\u4e2a\u6307\u4ee4\u6a21\u5f0f\uff0c\u5206\u522b\u5728\u5730\u5740\u548c\u6570\u636e\u4e0a\u6709\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>\u6570\u636e\u4f9d\u8d56\uff0c\u5730\u5740\u65e0\u4f9d\u8d56\uff1a<code>str x3, [x1]</code> \u548c <code>ldr x3, [x2]</code></li>\n<li>\u5730\u5740\u4f9d\u8d56\uff0c\u6570\u636e\u65e0\u4f9d\u8d56\uff1a<code>str x2, [x1]</code> \u548c <code>ldr x1, [x2]</code></li>\n</ul>\n<p>\u521d\u59cb\u5316\u65f6\uff0c<code>x1</code> \u548c <code>x2</code> \u6307\u5411\u540c\u4e00\u4e2a\u5730\u5740\uff0c\u91cd\u590d\u5982\u4e0a\u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u89c2\u5bdf\u5230\u591a\u5c11\u6761 <code>ldr</code> \u6307\u4ee4\u65f6\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff0c\u5728 Firestorm \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_memory_dependency_predictor.png\" /></p>\n<p>\u6570\u636e\u4f9d\u8d56\u6ca1\u6709\u660e\u663e\u7684\u9608\u503c\uff0c\u4f46\u4ece 84 \u5f00\u59cb\u51fa\u73b0\u4e86\u4e00\u4e2a\u5c0f\u7684\u589e\u957f\uff0c\u4e14\u659c\u7387\u4e0d\u4e3a\u96f6\uff1b\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 70\u3002</p>\n<p>Icestorm:</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_memory_dependency_predictor.png\" /></p>\n<p>\u6570\u636e\u4f9d\u8d56\u548c\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u90fd\u662f 13\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<h5 id=\"firestorm_1\">Firestorm<a class=\"headerlink\" href=\"#firestorm_1\" title=\"Permanent link\">&para;</a></h5>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0cFirestorm \u4e0a\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>[-1,0]</td>\n<td>[-3,0]</td>\n<td>[-7,0]</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>[-1,1]</td>\n<td>[-3,1]</td>\n<td>[-7,1]</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[-1,3]</td>\n<td>[-3,3]</td>\n<td>[-7,3]</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[-1,7]</td>\n<td>[-3,7]</td>\n<td>[-7,7]</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u8868\u53ef\u4ee5\u770b\u5230\uff0c\u6240\u6709 Store \u548c Load Overlap \u7684\u60c5\u51b5\uff0c\u65e0\u8bba\u5730\u5740\u504f\u79fb\uff0c\u90fd\u80fd\u6210\u529f\u8f6c\u53d1\u3002\u751a\u81f3\u5728 Load \u6216 Store \u8de8\u8d8a 64B \u7f13\u5b58\u884c\u8fb9\u754c\u65f6\uff0c\u4e5f\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u4ee3\u4ef7\u662f\u591a\u4e00\u4e2a\u5468\u671f\u3002</p>\n<p>\u4e00\u4e2a Load \u9700\u8981\u8f6c\u53d1\u4e24\u4e2a\u3001\u56db\u4e2a\u751a\u81f3\u516b\u4e2a Store \u7684\u6570\u636e\u65f6\uff0c\u5982\u679c\u6570\u636e\u8de8\u8d8a\u7f13\u5b58\u884c\uff0c\u5219\u4e0d\u80fd\u8f6c\u53d1\uff0c\u4f46\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0c\u65e0\u8bba\u5730\u5740\u504f\u79fb\uff0c\u90fd\u53ef\u4ee5\u8f6c\u53d1\uff0c\u53ea\u662f\u6bd4\u4ece\u5355\u4e2a Store \u8f6c\u53d1\u9700\u8981\u591a\u8017\u8d39 1-4 \u4e2a\u5468\u671f\u3002</p>\n<p>\u6210\u529f\u8f6c\u53d1\u65f6 7.5 cycle\uff0c\u8de8\u7f13\u5b58\u884c\u4e14\u8f6c\u53d1\u5931\u8d25\u65f6 28+ cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aApple Firestorm \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u652f\u6301</li>\n<li>1 ld + 2 st: \u652f\u6301\uff0c\u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 4 st: \u652f\u6301\uff0c\u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 8 st: \u652f\u6301\uff0c\u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n</ul>\n<h5 id=\"icestorm_1\">Icestorm<a class=\"headerlink\" href=\"#icestorm_1\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5728 Icestorm \u4e0a\uff0c\u5982\u679c Load \u548c Store \u8bbf\u95ee\u8303\u56f4\u51fa\u73b0\u91cd\u53e0\uff0c\u5219\u9700\u8981 10 Cycle\uff0c\u65e0\u8bba\u662f\u548c\u51e0\u4e2a Store \u91cd\u53e0\uff0c\u4e5f\u65e0\u8bba\u662f\u5426\u8de8\u7f13\u5b58\u884c\u3002</p>\n<h4 id=\"load-to-use-latency\">Load to use latency<a class=\"headerlink\" href=\"#load-to-use-latency\" title=\"Permanent link\">&para;</a></h4>\n<h5 id=\"firestorm_2\">Firestorm<a class=\"headerlink\" href=\"#firestorm_2\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5b9e\u6d4b Firestorm \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5982\u679c\u8bbf\u5b58\u8de8\u8d8a\u4e86 8B \u8fb9\u754c\uff0c\u5219\u9000\u5316\u5230 4 cycle\u3002</p>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<h5 id=\"icestorm_2\">Icestorm<a class=\"headerlink\" href=\"#icestorm_2\" title=\"Permanent link\">&para;</a></h5>\n<p>\u5b9e\u6d4b Icestorm \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5982\u679c\u8bbf\u5b58\u8de8\u8d8a\u4e86 8B/16B/32B \u8fb9\u754c\uff0c\u4f9d\u7136\u662f 3 cycle\uff1b\u8de8\u8d8a\u4e86 64B \u8fb9\u754c\u5219\u9000\u5316\u5230 7 cycle\u3002</p>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<h4 id=\"virtual-address-utagway-predictor\">Virtual Address UTag/Way-Predictor<a class=\"headerlink\" href=\"#virtual-address-utagway-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>Linear Address UTag/Way-Predictor \u662f AMD \u7684\u53eb\u6cd5\uff0c\u4f46\u4f7f\u7528\u76f8\u540c\u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u5728 Apple M1 \u4e0a\u89c2\u5bdf\u5230\u7c7b\u4f3c\u7684\u73b0\u8c61\uff0c\u731c\u60f3\u5b83\u4e5f\u7528\u4e86\u7c7b\u4f3c\u7684\u57fa\u4e8e\u865a\u62df\u5730\u5740\u7684 UTag/Way Predictor \u65b9\u6848\uff0c\u5e76\u6d4b\u51fa\u6765\u5b83\u7684 UTag \u4e5f\u6709 8 bit\uff0cFirestorm \u548c Icestorm \u90fd\u662f\u76f8\u540c\u7684\uff1a</p>\n<ul>\n<li>VA[14] xor VA[22] xor VA[30] xor VA[38] xor VA[46]</li>\n<li>VA[15] xor VA[23] xor VA[31] xor VA[39] xor VA[47]</li>\n<li>VA[16] xor VA[24] xor VA[32] xor VA[40]</li>\n<li>VA[17] xor VA[25] xor VA[33] xor VA[41]</li>\n<li>VA[18] xor VA[26] xor VA[34] xor VA[42]</li>\n<li>VA[19] xor VA[27] xor VA[35] xor VA[43]</li>\n<li>VA[20] xor VA[28] xor VA[36] xor VA[44]</li>\n<li>VA[21] xor VA[29] xor VA[37] xor VA[45]</li>\n</ul>\n<p>\u4e00\u5171\u6709 8 bit\uff0c\u7531 VA[47:14] \u6298\u53e0\u800c\u6765\u3002</p>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u60f3\u8981\u6d4b\u8bd5\u6709\u591a\u5c11\u4e2a\u6267\u884c\u5355\u5143\uff0c\u6bcf\u4e2a\u6267\u884c\u5355\u5143\u53ef\u4ee5\u8fd0\u884c\u54ea\u4e9b\u6307\u4ee4\uff0c\u9996\u5148\u8981\u6d4b\u8bd5\u5404\u7c7b\u6307\u4ee4\u5728\u65e0\u4f9d\u8d56\u60c5\u51b5\u4e0b\u7684\u7684 IPC\uff0c\u901a\u8fc7 IPC \u6765\u63a8\u65ad\u6709\u591a\u5c11\u4e2a\u80fd\u591f\u6267\u884c\u8fd9\u7c7b\u6307\u4ee4\u7684\u6267\u884c\u5355\u5143\uff1b\u4f46\u7531\u4e8e\u4e00\u4e2a\u6267\u884c\u5355\u5143\u53ef\u80fd\u53ef\u4ee5\u6267\u884c\u591a\u7c7b\u6307\u4ee4\uff0c\u4e8e\u662f\u8fdb\u4e00\u6b65\u9700\u8981\u89c2\u5bdf\u5728\u6df7\u5408\u4e0d\u540c\u7c7b\u7684\u6307\u4ee4\u65f6\u7684 IPC\uff0c\u4ece\u800c\u63a8\u65ad\u51fa\u5b8c\u6574\u7684\u7ed3\u679c\u3002</p>\n<h4 id=\"firestorm_3\">Firestorm<a class=\"headerlink\" href=\"#firestorm_3\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 Firestorm \u4e0a\u6d4b\u8bd5\u5982\u4e0b\u5404\u7c7b\u6307\u4ee4\u7684\u5ef6\u8fdf\u548c\u6bcf\u5468\u671f\u541e\u5410\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u5ef6\u8fdf</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>asimd int add</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd aesd/aese</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd aesimc/aesmc</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fabs</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fadd</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fmax</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmin</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmla</td>\n<td>4</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fmul</td>\n<td>4</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd fneg</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>asimd frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>asimd fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp cvtf2i (fcvtzs)</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp cvti2f (scvtf)</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fabs</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fadd</td>\n<td>3</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fjcvtzs</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fmax</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fmin</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fmov f2i</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmov i2f</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>fp fmul</td>\n<td>4</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp fneg</td>\n<td>2</td>\n<td>4</td>\n</tr>\n<tr>\n<td>fp frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frecpx</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int add</td>\n<td>1</td>\n<td>4.6</td>\n</tr>\n<tr>\n<td>int addi</td>\n<td>1</td>\n<td>6</td>\n</tr>\n<tr>\n<td>int bfm</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int crc</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int csel</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int madd (addend)</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int madd (others)</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int mrs nzcv</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>int mul</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>int nop</td>\n<td>-</td>\n<td>8</td>\n</tr>\n<tr>\n<td>int sbfm</td>\n<td>1</td>\n<td>4.7</td>\n</tr>\n<tr>\n<td>int sdiv</td>\n<td>7</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int smull</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>int ubfm</td>\n<td>1</td>\n<td>4.7</td>\n</tr>\n<tr>\n<td>int udiv</td>\n<td>7</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>not taken branch</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>taken branch</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem asimd load</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>mem asimd store</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem int load</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>mem int store</td>\n<td>-</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u521d\u6b65\u5f97\u5230\u7684\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6807\u91cf\u6d6e\u70b9\u548c ASIMD \u541e\u5410\u6700\u5927\u90fd\u662f 4\uff0c\u610f\u5473\u7740\u6709 4 \u4e2a\u6d6e\u70b9/ASIMD \u6267\u884c\u5355\u5143\uff0c\u4f46\u5e76\u975e\u5b8c\u5168\u5bf9\u79f0\uff0c\u4f8b\u5982 fdiv/frecpe/frecpx/frsqrte/fsqrt/fjcvtzs \u7531\u4e8e\u541e\u5410\u4e0d\u8d85\u8fc7 1\uff0c\u5927\u6982\u7387\u53ea\u80fd\u5728\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\u3002\u4f46\u8fd9\u4e9b\u6307\u4ee4\u662f\u4e0d\u662f\u90fd\u53ea\u80fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\uff0c\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u6d4b\u8bd5</li>\n<li>\u6d6e\u70b9\u548c\u6574\u6570\u4e4b\u95f4\u7684 move \u6216 convert \u6307\u4ee4\uff0cfmov i2f/cvti2f \u541e\u5410\u662f 3\uff0cfmov f2i/cvtf2i \u541e\u5410\u662f 2\uff0c\u90a3\u4e48\u8fd9\u4e9b\u6307\u4ee4\u662f\u5728\u54ea\u4e2a\u6267\u884c\u5355\u5143\u91cc\u5b9e\u73b0\u7684\uff0c\u662f\u5426\u9700\u8981\u540c\u65f6\u5360\u7528\u6574\u6570\u6267\u884c\u5355\u5143\u548c\u6d6e\u70b9\u6267\u884c\u5355\u5143\uff0c\u9700\u8981\u8fdb\u4e00\u6b65\u6d4b\u8bd5</li>\n<li>\u6574\u6570\u65b9\u9762\uff0c\u6839\u636e\u541e\u5410\uff0c\u63a8\u65ad\u51fa\u5982\u4e0b\u51e0\u7c7b\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u6570\u91cf\uff1a<ol>\n<li>ALU: 6</li>\n<li>CSEL: 3</li>\n<li>Mul/Br/MRS NZCV: 2</li>\n<li>CRC/BFM/MAdd/Div: 1</li>\n</ol>\n</li>\n<li>\u867d\u7136 Br \u7684\u541e\u5410\u53ef\u4ee5\u8fbe\u5230 2\uff0c\u4f46\u662f\u6bcf\u5468\u671f\u53ea\u80fd\u6709\u4e00\u4e2a taken branch\uff1b\u76ee\u524d\u4e00\u4e9b\u67b6\u6784\u53ef\u4ee5\u505a\u5230\u6bcf\u5468\u671f\u8d85\u8fc7\u4e00\u4e2a taken branch\uff0c\u6b64\u65f6 Br \u7684\u541e\u5410\u4e00\u822c\u4f1a\u7ed9\u5230 3</li>\n<li>\u8bbf\u5b58\u65b9\u9762\uff0c\u6bcf\u5468\u671f\u6700\u591a 3 Load \u6216\u8005 2 Store</li>\n</ol>\n<p>\u9996\u5148\u6765\u770b\u6d6e\u70b9\u548c ASIMD \u5355\u5143\uff0c\u6839\u636e\u4e0a\u9762\u7684\u4fe1\u606f\uff0c\u8ba4\u4e3a\u81f3\u5c11\u6709 4 \u4e2a\u6267\u884c\u5355\u5143\uff0c\u6bcf\u4e2a\u6267\u884c\u5355\u5143\u90fd\u53ef\u4ee5\u505a\u8fd9\u4e9b\u64cd\u4f5c\uff1aasimd int add/aes/fabs/fadd/fmax/fmin/fmla/fmul/fneg\uff0c\u4e0b\u9762\u628a\u8fd9\u4e9b\u6307\u4ee4\u79f0\u4e3a basic fp/asimd ops + aes\u3002\u63a5\u4e0b\u6765\u8981\u5224\u65ad\uff0cfmov f2i/fmov i2f/fdiv/frecpe/frecpx/frsqrte/fsqrt \u7531\u54ea\u4e9b\u6267\u884c\u5355\u5143\u8d1f\u8d23\u6267\u884c\uff0c\u65b9\u6cd5\u662f\u628a\u8fd9\u4e9b\u6307\u4ee4\u6df7\u5408\u8d77\u6765\u6d4b\u8bd5\u541e\u5410\uff08\u6b64\u5904\u7684\u541e\u5410\u4e0d\u4ee3\u8868 CPI\uff0c\u800c\u662f\u6bcf\u5468\u80fd\u591f\u6267\u884c\u591a\u5c11\u6b21\u6307\u4ee4\u7ec4\u5408\uff0c\u4f8b\u5982\u7528 2 \u6761\u6307\u4ee4\u7684\u7ec4\u5408\u6d4b\u8bd5\uff0c\u90a3\u4e48\u541e\u5410\u7b49\u4e8e CPI \u9664\u4ee5 2\uff09\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fp fdiv + fp frecpe</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frecpx</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frsqrte</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp fsqrt</td>\n<td>0.32=3/3.12</td>\n</tr>\n<tr>\n<td>fp fdiv + fmov f2i</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fmov f2i</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>fp fdiv + 3x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 4x fmov i2f</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>fmov i2f + 4x fp fadd</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fmov f2i + 4x fp fadd</td>\n<td>0.67=1/1.50</td>\n</tr>\n</tbody>\n</table>\n<p>\u6839\u636e\u4ee5\u4e0a\u6d4b\u8bd5\u7ed3\u679c\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7684\u63a8\u8bba\uff1a</p>\n<ol>\n<li>fp fdiv/frecpe/frecpx/frsqrte \u6df7\u5408\u7684\u65f6\u5019\uff0c\u541e\u5410\u53ea\u6709\u4e00\u534a\uff0cIPC \u4e0d\u53d8\uff0c\u8bf4\u660e\u8fd9\u4e9b\u6307\u4ee4\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u4e2d\uff0c\u6df7\u5408\u5e76\u4e0d\u80fd\u5e26\u6765\u66f4\u9ad8\u7684 IPC</li>\n<li>fp fdiv \u548c fp fsqrt \u6df7\u5408\u65f6\uff0c\u541e\u5410\u4e0b\u964d\u5230 0.32 \u4e00\u4e2a\u4e0d\u592a\u6574\u7684\u6570\u5b57\uff0c\u731c\u6d4b\u662f\u56e0\u4e3a\u5b83\u4eec\u5c5e\u4e8e\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u7684\u4e0d\u540c\u6d41\u6c34\u7ebf\uff0c\u62a2\u5360\u5bc4\u5b58\u5668\u5806\u5199\u53e3</li>\n<li>fp fdiv + fmov f2i \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u800c fdiv + 2x fmov f2i \u65f6\u541e\u5410\u4e0b\u964d\u5230 0.67\uff0cIPC \u7ef4\u6301\u5728 2\uff0c\u8bf4\u660e\u6709\u4e24\u4e2a\u6267\u884c\u5355\u5143\uff0c\u90fd\u53ef\u4ee5\u6267\u884c fmov f2i\uff0c\u4f46\u53ea\u6709\u5176\u4e2d\u4e00\u4e2a\u53ef\u4ee5\u6267\u884c fp fdiv\uff0c\u5bfc\u81f4 fdiv + 2x fmov f2i \u7684\u65f6\u5019\u4f1a\u62a2\u6267\u884c\u5355\u5143</li>\n<li>fp fdiv + 3x fmov i2f \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u800c fdiv + 4x fmov i2f \u65f6\u541e\u5410\u4e0b\u964d\u5230 0.75\uff0c\u6b64\u65f6\u6bcf\u5468\u671f\u8fd8\u662f\u6267\u884c 3 \u6761 fmov i2f \u6307\u4ee4\uff0c\u610f\u5473\u7740 fdiv \u6ca1\u6709\u62a2\u5360 fmov i2f \u7684\u6267\u884c\u5355\u5143\uff0c\u5b83\u4eec\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u72ec\u7acb\u7684</li>\n<li>fmov i2f + 4x fp fadd \u7684\u65f6\u5019\u541e\u5410\u662f 1\uff0c\u8bf4\u660e fmov i2f \u6ca1\u6709\u62a2\u5360 fp fadd \u7684\u6267\u884c\u5355\u5143</li>\n</ol>\n<p>\u63a8\u65ad\u8fd9\u56db\u4e2a\u6267\u884c\u5355\u5143\u652f\u6301\u7684\u64cd\u4f5c\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u5f53\u7136\u8fd8\u6709\u5f88\u591a\u6307\u4ee4\u6ca1\u6709\u6d4b\uff0c\u4e0d\u8fc7\u539f\u7406\u662f\u4e00\u6837\u7684\u3002</p>\n<p>\u8bbf\u5b58\u90e8\u5206\uff0c\u524d\u9762\u5df2\u7ecf\u5728\u6d4b LSU \u7684\u65f6\u5019\u6d4b\u8fc7\u4e86\uff0c\u6bcf\u5468\u671f Load + Store \u4e0d\u8d85\u8fc7 4 \u4e2a\uff0c\u5176\u4e2d Load \u4e0d\u8d85\u8fc7 3 \u4e2a\uff0cStore \u4e0d\u8d85\u8fc7 2 \u4e2a\u3002\u867d\u7136\u4ece IPC \u7684\u89d2\u5ea6\u6765\u770b LSU \u7684 Load/Store Pipe \u672a\u5fc5\u51c6\u786e\uff0c\u6bd4\u5982\u53ef\u80fd\u5b83\u53d1\u5c04\u548c\u63d0\u4ea4\u7684\u5e26\u5bbd\u662f\u4e0d\u540c\u7684\uff0c\u4f46\u5148\u6682\u65f6\u7b80\u5316\u4e3a\u5982\u4e0b\u7684\u6267\u884c\u5355\u5143\uff1a</p>\n<ol>\n<li>load + store</li>\n<li>load</li>\n<li>load</li>\n<li>store</li>\n</ol>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\u3002\u4ece addi \u7684\u6307\u4ee4\u6765\u770b\uff0c\u6709 6 \u4e2a ALU\uff0c\u80fd\u591f\u6267\u884c\u57fa\u672c\u7684\u6574\u6570\u6307\u4ee4\uff08add/ubfm/sbfm \u7684\u541e\u5410\u6709\u65f6\u5019\u6d4b\u51fa\u6765 4.6-4.7\uff0c\u6709\u65f6\u5019\u6d4b\u51fa\u6765 6\uff0c\u6000\u7591\u662f\u8fdb\u5165\u4e86\u4ec0\u4e48\u4f4e\u529f\u8017\u6a21\u5f0f\uff09\u3002\u4f46\u5176\u4ed6\u5f88\u591a\u6307\u4ee4\u53ef\u80fd\u53ea\u6709\u4e00\u90e8\u5206\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c\uff1abfm/crc/csel/madd/mrs nzcv/mul/div/branch/fmov i2f\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e9b\u6307\u4ee4\u4f7f\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u5426\u91cd\u5408\uff0c\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u6df7\u5408\u6307\u4ee4\u6d4b\u8bd5\uff0c\u541e\u5410\u7684\u5b9a\u4e49\u548c\u4e0a\u9762\u76f8\u540c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3x int csel + 3x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + 2x fmov f2i</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>3x int csel + int bfm</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int crc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int madd</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int mul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3x int csel + int sdiv</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>3x int csel + mrs nzcv</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>3x int csel + not taken branch</td>\n<td>0.75=1/1.33</td>\n</tr>\n<tr>\n<td>mrs nzcv + not taken branch</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mrs nzcv + 2x not taken branch</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>2x fmov f2i + 2x not taken branch</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2x fmov f2i + 2x int mul</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int madd + 2x int mul</td>\n<td>0.67=1/1.50</td>\n</tr>\n<tr>\n<td>int madd + int sdiv</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + int crc</td>\n<td>0.5</td>\n</tr>\n</tbody>\n</table>\n<p>\u6839\u636e\u4e0a\u8ff0\u7ed3\u679c\u5206\u6790\uff1a</p>\n<ol>\n<li>\u541e\u5410\u4e0e\u4e0d\u6df7\u5408\u65f6\u76f8\u540c\uff0c\u4ee3\u8868\u6df7\u5408\u7684\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408</li>\n<li>3x int csel + 2x fmov f2i \u7684 IPC \u7b49\u4e8e 4\uff0c\u610f\u5473\u7740\u6709\u56db\u4e2a\u6267\u884c\u5355\u5143\uff0c\u5176\u4e2d\u6709\u4e09\u4e2a\u53ef\u4ee5\u6267\u884c int csel\uff0c\u4e24\u4e2a\u53ef\u4ee5\u6267\u884c fmov f2i\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u5176\u4e2d\u6709\u4e00\u4e2a\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c int csel \u548c fmov f2i\uff0c\u5373\u6709\u8fd9\u6837\u7684\u56db\u4e2a\u6267\u884c\u5355\u5143\uff1a<ol>\n<li>alu + csel</li>\n<li>alu + csel</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n</ol>\n</li>\n<li>3x int csel + mrs nzcv/not taken branch \u7684 IPC \u7b49\u4e8e 3\uff0c\u8bf4\u660e\u5b83\u4eec\u7684\u6267\u884c\u5355\u5143\u662f\u91cd\u5408\u7684\uff1b\u53c8\u56e0\u4e3a 2x fmov f2i + 2x not taken branch \u7684\u541e\u5410\u662f 1\uff0c\u8bf4\u660e\u5b83\u4eec\u7684\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408\uff0c\u90a3\u4e48\u4e0a\u8ff0\u56db\u4e2a\u6267\u884c\u5355\u5143\u53ea\u80fd\u662f\uff1a<ol>\n<li>alu + csel + branch</li>\n<li>alu + csel + branch</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n</ol>\n</li>\n<li>mrs nzcv + 2x not taken branch \u7684 IPC \u7b49\u4e8e 2\uff0c\u8bf4\u660e\u5b83\u4eec\u7684\u6267\u884c\u5355\u5143\u662f\u91cd\u5408\u7684\uff0c\u90a3\u4e48\u4e0a\u8ff0\u56db\u4e2a\u6267\u884c\u5355\u5143\u662f\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n</ol>\n</li>\n<li>csel \u548c mul \u4e0d\u91cd\u5408\uff0cf2i \u548c mul \u4e5f\u4e0d\u91cd\u5408\uff0c\u8bf4\u660e mul \u5728\u5269\u4e0b\u7684\u4e24\u4e2a\u6267\u884c\u5355\u5143\u5185\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul</li>\n<li>alu + mul</li>\n</ol>\n</li>\n<li>madd \u548c mul \u91cd\u5408\uff0cmadd \u548c crc \u91cd\u5408\uff0c\u90a3\u4e48\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul + madd + crc</li>\n<li>alu + mul</li>\n</ol>\n</li>\n</ol>\n<p>\u5f97\u5230\u521d\u6b65\u7684\u7ed3\u679c\uff1a</p>\n<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul + madd + crc</li>\n<li>alu + mul</li>\n</ol>\n<p>\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u6307\u4ee4\u6ca1\u6709\u6d4b\u8bd5\uff0c\u4e0d\u8fc7\u65b9\u6cd5\u662f\u7c7b\u4f3c\u7684\u3002\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u91cc\uff0c\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u503c\u5f97\u4e00\u63d0\u7684\u70b9\uff1a</p>\n<ol>\n<li>fmov f2i \u540c\u65f6\u5360\u7528\u4e86\u4e24\u4e2a\u6d6e\u70b9\u6267\u884c\u5355\u5143\u548c\u4e24\u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u8fd9\u4e3b\u8981\u662f\u4e3a\u4e86\u590d\u7528\u5bc4\u5b58\u5668\u5806\u8bfb\u5199\u53e3\uff1afmov f2i \u9700\u8981\u8bfb\u6d6e\u70b9\u5bc4\u5b58\u5668\u5806\uff0c\u53c8\u9700\u8981\u5199\u6574\u6570\u5bc4\u5b58\u5668\u5806\uff0c\u90a3\u5c31\u5728\u6d6e\u70b9\u4fa7\u8bfb\u5bc4\u5b58\u5668\uff0c\u5728\u6574\u6570\u4fa7\u5199\u5bc4\u5b58\u5668\u3002</li>\n<li>fmov i2f \u65e2\u4e0d\u5728\u6d6e\u70b9\uff0c\u4e5f\u4e0d\u5728\u6574\u6570\uff0c\u90a3\u53ea\u80fd\u5728\u8bbf\u5b58\u4e86\uff1a\u800c\u6b63\u597d\u8bbf\u5b58\u6267\u884c\u5355\u5143\u9700\u8981\u8bfb\u6574\u6570\uff0c\u5199\u6574\u6570\u6216\u6d6e\u70b9\uff0c\u90a3\u5c31\u53ef\u4ee5\u590d\u7528\u5b83\u7684\u5bc4\u5b58\u5668\u5806\u5199\u53e3\u6765\u5b9e\u73b0 fmov i2f \u7684\u529f\u80fd\u3002</li>\n<li>\u53ef\u89c1\u6574\u6570/\u6d6e\u70b9/\u8bbf\u5b58\u6267\u884c\u5355\u5143\u5e76\u4e0d\u662f\u5b8c\u5168\u9694\u79bb\u7684\uff0c\u4f8b\u5982\u4e00\u4e9b\u5fae\u67b6\u6784\uff0c\u6574\u6570\u548c\u6d6e\u70b9\u662f\u76f4\u63a5\u653e\u5728\u4e00\u8d77\u7684\u3002</li>\n</ol>\n<p>\u5c0f\u7ed3\uff1aFirestorm \u7684\u6267\u884c\u5355\u5143\u5982\u4e0b\uff1a</p>\n<ol>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + branch + mrs nzcv</li>\n<li>alu + csel + fmov f2i</li>\n<li>alu + fmov f2i</li>\n<li>alu + mul + madd + crc</li>\n<li>alu + mul</li>\n<li>load + store</li>\n<li>load</li>\n<li>load</li>\n<li>store</li>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes + fmov f2i + cvtf2i</li>\n<li>basic fp/asimd ops + aes</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<h4 id=\"icestorm_3\">Icestorm<a class=\"headerlink\" href=\"#icestorm_3\" title=\"Permanent link\">&para;</a></h4>\n<p>\u63a5\u4e0b\u6765\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 Icestorm\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u5ef6\u8fdf</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>asimd int add</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd aesd/aese</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd aesimc/aesmc</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fabs</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fadd</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fdiv 64b</td>\n<td>11</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fdiv 32b</td>\n<td>9</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fmax</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fmin</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fmla</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fmul</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd fneg</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>asimd frecpe</td>\n<td>4</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd frsqrte</td>\n<td>4</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 64b</td>\n<td>15</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>asimd fsqrt 32b</td>\n<td>12</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp cvtf2i (fcvtzs)</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp cvti2f (scvtf)</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fabs</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fadd</td>\n<td>3</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fdiv 64b</td>\n<td>10</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv 32b</td>\n<td>8</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fjcvtzs</td>\n<td>-</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fmax</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmin</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmov f2i</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fmov i2f</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fmul</td>\n<td>4</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp fneg</td>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>fp frecpe</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frecpx</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp frsqrte</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fsqrt 64b</td>\n<td>13</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fsqrt 32b</td>\n<td>10</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int add</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int addi</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int bfm</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int crc</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int csel</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int madd (addend)</td>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int madd (others)</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int mrs nzcv</td>\n<td>-</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int mul</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int nop</td>\n<td>-</td>\n<td>4</td>\n</tr>\n<tr>\n<td>int sbfm</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int sdiv</td>\n<td>7</td>\n<td>0.125=1/8</td>\n</tr>\n<tr>\n<td>int smull</td>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>int ubfm</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>int udiv</td>\n<td>7</td>\n<td>0.125=1/8</td>\n</tr>\n<tr>\n<td>not taken branch</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>taken branch</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem asimd load</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem asimd store</td>\n<td>-</td>\n<td>1</td>\n</tr>\n<tr>\n<td>mem int load</td>\n<td>-</td>\n<td>2</td>\n</tr>\n<tr>\n<td>mem int store</td>\n<td>-</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u521d\u6b65\u5f97\u5230\u7684\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6807\u91cf\u6d6e\u70b9\u548c ASIMD \u541e\u5410\u6700\u5927\u90fd\u662f 2\uff0c\u610f\u5473\u7740\u6709 2 \u4e2a\u6d6e\u70b9/ASIMD \u6267\u884c\u5355\u5143\uff0c\u4f46\u5e76\u975e\u5b8c\u5168\u5bf9\u79f0\uff0c\u4f8b\u5982 fdiv/frecpe/frecpx/frsqrte/fsqrt/fjcvtzs \u7531\u4e8e\u541e\u5410\u4e0d\u8d85\u8fc7 1\uff0c\u5927\u6982\u7387\u53ea\u80fd\u5728\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\u3002\u4f46\u8fd9\u4e9b\u6307\u4ee4\u662f\u4e0d\u662f\u90fd\u53ea\u80fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\u6267\u884c\uff0c\u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u6d4b\u8bd5</li>\n<li>\u6574\u6570\u65b9\u9762\uff0c\u6839\u636e\u541e\u5410\uff0c\u63a8\u65ad\u51fa\u5982\u4e0b\u51e0\u7c7b\u6307\u4ee4\u5bf9\u5e94\u7684\u6267\u884c\u5355\u5143\u6570\u91cf\uff1a<ol>\n<li>ALU/CSEL/MRS NZCV/SBFM/UBFM: 3</li>\n<li>Br: 2</li>\n<li>Mul/CRC/BFM/MAdd/Div: 1</li>\n</ol>\n</li>\n<li>\u867d\u7136 Br \u7684\u541e\u5410\u53ef\u4ee5\u8fbe\u5230 2\uff0c\u4f46\u662f\u6bcf\u5468\u671f\u53ea\u80fd\u6709\u4e00\u4e2a taken branch</li>\n<li>\u8bbf\u5b58\u65b9\u9762\uff0c\u6bcf\u5468\u671f\u6700\u591a 2 Load \u6216\u8005 1 Store</li>\n</ol>\n<p>\u8fd8\u662f\u5148\u770b\u6d6e\u70b9\uff0c\u57fa\u672c\u6307\u4ee4 add/aes/fabs/fadd/fmax/fmin/fmla/fmul/fneg \u90fd\u80fd\u505a\u5230 2 \u7684\u541e\u5410\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e24\u4e2a\u6307\u5b9a\u5355\u5143\u90fd\u80fd\u6267\u884c\u8fd9\u4e9b\u57fa\u672c\u6307\u4ee4\u3002\u63a5\u4e0b\u6765\u6d4b\u5176\u4f59\u6307\u4ee4\u7684\u6df7\u5408\u541e\u5410\uff08\u541e\u5410\u5b9a\u4e49\u89c1\u4e0a\uff09\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fp fdiv + fp frecpe</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frecpx</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp frsqrte</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + fp fsqrt</td>\n<td>0.31=3/3.25</td>\n</tr>\n<tr>\n<td>fp fdiv + fmov f2i</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>fp fdiv + 2x fmov i2f</td>\n<td>1</td>\n</tr>\n<tr>\n<td>fp fdiv + 3x fmov i2f</td>\n<td>0.67/1/1.50</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u89c1 fdiv/frecpe/frecpx/frsqrte/fsqrt/fmov f2i \u90fd\u5728\u540c\u4e00\u4e2a\u6267\u884c\u5355\u5143\u5185\uff1a</p>\n<ol>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<p>\u8fd8\u6709\u5f88\u591a\u6307\u4ee4\u6ca1\u6709\u6d4b\uff0c\u4e0d\u8fc7\u539f\u7406\u662f\u4e00\u6837\u7684\u3002\u8bbf\u5b58\u5728\u524d\u9762\u6d4b LSU \u7684\u65f6\u5019\u5df2\u7ecf\u6d4b\u8fc7\u4e86\uff1a</p>\n<ol>\n<li>load + store</li>\n<li>load</li>\n</ol>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\u3002\u4ece addi \u7684\u6307\u4ee4\u6765\u770b\uff0c\u6709 3 \u4e2a ALU\uff0c\u80fd\u591f\u6267\u884c\u57fa\u672c\u7684\u6574\u6570\u6307\u4ee4\u3002\u4f46\u5176\u4ed6\u5f88\u591a\u6307\u4ee4\u53ef\u80fd\u53ea\u6709\u4e00\u90e8\u5206\u6267\u884c\u5355\u5143\u53ef\u4ee5\u6267\u884c\uff1abfm/crc/csel/madd/mul/div/branch\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e9b\u6307\u4ee4\u4f7f\u7528\u7684\u6267\u884c\u5355\u5143\u662f\u5426\u91cd\u5408\uff0c\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u6df7\u5408\u6307\u4ee4\u6d4b\u8bd5\uff0c\u541e\u5410\u7684\u5b9a\u4e49\u548c\u4e0a\u9762\u76f8\u540c\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u541e\u5410</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>int madd + int mul</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + int crc</td>\n<td>0.5</td>\n</tr>\n<tr>\n<td>int madd + 2x not taken branch</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>\u7531\u6b64\u53ef\u89c1\uff0cmadd/mul/crc \u662f\u4e00\u4e2a\u6267\u884c\u5355\u5143\uff0c\u548c branch \u7684\u4e24\u4e2a\u6267\u884c\u5355\u5143\u4e0d\u91cd\u5408\uff0c\u56e0\u6b64\u6574\u6570\u4fa7\u7684\u6267\u884c\u5355\u5143\u6709\uff1a</p>\n<ol>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + madd + mul + crc</li>\n</ol>\n<p>\u5c0f\u7ed3\uff1aIcestorm \u7684\u6267\u884c\u5355\u5143\u5982\u4e0b\uff1a</p>\n<ol>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + branch</li>\n<li>alu + csel + mrs nzcv + madd + mul + crc</li>\n<li>load + store</li>\n<li>load</li>\n<li>basic fp/asimd ops + aes + fdiv + frecpe + frecpx + frsqrte + fsqrt + fmov f2i</li>\n<li>basic fp/asimd ops + aes</li>\n</ol>\n<h3 id=\"scheduler\">Scheduler<a class=\"headerlink\" href=\"#scheduler\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 Scheduler \u7684\u5927\u5c0f\u548c\u7ec4\u7ec7\u65b9\u5f0f\uff08\u5206\u5e03\u5f0f\u8fd8\u662f\u96c6\u4e2d\u5f0f\uff09\uff0c\u6d4b\u8bd5\u65b9\u6cd5\u662f\uff1a\u9996\u5148\u7528\u957f\u5ef6\u8fdf\u7684\u64cd\u4f5c\u5835\u4f4f ROB\uff0c\u63a5\u7740\u7528\u82e5\u5e72\u6761\u4f9d\u8d56\u957f\u5ef6\u8fdf\u64cd\u4f5c\u7684\u6307\u4ee4\u5835\u4f4f Scheduler\uff0c\u5f53\u6307\u4ee4\u585e\u4e0d\u8fdb\u53bb\u7684\u65f6\u5019\uff0c\u5c31\u8bf4\u660e Scheduler \u6ee1\u4e86\u3002\u66f4\u8fdb\u4e00\u6b65\uff0c\u7531\u4e8e\u73b0\u5728\u5f88\u591a\u5904\u7406\u5668\u4f1a\u5f15\u5165 Non Scheduling Queue\uff0c\u91cc\u9762\u7684\u6307\u4ee4\u4e0d\u4f1a\u76f4\u63a5\u8c03\u5ea6\u8fdb\u6267\u884c\u5355\u5143\uff0c\u4e5f\u4e0d\u68c0\u67e5\u5b83\u4f9d\u8d56\u7684\u64cd\u4f5c\u6570\u662f\u5426\u5df2\u7ecf\u51c6\u5907\u597d\uff0c\u6b64\u65f6\u4e3a\u4e86\u533a\u5206\u53ef\u8c03\u5ea6\u90e8\u5206\u548c\u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\uff0c\u5728\u4f9d\u8d56\u957f\u5ef6\u8fdf\u64cd\u4f5c\u7684\u6307\u4ee4\u540e\u9762\uff0c\u6dfb\u52a0\u82e5\u5e72\u6761\u4e0d\u4f9d\u8d56\u957f\u5ef6\u8fdf\u64cd\u4f5c\u7684\u6307\u4ee4\uff0c\u8fd9\u6837\u6d4b\u51fa\u6765\u7684\u5c31\u662f\u53ef\u8c03\u5ea6\u90e8\u5206\u7684\u6df1\u5ea6\u3002</p>\n<h4 id=\"firestorm_4\">Firestorm<a class=\"headerlink\" href=\"#firestorm_4\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 Firestorm \u4e0a\u6d4b\u8bd5\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>\u6307\u4ee4</th>\n<th>\u53ef\u8c03\u5ea6 + \u4e0d\u53ef\u8c03\u5ea6</th>\n<th>\u53ef\u8c03\u5ea6</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ld</td>\n<td>58</td>\n<td>48</td>\n</tr>\n<tr>\n<td>st</td>\n<td>58</td>\n<td>43</td>\n</tr>\n<tr>\n<td>alu</td>\n<td>158</td>\n<td>134</td>\n</tr>\n<tr>\n<td>fp</td>\n<td>156</td>\n<td>144</td>\n</tr>\n<tr>\n<td>crc</td>\n<td>40</td>\n<td>28</td>\n</tr>\n<tr>\n<td>idiv</td>\n<td>40</td>\n<td>28</td>\n</tr>\n<tr>\n<td>bfm</td>\n<td>40</td>\n<td>28</td>\n</tr>\n<tr>\n<td>fjcvtzs</td>\n<td>42</td>\n<td>36</td>\n</tr>\n<tr>\n<td>fmov f2i</td>\n<td>84</td>\n<td>72</td>\n</tr>\n<tr>\n<td>csel</td>\n<td>76</td>\n<td>64</td>\n</tr>\n<tr>\n<td>mrs nzcv</td>\n<td>62</td>\n<td>50</td>\n</tr>\n</tbody>\n</table>\n<p>\u9996\u5148\u770b\u6d6e\u70b9\uff1a</p>\n<ol>\n<li>\u53ef\u8c03\u5ea6\u90e8\u5206 fp \u662f 144\uff0cfmov f2i \u662f 72\uff0cfjcvtzs \u662f 36\uff0c\u6709\u660e\u663e\u7684 4:2:1 \u7684\u5173\u7cfb</li>\n<li>fp/fmov f2i/fjcvtzs \u541e\u5410\u521a\u597d\u4e5f\u662f 4:2:1 \u7684\u5173\u7cfb</li>\n<li>\u56e0\u6b64\u56db\u4e2a\u6267\u884c\u5355\u5143\u524d\u9762\u5404\u6709\u4e00\u4e2a\u72ec\u7acb\u7684 36 entry \u7684 Scheduler</li>\n<li>\u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\uff0c156-144=12\uff0c84-72=12\uff0c42-36=6\uff0c\u731c\u6d4b\u6709\u4e24\u4e2a Non Scheduling Queue\uff0c\u6bcf\u4e2a Non Scheduling Queue 6 entry\uff0c\u5206\u522b\u5bf9\u5e94\u4e24\u4e2a Scheduler</li>\n</ol>\n<p>\u4e0b\u9762\u662f\u8bbf\u5b58\u90e8\u5206\uff0cload \u548c store \u603b\u6570\u4e00\u6837\u4f46 Scheduler \u5dee\u4e86 5\uff0c\u4e0d\u786e\u5b9a\u662f\u6d4b\u8bd5\u8bef\u5dee\u8fd8\u662f\u4ec0\u4e48\u95ee\u9898\uff0c\u6682\u4e14\u8003\u8651\u4e3a\u4e00\u4e2a\u7edf\u4e00\u7684 Scheduler \u548c\u540c\u4e00\u4e2a Non Scheduling Queue\u3002</p>\n<p>\u6700\u540e\u662f\u6574\u6570\u90e8\u5206\uff0c\u7531\u4e8e\u6709 6 \u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u60c5\u51b5\u4f1a\u6bd4\u8f83\u590d\u6742\uff1a</p>\n<ol>\n<li>\u53ef\u8c03\u5ea6\u90e8\u5206 alu \u4e00\u5171\u662f 134\uff0c\u5176\u4e2d csel \u662f 64\uff0ccrc/idiv/bfm \u90fd\u662f 28\uff0cmrs nzcv \u662f 50\uff0c\u7ed3\u5408\u516d\u4e2a\u6574\u6570\u6267\u884c\u5355\u5143\uff0c\u53ef\u4ee5\u5f97\u5230\u8fd9\u516d\u4e2a\u6267\u884c\u5355\u5143\u5bf9\u5e94\u7684 Scheduler \u5927\u5c0f\u5173\u7cfb\uff1a<ol>\n<li>alu + csel + branch + mrs nzcv: x entries</li>\n<li>alu + csel + branch + mrs nzcv: 50-x entries</li>\n<li>alu + csel + fmov f2i: 14 entries</li>\n<li>alu + fmov f2i: y entries</li>\n<li>alu + mul + madd + crc: 28 entries</li>\n<li>alu + mul: 42-y entries</li>\n</ol>\n</li>\n<li>alu \u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\u662f 158-134=24\uff0ccrc/idiv/bfm/csel/mrs nzcv \u4e0d\u53ef\u8c03\u5ea6\u90e8\u5206\u90fd\u662f 12\uff0c\u8003\u8651\u5230 csel \u5bf9\u5e94\u524d\u4e09\u4e2a\u6267\u884c\u5355\u5143\uff0c\u5e76\u4e14\u548c mrs nzcv \u4e00\u6837\u591a\uff0c\u8bf4\u660e\u524d\u4e09\u4e2a\u6267\u884c\u5355\u5143\u5171\u4eab\u4e00\u4e2a 12 entry \u7684 Non Scheduling Queue\uff1b\u5269\u4e0b\u4e09\u4e2a\u6267\u884c\u5355\u5143\u5171\u4eab\u5269\u4e0b\u7684 12 entry \u7684 Non Scheduling Queue</li>\n<li>\u6700\u540e\u53ea\u5dee x \u548c y \u7684\u53d6\u503c\u6ca1\u6709\u6c42\u51fa\u6765\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fdb\u4e00\u6b65\u6d4b\u8bd5\u6765\u66f4\u52a0\u7cbe\u786e\u5730\u6c42\u51fa</li>\n</ol>\n<h3 id=\"reorder-buffer\">Reorder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"firestorm_5\">Firestorm<a class=\"headerlink\" href=\"#firestorm_5\" title=\"Permanent link\">&para;</a></h4>\n<p>Firestorm \u7684 ROB \u91c7\u7528\u7684\u662f\u6bd4\u8f83\u7279\u522b\u7684\u65b9\u6848\uff0c\u5b83\u7684 entry \u5730\u4f4d\u4e0d\u662f\u7b49\u540c\u7684\uff0c\u800c\u662f\u82e5\u5e72\u4e2a entry \u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u6210\u4e3a\u4e00\u4e2a group\uff0c\u6bcf\u4e2a group \u6709\u82e5\u5e72\u4e2a entry\uff0c\u4e00\u4e2a group \u5bf9 group \u5185\u6307\u4ee4\u7684\u7c7b\u578b\u548c\u6570\u91cf\u6709\u8981\u6c42\uff0c\u8fd9\u5c31\u5bfc\u81f4\u7528\u4f20\u7edf\u65b9\u6cd5\u6d4b Firestorm \u7684 ROB\uff0c\u53ef\u80fd\u4f1a\u6d4b\u5230\u7279\u522b\u5de8\u5927\u7684\u6570\uff1a2200+\uff0c\u4e5f\u53ef\u80fd\u6d4b\u5230\u6bd4\u8f83\u5c0f\u7684\u6570\uff1a320+\uff0c\u8fd9\u5c31\u548c\u6307\u4ee4\u7c7b\u578b\u6709\u5173\u7cfb\u3002\u4e3a\u4ec0\u4e48\u5bf9\u6307\u4ee4\u7684\u7c7b\u578b\u548c\u4f4d\u7f6e\u6709\u8981\u6c42\u5462\uff0c\u8fd9\u662f\u4e3a\u4e86\u65b9\u4fbf\u5904\u7406\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u3002\u5f88\u591a\u6307\u4ee4\u662f\u6ca1\u6709\u526f\u4f5c\u7528\u7684\uff0c\u4e5f\u4e0d\u4f1a\u629b\u5f02\u5e38\uff0c\u8fd9\u4e9b\u6307\u4ee4\u53ef\u4ee5\u6bd4\u8f83\u968f\u610f\u5730\u653e\u7f6e\uff1b\u4f46\u662f\u5bf9\u4e8e\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\uff0cretire \u65f6\u662f\u9700\u8981\u7279\u6b8a\u5904\u7406\u7684\uff0c\u56e0\u6b64\u4e00\u4e2a\u5408\u7406\u7684\u8bbe\u8ba1\u5c31\u662f\uff0c\u8ba9\u8fd9\u4e9b\u6307\u4ee4\u53ea\u80fd\u653e\u5728 group \u7684\u5f00\u5934\u3002</p>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u53d1\u73b0 Firestorm \u4e0a pointer chasing \u7684\u5ef6\u8fdf\u6ce2\u52a8\u6bd4\u8f83\u5927\uff0c\u76ee\u6d4b\u662f prefetcher \u505a\u4e86\u9488\u5bf9\u6027\u7684\u4f18\u5316\uff0c\u56e0\u6b64\u7528 fsqrt chain \u6765\u505a\u5ef6\u8fdf\uff0cFirestorm \u4e0a\u4e00\u6761\u53cc\u7cbe\u5ea6 fsqrt \u7684\u5ef6\u8fdf\u662f 13 \u4e2a\u5468\u671f\u3002\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5305\u62ec M \u4e2a\u4e32\u884c\u7684 sqrt \u548c N \u4e2a nop\uff0c\u5982\u679c\u6ca1\u6709\u89e6\u78b0\u5230 ROB \u7684\u74f6\u9888\uff0c\u90a3\u4e48\u5f53 N \u6bd4\u8f83\u5c0f\u7684\u65f6\u5019\uff0c\u74f6\u9888\u5728\u4e32\u884c fsqrt \u4e0a\uff0c\u6bcf\u6b21\u5faa\u73af\u7684\u5468\u671f\u6570\u5e94\u8be5\u4e3a <code>M*13</code>\uff1b\u5f53 N \u6bd4\u8f83\u5927\u7684\u65f6\u5019\uff0c\u74f6\u9888\u5728\u6bcf\u4e2a\u5468\u671f\u6267\u884c 8 \u4e2a NOP \u4e0a\uff08NOP \u88ab eliminate \u4e86\uff0c\u4e0d\u7528\u8fdb ALU\uff0c\u53ef\u4ee5\u6253\u6ee1 8 \u7684\u53d1\u5c04\u5bbd\u5ea6\uff09\uff0c\u6bcf\u6b21\u5faa\u73af\u7684\u5468\u671f\u6570\u5e94\u8be5\u4e3a <code>N/8</code> \u518d\u52a0\u4e0a\u4e00\u4e2a\u5e38\u6570\u3002</p>\n<p>\u4f46\u5f53 N \u5f88\u5927\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4f1a\u649e\u4e0a ROB \u5927\u5c0f\u7684\u9650\u5236\u3002\u4e0b\u9762\u7ed9\u51fa\u4e86\u4e0d\u540c\u7684 M \u53d6\u503c\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5faa\u73af\u5468\u671f\u6570\u5728 <code>M*13</code> \u5de6\u53f3\u7684\u6700\u5927\u7684 N \u53d6\u503c\uff1a</p>\n<ul>\n<li>M=21, N &lt;= 2109, cycle=273.74, M*13=273</li>\n<li>M=22, N &lt;= 2205, cycle=286.75, M*13=286</li>\n<li>M=23, N &lt;= 2269, cycle=299.76, M*13=299</li>\n<li>M=24, N &lt;= 2277, cycle=312.77, M*13=312</li>\n<li>M=25, N &lt;= 2275, cycle=325.77, M*13=325</li>\n<li>M=26, N &lt;= 2274, cycle=338.77, M*13=338</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230 N \u6700\u5927\u5728 2277 \u9644\u8fd1\u5c31\u4e0d\u80fd\u518d\u589e\u52a0\u4e86\uff0c\u8bf4\u660e\u9047\u5230\u4e86 ROB \u7684\u74f6\u9888\uff0c\u9884\u8ba1 ROB \u7684\u6240\u6709 group \u7684 entry \u4e2a\u6570\u52a0\u8d77\u6765\u5927\u6982\u662f 2277 \u5de6\u53f3\u3002</p>\n<p>\u800c\u5982\u679c\u628a\u586b\u5145\u7684\u6307\u4ee4\u6539\u6210 load/store\uff0cinflight \u7684 load \u548c store \u6700\u591a\u90fd\u662f 325 \u4e2a\uff0c\u5e76\u4e14\u8fd9\u548c load/store queue \u5927\u5c0f\u65e0\u5173\uff0c\u800c load/store \u53c8\u662f\u6709\u526f\u4f5c\u7528\u7684\uff0c\u5f88\u53ef\u80fd\u662f\u56e0\u4e3a\u5b83\u4eec\u53ea\u80fd\u5728 ROB \u6bcf\u4e2a group \u91cc\u53ea\u80fd\u653e\u4e00\u6761\uff0c\u4e8e\u662f\u770b\u8d77\u6765 ROB \u7684\u5bb9\u91cf\u6bd4 2277 \u5c0f\u4e86\u5f88\u591a\uff0c\u53ea\u8868\u73b0\u51fa 325\u3002\u6309\u7167\u8fd9\u4e2a\u731c\u60f3\uff0c\u5bf9\u4e8c\u8005\u8fdb\u884c\u9664\u6cd5\uff0c\u53d1\u73b0\u5546\u548c 7 \u5341\u5206\u63a5\u8fd1\uff0c\u8fd9\u5927\u6982\u7387\u610f\u5473\u7740 Firestorm \u7684 ROB \u6709 325 \u5de6\u53f3\u4e2a group\uff0c\u6bcf\u4e2a group \u5185\u6709 7 \u4e2a entry\uff0c\u6bcf\u4e2a entry \u53ef\u4ee5\u653e\u4e00\u6761\u6307\u4ee4\uff08uop\uff09\u3002\u6d4b\u8bd5\u91cc\u5f00\u5934\u7684 20 \u4e2a sqrt \u4e5f\u8981\u5360\u7528 ROB\uff0c\u5b9e\u9645\u7684 ROB group \u6570\u91cf\u53ef\u80fd\u6bd4 325 \u7565\u591a\u3002</p>\n<p>\u7ed3\u8bba\uff1aFirestorm \u7684 ROB \u6709\u5927\u7ea6 330 \u4e2a group\uff0c\u6bcf\u4e2a group \u6700\u591a\u4fdd\u5b58 7 \u4e2a uop\u3002</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u901a\u8fc7 sysctl \u53ef\u4ee5\u770b\u5230\uff0c4 \u4e2a Firestorm \u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 12MB L2 Cache\uff0c4 \u4e2a Icestorm \u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 4MB L2 Cache\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>hw.perflevel0.l2cachesize: 12582912\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>hw.perflevel0.cpusperl2: 4\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>hw.perflevel1.l2cachesize: 4194304\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>hw.perflevel1.cpusperl2: 4\n</span></code></pre></div>\n<h3 id=\"l2-tlb\">L2 TLB<a class=\"headerlink\" href=\"#l2-tlb\" title=\"Permanent link\">&para;</a></h3>\n<h4 id=\"firestorm_6\">Firestorm<a class=\"headerlink\" href=\"#firestorm_6\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4ece\u82f9\u679c\u63d0\u4f9b\u7684\u6027\u80fd\u8ba1\u6570\u5668\u6765\u770b\uff0cL1 TLB \u5206\u4e3a\u6307\u4ee4\u548c\u6570\u636e\uff0c\u800c L2 TLB \u662f Unified\uff0c\u4e0d\u533a\u5206\u6307\u4ee4\u548c\u6570\u636e\u3002\u6cbf\u7528\u4e4b\u524d\u6d4b\u8bd5 L1 DTLB \u7684\u65b9\u6cd5\uff0c\u628a\u89c4\u6a21\u6269\u5927\u5230 L2 Unified TLB \u7684\u8303\u56f4\uff0c\u5c31\u53ef\u4ee5\u6d4b\u51fa\u6765 L2 Unified TLB \u7684\u5bb9\u91cf\uff0c\u4e0b\u9762\u662f Firestorm \u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_firestorm_l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 3072 \u4e2a Page\uff0c\u8bf4\u660e Firestorm \u7684 L2 TLB \u5bb9\u91cf\u662f 3072 \u9879\u3002</p>\n<p>\u628a\u6307\u9488\u7684\u8de8\u5ea6\u589e\u5927\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 96\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 36.5</li>\n<li>\u5982\u679c\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 48\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 36.5</li>\n<li>\u5982\u679c\u6bcf 128 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 24\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 36.5</li>\n<li>\u5982\u679c\u6bcf 256 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 12\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 35</li>\n<li>\u5982\u679c\u6bcf 512 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u4f9d\u7136\u5728 12\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 35</li>\n<li>\u89c2\u5bdf\u5230\u547d\u4e2d L1 DTLB \u65f6 CPI \u662f 3\uff0c\u547d\u4e2d L2 TLB \u65f6 CPI \u662f 9\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u662f 35-36.5\uff0c\u6b64\u65f6\u7f13\u5b58\u7f3a\u5931\u7387\u4e3a 0</li>\n</ul>\n<p>\u8ba4\u4e3a Firestorm \u7684 L2 TLB \u662f 12 Way\uff0c256 Set\uff0cIndex \u4f4d\u662f VA[21:14]\u3002</p>\n<h4 id=\"icestorm_4\">Icestorm<a class=\"headerlink\" href=\"#icestorm_4\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 Icestorm \u4e0a\u6d4b\u8bd5\uff1a</p>\n<p><img alt=\"\" src=\"../../../../apple_m1_icestorm_l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 1024 \u4e2a Page\uff0c\u8bf4\u660e Icestorm \u7684 L2 TLB \u5bb9\u91cf\u662f 1024 \u9879\u3002</p>\n<p>\u628a\u6307\u9488\u7684\u8de8\u5ea6\u589e\u5927\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6bcf 32 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 32\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 33</li>\n<li>\u5982\u679c\u6bcf 64 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 16\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 32</li>\n<li>\u5982\u679c\u6bcf 128 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 8\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 32</li>\n<li>\u5982\u679c\u6bcf 256 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u524d\u79fb\u5230 4 \u548c L1 DTLB \u62d0\u70b9\u91cd\u5408\uff0c\u4e00\u65e6 L1 DTLB \u7f3a\u5931\uff0cL2 TLB \u4e5f\u7f3a\u5931\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 32</li>\n<li>\u89c2\u5bdf\u5230\u547d\u4e2d L1 DTLB \u65f6 CPI \u662f 3\uff0c\u547d\u4e2d L2 TLB \u65f6 CPI \u662f 10\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u662f 32-33\uff0c\u6b64\u65f6\u7f13\u5b58\u7f3a\u5931\u7387\u4e3a 0</li>\n</ul>\n<p>\u7531\u4e8e Icestorm \u7684 L1 DTLB \u5c31\u662f 4 Way\uff0c\u4e0d\u786e\u5b9a Icestorm \u7684 L2 TLB \u7ec4\u76f8\u8fde\u662f 1/2/4 Way \u7684\u54ea\u4e00\u79cd\uff0c\u5047\u5982\u662f 4 Way\uff0c\u90a3\u4e48 Icestorm \u7684 L2 TLB \u662f 4 Way\uff0c256 Set\uff0cIndex \u4f4d\u662f VA[21:14]\u3002</p>", "image": null, "date_modified": "2024-12-26T00:00:00+00:00", "authors": [], "tags": ["apple", "cpu", "firestorm", "hardware", "icestorm", "m1", "performance", "uarch-review"]}, {"id": "https://jia.je/software/2024/12/10/linux-perf-pmu/", "url": "https://jia.je/software/2024/12/10/linux-perf-pmu/", "title": "Linux \u7684\u6027\u80fd\u5206\u6790\uff08Perf\uff09\u5b9e\u73b0\u63a2\u7a76", "content_html": "<h1 id=\"linux-\u7684\u6027\u80fd\u5206\u6790perf\u5b9e\u73b0\u63a2\u7a76\">Linux \u7684\u6027\u80fd\u5206\u6790\uff08Perf\uff09\u5b9e\u73b0\u63a2\u7a76<a class=\"headerlink\" href=\"#linux-\u7684\u6027\u80fd\u5206\u6790perf\u5b9e\u73b0\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u4f7f\u7528 Linux \u7684\u6027\u80fd\u5206\u6790\u529f\u80fd\u6bd4\u8f83\u591a\uff0c\u4f46\u662f\u5f88\u5c11\u53bb\u63a2\u7a76\u80cc\u540e\u7684\u539f\u7406\uff0c\u4f8b\u5982\u786c\u4ef6\u7684 PMU \u662f\u600e\u4e48\u914d\u7f6e\u7684\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u4e43\u81f3\u6bcf\u4e2a\u7ebf\u7a0b\u7ea7\u522b\u7684 PMU \u662f\u600e\u4e48\u91c7\u6837\u7684\u3002\u8fd9\u7bc7\u535a\u5ba2\u5c1d\u8bd5\u63a2\u7a76\u8fd9\u80cc\u540e\u7684\u539f\u7406\u3002</p>\n<!-- more -->\n\n<h2 id=\"pmu\">PMU<a class=\"headerlink\" href=\"#pmu\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u786c\u4ef6\">\u786c\u4ef6<a class=\"headerlink\" href=\"#\u786c\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u652f\u6491\u6027\u80fd\u5206\u6790\u7684\u80cc\u540e\u662f\u786c\u4ef6\u63d0\u4f9b\u7684\u673a\u5236\uff0c\u6700\u5e38\u7528\u7684\u5c31\u662f\u6027\u80fd\u8ba1\u6570\u5668\uff1a\u786c\u4ef6\u4f1a\u63d0\u4f9b\u4e00\u4e9b\u53ef\u4ee5\u914d\u7f6e\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u5728\u5bf9\u5e94\u7684\u786c\u4ef6\u4e8b\u4ef6\u89e6\u53d1\u662f\uff0c\u66f4\u65b0\u8fd9\u4e9b\u8ba1\u6570\u5668\uff0c\u7136\u540e\u518d\u7531\u7a0b\u5e8f\u8bfb\u53d6\u8ba1\u6570\u5668\u7684\u503c\u5e76\u7edf\u8ba1\u3002\u4e0b\u9762\u4ee5 ARM \u4e3a\u4f8b\uff0c\u5206\u6790\u4e00\u4e0b\u786c\u4ef6\u63d0\u4f9b\u7684\u6027\u80fd\u8ba1\u6570\u7684\u63a5\u53e3\uff1a</p>\n<ol>\n<li>Cycle \u8ba1\u6570\u5668\uff1aCycle Counter Register(PMCCNTR_EL0) \u548c Cycle Count Filter Register(PMCCFILTR_EL0)\uff0c\u5176\u4e2d\u540e\u8005\u63a7\u5236\u524d\u8005\u5728\u4ec0\u4e48\u7279\u6743\u6001\u4e0b\u4f1a\u8fdb\u884c\u8ba1\u6570</li>\n<li>\u6700\u591a 31 \u4e2a\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff1a<ol>\n<li>\u8be5\u6027\u80fd\u8ba1\u6570\u5668\u8bb0\u5f55\u7684\u786c\u4ef6\u4e8b\u4ef6\u4ee5\u53ca\u8ba1\u6570\u7684\u6761\u4ef6\uff1aPMEVTYPER<n>_EL0\uff0cn \u53d6 0 \u5230 31</li>\n<li>\u8be5\u6027\u80fd\u8ba1\u6570\u5668\u5f53\u524d\u7684\u503c\uff1aPMEVCNTR<n>_EL0\uff0cn \u53d6 0 \u5230 31</li>\n</ol>\n</li>\n<li>\u63a7\u5236 Cycle \u8ba1\u6570\u5668\u548c\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\u7684\u72b6\u6001\uff1aPMCNTENCLR_EL0/PMCNTENSET_EL0/PMCR_EL0</li>\n<li>\u5404\u8ba1\u6570\u5668\u662f\u5426\u6ea2\u51fa\uff1aPMOVSCLR_EL0/PMOVSSET_EL0</li>\n<li>\u5f53\u8ba1\u6570\u5668\u6ea2\u51fa\u65f6\uff0cPMU \u4f1a\u62c9\u8d77\u4e2d\u65ad\uff0c\u9488\u5bf9\u8fd9\u4e9b\u4e2d\u65ad\u7684\u914d\u7f6e\uff1aPMINTENCLR_EL1/PMINTENSET_EL1</li>\n</ol>\n<p>\u6ce8\uff1a\u5b9e\u9645\u4e0a\uff0c\u7531\u4e8e\u7ecf\u5e38\u4f1a\u5bf9\u6307\u4ee4\u6570\u8fdb\u884c\u91c7\u6837\uff0cARM v9.4/8.9 \u5141\u8bb8\u786c\u4ef6\u5b9e\u73b0\u4e00\u4e2a\u989d\u5916\u7684\u6307\u4ee4\u8ba1\u6570\u5668\uff0c\u548c Cycle \u8ba1\u6570\u5668\u7c7b\u4f3c\u3002</p>\n<p>\u5982\u679c\u60f3\u8981\u5728\u7528\u6237\u6001\u9891\u7e41\u5730\u8bfb\u53d6\u6027\u80fd\u8ba1\u6570\u5668\uff08cap_user_rdpmc\uff09\uff0c\u907f\u514d\u9891\u7e41\u8fdb\u5165\u5185\u6838\u7684\u5f00\u9500\uff0c\u4e5f\u53ef\u4ee5\u5728\u7528\u6237\u6001\u4e2d\u76f4\u63a5\u8bfb\u53d6\u6027\u80fd\u8ba1\u6570\u5668 PMCCNTR_EL0/PMEVCNTR<n>_EL0\uff1a\u5185\u6838\u5728 PMUSERENR_EL0 \u4e2d\u8fdb\u884c\u76f8\u5e94\u7684\u6743\u9650\u914d\u7f6e\u5373\u53ef\u3002v3.9 \u6216\u66f4\u9ad8\u7248\u672c\u7684 PMU \u5b9e\u73b0\u5141\u8bb8\u6309\u7167\u6bcf\u4e2a counter \u7684\u7c92\u5ea6\u6765\u63a7\u5236\u7528\u6237\u6001\u662f\u5426\u5141\u8bb8\u8bbf\u95ee\uff08PMUACR\uff09\u3002</p>\n<p>LoongArch \u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u5176\u63a5\u53e3\u66f4\u7b80\u5355\uff1a\u5b83\u53ea\u6709\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6709\u5982\u4e0b\u7684 csr \u6765\u914d\u7f6e\u5404\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\uff1a</p>\n<ol>\n<li>\u6027\u80fd\u8ba1\u6570\u5668\u7684\u503c\uff1aperfcntr<n></li>\n<li>\u6027\u80fd\u8ba1\u6570\u5668\u7684\u914d\u7f6e\uff1aperfctrl<n>\uff0c\u6709\u5982\u4e0b\u5b57\u6bb5\uff1a<ol>\n<li>EVENT: \u4e8b\u4ef6\u7f16\u53f7</li>\n<li>PLV{0,1,2,3}: \u7279\u6743\u6001\u8fc7\u6ee4\uff0c\u5bf9\u5e94\u56db\u4e2a\u7279\u6743\u6001\u4e0b\u662f\u5426\u91c7\u6837</li>\n<li>IE\uff1a\u662f\u5426\u542f\u7528\u6ea2\u51fa\u4e2d\u65ad</li>\n</ol>\n</li>\n<li>misc.rpcntl3\uff1a\u5141\u8bb8\u7528\u6237\u6001\u7a0b\u5e8f\u8bfb\u53d6\u6027\u80fd\u8ba1\u6570\u5668</li>\n</ol>\n<h3 id=\"\u5185\u6838\u9a71\u52a8\">\u5185\u6838\u9a71\u52a8<a class=\"headerlink\" href=\"#\u5185\u6838\u9a71\u52a8\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 Linux \u5185\u6838\u4e2d\uff0c\u8d1f\u8d23\u63a7\u5236 ARM \u6027\u80fd\u8ba1\u6570\u63a5\u53e3\u7684\u4ee3\u7801\u5728 <a href=\"https://github.com/torvalds/linux/blob/master/drivers/perf/arm_pmuv3.c\">arm_pmuv3.c</a> \u5f53\u4e2d\u3002\u6839\u636e\u8fd9\u4e2a\u786c\u4ef6\u63a5\u53e3\uff0c\u53ef\u4ee5\u9884\u60f3\u5230\uff0c\u5982\u679c\u8981\u5bf9\u4e00\u6bb5\u7a0b\u5e8f\u89c2\u5bdf\u5b83\u5728\u67d0\u4e2a\u8ba1\u6570\u5668\u4e0a\u7684\u53d6\u503c\uff0c\u9700\u8981\uff1a</p>\n<ol>\n<li>\u5206\u914d\u4e00\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u53ef\u80fd\u662f Cycle \u8ba1\u6570\u5668\u6216\u8005\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\uff1a\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L938\">armv8pmu_get_event_idx</a> \u51fd\u6570\uff0c\u5148\u5206\u914d Cycle \u8ba1\u6570\u5668\uff0c\u518d\u4ece\u5269\u4e0b\u7684\u901a\u7528\u6027\u80fd\u8ba1\u6570\u5668\u4e2d\u627e\u5230\u4e00\u4e2a\u7a7a\u95f2\u7684</li>\n<li>\u914d\u7f6e\u5e76\u542f\u7528\u8be5\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L796\">armv8pmu_enable_event</a> \u51fd\u6570\uff1a<ol>\n<li>\u628a\u4e8b\u4ef6\u7c7b\u578b\u5199\u5165\u5230 PMEVTYPER<n>_EL0 \u4e2d\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L629\">armv8pmu_write_event_type</a> \u51fd\u6570</li>\n<li>\u542f\u7528\u4e8b\u4ef6\u5bf9\u5e94\u7684\u6ea2\u51fa\u4e2d\u65ad\uff0c\u5199\u5165 PMINTENSET_EL1\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L714\">armv8pmu_enable_event_irq</a> \u51fd\u6570</li>\n<li>\u4e8b\u4ef6\u5f00\u59cb\u8ba1\u6570\uff0c\u5199\u5165 PMCNTENSET_EL0\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L675\">armv8pmu_enable_event_counter</a> \u51fd\u6570</li>\n</ol>\n</li>\n<li>\u5728\u7a0b\u5e8f\u5f00\u59cb\u524d\uff0c\u4ece PMEVCNTR<n>_EL0 \u8bfb\u53d6\u4e00\u6b21\u8ba1\u6570\u5668\u7684\u5f53\u524d\u53d6\u503c\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L566\">armv8pmu_read_counter</a> \u51fd\u6570</li>\n<li>\u5728\u7a0b\u5e8f\u7ed3\u675f\u65f6\uff0c\u518d\u8bfb\u53d6\u4e00\u6b21\u8ba1\u6570\u5668\u7684\u5f53\u524d\u53d6\u503c\uff0c\u548c\u7a0b\u5e8f\u5f00\u59cb\u65f6\u7684\u503c\u6c42\u5dee</li>\n<li>\u4e3a\u4e86\u89e3\u51b3\u6ea2\u51fa\u7684\u95ee\u9898\uff1a\u914d\u7f6e\u4e2d\u65ad\uff0c\u5728\u6ea2\u51fa\u65f6\u4f1a\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u4ee3\u7801\uff0c\u7edf\u8ba1\u6ea2\u51fa\u6b21\u6570\uff0c\u8ba1\u5165\u5dee\u503c\u7684\u9ad8\u4f4d\uff0c\u5bf9\u5e94 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/drivers/perf/arm_pmuv3.c#L840\">armv8pmu_handle_irq</a> \u51fd\u6570</li>\n</ol>\n<h3 id=\"perf-\u5b50\u7cfb\u7edf\">Perf \u5b50\u7cfb\u7edf<a class=\"headerlink\" href=\"#perf-\u5b50\u7cfb\u7edf\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9664\u4e86\u7531\u5355\u72ec\u7684\u67b6\u6784\u76f8\u5173\u7684\u5185\u6838\u9a71\u52a8\u8d1f\u8d23\u914d\u7f6e\u786c\u4ef6\u4ee5\u5916\uff0c\u8fd8\u9700\u8981\u7531 Perf \u5b50\u7cfb\u7edf\u6765\u5904\u7406\u6765\u81ea\u7528\u6237\u7684 perf \u4f7f\u7528\u3002\u5177\u4f53\u5730\uff0c\u5185\u6838\u9a71\u52a8\u4f1a\u6ce8\u518c\u4e00\u4e2a <code>struct pmu</code> \u7ed9 Perf \u5b50\u7cfb\u7edf\uff0c\u5b9e\u73b0\u8fd9\u4e9b\u51fd\u6570\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"c1\">// Fully disable/enable this PMU</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">pmu_enable</span><span class=\"p\">)</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pmu</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">pmu</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"cm\">/* optional */</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">pmu_disable</span><span class=\"p\">)</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">pmu</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">pmu</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"cm\">/* optional */</span>\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"c1\">// Try and initialize the event for this PMU.</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">event_init</span><span class=\"p\">)</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-6\"><a id=\"__codelineno-0-6\" name=\"__codelineno-0-6\" href=\"#__codelineno-0-6\"></a><span class=\"c1\">// Adds/Removes a counter to/from the PMU</span>\n</span><span id=\"__span-0-7\"><a id=\"__codelineno-0-7\" name=\"__codelineno-0-7\" href=\"#__codelineno-0-7\"></a><span class=\"kt\">int</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">add</span><span class=\"p\">)</span><span class=\"w\">         </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-8\"><a id=\"__codelineno-0-8\" name=\"__codelineno-0-8\" href=\"#__codelineno-0-8\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">del</span><span class=\"p\">)</span><span class=\"w\">         </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-9\"><a id=\"__codelineno-0-9\" name=\"__codelineno-0-9\" href=\"#__codelineno-0-9\"></a><span class=\"c1\">// Starts/Stops a counter present on the PMU.</span>\n</span><span id=\"__span-0-10\"><a id=\"__codelineno-0-10\" name=\"__codelineno-0-10\" href=\"#__codelineno-0-10\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">start</span><span class=\"p\">)</span><span class=\"w\">           </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-11\"><a id=\"__codelineno-0-11\" name=\"__codelineno-0-11\" href=\"#__codelineno-0-11\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">stop</span><span class=\"p\">)</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"p\">);</span>\n</span><span id=\"__span-0-12\"><a id=\"__codelineno-0-12\" name=\"__codelineno-0-12\" href=\"#__codelineno-0-12\"></a><span class=\"c1\">// Updates the counter value of the event.</span>\n</span><span id=\"__span-0-13\"><a id=\"__codelineno-0-13\" name=\"__codelineno-0-13\" href=\"#__codelineno-0-13\"></a><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">read</span><span class=\"p\">)</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">perf_event</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">event</span><span class=\"p\">);</span>\n</span></code></pre></div>\n<p>\u53ef\u89c1\u5728\u5185\u6838\u91cc\uff0cPMU \u8ba1\u6570\u5668\u7684\u62bd\u8c61\u662f <code>struct perf_event</code>\uff0c\u8fd9\u4e2a\u662f\u67b6\u6784\u65e0\u5173\u7684\uff0c\u6839\u636e\u7528\u6237\u6001\u7a0b\u5e8f\u901a\u8fc7 <code>perf_event_open</code> \u6784\u9020\u51fa\u6765\u7684\uff1b\u5185\u6838\u9a71\u52a8\u5c31\u4f1a\u6839\u636e\u8fd9\u4e2a <code>struct perf_event</code> \u53bb\u8fdb\u884c\u5b9e\u9645\u7684\u786c\u4ef6\u8ba1\u6570\u5668\u7684\u914d\u7f6e\u3002\u4f8b\u5982\u7528\u6237\u7a0b\u5e8f\u5728 <code>struct perf_event_attr</code> \u91cc\u8bbe\u7f6e <code>exclude_kernel = 1</code>\uff0c\u5c31\u4f1a\u4f20\u5230 <code>struct perf_event</code> \u5f53\u4e2d\uff0c\u6700\u540e\u5728\u76f8\u5e94\u7684\u5185\u6838\u9a71\u52a8\u4e2d\uff0c\u53d8\u6210\u786c\u4ef6\u6027\u80fd\u8ba1\u6570\u5668\u914d\u7f6e\u91cc\uff0c\u8ba1\u6570\u65f6\u5ffd\u7565\u5185\u6838\u6240\u5728\u7279\u6743\u6001\u7684\u914d\u7f6e\u3002</p>\n<p><code>perf record</code> \u662f\u57fa\u4e8e\u91c7\u6837\u5b9e\u73b0\u7684\uff1a\u5f53\u6027\u80fd\u8ba1\u6570\u5668\u6ea2\u51fa\uff08\u4e00\u822c\u662f Cycle \u8ba1\u6570\u5668\uff09\u7684\u65f6\u5019\uff0c\u89e6\u53d1\u4e2d\u65ad\u8fdb\u5165\u5185\u6838\uff0c\u6b64\u65f6\u7531\u8f6f\u4ef6\u6765\u6536\u96c6\u88ab\u6253\u65ad\u7684\u7a0b\u5e8f\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u6536\u96c6\u5b8c\u6210\u540e\u518d\u56de\u5230\u88ab\u6253\u65ad\u7684\u7a0b\u5e8f\u7ee7\u7eed\u6267\u884c\u3002</p>\n<h3 id=\"\u865a\u62df\u5316\">\u865a\u62df\u5316<a class=\"headerlink\" href=\"#\u865a\u62df\u5316\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728\u865a\u62df\u5316\u573a\u666f\u4e0b\uff0c\u4f9d\u7136\u5e0c\u671b\u865a\u62df\u673a\u5185\u7684 OS \u53ef\u4ee5\u6709\u6027\u80fd\u8ba1\u6570\u5668\u53ef\u4ee5\u7528\uff0c\u540c\u65f6\u5bbf\u4e3b\u673a\u4e0a\u4e5f\u53ef\u80fd\u5e0c\u671b\u83b7\u53d6\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\u4fe1\u606f\u3002</p>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f\u4ee5\u7eaf\u8f6f\u4ef6\u7684\u65b9\u6cd5\u53bb\u5b9e\u73b0\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6bd4\u5982 <a href=\"https://github.com/qemu/qemu/blob/1cf9bc6eba7506ab6d9de635f224259225f63466/target/arm/helper.c#L996\">QEMU \u7684 TCG \u6a21\u5f0f</a>\uff0c\u53ef\u4ee5\u6a21\u62df\u51fa\u4e00\u4e2a\u4ee5\u56fa\u5b9a\u9891\u7387\u8fd0\u884c\u7684\u5904\u7406\u5668\u7684 Cycle \u8ba1\u6570\u5668\uff0c\u4f46\u5b9e\u9645\u4e0a\u5c31\u662f\u62ff\u65f6\u95f4\u9664\u4ee5\u9891\u7387\uff0c\u662f\u5047\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff1b\u6b64\u5916\u8fd8\u80fd\u6a21\u62df\u51fa Instruction \u8ba1\u6570\u5668\uff0c\u56e0\u4e3a QEMU \u5728\u505a\u6307\u4ee4\u7ffb\u8bd1\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u987a\u5e26\u8bb0\u5f55\u4e0b\u6267\u884c\u7684\u6307\u4ee4\u6570\uff1b\u800c\u5fae\u67b6\u6784\u76f8\u5173\u7684\u6027\u80fd\u8ba1\u6570\u5668\u5c31\u6ca1\u6cd5\u9760\u8fd9\u4e2a\u6765\u5b9e\u73b0\u4e86\u3002</p>\n<p>\u53e6\u4e00\u79cd\u65b9\u6cd5\u5219\u662f\u5728\u786c\u4ef6\u865a\u62df\u5316\u7684\u57fa\u7840\u4e0a\uff0c\u8ba9\u865a\u62df\u673a\u4eab\u53d7\u5230\u6027\u80fd\u8ba1\u6570\u5668\u3002\u4e0d\u8fc7\u4e3a\u4e86\u5b89\u5168\u6027\uff0c\u5bbf\u4e3b\u673a\u53ef\u4ee5\u83b7\u53d6\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u4f46\u53cd\u8fc7\u6765\uff0c\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\u4e0d\u5e94\u8be5\u5f97\u5230\u5bbf\u4e3b\u673a\u7684\u4fe1\u606f\u3002</p>\n<p>\u76ee\u524d LoongArch KVM \u5df2\u7ecf\u652f\u6301\u6027\u80fd\u8ba1\u6570\u5668\u7684\u865a\u62df\u5316\uff0c\u4e0b\u9762\u6765\u770b\u5b83\u662f\u600e\u4e48\u505a\u7684\uff1a</p>\n<ol>\n<li>\u7ed9\u5bbf\u4e3b\u673a\uff08host\uff09\u7ef4\u62a4\u4e00\u4efd\u6027\u80fd\u8ba1\u6570\u5668\u7684\u4e0a\u4e0b\u6587\uff0c\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L35\">kvm_save_host_pmu</a> \u4fdd\u5b58\uff0c\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L50\">kvm_restore_host_pmu</a> \u6062\u590d</li>\n<li>\u518d\u7ed9\u6bcf\u4e2a\u865a\u62df\u673a\uff08guest\uff09\u7ef4\u62a4\u4e00\u4efd\u6027\u80fd\u8ba1\u6570\u5668\u7684\u4e0a\u4e0b\u6587\uff0c\u6b64\u65f6\u4e3a\u4e86\u8bbf\u95ee\u865a\u62df\u673a\u7684 csr\uff0c\u8981\u8bbf\u95ee gcsr(guest csr)\uff1a\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L66\">kvm_save_guest_pmu</a> \u4fdd\u5b58\uff0c\u7528 <a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L80\">kvm_restore_guest_pmu</a></li>\n<li>\u5f53\u865a\u62df\u673a\uff08guest\uff09\u56e0\u4e3a\u5404\u79cd\u539f\u56e0\u56de\u5230\u4e86 VMM\uff0c\u5c31\u8981\u8fdb\u884c<a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L94\">\u4e0a\u4e0b\u6587\u5207\u6362</a>\uff0c\u4fdd\u5b58\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6062\u590d\u5bbf\u4e3b\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff1b\u540c\u7406\uff0c\u8fdb\u5165\u865a\u62df\u673a\u65f6\uff0c\u518d\u6b21\u8fdb\u884c<a href=\"https://github.com/torvalds/linux/blob/7cb1b466315004af98f6ba6c2546bb713ca3c237/arch/loongarch/kvm/vcpu.c#L113\">\u4e0a\u4e0b\u6587\u5207\u6362</a>\uff0c\u4fdd\u5b58\u5bbf\u4e3b\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u6062\u590d\u865a\u62df\u673a\u7684\u6027\u80fd\u8ba1\u6570\u5668</li>\n</ol>\n<h2 id=\"intel-pt\">Intel PT<a class=\"headerlink\" href=\"#intel-pt\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel PT \u662f Intel \u5e73\u53f0\u4e0a\u8ddf\u8e2a\u6307\u4ee4\u6d41\u7684\u673a\u5236\uff0c\u5b83\u53ef\u4ee5\u8bb0\u5f55\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u9875\u8868\u7684\u4fee\u6539</li>\n<li>\u65f6\u949f\u5468\u671f</li>\n<li>\u5206\u652f\u8df3\u8f6c</li>\n<li>\u529f\u8017\u72b6\u6001\u53d8\u5316</li>\n</ol>\n<p>perf \u5de5\u5177\u4e5f\u662f\u652f\u6301\u7528 Intel PT \u8fdb\u884c\u8ddf\u8e2a\u7684\uff1a<a href=\"https://www.man7.org/linux/man-pages/man1/perf-intel-pt.1.html\">perf-intel-pt(1) \u2014 Linux manual page</a>\uff0c\u4e0b\u9762\u7684\u547d\u4ee4\u7528 Intel PT \u8ddf\u8e2a\u4e00\u6761\u547d\u4ee4\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u5e76\u663e\u793a\u51fa\u5b83\u751f\u6210\u7684\u8ddf\u8e2a\u4fe1\u606f\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>perf<span class=\"w\"> </span>record<span class=\"w\"> </span>-e<span class=\"w\"> </span>intel_pt//u<span class=\"w\"> </span>ls\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"c1\"># itrace: instruction trace</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"c1\"># i: instructions events</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"c1\"># y: cycles events</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"c1\"># b: branches events</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"c1\"># x: transactions events</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"c1\"># w: ptwrite events</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a><span class=\"c1\"># p: power events</span>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"c1\"># e: error events</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a>perf<span class=\"w\"> </span>script<span class=\"w\"> </span>--itrace<span class=\"o\">=</span>iybxwpe\n</span></code></pre></div>\n<p>\u6bd4\u5982\u5199\u4e00\u4e2a\u5faa\u73af 10 \u6b21\u7684\u4ee3\u7801\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"w\">  </span><span class=\"p\">}</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5bf9\u5e94\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"err\">0000000000001129</span><span class=\"w\"> </span><span class=\"err\">&lt;</span><span class=\"nf\">main</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"err\">1129:</span><span class=\"w\">       </span><span class=\"err\">55</span><span class=\"w\">                      </span><span class=\"nf\">push</span><span class=\"w\">   </span><span class=\"nv\">%rbp</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"w\">    </span><span class=\"err\">112</span><span class=\"nl\">a:</span><span class=\"w\">       </span><span class=\"err\">48</span><span class=\"w\"> </span><span class=\"err\">89</span><span class=\"w\"> </span><span class=\"nf\">e5</span><span class=\"w\">                </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"nv\">%rsp</span><span class=\"p\">,</span><span class=\"nv\">%rbp</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"err\">112</span><span class=\"nl\">d:</span><span class=\"w\">       </span><span class=\"nf\">c7</span><span class=\"w\"> </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"no\">fc</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"no\">movl</span><span class=\"w\">   </span><span class=\"no\">$0x0</span><span class=\"p\">,-</span><span class=\"mi\">0x4</span><span class=\"p\">(</span><span class=\"nv\">%rbp</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"w\">    </span><span class=\"err\">1134:</span><span class=\"w\">       </span><span class=\"nf\">eb</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\">                   </span><span class=\"no\">jmp</span><span class=\"w\">    </span><span class=\"mh\">113a</span> <span class=\"p\">&lt;</span><span class=\"no\">main</span><span class=\"p\">+</span><span class=\"mi\">0x11</span><span class=\"p\">&gt;</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"w\">    </span><span class=\"err\">1136:</span><span class=\"w\">       </span><span class=\"err\">83</span><span class=\"w\"> </span><span class=\"err\">45</span><span class=\"w\"> </span><span class=\"nf\">fc</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">             </span><span class=\"no\">addl</span><span class=\"w\">   </span><span class=\"no\">$0x1</span><span class=\"p\">,-</span><span class=\"mi\">0x4</span><span class=\"p\">(</span><span class=\"nv\">%rbp</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"w\">    </span><span class=\"err\">113</span><span class=\"nl\">a:</span><span class=\"w\">       </span><span class=\"err\">83</span><span class=\"w\"> </span><span class=\"err\">7</span><span class=\"nf\">d</span><span class=\"w\"> </span><span class=\"no\">fc</span><span class=\"w\"> </span><span class=\"mi\">09</span><span class=\"w\">             </span><span class=\"no\">cmpl</span><span class=\"w\">   </span><span class=\"no\">$0x9</span><span class=\"p\">,-</span><span class=\"mi\">0x4</span><span class=\"p\">(</span><span class=\"nv\">%rbp</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"w\">    </span><span class=\"err\">113</span><span class=\"nl\">e:</span><span class=\"w\">       </span><span class=\"err\">7</span><span class=\"nf\">e</span><span class=\"w\"> </span><span class=\"no\">f6</span><span class=\"w\">                   </span><span class=\"no\">jle</span><span class=\"w\">    </span><span class=\"mh\">1136</span> <span class=\"p\">&lt;</span><span class=\"no\">main</span><span class=\"p\">+</span><span class=\"mi\">0xd</span><span class=\"p\">&gt;</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"err\">1140:</span><span class=\"w\">       </span><span class=\"nf\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"no\">mov</span><span class=\"w\">    </span><span class=\"no\">$0x0</span><span class=\"p\">,</span><span class=\"nv\">%eax</span>\n</span><span id=\"__span-3-10\"><a id=\"__codelineno-3-10\" name=\"__codelineno-3-10\" href=\"#__codelineno-3-10\"></a><span class=\"w\">    </span><span class=\"err\">1145:</span><span class=\"w\">       </span><span class=\"err\">5</span><span class=\"nf\">d</span><span class=\"w\">                      </span><span class=\"no\">pop</span><span class=\"w\">    </span><span class=\"nv\">%rbp</span>\n</span><span id=\"__span-3-11\"><a id=\"__codelineno-3-11\" name=\"__codelineno-3-11\" href=\"#__codelineno-3-11\"></a><span class=\"w\">    </span><span class=\"err\">1146:</span><span class=\"w\">       </span><span class=\"nf\">c3</span><span class=\"w\">                      </span><span class=\"no\">ret</span>\n</span></code></pre></div>\n<p>\u6309\u7167\u4e0a\u8ff0\u65b9\u6cd5\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u751f\u6210\u4e86\u5404\u4e2a\u5206\u652f\u8df3\u8f6c\u7684\u4fe1\u606f\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      7311943d6248 __libc_start_call_main+0x78 (/usr/lib/x86_64-linux-gnu/libc.so.6) =&gt;     5b4f1df51129 main+0x0 (/home/jiegec/test1)\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df51134 main+0xb (/home/jiegec/test1) =&gt;     5b4f1df5113a main+0x11 (/home/jiegec/test1)\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-8\"><a id=\"__codelineno-4-8\" name=\"__codelineno-4-8\" href=\"#__codelineno-4-8\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-9\"><a id=\"__codelineno-4-9\" name=\"__codelineno-4-9\" href=\"#__codelineno-4-9\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-10\"><a id=\"__codelineno-4-10\" name=\"__codelineno-4-10\" href=\"#__codelineno-4-10\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-11\"><a id=\"__codelineno-4-11\" name=\"__codelineno-4-11\" href=\"#__codelineno-4-11\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-12\"><a id=\"__codelineno-4-12\" name=\"__codelineno-4-12\" href=\"#__codelineno-4-12\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df5113e main+0x15 (/home/jiegec/test1) =&gt;     5b4f1df51136 main+0xd (/home/jiegec/test1)\n</span><span id=\"__span-4-13\"><a id=\"__codelineno-4-13\" name=\"__codelineno-4-13\" href=\"#__codelineno-4-13\"></a>test1 3772291 [006] 1693209.504363:          1     branches:u:      5b4f1df51146 main+0x1d (/home/jiegec/test1) =&gt;     7311943d624a __libc_start_call_main+0x7a (/usr/lib/x86_64-linux-gnu/libc.so.6)\n</span></code></pre></div>\n<p>\u901a\u8fc7\u8fd9\u4e2a\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u8fd8\u539f\u51fa\u7a0b\u5e8f\u6267\u884c\u4e86\u54ea\u4e9b\u4ee3\u7801\uff1a</p>\n<ol>\n<li>__libc_start_call_main \u8c03\u7528 main \u51fd\u6570\uff0c\u5230\u5165\u53e3 0x1129(main+0x0)</li>\n<li>\u4ece 0x1134(main+0xb) \u8df3\u8f6c\u5230 0x113a(main+0x11)</li>\n<li>\u5faa\u73af 10 \u6b21\uff1a0x113e(main+0x15) \u8df3\u8f6c\u5230 0x1136(main+0xd)</li>\n<li>\u6700\u7ec8 \u5728 0x1146(main+0x1d) return \u56de\u5230 __libc_start_call_main \u51fd\u6570</li>\n</ol>\n<p>\u5982\u679c\u8981\u770b Intel PT \u5230\u5e95\u751f\u6210\u4e86\u4ec0\u4e48\u6570\u636e\uff0c\u53ef\u4ee5\u7528 <code>perf script -D</code> \u663e\u793a\u3002\u4f8b\u5982\u8981\u8bb0\u5f55\u5206\u652f\u8df3\u8f6c\u8fd8\u662f\u4e0d\u8df3\u8f6c\u7684\u5386\u53f2\uff0c\u7528\u7684\u662f\u5982\u4e0b\u7684 TNT(Taken/Not Taken) packet\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-perf-pmu-intel-pt-dump.png\" /></p>\n<p>TNT packet \u7684\u5b9a\u4e49\u5728 <a href=\"https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html\">Intel\u00ae 64 and IA-32 Architectures Software Developer Manuals</a> \u4e2d\u7ed9\u51fa\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-perf-pmu-intel-tnt.png\" /></p>\n<p>\u7531\u4e8e Intel PT \u7684\u6570\u636e\u91cf\u5f88\u5927\uff0c\u5b83\u548c SPE \u7c7b\u4f3c\uff0c\u4e5f\u662f\u5728\u5185\u5b58\u4e2d\u4fdd\u5b58 trace \u4fe1\u606f\u3002</p>\n<h2 id=\"intel-lbr\">Intel LBR<a class=\"headerlink\" href=\"#intel-lbr\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel LBR(Last Branch Record) \u673a\u5236\u8bb0\u5f55\u4e86\u5904\u7406\u5668\u6700\u8fd1\u82e5\u5e72\u6b21\u63a7\u5236\u6d41\u8f6c\u79fb\uff0c\u6bd4\u5982 taken branch\u3002\u5b83\u8bb0\u5f55\u7684\u6570\u91cf\u5f88\u5c0f\uff0c\u4fe1\u606f\u76f4\u63a5\u4fdd\u5b58\u5728 MSR \u5f53\u4e2d\uff0c\u800c\u4e0d\u662f\u50cf\u524d\u9762\u7684 SPE \u548c Intel PT \u90a3\u6837\uff0c\u9700\u8981\u5728\u5185\u5b58\u4e2d\u8bb0\u5f55\u4fe1\u606f\u3002</p>\n<p>LBR \u5728 perf \u4e2d\uff0c\u4e3b\u8981\u7528\u6765\u8ddf\u8e2a call stack\uff1a\u8bbe\u7f6e LBR\uff0c\u53ea\u8bb0\u5f55 call \u6307\u4ee4\uff0c\u5e76\u4e14\u6253\u5f00 call-stack \u6a21\u5f0f\uff0c\u90a3\u4e48 LBR \u8bb0\u5f55\u7684\u5c31\u662f\u5f53\u524d\u7684 call stack\uff0cperf \u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a\u4fe1\u606f\u6765\u627e\u5230\u5f53\u524d\u51fd\u6570\u7684\u8c03\u7528\u94fe\uff0c\u867d\u7136\u6709\u957f\u5ea6\u9650\u5236\u3002\u9664\u4e86 lbr \u4ee5\u5916\uff0cperf \u8fd8\u652f\u6301\u5229\u7528 fp(frame pointer) \u6216 dwarf(\u8c03\u8bd5\u4fe1\u606f) \u6765<a href=\"https://man7.org/linux/man-pages/man1/perf-record.1.html\">\u5bfb\u627e\u8c03\u7528\u94fe</a>\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a>--call-graph\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a>    Setup and enable call-graph (stack chain/backtrace)\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a>    recording, implies -g. Default is &quot;fp&quot; (for user space).\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a>\n</span><span id=\"__span-5-5\"><a id=\"__codelineno-5-5\" name=\"__codelineno-5-5\" href=\"#__codelineno-5-5\"></a>    Valid options are &quot;fp&quot; (frame pointer), &quot;dwarf&quot; (DWARF&#39;s CFI -\n</span><span id=\"__span-5-6\"><a id=\"__codelineno-5-6\" name=\"__codelineno-5-6\" href=\"#__codelineno-5-6\"></a>    Call Frame Information) or &quot;lbr&quot; (Hardware Last Branch Record\n</span><span id=\"__span-5-7\"><a id=\"__codelineno-5-7\" name=\"__codelineno-5-7\" href=\"#__codelineno-5-7\"></a>    facility).\n</span></code></pre></div>\n<p>\u548c Intel PT \u76f8\u6bd4\uff0c\u5b83\u8bb0\u5f55\u7684\u4fe1\u606f\u8f83\u5c11\uff0c\u4f46\u5b9e\u73b0\u4e0a\u4e5f\u66f4\u7b80\u5355\uff0c\u5f00\u9500\u66f4\u5c0f\u3002\u800c\u4e14 LBR \u53ea\u4f1a\u8bb0\u5f55\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u4e0d\u4f1a\u8bb0\u5f55\u6ca1\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u6b64\u5916\u5c31\u662f\u8bb0\u5f55\u7684\u5206\u652f\u6570\u6709\u4e0a\u9650\u3002</p>\n<h2 id=\"intel-bts\">Intel BTS<a class=\"headerlink\" href=\"#intel-bts\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8f83\u65e9\u7684 Intel \u5904\u7406\u5668\u6ca1\u6709\u5b9e\u73b0 Intel PT\uff0c\u4f46\u8003\u8651\u5230 LBR \u8bb0\u5f55\u7684\u5386\u53f2\u957f\u5ea6\u9650\u5236\uff0c\u57fa\u4e8e LBR \u505a\u4e86\u4e00\u4e2a\u628a LBR \u4fe1\u606f\u4fdd\u5b58\u5230\u5185\u5b58\u91cc\u7684\u6280\u672f\uff0c\u53eb\u505a Branch Trace Store\u3002perf \u4e5f\u652f\u6301<a href=\"https://github.com/torvalds/linux/blob/master/tools/perf/Documentation/intel-bts.txt\">\u57fa\u4e8e BTS</a> \u6765\u8bb0\u5f55\u5206\u652f\u5386\u53f2\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a><span class=\"c1\"># record</span>\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a>sudo<span class=\"w\"> </span>perf<span class=\"w\"> </span>record<span class=\"w\"> </span>--per-thread<span class=\"w\"> </span>-e<span class=\"w\"> </span>intel_bts//u<span class=\"w\"> </span>ls\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a><span class=\"c1\"># display trace</span>\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a>sudo<span class=\"w\"> </span>perf<span class=\"w\"> </span>script\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a><span class=\"c1\"># dump raw data</span>\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a>sudo<span class=\"w\"> </span>perf<span class=\"w\"> </span>script<span class=\"w\"> </span>-D\n</span></code></pre></div>\n<p>BTS \u6bcf\u4e2a entry \u5360\u7528 24 \u5b57\u8282\uff0c\u5305\u62ec 8 \u5b57\u8282\u7684 Last Branch From \u548c 8 \u5b57\u8282\u7684 Last Branch To\uff0c\u8fd8\u6709 8 \u5b57\u8282\u8bb0\u5f55\u4e86\u5206\u652f\u9884\u6d4b\u6b63\u786e\u8fd8\u662f\u9519\u8bef\uff08\u56fe\u6e90 <a href=\"https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html\">Intel\u00ae 64 and IA-32 Architectures Software Developer Manuals</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-perf-pmu-intel-bts.png\" /></p>\n<p>\u548c LBR \u4e00\u6837\uff0cBTS \u53ea\u8bb0\u5f55\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u4e0d\u8bb0\u5f55\u6ca1\u8df3\u8f6c\u7684\u5206\u652f\u3002</p>\n<h2 id=\"intel-pebs\">Intel PEBS<a class=\"headerlink\" href=\"#intel-pebs\" title=\"Permanent link\">&para;</a></h2>\n<p>Intel PEBS(Processor Event Based Sampling) \u662f\u4e00\u79cd\u786c\u4ef6\u7684\u91c7\u6837\u65b9\u6cd5\uff0c\u987e\u540d\u601d\u4e49\uff0c\u5f53\u5904\u7406\u5668\u89e6\u53d1\u67d0\u4e9b\u4e8b\u4ef6\u65f6\uff0c\u81ea\u52a8\u8fdb\u884c\u4e00\u6b21\u91c7\u6837\u3002\u8fd9\u4e2a\u4e8b\u4ef6\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u67d0\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\u6ea2\u51fa\u3002\u672c\u6765\uff0c\u6027\u80fd\u8ba1\u6570\u5668\u6ea2\u51fa\u7684\u65f6\u5019\uff0c\u5e94\u8be5\u89e6\u53d1\u4e2d\u65ad\uff0c\u8ba9\u5185\u6838\u7ef4\u62a4\u6027\u80fd\u8ba1\u6570\u5668\u7684\u771f\u5b9e\u503c\uff08\u4f8b\u5982\u786c\u4ef6\u5b9e\u73b0\u4e86 32 \u4f4d\u8ba1\u6570\u5668\uff0c\u4f46\u5185\u6838\u7ef4\u62a4\u7684\u662f 64 \u4f4d\uff09\uff1b\u4f46\u5728 PEBS \u4e2d\uff0c\u8fd9\u4e2a\u6027\u80fd\u8ba1\u6570\u5668\u7684\u6ea2\u51fa\u4e8b\u4ef6\u88ab\u7528\u6765\u89e6\u53d1\u786c\u4ef6\u7684\u91c7\u6837\uff1a\u8ba1\u6570\u6ea2\u51fa\u7684\u65f6\u5019\uff0c\u4f1a\u6355\u6349\u5f53\u524d\u7684\u5904\u7406\u5668\u72b6\u6001\uff08PC\u3001\u8bbf\u5b58\u5730\u5740\u548c\u5ef6\u8fdf\u3001\u901a\u7528\u5bc4\u5b58\u5668\u548c\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u503c\u3001\u65f6\u949f\u5468\u671f\u8ba1\u6570\u548c LBR \u4fe1\u606f\uff09\uff0c\u628a\u72b6\u6001\u5199\u5165\u5230\u5185\u5b58\u4e2d\u7684\u7f13\u51b2\u533a\uff0c\u5e76\u81ea\u52a8\u628a\u6027\u80fd\u8ba1\u6570\u5668\u8bbe\u4e3a\u6307\u5b9a\u7684\u590d\u4f4d\u503c\u3002\u5f53\u5185\u5b58\u4e2d\u7684\u7f13\u51b2\u533a\u6ee1\u7684\u65f6\u5019\uff0c\u624d\u4f1a\u89e6\u53d1\u4e2d\u65ad\uff0c\u8ba9\u5185\u6838\u6765\u5904\u7406 PEBS \u751f\u6210\u7684\u6570\u636e\uff0c\u5e76\u5206\u914d\u65b0\u7684\u7a7a\u95f4\u3002</p>\n<p>PEBS \u53ef\u4ee5\u7cbe\u7ec6\u5730\u6839\u636e\u6027\u80fd\u8ba1\u6570\u5668\u6765\u51b3\u5b9a\u91c7\u6837\u7684\u9891\u7387\uff0c\u4f8b\u5982\u6bcf 1000 \u6761\u6307\u4ee4\u91c7\u6837\u4e00\u6b21\uff0c\u6bcf 1000 \u4e2a\u5468\u671f\u91c7\u6837\u4e00\u6b21\uff0c\u751a\u81f3\u6bcf 1000 \u6b21\u7f13\u5b58\u7f3a\u5931\u91c7\u6837\u4e00\u6b21\u3002\u5177\u4f53\u505a\u6cd5\u662f\uff0c\u628a\u5bf9\u5e94\u7684\u6027\u80fd\u8ba1\u6570\u5668\u7684\u590d\u4f4d\u503c\u8bbe\u7f6e\u4e3a\u6700\u5927\u503c\u51cf 1000\uff0c\u90a3\u4e48\u6bcf\u6b21\u6ea2\u51fa\u89e6\u53d1 PEBS \u91c7\u6837\u4ee5\u540e\uff0c\u6027\u80fd\u8ba1\u6570\u5668\u4f1a\u88ab\u8bbe\u7f6e\u4e3a\u6700\u5927\u503c\u51cf 1000\uff0c\u7b49\u6027\u80fd\u8ba1\u6570\u5668\u589e\u52a0 1000 \u4ee5\u540e\uff0c\u518d\u6b21\u6ea2\u51fa\uff0c\u89e6\u53d1 PEBS \u91c7\u6837\uff0c\u5982\u6b64\u5faa\u73af\u3002</p>\n<p>AMD \u4e5f\u6709\u7c7b\u4f3c\u7684\u673a\u5236\uff0c\u53eb\u505a IBS(Instruction Based Sampling)\u3002IBS \u6ca1\u6709\u548c PMU \u7ed1\u5b9a\u8d77\u6765\uff0c\u800c\u662f\u6570\u6307\u4ee4\u6570\u6216\u6570\u5468\u671f\u3002\u63a8\u8350\u9605\u8bfb\u8bba\u6587 <a href=\"https://ieeexplore.ieee.org/document/10068807\">Precise Event Sampling on AMD Versus Intel: Quantitative and Qualitative Comparison</a>\uff0c\u5b83\u6df1\u5165\u6bd4\u8f83\u4e86 AMD IBS \u548c Intel PEBS \u7684\u5dee\u5f02\u3002</p>\n<p>\u5982\u679c\u8981\u542f\u7528 PEBS \u6216 IBS\uff0c\u5728 <code>perf record</code> \u6307\u4ee4\u4e8b\u4ef6\u65f6\uff0c\u8ffd\u52a0 <code>:p</code>\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a>The p modifier can be used for specifying how precise the instruction address should be. The p modifier can be specified\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a>multiple times:\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a>    0 - SAMPLE_IP can have arbitrary skid\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a>    1 - SAMPLE_IP must have constant skid\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a>    2 - SAMPLE_IP requested to have 0 skid\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a>    3 - SAMPLE_IP must have 0 skid, or uses randomization to avoid\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a>        sample shadowing effects.\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a>For Intel systems precise event sampling is implemented with PEBS which supports up to precise-level 2, and precise level 3 for some special cases.\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a>On AMD systems it is implemented using IBS OP (up to precise-level 2).\n</span></code></pre></div>\n<p>\u8be6\u7ec6\u4fe1\u606f\u89c1 <a href=\"https://man7.org/linux/man-pages/man1/perf-list.1.html\">perf-list(1) \u2014 Linux manual page</a>\u3002</p>\n<h2 id=\"arm-brbe\">ARM BRBE<a class=\"headerlink\" href=\"#arm-brbe\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u5e73\u53f0\u5b9a\u4e49\u4e86 BRBE(Branch Record Buffer Extension)\uff0c\u5b83\u548c Intel LBR \u7c7b\u4f3c\uff0c\u4e5f\u662f\u5728 System Register \u4e2d\u8bb0\u5f55\u6700\u8fd1\u82e5\u5e72\u6761\u8df3\u8f6c\u7684\u5206\u652f\u7684\u4fe1\u606f\u3002\u5b83\u4f1a\u8bb0\u5f55 taken branch \u7684\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<ol>\n<li>\u6e90\u5730\u5740</li>\n<li>\u76ee\u7684\u5730\u5740</li>\n<li>\u8ddd\u79bb\u4e0a\u4e00\u6b21 taken branch \u7684\u5468\u671f\u6570</li>\n<li>\u5206\u652f\u7c7b\u578b</li>\n<li>\u7279\u6743\u6001\uff08EL\uff09</li>\n<li>\u5206\u652f\u9884\u6d4b\u7ed3\u679c</li>\n</ol>\n<p>\u4e0d\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u5c31\u4e0d\u8bb0\u5f55\u3002\u548c LBR \u7c7b\u4f3c\uff0c\u5b83\u4e5f\u652f\u6301\u6839\u636e\u5206\u652f\u7c7b\u578b\u8fc7\u6ee4\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u7528\u4e8e call graph \u7684\u6293\u53d6\u3002</p>\n<h2 id=\"arm-spe\">ARM SPE<a class=\"headerlink\" href=\"#arm-spe\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u5e73\u53f0\u5b9a\u4e49\u4e86 SPE(Statistical Profiling Extension)\uff0c\u5b83\u7684\u505a\u6cd5\u662f\u57fa\u4e8e\u91c7\u6837\u7684\uff1a\u786c\u4ef6\u4e0a\u6bcf\u8fc7\u4e00\u6bb5\u65f6\u95f4\uff0c\u91c7\u6837\u4e00\u4e2a\u64cd\u4f5c\uff0c\u6bd4\u5982\u6b63\u5728\u6267\u884c\u7684\u6307\u4ee4\uff1b\u91c7\u6837\u5f97\u5230\u7684\u64cd\u4f5c\u7684\u8be6\u7ec6\u4fe1\u606f\u4f1a\u5199\u5165\u5230\u5185\u5b58\u5f53\u4e2d\uff0c\u7531\u5185\u6838\u9a71\u52a8\u51c6\u5907\u597d\u7684\u4e00\u6bb5\u7a7a\u95f4\u3002\u7a7a\u95f4\u6ee1\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u4e2d\u65ad\u901a\u77e5\u5185\u6838\u5e76\u8ba9\u5185\u6838\u91cd\u65b0\u5206\u914d\u7a7a\u95f4\u3002</p>\n<p><code>perf record</code> \u5728\u9ed8\u8ba4\u53c2\u6570\u4e0b\u7684\u5de5\u4f5c\u539f\u7406\u548c SPE \u6709\u70b9\u50cf\uff0c\u90fd\u662f\u5b9a\u65f6\u6253\u65ad\u7a0b\u5e8f\u5e76\u91c7\u6837\uff1a\u4f46 <code>perf record</code> \u662f\u5728\u7a0b\u5e8f\u88ab\u6253\u65ad\u540e\uff0c\u7531\u8f6f\u4ef6\u6765\u6536\u96c6\u4fe1\u606f\uff1b\u800c SPE \u662f\u7531\u786c\u4ef6\u91c7\u6837\uff0c\u53ef\u4ee5\u63d0\u4f9b\u66f4\u591a\u7684\u5fae\u67b6\u6784\u4fe1\u606f\uff08\u5ef6\u8fdf\uff0c\u8bbf\u5b58\u5730\u5740\uff0c\u662f\u5426\u547d\u4e2d TLB\uff0c\u5206\u652f\u8df3\u8f6c\u4e0e\u5426\u7b49\u7b49\uff09\u3002</p>\n<p>SPE \u7684\u5185\u6838\u9a71\u52a8\u5b9e\u73b0\u5728 <a href=\"https://github.com/torvalds/linux/blob/f92f4749861b06fed908d336b4dee1326003291b/drivers/perf/arm_spe_pmu.c#L754\">arm_spe_pmu.c</a> \u5f53\u4e2d\uff1b\u5b83\u505a\u7684\u4e8b\u60c5\u662f\uff0c\u5728\u5185\u5b58\u4e2d\u5206\u914d\u597d\u7f13\u51b2\u533a\uff0c\u542f\u52a8 SPE\uff0c\u5e76\u4e14\u5728 SPE \u89e6\u53d1\u4e2d\u65ad\u65f6\uff0c\u8fdb\u884c\u7f13\u51b2\u533a\u7684\u7ef4\u62a4\uff1b\u540c\u65f6\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\u4f1a\u901a\u8fc7 <a href=\"https://docs.kernel.org/userspace-api/perf_ring_buffer.html\">perf ring buffer (aka perf aux)</a> \u4f20\u9012\u7ed9\u7528\u6237\u6001\u7684\u7a0b\u5e8f\uff0c\u5177\u4f53\u6570\u636e\u7684\u89e3\u6790\u662f\u7531\u7528\u6237\u6001\u7684\u7a0b\u5e8f\u5b8c\u6210\u7684\u3002\u5982\u679c\u7528 perf \u5de5\u5177\uff0c\u90a3\u4e48\u8fd9\u4e2a\u89e3\u6790\u548c\u5c55\u793a\u7684\u5de5\u4f5c\u5c31\u662f\u7531 perf \u5b8c\u6210\u7684\u3002</p>\n<p>SPE \u548c AMD IBS \u7c7b\u4f3c\uff0c\u4e5f\u662f\u6570\u6307\u4ee4\u6570\uff1b\u548c Intel PEBS \u4e0d\u540c\uff0c\u5b83\u6ca1\u6709\u548c\u6027\u80fd\u8ba1\u6570\u5668\u8026\u5408\u8d77\u6765\u3002</p>\n<h2 id=\"arm-amu\">ARM AMU<a class=\"headerlink\" href=\"#arm-amu\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u9664\u4e86\u63d0\u4f9b\u6027\u80fd\u8ba1\u6570\u5355\u5143\uff08PMU\uff09\u4ee5\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86 AMU\uff08Activity Monitor Unit\uff09\u3002\u5b83\u548c PMU \u5f88\u7c7b\u4f3c\uff0c\u4e5f\u662f\u6709\u4e00\u4e9b\u6027\u80fd\u8ba1\u6570\u5668\uff0c\u4f46 AMU \u5728\u8ba1\u6570\u5668\u6ea2\u51fa\u7684\u65f6\u5019\u4e0d\u4f1a\u89e6\u53d1\u4e2d\u65ad\uff0c\u6240\u4ee5\u5b83\u5e76\u4e0d\u662f\u62ff\u6765\u89c2\u5bdf\u67d0\u4e2a\u7a0b\u5e8f\u7684\u6027\u80fd\u600e\u4e48\u6837\uff0c\u800c\u662f\u89c2\u5bdf\u7cfb\u7edf\u6574\u4f53\u7684\u72b6\u6001\uff0c\u6bd4\u5982\u65f6\u949f\u9891\u7387\uff0cIPC \u7b49\u7b49\u3002</p>\n<p>\u76ee\u524d AMU \u7684\u4e3b\u8981\u7528\u9014\u662f\u5728\u5185\u6838\u7684\u8c03\u5ea6\u5668\u4e0a\uff1a\u8c03\u5ea6\u5668\u9700\u8981\u4f30\u8ba1\u4e00\u6bb5\u65f6\u95f4\u5185\u505a\u4e86\u591a\u5c11\u5355\u4f4d\u7684\u4efb\u52a1\uff0c\u9700\u8981\u77e5\u9053 CPU \u7684\u9891\u7387\uff0c\u6bd4\u5982\u9891\u7387\u9ad8\uff0c\u5c31\u8ba4\u4e3a\u5b83\u505a\u4e86\u66f4\u591a\u7684\u4efb\u52a1\u3002\u4e4b\u524d\u7684\u505a\u6cd5\u662f\u8ba9\u8c03\u5ea6\u5668\u901a\u8fc7 cpufreq \u8bfb\u53d6\u5f53\u524d\u7684 CPU \u9891\u7387\uff0c\u4f46\u7531\u4e8e CPU \u7684\u9891\u7387\u4f1a\u4e0d\u65ad\u53d8\u5316\uff0c\u8fd9\u6837\u8bfb\u53d6\u5230\u7684\u9891\u7387\u662f\u4e00\u4e2a\u77ac\u65f6\u529f\u7387\uff0c\u4e0d\u80fd\u4ee3\u8868\u4e00\u6bb5\u65f6\u95f4\u7684\u5e73\u5747\u503c\uff0c\u5c31\u4f1a\u5e26\u6765\u8bef\u5dee\u3002</p>\n<p>\u4e3a\u4e86\u83b7\u53d6\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u5e73\u5747\u9891\u7387\uff0c<a href=\"https://github.com/torvalds/linux/blob/f92f4749861b06fed908d336b4dee1326003291b/arch/arm64/kernel/topology.c#L153\">amu_scale_freq_tick</a> \u51fd\u6570\u5c31\u4f7f\u7528\u4e86 AMU \u7684\u4e24\u4e2a\u8ba1\u6570\u5668\uff1a</p>\n<ol>\n<li>Processor Cycle \u8ba1\u6570\u5668\uff1a\u8bb0\u5f55\u6838\u5fc3\u7684\u5468\u671f\u6570\uff0c\u4e5f\u5c31\u662f\u4ee5 CPU \u9891\u7387\u81ea\u589e\u7684\u8ba1\u6570\u5668</li>\n<li>Constant Cycle \u8ba1\u6570\u5668\uff1a\u4ee5\u56fa\u5b9a\u9891\u7387\uff08\u800c\u975e CPU \u9891\u7387\uff09\u81ea\u589e\u7684\u8ba1\u6570\u5668</li>\n</ol>\n<p>\u901a\u8fc7\u8bb0\u5f55\u4e00\u6bb5\u65f6\u95f4\u5185\u4e24\u4e2a\u8ba1\u6570\u5668\u7684\u53d8\u5316\u91cf\uff0c\u5c06\u4e24\u4e2a\u53d8\u5316\u91cf\u505a\u9664\u6cd5\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u6b63\u6bd4\u4e8e\u8fd9\u6bb5\u65f6\u95f4\u5185 CPU \u7684\u5e73\u5747\u9891\u7387\u7684\u503c\uff0c\u4ea4\u7ed9\u8c03\u5ea6\u5668\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://developer.arm.com/documentation/ddi0487/latest/\">Arm Architecture Reference Manual for A-profile architecture</a></li>\n<li><a href=\"https://loongson.github.io/LoongArch-Documentation/LoongArch-Vol1-EN.html\">LoongArch Reference Manual Volume 1: Basic Architecture</a></li>\n<li><a href=\"https://perfwiki.github.io/main/\">perf: Linux profiling with performance counters</a></li>\n<li><a href=\"https://perfwiki.github.io/main/perf-tools-support-for-intel-processor-trace/\">Perf tools support for Intel\u00ae Processor Trace</a></li>\n<li><a href=\"https://ieeexplore.ieee.org/document/10068807\">Precise Event Sampling on AMD Versus Intel: Quantitative and Qualitative Comparison</a></li>\n</ul>", "image": null, "date_modified": "2024-12-10T00:00:00+00:00", "authors": [], "tags": ["aarch64", "arm", "linux", "perf", "pmu", "software"]}, {"id": "https://jia.je/hardware/2024/11/11/amd_zen5/", "url": "https://jia.je/hardware/2024/11/11/amd_zen5/", "title": "AMD Zen 5 \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"amd-zen-5-\u5fae\u67b6\u6784\u8bc4\u6d4b\">AMD Zen 5 \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#amd-zen-5-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>Zen 5 \u662f AMD \u6700\u65b0\u7684\u4e00\u4ee3\u5fae\u67b6\u6784\uff0c\u5728\u5f88\u591a\u5730\u65b9\u548c\u4e4b\u524d\u4e0d\u540c\uff0c\u56e0\u6b64\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD \u4e00\u5411\u516c\u5f00\u5f97\u6bd4\u8f83\u5927\u65b9\uff0c\u5173\u4e8e Zen 5 \u7684\u4fe1\u606f\u6709\uff1a</p>\n<ul>\n<li><a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/58455.zip\">Software Optimization Guide for the AMD Zen5 Microarchitecture</a></li>\n<li><a href=\"https://www.amd.com/content/dam/amd/en/documents/epyc-business-docs/white-papers/5th-gen-amd-epyc-processor-architecture-white-paper.pdf\">5TH GEN AMD EPYC\u2122 PROCESSOR ARCHITECTURE</a></li>\n</ul>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Zen 5 \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://www.phoronix.com/review/amd-zen-5-core\">AMD Reveals More Zen 5 CPU Core Details</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/07/26/zen-5s-2-ahead-branch-predictor-unit-how-30-year-old-idea-allows-for-new-tricks/\">Zen 5\u2019s 2-Ahead Branch Predictor Unit: How a 30 Year Old Idea Allows for New Tricks</a></li>\n<li><a href=\"https://chipsandcheese.com/2023/10/08/zen-5s-leaked-slides/\">Zen 5\u2019s Leaked Slides</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/08/10/amds-strix-point-zen-5-hits-mobile/\">AMD\u2019s Strix Point: Zen 5 Hits Mobile</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/08/14/amds-ryzen-9950x-zen-5-on-desktop/\">AMD\u2019s Ryzen 9950X: Zen 5 on Desktop</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/09/15/discussing-amds-zen-5-at-hot-chips-2024/\">Discussing AMD\u2019s Zen 5 at Hot Chips 2024</a></li>\n<li><a href=\"https://blog.hjc.im/zen-5-more-details-1.html\">Zen 5 \u8865\u5145\u6d4b\u8bd5 (1/2): \u66f4\u591a\u5fae\u67b6\u6784\u7ec6\u8282</a></li>\n<li><a href=\"http://www.numberworld.org/blogs/2024_8_7_zen5_avx512_teardown/\">Zen5's AVX512 Teardown + More...</a></li>\n<li><a href=\"https://chipsandcheese.com/p/disabling-zen-5s-op-cache-and-exploring\">Disabling Zen 5\u2019s Op Cache and Exploring its Clustered Decoder</a></li>\n<li><a href=\"https://chipsandcheese.com/p/zen-5s-avx-512-frequency-behavior\">Zen 5's AVX-512 Frequency Behavior</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>AMD Zen 5 \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"mop-vs-uop\">MOP vs uOP<a class=\"headerlink\" href=\"#mop-vs-uop\" title=\"Permanent link\">&para;</a></h2>\n<p>MOP = Macro operation, uOP = Micro operation</p>\n<p>AMD \u7684\u6587\u6863\u91cc\u662f\u8fd9\u4e48\u8bf4\u7684\uff1a</p>\n<blockquote>\n<p>The processor implements AMD64 instruction set by means of macro-ops (the primary units of\nwork managed by the processor) and micro-ops (the primitive operations executed in the\nprocessor's execution units).\nInstructions are marked as fast path single (one macro-op), fast path double (two macro-ops), or\nmicrocode (greater than two macro-ops). Macro ops can normally contain up to two micro-ops.</p>\n</blockquote>\n<p>\u4e00\u6761\u6307\u4ee4\u53ef\u4ee5\u5206\u6210\u82e5\u5e72\u4e2a MOP\uff08\u6bd4\u5982 REP MOVS \u4f1a\u62c6\u6210\u5f88\u591a\u4e2a MOP\uff09\uff0c\u4e00\u4e2a MOP \u53ef\u4ee5\u7ee7\u7eed\u7ec6\u5206\u4e3a uOP\uff08\u6bd4\u5982 store \u62c6\u5206\u6210 store data \u548c store address\uff1b\u628a\u5185\u5b58\u7684\u503c\u52a0\u5230\u5bc4\u5b58\u5668\u4e0a\u7684 add \u6307\u4ee4\u62c6\u5206\u6210 load \u548c add\uff09\u3002Dispatch \u7684\u5355\u4f4d\u662f MOP\uff0cROB \u4fdd\u5b58\u7684\u4e5f\u662f MOP\u3002\u4e0e Zen3/Zen4 \u4e0d\u540c\uff0cOp Cache \u4fdd\u5b58\u7684\u4e0d\u662f MOP\uff0c\u800c\u662f Fused Instructions\uff0c\u8fd9\u4e2a Fusion \u6765\u81ea\u4e8e Branch Fusion \u6216 MOV + ALU Fusion\u3002Fusion \u76f8\u5f53\u4e8e\u628a\u591a\u6761\u6307\u4ee4\u5408\u6210\u4e86\u4e00\u4e2a\uff0c\u51cf\u5c11\u4e86 MOP \u7684\u6570\u91cf\u3002</p>\n<p>MOP \u5230 uOP \u7684\u62c6\u5206\u9700\u8981\u7b49\u5230 Scheduler \u4e2d\u624d\u8fdb\u884c\uff0cScheduler \u8f93\u5165 MOP\uff0c\u8f93\u51fa uOP\uff0c\u4e5f\u5c31\u662f\u8bf4\u6700\u7ec8\u7ed9\u5230\u6267\u884c\u5355\u5143\u7684\u662f uOP\u3002</p>\n<p>\u548c ARM \u516c\u7248\u6838\u7684 MOP/uOP \u5bf9\u6bd4\uff0c\u5176\u5b9e\u662f\u5f88\u7c7b\u4f3c\u7684\uff1auOP \u662f\u6267\u884c\u5355\u5143\u770b\u5230\u7684\u6307\u4ee4\u7c92\u5ea6\uff0cMOP \u662f\u7ef4\u62a4\u7cbe\u786e\u5f02\u5e38\u7684\u6307\u4ee4\u7c92\u5ea6\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"op-cache\">Op Cache<a class=\"headerlink\" href=\"#op-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a64 set, 16 way, <strong>1024 entry</strong>, <strong>6 (fused) inst/entry</strong>, \u4f9b\u6307 <strong>2 entry/cycle</strong></p>\n<h4 id=\"\u5f00\u542f\u5173\u95ed\">\u5f00\u542f/\u5173\u95ed<a class=\"headerlink\" href=\"#\u5f00\u542f\u5173\u95ed\" title=\"Permanent link\">&para;</a></h4>\n<p>AMD \u5728 UEFI \u56fa\u4ef6\u4e2d\u63d0\u4f9b\u4e86\u5173\u95ed Op Cache \u7684\u8bbe\u7f6e\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u6d4b\u8bd5\u5728 Op Cache \u5f00\u542f/\u5173\u95ed\u4e0d\u540c\u60c5\u51b5\u4e0b\u7684\u6027\u80fd\u3002\u901a\u8fc7\u8fdb\u4e00\u6b65\u7814\u7a76\uff0c\u53d1\u73b0\u56fa\u4ef6\u7684 Op Cache \u5173\u95ed\u8bbe\u7f6e\uff0c\u5b9e\u9645\u4e0a\u5bf9\u5e94\u4e86 MSR[0xc0011021] \u7684 bit 5\uff1a\u521d\u59cb\u60c5\u51b5\u4e0b\uff0cMSR[0xc0011021] \u7684\u503c\u4e3a 0x20000000000040\uff0c\u5982\u679c\u8fdb\u5165\u56fa\u4ef6\u5173\u95ed Op Cache\uff0c\u53ef\u4ee5\u89c2\u5bdf\u5230 MSR[0xc0011021] \u53d8\u6210\u4e86 0x20000000000060\u3002\u5b9e\u9645\u4e0a\uff0cOp Cache \u53ef\u4ee5\u5728\u8fdb\u5165 Linux \u540e\u52a8\u6001\u5f00\u542f/\u5173\u95ed\uff08\u611f\u8c22 David Huang \u5728\u535a\u5ba2\u4e2d\u63d0\u4f9b\u7684\u4fe1\u606f\uff09\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>sudo<span class=\"w\"> </span>modprobe<span class=\"w\"> </span>msr\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"c1\"># Disable Op Cache for Core 0</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>sudo<span class=\"w\"> </span>wrmsr<span class=\"w\"> </span>-p<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>0xc0011021<span class=\"w\"> </span>0x20000000000060\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"c1\"># Enable Op Cache for Core 0</span>\n</span><span id=\"__span-0-5\"><a id=\"__codelineno-0-5\" name=\"__codelineno-0-5\" href=\"#__codelineno-0-5\"></a>sudo<span class=\"w\"> </span>wrmsr<span class=\"w\"> </span>-p<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>0xc0011021<span class=\"w\"> </span>0x20000000000040\n</span></code></pre></div>\n<p>\u56e0\u6b64\u5f00\u5173 Op Cache \u4e0d\u9700\u8981\u91cd\u542f\u8fdb\u56fa\u4ef6\u4e86\u3002</p>\n<h4 id=\"\u5bb9\u91cf\">\u5bb9\u91cf<a class=\"headerlink\" href=\"#\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>Zen 5 \u7684 Op Cache \u6bcf\u4e2a entry \u662f 6 (fused) inst\uff0c\u4e3a\u4e86\u6d4b\u51fa Op Cache \u7684\u5bb9\u91cf\uff0c\u4ee5\u53ca\u786e\u8ba4\u4fdd\u5b58\u7684\u662f fused inst\uff0c\u5229\u7528 MOV + ALU Fusion \u6765\u6784\u9020\u6307\u4ee4\u5e8f\u5217\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"c1\"># rsi = rdi</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"c1\"># rsi += rdx</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"nv\">%rdx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span></code></pre></div>\n<p>\u8fd9\u4e24\u6761\u6307\u4ee4\u6ee1\u8db3 Zen 5 \u7684 MOV + ALU Fusion \u8981\u6c42\uff0c\u786c\u4ef6\u4e0a\u878d\u5408\u6210\u4e00\u4e2a <code>rsi = rdx + rdi</code> \u7684\u64cd\u4f5c\u3002\u505a\u8fd9\u4e2a\u878d\u5408\u4e5f\u662f\u56e0\u4e3a x86 \u6307\u4ee4\u96c6\u7f3a\u5c11 3 \u5730\u5740\u6307\u4ee4\uff0c\u5f53\u7136\u672a\u6765 APX \u4f1a\u8865\u4e0a\u8fd9\u4e2a\u7f3a\u5931\u3002\u5b9e\u6d4b\u53d1\u73b0\uff0c\u8fd9\u6837\u7684\u6307\u4ee4\u5e8f\u5217\u53ef\u4ee5\u8fbe\u5230 12 \u7684 IPC\uff0c\u6b63\u597d Zen 5 \u7684 ALU \u6709 6 \u4e2a\uff0c\u4e5f\u5c31\u662f\u6bcf\u5468\u671f\u6267\u884c 6 \u6761\u878d\u5408\u540e\u7684\u6307\u4ee4\uff0c\u548c 12 IPC \u662f\u543b\u5408\u7684\u300212 \u7684 IPC \u53ef\u4ee5\u4e00\u76f4\u7ef4\u6301\u5230 36KB \u7684 footprint\uff0c\u8fd9\u91cc\u7684 mov \u548c add \u6307\u4ee4\u90fd\u662f 3 \u5b57\u8282\uff0c\u6362\u7b97\u4e0b\u6765 36KB \u5bf9\u5e94 <code>36*1024/6=6144</code> \u4e2a fused instruction\uff0c\u6b63\u597d <code>64*16*6=6144</code>\uff0c\u5bf9\u4e0a\u4e86\u3002\u5173\u6389 Op Cache \u540e\uff0c\u6027\u80fd\u4e0b\u964d\u5230 4 IPC\uff0c\u5bf9\u5e94\u4e86 Decode \u5bbd\u5ea6\uff0c\u540c\u65f6\u4e5f\u8bf4\u660e Decode \u7684 4 Wide \u5bf9\u5e94\u7684\u662f\u6307\u4ee4\uff0c\u800c\u4e0d\u662f\u878d\u5408\u540e\u7684\u6307\u4ee4\u3002</p>\n<h4 id=\"\u541e\u5410\">\u541e\u5410<a class=\"headerlink\" href=\"#\u541e\u5410\" title=\"Permanent link\">&para;</a></h4>\n<p>\u63a5\u4e0b\u6765\u8981\u6d4b\u8bd5 Op Cache \u80fd\u5426\u5355\u5468\u671f\u7ed9\u5355\u4e2a\u7ebf\u7a0b\u63d0\u4f9b 2 \u4e2a entry \u7684\u541e\u5410\u3002\u7531\u4e8e\u6bcf\u4e2a entry \u6700\u591a\u53ef\u4ee5\u6709 6 (fused) inst\uff0c\u52a0\u8d77\u6765\u662f 12\uff0c\u800c dispatch \u53ea\u6709 8 MOP/cycle\uff0c\u56e0\u6b64\u9000\u800c\u6c42\u5176\u6b21\uff0c\u4e0d\u8981\u6c42\u7528\u5b8c entry \u7684 6 \u6761\u6307\u4ee4\uff0c\u800c\u662f\u7528 jmp \u6307\u4ee4\u6765\u63d0\u524d\u7ed3\u675f entry\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"c1\"># rsi = rdi</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"nf\">jmp</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"no\">f</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"err\">2:</span>\n</span></code></pre></div>\n<p>\u91cd\u590d\u4e0a\u8ff0\u6307\u4ee4\uff0c\u53d1\u73b0\u5728 5KB \u4e4b\u524d\u90fd\u53ef\u4ee5\u8fbe\u5230 4 \u7684 IPC\uff0c\u4e4b\u540e\u5219\u4e0b\u964d\u5230 2 IPC\uff0c\u8bf4\u660e 5KB \u65f6\u7528\u6ee1\u4e86 Op Cache\u3002\u8fd9\u91cc\u7684 mov \u6307\u4ee4\u662f 3 \u5b57\u8282\uff0cjmp \u6307\u4ee4\u662f 2 \u5b57\u8282\uff0c\u4e5f\u5c31\u662f\u8bf4 5KB \u5bf9\u5e94\u4e0a\u8ff0\u6307\u4ee4\u6a21\u5f0f\u91cd\u590d\u4e86 1024 \u6b21\uff0c\u6b64\u65f6 Op Cache \u7528\u6ee1\u4e86\u5bb9\u91cf\uff0c\u6b63\u597d Op Cache \u4e5f\u662f <code>64*16=1024</code> \u4e2a entry\uff0c\u5370\u8bc1\u4e86 Op Cache \u7684 entry \u4f1a\u88ab jmp \u63d0\u524d\u7ed3\u675f\uff0c\u5728\u4e0a\u8ff0\u7684\u6307\u4ee4\u6a21\u5f0f\u4e0b\uff0centry \u4e0d\u4f1a\u8de8\u8d8a jmp \u6307\u4ee4\u8bb0\u5f55\u540e\u9762\u7684\u6307\u4ee4\uff0c\u6bcf\u4e2a entry \u53ea\u6709\u4e24\u6761\u6307\u4ee4\u3002\u90a3\u4e48 4 IPC \u8bc1\u660e\u4e86 Op Cache \u53ef\u4ee5\u6bcf\u5468\u671f\u63d0\u4f9b 2 entry\uff0c\u76f8\u6bd4 Decode \u53ea\u80fd\u6bcf\u5468\u671f\u7ed9\u5355\u7ebf\u7a0b\u63d0\u4f9b 4 \u6761\u6307\u4ee4\u660e\u663e\u8981\u5feb\u3002</p>\n<h3 id=\"\u53d6\u6307\">\u53d6\u6307<a class=\"headerlink\" href=\"#\u53d6\u6307\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6bcf\u5468\u671f\u5171 64B\uff0c\u53ef\u4ee5\u53d6<strong>\u4e24\u4e2a</strong> 32B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u53d6\u6307\uff0c\u9700\u8981\u5173\u6389 Op Cache\uff0c\u4f46\u7531\u4e8e Decode \u74f6\u9888\u592a\u660e\u663e\uff0c\u4e0d\u5bb9\u6613\u6d4b\u51fa\u53d6\u6307\u7684\u6027\u80fd\uff0c\u4f8b\u5982\u662f\u5426\u4e00\u4e2a\u5468\u671f\u53ef\u4ee5\u7ed9\u5355\u7ebf\u7a0b\u53d6\u4e24\u4e2a 32B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757\u3002\u76ee\u524d\u901a\u8fc7\u5b9e\u6d4b\u53ef\u4ee5\u77e5\u9053\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\uff0c\u6d4b\u8bd5\u5faa\u73af\u4f53\u8de8\u8d8a 64B \u7f13\u5b58\u884c\u8fb9\u754c\u7684\u60c5\u51b5\uff0c\u6307\u4ee4\u6a21\u5f0f\u89c1\u4e0b\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"nf\">dec</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"c1\"># 64B cache line boundary here</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">b</span>\n</span></code></pre></div>\n<p>\u5faa\u73af\u4e00\u6b21\u9700\u8981 1.5 \u4e2a\u5468\u671f\u3002\u5982\u679c Fetch \u6bcf\u5468\u671f\u53ea\u80fd\u53d6\u4e00\u4e2a 32B/64B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u9700\u8981 2 \u4e2a\u5468\u671f\u6765\u53d6\u6307\uff0c\u4f46\u5982\u679c Fetch \u6bcf\u5468\u671f\u53ef\u4ee5\u53d6\u4e24\u4e2a 32B \u5bf9\u9f50\u7684\u6307\u4ee4\u5757\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u53ea\u9700\u8981 1 \u4e2a\u5468\u671f\u53d6\u6307\uff0c\u4f46\u5b9e\u9645\u6d4b\u51fa\u6765\u53c8\u662f 1.5 \u4e2a\u5468\u671f\uff0c\u76ee\u524d\u8fd8\u6ca1\u6709\u627e\u5230\u5408\u7406\u7684\u89e3\u91ca\uff0c\u4f46\u5927\u6982\u7387 Fetch \u8fd8\u662f\u53ef\u4ee5\u7ed9\u5355\u7ebf\u7a0b\u6bcf\u5468\u671f\u63d0\u4f9b\u4e24\u4e2a 32B \u6307\u4ee4\u5757\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a2x <strong>4-wide</strong> decode pipeline, <strong>one pipeline per thread</strong></p>\n<p>AMD Zen 5 \u7684 Decode \u867d\u7136\u6709\u4e24\u4e2a Pipe\uff0c\u4f46\u662f\u6bcf\u4e2a\u903b\u8f91\u7ebf\u7a0b\u53ea\u80fd\u7528\u4e00\u4e2a\uff0c\u610f\u5473\u7740\u5355\u7ebf\u7a0b\u60c5\u51b5\u4e0b\uff0c\u65e0\u6cd5\u505a\u5230 8-wide Decode\uff0c\u800c 4-wide Decode \u53c8\u592a\u7a84\u4e86\u70b9\uff0c\u56e0\u6b64 Op Cache \u7684\u547d\u4e2d\u7387\u5c31\u663e\u5f97\u5f88\u91cd\u8981\u3002</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 Decode\uff0c\u9700\u8981\u9996\u5148\u6309\u7167\u4e0a\u9762\u7684\u65b9\u6cd5\u5173\u95ed Op Cache\uff0c\u7136\u540e\u6784\u9020\u4e0d\u540c\u7684\u6307\u4ee4\u5e8f\u5217\u4ee5\u89c2\u5bdf IPC\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<ul>\n<li>\u91cd\u590d 1-4 \u5b57\u8282 nop\uff1a4 IPC</li>\n<li>\u91cd\u590d 5 \u5b57\u8282 nop\uff1a3.2 IPC</li>\n<li>\u91cd\u590d 6 \u5b57\u8282 nop\uff1a2.67 IPC</li>\n<li>\u91cd\u590d 7 \u5b57\u8282 nop\uff1a2.3 IPC</li>\n<li>\u91cd\u590d 8 \u5b57\u8282 nop\uff1a2 IPC</li>\n<li>\u91cd\u590d 9 \u5b57\u8282 nop\uff1a1.78 IPC</li>\n<li>\u91cd\u590d 10 \u5b57\u8282 nop\uff1a1.6 IPC</li>\n<li>\u91cd\u590d 11-15 \u5b57\u8282 nop\uff1a1 IPC</li>\n</ul>\n<p>\u4e0a\u8ff0 nop \u7684\u7f16\u7801\u53d6\u81ea Software Optimization Guide \u7684 Encodings for NOP Instructions 1 to 15 \u8868\u683c\u3002</p>\n<p>\u9996\u5148\u53ef\u4ee5\u770b\u5230 Zen5 4-wide Decode \u7684\u9650\u5236\uff0c\u5176\u6b21\u53ef\u4ee5\u53d1\u73b0\u91cd\u590d 5-10 \u5b57\u8282\u7684 nop\uff0c\u6bcf\u5468\u671f\u7684 Decode \u541e\u5410\u90fd\u662f 16B\u300211 \u5b57\u8282\u4ee5\u4e0a\u5219\u662f\u649e\u5230\u4e86 Decode \u7684\u9650\u5236\uff1a<code>Only the first decode slot (of four) can decode instructions greater than 10 bytes in length</code>\u3002</p>\n<p>\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f\u8fd9\u4e2a 16B \u7684\u9650\u5236\uff0c\u8003\u8651\u79fb\u52a8\u7a97\u53e3\u7684\u8bd1\u7801\u8bbe\u8ba1\uff0c\u6bcf\u5468\u671f\u53ef\u4ee5\u5bf9\u4e24\u4e2a\u8fde\u7eed 16B \u7684\u7a97\u53e3\u8bd1\u7801\uff08<code>IBQ entries hold 16 byte-aligned fetch windows of the instruction byte stream. The decode pipes each scan two IBQ entries.</code>\uff09\uff0c\u5728 5 \u5b57\u8282\u7684 nop \u6a21\u5f0f\u4e0b\uff0c\u6bcf\u4e2a\u5468\u671f\u7684 Decode \u5e94\u8be5\u662f\uff1a</p>\n<ul>\n<li>Cycle 0: Window 0-31, Decode 0, 5, 10, 15</li>\n<li>Cycle 1: Window 16-47, Decode 20, 25, 30, 35</li>\n<li>Cycle 2: Window 32-63, Decode 40, 45, 50, 55</li>\n<li>Cycle 3: Window 48-79, Decode 60, 65, 70, 75</li>\n<li>Cycle 4: Window 80-111, Decode 80, 85, 90, 95</li>\n</ul>\n<p>\u6309\u8fd9\u4e2a\u7406\u60f3\u7684\u65b9\u6cd5\u6765\u770b\uff0c\u5e94\u8be5\u53ef\u4ee5\u505a\u5230 4 \u7684 IPC\uff0c\u4f46\u5b9e\u9645\u4e0a\u6ca1\u6709\u3002\u4e00\u4e2a\u731c\u6d4b\u662f\uff0c\u6ed1\u52a8\u7a97\u53e3\u6bcf\u6b21\u53ea\u80fd\u79fb\u52a8 1 \u4e2a 16B\uff0c\u800c\u4e0d\u80fd\u4ece 48 \u8df3\u5230 80\uff0c\u90a3\u4e48\u4ece Cycle 4 \u5f00\u59cb\u4f1a\u51fa\u73b0\u6027\u80fd\u635f\u5931\uff1a</p>\n<ul>\n<li>Cycle 4: Window 64-95, Decode 80, 85, 90</li>\n<li>Cycle 5: Window 80-111, Decode 95, 100, 105</li>\n<li>Cycle 6: Window 96-127, Decode 110, 115, 120</li>\n<li>Cycle 7: Window 112-143, Decode 125, 130, 135</li>\n<li>Cycle 8: Window 128-159, Decode 140, 145, 150, 155</li>\n</ul>\n<p>\u8fd9\u4e2a\u89c4\u5f8b\u5ef6\u7eed\u4e0b\u53bb\uff0c\u5e73\u5747\u4e0b\u6765\u5c31\u662f 3.2 IPC\u3002</p>\n<p>\u6839\u636e\u8fd9\u4e2a\u731c\u60f3\uff0cDecode \u4ece\u4e24\u4e2a\u8fde\u7eed\u7684 IBQ entry \u8bd1\u7801\u6700\u591a\u56db\u6761\u6307\u4ee4\uff0c\u662f\u6ca1\u6709 16B \u7684\u9650\u5236\u7684\uff0c\u4f46 IBQ \u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6bcf\u5468\u671f\u53ea\u80fd\u5f39\u51fa\u4e00\u4e2a entry\uff0c\u800c\u4e0d\u80fd\u6bcf\u5468\u671f\u5f39\u51fa\u4e24\u4e2a\uff0c\u8fd9\u624d\u5bfc\u81f4\u4e86 16B \u7684\u541e\u5410\u3002\u603b\u4e4b\uff0c4-wide \u4ee5\u53ca 16B \u7684\u9650\u5236\uff0c\u5e94\u8be5\u8bf4\u662f\u5f88\u5c0f\u7684\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>32KB</strong>, 8-way set associative</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u7684\u5bb9\u91cf\uff0c\u9700\u8981\u5173\u95ed Op Cache\uff0c\u4f46\u7531\u4e8e Decode \u7684\u9650\u5236\uff0c\u5373\u4f7f footprint \u5927\u4e8e L1 ICache \u5bb9\u91cf\uff0cIPC \u4f9d\u7136\u6ca1\u6709\u53d8\u5316\uff0c\u9488\u5bf9\u8fd9\u4e2a\u73b0\u8c61\uff0c\u731c\u6d4b L1 ICache \u7684\u9884\u53d6\u5728\u8d77\u4f5c\u7528\uff0c\u5e76\u4e14 L2 Cache \u5230 L1 ICache \u7684 Refill \u5e26\u5bbd\u4e0d\u5c0f\u4e8e Decode \u5e26\u5bbd\uff0c\u5bfc\u81f4\u74f6\u9888\u5728 Decode\u3002</p>\n<p>\u56e0\u6b64\uff0c\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u7684\u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a jmp \u5e8f\u5217\uff0c\u4ee5 4B \u4f4d\u95f4\u8ddd\u6392\u5e03\uff0c\u89c2\u5bdf\u5230\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\uff0c\u5728 8192 \u6761 jmp \u6307\u4ee4\u4e4b\u524d\u53ef\u4ee5\u505a\u5230 1 CPI\uff0c\u4e4b\u540e\u9010\u6e10\u63d0\u5347\u5230 1.5 CPI\uff0c\u6b63\u597d 8192 \u5bf9\u5e94\u4e86 <code>8192*4=32768</code> \u4e5f\u5c31\u662f 32KB L1 ICache \u7684\u5bb9\u91cf\u9650\u5236\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>64-entry</strong>, fully associative</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ITLB \u7684\u5bb9\u91cf\uff0c\u6784\u9020 jmp \u5e8f\u5217\uff0c\u6bcf\u4e2a jmp \u5728\u4e00\u4e2a\u5355\u72ec\u7684\u9875\u4e2d\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\u89c2\u5bdf jmp \u7684\u6027\u80fd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u660e\u663e\u7684 64 pages \u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u4e86 64 entry \u7684 L1 ITLB\u3002</p>\n<h3 id=\"l2-itlb\">L2 ITLB<a class=\"headerlink\" href=\"#l2-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>2048-entry</strong>, 8-way set associative L2 ITLB</p>\n<p>\u7ee7\u7eed\u6cbf\u7528\u6d4b\u8bd5 L1 ITLB \u7684\u65b9\u5f0f\uff0c\u628a\u9875\u7684\u6570\u91cf\u63d0\u9ad8\u5230 2000+\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\u5f97\u5230\u4ee5\u4e0b\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_l2itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u660e\u663e\u7684 2048 pages \u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u4e86 2048 entry \u7684 L2 ITLB\u3002</p>\n<h3 id=\"btb\">BTB<a class=\"headerlink\" href=\"#btb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a16K-entry L1 BTB, 8K-entry L2 BTB</p>\n<p>\u56e0\u4e3a L1 ICache \u53ea\u6709 32KB\uff0c\u800c L1 BTB \u6709 16K entry\uff0c\u6bcf\u4e2a entry \u6700\u591a\u80fd\u4fdd\u5b58\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u56e0\u6b64\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u9996\u5148\u9047\u5230\u7684\u662f L1 ICache \u7684\u74f6\u9888\uff0c\u800c\u4e0d\u662f L1 BTB \u7684\u74f6\u9888\u3002</p>\n<h3 id=\"return-address-stack\">Return Address Stack<a class=\"headerlink\" href=\"#return-address-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>52-entry</strong> per thread</p>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u65f6\u95f4\uff0c\u5728\u5173\u95ed Op Cache \u7684\u60c5\u51b5\u4e0b\u5f97\u5230\u5982\u4e0b\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_ras.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 52 \u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f Return Address Stack \u7684\u5927\u5c0f\u3002</p>\n<h3 id=\"indirect-target-predictor\">Indirect Target Predictor<a class=\"headerlink\" href=\"#indirect-target-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a3072-entry Indirect Target Array</p>\n<h3 id=\"move-elimination-zero-cycle-move-and-zeroingones-idiom\">Move Elimination (Zero Cycle Move) and Zeroing/Ones Idiom<a class=\"headerlink\" href=\"#move-elimination-zero-cycle-move-and-zeroingones-idiom\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u652f\u6301 xor/sub/cmp/sbb/vxorp/vandnp/vpcmpgt/vpandn/vpxor/vpsub \u7684 Zeroing Idiom\uff0c\u652f\u6301 pcmpeq/vpcmpeq \u7684 Ones Idiom\uff0c\u652f\u6301 mov/movsxd/xchg/(v)vmovap/(v)movdp/(v)movup \u7684 Zero Cycle Move\u3002</p>\n<p>\u5b9e\u6d4b\u4e0b\u6765\uff0c\u4ee5\u4e0b\u6307\u4ee4\u5e8f\u5217\u7684 IPC \u4e3a\uff1a</p>\n<ul>\n<li>\u6709\u4f9d\u8d56\u94fe\u7684 mov r, r\uff1a7 IPC</li>\n<li>\u6ca1\u6709\u4f9d\u8d56\u7684 mov r, r\uff1a7 IPC</li>\n<li>xor r, r, r\uff1a7 IPC</li>\n<li>sub r, r, r\uff1a7 IPC</li>\n<li>\u6709\u4f9d\u8d56\u94fe\u7684 mov vr, vr\uff1a6 IPC</li>\n<li>\u6ca1\u6709\u4f9d\u8d56\u7684 mov vr, vr\uff1a6 IPC</li>\n<li>xor vr, vr, vr\uff1a6 IPC</li>\n<li>mov r, imm\uff1a6 IPC</li>\n</ul>\n<p>\u5176\u4e2d r \u8868\u793a\u6574\u6570\u5bc4\u5b58\u5668\uff0cvr \u8868\u793a\u6d6e\u70b9/\u5411\u91cf\u5bc4\u5b58\u5668\u3002\u603b\u4f53\u6765\u8bf4\u8fd8\u662f\u505a\u7684\u6bd4\u8f83\u5b8c\u5584\u7684\u3002</p>\n<h3 id=\"dispatch\">Dispatch<a class=\"headerlink\" href=\"#dispatch\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a8 MOP/cycle, up to 2 taken branches/cycle</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"rob\">ROB<a class=\"headerlink\" href=\"#rob\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>224-entry per thread</strong>, 1-2 MOP per entry</p>\n<p>\u628a\u4e24\u4e2a\u72ec\u7acb\u7684 long latency pointer chasing load \u653e\u5728\u5faa\u73af\u7684\u5934\u548c\u5c3e\uff0c\u4e2d\u95f4\u7528 NOP \u586b\u5145\uff0c\u5f53 NOP \u586b\u6ee1\u4e86 ROB\uff0c\u7b2c\u4e8c\u4e2a pointer chasing load \u65e0\u6cd5\u63d0\u524d\u6267\u884c\uff0c\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\u3002\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_rob.png\" /></p>\n<p>\u5f53 NOP \u6307\u4ee4\u8fbe\u5230 446 \u6761\u65f6\u51fa\u73b0\u6027\u80fd\u7a81\u53d8\uff0c\u6b64\u65f6\u5e94\u8be5\u662f\u89e6\u53d1\u4e86 Zen 5 \u7684\u6bcf\u4e2a entry \u4fdd\u5b58\u4e24\u4e2a MOP \u7684\u6761\u4ef6\uff0c\u56e0\u6b64 446 \u6761 NOP \u6307\u4ee4\u5bf9\u5e94 223 \u4e2a entry\uff0c\u52a0\u4e0a\u5faa\u73af\u5f00\u5934\u7684 load \u6307\u4ee4\uff0c\u6b63\u597d\u628a\u5faa\u73af\u5c3e\u90e8\u7684 load \u62e6\u5728\u4e86 ROB \u5916\u9762\uff0c\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\u3002</p>\n<p>\u8bf4\u660e\u5355\u7ebf\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u5230\u7684 ROB \u5bb9\u91cf\u662f 224 entry\u3002</p>\n<h3 id=\"register-file\">Register File<a class=\"headerlink\" href=\"#register-file\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a240-entry(40 per thread for architectural) integer physical register file, 192-entry flag physical register file, 384-entry 512b vector register file</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u7269\u7406\u5bc4\u5b58\u5668\u5806\u5927\u5c0f\uff0c\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5f00\u5934\u548c\u7ed3\u5c3e\u5404\u662f\u4e00\u4e2a\u957f\u5ef6\u8fdf\u7684\u64cd\u4f5c\uff0c\u7531\u4e8e Zen 5 \u6ca1\u6709\u5b9e\u73b0 temporal prefetcher\uff0c\u4f7f\u7528\u7684\u662f pointer chasing load\u3002\u7136\u540e\u5728\u4e24\u4e2a\u957f\u5ef6\u8fdf\u7684\u64cd\u4f5c\u4e2d\u95f4\u7a7f\u63d2\u4e0d\u540c\u7684\u6307\u4ee4\u7c7b\u578b\uff0c\u4ece\u800c\u6d4b\u51fa\u5bf9\u5e94\u7684\u7269\u7406\u5bc4\u5b58\u5668\u5806\u53ef\u4f9b\u9884\u6d4b\u6267\u884c\u7684\u5bc4\u5b58\u5668\u6570\u91cf\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_rf.png\" /></p>\n<p>\u6574\u6570\u65b9\u9762\u4f7f\u7528 lea \u6307\u4ee4\u6765\u6d88\u8017\u6574\u6570\u7269\u7406\u5bc4\u5b58\u5668\u800c\u4e0d\u6d88\u8017 flags \u5bc4\u5b58\u5668\uff0c\u6b64\u65f6\u65e0\u8bba\u662f 32 \u4f4d\u8fd8\u662f 64 \u4f4d\u5bc4\u5b58\u5668\uff0c\u4f9b\u9884\u6d4b\u6267\u884c\u7684\u5bc4\u5b58\u5668\u6570\u90fd\u6709 200 \u4e2a\uff0c\u548c\u5b98\u65b9\u7684\u4fe1\u606f\u543b\u5408\uff1a<code>200+40=240</code>\uff0c\u8bf4\u660e\u8d85\u7ebf\u7a0b\u5728\u6ca1\u6709\u8d1f\u8f7d\u7684\u65f6\u5019\uff0c\u4e0d\u4f1a\u5360\u7528\u6574\u6570\u7269\u7406\u5bc4\u5b58\u5668\u5806\uff0c\u8fd9\u5728 AMD \u7684\u6587\u6863\u4e2d\u53eb\u505a Watermarked\uff1a<code>Resource entries are assigned on demand</code>\u3002356 \u4e2a flags \u5bc4\u5b58\u5668\u8d85\u8fc7\u4e86\u5b98\u65b9\u5ba3\u4f20\u7684 192 \u7684\u5927\u5c0f\uff0c\u731c\u6d4b\u505a\u4e86\u4e00\u4e9b\u4f18\u5316\uff0c\u6d4b\u5230\u7684\u5e76\u975e flags \u5bc4\u5b58\u5668\u5806\u5927\u5c0f\u3002</p>\n<p>\u6d6e\u70b9\u65b9\u9762\uff0c\u6d4b\u5f97 430 \u4e2a\u4f9b\u9884\u6d4b\u6267\u884c\u7684\u6d6e\u70b9\u5bc4\u5b58\u5668\uff0c\u8d85\u8fc7\u4e86\u5b98\u65b9\u5ba3\u4f20\u7684 384 \u4e2a 512 \u4f4d\u6d6e\u70b9\u5bc4\u5b58\u5668\u3002\u8003\u8651\u5230 Zen5 \u5f15\u5165\u4e86\u5728 Rename \u4e4b\u524d\u7684 96-entry Non-Scheduling Queue(NSQ)\uff0c\u5728 NSQ \u4e2d\u7684\u6307\u4ee4\u8fd8\u6ca1\u6709\u7ecf\u8fc7\u91cd\u547d\u540d\uff0c\u56e0\u6b64\u4e0d\u6d88\u8017\u7269\u7406\u5bc4\u5b58\u5668\uff1a<code>384+96=480</code>\uff0c\u518d\u53bb\u6389\u81f3\u5c11 32 \u4e2a\u67b6\u6784\u5bc4\u5b58\u5668 zmm0-zmm31\uff0c\u548c\u89c2\u5bdf\u5230\u7684 430 \u662f\u6bd4\u8f83\u63a5\u8fd1\u7684\u3002</p>\n<p>\u9488\u5bf9\u6d6e\u70b9\u5bc4\u5b58\u5668\uff0cZen5 \u7684\u4e0d\u540c\u5e73\u53f0\u7684\u8bbe\u8ba1\u4e0d\u5b8c\u5168\u4e00\u6837\uff0c\u4e0a\u9762\u7684\u6d4b\u8bd5\u662f\u5728 9950X \u4e0a\u8fdb\u884c\u7684\uff0c\u5176\u4ed6\u5e73\u53f0\u7684\u6d4b\u8bd5\u4ee5\u53ca\u5206\u6790\u89c1 <a href=\"http://www.numberworld.org/blogs/2024_8_7_zen5_avx512_teardown/#vector_register_file\">Zen5's AVX512 Teardown + More...</a>\u3002</p>\n<h3 id=\"l1-dcache\">L1 DCache<a class=\"headerlink\" href=\"#l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>48KB</strong>, 12-way set associative, index \u662f VA[11:6]</p>\n<p>\u4f7f\u7528\u4e0d\u540c footprint \u7684\u968f\u673a\u7684 pointer chasing load\uff0c\u6d4b\u8bd5\u6027\u80fd\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\u660e\u663e\u7684 48KB \u7684\u62d0\u70b9\uff0c\u547d\u4e2d L1 DCache \u65f6 load to use latency \u662f 4 cycle\uff0c\u547d\u4e2d L2 \u65f6\u589e\u5927\u5230\u4e86 14 cycle\u3002</p>\n<h4 id=\"linear-address-utagway-predictor\">Linear Address UTAG/Way-Predictor<a class=\"headerlink\" href=\"#linear-address-utagway-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>\u590d\u73b0\u8bba\u6587 <a href=\"https://dl.acm.org/doi/10.1145/3320269.3384746\">Take A Way: Exploring the Security Implications of AMD's Cache Way Predictors</a>\uff0c\u53ef\u4ee5\u770b\u5230 Zen 5 \u7684 UTAG \u54c8\u5e0c\u51fd\u6570\u548c Zen 2 \u4e00\u6837\u4e5f\u662f\u5982\u4e0b 8 bit\uff1a</p>\n<ul>\n<li>VA[12] xor VA[27]</li>\n<li>VA[13] xor VA[26]</li>\n<li>VA[14] xor VA[25]</li>\n<li>VA[15] xor VA[20]</li>\n<li>VA[16] xor VA[21]</li>\n<li>VA[17] xor VA[22]</li>\n<li>VA[18] xor VA[23]</li>\n<li>VA[19] xor VA[24]</li>\n</ul>\n<p>\u5982\u679c\u4e24\u4e2a\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u540c\u4e00\u4e2a DCache Set \u4e0a\u7684\u4e0d\u540c Way\uff08Set \u6839\u636e VA[11:6] \u552f\u4e00\u786e\u5b9a\uff09\uff0c\u5e76\u4e14\u5b83\u4eec\u7684 uTag \u51fa\u73b0\u51b2\u7a81\uff0c\u90a3\u4e48\u8bbf\u95ee\u4e00\u4e2a\u865a\u62df\u5730\u5740\u4f1a\u628a\u53e6\u4e00\u4e2a\u865a\u62df\u5730\u5740\u4ece L1 DCache \u4e2d\u6e05\u6389\u3002</p>\n<h3 id=\"load-store-unit\">Load Store Unit<a class=\"headerlink\" href=\"#load-store-unit\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u6bcf\u5468\u671f\u6700\u591a\u56db\u4e2a\u5185\u5b58\u64cd\u4f5c\u3002\u6bcf\u5468\u671f\u6700\u591a\u56db\u4e2a\u8bfb\uff0c\u5176\u4e2d\u6700\u591a\u4e24\u4e2a 128b/256b/512b \u8bfb\uff1b\u6bcf\u5468\u671f\u6700\u591a\u4e24\u4e2a\u5199\uff0c\u5176\u4e2d\u6700\u591a\u4e00\u4e2a 512b \u5199\u3002load to use latency\uff0c\u6574\u6570\u662f 4-5 \u4e2a\u5468\u671f\uff0c\u6d6e\u70b9\u662f 7-8 \u4e2a\u5468\u671f\u3002\u8de8\u8d8a 64B \u8fb9\u754c\u7684\u8bfb\u4f1a\u6709\u989d\u5916\u7684\u4e00\u4e2a\u5468\u671f\u7684\u5ef6\u8fdf\u3002\u652f\u6301 Store to load forwarding\uff0c\u8981\u6c42\u5148\u524d\u7684 store \u5305\u62ec\u4e86 load \u7684\u6240\u6709\u5b57\u8282\uff0c\u4e0d\u8981\u6c42\u5bf9\u9f50\u3002</p>\n<h4 id=\"\u541e\u5410_1\">\u541e\u5410<a class=\"headerlink\" href=\"#\u541e\u5410_1\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5b9e\u6d4b Zen 5 \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\u5982\u4e0b\u7684\u8bbf\u5b58\u64cd\u4f5c\uff1a</p>\n<ul>\n<li>4x 32b Load: 1 cycle</li>\n<li>4x 64b Load: 1 cycle</li>\n<li>2x 128b Load: 1 cycle</li>\n<li>2x 256b Load: 1 cycle</li>\n<li>2x 32b Store: 1 cycle</li>\n<li>2x 64b Store: 1 cycle</li>\n<li>2x 128b Store: 1 cycle</li>\n<li>2x 256b Store: 1 cycle</li>\n<li>1x 64b Load + 2x 64b Store: 1 cycle</li>\n<li>2x 64b Load + 2x 64b Store: 1 cycle</li>\n<li>3x 64b Load + 1x 64b Store: 1 cycle</li>\n<li>1x 128b Load + 2x 128b Store: 1 cycle</li>\n<li>2x 128b Load + 1x 128b Store: 1 cycle</li>\n</ul>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u6bcf\u5468\u671f\u652f\u6301 4 \u4e2a 64b \u7684 Load/Store\uff0c\u5176\u4e2d Store \u6700\u591a\u4e24\u6761\u3002\u4e00\u4e2a 128b \u7684 Load \u76f8\u5f53\u4e8e\u4e24\u4e2a 64b\uff0c\u5bf9\u5e94 IPC \u51cf\u534a\u3002</p>\n<h4 id=\"\u5ef6\u8fdf\">\u5ef6\u8fdf<a class=\"headerlink\" href=\"#\u5ef6\u8fdf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e32\u884c\u7684 load \u94fe\uff0c\u89c2\u5bdf\u5230\u591a\u6570\u60c5\u51b5\u4e0b load to use latency \u662f 4 \u4e2a\u5468\u671f\uff0c\u5728\u8de8\u8d8a 64B \u8fb9\u754c\u65f6\uff0c\u4f1a\u589e\u52a0\u4e00\u4e2a\u5468\u671f\u53d8\u6210 5 \u4e2a\u5468\u671f\u3002\u6b64\u5916\uff0c\u5982\u679c\u6d89\u53ca\u5230 index \u8ba1\u7b97\uff08\u5373 <code>offset(base, index, shift)</code>\uff09\uff0c\u4e5f\u4f1a\u589e\u52a0\u4e00\u4e2a\u5468\u671f\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff1a</p>\n<p>\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[0,2]</td>\n<td>{0}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[0,6]</td>\n<td>[0,4]</td>\n<td>{0}</td>\n</tr>\n</tbody>\n</table>\n<p>\u53ef\u4ee5\u770b\u5230\uff0cZen 5 \u5728 Store \u5b8c\u5168\u5305\u542b Load \u7684\u60c5\u51b5\u4e0b\u90fd\u53ef\u4ee5\u8f6c\u53d1\uff0c\u6ca1\u6709\u989d\u5916\u7684\u5bf9\u9f50\u8981\u6c42\u3002\u4f46\u5f53 Load \u548c Store \u53ea\u6709\u90e8\u5206\u91cd\u5408\u65f6\uff0c\u5c31\u65e0\u6cd5\u8f6c\u53d1\u3002\u4e24\u4e2a\u8fde\u7eed\u7684 32 \u4f4d\u7684 Store \u548c\u4e00\u4e2a 64 \u4f4d\u7684 Load \u91cd\u5408\u4e5f\u4e0d\u80fd\u8f6c\u53d1\u3002</p>\n<p>\u53ef\u89c1 Zen 5 \u7684 Store to Load Forwarding \u5b9e\u73b0\u6bd4\u8f83\u7c97\u66b4\uff0c\u53ea\u5141\u8bb8 Load \u4ece\u5355\u4e2a\u5b8c\u5168\u5305\u542b Load \u7684 Store \u4e2d\u8f6c\u53d1\u6570\u636e\u3002\u548c <a href=\"../../07/arm_neoverse_v2/\">Neoverse V2</a> \u76f8\u6bd4\uff0cZen 5 \u5bf9 Load \u5728 Store \u5185\u7684\u504f\u79fb\u6ca1\u6709\u8981\u6c42\uff0c\u4f46\u4e5f\u4e0d\u5141\u8bb8 Load \u548c Store \u53ea\u6709\u4e00\u90e8\u5206\u8986\u76d6\uff0c\u4e5f\u4e0d\u652f\u6301\u4e00\u4e2a Load \u4ece\u4e24\u4e2a\u6216\u66f4\u591a\u7684 Store \u4e2d\u83b7\u53d6\u6570\u636e\u3002</p>\n<p>\u6210\u529f\u8f6c\u53d1\u65f6 8 cycle\uff0c\u6709 Overlap \u4f46\u8f6c\u53d1\u5931\u8d25\u65f6 14-15 cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aZen 5 \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42 st \u5305\u542b ld</li>\n<li>1 ld + 2+ st: \u4e0d\u652f\u6301</li>\n</ul>\n<h3 id=\"l1-dtlb\">L1 DTLB<a class=\"headerlink\" href=\"#l1-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>96-entry</strong>, fully associative</p>\n<p>\u4f7f\u7528\u4e0d\u540c footprint \u7684\u968f\u673a\u7684 pointer chasing load \u4e14\u6bcf\u6b21 load \u90fd\u5728\u5355\u72ec\u7684\u9875\u5185\uff0c\u6d4b\u8bd5\u6027\u80fd\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../amd_zen5_l1dtlb.png\" /></p>\n<p>\u53ef\u4ee5\u89c2\u5bdf\u5230\u660e\u663e\u7684 96 page \u7684\u62d0\u70b9\uff0c\u547d\u4e2d L1 DTLB \u65f6 load to use latency \u662f 4 cycle\uff0c\u547d\u4e2d L2 DTLB \u65f6\u589e\u5927\u5230\u4e86 11 cycle\u3002</p>\n<p>\u8fd9\u4e2a\u62d0\u70b9\u4e5f\u53ef\u4ee5\u4ece\u6027\u80fd\u8ba1\u6570\u5668\u4e2d\u770b\u51fa\uff0cZen 5 \u9488\u5bf9 L1 DTLB \u6709\u6027\u80fd\u8ba1\u6570\u5668 <code>PMCx045 [L1 DTLB Misses] (Core::X86::Pmc::Core::LsL1DTlbMiss)</code>\uff0c\u6839\u636e\u8fd9\u4e2a\u4e8b\u4ef6\u8bb0\u5f55 L1 DTLB Miss \u6b21\u6570\uff0c\u53ef\u4ee5\u770b\u5230\u5728 96 \u4e2a\u9875\u5185\u65f6 Miss \u6b21\u6570\u4e3a 0\uff0c\u4e4b\u540e\u5f00\u59cb\u589e\u52a0\uff0c\u5230 100 \u4e2a\u9875\u7684\u65f6\u5019 Miss \u6b21\u6570\u548c\u8bbf\u95ee\u6b21\u6570\u76f8\u540c\uff0c\u5373 100% Miss Rate\u3002</p>\n<h3 id=\"l2-dtlb\">L2 DTLB<a class=\"headerlink\" href=\"#l2-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a4096-entry, 16-way set associative</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a16-way set associative, inclusive, 1MB, <strong>&gt;= 14 cycle load to use latency</strong></p>\n<h3 id=\"l3-cache\">L3 Cache<a class=\"headerlink\" href=\"#l3-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a16-way set associative, exclusive</p>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aZen 5 \u7684\u540e\u7aef\u6709 6 \u6761 ALU \u6d41\u6c34\u7ebf\uff0c4 \u6761\u8bbf\u5b58\u6d41\u6c34\u7ebf\uff0c4 \u6761 512 \u4f4d\u5bbd\u5411\u91cf\u6d41\u6c34\u7ebf\uff08\u5176\u4e2d 2 \u6761\u652f\u6301 FMA\uff09\uff0c2 \u6761\u5411\u91cf\u8bbf\u5b58\u6d41\u6c34\u7ebf</p>\n<p>\u5b9e\u6d4b\u53d1\u73b0 Zen 5 \u6bcf\u5468\u671f\u6700\u591a\u53ef\u4ee5\u6267\u884c 2 \u6761 AVX512 \u7684\u6d6e\u70b9 FMA \u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u5468\u671f\u6d6e\u70b9\u5cf0\u503c\u6027\u80fd\uff1a</p>\n<ul>\n<li>\u5355\u7cbe\u5ea6\uff1a<code>512/32*2*2=64</code> FLOP per cycle</li>\n<li>\u53cc\u7cbe\u5ea6\uff1a<code>512/64*2*2=32</code> FLOP per cycle</li>\n</ul>\n<p>\u901a\u8fc7 512 \u4f4d\u7684\u6d6e\u70b9 datapath\uff0c\u7ec8\u4e8e\u8fbe\u5230\u4e86\u7b2c\u4e00\u68af\u961f\u7684\u6d6e\u70b9\u5cf0\u503c\u6027\u80fd\u3002\u6ce8\u610f\u79fb\u52a8\u7aef\u7684 Zen 5 \u7684\u6d6e\u70b9 datapath \u780d\u534a\uff0c\u53ea\u6709 256 \u4f4d\u3002</p>", "image": null, "date_modified": "2024-11-11T00:00:00+00:00", "authors": [], "tags": ["amd", "cpu", "hardware", "performance", "ryzen", "uarch-review", "zen5"]}, {"id": "https://jia.je/meta/2024/11/10/migrate-from-disqus-to-giscus/", "url": "https://jia.je/meta/2024/11/10/migrate-from-disqus-to-giscus/", "title": "\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece Disqus \u8fc1\u79fb\u5230 Giscus", "content_html": "<h1 id=\"\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece-disqus-\u8fc1\u79fb\u5230-giscus\">\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece Disqus \u8fc1\u79fb\u5230 Giscus<a class=\"headerlink\" href=\"#\u628a\u8bc4\u8bba\u7cfb\u7edf\u4ece-disqus-\u8fc1\u79fb\u5230-giscus\" title=\"Permanent link\">&para;</a></h1>\n<p>Disqus \u8981\u52a0\u5e7f\u544a\u4e86\uff0c\u4e8e\u662f\u672c\u535a\u5ba2\u7684\u8bc4\u8bba\u7cfb\u7edf\u8fc1\u79fb\u5230\u4e86 Giscus\u3002</p>", "image": null, "date_modified": "2024-11-10T00:00:00+00:00", "authors": [], "tags": ["meta", "site"]}, {"id": "https://jia.je/hardware/2024/11/07/arm_neoverse_v2/", "url": "https://jia.je/hardware/2024/11/07/arm_neoverse_v2/", "title": "ARM Neoverse V2 (\u4ee3\u53f7 Demeter) \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"arm-neoverse-v2-\u4ee3\u53f7-demeter-\u5fae\u67b6\u6784\u8bc4\u6d4b\">ARM Neoverse V2 (\u4ee3\u53f7 Demeter) \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#arm-neoverse-v2-\u4ee3\u53f7-demeter-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM Neoverse V2 \u662f\u76ee\u524d\uff082024 \u5e74\uff09\u5728\u670d\u52a1\u5668\u4e0a\u80fd\u7528\u5230\u7684\u6700\u65b0\u7684 ARM \u516c\u7248\u6838\u5e73\u53f0\uff08AWS Graviton 4\uff09\uff0c\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>ARM \u5173\u4e8e Neoverse V2 \u5fae\u67b6\u6784\u6709\u5982\u4e0b\u516c\u5f00\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://hc2023.hotchips.org/assets/program/conference/day1/CPU1/HC2023.Arm.MagnusBruce.v04.FINAL.pdf\">Arm Neoverse V2 platform: Leadership Performance and Power Efficiency for Next-Generation Cloud Computing, ML and HPC Workloads</a></li>\n<li><a href=\"https://developer.arm.com/documentation/102375/latest/\">Arm\u00ae Neoverse\u2122 V2 Core Technical Reference Manual</a></li>\n<li><a href=\"https://developer.arm.com/documentation/109898/latest/\">Arm Neoverse V2 Software Optimization Guide</a></li>\n</ul>\n<p>\u8003\u8651\u5230 Neoverse V2 \u4e0e Cortex X3 \u7684\u9ad8\u5ea6\u76f8\u4f3c\u6027\uff0c\u8fd9\u91cc\u4e5f\u5217\u51fa Cortex X3 \u7684\u76f8\u5173\u4fe1\u606f\uff1a</p>\n<ul>\n<li><a href=\"https://fuse.wikichip.org/news/6855/arm-unveils-next-gen-flagship-core-cortex-x3/\">Arm Unveils Next-Gen Flagship Core: Cortex-X3</a></li>\n<li><a href=\"https://developer.arm.com/documentation/101593/latest/\">Arm\u00ae Cortex\u2011X3 Core Technical Reference Manual</a></li>\n</ul>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709 Neoverse V2 \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://chipsandcheese.com/p/hot-chips-2023-arms-neoverse-v2\">Hot Chips 2023: Arm\u2019s Neoverse V2</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Neoverse V2 (AWS Graviton 4) \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"mop-vs-uop\">MOP vs uOP<a class=\"headerlink\" href=\"#mop-vs-uop\" title=\"Permanent link\">&para;</a></h2>\n<p>MOP = Macro operation, uOP = Micro operation</p>\n<p>ARM \u516c\u7248\u6838\u5fae\u67b6\u6784\u65e2\u6709 MOP \u7684\u6982\u5ff5\uff0c\u53c8\u6709 uOP \u7684\u6982\u5ff5\u3002uOP \u4e3b\u8981\u662f\u9488\u5bf9\u540e\u7aef\uff0c\u6267\u884c\u5355\u5143\u5904\u7406\u7684\u662f uOP\u3002MOP \u51fa\u73b0\u5728 MOP Cache \u4ee5\u53ca ROB \u5f53\u4e2d\u3002\u4ed6\u4eec\u548c\u6307\u4ee4\u90fd\u5e76\u4e0d\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u5173\u7cfb\u3002</p>\n<p>\u4f8b\u5982 Instruction Fusion \u7279\u6027\uff0c\u53ef\u4ee5\u628a\u591a\u6761\u6307\u4ee4\u5408\u5e76\u5230\u4e00\u6761 uOP \u5f53\u4e2d\uff0c\u4f8b\u5982 CMP + CSET\uff0c\u5408\u5e76\u6210\u4e00\u4e2a uOP \u4ee5\u540e\uff0c\u53ea\u9700\u8981\u4e00\u4e2a ALU \u5c31\u53ef\u4ee5\u5b8c\u6210\u6574\u4e2a\u64cd\u4f5c\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e00\u6761\u6307\u4ee4\u4e5f\u53ef\u80fd\u62c6\u6210\u591a\u4e2a uOP\uff0c\u4f8b\u5982 128b Load Pair \u6307\u4ee4\uff0c\u4e00\u6761\u6307\u4ee4\u88ab\u62c6\u6210\u4e24\u4e2a uOP\uff0c\u53ef\u4ee5\u72ec\u7acb\u6267\u884c\uff0c\u4f46\u4e3a\u4e86\u4fdd\u8bc1\u7cbe\u786e\u5f02\u5e38\uff0c\u5728 ROB \u4e2d\u8fd8\u662f\u540c\u4e00\u4e2a MOP\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u5982\u679c\u4e0d\u8003\u8651\u8fd9\u4e9b\u7ec6\u8282\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4e00\u6761\u6307\u4ee4\u5bf9\u5e94\u4e00\u4e2a MOP \u5bf9\u5e94\u4e00\u4e2a uOP \u4e5f\u662f\u6210\u7acb\u7684\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"branch-predictor\">Branch Predictor<a class=\"headerlink\" href=\"#branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aTwo predicted branches per cycle, nanoBTB + two level main BTB, 8 table 2 way TAGE direction predictor</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>64KB</strong>, 4-way set associative, VIPT behaving as PIPT, 64B cacheline, PLRU replacement policy</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b\u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_fetch_bandwidth.png\" /></p>\n<p>\u5f00\u59cb\u6709\u4e00\u6bb5 IPC \u63a5\u8fd1 12\uff0c\u6b64\u65f6\u6307\u4ee4\u7531 MOP Cache \u63d0\u4f9b\uff0c\u7531\u4e8e\u8fde\u7eed\u7684\u4e24\u6761 NOP \u53ef\u4ee5\u88ab\u878d\u5408\u6210\u4e00\u4e2a uOP\uff0c\u56e0\u6b64\u53ef\u4ee5\u7a81\u7834 8 \u7684\u9650\u5236\uff0c\u4f46\u4e3a\u4ec0\u4e48\u662f 12 \u8fd8\u9700\u8981\u8fdb\u4e00\u6b65\u7814\u7a76\u3002</p>\n<p>\u5f53\u6307\u4ee4\u8d85\u51fa MOP Cache \u5bb9\u91cf\u540e\uff0c\u6307\u4ee4\u8d70 ICache + Decode\uff0c\u6b64\u65f6\u53ef\u4ee5\u8fbe\u5230 6 \u7684 IPC\uff0c\u4e0e 6-wide \u7684 Decode Width \u543b\u5408\u3002\u5f53 footprint \u8d85\u51fa 64 KB \u65f6\uff0cIPC \u4e0b\u964d\uff0c\u5bf9\u5e94\u4e86 64KB \u7684 L1 ICache \u5bb9\u91cf\u3002</p>\n<p>\u8d85\u51fa L1 ICache \u5bb9\u91cf\u540e\uff0c\u53ef\u4ee5\u8fbe\u5230 4 \u7684 IPC\uff0c\u8bf4\u660e L2 Cache \u53ef\u4ee5\u63d0\u4f9b\u6bcf\u5468\u671f 16 \u5b57\u8282\u7684\u53d6\u6307\u5e26\u5bbd\u3002</p>\n<h3 id=\"mop-cache\">MOP Cache<a class=\"headerlink\" href=\"#mop-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>1536 macro-operations</strong>, 4-way skewed associative, VIVT behaving as PIPT, NRU replacement policy, <strong>8 MOP/cycle</strong></p>\n<p>\u56e0\u4e3a MOP Cache \u7684\u5e26\u5bbd\u6bd4 Decode \u9ad8\uff0c\u4e3a\u4e86\u6d4b\u8bd5\u51fa MOP Cache \u7684\u89c4\u683c\uff0c\u9700\u8981\u6784\u9020\u6307\u4ee4\u5e8f\u5217\uff0c\u4f7f\u5176\u53ef\u4ee5\u8fbe\u5230 8 MOP/cycle \u7684 IPC\uff0c\u5982\u679c\u8d70\u7684\u662f Instruction Fetch + Decode\uff0c\u5219\u8fbe\u4e0d\u5230\u8fd9\u4e2a IPC\u3002\u4f46\u662f Neoverse V2 \u7684 Dispatch \u6709\u6bd4\u8f83\u660e\u786e\u7684\u9650\u5236\uff1a</p>\n<p>The dispatch stage can process up to 8 MOPs per cycle and dispatch up to 16 \u00b5OPs per cycle, with the following limitations on the number of \u00b5OPs of each type that may be simultaneously dispatched.</p>\n<ul>\n<li>Up to 4 \u00b5OPs utilizing the S\uff08\u5355\u5468\u671f\u6574\u6570\uff09or B\uff08\u5206\u652f\uff09pipelines</li>\n<li>Up to 4 \u00b5OPs utilizing the M\uff08\u591a\u5468\u671f\u6574\u6570\uff09pipelines</li>\n<li>Up to 2 \u00b5OPs utilizing the M0\uff08\u591a\u5468\u671f\u6574\u6570\uff09pipelines</li>\n<li>Up to 2 \u00b5OPs utilizing the V0\uff08\u6d6e\u70b9/\u5411\u91cf\uff09pipeline</li>\n<li>Up to 2 \u00b5OPs utilizing the V1\uff08\u6d6e\u70b9/\u5411\u91cf\uff09pipeline</li>\n<li>Up to 6 \u00b5OPs utilizing the L\uff08\u8bbf\u5b58\uff09pipelines</li>\n</ul>\n<p>\u8003\u8651\u5230\u8fd9\u4e2a\u9650\u5236\uff0c\u4f7f\u7528 4 \u6761 add \u6307\u4ee4\uff0c4 \u6761 fadd \u6307\u4ee4\u4e3a\u4e00\u7ec4\uff0c\u4e0d\u65ad\u91cd\u590d\u3002\u901a\u8fc7\u6d4b\u8bd5\uff0c\u8fd9\u6837\u7684\u6307\u4ee4\u5e8f\u5217\u786e\u5b9e\u53ef\u4ee5\u8fbe\u5230 8 \u7684 IPC\u3002\u5f53\u6307\u4ee4\u4e2a\u6570\u589e\u52a0\u5230\u8d85\u51fa MOP Cache \u5bb9\u91cf\u65f6\uff0c\u5c06\u4f1a\u89c2\u5bdf\u5230\u6027\u80fd\u7684\u4e0b\u964d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_mop_cache.png\" /></p>\n<p>\u62d0\u70b9\u51fa\u73b0\u5728 192 \u4e2a\u6307\u4ee4\u7ec4\uff0c\u6b64\u65f6\u8fbe\u5230 MOP Cache \u7684\u5bb9\u91cf\u74f6\u9888\uff0c<code>192*8=1536</code>\uff0c\u6b63\u597d\u662f MOP Cache \u7684\u5bb9\u91cf\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aCaches entries at the 4KB, 16KB, 64KB, or 2MB granularity, Fully associative, 48 entries</p>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 B \u6307\u4ee4\uff0c\u4f7f\u5f97 B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 48 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 48 \u7684 L1 ITLB \u5bb9\u91cf\u3002\u6b64\u540e\u6027\u80fd\u964d\u4f4e\u5230 7 CPI\uff0c\u6b64\u65f6\u5bf9\u5e94\u4e86 L2 Unified TLB \u7684\u5ef6\u8fdf\u3002</p>\n<p>\u8fdb\u4e00\u6b65\u589e\u52a0 Page \u6570\u91cf\uff0c\u53d1\u73b0\u5728\u5927\u7ea6 1000 \u4e2a\u9875\u7684\u65f6\u5019\uff0c\u65f6\u95f4\u4ece 7 cycle \u9010\u6e10\u4e0a\u5347\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_itlb_l2.png\" /></p>\n<p>\u8003\u8651\u5230 L2 Unified TLB \u4e00\u5171\u6709 2048 \u4e2a Entry\uff0c\u731c\u6d4b\u5b83\u9650\u5236\u4e86 ITLB \u80fd\u4f7f\u7528\u7684 L2 TLB \u7684\u5bb9\u91cf\u53ea\u6709 2048 \u7684\u4e00\u534a\uff0c\u4e5f\u5c31\u662f 1024 \u9879\u3002\u8d85\u51fa 1024 \u9879\u4ee5\u540e\uff0c\u9700\u8981 Page Table Walker \u8fdb\u884c\u5730\u5740\u7ffb\u8bd1\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a6-wide Decode</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>Return Stack \u8bb0\u5f55\u4e86\u6700\u8fd1\u7684\u51fd\u6570\u8c03\u7528\u94fe\uff0ccall \u65f6\u538b\u6808\uff0creturn \u65f6\u5f39\u6808\uff0c\u4ece\u800c\u5b9e\u73b0 return \u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u7684\u9884\u6d4b\u3002\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u53d1\u73b0 Neoverse V2 \u7684 Return Stack \u6df1\u5ea6\u4e3a 32\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_return_stack.png\" /></p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"dispatch\">Dispatch<a class=\"headerlink\" href=\"#dispatch\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aup to 8 MOPs per cycle and up to 16 uOPs per cycle</p>\n<h3 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<p>The Neoverse V2 core allows data to be forwarded from store instructions to a load instruction with the restrictions mentioned below:</p>\n<ul>\n<li>Load start address should align with the start or middle address of the older store</li>\n<li>Loads of size greater than or equal to 8 bytes can get the data forwarded from a maximum of 2 stores. If there are 2 stores, then each store should forward to either first or second half of the load</li>\n<li>Loads of size less than or equal to 4 bytes can get their data forwarded from only 1 store</li>\n</ul>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff1a</p>\n<p>\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>{0,1}</td>\n<td>{0}</td>\n<td>{}</td>\n<td>{}</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>{0,2}</td>\n<td>{0,2}</td>\n<td>{0}</td>\n<td>{-4,0}</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>{0,4}</td>\n<td>{0,4}</td>\n<td>{0,4}</td>\n<td>{-4,0,4}</td>\n</tr>\n</tbody>\n</table>\n<p>\u4e00\u4e2a Load \u9700\u8981\u8f6c\u53d1\u4e24\u4e2a Store \u7684\u6570\u636e\u7684\u60c5\u51b5\uff1a\u5bf9\u5730\u5740 x \u7684 32b Store \u548c\u5bf9\u5730\u5740 x+4 \u7684 32b Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 64b Load\uff0c\u5728 Overlap \u7684\u60c5\u51b5\u4e0b\uff0c\u8981\u6c42 y=x\uff0c\u4e5f\u5c31\u662f\u6070\u597d\u524d\u534a\u6765\u81ea\u7b2c\u4e00\u4e2a Store\uff0c\u540e\u534a\u6765\u81ea\u7b2c\u4e8c\u4e2a Store\u3002</p>\n<p>\u548c\u5b98\u65b9\u7684\u63cf\u8ff0\u662f\u6bd4\u8f83\u7b26\u5408\u7684\uff0c\u53ea\u8003\u8651\u4e86\u5168\u90e8\u8f6c\u53d1\u3001\u8f6c\u53d1\u524d\u534a\u548c\u8f6c\u53d1\u540e\u534a\u7684\u4e09\u79cd\u573a\u666f\u3002\u7279\u522b\u5730\uff0c\u9488\u5bf9\u5e38\u89c1\u7684 64b Load\uff0c\u652f\u6301 y-x=-4\u3002\u540c\u65f6\u4e5f\u652f\u6301\u524d\u534a\u548c\u540e\u534a\u6765\u81ea\u4e24\u4e2a\u4e0d\u540c\u7684 Store\u3002\u5bf9\u5730\u5740\u672c\u8eab\u7684\u5bf9\u9f50\u6ca1\u6709\u8981\u6c42\uff0c\u751a\u81f3\u5728\u8de8\u7f13\u5b58\u884c\u8fb9\u754c\u65f6\u4e5f\u53ef\u4ee5\u8f6c\u53d1\uff0c\u53ea\u662f\u5bf9 Load \u548c Store \u7684\u76f8\u5bf9\u4f4d\u7f6e\u6709\u8981\u6c42\u3002</p>\n<p>\u548c <a href=\"../../11/amd_zen5/\">Zen 5</a> \u76f8\u6bd4\uff0cNeoverse V2 \u5bf9 Store \u548c Load \u7684\u76f8\u5bf9\u4f4d\u7f6e\u6709\u989d\u5916\u7684\u8981\u6c42\uff08\u5f00\u5934\u6216\u6b63\u4e2d\u592e\uff09\uff0c\u4f46\u652f\u6301\u4e86 Store \u548c Load \u53ea\u6709\u4e00\u90e8\u5206\u8986\u76d6\u7684\u60c5\u51b5\uff0c\u4e5f\u5141\u8bb8\u4e00\u4e2a Load \u4ece\u4e24\u4e2a Store \u4e2d\u53d6\u5f97\u6570\u636e\u3002</p>\n<p>\u4ece\u6027\u80fd\u4e0a\uff0c\u53ef\u4ee5\u8f6c\u53d1\u65f6 5 Cycle\uff0c\u6709 Overlap \u4f46\u65e0\u6cd5\u8f6c\u53d1\u65f6 10.5 Cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aARM Neoverse V2 \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42 ld \u548c st \u5730\u5740\u76f8\u540c\u6216\u5dee\u51fa\u534a\u4e2a st \u5bbd\u5ea6</li>\n<li>1 ld + 2 st: \u8981\u6c42 ld \u548c st \u5730\u5740\u76f8\u540c</li>\n<li>1 ld + 4 st: \u4e0d\u652f\u6301</li>\n</ul>\n<h3 id=\"\u8ba1\u7b97\u5355\u5143\">\u8ba1\u7b97\u5355\u5143<a class=\"headerlink\" href=\"#\u8ba1\u7b97\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a6x ALU, <strong>2x Branch</strong>, <strong>4x 128b SIMD</strong></p>\n<p>\u5b9e\u6d4b\u4ee5\u4e0b\u6307\u4ee4\u7684\u541e\u5410\uff1a</p>\n<ul>\n<li>int add: 4 IPC\uff0c\u53d7\u5230 Dispatch \u9650\u5236\uff1a<code>Up to 4 \u00b5OPs utilizing the S\uff08\u5355\u5468\u671f\u6574\u6570\uff09or B\uff08\u5206\u652f\uff09pipelines</code></li>\n<li>int mul: 2 IPC\uff0c\u5bf9\u5e94\u4e24\u4e2a Multi Cycle \u5355\u5143</li>\n<li>int not taken branch: 2 IPC\uff0c\u5bf9\u5e94\u4e24\u4e2a Branch \u5355\u5143</li>\n<li>asimd fadd double: 4 IPC\uff0c\u5bf9\u5e94\u56db\u4e2a FP/ASIMD \u5355\u5143</li>\n</ul>\n<h3 id=\"load-store-unit\">Load Store Unit<a class=\"headerlink\" href=\"#load-store-unit\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>2 Load/Store Pipe + 1 Load Pipe</strong>, Reduce bandwidth or <strong>incur additional latency</strong> for:</p>\n<ol>\n<li>Load operations that cross a cache-line (64-byte) boundary.</li>\n<li>Quad-word load operations that are not 4B aligned.</li>\n<li>Store operations that cross a 32B boundary.</li>\n</ol>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u4e00\u4e2a\u5468\u671f\u5185\u53ef\u4ee5\u6700\u591a\u5b8c\u6210\u5982\u4e0b\u7684 Load/Store \u6307\u4ee4\uff1a</p>\n<ul>\n<li>3x 64b Load</li>\n<li>2x 64b Load + 1x 64b Store</li>\n<li>1x 64b Load + 2x 64b Store</li>\n<li>2x 64b Store</li>\n</ul>\n<p>\u8fd9\u4e2a\u6027\u80fd\u7b26\u5408 2 LS + 1 LD pipe \u7684\u8bbe\u8ba1\u3002</p>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u5f53 Load \u6307\u4ee4\u6ca1\u6709\u8de8\u8d8a\u7f13\u5b58\u884c\u65f6\uff0cload to use \u5ef6\u8fdf\u662f 4 cycle\uff1b\u5f53 Load \u6307\u4ee4\u8de8\u8fc7 64B \u7f13\u5b58\u884c\u8fb9\u754c\u65f6\uff0cload to use \u5ef6\u8fdf\u589e\u52a0\u5230 5 cycle\u3002</p>\n<h3 id=\"memory-dependency-predictor\">Memory Dependency Predictor<a class=\"headerlink\" href=\"#memory-dependency-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u9884\u6d4b\u6267\u884c Load\uff0c\u9700\u8981\u4fdd\u8bc1 Load \u548c\u4e4b\u524d\u7684 Store \u8bbf\u95ee\u7684\u5185\u5b58\u6ca1\u6709 Overlap\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u9884\u6d4b\u5668\u6765\u9884\u6d4b Load \u548c Store \u4e4b\u524d\u5728\u5185\u5b58\u4e0a\u7684\u4f9d\u8d56\u3002\u53c2\u8003 <a href=\"https://blog.stuffedcow.net/2014/01/x86-memory-disambiguation/\">Store-to-Load Forwarding and Memory Disambiguation in x86 Processors</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e24\u4e2a\u6307\u4ee4\u6a21\u5f0f\uff0c\u5206\u522b\u5728\u5730\u5740\u548c\u6570\u636e\u4e0a\u6709\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>\u6570\u636e\u4f9d\u8d56\uff0c\u5730\u5740\u65e0\u4f9d\u8d56\uff1a<code>str x3, [x1]</code> \u548c <code>ldr x3, [x2]</code></li>\n<li>\u5730\u5740\u4f9d\u8d56\uff0c\u6570\u636e\u65e0\u4f9d\u8d56\uff1a<code>str x2, [x1]</code> \u548c <code>ldr x1, [x2]</code></li>\n</ul>\n<p>\u521d\u59cb\u5316\u65f6\uff0c<code>x1</code> \u548c <code>x2</code> \u6307\u5411\u540c\u4e00\u4e2a\u5730\u5740\uff0c\u91cd\u590d\u5982\u4e0a\u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u89c2\u5bdf\u5230\u591a\u5c11\u6761 <code>ldr</code> \u6307\u4ee4\u65f6\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_memory_dependency_predictor.png\" /></p>\n<p>\u6709\u610f\u601d\u7684\u662f\uff0c\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 40\uff0c\u800c\u6570\u636e\u4f9d\u8d56\u6ca1\u6709\u9608\u503c\u3002</p>\n<h3 id=\"move-elimination\">Move Elimination<a class=\"headerlink\" href=\"#move-elimination\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u7279\u5b9a\u60c5\u51b5\u4e0b\u8fd9\u4e9b\u6307\u4ee4\u53ef\u4ee5\u88ab\u4f18\u5316\uff1amov reg, 0; mov reg, zero; mov vreg, 0; mov reg, reg;mov vreg, vreg</p>\n<p>\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5404\u79cd\u6a21\u5f0f\u7684 IPC \u5982\u4e0b\uff1a</p>\n<ul>\n<li>mov reg, 0: IPC 6</li>\n<li>mov vreg, 0: IPC 6</li>\n<li>mov reg, reg: \u65e0\u4f9d\u8d56\u94fe\u65f6 IPC 4</li>\n<li>mov vreg, vreg: \u65e0\u4f9d\u8d56\u94fe\u65f6 IPC 3.6</li>\n</ul>\n<p>\u867d\u7136\u505a\u4e86\u4f18\u5316\uff0c\u4f46\u7b97\u4e0d\u4e0a\u5f88\u5feb\u3002</p>\n<h3 id=\"reorder-buffer\">Reorder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>320 MOP</strong> ROB, 8-wide retire</p>\n<p>\u628a\u4e24\u4e2a\u4e32\u884c\u7684 fsqrt \u5e8f\u5217\u653e\u5728\u5faa\u73af\u7684\u5934\u548c\u5c3e\uff0c\u4e2d\u95f4\u7528 NOP \u586b\u5145\uff0c\u5982\u679c ROB \u8db3\u591f\u5927\uff0c\u53ef\u4ee5\u5728\u6267\u884c\u5f00\u5934\u4e32\u884c\u7684 fsqrt \u5e8f\u5217\u65f6\uff0c\u540c\u65f6\u6267\u884c\u7ed3\u5c3e\u4e32\u884c\u7684 fsqrt \u5e8f\u5217\uff0c\u6b64\u65f6\u6027\u80fd\u662f\u6700\u4f18\u7684\u3002\u5982\u679c ROB \u4e0d\u591f\u5927\uff0c\u90a3\u4e48\u4f1a\u89c2\u5bdf\u5230\u6027\u80fd\u4e0b\u964d\u3002\u7531\u4e8e Neoverse V2 \u6267\u884c NOP \u53ef\u4ee5\u8fbe\u5230\u63a5\u8fd1 12 \u7684 IPC\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u5f88\u5c11\u7684 fsqrt \u5c31\u8db3\u591f\u751f\u6210\u8db3\u591f\u7684\u5ef6\u8fdf\u3002</p>\n<p>\u901a\u8fc7\u6d4b\u8bd5\uff0c\u53d1\u73b0\u5728\u5927\u7ea6 640 \u6761 NOP \u65f6\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff0c\u800c Neoverse V2 \u5b9e\u73b0\u4e86 Instruction Fusion\uff0c\u4e24\u6761 NOP \u6307\u4ee4\u7b97\u505a\u4e00\u6761 uOP\uff0c\u540c\u65f6\u4e5f\u662f\u4e00\u6761 MOP\uff0c\u56e0\u6b64 640 \u6761 NOP \u5bf9\u5e94 320 MOP \u7684 ROB \u5927\u5c0f\u3002\u6781\u9650\u60c5\u51b5\u4e0b\uff0c320 MOP \u53ef\u4ee5\u5b58 640 uOP\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u6bd4\u8f83\u96be\u8fbe\u5230\uff0c\u5f88\u5bb9\u6613\u53d7\u9650\u4e8e\u5176\u4ed6\u7ed3\u6784\u3002</p>\n<h3 id=\"l1-dcache\">L1 DCache<a class=\"headerlink\" href=\"#l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>64KB</strong>, 4-way set associative, <strong>VIPT behaving as PIPT</strong>, 64B cacheline, ECC protected, RRIP replacement policy, <strong>4\u00d764-bit read paths</strong> and <strong>4\u00d764-bit write</strong> paths for the integer execute pipeline, <strong>3\u00d7128-bit read paths</strong> and <strong>2\u00d7128-bit</strong> write paths for the vector execute pipeline</p>\n<h4 id=\"\u5bb9\u91cf\">\u5bb9\u91cf<a class=\"headerlink\" href=\"#\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 64KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 64KB \u7684 L1 DCache \u5bb9\u91cf\u3002\u4e4b\u540e\u5ef6\u8fdf\u5148\u4e0a\u5347\u540e\u4e0b\u964d\uff0c\u4e0e ARM \u91c7\u7528\u7684 Correlated Miss Caching(CMC) \u9884\u53d6\u5668\u8bb0\u4f4f\u4e86 pointer chasing \u7684\u5386\u53f2\u6709\u5173\uff0c\u8be6\u7ec6\u53ef\u4ee5\u9605\u8bfb <a href=\"https://hc33.hotchips.org/assets/program/conference/day1/20210818_Hotchips_NeoverseN2.pdf\">Arm Neoverse N2: Arm\u2019s 2nd generation high performance infrastructure CPUs and system IPs</a>\u3002</p>\n<h4 id=\"\u5ef6\u8fdf\">\u5ef6\u8fdf<a class=\"headerlink\" href=\"#\u5ef6\u8fdf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0cL1 DCache \u7684 load to use latency \u662f 4 cycle\uff0c\u6ca1\u6709\u9488\u5bf9 pointer chasing \u505a 3 cycle \u7684\u4f18\u5316\u3002</p>\n<h4 id=\"\u541e\u5410\">\u541e\u5410<a class=\"headerlink\" href=\"#\u541e\u5410\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4f7f\u7528 FP/ASIMD 128b Load \u53ef\u4ee5\u8fbe\u5230 3 IPC\uff0c\u5bf9\u5e94\u4e86 3x128b read paths\uff1b\u800c\u5982\u679c\u4f7f\u7528 2x64b \u6574\u6570 LDP\uff0c\u5219\u53ea\u80fd\u8fbe\u5230 2 IPC\uff0c\u5bf9\u5e94 4x64b read paths\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8981\u8fbe\u5230\u5cf0\u503c\u7684\u8bfb\u53d6\u6027\u80fd\uff0c\u5fc5\u987b\u7528 FP/ASIMD \u6307\u4ee4\u3002\u5199\u5165\u65b9\u9762\uff0c\u5411\u91cf 128b Store \u53ef\u4ee5\u8fbe\u5230 2 IPC\uff0c\u5bf9\u5e94\u4e86 2x128b write paths\uff1b\u7c7b\u4f3c\u5730\uff0c2x64b \u6574\u6570 STP \u80fd\u8fbe\u5230 2 IPC\uff0c\u5bf9\u5e94 4x64b write paths\u3002</p>\n<h4 id=\"vipt\">VIPT<a class=\"headerlink\" href=\"#vipt\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 4KB page \u7684\u60c5\u51b5\u4e0b\uff0c64KB 4-way \u7684 L1 DCache \u4e0d\u6ee1\u8db3 VIPT \u7684 Index \u5168\u5728\u9875\u5185\u504f\u79fb\u7684\u6761\u4ef6\uff08\u8be6\u89c1 <a href=\"../../../../2023/12/08/vipt-l1-cache-page-size/\">VIPT \u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb</a>\uff09\uff0c\u6b64\u65f6\u8981\u4e48\u6539\u7528 PIPT\uff0c\u8981\u4e48\u5728 VIPT \u7684\u57fa\u7840\u4e0a\u5904\u7406 alias \u7684\u95ee\u9898\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e00\u70b9\uff0c\u53c2\u8003 <a href=\"https://blog.cyyself.name/why-the-big-l1-cache-is-so-hard/\">\u6d45\u8c08\u73b0\u4ee3\u5904\u7406\u5668\u5b9e\u73b0\u8d85\u5927 L1 Cache \u7684\u65b9\u5f0f</a> \u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u7528 shm \u6784\u9020\u51fa\u4e24\u4e2a 4KB \u865a\u62df\u9875\u6620\u5c04\u5230\u540c\u4e00\u4e2a\u7269\u7406\u9875\u7684\u60c5\u51b5\uff0c\u7136\u540e\u5728\u4e24\u4e2a\u865a\u62df\u9875\u4e4b\u95f4 copy\uff0c\u53d1\u73b0\u76f8\u6bd4\u5728\u540c\u4e00\u4e2a\u865a\u62df\u9875\u5185 copy \u6709\u663e\u8457\u7684\u6027\u80fd\u4e0b\u964d\uff0c\u5e76\u4e14\u4ea7\u751f\u4e86\u5927\u91cf\u7684 L1 DCache Refill\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>copy from aliased page = 3261121467 cycles, 285103870 refills\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>baseline = 1520692165 cycles, 1200 refills\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>slowdown = 2.14x\n</span></code></pre></div>\n<p>\u56e0\u6b64\u9a8c\u8bc1\u4e86 L1 DCache \u91c7\u7528\u7684\u662f VIPT\uff0c\u5e76\u505a\u4e86\u9488\u5bf9 alias \u7684\u6b63\u786e\u6027\u5904\u7406\u3002\u5982\u679c\u662f PIPT\uff0c\u90a3\u4e48 L1 DCache \u4f1a\u53d1\u73b0\u8fd9\u4e24\u4e2a\u9875\u5bf9\u5e94\u7684\u662f\u76f8\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u6027\u80fd\u4e0d\u4f1a\u4e0b\u964d\uff0c\u4e5f\u4e0d\u9700\u8981\u9891\u7e41\u7684 refill\u3002</p>\n<h4 id=\"\u6784\u9020\">\u6784\u9020<a class=\"headerlink\" href=\"#\u6784\u9020\" title=\"Permanent link\">&para;</a></h4>\n<p>\u8fdb\u4e00\u6b65\u5c1d\u8bd5\u7814\u7a76 Neoverse V2 \u7684 L1 DCache \u7684\u6784\u9020\uff0c\u4e3a\u4e86\u652f\u6301\u6bcf\u5468\u671f 3 \u6761 Load \u6307\u4ee4\uff0cL1 DCache \u901a\u5e38\u4f1a\u5206 Bank\uff0c\u6bcf\u4e2a Bank \u90fd\u6709\u81ea\u5df1\u7684\u8bfb\u53e3\u3002\u5982\u679c Load \u5206\u5e03\u5230\u4e0d\u540c\u7684 Bank \u4e0a\uff0c\u5404 Bank \u53ef\u4ee5\u540c\u65f6\u8bfb\u53d6\uff0c\u83b7\u5f97\u66f4\u9ad8\u7684\u6027\u80fd\uff1b\u5982\u679c Load \u547d\u4e2d\u76f8\u540c\u7684 Bank\uff0c\u4f46\u662f\u8bbf\u95ee\u7684 Bank \u5185\u5730\u5740\u4e0d\u540c\uff0c\u5c31\u53ea\u80fd\u7b49\u5230\u4e0b\u4e00\u4e2a\u5468\u671f\u518d\u8bfb\u53d6\u3002\u4e3a\u4e86\u6d4b\u8bd5 Bank \u7684\u6784\u9020\uff0c\u8bbe\u8ba1\u4e00\u7cfb\u5217\u4ee5\u4e0d\u540c\u7684\u56fa\u5b9a stride \u95f4\u9694\u7684 Load \u6307\u4ee4\uff0c\u89c2\u5bdf Load \u7684 IPC\uff1a</p>\n<ul>\n<li>Stride=1B/2B/4B/8B/16B/32B: IPC=3</li>\n<li>Stride=64B: IPC=2</li>\n<li>Stride=128B/256B/512B: IPC=1</li>\n</ul>\n<p>Stride=64B \u65f6\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff0c\u8bf4\u660e\u6b64\u65f6\u51fa\u73b0\u4e86 Bank Conflict\uff0c\u8fdb\u4e00\u6b65\u5230 Stride=128B \u65f6\uff0c\u53ea\u80fd\u8fbe\u5230 1 \u7684 IPC\uff0c\u8bf4\u660e\u6b64\u65f6\u6240\u6709\u7684 Load \u90fd\u547d\u4e2d\u4e86\u540c\u4e00\u4e2a Bank\uff0c\u5e76\u4e14\u662f\u4e32\u884c\u8bfb\u53d6\u3002\u6839\u636e\u8fd9\u4e2a\u73b0\u8c61\uff0c\u8ba4\u4e3a Neoverse V2 \u7684 L1 DCache \u7ec4\u7ec7\u65b9\u5f0f\u548c\u9650\u5236\u662f\uff1a</p>\n<ul>\n<li>\u4e00\u5171\u6709\u4e24\u4e2a Bank\uff0cBank Index \u662f VA[6]</li>\n<li>\u6bcf\u4e2a Bank \u6bcf\u5468\u671f\u53ef\u4ee5\u4ece\u4e00\u4e2a\u7f13\u5b58\u884c\u8bfb\u53d6\u6570\u636e</li>\n<li>\u652f\u6301\u591a\u4e2a Load \u8bbf\u95ee\u540c\u4e00\u4e2a\u7f13\u5b58\u884c</li>\n<li>\u5982\u679c\u591a\u4e2a Load \u8bbf\u95ee\u540c\u4e00\u4e2a Bank \u7684\u4e0d\u540c\u7f13\u5b58\u884c\uff0c\u53ea\u80fd\u4e00\u4e2a\u5468\u671f\u5b8c\u6210\u4e00\u4e2a Load</li>\n</ul>\n<p>\u8fd9\u91cc\u8ba8\u8bba\u7684\u662f\u7f13\u5b58\u884c\u7ea7\u522b\u7684 Bank\uff0c\u5b9e\u9645\u4e0a\u901a\u5e38\u7f13\u5b58\u884c\u5185\u90e8\u4e5f\u4f1a\u8fdb\u884c Bank \u5212\u5206\uff0c\u4f46\u4e3b\u8981\u662f\u4e3a\u4e86\u529f\u8017\uff0c\u6bd4\u5982\u4ece\u4e00\u4e2a 64B \u7f13\u5b58\u884c\u91cc\u8bfb\u53d6 8B \u6570\u636e\uff0c\u4e0d\u9700\u8981\u628a\u6574\u4e2a 64B \u90fd\u8bfb\u51fa\u6765\u3002</p>\n<h3 id=\"l1-dtlb\">L1 DTLB<a class=\"headerlink\" href=\"#l1-dtlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aCaches entries at the 4KB, 16KB, 64KB, 2MB or 512MB granularity, Fully associative, <strong>48</strong> entries. A miss in the L1 data TLB and a hit in the L2 TLB has a 6-cycle penalty compared to a hit in the L1 data TLB.</p>\n<p>\u7528 pointer chasing \u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../arm_neoverse_v2_l1dtlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 48 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 48 \u7684 L1 DTLB \u5bb9\u91cf\u3002\u8d85\u51fa\u5bb9\u91cf\u540e\uff0c\u9700\u8981\u989d\u5916\u7684 5 cycle \u7684 latency \u8bbf\u95ee L2 Unified TLB\u3002</p>\n<h3 id=\"l2-unified-tlb\">L2 Unified TLB<a class=\"headerlink\" href=\"#l2-unified-tlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1aShared by instructions and data, 8-way set associative, 2048 entries</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a1MB or 2MB, 8-way set associative, 4 banks, PIPT, ECC protected, 64B cacheline, 10 cycle load-to-use, 128 B/cycle</p>\n<h3 id=\"sve\">SVE<a class=\"headerlink\" href=\"#sve\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a128b SVE vector length</p>\n<p>\u5728 Linux \u4e0b\u67e5\u770b <code>/proc/sys/abi/sve_default_vector_length</code> \u7684\u5185\u5bb9\uff0c\u5f97\u5230 SVE \u5bbd\u5ea6\u4e3a 16 \u5b57\u8282\uff0c\u4e5f\u5c31\u662f 128b\u3002</p>\n<p>\u5b9e\u6d4b\u53d1\u73b0 Neoverse V2 \u6bcf\u5468\u671f\u6700\u591a\u53ef\u4ee5\u6267\u884c 4 \u6761 ASIMD \u6216 SVE \u7684\u6d6e\u70b9 FMA \u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u5468\u671f\u6d6e\u70b9\u5cf0\u503c\u6027\u80fd\uff1a</p>\n<ul>\n<li>\u5355\u7cbe\u5ea6\uff1a<code>128/32*2*4=32</code> FLOP per cycle</li>\n<li>\u53cc\u7cbe\u5ea6\uff1a<code>128/64*2*4=16</code> FLOP per cycle</li>\n</ul>\n<p>\u4e0e Zen 2-4\u3001Oryon\u3001Firestorm\u3001LA464\u3001Haswell \u7b49\u5fae\u67b6\u6784\u770b\u9f50\uff0c\u4f46\u4e0d\u53ca Zen 5\u3001Skylake \u7b49\u901a\u8fc7 AVX512 \u63d0\u4f9b\u7684\u5cf0\u503c\u6d6e\u70b9\u6027\u80fd\u3002</p>", "image": null, "date_modified": "2024-11-07T00:00:00+00:00", "authors": [], "tags": ["arm", "cpu", "hardware", "neoverse", "performance", "uarch-review"]}, {"id": "https://jia.je/software/2024/10/23/linux-core-scheduling/", "url": "https://jia.je/software/2024/10/23/linux-core-scheduling/", "title": "Linux \u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76", "content_html": "<h1 id=\"linux-\u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76\">Linux \u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76<a class=\"headerlink\" href=\"#linux-\u5927\u5c0f\u6838\u7684\u8c03\u5ea6\u7b97\u6cd5\u63a2\u7a76\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u770b\u5230\u4e00\u4e9b\u5173\u4e8e Linux \u5927\u5c0f\u6838\u8c03\u5ea6\u7b97\u6cd5\u7684\u4e00\u4e9b\u535a\u5ba2\uff0c\u8003\u8651\u5230\u5927\u5c0f\u6838\u76ee\u524d\u5df2\u7ecf\u6bd4\u8f83\u5e38\u89c1\u4e86\uff0c\u56e0\u6b64\u505a\u4e00\u4e9b\u73b0\u72b6\u7684\u63a2\u7a76\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u73b0\u8c61\">\u73b0\u8c61<a class=\"headerlink\" href=\"#\u73b0\u8c61\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"intel\">Intel<a class=\"headerlink\" href=\"#intel\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u53ef\u4ee5\u505a\u4e00\u4e0b\u5b9e\u9a8c\uff0c\u7528 <code>stress --cpu N</code> \u542f\u52a8 N \u4e2a\u8ba1\u7b97\u8d1f\u8f7d\uff0c\u770b\u770b\u8fd9\u4e9b\u7ebf\u7a0b\u90fd\u4f1a\u88ab\u5206\u914d\u5230\u54ea\u4e9b\u6838\u4e0a\u3002\u5728 Intel Core i9-14900K \u4e0a\u5b9e\u9a8c\uff0c\u8fd9\u4e2a CPU \u662f 8P+16E\uff0c8P \u5bf9\u5e94 0-15 \u6838\uff0c\u8d85\u7ebf\u7a0b\u7684\u6838\u7684 ID \u662f\u8fde\u53f7\u7684\uff0c16E \u5bf9\u5e94 16-31 \u6838\uff0c\u89c2\u5bdf\u5230\u4e0b\u9762\u7684\u7ed3\u679c\uff1a</p>\n<ul>\n<li><code>N=1</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 12-15 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c\u8fd9\u5bf9\u5e94\u7684\u662f 8P \u4e2d\u7684\u6700\u540e 2P</li>\n<li><code>N=2</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 12-13 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c\u4ee5\u53ca 14-15 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c\u540c\u6837\u4e5f\u662f 8P \u4e2d\u7684\u6700\u540e 2P\uff0c\u6bcf\u4e2a P \u4e0a\u5206\u914d\u4e00\u4e2a\u4efb\u52a1</li>\n<li><code>N=3</code> \u65f6\uff0c\u5728 <code>N=2</code> \u7684\u57fa\u7840\u4e0a\uff0c\u5728 0-11 \u6838\u91cc\u518d\u8c03\u5ea6\u4e00\u4e2a</li>\n<li><code>N=4..=8</code> \u65f6\uff0c\u5728 <code>N=2</code> \u7684\u57fa\u7840\u4e0a\uff0c\u5728 0-11 \u6838\u91cc\u8c03\u5ea6\u5269\u4e0b\u7684\u4efb\u52a1\uff0c\u4f46\u4e0d\u4f1a\u5206\u914d\u5230\u4e00\u4e2a P \u6838\u7684\u4e24\u4e2a\u903b\u8f91\u6838\u4e0a</li>\n<li><code>N=9..=24</code> \u65f6\uff0c\u5728 <code>N=8</code> \u7684\u57fa\u7840\u4e0a\uff0c\u5728 16-31 \u6838\u91cc\u8c03\u5ea6\u5269\u4e0b\u7684\u4efb\u52a1</li>\n<li><code>N=25..=32</code> \u65f6\uff0c\u5728 <code>N=24</code> \u7684\u57fa\u7840\u4e0a\uff0c\u628a\u4efb\u52a1\u5206\u914d\u5230 P \u6838\u7684\u7b2c\u4e8c\u4e2a\u903b\u8f91\u6838\u4e0a</li>\n</ul>\n<p>\u53ef\u89c1\u5728\u8c03\u5ea6\u65f6\uff0c\u6309\u7167\u5982\u4e0b\u7684\u4f18\u5148\u7ea7\uff1a</p>\n<ol>\n<li>\u6700\u540e 2 \u4e2a P \u6838</li>\n<li>\u5176\u4f59 6 \u4e2a P \u6838</li>\n<li>E \u6838</li>\n<li>P \u6838\u7684\u8d85\u7ebf\u7a0b</li>\n</ol>\n<p>\u53ef\u89c1 P \u6838\u5185\u90e8\u4e5f\u6709\u4f18\u5148\u7ea7\u4e0d\u540c\uff0c\u6700\u540e 2 \u4e2a P \u6838\u5177\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\uff0c\u800c\u5b83\u4eec\u7684 Boost \u9891\u7387\u786e\u5b9e\u4e5f\u66f4\u9ad8\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"m\">5700000</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/sys/devices/system/cpu/cpufreq/policy12/scaling_max_freq\n</span><span id=\"__span-0-4\"><a id=\"__codelineno-0-4\" name=\"__codelineno-0-4\" href=\"#__codelineno-0-4\"></a><span class=\"m\">6000000</span>\n</span></code></pre></div>\n<p>6 \u4e2a P \u6838\u7684\u6700\u5927\u9891\u7387\u8bbe\u5b9a\u4e3a 5.7 GHz\uff0c2 \u4e2a P \u6838\u7684\u6700\u5927\u9891\u7387\u8bbe\u5b9a\u4e3a 6.0 GHz\u3002\u56e0\u6b64\u8fd9\u4e24\u4e2a 6.0 GHz \u7684 P \u6838\u4f1a\u88ab\u4f18\u5148\u8c03\u5ea6\u3002\u6b64\u65f6\u518d\u6765\u770b <a href=\"https://www.intel.com/content/www/us/en/products/sku/236773/intel-core-i9-processor-14900k-36m-cache-up-to-6-00-ghz/specifications.html\">Intel\u00ae Core\u2122 i9 processor 14900K Spec</a>:</p>\n<ul>\n<li>Max Turbo Frequency: 6 GHz</li>\n<li>Intel\u00ae Thermal Velocity Boost Frequency: 6 GHz</li>\n<li>Intel\u00ae Turbo Boost Max Technology 3.0 Frequency: 5.8 GHz</li>\n<li>Performance-core Max Turbo Frequency: 5.6 GHz</li>\n<li>Performance-core Base Frequency: 3.2 GHz</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b98\u65b9\u5ba3\u4f20\u7684\u6700\u9ad8 Turbo \u9891\u7387\u662f 6 GHz\uff0c\u4f46\u5b9e\u9645\u4e0a\u53ea\u6709\u4e24\u4e2a P \u6838\u53ef\u4ee5\u8fbe\u5230\u3002</p>\n<p>\u4f46\u5e76\u975e\u6240\u6709\u5e73\u53f0\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u90fd\u80fd\u8fbe\u5230\u5ba3\u79f0\u7684\u6700\u9ad8\u9891\u7387\u7684\u3002\u4f8b\u5982\u5728 Dell R730 \u4e0a\uff0cXeon E5-2680 v4 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u53ea\u80fd\u8fbe\u5230 2.9 GHz \u7684 Boost \u9891\u7387\uff0c\u4f46\u6309\u7167 Intel \u5b98\u7f51\uff0c\u8fd9\u4e2a CPU \u7684 Boost \u6700\u9ad8\u53ef\u4ee5\u8fbe\u5230 3.3 GHz\u3002\u5f53\u7136\u4e86\uff0c2.9 GHz \u662f\u5168\u6838\u80fd\u591f\u8fbe\u5230\u7684 Boost\uff0c3.3 GHz \u53ea\u80fd\u5c11\u6570\u7684\u6838\u8fbe\u5230\uff0c\u800c\u670d\u52a1\u5668\u573a\u666f\u4e0b\uff0c\u5927\u591a\u65f6\u95f4\u662f\u8dd1\u591a\u6838\u8d1f\u8f7d\uff0c\u9650\u5236\u5230 2.9 GHz \u4e5f\u53ef\u4ee5\u7406\u89e3\u3002\u5982\u679c\u60f3\u8981 3.3 GHz\uff0c\u5c31\u9700\u8981\u8fdb BIOS \u8bbe\u7f6e\uff0c\u628a\u8c03\u9891\u4ea4\u7ed9 OS\uff0cC-State \u4e5f\u5168\u90e8\u653e\u5f00\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5b9e\u73b0 3.3 GHz \u4e86\u3002\u8fd9\u91cc\u6bd4\u8f83\u91cd\u8981\u7684\u662f\u8981\u6253\u5f00 C6\uff0c\u56e0\u4e3a\u628a\u7a7a\u95f2\u7684\u6838\u653e\u5230 C6 \u4ee5\u540e\uff0c\u624d\u80fd\u628a\u5355\u6838\u8dd1\u5230\u6700\u9ad8\u7684\u9891\u7387\u3002</p>\n<h3 id=\"amd\">AMD<a class=\"headerlink\" href=\"#amd\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 AMD Ryzen 9 9950X \u4e0a\u8fdb\u884c\u7c7b\u4f3c\u7684\u5b9e\u9a8c\uff0c\u8fd9\u4e2a CPU \u6709 16 \u4e2a\u6838\uff0c0 \u6838\u548c 16 \u6838\u5bf9\u5e94\u4e00\u4e2a\u7269\u7406\u6838\uff0c\u5176\u4ed6\u4f9d\u6b64\u7c7b\u63a8\uff0c0-7 \u662f\u4e00\u4e2a CCD\uff0c8-15 \u662f\u53e6\u4e00\u4e2a CCD\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<ul>\n<li><code>N=1</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 4\uff0c9 \u548c 20 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=2</code> \u65f6\uff0c\u4e3b\u8981\u8c03\u5ea6\u5230 0 \u548c 16 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a\uff0c9 \u548c 25 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=3</code> \u65f6\uff0c\u5728 <code>N=2</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 4 \u548c 20 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=4</code> \u65f6\uff0c\u5728 <code>N=3</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 11 \u548c 27 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=5</code> \u65f6\uff0c\u5728 <code>N=4</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 5 \u548c 21 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=6</code> \u65f6\uff0c\u5728 <code>N=5</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 8 \u548c 24 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=7</code> \u65f6\uff0c\u5728 <code>N=6</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 3 \u548c 19 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n<li><code>N=8</code> \u65f6\uff0c\u5728 <code>N=7</code> \u7684\u57fa\u7840\u4e0a\uff0c\u8c03\u5ea6\u5230 10 \u548c 26 \u6838\u91cc\u5176\u4e2d\u4e00\u4e2a</li>\n</ul>\n<p>\u67e5\u770b\u5b83\u4eec\u7684 <code>scaling_max_freq</code>\uff0c\u4f1a\u53d1\u73b0\u90fd\u662f\u76f8\u540c\u7684 5.752 GHz\u3002\u67e5\u770b\u5b83\u4eec\u7684 <code>amd_pstate_prefcore_ranking</code>\uff0c\u53d1\u73b0\u53d6\u503c\u548c\u903b\u8f91\u6838\u7684\u6620\u5c04\u5173\u7cfb\uff1a</p>\n<ul>\n<li>236: 0,4,16,20</li>\n<li>231: 5,21</li>\n<li>226: 3,19</li>\n<li>221: 1,17</li>\n<li>216: 2,18</li>\n<li>211: 7,23</li>\n<li>206: 6,22</li>\n<li>201: 9,25</li>\n<li>196: 11,27</li>\n<li>191: 8,24</li>\n<li>186: 10,26</li>\n<li>181: 12,28</li>\n<li>176: 13,29</li>\n<li>171: 15,31</li>\n<li>166: 14,30</li>\n</ul>\n<p>\u6309\u7406\u8bf4\u503c\u8d8a\u5927\u7684\uff0c\u8d8a\u5e94\u8be5\u5148\u88ab\u8c03\u5ea6\uff0c\u5e94\u8be5\u6309 0-&gt;4-&gt;5-&gt;3 \u7684\u987a\u5e8f\u5206\u914d\uff0c\u4f46\u5b9e\u9645\u4e0a\u89c2\u5bdf\u7684\u7ed3\u679c\u5e76\u4e0d\u662f\u8fd9\u6837\u3002\u5bfb\u627e\u89c4\u5f8b\uff0c\u53d1\u73b0\u5b83\u5148\u4ece\u7b2c\u4e00\u4e2a CCD \u627e\u5230\u5206\u6570\u6700\u9ad8\u7684\uff0c\u518d\u4ece\u7b2c\u4e8c\u4e2a CCD \u627e\uff0c\u518d\u56de\u5230\u7b2c\u4e00\u4e2a CCD \u627e\u5206\u6570\u7b2c\u4e8c\u9ad8\u7684\uff0c\u4f9d\u6b64\u7c7b\u63a8\uff1a</p>\n<ol>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u6700\u9ad8\u7684\u6838\uff1a0</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u6700\u9ad8\u7684\u6838\uff1a9</li>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u7b2c\u4e8c\u9ad8\u7684\u6838\uff1a4</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u7b2c\u4e8c\u9ad8\u7684\u6838\uff1a11</li>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u7b2c\u4e09\u9ad8\u7684\u6838\uff1a5</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u7b2c\u4e09\u9ad8\u7684\u6838\uff1a8</li>\n<li>\u627e\u7b2c\u4e00\u4e2a CCD \u5206\u6570\u7b2c\u56db\u9ad8\u7684\u6838\uff1a3</li>\n<li>\u627e\u7b2c\u4e8c\u4e2a CCD \u5206\u6570\u7b2c\u56db\u9ad8\u7684\u6838\uff1a10</li>\n</ol>\n<p>\u8bf4\u660e\u5b83\u7684\u903b\u8f91\u662f\uff0c\u8f6e\u6d41\u4ece\u4e24\u4e2a CCD \u4e2d\u53d6\u51fa\u4e00\u4e2a\u5206\u6570\u5c3d\u91cf\u9ad8\u7684\u6838\u53bb\u5206\u914d\u8d1f\u8f7d\u3002\u5b9e\u9645\u6d4b\u4e0b\u6765\uff0c\u5206\u6570\u9ad8\u7684\u6838\u4e5f\u786e\u5b9e\u80fd\u591f Boost \u5230\u66f4\u9ad8\u7684\u9891\u7387\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>$<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>i<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">$(</span>seq<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">15</span><span class=\"k\">)</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"s2\">&quot;</span><span class=\"nv\">$i</span><span class=\"s2\">:&quot;</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span>numactl<span class=\"w\"> </span>-C<span class=\"w\"> </span><span class=\"nv\">$i</span><span class=\"w\"> </span>perf<span class=\"w\"> </span>stat<span class=\"w\"> </span>-e<span class=\"w\"> </span>cycles,task-clock<span class=\"w\"> </span>stress<span class=\"w\"> </span>--cpu<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>--timeout<span class=\"w\"> </span>1s<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>GHz<span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span>sleep<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">done</span>\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a><span class=\"m\">0</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,700,258,748<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.717 GHz</span>\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a><span class=\"m\">1</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,642,814,521<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.659 GHz</span>\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a><span class=\"m\">2</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,648,004,395<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.665 GHz</span>\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a><span class=\"m\">3</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,663,175,321<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.680 GHz</span>\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a><span class=\"m\">4</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,687,251,660<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.704 GHz</span>\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a><span class=\"m\">5</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,667,947,179<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.685 GHz</span>\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a><span class=\"m\">6</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,595,919,881<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.613 GHz</span>\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a><span class=\"m\">7</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,599,885,078<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.617 GHz</span>\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a><span class=\"m\">8</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,424,861,894<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.441 GHz</span>\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a><span class=\"m\">9</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,427,318,403<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.443 GHz</span>\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a><span class=\"m\">10</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,422,689,654<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.439 GHz</span>\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a><span class=\"m\">11</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,425,760,950<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.442 GHz</span>\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a><span class=\"m\">12</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,418,583,254<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.435 GHz</span>\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a><span class=\"m\">13</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,425,842,189<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.442 GHz</span>\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a><span class=\"m\">14</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,375,985,781<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.392 GHz</span>\n</span><span id=\"__span-1-17\"><a id=\"__codelineno-1-17\" name=\"__codelineno-1-17\" href=\"#__codelineno-1-17\"></a><span class=\"m\">15</span>:<span class=\"w\">     </span><span class=\"m\">5</span>,377,887,646<span class=\"w\">      </span>cycles:u<span class=\"w\">                         </span><span class=\"c1\">#    5.394 GHz</span>\n</span></code></pre></div>\n<p>\u5206\u6570\u9ad8\u7684\u53ef\u4ee5\u51b2\u5230 5.7 GHz\uff0c\u5206\u6570\u4f4e\u4e00\u4e9b\u7684\u5c31\u53ea\u80fd\u5230 5.4 GHz \u4e86\u3002</p>\n<p>\u6ce8\uff1a\u6839\u636e David Huang \u63d0\u4f9b\u7684\u4fe1\u606f\uff0cAMD \u7684 Linux \u5185\u6838\u7ef4\u62a4\u8005\u5df2\u7ecf\u63d0\u4ea4 <a href=\"https://lore.kernel.org/lkml/20241203201129.31957-1-mario.limonciello@amd.com/\">Patch</a> \u6765\u4fee\u6539\u8fd9\u4e2a\u884c\u4e3a\uff0c\u4f7f\u5f97\u8fdb\u7a0b\u5c3d\u91cf\u8c03\u5ea6\u5230\u5206\u6570\u66f4\u9ad8\u7684\u6838\uff0c\u65e0\u8bba\u5b83\u5728\u54ea\u4e2a CCD\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5373\u4f7f\u4e0d\u7ed1\u6838\uff0c\u4e5f\u53ef\u4ee5\u4fdd\u8bc1\u5355\u6838\u8d1f\u8f7d\u4f1a\u7a33\u5b9a\u8dd1\u5728\u9891\u7387\u6700\u9ad8\u7684\u6838\u4e0a\u3002</p>\n<h3 id=\"qualcomm\">Qualcomm<a class=\"headerlink\" href=\"#qualcomm\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6700\u540e\u518d\u770b\u4e00\u4e0b Qualcomm X1E80100 \u5e73\u53f0\uff0c\u8fd9\u4e2a\u5e73\u53f0\u6709\u4e09\u4e2a Cluster\uff1a0-3\uff0c4-7 \u548c 8-11 \u662f\u4e09\u4e2a Cluster\u3002\u5176\u4e2d\u540e\u4e24\u4e2a Cluster \u7684\u6bcf\u4e2a Cluster \u53ef\u4ee5\u652f\u6301\u5176\u4e2d\u4e00\u4e2a\u6838\u5fc3\u4ece 3.4 GHz Boost \u5230 4.0 GHz\uff0c\u52a0\u8d77\u6765\u5c31\u662f\u6700\u591a\u4e24\u4e2a\u6838\u5fc3 Boost \u5230 4.0 GHz\u3002\u6253\u4e0a <a href=\"https://patchew.org/linux/20240612124056.39230-1-quic._5Fsibis@quicinc.com/\">cpufreq</a> \u7684\u8865\u4e01\u540e\uff0c\u5185\u6838\u901a\u8fc7 scmi \u63a5\u53e3\u5f97\u5230\u4e86\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>/sys/devices/system/cpu/cpufreq/policy*/scaling_max_freq\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"m\">3417600</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"m\">4012800</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"m\">4012800</span>\n</span></code></pre></div>\n<p>\u4f46\u5b9e\u9645\u8c03\u5ea6\u8d77\u6765\uff0c\u5404\u4e2a\u6838\u5fc3\u4e71\u8dd1\uff0c\u800c 3.4 GHz \u8ddd\u79bb 4.0 GHz \u5dee\u8ddd\u4e0d\u5c0f\uff0c\u6027\u80fd\u5dee\u63a5\u8fd1 15%\uff0c\u53ef\u89c1\u76ee\u524d Linux \u5185\u6838\u5e76\u6ca1\u6709\u5f88\u597d\u5730\u9002\u914d\uff0c\u76ee\u524d\u8fd8\u662f\u9700\u8981\u624b\u52a8\u7ed1\u6838\u3002\u9ad8\u901a\u76ee\u524d\u8fd8\u63d0\u4ea4\u4e86 <a href=\"https://patchwork.kernel.org/project/linux-arm-msm/list/?series=867688&amp;state=*\">memlat govenor</a> \u8865\u4e01\u6765\u5bf9 LLC/DDR \u6765\u8fdb\u884c DVFS\uff0c\u4f46\u5bf9\u8fd9\u4e2a\u95ee\u9898\u5e94\u8be5\u6ca1\u6709\u6539\u8fdb\u3002</p>\n<h2 id=\"\u5206\u6790\">\u5206\u6790<a class=\"headerlink\" href=\"#\u5206\u6790\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a5\u4e0b\u6765\u5c31\u8981\u8fdb\u5165\u5230 Linux \u6e90\u7801\uff0c\u627e\u5230 Linux \u662f\u5982\u4f55\u5904\u7406\u8fd9\u4e9b\u8c03\u5ea6\u4f18\u5148\u7ea7\u7684\uff0c\u8fd9\u4e9b\u4f18\u5148\u7ea7\u662f\u8c01\u786e\u5b9a\u7684\uff0c\u53c8\u662f\u600e\u4e48\u4f20\u9012\u5230 Linux \u5185\u6838\uff0c\u53c8\u662f\u600e\u4e48\u53c2\u4e0e\u5230\u8c03\u5ea6\u7684\u5462\uff1f</p>\n<h3 id=\"intel-itmt\">Intel ITMT<a class=\"headerlink\" href=\"#intel-itmt\" title=\"Permanent link\">&para;</a></h3>\n<p>\u9996\u5148\u6765\u770b\u4e00\u4e0b Intel \u7684\u8865\u4e01\uff1a<a href=\"https://lore.kernel.org/lkml/cover.1479844244.git.tim.c.chen@linux.intel.com/\">Support Intel Turbo Boost Max Technology 3.0</a>\uff0c\u8fd9\u4e2a patch \u505a\u4e86\u8fd9\u4e9b\u4e8b\u60c5\uff1a</p>\n<ol>\n<li><a href=\"https://lore.kernel.org/lkml/0998b98943bcdec7d1ddd4ff27358da555ea8e92.1479844244.git.tim.c.chen@linux.intel.com/\">PATCH v8 8/8</a>: \u8bfb\u53d6 ACPI \u7684 CPPC \u4fe1\u606f\uff0c\u5f97\u5230\u6bcf\u4e2a\u6838\u5fc3\u7684 highest_perf\uff0c\u6839\u636e highest_perf\uff0c\u8bbe\u7f6e\u903b\u8f91\u6838\u7684\u8c03\u5ea6\u4f18\u5148\u7ea7\uff1a<code>sched_set_itmt_core_prio(cppc_perf.highest_perf, cpu);</code></li>\n<li><a href=\"https://lore.kernel.org/lkml/0e73ae12737dfaafa46c07066cc7c5d3f1675e46.1479844244.git.tim.c.chen@linux.intel.com/\">PATCH v8 1/8</a>: \u4fee\u6539\u8c03\u5ea6\u5668\uff0c\u8ba9\u5b83\u5c0a\u91cd arch_asym_cpu_priority \u51fd\u6570\u8ba1\u7b97\u51fa\u6765\u7684\u4f18\u5148\u7ea7\uff0c\u800c\u4e0d\u662f\u6309\u7167\u6838\u5fc3\u7f16\u53f7\u4ece\u5c0f\u5230\u5927</li>\n<li><a href=\"https://lore.kernel.org/lkml/cd401ccdff88f88c8349314febdc25d51f7c48f7.1479844244.git.tim.c.chen@linux.intel.com/\">PATCH v8 3/8</a>: \u5b9e\u73b0 arch_asym_cpu_priority\uff0c\u5982\u679c\u4e00\u4e2a\u7269\u7406\u6838\u5bf9\u5e94 n \u4e2a\u903b\u8f91\u6838\uff0c\u90a3\u4e48\u7b2c\u4e00\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u4e58\u4ee5 n/1\uff0c\u7b2c\u4e8c\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u4e58\u4ee5 n/2\uff0c\u4f9d\u6b21\u7c7b\u63a8\u3002</li>\n</ol>\n<p>\u7b80\u800c\u8a00\u4e4b\uff0c\u4ece ACPI \u4e2d\u83b7\u53d6 CPPC \u4fe1\u606f\uff0c\u628a CPPC \u7684 Highest Perf \u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7269\u7406\u6838\u7684\u4f18\u5148\u7ea7\uff0c\u518d\u6839\u636e\u7269\u7406\u6838\u7684\u4f18\u5148\u7ea7\u8ba1\u7b97\u6bcf\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\uff0c\u5982\u679c\u662f 2-SMT\uff0c\u90a3\u5c31\u662f\u7b2c\u4e00\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u7ffb\u500d\uff0c\u7b2c\u4e8c\u4e2a\u903b\u8f91\u6838\u7684\u4f18\u5148\u7ea7\u4e0d\u53d8\u3002\u4f46\u8fd9\u4e2a\u65b9\u6cd5\u6709\u5c40\u9650\u6027\uff0c\u5c31\u662f\u8981\u6c42 E \u6838\u7684\u4f18\u5148\u7ea7\u4ecb\u4e8e P \u6838\u7684\u4e24\u4e2a\u4f18\u5148\u7ea7\u4e4b\u95f4\uff0c\u8bbe\u7f6e\u8d77\u6765\u6bd4\u8f83\u522b\u626d\u3002\u540e\u6765\u9488\u5bf9 SMT \u7684\u5904\u7406\u88ab\u96c6\u6210\u5230\u4e86\u8c03\u5ea6\u5668\u5f53\u4e2d\uff0c\u56e0\u6b64\u4ece itmt \u7684\u89c6\u89d2\u6765\u770b\uff0c\u4e0d\u9700\u8981\u9488\u5bf9 SMT \u8fdb\u884c\u7279\u6b8a\u5904\u7406\uff0cSMT \u7684\u6838\u8bbe\u7f6e\u4e3a\u540c\u4e00\u4e2a\u4f18\u5148\u7ea7\u5373\u53ef\uff1a<a href=\"https://github.com/torvalds/linux/commit/046a5a95c3b0425cfe79e43021d8ee90c1c4f8c9\">x86/sched/itmt: Give all SMT siblings of a core the same priority</a>\u3002</p>\n<p>\u5728 Intel i9-14900K \u5e73\u53f0\u4e0a\uff0c\u65e0\u8bba\u5927\u5c0f\u6838\uff0cHighest Perf \u90fd\u7b49\u4e8e 255\uff0c\u6b64\u65f6\u65e0\u6cd5\u901a\u8fc7 Highest Perf \u6765\u533a\u5206\u6838\u5fc3\u7684\u4f53\u8d28\uff0c\u6b64\u65f6\u4f1a\u89e6\u53d1\u4e0b\u9762\u7684<a href=\"https://github.com/torvalds/linux/blob/c2ee9f594da826bea183ed14f2cc029c719bf4da/drivers/cpufreq/intel_pstate.c#L363-L371\">\u4ee3\u7801</a>\uff1a</p>\n<div class=\"language-cpp highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"cm\">/*</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"cm\"> * If CPPC is not available, fall back to MSR_HWP_CAPABILITIES bits [8:0].</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"cm\"> *</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"cm\"> * Also, on some systems with overclocking enabled, CPPC.highest_perf is</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"cm\"> * hardcoded to 0xff, so CPPC.highest_perf cannot be used to enable ITMT.</span>\n</span><span id=\"__span-3-6\"><a id=\"__codelineno-3-6\" name=\"__codelineno-3-6\" href=\"#__codelineno-3-6\"></a><span class=\"cm\"> * Fall back to MSR_HWP_CAPABILITIES then too.</span>\n</span><span id=\"__span-3-7\"><a id=\"__codelineno-3-7\" name=\"__codelineno-3-7\" href=\"#__codelineno-3-7\"></a><span class=\"cm\"> */</span>\n</span><span id=\"__span-3-8\"><a id=\"__codelineno-3-8\" name=\"__codelineno-3-8\" href=\"#__codelineno-3-8\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">cppc_perf</span><span class=\"p\">.</span><span class=\"n\">highest_perf</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">CPPC_MAX_PERF</span><span class=\"p\">)</span>\n</span><span id=\"__span-3-9\"><a id=\"__codelineno-3-9\" name=\"__codelineno-3-9\" href=\"#__codelineno-3-9\"></a><span class=\"w\">    </span><span class=\"n\">cppc_perf</span><span class=\"p\">.</span><span class=\"n\">highest_perf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">HWP_HIGHEST_PERF</span><span class=\"p\">(</span><span class=\"n\">READ_ONCE</span><span class=\"p\">(</span><span class=\"n\">all_cpu_data</span><span class=\"p\">[</span><span class=\"n\">cpu</span><span class=\"p\">]</span><span class=\"o\">-&gt;</span><span class=\"n\">hwp_cap_cached</span><span class=\"p\">));</span>\n</span></code></pre></div>\n<p>\u67e5\u770b\u5404\u4e2a\u6838\u5fc3\u4e0a MSR_HWP_CAPABILITIES MSR \u8bb0\u5f55\u7684 Highest Perf \u503c\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"k\">for</span><span class=\"w\"> </span>i<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">$(</span>seq<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">31</span><span class=\"k\">)</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span>sudo<span class=\"w\"> </span>turbostat<span class=\"w\"> </span>-c<span class=\"w\"> </span><span class=\"nv\">$i</span><span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>--interval<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>MSR_HWP_CAPABILITIES<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">done</span>\n</span></code></pre></div>\n<p>\u53d1\u73b0\u540e\u4e24\u4e2a P \u6838\u7684 highest perf \u662f 77\uff0c\u5176\u4ed6 P \u6838\u7684 highest perf \u662f 73\uff0cE \u6838\u7684 highest perf \u662f 44\u3002\u56e0\u6b64 Linux \u7684\u8c03\u5ea6\u7b56\u7565\u5c31\u51fa\u6765\u4e86\uff1a\u5148\u662f\u540e\u4e24\u4e2a P \u6838\uff0c\u518d\u662f\u5176\u4ed6 P \u6838\uff0c\u7136\u540e\u662f E \u6838\uff0c\u6700\u540e\u662f SMT \u51fa\u6765\u7684\u903b\u8f91\u6838\u3002</p>\n<h3 id=\"acpi-cppc\">ACPI CPPC<a class=\"headerlink\" href=\"#acpi-cppc\" title=\"Permanent link\">&para;</a></h3>\n<p>\u63a5\u4e0b\u6765\uff0c\u67e5\u770b ACPI \u7684 CPPC \u4fe1\u606f\u4fdd\u5b58\u4e86\u4ec0\u4e48\u3002<a href=\"https://uefi.org/specs/ACPI/6.5/08_Processor_Configuration_and_Control.html?highlight=cppc#collaborative-processor-performance-control\">CPPC</a> \u5168\u79f0\u662f Collaborative Processor Performance Control\uff0c\u662f\u5bf9\u5df2\u6709\u7684 P State \u7684\u6539\u8fdb\uff0c\u539f\u6765\u7684 P State \u662f\u5206\u7acb\u7684\u51e0\u4e2a\u914d\u7f6e\uff0c\u53ef\u9009\u9879\u6bd4\u8f83\u5c11\uff0cCPPC \u5bf9\u6027\u80fd\u505a\u4e86\u62bd\u8c61\uff0c\u6bcf\u4e2a\u6838\u5fc3\u53ef\u4ee5\u6709 Highest Performance\uff0cNominal Performance\uff0cLowest Nonlinear Performance \u548c Lowest Performance \u8fd9\u51e0\u4e2a\u503c\uff0c\u6027\u80fd\u53ef\u4ee5\u5728\u8fd9\u4e9b\u503c\u4e4b\u95f4\u6d6e\u52a8\u3002\u7b80\u5355\u6765\u8bf4\uff0cHighest \u5bf9\u5e94\u5355\u6838 Boost \u5230\u7684\u6700\u9ad8\u6027\u80fd\uff0cNominal \u5bf9\u5e94\u5168\u6838\u80fd\u8fbe\u5230\u7684\u6027\u80fd\uff0cLowest \u5bf9\u5e94\u6700\u4f4e\u9891\u4e0b\u7684\u6027\u80fd\uff0cLowest Nonlinear \u4ee3\u8868\u6027\u80fd\u529f\u8017\u6bd4\u7ebf\u6027\u7684\u754c\u9650\uff0c\u5f80\u4e0b\u6027\u80fd\u6838\u529f\u8017\u662f\u7ebf\u6027\u7684\uff0c\u5f80\u4e0a\u6027\u80fd\u529f\u8017\u6bd4\u4f1a\u4e0b\u964d\u3002OS \u53ef\u4ee5\u8bbe\u5b9a\u60f3\u8981\u7684\u6027\u80fd\u8303\u56f4\uff1aMinimum \u548c Maximum Perf\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u60f3\u8981\u7684\u6027\u80fd Desired Performance\u3002\u5f53\u7136\u4e86\uff0c\u786c\u4ef6\u4e5f\u4e0d\u4e00\u5b9a\u80fd\u591f\u8fbe\u5230 Highest Perf\uff0c\u5f53\u524d\u80fd\u4fdd\u8bc1\u8fbe\u5230\u7684\u6700\u9ad8\u6027\u80fd\u53eb\u505a Guaranteed Perf\u3002\u6b64\u5916\u8fd8\u6709 Energy Performance Preference (EPP)\uff0cOS \u544a\u8bc9\u786c\u4ef6\uff0c\u6211\u60f3\u8981\u80fd\u6548\u8fd8\u662f\u6027\u80fd\uff0c\u6700\u5c0f\u7684 0 \u8868\u793a\u6027\u80fd\uff0c\u6700\u5927\u7684 255 \u8868\u793a\u80fd\u6548\u3002</p>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u786c\u4ef6\u544a\u8bc9 OS \u4e94\u4e2a\u503c\uff1aHighest Perf\uff0cNominal Perf\uff0cLowest Nonlinear Perf\uff0cLowest Perf \u548c Guaranteed Perf\uff0cOS \u901a\u8fc7\u4e09\u4e2a\u503c\u544a\u8bc9\u786c\u4ef6\uff0c\u6211\u60f3\u8981\u4ec0\u4e48\u6837\u7684\u6027\u80fd\uff1aMin Perf\uff0cMax Perf\uff0cDesired Perf\uff0c\u4ee5\u53ca\u6027\u80fd\u548c\u529f\u8017\u54ea\u4e2a\u66f4\u770b\u91cd\uff1aEPP\u3002</p>\n<h3 id=\"amd-cppc\">AMD CPPC<a class=\"headerlink\" href=\"#amd-cppc\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 AMD \u5e73\u53f0\u4e0a\uff0cCPPC \u7684\u8fd9\u4e9b\u6027\u80fd\u503c\u65e2\u53ef\u4ee5\u901a\u8fc7 ACPI \u83b7\u53d6\uff0c\u53c8\u53ef\u4ee5\u901a\u8fc7 MSR \u6765\u8bfb\u5199\uff08\u6765\u6e90\uff1a<a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/57254-PUB_3.00.zip\">Processor Programming Reference (PPR) for AMD Family 1Ah Model 24h, Revision B0 Processors</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../linux-core-scheduling-cppc-1.png\" /></p>\n<p><img alt=\"\" src=\"../../../../linux-core-scheduling-cppc-2.png\" /></p>\n<p>\u5728\u66f4\u65e9\u7684 AMD \u5904\u7406\u5668\u4e2d\uff0c\u6ca1\u6709\u8fd9\u4e9b MSR\uff0c\u800c\u662f\u901a\u8fc7 MMIO \u6765\u63a7\u5236\uff0c\u8fd9\u4e9b\u4fe1\u606f\u8bb0\u5f55\u5728 ACPI CPPC \u5f53\u4e2d\u3002</p>\n<p>\u901a\u8fc7\u6bd4\u5bf9 <code>/sys/devices/system/cpu/cpu*/acpi_cppc/highest_perf</code> \u548c <code>/sys/devices/system/cpu/cpu*/cpufreq/amd_pstate_prefcore_ranking</code>\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u5b83\u4eec\u662f\u4e00\u6837\u7684\uff0c\u8bf4\u660e amd-pstate \u9a71\u52a8\u505a\u7684\u4e8b\u60c5\u548c itmt \u7c7b\u4f3c\uff0c\u6839\u636e ACPI \u7684 Highest Perf \u4fe1\u606f\uff08\u6216\u8005\u4ece MSR 0xC001_02B0 \u8bfb\u51fa Highest Perf\uff09\uff0c\u8bbe\u7f6e Preferred Core Ranking \u4ee5\u53ca\u8c03\u5ea6\u5668\u7684\u4f18\u5148\u7ea7\u3002\u9605\u8bfb\u4ee3\u7801\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u786e\u5b9e\u662f\u8fd9\u4e48\u505a\u7684\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u5316\u4e2d\uff0c\u8bbe\u7f6e\u4f18\u5148\u7ea7\u4e3a <code>highest_perf</code>\uff1a<a href=\"https://github.com/torvalds/linux/blob/c2ee9f594da826bea183ed14f2cc029c719bf4da/drivers/cpufreq/amd-pstate.c#L796\"><code>sched_set_itmt_core_prio((int)READ_ONCE(cpudata-&gt;highest_perf), cpudata-&gt;cpu);</code></a></li>\n<li>\u8bbe\u7f6e <code>prefcore_ranking</code> \u4e3a <code>highest_perf</code>: <a href=\"https://github.com/torvalds/linux/blob/c2ee9f594da826bea183ed14f2cc029c719bf4da/drivers/cpufreq/amd-pstate.c#L402\"><code>WRITE_ONCE(cpudata-&gt;prefcore_ranking, cppc_perf.highest_perf)</code></a></li>\n<li>\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u53d1\u73b0 <code>highest_perf</code> \u51fa\u73b0\u53d8\u5316\uff0c\u4e5f\u66f4\u65b0\u5230\u8c03\u5ea6\u5668\u7684\u4f18\u5148\u7ea7\u5f53\u4e2d\uff1a<a href=\"https://github.com/torvalds/linux/blob/master/drivers/cpufreq/amd-pstate.c#L822\"><code>sched_set_itmt_core_prio((int)cur_high, cpu);</code></a></li>\n</ol>\n<p>\u5269\u4e0b\u7684\u5c31\u548c Intel \u4e00\u6837\u4e86\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u8c03\u5ea6\u5668\u8f6e\u6d41\u4ece\u4e24\u4e2a CCD \u53d6\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u6838\u5fc3\u8c03\u5ea6\uff0c\u5e94\u8be5\u662f\u8c03\u5ea6\u5668\u8003\u8651\u4e86\u8fd9\u4e9b\u6838\u5fc3\u7684\u62d3\u6251\uff0c\u8fdb\u884c\u4e86\u8d1f\u8f7d\u5747\u8861\uff0c\u5c3d\u91cf\u4fdd\u8bc1\u6bcf\u4e2a CCD \u4e0a\u7684\u8d1f\u8f7d\u76f8\u5f53\u3002\u8fd9\u6837\u7684\u8bbe\u8ba1\u5728 9950X \u8fd9\u79cd\u5bf9\u79f0\u7684\u67b6\u6784\u4e0a\u6ca1\u5565\u95ee\u9898\uff0c\u4f46\u5982\u679c\u662f Strix Point \u8fd9\u79cd\u6df7\u5408 Zen5 \u548c Zen5c \u7684\u60c5\u51b5\uff0c\u5982\u679c\u8fd8\u50cf\u8fd9\u6837\uff0c\u5c31\u4f1a\u5728 Zen5 \u548c Zen5c \u4e4b\u95f4\u6765\u56de\u8c03\u5ea6\uff0c\u8fd9\u6837\u5c31\u4e0d\u592a\u5408\u9002\u4e86\uff1a\u5e94\u8be5\u5148\u8c03\u5ea6 Zen5\uff0c\u518d\u8c03\u5ea6 Zen5c\u3002\u5b8c\u6574\u7684\u8ba8\u8bba\u89c1 <a href=\"https://blog.hjc.im/thoughts-on-linux-preferred-cores-and-multi-ccx.html\">\u8c08\u8c08 Linux \u4e0e ITMT \u8c03\u5ea6\u5668\u4e0e\u591a\u7c07\u5904\u7406\u5668</a>\u3002\u6700\u8fd1 Linux \u4e5f\u4e0a\u6e38\u5316\u4e86\u76f8\u5173\u7684 Patch\uff0c\u4f7f\u5f97 P \u6838\u4f18\u5148\u88ab\u8c03\u5ea6\uff1a<a href=\"https://www.phoronix.com/news/AMD-Hetero-Topo-Linux-6.13\">AMD Heterogeneous CPU Design Topology Patches Coming For Linux 6.13</a>\u3002</p>\n<p>\u800c\u6211\u4eec\u77e5\u9053 Linux \u7684 cpufreq \u8bbe\u7f6e\u4e86\u4e0d\u540c\u7684 governor\uff0c\u4f8b\u5982 performance \u548c powersave\u3002\u90a3\u4e48\u5b83\u4eec\u662f\u600e\u4e48\u6620\u5c04\u5230 Min/Max/Desired Perf \u7684\u5462\uff1f\u901a\u8fc7\u9605\u8bfb\u4ee3\u7801\uff0c\u53ef\u4ee5\u53d1\u73b0\uff1a</p>\n<ol>\n<li>powersave \u5bf9\u5e94\u7684\u914d\u7f6e\u662f\uff1aMin Perf \u8bbe\u7f6e\u4e3a Lowest/Lowest Nonlinear Perf\uff0cMax Perf \u8bbe\u7f6e\u4e3a Highest/Nominal Perf</li>\n<li>performance \u5bf9\u5e94\u7684\u914d\u7f6e\u662f\uff1aMin Perf \u548c Max Perf \u90fd\u8bbe\u7f6e\u4e3a Highest/Nominal Perf</li>\n</ol>\n<p>\u5982\u679c\u542f\u7528 boost\uff08<code>echo 1 &gt; /sys/devices/system/cpu/cpufreq/policy0/boost</code>\uff09\uff0c\u90a3\u5c31\u628a Max Perf \u8bbe\u7f6e\u5230 Highest Perf\uff1b\u5982\u679c\u4e0d\u542f\u7528 Boost\uff0c\u5c31\u8bbe\u7f6e\u5230 Nominal Perf\u3002</p>\n<p>\u4e0b\u9762\u7ed9\u51fa\u51e0\u4e2a\u4f8b\u5b50\uff0c\u5176\u4e2d Highest Perf \u4e3a 166\uff0cNominal Perf \u4e3a 124\uff0cLowest Perf \u4e3a 18\uff1a</p>\n<ol>\n<li>performance + boost=1: Min = 166, Max = 166</li>\n<li>performance + boost=0: Min = 124, Max = 124</li>\n<li>powersave + boost=1: Min = 18, Max = 166</li>\n<li>powersave + boost=0: Min = 18, Max = 124</li>\n</ol>\n<p>\u800c\u5176\u4ed6\u7531 Linux \u5b9e\u73b0\u53d8\u9891\u7684 governor\uff1aschedutil \u548c ondemand\uff0c\u4f1a\u901a\u8fc7 Desired Perf \u6765\u5b9e\u73b0\u3002</p>\n<p>amd-pstate \u652f\u6301\u4e09\u4e2a<a href=\"https://www.phoronix.com/news/AMD-P-State-Guided-Auto\">\u8fd0\u884c\u6a21\u5f0f</a>\uff1a</p>\n<ol>\n<li>active(\u9ed8\u8ba4): \u8f6f\u4ef6\u5c31\u8bbe\u7f6e\u4e00\u4e0b\u8981\u6027\u80fd\u8fd8\u662f\u80fd\u8017\uff08\u901a\u8fc7 performance/powersave governor \u548c EPP <code>/sys/devices/system/cpu/cpufreq/policy0/energy_performance_preference</code>\uff09\uff0c\u5176\u4ed6\u7684\u90fd\u4ea4\u7ed9\u786c\u4ef6\u81ea\u52a8\u8c03\u6574</li>\n<li>guided\uff1a\u8f6f\u4ef6\u8bbe\u7f6e\u4e00\u4e2a\u6700\u4f4e\u548c\u6700\u9ad8\u7684\u6027\u80fd\uff0c\u5176\u4ed6\u90fd\u4ea4\u7ed9\u786c\u4ef6</li>\n<li>passive\uff1a\u8f6f\u4ef6\u6765\u8d1f\u8d23\u8c03\u9891\uff0c\u7ed3\u679c\u901a\u8fc7 Desired Perf \u544a\u8bc9\u786c\u4ef6</li>\n</ol>\n<p>\u8fd9\u91cc\u8bf4\u7684 active \u548c passive \u662f\u4ece\u786c\u4ef6\u7684\u89d2\u5ea6\u51fa\u53d1\u7684\uff0c\u800c\u4e0d\u662f OS\u3002</p>\n<p>\u6ce8\uff1a\u867d\u7136\u8fd9\u91cc\u8bf4\u662f\u786c\u4ef6\u8c03\u6574\uff0c\u5b9e\u9645\u4e0a\u5927\u6982\u7387\u662f\u7531\u5728\u4e00\u4e2a\u7247\u4e0a\u7684\u5c0f CPU \u8fd0\u884c\u7684\u56fa\u4ef6\uff08PMFW\uff0cPower Management Firmware\uff09\u8d1f\u8d23\u8c03\u6574\u3002</p>\n<h3 id=\"qualcomm_1\">Qualcomm<a class=\"headerlink\" href=\"#qualcomm_1\" title=\"Permanent link\">&para;</a></h3>\n<p>arm64 \u67b6\u6784\u6ca1\u6709\u5b9e\u73b0 arch_asym_cpu_priority \u51fd\u6570\uff0c\u56e0\u6b64\u7528\u7684\u4e0d\u662f\u4e0a\u8ff0 Intel/AMD \u7684\u673a\u5236\uff0c\u800c\u662f\u5728 Device Tree \u4e2d\u7528 <a href=\"https://www.kernel.org/doc/Documentation/devicetree/bindings/arm/cpu-capacity.txt\">capacity-dmips-mhz</a> \u6807\u8bb0\u6bcf\u4e2a\u6838\u5fc3\u7684\u6027\u80fd\uff0c\u4f46\u662f X Elite \u7684 DTS \u6ca1\u6709\u8bb0\u5f55\u8fd9\u4e2a\u4fe1\u606f\uff0c\u56e0\u6b64 Linux \u5185\u6838\u4e5f\u5c31\u65e0\u6cd5\u5408\u7406\u5730\u8c03\u5ea6\u4e86\u3002\u56e0\u6b64\u4e00\u4e2a\u53ef\u80fd\u7684\u89e3\u51b3\u529e\u6cd5\u662f\uff0c\u7ed9\u540e\u4e24\u4e2a Cluster \u7684\u4e00\u4e2a\u6838\u8bbe\u7f6e\u66f4\u9ad8\u7684 capacity-dmips-mhz\uff0c\u5176\u4ed6\u7684\u6838\u5fc3\u90fd\u8bbe\u7f6e\u6210\u4e00\u6837\u3002\u4f46\u5176\u5b9e\u901a\u5e38\u6765\u8bf4\uff0c\u5bf9\u4e8e\u540c\u4e00\u4e2a\u6838\u6765\u8bf4\uff0c\u63d0\u9ad8\u9891\u7387\u4ee5\u540e\uff0cDMIPS/MHz \u53cd\u800c\u662f\u4e0b\u964d\u7684\uff0c\u5185\u6838\u7528 DMIPS/MHz \u8fd9\u4e2a\u6307\u6807\uff0c\u4e3b\u8981\u662f\u7528\u6765\u533a\u5206\u5927\u5c0f\u6838\uff0c\u800c\u4e0d\u662f\u7528\u6765\u5224\u65ad\u6709\u6ca1\u6709 Boost\u3002</p>\n<p>\u5b9e\u9645\u5c1d\u8bd5\u4e86\u4e00\u4e0b\uff0c\u7ed9 4 \u548c 8 \u8fd9\u4e24\u4e2a\u6838\u6807\u8bb0\u66f4\u9ad8\u7684 capacity-dmips-mhz\uff0c\u73b0\u5728\u8dd1\u5355\u6838\u6216\u53cc\u6838\u8d1f\u8f7d\u53ef\u4ee5\u81ea\u52a8\u8dd1\u5230 4.0 GHz \u4e0a\u4e86\u3002\u8868\u73b0\u5728 Geekbench 6 \u4e0a\uff0c\u5c31\u662f\u5355\u6838\u6027\u80fd 2452 \u5206\u5230 2892 \u5206\u7684\u533a\u522b\u3002\u4fee\u6539\u7684\u5185\u5bb9\u5df2\u7ecf\u63d0\u4ea4\uff1a<a href=\"https://lore.kernel.org/lkml/20241025031257.6284-2-c@jia.je/\">[PATCH] arm64: dts: qcom: x1e80100: Add performance hint for boost clock</a>\uff0c\u4e0d\u8fc7\u5408\u5e76\u7684\u6982\u7387\u4e0d\u5927\uff0c\u6bd5\u7adf\u4e0d\u662f\u4ec0\u4e48\u4f18\u96c5\u7684\u89e3\u51b3\u529e\u6cd5\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9488\u5bf9\u4e0d\u540c\u6838\u5fc3\u7684\u4e0d\u540c\u6027\u80fd\u4ee5\u53ca SMT\uff0cLinux \u7684\u8c03\u5ea6\u5668\u9700\u8981\u77e5\u9053\u5404\u4e2a\u903b\u8f91\u6838\u5fc3\u7684\u8c03\u5ea6\u4f18\u5148\u7ea7\u3002\u5728 Intel/AMD \u5e73\u53f0\u4e0a\uff0c\u8fd9\u4e2a\u4fe1\u606f\u76ee\u524d\u4e3b\u8981\u662f\u901a\u8fc7 CPPC \u7684 Highest Perf \u6765\u83b7\u53d6\uff0c\u4e5f\u53ef\u80fd Fallback \u5230 MSR_HWP_CAPABILITIES \u4e0a\u3002\u5728 ARM64 \u5e73\u53f0\u4e0a\uff0c\u5219\u9700\u8981 DTS \u6807\u8bb0\u5404\u6838\u5fc3\u7684\u6027\u80fd\u3002</p>\n<h2 id=\"\u53c2\u8003\">\u53c2\u8003<a class=\"headerlink\" href=\"#\u53c2\u8003\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://blog.hjc.im/thoughts-on-linux-preferred-cores-and-multi-ccx.html\">\u8c08\u8c08 Linux \u4e0e ITMT \u8c03\u5ea6\u5668\u4e0e\u591a\u7c07\u5904\u7406\u5668</a></li>\n<li><a href=\"https://zhiwei-lii.github.io/intel-cpu%E4%B8%8A%E9%9D%A2%E7%9A%84linux%E5%A4%A7%E5%B0%8F%E6%A0%B8%E8%B0%83%E5%BA%A6%E9%97%AE%E9%A2%98/\">Intel CPU \u4e0a\u9762\u7684 Linux \u5927\u5c0f\u6838\u8c03\u5ea6\u95ee\u9898</a></li>\n</ul>", "image": null, "date_modified": "2024-10-23T00:00:00+00:00", "authors": [], "tags": ["cpu", "intel", "linux", "qualcomm", "scheduler", "software"]}, {"id": "https://jia.je/hardware/2024/09/21/ibm-z15-branch-predictor/", "url": "https://jia.je/hardware/2024/09/21/ibm-z15-branch-predictor/", "title": "IBM z15 Mainframe CPU \u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0", "content_html": "<h1 id=\"ibm-z15-mainframe-cpu-\u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0\">IBM z15 Mainframe CPU \u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0<a class=\"headerlink\" href=\"#ibm-z15-mainframe-cpu-\u5206\u652f\u9884\u6d4b\u5668\u5b66\u4e60\u7b14\u8bb0\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ISCA 2020 \u7684\u4e00\u7bc7\u6587\u7ae0 <a href=\"https://ieeexplore.ieee.org/document/9138999\">The IBM z15 High Frequency Mainframe Branch Predictor Industrial Product</a> \u975e\u5e38\u8be6\u7ec6\u5730\u89e3\u6790\u4e86 IBM z15 Mainframe CPU \u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u3002\u672c\u6587\u662f\u5bf9\u8fd9\u7bc7\u8bba\u6587\u7684\u5b66\u4e60\u548c\u6574\u7406\u7684\u7b14\u8bb0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u8bbe\u8ba1\u601d\u8def\">\u8bbe\u8ba1\u601d\u8def<a class=\"headerlink\" href=\"#\u8bbe\u8ba1\u601d\u8def\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8bba\u6587\u7684\u7b2c\u4e8c\u8282 Branch Prediction Design Considerations \u63d0\u5230\u4e86\u5b83\u8bbe\u8ba1\u5206\u652f\u9884\u6d4b\u5668\u65f6\u9700\u8981\u8003\u8651\u7684\u4e8b\u60c5\u3002z15 \u5904\u7406\u5668\u9762\u5411\u7684\u662f\u5177\u6709\u5f88\u5927\u6307\u4ee4 footprint \u7684\u7a0b\u5e8f\uff0c\u4e3a\u6b64\u51c6\u5907\u4e86 128KB \u7684 L1 ICache\uff0c\u4ee5\u53ca 4MB \u7684 L2 Private ICache\u3002\u4e3a\u4e86\u652f\u6491 MB \u7ea7\u522b\u7684\u6307\u4ee4\uff0cBTB \u4e5f\u8981\u76f8\u5e94\u589e\u5927\u3002</p>\n<p>IBM z \u7cfb\u5217\u7528\u7684\u662f\u53d8\u957f\u6307\u4ee4\u96c6\uff0c\u6307\u4ee4\u957f\u5ea6\u53ef\u80fd\u662f 2 \u6216 4 \u6216 6 \u5b57\u8282\uff0c\u5e73\u5747\u957f\u5ea6\u662f 5 \u5b57\u8282\u3002\u8003\u8651\u5230\u6bcf 5 \u6761\u6307\u4ee4\u6709\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u5c31\u662f\u6bcf 25 \u4e2a\u5b57\u8282\u6709\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48 4MB \u7684 L2 ICache \u5e73\u5747\u4e0b\u6765\u53ef\u80fd\u6709 164K \u6761\u5206\u652f\u3002\u56e0\u6b64\uff0cz15 \u8bbe\u8ba1\u4e86\u53ef\u4ee5\u4fdd\u5b58 128K \u6761\u5206\u652f\u7684 L2 BTB\u3002z15 \u7684\u6d41\u6c34\u7ebf\u5f88\u957f\uff0c\u5206\u652f\u9884\u6d4b\u9519\u8bef\u4f1a\u5e26\u6765 26 \u4e2a\u5468\u671f\u7684\u5f00\u9500\uff0c\u56e0\u6b64\u5206\u652f\u9884\u6d4b\u7684\u6b63\u786e\u7387\u5c31\u5f88\u91cd\u8981\u3002z15 \u5904\u7406\u5668\u8bbe\u8ba1\u4e86\u4e24\u7ea7\u7684 BTB\uff0cL1 BTB\uff08\u8bba\u6587\u4e2d\u79f0 BTB1\uff09\u5bb9\u91cf\u662f 16K=2K x 8 way\uff0cL2 BTB\uff08\u8bba\u6587\u4e2d\u79f0 BTB2\uff09\u5bb9\u91cf\u662f 128K=32K x 4-way\u3002\u4e3a\u4e86\u52a0\u901f L1 BTB \u7684\u9884\u6d4b\uff0cz15 \u6709 Column Predictor\uff08CPRED\uff0c1K x 8\uff09\u3002\u4e3a\u4e86\u9884\u6d4b\u5206\u652f\u7684\u65b9\u5411\uff0cz15 \u8fd8\u5f15\u5165\u4e86 PHT\uff08short \u548c long \u4e24\u4e2a PHT\uff0c\u90fd\u662f 512 x 8\uff09\uff0cPerceptron\uff0816 x 2\uff09\u3002\u4e3a\u4e86\u9884\u6d4b\u95f4\u63a5\u5206\u652f\u548c\u8fd4\u56de\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\uff0cz15 \u8bbe\u8ba1\u4e86 Changing Target Buffer\uff08CTB\uff0c2K x 1\uff09\u548c Call/Return Stack\uff08CRS\uff09\u3002</p>\n<h2 id=\"\u5177\u4f53\u5b9e\u73b0\">\u5177\u4f53\u5b9e\u73b0<a class=\"headerlink\" href=\"#\u5177\u4f53\u5b9e\u73b0\" title=\"Permanent link\">&para;</a></h2>\n<p>z15 \u91c7\u7528\u7684\u662f\u5206\u79bb\u5f0f\u524d\u7aef\uff0c\u5206\u652f\u9884\u6d4b\u5668\u6709 6 \u7ea7\u7684\u6d41\u6c34\u7ebf\uff0c\u6bcf\u4e00\u7ea7\u5206\u522b\u8bb0\u4e3a b0-b5\u3002\u5404\u7ea7\u7684\u529f\u80fd\u5982\u4e0b\uff1a</p>\n<blockquote>\n<p>Indexing into the BTB arrays occurs in\nthe b0 cycle, which when superimposed over the z15 core\npipeline in figure 1 coincides with the very stage after a\nrestart, but deviates away from the core pipeline after that.\nAn array access cycle is in b1. Metadata from the arrays is\nobtained in b2, and hit detection and direction application\non a per branch basis performed across the b2 and b3\ncycles. Ordering of the branches based on their low-order\ninstruction address bits is also done in b3. In b4, the final\nprediction is prepared, including selection of the\nappropriate target address provider. The prediction is\npresented to the consumers, namely the IDU and ICM, in\nthe b5 cycle.</p>\n</blockquote>\n<p>\u5982\u679c\u7b49\u5230 b5 \u624d\u51fa\u9884\u6d4b\u7ed3\u679c\u5c31\u6bd4\u8f83\u6162\u4e86\uff0c\u56e0\u6b64\u5b83\u8fd8\u53ef\u4ee5\u5728 b2 \u5468\u671f\u51fa\u7ed3\u679c\uff0c\u5229\u7528\u7684\u662f CPRED \u9884\u6d4b\u5668\u3002\u5728 CPRED \u5de5\u4f5c\u7684\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e24\u4e2a\u5468\u671f\u53ef\u4ee5\u9884\u6d4b\u4e00\u4e2a taken branch\uff0c\u5982\u679c CPRED \u6ca1\u6709\u9884\u6d4b\uff0c\u90a3\u5c31\u9700\u8981\u6bcf 5 \u4e2a\u5468\u671f\u9884\u6d4b\u4e00\u4e2a taken branch\uff0c\u800c\u5728 SMT2 \u6a21\u5f0f\u4e0b\uff0c\u4e24\u4e2a\u7ebf\u7a0b\u8f6e\u6d41\u8bbf\u95ee BTB\uff0c\u6b64\u65f6\u6bcf\u4e2a\u7ebf\u7a0b\u9700\u8981\u6bcf 6 \u4e2a\u5468\u671f\u9884\u6d4b\u4e00\u4e2a taken branch\u3002</p>\n<p>z15 \u7684 L1 BTB \u7684 8-way \u610f\u5473\u7740\u5728\u4e00\u4e2a\u5468\u671f\u53ef\u4ee5\u8fdb\u884c 8 \u6761\u5206\u652f\u7684\u9884\u6d4b\uff0c\u4ece 64B \u7684\u6307\u4ee4\u4e2d\uff0c\u8bc6\u522b\u6700\u591a 8 \u6761\u6307\u4ee4\uff0c\u4ece\u4e2d\u627e\u5230\u7b2c\u4e00\u6761\u8df3\u8f6c\u7684\u5206\u652f\u3002\u4e3a\u4e86\u4f18\u5316\u6027\u80fd\u548c\u529f\u8017\uff0c\u5728\u9762\u5bf9\u8fde\u7eed\u7684\u65e0\u5206\u652f\u6307\u4ee4\u7684\u4ee3\u7801\u65f6\uff0c\u53ef\u4ee5\u5feb\u901f\u8df3\u8fc7\uff0c\u8fd9\u91cc\u7528\u7684\u662f SKOOT\uff08Skip Over OffseT\uff09\u9884\u6d4b\u5668\uff0c\u5728 BTB \u7684\u5206\u652f\u8bb0\u5f55\u4e86\u5230\u4e0b\u4e00\u6b21\u5206\u652f\u7684\u8ddd\u79bb\uff0c\u5982\u679c\u8fd9\u4e2a\u8ddd\u79bb\u5f88\u957f\uff0c\u90a3\u5c31\u53ef\u4ee5\u5feb\u901f\u8df3\u8fc7\u82e5\u5e72\u4e2a 64B \u6307\u4ee4\u5757\u3002</p>\n<p>\u4e3a\u4e86\u9884\u6d4b\u5206\u652f\u7684\u65b9\u5411\uff0c\u5728 L1 BTB \u91cc\uff0c\u4e5f\u4fdd\u5b58\u4e86 2 bit saturating counter\uff0c\u4e5f\u5c31\u662f BTB \u4e5f\u5145\u5f53\u4e86\u901a\u5e38\u8bf4\u7684 BHT\u3002\u9664\u4e86 BHT \u4ee5\u5916\uff0c\u4e3a\u4e86\u9884\u6d4b\u5206\u652f\u65b9\u5411\uff0cz15 \u8bb0\u5f55\u4e86 Global Path Vector\uff0c\u4e5f\u5c31\u662f\u5e38\u8bf4\u7684 PHR\uff0c\u8bb0\u5f55\u6700\u8fd1\u7684 n \u6761 taken branch \u7684\u5386\u53f2\u3002z14 \u4e4b\u524d\uff0cGPV \u8bb0\u5f55\u4e86\u6700\u8fd1 9 \u6761 taken branch \u7684\u5386\u53f2\uff0cz14 \u548c z15\uff0cGPV \u8bb0\u5f55\u4e86\u6700\u8fd1 17 \u6761 taken branch \u7684\u5386\u53f2\u3002GPV \u4e2d\u6bcf\u4e2a taken branch \u63d0\u4f9b 2 bit \u7684\u4fe1\u606f\u3002</p>\n<p>GPV \u548c PC \u4f5c\u4e3a TAGE \u7684\u8f93\u5165\uff0c\u8fdb\u884c\u65b9\u5411\u9884\u6d4b\u3002z15 \u91c7\u7528\u4e86\u4e24\u4e2a TAGE PHT\uff0c\u90fd\u662f 512 x 8 way\uff0c\u4e00\u5171\u662f 8K \u5206\u652f\u7684\u5bb9\u91cf\uff0c\u5386\u53f2\u77ed\u7684 TAGE PHT \u53ea\u7528\u6700\u8fd1 9 \u6761 taken branch \u7684\u5386\u53f2\uff0c\u5386\u53f2\u957f\u7684 TAGE PHT \u5219\u4f1a\u7528\u5b8c\u6574\u7684 17 \u6761 taken branch \u7684\u5386\u53f2\u3002\u8bba\u6587\u91cc\u6bd4\u8f83\u8be6\u7ec6\u5730\u63cf\u8ff0\u4e86 TAGE \u7684\u5b9e\u73b0\uff0c\u57fa\u672c\u548c A. Seznec \u7684\u8bbe\u8ba1\u662f\u4e00\u6837\u7684\uff0c\u4e5f\u505a\u4e86 USE_ALT_ON_NA \u7684\u6539\u8fdb\u3002\u9664\u4e86 TAGE \u4ee5\u5916\uff0cz15 \u8fd8\u6709 Perceptron \u9884\u6d4b\u5668\uff0c\u6709 32 \u4e2a entry\uff0c16 x 2 way\uff0c\u628a\u7cfb\u6570\u548c GPV \u8fdb\u884c\u70b9\u79ef\uff08GPV \u7684\u6bcf\u4e2a bit \u6620\u5c04\u4e3a 1 \u548c -1\uff09\uff0c\u6839\u636e\u7ed3\u679c\u7684\u7b26\u53f7\u51b3\u5b9a\u8df3\u8f6c\u7684\u65b9\u5411\u3002</p>\n<p>\u56e0\u6b64\u4e00\u5171\u6709 BHT\u3001TAGE \u548c Perceptron \u53ef\u4ee5\u63d0\u4f9b\u65b9\u5411\u9884\u6d4b\u3002\u4e3a\u4e86\u5224\u65ad\u7528\u54ea\u4e2a\u9884\u6d4b\u5668\u6765\u63d0\u4f9b\u6700\u7ec8\u7684\u65b9\u5411\uff0c\u89c4\u5219\u662f\uff1a</p>\n<ol>\n<li>\u5bf9\u4e8e\u6761\u4ef6\u5206\u652f\uff0c\u8bb0\u5f55\u5b83\u662f\u5426\u66fe\u7ecf\u8df3\u548c\u4e0d\u8df3\u8fc7\uff08Bidirectional\uff09\uff0c\u5982\u679c\u53ea\u5f80\u4e00\u4e2a\u65b9\u5411\u8df3\uff0c\u5c31\u67e5 BHT</li>\n<li>\u5982\u679c\u4e24\u4e2a\u65b9\u5411\u90fd\u8df3\u8fc7\uff0c\u6b64\u65f6 Perceptron \u4f18\u5148\u7ea7\u66f4\u9ad8\uff0c\u5982\u679c Perceptron \u547d\u4e2d\u4e14\u7f6e\u4fe1\u5ea6\u9ad8\uff0c\u5219\u7528 Perceptron \u7684\u7ed3\u679c</li>\n<li>\u5426\u5219\u8003\u5bdf TAGE \u7684\u9884\u6d4b\u7ed3\u679c\uff0c\u5982\u679c TAGE \u547d\u4e2d\u4e14\u7f6e\u4fe1\u5ea6\u9ad8\uff0c\u5219\u7528 TAGE \u7684\u7ed3\u679c</li>\n<li>\u5982\u679c Perceptron \u548c TAGE \u90fd\u6ca1\u6709\u547d\u4e2d\uff0c\u518d\u7528 BHT \u7684\u7ed3\u679c</li>\n</ol>\n<p>\u7b80\u5355\u6765\u8bf4\uff0c\u4f18\u5148\u7ea7\u662f Perceptron &gt; TAGE &gt; BHT\u3002</p>\n<p>\u4e3a\u4e86\u9884\u6d4b\u95f4\u63a5\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\uff0cz15 \u4e0a PC \u548c GPV \u901a\u8fc7\u54c8\u5e0c\u6620\u5c04\u5230 CTB\uff08Changing Target Buffer\uff09\u7684\u8868\u9879\u4e0a\uff0c\u6bcf\u4e2a\u8868\u9879\u8bb0\u5f55\u4e86\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u3002</p>\n<p>\u6709\u610f\u601d\u7684\u662f\uff0cz15 \u6307\u4ee4\u96c6\u91cc\u6ca1\u6709\u5355\u72ec\u7684 call \u548c return \u6307\u4ee4\uff0c\u56e0\u6b64\u786c\u4ef6\u9700\u8981\u8bc6\u522b\u95f4\u63a5\u5206\u652f\u91cc\u7684 call \u548c return \u6a21\u5f0f\u3002\u8bba\u6587\u91cc\u4ecb\u7ecd\u4e86\u5177\u4f53\u7684\u8bc6\u522b\u65b9\u6cd5\uff0c\u4f46\u76ee\u524d\u4e3b\u6d41\u6307\u4ee4\u96c6\u90fd\u505a\u4e86\u533a\u5206\uff08\u8981\u4e48\u662f\u5355\u72ec\u7684\u6307\u4ee4\uff0c\u8981\u4e48\u5efa\u8bae\u7f16\u8bd1\u5668\u7528\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\uff0c\u6807\u8bb0 call \u548c return\uff09\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65b9\u6cd5\u4e5f\u6ca1\u5565\u53c2\u8003\u4ef7\u503c\u3002</p>", "image": null, "date_modified": "2024-09-21T00:00:00+00:00", "authors": [], "tags": ["bp", "cpu", "hardware", "ibm", "microarchitecture"]}, {"id": "https://jia.je/hardware/2024/09/12/brief-into-ooo-3/", "url": "https://jia.je/hardware/2024/09/12/brief-into-ooo-3/", "title": "\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e09\uff1a\u524d\u7aef\uff09", "content_html": "<h1 id=\"\u6d45\u8c08\u4e71\u5e8f\u6267\u884c-cpu\u4e09\u524d\u7aef\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e09\uff1a\u524d\u7aef\uff09<a class=\"headerlink\" href=\"#\u6d45\u8c08\u4e71\u5e8f\u6267\u884c-cpu\u4e09\u524d\u7aef\" title=\"Permanent link\">&para;</a></h1>\n<p>\u672c\u6587\u7684\u5185\u5bb9\u5df2\u7ecf\u6574\u5408\u5230<a href=\"/kb/hardware/ooo_cpu.html\">\u77e5\u8bc6\u5e93</a>\u4e2d\u3002</p>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8fd9\u662f <a href=\"../../../../2021/09/14/brief-into-ooo/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU</a> \u7cfb\u5217\u535a\u5ba2\u7684\u7b2c\u4e09\u7bc7\u3002</p>\n<p>\u672c\u6587\u4e3b\u8981\u8ba8\u8bba\u5904\u7406\u5668\u524d\u7aef\u7684\u90e8\u5206\u3002</p>\n<p>\u672c\u7cfb\u5217\u7684\u6240\u6709\u6587\u7ae0\uff1a</p>\n<ul>\n<li><a href=\"../../../../2021/09/14/brief-into-ooo/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e00\uff1a\u4e71\u5e8f\uff09</a></li>\n<li><a href=\"../../../../2022/03/31/brief-into-ooo-2/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e8c\uff1a\u8bbf\u5b58\uff09</a></li>\n<li><a href=\"./\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e09\uff1a\u524d\u7aef\uff09</a></li>\n</ul>\n<!-- more -->\n\n<h2 id=\"\u5904\u7406\u5668\u524d\u7aef\">\u5904\u7406\u5668\u524d\u7aef<a class=\"headerlink\" href=\"#\u5904\u7406\u5668\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<p>\u518d\u6765\u5206\u6790\u4e00\u4e0b\u4e71\u5e8f\u6267\u884c CPU \u7684\u524d\u7aef\u90e8\u5206\u3002\u4ee5 RISC-V \u4e3a\u4f8b\uff0c\u6307\u4ee4\u957f\u5ea6\u6709 4 \u5b57\u8282\u6216\u8005 2 \u5b57\u8282\u4e24\u79cd\uff0c\u5176\u4e2d 2 \u5b57\u8282\u5c5e\u4e8e\u538b\u7f29\u6307\u4ee4\u96c6\u3002\u5982\u4f55\u6b63\u786e\u5e76\u9ad8\u6548\u5730\u8fdb\u884c\u53d6\u6307\u4ee4\u8bd1\u7801\uff1f</p>\n<p>\u9996\u5148\uff0c\u6211\u4eec\u5e0c\u671b\u524d\u7aef\u80fd\u591f\u5c3d\u53ef\u80fd\u5feb\u5730\u53d6\u6307\u4ee4\uff0c\u524d\u7aef\u7684\u53d6\u6307\u80fd\u529b\u8981\u548c\u540e\u7aef\u5339\u914d\uff0c\u6bd4\u5982\u5bf9\u4e8e\u4e00\u4e2a\u56db\u53d1\u5c04\u7684 CPU\uff0c\u524d\u7aef\u5bf9\u5e94\u5730\u9700\u8981\u4e00\u4e2a\u5468\u671f\u53d6 <code>4*4=16</code> \u5b57\u8282\u7684\u6307\u4ee4\u3002\u4f46\u662f\uff0c\u8fd9 16 \u5b57\u8282\u53ef\u80fd\u662f 4 \u6761\u975e\u538b\u7f29\u6307\u4ee4\uff0c\u4e5f\u53ef\u80fd\u662f 8 \u6761\u538b\u7f29\u6307\u4ee4\uff0c\u4e5f\u53ef\u80fd\u662f\u6df7\u5408\u7684\u60c5\u51b5\u3002\u6240\u4ee5\uff0c\u8fd9\u91cc\u4f1a\u51fa\u73b0\u4e00\u4e2a\u53ef\u80fd\u51fa\u73b0\u6307\u4ee4\u6761\u6570\u4e0d\u5339\u914d\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u4e2d\u95f4\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a Fetch Buffer\uff0c\u6bd4\u5982 <a href=\"https://github.com/riscv-boom/riscv-boom\">BOOM</a> \u7684\u5b9e\u73b0\u4e2d\uff0cL1 ICache \u6bcf\u5468\u671f\u8bfb\u53d6 16 \u5b57\u8282\uff0c\u7136\u540e\u8fdb\u884c\u9884\u8bd1\u7801\uff0c\u51fa\u6765 8 \u6761\u6307\u4ee4\uff0c\u4fdd\u5b58\u5230 Fetch Buffer \u4e2d\u3002\u8fd9\u91cc\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u51e0\u70b9\uff1a\u9996\u5148\u4ece ICache \u8bfb\u53d6\u7684\u6570\u636e\u662f\u5bf9\u9f50\u7684\uff0c\u4f46\u662f PC \u53ef\u80fd\u4e0d\u662f\uff0c\u6bd4\u5982\u4e2d\u95f4\u7684\u5730\u5740\u3002\u5176\u6b21\uff0c\u53ef\u80fd\u4e00\u4e2a 4 \u5b57\u8282\u7684\u975e\u538b\u7f29\u6307\u4ee4\u8de8\u8d8a\u4e86\u4e24\u6b21 Fetch\uff0c\u6bd4\u5982\u524d 2 \u4e2a\u5b57\u8282\u5728\u524d\u4e00\u4e2a Fetch Bundle\uff0c\u540e 2 \u4e2a\u5b57\u8282\u5728\u540e\u4e00\u4e2a Fetch Bundle\uff1b\u6b64\u5916\uff0c\u6bcf\u4e2a 2 \u5b57\u8282\u7684\u8fb9\u754c\u90fd\u9700\u8981\u5224\u65ad\u4e00\u4e0b\u662f\u538b\u7f29\u6307\u4ee4\u8fd8\u662f\u975e\u538b\u7f29\u6307\u4ee4\u3002\u4e00\u4e2a\u975e\u5e38\u7279\u6b8a\u7684\u60c5\u51b5\u5c31\u662f\uff0c\u4e00\u4e2a 4 \u5b57\u8282\u7684\u6307\u4ee4\u8de8\u8d8a\u4e86\u4e24\u4e2a\u9875\uff0c\u6240\u4ee5\u4e24\u4e2a\u9875\u90fd\u9700\u8981\u67e5\u8be2\u9875\u8868\uff1b\u5982\u679c\u6070\u597d\u5728\u7b2c\u4e8c\u4e2a\u9875\u5904\u53d1\u751f\u4e86\u9875\u7f3a\u5931\uff0c\u6b64\u65f6 epc \u662f\u6307\u4ee4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u4f46 tval \u662f\u7b2c\u4e8c\u4e2a\u9875\u7684\u5730\u5740\uff0c\u8fd9\u6837\u5185\u6838\u624d\u77e5\u9053\u662f\u54ea\u4e2a\u9875\u53d1\u751f\u4e86\u7f3a\u5931\u3002</p>\n<p>\u5176\u6b21\uff0c\u9700\u8981\u914d\u5408\u5206\u652f\u9884\u6d4b\u3002\u5982\u679c\u9700\u8981\u4fdd\u8bc1\u5206\u652f\u9884\u6d4b\u6b63\u786e\u7684\u60c5\u51b5\u4e0b\uff0c\u80fd\u591f\u5728\u5faa\u73af\u4e2d\u8fbe\u5230\u63a5\u8fd1 100% \u7684\u6027\u80fd\uff0c\u90a3\u4e48\uff0c\u5728 Fetch \u5206\u652f\u7ed3\u5c3e\u7684\u5206\u652f\u6307\u4ee4\u7684\u540c\u65f6\uff0c\u9700\u8981\u4fdd\u8bc1\u4e0b\u4e00\u6b21 Fetch \u5df2\u7ecf\u5f97\u5230\u4e86\u5206\u652f\u9884\u6d4b\u7684\u76ee\u7684\u5730\u5740\u3002\u8fd9\u4e2a\u5c31\u662f BOOM \u91cc\u9762\u7684 L0 BTB (1-cycle redirect)\u3002\u4f46\u662f\uff0c\u4e00\u4e2a\u5468\u671f\u5185\u5b8c\u6210\u7684\u5206\u652f\u9884\u6d4b\uff0c\u5b83\u7684\u9762\u79ef\u80af\u5b9a\u4e0d\u80fd\u5927\uff0c\u5426\u5219\u65f6\u5e8f\u65e0\u6cd5\u6ee1\u8db3\uff0c\u6240\u4ee5 BOOM \u91cc\u9762\u8fd8\u8bbe\u8ba1\u4e86 2-cycle \u548c 3-cycle \u7684\u6bd4\u8f83\u9ad8\u7ea7\u7684\u5206\u652f\u9884\u6d4b\u5668\uff0c\u8fd8\u6709\u9488\u5bf9\u51fd\u6570\u8c03\u7528\u7684 RAS\uff08Return Address Stack\uff09\u3002</p>\n<p>\u5206\u652f\u9884\u6d4b\u4e5f\u6709\u5f88\u591a\u65b9\u6cd5\u3002\u6bd4\u8f83\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5b9e\u73b0\u4e00\u4e2a BHT\uff0c\u6bcf\u4e2a\u9879\u662f\u4e00\u4e2a 2 \u4f4d\u7684\u9971\u548c\u8ba1\u6570\u5668\uff0c\u8d85\u8fc7\u4e00\u534a\u7684\u65f6\u5019\u589e\u52a0\uff0c\u5c11\u4e8e\u4e00\u534a\u65f6\u51cf\u5c11\u3002\u4f46\u662f\uff0c\u5982\u679c\u9047\u5230\u4e86\u8df3\u8f6c/\u4e0d\u8df3\u8f6c/\u8df3\u8f6c/\u4e0d\u8df3\u8f6c\u8fd9\u79cd\u6765\u56de\u5207\u6362\u7684\u60c5\u51b5\uff0c\u51c6\u786e\u7387\u5c31\u5f88\u4f4e\u3002\u4e00\u4e2a\u590d\u6742\u4e00\u4e9b\u7684\u8bbe\u8ba1\uff0c\u5c31\u662f\u7528 BHR\uff0c\u8bb0\u5f55\u8fd9\u4e2a\u5206\u652f\u6307\u4ee4\u6700\u8fd1\u51e0\u6b21\u7684\u5386\u53f2\uff0c\u5bf9\u4e8e\u6bcf\u79cd\u53ef\u80fd\u7684\u5386\u53f2\uff0c\u90fd\u5bf9\u5e94\u4e00\u4e2a 2 \u4f4d\u7684\u9971\u548c\u8ba1\u6570\u5668\u3002\u8fd9\u6837\uff0c\u9047\u5230\u521a\u624d\u6240\u8bf4\u7684\u60c5\u51b5\u5c31\u4f1a\u5f88\u597d\u5730\u9884\u6d4b\u3002\u4f46\u5b9e\u8df5\u4e2d\u4f1a\u9047\u5230\u95ee\u9898\uff1a\u5982\u679c\u5728\u5199\u56de\u4e4b\u524d\uff0c\u53c8\u8fdb\u884c\u4e86\u4e00\u6b21\u9884\u6d4b\uff0c\u56e0\u4e3a\u9884\u6d4b\u662f\u5728\u53d6\u6307\u7684\u65f6\u5019\u505a\u7684\uff0c\u4f46\u662f\u66f4\u65b0 BPU \u662f\u5728\u5199\u56de\u7684\u65f6\u5019\u5b8c\u6210\u7684\uff0c\u8fd9\u65f6\u5019\u9884\u6d4b\u5c31\u662f\u57fa\u4e8e\u65e7\u7684\u72b6\u6001\u8fdb\u884c\u9884\u6d4b\uff0c\u8fd9\u65f6\u5019 BHR \u5c31\u4f1a\u51fa\u73b0\u4e0d\u51c6\u786e\u7684\u95ee\u9898\uff1b\u800c\u4e14\u5199\u56de BPU \u7684\u65f6\u5019\uff0c\u4f1a\u6309\u7167\u539f\u6765\u7684\u72b6\u6001\u8fdb\u884c\u66f4\u65b0\uff0c\u8fd9\u4e2a\u72b6\u6001\u53ef\u80fd\u4e5f\u662f\u9519\u8bef\u7684\uff0c\u5bfc\u81f4\u4e22\u5931\u4e00\u6b21\u66f4\u65b0\uff0c\u8bc6\u522b\u7684\u6a21\u5f0f\u4ece\u8df3\u8f6c/\u4e0d\u8df3\u8f6c/\u8df3\u8f6c/\u4e0d\u8df3\u8f6c\u53d8\u6210\u4e86\u8df3\u8f6c/\u8df3\u8f6c/\u8df3\u8f6c/\u4e0d\u8df3\u8f6c\uff0c\u8fd9\u6837\u53c8\u4f1a\u9884\u6d4b\u9519\u8bef\u3002\u4e00\u4e2a\u89e3\u51b3\u529e\u6cd5\u662f\uff0c\u5728\u53d6\u6307\u9636\u6bb5\uff0cBPU \u9884\u6d4b\u5b8c\u5c31\u7acb\u5373\u6309\u7167\u9884\u6d4b\u7684\u7ed3\u679c\u66f4\u65b0 BHR\uff0c\u4e4b\u540e\u5199\u56de\u9636\u6bb5\u4f1a\u6062\u590d\u5230\u5b9e\u9645\u7684 BHR \u53d6\u503c\u3002\u8bba\u6587 <a href=\"https://dl.acm.org/doi/10.1145/192724.192756\">The effect of speculatively updating branch history on branch prediction accuracy, revisited</a> \u548c <a href=\"https://jilp.org/vol2/v2paper1.pdf\">Speculative Updates of Local and Global Branch History: A Quantitative Analysis</a> \u8ba8\u8bba\u4e86\u8fd9\u4e2a\u5b9e\u73b0\u65b9\u5f0f\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u3002</p>\n<p>\u6bd4\u8f83\u5bb9\u6613\u505a\u9884\u6d4b\u66f4\u65b0\u548c\u6062\u590d\u7684\u662f\u5168\u5c40\u5206\u652f\u5386\u53f2\uff0c\u53ef\u4ee5\u7ef4\u62a4\u4e24\u4e2a GHR\uff08Global History Register\uff09\uff0c\u4e00\u4e2a\u662f\u76ee\u524d\u53d6\u6307\u4ee4\u6700\u65b0\u7684\uff0c\u4e00\u4e2a\u662f\u63d0\u4ea4\u7684\u6700\u65b0\u7684\u3002\u5728\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u7528 GHR \u53bb\u627e\u5bf9\u5e94\u7684 2-bit \u72b6\u6001\uff0c\u7136\u540e\u628a\u9884\u6d4b\u7ed3\u679c\u66f4\u65b0\u5230 GHR \u4e0a\u3002\u5728\u9884\u6d4b\u5931\u8d25\u7684\u65f6\u5019\uff0c\u628a GHR \u6062\u590d\u4e3a\u63d0\u4ea4\u7684\u72b6\u6001\u3002\u5982\u679c\u8981\u652f\u6301\u4e00\u4e2a Fetch Packet \u4e2d\u6709\u591a\u4e2a\u5206\u652f\uff0c\u53ef\u4ee5\u8ba9 GHR \u5bf9\u5e94\u82e5\u5e72\u4e2a 2-bit \u72b6\u6001\uff0c\u5206\u522b\u5bf9\u5e94\u76f8\u5e94\u4f4d\u7f6e\u4e0a\u7684\u5206\u652f\u7684\u72b6\u6001\uff0c\u5f53\u7136\u8fd9\u6837\u9762\u79ef\u4e5f\u4f1a\u589e\u52a0\u5f88\u591a\u3002</p>\n<p>\u9664\u4e86\u8bb0\u5f55\u6761\u4ef6\u5206\u652f\u7684\u8df3\u4e0e\u4e0d\u8df3\u4ee5\u5916\uff0c\u901a\u5e38\u8fd8\u53ef\u4ee5\u7ef4\u62a4 taken branch \u7684\u5730\u5740\uff0c\u8bb0\u5f55\u8fd9\u6837\u7684\u5206\u652f\u5386\u53f2\u7684 GHR \u5c31\u53eb\u505a PHR\uff08Path History Register\uff09\u3002</p>\n<p>\u76ee\u524d\u6bd4\u8f83\u4e3b\u6d41\u7684\u5206\u652f\u9884\u6d4b\u7b97\u6cd5\u5c31\u662f <a href=\"https://inria.hal.science/hal-03408381/document\">TAGE</a> \u4e86\uff1a\u7ef4\u62a4\u591a\u4e2a\u8868\uff0c\u6bcf\u4e2a\u8868\u91c7\u53d6\u7684\u5386\u53f2\u957f\u5ea6\u4e0d\u540c\uff0c\u5448\u51e0\u4f55\u7ea7\u6570\uff0c\u4f7f\u5f97\u9700\u8981\u6bd4\u8f83\u77ed\u7684\u5386\u53f2\u5c31\u53ef\u4ee5\u9884\u6d4b\u7684\u5206\u652f\u53ef\u4ee5\u66f4\u5feb\u7684\u9884\u70ed\uff0c\u9700\u8981\u6bd4\u8f83\u957f\u7684\u5386\u53f2\u624d\u80fd\u9884\u6d4b\u7684\u5206\u652f\u4e5f\u53ef\u4ee5\u6709\u8f83\u597d\u7684\u51c6\u786e\u5ea6\u3002\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f TAGE \u7684\u8868\u9879\u5206\u914d\u548c\u66ff\u6362\u7684\u7b97\u6cd5\uff0cuseful counter \u548c altpred \u7684\u8bbe\u8ba1\uff0c\u4ee5\u53ca USE_ALT_ON_NA \u7684\u4f18\u5316\u3002\u4e3a\u4e86\u9884\u6d4b\u95f4\u63a5\u5206\u652f\uff0c\u53ef\u4ee5\u628a\u76ee\u7684\u5730\u5740\u653e\u5230 TAGE \u7684\u8868\u9879\u91cc\uff0c\u628a\u9884\u6d4b\u65b9\u5411\u53d8\u4e3a\u9884\u6d4b\u76ee\u7684\u5730\u5740\uff0c\u8fd9\u79cd\u9884\u6d4b\u95f4\u63a5\u5206\u652f\u7684 TAGE \u5c31\u53eb\u505a ITTAGE\u3002\u90e8\u5206\u5b9e\u73b0\u8fd8\u4f1a\u7ed9 TAGE \u6dfb\u52a0 Statistical Corrector \u6216\u8005 Loop Predictor\u3002\u8fd9\u4e9b\u7b97\u6cd5\u57fa\u672c\u7edf\u6cbb\u4e86\u5f53\u4eca\u9ad8\u6027\u80fd\u7684\u5904\u7406\u5668\u8bbe\u8ba1\u3002</p>\n<p>\u6211\u5728\u535a\u5ba2 <a href=\"../../10/samsung-exynos-cpu/\">\u4e09\u661f Exynos CPU \u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0</a> \u4e2d\u8be6\u7ec6\u5206\u6790\u4e86 Exynos \u5fae\u67b6\u6784\u7684\u524d\u7aef\u8bbe\u8ba1\uff0c\u5efa\u8bae\u611f\u5174\u8da3\u7684\u8bfb\u8005\u9605\u8bfb\u3002</p>\n<h2 id=\"short-forward-branch\">Short Forward Branch<a class=\"headerlink\" href=\"#short-forward-branch\" title=\"Permanent link\">&para;</a></h2>\n<p>\u8bba\u6587 <a href=\"https://carrv.github.io/2020/papers/CARRV2020_paper_15_Zhao.pdf\">SonicBOOM: The 3rd Generation Berkeley Out-of-Order Machine</a> \u63d0\u5230\u4e86\u4e00\u4e2a\u6709\u610f\u601d\u7684\u4f18\u5316\uff1aShort Forward Branch\u3002\u5b83\u9762\u5bf9\u7684\u573a\u666f\u662f\u4e00\u4e9b\u5c0f\u7684 if \u8bed\u53e5\uff0c\u5728 if \u7684\u6761\u4ef6\u6ee1\u8db3\u65f6\uff0c\u6267\u884c\u5c11\u91cf\u7684\u6307\u4ee4\u3002\u6b63\u5e38\u6765\u8bf4\uff0c\u8fd9\u6837\u7684\u4ee3\u7801\u4f1a\u88ab\u7f16\u8bd1\u6210\u4e00\u4e2a Forward \u7684\u5206\u652f\uff0c\u88ab\u8df3\u8fc7\u7684\u5c31\u662f if \u6761\u4ef6\u6ee1\u8db3\u65f6\u8981\u6267\u884c\u7684\u4ee3\u7801\u5bf9\u5e94\u7684\u6307\u4ee4\u3002\u5982\u679c\u5206\u652f\u6bd4\u8f83\u597d\u9884\u6d4b\uff0c\u90a3\u73b0\u6709\u7684\u5206\u652f\u9884\u6d4b\u5668\u5c31\u53ef\u4ee5\u5f97\u5230\u5f88\u597d\u7684\u6027\u80fd\uff0c\u4f46\u5982\u679c\u5206\u652f\u4e0d\u597d\u9884\u6d4b\uff0c\u4f8b\u5982\u5b83\u4f1a\u4f9d\u8d56\u6570\u636e\u7684\u503c\uff0c\u5e76\u4e14\u5177\u6709\u4e00\u5b9a\u7684\u968f\u673a\u6027\uff0c\u8fd9\u65f6\u5019\u6027\u80fd\u5c31\u4f1a\u4e0b\u964d\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u7528\u6761\u4ef6\u6267\u884c\u6765\u4ee3\u66ff\u5206\u652f\uff1a\u628a\u5206\u652f\u6307\u4ee4\u66ff\u6362\u4e3a\u6bd4\u8f83\u6307\u4ee4\uff0c\u7136\u540e\u6839\u636e\u6bd4\u8f83\u7684\u7ed3\u679c\u6765\u6761\u4ef6\u6267\u884c\u672c\u6765\u53ef\u80fd\u4f1a\u88ab\u8df3\u8fc7\u7684\u6307\u4ee4\u3002\u4e0b\u9762\u662f\u8bba\u6587\u4e2d\u7ed9\u7684\u4f8b\u5b50\uff0c\u8bf4\u7684\u6bd4\u8f83\u7684\u6e05\u6670\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-sfb.png\" /></p>\n<p>\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f\uff0c\u8fd9\u4e2a\u4f18\u5316\u662f\u5b8c\u5168\u7531\u786c\u4ef6\u6765\u505a\u7684\uff0c\u800c\u4e0d\u662f\u7f16\u8bd1\u5668\u3002\u5f53\u7136\u4e86\uff0c\u5982\u679c\u7f16\u8bd1\u5668\u8981\u505a\u7684\u524d\u63d0\u662f\u786c\u4ef6\u652f\u6301\u8fd9\u7c7b\u6807\u91cf\u7684\u6761\u4ef6\u6267\u884c\u6307\u4ee4\uff0c\u867d\u7136 Zicond \u6269\u5c55\u786e\u5b9e\u63d0\u4f9b\u4e86\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u5f88\u591a RISC-V \u5b9e\u73b0\u8fd8\u6ca1\u6709\u5b9e\u73b0 Zicond\u3002\u786c\u4ef6\u4e0a\u505a\u7684\u8bdd\uff0c\u5c31\u4e0d\u9700\u8981\u6269\u5c55\u6307\u4ee4\u96c6\uff0c\u76f4\u63a5\u5728\u524d\u7aef\u8fdb\u884c\u8bc6\u522b\uff0c\u5f53\u53d1\u73b0\u8fd9\u79cd Short Forward Branch \u65f6\uff0c\u628a\u5206\u652f\u6307\u4ee4\u672c\u8eab\u6539\u6210\u4e00\u6761 set-flag \u6307\u4ee4\uff0c\u7136\u540e\u628a\u5206\u652f\u5230\u8df3\u8f6c\u76ee\u7684\u5730\u8fd9\u4e00\u6bb5\u7684\u6307\u4ee4\u6539\u4e3a\u6761\u4ef6\u6267\u884c\u3002\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u8fdb\u884c\u5206\u652f\u9884\u6d4b\u4e86\uff0c\u65e0\u8bba\u539f\u6765\u7684\u5206\u652f\u662f\u5426\u8df3\u8f6c\uff0c\u540e\u7eed\u7684\u8fd9\u4e9b\u6307\u4ee4\u90fd\u4f1a\u8fdb\u5165\u6d41\u6c34\u7ebf\uff0c\u770b\u8d77\u6765\u505a\u4e86\u66f4\u591a\u7684\u4e8b\u60c5\uff0c\u4f46\u5f88\u591a\u65f6\u5019\u53cd\u800c\u6bd4\u9519\u8bef\u7684\u5206\u652f\u9884\u6d4b\u8fd8\u8981\u5feb\u3002</p>\n<p>\u8fd9\u4e2a\u4f18\u5316\u601d\u8def\u5728 Intel \u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US9367314B2/en\">Converting conditional short forward branches to computationally equivalent predicated instructions</a> \u4e5f\u6709\u9610\u8ff0\uff0c\u4e0d\u77e5\u9053\u8fd9\u4e2a\u4f18\u5316\u6709\u6ca1\u6709\u5b9e\u9645\u52a0\u5230 Intel \u7684\u5904\u7406\u5668\u5f53\u4e2d\u3002\u4e13\u5229\u7684\u56fe 6 \u5f88\u597d\u5730\u7528 X86 \u7684\u6307\u4ee4\u9610\u8ff0\u4e86\u8fd9\u4e2a\u4f18\u5316\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-intel.png\" /></p>\n<p>Intel \u5728 <a href=\"https://ieeexplore.ieee.org/document/9138936\">ISCA 2020 \u7684\u8bba\u6587 Auto-Predication of Critical Branches</a> \u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e9b\u786c\u4ef6\u7684\u5b9e\u73b0\u601d\u8def\uff0c\u8ba8\u8bba\u4e86\u600e\u6837\u53bb\u68c0\u6d4b\u8fd9\u6837\u7684\u5316\u5206\u652f\u6307\u4ee4\u4e3a\u6761\u4ef6\u6267\u884c\u6307\u4ee4\u7684\u60c5\u51b5\uff0c\u5982\u4f55\u5728\u786c\u4ef6\u4e2d\u5b9e\u73b0\u9ad8\u6548\u7684\u6761\u4ef6\u6267\u884c\uff0c\u600e\u4e48\u907f\u514d\u8d1f\u4f18\u5316\uff08\u4f8b\u5982\u53bb\u6389\u5206\u652f\u6307\u4ee4\u4ee5\u540e\uff0c\u5206\u652f\u9884\u6d4b\u5668\u773c\u91cc\u5c31\u4e22\u5931\u4e86\u5206\u652f\u7684\u5386\u53f2\uff1b\u8f6c\u5316\u4e3a\u6761\u4ef6\u6267\u884c\u4ee5\u540e\uff0c\u672c\u6765\u53ef\u80fd\u6ca1\u6709\u4f9d\u8d56\u7684\u6307\u4ee4\u4e5f\u53d8\u5f97\u5f3a\u5236\u6709\u4f9d\u8d56\u4e86\uff09\uff0c\u5efa\u8bae\u6709\u5174\u8da3\u7684\u8bfb\u8005\u9605\u8bfb\u3002</p>\n<p>\u90a3\u4e48\u8fd9\u6837\u7684\u6307\u4ee4\u5e8f\u5217\u5728\u5b9e\u9645\u7684\u7a0b\u5e8f\u91cc\u51fa\u73b0\u7684\u591a\u5417\uff1f\u8bba\u6587 <a href=\"http://ieeexplore.ieee.org/document/717459/\">The Effects of Predicated Execution on Branch Prediction</a> \u5206\u6790\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u7ed3\u8bba\u662f\u8fd8\u771f\u4e0d\u5c11\u3002\u5f53\u7136\u4e86\uff0c\u8fd9\u7bc7\u8bba\u6587\u4e3b\u8981\u7684\u8bba\u70b9\u662f\uff0c\u6307\u4ee4\u96c6\u5e94\u8be5\u5f15\u5165\u5404\u79cd\u6761\u4ef6\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u6837\u7f16\u8bd1\u5668\u5c31\u53ef\u4ee5\u5229\u7528\u73b0\u6709\u5904\u7406\u5668\u7684\u6761\u4ef6\u6267\u884c\u6307\u4ee4\u6765\u4f18\u5316\uff0c\u6ca1\u6709\u53bb\u8ba8\u8bba\u7eaf\u786c\u4ef6\u7684\u5b9e\u73b0\u65b9\u6cd5\u3002</p>\n<p>\u4ece SiFive \u63d0\u4ea4\u7ed9 GCC \u7684 <a href=\"https://patchwork.ozlabs.org/project/gcc/patch/20190430234741.8120-1-jimw@sifive.com/#2163277\">patch</a> \u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u7c7b\u4f3c\u7684\u4f18\u5316\u88ab\u5b9e\u88c5\u5230\u4e86 SiFive \u7684 CPU \u5f53\u4e2d\uff0c\u4e0d\u8fc7\u8fd9\u91cc\u505a\u7684\u4f1a\u66f4\u52a0\u7b80\u5355\uff0c\u53ea\u8003\u8651\u4e86\u5206\u652f\u8df3\u8fc7\u4e00\u6761\u6307\u4ee4\u7684\u60c5\u51b5\uff0c\u8fd9\u79cd\u4e5f\u6bd4\u8f83\u597d\u5b9e\u73b0\uff0c\u53ef\u4ee5\u5728\u73b0\u6709\u7684\u6307\u4ee4\u878d\u5408\u673a\u5236\u7684\u57fa\u7840\u4e0a\uff0c\u628a\u4e24\u6761\u6307\u4ee4\u5408\u6210\u4e00\u6761\uff1a</p>\n<blockquote>\n<p>The SiFive 7 series cores have macro fusion support to convert a branch over a\nsingle instruction into a conditionally executed instruction.  This adds a\nconditional move pattern, enabled only for the SiFive 7 series cores, that\nimplements the initial optimization support for this feature.  This gives us\nabout a 10% increase in coremark scores for this core.</p>\n</blockquote>\n<p>SiFive \u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US10996952B2/en\">Macro-op fusion</a> \u4e5f\u63d0\u5230\u4e86\u5f88\u591a\u5728 RISC-V \u4e0a\u5b9e\u73b0\u7684\u6307\u4ee4\u878d\u5408\u7684\u4f18\u5316\uff0c\u4e0b\u9762\u4e3e\u51e0\u4e2a\u4f8b\u5b50\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a><span class=\"w\">    </span><span class=\"nf\">bne</span><span class=\"w\"> </span><span class=\"no\">x1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">target</span>\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a><span class=\"w\">    </span><span class=\"nf\">add</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a><span class=\"nl\">target:</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u8f6c\u5316\u4e3a\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a><span class=\"w\">    </span><span class=\"nf\">ifeqz_addi</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</span></code></pre></div>\n<p>\u8fd9\u5c31\u662f\u4e0a\u9762\u6240\u8bf4\u7684 SiFive \u5b9e\u73b0\u7684\u53ea\u8df3\u8fc7\u5355\u6761\u6307\u4ee4\u7684 Short Forward Branch\uff0c\u628a bne + add \u6307\u4ee4\u53d8\u6210\u4e86\u6761\u4ef6 add \u6307\u4ee4\uff0c\u5e76\u4e14\u81ea\u5e26\u548c 0 \u6bd4\u8f83\u7684\u903b\u8f91\uff1a\u5982\u679c x1 == 0\uff08ifeqz\uff0cif equals to zero\uff09\uff0c\u5c31\u8bbe\u7f6e x3 = x3 + 1\uff0c\u5426\u5219 x3 \u4fdd\u6301\u4e0d\u53d8\u3002\u7c7b\u4f3c\u5730\uff0c\u628a add \u6362\u6210 sub \u4e5f\u53ef\u4ee5\u7c7b\u4f3c\u5730\u505a\u878d\u5408\uff0c\u751a\u81f3\u8fde\u51fd\u6570\u8c03\u7528 jal \u6307\u4ee4\u4e5f\u53ef\u4ee5\u3002</p>\n<p>\u8fd8\u6709\u4e00\u4e2a\u6709\u8da3\u7684\u6307\u4ee4\u878d\u5408\u573a\u666f\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a><span class=\"w\">    </span><span class=\"nf\">beq</span><span class=\"w\"> </span><span class=\"no\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">skip</span>\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a><span class=\"w\">    </span><span class=\"nf\">j</span><span class=\"w\"> </span><span class=\"no\">target</span>\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a><span class=\"nl\">skip:</span>\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a><span class=\"w\">    </span><span class=\"c1\">// ...</span>\n</span><span id=\"__span-2-5\"><a id=\"__codelineno-2-5\" name=\"__codelineno-2-5\" href=\"#__codelineno-2-5\"></a><span class=\"nl\">target:</span>\n</span></code></pre></div>\n<p>\u53ef\u4ee5\u878d\u5408\u4e3a\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"w\">    </span><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"no\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">x9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">target</span>\n</span></code></pre></div>\n<p>\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\uff0c\u4e3a\u4ec0\u4e48\u7f16\u8bd1\u5668\u8981\u591a\u6b64\u4e00\u4e3e\uff0c\u4e0d\u76f4\u63a5\u751f\u6210\u4e00\u4e2a bne\uff1f\u7b54\u6848\u662f RISC-V \u7684 bne \u7684\u7acb\u5373\u6570\u8303\u56f4\u592a\u5c0f\uff0c\u8981\u60f3\u8df3\u5230\u66f4\u5927\u7684\u8303\u56f4\uff0c\u5c31\u9700\u8981\u7528 j \u6307\u4ee4\uff0c\u4e8e\u662f\u7f16\u8bd1\u5668\u53ea\u597d\u7528 beq + j \u7684\u7ec4\u5408\u6765\u5b9e\u73b0\u5927\u8303\u56f4\u7684 bne\u3002\u7136\u540e SiFive \u7684\u5904\u7406\u5668\u4f1a\u8bc6\u522b\u8fd9\u79cd\u6a21\u5f0f\uff0c\u628a\u5b83\u8f6c\u6362\u6210\u4e00\u6761 jne\uff1a\u6761\u4ef6\u5206\u652f\uff0c\u4f46\u53c8\u6709 j \u6307\u4ee4\u7684 imm \u8df3\u8f6c\u8303\u56f4\u3002\u8fd9\u4e5f\u633a\u6709\u610f\u601d\u7684\uff0c\u6307\u4ee4\u5728\u8bbe\u8ba1\u7684\u65f6\u5019\uff0c\u4e0d\u597d\u505a\u592a\u591a\u7684 imm \u4f4d\u6570\uff0c\u7f16\u8bd1\u5668\u56e0\u6b64\u751f\u6210\u4e86\u66f4\u590d\u6742\u7684\u4ee3\u7801\uff0c\u786c\u4ef6\u518d\u7ffb\u8bd1\u56de\u6765\u3002</p>\n<p>\u82f9\u679c\u7533\u8bf7\u4e86 <a href=\"https://patents.google.com/patent/US20240028339A1/en\">Using a Next Fetch Predictor Circuit with Short Branches and Return Fetch Groups</a> \u4e13\u5229\uff0c\u5b83\u548c\u4e0a\u9762\u63d0\u5230\u7684\u4f18\u5316\u4e0d\u592a\u4e00\u6837\uff0c\u4f46\u662f\u6709\u4e9b\u7c7b\u4f3c\u3002\u4e13\u5229\u91cc\u63d0\u5230\u4e86\u8fd9\u4e48\u51e0\u79cd\u60c5\u51b5\uff1a</p>\n<ul>\n<li>\u5982\u679c Fetch Group \u5185\u6709\u4e00\u4e2a\u8981\u8df3\u8f6c\u7684\u5206\u652f\u6307\u4ee4\u4f1a Forward \u8df3\u8f6c\u5230\u540c\u4e00\u4e2a Fetch Group \u5185\u90e8\uff0c\u539f\u6765\u7684\u505a\u6cd5\u662f\u4ece\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u518d Fetch \u4e00\u6b21\uff0c\u4f46\u65e2\u7136\u662f\u540c\u4e00\u4e2a Fetch Group\uff0cFetch \u5206\u652f\u6307\u4ee4\u7684\u540c\u65f6\uff0c\u5df2\u7ecf\u628a\u4ece\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u5f00\u59cb\u7684\u6307\u4ee4\u53d6\u8fdb\u6765\u4e86\uff0c\u8df3\u8fc7\u4e2d\u95f4\u7684\u6307\u4ee4\uff0c\u628a\u4e24\u6bb5\u6307\u4ee4\u62fc\u63a5\u8d77\u6765\uff0c\u53ef\u4ee5\u7701\u4e0b\u91cd\u65b0 Fetch \u4e00\u6b21\u7684\u65f6\u95f4\u3002</li>\n<li>\u5982\u679c Fetch Group \u5185\u6709\u4e00\u6761 call \u6307\u4ee4\uff0c\u5728\u539f\u6765\u7684\u505a\u6cd5\u91cc\uff0ccall \u6307\u4ee4\u4e4b\u540e\u7684\u6307\u4ee4\u5c31\u88ab\u4e22\u5f03\u4e86\uff0c\u7b49\u5230\u672a\u6765 return \u56de\u6765\u7684\u65f6\u5019\uff0c\u518d\u91cd\u65b0 Fetch \u4e00\u6b21\uff1b\u4e13\u5229\u91cc\u7684\u505a\u6cd5\u662f\uff0c\u5728 call \u7684\u65f6\u5019\uff0c\u628a call \u6307\u4ee4\u4e4b\u540e\u7684\u6307\u4ee4\u4fdd\u5b58\u4e0b\u6765\uff0c\u5f53\u672a\u6765 return \u56de\u6765\u7684\u65f6\u5019\uff0c\u4e0d\u518d\u91cd\u65b0 Fetch\uff0c\u800c\u662f\u53d6\u51fa\u4fdd\u5b58\u4e0b\u6765\u7684 call \u6307\u4ee4\u4e4b\u540e\u7684\u6307\u4ee4\uff0c\u8fd9\u6837\u5c31\u8282\u7701\u4e86\u91cd\u65b0 Fetch \u4e00\u6b21\u7684\u65f6\u95f4\u3002</li>\n</ul>\n<p>\u56e0\u6b64\u5b83\u7684\u76ee\u7684\u4e3b\u8981\u662f\u89e3\u51b3\u91cd\u590d Fetch \u7684\u80fd\u8017\u95ee\u9898\uff0c\u800c\u4e0d\u662f\u5206\u652f\u9884\u6d4b\u9519\u8bef\u7387\u9ad8\u7684\u95ee\u9898\u3002</p>\n<h2 id=\"clustered-decode\">Clustered Decode<a class=\"headerlink\" href=\"#clustered-decode\" title=\"Permanent link\">&para;</a></h2>\n<p>\u63a8\u8350\u9605\u8bfb\uff1a<a href=\"https://zhuanlan.zhihu.com/p/720301269\">\u89e3\u7801\u7c07\u4e8c\u4e09\u4e8b\uff08\u4e00\uff09\uff1a\u4e3a\u4ec0\u4e48\uff1f&amp;\u52a0\u6599\uff01</a></p>\n<p>Intel \u7684 E \u6838\u4ece Tremont \u5fae\u67b6\u6784\u5f00\u59cb\u5b9e\u73b0\u4e86 Clustered Decode\uff0c\u4ece Goldmont Plus \u5fae\u67b6\u6784\u7684\u4f20\u7edf\u7684 3-wide decode\uff0c\u53d8\u6210\u4e86\u4e24\u6761 3-wide decode \u7684\u6d41\u6c34\u7ebf\uff0c\u52a0\u8d77\u6765\u5b9e\u73b0 6-wide decode \u7684\u6548\u679c\u3002\u4f46\u662f\u8fd9\u4e24\u4e2a\u6d41\u6c34\u7ebf\u600e\u4e48\u534f\u540c\u5de5\u4f5c\u5462\uff1f</p>\n<p>Intel \u5728 <a href=\"https://cdrdv2-public.intel.com/671488/248966-046A-software-optimization-manual.pdf\">Software Optimization Manual</a> \u4e2d\u662f\u8fd9\u4e48\u63cf\u8ff0\u7684\uff1a</p>\n<blockquote>\n<p>Tremont microarchitecture has a 32B predict pipeline that feeds dual 3-wide decode clusters capable of 6 instruction decode per cycle. Each cluster can access a banked 32KB instruction cache at 16B/cycle for a maximum of 32B/cycle.</p>\n</blockquote>\n<p>ICache \u5206\u6210\u4e24\u4e2a bank\uff0c\u4e24\u4e2a bank \u53ef\u4ee5\u540c\u65f6\u8bbf\u95ee\uff0c\u6bcf\u4e2a bank \u63d0\u4f9b 16B/cycle \u7684\u5e26\u5bbd\uff0c\u5bf9\u5e94\u4e24\u4e2a decode pipeline\u3002\u7531\u4e8e\u4e0d\u540c\u7684 bank \u53ef\u4ee5\u7528\u4e0d\u540c\u7684\u5730\u5740\u7684\u8bbf\u95ee\uff0c\u8fd9\u610f\u5473\u7740\u8fd9\u4e24\u6b21\u8bbf\u95ee\u53ef\u4ee5\u8bbf\u95ee\u4e0d\u540c cacheline \u5185\u7684\u6307\u4ee4\uff0c\u8fd9\u6b63\u597d\u5bf9\u5e94\u4e86\u6307\u4ee4\u6d41\u91cc\u6709\u8df3\u8f6c\u7684\u60c5\u51b5\uff1a</p>\n<p>\u5047\u5982\u6709\u4e00\u6bb5\u6307\u4ee4\uff08\u4e0b\u9762\u7684\u6307\u4ee4\u6d41 A\uff09\uff0c\u6700\u540e\u4e00\u6761\u6307\u4ee4\u4f1a\u8df3\u8f6c\u5230\u53e6\u4e00\u4e2a\u5730\u5740\uff08\u4e0b\u9762\u7684 1: label\uff09\uff0c\u5206\u652f\u9884\u6d4b\u5668\u5728\u770b\u5230\u8fd9\u4e2a\u6a21\u5f0f\u540e\uff0c\u5c31\u53ef\u4ee5\u8ba9\u4e24\u4e2a decode cluster \u5206\u522b\u5904\u7406\u8df3\u8f6c\u524d\u7684\u4ee3\u7801\uff08\u6307\u4ee4\u6d41 A \u5185\u7684 <code>dec + jne</code>\uff09\u548c\u8df3\u8f6c\u540e\u7684\u4ee3\u7801\uff08\u6307\u4ee4\u6d41 B \u5185\u7684 <code>mov</code>\uff09\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a><span class=\"c1\"># instruction stream A</span>\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a><span class=\"nf\">dec</span><span class=\"w\"> </span><span class=\"nv\">%rsi</span>\n</span><span id=\"__span-4-3\"><a id=\"__codelineno-4-3\" name=\"__codelineno-4-3\" href=\"#__codelineno-4-3\"></a><span class=\"nf\">jne</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"no\">f</span>\n</span><span id=\"__span-4-4\"><a id=\"__codelineno-4-4\" name=\"__codelineno-4-4\" href=\"#__codelineno-4-4\"></a>\n</span><span id=\"__span-4-5\"><a id=\"__codelineno-4-5\" name=\"__codelineno-4-5\" href=\"#__codelineno-4-5\"></a><span class=\"c1\"># instruction stream B</span>\n</span><span id=\"__span-4-6\"><a id=\"__codelineno-4-6\" name=\"__codelineno-4-6\" href=\"#__codelineno-4-6\"></a><span class=\"err\">1:</span>\n</span><span id=\"__span-4-7\"><a id=\"__codelineno-4-7\" name=\"__codelineno-4-7\" href=\"#__codelineno-4-7\"></a><span class=\"nf\">mov</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">(</span><span class=\"nv\">%rsp</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">%rdi</span>\n</span></code></pre></div>\n<p>\u8fd9\u6837\u5c31\u5728\u4fdd\u6301\u786c\u4ef6\u5b9e\u73b0\u6bd4\u8f83\u7b80\u5355\u7684\u524d\u63d0\u4e0b\uff0c\u5b9e\u73b0\u4e86\u6bd4\u8f83\u5bbd\u7684 decode width\uff08Intel \u539f\u6587\uff1a<code>Whereas increasing decode width in a traditional fashion for x86 requires exponential resources and triggers efficiency loss, clustering allows for x86 decode to be built with linear resources and little efficiency loss.</code>\uff09\u3002\u8fd9\u5bf9\u4e8e x86 \u6765\u8bf4\u662f\u6bd4\u8f83\u96be\u63d0\u5347\u7684\uff0c\u56e0\u4e3a\u6307\u4ee4\u662f\u53d8\u957f\u7684\uff0c\u5982\u679c\u4e0d\u77e5\u9053\u6307\u4ee4\u4ece\u54ea\u91cc\u5f00\u59cb\uff0c\u8bd1\u7801\u5c06\u4f1a\u5341\u5206\u590d\u6742\u800c\u4e14\u4e32\u884c\u3002\u53ef\u4ee5\u770b\u5230 ARM \u9635\u8425\u7684\u9ad8\u6027\u80fd\u5904\u7406\u5668\u5728 decode width \u4e0a\u6709\u4e00\u5b9a\u7684\u9886\u5148\uff0c\u4e5f\u662f\u56e0\u4e3a ARMv8 \u662f\u5b9a\u957f\u6307\u4ee4\u96c6\u3002</p>\n<p>\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4e5f\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u5047\u5982\u6ca1\u6709\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u600e\u4e48\u529e\uff1f\u5982\u679c\u9047\u5230\u4e00\u5927\u6bb5\u6ca1\u6709\u5206\u652f\u7684\u6307\u4ee4\uff0c\u4f3c\u4e4e\u5c31\u53ea\u80fd\u7528\u4e0a 3-wide decode\uff0c\u90a3\u4e48\u8fd9\u5f88\u5bb9\u6613\u6210\u4e3a\u4e00\u4e2a\u74f6\u9888\u3002Tremont \u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5efa\u8bae\u7528\u6237\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u63d2\u5165\u4e00\u4e9b jmp \u6307\u4ee4\u3002</p>\n<p>Intel \u5728 Tremont \u7684\u4e0b\u4e00\u4ee3 Gracemont \u5fae\u67b6\u6784\u4e2d\u7f13\u89e3\u4e86\u8fd9\u4e2a\u74f6\u9888\u3002\u65e2\u7136\u63d2\u5165\u4e00\u4e9b jmp \u6307\u4ee4\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u7531\u786c\u4ef6\u81ea\u52a8\u63d2\u5165\u4e00\u4e9b\u4f2a jmp \u6307\u4ee4\uff0c\u4e5f\u89e3\u51b3\u4e86\u540c\u6837\u7684\u95ee\u9898\uff0c\u8fd9\u5c31\u662f Gracemont \u7684\u89e3\u51b3\u601d\u8def\uff1a</p>\n<blockquote>\n<p>Gracemont microarchitecture addresses this bottleneck by introducing a hardware load-balancer. When the hardware detects long basic blocks, additional toggle points can be created based on internal heuristics. These toggle points are added to the predictors, thus guiding the machine to toggle within the basic block.</p>\n</blockquote>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u786c\u4ef6\u4f1a\u68c0\u6d4b\u8fd9\u79cd\u957f\u7684\u8fde\u7eed\u6307\u4ee4\u5757\uff08\u4f8b\u5982\u8fde\u7eed 32 \u6761\u6307\u4ee4\u90fd\u6ca1\u6709\u4e00\u4e2a\u8df3\u8f6c\u7684\u6307\u4ee4\uff09\uff0c\u9002\u65f6\u63d2\u5165\u4e00\u4e9b toggle point\uff08\u4f8b\u5982\u63d2\u5230\u7b2c 24 \u6761\u6307\u4ee4\u540e\u9762\uff09\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684\u4f2a jmp \u6307\u4ee4\uff0c\u8fd9\u6761\u6307\u4ee4\u5e76\u4e0d\u5b58\u5728\uff0c\u800c\u662f\u5728\u5206\u652f\u9884\u6d4b\u5668\u4e2d\u505a\u6807\u8bb0\uff0c\u90a3\u4e48\u672a\u6765\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u4e24\u6761 Decode Pipeline \u4e86\uff1a</p>\n<blockquote>\n<p>If there are no natural toggle points (i.e., taken branches) within 32 uops, the hardware will insert a toggle point on the instruction after or corresponding to the 24th uop of the stream. As inserted toggle points consume resources in the predictor, it typically doesn't insert immediately but rather marks the location of the instruction in a table of addresses. If the same inserted toggle point is marked a second time, it allocates this location into the predictor.</p>\n</blockquote>\n<p>\u6b64\u5916\uff0c\u4e3a\u4e86\u89e3\u51b3\u53d8\u957f\u6307\u4ee4\u96c6\u7684\u8bd1\u7801\u95ee\u9898\uff0c\u8fd8\u6709\u4e00\u4e2a\u4f18\u5316\uff1a\u5728 ICache \u4e2d\u6807\u8bb0\u6bcf\u6761\u6307\u4ee4\u7684\u8fb9\u754c\uff0c\u8fd9\u6837\u8bd1\u7801\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5feb\u901f\u5bfb\u627e\u5230\u6307\u4ee4\u8fb9\u754c\uff0c\u4ece\u6307\u4ee4\u8fb9\u754c\u5e76\u884c\u5730\u8fdb\u884c\u8bd1\u7801\uff0c\u800c\u4e0d\u7528\u5148\u5224\u65ad\u7b2c\u4e00\u6761\u6307\u4ee4\u6709\u591a\u957f\uff0c\u518d\u627e\u5230\u7b2c\u4e8c\u6761\u6307\u4ee4\u5728\u54ea\uff0c\u518d\u5224\u65ad\u7b2c\u4e8c\u6761\u6307\u4ee4\u6709\u591a\u957f\uff0c\u518d\u53bb\u627e\u7b2c\u4e09\u6761\u6307\u4ee4\u3002\u4e0d\u8fc7\u8fd9\u4e2a\u4fe1\u606f\u600e\u4e48\u6765\u5462\uff1f</p>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f\u5728 ICache \u4e2d\u8fdb\u884c\u9884\u8bd1\u7801\uff08Pre-decode\uff09\uff0c\u5f53 ICache \u5728 refill \u7684\u65f6\u5019\uff0c\u5c31\u8fdb\u884c\u4e00\u5b9a\u7684\u8bd1\u7801\uff0c\u628a\u6307\u4ee4\u8fb9\u754c\u6807\u8bb0\u51fa\u6765\u3002\u4f46 x86 \u7684\u6307\u4ee4\u4ece\u4e0d\u540c\u4f4d\u7f6e\u5f00\u59cb\u8bd1\u7801\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u4e5f\u56e0\u4e3a\u8fd9\u4e00\u70b9 ROP \u653b\u51fb\u5728 x86 \u4e0a\u6bd4\u8f83\u5bb9\u6613\u5b9e\u73b0\u3002\u8fd9\u5bf9\u4e8e\u9884\u8bd1\u7801\u4e5f\u5e26\u6765\u4e86\u56f0\u96be\uff0c\u4e0d\u77e5\u9053\u4ece\u54ea\u4e2a\u5b57\u8282\u5f00\u59cb\u6267\u884c\u3002</p>\n<p>\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u7b49\u5230\u8bd1\u7801\u7684\u65f6\u5019\uff0c\u5148\u68c0\u67e5\u4e00\u4e0b\u6709\u6ca1\u6709\u6307\u4ee4\u8fb9\u754c\u7684\u4fe1\u606f\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u4e34\u65f6\u8017\u8d39\u4e24\u4e2a\u5468\u671f\u6765\u8fdb\u884c\u9884\u8bd1\u7801\u7684\u64cd\u4f5c\uff0c\u628a\u6307\u4ee4\u8fb9\u754c\u6807\u8bb0\u51fa\u6765\uff0c\u628a\u7ed3\u679c\u5199\u5165 ICache \u4e2d\u3002\u7531\u4e8e\u6b64\u65f6\u5df2\u7ecf\u4ece\u5206\u652f\u9884\u6d4b\u5668\u77e5\u9053\u4e86\u6307\u4ee4\u6267\u884c\u7684\u8d77\u59cb\u5730\u5740\uff0c\u6240\u4ee5\u5f97\u5230\u7684\u7ed3\u679c\u66f4\u52a0\u7cbe\u786e\u3002\u8fd9\u4e2a\u65b9\u6cd5\u5728 Gracemont \u4e2d\u91c7\u7528\uff0c\u53eb\u505a On Demand Instruction Length Decoder\uff08OD-ILD\uff09\uff0c\u987e\u540d\u601d\u4e49\uff0c\u5b83\u7684\u8bd1\u7801\u7ed3\u679c\u662f\u6307\u4ee4\u7684\u957f\u5ea6\uff0c\u4e5f\u5c31\u5f97\u5230\u4e86\u6307\u4ee4\u7684\u8fb9\u754c\u4fe1\u606f\uff1a</p>\n<blockquote>\n<p>Instead of a second level predecode cache, the Gracemont microarchitecture introduces an \u201con-demand\u201d instruction length decoder (OD-ILD). This block is typically only active when new instruction bytes are brought into the instruction cache from a miss. When this happens, two extra cycles are added to the fetch pipeline in order to generate predecode bits on the fly.</p>\n</blockquote>\n<p>\u8fd9\u4e2a\u65b9\u6cd5\u5728 Intel \u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US20220100516A1/en\">Circuitry and methods for power efficient generation of length markers for a variable length instruction set</a> \u6709\u6bd4\u8f83\u8be6\u7ec6\u7684\u63cf\u8ff0\u3002</p>\n<p>Intel \u5728 Skymont \u8fd9\u4e00\u4ee3 E-core \u5fae\u67b6\u6784\u5728\u5927\u5927\u62d3\u5bbd\u540e\u7aef\u7684\u540c\u65f6\uff0c\u628a Decode \u4ece\u4e24\u6761 3-wide pipeline \u6539\u6210\u4e86\u4e09\u6761 3-wide pipeline\uff0c\u90a3\u4e48\u600e\u4e48\u628a\u8fd9\u4e09\u6761 Decode pipeline \u5582\u6ee1\uff0c\u662f\u7ee7\u7eed\u5ef6\u7eed\u4e0a\u9762\u7684\u601d\u8def\uff0c\u53ea\u4e0d\u8fc7\u63d2\u5165\u66f4\u591a\u7684 toggle point\uff0c\u8fd8\u662f\u6709\u4e00\u4e9b\u65b0\u7684\u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u62ed\u76ee\u4ee5\u5f85\u3002</p>\n<h2 id=\"btb-organization\">BTB Organization<a class=\"headerlink\" href=\"#btb-organization\" title=\"Permanent link\">&para;</a></h2>\n<p>BTB \u7684\u76ee\u7684\u662f\u5728\u5206\u652f\u9884\u6d4b\u9636\u6bb5\uff0c\u63d0\u4f9b\u54ea\u4e9b\u6307\u4ee4\u662f\u5206\u652f\u6307\u4ee4\uff0c\u4ee5\u53ca\u8fd9\u4e9b\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u7684\u4fe1\u606f\u3002\u90a3\u4e48 BTB \u662f\u600e\u4e48\u4fdd\u5b58\u8fd9\u4e9b\u4fe1\u606f\u7684\u5462\uff1f\u8bba\u6587 <a href=\"https://dl.acm.org/doi/pdf/10.1145/3613424.3623774\">Branch Target Buffer Organizations</a> \u603b\u7ed3\u4e86\u51e0\u79cd\u5e38\u89c1\u7684 BTB \u7ec4\u7ec7\u65b9\u6cd5\uff1a</p>\n<ol>\n<li>\u7b2c\u4e00\u79cd\u65b9\u6cd5\uff1aI-BTB\uff0cInstruction BTB\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u53ef\u80fd\u51fa\u73b0\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0c\u90fd\u8fdb\u884c\u4e00\u6b21 BTB \u67e5\u8be2\uff0c\u770b\u770b\u8fd9\u4e2a\u5730\u5740\u662f\u4e0d\u662f\u6709\u5206\u652f\u6307\u4ee4\u3002\u6b64\u65f6 BTB entry \u53ea\u9700\u8981\u8bb0\u5f55 tag\uff08\u7528\u4e8e\u7ec4\u76f8\u8fde\u7684 Way \u5339\u914d\uff09\u3001branch type \u548c branch target\u3002\u4ee5 ARMv8 \u4e3a\u4f8b\uff0c\u6307\u4ee4\u90fd\u662f 4 \u5b57\u8282\uff0c\u5047\u5982\u8981\u5bf9 32 \u5b57\u8282\u7684\u5757\u8fdb\u884c\u9884\u6d4b\uff0c\u90a3\u4e48\u5c31\u8981\u5bf9\u8fd9 32 \u5b57\u8282\u7684 8 \u4e2a 4 \u5b57\u8282\u90fd\u8fdb\u884c\u4e00\u6b21 BTB \u67e5\u8be2\uff0c\u5f97\u5230\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u4e0a\u7684\u5206\u652f\u4fe1\u606f\u3002x86 \u7684\u8bdd\u6bcf\u4e2a\u5b57\u8282\u90fd\u53ef\u80fd\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7528\u8fd9\u6837\u7684\u65b9\u6cd5\u9700\u8981\u67e5\u8be2\u7684\u6b21\u6570\u8fc7\u591a\u3002</li>\n<li>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff1aR-BTB\uff0cRegion BTB\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u5bf9\u9f50\u7684\u5757\uff0c\u8bb0\u5f55\u8fd9\u4e2a\u5757\u5185\u7684\u6709\u9650\u6761\u5206\u652f\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u5bf9\u6bcf\u4e2a\u5bf9\u9f50\u5230 32 \u5b57\u8282\u7684\u5757\uff0c\u8bb0\u5f55\u6700\u591a 4 \u6761\u5206\u652f\u3002\u6b64\u65f6 BTB entry \u9700\u8981\u8bb0\u5f55 tag\uff08\u7528\u4e8e\u7ec4\u76f8\u8fde\u7684 Way \u5339\u914d\uff09\u3001\u6bcf\u6761\u5206\u652f\u7684 offset\u3001\u7c7b\u578b \u548c target\u3002\u8fd9\u6837 BTB \u67e5\u8be2\u7684\u6b21\u6570\u4f1a\u6bd4\u8f83\u5c11\uff0c\u4f46\u5982\u679c\u4e00\u4e2a\u5757\u5185\u5206\u652f\u592a\u591a\uff0c\u4f1a\u51fa\u73b0\u5b58\u4e0d\u4e0b\u7684\u60c5\u51b5\u3002</li>\n<li>\u7b2c\u4e09\u79cd\u65b9\u6cd5\uff1aB-BTB\uff0cBlock BTB\uff0c\u8bb0\u5f55\u7684\u662f\u4ece\u67d0\u4e2a PC \u5f00\u59cb\u8fde\u7eed\u7684\u4e00\u6bb5\u6307\u4ee4\uff0c\u8fd9\u6bb5\u6307\u4ee4\u4e0d\u80fd\u6709\u591a\u4e8e n \u6761\u5206\u652f\uff0c\u5e76\u4e14\u4e0d\u80fd\u591a\u4e8e m \u6761\u6307\u4ee4\u6216 m \u4e2a\u5b57\u8282\u3002\u6b64\u65f6 BTB entry \u9700\u8981\u8bb0\u5f55 tag\uff08\u7528\u4e8e\u7ec4\u76f8\u8fde\u7684 Way \u5339\u914d\uff09\u3001\u6bcf\u6761\u5206\u652f\u7684 offset\u3001\u7c7b\u578b \u548c target\u3002\u8fd9\u79cd\u65b9\u6cd5\u5728\u5206\u652f\u5f88\u5bc6\u96c6\u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u7528\u591a\u4e2a BTB entry \u4fdd\u5b58\u8fd9\u4e9b\u5206\u652f\u3002\u6b64\u5916\u4e5f\u6bd4\u8f83\u65b9\u4fbf\u505a 2 predictions/cycle\uff1a\u540c\u65f6\u9884\u6d4b\u4e24\u4e2a\u6761\u4ef6\u5206\u652f\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5206\u652f\u4e0d\u8df3\u8f6c\uff0c\u90a3\u5c31\u7528\u7b2c\u4e8c\u4e2a\u5206\u652f\u7684\u7ed3\u679c\u3002\u4f46\u540c\u4e00\u4e2a\u5206\u652f\u53ef\u80fd\u91cd\u590d\u4fdd\u5b58\u5728\u591a\u4e2a BTB entry \u4e2d\uff0c\u56e0\u4e3a\u5165\u53e3 PC \u53ef\u80fd\u4e0d\u540c\u3002</li>\n</ol>\n<p>\u4e0b\u9762\u770b\u4e00\u4e9b\u4f8b\u5b50\uff0c\u4f8b\u5982 AMD \u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/software-optimization-guides/56665.zip\">Software Optimization Guide for AMD EPYC\u2122 7003 Processors</a> \u4e2d\u6709\u5982\u4e0b\u8868\u8ff0\uff1a</p>\n<blockquote>\n<p>Each BTB entry includes information for branches and their targets. Each BTB\nentry can hold up to two branches if the last bytes of the branches reside in the same 64-byte aligned\ncache line and the first branch is a conditional branch.</p>\n</blockquote>\n<p>\u8fd9\u548c\u4e0a\u9762\u6240\u8bf4\u7684 B-BTB \u662f\u7c7b\u4f3c\u7684\uff0c\u5982\u679c\u4e24\u6761\u5206\u652f\u5728\u540c\u4e00\u4e2a 64B \u5bf9\u9f50\u7684 cacheline \u5185\uff0c\u5e76\u4e14\u7b2c\u4e00\u6761\u5206\u652f\u662f\u6761\u4ef6\u5206\u652f\uff0c\u5c31\u53ef\u4ee5\u4fdd\u5b58\u5728\u540c\u4e00\u4e2a BTB entry \u5185\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e00\u4e2a BTB entry \u53ef\u4ee5\u4fdd\u5b58 1 \u5230 2 \u6761\u5206\u652f\u3002</p>\n<p>\u9999\u5c71<a href=\"https://raw.githubusercontent.com/OpenXiangShan/XiangShan-doc/main/slides/20220825-RVSC-%E9%A6%99%E5%B1%B1%E5%A4%84%E7%90%86%E5%99%A8%E5%89%8D%E7%AB%AF%E5%8F%96%E6%8C%87%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B.pdf\">\u5357\u6e56\u5fae\u67b6\u6784</a>\u4e5f\u91c7\u7528\u4e86\u7c7b\u4f3c\u7684<a href=\"https://docs.xiangshan.cc/zh-cn/latest/frontend/bp/\">B-BTB \u8bbe\u8ba1</a>\uff0c\u4e0b\u9762\u662f\u9999\u5c71\u5fae\u67b6\u6784\u6587\u6863\u7684\u622a\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-ftb.png\" /></p>\n<p>\u5982\u679c\u7a0b\u5e8f\u91cc\u6709\u5f88\u591a\u7ecf\u5e38\u6216\u8005\u603b\u662f\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u90a3\u4e48\u4e0a\u9762\u8fd9\u79cd B-BTB \u8bbe\u8ba1\u5c31\u6709\u4e00\u4e9b\u6d6a\u8d39\uff0c\u56e0\u4e3a\u627e\u4e0d\u5230\u5f88\u591a\u6761\u4ef6\u5206\u652f + \u5206\u652f\u7684\u7ec4\u5408\uff0c\u5373\u4f7f\u627e\u5230\u4e86\uff0c\u5982\u679c\u6761\u4ef6\u5206\u652f\u603b\u662f\u8df3\u8f6c\uff0c\u90a3\u4e48\u7b2c\u4e8c\u6761\u5206\u652f\u5c31\u6d6a\u8d39\u4e86\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cAMD \u5728 <a href=\"https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/software-optimization-guides/57647.zip\">Software Optimization Guide for the AMD Zen4 Microarchitecture</a> \u4e2d\u63d0\u5230\u4e00\u79cd\u89e3\u51b3\u65b9\u6848\uff1a</p>\n<blockquote>\n<p>Each BTB entry can hold up to two branches, and two pair cases are supported:\n\u2022 A conditional branch followed by another branch with both branches having their last byte in the\nsame 64 byte aligned cacheline.\n\u2022 A direct branch (excluding CALLs) followed by a branch ending within the 64 byte aligned\ncacheline containing the target of the first branch.\nPredicting with BTB pairs allows two fetches to be predicted in one prediction cycle.</p>\n</blockquote>\n<p>\u53ef\u4ee5\u770b\u5230\u7b2c\u4e00\u79cd\u60c5\u51b5\u5c31\u662f\u524d\u9762 Zen 3 \u7684\u6a21\u5f0f\uff0c\u4e00\u4e2a cacheline \u5185\uff0c\u6761\u4ef6\u5206\u652f + \u5206\u652f\uff1b\u7b2c\u4e8c\u79cd\u60c5\u51b5\u5c31\u662f\u65b0\u7684\u8bbe\u8ba1\uff0c\u5b83\u53ef\u4ee5\u8bb0\u5f55\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7b2c\u4e8c\u6761\u5206\u652f\u6307\u4ee4\u548c\u7b2c\u4e00\u6761\u5206\u652f\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\u5728\u540c\u4e00\u4e2a cacheline \u4e2d\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a BTB \u8bb0\u5f55\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7b2c\u4e00\u6761\u8df3\u5230\u7b2c\u4e8c\u6761\uff0c\u7b2c\u4e8c\u6761\u518d\u8df3\u8f6c\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4e00\u4e2a\u5468\u671f\u7ed9\u51fa\u4e24\u4e2a Fetch Bundle\uff0c\u4e5f\u5c31\u662f 2 taken predictions/cycle\u3002\u8bba\u6587\u4e2d\u8fd9\u79cd\u8bbe\u8ba1\u53eb\u505a MB-BTB\u3002</p>\n<p>\u63a8\u8350\u9605\u8bfb\uff1a<a href=\"https://blog.eastonman.com/blog/2023/12/modern-branch-prediction-from-academy-to-industry/\">\u73b0\u4ee3\u5206\u652f\u9884\u6d4b\uff1a\u4ece\u5b66\u672f\u754c\u5230\u5de5\u4e1a\u754c</a></p>\n<h2 id=\"instruction-prefetcher\">Instruction Prefetcher<a class=\"headerlink\" href=\"#instruction-prefetcher\" title=\"Permanent link\">&para;</a></h2>\n<p>\u968f\u7740\u7a0b\u5e8f\u7684\u6307\u4ee4 footprint \u589e\u5927\uff0c\u9664\u4e86\u589e\u5927 L1 ICache \u5bb9\u91cf\uff0c\u4e5f\u9700\u8981\u5b9e\u73b0\u5408\u7406\u7684 Instruction Prefetcher\uff0c\u628a\u6307\u4ee4\u9884\u53d6\u5230 L1 ICache \u5f53\u4e2d\u3002\u5bf9\u4e8e Decoupled Frontend\uff0c\u76ee\u524d\u6bd4\u8f83\u5e38\u89c1\u7684\u65b9\u6cd5\u662f\u4f7f\u7528 <a href=\"https://ieeexplore.ieee.org/document/809439\">Fetch Directed Intruction Prefetching(FDIP)</a>\uff0c\u5229\u7528 Decoupled Frontend \u91cc\u5206\u652f\u9884\u6d4b\u53ef\u4ee5\u5728\u53d6\u6307\u4e4b\u524d\u8dd1\u5f97\u66f4\u8fdc\u7684\u7279\u6027\uff0c\u4f7f\u7528\u5206\u652f\u9884\u6d4b\u7684\u5730\u5740\u6765\u8fdb\u884c\u9884\u53d6\u3002\u5177\u4f53\u5730\uff0cDecoupled Frontend \u4f1a\u628a\u5206\u652f\u9884\u6d4b\u5f97\u5230\u7684\u5730\u5740\u5199\u5165 Fetch Target Queue(FTQ)\uff0c\u8fd9\u4e9b\u5730\u5740\u7531 ICache \u6765\u6d88\u8d39\u3002\u4e0e\u6b64\u540c\u65f6\uff0cFTQ \u4e2d\u7684\u5730\u5740\u4e5f\u4f1a\u7528\u4e8e\u6307\u4ee4\u9884\u53d6\uff0c\u7ed3\u6784\u5982\u8bba\u6587\u4e2d\u7684\u56fe 1\uff1a</p>\n<p><img alt=\"\" src=\"../../../../brief-into-ooo-3-fdip.png\" /></p>\n<p>\u5bf9\u4e8e Coupled Frontend\uff0c\u9884\u6d4b\u548c\u53d6\u6307\u7d27\u5bc6\u76f8\u8fde\uff0cFDIP \u7684\u65b9\u6cd5\u5c31\u4e0d\u597d\u7528\u4e86\uff0c\u9700\u8981\u5bfb\u627e\u5176\u4ed6\u7684\u65b9\u6cd5\u3002</p>\n<p>\u4e00\u79cd\u65b9\u6cd5\u662f Call Graph Prefetching(CGP)\uff0c\u6765\u81ea\u8bba\u6587 <a href=\"https://ieeexplore.ieee.org/abstract/document/903270\">Call graph prefetching for database applications</a>\u3002\u4ece\u540d\u5b57\u4e5f\u53ef\u4ee5\u770b\u51fa\uff0c\u5b83\u9488\u5bf9\u7684\u662f\u6570\u636e\u5e93\u573a\u666f\uff0c\u800c\u8fd9\u4e2a\u573a\u666f\u4e0b\uff0c\u4ee3\u7801\u7684\u89c4\u6a21\u5f88\u5927\uff0c\u66f4\u52a0\u5bb9\u6613\u51fa\u73b0 ICache Miss\u3002</p>\n<p>\u5b83\u7684\u6838\u5fc3\u601d\u8def\u662f\uff0c\u7ef4\u62a4\u4e00\u4e2a Call Graph History Cache(CGHC) \u6765\u8bb0\u5f55\u7a0b\u5e8f\u6267\u884c\u7684\u8c03\u7528\u56fe\uff0c\u6839\u636e\u5386\u53f2\u4fe1\u606f\u6765\u9884\u53d6\u672a\u6765\u53ef\u80fd\u4f1a\u6267\u884c\u7684\u51fd\u6570\u7684\u6307\u4ee4\uff0c\u8fd9\u9488\u5bf9\u7684\u662f\u9891\u7e41\u7684\u51fd\u6570\u8c03\u7528\uff1b\u9488\u5bf9\u51fd\u6570\u4f53\u6bd4\u8f83\u5927\u7684\u60c5\u51b5\uff0c\u51fd\u6570\u8c03\u7528\u7684\u6bd4\u4f8b\u6bd4\u8f83\u5c0f\uff0c\u5229\u7528 Next N-Line Prefetching\uff0c\u4e5f\u5c31\u662f\u5728 miss \u7684\u65f6\u5019\u628a\u8fde\u7eed\u7684\u51e0\u6761\u7f13\u5b58\u884c\u9884\u53d6\u8fdb\u6765\u3002</p>\n<p>\u90a3\u4e48\u8fd9\u4e2a Call Graph History Cache \u662f\u600e\u4e48\u7ef4\u62a4\u51fd\u6570\u8c03\u7528\u7684\u5462\uff1f\u5b83\u8bb0\u5f55\u4e86\u4e24\u4e2a Array\uff1aTag Array \u548c Data Array\u3002Tag Array \u8bb0\u5f55\u7684\u662f\u51fd\u6570\u7684\u5165\u53e3\u5730\u5740\uff0c\u4ee5\u53ca\u5728\u8fd9\u4e2a\u51fd\u6570\u5185\u6267\u884c\u5230\u4e86\u7b2c\u51e0\u4e2a\u51fd\u6570\uff08Index\uff09\uff1bData Array \u5219\u8bb0\u5f55\u4e86\u88ab\u8be5\u51fd\u6570\u8c03\u7528\u7684\u51fd\u6570\u7684\u5165\u53e3\u5730\u5740\uff0c\u6700\u591a\u516b\u4e2a\u3002\u4f8b\u5982\u51fd\u6570 A \u4f1a\u8c03\u7528\u51fd\u6570 B \u548c C\uff0c\u90a3\u4e48 CGHC \u4f1a\u4fdd\u5b58\u8fd9\u4e48\u4e00\u6761\u8bb0\u5f55\uff1a</p>\n<ul>\n<li>Tag Array\uff1a\u8bb0\u5f55\u51fd\u6570 A \u7684\u5165\u53e3\u5730\u5740\u4ee5\u53ca Index\uff0cIndex \u521d\u59cb\u5316\u4e3a 1</li>\n<li>Data Array\uff1a\u8bb0\u5f55\u51fd\u6570 B \u548c C \u7684\u5730\u5740</li>\n</ul>\n<p>\u5f53\u524d\u7aef\u901a\u8fc7\u5206\u652f\u9884\u6d4b\uff0c\u9884\u6d4b\u5230\u8981\u6267\u884c\u51fd\u6570 A\uff0c\u90a3\u4e48\u5c31\u901a\u8fc7 A \u7684\u5730\u5740\u53bb\u67e5\u8be2 Tag Array\uff0c\u627e\u5230\u5339\u914d\uff0c\u5e76\u4e14\u53d1\u73b0\u5176 Index \u7b49\u4e8e 1\uff1b\u90a3\u4e48\u63a5\u7740\u7528 Index \u8bbf\u95ee Data Array\uff0c\u53d6\u51fa\u7b2c\u4e00\u4e2a\u51fd\u6570\u7684\u5730\u5740\uff0c\u4e5f\u5c31\u662f B\uff0c\u90a3\u5c31\u9884\u53d6 B\u3002\u5f53\u51fd\u6570 B \u88ab\u8c03\u7528\u7684\u65f6\u5019\uff0c\u66f4\u65b0 Index \u4e3a 2\uff0c\u8868\u793a\u51fd\u6570 B \u5df2\u7ecf\u88ab\u8c03\u7528\uff0c\u4e0b\u4e00\u4e2a\u8981\u88ab\u8c03\u7528\u7684\u662f C\u3002\u5f53\u51fd\u6570 B \u8fd4\u56de\u7684\u65f6\u5019\uff0c\u7528 Index \u8bbf\u95ee Data Array\uff0c\u5f97\u5230\u51fd\u6570 C \u7684\u5730\u5740\uff0c\u9884\u53d6 C\u3002\u5982\u679c\u8bf4 Call Graph \u662f\u4e2a\u56fe\uff0c\u90a3\u4e48 Tag Array \u548c Data Array \u5c31\u7ec4\u6210\u4e86\u90bb\u63a5\u8868\u3002</p>\n<p>\u82f9\u679c\u7684\u4e13\u5229 <a href=\"https://patentimages.storage.googleapis.com/4d/f2/31/acf69ce6f289ff/US10642618.pdf\">Callgraph Signature Prefetch</a> \u4f7f\u7528\u4e86\u7c7b\u4f3c\u7684\u601d\u60f3\uff0c\u4e0d\u8fc7\u5728\u7ef4\u62a4 Call Graph \u7684\u65b9\u5f0f\u4e0a\u4e0d\u540c\uff1a\u4e0a\u9762\u7684\u8bba\u6587\u662f\u901a\u8fc7\u663e\u5f0f\u7684\u65b9\u6cd5\u8bb0\u5f55 Call Graph\uff0c\u6bcf\u4e2a\u51fd\u6570\u8c03\u7528\u4e86\u54ea\u4e9b\u51fd\u6570\uff0c\u800c\u4e13\u5229\u4e2d\uff0c\u53c2\u8003\u4e86\u5206\u652f\u9884\u6d4b\u8bb0\u5f55\u5206\u652f\u5386\u53f2\u7684\u65b9\u6cd5\uff0c\u628a\u6700\u8fd1\u7684 call \u548c return \u5730\u5740\u538b\u7f29\u8bb0\u5f55\u4e0b\u6765\uff0c\u901a\u8fc7 hash \u5f97\u5230 Signature\uff0c\u518d\u7528 Signature \u53bb\u67e5\u8be2 Prefetch Table\uff0c\u76f8\u5f53\u4e8e\u5728\u62ff\u6700\u8fd1\u82e5\u5e72\u6b21\u8c03\u7528\u548c\u8fd4\u56de\u7684\u5386\u53f2\u6765\u9884\u6d4b\u4e0b\u4e00\u6b21 call \u7684\u5730\u5740\u3002Prefetch Table \u7684\u6bcf\u4e2a Entry \u8bb0\u5f55\u4e86\u8fd9\u4e9b\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Signature\uff1a\u8bb0\u5f55\u4e86\u8fd9\u4e2a Entry \u5bf9\u5e94\u7684 Signature\uff0c\u5373\u6700\u8fd1\u51fd\u6570\u8c03\u7528\u7684\u538b\u7f29\u8868\u793a\uff1b\u5b9e\u9645\u53ef\u80fd\u5b9e\u73b0\u4e3a\u5168\u76f8\u8fde\uff0c\u4e5f\u53ef\u80fd\u662f\u7ec4\u76f8\u8fde\uff0c\u901a\u8fc7 tag \u5339\u914d</li>\n<li>Address\uff1a\u8981\u9884\u53d6\u7684\u6307\u4ee4\u5730\u5740\uff1b\u4e13\u5229\u4e2d\u8fd8\u8c08\u5230\u4e86 Address \u7684\u538b\u7f29\uff0c\u5373\u628a Address \u7684\u9ad8\u4f4d\u5355\u72ec\u5b58\u653e\u5728\u4e00\u4e2a Address Table \u4e2d\uff0c\u90a3\u4e48 Prefetch Table \u7684 Entry \u8bb0\u5f55\u4e86 Address Table \u7684 Index \u4ee5\u53ca\u4f4e\u4f4d Offset\uff0c\u9700\u8981\u9884\u53d6\u65f6\uff0c\u518d\u4ece Address Table \u8bfb\u53d6\u9ad8\u4f4d\uff0c\u62fc\u63a5\u8d77\u6765</li>\n<li>Counter\uff1a\u7ed9\u4ece Address \u5f00\u59cb\u7684\u82e5\u5e72\u4e2a\u7f13\u5b58\u884c\u7ef4\u62a4 Saturating Counter\uff0c\u7528\u6765\u5224\u65ad\u662f\u5426\u8981\u8fdb\u884c\u9884\u53d6</li>\n<li>Order\uff1a\u7528\u6765\u7ef4\u62a4 Replacement Policy \u6240\u9700\u8981\u7684\u4fe1\u606f</li>\n</ul>\n<p>\u90a3\u4e48\u524d\u7aef\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff0c\u6839\u636e\u5206\u652f\u9884\u6d4b\u53bb\u66f4\u65b0 Signature\uff0c\u6839\u636e Signature \u67e5\u8be2 Prefetch Table\uff0c\u5982\u679c\u6709\u547d\u4e2d\uff0c\u6839\u636e Counter \u7684\u5927\u5c0f\u51b3\u5b9a\u662f\u5426\u8981\u9884\u53d6\uff0c\u4ece Address \u5f00\u59cb\u9884\u53d6\u54ea\u4e9b\u6570\u636e\u3002</p>\n<h2 id=\"championship-branch-prediction\">Championship Branch Prediction<a class=\"headerlink\" href=\"#championship-branch-prediction\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9488\u5bf9\u5206\u652f\u65b9\u5411\u9884\u6d4b\uff0c\u66fe\u7ecf\u529e\u8fc7 5 \u5c4a\u7684 Championship Branch Prediction \u7ade\u8d5b\uff0c\u6700\u540e\u4e00\u6b21\u662f 2016 \u5e74\u7684 CBP-5\uff0c\u7f51\u7ad9\u662f <a href=\"https://jilp.org/cbp2016/\">Championship Branch Prediction (CBP-5)</a>\u3002\u5176\u6587\u4ef6\u53ef\u4ee5\u4ece\u4e0b\u5217\u5730\u5740\u5f97\u5230\uff1a</p>\n<ul>\n<li>https://web.archive.org/web/20220814115014/http://hpca23.cse.tamu.edu/cbp2016/cbp2016.final.tar.gz</li>\n<li>https://web.archive.org/web/20190907061905/http://hpca23.cse.tamu.edu/cbp2016/MD5SUM.txt</li>\n<li>https://drive.google.com/drive/folders/1VAdmqdOEFLvnRKkQQidxvGJA_C6S2RWo \u6765\u81ea https://github.com/craymichael/CBP-16-Simulation</li>\n</ul>\n<p>\u540e\u7eed\u8fd8\u6709\u4e00\u4e9b\u8bba\u6587\u4e5f\u662f\u5728 CBP2016 \u7684\u73af\u5883\u4e0b\u8fdb\u884c\u7684\u6d4b\u8bd5\u3002</p>", "image": null, "date_modified": "2024-09-12T00:00:00+00:00", "authors": [], "tags": ["bp", "brief-into-ooo", "cpu", "frontend", "hardware", "ooo", "prediction"]}, {"id": "https://jia.je/hardware/2024/09/10/samsung-exynos-cpu/", "url": "https://jia.je/hardware/2024/09/10/samsung-exynos-cpu/", "title": "\u4e09\u661f Exynos CPU \u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0", "content_html": "<h1 id=\"\u4e09\u661f-exynos-cpu-\u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0\">\u4e09\u661f Exynos CPU \u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0<a class=\"headerlink\" href=\"#\u4e09\u661f-exynos-cpu-\u5fae\u67b6\u6784\u5b66\u4e60\u7b14\u8bb0\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>ISCA 2020 \u7684\u4e00\u7bc7\u6587\u7ae0 <a href=\"https://ieeexplore.ieee.org/document/9138988\">Evolution of the Samsung Exynos CPU Microarchitecture</a> \u975e\u5e38\u8be6\u7ec6\u5730\u89e3\u6790\u4e86\u4e09\u661f Exynos \u81ea\u7814 CPU \u5fae\u67b6\u6784\u7684\u6f14\u8fdb\u5386\u53f2\u3002\u672c\u6587\u662f\u5bf9\u8fd9\u7bc7\u8bba\u6587\u7684\u5b66\u4e60\u548c\u6574\u7406\u7684\u7b14\u8bb0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5206\u652f\u9884\u6d4b\u5668\">\u5206\u652f\u9884\u6d4b\u5668<a class=\"headerlink\" href=\"#\u5206\u652f\u9884\u6d4b\u5668\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6587\u7ae0 Chapter IV \u8bb2\u8ff0\u4e86 Exynos \u7cfb\u5217\u5fae\u67b6\u6784\u7684\u5206\u652f\u9884\u6d4b\u5668\u5b9e\u73b0\u3002Exynos \u5fae\u67b6\u6784\u7528\u7684\u662f <a href=\"https://ieeexplore.ieee.org/document/903263\">Scaled Hashed Perceptron</a> \u5206\u652f\u65b9\u5411\u9884\u6d4b\u5668\uff0c\u8fd9\u4e2a\u5206\u652f\u9884\u6d4b\u5668\u7684\u63d0\u51fa\u8005 Daniel A. Jim\u00e9nez \u4e5f\u5728\u8fd9\u7bc7\u8bba\u6587\u7684\u4f5c\u8005\u5217\u8868\u4e2d\u3002\u73b0\u5728\u91c7\u7528\u57fa\u4e8e Perceptron \u7684\u5206\u652f\u9884\u6d4b\u5668\u7684\u5904\u7406\u5668\u4e0d\u591a\uff0cAMD \u7684 Zen 1 \u7528\u4e86\uff0cZen 2 \u662f Perceptron \u52a0 TAGE\uff0cZen 3 \u4ee5\u540e\u5c31\u53ea\u6709 TAGE \u4e86\u3002</p>\n<p>\u9664\u4e86\u65b9\u5411\u9884\u6d4b\u5668\uff0c\u8fd8\u9700\u8981\u6709 BTB \u6765\u8bc6\u522b\u5206\u652f\u4ee5\u53ca\u8bb0\u5f55\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u3002\u4e3a\u4e86\u6027\u80fd\uff0c\u6bcf\u4e2a\u5468\u671f\u90fd\u8981\u9884\u6d4b\u81f3\u5c11\u4e00\u4e2a\u5206\u652f\uff0c\u6240\u4ee5\u4e00\u822c\u4f1a\u6709\u4e00\u4e2a 0-bubble \u7684 BTB\uff0c\u5728\u8fd9\u91cc\u53eb uBTB\uff08microBTB\uff0c\u7528 u \u4ee3\u66ff\u5e0c\u814a\u5b57\u6bcd \u03bc\uff09\u3002\u4f46\u4e5f\u56e0\u4e3a\u65f6\u5e8f\u7684\u9650\u5236\uff0c\u4e0d\u4f1a\u505a\u7684\u592a\u5927\u3002\u4e3a\u4e86\u652f\u6301\u6709\u66f4\u5927\u7684\u5bb9\u91cf\uff0c\u901a\u5e38\u8fd8\u4f1a\u6709\u66f4\u5927\u7684\uff0c\u5ef6\u8fdf\u4e5f\u66f4\u957f\u7684 BTB\uff0c\u5728\u8fd9\u91cc\u53eb mBTB\uff08Main BTB\uff09\uff0c\u6700\u5927\u7684\u662f L2 BTB\uff0c\u8fd8\u6709\u540e\u9762\u4f1a\u8bb2\u5230\u5904\u7406\u8fb9\u754c\u60c5\u51b5\u7684 vBTB\u3002\u540c\u7406\uff0c\u5206\u652f\u9884\u6d4b\u5668\u4e5f\u6709\u5bb9\u91cf\u548c\u5ef6\u8fdf\u7684\u53cc\u91cd\u8003\u8651\uff0c\u8bbe\u7f6e\u4e0d\u540c\u5927\u5c0f\u548c\u5bb9\u91cf\u7684\u5206\u652f\u9884\u6d4b\u5668\uff0c\u4e5f\u53ef\u80fd\u4f1a\u5206\u591a\u7ea7\uff0c\u548c 0-bubble uBTB \u914d\u5bf9\u7684 LHP\uff08Local History Perception\uff09\u4ee5\u53ca 1-2 bubble mBTB \u914d\u5bf9\u7684\u5b8c\u6574\u7684 SHP\uff08Scaled Hashed Perception\uff09\u3002\u6b64\u5916\u8fd8\u6709 RAS\uff08Return Address Stack\uff09\u8d1f\u8d23\u51fd\u6570\u8fd4\u56de\u5730\u5740\u7684\u9884\u6d4b\u3002</p>\n<p>\u9996\u5148\u4ece Exynos \u6700\u65e9\u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u5f00\u59cb\u3002\u4e00\u5f00\u59cb\u8bbe\u8ba1\u7684\u65f6\u5019\uff0c\u5c31\u8003\u8651\u5230\u8981\u652f\u6301 2 prediction/clock \u7684\u573a\u666f\uff0c\u524d\u63d0\u662f\u7b2c\u4e00\u4e2a\u5206\u652f\u662f not taken \u7684\u3002\u4f8b\u5982\u6709\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u7b2c\u4e00\u6761\u662f\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5982\u679c\u7b2c\u4e00\u6761\u5206\u652f taken\uff0c\u90a3\u5c31\u4ee5\u7b2c\u4e00\u6761\u5206\u652f\u7684\u7ed3\u679c\u4e3a\u51c6\uff1b\u5982\u679c\u7b2c\u4e00\u6761\u5206\u652f not taken\uff0c\u90a3\u5c31\u5e94\u8be5\u4ee5\u7b2c\u4e8c\u6761\u5206\u652f\u7684\u7ed3\u679c\u4e3a\u51c6\u3002\u8fd9\u6837\u53ef\u4ee5\u5728\u6bd4\u8f83\u4f4e\u7684\u5f00\u9500\u7684\u524d\u63d0\u4e0b\uff0c\u4e00\u4e2a\u5468\u671f\u9884\u6d4b\u4e24\u6761\u5206\u652f\u6307\u4ee4\uff0c\u63d0\u9ad8\u5206\u652f\u9884\u6d4b\u7684\u6027\u80fd\uff0c\u5982\u679c\u4e0d\u505a\u8fd9\u4e2a\u4f18\u5316\u7684\u8bdd\uff0c\u9700\u8981\u5148\u9884\u6d4b\u7b2c\u4e00\u6761\u5206\u652f\uff0c\u9884\u6d4b\u5b8c\uff0c\u518d\u53bb\u9884\u6d4b\u7b2c\u4e8c\u6761\u5206\u652f\u3002\u8bba\u6587\u4e2d\u6307\u51fa\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u9700\u8981\u9884\u6d4b 2 \u4e2a\u5206\u652f\u7684\u573a\u666f\uff0c\u6709 60% \u7684\u60c5\u51b5\u662f\u7b2c\u4e00\u6761\u5206\u652f taken\uff0c24% \u60c5\u51b5\u662f\u7b2c\u4e00\u6761\u5206\u652f not taken \u5e76\u4e14\u7b2c\u4e8c\u6761\u5206\u652f taken\uff0c\u4e24\u4e2a\u90fd not taken \u7684\u60c5\u51b5\u5360 16%\u3002\u90a3\u4e48\u540e 40% \u7684\u60c5\u51b5\u5c31\u53ef\u4ee5\u5f97\u5230\u6027\u80fd\u63d0\u5347\u3002\u8fd9\u4e2a\u4f18\u5316\u8fd8\u662f\u633a\u5e38\u89c1\u7684\uff0c\u4f8b\u5982<a href=\"https://raw.githubusercontent.com/OpenXiangShan/XiangShan-doc/main/slides/20220825-RVSC-%E9%A6%99%E5%B1%B1%E5%A4%84%E7%90%86%E5%99%A8%E5%89%8D%E7%AB%AF%E5%8F%96%E6%8C%87%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B.pdf\">\u9999\u5c71\u5357\u6e56\u67b6\u6784</a>\u505a\u4e86\u8fd9\u4e2a\u4f18\u5316\uff0c\u800c\u4e14\u867d\u7136\u53ef\u4ee5 2 predictions/cycle\uff0c\u4f46\u5b9e\u9645\u4e0a\u53ea\u6709\u4e00\u4e2a Fetch Packet\uff0c\u4e5f\u6700\u591a 1 taken prediction/cycle\u3002</p>\n<p>SHP\uff0c\u4e5f\u5c31\u662f\u90a3\u4e2a\u6700\u5927\u7684 Perceptron \u9884\u6d4b\u5668\uff0c\u5305\u542b\u4e86 8 \u4e2a\u8868\uff0c\u6bcf\u4e2a\u8868\u6709 1024 \u4e2a\u6743\u91cd\uff0c\u6bcf\u4e2a BTB \u8868\u9879\u8fd8\u7ed9\u6bcf\u4e2a\u5206\u652f\u8bb0\u5f55\u4e86\u4e00\u4e2a bias\u3002\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u6839\u636e GHR\uff08\u6839\u636e\u5206\u652f taken/not taken \u5386\u53f2\uff09\u548c PHR\uff08\u6839\u636e taken branch \u5730\u5740\uff09\u4ee5\u53ca\u5206\u652f\u7684 PC \u7ecf\u8fc7\u54c8\u5e0c\uff0c\u5f97\u5230 table \u7684 index\uff0c\u6839\u636e index \u53bb\u8bbf\u95ee\u6743\u91cd\u3002\u628a\u4ece 8 \u4e2a\u8868\u91cc\u8bfb\u51fa\u6765\u7684\u6743\u91cd\u52a0\u8d77\u6765\uff0c\u518d\u52a0\u4e0a bias \u7684\u4e24\u500d\uff0c\u5f97\u5230\u6700\u65e9\u7684\u8ba1\u7b97\u7ed3\u679c\uff0c\u5982\u679c\u662f\u975e\u8d1f\u6570\uff0c\u5219\u9884\u6d4b\u4e3a taken\uff1b\u8d1f\u6570\u5219\u9884\u6d4b\u4e3a not taken\u3002</p>\n<p>\u77e5\u9053\u5206\u652f\u7684\u5b9e\u9645\u8df3\u8f6c\u65b9\u5411\u540e\uff0c\u5982\u679c\u9884\u6d4b\u9519\u8bef\u4e86\uff0c\u6216\u8005\u9884\u6d4b\u5bf9\u4e86\uff0c\u4f46\u662f\u8ba1\u7b97\u7ed3\u679c\u592a\u63a5\u8fd1 0\uff0c\u5c31\u9700\u8981\u66f4\u65b0 weight\u3002\u66f4\u65b0\u65f6\uff0c\u4f1a\u66f4\u65b0\u53c2\u4e0e\u5230\u8ba1\u7b97\u7684\u6765\u81ea\u5404\u4e2a\u8868\u7684 weight\uff0c\u5982\u679c\u662f taken\uff0c\u90a3\u5c31\u589e\u52a0 weight\uff1b\u5982\u679c\u662f not taken\uff0c\u5c31\u51cf\u5c11 weight\u3002Exynos M1 \u91c7\u7528\u4e86 165 \u4f4d\u7684 GHR\uff0c\u4e5f\u5c31\u662f\u6700\u8fd1 165 \u6761\u6761\u4ef6\u5206\u652f\u7684\u8df3\u8f6c\u65b9\u5411\uff0c\u4ee5\u53ca 80 \u4f4d\u7684 PHR\uff0c\u6bcf\u4e2a taken branch \u4f1a\u5411 PHR \u8d21\u732e 3 \u4e2a bit\uff08B[4:2]\uff09\uff0c\u4f46\u662f\u6ca1\u8bf4\u79fb\u4f4d\u591a\u5c11\u3002\u8fd9\u6837\u5c31\u6784\u6210\u4e86\u4e00\u4e2a Perceptron \u9884\u6d4b\u5668\u3002</p>\n<p>\u7279\u522b\u5730\uff0c\u9488\u5bf9\u603b\u662f\u8df3\u8f6c\u7684\u5206\u652f\uff0c\u4f8b\u5982\u65e0\u6761\u4ef6\u8df3\u8f6c\u5206\u652f\uff0c\u6216\u8005\u603b\u662f\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\uff0c\u5c31\u4e0d\u7528\u66f4\u65b0 SHP \u4e86\uff0c\u4ed6\u4eec\u53ea\u9700\u8981\u5728 BTB \u4e2d\u6807\u8bb0\u4e00\u4e0b\u5373\u53ef\uff0c\u907f\u514d\u6c61\u67d3 SHP\uff0c\u5e72\u6270\u5176\u4ed6\u5206\u652f\u7684\u9884\u6d4b\u3002\u7c7b\u4f3c\u7684\u601d\u8def\u4e5f\u633a\u5e38\u89c1\u7684\uff0cAMD \u7684\u505a\u6cd5\u662f\uff0c\u5bf9\u4e8e\u4ece\u6765\u6ca1\u6709\u8df3\u8f6c\u8fc7\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u4e0d\u5206\u914d BTB \u8868\u9879\uff0c\u5e76\u4e14\u9884\u6d4b\u4e3a\u4e0d\u8df3\u8f6c\uff1b\u5f53\u6761\u4ef6\u5206\u652f\u4e86\u8df3\u8f6c\u7b2c\u4e00\u6b21\uff0c\u90a3\u5c31\u4f1a\u5728 BTB \u4e2d\u5206\u914d\u8868\u9879\uff0c\u6807\u8bb0\u4e3a always taken\uff0c\u8868\u793a\u9884\u6d4b\u4e3a\u603b\u662f\u8df3\u8f6c\uff1b\u5f53\u6761\u4ef6\u5206\u652f\u8df3\u8f6c\u548c\u4e0d\u8df3\u8f6c\u5404\u81f3\u5c11\u4e00\u6b21\uff0c\u624d\u542f\u7528\u5206\u652f\u65b9\u5411\u9884\u6d4b\u5668\u3002</p>\n<p>\u63a5\u4e0b\u6765\u662f BTB\u3002mBTB\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684\u6709 1-2 bubble \u7684\u7565\u5fae\u5927\u4e00\u4e9b\u7684 BTB\uff0c\u53ef\u4ee5\u7ed9 128B \u5927\u5c0f\u7684 cacheline \u4fdd\u5b58 8 \u6761\u5206\u652f\u6307\u4ee4\u3002\u7edf\u8ba1\u6570\u636e\u8868\u793a\uff0c\u5e73\u5747\u6bcf 5 \u6761\u6307\u4ee4\u6709\u4e00\u6761\u662f\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u4e48 128B \u5728 4 \u5b57\u8282\u5b9a\u957f\u6307\u4ee4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u5b58 32 \u6761\u6307\u4ee4\uff0c\u4f30\u7b97\u5f97\u5230\u5927\u7ea6\u6709 6-7 \u6761\u5206\u652f\u6307\u4ee4\uff0c\u6240\u4ee5\u8bbe\u8ba1\u4e86\u53ef\u4ee5\u5b58 8 \u6761\u3002\u4f46\u4e5f\u6709\u53ef\u80fd\u5206\u652f\u5bc6\u5ea6\u5f88\u9ad8\uff0c128B \u5168\u662f\u5206\u652f\u6307\u4ee4\uff0c\u90a3\u5c31\u4f1a\u6709 32 \u6761\u5206\u652f\u6307\u4ee4\u4e86\u3002</p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u8bbe\u8ba1\u4e86 vBTB\uff08virtual indexed BTB\uff09\uff0c\u53ef\u4ee5\u628a 128B \u7684 cacheline \u91cc\u8d85\u8fc7 8 \u4e2a branch \u7684\u591a\u4f59\u90e8\u5206\u4fdd\u5b58\u4e0b\u6765\uff0c\u5f53\u7136\u4e86\uff0c\u4f1a\u6709\u989d\u5916\u7684\u5f00\u9500\u3002</p>\n<p>\u6bd4\u8f83\u7279\u522b\u7684\u662f\uff0c\u6ca1\u6709\u8bbe\u8ba1\u5355\u72ec\u7684\u4f8b\u5982 ITTAGE \u90a3\u6837\u7684 Indirect Predictor\uff0c\u800c\u662f\u91c7\u7528\u4e86\u53eb\u505a VPC\uff08Virtual PC\uff09\u7684\u65b9\u6848\uff0c\u5b83\u7684\u601d\u8def\u662f\uff0c\u590d\u7528\u65b9\u5411\u9884\u6d4b\u5668\u548c BTB \u7684\u80fd\u529b\uff0c\u628a\u4e00\u6761 Indirect Branch \u6620\u5c04\u4e3a\u591a\u6761 Conditional Branch\uff0c\u6bcf\u4e2a Conditional Branch \u7684 Target \u5bf9\u5e94\u4e00\u4e2a\u53ef\u80fd\u7684 Indirect Branch Target\uff0c\u8fd9\u4e2a Target \u5c31\u5b58\u5728 BTB \u5f53\u4e2d\u3002\u9884\u6d4b\u7684\u65f6\u5019\uff0c\u6309\u7167\u987a\u5e8f\u904d\u5386\u6bcf\u4e2a\u865a\u62df\u7684 Conditional Branch\uff0c\u5982\u679c\u9884\u6d4b\u4e3a taken\uff0c\u90a3\u5c31\u8df3\u8f6c\u5230\u8fd9\u4e2a\u865a\u62df\u7684\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\uff1b\u5982\u679c\u9884\u6d4b\u4e3a not taken\uff0c\u90a3\u5c31\u904d\u5386\u5230\u4e0b\u4e00\u4e2a\u865a\u62df\u7684\u5206\u652f\u3002\u5982\u679c\u6240\u6709\u7684\u865a\u62df\u6761\u4ef6\u5206\u652f\u90fd\u88ab\u9884\u6d4b\u4e3a\u4e0d\u8df3\u8f6c\uff0c\u90a3\u5c31\u9700\u8981\u7b49\u5230\u540e\u7aef\u8ba1\u7b97\u51fa\u5b9e\u9645\u7684\u76ee\u7684\u5730\u5740\uff0c\u518d\u8df3\u8f6c\u3002\u5bf9\u4e8e\u6bcf\u4e2a Indirect Branch\uff0c\u8fd9\u6837\u7684\u865a\u62df\u6761\u4ef6\u5206\u652f\u6700\u591a\u751f\u6210 16 \u4e2a\u3002</p>\n<p>\u8fd9\u4e9b\u865a\u62df\u7684\u6761\u4ef6\u5206\u652f\u65e2\u7136\u8981\u5229\u7528 BTB \u7684\u7a7a\u95f4\uff0c\u81ea\u7136\u4e5f\u4f1a\u62a2\u5360 128B cacheline \u6700\u591a 8 \u6761\u5206\u652f\u7684\u9650\u5236\uff0c\u591a\u4f59\u7684\u5206\u652f\u6216\u8005 Indirect Branch \u751f\u6210\u7684\u865a\u62df\u6761\u4ef6\u5206\u652f\u4e5f\u4f1a\u6ea2\u51fa\u5230 vBTB \u5185\u3002\u8fd9\u79cd\u8bbe\u8ba1\u8fd8\u662f\u7b2c\u4e00\u6b21\u89c1\u3002</p>\n<p>\u7531\u4e8e\u8fd9\u4e2a\u521d\u59cb\u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u53ea\u6709\u4e00\u4e2a main BTB\uff0c\u9700\u8981 2 bubble \u624d\u80fd\u51fa\u4e00\u4e2a taken branch\uff0c\u5728 taken branch \u5f88\u5bc6\u96c6\u7684\u65f6\u5019\uff0c\u5c31\u9700\u8981\u4e09\u4e2a\u5468\u671f\u4e00\u4e2a taken branch \u4e86\uff0c\u8fd9\u6027\u80fd\u80af\u5b9a\u4e0d\u591f\u597d\u3002\u6240\u4ee5 Exynos M1 \u5f15\u5165\u4e86 0-bubble \u7684 uBTB\uff0c\u5bb9\u91cf\u6bd4\u8f83\u5c0f\uff0c\u597d\u5904\u662f\u5feb\uff0c\u4e00\u822c\u8fd9\u79cd 0-bubble BTB \u4e5f\u53ef\u4ee5\u53eb\u505a Next Line Predictor\uff0c\u9884\u6d4b\u4e0b\u4e00\u4e2a\u5468\u671f\u7684 Fetch \u5730\u5740\u3002</p>\n<p>\u4e3a\u4e86\u5b9e\u73b0 0-bubble \u7684 uBTB\uff0cExynos M1 \u7528\u4e86\u4e00\u4e2a\u57fa\u4e8e\u56fe\u7684\u7ed3\u6784\u6765\u8bb0\u5f55\u5206\u652f\u4e4b\u95f4\u7684\u8df3\u8f6c\u5173\u7cfb\uff0c\u914d\u5408\u4e00\u4e2a\u8bb0\u5f55\u5206\u652f\u5c40\u90e8\u5386\u53f2\u7684 Hashed Perceptron \u7b97\u6cd5\u6765\u9884\u6d4b\u65b9\u5411\u3002\u8fd9\u4e2a\u9884\u6d4b\u7b97\u6cd5\u4e5f\u662f\u7b2c\u4e00\u6b21\u89c1\uff0c\u5728\u4e09\u661f\u7684\u4e13\u5229 <a href=\"https://patents.google.com/patent/US20170068539A1/en\">High performance zero bubble conditional branch prediction using micro branch target buffer </a> \u4e2d\u63d0\u51fa\uff0c\u5927\u9898\u601d\u8def\u5176\u5b9e\u5c31\u662f\u628a\u57fa\u672c\u5757\u5b66\u4e60\u51fa\u6765\uff0c\u627e\u5230\u5206\u652f\u4e4b\u95f4 taken \u548c not taken \u7684\u5173\u7cfb\uff0c\u4ee5\u6bcf\u4e2a\u5206\u652f\u4e3a\u4e00\u4e2a\u7ed3\u70b9\uff0c\u5982\u679c\u4e00\u4e2a\u5206\u652f taken \u4ee5\u540e\u4f1a\u5230\u53e6\u4e00\u4e2a\u5206\u652f\uff0c\u90a3\u5c31\u5728\u8fd9\u4e24\u4e2a\u5206\u652f\u5bf9\u5e94\u7684\u7ed3\u70b9\u4e4b\u95f4\u8fde\u4e00\u6761 taken \u7684\u6709\u5411\u8fb9\uff0c\u7c7b\u4f3c\u5730\uff0cnot taken \u4e5f\u4f1a\u8fde not taken \u7684\u6709\u5411\u8fb9\u3002</p>\n<p>\u6709\u4e86\u56fe\u4ee5\u540e\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u56fe\u4e2d\u77e5\u9053\u4e0b\u4e00\u4e2a\u4f1a\u5230\u8fbe\u7684\u5206\u652f\u5728\u54ea\u91cc\uff0c\u5373\u4f7f\u8fd9\u4e2a\u5206\u652f\u53ef\u80fd\u8ddd\u79bb\u5f88\u8fdc\uff1b\u800c\u5e38\u89c4\u7684 BTB \u8bbe\u8ba1\u91cc\uff0c\u5219\u662f\u62ff\u5230\u5730\u5740\u4ee5\u540e\uff0c\u7528\u5730\u5740\u53bb\u5bfb\u627e\u5339\u914d\u7684 BTB entry\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f1a\u626b\u63cf\u5230\u4e00\u4e9b\u4e0d\u5b58\u5728\u5206\u652f\u6307\u4ee4\u7684\u4ee3\u7801\u5757\u3002\u8fd9\u91cc\u4e5f\u652f\u6301\u524d\u9762\u8bf4\u7684\u8fde\u7eed\u4e24\u4e2a\u5206\u652f\u540c\u65f6\u9884\u6d4b\u7684\u60c5\u51b5\uff0c\u5728\u540c\u4e00\u4e2a\u5468\u671f\u5185\u9884\u6d4b\u4e24\u4e2a\u5206\u652f\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5206\u652f\u4e0d\u8df3\uff0c\u5c31\u7528\u7b2c\u4e8c\u4e2a\u5206\u652f\u7684\u7ed3\u679c\uff0c\u5728\u6811\u4e0a\u8f6c\u79fb\u3002\u4e3a\u4e86\u7701\u7535\uff0c\u5f53 uBTB \u9884\u6d4b\u51c6\u786e\u7387\u8f83\u9ad8\uff0c\u56fe\u8bb0\u5f55\u4e86\u6700\u8fd1\u6267\u884c\u7684\u6240\u6709\u5206\u652f\uff0c\u90a3\u4e48 uBTB \u5c31\u53ef\u4ee5\u706b\u529b\u5168\u5f00\uff0c\u4fdd\u6301 0-bubble \u7684\u9884\u6d4b\uff0c\u8fd9\u4e2a\u9884\u6d4b\u5728\u540e\u9762\u7684\u6d41\u6c34\u7ebf\u4e2d\u4f1a\u88ab mBTB \u548c SHP \u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u786e\u8ba4\u3002\u5982\u679c\u51c6\u786e\u7387\u7279\u522b\u9ad8\uff0c\u8ba4\u4e3a mBTB \u548c SHP \u5927\u6982\u7387\u4e5f\u4f1a\u5f97\u5230\u76f8\u540c\u7684\u9884\u6d4b\u7ed3\u679c\uff0c\u5c31\u4f1a\u8fdb\u4e00\u6b65\u505c\u6b62 mBTB \u548c SHP \u7684\u4f7f\u7528\uff0c\u964d\u4f4e\u529f\u8017\uff0c\u8fd9\u65f6\u5019\u5c31\u8981\u9760\u540e\u7aef\u7684 Branch Unit \u6765\u68c0\u67e5\u9884\u6d4b\u662f\u5426\u6b63\u786e\u3002</p>\n<p>\u8fd9\u5c31\u662f Exynos M1 \u548c M2 \u7684\u5206\u652f\u9884\u6d4b\u5668\u8bbe\u8ba1\u3002\u4e0a\u9762\u7684\u4e13\u5229<a href=\"https://patents.google.com/patent/US20170068539A1/en\">High performance zero bubble conditional branch prediction using micro branch target buffer</a>\u8fd8\u7ed9\u51fa\u4e86\u524d\u7aef\u7684\u6d41\u6c34\u7ebf\u5404\u7ea7\u7684\u529f\u80fd\uff1a</p>\n<p><img alt=\"\" src=\"../../../../samsung-exynos-cpu-frontend-1.png\" /></p>\n<p>\u8fd9\u4e2a\u56fe\u4e2d\u6ca1\u6709\u7ed8\u5236 uBTB \u5185\u90e8\u7684\u7ed3\u6784\uff0cuBTB \u8d1f\u8d23\u7ed9\u51fa\u521d\u59cb\u7684\u9884\u6d4b\uff0c\u5230 B1 \u9636\u6bb5\uff0c\u4ece B1 \u5f00\u59cb\uff0c\u4f1a\u7ecf\u8fc7\u4e24\u6761\u6d41\u6c34\u7ebf\uff0c\u4e0a\u9762\u7684\u6d41\u6c34\u7ebf\u662f mBTB + SHP \u8d1f\u8d23\u66f4\u7cbe\u786e\u7684\u9884\u6d4b\uff0c\u4e0b\u9762\u7684\u6d41\u6c34\u7ebf\u662f\u67e5\u8be2 ITLB + \u8bfb\u53d6 ICache\u3002\u4e0a\u9762\u8bf4 2-bubble \u7684 mBTB\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u4ece B1 \u5f97\u5230 Fetch Window\uff0cB2 \u8bfb\u53d6 mBTB \u548c SHP \u7684\u6743\u91cd\uff0c\u7b49\u5230 B3 \u5b8c\u6210\u4e4b\u540e\u624d\u53ef\u4ee5\u8ba1\u7b97\u51fa\u7ed3\u679c\uff0c\u5224\u65ad\u662f taken \u8fd8\u662f not taken\uff0c\u5982\u679c\u9884\u6d4b\u7684\u7ed3\u679c\u548c uBTB \u9884\u6d4b\u4e0d\u4e00\u81f4\uff0c\u5c31\u9700\u8981\u5237\u6d41\u6c34\uff0c\u4ece B1 \u91cd\u65b0\u5f00\u59cb\uff1aB1 B2 B3 B1 B2 B3\uff0c\u4e09\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002</p>\n<p>\u56fe\u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230 vBTB \u5728 B4\uff0c\u6240\u4ee5\u5982\u679c\u4e00\u4e2a cacheline \u6709\u8d85\u8fc7 8 \u4e2a branch\uff0c\u90a3\u4e48\u5728\u9884\u6d4b\u8fd9\u4e9b\u6ea2\u51fa\u5230 vBTB \u4e2d\u7684\u5206\u652f\u65f6\uff0c\u9700\u8981\u989d\u5916\u7684\u4e24\u4e2a\u5468\u671f\uff1aB1 B2 B3 B4 B3\uff0c\u4e94\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002</p>\n<p>Exynos M3 \u7ee7\u7eed\u6539\u8fdb\u4e86\u5206\u652f\u9884\u6d4b\u5668\u3002\u9996\u5148\u662f uBTB \u7684\u56fe\u7684\u5bb9\u91cf\u7ffb\u500d\uff0c\u6dfb\u52a0\u4e86\u9488\u5bf9\u65e0\u6761\u4ef6\u5206\u652f\u7684\u5bb9\u91cf\u3002\u4e3a\u4e86\u52a0\u901f\u603b\u662f\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff0c\u5f53 mBTB \u68c0\u6d4b\u5230\u603b\u662f\u8df3\u8f6c\u7684\u6761\u4ef6\u5206\u652f\u6307\u4ee4\u65f6\uff0c\u63d0\u524d\u4e00\u4e2a\u5468\u671f\u5f97\u5230\u7ed3\u679c\uff0c\u4e5f\u5c31\u662f\u4e0a\u56fe\u4e2d B3 \u5230 B1 \u7684\u8fde\u7ebf\uff0c\u6ca1\u6709\u7ecf\u8fc7\u6743\u91cd\u8ba1\u7b97\uff0c\u76f4\u63a5\u5237 B1\uff1aB1 B2 B1 B2\uff0c\u4e24\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\uff0c1-bubble\uff0c\u5728\u8bba\u6587\u91cc\u53eb\u505a 1AT\uff081-bubble Always Taken\uff09\u3002Exynos M3 \u8fd8\u7ffb\u500d\u4e86 SHP \u7684\u884c\u7684\u4e2a\u6570\uff0c\u4e5f\u7ffb\u500d\u4e86 L2 BTB \u5bb9\u91cf\u3002</p>\n<p>Exynos M4 \u7ee7\u7eed\u7ffb\u500d\u4e86 L2 BTB \u5bb9\u91cf\uff0c\u51cf\u5c11\u4e86 L2 BTB refill \u5230 mBTB \u7684\u5ef6\u8fdf\uff0c\u5e26\u5bbd\u7ffb\u500d\u3002\u8fd9\u4e2a\u4f18\u5316\u4e3b\u8981\u662f\u9488\u5bf9\u5206\u652f\u6bd4\u8f83\u591a\uff0cmBTB \u5b58\u4e0d\u4e0b\u7684\u7a0b\u5e8f\u3002</p>\n<p>Exynos M5 \u589e\u52a0\u4e86 Empty Line Optimization \u4f18\u5316\uff1a\u68c0\u6d4b\u6ca1\u6709\u5206\u652f\u7684\u7f13\u5b58\u884c\uff0c\u5982\u679c\u786e\u8ba4\u7f13\u5b58\u884c\u6ca1\u6709\u5206\u652f\uff0c\u90a3\u5c31\u4e0d\u7528\u9884\u6d4b\u91cc\u9762\u7684\u5206\u652f\u4e86\uff0c\u53ef\u4ee5\u8282\u7701\u529f\u8017\u3002</p>\n<p>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u4f18\u5316 taken branch \u7684\u541e\u5410\uff0c\u5728 mBTB \u4e2d\u8bb0\u5f55\u5206\u652f\u7684\u76ee\u7684\u5730\u5740\u65f6\uff0c\u4e0d\u4ec5\u8bb0\u5f55\u5728\u5206\u652f\u672c\u8eab\u6240\u5728\u7684 mBTB entry \u4e2d\uff0c\u8fd8\u8981\u8bb0\u5f55\u5728\u8fd9\u6761\u5206\u652f\u7684\u524d\u5e8f\u5206\u652f\u7684 mBTB entry \u4e2d\uff1a\u4f8b\u5982 A \u8df3\u8f6c\u5230 B\uff0cB \u8df3\u8f6c\u5230 C\uff0c\u7ecf\u5178\u7684\u5b9e\u73b0\u662f\u7528 A \u7684\u5730\u5740\u627e\u5230 A \u7684 BTB entry\uff0centry \u4e2d\u8bb0\u5f55\u4e86 A \u76ee\u7684\u5730\u5740\u662f B\uff0c\u63a5\u7740\u7528 B \u7684\u5730\u5740\u627e\u5230 B \u7684 BTB entry\uff0centry \u4e2d\u8bb0\u5f55\u4e86 B \u7684\u76ee\u7684\u5730\u5740\u662f C\uff1b\u800c Exynos M5 \u7684\u8bbe\u8ba1\u662f\uff0cC \u7684\u76ee\u7684\u5730\u5740\uff0c\u4e0d\u4ec5\u8981\u8bb0\u5f55\u5728 B \u7684 BTB entry \u4e2d\uff0c\u8fd8\u8981\u8bb0\u5f55\u5728 A \u7684 BTB entry \u4e2d\u3002\u4e0d\u8fc7\u8fd9\u91cc\u8981\u6c42 B \u7684\u8df3\u8f6c\u662f always-taken \u6216\u8005 often-taken\uff0c\u56e0\u4e3a\u5e76\u6ca1\u6709\u5bf9\u7b2c\u4e8c\u6761\u5206\u652f\u505a\u9884\u6d4b\uff0c\u800c\u662f\u9884\u6d4b\u5b83\u4e00\u5b9a\u4f1a\u8df3\u3002\u901a\u8fc7\u8fd9\u6837\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728 2-bubble \u7684\u9884\u6d4b\u5668\u7684\u5b9e\u73b0\u4e0b\uff0c\u5b9e\u73b0 1 taken branch/cycle \u7684\u541e\u5410\uff0c\u7b49\u6548\u4e8e\u4e00\u4e2a 0-bubble \u7684\u9884\u6d4b\u5668\u3002\u4e0b\u9762\u662f\u8bba\u6587\u4e2d\u5bf9 mBTB \u4ece 2-bubble \u5230 1-bubble \u6700\u7ec8\u5230 0-bubble \u7684\u53d8\u5316\u7684\u5bf9\u6bd4\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../samsung-exynos-cpu-mbtb.png\" /></p>\n<p>\u6700\u5de6\u8fb9\u7684 SHP 2-bubble \u5c31\u662f\u6700\u521d\u7684\u5b9e\u73b0\uff0c\u5b83\u9700\u8981\u5728 B3 \u5f97\u5230\u5206\u652f\u662f taken \u8fd8\u662f not taken \u7684\u4fe1\u606f\uff0c\u5982\u679c\u548c\u4e4b\u524d\u9884\u6d4b\u7684\u4e0d\u4e00\u6837\uff0c\u90a3\u5c31\u9700\u8981 flush \u6389\u6d41\u6c34\u7ebf\uff0cB1 \u91cd\u65b0\u4ece\u6b63\u786e\u7684\u5730\u5740\u5f00\u59cb\uff0c\u7136\u540e\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u7531\u4e8e\u6bcf\u6b21\u90fd\u9700\u8981\u5230 B3 \u624d\u80fd\u5f97\u5230\u6b63\u786e\u7684\u5730\u5740\uff0c\u6240\u4ee5\u4e09\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002</p>\n<p>\u4e2d\u95f4\u662f\u6539\u8fdb\u7684 1AT 1-bubble \u5b9e\u73b0\uff0c\u5b83\u5728 mBTB \u4e2d\u8bb0\u5f55\u4e86\u8fd9\u4e2a\u5206\u652f\u662f\u5426\u662f Always Taken\u3002\u56e0\u4e3a mBTB \u5728 B2 \u4e2d\u8bfb\u53d6\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4fe1\u606f\u5728 B2 \u5c31\u53ef\u4ee5\u5f97\u77e5\uff0c\u4f8b\u5982\u56fe\u4e2d A \u5206\u652f\u5230\u8fbe B2 \u65f6\uff0c\u68c0\u6d4b\u5230\u5b83\u662f Always Taken\uff0c\u4e0b\u4e2a\u5468\u671f\u7684 B1 \u76f4\u63a5\u5c31\u4ece\u6b63\u786e\u7684\u5730\u5740 B \u5f00\u59cb\uff0c\u540c\u7406 B \u5230\u8fbe B2 \u65f6\uff0c\u53c8\u53d1\u73b0\u5b83\u662f Always Taken\uff0c\u4e0b\u4e00\u4e2a\u5468\u671f\u7684 B1 \u53c8\u4ece C \u5f00\u59cb\uff0c\u6240\u4ee5\u4e24\u5468\u671f\u4e00\u4e2a taken branch\uff0c\u524d\u63d0\u662f\u5206\u652f\u662f Always Taken\uff0c\u901a\u8fc7\u907f\u514d\u5206\u652f\u9884\u6d4b\u6765\u51cf\u5c11\u4e00\u4e2a\u5468\u671f\u7684 bubble\u3002</p>\n<p>\u53f3\u8fb9\u662f\u6700\u540e\u7684 ZAT/ZOT 0-bubble \u5b9e\u73b0\uff0c\u5b83\u5728 mBTB \u4e2d\u8bb0\u5f55\u4e86\u540e\u7eed\u4e24\u4e2a\u5206\u652f\u7684\u5730\u5740\uff0c\u4f8b\u5982 X \u5728 mBTB \u4e2d\u8bb0\u5f55\u4e86 A \u548c B \u7684\u5730\u5740\u3002\u5f53 B3 \u53d1\u73b0 X \u8981\u8df3\u8f6c\u7684\u65f6\u5019\uff0c\u5237\u6d41\u6c34\u7ebf\uff0c\u5728\u63a5\u4e0b\u6765\u7684\u4e24\u4e2a\u5468\u671f\u91cc\u5206\u522b\u7ed9 B1 \u63d0\u4f9b\u4e86 A \u548c B \u7684\u5730\u5740\u3002\u5f53 A \u5230\u8fbe B2 \u65f6\uff0cA \u5728 mBTB \u91cc\u8bb0\u5f55\u4e86 B \u548c C \u7684\u5730\u5740\uff0c\u4e8e\u662f\u628a C \u7684\u5730\u5740\u8f6c\u53d1\u5230\u4e0b\u4e00\u4e2a\u5468\u671f\u7684 B1\uff0c\u4f9d\u6b64\u7c7b\u63a8\uff0cB2 \u7684 B \u5f97\u5230\u4e86 D \u7684\u5730\u5740\uff0cB2 \u7684 C \u5f97\u5230\u4e86 E \u7684\u5730\u5740\uff0c\u8fd9\u6837\u5b9e\u73b0\u4e86\u6bcf\u4e2a\u5468\u671f\u4e00\u4e2a taken branch\u3002\u901a\u8fc7\u8bb0\u5f55\u4e24\u8df3\u7684\u5730\u5740\u548c\u907f\u514d\u5206\u652f\u9884\u6d4b\uff08\u628a Always Taken \u548c Often Taken \u90fd\u9884\u6d4b\u4e3a Taken\uff09\uff0c\u4e24\u4e2a\u5468\u671f\u7ed9\u51fa\u4e24\u4e2a\u5730\u5740\uff0c\u51cf\u5c11\u4e24\u4e2a\u5468\u671f\u7684 bubble\u3002</p>\n<p>\u8fd9\u65f6\u5019\u5c31\u76f8\u5f53\u4e8e\u6709\u4e24\u4e2a 0-bubble \u9884\u6d4b\u5668\u4e86\uff0cmBTB \u6709 0-bubble \u80fd\u529b\uff0cuBTB \u4e5f\u6709\uff0c\u6240\u4ee5 Exynos M5 \u51cf\u5c11\u4e86 uBTB \u7684\u5bb9\u91cf\uff0c\u6362\u53d6\u66f4\u5927\u7684 mBTB \u7684\u9884\u6d4b\u5668\u5bb9\u91cf\uff1aSHP \u7684\u8868\u6570\u91cf\u7ffb\u500d\uff0cGHR \u5386\u53f2\u957f\u5ea6\u589e\u52a0\u3002</p>\n<p>\u867d\u7136 mBTB \u5728\u7279\u5b9a\u60c5\u51b5\u4e0b\u53ef\u4ee5\u505a\u5230 0-bubble\uff0c\u4f46\u662f\u5982\u679c\u603b\u662f\u9700\u8981\u7ea0\u6b63\u9884\u6d4b\u9519\u8bef\uff0c\u5c31\u4f1a\u56de\u9000\u5230\u4e09\u4e2a\u5468\u671f\u4e00\u6761\u5206\u652f\u7684\u6027\u80fd\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cExynos M5 \u5f15\u5165\u4e86 Mispredict Recovery Buffer\uff08MRB\uff09\uff1a\u9488\u5bf9\u6bd4\u8f83\u96be\u9884\u6d4b\u7684\u5206\u652f\uff0c\u8bb0\u5f55\u5b83\u540e\u7eed\u6700\u53ef\u80fd\u6267\u884c\u7684\u4e09\u6b21 fetch \u7684\u5730\u5740\uff0c\u5982\u679c\u547d\u4e2d\u4e86 MRB\uff0c\u90a3\u5c31\u76f4\u63a5\u4ece MRB \u4e2d\u6309\u987a\u5e8f\u7528\u4e09\u4e2a\u5468\u671f\u628a\u8fd9\u4e09\u6b21 fetch \u7684\u5730\u5740\u653e\u5230 B1\uff0c\u7136\u540e\u6d41\u6c34\u7ebf\u53bb\u9a8c\u8bc1\u8fd9\u4e09\u4e2a fetch \u5730\u5740\u662f\u5426\u6b63\u786e\uff0c\u8282\u7701\u4e86\u91cd\u590d\u7684 B3 \u5230 B1 \u7684\u91cd\u5b9a\u5411\u65f6\u95f4\u3002\u8fd9\u4e2a\u601d\u8def\u6709\u70b9\u50cf\u5927\u6a21\u578b\u7684\u63a8\u6d4b\u751f\u6210\uff1a\u7528\u6bd4\u8f83\u77ed\u7684\u65f6\u95f4\u9884\u6d4b\uff08\u5728\u8fd9\u91cc\u662f\u76f4\u63a5\u7528 MRB \u8bb0\u4e0b\u6765\u4e86\uff09\u51fa\u4e00\u4e2a\u672c\u6765\u662f\u4e32\u884c\u7684\u8fc7\u7a0b\u7684\u7ed3\u679c\uff0c\u7136\u540e\u518d\u7528\u6d41\u6c34\u7ebf\u6216\u8005\u5e76\u884c\u7684\u65b9\u5f0f\u53bb\u9a8c\u8bc1\u7ed3\u679c\u662f\u5426\u6b63\u786e\u3002\u5229\u7528\u7684\u6027\u8d28\u90fd\u662f\uff0c\u4e32\u884c\u751f\u6210\u6162\uff0c\u4f46\u662f\u9a8c\u8bc1\u7ed3\u679c\u5374\u6bd4\u8f83\u5feb\u3002</p>\n<p>Exynos M6 \u6269\u5927\u4e86 mBTB \u5bb9\u91cf\uff0c\u9488\u5bf9\u95f4\u63a5\u8df3\u8f6c\u6307\u4ee4\u505a\u4e86\u66f4\u591a\u7684\u4f18\u5316\uff0c\u4e3b\u8981\u662f\u8003\u8651\u5e94\u7528\u7a0b\u5e8f\u4f1a\u51fa\u73b0\u4e00\u4e2a\u95f4\u63a5\u8df3\u8f6c\u4f1a\u8df3\u8f6c\u5230\u4e0a\u767e\u4e2a\u4e0d\u540c\u7684\u76ee\u7684\u5730\u5740\u8fd9\u79cd\u6a21\u5f0f\uff0c\u4e4b\u524d\u7684 VPC \u65b9\u6cd5\u662f O(n) \u7684\uff0cn \u662f\u53ef\u80fd\u7684\u76ee\u7684\u5730\u5740\u7684\u4e2a\u6570\uff0cn \u5c0f\u7684\u65f6\u5019\u6bd4\u8f83\u597d\uff0cn \u5927\u4e86\u5c31\u5f88\u6162\u4e86\u3002</p>\n<p>Exynos M6 \u7684\u529e\u6cd5\u662f\uff0c\u9488\u5bf9\u8fd9\u4e9b\u76ee\u7684\u5730\u5740\u7279\u522b\u591a\u7684\u95f4\u63a5\u8df3\u8f6c\u6307\u4ee4\uff0c\u8bbe\u8ba1\u5355\u72ec\u7684\u5b58\u50a8\uff0c\u4e0d\u53bb\u5360\u7528 vBTB \u7684\u7a7a\u95f4\uff0c\u8fd9\u4e2a\u7a7a\u95f4\u662f Indirect target storage\uff0c\u91c7\u7528 4 \u8def\u7ec4\u76f8\u8fde\uff0c\u4e00\u5171 256 \u4e2a set\u3002\u7ecf\u5e38\u51fa\u73b0\u7684\u76ee\u7684\u5730\u5740\u8fd8\u662f\u548c\u4e4b\u524d\u4e00\u6837\uff0c\u653e\u5728 mBTB \u4e2d\uff0c\u4f46\u662f\u5bf9\u4e8e\u5269\u4e0b\u7684\u76ee\u7684\u5730\u5740\uff0c\u5219\u662f\u653e\u5230 Indirect target storage \u4e2d\uff0c\u6839\u636e\u6700\u8fd1\u7684 indirect branch target \u8ba1\u7b97\u51fa Index \u548c Tag\uff0c\u53bb Indirect target storage \u4e2d\u5bfb\u627e\uff0c\u5176\u5b9e\u8fd9\u4e2a\u5c31\u548c ITTAGE \u91cc\u7684\u4e00\u4e2a table \u6709\u70b9\u7c7b\u4f3c\u4e86\u3002</p>\n<p>\u6700\u540e\u8bba\u6587\u603b\u7ed3\u4e86 Exynos \u4ece M1 \u5230 M6 \u7684\u5404\u7ea7\u5206\u652f\u9884\u6d4b\u5668\u7684\u5b58\u50a8\u9762\u79ef\u5f00\u9500\uff0c\u57fa\u672c\u6bcf\u4e00\u4ee3\u90fd\u6709\u6240\u589e\u52a0\uff0c\u65e2\u6709 MPKI \u7684\u51cf\u5c11\uff08M6 \u76f8\u6bd4 M1 \u5728 SPECint2006 \u4e0a MPKI \u51cf\u5c11 25.6%\uff09\uff0c\u53c8\u6709\u9884\u6d4b\u6027\u80fd\u7684\u63d0\u5347\u3002</p>\n<h2 id=\"\u5206\u652f\u9884\u6d4b\u5b89\u5168\">\u5206\u652f\u9884\u6d4b\u5b89\u5168<a class=\"headerlink\" href=\"#\u5206\u652f\u9884\u6d4b\u5b89\u5168\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6709\u610f\u601d\u7684\uff0c\u8bba\u6587\u4e5f\u63d0\u5230\u4e86\u5206\u652f\u9884\u6d4b\u7684\u5b89\u5168\u95ee\u9898\uff0c\u4e3b\u8981\u662f\u907f\u514d\u8de8\u4e0a\u4e0b\u6587\u7684\u5206\u652f\u9884\u6d4b\u5668\u6ce8\u5165\u653b\u51fb\u3002\u6838\u5fc3\u601d\u8def\u662f\uff0c\u7ed9\u6bcf\u4e2a\u4e0a\u4e0b\u6587\u751f\u6210\u4e00\u4e2a\u968f\u673a\u6570\uff08<code>CONTEXT_HASH</code>\uff09\uff0c\u7136\u540e\u628a\u968f\u673a\u6570\u5f02\u6216\u5230 BTB \u4fdd\u5b58\u7684\u76ee\u7684\u5730\u5740\u91cc\u9762\u53bb\uff0c\u5728\u4ece BTB \u8bfb\u51fa\u6765\u76ee\u7684\u5730\u5740\u4f7f\u7528\u4e4b\u524d\uff0c\u8981\u518d\u6b21\u5f02\u6216\u540c\u4e00\u4e2a\u968f\u673a\u6570\u3002\u90a3\u4e48\u5982\u679c\u662f\u8bfb\u53d6\u4e86\u6765\u81ea\u540c\u4e00\u4e2a\u4e0a\u4e0b\u6587\u7684 BTB entry\uff0c\u901a\u8fc7\u4e24\u6b21\u5f02\u6216\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u539f\u59cb\u6570\u636e\uff1b\u5982\u679c\u662f\u8bfb\u53d6\u4e86\u6765\u81ea\u4e0d\u540c\u4e0a\u4e0b\u6587\u7684 BTB entry\uff0c\u7531\u4e8e\u968f\u673a\u6570\u4e0d\u540c\uff0c\u6700\u540e\u4f1a\u5f97\u5230\u968f\u673a\u7684\u6570\u636e\u3002\u5f53\u7136\u4e86\uff0c\u524d\u63d0\u662f\u8fd9\u4e9b\u968f\u673a\u6570\u4e0d\u80fd\u88ab\u653b\u51fb\u8005\u5f97\u5230\uff0c\u5bf9\u8f6f\u4ef6\u662f\u4e0d\u53ef\u89c1\u7684\u3002</p>\n<h2 id=\"uop-cache\">uOP Cache<a class=\"headerlink\" href=\"#uop-cache\" title=\"Permanent link\">&para;</a></h2>\n<p>Exynos M1 \u5230 M4 \u6ca1\u6709 uOP Cache\uff0c\u6240\u6709\u6307\u4ee4\u90fd\u9700\u8981\u7ecf\u8fc7\u53d6\u6307\u548c\u8bd1\u7801\uff0c\u5f97\u5230 uOP\u3002\u4ece Exynos M5 \u5f00\u59cb\u5f15\u5165\u4e86 uOP Cache\uff0c\u4f1a\u7f13\u5b58\u8bd1\u7801\u540e\u7684 uOP\u3002Exynos M5 \u7684 uOP Cache \u6700\u591a\u53ef\u4ee5\u4fdd\u5b58 384 \u4e2a uOP\uff0c\u6bcf\u4e2a entry \u53ef\u4ee5\u4fdd\u5b58 6 \u4e2a uOP\uff0c\u4e00\u4e2a\u5468\u671f\u63d0\u4f9b\u4e00\u4e2a entry\u3002\u4e00\u4e2a uOP Cache Entry \u4e2d\u7684 uOP \u6765\u81ea\u8fde\u7eed\u7684\u6307\u4ee4\uff0c\u4ee5\u5206\u652f\u6307\u4ee4\u4f5c\u4e3a\u7ed3\u5c3e\u3002\u4e0b\u9762\u662f\u8bba\u6587\u7ed9\u51fa\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<p><img alt=\"\" src=\"../../../../samsung-exynos-cpu-uop.png\" /></p>\n<p>\u8fd9\u6bb5\u6307\u4ee4\u7684\u5165\u53e3\u5728\u7b2c\u4e00\u4e2a\u7f13\u5b58\u884c\u7684\u6700\u540e\uff0c\u4ece I0 \u5f00\u59cb\uff0c\u6267\u884c I0 I1 I2 I3\uff0cI3 \u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u56e0\u6b64 uOP \u7684 entry \u5230\u6b64\u7ed3\u675f\uff0c\u8bb0\u5f55\u4e86 I0-I3 \u8bd1\u7801\u540e\u7684 uOP\uff0c\u8fd9\u91cc I2 \u6307\u4ee4\u88ab\u8bd1\u7801\u6210\u4e86\u4e24\u6761 uOP\uff0c\u4e8e\u662f\u8fd9\u4e2a entry \u5c31\u662f U0 U1 U2A U2B U3 \u8fd9\u4e94\u4e2a uOP\u3002I3 \u8df3\u8f6c\u5230\u4e86 I4\uff0cI4 \u7d27\u63a5\u7740\u53c8\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4 I5\uff0c\u6240\u4ee5 uOP \u7684 entry \u5230\u8fd9\u91cc\u7ed3\u675f\uff0c\u8bb0\u5f55 I4 \u548c I5 \u8bd1\u7801\u540e\u7684 uOP\uff1aU4 \u548c U5\u3002\u540e\u9762\u4f9d\u6b64\u7c7b\u63a8\u3002</p>\n<p>\u90a3\u4e48\u4ec0\u4e48\u65f6\u5019 uOP Cache \u542f\u7528\u5462\uff1f\u8bba\u6587\u4e2d\u63d0\u5230\u4e86\u4e00\u4e2a\u72b6\u6001\u673a\uff1a</p>\n<ol>\n<li>FilterMode\uff1a\u5f53 uBTB \u5728\u5b66\u4e60\u5206\u652f\u4e4b\u95f4\u7684\u5173\u7cfb\u65f6\uff0c\u4e5f\u5728\u68c0\u67e5\u8fd9\u6bb5\u4ee3\u7801\u80fd\u5426\u653e\u5230 uOP Cache \u91cc\uff0c\u5982\u679c\u53ef\u4ee5\u7684\u8bdd\uff0c\u8f6c\u79fb\u5230 BuildMode</li>\n<li>BuildMode\uff1a\u5f00\u59cb\u628a\u8bd1\u7801\u5f97\u5230\u7684 uOP \u4fdd\u5b58\u5230 uOP Cache \u5185\u90e8\uff0c\u540c\u65f6\u548c uBTB \u5b66\u4e60\u5230\u7684\u56fe\u8fdb\u884c\u6bd4\u5bf9\uff0c\u5f53\u56fe\u4e2d\u5927\u90e8\u5206\u7684\u8fb9\u5bf9\u5e94\u7684\u6307\u4ee4\u90fd\u5df2\u7ecf\u88ab uOP Cache \u5b66\u4e60\u5230\uff0c\u8bf4\u660e uOP Cache \u5df2\u7ecf\u6355\u6349\u4e86\u5927\u90e8\u5206\u9700\u8981\u7684\u6307\u4ee4\uff0c\u8fdb\u5165 FetchMode</li>\n<li>FetchMode\uff1a\u6307\u4ee4\u7f13\u5b58\u548c\u8bd1\u7801\u90e8\u4ef6\u88ab\u5173\u95ed\uff0c\u8282\u7701\u529f\u8017\uff0c\u6240\u6709\u6307\u4ee4\u90fd\u4ece uOP Cache \u63d0\u4f9b\uff1b\u6b64\u65f6\u5982\u679c uBTB \u7684\u51c6\u786e\u7387\u5f88\u9ad8\uff0cmBTB \u4e5f\u53ef\u4ee5\u5173\u6389\uff0c\u8fdb\u4e00\u6b65\u8282\u7701\u529f\u8017\u3002\u5f53 uOP Cache \u547d\u4e2d\u7387\u964d\u4f4e\uff0c\u5207\u6362\u56de FilterMode</li>\n</ol>\n<p>\u8fd9\u79cd\u8bbe\u8ba1\u8fd8\u662f\u6bd4\u8f83\u5e38\u89c1\u7684\uff0cuOP Cache \u548c Decoder \u4e0d\u4f1a\u540c\u65f6\u5de5\u4f5c\uff0c\u800c\u662f\u4e8c\u9009\u4e00\uff0c\u6839\u636e uOP Cache \u7684\u547d\u4e2d\u7387\u6765\u51b3\u5b9a\u8c01\u6765\u5de5\u4f5c\u3002\u7136\u540e\u8fdb\u4e00\u6b65\u4e3a\u4e86\u907f\u514d uOP Cache \u586b\u5145\u7684\u529f\u8017\uff0c\u5982\u679c uBTB \u53d1\u73b0\u8fd9\u4e9b\u4ee3\u7801\u653e\u4e0d\u4e0b uOP Cache \u4e2d\uff0c\u5c31\u4e0d\u586b\u5145 uOP Cache \u4e86\uff0c\u8fd9\u5c31\u662f FilterMode \u7684\u8bbe\u8ba1\u7684\u610f\u4e49\u3002</p>\n<h2 id=\"l1-\u6570\u636e\u9884\u53d6\">L1 \u6570\u636e\u9884\u53d6<a class=\"headerlink\" href=\"#l1-\u6570\u636e\u9884\u53d6\" title=\"Permanent link\">&para;</a></h2>\n<p>L1 \u6570\u636e\u9884\u53d6\u5668\u4f1a\u68c0\u6d4b\u4e0d\u540c\u7684 stride\uff0c\u5728\u865a\u62df\u5730\u5740\u4e0a\uff0c\u8ddf\u8e2a\u8bbf\u5b58\u7684\u5386\u53f2\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8bc6\u522b\u8bbf\u5b58\u7684\u5e8f\u5217\uff0c\u7531\u4e8e\u8bbf\u5b58\u662f\u53ef\u4ee5\u4e71\u5e8f\u6267\u884c\u7684\uff0c\u5b83\u4f1a\u8fdb\u884c\u91cd\u6392\uff0c\u4f7f\u5f97\u8bbf\u5b58\u6a21\u5f0f\u7684\u8bc6\u522b\u770b\u5230\u5c31\u662f\u7a0b\u5e8f\u7684\u987a\u5e8f\u3002\u4e3a\u4e86\u9a8c\u8bc1\u9884\u53d6\u662f\u5426\u6b63\u786e\uff0c\u5728\u9884\u53d6\u7684\u540c\u65f6\uff0c\u4e5f\u4f1a\u628a\u8fd9\u4e9b\u9884\u53d6\u7684\u5730\u5740\u8bb0\u5f55\u4e0b\u6765\uff0c\u653e\u5728 Confirmation Queue \u4e2d\uff0c\u548c\u672a\u6765\u7684 load \u5730\u5740\u505a\u6bd4\u5bf9\u3002\u5982\u679c\u9884\u53d6\u5668\u548c\u672a\u6765\u7684 load \u5339\u914d\u7684\u6bd4\u4f8b\u5f88\u9ad8\uff0c\u8bf4\u660e\u9884\u53d6\u5668\u5f88\u51c6\u786e\uff0c\u53ef\u4ee5\u7ee7\u7eed\u8ba9\u4ed6\u9884\u53d6\u3002\u5982\u679c\u51c6\u786e\u7387\u8f83\u4f4e\uff0c\u4e3a\u4e86\u907f\u514d\u6d6a\u8d39\u5185\u5b58\u5e26\u5bbd\uff0c\u5c31\u4f1a\u505c\u6b62\u9884\u53d6\u3002</p>\n<p>\u9664\u4e86 strided \u8bbf\u5b58\u6a21\u5f0f\uff0cExynos M3 \u8fd8\u5f15\u5165\u4e86 Spatial Memory Stream \u9884\u53d6\u5668\uff0c\u5b83\u4f1a\u8ddf\u8e2a\u4e00\u4e2a\u533a\u95f4\u7684\u7b2c\u4e00\u6b21 cache miss \u548c\u540e\u7eed\u7684 miss\uff0c\u5f53\u518d\u6b21\u9047\u5230\u7b2c\u4e00\u6b21 cache miss \u7684\u5730\u5740\u65f6\uff0c\u9884\u53d6\u540e\u7eed\u53ef\u80fd\u4f1a\u51fa\u73b0 miss \u7684\u5730\u5740\u3002</p>\n<h2 id=\"l2l3-\u7f13\u5b58\">L2/L3 \u7f13\u5b58<a class=\"headerlink\" href=\"#l2l3-\u7f13\u5b58\" title=\"Permanent link\">&para;</a></h2>\n<p>\u4e3a\u4e86\u51cf\u5c11\u6570\u636e\u7684\u91cd\u590d\uff0cL3 \u7f13\u5b58\u548c L1/L2 \u662f exclusive \u7684\u5173\u7cfb\uff0c\u6570\u636e\u662f\u4e92\u65a5\u7684\uff0c\u8981\u4e48\u5b58\u5728 L3 \u91cc\uff0c\u8981\u4e48\u5b58\u5728 L1/L2 \u91cc\uff0c\u8981\u4e48\u90fd\u4e0d\u5b58\u3002</p>\n<p>Exynos M4 \u9488\u5bf9 L2 \u7f13\u5b58\u5f15\u5165\u4e86 Buddy Prefetcher\uff1a\u5982\u679c\u4e00\u4e2a\u7f13\u5b58\u884c\u7f3a\u5931\u4e86\uff0c\u90a3\u5c31\u628a\u5b83\u76f8\u90bb\u7684\u4e0b\u4e00\u4e2a\u7f13\u5b58\u884c\u4e5f\u9884\u53d6\u8fdb\u6765\u3002</p>\n<h2 id=\"\u8bbf\u5b58\u5ef6\u8fdf\">\u8bbf\u5b58\u5ef6\u8fdf<a class=\"headerlink\" href=\"#\u8bbf\u5b58\u5ef6\u8fdf\" title=\"Permanent link\">&para;</a></h2>\n<p>Exynos \u7cfb\u5217\u7684 load to use latency \u901a\u5e38\u60c5\u51b5\u4e0b\u662f 4 cycle\uff0c\u4f46\u9488\u5bf9 load to load \u7684\u60c5\u51b5\uff0c\u4e5f\u5c31\u662f\u524d\u4e00\u4e2a load \u7684\u7ed3\u679c\uff0c\u4f5c\u4e3a\u540e\u4e00\u4e2a load \u7684\u57fa\u5730\u5740\u7684\u60c5\u51b5\uff0c\u4ece Exynos M4 \u5f00\u59cb\u53ef\u4ee5\u505a\u5230 3 cycle \u7684 load to use latency\uff0c\u8fd9\u5728\u8bba\u6587\u4e2d\u53eb\u505a cascading load\u3002\u8fd9\u4e2a 4 cycle \u51cf\u5230 3 cycle \u7684\u7279\u6027\u5728\u82f9\u679c\uff0c\u9ad8\u901a\u548c Intel\uff08E-core\uff09\u7684 CPU \u4e2d\u90fd\u6709\u770b\u5230\u3002</p>\n<h2 id=\"\u5c0f\u7ed3\">\u5c0f\u7ed3<a class=\"headerlink\" href=\"#\u5c0f\u7ed3\" title=\"Permanent link\">&para;</a></h2>\n<p>\u867d\u7136 Exynos \u7cfb\u5217\u5fae\u67b6\u6784\u7684\u82af\u7247\u6ca1\u6709\u65b0\u7684\u6f14\u8fdb\u4e86\uff0c\u4f46\u662f\u4e5f\u975e\u5e38\u611f\u8c22\u8fd9\u4e9b\u4f5c\u8005\u6177\u6168\u5730\u4ecb\u7ecd\u4e86\u4ed6\u4eec\u8fd9\u4e9b\u5e74\u4f18\u5316\u5fae\u67b6\u6784\u7684\u52aa\u529b\uff0c\u63d0\u4f9b\u4e86\u5f88\u591a\u6709\u4ef7\u503c\u7684\u4fe1\u606f\u3002\u4ece\u4f5c\u8005\u4fe1\u606f\u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65f6\u5f00\u53d1 Exynos \u7684\u56e2\u961f\u6210\u5458\uff0c\u5728\u56e2\u961f\u89e3\u6563\u4ee5\u540e\uff0c\u53bb\u7684\u57fa\u672c\u4e5f\u662f\u6709\u81ea\u7814\u6838\u7684\u516c\u53f8\uff1aSifive\uff0cCentaur\uff0cARM\uff0cAMD\uff0cNuvia\u3002</p>\n<p>\u7531\u4e8e\u672c\u4eba\u5bf9 DCache \u4ee5\u53ca Prefetch \u90e8\u5206\u7f3a\u4e4f\u6df1\u5165\u4e86\u89e3\uff0c\u6240\u4ee5\u8fd9\u90e8\u5206\u7684\u4ecb\u7ecd\u6bd4\u8f83\u5c11\uff0c\u6709\u5174\u8da3\u7684\u8bfb\u8005\u5efa\u8bae\u53c2\u8003\u539f\u6587\u3002</p>", "image": null, "date_modified": "2024-09-10T00:00:00+00:00", "authors": [], "tags": ["arm", "cpu", "exynos", "hardware", "microarchitecture", "samsung"]}, {"id": "https://jia.je/hardware/2024/09/04/memory_model_and_memory_ordering/", "url": "https://jia.je/hardware/2024/09/04/memory_model_and_memory_ordering/", "title": "\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f", "content_html": "<h1 id=\"\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\">\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f<a class=\"headerlink\" href=\"#\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\u662f\u4e00\u4e2a\u8d2f\u7a7f\u8f6f\u786c\u4ef6\u5b9e\u73b0\u7684\u6982\u5ff5\uff0c\u4f60\u53ef\u4ee5\u5728 CPU \u5fae\u67b6\u6784\uff0c\u603b\u7ebf\uff0c\u5230\u6c47\u7f16\u6307\u4ee4\uff0c\u7f16\u8bd1\u5668\u548c\u7f16\u7a0b\u8bed\u8a00\u4e2d\u770b\u5230\u5b83\u4eec\u3002\u672c\u6587\u4e3b\u8981\u6765\u63a2\u8ba8\u8fd9\u4e9b\u95ee\u9898\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5185\u5b58\u6a21\u578b\">\u5185\u5b58\u6a21\u578b<a class=\"headerlink\" href=\"#\u5185\u5b58\u6a21\u578b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u5bf9\u4e8e\u5904\u7406\u5668\u6838\u5fc3\u6765\u8bf4\uff0c\u5982\u4f55\u5b9e\u73b0\u8bbf\u5b58\u6307\u4ee4\uff0c\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u662f\u5341\u5206\u663e\u8457\u7684\u3002\u6700\u57fa\u7840\u7684\u786c\u4ef6\u5b9e\u73b0\u65b9\u6cd5\uff0c\u5c31\u662f\u4e32\u884c\u5730\u5b8c\u6210\u6bcf\u4e00\u6761 Load \u548c Store \u6307\u4ee4\uff0c\u6bcf\u4e00\u6761\u8bbf\u5b58\u6307\u4ee4\u6267\u884c\u5b8c\uff0c\u624d\u80fd\u5f00\u59cb\u6267\u884c\u4e0b\u4e00\u6761\u8bbf\u5b58\u6307\u4ee4\u3002\u4f46\u5982\u679c\u6b63\u5728\u6267\u884c\u7684\u8bbf\u5b58\u6307\u4ee4 A \u9047\u5230\u4e86\u7f13\u5b58\u7f3a\u5931\uff0c\u9700\u8981\u7b49\u5f85\u7f13\u5b58\u7684\u56de\u586b\uff0c\u7531\u4e8e\u786c\u4ef6\u53ea\u5b9e\u73b0\u4e86\u4e32\u884c\u6267\u884c\uff0c\u5728 A \u4e4b\u540e\u672a\u6765\u8981\u6267\u884c\u7684\u8bbf\u5b58\u6307\u4ee4 B \u53c8\u5fc5\u987b\u7b49\u5f85 A \u7684\u5b8c\u6210\uff0c\u8017\u8d39\u7684\u65f6\u95f4\u5c31\u4f1a\u6bd4\u8f83\u957f\u3002</p>\n<p>\u4f46\u5f88\u591a\u65f6\u5019\uff0cB \u6307\u4ee4\u5e76\u4e0d\u4f9d\u8d56 A \u6307\u4ee4\uff0c\u53ef\u80fd\u8bbf\u95ee\u7684\u662f\u4e0d\u540c\u7684\u5185\u5b58\u5730\u5740\uff0c\u53ef\u80fd B \u8981\u8bbf\u95ee\u7684\u6570\u636e\u5c31\u5728\u7f13\u5b58\u4e2d\uff0c\u5982\u679c\u80fd\u591f\u5728 A \u7b49\u5f85\u7f13\u5b58\u56de\u586b\u7684\u65f6\u95f4\u540c\u65f6\u6267\u884c B\uff0c\u6027\u80fd\u53ef\u4ee5\u5f97\u5230\u63d0\u5347\u3002\u4f46\u5e76\u975e\u6240\u6709\u7684 B \u90fd\u53ef\u4ee5\u63d0\u524d\u6267\u884c\u7684\uff0c\u6bd4\u5982</p>\n<ul>\n<li>\u4ece\u6838\u5185\u7684\u89c6\u89d2\u6765\u770b\uff0cA \u548c B \u8bbf\u95ee\u7684\u5185\u5b58\u8303\u56f4\u6709\u91cd\u5408\uff0c\u90a3\u4e48\u5b83\u4eec\u7684\u6267\u884c\u987a\u5e8f\u5c31\u5f88\u91cd\u8981\uff1a<ul>\n<li>\u5982\u679c A \u662f Store \u6307\u4ee4\uff0cB \u662f Load \u6307\u4ee4\uff0cB \u5728 A \u4e4b\u524d\u6267\u884c\uff0cB \u63d0\u65e9\u4ece Cache \u8bfb\u53d6\u6570\u636e\uff0c\u5f97\u5230\u7684\u662f A \u5199\u5165\u4e4b\u524d\u7684\u7ed3\u679c\uff0c\u6570\u636e\u5c31\u9519\u4e86\u3002\u4e0d\u8fc7\u597d\u5728\u8fd9\u53ef\u4ee5\u901a\u8fc7 Store to Load Forwarding \u89e3\u51b3\uff0c\u628a A \u8981\u5199\u5165\u7684\u6570\u636e\u4ee5\u53ca Cache \u4e2d\u7684\u6570\u636e\u62fc\u63a5\u51fa\uff0c\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684 B \u8981\u8bfb\u53d6\u7684\u6570\u636e\u3002</li>\n<li>\u5982\u679c A \u662f Load \u6307\u4ee4\uff0cB \u662f Store \u6307\u4ee4\uff0cB \u5728 A \u4e4b\u524d\u6267\u884c\uff0c\u63d0\u65e9\u5411 Cache \u5199\u5165\u6570\u636e\uff0c\u90a3\u4e48 A \u90fd\u51fa\u6765\u7684\u5c31\u662f B \u5199\u5165\u4e4b\u540e\u7684\u7ed3\u679c\uff0c\u6570\u636e\u5c31\u9519\u4e86\u3002</li>\n<li>\u5982\u679c A \u548c B \u90fd\u662f Store \u6307\u4ee4\uff0cB \u5728 A \u4e4b\u524d\u6267\u884c\uff0c\u90a3\u4e48\u6700\u7ec8\u5185\u5b58\u4e2d\u7684\u503c\u662f A \u8986\u76d6\u4e86 B\uff0c\u800c\u4e0d\u662f\u9884\u671f\u7684 B \u8986\u76d6\u4e86 A</li>\n</ul>\n</li>\n<li>\u4ece\u6838\u5916\u7684\u89c6\u89d2\u6765\u770b\uff0c\u5047\u5982\u76ee\u524d\u6b63\u5728\u4e00\u4e2a\u88ab\u9501\u4fdd\u62a4\u7684\u4e34\u754c\u533a\uff0cA \u662f\u5bf9\u88ab\u4fdd\u62a4\u7684\u6570\u636e\u7684\u4fee\u6539\uff0cB \u662f\u91ca\u653e\u9501\uff0c\u5982\u679c B \u5728 A \u4e4b\u524d\u6267\u884c\uff0c\u5c31\u4f1a\u5bfc\u81f4\u9501\u91ca\u653e\u4e86\uff0c\u4f46\u8fd8\u5728\u4fee\u6539\u88ab\u4fdd\u62a4\u7684\u6570\u636e\u7684\u60c5\u51b5\u3002</li>\n</ul>\n<p>\u53ef\u80fd\u8fd8\u6709\u5176\u4ed6\u7c7b\u4f3c\u7684\u573a\u666f\uff0c\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b\uff0c\u51b3\u5b9a\u8bbf\u5b58\u7684\u662f\u5426\u4e71\u5e8f\uff0c\u5982\u4f55\u4e71\u5e8f\uff0c\u9700\u8981\u8003\u8651\uff1a</p>\n<ul>\n<li>\u4ece\u6838\u5185\u7684\u89c6\u89d2\u6765\u770b\uff0c\u4e71\u5e8f\u6267\u884c\u4e0d\u80fd\u4fee\u6539\u7a0b\u5e8f\u7684\u4e00\u6837\u3002\u5b9e\u73b0\u4e71\u5e8f\u7684\u6027\u80fd\uff0c\u53c8\u8981\u8868\u73b0\u51fa\u7c7b\u4f3c\u4e32\u884c\u7684\u884c\u4e3a</li>\n<li>\u4ece\u6838\u95f4\u7684\u89c6\u89d2\u6765\u770b\uff0c\u6709\u4e00\u4e9b\u6307\u4ee4\u4e0d\u80fd\u4e71\u5e8f\uff0c\u5426\u5219\u4f1a\u5f71\u54cd\u6838\u95f4\u540c\u6b65\u4e92\u65a5\u7684\u6b63\u786e\u6027</li>\n</ul>\n<p>\u9664\u4e86 CPU \u6838\u4e4b\u95f4\uff0c\u5982\u679c\u4e00\u4e9b\u5916\u8bbe\uff08\u4f8b\u5982\u663e\u5361\uff0c\u7f51\u5361\uff09\u4e5f\u8981\u8bbf\u95ee\u5185\u5b58\uff0c\u90a3\u4e48 CPU \u548c\u5916\u8bbe\u4e4b\u95f4\uff0c\u4e5f\u53ef\u80fd\u6709\u7c7b\u4f3c\u7684\u987a\u5e8f\u95ee\u9898\u3002</p>\n<p>\u56e0\u6b64\u5c31\u9700\u8981\u660e\u786e\u89c4\u5b9a\u786c\u4ef6\u4e71\u5e8f\u6267\u884c\u7684\u6a21\u5f0f\u548c\u8fb9\u754c\uff0c\u4f7f\u5f97\u8f6f\u4ef6\u5f00\u53d1\u8005\u4e00\u65b9\u9762\u53ef\u4ee5\u6839\u636e\u9700\u8981\u5728\u8f6f\u4ef6\u4e2d\u63d2\u5165\u6307\u4ee4\u6765\u963b\u6b62\u4e0d\u671f\u671b\u53d1\u751f\u7684\u4e71\u5e8f\uff0c\u4ece\u800c\u4fdd\u8bc1\u6b63\u786e\u6027\uff1b\u53e6\u4e00\u65b9\u9762\u5728\u5927\u591a\u6570\u65f6\u95f4\uff0c\u786c\u4ef6\u63d0\u4f9b\u7684\u4e71\u5e8f\u53ef\u4ee5\u5728\u4fdd\u8bc1\u6b63\u786e\u6027\u7684\u60c5\u51b5\u4e0b\uff0c\u63d0\u4f9b\u66f4\u597d\u7684\u6027\u80fd\u3002</p>\n<p>\u4f46\u8fd9\u4e2a\u6a21\u5f0f\u548c\u8fb9\u754c\u4e0d\u662f\u4e00\u5929\u5efa\u6210\u7684\u3002\u786c\u4ef6\u5382\u5546\u5e0c\u671b\u80fd\u591f\u4e0d\u65ad\u63a8\u51fa\u6027\u80fd\u66f4\u597d\u7684\u65b0\u5904\u7406\u5668\uff0c\u8fd9\u4e9b\u65b0\u5904\u7406\u5668\u53ef\u80fd\u4e3a\u4e86\u6027\u80fd\u53bb\u505a\u66f4\u591a\u7684\u4f18\u5316\uff0c\u8fd9\u4e9b\u4f18\u5316\u53ef\u80fd\u4f1a\u6d89\u53ca\u5230\u66f4\u591a\u7684\u4e71\u5e8f\u60c5\u51b5\uff0c\u8fd9\u65f6\u5019\u517c\u5bb9\u6027\u5c31\u6210\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u65e7\u8f6f\u4ef6\u5047\u8bbe\u4e86\u786c\u4ef6\u4e0d\u4f1a\u505a\u67d0\u79cd\u4e71\u5e8f\uff0c\u7ed3\u679c\u65b0\u786c\u4ef6\u505a\u4e86\uff0c\u90a3\u65e7\u8f6f\u4ef6\u5728\u65b0\u786c\u4ef6\u4e0a\u5c31\u4f1a\u51fa\u73b0\u517c\u5bb9\u6027\u95ee\u9898\u3002\u4e8e\u662f\u8f6f\u4ef6\u5f00\u53d1\u8005\u5f88\u5e0c\u671b\u6709\u4e00\u4e2a\u6807\u51c6\u6216\u8005\u8bf4\u6a21\u578b\u51fa\u6765\uff0c\u786c\u4ef6\u4fdd\u8bc1\u6309\u7167\u8fd9\u4e2a\u6a21\u578b\u5b9e\u73b0\u4e71\u5e8f\uff0c\u8f6f\u4ef6\u6309\u7167\u8fd9\u4e2a\u6a21\u578b\u6765\u5f00\u53d1\uff0c\u8fd9\u6837\u8f6f\u4ef6\u786c\u4ef6\u5206\u522b\u53d1\u5c55\uff0c\u4e5f\u4e0d\u4f1a\u51fa\u9519\u3002</p>\n<p>\u4f46\u786c\u4ef6\u5382\u5546\u5bf9\u8fd9\u4e2a\u4e8b\u60c5\u4e5f\u626d\u626d\u634f\u634f\uff0c\u751f\u6015\u4eca\u5929\u505a\u4e86\u4ec0\u4e48\u89c4\u5b9a\uff0c\u660e\u5929\u53d1\u73b0\u8fd9\u4e2a\u89c4\u5b9a\u4f1a\u6d6a\u8d39\u4e86\u4e00\u4e2a\u5de8\u5927\u7684\u6027\u80fd\u63d0\u5347\u673a\u4f1a\uff0c\u4f46\u7ade\u4e89\u5bf9\u624b\u6ca1\u6709\u505a\u8fd9\u4e2a\u627f\u8bfa\uff0c\u7ade\u4e89\u5bf9\u624b\u5c31\u5f97\u5230\u4e86\u4f18\u52bf\u3002\u4f46\u662f\u4e0d\u505a\u627f\u8bfa\u5462\uff0c\u8f6f\u4ef6\u751f\u6001\u53c8\u6210\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u5728\u4eca\u5e74\u7684\u5904\u7406\u5668\u4e0a\u5199\u4ee3\u7801\uff0c\u53ea\u80fd\u4fdd\u8bc1\u5728\u4eca\u5e74\u7684\u5904\u7406\u5668\u4e0a\u53ef\u4ee5\u6b63\u5e38\u8dd1\uff0c\u660e\u5e74\u51fa\u4e86\u65b0\u7684\u5904\u7406\u5668\uff0c\u51fa\u73b0\u4e86\u4e0d\u517c\u5bb9\u7684\u5730\u65b9\uff0c\u53c8\u8981\u91cd\u65b0\u6539\u4e00\u904d\uff0c\u8fd9\u4f1a\u628a\u8f6f\u4ef6\u5f00\u53d1\u8005\u7ed9\u8d76\u8dd1\u7684\u3002\u5728\u8fd9\u79cd\u522b\u626d\u7684\u5fc3\u6001\u4e0b\uff0c\u5f88\u957f\u65f6\u95f4\u4ee5\u6765\uff0c\u786c\u4ef6\u5382\u5546\u5bf9\u6b64\u90fd\u5199\u7684\u6709\u4e9b\u8bed\u7109\u4e0d\u8be6\uff0c\u76f8\u5173\u7684\u4e89\u8bba\u5728\u96f6\u51e0\u5e74\u90fd\u4e00\u76f4\u80fd\u770b\u5230\u3002</p>\n<p>\u4e0d\u8fc7\u597d\u5728\u73b0\u5728\u662f 2024 \u5e74\uff0c\u5927\u591a\u6570\u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\u90fd\u5df2\u7ecf\u6bd4\u8f83\u660e\u786e\uff0c\u867d\u7136\u5f88\u591a\u65f6\u5019\u786c\u4ef6\u5382\u5546\u505a\u7684\u662f\u6bd4\u8f83\u5bbd\u677e\u7684\u4fdd\u8bc1\uff0c\u5b9e\u9645\u5b9e\u73b0\u7684\u65f6\u5019\u4f1a\u66f4\u52a0\u4e25\u683c\uff0c\u4f8b\u5982\u58f0\u79f0 A \u548c B \u662f\u5141\u8bb8\u4e71\u5e8f\u6267\u884c\u7684\uff0c\u4f46\u5b9e\u9645\u4e0a\u76ee\u524d\u7684\u6240\u6709\u786c\u4ef6\u90fd\u6ca1\u6709\u8fd9\u4e48\u505a\uff0c\u8f6f\u4ef6\u4e5f\u53ea\u80fd\u6309\u7167\u6700\u4fdd\u5b88\u7684\u65b9\u5f0f\u6765\u505a\u5047\u8bbe\u3002\u4f46\u6709\u603b\u6bd4\u6ca1\u6709\u597d\uff0c\u53ef\u80fd\u4e5f\u662f\u786c\u4ef6\u5382\u5546\u7814\u7a76\u4e86\u5f88\u591a\u5e74\uff0c\u6ca1\u53d1\u73b0\u4ec0\u4e48\u53ef\u4ee5\u7ee7\u7eed\u4f18\u5316\u7684\u4f59\u5730\u4e86\uff0c\u4e0d\u5982\u6b7b\u4e86\u5fc3\u628a\u89c4\u77e9\u7ed9\u5b9a\u4e0b\u6765\uff0c\u628a\u8f6f\u4ef6\u751f\u6001\u7ed9\u6253\u597d\u3002</p>\n<p>\u73b0\u5728\u5f00\u59cb\u8bb2\u5b9e\u9645\u7684\u5185\u5b58\u6a21\u578b\u548c\u5185\u5b58\u5e8f\u3002\u4e3a\u4ec0\u4e48\u8fd9\u4e24\u4e2a\u6982\u5ff5\u603b\u662f\u653e\u5728\u4e00\u8d77\u8bb2\uff1f\u4ec0\u4e48\u662f\u6a21\u578b\uff1f\u4ec0\u4e48\u662f\u5e8f\uff1f</p>\n<p>CPU \u6838\u5fc3\u7684\u5b9e\u73b0\u662f\u5f88\u590d\u6742\u7684\uff0c\u4e0d\u540c\u4ee3\u7684 CPU \u67b6\u6784\u7684\u5b9e\u73b0\u4e5f\u6709\u5f88\u591a\u4e0d\u540c\uff0c\u5c4f\u853d\u8fd9\u4e9b\u5fae\u67b6\u6784\u7684\u7ec6\u8282\uff0c\u628a\u5b83\u4eec\u5bf9\u8f6f\u4ef6\u66b4\u9732\u51fa\u6765\u7684\u884c\u4e3a\uff0c\u62bd\u8c61\u51fa\u4e00\u4e2a\u7edf\u4e00\u7684\u786c\u4ef6\u6a21\u578b\uff0c\u8fd9\u4e2a\u6a21\u578b\u5c55\u73b0\u4e86\u786c\u4ef6\u9488\u5bf9\u5185\u5b58\u8bbf\u95ee\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u5c31\u662f\u5185\u5b58\u6a21\u578b\u3002\u6839\u636e\u5185\u5b58\u6a21\u578b\uff0c\u5b9a\u4e49\u54ea\u4e9b\u60c5\u51b5\u4e0b\uff0c\u54ea\u4e9b\u6307\u4ee4\u53ef\u4ee5\u548c\u54ea\u4e9b\u6307\u4ee4\u4e71\u5e8f\uff0c\u4e3a\u4e86\u907f\u514d\u4e71\u5e8f\uff0c\u53c8\u53ef\u4ee5\u6dfb\u52a0\u54ea\u4e9b\u6307\u4ee4\u6765\u907f\u514d\u4e71\u5e8f\uff0c\u8fd9\u5c31\u662f\u5185\u5b58\u5e8f\u3002\u901a\u8fc7\u5bf9\u786c\u4ef6\u7684\u5efa\u6a21\uff0c\u628a\u590d\u6742\u7684\u5fae\u67b6\u6784\u5b9e\u73b0\u5265\u79bb\u51fa\u6765\uff0c\u5f97\u5230\u4e00\u4e2a\u62bd\u8c61\u7684\u6a21\u578b\uff0c\u4ee5\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u7406\u8bba\u53bb\u7814\u7a76\u5b83\u7684\u884c\u4e3a\u3002</p>\n<h3 id=\"sc\">SC<a class=\"headerlink\" href=\"#sc\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e0b\u9762\u6765\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u5185\u5b58\u6a21\u578b\u7684\u4f8b\u5b50\uff1a\u5047\u5982 CPU \u4e0d\u505a\u4efb\u4f55\u7684\u4e71\u5e8f\uff0c\u4e25\u683c\u6309\u7167\u6307\u4ee4\u7684\u987a\u5e8f\u8fdb\u884c\u8bbf\u5b58\uff1b\u4ece\u591a\u6838\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u6765\u81ea\u4e0d\u540c\u6838\u5fc3\u7684\u8bbf\u5b58\u90fd\u4f1a\u5230\u8fbe\u5185\u5b58\u5b50\u7cfb\u7edf\uff0c\u6bcf\u4e2a\u8bbf\u5b58\u90fd\u662f\u539f\u5b50\u7684\u3002\u90a3\u4e48\u6700\u540e\u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u8fdb\u884c\u7684\u8bbf\u5b58\u5e8f\u5217\uff0c\u5c31\u662f\u5404\u4e2a\u6838\u5fc3\u7684\u7a0b\u5e8f\u7684\u8bbf\u5b58\u5e8f\u5217\u4ea4\u9519\u7684\u7ed3\u679c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff1a</p>\n<p>A \u6838\u5fc3\u4e0a\u7684\u7a0b\u5e8f\u8981\u8fdb\u884c Read a\uff08\u8868\u793a\u8bfb\u53d6 a \u5730\u5740\u7684\u6570\u636e\uff0c\u4e0b\u9762\u7b80\u79f0 Ra\uff09\u548c Write a \u64cd\u4f5c\uff08\u8868\u793a\u628a\u6570\u636e\u5199\u5165 a \u5730\u5740\uff0c\u4e0b\u9762\u7b80\u79f0 Wa\uff09\uff1bB \u6838\u5fc3\u4e0a\u7684\u7a0b\u5e8f\u8981\u8fdb\u884c Read b \u548c Write b \u64cd\u4f5c\u3002\u7531\u4e8e\u6bcf\u4e2a\u6838\u5fc3\u5185\u90e8\u4e0d\u4f1a\u5bf9\u8bbf\u5b58\u8fdb\u884c\u91cd\u6392\uff0c\u6240\u4ee5\u8fd9\u4e9b\u8bbf\u5b58\u64cd\u4f5c\u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u6267\u884c\u65f6\uff0c\u4f1a\u4fdd\u6301\u5b83\u5728\u7a0b\u5e8f\u91cc\u7684\u6267\u884c\u987a\u5e8f\uff0c\u8fd9\u4e2a\u53eb\u505a program order\u3002\u7531\u4e8e\u4e0d\u540c\u6838\u5fc3\u53d1\u8d77\u8bbf\u5b58\u7684\u65f6\u95f4\u4e0d\u540c\uff0c\u6700\u540e\u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u6267\u884c\u7684\u8bbf\u5b58\u53ef\u80fd\u6709\u8fd9\u4e9b\u60c5\u51b5\uff1a</p>\n<ul>\n<li>Ra Wa Rb Wb</li>\n<li>Ra Rb Wa Wb</li>\n<li>Ra Rb Wb Wa</li>\n<li>Rb Ra Wa Wb</li>\n<li>Rb Ra Wb Wa</li>\n<li>Rb Wb Ra Wa</li>\n</ul>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u53ef\u80fd\u662f\u5148\u5b8c\u6210\u6240\u6709 A \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff0c\u518d\u5b8c\u6210 B \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff08Ra Wa Rb Wb\uff09\uff0c\u4e5f\u53ef\u80fd\u53cd\u8fc7\u6765\uff0c\u5148\u5b8c\u6210 B \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff0c\u518d\u5b8c\u6210 A \u6838\u5fc3\u4e0a\u7684\u8bbf\u5b58\uff08Rb Wb Ra Wa\uff09\uff0c\u4e5f\u53ef\u80fd\u4e24\u4e2a\u6838\u5fc3\u7684\u8bbf\u5b58\u4ea4\u9519\u8fdb\u884c\uff08\u4f8b\u5982 Ra Rb Wa Wb\uff09\u3002\u5b83\u4eec\u90fd\u6ee1\u8db3\u4e00\u4e2a\u6761\u4ef6\uff1aRa \u4e00\u5b9a\u5728 Wa \u4e4b\u524d\uff0cRb \u4e00\u5b9a\u5728 Wb \u4e4b\u524d\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0cRa \u4e00\u5b9a\u5728 Wa \u4e4b\u524d\u7684\u8fd9\u79cd program order \u5728\u5185\u5b58\u5b50\u7cfb\u7edf\u4e0a\u7684\u6267\u884c\u987a\u5e8f memory order \u91cc\u4e5f\u4e00\u5b9a\u4f1a\u4fdd\u8bc1\u3002</p>\n<p>\u8fd9\u79cd\u5185\u5b58\u6a21\u578b\u5c31\u662f Sequential Consistency (\u7b80\u79f0 SC)\uff0c\u5b83\u7684\u6027\u8d28\u5c31\u662f\u9075\u5faa program order\uff0c\u4ece\u6bcf\u4e2a\u6838\u5fc3\u6765\u770b\uff0c\u4ee3\u7801\u600e\u4e48\u5199\u7684\u5c31\u600e\u4e48\u8dd1\uff0c\u4e0d\u505a\u91cd\u6392\uff0c\u800c\u6765\u81ea\u4e0d\u540c\u6838\u5fc3\u7684\u8bbf\u5b58\u4e4b\u95f4\u7684\u987a\u5e8f\u4e0d\u505a\u8981\u6c42\u3002\u4e0b\u9762\u662f SC \u6a21\u578b\u7684\u56fe\u793a\uff08\u56fe\u6e90 <a href=\"https://www.cl.cam.ac.uk/~pes20/ppc-supplemental/test7.pdf\">A Tutorial Introduction to the ARM and POWER Relaxed Memory Model</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_sc.png\" /></p>\n<p>\u6839\u636e\u8fd9\u4e2a\u6027\u8d28\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5206\u6790\u8f6f\u4ef6\u7684\u884c\u4e3a\uff0c\u5224\u65ad\u5b83\u662f\u5426\u53ef\u80fd\u51fa\u73b0\u7279\u5b9a\u7684\u7ed3\u679c\u3002\u4e0b\u9762\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff1a</p>\n<p>\u5047\u5982\u6709\u4e24\u4e2a\u7ebf\u7a0b\uff0cA \u7ebf\u7a0b\u8981\u7ed9 B \u7ebf\u7a0b\u4f20\u8f93\u6570\u636e\uff0c\u4e24\u4e2a\u7ebf\u7a0b\u5206\u522b\u8dd1\u5728\u4e24\u4e2a\u6838\u5fc3\u4e0a\u3002\u4e3a\u4e86\u4f20\u8f93\u6570\u636e\uff0cA \u628a\u6570\u636e\u653e\u5728\u5185\u5b58\u5730\u5740 x \u91cc\uff0c\u4e3a\u4e86\u6807\u8bb0\u6570\u636e\u51c6\u5907\u5b8c\u6210\uff0c\u53e6\u5916\u5728\u5185\u5b58\u5730\u5740 y \u653e\u4e86\u4e00\u4e2a\u6807\u8bb0\uff0c0 \u8868\u793a\u6570\u636e\u8fd8\u6ca1\u51c6\u5907\u597d\uff0c1 \u8868\u793a\u6570\u636e\u51c6\u5907\u597d\u4e86\u3002\u90a3\u4e48 A \u8981\u4f20\u8f93\u6570\u636e\u7684\u65f6\u5019\uff0c\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff1a</p>\n<ol>\n<li>\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u5f80 y \u5730\u5740\u5199\u5165 0</li>\n<li>\u8981\u4f20\u8f93\u6570\u636e\u65f6\uff0c\u5148\u5f80 x \u5730\u5740\u5199\u5165\u8981\u4f20\u8f93\u7684\u6570\u636e\uff0c\u518d\u5f80 y \u5730\u5740\u5199\u5165 1</li>\n</ol>\n<p>\u53e6\u4e00\u8fb9\uff0cB \u7ebf\u7a0b\u8981\u7b49\u5f85 A \u7ebf\u7a0b\u53d1\u9001\u7684\u6570\u636e\uff0c\u90a3\u4e48\u5b83\u5e94\u8be5\uff1a</p>\n<ol>\n<li>\u8bfb\u53d6 y \u5730\u5740\u7684\u5185\u5bb9\uff0c\u68c0\u67e5\u662f\u5426\u4e3a 1</li>\n<li>\u5982\u679c\u662f 1\uff0c\u8bf4\u660e\u4f20\u8f93\u7684\u6570\u636e\u5df2\u7ecf\u5728 x \u5730\u5740\u4e2d\u4e86\uff0c\u518d\u4ece x \u5730\u5740\u8bfb\u53d6\u8981\u4f20\u8f93\u7684\u6570\u636e</li>\n</ol>\n<p>\u73b0\u5728\u95ee\u9898\u6765\u4e86\uff1a\u4ee5\u4e0a\u7684\u5199\u6cd5\uff0c\u5b83\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u5417\uff1f\u6211\u5f53\u7136\u53ef\u4ee5\u53bb\u5404\u4e2a\u786c\u4ef6\u5e73\u53f0\u4e0a\u90fd\u6d4b\u8bd5\u6d4b\u8bd5\uff0c\u770b\u770b\u5230\u5e95\u80fd\u4e0d\u80fd\u5de5\u4f5c\u3002\u4f46\u662f\u65e2\u7136\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u4e86\u786c\u4ef6\u662f\u6309\u7167\u4e00\u5b9a\u7684\u5185\u5b58\u6a21\u578b\u5b9e\u73b0\u7684\uff0c\u90a3\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\uff0c\u662f\u5426\u53ef\u4ee5\u4ece\u5185\u5b58\u6a21\u578b\u7684\u89d2\u5ea6\u6765\u5224\u65ad\u5b83\u5230\u5e95\u662f\u5426\u53ef\u884c\u3002</p>\n<p>\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u53cd\u8bc1\u6cd5\uff1a\u5982\u679c\u4e0a\u9762\u7684\u4f20\u8f93\u6570\u636e\u65b9\u6cd5\u4e0d\u53ef\u884c\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u6837\u7684\u7ed3\u679c\uff1f\u90a3\u5c31\u662f B \u8bfb\u53d6\u5230\u4e86\u9519\u8bef\u7684\u6570\u636e\uff0c\u4e5f\u5c31\u662f B \u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\u65f6\uff0cA \u8fd8\u6ca1\u6709\u6765\u5f97\u53ca\u5f80 x \u5730\u5740\u5199\u5165\u6570\u636e\u3002\u8fd9\u53ef\u80fd\u5417\uff1f\u6211\u4eec\u6765\u8fdb\u884c\u63a8\u5bfc\uff1a</p>\n<p>\u9996\u5148\u7b80\u5316\u4e00\u4e0b A \u7ebf\u7a0b\u505a\u7684\u64cd\u4f5c\uff1a</p>\n<ol>\n<li>\u5411 x \u5730\u5740\u5199\u5165\u6570\u636e\uff0c\u4e0d\u59a8\u8bbe\u8fd9\u4e2a\u6570\u636e\u662f 1\uff0c\u4e5f\u5c31\u662f <code>*x = 1</code>\uff0c\u8bb0\u4e3a Wx1\uff08W \u8868\u793a write\uff0c\u540e\u9762\u8ddf\u968f\u5730\u5740\u4ee5\u53ca\u5199\u5165\u7684\u6570\u636e\uff09</li>\n<li>\u5411 y \u5730\u5740\u5199\u5165 1\uff0c\u8868\u793a\u6570\u636e\u51c6\u5907\u5b8c\u6210\uff0c\u4e5f\u5c31\u662f <code>*y = 1</code>\uff0c\u8bb0\u4e3a Wy1</li>\n</ol>\n<p>\u63a5\u7740\u662f B \u7ebf\u7a0b\u505a\u7684\u64cd\u4f5c\uff0c\u5047\u8bbe\u51fa\u73b0\u4e86\u9519\u8bef\u60c5\u51b5\uff0c\u4e5f\u5c31\u662f\u5728 <code>y = 1</code> \u7684\u65f6\u5019\uff0c\u4ece x \u8bfb\u53d6\u4e86\u9519\u8bef\u7684\u6570\u636e\uff1a</p>\n<ol>\n<li>\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u5f97\u5230\u4e86 1\uff0c\u8868\u793a\u6570\u636e\u51c6\u5907\u5b8c\u6210\uff0c\u4e5f\u5c31\u662f <code>r1 = *y</code>\uff0cr1 \u7b49\u4e8e 1\uff0c\u8bb0\u4e3a Ry1\uff08R \u8868\u793a read\uff0c\u540e\u9762\u8ddf\u968f\u5730\u5740\u4ee5\u53ca\u8bfb\u53d6\u5230\u7684\u6570\u636e\uff09</li>\n<li>\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u56e0\u4e3a\u524d\u9762\u5047\u8bbe\u4e86\u8bfb\u53d6\u4e86\u9519\u8bef\u7684\u6570\u636e\uff0c\u6b63\u786e\u7684\u6570\u636e\u662f 1\uff0c\u4e0d\u59a8\u8bbe\u9519\u8bef\u7684\u6570\u636e\u662f 0\uff0c\u4e5f\u5c31\u662f <code>r2 = *x</code>\uff0cr2 \u7b49\u4e8e 0\uff0c\u8bb0\u4e3a Rx0</li>\n</ol>\n<p>\u63a5\u4e0b\u6765\u8bc1\u660e\uff1a\u5728 SC \u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u8fd9\u79cd\u53ef\u80fd\u6027\u4e0d\u5b58\u5728\uff1a</p>\n<ol>\n<li>\u5728 SC \u5185\u5b58\u6a21\u578b\u4e0b\uff0cprogram order \u5f97\u5230\u4fdd\u6301\uff0c\u4e5f\u5c31\u662f A \u548c B \u7ebf\u7a0b\u5404\u81ea\u7684\u6267\u884c\u987a\u5e8f\u662f\u4fdd\u8bc1\u7684\uff0c\u53ef\u77e5 Wx1 \u5fc5\u987b\u51fa\u73b0\u5728 Wy1 \u4e4b\u524d\uff0cRy1 \u5fc5\u987b\u51fa\u73b0\u5728 Rx0 \u4e4b\u524d\uff0c\u8bb0\u4f5c Wx1 -&gt; Wy1\uff0cRy1 -&gt; Rx0</li>\n<li>\u5bf9\u4e8e x \u5730\u5740\u6765\u8bf4\uff0cWx1 \u5199\u5165\u4e86 1\uff0cRx0 \u8bfb\u51fa\u4e86 0\uff0c\u8bf4\u660e Rx0 \u5fc5\u987b\u5728 Wx1 \u4e4b\u524d\u6267\u884c\uff0c\u624d\u53ef\u80fd\u8bfb\u5230 0\uff0c\u5373 Rx0 -&gt; Wx1\uff1b\u5bf9\u4e8e y \u5730\u5740\u6765\u8bf4\uff0cWy1 \u5199\u5165\u4e86 1\uff0cRy1 \u8bfb\u51fa\u4e86 1\uff0c\u7531\u4e8e y \u5730\u5740\u7684\u521d\u59cb\u503c\u662f 0\uff0c\u8bf4\u660e Ry1 \u5fc5\u987b\u5728 Wy1 \u4e4b\u540e\u6267\u884c\uff0c\u624d\u53ef\u80fd\u8bfb\u5230 0\uff0c\u5373 Wy1 -&gt; Ry1</li>\n</ol>\n<p>\u8fd9\u6837\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff1a</p>\n<ol>\n<li>Wx1 -&gt; Wy1</li>\n<li>Wy1 -&gt; Ry1</li>\n<li>Ry1 -&gt; Rx0</li>\n<li>Rx0 -&gt; Wx1</li>\n</ol>\n<p>\u4f60\u4f1a\u53d1\u73b0\u8fd9\u56db\u4e2a\u64cd\u4f5c\u7684\u987a\u5e8f\u5173\u7cfb\u51fa\u73b0\u4e86\u73af\uff0c\u8bf4\u660e\u4e0d\u5b58\u5728\u4e00\u4e2a\u6267\u884c\u5e8f\u5217\uff0c\u53ef\u4ee5\u540c\u65f6\u6ee1\u8db3\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u3002\u4e5f\u5c31\u8bf4\u660e SC \u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u4e0d\u53ef\u80fd\u5f97\u5230\u8fd9\u4e2a\u6267\u884c\u7ed3\u679c\u3002\u901a\u8fc7\u5185\u5b58\u6a21\u578b\uff0c\u6211\u53ef\u4ee5\u4ece\u7406\u8bba\u4e0a\u8bc1\u660e\u8fd9\u6bb5\u4ee3\u7801\u5728 SC \u5185\u5b58\u6a21\u578b\u4e0b\u662f\u6ca1\u6709\u95ee\u9898\u7684\uff0c\u90a3\u4e48\u8fd9\u6bb5\u4ee3\u7801\u5728\u6240\u6709\u5b9e\u73b0\u4e86 SC \u5185\u5b58\u6a21\u578b\u7684\u5904\u7406\u5668\u4e0a\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u3002</p>\n<h3 id=\"litmus\">Litmus<a class=\"headerlink\" href=\"#litmus\" title=\"Permanent link\">&para;</a></h3>\n<p>\u50cf\u4e0a\u9762\u8fd9\u79cd\u6765\u81ea\u591a\u7ebf\u7a0b\u7f16\u7a0b\u7684\u4e00\u4e2a\u5c0f\u7247\u6bb5\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u5185\u5b58\u6a21\u578b\u7684\u89d2\u5ea6\u5206\u6790\u5b83\u53ef\u80fd\u7684\u6267\u884c\u7ed3\u679c\uff0c\u4e5f\u53ef\u4ee5\u5728\u5b9e\u9645\u7684\u5904\u7406\u5668\u4e0a\u8fd0\u884c\uff0c\u8fd9\u79cd\u5c0f\u7247\u6bb5\u5c31\u53eb\u505a Litmus test\uff0c\u4e0a\u9762\u770b\u5230\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u5176\u5b9e\u662f Litmus test \u5f53\u4e2d\u7684 Message Passing \u6d4b\u8bd5\uff08MP\uff09\u3002\u5229\u7528 <a href=\"https://github.com/herd/herdtools7\">herd/herdtools7 on GitHub</a> \u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u7535\u8111\u4e0a\u5b9e\u9645\u53bb\u8fd0\u884c Litmus test\uff0c\u89c2\u5bdf\u5b83\u7684\u5b9e\u9645\u8fd0\u884c\u7ed3\u679c\u3002herdtools7 \u7684\u5b89\u88c5\u6d41\u7a0b\uff1a</p>\n<ol>\n<li>\u5b89\u88c5 OCaml \u5de5\u5177\u94fe\uff08\u5305\u62ec opam\uff09\uff0c\u914d\u7f6e opam</li>\n<li>\u7528 opam \u5b89\u88c5 herdtools7: <code>opam install herdtools7</code></li>\n</ol>\n<p>\u6709\u4e86 herdtools7 \u4ee5\u540e\uff0c\u5982\u679c\u8981\u6267\u884c\u4e0a\u9762\u7684 Message Passing \u6d4b\u8bd5\uff0c\u53ea\u9700\u8981\u6309\u7167\u8fd0\u884c\u5982\u4e0b\u7684\u547d\u4ee4\uff08\u4ee5 x86 \u4e3a\u4f8b\uff09\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>diycross7<span class=\"w\"> </span>-arch<span class=\"w\"> </span>X86<span class=\"w\"> </span>-name<span class=\"w\"> </span>MP-X86<span class=\"w\"> </span>PodWW<span class=\"w\"> </span>Rfe<span class=\"w\"> </span>PodRR<span class=\"w\"> </span>Fre\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>litmus7<span class=\"w\"> </span>MP-X86.litmus\n</span></code></pre></div>\n<p>\u5b83\u5c31\u4f1a\u5728 x86 \u673a\u5668\u4e0a\u8fd0\u884c MP \u6d4b\u8bd5\uff0c\u8fd0\u884c 1000000 \u6b21\u540e\uff0c\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0\u524d\u9762\u6240\u8ff0\u7684\u8bfb\u51fa\u6765 y \u7b49\u4e8e 1 \u4f46\u662f x \u7b49\u4e8e 0 \u7684\u60c5\u51b5\u3002\u90a3\u4e48\u4e0a\u9762\u51fa\u73b0\u7684 <code>PodWW Rfe PodRR Fre</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f\u6211\u4eec\u9996\u5148\u6765\u770b\u770b\u751f\u6210\u7684 <code>MP-X86.litmus</code> \u6587\u4ef6\u7684\u5185\u5bb9\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>X86 MP-X86\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>&quot;PodWW Rfe PodRR Fre&quot;\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>Cycle=Rfe PodRR Fre PodWW\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>Generator=diycross7 (version 7.56+03)\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>Prefetch=0:x=F,0:y=W,1:y=F,1:x=T\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>Com=Rf Fr\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>Orig=PodWW Rfe PodRR Fre\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>{\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a>}\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a> P0         | P1          ;\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a> MOV [x],$1 | MOV EAX,[y] ;\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a> MOV [y],$1 | MOV EBX,[x] ;\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a>exists (1:EAX=1 /\\ 1:EBX=0)\n</span></code></pre></div>\n<p>\u5ffd\u7565\u5f00\u5934\u7684\u90e8\u5206\uff0c\u76f4\u63a5\u4ece P0 P1 \u8fd9\u4e00\u884c\u5f00\u59cb\u770b\uff1aP0 \u548c P1 \u5bf9\u5e94\u4e24\u4e2a\u5904\u7406\u5668\u6838\u5fc3\uff0c\u4e0b\u9762\u662f\u5728\u8fd9\u4e24\u4e2a\u6838\u5fc3\u4e0a\u8981\u8fd0\u884c\u7684\u6c47\u7f16\u6307\u4ee4\uff1a</p>\n<ul>\n<li>P0 \u4e0a\u8fd0\u884c\uff1a<ul>\n<li>MOV [x], $1\uff1a\u5f80 x \u5730\u5740\u5199\u5165 1\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>*x = 1</code>, Wx1</li>\n<li>MOV [y], $1\uff1a\u5f80 y \u5730\u5740\u5199\u5165 1\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>*y = 1</code>, Wy1</li>\n</ul>\n</li>\n<li>P1 \u4e0a\u8fd0\u884c\uff1a<ul>\n<li>MOV EAX, [y]\uff1a\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u4fdd\u5b58\u5728 EAX \u5bc4\u5b58\u5668\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>r1 = *y</code></li>\n<li>MOV EBX, [x]\uff1a\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u4fdd\u5b58\u5728 EAX \u5bc4\u5b58\u5668\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u8bf4\u7684 <code>r2 = *x</code></li>\n</ul>\n</li>\n</ul>\n<p>\u6b63\u597d\u5c31\u662f Message Passing \u6d4b\u8bd5\u7684\u5185\u5bb9\uff0c\u53ea\u4e0d\u8fc7\u7528\u6c47\u7f16\u5b8c\u6210\u4e86\u5b9e\u73b0\u3002\u6700\u540e\uff0c\u5b83\u63d0\u95ee\uff1a<code>exists (1:EAX=1 /\\ 1:EBX=0)</code>\uff0c\u5373\u662f\u5426\u5b58\u5728\u4e00\u79cd\u53ef\u80fd\uff0cP1 \u7684 EAX \u5bc4\u5b58\u5668\uff08<code>1:EAX</code>\uff09\u7b49\u4e8e 1\uff0c\u540c\u65f6\uff08<code>/\\</code> \u8868\u793a\u903b\u8f91\u4e0e\uff09P1 \u7684 EBX \u5bc4\u5b58\u5668\uff08<code>1:EBX</code>\uff09\u7b49\u4e8e 0\uff1f\u8fd9\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684\u9519\u8bef\u60c5\u51b5\uff0cy \u7b49\u4e8e 1 \u4f46\u662f x \u7b49\u4e8e 0\u3002</p>\n<p>\u63a5\u4e0b\u6765\u7684 <code>litmus7 MP-X86.litmus</code> \u547d\u4ee4\u5c31\u4f1a\u5728\u4e24\u4e2a\u6838\u5fc3\u4e0a\u8fd0\u884c\u8fd9\u6bb5\u6c47\u7f16\uff0c\u5e76\u4e14\u7edf\u8ba1\u6700\u7ec8\u7684\u6267\u884c\u7ed3\u679c\uff0c\u53d1\u73b0\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-2-1\"><a id=\"__codelineno-2-1\" name=\"__codelineno-2-1\" href=\"#__codelineno-2-1\"></a>Histogram (3 states)\n</span><span id=\"__span-2-2\"><a id=\"__codelineno-2-2\" name=\"__codelineno-2-2\" href=\"#__codelineno-2-2\"></a>500087:&gt;1:EAX=0; 1:EBX=0;\n</span><span id=\"__span-2-3\"><a id=\"__codelineno-2-3\" name=\"__codelineno-2-3\" href=\"#__codelineno-2-3\"></a>1281  :&gt;1:EAX=0; 1:EBX=1;\n</span><span id=\"__span-2-4\"><a id=\"__codelineno-2-4\" name=\"__codelineno-2-4\" href=\"#__codelineno-2-4\"></a>498632:&gt;1:EAX=1; 1:EBX=1;\n</span></code></pre></div>\n<p>\u8fd0\u884c\u4e86 1000000 \u6b21\uff0c\u89c2\u5bdf\u5230 500087 \u6b21 y=1, x=0\uff1b1281 \u6b21 y=0, x=1\uff1b498632 \u6b21 y=1, x=1\uff1b\u6ca1\u6709\u89c2\u5bdf\u5230 y=1 &amp;&amp; x=0\u3002\u4e5f\u5c31\u662f\u6ca1\u6709\u627e\u5230\u53cd\u4f8b\u3002</p>\n<p>\u90a3\u4e48 diycross7 \u547d\u4ee4\u662f\u600e\u4e48\u751f\u6210\u8fd9\u6bb5\u6c47\u7f16\u7684\u5462\uff1f\u7b54\u6848\u5c31\u5728 <code>PodWW Rfe PodRR Fre</code> \u53c2\u6570\u5f53\u4e2d\u3002\u5b83\u63cf\u8ff0\u7684\u5c31\u662f\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff1a</p>\n<ol>\n<li>Wx1 -&gt; Wy1: P0 \u4e0a\u7684 program order</li>\n<li>Wy1 -&gt; Ry1: memory \u4e0a\u7684\u5199\u540e\u8bfb</li>\n<li>Ry1 -&gt; Rx0: P1 \u4e0a\u7684 program order</li>\n<li>Rx0 -&gt; Wx1: memory \u4e0a\u7684\u8bfb\u540e\u5199</li>\n</ol>\n<p>\u5982\u679c\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u90fd\u5f97\u5230\u4fdd\u8bc1\uff0c\u90a3\u4e48\u5c31\u4e0d\u5b58\u5728\u4e00\u4e2a\u6267\u884c\u5e8f\u5217\u53ef\u4ee5\u540c\u65f6\u6ee1\u8db3\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u3002\u5728 diycross7 \u7684\u8bed\u8a00\u91cc\u9762\uff0c\u6211\u4eec\u628a\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\u63cf\u8ff0\u51fa\u6765\uff1a</p>\n<ol>\n<li>Wx1 -&gt; Wy1: P0 \u4e0a\u7684 program order\uff0c\u5e76\u4e14\u662f\u4e24\u4e2a Write \u4e4b\u95f4\u7684 program order\uff0c\u6240\u4ee5\u662f PodWW\uff08Pod = program order\uff0cWW = write to write\uff09</li>\n<li>Wy1 -&gt; Ry1: memory \u4e0a\u7684\u5199\u540e\u8bfb\uff0c\u5e76\u4e14\u5206\u522b\u5728 P0 \u548c P1 \u4e0a\u6267\u884c\uff0c\u6240\u4ee5\u662f Rfe\uff08Rf = read from\uff0c\u540e\u9762\u7684 read \u7684\u6570\u636e\u6765\u81ea\u524d\u9762\u7684 write\uff0c\u7bad\u5934\u4ece W \u6307\u5411 R\uff0ce = external\uff0c\u8868\u793a\u8bfb\u548c\u5199\u5728\u4e24\u4e2a\u6838\u4e0a\uff09</li>\n<li>Ry1 -&gt; Rx0: P1 \u4e0a\u7684 program order\uff0c\u5e76\u4e14\u662f\u4e24\u4e2a Read \u4e4b\u95f4\u7684 program order\uff0c\u6240\u4ee5\u662f PodRR\uff08Pod = program order\uff0cRR = read to read\uff09</li>\n<li>Rx0 -&gt; Wx1: memory \u4e0a\u7684\u8bfb\u540e\u5199\uff0c\u5e76\u4e14\u5206\u522b\u5728 P1 \u548c P0 \u4e0a\u6267\u884c\uff0c\u6240\u4ee5\u662f Fre\uff08Fr = from read\uff0c\u8bfb\u5728\u524d\uff0c\u5199\u5728\u540e\uff0c\u7bad\u5934\u4ece R \u6307\u5411 W\uff0ce = external\uff0c\u8868\u793a\u8bfb\u548c\u5199\u5728\u4e24\u4e2a\u6838\u4e0a\uff09</li>\n</ol>\n<p>\u4e8e\u662f\u6211\u4eec\u5c31\u7528 <code>PodWW Rfe PodRR Fre</code> \u63cf\u8ff0\u4e86\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff0cdiycross7 \u5de5\u5177\u5c31\u6839\u636e\u8fd9\u56db\u7ec4\u987a\u5e8f\u5173\u7cfb\uff0c\u751f\u6210\u4e86\u6c47\u7f16\u7a0b\u5e8f\uff0c\u8fd9\u4e2a\u6c47\u7f16\u7a0b\u5e8f\u4f1a\u7528\u5230\u8fd9\u4e9b\u987a\u5e8f\u5173\u7cfb\uff0c\u90a3\u4e48\u5728\u5904\u7406\u5668\u4e0a\u6267\u884c\uff0c\u5c31\u53ef\u4ee5\u5224\u65ad\u5728\u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u8fd9\u4e2a\u73af\u662f\u5426\u53ef\u80fd\u6253\u7834\uff0c\u53cd\u4f8b\u662f\u5426\u53ef\u80fd\u5b58\u5728\u3002\u901a\u8fc7\u8fd9\u79cd\u63cf\u8ff0\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u51fa\u5404\u79cd\u5404\u6837\u7684 Litmus test\uff0c\u6d4b\u8bd5\u548c\u5206\u6790\u4e0d\u540c\u7684\u4ee3\u7801\u5728\u5404\u79cd\u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u4f1a\u6709\u600e\u6837\u7684\u8868\u73b0\u3002</p>\n<h3 id=\"store-buffer\">Store Buffer<a class=\"headerlink\" href=\"#store-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u6682\u65f6\u5148\u4e0d\u8bb2\u5185\u5b58\u6a21\u578b\uff0c\u5148\u8bb2\u8bb2\u5904\u7406\u5668\u5728\u8bbf\u5b58\u4e0a\u7684\u4e00\u4e2a\u91cd\u8981\u7684\u4f18\u5316\uff1aStore Buffer\u3002\u5bf9\u4e8e\u4e71\u5e8f\u6267\u884c\u5904\u7406\u5668\u6765\u8bf4\uff0c\u9884\u6d4b\u6267\u884c\u662f\u6709\u9650\u5ea6\u7684\uff0c\u56e0\u4e3a\u5982\u679c\u9884\u6d4b\u9519\u8bef\u4e86\uff0c\u9700\u8981\u56de\u6eda\u5230\u6b63\u786e\u7684\u72b6\u6001\uff0c\u8fd9\u4e5f\u610f\u5473\u7740\uff0c\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u4e0d\u80fd\u7b80\u5355\u5730\u9884\u6d4b\u6267\u884c\uff1a\u4f8b\u5982\u5728\u4e00\u6bb5\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u4ee3\u7801\u91cc\uff0c\u9700\u8981\u6839\u636e\u7528\u6237\u7684\u8f93\u5165\u51b3\u5b9a\u7535\u8111\u8981\u5173\u673a\u8fd8\u662f\u91cd\u542f\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-3-1\"><a id=\"__codelineno-3-1\" name=\"__codelineno-3-1\" href=\"#__codelineno-3-1\"></a><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">shutdown</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-2\"><a id=\"__codelineno-3-2\" name=\"__codelineno-3-2\" href=\"#__codelineno-3-2\"></a><span class=\"w\">    </span><span class=\"n\">do_shutdown</span><span class=\"p\">();</span>\n</span><span id=\"__span-3-3\"><a id=\"__codelineno-3-3\" name=\"__codelineno-3-3\" href=\"#__codelineno-3-3\"></a><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n</span><span id=\"__span-3-4\"><a id=\"__codelineno-3-4\" name=\"__codelineno-3-4\" href=\"#__codelineno-3-4\"></a><span class=\"w\">    </span><span class=\"n\">do_reboot</span><span class=\"p\">();</span>\n</span><span id=\"__span-3-5\"><a id=\"__codelineno-3-5\" name=\"__codelineno-3-5\" href=\"#__codelineno-3-5\"></a><span class=\"p\">}</span>\n</span></code></pre></div>\n<p>\u5047\u5982\u5904\u7406\u5668\u5b9e\u73b0\u4e86\u5206\u652f\u9884\u6d4b\uff0c\u9884\u6d4b <code>shutdown == true</code>\uff0c\u63a5\u7740\u9884\u6d4b\u6267\u884c\u4e86 <code>do_shutdown</code>\uff0c\u5982\u679c\u5904\u7406\u5668\u771f\u7684\u9884\u6d4b\u6267\u884c\u4e86\u5173\u673a\u64cd\u4f5c\uff0c\u90a3\u4e48\u7535\u8111\u5c31\u76f4\u63a5\u5173\u673a\u4e86\uff0c\u90fd\u6ca1\u6709\u6765\u5f97\u53ca\u786e\u8ba4\u662f\u4e0d\u662f\u8981\u5173\u673a\u3002\u4f8b\u5982\u5b9e\u9645\u4e0a\u53ef\u80fd <code>shutdown == false</code>\uff0c\u5e94\u8be5\u6267\u884c\u7684\u662f <code>do_reboot</code>\uff0c\u672c\u6765\u662f\u91cd\u542f\u7684\uff0c\u5374\u53d8\u6210\u4e86\u5173\u673a\u3002\u6240\u4ee5\u9884\u6d4b\u6267\u884c\u9047\u5230\u8fd9\u79cd\u5e26\u6709\u526f\u4f5c\u7528\uff08side effect\uff09\u7684\u6307\u4ee4\uff0c\u9700\u8981\u5355\u72ec\u5904\u7406\u3002</p>\n<p>\u4e00\u4e2a\u7b80\u5355\u7684\u529e\u6cd5\u5c31\u662f\u8981\u6c42\u6240\u6709\u5e26\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u987a\u5e8f\u6267\u884c\uff0c\u53ea\u6709\u524d\u9762\u7684\u6240\u6709\u6307\u4ee4\u6267\u884c\u5b8c\u4e86\uff0c\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u624d\u53ef\u4ee5\u6267\u884c\uff0c\u56e0\u4e3a\u6b64\u65f6\u4e0d\u53ef\u80fd\u56de\u6eda\u5230\u66f4\u65e9\u7684\u6307\u4ee4\u4e86\u3002\u4f46\u662f\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u5f88\u591a\uff0c\u901a\u5e38\u8ba4\u4e3a Store \u6307\u4ee4\u90fd\u6709\u526f\u4f5c\u7528\uff0c\u5982\u679c\u8003\u8651\u5230\u4fa7\u4fe1\u9053\u653b\u51fb\u548c\u5b89\u5168\u6027\uff0c\u53ef\u80fd\u8fde Load \u6307\u4ee4\u90fd\u6709\u526f\u4f5c\u7528\uff0c\u56e0\u4e3a\u5b83\u4f1a\u6539\u53d8 Cache \u7684\u72b6\u6001\uff1b\u5982\u679c\u8981\u8bbf\u95ee\u5916\u8bbe\uff0c\u90a3\u4e48 Load \u548c Store \u90fd\u6709\u526f\u4f5c\u7528\u3002\u5728\u4e71\u5e8f\u5904\u7406\u5668\u4e0a\uff0c\u5c31\u662f\u53ea\u5141\u8bb8\u6709\u526f\u4f5c\u7528\u7684\u6307\u4ee4\u5728 Reorder Buffer\uff08ROB\uff09\u5934\u90e8\uff0c\u624d\u53ef\u4ee5\u6267\u884c\u3002\u4f46\u5982\u679c\u9047\u5230\u4e86\u7f13\u5b58\u7f3a\u5931\uff0c\u8fd9\u4e2a\u65f6\u95f4\u5c31\u4f1a\u5f88\u957f\uff0c\u4e00\u76f4\u5835\u4f4f ROB\uff0c\u5f71\u54cd\u6027\u80fd\u3002</p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u9488\u5bf9\u5199\u5165\u5185\u5b58\u7684 Store \u6307\u4ee4\uff0c\u867d\u7136\u5b83\u6709\u526f\u4f5c\u7528\uff0c\u4f46\u901a\u5e38\u8ba4\u4e3a\u7f13\u5b58\u5199\u5165\u662f\u4e0d\u4f1a\u5931\u8d25\u7684\uff0c\u6240\u4ee5\u4e0d\u7528\u62c5\u5fc3\u5199\u5165\u5931\u8d25\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u53ef\u4ee5\u628a\u8fd9\u4e9b Store \u6307\u4ee4\u653e\u5728\u4e00\u4e2a\u961f\u5217\u91cc\u9762\uff0c\u8fd9\u4e2a\u961f\u5217\u79f0\u4e3a Store Buffer\u3002\u4ece ROB \u63d0\u4ea4\u7684 Store \u6307\u4ee4\u4f1a\u653e\u5230 Store Buffer \u91cc\u9762\uff0c\u6b64\u65f6\u53ef\u4ee5\u8ba4\u4e3a Store \u6307\u4ee4\u5b8c\u6210\u4e86\u63d0\u4ea4\uff0cStore \u6307\u4ee4\u4ece ROB \u4e2d\u5220\u9664\uff0c\u4e0d\u518d\u5835\u585e\u540e\u9762\u7684\u5176\u4ed6\u6307\u4ee4\u3002Store Buffer \u961f\u5217\u91cc\u7684 Store \u6307\u4ee4\u4f1a\u6309\u987a\u5e8f\u628a\u6570\u636e\u5199\u5165\u7f13\u5b58\uff0c\u8fd9\u65f6\u5019\u518d\u9047\u5230\u7f13\u5b58\u7f3a\u5931\uff0c\u5f71\u54cd\u4e5f\u6bd4\u8f83\u5c0f\u3002</p>\n<p>\u5f53\u7136\u4e86\uff0c\u7531\u4e8e Store Buffer \u91cc\u7684\u6570\u636e\u8fd8\u6ca1\u5199\u5165\u7f13\u5b58\uff0c\u7f13\u5b58\u91cc\u7684\u6570\u636e\u4e0d\u4e00\u5b9a\u662f\u6700\u65b0\u7684\uff0c\u6240\u4ee5\u540e\u7eed Load \u6307\u4ee4\u8bfb\u53d6\u6570\u636e\u65f6\uff0c\u4e0d\u4ec5\u8981\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\uff0c\u8fd8\u8981\u67e5\u8be2 Store Buffer\uff0c\u5982\u679c\u7f13\u5b58\u548c Store Buffer \u90fd\u6709\u6570\u636e\uff0c\u8981\u4ee5 Store Buffer \u4e3a\u51c6\u3002\u8fd9\u6837\u5b9e\u73b0\u4ee5\u540e\uff0c\u4ece\u5355\u7ebf\u7a0b\u7a0b\u5e8f\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u884c\u4e3a\u6ca1\u6709\u53d8\u5316\u3002\u4f46\u662f\u591a\u7ebf\u7a0b\u7a0b\u5e8f\u5c31\u9047\u5230\u4e86\u4e00\u4e2a\u65b0\u95ee\u9898\uff1a</p>\n<ul>\n<li>A \u6838\u5fc3\u5411 x \u5730\u5740\u5199\u5165 1\uff0c\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e</li>\n<li>B \u6838\u5fc3\u5411 y \u5730\u5740\u5199\u5165 1\uff0c\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e</li>\n<li>A \u6838\u5fc3\u4ece y \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u56e0\u4e3a A \u6ca1\u6709\u5199\u5165 y \u5730\u5740\uff0c\u6240\u4ee5 A \u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6 y \u5730\u5740\u7684\u6570\u636e\uff1b\u540c\u65f6 B \u6838\u5fc3\u4ece x \u5730\u5740\u8bfb\u53d6\u6570\u636e\uff0c\u540c\u7406 B \u4e5f\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6 x \u5730\u5740\u7684\u6570\u636e</li>\n<li>\u4e24\u4e2a\u6838\u5fc3\u5199\u5165\u6570\u636e\u7684\u6307\u4ee4\u8fdb\u5165\u4e86\u5404\u81ea\u6838\u5fc3\u7684 Store Buffer\uff0c\u4f46\u662f\u8fd8\u6ca1\u5199\u5165\u7f13\u5b58\uff1b\u56e0\u6b64 A \u548c B \u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\u7684\u6570\u636e\u90fd\u662f 0</li>\n</ul>\n<p>\u7528\u7a0b\u5e8f\u6765\u8868\u8fbe\uff0c\u5c31\u662f\uff1a</p>\n<p>A \u6838\u5fc3\uff1a</p>\n<ul>\n<li>Wx1: *x = 1</li>\n<li>Ry0: r1 = *y</li>\n</ul>\n<p>B \u6838\u5fc3\uff1a</p>\n<ul>\n<li>Wy1: *y = 1</li>\n<li>Rx0: r2 = *x</li>\n</ul>\n<p>\u4f60\u53ef\u80fd\u4f1a\u60f3\uff0c\u8fd9\u600e\u4e48\u53ef\u80fd\uff1f\u660e\u660e\u4e24\u8fb9\u90fd\u662f\u5148\u5199\u540e\u8bfb\uff0c\u600e\u4e48\u7ed3\u679c\u5374\u597d\u50cf\u662f\u5148\u8bfb\u540e\u5199\uff1f\u5982\u679c\u6211\u4eec\u7ee7\u7eed\u6309\u7167 SC \u6a21\u578b\u7684\u89c4\u5b9a\u6765\u5bfb\u627e\u987a\u5e8f\u5173\u7cfb\uff1a</p>\n<ul>\n<li>program order: Wx1 -&gt; Ry0, Wy1 -&gt; Rx0</li>\n<li>coherence\uff1aRy0 -&gt; Wy1\uff0cRx0 -&gt; Wx1</li>\n</ul>\n<p>\u51fa\u73b0\u4e86\u73af\uff1aWx1 -&gt; Ry0 -&gt; Wy1 -&gt; Rx0 -&gt; Wx1\uff0c\u8bf4\u660e\u8fd9\u4e2a\u7ed3\u679c\u5728 SC \u6a21\u578b\u4e0b\u4e0d\u53ef\u80fd\u6210\u7acb\u3002\u4f46\u5982\u679c\u6211\u4eec\u5728 x86 \u673a\u5668\u4e0a\u771f\u7684\u8dd1\u4e00\u4e0b\u8fd9\u4e2a\u6d4b\u8bd5\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-4-1\"><a id=\"__codelineno-4-1\" name=\"__codelineno-4-1\" href=\"#__codelineno-4-1\"></a>diycross7<span class=\"w\"> </span>-arch<span class=\"w\"> </span>X86<span class=\"w\"> </span>-name<span class=\"w\"> </span>SB-X86<span class=\"w\"> </span>PodWR<span class=\"w\"> </span>Fre<span class=\"w\"> </span>PodWR<span class=\"w\"> </span>Fre\n</span><span id=\"__span-4-2\"><a id=\"__codelineno-4-2\" name=\"__codelineno-4-2\" href=\"#__codelineno-4-2\"></a>litmus7<span class=\"w\"> </span>SB-X86.litmus\n</span></code></pre></div>\n<p>\u8fd9\u91cc\u7684 <code>PodWR Fre PodWR Fre</code> \u662f\u8fd9\u4e48\u6765\u7684\uff1a</p>\n<ul>\n<li>Wx1 -&gt; Ry0: PodWR, program order, write to read</li>\n<li>Ry0 -&gt; Wy1: Fre, from-read, external</li>\n<li>Wy1 -&gt; Rx0: PodWR, program order, write to read</li>\n<li>Rx0 -&gt; Wx1: Fre, from-read, external</li>\n</ul>\n<p>diycross7 \u547d\u4ee4\u751f\u6210\u4e86\u4e0b\u9762\u7684\u6c47\u7f16\uff1a</p>\n<div class=\"language-asm highlight\"><pre><span></span><code><span id=\"__span-5-1\"><a id=\"__codelineno-5-1\" name=\"__codelineno-5-1\" href=\"#__codelineno-5-1\"></a><span class=\"w\"> </span><span class=\"nf\">P0</span><span class=\"w\">          </span><span class=\"err\">|</span><span class=\"w\"> </span><span class=\"no\">P1</span><span class=\"w\">          </span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-2\"><a id=\"__codelineno-5-2\" name=\"__codelineno-5-2\" href=\"#__codelineno-5-2\"></a><span class=\"w\"> </span><span class=\"nf\">MOV</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">x</span><span class=\"p\">],</span><span class=\"no\">$1</span><span class=\"w\">  </span><span class=\"err\">|</span><span class=\"w\"> </span><span class=\"no\">MOV</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"no\">y</span><span class=\"p\">],</span><span class=\"no\">$1</span><span class=\"w\">  </span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-3\"><a id=\"__codelineno-5-3\" name=\"__codelineno-5-3\" href=\"#__codelineno-5-3\"></a><span class=\"w\"> </span><span class=\"nf\">MOV</span><span class=\"w\"> </span><span class=\"no\">EAX</span><span class=\"p\">,[</span><span class=\"no\">y</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"err\">|</span><span class=\"w\"> </span><span class=\"no\">MOV</span><span class=\"w\"> </span><span class=\"no\">EAX</span><span class=\"p\">,[</span><span class=\"no\">x</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"c1\">;</span>\n</span><span id=\"__span-5-4\"><a id=\"__codelineno-5-4\" name=\"__codelineno-5-4\" href=\"#__codelineno-5-4\"></a><span class=\"nf\">exists</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"no\">EAX</span><span class=\"err\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">/\\</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"no\">EAX</span><span class=\"err\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</span></code></pre></div>\n<p>\u8fd0\u884c litmus7 \u5f97\u5230\u5982\u4e0b\u7684\u7ed3\u679c\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-6-1\"><a id=\"__codelineno-6-1\" name=\"__codelineno-6-1\" href=\"#__codelineno-6-1\"></a>Histogram (4 states)\n</span><span id=\"__span-6-2\"><a id=\"__codelineno-6-2\" name=\"__codelineno-6-2\" href=\"#__codelineno-6-2\"></a>540   *&gt;0:EAX=0; 1:EAX=0;\n</span><span id=\"__span-6-3\"><a id=\"__codelineno-6-3\" name=\"__codelineno-6-3\" href=\"#__codelineno-6-3\"></a>499697:&gt;0:EAX=1; 1:EAX=0;\n</span><span id=\"__span-6-4\"><a id=\"__codelineno-6-4\" name=\"__codelineno-6-4\" href=\"#__codelineno-6-4\"></a>499760:&gt;0:EAX=0; 1:EAX=1;\n</span><span id=\"__span-6-5\"><a id=\"__codelineno-6-5\" name=\"__codelineno-6-5\" href=\"#__codelineno-6-5\"></a>3     :&gt;0:EAX=1; 1:EAX=1;\n</span><span id=\"__span-6-6\"><a id=\"__codelineno-6-6\" name=\"__codelineno-6-6\" href=\"#__codelineno-6-6\"></a>Ok\n</span></code></pre></div>\n<p>\u4f60\u4f1a\u53d1\u73b0\u5728 x86 \u673a\u5668\u4e0a\u771f\u7684\u51fa\u73b0\u4e86\u8fd9\u4e2a\u7ed3\u679c\uff1a\u4ece x \u548c y \u8bfb\u51fa\u6765\u7684\u6570\u636e\u90fd\u662f 0\u3002\u8fd9\u5c31\u8bf4\u660e x86 \u673a\u5668\u5b9e\u73b0\u7684\u5e76\u4e0d\u662f SC \u7684\u5185\u5b58\u6a21\u578b\u3002\u5728 SC \u6a21\u578b\u4e0b\uff0c\u8fd9\u6bb5\u4ee3\u7801\u7684\u56db\u4e2a\u987a\u5e8f\u5173\u7cfb\u6210\u73af\uff0c\u4f7f\u5f97\u4e0d\u5b58\u5728 x \u548c y \u8bfb\u51fa\u6765\u90fd\u4e3a 0 \u7684\u60c5\u51b5\uff1b\u73b0\u5728\u786e\u5b9e\u89c2\u5bdf\u5230\u4e86\u8bfb\u51fa\u6765 x \u548c y \u90fd\u4e3a 0 \u7684\u60c5\u51b5\uff0c\u8bf4\u660e\u8fd9\u4e2a\u73af\u88ab\u65ad\u5f00\u4e86\uff0c\u6709\u7684\u8fb9\u4e0d\u518d\u6210\u7acb\u3002</p>\n<p>\u56de\u60f3\u524d\u9762\u63d0\u5230\u7684 Store Buffer \u7684\u786c\u4ef6\u5b9e\u73b0\uff0c\u95ee\u9898\u51fa\u73b0\u5728\uff0cx \u548c y \u5904\u4e8e\u4e0d\u540c\u7684\u5730\u5740\uff0cA \u6838\u5fc3\u8bfb\u53d6 y \u65f6\uff0c\u76f4\u63a5\u901a\u8fc7\u7f13\u5b58\u8bfb\u53d6\u6570\u636e\uff0c\u6b64\u65f6\u4ece\u7f13\u5b58\u7684\u89c6\u89d2\u6765\u770b\uff0c\u5148\u770b\u5230\u4e86 A \u6838\u5fc3\u8bfb\u53d6 y\uff0c\u540e\u770b\u5230\u4e86 A \u6838\u5fc3\u5199\u5165\u4e86 x\uff0c\u8fd9\u548c\u6307\u4ee4\u7684\u987a\u5e8f\u4e0d\u540c\u3002\u4e5f\u5c31\u662f PodWR\uff08Program order write to read\uff09\u8fd9\u6761\u8fb9\u4e0d\u518d\u6210\u7acb\u4e86\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4ece\u6838\u5916\u7684\u89c6\u89d2\u770b\uff0c\u7a0b\u5e8f\u7684\u5148 Store \u540e Load\uff0c\u53ef\u80fd\u88ab\u91cd\u6392\u4e3a\u5148 Load \u540e Store\u3002\u8fd9\u4e5f\u8bf4\u660e x86 \u7684\u5904\u7406\u5668\u505a\u4e86 Store Buffer \u7684\u786c\u4ef6\u5b9e\u73b0\u3002\u5728\u4f18\u5316\u6027\u80fd\u7684\u540c\u65f6\uff0c\u4e5f\u5207\u5b9e\u6539\u53d8\u4e86\u5185\u5b58\u6a21\u578b\u3002</p>\n<h3 id=\"x86-tso\">X86-TSO<a class=\"headerlink\" href=\"#x86-tso\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4f9d\u6258 Store Buffer\uff0c\u6211\u4eec\u53ef\u4ee5\u6784\u5efa\u51fa\u4e00\u4e2a\u65b0\u7684\u5185\u5b58\u6a21\u578b\uff1a\u5728\u6bcf\u4e2a\u6838\u5fc3\u548c\u5185\u5b58\u5b50\u7cfb\u7edf\u4e4b\u95f4\uff0c\u591a\u4e86\u4e00\u4e2a Store Buffer\uff0cStore \u6307\u4ee4\u4f1a\u5148\u8fdb\u5165 Store Buffer\uff0c\u518d\u8fdb\u5165\u5185\u5b58\u5b50\u7cfb\u7edf\u3002\u5f53 Load \u6307\u4ee4\u548c Store Buffer \u4e2d\u7684 Store \u6307\u4ee4\u6709\u6570\u636e\u76f8\u5173\u65f6\uff0c\u4f1a\u4ece Store Buffer \u4e2d\u53d6\u6570\u636e\uff0c\u5982\u679c\u4e0d\u76f8\u5173\uff0c\u6216\u8005\u4e0d\u5b8c\u5168\u76f8\u5173\uff08\u4f8b\u5982\u53ea\u6709\u4e00\u90e8\u5206\u91cd\u5408\uff09\uff0c\u5219\u4f1a\u4ece\u5185\u5b58\u5b50\u7cfb\u7edf\u4e2d\u53d6\u6570\u636e\uff0c\u6b64\u65f6\u4ece\u5185\u5b58\u5b50\u7cfb\u7edf\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5c31\u53d1\u751f\u4e86 Load \u63d0\u524d\u4e8e Store \u6267\u884c\u7684\u91cd\u6392\u3002\u8fd9\u4e2a\u6a21\u578b\u88ab\u79f0\u4e3a <a href=\"https://dl.acm.org/doi/10.1145/1785414.1785443\">X86-TSO</a>\uff08\u56fe\u6e90 <a href=\"https://link.springer.com/book/10.1007/978-3-031-01764-3\">A Primer on Memory Consistency and Cache Coherence, Second Edition</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_x86_tso.png\" /></p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cX86-TSO \u6a21\u578b\u662f\u5728 <a href=\"https://dl.acm.org/doi/10.1145/1785414.1785443\">2010 \u5e74\u7684\u8bba\u6587 x86-TSO: a rigorous and usable programmer's model for x86 multiprocessors</a>\u4e2d\u7531\u5b66\u672f\u754c\u5bf9\u73b0\u6709 x86 \u5904\u7406\u5668\u7684\u5185\u5b58\u6a21\u578b\u7684\u603b\u7ed3\uff0c\u4f46 Intel \u548c AMD \u5728\u4ed6\u4eec\u7684\u6587\u6863\u4e2d\u6ca1\u6709\u76f4\u63a5\u91c7\u7528\u8fd9\u4e2a\u6a21\u578b\uff0c\u800c\u662f\u7ed9\u51fa\u4e86\u5404\u79cd\u5404\u6837\u7684\u89c4\u5219\u3002\u4f46\u5b9e\u8df5\u4e2d\uff0c\u53ef\u4ee5\u8ba4\u4e3a x86 \u5904\u7406\u5668\u7528\u7684\u5c31\u662f\u8fd9\u4e2a\u6a21\u578b\uff0c\u4ece\u5404\u81ea litmus \u6d4b\u8bd5\u4e2d\uff0c\u4e5f\u6ca1\u6709\u53d1\u73b0\u7406\u8bba\u548c\u5b9e\u9645\u4e0d\u4e00\u81f4\u7684\u5730\u65b9\u3002</p>\n<p>\u8fd9\u91cc\u7684 TSO \u7684\u5168\u79f0\u662f Total Store Order\uff0c\u610f\u601d\u662f\u9488\u5bf9 Store \u6307\u4ee4\uff08\u53ea\u6709\u79bb\u5f00 Store Buffer \u8fdb\u5165\u7f13\u5b58\u7684\u624d\u7b97\uff09\uff0c\u6709\u4e00\u4e2a\u5168\u5c40\u7684\u987a\u5e8f\u3002\u5185\u5b58\u5b50\u7cfb\u7edf\u4f1a\u5904\u7406\u6765\u81ea\u4e0d\u540c\u6838\u5fc3\u7684 Store\uff0c\u4f46\u4f1a\u4fdd\u8bc1 Store \u6709\u4e00\u4e2a\u5148\u540e\u987a\u5e8f\uff0c\u5e76\u4e14\u6240\u6709\u6838\u5fc3\u4f1a\u770b\u5230\u540c\u4e00\u4e2a\u987a\u5e8f\u3002\u8fd9\u4e2a\u6982\u5ff5\u6709\u4e9b\u65f6\u5019\u8fd8\u4f1a\u88ab\u79f0\u4e3a Multi-copy Atomic\uff0c\u5b57\u9762\u610f\u601d\u662f\u5f53\u4e00\u4e2a Store \u88ab\u5176\u4ed6\u6838\u5fc3\u770b\u5230\u65f6\uff0c\u6240\u6709\u6838\u5fc3\u90fd\u4f1a\u201c\u540c\u65f6\u201d\u770b\u5230\uff0c\u4e0d\u4f1a\u8bf4\u4e00\u90e8\u5206\u6838\u5148\u770b\u5230\uff0c\u53e6\u4e00\u90e8\u5206\u6838\u540e\u770b\u5230\u3002</p>\n<p>\u4ece TSO \u7684\u5b57\u9762\u610f\u601d\u6765\u8bf4\uff0c\u5e76\u6ca1\u6709\u63d0\u5230 Load \u53ef\u4ee5\u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff0c\u662f X86 \u7684 TSO \u5b9e\u73b0\u4e86\u8fd9\u79cd\u91cd\u6392\u3002\u4e0d\u8fc7\u5e73\u5e38\u4e5f\u4e0d\u4f1a\u4e13\u95e8\u53bb\u533a\u5206\u8fd9\u4ef6\u4e8b\u60c5\uff0c\u63d0\u5230 TSO\uff0c\u5927\u5bb6\u60f3\u5230\u7684\u90fd\u662f X86 \u7684 TSO\uff0c\u4e5f\u5c31\u662f X86-TSO \u6a21\u578b\u3002</p>\n<p>\u603b\u7ed3\u4e00\u4e0b\uff0cX86-TSO \u6a21\u578b\u7684\u89c4\u5b9a\u5c31\u662f\u5982\u4e0b\u51e0\u70b9\uff1a</p>\n<ul>\n<li>Total Store Order\uff1a\u6240\u6709\u6838\u5fc3\u4f1a\u89c2\u5bdf\u5230\u76f8\u540c\u7684\u5168\u5c40\u7684 Store \u987a\u5e8f</li>\n<li>Load \u53ef\u4ee5\u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d</li>\n<li>Load \u4f1a\u4ece Store Buffer \u548c\u7f13\u5b58\u4e24\u4e2a\u5730\u65b9\u53d6\u6570\u636e</li>\n</ul>\n<p>\u5bf9\u6bd4 SC \u548c X86-TSO \u6a21\u578b\uff1a</p>\n<ul>\n<li>X86-TSO \u6a21\u578b\u5141\u8bb8 Load \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d</li>\n<li>Store Buffer \u6d4b\u8bd5\u4e0b\uff0cSC \u7981\u6b62\u91cd\u6392\uff0cX86-TSO \u5141\u8bb8\u91cd\u6392</li>\n<li>Message Passing \u6d4b\u8bd5\u4e0b\uff0cSC \u548c X86-TSO \u90fd\u7981\u6b62\u91cd\u6392</li>\n</ul>\n<h3 id=\"weakrelaxed-memory-model\">Weak/Relaxed Memory Model<a class=\"headerlink\" href=\"#weakrelaxed-memory-model\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5728 X86 \u4ee5\u5916\u7684\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u7ecf\u5e38\u53ef\u4ee5\u770b\u5230\u53e6\u5916\u4e00\u79cd\u5185\u5b58\u6a21\u578b\uff0c\u4e00\u822c\u79f0\u4e3a Weak Memory Model \u6216\u8005 Relaxed Memory Model\u3002\u600e\u4e48\u4e2a Weak \u6cd5\u5462\uff1f\u5c31\u662f\u786c\u4ef6\u60f3\u91cd\u6392\u5c31\u91cd\u6392\uff0c\u5f53\u7136\u4e86\uff0c\u662f\u5728\u4fdd\u8bc1\u6838\u5185\u89c6\u89d2\u6b63\u786e\u7684\u524d\u63d0\u4e0b\u3002\u56de\u60f3\u524d\u9762 SC \u6a21\u578b\u548c X86-TSO \u6a21\u578b\uff0c\u5b83\u4eec\u5bf9\u4e8e Load \u548c Store \u4e4b\u95f4\u91cd\u6392\u7684\u8981\u6c42\u662f\uff1a</p>\n<ul>\n<li>\u5148 Load \u540e Load\uff1aSC \u548c X86-TSO \u4e0d\u5141\u8bb8\u91cd\u6392</li>\n<li>\u5148 Load \u540e Store\uff1aSC \u548c X86-TSO \u4e0d\u5141\u8bb8\u91cd\u6392</li>\n<li>\u5148 Store \u540e Load\uff1aSC \u4e0d\u5141\u8bb8\u91cd\u6392\uff0cX86-TSO \u5141\u8bb8\u91cd\u6392</li>\n<li>\u5148 Store \u540e Store\uff1aSC \u548c X86-TSO \u4e0d\u5141\u8bb8\u91cd\u6392</li>\n</ul>\n<p>\u65e2\u7136 Weak \u4e86\uff0c\u90a3\u5c31\u81ea\u7531\u5230\u5e95\uff1a\u5168\u90fd\u5141\u8bb8\u91cd\u6392\u3002\u5982\u679c\u7528\u6237\u4e0d\u60f3\u91cd\u6392\uff0c\u90a3\u518d\u52a0\u5408\u9002\u7684 fence \u6216 barrier \u6307\u4ee4\uff0c\u963b\u6b62\u4e0d\u60f3\u8981\u7684\u91cd\u6392\u3002\u5728\u8fd9\u4e2a\u5185\u5b58\u6a21\u578b\u4e0b\uff0c\u6bcf\u4e2a\u6838\u5fc3\u53ef\u4ee5\u5728\u5411\u5185\u5b58\u5b50\u7cfb\u7edf\u8bfb\u5199\u524d\uff0c\u5bf9\u81ea\u5df1\u7684\u8bfb\u5199\u8fdb\u884c\u91cd\u6392\uff08\u56fe\u6e90 <a href=\"https://link.springer.com/book/10.1007/978-3-031-01764-3\">A Primer on Memory Consistency and Cache Coherence, Second Edition</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_weak.png\" /></p>\n<p>\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\u5462\uff1f\u524d\u9762\u51fa\u73b0\u8fc7 Message Passing \u7684\u4f8b\u5b50\uff0c\u7ed3\u8bba\u662f MP \u6d4b\u8bd5\u7684\u60c5\u51b5\u5728 SC \u548c X86-TSO \u573a\u666f\u4e0b\u90fd\u88ab\u7981\u6b62\u3002\u4f46\u5982\u679c\u6211\u4eec\u5728\u4e00\u4e2a\u5177\u6709 Weak Memory Model \u7684\u673a\u5668\u4e0a\u8fd0\u884c\uff1a</p>\n<div class=\"language-shell highlight\"><pre><span></span><code><span id=\"__span-7-1\"><a id=\"__codelineno-7-1\" name=\"__codelineno-7-1\" href=\"#__codelineno-7-1\"></a><span class=\"c1\"># P0:</span>\n</span><span id=\"__span-7-2\"><a id=\"__codelineno-7-2\" name=\"__codelineno-7-2\" href=\"#__codelineno-7-2\"></a><span class=\"c1\"># 1. Wx1</span>\n</span><span id=\"__span-7-3\"><a id=\"__codelineno-7-3\" name=\"__codelineno-7-3\" href=\"#__codelineno-7-3\"></a><span class=\"c1\"># 2. Wy1</span>\n</span><span id=\"__span-7-4\"><a id=\"__codelineno-7-4\" name=\"__codelineno-7-4\" href=\"#__codelineno-7-4\"></a><span class=\"c1\"># P1:</span>\n</span><span id=\"__span-7-5\"><a id=\"__codelineno-7-5\" name=\"__codelineno-7-5\" href=\"#__codelineno-7-5\"></a><span class=\"c1\"># 1. Ry1</span>\n</span><span id=\"__span-7-6\"><a id=\"__codelineno-7-6\" name=\"__codelineno-7-6\" href=\"#__codelineno-7-6\"></a><span class=\"c1\"># 2. Rx0</span>\n</span><span id=\"__span-7-7\"><a id=\"__codelineno-7-7\" name=\"__codelineno-7-7\" href=\"#__codelineno-7-7\"></a><span class=\"c1\"># orders:</span>\n</span><span id=\"__span-7-8\"><a id=\"__codelineno-7-8\" name=\"__codelineno-7-8\" href=\"#__codelineno-7-8\"></a><span class=\"c1\"># Wx1 -&gt; Wy1: PodWW</span>\n</span><span id=\"__span-7-9\"><a id=\"__codelineno-7-9\" name=\"__codelineno-7-9\" href=\"#__codelineno-7-9\"></a><span class=\"c1\"># Wy1 -&gt; Ry1: Rfe</span>\n</span><span id=\"__span-7-10\"><a id=\"__codelineno-7-10\" name=\"__codelineno-7-10\" href=\"#__codelineno-7-10\"></a><span class=\"c1\"># Ry1 -&gt; Rx0: PodRR</span>\n</span><span id=\"__span-7-11\"><a id=\"__codelineno-7-11\" name=\"__codelineno-7-11\" href=\"#__codelineno-7-11\"></a><span class=\"c1\"># Rx0 -&gt; Wx1: Fre</span>\n</span><span id=\"__span-7-12\"><a id=\"__codelineno-7-12\" name=\"__codelineno-7-12\" href=\"#__codelineno-7-12\"></a>diycross7<span class=\"w\"> </span>-arch<span class=\"w\"> </span>AArch64<span class=\"w\"> </span>-name<span class=\"w\"> </span>MP-AArch64<span class=\"w\"> </span>PodWW<span class=\"w\"> </span>Rfe<span class=\"w\"> </span>PodRR<span class=\"w\"> </span>Fre\n</span><span id=\"__span-7-13\"><a id=\"__codelineno-7-13\" name=\"__codelineno-7-13\" href=\"#__codelineno-7-13\"></a>litmus7<span class=\"w\"> </span>MP-AArch64.litmus<span class=\"w\"> </span><span class=\"c1\"># MP = Message Passing</span>\n</span></code></pre></div>\n<p>\u4f1a\u53d1\u73b0\u867d\u7136\u6982\u7387\u6bd4\u8f83\u4f4e\uff0c\u4f46\u786e\u5b9e\u4f1a\u51fa\u73b0 y=1\uff0cx=0 \u7684\u60c5\u51b5\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-8-1\"><a id=\"__codelineno-8-1\" name=\"__codelineno-8-1\" href=\"#__codelineno-8-1\"></a>Histogram (4 states)\n</span><span id=\"__span-8-2\"><a id=\"__codelineno-8-2\" name=\"__codelineno-8-2\" href=\"#__codelineno-8-2\"></a>500000:&gt;1:X1=0; 1:X3=0;\n</span><span id=\"__span-8-3\"><a id=\"__codelineno-8-3\" name=\"__codelineno-8-3\" href=\"#__codelineno-8-3\"></a>1     *&gt;1:X1=1; 1:X3=0;\n</span><span id=\"__span-8-4\"><a id=\"__codelineno-8-4\" name=\"__codelineno-8-4\" href=\"#__codelineno-8-4\"></a>1     :&gt;1:X1=0; 1:X3=1;\n</span><span id=\"__span-8-5\"><a id=\"__codelineno-8-5\" name=\"__codelineno-8-5\" href=\"#__codelineno-8-5\"></a>499998:&gt;1:X1=1; 1:X3=1;\n</span></code></pre></div>\n<p>\u65e2\u7136\u5728\u5b9e\u9645\u7684 ARM \u673a\u5668\u4e0a\u6d4b\u51fa\u6765\u8fd9\u79cd\u60c5\u51b5\uff0c\u8bf4\u660e PodWW \u6216\u8005 PodRR \u81f3\u5c11\u6709\u4e00\u4e2a\u51fa\u73b0\u4e86\u91cd\u6392\uff0c\u6253\u7834\u4e86\u73af\u3002</p>\n<p>\u66f4\u8fdb\u4e00\u6b65\uff0cSC \u548c X86-TSO \u90fd\u8981\u6c42\u6709 Total Store Order\uff08Multi-copy Atomic\uff09\uff1a\u6240\u6709\u6838\u5fc3\u4f1a\u770b\u5230\u7edf\u4e00\u7684 Store \u987a\u5e8f\u3002\u6709\u8981\u6c42\uff0c\u5c31\u53ef\u4ee5\u820d\u5f03\uff0c\u90e8\u5206 Weak Memory Model \u4e5f\u4e0d\u8981\u6c42\u8fd9\u4e00\u70b9\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c\u5185\u5b58\u6a21\u578b\u5c31\u597d\u50cf\u6bcf\u4e2a\u6838\u5fc3\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u4efd\u5185\u5b58\uff0c\u8fd9\u4e9b\u5185\u5b58\u4e4b\u95f4\u4f1a\u4e92\u76f8\u4f20\u64ad Store \u4ee5\u4fdd\u8bc1\u7f13\u5b58\u4e00\u81f4\u6027\uff0c\u4f46\u662f\u6709\u7684\u6838\u5fc3\u53ef\u80fd\u5148\u770b\u5230\uff0c\u6709\u7684\u6838\u5fc3\u53ef\u80fd\u540e\u770b\u5230\uff08\u56fe\u6e90 <a href=\"https://www.cl.cam.ac.uk/~pes20/ppc-supplemental/test7.pdf\">A Tutorial Introduction to the ARM and POWER Relaxed Memory Model</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_weak_2.png\" /></p>\n<p>\u8fd9\u4e00\u70b9\u53ef\u4ee5\u5728 IRIW\uff08\u5168\u79f0 Independent Read of Independent Write\uff1b\u51c6\u786e\u5730\u8bf4\uff0c\u4e3a\u4e86\u6392\u9664 PodRR \u91cd\u6392\u7684\u60c5\u51b5\uff0c\u8981\u7528 IRIW+addrs \u6216\u8005\u52a0 barrier\uff09Litmus \u6d4b\u8bd5\u4e2d\u770b\u5230\u3002\u7b80\u5355\u6765\u8bf4\uff0cIRIW \u6d4b\u8bd5\u4e2d\uff0c\u6709\u4e24\u4e2a\u6838\u5fc3\u8d1f\u8d23\u5199\u5165\uff0c\u53e6\u5916\u4e24\u4e2a\u6838\u5fc3\u8d1f\u8d23\u8bfb\uff0c\u5982\u679c\u8fd9\u4e24\u4e2a\u8d1f\u8d23\u8bfb\u7684\u6838\u5fc3\u89c2\u5bdf\u5230\u4e86\u4e0d\u540c\u7684\u5199\u5165\u987a\u5e8f\uff0c\u8bf4\u660e\u6ca1\u6709 Total Store Order\uff08Multi-copy Atomic\uff09\uff1a\u5199\u5165\u4f20\u64ad\u5230\u4e0d\u540c\u6838\u5fc3\u7684\u987a\u5e8f\u53ef\u80fd\u6253\u4e71\u3002</p>\n<h2 id=\"\u5185\u5b58\u5e8f\">\u5185\u5b58\u5e8f<a class=\"headerlink\" href=\"#\u5185\u5b58\u5e8f\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u6307\u4ee4\u96c6\">\u6307\u4ee4\u96c6<a class=\"headerlink\" href=\"#\u6307\u4ee4\u96c6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u65e2\u7136 X86-TSO \u5df2\u7ecf\u51fa\u73b0\u4e86\u4e00\u79cd\u53ef\u80fd\u7684\u91cd\u6392\u60c5\u51b5\uff1aLoad \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff0c\u5047\u5982\u6211\u4eec\u4e0d\u5e0c\u671b\u51fa\u73b0\u8fd9\u79cd\u91cd\u6392\uff0c\u600e\u4e48\u529e\uff1f\u5404\u4e2a\u6307\u4ee4\u96c6\u90fd\u63d0\u4f9b\u4e86\u4e00\u4e9b fence \u6216\u8005 barrier \u6307\u4ee4\uff0c\u53ef\u4ee5\u963b\u6b62\u5404\u79cd\u7c7b\u578b\u7684\u91cd\u6392\u3002\u4ee5 x86 \u4e3a\u4f8b\uff1a</p>\n<ul>\n<li>sfence: store fence\uff0c\u4fdd\u8bc1 sfence \u4e4b\u524d\u7684 store \u90fd\u5b8c\u6210\uff08globally visible\uff0c\u5f97\u5199\u5230\u7f13\u5b58\u91cc\u624d\u7b97\uff09\u4e4b\u540e\uff0c\u624d\u5f00\u59cb sfence \u4e4b\u540e\u7684 store</li>\n<li>lfence: load fence\uff0c\u4fdd\u8bc1 lfence \u4e4b\u524d\u7684 load \u90fd\u5b8c\u6210\uff08globally visible\uff09\u4e4b\u540e\uff0c\u624d\u5f00\u59cb lfence \u4e4b\u540e\u7684 load</li>\n<li>mfence: memory fence, \u4fdd\u8bc1 mfence \u4e4b\u524d\u7684 load \u548c store \u90fd\u5b8c\u6210\uff08globally visible\uff09\u4e4b\u540e\uff0c\u624d\u5f00\u59cb mfence \u4e4b\u540e\u7684 load \u548c store</li>\n</ul>\n<p>\u8fd9\u5176\u4e2d\u5e38\u7528\u7684\u5176\u5b9e\u5c31\u662f mfence\uff1a\u524d\u9762\u63d0\u5230 X86-TSO \u5141\u8bb8 Load \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff0c\u4e3a\u4e86\u963b\u6b62\u8fd9\u4e00\u70b9\uff0clfence \u548c sfence \u90fd\u4e0d\u591f\uff0c\u56e0\u4e3a lfence \u7ba1\u7684\u662f Load \u88ab\u91cd\u6392\u5230 Load \u4e4b\u524d\uff0csfence \u7ba1\u7684\u662f Store \u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\u3002mfence \u5219\u53ef\u4ee5\uff1a\u5728 Store \u540e\u9762\u7d27\u6328\u7740\u4e00\u6761 mfence \u6307\u4ee4\uff0c\u90a3\u4e48 mfence \u4e4b\u540e\u7684 Load \u6307\u4ee4\u5c31\u65e0\u6cd5\u88ab\u91cd\u6392\u5230 Store \u4e4b\u524d\uff1a</p>\n<ol>\n<li>store</li>\n<li>mfence</li>\n<li>load</li>\n</ol>\n<p>\u6240\u4ee5\u5982\u679c\u8981\u5728 x86 \u4e0a\u8fd0\u884c\u6309\u7167 SC \u5185\u5b58\u6a21\u578b\u7f16\u5199\u7684\u7a0b\u5e8f\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6b63\u786e\u6027\uff0c\u9700\u8981\u5728\u6bcf\u4e2a Store \u540e\u9762\u52a0\u4e00\u6761 mfence \u6307\u4ee4\u3002</p>\n<p>\u518d\u6765\u770b\u770b\u5bf9\u4e8e ARMv8 \u8fd9\u79cd\u5177\u6709 Weak/Relaxed Memory Model \u7684\u67b6\u6784\uff0c\u6307\u4ee4\u96c6\u63d0\u4f9b\u4e86\u54ea\u4e9b\u6307\u4ee4\u6765\u907f\u514d\u91cd\u6392\uff1a</p>\n<ul>\n<li>DMB\uff1a\u76f8\u5f53\u4e8e x86 \u7684 mfence\uff0c\u4fdd\u8bc1 DMB \u540e\u7684 Load \u548c Store \u4e0d\u4f1a\u91cd\u6392\u5230 DMB \u4e4b\u524d\uff0cDMB \u524d\u7684 Load \u548c Store \u4e5f\u4e0d\u4f1a\u91cd\u6392\u5230 DMB \u4e4b\u540e</li>\n<li>Load Acquire\uff1a\u5bf9 Load \u6307\u4ee4\u6dfb\u52a0 Acquire \u8bed\u4e49\uff0c\u4fdd\u8bc1 Load Acquire \u4e4b\u540e\u7684 Load/Store \u4e0d\u4f1a\u88ab\u91cd\u6392\u5230 Load  Acquire \u4e4b\u524d</li>\n<li>Store Release\uff1a\u5bf9 Release \u6307\u4ee4\u6dfb\u52a0 Release \u8bed\u4e49\uff0c\u4fdd\u8bc1 Store Release \u4e4b\u524d\u7684 Load/Store \u4e0d\u4f1a\u88ab\u91cd\u6392\u5230 Store Release \u4e4b\u540e</li>\n</ul>\n<p>\u770b\u5230 Acquire \u548c Release\uff0c\u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97\u8fd9\u4e2a\u8bf4\u6cd5\u6709\u70b9\u719f\u6089\uff1a\u5728\u9501\u91cc\u9762\uff0c\u83b7\u5f97\u9501\u53ef\u4ee5\u8bf4 Lock \u6216\u8005\u8bf4 Acquire\uff1b\u91ca\u653e\u9501\u53ef\u4ee5\u8bf4 Unlock \u6216\u8005\u8bf4 Release\u3002\u4e8b\u5b9e\u4e0a\uff0cLoad Acquire \u548c Store Release \u6b63\u597d\u5c31\u53ef\u4ee5\u7528\u5728 Lock \u548c Unlock \u7684\u573a\u5408\uff1a</p>\n<div class=\"language-c highlight\"><pre><span></span><code><span id=\"__span-9-1\"><a id=\"__codelineno-9-1\" name=\"__codelineno-9-1\" href=\"#__codelineno-9-1\"></a><span class=\"n\">lock</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// Load Acquire</span>\n</span><span id=\"__span-9-2\"><a id=\"__codelineno-9-2\" name=\"__codelineno-9-2\" href=\"#__codelineno-9-2\"></a><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n</span><span id=\"__span-9-3\"><a id=\"__codelineno-9-3\" name=\"__codelineno-9-3\" href=\"#__codelineno-9-3\"></a><span class=\"n\">unlock</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// Store Release</span>\n</span></code></pre></div>\n<p>\u5728\u4e34\u754c\u533a\u4e2d\u8bfb\u53d6 x\uff0c\u80af\u5b9a\u5e0c\u671b\u662f\u5728\u6301\u6709\u9501\u7684\u524d\u63d0\u4e0b\u8fdb\u884c Load\uff0c\u4e5f\u5c31\u662f\u8bf4 Load x \u4e0d\u80fd\u88ab\u91cd\u6392\u5230 <code>lock()</code> \u4e4b\u524d\uff0c\u4e5f\u4e0d\u80fd\u88ab\u91cd\u6392\u5230 <code>unlock()</code> \u4e4b\u540e\uff1b\u540c\u7406\u5728\u4e34\u754c\u533a\u4e2d\u5199\u5165 y\uff0c\u80af\u5b9a\u4e5f\u662f\u5e0c\u671b\u5728\u6301\u6709\u9501\u7684\u524d\u63d0\u4e0b\u8fdb\u884c Store\uff0c\u4e5f\u5c31\u662f\u8bf4 Store y \u4e0d\u80fd\u88ab\u91cd\u6392\u5230 <code>lock()</code> \u4e4b\u524d\u6216 <code>unlock()</code> \u4e4b\u540e\u3002\u4e3a\u4e86\u907f\u514d\u8fd9\u4e2a\u91cd\u6392\uff0c\u5728\u4e00\u5934\u4e00\u5c3e\u5206\u522b\u52a0\u4e0a Acquire \u548c Release \u6807\u8bb0\uff0c\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u4e34\u754c\u533a\u5185\u7684 Load/Store \u90fd\u662f\u5728\u6301\u6709\u9501\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u3002</p>\n<p>\u9664\u4e86\u9501\u4ee5\u5916\uff0c\u8fd9\u4e2a\u6a21\u5f0f\u4e5f\u53ef\u4ee5\u7528\u6765\u5b9e\u73b0\u6b63\u786e\u7684 Message Passing\uff0c\u539f\u6765\u7684 Message Passing \u5b9e\u73b0\u662f\uff1a</p>\n<p>P0:</p>\n<ol>\n<li>*x = 1</li>\n<li>*y = 1</li>\n</ol>\n<p>P1:</p>\n<ol>\n<li>r1 = *y</li>\n<li>r2 = *x</li>\n</ol>\n<p>\u8fd9\u91cc\u4f1a\u6709 Store-Store \u91cd\u6392\u4ee5\u53ca Load-Load \u91cd\u6392\u7684\u98ce\u9669\uff0c\u52a0\u4e0a Load Acquire \u548c Store Release \u4ee5\u540e\uff1a</p>\n<p>P0:</p>\n<ol>\n<li>*x = 1</li>\n<li>*y = 1 (Store Release)</li>\n</ol>\n<p>P1:</p>\n<ol>\n<li>r1 = *y (Load Acquire)</li>\n<li>r2 = *x</li>\n</ol>\n<p>\u8fd9\u6837\u5c31\u907f\u514d\u4e86\u91cd\u6392\uff0cP1 \u53ef\u4ee5\u89c2\u5bdf\u5230\u6b63\u786e\u7684\u7ed3\u679c\u3002</p>\n<p>\u6b64\u5916\uff0cAcquire \u548c Release \u6807\u8bb0\u4e5f\u53ef\u4ee5\u6dfb\u52a0\u5230\u539f\u5b50\u6307\u4ee4\u4e0a\uff0c\u6bd5\u7adf\u539f\u5b50\u6307\u4ee4\u5176\u5b9e\u5c31\u662f Load + Store\u3002\u76f8\u6bd4 Fence\uff0cAcquire \u548c Release \u662f\u5355\u5411\u7684\uff0c\u53ea\u5f71\u54cd\u524d\u9762\u7684\u6307\u4ee4\uff0c\u6216\u8005\u53ea\u5f71\u54cd\u540e\u9762\u7684\u6307\u4ee4\uff0c\u800c Fence \u901a\u5e38\u662f\u4e24\u4e2a\u65b9\u5411\u90fd\u963b\u6b62\uff0c\u4e0d\u8bb8\u524d\u9762\u7684\u6392\u5230\u540e\u9762\uff0c\u4e5f\u4e0d\u8bb8\u540e\u9762\u7684\u6392\u5230\u524d\u9762\u3002</p>\n<h3 id=\"\u8f6f\u4ef6\">\u8f6f\u4ef6<a class=\"headerlink\" href=\"#\u8f6f\u4ef6\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4ece\u4e0a\u9762\u7684\u5206\u6790\u53ef\u89c1\uff0c\u4e0d\u540c\u7684\u5904\u7406\u5668\u548c\u6307\u4ee4\u96c6\u4f7f\u7528\u4e86\u4e0d\u540c\u7684\u5185\u5b58\u6a21\u578b\uff0c\u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u6307\u4ee4\u6765\u63a7\u5236\u4e71\u5e8f\u91cd\u6392\uff0c\u4f46\u662f\u5bf9\u4e8e\u8f6f\u4ef6\u5f00\u53d1\u8005\u6765\u8bf4\uff0c\u4f1a\u5e0c\u671b\u5c3d\u91cf\u7528\u4e00\u5957\u901a\u7528\u7684 API \u6765\u63a7\u5236\u4e71\u5e8f\u91cd\u6392\uff0c\u53ef\u4ee5\u517c\u5bb9\u5404\u79cd\u6307\u4ee4\u96c6\uff0c\u4e0d\u7528\u53bb\u8bb0\u5fc6\u6bcf\u4e2a\u5904\u7406\u5668\u7528\u7684\u662f\u4ec0\u4e48\u5185\u5b58\u6a21\u578b\uff0c\u4e0d\u7528\u53bb\u77e5\u9053\u54ea\u4e9b\u6307\u4ee4\u53ef\u4ee5\u7528\u6765\u89e3\u51b3\u54ea\u4e9b\u91cd\u6392\u3002</p>\n<p>\u8fd9\u4e2a API \u5728\u5f88\u591a\u7f16\u7a0b\u8bed\u8a00\u4e2d\u90fd\u6709\uff0cC \u7684 stdatomic.h\uff0cC++ \u7684 std::memory_order\uff0cRust \u7684 std::sync::atomic::Ordering \u7b49\u7b49\u3002\u5b83\u4eec\u5bf9\u5404\u79cd\u5904\u7406\u5668\u7684\u5185\u5b58\u5e8f\u8fdb\u884c\u4e86\u8fdb\u4e00\u6b65\u7684\u62bd\u8c61\uff0c\u5e76\u4e14\u5728\u7f16\u8bd1\u7684\u65f6\u5019\uff0c\u7531\u7f16\u8bd1\u5668\u6216\u6807\u51c6\u5e93\u628a\u8fd9\u4e9b\u62bd\u8c61\u7684\u5185\u5b58\u5e8f\u7ffb\u8bd1\u6210\u5b9e\u9645\u7684\u6307\u4ee4\u3002\u4ee5 C++ \u7684\u62bd\u8c61\u4e3a\u4f8b\uff0c\u6709\u5982\u4e0b\u51e0\u79cd\u5185\u5b58\u5e8f\uff08\u56fe\u6e90 <a href=\"https://en.cppreference.com/w/cpp/atomic/memory_order\">cppreference</a>\uff09\uff1a</p>\n<p><img alt=\"\" src=\"../../../../memory_model_and_memory_ordering_order.png\" /></p>\n<p>\u5176\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684 acquire \u548c release\uff0c\u5176\u5b9e\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684 Load Acquire \u548c Store Release\u3002\u6700\u540e\u7684 seq_cst\uff0c\u5c31\u5bf9\u5e94\u4e86 Sequential Consistency\uff08SC\uff09\u6a21\u578b\uff0c\u8981\u6a21\u62df SC \u6a21\u578b\u7684\u884c\u4e3a\u3002</p>\n<p>\u7531\u4e8e C++ \u53ef\u4ee5\u88ab\u7f16\u8bd1\u5230\u4e0d\u540c\u7684\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u6240\u4ee5\u8fd9\u4e9b memory order \u5728\u7f16\u8bd1\u7684\u65f6\u5019\uff0c\u4f1a\u53d8\u6210\u5bf9\u5e94\u7684\u6307\u4ee4\uff0c\u4e5f\u53ef\u80fd\u7531\u4e8e\u5185\u5b58\u6a21\u578b\u4fdd\u8bc1\u4e86\u4e0d\u51fa\u73b0\u5bf9\u5e94\u7684\u4e71\u5e8f\uff0c\u4e0d\u9700\u8981\u751f\u6210\u989d\u5916\u7684\u6307\u4ee4\u3002\u4ee5 X86 \u4e3a\u4f8b\u5b50\uff1a</p>\n<ul>\n<li>Load Acquire\uff1a\u9632\u6b62 Load \u4e4b\u540e\u7684 Load/Store \u6307\u4ee4\u88ab\u91cd\u6392\u5230 Load \u4e4b\u524d\uff0c\u56e0\u4e3a X86-TSO \u963b\u6b62\u4e86 Load-Load \u548c Load-Store\uff08\u5148 Load \u540e Store\uff09\u91cd\u6392\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u989d\u5916\u7684\u6307\u4ee4</li>\n<li>Store Release\uff1a\u9632\u6b62 Store \u4e4b\u524d\u7684 Load/Store \u6307\u4ee4\u88ab\u91cd\u6392\u5230 Store \u4e4b\u540e\uff0c\u56e0\u4e3a X86-TSO \u963b\u6b62\u4e86 Load-Store \u548c Store-Store \u91cd\u6392\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u989d\u5916\u7684\u6307\u4ee4</li>\n</ul>\n<p>\u5b8c\u6574\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u5efa\u8bae\u9605\u8bfb <a href=\"https://www.cl.cam.ac.uk/~pes20/cpp/cpp0xmappings.html\">C/C++11 mappings to processors</a>\u3002</p>\n<p>\u7f16\u8bd1\u5668\u7684\u4f18\u5316\u53ef\u80fd\u4f1a\u5bf9\u5185\u5b58\u5e8f\u4ea7\u751f\u4e00\u4e9b\u610f\u6599\u4e4b\u5916\u7684\u5f71\u54cd\uff0c\u63a8\u8350\u9605\u8bfb Linux \u5185\u6838\u7684 <a href=\"https://www.kernel.org/doc/Documentation/memory-barriers.txt\">LINUX KERNEL MEMORY BARRIERS</a> \u6587\u6863\u3002</p>\n<h2 id=\"\u53c2\u8003\u6587\u732e\">\u53c2\u8003\u6587\u732e<a class=\"headerlink\" href=\"#\u53c2\u8003\u6587\u732e\" title=\"Permanent link\">&para;</a></h2>\n<ul>\n<li><a href=\"https://www.cl.cam.ac.uk/~pes20/ppc-supplemental/test7.pdf\">A Tutorial Introduction to the ARM and POWER Relaxed Memory Model</a></li>\n<li><a href=\"https://www.cl.cam.ac.uk/~pes20/weakmemory/x86tso-paper.tphols.pdf\">A Better x86 Memory Model: x86-TSO</a></li>\n<li><a href=\"https://research.swtch.com/hwmm\">Hardware Memory Models - Russ Cox</a></li>\n<li><a href=\"https://github.com/herd/herdtools7\">herd/herdtools7 on GitHub</a></li>\n<li><a href=\"https://link.springer.com/book/10.1007/978-3-031-01764-3\">A Primer on Memory Consistency and Cache Coherence, Second Edition</a></li>\n<li><a href=\"https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/generate-litmus-tests-automatically-diy7-tool\">How to generate litmus tests automatically with the diy7 tool</a></li>\n</ul>", "image": null, "date_modified": "2024-09-04T00:00:00+00:00", "authors": [], "tags": ["acquire", "arm64", "cpu", "hardware", "lock", "mca", "ordering", "release", "tso", "x86"]}, {"id": "https://jia.je/hardware/2024/09/01/qualcomm_oryon/", "url": "https://jia.je/hardware/2024/09/01/qualcomm_oryon/", "title": "Qualcomm Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b", "content_html": "<h1 id=\"qualcomm-oryon-\u5fae\u67b6\u6784\u8bc4\u6d4b\">Qualcomm Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b<a class=\"headerlink\" href=\"#qualcomm-oryon-\u5fae\u67b6\u6784\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h1>\n<h2 id=\"\u80cc\u666f\">\u80cc\u666f<a class=\"headerlink\" href=\"#\u80cc\u666f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u6700\u8fd1\u501f\u5230\u4e00\u53f0 Surface Laptop 7 \u53ef\u4ee5\u62ff\u6765\u6298\u817e\uff0c\u5b83\u7528\u7684\u662f\u9ad8\u901a Snapdragon X Elite \u5904\u7406\u5668\uff0c\u501f\u6b64\u673a\u4f1a\u6d4b\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u5fae\u67b6\u6784\u5728\u5404\u4e2a\u65b9\u9762\u7684\u8868\u73b0\u3002</p>\n<!-- more -->\n\n<h2 id=\"\u5b98\u65b9\u4fe1\u606f\">\u5b98\u65b9\u4fe1\u606f<a class=\"headerlink\" href=\"#\u5b98\u65b9\u4fe1\u606f\" title=\"Permanent link\">&para;</a></h2>\n<p>\u9ad8\u901a\u5173\u4e8e Oryon \u5fae\u67b6\u6784\u6709\u4e24\u4e2a slides\uff0c\u5185\u5bb9\u53ef\u4ee5\u5728\u4ee5\u4e0b\u7684\u94fe\u63a5\u4e2d\u770b\u5230\uff1a</p>\n<ul>\n<li><a href=\"https://www.anandtech.com/show/21445/qualcomm-snapdragon-x-architecture-deep-dive/2\">The Qualcomm Snapdragon X Architecture Deep Dive: Getting To Know Oryon and Adreno X1 - Anandtech</a></li>\n<li><a href=\"https://hc2024.hotchips.org/assets/program/conference/day1/25_HC2024.Qualcomm.GWilliams.pdf\">Hot Chips 2024: Qualcomm\u2019s Oryon Core</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/08/26/hot-chips-2024-qualcomms-oryon-core/\">Hot Chips 2024: Qualcomm\u2019s Oryon Core - Chips and Cheese</a></li>\n</ul>\n<p>\u4e24\u6b21\u5185\u5bb9\u5927\u4f53\u4e00\u81f4\uff0cHot Chips 2024 \u7684\u5185\u5bb9\u66f4\u52a0\u8be6\u7ec6\uff0c\u4f46\u4e5f\u51fa\u73b0\u4e86\u4e00\u4e9b\u524d\u540e\u77db\u76fe\u7684\u5730\u65b9\u3002</p>\n<h2 id=\"\u73b0\u6709\u8bc4\u6d4b\">\u73b0\u6709\u8bc4\u6d4b<a class=\"headerlink\" href=\"#\u73b0\u6709\u8bc4\u6d4b\" title=\"Permanent link\">&para;</a></h2>\n<p>\u7f51\u4e0a\u5df2\u7ecf\u6709\u8f83\u591a\u9488\u5bf9 Oryon \u5fae\u67b6\u6784\u7684\u8bc4\u6d4b\u548c\u5206\u6790\uff0c\u5efa\u8bae\u9605\u8bfb\uff1a</p>\n<ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/704707254\">\u9ad8\u901a X Elite Oryon \u5fae\u67b6\u6784\u8bc4\u6d4b\uff1a\u8d70\u8d70\u505c\u505c</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/07/09/qualcomms-oryon-core-a-long-time-in-the-making/\">Qualcomm\u2019s Oryon Core: A Long Time in the Making</a></li>\n<li><a href=\"https://chipsandcheese.com/2024/05/15/qualcomms-oryon-llvm-patches/\">Qualcomm\u2019s Oryon LLVM Patches</a></li>\n<li><a href=\"https://www.bilibili.com/video/BV1Ue41197Qb/\">\u9ad8\u901a\u81ea\u7814 PC \u82af\u7247 X Elite \u5b9e\u6d4b\uff1a\u771f\u80fd\u5e72\u7ffb\u82f9\u679c\u82f1\u7279\u5c14\uff1f</a></li>\n<li><a href=\"https://www.bilibili.com/video/BV1z1421r7dZ/\">\u592a\u8d35\u4e86\uff0c\u5b83\u6ca1\u4f60\u60f3\u7684\u90a3\u4e48\u7f8e\u597d\uff01\u9ad8\u901a\u9a81\u9f99 X Elite 78-100 \u7b14\u8bb0\u672c\u8be6\u7ec6\u8bc4\u6d4b</a></li>\n<li><a href=\"https://www.qualcomm.com/products/mobile/snapdragon/laptops-and-tablets/snapdragon-x-elite\">Snapdragon X Elite</a></li>\n<li><a href=\"https://www.qualcomm.com/products/technology/processors/oryon\">Qualcomm Oryon CPU</a></li>\n</ul>\n<p>\u4e0b\u9762\u5206\u5404\u4e2a\u6a21\u5757\u5206\u522b\u8bb0\u5f55\u5b98\u65b9\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u5b9e\u6d4b\u7684\u7ed3\u679c\u3002\u8bfb\u8005\u53ef\u4ee5\u5bf9\u7167\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u8bc4\u6d4b\u7406\u89e3\u3002\u5b98\u65b9\u4fe1\u606f\u4e0e\u5b9e\u6d4b\u7ed3\u679c\u4e00\u81f4\u7684\u6570\u636e\u4f1a\u52a0\u7c97\u3002</p>\n<h2 id=\"benchmark\">Benchmark<a class=\"headerlink\" href=\"#benchmark\" title=\"Permanent link\">&para;</a></h2>\n<p>Qualcomm Oryon \u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u89c1 <a href=\"../../../../../benchmark/\">SPEC</a>\u3002</p>\n<h2 id=\"\u73af\u5883\u51c6\u5907\">\u73af\u5883\u51c6\u5907<a class=\"headerlink\" href=\"#\u73af\u5883\u51c6\u5907\" title=\"Permanent link\">&para;</a></h2>\n<p>Surface Laptop 7 \u9884\u88c5\u7684\u662f Windows on ARM\uff0c\u5e76\u4e0d\u9002\u5408\u8fdb\u884c\u6d4b\u8bd5\u3002\u56e0\u6b64\uff0c\u6211\u5728\u5b83\u4e0a\u9762\u81ea\u5df1\u88c5\u4e86\u4e00\u4e2a\u88f8\u673a\u7684 Linux \u7cfb\u7edf\uff0c\u76ee\u524d\u7f51\u4e0a\u5df2\u7ecf\u6709\u6bd4\u8f83\u591a\u76f8\u5173\u7684\u6559\u7a0b\u4ee5\u53ca\u5b89\u88c5\u955c\u50cf\u4e86\u3002</p>\n<h2 id=\"\u524d\u7aef\">\u524d\u7aef<a class=\"headerlink\" href=\"#\u524d\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u53d6\u6307\">\u53d6\u6307<a class=\"headerlink\" href=\"#\u53d6\u6307\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a\u53d6\u6307\u53ef\u4ee5\u8fbe\u5230\u6bcf\u5468\u671f\u6700\u591a <strong>16</strong> \u6307\u4ee4</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u5b9e\u9645\u7684 Fetch \u5bbd\u5ea6\uff0c\u53c2\u8003 <a href=\"https://zhuanlan.zhihu.com/p/720136752\">\u5982\u4f55\u6d4b\u91cf\u771f\u6b63\u7684\u53d6\u6307\u5e26\u5bbd\uff08I-fetch width\uff09 - JamesAslan</a> \u6784\u9020\u4e86\u6d4b\u8bd5\u3002</p>\n<p>\u5176\u539f\u7406\u662f\u5f53 Fetch \u8981\u8de8\u9875\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u4e24\u4e2a\u76f8\u90bb\u9875\u53ef\u80fd\u6620\u5c04\u5230\u4e0d\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u5982\u679c\u8981\u652f\u6301\u5355\u5468\u671f\u8de8\u9875\u53d6\u6307\uff0c\u9700\u8981\u67e5\u8be2\u4e24\u6b21 ITLB\uff0c\u6216\u8005 ITLB \u9700\u8981\u628a\u76f8\u90bb\u4e24\u4e2a\u9875\u7684\u6620\u5c04\u5b58\u5728\u4e00\u8d77\u3002\u8fd9\u4e2a\u573a\u666f\u4e00\u822c\u6bd4\u8f83\u5c11\uff0c\u5904\u7406\u5668\u5f88\u5c11\u4f1a\u9488\u5bf9\u8fd9\u79cd\u7279\u6b8a\u60c5\u51b5\u505a\u4f18\u5316\uff0c\u4f46\u4e5f\u4e0d\u662f\u6ca1\u6709\u3002\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u628a\u5faa\u73af\u653e\u5728\u4e24\u4e2a\u9875\u7684\u8fb9\u754c\u4e0a\uff0c\u53d1\u73b0 Oryon \u5fae\u67b6\u6784\u9047\u5230\u8de8\u9875\u7684\u53d6\u6307\u65f6\u786e\u5b9e\u4f1a\u62c6\u6210\u4e24\u4e2a\u5468\u671f\u6765\u8fdb\u884c\u3002\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u6784\u9020\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u5728\u7b2c\u4e00\u4e2a\u9875\u7684\u6700\u540e\u56db\u4e2a\u5b57\u8282\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u4e0a\uff0c\u90a3\u4e48\u6bcf\u6b21\u5faa\u73af\u7684\u53d6\u6307\u65f6\u95f4\uff0c\u5c31\u662f\u4e00\u4e2a\u5468\u671f\uff08\u8bfb\u53d6\u7b2c\u4e00\u4e2a\u9875\u5185\u7684\u6307\u4ee4\uff09\u52a0\u4e0a\u7b2c\u4e8c\u4e2a\u9875\u5185\u6307\u4ee4\u9700\u8981 Fetch \u7684\u5468\u671f\u6570\uff0c\u591a\u7684\u8fd9\u4e00\u4e2a\u5468\u671f\u5c31\u8db3\u4ee5\u628a Fetch \u5bbd\u5ea6\u4ece\u540e\u7aef\u9650\u5236\u4e2d\u533a\u5206\u5f00\uff0c\u5b9e\u9a8c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_if_width.png\" /></p>\n<p>\u56fe\u4e2d\u84dd\u7ebf\uff08cross-page\uff09\u8868\u793a\u7684\u5c31\u662f\u4e0a\u9762\u6240\u8ff0\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u653e\u4e00\u4e2a\u9875\uff0c\u5176\u4f59\u6307\u4ee4\u653e\u7b2c\u4e8c\u4e2a\u9875\u7684\u60c5\u51b5\uff0c\u6a2a\u5750\u6807\u662f\u7b2c\u4e8c\u4e2a\u9875\u5185\u7684\u6307\u4ee4\u6570\uff0c\u90a3\u4e48\u4e00\u6b21\u5faa\u73af\u7684\u6307\u4ee4\u6570\u7b49\u4e8e\u6a2a\u5750\u6807 +1\u3002\u7eb5\u5750\u6807\u662f\u8fd0\u884c\u5f88\u591a\u6b21\u5faa\u73af\u7684\u603b cycle \u6570\u9664\u4ee5\u5faa\u73af\u6b21\u6570\uff0c\u4e5f\u5c31\u662f\u5e73\u5747\u6bcf\u6b21\u5faa\u73af\u8017\u8d39\u7684\u5468\u671f\u6570\u3002\u53ef\u4ee5\u770b\u5230\u6bcf 16 \u6761\u6307\u4ee4\u4f1a\u591a\u4e00\u4e2a\u5468\u671f\uff0c\u56e0\u6b64 Oryon \u7684\u524d\u7aef\u53d6\u6307\u5bbd\u5ea6\u786e\u5b9e\u662f 16 \u6761\u6307\u4ee4\u3002</p>\n<p>\u4e3a\u4e86\u786e\u8ba4\u8fd9\u4e2a\u74f6\u9888\u662f\u7531\u53d6\u6307\u9020\u6210\u7684\uff0c\u53c8\u6784\u9020\u4e86\u4e00\u7ec4\u5b9e\u9a8c\uff0c\u628a\u5faa\u73af\u7684\u6240\u6709\u6307\u4ee4\u90fd\u653e\u5230\u4e00\u4e2a\u9875\u4e2d\uff0c\u8fd9\u4e2a\u65f6\u5019 Fetch \u4e0d\u518d\u6210\u4e3a\u74f6\u9888\uff08\u56fe\u4e2d aligned\uff09\uff0c\u4e24\u4e2a\u66f2\u7ebf\u7684\u5bf9\u6bd4\u53ef\u4ee5\u660e\u786e\u5730\u5f97\u51fa\u4e0a\u8ff0\u7ed3\u8bba\u3002</p>\n<h3 id=\"l1-icache\">L1 ICache<a class=\"headerlink\" href=\"#l1-icache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>192KB</strong> <strong>6-way</strong> L1 ICache</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 L1 ICache \u5bb9\u91cf\uff0c\u6784\u9020\u4e00\u4e2a\u5177\u6709\u5de8\u5927\u6307\u4ee4 footprint \u7684\u5faa\u73af\uff0c\u7531\u5927\u91cf\u7684 nop \u548c\u6700\u540e\u7684\u5206\u652f\u6307\u4ee4\u7ec4\u6210\u3002\u89c2\u5bdf\u5728\u4e0d\u540c footprint \u5927\u5c0f\u4e0b\u7684 IPC\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_fetch_bandwidth.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 footprint \u5728 192 KB \u4e4b\u524d\u65f6\u53ef\u4ee5\u8fbe\u5230 8 IPC\uff0c\u4e4b\u540e\u5219\u5feb\u901f\u964d\u5230 2 IPC\uff0c\u8fd9\u91cc\u7684 192 KB \u5c31\u5bf9\u5e94\u4e86 L1 ICache \u7684\u5bb9\u91cf\u3002\u867d\u7136 Fetch \u53ef\u4ee5\u6bcf\u5468\u671f 16 \u6761\u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u4e00\u6761 64B \u7684\u7f13\u5b58\u884c\uff0c\u7531\u4e8e\u540e\u7aef\u7684\u9650\u5236\uff0c\u53ea\u80fd\u89c2\u5bdf\u5230 8 \u7684 IPC\u3002</p>\n<h3 id=\"l1-itlb\">L1 ITLB<a class=\"headerlink\" href=\"#l1-itlb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>256-entry</strong> <strong>8-way</strong> L1 ITLB\uff0c\u652f\u6301 4KB \u548c 64KB \u7684\u9875\u8868\u5927\u5c0f</p>\n<p>\u6784\u9020\u4e00\u7cfb\u5217\u7684 B \u6307\u4ee4\uff0c\u4f7f\u5f97 B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 ITLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_itlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 256 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 256 \u7684 L1 ITLB \u5bb9\u91cf\u3002\u6ce8\u610f\u8981\u907f\u514d ICache \u548c BTB \u7684\u5bb9\u91cf\u6210\u4e3a\u74f6\u9888\uff0c\u628a B \u6307\u4ee4\u5206\u5e03\u5728\u4e0d\u540c\u7684 Cache Line \u548c BTB entry \u4e0a\u3002</p>\n<p>\u5982\u679c\u6bcf\u4e24\u4e2a page \u653e\u4e00\u6761 B \u6307\u4ee4\uff0c\u5bb9\u91cf\u51cf\u5c0f\u5230 128 Page\uff1b\u8fdb\u4e00\u6b65\u628a B \u6307\u4ee4\u653e\u5f97\u66f4\u52a0\u7a00\u758f\uff0c\u6700\u7ec8\u5728\u6bcf 32 \u4e2a page \u653e\u4e00\u6761 B \u6307\u4ee4\u65f6\uff0c\u5bb9\u91cf\u51cf\u5230 8 Page\uff0c\u4e4b\u540e\u4e0d\u518d\u51cf\u5c0f\u3002\u8bf4\u660e L1 ITLB \u662f 32 Set 8 Way\uff0cIndex \u662f PC[16:12]\u3002\u8fd9\u662f\u9875\u8868\u5927\u5c0f\u4e3a 4KB \u7684\u60c5\u51b5\uff0c64KB \u6ca1\u6709\u6d4b\u8bd5\uff0c\u9884\u8ba1\u662f\u7c7b\u4f3c\u7684\u3002</p>\n<h3 id=\"decode\">Decode<a class=\"headerlink\" href=\"#decode\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a8 inst/cycle decoded</p>\n<h3 id=\"return-stack\">Return Stack<a class=\"headerlink\" href=\"#return-stack\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>50-entry</strong> return stack</p>\n<p>\u6784\u9020\u4e0d\u540c\u6df1\u5ea6\u7684\u8c03\u7528\u94fe\uff0c\u6d4b\u8bd5\u6bcf\u6b21\u8c03\u7528\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\uff0c\u5f97\u5230\u4e0b\u9762\u7684\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_rs.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u94fe\u6df1\u5ea6\u4e3a 50 \u65f6\u6027\u80fd\u7a81\u7136\u53d8\u5dee\uff0c\u56e0\u6b64 Return Stack \u6df1\u5ea6\u4e3a 50\u3002</p>\n<h3 id=\"branch-predictor\">Branch Predictor<a class=\"headerlink\" href=\"#branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a80KB Conditional Predictor, 40KB Indirect Predictor</p>\n<h3 id=\"btb\">BTB<a class=\"headerlink\" href=\"#btb\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a<strong>2K+</strong> entry BTB</p>\n<p>\u6784\u9020\u5927\u91cf\u7684\u65e0\u6761\u4ef6\u5206\u652f\u6307\u4ee4\uff08B \u6307\u4ee4\uff09\uff0cBTB \u9700\u8981\u8bb0\u5f55\u8fd9\u4e9b\u6307\u4ee4\u7684\u76ee\u7684\u5730\u5740\uff0c\u90a3\u4e48\u5982\u679c\u5206\u652f\u6570\u91cf\u8d85\u8fc7\u4e86 BTB \u7684\u5bb9\u91cf\uff0c\u6027\u80fd\u4f1a\u51fa\u73b0\u660e\u663e\u4e0b\u964d\u3002\u5f53\u628a\u5927\u91cf B \u6307\u4ee4\u7d27\u5bc6\u653e\u7f6e\uff0c\u4e5f\u5c31\u662f\u6bcf 4 \u5b57\u8282\u4e00\u6761 B \u6307\u4ee4\u65f6\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_btb_4b.png\" /></p>\n<p>\u53ef\u89c1\u5728 2048 \u4e2a\u5206\u652f\u4e4b\u5185\u53ef\u4ee5\u8fbe\u5230 1 \u7684 CPI\uff0c\u8d85\u8fc7 2048 \u4e2a\u5206\u652f\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u5e73\u53f0\uff0c\u4e00\u76f4\u5ef6\u7eed\u5230 32768 \u4e2a\u5206\u652f\u6216\u66f4\u591a\u3002\u8d85\u51fa BTB \u5bb9\u91cf\u4ee5\u540e\uff0c\u5206\u652f\u9884\u6d4b\u65f6\uff0c\u65e0\u6cd5\u4ece BTB \u4e2d\u5f97\u5230\u54ea\u4e9b\u6307\u4ee4\u662f\u5206\u652f\u6307\u4ee4\u7684\u4fe1\u606f\uff0c\u53ea\u80fd\u7b49\u5230\u53d6\u6307\u751a\u81f3\u8bd1\u7801\u540e\u624d\u80fd\u540e\u77e5\u540e\u89c9\u5730\u53d1\u73b0\u8fd9\u662f\u4e00\u6761\u5206\u652f\u6307\u4ee4\uff0c\u8fd9\u6837\u5c31\u51fa\u73b0\u4e86\u6027\u80fd\u635f\u5931\uff0c\u51fa\u73b0\u4e86 3 CPI \u7684\u60c5\u51b5\u3002</p>\n<p>\u964d\u4f4e\u5206\u652f\u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u5728 B \u6307\u4ee4\u4e4b\u95f4\u63d2\u5165 NOP \u6307\u4ee4\uff0c\u4f7f\u5f97\u6bcf 8 \u4e2a\u5b57\u8282\u6709\u4e00\u6761 B \u6307\u4ee4\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_btb_8b.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 CPI=1 \u7684\u62d0\u70b9\u524d\u79fb\u5230 1024 \u4e2a\u5206\u652f\uff0c\u540c\u65f6 CPI=3 \u7684\u5e73\u53f0\u4e5f\u51fa\u73b0\u4e86\u65b0\u7684\u62d0\u70b9\uff0c\u5728 16384 \u548c 32768 \u4e4b\u95f4\u3002\u62d0\u70b9\u7684\u524d\u79fb\uff0c\u610f\u5473\u7740 BTB \u91c7\u7528\u4e86\u7ec4\u76f8\u8fde\u7684\u7ed3\u6784\uff0c\u5f53 B \u6307\u4ee4\u7684 PC \u7684\u90e8\u5206\u4f4e\u4f4d\u603b\u662f\u4e3a 0 \u65f6\uff0c\u7ec4\u76f8\u8fde\u7684 Index \u53ef\u80fd\u65e0\u6cd5\u53d6\u5230\u6240\u6709\u7684 Set\uff0c\u5bfc\u81f4\u8868\u73b0\u51fa\u6765\u7684 BTB \u5bb9\u91cf\u53ea\u6709\u90e8\u5206 Set\uff0c\u4f8b\u5982\u6b64\u5904\u5bb9\u91cf\u51cf\u534a\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u534a\u7684 Set \u88ab\u7528\u5230\u4e86\u3002</p>\n<p>\u51fa\u73b0\u65b0\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u662f\u6307\u4ee4 footprint \u8d85\u51fa L1 ICache \u7684\u60c5\u51b5\uff1aL1 ICache \u662f 192KB\uff0c\u6309\u7167\u6bcf 8 \u5b57\u8282\u4e00\u4e2a B \u6307\u4ee4\u8ba1\u7b97\uff0c\u6700\u591a\u53ef\u4ee5\u5b58\u653e 24576 \u6761 B \u6307\u4ee4\uff0c\u8fd9\u4e2a\u503c\u6b63\u597d\u5904\u5728 16384 \u548c 32768 \u4e4b\u95f4\uff0c\u548c\u62d0\u70b9\u543b\u5408\u3002</p>\n<p>\u5982\u679c\u8fdb\u4e00\u6b65\u964d\u4f4e B \u6307\u4ee4\u7684\u5bc6\u5ea6\uff0c\u4f7f\u5f97\u5b83\u7684\u4f4e\u82e5\u5e72\u4f4d\u90fd\u7b49\u4e8e 0\uff0c\u6700\u7ec8 CPI=1 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 2 \u6761\u5206\u652f\uff0cCPI=3/3.5 \u7684\u62d0\u70b9\u5b9a\u683c\u5728 6 \u6761\u5206\u652f\u3002\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\uff0c\u8ba4\u4e3a BTB \u662f 1024 Set 2 Way \u7684\u7ed3\u6784\uff0cIndex \u662f PC[11:2]\uff1b\u540c\u65f6\u4e5f\u4fa7\u9762\u4f50\u8bc1\u4e86 192KB L1 ICache \u662f 512 Set 6 Way\uff0cIndex \u662f PC[14:6]\u3002\u4e0d\u8fc7\u8003\u8651\u5230 Oryon \u652f\u6301\u8de8 64B \u8fb9\u754c\u8bbf\u5b58\uff0c\u5b9e\u9645\u7684 L1 ICache \u5927\u6982\u7387\u662f\u5206 bank \u7684\uff0c\u8fd9\u6837\u624d\u80fd\u5728\u4fdd\u6301\u5355\u8bfb\u53e3\u7684\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u5468\u671f\u4ece\u8fde\u7eed\u7684\u4e24\u4e2a Cache Line \u4e2d\u53d6\u6307\u4ee4\u3002</p>\n<p>\u5c0f\u7ed3\uff1aBTB \u5bb9\u91cf\u4e3a 2048 \u9879\uff0c\u91c7\u7528 2 \u8def\u7ec4\u76f8\u8fde\u65b9\u5f0f\uff0c\u5f53\u6240\u6709\u5206\u652f\u547d\u4e2d BTB \u65f6\uff0c\u53ef\u4ee5\u8fbe\u5230 1 CPI\uff1b\u5982\u679c\u8d85\u51fa\u4e86 BTB \u5bb9\u91cf\uff0c\u4f46\u6ca1\u6709\u8d85\u51fa L1 ICache \u5bb9\u91cf\uff0c\u53ef\u4ee5\u8fbe\u5230 3 CPI\u3002</p>\n<h3 id=\"branch-mispredict-latency\">Branch Mispredict Latency<a class=\"headerlink\" href=\"#branch-mispredict-latency\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a13 cycle Branch Mispredict Latency</p>\n<h3 id=\"conditional-branch-predictor\">Conditional Branch Predictor<a class=\"headerlink\" href=\"#conditional-branch-predictor\" title=\"Permanent link\">&para;</a></h3>\n<p>\u53c2\u8003 <a href=\"https://arxiv.org/abs/2411.13900\">Dissecting Conditional Branch Predictors of Apple Firestorm and Qualcomm Oryon for Software Optimization and Architectural Analysis</a> \u8bba\u6587\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u6d4b\u51fa Oryon \u7684\u5206\u652f\u9884\u6d4b\u5668\u91c7\u7528\u7684\u5386\u53f2\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a</p>\n<ol>\n<li>\u4f7f\u7528 100 \u4f4d\u7684 Path History Register for Target(PHRT) \u4ee5\u53ca 32 \u4f4d\u7684 Path History Register for Branch(PHRB)\uff0c\u6bcf\u6b21\u6267\u884c taken branch \u65f6\u66f4\u65b0</li>\n<li>\u66f4\u65b0\u65b9\u5f0f\u4e3a\uff1a<code>PHRTnew = (PHRTold &lt;&lt; 1) xor T[31:2], PHRBnew = (PHRBold &lt;&lt; 1) xor B[5:2]</code>\uff0c\u5176\u4e2d B \u4ee3\u8868\u5206\u652f\u6307\u4ee4\u7684\u5730\u5740\uff0cT \u4ee3\u8868\u5206\u652f\u8df3\u8f6c\u7684\u76ee\u7684\u5730\u5740</li>\n</ol>\n<p>\u5404\u5382\u5546\u5904\u7406\u5668\u7684 PHR \u66f4\u65b0\u89c4\u5219\u89c1 <a href=\"https://jia.je/cpu/cbp.html\">jiegec/cpu</a>\u3002</p>\n<h2 id=\"\u540e\u7aef\">\u540e\u7aef<a class=\"headerlink\" href=\"#\u540e\u7aef\" title=\"Permanent link\">&para;</a></h2>\n<h3 id=\"\u7269\u7406\u5bc4\u5b58\u5668\u5806\">\u7269\u7406\u5bc4\u5b58\u5668\u5806<a class=\"headerlink\" href=\"#\u7269\u7406\u5bc4\u5b58\u5668\u5806\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a400+ registers Integer pool, 400+ registers Vector pool</p>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u7269\u7406\u5bc4\u5b58\u5668\u5806\u7684\u5927\u5c0f\uff0c\u4e00\u822c\u4f1a\u7528\u4e24\u4e2a\u4f9d\u8d56\u94fe\u5f88\u957f\u7684\u64cd\u4f5c\u653e\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\uff0c\u4e2d\u95f4\u586b\u5165\u82e5\u5e72\u4e2a\u65e0\u5173\u7684\u6307\u4ee4\uff0c\u5e76\u4e14\u7528\u8fd9\u4e9b\u6307\u4ee4\u6765\u8017\u8d39\u7269\u7406\u5bc4\u5b58\u5668\u5806\u3002\u6d4b\u8bd5\u7ed3\u679c\u89c1\u4e0b\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_prf.png\" /></p>\n<ul>\n<li>32b/64b int\uff1a\u6d4b\u8bd5 32/64 \u4f4d\u6574\u6570\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 362-374</li>\n<li>fp\uff1a\u6d4b\u8bd5\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 362-372</li>\n<li>flags\uff1a\u6d4b\u8bd5 NZCV \u5bc4\u5b58\u5668\u7684\u6570\u91cf\uff0c\u62d0\u70b9\u5728 119-126</li>\n</ul>\n<p>\u53ef\u89c1\u6574\u6570\u548c\u6d6e\u70b9\u6570\u90fd\u80fd\u63d0\u4f9b\u5927\u7ea6 360+ \u4e2a\u5bc4\u5b58\u5668\u7528\u4e8e\u4e71\u5e8f\u6267\u884c\uff0c\u52a0\u4e0a\u7528\u4e8e\u4fdd\u5b58\u67b6\u6784\u5bc4\u5b58\u5668\u7684\u81f3\u5c11 32 \u4e2a\u5bc4\u5b58\u5668\uff0c\u52a0\u8d77\u6765\u548c\u9ad8\u901a\u5ba3\u79f0\u7684 400+ \u662f\u6bd4\u8f83\u4e00\u81f4\u7684\u3002\u6574\u6570\u548c\u6d6e\u70b9\u4e2a\u6570\u6d4b\u51fa\u6765\u4e00\u6837\uff0c\u53ef\u80fd\u662f\u8fd9\u4e24\u4e2a\u5bc4\u5b58\u5668\u5806\u5927\u5c0f\u4e00\u6837\uff0c\u4e5f\u53ef\u80fd\u662f\u6574\u6570\u548c\u6d6e\u70b9\u653e\u540c\u4e00\u4e2a\u5bc4\u5b58\u5668\u5806\u4e2d\u3002\u7ecf\u8fc7\u6df7\u5408\u6574\u6570\u548c\u6d6e\u70b9\u6307\u4ee4\u6d4b\u8bd5\uff0c\u8ba4\u4e3a\u8fd9\u4e24\u4e2a\u5bc4\u5b58\u5668\u5806\u5e76\u4e0d\u5171\u4eab\uff0c\u53ea\u662f\u6570\u91cf\u5dee\u4e0d\u591a\u3002</p>\n<p>NZCV \u91cd\u547d\u540d\u5219\u6bd4\u6574\u6570\u5bc4\u5b58\u5668\u5c11\u5f97\u591a\uff0c\u53ea\u6709 120+\uff0c\u4e5f\u662f\u8003\u8651\u5230 ARMv8 \u6307\u4ee4\u96c6\u5927\u90e8\u5206\u6307\u4ee4\u4e0d\u50cf X86 \u90a3\u6837\u4f1a\u4fee\u6539 NZCV\u3002</p>\n<h3 id=\"reservation-stations\">Reservation Stations<a class=\"headerlink\" href=\"#reservation-stations\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>IXU 6-wide 64-bit, each with 20 entry queue</li>\n<li>VXU 4-wide 128-bit, each with 48 entry queue</li>\n<li>LSU 4-wide 128-bit, each with 16 entry queue (\u6ce8\uff1aHot Chips \u4e0a\u7684 Slides \u5199\u7684\u662f\u56db\u4e2a 64-entry\uff0c\u51fa\u73b0\u4e86\u4e0d\u4e00\u81f4)</li>\n</ul>\n<h3 id=\"\u6267\u884c\u5355\u5143\">\u6267\u884c\u5355\u5143<a class=\"headerlink\" href=\"#\u6267\u884c\u5355\u5143\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Up to <strong>6</strong> ALU/cycle</li>\n<li>Up to <strong>2</strong> Branch/cycle</li>\n<li>Up to <strong>2</strong> multiply/MLA per cycle</li>\n</ul>\n<p>\u5728\u5faa\u73af\u4e2d\u91cd\u590d\u4e0b\u5217\u6307\u4ee4\u591a\u6b21\uff0c\u6d4b\u91cf CPI\uff0c\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p>\n<ul>\n<li><code>add x0, x0, 1</code>\uff1aCPI = 6.0\uff0c\u8bf4\u660e\u53ef\u4ee5 6 ALU/cycle</li>\n<li><code>cbnz xzr, target;target:</code>\uff1aCPI = 2.0\uff0c\u8bf4\u660e\u53ef\u4ee5 2 Branch/cycle\uff0c\u6ce8\u610f\u8fd9\u91cc\u662f not taken \u5206\u652f</li>\n<li><code>mul x0, x1, x2</code>\uff1aCPI = 2.0\uff0c\u8bf4\u660e\u53ef\u4ee5 2 Multiply/cycle</li>\n</ul>\n<h3 id=\"reorder-buffer\">Reorder Buffer<a class=\"headerlink\" href=\"#reorder-buffer\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>Retirement 8 uOps/cycle</li>\n<li>Reorder Buffer is 650+ uOps</li>\n</ul>\n<p>\u4e3a\u4e86\u6d4b\u8bd5 ROB \u7684\u5927\u5c0f\uff0c\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u5faa\u73af\uff0c\u5faa\u73af\u5f00\u59cb\u662f 8 \u6761\u4e32\u884c\u7684 fsqrt \u6307\u4ee4\uff0c\u6bcf\u6761\u6307\u4ee4\u9700\u8981 13 \u4e2a\u5468\u671f\uff0c\u7531\u4e8e\u6570\u636e\u4f9d\u8d56\uff0c\u4e00\u5171\u9700\u8981 8*13=104 \u4e2a\u5468\u671f\u5b8c\u6210\u3002\u4e4b\u540e\u662f\u82e5\u5e72\u6761 NOP \u6307\u4ee4\uff0c\u5f53 NOP \u6307\u4ee4\u6bd4\u8f83\u5c11\u65f6\uff0c\u5faa\u73af\u7684\u65f6\u5019\u53d6\u51b3\u4e8e fsqrt \u6307\u4ee4\u7684\u65f6\u95f4\uff0c\u4e00\u6b21\u5faa\u73af\u5927\u7ea6\u9700\u8981 104 \u4e2a\u5468\u671f\uff1b\u5f53 NOP \u6307\u4ee4\u6570\u91cf\u8fc7\u591a\uff0c\u586b\u6ee1\u4e86 ROB \u4ee5\u540e\uff0c\u5c31\u4f1a\u5bfc\u81f4 ROB \u65e0\u6cd5\u4fdd\u5b58\u4e0b\u4e00\u6b21\u5faa\u73af\u7684 fsqrt \u6307\u4ee4\uff0c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\u3002\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_rob.png\" /></p>\n<p>\u5f53 NOP \u6570\u91cf\u8fbe\u5230 676 \u65f6\uff0c\u6027\u80fd\u5f00\u59cb\u6025\u5267\u4e0b\u6ed1\uff0c\u800c\u6267\u884c 676 \u6761 NOP \u53ea\u9700\u8981 676/8=84.5 \u4e2a\u5468\u671f\uff0c\u5c0f\u4e8e 104 \u4e2a\u5468\u671f\uff0c\u8bf4\u660e\u74f6\u9888\u4e0d\u5728\u6267\u884c NOP \u4e0a\uff0c\u800c\u662f\u56e0\u4e3a ROB \u88ab\u586b\u6ee1\uff0c\u5bfc\u81f4\u540e\u7eed\u7684 fsqrt \u6307\u4ee4\u65e0\u6cd5\u53ca\u65f6\u6267\u884c\u3002\u56e0\u6b64\u8ba4\u4e3a Oryon \u7684 ROB \u5927\u5c0f\u5728 680+\u3002</p>\n<p>\u6ca1\u6709\u89c2\u5bdf\u5230\u7c7b\u4f3c Firestorm \u7684 Coalesced ROB \u7684\u8bbe\u8ba1\u3002</p>\n<h3 id=\"load-store-unit--l1-dcache\">Load Store Unit + L1 DCache<a class=\"headerlink\" href=\"#load-store-unit--l1-dcache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li><strong>96KB</strong> 6-way L1 DCache</li>\n<li><strong>224-entry</strong> <strong>7-way</strong> L1 DTLB, supports 4KB and 64KB translation granules</li>\n<li>Up to 4 Load-Store operations per cycle</li>\n<li>192 entry Load Queue, 56 entry Store Queue</li>\n<li>Full 64B/cycle for both fills and evictions to L2 cache</li>\n</ul>\n<h4 id=\"l1-dcache-\u5bb9\u91cf\">L1 DCache \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dcache-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_l1dc.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 96KB \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 96KB \u7684 L1 DCache \u5bb9\u91cf\u3002</p>\n<h4 id=\"l1-dtlb-\u5bb9\u91cf\">L1 DTLB \u5bb9\u91cf<a class=\"headerlink\" href=\"#l1-dtlb-\u5bb9\u91cf\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u6d4b\u8bd5 L1 DTLB \u5bb9\u91cf\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u6b21 pointer chasing \u94fe\u7684\u6307\u9488\u5206\u5e03\u5728\u4e0d\u540c\u7684 page \u4e0a\uff0c\u4f7f\u5f97 DTLB \u6210\u4e3a\u74f6\u9888\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_dtlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230 224 Page \u51fa\u73b0\u4e86\u660e\u663e\u7684\u62d0\u70b9\uff0c\u5bf9\u5e94\u7684\u5c31\u662f 224 \u7684 L1 DTLB \u5bb9\u91cf\u3002\u4ece\u6bcf\u4e2a page \u4e00\u4e2a\u6307\u9488\u6539\u6210\u6bcf 32 page \u4e00\u4e2a\u6307\u9488\u5e76\u6ce8\u610f\u5bf9\u9f50\u5c3d\u91cf\u4fdd\u8bc1 Index \u4e3a 0\uff0c\u6b64\u65f6 L1 DTLB \u5bb9\u91cf\u964d\u4e3a 7\uff0c\u8bf4\u660e L1 DTLB \u662f 7 \u8def\u7ec4\u76f8\u8fde\u7ed3\u6784\uff0c32 \u4e2a Set\uff0cIndex \u4f4d\u662f VA[16:12]\uff0c\u8fd9\u4e9b\u9875\u88ab\u6620\u5c04\u5230\u4e86\u76f8\u540c\u7684 Set \u5f53\u4e2d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_dtlb_7.png\" /></p>\n<p>\u6a2a\u5ea7\u6807\u4e3a 8\uff0c\u4e5f\u5c31\u662f\u6709 8 \u4e2a\u9875\u65f6\uff0c\u6b64\u65f6\u8fd9 8 \u4e2a\u9875\u90fd\u6620\u5c04\u5230\u540c\u4e00\u4e2a set \u5f53\u4e2d\uff0c\u6709\u56db\u5206\u4e4b\u4e00\u7684\u6982\u7387\u4f1a\u51fa\u73b0 L1 DTLB miss\uff0c\u6b64\u65f6 load latency \u662f 11 cycle\uff0c\u5269\u4e0b\u56db\u5206\u4e4b\u4e09\u7684\u6982\u7387 L1 DTLB hit\uff0cload latency \u662f 3 cycle\uff0c\u52a0\u6743\u5e73\u5747\u4e0b\u6765\u5f97\u5230 <code>11*1/4+3*3/4=5</code>\uff0c\u7b26\u5408\u9884\u671f\u3002\u8fd9\u4e2a\u56db\u5206\u4e4b\u4e00\u5bf9\u5e94\u4e86\u67d0\u79cd\u66ff\u6362\u7b56\u7565\u3002\u4ece\u6a2a\u5ea7\u6807\u4e3a 9 \u5f00\u59cb\uff0c\u5219\u6240\u6709\u8bbf\u95ee\u90fd\u51fa\u73b0 L1 DTLB miss\uff0c\u5ef6\u8fdf\u964d\u4f4e\u5230 11 cycle\uff0c\u8fd9\u4ee3\u8868\u4e86 L1 DTLB miss\uff0cL2 Unified TLB hit \u7684\u5ef6\u8fdf\u3002</p>\n<p>\u547d\u4e2d L1 DTLB \u65f6\u6bcf\u6761 Load \u6307\u4ee4\u662f 3 cycle\uff0c\u610f\u5473\u7740\u9ad8\u901a\u5b9e\u73b0\u4e86 3 cycle \u7684 pointer chasing load to use latency\uff0c\u8fd9\u4e2a\u7279\u6027\u5728\u82f9\u679c\uff0cExynos M-series \u548c Intel \u7684 E-core \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u9488\u5bf9\u8fd9\u4e2a\u4f18\u5316\u7684\u8ba8\u8bba\uff0c\u8be6\u89c1 <a href=\"../../../../2022/03/31/brief-into-ooo-2/\">\u6d45\u8c08\u4e71\u5e8f\u6267\u884c CPU\uff08\u4e8c\uff1a\u8bbf\u5b58\uff09</a> \u7684 Load Pipeline \u5c0f\u8282\u3002\u5728\u5176\u4ed6\u573a\u666f\u4e0b\uff0c\u4f9d\u7136\u662f 4 cycle \u7684 load to use latency\u3002</p>\n<h4 id=\"loadstore-\u5e26\u5bbd\">Load/Store \u5e26\u5bbd<a class=\"headerlink\" href=\"#loadstore-\u5e26\u5bbd\" title=\"Permanent link\">&para;</a></h4>\n<p>\u9488\u5bf9 Load Store \u5e26\u5bbd\uff0c\u5b9e\u6d4b\u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u5b8c\u6210\uff1a</p>\n<ul>\n<li>4x 128b Load</li>\n<li>3x 128b Load + 1x 128b Store</li>\n<li>2x 128b Load + 2x 128b Store</li>\n<li>1x 128b Load + 2x 128b Store</li>\n<li>2x 128b Store</li>\n</ul>\n<p>\u5982\u679c\u628a\u6bcf\u6761\u6307\u4ee4\u7684\u8bbf\u5b58\u4f4d\u5bbd\u4ece 128b \u6539\u6210 256b\uff0c\u8bfb\u5199\u5e26\u5bbd\u4e0d\u53d8\uff0c\u6307\u4ee4\u541e\u5410\u51cf\u534a\u3002\u4e5f\u5c31\u662f\u8bf4\u6700\u5927\u7684\u8bfb\u5e26\u5bbd\u662f 64B/cyc\uff0c\u6700\u5927\u7684\u5199\u5e26\u5bbd\u662f 32B/cyc\uff0c\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u8fbe\u5230\u3002</p>\n<p>\u4e0d\u592a\u786e\u5b9a\u7684\u662f\u9ad8\u901a\u5b98\u65b9\u7684\u8868\u8ff0\u91cc <code>Up to 4 Load-Store operations per cycle</code> \u5bf9\u4e8e 4 Store ops per cycle \u4ee5\u4ec0\u4e48\u65b9\u5f0f\u6210\u7acb\uff0c\u56e0\u4e3a\u4ece IPC \u6765\u770b\uff0c\u53ea\u80fd\u8fbe\u5230 2 Store Per Cycle\u3002</p>\n<h4 id=\"l1-dcache-\u5206-bank\">L1 DCache \u5206 Bank<a class=\"headerlink\" href=\"#l1-dcache-\u5206-bank\" title=\"Permanent link\">&para;</a></h4>\n<p>\u8003\u8651\u5230 L1 DCache \u9700\u8981\u5355\u5468\u671f\u652f\u6301 4 \u6761 Load \u6307\u4ee4\uff0c\u5982\u679c\u8981\u7528\u5355\u8bfb\u53e3\u7684 SRAM\uff0c\u4e00\u822c\u7684\u505a\u6cd5\u662f\u8bbe\u8ba1 4 \u4e2a Bank\uff0c\u6bcf\u4e2a Bank \u5bf9\u5e94\u4e00\u7ec4 SRAM\u3002\u4e3a\u4e86\u6d4b\u8bd5 Bank \u7684\u7c92\u5ea6\uff0c\u4f7f\u7528\u4e0d\u540c\u8de8\u6b65\uff08Stride\uff09\u7684 Load\uff0c\u89c2\u5bdf IPC\uff1a</p>\n<ul>\n<li>Stride=1B/2B/4B/8B/16B/32B/64B \u65f6 IPC=4</li>\n<li>Stride=128B \u65f6 IPC=2</li>\n<li>Stride=256B \u65f6 IPC=1</li>\n</ul>\n<p>\u5f53\u591a\u4e2a Load \u8bbf\u95ee\u540c\u4e00\u4e2a Cache Line \u65f6\uff0c\u8fd9\u4e9b Load \u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\uff0c\u6781\u9650\u60c5\u51b5\u4e0b\u7528 4 \u6761 128b Load \u53ef\u4ee5\u505a\u5230\u4e00\u4e2a\u5468\u671f\u628a\u6574\u4e2a 64B Cache Line \u90fd\u8bfb\u51fa\u6765\uff1bStride=128B \u65f6\uff0cIPC \u780d\u534a\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u534a\u7684 Bank \u5f97\u5230\u4e86\u5229\u7528\uff0c\u8fdb\u4e00\u6b65 Stride=256B \u65f6\uff0cIPC=1\uff0c\u8bf4\u660e\u53ea\u6709\u4e00\u4e2a Bank \u88ab\u7528\u4e0a\u3002</p>\n<p>\u90a3\u4e48 L1 DCache \u7684\u7ec4\u7ec7\u65b9\u5f0f\u5e94\u8be5\u662f 4 \u4e2a Bank\uff0cBank Index \u5bf9\u5e94 PA[7:6]\uff0c\u4e5f\u5c31\u662f\u8fde\u7eed\u7684\u56db\u4e2a 64B Cache Line \u4f1a\u88ab\u6620\u5c04\u5230\u56db\u4e2a Bank \u4e0a\u3002\u5f53\u591a\u4e2a Load \u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a Bank \u4e14\u8bbf\u95ee\u7684\u4e0d\u662f\u540c\u4e00\u4e2a Cache Line \u65f6\uff0c\u4f1a\u51fa\u73b0\u6027\u80fd\u635f\u5931\u3002</p>\n<p>\u8fd9\u91cc\u8ba8\u8bba\u7684\u662f\u7f13\u5b58\u884c\u7ea7\u522b\u7684 Bank\uff0c\u5b9e\u9645\u4e0a\u901a\u5e38\u7f13\u5b58\u884c\u5185\u90e8\u4e5f\u4f1a\u8fdb\u884c Bank \u5212\u5206\uff0c\u4f46\u4e3b\u8981\u662f\u4e3a\u4e86\u529f\u8017\uff0c\u6bd4\u5982\u4ece\u4e00\u4e2a 64B \u7f13\u5b58\u884c\u91cc\u8bfb\u53d6 8B \u6570\u636e\uff0c\u4e0d\u9700\u8981\u628a\u6574\u4e2a 64B \u90fd\u8bfb\u51fa\u6765\u3002</p>\n<h4 id=\"vipt\">VIPT<a class=\"headerlink\" href=\"#vipt\" title=\"Permanent link\">&para;</a></h4>\n<p>\u5728 4KB page \u7684\u60c5\u51b5\u4e0b\uff0c96KB 6-way \u7684 L1 DCache \u4e0d\u6ee1\u8db3 VIPT \u7684 Index \u5168\u5728\u9875\u5185\u504f\u79fb\u7684\u6761\u4ef6\uff08\u8be6\u89c1 <a href=\"../../../../2023/12/08/vipt-l1-cache-page-size/\">VIPT \u4e0e\u7f13\u5b58\u5927\u5c0f\u548c\u9875\u8868\u5927\u5c0f\u7684\u5173\u7cfb</a>\uff09\uff0c\u6b64\u65f6\u8981\u4e48\u6539\u7528 PIPT\uff0c\u8981\u4e48\u5728 VIPT \u7684\u57fa\u7840\u4e0a\u5904\u7406 alias \u7684\u95ee\u9898\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e00\u70b9\uff0c\u53c2\u8003 <a href=\"https://blog.cyyself.name/why-the-big-l1-cache-is-so-hard/\">\u6d45\u8c08\u73b0\u4ee3\u5904\u7406\u5668\u5b9e\u73b0\u8d85\u5927 L1 Cache \u7684\u65b9\u5f0f</a> \u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u7528 shm \u6784\u9020\u51fa\u4e24\u4e2a 4KB \u865a\u62df\u9875\u6620\u5c04\u5230\u540c\u4e00\u4e2a\u7269\u7406\u9875\u7684\u60c5\u51b5\uff0c\u7136\u540e\u5728\u4e24\u4e2a\u865a\u62df\u9875\u4e4b\u95f4 copy\uff0c\u53d1\u73b0\u76f8\u6bd4\u5728\u540c\u4e00\u4e2a\u865a\u62df\u9875\u5185 copy \u6709\u663e\u8457\u7684\u6027\u80fd\u4e0b\u964d\uff0c\u5e76\u4e14\u4ea7\u751f\u4e86\u5927\u91cf\u7684 L1 DCache Refill\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-0-1\"><a id=\"__codelineno-0-1\" name=\"__codelineno-0-1\" href=\"#__codelineno-0-1\"></a>copy from aliased page = 8407465601 cycles, 321782134 refills\n</span><span id=\"__span-0-2\"><a id=\"__codelineno-0-2\" name=\"__codelineno-0-2\" href=\"#__codelineno-0-2\"></a>baseline = 1239053083 cycles, 20 refills\n</span><span id=\"__span-0-3\"><a id=\"__codelineno-0-3\" name=\"__codelineno-0-3\" href=\"#__codelineno-0-3\"></a>slowdown = 6.79x\n</span></code></pre></div>\n<p>\u56e0\u6b64\u731c\u6d4b L1 DCache \u91c7\u7528\u7684\u662f VIPT\uff0c\u5e76\u505a\u4e86\u9488\u5bf9 alias \u7684\u6b63\u786e\u6027\u5904\u7406\u3002\u5982\u679c\u662f PIPT\uff0c\u90a3\u4e48 L1 DCache \u4f1a\u53d1\u73b0\u8fd9\u4e24\u4e2a\u9875\u5bf9\u5e94\u7684\u662f\u76f8\u540c\u7684\u7269\u7406\u5730\u5740\uff0c\u6027\u80fd\u4e0d\u4f1a\u4e0b\u964d\uff0c\u4e5f\u4e0d\u9700\u8981\u9891\u7e41\u7684 refill\u3002</p>\n<h4 id=\"memory-dependency-predictor\">Memory Dependency Predictor<a class=\"headerlink\" href=\"#memory-dependency-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>\u4e3a\u4e86\u9884\u6d4b\u6267\u884c Load\uff0c\u9700\u8981\u4fdd\u8bc1 Load \u548c\u4e4b\u524d\u7684 Store \u8bbf\u95ee\u7684\u5185\u5b58\u6ca1\u6709 Overlap\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6709\u4e00\u4e2a\u9884\u6d4b\u5668\u6765\u9884\u6d4b Load \u548c Store \u4e4b\u524d\u5728\u5185\u5b58\u4e0a\u7684\u4f9d\u8d56\u3002\u53c2\u8003 <a href=\"https://blog.stuffedcow.net/2014/01/x86-memory-disambiguation/\">Store-to-Load Forwarding and Memory Disambiguation in x86 Processors</a> \u7684\u65b9\u6cd5\uff0c\u6784\u9020\u4e24\u4e2a\u6307\u4ee4\u6a21\u5f0f\uff0c\u5206\u522b\u5728\u5730\u5740\u548c\u6570\u636e\u4e0a\u6709\u4f9d\u8d56\uff1a</p>\n<ul>\n<li>\u6570\u636e\u4f9d\u8d56\uff0c\u5730\u5740\u65e0\u4f9d\u8d56\uff1a<code>str x3, [x1]</code> \u548c <code>ldr x3, [x2]</code></li>\n<li>\u5730\u5740\u4f9d\u8d56\uff0c\u6570\u636e\u65e0\u4f9d\u8d56\uff1a<code>str x2, [x1]</code> \u548c <code>ldr x1, [x2]</code></li>\n</ul>\n<p>\u521d\u59cb\u5316\u65f6\uff0c<code>x1</code> \u548c <code>x2</code> \u6307\u5411\u540c\u4e00\u4e2a\u5730\u5740\uff0c\u91cd\u590d\u5982\u4e0a\u7684\u6307\u4ee4\u6a21\u5f0f\uff0c\u89c2\u5bdf\u5230\u591a\u5c11\u6761 <code>ldr</code> \u6307\u4ee4\u65f6\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_memory_dependency_predictor.png\" /></p>\n<p>\u6709\u610f\u601d\u7684\u662f\uff0c\u4e24\u79cd\u6a21\u5f0f\u51fa\u73b0\u4e86\u4e0d\u540c\u7684\u9608\u503c\uff0c\u5730\u5740\u4f9d\u8d56\u7684\u9608\u503c\u662f 64\uff0c\u800c\u6570\u636e\u4f9d\u8d56\u7684\u9608\u503c\u662f 96\u3002</p>\n<h4 id=\"store-to-load-forwarding\">Store to Load Forwarding<a class=\"headerlink\" href=\"#store-to-load-forwarding\" title=\"Permanent link\">&para;</a></h4>\n<p>\u7ecf\u8fc7\u5b9e\u9645\u6d4b\u8bd5\uff0c\u5982\u4e0b\u7684\u60c5\u51b5\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff1a</p>\n<p>\u5bf9\u5730\u5740 x \u7684 Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 Load \u6210\u529f\u65f6 y-x \u7684\u53d6\u503c\u8303\u56f4\uff1a</p>\n<table>\n<thead>\n<tr>\n<th>Store\\Load</th>\n<th>8b Load</th>\n<th>16b Load</th>\n<th>32b Load</th>\n<th>64b Load</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>8b Store</td>\n<td>{0}</td>\n<td>[-1,0]</td>\n<td>[-3,0]</td>\n<td>[-7,0]</td>\n</tr>\n<tr>\n<td>16b Store</td>\n<td>[0,1]</td>\n<td>[-1,1]</td>\n<td>[-3,1]</td>\n<td>[-7,1]</td>\n</tr>\n<tr>\n<td>32b Store</td>\n<td>[0,3]</td>\n<td>[-1,3]</td>\n<td>[-3,3]</td>\n<td>[-7,3]</td>\n</tr>\n<tr>\n<td>64b Store</td>\n<td>[0,7]</td>\n<td>[-1,7]</td>\n<td>[-3,7]</td>\n<td>[-7,7]</td>\n</tr>\n</tbody>\n</table>\n<p>\u4ece\u4e0a\u8868\u53ef\u4ee5\u770b\u5230\uff0c\u6240\u6709 Store \u548c Load Overlap \u7684\u60c5\u51b5\uff0c\u65e0\u8bba\u5730\u5740\u504f\u79fb\uff0c\u90fd\u80fd\u6210\u529f\u8f6c\u53d1\uff0c\u4e0d\u8fc7\u4ee3\u4ef7\u662f\u5982\u679c Load \u6216 Store \u8de8\u8d8a 64B \u7f13\u5b58\u884c\u7684\u8fb9\u754c\u65f6\u5c31\u4f1a\u8f6c\u53d1\u5931\u8d25\uff0c\u6bd5\u7adf\u5728\u53ea\u6709\u90e8\u5206\u8986\u76d6\u7684\u60c5\u51b5\u4e0b\uff0c\u5269\u4e0b\u7684\u90e8\u5206\u9700\u8981\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\u3002<a href=\"../../../12/26/apple_m1/\">Apple Firestorm</a> \u548c Qualcomm Oryon \u6bd4\u8f83\u7c7b\u4f3c\uff0c\u6240\u6709 Overlap \u60c5\u51b5\u4e0b\u90fd\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u4f46\u5373\u4f7f\u662f\u8de8\u8d8a 64B \u7f13\u5b58\u884c\u4e5f\u53ef\u4ee5\u6210\u529f\u8f6c\u53d1\uff0c\u53ea\u9700\u8981\u591a\u82b1\u8d39\u4e00\u4e2a\u5468\u671f\u3002</p>\n<p>\u4e00\u4e2a Load \u9700\u8981\u8f6c\u53d1\u4e24\u4e2a Store \u7684\u6570\u636e\u7684\u60c5\u51b5\u6bd4\u8f83\u5947\u602a\uff1a\u5bf9\u5730\u5740 x \u7684 32b Store \u548c\u5bf9\u5730\u5740 x+4 \u7684 32b Store \u8f6c\u53d1\u5230\u5bf9\u5730\u5740 y \u7684 64b Load\uff0c\u8981\u6c42 x%4==0\uff0c\u4e0d\u8de8\u8d8a 64B \u7f13\u5b58\u884c\uff0c\u5bf9 y-x \u9664\u4e86 Overlap \u4ee5\u5916\u6ca1\u6709\u989d\u5916\u7684\u8981\u6c42\u3002Apple Firestorm \u5219\u6ca1\u6709 x%4==0 \u8fd9\u4e2a\u5c40\u9650\u6027\uff0c\u4f46\u5728\u8de8\u8d8a 64B \u7f13\u5b58\u884c\u65f6\u4e5f\u4e0d\u80fd\u8f6c\u53d1\u3002</p>\n<p>\u4f46 64b Load \u5c31\u4e0d\u652f\u6301\u4ece 4 \u4e2a 16b Store \u8f6c\u53d1\u4e86\uff0c8 \u4e2a 8b Store \u4e5f\u4e0d\u652f\u6301\u3002Apple Firestorm \u5219\u90fd\u652f\u6301\uff0c\u76f8\u6bd4\u4ece\u5355\u4e2a Store \u8f6c\u53d1\u591a 1-4 \u4e2a\u5468\u671f\u3002</p>\n<p>\u7531\u6b64\u770b\u51fa Oryon \u548c <a href=\"../../../11/11/amd_zen5/\">Zen 5</a> \u4ee5\u53ca <a href=\"../../../11/07/arm_neoverse_v2/\">Neoverse V2</a> \u5728\u8bbe\u8ba1\u601d\u8def\u4e0a\u7684\u4e0d\u540c\uff1aOryon \u8ffd\u6c42 Load \u548c Store \u7684\u81ea\u7531\u7ec4\u5408\uff0c\u5141\u8bb8\u53ea\u6709\u4e00\u90e8\u5206\u8986\u76d6\uff0c\u4e5f\u65e0\u6240\u8c13\u5730\u5740\u504f\u79fb\u662f\u591a\u5c11\uff0c\u4f46\u4e5f\u727a\u7272\u4e86\u8de8 64B \u7f13\u5b58\u884c\u65f6\u7684\u6027\u80fd\u3002\u6b64\u5916\uff0cOryon \u9488\u5bf9\u4e00\u4e2a Load \u8f6c\u53d1\u4e24\u4e2a Store \u7684\u60c5\u51b5\u7684\u652f\u6301\u6bd4\u8f83\u7279\u522b\uff0c\u8981\u6c42 Store \u5730\u5740\u5bf9\u9f50\u5230 4B\u3002</p>\n<p>\u6210\u529f\u8f6c\u53d1\u65f6 9 cycle\uff0c\u6709 Overlap \u4f46\u8f6c\u53d1\u5931\u8d25\u65f6 17-23 cycle\uff0c\u8de8\u7f13\u5b58\u884c\u65f6\u8981 40+ cycle\u3002</p>\n<p>\u5c0f\u7ed3\uff1aQualcomm Oryon \u7684 Store to Load Forwarding\uff1a</p>\n<ul>\n<li>1 ld + 1 st: \u8981\u6c42\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 2 st: \u8981\u6c42 ld \u5bf9\u9f50\u5230 4B \u8fb9\u754c\u4e14\u4e0d\u8de8\u8d8a 64B \u8fb9\u754c</li>\n<li>1 ld + 4 st: \u4e0d\u652f\u6301</li>\n</ul>\n<h4 id=\"load-to-use-latency\">Load to use latency<a class=\"headerlink\" href=\"#load-to-use-latency\" title=\"Permanent link\">&para;</a></h4>\n<p>Oryon \u7684 Load to use latency \u9488\u5bf9 pointer chasing \u573a\u666f\u505a\u4e86\u4f18\u5316\uff0c\u5728\u4e0b\u5217\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u8fbe\u5230 3 cycle:</p>\n<ul>\n<li><code>ldr x0, [x0]</code>: load \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n<li><code>ldr x0, [x0, 8]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u7acb\u5373\u6570\u504f\u79fb</li>\n<li><code>ldr x0, [x0, x1]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u6709\u5bc4\u5b58\u5668\u504f\u79fb</li>\n<li><code>ldp x0, x1, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e00\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 4 cycle\uff1a</p>\n<ul>\n<li>load \u7684\u76ee\u7684\u5bc4\u5b58\u5668\u4f5c\u4e3a alu \u7684\u6e90\u5bc4\u5b58\u5668\uff08\u4e0b\u79f0 load to alu latency\uff09</li>\n<li><code>ldr x0, [sp, x0, lsl #3]</code>\uff1aload \u7ed3\u679c\u8f6c\u53d1\u5230 index</li>\n</ul>\n<p>\u5728\u4e0b\u5217\u573a\u666f\u4e0b Load to use latency \u5219\u662f 5 cycle\uff1a</p>\n<ul>\n<li><code>ldp x1, x0, [x0]</code>\uff1aload pair \u7684\u7b2c\u4e8c\u4e2a\u76ee\u7684\u5bc4\u5b58\u5668\u8f6c\u53d1\u5230\u57fa\u5730\u5740\uff0c\u65e0\u504f\u79fb</li>\n</ul>\n<p>\u6bd4\u8f83\u5947\u602a\u7684\u662f <code>ldr x0, [x0]</code> \u5728\u8de8\u8d8a 8B \u8fb9\u754c\u65f6\u7684\u884c\u4e3a\uff0cload to load latency \u9000\u5316\u4e3a 6 cycle\uff0cload to alu latency \u5219\u662f 4 cycle\u3002Apple Firestorm \u5219\u6ca1\u6709\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728\u8de8\u8d8a 8B \u8fb9\u754c\u751a\u81f3 64B \u8fb9\u754c\u65f6\uff0c\u5b9e\u73b0\u4e86 4 cycle load to load latency \u548c 4 cycle load to alu latency\u3002</p>\n<h4 id=\"virtual-address-utagway-predictor\">Virtual Address UTag/Way-Predictor<a class=\"headerlink\" href=\"#virtual-address-utagway-predictor\" title=\"Permanent link\">&para;</a></h4>\n<p>Linear Address UTag/Way-Predictor \u662f AMD \u7684\u53eb\u6cd5\uff0c\u4f46\u4f7f\u7528\u76f8\u540c\u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u5728 Qualcomm Oryon \u4e0a\u89c2\u5bdf\u5230\u7c7b\u4f3c\u7684\u73b0\u8c61\uff0c\u731c\u60f3\u5b83\u4e5f\u7528\u4e86\u7c7b\u4f3c\u7684\u57fa\u4e8e\u865a\u62df\u5730\u5740\u7684 UTag/Way Predictor \u65b9\u6848\uff0c\u5e76\u6d4b\u51fa\u6765\u5b83\u7684 UTag \u4e5f\u6709 8 bit\uff1a</p>\n<ul>\n<li>VA[14] xor VA[22] xor VA[30] xor VA[38] xor VA[46]</li>\n<li>VA[15] xor VA[23] xor VA[31] xor VA[39] xor VA[47]</li>\n<li>VA[16] xor VA[24] xor VA[32] xor VA[40]</li>\n<li>VA[17] xor VA[25] xor VA[33] xor VA[41]</li>\n<li>VA[18] xor VA[26] xor VA[34] xor VA[42]</li>\n<li>VA[19] xor VA[27] xor VA[35] xor VA[43]</li>\n<li>VA[20] xor VA[28] xor VA[36] xor VA[44]</li>\n<li>VA[21] xor VA[29] xor VA[37] xor VA[45]</li>\n</ul>\n<p>\u4e00\u5171\u6709 8 bit\uff0c\u7531 VA[47:14] \u6298\u53e0\u800c\u6765\uff0c\u548c Apple M1 \u4e00\u6837\u3002</p>\n<p>\u9664\u4e86 UTag \u53ef\u80fd\u51b2\u7a81\u4ee5\u5916\uff0c\u5982\u679c VA[13:12] \u51fa\u73b0\u4e86 VIPT \u5bfc\u81f4\u7684 alias\uff0c\u4e5f\u4f1a\u51fa\u73b0\u6027\u80fd\u4e0b\u964d\u3002</p>\n<h3 id=\"mmu\">MMU<a class=\"headerlink\" href=\"#mmu\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>4KB and 64KB translation granules</li>\n<li>1 cycle access for L1 ITLB &amp; L1 DTLB</li>\n<li>Unified L2 TLB, <strong>8-way</strong> &gt;8K entry</li>\n</ul>\n<h4 id=\"l2-tlb\">L2 TLB<a class=\"headerlink\" href=\"#l2-tlb\" title=\"Permanent link\">&para;</a></h4>\n<p>\u6cbf\u7528\u4e4b\u524d\u6d4b\u8bd5 L1 DTLB \u7684\u65b9\u6cd5\uff0c\u628a\u89c4\u6a21\u6269\u5927\u5230 L2 Unified TLB \u7684\u8303\u56f4\uff0c\u5c31\u53ef\u4ee5\u6d4b\u51fa\u6765 L2 Unified TLB \u7684\u5bb9\u91cf\uff0c\u4e0b\u9762\u662f Oryon \u4e0a\u7684\u6d4b\u8bd5\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_l2tlb.png\" /></p>\n<p>\u53ef\u4ee5\u770b\u5230\u62d0\u70b9\u662f 32768 \u4e2a Page \u9644\u8fd1\uff0c\u8bf4\u660e Oryon \u7684 L2 TLB \u5bb9\u91cf\u662f 32768 \u9879\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u628a\u6d4b\u8bd5\u8303\u56f4\u6269\u5927\uff0c\u770b\u5230\u5b8c\u6574\u7684\u56fe\u50cf\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_tlb.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u662f 224 * 4 KB = 896 KB\uff0c\u5bf9\u5e94 L1 DTLB\uff0c\u6b64\u65f6\u8bbf\u5b58\u5ef6\u8fdf\u662f 3 cycle\uff1b\u7b2c\u4e8c\u4e2a\u62d0\u70b9\u662f 32768 * 4 KB = 131072 KB\uff0c\u5bf9\u5e94 L2 TLB\uff0c\u6b64\u65f6\u8bbf\u5b58\u5ef6\u8fdf\u662f 29.5 cycle\uff0c\u8fd9\u4e2a\u65f6\u5019\u5bf9 Cache \u7684\u5360\u7528\u662f 32768 * 64 = 2 MB\uff0c\u5df2\u7ecf\u8d85\u8fc7\u4e86 L1 DCache \u5bb9\u91cf\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5ef6\u8fdf\u5305\u62ec\u4e86 L1 DCache miss \u7684\u5ef6\u8fdf\uff0c\u5982\u679c\u53bb\u6389\u5b98\u65b9\u5ba3\u79f0\u7684 17 cycle \u7684 L1 DCache miss \u5ef6\u8fdf\uff0c\u5c31\u5f97\u5230 29.5 - 17 = 12.5 cycle\u3002</p>\n<p>\u7531\u4e8e Oryon \u7684 L2 TLB \u5f88\u5927\uff0c\u5f88\u5bb9\u6613\u9047\u5230\u6570\u636e\u7f13\u5b58\u5bb9\u91cf\u7684\u74f6\u9888\uff0c\u56e0\u6b64\u628a\u6307\u9488\u7684\u8de8\u5ea6\u8c03\u5927\uff0c\u4f7f\u5f97\u7b49\u6548 L2 TLB \u5bb9\u91cf\u53d8\u5c0f\uff0c\u4f46\u6570\u636e\u7f13\u5b58\u5bb9\u91cf\u4e0d\u53d8\uff0c\u53ef\u4ee5\u6d4b\u8bd5\u53bb\u6389\u7f13\u5b58\u7f3a\u5931\u5ef6\u8fdf\u540e\u7684\u6027\u80fd\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6bcf 512 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 64\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e0d\u592a\u7a33\u5b9a\uff0c\u6000\u7591\u6709\u9884\u53d6</li>\n<li>\u5982\u679c\u6bcf 1024 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 32\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 55-57</li>\n<li>\u5982\u679c\u6bcf 2048 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 16\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 53-57</li>\n<li>\u5982\u679c\u6bcf 4096 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u5728 8\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 59-67</li>\n<li>\u5982\u679c\u6bcf 8192 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\uff0cL2 TLB \u62d0\u70b9\u4f9d\u7136\u5728 8\uff0cL2 TLB \u7f3a\u5931\u65f6 CPI \u4e3a 59-71</li>\n<li>\u89c2\u5bdf\u5230\u547d\u4e2d L1 DTLB \u65f6 CPI \u662f 3\uff0c\u547d\u4e2d L2 TLB \u65f6 CPI \u662f 11\uff08\u6bcf 1024 \u4e2a\u9875\u4e00\u4e2a\u6307\u9488\u65f6\u4f8b\u5916\uff0cCPI \u4ece 11 \u7f13\u6162\u4e0b\u964d\u5230 14.5\uff09\uff0c\u6b64\u65f6 L1 \u6570\u636e\u7f13\u5b58\u7f3a\u5931\u7387\u4e3a 0\uff0c\u5ef6\u8fdf\u90fd\u6765\u81ea\u4e8e L1 DTLB miss</li>\n</ul>\n<p>\u8ba4\u4e3a Oryon \u7684 L2 TLB \u662f 8 Way\uff0c4096 Set\uff0c\u90a3\u5c31\u662f 32768 \u4e2a entry\uff0cIndex \u662f VA[23:12]\u3002\u4f46\u5b98\u65b9\u58f0\u79f0\u7684\u662f <code>&gt;8K</code>\uff0c\u8fd9\u4e2a\u8868\u8ff0\u6bd4\u8f83\u8010\u4eba\u5bfb\u5473\uff0c\u53ef\u80fd\u662f 8K \u4e2a entry\uff0c\u6bcf\u4e2a entry \u6700\u591a\u8bb0\u5f55\u56db\u4e2a\u9875\u7684\u6620\u5c04\u5173\u7cfb\u3002</p>\n<p>\u547d\u4e2d L2 TLB \u7684\u65f6\u95f4\u6709\u957f\u6709\u77ed\uff0c\u8bf4\u660e\u5b83\u7684 entry \u4e0d\u662f\u7b49\u540c\u7684\uff0c\u968f\u7740\u8bbf\u95ee\u8303\u56f4\u53d8\u5927\uff0c\u5373\u4f7f\u90fd\u547d\u4e2d\uff0c\u5ef6\u8fdf\u4e5f\u4f1a\u4e0a\u5347\u3002</p>\n<h3 id=\"l2-cache\">L2 Cache<a class=\"headerlink\" href=\"#l2-cache\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>\u6bcf 4 \u4e2a\u6838\u5fc3\u7ec4\u6210\u4e00\u4e2a Cluster\uff0cCluster \u5185\u7684\u6838\u5fc3\u5171\u4eab\u4e00\u4e2a 12MB 12-way L2 Cache</li>\n<li>MOESI</li>\n<li><strong>17</strong> cycle latency for L1 miss to L2 hit</li>\n</ul>\n<p>\u6784\u9020\u4e0d\u540c\u5927\u5c0f footprint \u7684 pointer chasing \u94fe\uff0c\u6d4b\u8bd5\u4e0d\u540c footprint \u4e0b\u6bcf\u6761 load \u6307\u4ee4\u8017\u8d39\u7684\u65f6\u95f4\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_l2.png\" /></p>\n<p>\u7b2c\u4e00\u4e2a\u62d0\u70b9\u5728 96KB\uff0c\u5bf9\u5e94 L1 DCache \u7684\u5bb9\u91cf\uff0c\u4e4b\u540e\u5ef6\u8fdf\u5728 18-22 \u5468\u671f\u4e4b\u95f4\u6ce2\u52a8\uff0c\u4e2d\u95f4\u4e00\u6bb5\u6bd4\u8f83\u7a33\u5b9a\u5728 20 cycle\uff0c\u8fd9\u5bf9\u5e94\u4e86 3 cycle load to load latency + 17 cycle l1 miss penalty\u3002</p>\n<p>\u5ef6\u8fdf\u8d85\u8fc7 6MB \u4ee5\u540e\u5ef6\u8fdf\u5feb\u901f\u4e0a\u5347\uff0c\u5bf9\u6b64\u6709\u4e24\u79cd\u731c\u6d4b\uff1a</p>\n<ol>\n<li>L2 Cache \u5e76\u975e\u6240\u6709\u5bb9\u91cf\u90fd\u53ef\u4ee5\u5728\u5dee\u4e0d\u591a\u7684\u65f6\u95f4\u5185\u8bbf\u95ee\uff0c\u79bb\u6838\u5fc3\u8fd1\u7684\u66f4\u5feb\uff0c\u79bb\u6838\u5fc3\u8fdc\u7684\u8f83\u6162</li>\n<li>\u4e3a\u4e86\u9632\u6b62\u67d0\u4e2a\u6838\u5fc3\u5bf9 L2 Cache \u7684\u5360\u7528\u592a\u5927\uff0c\u5bfc\u81f4\u540c\u4e00\u4e2a Cluster \u5185\u5176\u4ed6\u6838\u5fc3\u5206\u4e0d\u5230 L2 \u7f13\u5b58\uff0c\u8fdb\u884c QoS\uff0c\u9650\u5236\u6bcf\u4e2a\u6838\u5fc3\u80fd\u591f\u5360\u7528\u7684 L2 Cache \u5bb9\u91cf</li>\n</ol>\n<p>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u9a8c\u8bc1\u4ee5\u4e0a\u7684\u731c\u6d4b\uff0c\u9664\u4e86\u5468\u671f\u6570\u4ee5\u5916\uff0c\u4e5f\u6d4b\u8bd5\u4e86\u4e0d\u540c footprint \u4e0b L2D_CACHE_REFILL \u4e8b\u4ef6\u7684\u6b21\u6570\uff0c\u53d1\u73b0\uff1a</p>\n<ol>\n<li>footprint \u5728 8MB \u8303\u56f4\u5185\u65f6\uff0cL2D_CACHE_REFILL \u7ea6\u7b49\u4e8e 0\uff0c\u610f\u5473\u7740\u6b64\u65f6\u6570\u636e\u90fd\u547d\u4e2d\u4e86 L2 Cache\uff0c\u4f46\u5f53 footprint \u8fbe\u5230 8MB \u65f6\uff0c\u8bbf\u95ee\u5ef6\u8fdf\u5df2\u7ecf\u589e\u52a0\u5230 45 \u4e2a\u5468\u671f\uff0c\u8fd9\u7b26\u5408\u7b2c\u4e00\u70b9\u731c\u6d4b\uff0c\u5373\u4f7f\u90fd\u547d\u4e2d L2 Cache\uff0c\u4e5f\u6709\u5feb\u6162\u4e4b\u5206</li>\n<li>footprint \u8fbe\u5230 12 MB \u65f6\uff0c\u6bcf\u6b21\u8bbf\u5b58\u7684\u5e73\u5747 L2D_CACHE_REFILL \u7ea6\u7b49\u4e8e 0.23\uff0c\u5047\u5982\u4e00\u4e2a\u6838\u5fc3\u53ef\u4ee5\u7528\u6ee1\u6574\u4e2a L2 Cache\uff0c\u6b64\u65f6\u5e94\u5f53\u6ca1\u6709\u8fd9\u4e48\u9ad8\u7684\u7f3a\u5931\u7387\uff0c\u8fd9\u7b26\u5408\u7b2c\u4e8c\u70b9\u731c\u6d4b</li>\n</ol>\n<p>\u56e0\u6b64\u53ef\u80fd\u4e0a\u8ff0\u4e24\u4e2a\u731c\u6d4b\u90fd\u662f\u5bf9\u7684\uff0c\u5f53\u7136\u4e86\uff0c\u4e5f\u4e0d\u6392\u9664\u8fd8\u6709\u522b\u7684\u89e3\u91ca\u3002</p>\n<h3 id=\"prefetcher\">Prefetcher<a class=\"headerlink\" href=\"#prefetcher\" title=\"Permanent link\">&para;</a></h3>\n<p>\u4e3a\u4e86\u6d4b\u8bd5\u9884\u53d6\u5668\u7684\u884c\u4e3a\uff0c\u53ef\u4ee5\u6784\u9020\u4e0d\u540c\u7684 footprint \u548c\u4e0d\u540c\u8bbf\u5b58\u6a21\u5f0f\u7684 pointer chasing \u94fe\uff0c\u89c2\u5bdf\u5b83\u7684\u6027\u80fd\u4ee5\u53ca\u9884\u53d6\u5668\u4ecb\u5165\u6b21\u6570\u7684\u6027\u80fd\u8ba1\u6570\u5668\u3002\u6d89\u53ca\u5230\u7684\u8bbf\u5b58\u6a21\u5f0f\u5982\u4e0b\uff1a</p>\n<ul>\n<li>64B stride\uff1a\u6309\u7167\u56fa\u5b9a\u7684 stride \u8bbf\u5b58\uff0c\u5730\u5740\u6a21\u5f0f\u662f 0B -&gt; 64B -&gt; 128B -&gt; ...</li>\n<li>random cache line\uff1a\u628a 64B cache line \u6253\u4e71\u987a\u5e8f\uff0c\u6bcf\u4e2a cache line \u8f6e\u6d41\u8bfb\u53d6\u4e00\u6b21</li>\n<li>first cache line in random page\uff1a\u628a 4K \u5927\u5c0f\u7684 page \u6253\u4e71\u987a\u5e8f\uff0c\u6bcf\u4e2a page \u8f6e\u6d41\u8bfb\u53d6\u4e00\u6b21\uff0c\u8bfb\u53d6\u7684\u662f\u5404\u4e2a\u9875\u5185\u7684\u7b2c\u4e00\u4e2a 64B cache line\uff1b\u53ea\u8bfb\u53d6\u6bcf\u4e2a\u9875\u7684\u7b2c\u4e00\u4e2a 64B cache line \u662f\u4e3a\u4e86\u8fbe\u5230\u7c7b\u4f3c L1 DCache \u7684\u5bb9\u91cf\u7528\u6ee1\u7684\u6548\u679c</li>\n<li>one random cache line in random page\uff1a\u628a 4K \u5927\u5c0f\u7684 page \u6253\u4e71\u987a\u5e8f\uff0c\u6bcf\u4e2a page \u8f6e\u6d41\u8bfb\u53d6\u4e00\u6b21\uff0c\u8bfb\u53d6\u7684\u662f\u5404\u4e2a\u9875\u5185\u7684\u968f\u673a\u4f46\u56fa\u5b9a\u4f4d\u7f6e\u7684\u4e00\u4e2a 64B cache line</li>\n</ul>\n<p>\u6ce8\uff1a\u4e0a\u8ff0\u7684\u6253\u4e71\u987a\u5e8f\uff0c\u53ea\u662f\u5728\u6784\u5efa pointer chasing \u94fe\u65f6\u6253\u4e71\uff0c\u56e0\u6b64\u5728\u8bbf\u5b58\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u4f1a\u518d\u8c03\u6574\u8bbf\u5b58\u987a\u5e8f\u3002</p>\n<p>\u540c\u65f6\u7edf\u8ba1\u6bcf\u6b21\u8bbf\u5b58\u82b1\u8d39\u7684\u65f6\u95f4\u4ee5\u53ca <code>0x8154, L1D_CACHE_HWPRF, Level 1 data cache hardware prefetch</code> \u6027\u80fd\u8ba1\u6570\u5668\u7684\u7ed3\u679c\uff0c\u5f97\u5230\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"../../../../qualcomm_oryon_prefetcher.png\" /></p>\n<ul>\n<li>64B stride\uff1a\u53ef\u4ee5\u770b\u5230\u5728\u8d85\u51fa 96KB \u7684 L1 DCache \u5bb9\u91cf\u4ee5\u540e\uff0c\u8bbf\u5b58\u5ef6\u8fdf\u7565\u5fae\u589e\u52a0\u5230 1ns\uff0c\u540c\u65f6\u6bcf\u6b21\u8bbf\u5b58\u5bf9\u5bf9\u5e94\u4e00\u6b21\u786c\u4ef6\u9884\u53d6\uff0c\u6b64\u65f6\u4e3b\u8981\u662f Stride Prefetcher \u5728\u8d77\u4f5c\u7528</li>\n<li>random cache line\uff1a\u53ef\u4ee5\u770b\u5230\u5728\u8d85\u51fa L1 DCache \u5bb9\u91cf\u540e\uff0c\u8bbf\u5b58\u5ef6\u8fdf\u5927\u5e45\u4e0a\u5347\uff0c\u4f46\u5e76\u6ca1\u6709\u76f4\u63a5\u964d\u4f4e\u5230 L2 Cache \u7684\u8bbf\u95ee\u5ef6\u8fdf\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u770b\u5230\u9884\u53d6\u7684\u6bd4\u4f8b\u6025\u5267\u4e0a\u5347\uff1b\u8bf4\u660e\u5373\u4f7f\u662f\u968f\u673a\u7684\u8bbf\u95ee\u6a21\u5f0f\uff0c\u9884\u53d6\u5668\u53ef\u4ee5\u8bb0\u5f55\u4e0b\u90e8\u5206\u8bbf\u5b58\u8fc7\u7a0b\uff0c\u4ece\u800c\u964d\u4f4e\u4e86\u7f13\u5b58\u7f3a\u5931\u7387\uff0c\u6b64\u65f6\u4e3b\u8981\u662f Region/Spatial Prefetcher \u5728\u8d77\u4f5c\u7528</li>\n<li>first cache line in random page\uff1a\u53ef\u4ee5\u770b\u5230\u5728\u8d85\u51fa L1 DCache \u5bb9\u91cf\u540e\uff0c\u8bbf\u5b58\u5ef6\u8fdf\u5feb\u901f\u964d\u4f4e\u5230 L2 Cache \u7684\u8bbf\u95ee\u5ef6\u8fdf\uff0c\u540c\u65f6\u786c\u4ef6\u9884\u53d6\u5668\u5e76\u6ca1\u6709\u5de5\u4f5c\uff1b\u8bf4\u660e\u786c\u4ef6\u6ca1\u6709\u9488\u5bf9 L1 DCache \u5b9e\u73b0 Temporal Prefetcher</li>\n<li>one random cache line in random page\uff1a\u6b64\u65f6\u5b9e\u9645\u7684\u7f13\u5b58\u5bb9\u91cf\u53ea\u6709\u6a2a\u5ea7\u6807\u7684 <code>64/4096</code> \u500d\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u6d4b\u5f97\u7684\u6027\u80fd\u62d0\u70b9 896KB \u5b9e\u9645\u4e0a\u5bf9\u5e94\u7684\u662f L1 DTLB \u7684\u5bb9\u91cf</li>\n</ul>\n<h3 id=\"memory\">Memory<a class=\"headerlink\" href=\"#memory\" title=\"Permanent link\">&para;</a></h3>\n<p>\u5b98\u65b9\u4fe1\u606f\uff1a</p>\n<ul>\n<li>6MB System Level Cache, 26-29ns latency, 135GB/s bandwidth in each direction</li>\n<li>LPDDR5x DRAM, 8448 MT/s, 8 channel of 16 bits, 135GB/s bandwidth, 102-104ns latency</li>\n</ul>\n<p>\u901a\u8fc7 dmidecode\uff0c\u53ef\u4ee5\u770b\u5230 Surface Laptop 7 \u7684\u5185\u5b58\u578b\u53f7\uff1a</p>\n<div class=\"language-text highlight\"><pre><span></span><code><span id=\"__span-1-1\"><a id=\"__codelineno-1-1\" name=\"__codelineno-1-1\" href=\"#__codelineno-1-1\"></a>Handle 0x0004, DMI type 17, 92 bytes\n</span><span id=\"__span-1-2\"><a id=\"__codelineno-1-2\" name=\"__codelineno-1-2\" href=\"#__codelineno-1-2\"></a>Memory Device\n</span><span id=\"__span-1-3\"><a id=\"__codelineno-1-3\" name=\"__codelineno-1-3\" href=\"#__codelineno-1-3\"></a>        Total Width: 16 bits\n</span><span id=\"__span-1-4\"><a id=\"__codelineno-1-4\" name=\"__codelineno-1-4\" href=\"#__codelineno-1-4\"></a>        Data Width: 16 bits\n</span><span id=\"__span-1-5\"><a id=\"__codelineno-1-5\" name=\"__codelineno-1-5\" href=\"#__codelineno-1-5\"></a>        Size: 32 GB\n</span><span id=\"__span-1-6\"><a id=\"__codelineno-1-6\" name=\"__codelineno-1-6\" href=\"#__codelineno-1-6\"></a>        Form Factor: TSOP\n</span><span id=\"__span-1-7\"><a id=\"__codelineno-1-7\" name=\"__codelineno-1-7\" href=\"#__codelineno-1-7\"></a>        Locator: Top - on board\n</span><span id=\"__span-1-8\"><a id=\"__codelineno-1-8\" name=\"__codelineno-1-8\" href=\"#__codelineno-1-8\"></a>        Bank Locator: Bank 0\n</span><span id=\"__span-1-9\"><a id=\"__codelineno-1-9\" name=\"__codelineno-1-9\" href=\"#__codelineno-1-9\"></a>        Type: LPDDR5\n</span><span id=\"__span-1-10\"><a id=\"__codelineno-1-10\" name=\"__codelineno-1-10\" href=\"#__codelineno-1-10\"></a>        Speed: 8448 MT/s\n</span><span id=\"__span-1-11\"><a id=\"__codelineno-1-11\" name=\"__codelineno-1-11\" href=\"#__codelineno-1-11\"></a>        Manufacturer: Hynix\n</span><span id=\"__span-1-12\"><a id=\"__codelineno-1-12\" name=\"__codelineno-1-12\" href=\"#__codelineno-1-12\"></a>        Part Number: H58G66BK8BX067\n</span><span id=\"__span-1-13\"><a id=\"__codelineno-1-13\" name=\"__codelineno-1-13\" href=\"#__codelineno-1-13\"></a>        Configured Memory Speed: 8448 MT/s\n</span><span id=\"__span-1-14\"><a id=\"__codelineno-1-14\" name=\"__codelineno-1-14\" href=\"#__codelineno-1-14\"></a>        Minimum Voltage: 0.348 V\n</span><span id=\"__span-1-15\"><a id=\"__codelineno-1-15\" name=\"__codelineno-1-15\" href=\"#__codelineno-1-15\"></a>        Maximum Voltage: 0.856 V\n</span><span id=\"__span-1-16\"><a id=\"__codelineno-1-16\" name=\"__codelineno-1-16\" href=\"#__codelineno-1-16\"></a>        Configured Voltage: 0.8 V\n</span></code></pre></div>", "image": null, "date_modified": "2024-09-01T00:00:00+00:00", "authors": [], "tags": ["cpu", "hardware", "oryon", "performance", "qualcomm", "uarch-review", "xelite"]}]}